/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/PerformanceSampler","../../core/PooledArray","../../core/promiseUtils","../../core/Accessor","../../core/watchUtils","../../layers/support/PromiseQueue","./debugFlags"],(function(e,t,s,i,r,n,a,u,o,_,d,h,c,l,T,E,p,f,g){"use strict";const I=n.getLogger("esri.views.support.Scheduler");function k(e){return new F.Scheduler({nowFunc:e})}var R;(R=e.Task||(e.Task={})).REMOTE_CLIENT="worker messages",R.SLIDE="slide",R.STAGE="stage",R.STREAM_DATA_LOADER="stream loader",R.ELEVATION_QUERY="elevation query",R.TERRAIN_SURFACE="terrain",R.SURFACE_GEOMETRY_UPDATES="surface geometry updates",R.GRAPHICS_CORE="Graphics3D",R.I3S_CONTROLLER="I3S",R.POINT_CLOUD_LAYER="point cloud",R.FEATURE_TILE_FETCHER="feature fetcher",R.LABELER="labeler",R.GRAPHICS_DECONFLICTOR="graphics deconflictor",R.FILTER_VISIBILITY="Graphics3D filter visibility",R.FEATURE_QUERY_ENGINE="feature query",R.SCALE_VISIBILITY="Graphics3D scale visibility",R.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",R.POINT_OF_INTEREST_FREQUENT="POI frequent",R.POINT_OF_INTEREST_INFREQUENT="POI infrequent",R.FEATURE_TILE_TREE="feature tile tree",R.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",R.ELEVATION_ALIGNMENT="elevation alignment",R.TEXT_TEXTURE_ATLAS="text texture atlas",R.TEXTURE_UNLOAD="texture unload",R.OVERLAY_MANAGER="overlay manager",R.LINE_OF_SIGHT_TOOL="line of sight tool",R.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",R.ELEVATION_PROFILE="elevation profile",R.SNAPPING="snapping",R[R.TEST_PRIO=1]="TEST_PRIO";const A=0,m={[e.Task.REMOTE_CLIENT]:A,[e.Task.SLIDE]:A,[e.Task.STREAM_DATA_LOADER]:A,[e.Task.ELEVATION_QUERY]:A,[e.Task.STAGE]:1,[e.Task.TERRAIN_SURFACE]:1,[e.Task.SURFACE_GEOMETRY_UPDATES]:1,[e.Task.GRAPHICS_CORE]:2,[e.Task.I3S_CONTROLLER]:2,[e.Task.POINT_CLOUD_LAYER]:2,[e.Task.FEATURE_TILE_FETCHER]:2,[e.Task.LABELER]:8,[e.Task.GRAPHICS_DECONFLICTOR]:4,[e.Task.FILTER_VISIBILITY]:4,[e.Task.FEATURE_QUERY_ENGINE]:8,[e.Task.SCALE_VISIBILITY]:4,[e.Task.FRUSTUM_VISIBILITY]:4,[e.Task.POINT_OF_INTEREST_FREQUENT]:6,[e.Task.POINT_OF_INTEREST_INFREQUENT]:30,[e.Task.FEATURE_TILE_TREE]:16,[e.Task.FEATURE_TILE_TREE_ACTIVE]:A,[e.Task.ELEVATION_ALIGNMENT]:12,[e.Task.TEXT_TEXTURE_ATLAS]:12,[e.Task.TEXTURE_UNLOAD]:12,[e.Task.OVERLAY_MANAGER]:12,[e.Task.LINE_OF_SIGHT_TOOL]:16,[e.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE]:A,[e.Task.SNAPPING]:A};function S(e){return e in m?m[e]:"number"==typeof e?e:1}const L=6.5,b=1,y=30,U=1e3/30,N=100,O=.9;var F,P;!function(i){let n=function(s){function i(i){var n;(n=s.call(this,i)||this).updating=!0,n.performanceInfo={total:new c("total"),tasks:new Array},n._budget=null,n._state=1,n._tasks=new l,n._runQueue=new l,n._load=0,n._idleStateCallbacks=new l,n._idleUpdatesStartFired=!1,n._maxReschedule=v,n._forceTask=!1,n._debug=!1,n._debugHandle=p.init(g,"SCHEDULER_LOG_SLOW_TASKS",(e=>n._debug=e)),n._budget=new _(i.nowFunc),G.length=0;for(const t in e.Task)D.set(e.Task[t],n.performanceInfo.tasks.length),n.performanceInfo.tasks.push(new c(e.Task[t])),G.push(0);let a;const u=t._assertThisInitialized(n);return n._test={get state(){return r.isNone(a)?u._state:a},set state(e){a=e},FRAME_SAFETY_BUDGET:L,INTERACTING_BUDGET:U,IDLE_BUDGET:N,get budget(){return u._budget.budget},usedBudget:0,updateTask:e=>n._updateTask(e),getState:e=>n._getState(e),getRuntime:e=>n._getRuntime(e),resetRuntimes:()=>n._resetRuntimes(),getRunning:()=>n._getRunning()},n}t._inheritsLoose(i,s);var n=i.prototype;return n.destroy=function(){this._debugHandle&&this._debugHandle.remove()},n.registerTask=function(e,t,s){const i=S(e),r=new a(this,e,t,s,i);return this._tasks.push(r),r},n.registerIdleStateCallbacks=function(e,t){const s={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(s),2===this.state&&this._idleUpdatesStartFired&&s.idleBegin();const i=this;return{remove:()=>this._removeIdleStateCallbacks(s),set idleBegin(e){i._idleUpdatesStartFired&&(s.idleEnd(),2===i._state&&e()),s.idleBegin=e},set idleEnd(e){s.idleEnd=e}}},n.updateBudget=function(e){this._test.usedBudget=0;let t=L,s=e.frameDuration,i=b;switch(this.state){case 2:t=0,s=Math.max(N,e.frameDuration),i=y;break;case 1:s=Math.max(U,e.frameDuration)}return s-=e.elapsedFrameTime+t,2!==this.state&&s<b&&!this._forceTask?(this._forceTask=!0,!1):(s=Math.max(s,i),this._budget.reset(s,this.state),this._maxReschedule=v,this._updateLoad(),this._schedule())},n.frame=function(){switch(this._forceTask=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed},n._removeIdleStateCallbacks=function(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)},n.removeTask=function(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)},n._updateTask=function(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e)}))},n._getState=function(t){if(this._runQueue.some((e=>e.name===t)))return e.TaskState.SCHEDULED;let s=e.TaskState.IDLE;return this._tasks.forAll((i=>{i.name===t&&i.needsUpdate&&(i.schedulePriority<=1?s=e.TaskState.READY:s!==e.TaskState.READY&&(s=e.TaskState.WAITING))})),s},n._getRuntime=function(e){let t=0;return this._tasks.forAll((s=>{s.name===e&&(t+=s.runtime)})),t},n._resetRuntimes=function(){this._tasks.forAll((e=>e.runtime=0))},n._getRunning=function(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)})),0===e.size)return null;let t="";return e.forEach(((e,s)=>{t+=e>1?` ${e}x ${s}`:` ${s}`})),t},n._runIdle=function(){this._run()},n._runInteracting=function(){this._run()},n._runAnimating=function(){this._run()},n._updateLoad=function(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=this._load*O+e*(1-O)},n._schedule=function(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.priority,!1))),this._tasks.forAll((e=>{e.priority===A&&e.needsUpdate&&!this._runQueue.some((t=>t===e))&&this._runQueue.unshift(e)}));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((s=>{if(s.needsUpdate&&0!==s.schedulePriority&&s.priority!==A)switch(e=!0,t=Math.max(t,s.priority),s.schedulePriority){case 1:s.schedulePriority=0,this._runQueue.push(s);break;default:--s.schedulePriority}})),!e)return this.updating=!1,!1;this._maxReschedule===v&&(this._maxReschedule=t),--this._maxReschedule}return this.updating=!0,!0},n._run=function(){const e=this._budget.now();for(let s=0;s<G.length;++s)G[s]=0;do{for(;this._runQueue.length>0;){const s=this._budget.now(),i=this._runQueue.pop();this._budget.resetProgress();try{i.update(this._budget)}catch(t){I.error(`Exception in task "${i.name}"`,t)}i.schedulePriority=i.priority;const r=this._budget.now()-s;if(i.runtime+=r,G[D.get(i.task)]+=r,this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",i.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(G,this._budget.now()-e)}}while(this._schedule());this._recordFrameTaskTimes(G,this._budget.now()-e)},n._recordFrameTaskTimes=function(e,t){for(let s=0;s<e.length;++s)this.performanceInfo.tasks[s].record(e[s]);this.performanceInfo.total.record(t)},t._createClass(i,[{key:"now",get:function(){return this.nowFunc()}},{key:"load",get:function(){return this._load}},{key:"state",get:function(){return r.isNone(this._test.state)?this._state:this._test.state},set:function(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))))}},{key:"test",get:function(){return this._test}}]),i}(E);s.__decorate([u.property()],n.prototype,"updating",void 0),s.__decorate([u.property()],n.prototype,"nowFunc",void 0),n=s.__decorate([o.subclass("esri.views.support.Scheduler")],n),i.Scheduler=n;let a=function(e){function s(t,s,i,r,n){var a;return(a=e.call(this,{})||this)._scheduler=t,a.name=s,a.update=i,a._needsUpdateCB=r,a._priority=n,a.runtime=0,a._queue=new f,a.updating=!1,a.schedulePriority=a._priority,a}t._inheritsLoose(s,e);var i=s.prototype;return i.normalizeCtorArgs=function(){return{}},i.remove=function(){this.processQueue(C),this._scheduler.removeTask(this),this.schedule=w.schedule,this.reschedule=w.reschedule},i.setPriority=function(e){this.name=e;const t=S(e);this._priority!==A&&0===this.schedulePriority||(this.schedulePriority=t),this._priority=t},i.schedule=function(e,t){return this.updating=!0,this._queue.push(e,t)},i.reschedule=function(e,t){return this.updating=!0,this._queue.unshift(e,t)},i.processQueue=function(e){for(;!e.done&&this._queue.process();)e.madeProgress();this.updating=this._queue.length>0},t._createClass(s,[{key:"priority",get:function(){return this._priority}},{key:"task",get:function(){return this.name},set:function(e){this.setPriority(e)}},{key:"needsUpdate",get:function(){return this.updating||this._needsUpdateCB()}}]),s}(E);s.__decorate([u.property()],a.prototype,"updating",void 0),a=s.__decorate([o.subclass("esri.views.support.SchedulerTask")],a);let _=function(){function e(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}var s=e.prototype;return s.run=function(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)},s.madeProgress=function(){this._didWork=!0},s.reset=function(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1},s.resetProgress=function(){this._didWork=!1},t._createClass(e,[{key:"done",get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}},{key:"budget",get:function(){return this._budget}},{key:"state",get:function(){return this._state}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"remaining",get:function(){return Math.max(this._budget-this.elapsed,0)}},{key:"elapsed",get:function(){return this.now()-this._begin}},{key:"hasProgressed",get:function(){return this._didWork}}]),e}();i.Budget=_}(F||(F={})),(P=e.TaskState||(e.TaskState={})).SCHEDULED="s",P.READY="r",P.WAITING="w",P.IDLE="i";const C=(()=>{const e=new F.Budget((()=>performance.now()));return e.enabled=!1,e})();const w=new(function(){function e(){}var t=e.prototype;return t.remove=function(){},t.processQueue=function(){},t.schedule=function(e){return T.when(e())},t.reschedule=function(e){return T.when(e())},e}()),v=Number.MAX_SAFE_INTEGER,D=new Map,G=new Array;e.ImmediateTask=w,e.getTaskPriority=S,e.newScheduler=k,e.noBudget=C,e.taskPriorities=m,Object.defineProperty(e,"__esModule",{value:!0})}));
