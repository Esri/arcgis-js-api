/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import"../../core/has.js";import{clamp as t}from"../../core/mathUtils.js";import{isNone as i}from"../../core/maybe.js";const h=2048,e=1.5,n=8;function o(i,h){const{format:e,quality:n,rotation:o,disableDecorations:a}=i||{},r=P(i,h.padding),l=q(i,{width:h.width-r.left-r.right,height:h.height-r.top-r.bottom}),{width:g,height:u}=v(i,l),f=k(e),d=W[f];return{format:f,quality:t(null!=n?n:d,0,100),area:l,width:g,height:u,rotation:o,disableDecorations:!!a,ignoreBackground:!(!i||!i.ignoreBackground),ignorePadding:!(!i||!i.ignorePadding)}}function a(t,i){const h=o(t,i),e=h.area,n=h.width/e.width,a=P(h,i.padding),r=a.left+a.right,l=a.top+a.bottom,g=i.width-r,u=i.height-l,f=Math.floor(g*n+r),d=Math.floor(u*n+l),c=t&&t.layers?t.layers:[],s=h.ignoreBackground,w=h.ignorePadding;return{framebufferWidth:f,framebufferHeight:d,region:{x:Math.floor(e.x*n)+a.left,y:Math.floor(e.y*n)+a.top,width:h.width,height:h.height},format:h.format,quality:h.quality,rotation:h.rotation,pixelRatio:n,layers:c,disableDecorations:h.disableDecorations,ignoreBackground:s,ignorePadding:w}}function r(t,i,h){const{ctx:e,canvas:n}=g(t,h),o=e.getImageData(0,0,t.width,t.height),a=c(n,i);return u(n),{dataUrl:a,data:o}}function l(t,i){const{ctx:h,canvas:e}=g(t,i),n=h.getImageData(0,0,t.width,t.height);return u(e),n}function g(t,i){const h=f();i.premultipliedAlpha&&E(t),h.width=t.width,h.height=t.height;const e=h.getContext("2d");return e.putImageData(t,0,0),i.flipY&&B(e),{ctx:e,canvas:h}}function u(t){t.width=0,t.height=0}function f(){return i(d)&&(d=document.createElement("canvas")),d}let d=null;function c(t,i){const h=R[i.format],e=i.quality/100;return t.toDataURL(h,e)}function s(i,h){const e=k(i),n=W[e];return{format:e,quality:t(null!=h?h:n,0,100)}}function w(t,i){return i/Math.max(t[0],t[1])}function m(t,i,h){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(j)try{return new ImageData(t,i)}catch(e){j=!1}return x(t,i,h)}function M(t,i,h,e){if(!i||!h)throw new Error("Cannot construct image data without dimensions");if(j)try{return new ImageData(t,i,h)}catch(o){j=!1}const n=x(i,h,e);return n.data.set(t,0),n}function p(t,i,h,e=0,n=0,o=t.width-e,a=t.height-n,r=!1){const{data:l}=t,{width:g,height:u,data:f}=i,d=o/g,c=a/u,s=Math.ceil(d/2),w=Math.ceil(c/2),m=t.width;for(let M=0;M<u;M++)for(let t=0;t<g;t++){const i=4*(t+(r?u-M-1:M)*g);let o=0,a=0,p=0,y=0,x=0,b=0;const j=(M+.5)*c;for(let r=Math.floor(M*c);r<(M+1)*c;r++){const i=Math.abs(j-(r+.5))/w,g=(t+.5)*d,u=i*i;for(let f=Math.floor(t*d);f<(t+1)*d;f++){const t=Math.abs(g-(f+.5))/s,i=Math.sqrt(u+t*t);if(i>=1)continue;let d=2*i*i*i-3*i*i+1;const c=4*(e+f+(n+r)*m);b+=d*l[c+3],a+=d,!h&&l[c+3]<255&&(d=d*l[c+3]/255),p+=d*l[c],y+=d*l[c+1],x+=d*l[c+2],o+=d}}f[i]=p/o,f[i+1]=y/o,f[i+2]=x/o,f[i+3]=b/a}return i}function y(t,i,o){if(!i)return t;const{framebufferWidth:a,framebufferHeight:r,pixelRatio:l,region:g}=t,u=P(t,o),f=u.left+u.right,d=u.top+u.bottom,c=a-f,s=r-d,w=Math.min(n,Math.min((h-f)/c,(h-d)/s));return w<e?t:{...t,framebufferWidth:Math.round(c*w)+f,framebufferHeight:Math.round(s*w)+d,pixelRatio:l*w,resample:{region:{x:Math.round((g.x-u.left)*w)+u.left,y:Math.round((g.y-u.top)*w)+u.top,width:Math.round(g.width*w),height:Math.round(g.height*w)},width:a,height:r}}}function x(t,i,h){return h||(h=D()),h.getContext("2d").createImageData(t,i)}let b=null,j=!0;function D(){return b||(b=document.createElement("canvas"),b.width=1,b.height=1),b}function v(t,i){if(!t)return i;const h=t.width,e=t.height;if(null!=h&&null!=e)return{width:Math.floor(h),height:Math.floor(e)};if(null==h&&null==e)return i;const n=i.width/i.height;return null==e?{width:Math.floor(h),height:Math.floor(h/n)}:{width:Math.floor(e*n),height:Math.floor(e)}}function q(t,i){const h={x:0,y:0,width:i.width,height:i.height};if(t&&t.area){null!=t.area.x&&(h.x=Math.floor(t.area.x)),null!=t.area.y&&(h.y=Math.floor(t.area.y));const e=null!=t.area.width?Math.floor(t.area.width):null,n=null!=t.area.height?Math.floor(t.area.height):null;if(h.width=i.width-h.x,h.height=i.height-h.y,null!=e&&null!=n)h.width=Math.min(h.width,e),h.height=Math.min(h.height,n);else if(null==e&&null!=n){const t=Math.min(h.width,e);h.height=t/h.width*h.height,h.width=t}else if(null!=e&&null==n){const t=Math.min(h.height,n);h.width=t/h.height*h.width,h.height=t}}return I(C(h,t),i)}function I(t,i){const h=Math.floor(Math.max(t.x,0)),e=Math.floor(Math.max(t.y,0)),n={x:h,y:e,width:Math.floor(Math.min(t.width,i.width-h)),height:Math.floor(Math.min(t.height,i.height-e))},o=n.width/n.height,a=t.width/t.height;if(a===o)return n;if(a>o){const t=Math.floor(n.width/a),i=n.height-t;return{x:n.x,y:Math.floor(n.y+i/2),width:n.width,height:t}}const r=Math.floor(n.height*a),l=n.width-r;return{x:Math.floor(n.x+l/2),y:n.y,width:r,height:n.height}}function C(t,i){if(!i||null==i.width||null==i.height)return t;const h=i.width/i.height,e=t.width/t.height;if(e===h)return t;if(e<h){const i=Math.floor(t.height*h);return t.x-=(i-t.width)/2,t.width=i,t}const n=Math.floor(t.width/h);return t.y-=(n-t.height)/2,t.height=n,t}function P(t,i){return!i||t&&t.ignorePadding?A:i}function k(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return U}}function B(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function E(t){const i=t.data,h=i.length;for(let e=0;e<h;e+=4){const t=i[e+3];if(255!==t&&t>0){const h=255/t;i[e+0]=i[e+0]*h,i[e+1]=i[e+1]*h,i[e+2]=i[e+2]*h}}}const R={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},H=98,U="png",W={png:100,jpg:H,jpeg:H},A={top:0,right:0,bottom:0,left:0};export{o as completeUserSettings,m as createEmptyImageData,r as encode,l as encodeData,s as getFormatAndQuality,w as getMaximumResolutionScale,p as resampleHermite,y as screenshotSuperSampleSettings,c as toDataUrl,a as toRenderSettings,M as wrapImageData};
