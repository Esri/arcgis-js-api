// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/compilerUtils","../../core/mathUtils"],(function(t,e,i,a,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.screenshotSuperSampleSettings=e.resampleHermite=e.wrapImageData=e.createEmptyImageData=e.toDataUrl=e.encodeResult=e.toRenderSettings=e.completeUserSettings=void 0;function h(t,e){var i=t||{},h=i.format,n=i.quality,o=i.rotation,l=i.disableSlice,g=d(t,e.padding),u=function(t,e){var i={x:0,y:0,width:e.width,height:e.height};if(t&&t.area){null!=t.area.x&&(i.x=Math.floor(t.area.x)),null!=t.area.y&&(i.y=Math.floor(t.area.y));var a=null!=t.area.width?Math.floor(t.area.width):null,r=null!=t.area.height?Math.floor(t.area.height):null;if(i.width=e.width-i.x,i.height=e.height-i.y,null!=a&&null!=r)i.width=Math.min(i.width,a),i.height=Math.min(i.height,r);else if(null==a&&null!=r){var h=Math.min(i.width,a);i.height=h/i.width*i.height,i.width=h}else if(null!=a&&null==r){var n=Math.min(i.height,r);i.width=n/i.height*i.width,i.height=n}}return function(t,e){var i=Math.floor(Math.max(t.x,0)),a=Math.floor(Math.max(t.y,0)),r=Math.floor(Math.min(t.width,e.width-i)),h=Math.floor(Math.min(t.height,e.height-a)),n={x:i,y:a,width:r,height:h},o=n.width/n.height,l=t.width/t.height;if(l===o)return n;if(l>o){var g=Math.floor(n.width/l),d=n.height-g;return{x:n.x,y:Math.floor(n.y+d/2),width:n.width,height:g}}var u=Math.floor(n.height*l),f=n.width-u;return{x:Math.floor(n.x+f/2),y:n.y,width:u,height:n.height}}(function(t,e){if(!e||null==e.width||null==e.height)return t;var i=e.width/e.height,a=t.width/t.height;if(a===i)return t;if(a<i){var r=Math.floor(t.height*i);return t.x-=(r-t.width)/2,t.width=r,t}var h=Math.floor(t.width/i);return t.y-=(h-t.height)/2,t.height=h,t}(i,t),e)}(t,{width:e.width-g.left-g.right,height:e.height-g.top-g.bottom}),w=function(t,e){if(!t)return e;var i=t.width,a=t.height;if(null!=i&&null!=a)return{width:Math.floor(i),height:Math.floor(a)};if(null==i&&null==a)return e;var r=e.width/e.height;if(null==a)return{width:Math.floor(i),height:Math.floor(i/r)};return{width:Math.floor(a*r),height:Math.floor(a)}}(t,u),s=w.width,m=w.height,p=function(t){switch(t){case"png":case"jpg":case"jpeg":return t;case null:case void 0:return f;default:return a.neverReached(t),f}}(h),M=c[p];return{format:p,quality:r.clamp(null!=n?n:M,0,100),area:u,width:s,height:m,rotation:o,disableSlice:!!l,ignoreBackground:!(!t||!t.ignoreBackground),ignorePadding:!(!t||!t.ignorePadding)}}function n(t,e){var i=u[e.format],a=e.quality/100;return t.toDataURL(i,a)}function o(t,e,i){return i||(i=function(){l||((l=document.createElement("canvas")).width=1,l.height=1);return l}()),i.getContext("2d").createImageData(t,e)}e.completeUserSettings=h,e.toRenderSettings=function(t,e){var i=h(t,e),a=i.area,r=i.width/a.width,n=d(i,e.padding),o=n.left+n.right,l=n.top+n.bottom,g=e.width-o,u=e.height-l,f=Math.floor(g*r+o),c=Math.floor(u*r+l),w=t&&t.layers?t.layers:[],s=i.ignoreBackground,m=i.ignorePadding;return{framebufferWidth:f,framebufferHeight:c,region:{x:Math.floor(a.x*r)+n.left,y:Math.floor(a.y*r)+n.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:r,layers:w,disableSlice:i.disableSlice,ignoreBackground:s,ignorePadding:m}},e.encodeResult=function(t,e,i,a){a.premultipliedAlpha&&function(t){for(var e=t.data,i=e.length,a=0;a<i;a+=4){var r=e[a+3];if(r>0){var h=r/255;e[a+0]=e[a+0]/h,e[a+1]=e[a+1]/h,e[a+2]=e[a+2]/h}}}(t),i.width=t.width,i.height=t.height;var r=i.getContext("2d");r.putImageData(t,0,0),a.flipY&&function(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}(r);var h=r.getImageData(0,0,t.width,t.height),o=n(i,e);return i.width=0,i.height=0,{dataUrl:o,data:h}},e.toDataUrl=n,e.createEmptyImageData=function(t,e,i){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(g)try{return new ImageData(t,e)}catch(t){g=!1}return o(t,e,i)},e.wrapImageData=function(t,e,i,a){if(!e||!i)throw new Error("Cannot construct image data without dimensions");if(g)try{return new ImageData(t,e,i)}catch(t){g=!1}var r=o(e,i,a);return r.data.set(t,0),r},e.resampleHermite=function(t,e,i,a,r,h,n,o){void 0===a&&(a=0),void 0===r&&(r=0),void 0===h&&(h=t.width-a),void 0===n&&(n=t.height-r),void 0===o&&(o=!1);for(var l=t.data,g=e.width,d=e.height,u=e.data,f=h/g,c=n/d,w=Math.ceil(f/2),s=Math.ceil(c/2),m=t.width,p=0;p<d;p++)for(var M=0;M<g;M++){for(var v=4*(M+(o?d-p-1:p)*g),y=0,x=0,b=0,S=0,D=0,j=0,I=(p+.5)*c,R=Math.floor(p*c);R<(p+1)*c;R++)for(var U=Math.abs(I-(R+.5))/s,q=(M+.5)*f,P=U*U,_=Math.floor(M*f);_<(M+1)*f;_++){var C=Math.abs(q-(_+.5))/w,E=Math.sqrt(P+C*C);if(!(E>=1)){var H=2*E*E*E-3*E*E+1,k=4*(a+_+(r+R)*m);j+=H*l[k+3],x+=H,!i&&l[k+3]<255&&(H=H*l[k+3]/255),b+=H*l[k],S+=H*l[k+1],D+=H*l[k+2],y+=H}}u[v]=b/y,u[v+1]=S/y,u[v+2]=D/y,u[v+3]=j/x}return e},e.screenshotSuperSampleSettings=function(t,e,a){if(!e)return t;var r=t.framebufferWidth,h=t.framebufferHeight,n=t.pixelRatio,o=t.region,l=d(t,a),g=l.left+l.right,u=l.top+l.bottom,f=r-g,c=h-u,w=Math.min(8,Math.min((2048-g)/f,(2048-u)/c));return w<1.5?t:i.__assign(i.__assign({},t),{framebufferWidth:Math.round(f*w)+g,framebufferHeight:Math.round(c*w)+u,pixelRatio:n*w,resample:{region:{x:Math.round((o.x-l.left)*w)+l.left,y:Math.round((o.y-l.top)*w)+l.top,width:Math.round(o.width*w),height:Math.round(o.height*w)},width:r,height:h}})};var l=null,g=!0;function d(t,e){return!e||t&&t.ignorePadding?w:e}var u={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},f="jpg",c={png:100,jpg:98,jpeg:98},w={top:0,right:0,bottom:0,left:0}}));