// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/maybe","../../core/promiseUtils","../../core/Queue","../../core/scheduling"],function(e,t,s,r,o,n,i,c){function u(e){return e&&"function"==typeof e.then}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){this.item=e,this.controller=t,this.promise=null}return e}(),p=function(){function e(e){var t=this;this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new i({peeker:e.peeker}),this.process=e.process;var s=e.scheduler;e.priority&&s&&(this._task=s.registerTask(e.priority,function(e){return t.update(e)},function(){return t.needsUpdate()}))}return e.prototype.destroy=function(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)},Object.defineProperty(e.prototype,"length",{get:function(){return this._processingItems.size+this._queue.length},enumerable:!0,configurable:!0}),e.prototype.abort=function(e){var t=this._controllers.get(e);t&&t.abort()},e.prototype.clear=function(){this._queue.clear();var e=[];this._controllers.forEach(function(t){return e.push(t)}),this._controllers.clear(),e.forEach(function(e){return e.abort()}),this._processingItems.clear(),this._cancelNext()},e.prototype.get=function(e){var t=this._deferreds.get(e);return t?t.promise:void 0},e.prototype.isOngoing=function(e){return this._processingItems.has(e)},e.prototype.has=function(e){return this._deferreds.has(e)},e.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())},e.prototype.push=function(e){return r(this,void 0,void 0,function(){var t,r,o,i,c,u,h=this;return s(this,function(s){return(t=this.get(e))?[2,t]:(o=n.createAbortController(),i=function(){var t=h._processingItems.get(e);t&&t.controller.abort(),c(),r.reject(n.createAbortError())},c=function(){u.remove(),h._deferreds.delete(e),h._controllers.delete(e),h._queue.remove(e),h._processingItems.delete(e),h._scheduleNext()},u=n.onAbortOrThrow(o.signal,i),r=n.createDeferred(),this._deferreds.set(e,r),this._controllers.set(e,o),r.promise.then(c,c),this._queue.push(e),this._scheduleNext(),[2,r.promise])})})},e.prototype.reset=function(){var e=[];this._processingItems.forEach(function(t){return e.push(t)}),this._processingItems.clear();for(var t=0,s=e;t<s.length;t++){var r=s[t];this._queue.push(r.item),r.controller.abort()}this._scheduleNext()},e.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())},e.prototype.needsUpdate=function(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency},e.prototype.update=function(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()},e.prototype._scheduleNext=function(){var e=this;this._task||this._isPaused||this._schedule||(this._schedule=c.schedule(function(){e._schedule=null,e._next()}))},e.prototype._next=function(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())},e.prototype._cancelNext=function(){this._schedule&&(this._schedule.remove(),this._schedule=null)},e.prototype._processResult=function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))},e.prototype._processError=function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))},e.prototype._canProcessFulfillment=function(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e},e.prototype._process=function(e){var t=this;if(!o.isNone(e)){var s,r=n.createAbortController(),i=new h(e,r);this._processingItems.set(e,i);try{s=this.process(e,r.signal)}catch(e){this._processError(i,e)}u(s)?(i.promise=s,s.then(function(e){return t._processResult(i,e)},function(e){return t._processError(i,e)})):this._processResult(i,s)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{update:function(t){return e.update(t)}}},enumerable:!0,configurable:!0}),e}();t.QueueProcessor=p});