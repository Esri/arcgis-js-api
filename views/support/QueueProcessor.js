// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../core/maybe","../../core/promiseUtils","../../core/Queue","../../core/scheduling"],(function(e,t,s,r,o,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QueueProcessor=void 0;var i=function(e,t){this.item=e,this.controller=t,this.promise=null},u=function(){function e(e){var t=this;this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new o.default(e.peeker),this.process=e.process;var r=e.scheduler;e.task&&s.isSome(r)&&(this._task=r.registerTask(e.task,(function(e){return t.update(e)}),(function(){return t.needsUpdate()})))}return e.prototype.destroy=function(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)},Object.defineProperty(e.prototype,"length",{get:function(){return this._processingItems.size+this._queue.length},enumerable:!1,configurable:!0}),e.prototype.abort=function(e){var t=this._controllers.get(e);t&&t.abort()},e.prototype.clear=function(){this._queue.clear();var e=[];this._controllers.forEach((function(t){return e.push(t)})),this._controllers.clear(),e.forEach((function(e){return e.abort()})),this._processingItems.clear(),this._cancelNext()},e.prototype.forEach=function(e){this._deferreds.forEach((function(t,s){return e(s)}))},e.prototype.get=function(e){var t=this._deferreds.get(e);return t?t.promise:void 0},e.prototype.isOngoing=function(e){return this._processingItems.has(e)},e.prototype.has=function(e){return this._deferreds.has(e)},e.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())},e.prototype.push=function(e,t){var o,n=this,i=this.get(e);if(i)return i;var u=r.createAbortController(),c=null;t&&(c=r.onAbort(t,(function(){return u.abort()})));var h=function(){p.remove(),s.isSome(c)&&c.remove(),n._deferreds.delete(e),n._controllers.delete(e),n._queue.remove(e),n._processingItems.delete(e),n._scheduleNext()},p=r.onAbortOrThrow(u.signal,(function(){var t=n._processingItems.get(e);t&&t.controller.abort(),h(),o.reject(r.createAbortError())}));return o=r.createDeferred(),this._deferreds.set(e,o),this._controllers.set(e,u),o.promise.then(h,h),this._queue.push(e),this._scheduleNext(),o.promise},e.prototype.reset=function(){var e=[];this._processingItems.forEach((function(t){return e.push(t)})),this._processingItems.clear();for(var t=0,s=e;t<s.length;t++){var r=s[t];this._queue.push(r.item),r.controller.abort()}this._scheduleNext()},e.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())},e.prototype.takeAll=function(){for(var e=[];this._queue.length;)e.push(this._queue.pop());return this.clear(),e},e.prototype.needsUpdate=function(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency},e.prototype.update=function(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()},e.prototype._scheduleNext=function(){var e=this;this._task||this._isPaused||this._schedule||(this._schedule=n.schedule((function(){e._schedule=null,e._next()})))},e.prototype._next=function(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())},e.prototype._cancelNext=function(){this._schedule&&(this._schedule.remove(),this._schedule=null)},e.prototype._processResult=function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))},e.prototype._processError=function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))},e.prototype._canProcessFulfillment=function(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e},e.prototype._process=function(e){var t=this;if(!s.isNone(e)){var o,n,u=r.createAbortController(),c=new i(e,u);this._processingItems.set(e,c);try{o=this.process(e,u.signal)}catch(e){this._processError(c,e)}(n=o)&&"function"==typeof n.then?(c.promise=o,o.then((function(e){return t._processResult(c,e)}),(function(e){return t._processError(c,e)}))):this._processResult(c,o)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{update:function(t){return e.update(t)}}},enumerable:!1,configurable:!0}),e}();t.QueueProcessor=u}));