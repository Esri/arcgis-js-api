/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Handles","../../core/maybe","../../core/reactiveUtils","../../core/scheduling","../../core/watchUtils","../../core/accessorSupport/get","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass"],(function(e,t,n,s,a,i,d,r,o,c,h,l){"use strict";e.WatchUpdatingTracking=function(e){function n(){var t;return(t=e.apply(this,arguments)||this).updating=!1,t.handleId=0,t.handles=new a,t.scheduleHandleId=0,t.pendingPromises=new Set,t}t._inheritsLoose(n,e);var s=n.prototype;return s.destroy=function(){this.removeAll(),this.handles.destroy()},s.add=function(e,t,n,s=0){const a=0!=(1&s),i=++this.handleId;a||this.installSyncUpdatingWatch(e,t,i);const d=0!=(2&s)?o.init(e,t,n,a):e.watch(t,n,a);return this.handles.add(d,i),{remove:()=>this.handles.remove(i)}},s.addOnCollectionPropertyChange=function(e,t,n,s=0){const a=0!=(2&s),i=++this.handleId;return this.handles.add([o.on(e,t,"after-changes",this.createSyncUpdatingCallback()),o.on(e,t,"change",n,a?e=>{n({added:e.items,removed:[],moved:[],target:e})}:void 0)],i),{remove:()=>{this.handles.remove(i)}}},s.addOnCollectionChange=function(e,t,n=0){const s=0!=(2&n),a=++this.handleId;return this.handles.add([e.on("after-changes",this.createSyncUpdatingCallback()),e.on("change",t)],a),s&&t({added:e.items,removed:[],moved:[],target:e}),{remove:()=>{this.handles.remove(a)}}},s.addPromise=function(e){if(i.isNone(e))return e;const t=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(e)&&(0!==this.pendingPromises.size||this.handles.has(u)||this._set("updating",!1))}},t),this.pendingPromises.add(e),this._set("updating",!0);const n=()=>this.handles.remove(t);return e.then(n,n),e},s.removeAll=function(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)},s.installSyncUpdatingWatch=function(e,t,n){const s=this.createSyncUpdatingCallback(),a=d.react((()=>c.valueOf(e,t)),s,{sync:!0,equals:()=>!1});return this.handles.add(a,n),a},s.createSyncUpdatingCallback=function(){return()=>{this.handles.remove(u),++this.scheduleHandleId;const e=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(r.schedule((()=>{e===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(u))})),u)}},n}(s),n.__decorate([h.property({readOnly:!0})],e.WatchUpdatingTracking.prototype,"updating",void 0),e.WatchUpdatingTracking=n.__decorate([l.subclass("esri.views.support.WatchUpdatingTracking")],e.WatchUpdatingTracking);const u=-42;Object.defineProperty(e,"__esModule",{value:!0})}));
