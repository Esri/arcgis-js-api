/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../request","../../geometry/Point","../../geometry/projection","../../layers/support/rasterFunctions/rasterProjectionHelper","../webgl/BufferObject","../webgl/FramebufferObject","../../core/has","../webgl/checkWebGLError","../webgl/enums","../../chunks/builtins","../webgl/ProgramCache","../webgl/RenderingContext","../webgl/Texture","../webgl/VertexArrayObject","../2d/engine/Bitmap","../2d/engine/webgl/VertexStream","../2d/engine/webgl/shaders/MaterialPrograms","../webgl/rasterUtils"],(function(t,e,r,i,a,n,s,o,c,h,p,m,u,g,d,x,l,_,f,w){"use strict";let b=function(){function t(t){if(t)this._ownsRctx=!1,this._rctx=t;else{this._ownsRctx=!0;const t=document.createElement("canvas").getContext("webgl");t.getExtension("OES_texture_float"),this._rctx=new g(t)}const e=f.createProgramTemplate("raster/reproject","raster/reproject",new Map([["a_position",0]])),r=new u(this._rctx);this._program=r.getProgram(e,{applyProjection:!0,bilinear:!1,bicubic:!1}),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new _(this._rctx,[0,0,1,0,0,1,1,1])}var s=t.prototype;return s.reprojectTexture=function(t,e,r=!1){const s=a.project(t.extent,e),c=new i({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:h,y:p}=n.projectResolution(c,e,t.extent);let m=(h+p)/2;const u=Math.round((s.xmax-s.xmin)/m),g=Math.round((s.ymax-s.ymin)/m);m=(s.width/u+s.height/g)/2;const x=new i({x:m,y:m,spatialReference:s.spatialReference}),l=n.getProjectionOffsetGrid(s,t.extent,x,null,null,!0,[16,16]),_=w.createTransformTexture(this._rctx,l),f=new d(this._rctx,{width:u,height:g,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1}),b=new o(this._rctx,{colorTarget:0,depthStencilTarget:0,width:u,height:g},f);if(this._rctx.bindFramebuffer(b),this._rctx.setViewport(0,0,u,g),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(_,1),this._quad.bind(),this._program.setUniform2f("u_srcImageSize",t.texture.descriptor.width,t.texture.descriptor.height),this._program.setUniform2fv("u_transformSpacing",l.spacing),this._program.setUniform2fv("u_transformGridSize",l.size),this._program.setUniform2f("u_targetImageSize",u,g),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),_.dispose(),r){const t=new ImageData(b.descriptor.width,b.descriptor.height);return b.readPixels(0,0,b.descriptor.width,b.descriptor.height,6408,5121,t.data),b.detachColorTexture(36064),b.dispose(),{texture:f,extent:s,imageData:t}}return b.detachColorTexture(36064),b.dispose(),{texture:f,extent:s}},s.reprojectBitmapData=function(t,e){const r=l.isImageSource(t.bitmapData)?l.rasterize(t.bitmapData):t.bitmapData,i=new d(this._rctx,{width:t.bitmapData.width,height:t.bitmapData.height,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1},r),a=this.reprojectTexture({texture:i,extent:t.extent},e,!0);a.texture.dispose();const n=document.createElement("canvas");n.width=a.imageData.width,n.height=a.imageData.height;return n.getContext("2d").putImageData(a.imageData,0,0),{bitmapData:n,extent:a.extent}},s.loadAndReprojectBitmapData=function(){var t=e._asyncToGenerator((function*(t,e,i){const a=(yield r(t,{responseType:"image"})).data,n=document.createElement("canvas");n.width=a.width,n.height=a.height;const s=n.getContext("2d");s.drawImage(a,0,0);const o=s.getImageData(0,0,n.width,n.height),c=this.reprojectBitmapData({bitmapData:o,extent:e},i);return{bitmapData:c.bitmapData,extent:c.extent}}));function i(e,r,i){return t.apply(this,arguments)}return i}(),s.destroy=function(){this._quad.dispose(),this._program.dispose(),this._ownsRctx&&this._rctx.dispose()},t}();t.ImageReprojector=b,Object.defineProperty(t,"__esModule",{value:!0})}));
