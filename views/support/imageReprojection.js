/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../request","../../geometry/Point","../../geometry/projection","../../layers/support/rasterFunctions/rasterProjectionHelper","../2d/engine/Bitmap","../2d/engine/webgl/VertexStream","../2d/engine/webgl/shaders/MaterialPrograms","../webgl/FramebufferObject","../webgl/ProgramCache","../webgl/rasterUtils","../webgl/RenderingContext","../webgl/Texture"],(function(t,e,r,i,a,n,s,o,c,p,h,m,d,x){"use strict";let g=function(){function t(t){if(t)this._ownsRctx=!1,this._rctx=t;else{this._ownsRctx=!0;const t=document.createElement("canvas").getContext("webgl");t.getExtension("OES_texture_float"),this._rctx=new d.RenderingContext(t,{})}const e=c.createProgramTemplate("raster/reproject","raster/reproject",new Map([["a_position",0]])),r=new h(this._rctx);this._program=r.getProgram(e,{applyProjection:!0,bilinear:!1,bicubic:!1}),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new o(this._rctx,[0,0,1,0,0,1,1,1])}var g=t.prototype;return g.reprojectTexture=function(t,e,r=!1){const s=a.project(t.extent,e),o=new i({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:c,y:h}=n.projectResolution(o,e,t.extent);let d=(c+h)/2;const g=Math.round((s.xmax-s.xmin)/d),u=Math.round((s.ymax-s.ymin)/d);d=(s.width/g+s.height/u)/2;const l=new i({x:d,y:d,spatialReference:s.spatialReference}),_=n.getProjectionOffsetGrid({projectedExtent:s,srcBufferExtent:t.extent,pixelSize:l,hasWrapAround:!0,spacing:[16,16]}),f=m.createTransformTexture(this._rctx,_),w=new x(this._rctx,{width:g,height:u,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1}),b=new p(this._rctx,{colorTarget:0,depthStencilTarget:0,width:g,height:u},w);if(this._rctx.bindFramebuffer(b),this._rctx.setViewport(0,0,g,u),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(f,1),this._quad.bind(),this._program.setUniform2f("u_srcImageSize",t.texture.descriptor.width,t.texture.descriptor.height),this._program.setUniform2fv("u_transformSpacing",_.spacing),this._program.setUniform2fv("u_transformGridSize",_.size),this._program.setUniform2f("u_targetImageSize",g,u),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),f.dispose(),r){const t=new ImageData(b.descriptor.width,b.descriptor.height);return b.readPixels(0,0,b.descriptor.width,b.descriptor.height,6408,5121,t.data),b.detachColorTexture(36064),b.dispose(),{texture:w,extent:s,imageData:t}}return b.detachColorTexture(36064),b.dispose(),{texture:w,extent:s}},g.reprojectBitmapData=function(t,e){const r=s.isImageSource(t.bitmapData)?s.rasterize(t.bitmapData):t.bitmapData,i=new x(this._rctx,{width:t.bitmapData.width,height:t.bitmapData.height,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1},r),a=this.reprojectTexture({texture:i,extent:t.extent},e,!0);a.texture.dispose();const n=document.createElement("canvas");n.width=a.imageData.width,n.height=a.imageData.height;return n.getContext("2d").putImageData(a.imageData,0,0),{bitmapData:n,extent:a.extent}},g.loadAndReprojectBitmapData=function(){var t=e._asyncToGenerator((function*(t,e,i){const a=(yield r(t,{responseType:"image"})).data,n=document.createElement("canvas");n.width=a.width,n.height=a.height;const s=n.getContext("2d");s.drawImage(a,0,0);const o=s.getImageData(0,0,n.width,n.height),c=this.reprojectBitmapData({bitmapData:o,extent:e},i);return{bitmapData:c.bitmapData,extent:c.extent}}));function i(e,r,i){return t.apply(this,arguments)}return i}(),g.destroy=function(){this._quad.dispose(),this._program.dispose(),this._ownsRctx&&this._rctx.dispose()},t}();t.ImageReprojector=g,Object.defineProperty(t,"__esModule",{value:!0})}));
