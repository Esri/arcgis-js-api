/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../request","../../geometry/Point","../../geometry/projection","../../layers/support/rasterFunctions/rasterProjectionHelper","../2d/engine/Bitmap","../2d/engine/webgl/VertexStream","../2d/engine/webgl/shaders/MaterialPrograms","../webgl/enums","../webgl/FramebufferObject","../webgl/rasterUtils","../webgl/RenderingContext","../webgl/Texture"],(function(e,t,r,i,a,n,s,o,c,p,h,u,m,x){"use strict";let d=function(){function e(t){if(t)this._ownsRctx=!1,this._rctx=t;else{if(e._instance)return e._instanceRefCount++,e._instance;e._instanceRefCount=1,e._instance=this,this._ownsRctx=!0;const t=document.createElement("canvas").getContext("webgl");t.getExtension("OES_texture_float"),this._rctx=new m.RenderingContext(t,{})}const r={applyProjection:!0,bilinear:!1,bicubic:!1},i=c.createProgramTemplate("raster/reproject","raster/reproject",new Map([["a_position",0]]),r);this._program=this._rctx.programCache.acquire(i.shaders.vertexShader,i.shaders.fragmentShader,i.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new o(this._rctx,[0,0,1,0,0,1,1,1])}var d=e.prototype;return d.reprojectTexture=function(e,t,r=!1){const s=a.project(e.extent,t),o=new i({x:(e.extent.xmax-e.extent.xmin)/e.texture.descriptor.width,y:(e.extent.ymax-e.extent.ymin)/e.texture.descriptor.height,spatialReference:e.extent.spatialReference}),{x:c,y:m}=n.projectResolution(o,t,e.extent);let d=(c+m)/2;const g=Math.round((s.xmax-s.xmin)/d),_=Math.round((s.ymax-s.ymin)/d);d=(s.width/g+s.height/_)/2;const l=new i({x:d,y:d,spatialReference:s.spatialReference}),f=n.getProjectionOffsetGrid({projectedExtent:s,srcBufferExtent:e.extent,pixelSize:l,hasWrapAround:!0,spacing:[16,16]}),T=u.createTransformTexture(this._rctx,f),w=new x.Texture(this._rctx,{width:g,height:_,pixelFormat:p.PixelFormat.RGBA,dataType:p.PixelType.UNSIGNED_BYTE,wrapMode:p.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:p.TextureSamplingMode.LINEAR,hasMipmap:!1}),b=new h.FramebufferObject(this._rctx,{colorTarget:p.TargetType.TEXTURE,depthStencilTarget:p.DepthStencilTargetType.NONE,width:g,height:_},w);if(this._rctx.bindFramebuffer(b),this._rctx.setViewport(0,0,g,_),this._rctx.useProgram(this._program),this._rctx.bindTexture(e.texture,0),this._rctx.bindTexture(T,1),this._quad.bind(),this._program.setUniform2f("u_srcImageSize",e.texture.descriptor.width,e.texture.descriptor.height),this._program.setUniform2fv("u_transformSpacing",f.spacing),this._program.setUniform2fv("u_transformGridSize",f.size),this._program.setUniform2f("u_targetImageSize",g,_),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),T.dispose(),r){const e=new ImageData(b.descriptor.width,b.descriptor.height);return b.readPixels(0,0,b.descriptor.width,b.descriptor.height,p.PixelFormat.RGBA,p.PixelType.UNSIGNED_BYTE,e.data),b.detachColorTexture(p.ColorAttachment.COLOR_ATTACHMENT0),b.dispose(),{texture:w,extent:s,imageData:e}}return b.detachColorTexture(p.ColorAttachment.COLOR_ATTACHMENT0),b.dispose(),{texture:w,extent:s}},d.reprojectBitmapData=function(e,t){const r=s.isImageSource(e.bitmapData)?s.rasterize(e.bitmapData):e.bitmapData,i=new x.Texture(this._rctx,{width:e.bitmapData.width,height:e.bitmapData.height,pixelFormat:p.PixelFormat.RGBA,dataType:p.PixelType.UNSIGNED_BYTE,wrapMode:p.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:p.TextureSamplingMode.LINEAR,hasMipmap:!1},r),a=this.reprojectTexture({texture:i,extent:e.extent},t,!0);a.texture.dispose();const n=document.createElement("canvas");n.width=a.imageData.width,n.height=a.imageData.height;return n.getContext("2d").putImageData(a.imageData,0,0),{bitmapData:n,extent:a.extent}},d.loadAndReprojectBitmapData=function(){var e=t._asyncToGenerator((function*(e,t,i){const a=(yield r(e,{responseType:"image"})).data,n=document.createElement("canvas");n.width=a.width,n.height=a.height;const s=n.getContext("2d");s.drawImage(a,0,0);const o=s.getImageData(0,0,n.width,n.height);if(t.spatialReference.equals(i))return{bitmapData:o,extent:t};const c=this.reprojectBitmapData({bitmapData:o,extent:t},i);return{bitmapData:c.bitmapData,extent:c.extent}}));function i(t,r,i){return e.apply(this,arguments)}return i}(),d.destroy=function(){this._ownsRctx?(e._instanceRefCount--,0===e._instanceRefCount&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),e._instance=null)):(this._quad.dispose(),this._program.dispose())},e}();d._instanceRefCount=0,e.ImageReprojector=d,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
