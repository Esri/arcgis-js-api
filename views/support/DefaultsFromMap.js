/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Accessor.js";import{abortMaybe as a,isSome as n,unwrap as s,isNone as i}from"../../core/maybe.js";import{createTask as r,isAborted as o}from"../../core/promiseUtils.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{supportsHeightModelInfo as c,deriveHeightModelInfoFromLayer as u}from"../../geometry/support/heightModelInfoUtils.js";import{ViewingMode as d}from"../ViewingMode.js";import{projectWithEngineOrService as f}from"./projectionUtils.js";let h=class extends t{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=a(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return n(this.userSpatialReference)?this.userSpatialReference:s(this._spatialReferenceTask.spatialReference)}get extent(){return s(this._extentTask.extent)}get heightModelInfo(){return s(this._heightModelInfoTask.heightModelInfo)}get vcsWkid(){return s(this._heightModelInfoTask.vcsWkid)}get latestVcsWkid(){return s(this._heightModelInfoTask.latestVcsWkid)}get viewingMode(){return i(this.userSpatialReference)||this.userSpatialReference.equals(s(this._spatialReferenceTask.spatialReference))?s(this._spatialReferenceTask.viewingMode):null}get tileInfo(){return s(this._tileInfoTask.tileInfo)}get mapCollections(){const e=this.map?.(),t=[];return n(this.priorityCollection)&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;let a=null;for(const i of e){const e=this._getSupportedSpatialReferences(i);if(e.length>0){const t=this._narrowDownSpatialReferenceCandidates(a,e);n(t)&&(a=t)}if(n(a)&&1===a.length)break}if(t&&(i(a)||1!==a.length))return{updating:!0};const s=this._pickSpatialReferenceCandidate(a);return{spatialReference:n(s)?s.spatialReference:null,viewingMode:n(s)?s.viewingMode:null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:t}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const t=e[0].tileInfo;return{tileInfo:t&&t.spatialReference.equals(this.spatialReference)?t:null,updating:!1}}return{updating:t}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;for(const a of e)if(c(a)){const e=u(a);if(e)return{heightModelInfo:e,vcsWkid:a.spatialReference?.vcsWkid,latestVcsWkid:a.spatialReference?.latestVcsWkid,updating:!1}}return{updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,t=e.updating,a=[];for(const s of e.layers){const e="fullExtents"in s&&s.fullExtents||(n(s.fullExtent)?[s.fullExtent]:[]),t=this.requiresExtentInSpatialReference?null:e[0],i=e.find((e=>e.spatialReference.equals(this.spatialReference)))??t;if(i)return{candidates:[{extent:i,layer:s}],updating:!1};if(this._getSupportedSpatialReferences(s).length>0)for(const n of e)a.push({extent:n,layer:s})}return{candidates:a,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(i(e)||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const s=this._pickExtentCandidate(e),l=this.spatialReference;return s.extent.equals(this._projectExtentTask.input)&&l.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:n(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(n(this._projectExtentTask.task)&&(this._projectExtentTask.task=a(this._projectExtentTask.task)),this._projectExtentTask={input:s.extent.clone(),output:null,spatialReference:l.clone(),task:r((async e=>{try{const t=await f(s.extent,l,s.layer.portalItem,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if(o(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(i(e))return t;const a=[],s=(e,t)=>n(e)?n(t)?e===t&&e:e:t;for(const n of e)for(const e of t){if(!n.spatialReference.equals(e.spatialReference))continue;const t=s(n.viewingMode,e.viewingMode);if(!1!==t){a.push({spatialReference:n.spatialReference,viewingMode:t});break}}return a.length>0?a:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return i(e)||e.length<1?n(t)?{spatialReference:t,viewingMode:null}:null:(n(t)&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==d.Local))&&(e=e.filter((({viewingMode:e})=>e!==d.Local))),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const a=[];for(const s of t){const t=this.getSpatialReferenceSupport({spatialReference:s,layer:e});if(n(t)){const e=n(t.constraints)?t.constraints:[{spatialReference:s,viewingMode:null}];for(const{spatialReference:t,viewingMode:n}of e)(!this.requiresExtentInSpatialReference||i(this.userSpatialReference)||t.equals(this.userSpatialReference))&&a.push({spatialReference:t,viewingMode:n})}}return a}_pickExtentCandidate(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]}_collectLayers(e){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],updating:!0};const t={layers:[],preloading:-1,updating:!1};for(const a of e)if(this._collectCollection(a,t),t.preloading===this.sourcePreloadCount)break;return{layers:t.layers,updating:t.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const a of e.layers){switch(this._loadMaybe(a)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":t.updating||t.layers.push(a),"layers"in a&&this._collectCollection({layers:a.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e?"not-loaded"===e.loadStatus?(e.load(),"loading"):e.loadStatus:"loaded"}};e([l()],h.prototype,"required",void 0),e([l({constructOnly:!0})],h.prototype,"map",void 0),e([l({constructOnly:!0})],h.prototype,"getSpatialReferenceSupport",void 0),e([l()],h.prototype,"defaultSpatialReference",void 0),e([l()],h.prototype,"userSpatialReference",void 0),e([l()],h.prototype,"sourcePreloadCount",void 0),e([l()],h.prototype,"priorityCollection",void 0),e([l()],h.prototype,"requiresExtentInSpatialReference",void 0),e([l()],h.prototype,"suspended",void 0),e([l({readOnly:!0})],h.prototype,"ready",null),e([l({readOnly:!0})],h.prototype,"heightModelInfoReady",null),e([l({readOnly:!0})],h.prototype,"spatialReference",null),e([l({readOnly:!0})],h.prototype,"extent",null),e([l({readOnly:!0})],h.prototype,"heightModelInfo",null),e([l({readOnly:!0})],h.prototype,"vcsWkid",null),e([l({readOnly:!0})],h.prototype,"latestVcsWkid",null),e([l({readOnly:!0})],h.prototype,"viewingMode",null),e([l({readOnly:!0})],h.prototype,"tileInfo",null),e([l({readOnly:!0})],h.prototype,"mapCollections",null),e([l({readOnly:!0})],h.prototype,"_allLayers",null),e([l({readOnly:!0})],h.prototype,"_spatialReferenceTask",null),e([l({readOnly:!0})],h.prototype,"_tileInfoTask",null),e([l({readOnly:!0})],h.prototype,"_heightModelInfoTask",null),e([l({readOnly:!0})],h.prototype,"_extentCandidatesTask",null),e([l()],h.prototype,"_extentTask",null),e([l()],h.prototype,"_projectExtentTask",void 0),h=e([p("esri.views.support.DefaultsFromMap")],h);export{h as DefaultsFromMap};
