/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/support/heightModelInfoUtils","../ViewingMode","./projectionUtils"],(function(e,t,a,r,n,o,s,i,l,p,u,c,d,f){"use strict";e.DefaultsFromMap=function(e){function a(t){var a;return(a=e.call(this,t)||this).required={tileInfo:!1,heightModelInfo:!1,extent:!1},a.defaultSpatialReference=null,a.userSpatialReference=null,a.sourcePreloadCount=10,a.priorityCollection=null,a.requiresExtentInSpatialReference=!0,a.suspended=!1,a._projectExtentTask={task:null,input:null,output:null,spatialReference:null},a}t._inheritsLoose(a,e);var r=a.prototype;return r.destroy=function(){this._projectExtentTask.task&&(this._projectExtentTask.task=o.abortMaybe(this._projectExtentTask.task)),this._set("map",null)},r._narrowDownSpatialReferenceCandidates=function(e,t){if(o.isNone(e))return t;const a=[],r=(e,t)=>o.isSome(e)?o.isSome(t)?e===t&&e:e:t;for(const n of e)for(const e of t){if(!n.spatialReference.equals(e.spatialReference))continue;const t=r(n.viewingMode,e.viewingMode);if(!1!==t){a.push({spatialReference:n.spatialReference,viewingMode:t});break}}return a.length>0?a:null},r._pickSpatialReferenceCandidate=function(e){const t=this.defaultSpatialReference;return o.isNone(e)||e.length<1?o.isSome(t)?{spatialReference:t,viewingMode:null}:null:(o.isSome(t)&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==d.ViewingMode.Local))&&(e=e.filter((({viewingMode:e})=>e!==d.ViewingMode.Local))),e[0])},r._getSupportedSpatialReferences=function(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const a=[];for(const r of t){const t=this.getSpatialReferenceSupport({spatialReference:r,layer:e});if(o.isSome(t)){const e=o.isSome(t.constraints)?t.constraints:[{spatialReference:r,viewingMode:null}];for(const{spatialReference:t,viewingMode:r}of e)(!this.requiresExtentInSpatialReference||o.isNone(this.userSpatialReference)||t.equals(this.userSpatialReference))&&a.push({spatialReference:t,viewingMode:r})}}return a},r._pickExtentCandidate=function(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]},r._collectLayers=function(e){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],updating:!0};const t={layers:[],preloading:-1,updating:!1};for(const a of e)if(this._collectCollection(a,t),t.preloading===this.sourcePreloadCount)break;return{layers:t.layers,updating:t.updating}},r._collectCollection=function(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const a of e.layers){switch(this._loadMaybe(a)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":t.updating||t.layers.push(a),"layers"in a&&this._collectCollection({layers:a.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}},r._loadMaybe=function(e){return e&&"loadStatus"in e?"not-loaded"===e.loadStatus?(e.load().catch((()=>{})),"loading"):e.loadStatus:"loaded"},t._createClass(a,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},{key:"spatialReference",get:function(){return o.isSome(this.userSpatialReference)?this.userSpatialReference:o.unwrap(this._spatialReferenceTask.spatialReference)}},{key:"extent",get:function(){return o.unwrap(this._extentTask.extent)}},{key:"heightModelInfo",get:function(){return o.unwrap(this._heightModelInfoTask.heightModelInfo)}},{key:"vcsWkid",get:function(){return o.unwrap(this._heightModelInfoTask.vcsWkid)}},{key:"latestVcsWkid",get:function(){return o.unwrap(this._heightModelInfoTask.latestVcsWkid)}},{key:"viewingMode",get:function(){return o.isNone(this.userSpatialReference)||this.userSpatialReference.equals(o.unwrap(this._spatialReferenceTask.spatialReference))?o.unwrap(this._spatialReferenceTask.viewingMode):null}},{key:"tileInfo",get:function(){return o.unwrap(this._tileInfoTask.tileInfo)}},{key:"mapCollections",get:function(){const e=this.map?.(),t=[];return o.isSome(this.priorityCollection)&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}},{key:"_allLayers",get:function(){return this._collectLayers(this.mapCollections)}},{key:"_spatialReferenceTask",get:function(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;let a=null;for(const n of e){const e=this._getSupportedSpatialReferences(n);if(e.length>0){const t=this._narrowDownSpatialReferenceCandidates(a,e);o.isSome(t)&&(a=t)}if(o.isSome(a)&&1===a.length)break}if(t&&(o.isNone(a)||1!==a.length))return{updating:!0};const r=this._pickSpatialReferenceCandidate(a);return{spatialReference:o.isSome(r)?r.spatialReference:null,viewingMode:o.isSome(r)?r.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:t}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const t=e[0].tileInfo;return{tileInfo:t&&t.spatialReference.equals(this.spatialReference)?t:null,updating:!1}}return{updating:t}}},{key:"_heightModelInfoTask",get:function(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;for(const a of e)if(c.supportsHeightModelInfo(a)){const e=c.deriveHeightModelInfoFromLayer(a);if(e)return{heightModelInfo:e,vcsWkid:a.spatialReference?.vcsWkid,latestVcsWkid:a.spatialReference?.latestVcsWkid,updating:!1}}return{updating:t}}},{key:"_extentCandidatesTask",get:function(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,t=e.updating,a=[];for(const r of e.layers){const e="fullExtents"in r&&r.fullExtents||(o.isSome(r.fullExtent)?[r.fullExtent]:[]),t=this.requiresExtentInSpatialReference?null:e[0],n=e.find((e=>e.spatialReference.equals(this.spatialReference)))??t;if(n)return{candidates:[{extent:n,layer:r}],updating:!1};if(this._getSupportedSpatialReferences(r).length>0)for(const o of e)a.push({extent:o,layer:r})}return{candidates:a,updating:t}}},{key:"_extentTask",get:function(){var e=this;const{candidates:a,updating:r}=this._extentCandidatesTask;if(r)return{updating:r};if(o.isNone(a)||0===a.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(a),l=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&l.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:o.isSome(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(o.isSome(this._projectExtentTask.task)&&(this._projectExtentTask.task=o.abortMaybe(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:l.clone(),task:n.createTask(function(){var a=t._asyncToGenerator((function*(t){try{const a=yield f.projectWithEngineOrService(i.extent,l,i.layer.portalItem,t);e._projectExtentTask={...e._projectExtentTask,task:null,output:a}}catch(a){if(s.isAborted(t))return;e._projectExtentTask={...e._projectExtentTask,task:null}}}));return function(e){return a.apply(this,arguments)}}())},{updating:!0})}}]),a}(r),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"required",void 0),a.__decorate([i.property({constructOnly:!0})],e.DefaultsFromMap.prototype,"map",void 0),a.__decorate([i.property({constructOnly:!0})],e.DefaultsFromMap.prototype,"getSpatialReferenceSupport",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"defaultSpatialReference",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"userSpatialReference",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"sourcePreloadCount",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"priorityCollection",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"requiresExtentInSpatialReference",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"suspended",void 0),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"ready",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"heightModelInfoReady",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"spatialReference",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"extent",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"heightModelInfo",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"vcsWkid",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"latestVcsWkid",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"viewingMode",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"tileInfo",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"mapCollections",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_allLayers",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_spatialReferenceTask",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_tileInfoTask",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_heightModelInfoTask",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_extentCandidatesTask",null),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"_extentTask",null),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"_projectExtentTask",void 0),e.DefaultsFromMap=a.__decorate([u.subclass("esri.views.support.DefaultsFromMap")],e.DefaultsFromMap),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
