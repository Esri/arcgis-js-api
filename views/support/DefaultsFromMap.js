/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/support/heightModelInfoUtils","../ViewingMode","./projectionUtils"],(function(e,t,n,a,i,r,o,s,l,p,d,u,c,f){"use strict";const g=a.getLogger("esri.views.support.DefaultsFromMap");g.level="info";let h=function(t){function n(e){var n;return(n=t.call(this,e)||this).required={tileInfo:!1,heightModelInfo:!1,extent:!1},n.defaultSpatialReference=null,n.userSpatialReference=null,n.sourcePreloadCount=10,n.priorityCollection=null,n.logDebugInformation=!1,n.requiresExtentInSpatialReference=!0,n.suspended=!1,n._projectExtentTask={task:null,input:null,output:null,spatialReference:null},n}e._inheritsLoose(n,t);var a=n.prototype;return a.destroy=function(){this._projectExtentTask.task&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=i.abortMaybe(this._projectExtentTask.task)),this._set("map",null)},a._processSpatialReferenceCandidates=function(e,t){var n;const a=this._getSupportedSpatialReferences(e);if(0!==a.length)if(this._debug("Spatial reference candidates from",null!=(n=e.title)?n:e.id,":",a.map((e=>`${e.spatialReference.wkid}:${i.isSome(e.viewingMode)?c.stringFromViewingMode(e.viewingMode):"global/local"}`)).join(", ")),t.candidates){const e=[],n=(e,t)=>i.isNone(e.viewingMode)?t.viewingMode:(i.isNone(t.viewingMode)||e.viewingMode===t.viewingMode)&&e.viewingMode;for(const i of t.candidates)for(const t of a){if(!i.spatialReference.equals(t.spatialReference))continue;const a=n(i,t);if(!1!==a){e.push({spatialReference:i.spatialReference,viewingMode:a});break}}e.length>0&&(t.candidates=e)}else t.candidates=a},a._pickSpatialReferenceCandidate=function(e){const t=this.defaultSpatialReference;return!e||e.length<1?i.isSome(t)?{spatialReference:t,viewingMode:null}:null:(i.isSome(t)&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==c.ViewingMode.Local))&&(e=e.filter((({viewingMode:e})=>e!==c.ViewingMode.Local))),e[0])},a._getSupportedSpatialReferences=function(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const n=[];for(const a of t){const t=this.getSpatialReferenceSupport({spatialReference:a,layer:e});if(i.isSome(t)){const e=i.isSome(t.constraints)?t.constraints:[{spatialReference:a}];for(const{spatialReference:t,viewingMode:a}of e)(!this.requiresExtentInSpatialReference||i.isNone(this.userSpatialReference)||t.equals(this.userSpatialReference))&&n.push({spatialReference:t,viewingMode:a})}}return n},a._pickExtentCandidate=function(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]},a._collectLayers=function(e){var t;if("loaded"!==this._loadMaybe(null==(t=this.map)?void 0:t.call(this)))return{layers:[],updating:!0};const n={layers:[],preloading:-1,updating:!1};for(const a of e)if(this._collectCollection(a,n),n.preloading===this.sourcePreloadCount)break;return{layers:n.layers,updating:n.updating}},a._collectCollection=function(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":var n,a;if(!t.updating)this._debug("Considering layer",null!=(n=null!=(a=i.title)?a:i.id)?n:i.declaredClass),t.layers.push(i);"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}},a._loadMaybe=function(e){return e&&"loadStatus"in e?"not-loaded"===e.loadStatus?(this._debug("Triggering load",null!=(t=null!=(n=e.title)?n:e.id)?t:e.declaredClass),e.load(),"loading"):e.loadStatus:"loaded";var t,n},a._debug=function(...e){this.logDebugInformation&&g.info(...e)},e._createClass(n,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},{key:"spatialReference",get:function(){return i.isSome(this.userSpatialReference)?this.userSpatialReference:i.unwrap(this._spatialReferenceTask.spatialReference)}},{key:"extent",get:function(){return i.unwrap(this._extentTask.extent)}},{key:"heightModelInfo",get:function(){return i.unwrap(this._heightModelInfoTask.heightModelInfo)}},{key:"vcsWkid",get:function(){return i.unwrap(this._heightModelInfoTask.vcsWkid)}},{key:"latestVcsWkid",get:function(){return i.unwrap(this._heightModelInfoTask.latestVcsWkid)}},{key:"viewingMode",get:function(){return i.isNone(this.userSpatialReference)||this.userSpatialReference.equals(i.unwrap(this._spatialReferenceTask.spatialReference))?i.unwrap(this._spatialReferenceTask.viewingMode):null}},{key:"tileInfo",get:function(){return i.unwrap(this._tileInfoTask.tileInfo)}},{key:"mapCollections",get:function(){var e,t,n,a;const r=null==(e=this.map)?void 0:e.call(this),o=[];return i.isSome(this.priorityCollection)&&o.push(this.priorityCollection),o.push({parent:null==r?void 0:r.basemap,layers:null==r||null==(t=r.basemap)?void 0:t.baseLayers},{layers:null==r?void 0:r.layers},{parent:null==r?void 0:r.ground,layers:null==r||null==(n=r.ground)?void 0:n.layers},{parent:null==r?void 0:r.basemap,layers:null==r||null==(a=r.basemap)?void 0:a.referenceLayers}),o}},{key:"_allLayers",get:function(){var e,t;const n=this._collectLayers(this.mapCollections);return this._debug("Collected",null!=(e=null==(t=n.layers)?void 0:t.length)?e:0,"layers, updating",n.updating),n}},{key:"_spatialReferenceTask",get:function(){var e,t;if(this.suspended)return null!=(t=this._get("_spatialReferenceTask"))?t:{updating:!1};const{layers:n,updating:a}=this._allLayers,r={candidates:null};for(const i of n)if(this._processSpatialReferenceCandidates(i,r),r.candidates&&1===r.candidates.length)break;if(1!==(null==(e=r.candidates)?void 0:e.length)&&a)return{updating:!0};const o=this._pickSpatialReferenceCandidate(r.candidates);return this._debug("Finished spatial reference",i.isSome(o)?`${o.spatialReference.wkid}:${i.isSome(o.viewingMode)?c.stringFromViewingMode(o.viewingMode):"global/local"}`:"none available"),{spatialReference:i.isSome(o)?o.spatialReference:null,viewingMode:i.isSome(o)?o.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){var e,t,n,a,i,r,o,s;if(!this.required.tileInfo)return null!=(s=this._get("_tileInfoTask"))?s:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:l,updating:p}=this._collectLayers([{parent:null==(e=this.map)||null==(t=e.call(this))?void 0:t.basemap,layers:null==(n=this.map)||null==(a=n.call(this))||null==(i=a.basemap)?void 0:i.baseLayers},{layers:null==(r=this.map)||null==(o=r.call(this))?void 0:o.layers}]);if(l&&l.length>0&&"tileInfo"in l[0]){const e=l[0].tileInfo;return{tileInfo:e&&e.spatialReference.equals(this.spatialReference)?e:null,updating:!1}}return{updating:p}}},{key:"_heightModelInfoTask",get:function(){var e,t;if(!this.required.heightModelInfo||this.suspended&&null!=(e=this._get("_heightModelInfoTask"))&&e.heightModelInfo)return null!=(t=this._get("_heightModelInfoTask"))?t:{updating:!1};const{layers:n,updating:a}=this._allLayers;for(const l of n){var i,r;if(this._debug("Considering",null!=(i=null!=(r=l.title)?r:l.id)?i:l.declaredClass,"for height model info"),u.mayHaveHeightModelInfo(l)){const e=u.deriveHeightModelInfoFromLayer(l);var o,s;if(e)return this._debug("Derived height model info",e),{heightModelInfo:e,vcsWkid:null==(o=l.spatialReference)?void 0:o.vcsWkid,latestVcsWkid:null==(s=l.spatialReference)?void 0:s.latestVcsWkid,updating:!1}}this._debug("Layer does not support height models")}return this._debug("No height model info found,","updating",a),{updating:a}}},{key:"_extentCandidatesTask",get:function(){var e;if(this.suspended||!this.required.extent)return null!=(e=this._get("_extentCandidatesTask"))?e:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const t=this._allLayers,n=t.updating,a=[];for(const o of t.layers){var r;const e="fullExtents"in o&&o.fullExtents||(i.isSome(o.fullExtent)?[o.fullExtent]:[]),t=this.requiresExtentInSpatialReference?null:e[0],n=null!=(r=e.find((e=>e.spatialReference.equals(this.spatialReference))))?r:t;if(n)return{candidates:[{extent:n,layer:o}],updating:!1};if(this._getSupportedSpatialReferences(o).length>0)for(const i of e)a.push({extent:i,layer:o})}return{candidates:a,updating:n}}},{key:"_extentTask",get:function(){var t=this;const{candidates:n,updating:a}=this._extentCandidatesTask;if(a)return{updating:a};if(i.isNone(n)||0===n.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const o=this._pickExtentCandidate(n),s=this.spatialReference;return o.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:i.isSome(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(i.isSome(this._projectExtentTask.task)&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=i.abortMaybe(this._projectExtentTask.task)),this._debug("Starting project extent task for",o.extent),this._projectExtentTask={input:o.extent.clone(),output:null,spatialReference:s.clone(),task:r.createTask(function(){var n=e._asyncToGenerator((function*(e){try{const n=yield f.projectWithEngineOrService(o.extent,s,o.layer.portalItem,e);t._debug("Project extent task finished",n),t._projectExtentTask={...t._projectExtentTask,task:null,output:n}}catch(n){if(r.isAborted(e))return;t._projectExtentTask={...t._projectExtentTask,task:null}}}));return function(e){return n.apply(this,arguments)}}())},{updating:!0})}}]),n}(n);t.__decorate([o.property()],h.prototype,"required",void 0),t.__decorate([o.property({constructOnly:!0})],h.prototype,"map",void 0),t.__decorate([o.property({constructOnly:!0})],h.prototype,"getSpatialReferenceSupport",void 0),t.__decorate([o.property()],h.prototype,"defaultSpatialReference",void 0),t.__decorate([o.property()],h.prototype,"userSpatialReference",void 0),t.__decorate([o.property()],h.prototype,"sourcePreloadCount",void 0),t.__decorate([o.property()],h.prototype,"priorityCollection",void 0),t.__decorate([o.property()],h.prototype,"logDebugInformation",void 0),t.__decorate([o.property()],h.prototype,"requiresExtentInSpatialReference",void 0),t.__decorate([o.property()],h.prototype,"suspended",void 0),t.__decorate([o.property({readOnly:!0})],h.prototype,"ready",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"heightModelInfoReady",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"spatialReference",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"extent",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"heightModelInfo",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"vcsWkid",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"latestVcsWkid",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"viewingMode",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"tileInfo",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"mapCollections",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"_allLayers",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"_spatialReferenceTask",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"_tileInfoTask",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"_heightModelInfoTask",null),t.__decorate([o.property({readOnly:!0})],h.prototype,"_extentCandidatesTask",null),t.__decorate([o.property()],h.prototype,"_extentTask",null),t.__decorate([o.property()],h.prototype,"_projectExtentTask",void 0),h=t.__decorate([d.subclass("esri.views.support.DefaultsFromMap")],h);return h}));
