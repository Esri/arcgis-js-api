/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Handles","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../geometry/projection","../../geometry/support/heightModelInfoUtils","../ViewingMode"],(function(e,t,n,a,i,r,o,s,l,p,d,u,c,f,h,g){"use strict";const y=10,_=r.getLogger("esri.views.support.DefaultsFromMap");_.level="info";let k=function(n){function a(e){var t;return(t=n.call(this,e)||this)._handles=new i,t.required={tileInfo:!1,heightModelInfo:!1,extent:!1},t.defaultSpatialReference=null,t.userSpatialReference=null,t.priorityCollection=null,t.logDebugInformation=!1,t.suspended=!1,t._projectExtentTask={task:null,input:null,output:null,spatialReference:null},t}t._inheritsLoose(a,n);var r=a.prototype;return r.destroy=function(){this._handles=o.destroyMaybe(this._handles),this._projectExtentTask.task&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=o.abortMaybe(this._projectExtentTask.task)),this._set("map",null)},r._processSpatialReferenceCandidates=function(e,t){var n;const a=this._getSupportedSpatialReferences(e);if(0!==a.length)if(this._debug("Spatial reference candidates from",null!=(n=e.title)?n:e.id,":",a.map((e=>`${e.spatialReference.wkid}:${o.isSome(e.viewingMode)?g.stringFromViewingMode(e.viewingMode):"global/local"}`)).join(", ")),t.candidates){const e=[],n=(e,t)=>o.isNone(e.viewingMode)?t.viewingMode:(o.isNone(t.viewingMode)||e.viewingMode===t.viewingMode)&&e.viewingMode;for(const i of t.candidates)for(const t of a){if(!i.spatialReference.equals(t.spatialReference))continue;const a=n(i,t);if(!1!==a){e.push({spatialReference:i.spatialReference,viewingMode:a});break}}e.length>0&&(t.candidates=e)}else t.candidates=a},r._pickSpatialReferenceCandidate=function(e){const t=this.defaultSpatialReference;return!e||e.length<1?o.isSome(t)?{spatialReference:t,viewingMode:null}:null:o.isSome(t)&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))?{spatialReference:t,viewingMode:null}:e[0]},r._getSupportedSpatialReferences=function(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const n=[];for(const a of t){const t=this.getSpatialReferenceSupport({spatialReference:a,layer:e});if(o.isSome(t)){const e=o.isSome(t.constraints)?t.constraints:[{spatialReference:a}];for(const{spatialReference:t,viewingMode:a}of e)(o.isNone(this.userSpatialReference)||t.equals(this.userSpatialReference))&&n.push({spatialReference:t,viewingMode:a})}}return n},r._pickExtentCandidate=function(e){const t=this.spatialReference,n=e.find((({extent:e})=>f.canProjectWithoutEngine(e.spatialReference,t)||f.isLoaded()));return o.isSome(n)?{candidate:n,requiresGeometryService:!1}:{candidate:e[0],requiresGeometryService:!0}},r._collectLayers=function(e){var t;if("loaded"!==this._loadMaybe(null==(t=this.map)?void 0:t.call(this)))return{layers:[],updating:!0};const n={layers:[],preloading:-1,updating:!1};for(const a of e)if(this._collectCollection(a,n),n.preloading===y)break;return{layers:n.layers,updating:n.updating}},r._collectCollection=function(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":var n,a;if(!t.updating)this._debug("Considering layer",null!=(n=null!=(a=i.title)?a:i.id)?n:i.declaredClass),t.layers.push(i);"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.preloading===y)break}}},r._loadMaybe=function(e){return e&&"loadStatus"in e?"not-loaded"===e.loadStatus?(this._debug("Triggering load",null!=(t=null!=(n=e.title)?n:e.id)?t:e.declaredClass),e.load(),"loading"):e.loadStatus:"loaded";var t,n},r._debug=function(...e){this.logDebugInformation&&_.info(...e)},t._createClass(a,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},{key:"spatialReference",get:function(){return o.isSome(this.userSpatialReference)?this.userSpatialReference:o.unwrap(this._spatialReferenceTask.spatialReference)}},{key:"extent",get:function(){return o.unwrap(this._extentTask.extent)}},{key:"heightModelInfo",get:function(){return o.unwrap(this._heightModelInfoTask.heightModelInfo)}},{key:"vcsWkid",get:function(){return o.unwrap(this._heightModelInfoTask.vcsWkid)}},{key:"latestVcsWkid",get:function(){return o.unwrap(this._heightModelInfoTask.latestVcsWkid)}},{key:"viewingMode",get:function(){return o.isNone(this.userSpatialReference)||this.userSpatialReference.equals(o.unwrap(this._spatialReferenceTask.spatialReference))?o.unwrap(this._spatialReferenceTask.viewingMode):null}},{key:"tileInfo",get:function(){return o.unwrap(this._tileInfoTask.tileInfo)}},{key:"mapCollections",get:function(){var e,t,n,a;const i=null==(e=this.map)?void 0:e.call(this),r=[];return o.isSome(this.priorityCollection)&&r.push(this.priorityCollection),r.push({parent:null==i?void 0:i.basemap,layers:null==i||null==(t=i.basemap)?void 0:t.baseLayers},{layers:null==i?void 0:i.layers},{parent:null==i?void 0:i.ground,layers:null==i||null==(n=i.ground)?void 0:n.layers},{parent:null==i?void 0:i.basemap,layers:null==i||null==(a=i.basemap)?void 0:a.referenceLayers}),r}},{key:"_allLayers",get:function(){var e,t;const n=this._collectLayers(this.mapCollections);return this._debug("Collected",null!=(e=null==(t=n.layers)?void 0:t.length)?e:0,"layers, updating",n.updating),n}},{key:"_spatialReferenceTask",get:function(){var e,t;if(this.suspended)return null!=(t=this._get("_spatialReferenceTask"))?t:{updating:!1};const{layers:n,updating:a}=this._allLayers,i={candidates:null};for(const o of n)if(this._processSpatialReferenceCandidates(o,i),i.candidates&&1===i.candidates.length)break;if(1!==(null==(e=i.candidates)?void 0:e.length)&&a)return{updating:!0};const r=this._pickSpatialReferenceCandidate(i.candidates);return this._debug("Finished spatial reference",o.isSome(r)?`${r.spatialReference.wkid}:${o.isSome(r.viewingMode)?g.stringFromViewingMode(r.viewingMode):"global/local"}`:"none available"),{spatialReference:o.isSome(r)?r.spatialReference:null,viewingMode:o.isSome(r)?r.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){var e,t,n,a,i,r,o,s;if(!this.required.tileInfo)return null!=(s=this._get("_tileInfoTask"))?s:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:l,updating:p}=this._collectLayers([{parent:null==(e=this.map)||null==(t=e.call(this))?void 0:t.basemap,layers:null==(n=this.map)||null==(a=n.call(this))||null==(i=a.basemap)?void 0:i.baseLayers},{layers:null==(r=this.map)||null==(o=r.call(this))?void 0:o.layers}]);if(l&&l.length>0&&"tileInfo"in l[0]){const e=l[0].tileInfo;return{tileInfo:e&&e.spatialReference.equals(this.spatialReference)?e:null,updating:!1}}return{updating:p}}},{key:"_heightModelInfoTask",get:function(){var e,t;if(!this.required.heightModelInfo||this.suspended&&null!=(e=this._get("_heightModelInfoTask"))&&e.heightModelInfo)return null!=(t=this._get("_heightModelInfoTask"))?t:{updating:!1};const{layers:n,updating:a}=this._allLayers;for(const l of n){var i,r;if(this._debug("Considering",null!=(i=null!=(r=l.title)?r:l.id)?i:l.declaredClass,"for height model info"),h.mayHaveHeightModelInfo(l)){const e=h.deriveHeightModelInfoFromLayer(l);var o,s;if(e)return this._debug("Derived height model info",e),{heightModelInfo:e,vcsWkid:null==(o=l.spatialReference)?void 0:o.vcsWkid,latestVcsWkid:null==(s=l.spatialReference)?void 0:s.latestVcsWkid,updating:!1}}this._debug("Layer does not support height models")}return this._debug("No height model info found,","updating",a),{updating:a}}},{key:"_extentCandidatesTask",get:function(){var e;if(this.suspended||!this.required.extent)return null!=(e=this._get("_extentCandidatesTask"))?e:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const t=this._allLayers,n=t.updating,a=[];for(const i of t.layers){const e="fullExtents"in i&&i.fullExtents||(o.isSome(i.fullExtent)?[i.fullExtent]:[]),t=e.find((e=>e.spatialReference.equals(this.spatialReference)));if(t)return{candidates:[{extent:t,layer:i}],updating:!1};if(this._getSupportedSpatialReferences(i).length>0)for(const n of e)a.push({extent:n,layer:i})}return{candidates:a,updating:n}}},{key:"_extentTask",get:function(){var n=this;const{candidates:a,updating:i}=this._extentCandidatesTask;if(i)return{updating:i};if(o.isNone(a)||0===a.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{candidate:r,requiresGeometryService:l}=this._pickExtentCandidate(a),p=this.spatialReference;if(r.extent.equals(this._projectExtentTask.input)&&p.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:o.isSome(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished};if(o.isSome(this._projectExtentTask.task)&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=o.abortMaybe(this._projectExtentTask.task)),!l){this._projectExtentTask={input:null,output:null,task:null,spatialReference:null};try{return{extent:f.project(r.extent,p),updating:!1}}catch{return{updating:!1}}}return this._debug("Starting project extent task for",r.extent),this._projectExtentTask={input:r.extent.clone(),output:null,spatialReference:p.clone(),task:s.createTask(function(){var a=t._asyncToGenerator((function*(t){try{const a=yield s.whenOrAbort(new Promise(((t,n)=>e(["../../portal/support/geometryServiceUtils"],t,n))),t),i=yield a.projectGeometry(r.extent,p,r.layer.portalItem,t);n._debug("Project extent task finished",i),n._projectExtentTask={...n._projectExtentTask,task:null,output:i}}catch(a){if(s.isAborted(t))return;n._projectExtentTask={...n._projectExtentTask,task:null}}}));return function(e){return a.apply(this,arguments)}}())},{updating:!0}}}]),a}(a);n.__decorate([l.property()],k.prototype,"required",void 0),n.__decorate([l.property({constructOnly:!0})],k.prototype,"map",void 0),n.__decorate([l.property({constructOnly:!0})],k.prototype,"getSpatialReferenceSupport",void 0),n.__decorate([l.property()],k.prototype,"defaultSpatialReference",void 0),n.__decorate([l.property()],k.prototype,"userSpatialReference",void 0),n.__decorate([l.property()],k.prototype,"priorityCollection",void 0),n.__decorate([l.property()],k.prototype,"logDebugInformation",void 0),n.__decorate([l.property()],k.prototype,"suspended",void 0),n.__decorate([l.property({readOnly:!0})],k.prototype,"ready",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"heightModelInfoReady",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"spatialReference",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"extent",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"heightModelInfo",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"vcsWkid",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"latestVcsWkid",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"viewingMode",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"tileInfo",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"mapCollections",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"_allLayers",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"_spatialReferenceTask",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"_tileInfoTask",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"_heightModelInfoTask",null),n.__decorate([l.property({readOnly:!0})],k.prototype,"_extentCandidatesTask",null),n.__decorate([l.property()],k.prototype,"_extentTask",null),n.__decorate([l.property()],k.prototype,"_projectExtentTask",void 0),k=n.__decorate([c.subclass("esri.views.support.DefaultsFromMap")],k);return k}));
