// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","./kernel","./Map","./Viewpoint","./core/Collection","./core/Error","./core/Handles","./core/has","./core/lang","./core/Loadable","./core/loadAll","./core/Logger","./core/MultiOriginJSONSupport","./core/Promise","./core/promiseUtils","./core/urlUtils","./core/accessorSupport/decorators","./core/accessorSupport/originUtils","./core/accessorSupport/read","./geometry/Extent","./geometry/HeightModelInfo","./geometry/SpatialReference","./geometry/support/heightModelInfoUtils","./geometry/support/jsonUtils","./portal/Portal","./portal/PortalItem","./support/webSceneUtils","./views/3d/support/projectionUtils","./views/support/spatialReferenceSupport","./webdoc/support/saveUtils","./webdoc/support/thumbnailUtils","./webscene/ApplicationProperties","./webscene/Environment","./webscene/InitialViewProperties","./webscene/Presentation","./webscene/TransportationNetwork","./webscene/Version","@dojo/framework/shim/Promise"],(function(e,t,r,i,n,o,a,s,l,p,u,c,d,h,y,f,v,g,m,w,_,b,S,I,A,O,R,L,M,P,V,U,j,E,C,N,T,G,W){"use strict";var J=h.getLogger("esri.WebScene"),x=p("esri-debug-messages"),F=new W.default(1,21),k=function(){for(var e=[],t=F.major,r=8;r<=F.minor;r++)e.push(t+"."+r);return e};return function(t){function n(e){var i=t.call(this,e)||this;return i._handles=new l,i.applicationProperties=null,i.clippingArea=null,i.clippingEnabled=!1,i.heightModelInfo=null,i.sourceVersion=null,i.supportsHeightModelInfo=!0,i.transportationNetworks=null,i.presentation=new T,i.initialViewProperties=new N,i.portalItem=null,i.resourceInfo=null,i.debouncedSaveOperations=v.debounce((function(e,t,n){return r.__awaiter(i,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(e){case 0:return[2,this._saveImpl(t)];case 1:return[2,this._saveAsImpl(n,t)]}return[2]}))}))})),i.resourceReferences={portalItem:null,paths:[]},i.authoringApp=null,i.authoringAppVersion=null,i._isAuthoringAppSetByUser=!1,i._isAuthoringAppVersionSetByUser=!1,i}return r.__extends(n,t),n.prototype.initialize=function(){var e=this;if(this.when().catch((function(e){J.error("#load()","Failed to load web scene",e)})),this.resourceInfo){var t=void 0;try{t=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(v.reject(e))}this.read(t),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this._handles.add(this.allLayers.on("change",(function(){return e._scheduleLayersIdGC()})))},n.prototype.destroy=function(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();var e=this.portalItem;this.portalItem=null,null==e||e.destroy()},n.prototype.writeClippingArea=function(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()},n.prototype.readClippingEnabled=function(e,t){return!!t.clippingArea&&!!t.clippingArea.clip},n.prototype.writeClippingEnabled=function(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)},n.prototype.writeLayers=function(e,t,i,n){var o=this,a=r.__assign(r.__assign({},n),{layerContainerType:"operational-layers"}),s=e.map((function(e){return o.verifyWriteLayer(e,n)?e.write(null,a):null})).filter((function(e){return!!e}));t[i]=s.toArray()},n.prototype.verifyWriteLayer=function(e,t){return"write"in e||(t&&t.messages&&t.messages.push(new s("layer:unsupported","Layers ("+e.title+", "+e.id+") of type '"+e.declaredClass+"' cannot be persisted in web scenes",{layer:e})),!1)},n.prototype.readSourceVersion=function(e,t){var r=t.version.split("."),i=r[0],n=r[1];return new W.default(parseInt(i,10),parseInt(n,10))},n.prototype.writeSourceVersion=function(e,t,r){t[r]=F.major+"."+F.minor},Object.defineProperty(n.prototype,"thumbnailUrl",{get:function(){return this.portalItem&&this.portalItem.thumbnailUrl||null},set:function(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"authoringApp",{set:function(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)},enumerable:!1,configurable:!0}),n.prototype.writeAuthoringApp=function(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"},Object.defineProperty(n.prototype,"authoringAppVersion",{set:function(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)},enumerable:!1,configurable:!0}),n.prototype.writeAuthoringAppVersion=function(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=i.version},n.prototype.writeGround=function(e,t,r,i){t[r]=e?e.write(null,i):{transparency:0,layers:[]}},n.prototype.readInitialViewProperties=function(e,t){var r={};return t.initialState&&t.initialState.environment&&(r.environment=C.fromJSON(t.initialState.environment)),t.spatialReference?r.spatialReference=I.fromJSON(t.spatialReference):r.spatialReference=I.WebMercator,r.viewingMode=t.viewingMode||"global",t.initialState&&t.initialState.viewpoint&&(r.viewpoint=o.fromJSON(t.initialState.viewpoint)),new N(r)},Object.defineProperty(n.prototype,"spatialReference",{get:function(){var e,t;return null!==(t=null===(e=this.initialViewProperties)||void 0===e?void 0:e.spatialReference)&&void 0!==t?t:I.WebMercator},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"viewingMode",{get:function(){var e,t;return null!==(t=null===(e=this.initialViewProperties)||void 0===e?void 0:e.viewingMode)&&void 0!==t?t:"global"},enumerable:!1,configurable:!0}),n.prototype.load=function(e){return this.addResolvingPromise(this._loadFromSource()),v.resolve(this)},n.prototype.loadAll=function(){var e=this;return d.default(this,(function(t){var r=e.presentation&&e.presentation.slides;t(e.ground,e.basemap,e.layers,r&&r.map((function(e){return e.basemap})))}))},n.prototype.read=function(e,i){var n=this;i=r.__assign(r.__assign({},i),{origin:"web-scene"});var o=this._isAuthoringAppVersionSetByUser,a=this._isAuthoringAppSetByUser;if(_.readLoadable(this,e,(function(r){return t.prototype.read.call(n,e,r)}),i),a||(this._isAuthoringAppSetByUser=!1),o||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion.supportsVisibleElevationLayersInSlides){var s=e.baseMap.elevationLayers.map((function(e){return{id:e.id}})),l=this.presentation.slides,p=s.filter((function(e){return!l.some((function(t){return function(e,t){return e.visibleLayers.some((function(e){return e.id===t}))}(t,e.id)}))}));l.forEach((function(e){e.visibleLayers.addMany(p)}))}},n.prototype._writeBasemapElevationLayers=function(e){var t=e.ground&&e.ground.layers;!e.baseMap&&t&&t.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=u.clone(t))},n.prototype.write=function(e,i){if("loaded"!==this.loadStatus){var n=new s("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw J.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),n}this._runLayersIdGC();var o=!(null==i?void 0:i.messages);i=r.__assign(r.__assign({messages:[]},i),{origin:"web-scene"});var a=t.prototype.write.call(this,e,i);if(o){var l=i.messages.filter((function(e){return"web-document-write:property-required"===e.name}));if(l.length){n=new s("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:l});throw J.error("#toJSON()","One or more properties that are required in the webscene JSON are missing",l),n}}return this._writeBasemapElevationLayers(a),a},n.prototype.save=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this.debouncedSaveOperations(0,e)]}))}))},n.prototype._saveImpl=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n;return r.__generator(this,(function(r){switch(r.label){case 0:return this.portalItem?[3,2]:(J.error("save(): requires the .portalItem property to be set"),[4,v.reject(new s("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"))]);case 1:r.sent(),r.label=2;case 2:return"Web Scene"===this.portalItem.type?[3,4]:[4,v.reject(new s("webscene:portal-item-wrong-type",'Portal item needs to have type "Web Scene"'))];case 3:r.sent(),r.label=4;case 4:return t=this._updateFromPromise,[4,this._ensureLoadBeforeSave()];case 5:return r.sent(),i=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl&&g.urlToObject(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||R.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),n=this.write(null,i),[4,v.all(i.resources.pendingOperations)];case 6:return r.sent(),[4,this._verifySave(n,i,e)];case 7:return r.sent(),this._updateTypeKeywords(this.portalItem),[4,this.portalItem.update({data:n})];case 8:return r.sent(),[4,U.saveResources(this.resourceReferences,i,null)];case 9:return r.sent(),w.updateOrigins(i),t?[4,t]:[3,11];case 10:r.sent(),r.label=11;case 11:return[4,this._saveThumbnail()];case 12:return r.sent(),[2,this.portalItem]}}))}))},n.prototype.saveAs=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this.debouncedSaveOperations(1,t,e)]}))}))},n.prototype._saveAsImpl=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o,a,l,p;return r.__generator(this,(function(r){switch(r.label){case 0:return(i=L.from(e))?[3,2]:(J.error("saveAs(portalItem): requires a portal item parameter"),[4,v.reject(new s("webscene:portal-item-required","saveAs requires a portal item to save to"))]);case 1:r.sent(),r.label=2;case 2:return i.id&&((i=i.clone()).id=null),n=i.portal||R.getDefault(),[4,this._ensureLoadBeforeSave()];case 3:return r.sent(),i.type="Web Scene",i.portal=n,o=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:n,portalItem:i,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),a=this.write(null,o),[4,v.all(o.resources.pendingOperations)];case 4:return r.sent(),[4,this._verifySaveAs(a,o,t)];case 5:return r.sent(),l=this.thumbnailUrl,p=!this._isOverridden("thumbnailUrl"),this._updateTypeKeywords(i),[4,n._signIn()];case 6:return r.sent(),[4,n.user.addItem({item:i,folder:t&&t.folder,data:a})];case 7:return r.sent(),[4,U.saveResources(this.resourceReferences,o,null)];case 8:return r.sent(),this.portalItem=i,y.MultiOriginJSONSupport.prototype.read.call(this,{version:a.version,authoringApp:a.authoringApp,authoringAppVersion:a.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl&&g.urlToObject(i.itemUrl)}),w.updateOrigins(o),l&&(this.thumbnailUrl=p?g.addQueryParameter(l,"w","8192"):l),o.portalItem=i,[4,this._saveThumbnail()];case 9:return r.sent(),[2,i]}}))}))},n.prototype._saveThumbnail=function(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return this._isOverridden("thumbnailUrl")?[4,this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl})]:[3,2];case 1:e.sent(),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),e.label=2;case 2:return[2]}}))}))},n.prototype._verifySave=function(t,r,i,n){void 0===n&&(n=!1);var o=r.messages.filter((function(e){return"error"===e.type})).map((function(e){return new s(e.name,e.message,e.details)}));r.blockedRelativeUrls&&(o=o.concat(r.blockedRelativeUrls.map((function(e){return new s("url:unsupported","Relative url '"+e+"' is not supported in Web Scene")})))),i&&i.ignoreUnsupported&&(o=o.filter((function(e){return"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name&&"scenemodification:unsupported"!==e.name}))),(null==i?void 0:i.requiredPropertyChecksDisabled)&&(o=o.filter((function(e){return"web-document-write:property-required"!==e.name})));var a=i&&i.strictSchemaValidationEnabled;return(x||a?new Promise((function(t,r){e(["./webscene/support/schemaValidator"],t,r)})).then((function(e){var r=e.validate(t);if(r.length>0){var i="webscene did not validate:\n"+r.join("\n");J.error((n?"saveAs":"save")+"(): "+i)}return r.map((function(e){return new s("webscene:schema-validation",e)}))})).then((function(e){if(a&&e.length>0)throw M.createSchemaValidationError(e.concat(o));return o})):v.resolve(o)).then((function(e){if(e.length>0)return v.reject(new s("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:e}))}))},n.prototype._verifySaveAs=function(e,t,r){return this.canSaveAs(t)?v.reject(M.createCopyError()):this._verifySave(e,t,r,!0)},n.prototype.verifySaveAs=function(e){var t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),r=this.write(null,t);return this._verifySaveAs(r,t,e)},n.prototype.canSaveAs=function(e){return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write(null,e)),e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.length>0},n.prototype.updateFrom=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return i=this._updateFromInternal(e,t),this._updateFromPromise=i,[4,i];case 1:return r.sent(),this._updateFromPromise===i&&(this._updateFromPromise=null),[2]}}))}))},n.prototype._updateFromInternal=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,e.whenReady()];case 1:return r.sent(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=C.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,e.clippingArea?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this&&e.allLayerViews.forEach((function(e){e.layer.visible=e.visible})),!1===t.thumbnailExcluded||null==t.thumbnailExcluded&&!t.viewpointExcluded?[4,this._updateFromThumbnail(e,t.thumbnailSize||void 0)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))},n.prototype._updateFromThumbnail=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n;return r.__generator(this,(function(r){switch(r.label){case 0:return i=j.getOptimalThumbnailSize(e,t),[4,e.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableSlice:!0})];case 1:return n=r.sent(),this.thumbnailUrl=n.dataUrl,[2]}}))}))},n.prototype._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()},n.prototype._readAndLoadFromJSON=function(e,t){var r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)},n.prototype._extractOperationalLayers=function(e){var t=this,r=[];if(!this.sourceVersion.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(var i=0,n=e.baseMap.elevationLayers;i<n.length;i++){var o=n[i];r.push(o)}var a=[],s=function(e){return e.layers&&(e.layers=e.layers.filter(s)),"ArcGISTiledElevationServiceLayer"!==e.layerType||(t.sourceVersion.supportsGround||a.push(e),!1)};return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(s):[],operationalElevationLayers:a,basemapElevationLayers:r}},n.prototype._loadFromJSON=function(t,i){var n=this,o=new a;return this._validateSpatialReference().then((function(){return n._validateHeightModelInfo()})).then((function(){return new Promise((function(t,r){e(["./portal/support/layersCreator"],t,r)}))})).then((function(e){var a,s=n._extractOperationalLayers(t),l=s.operationalLayers,p=s.operationalElevationLayers,u=s.basemapElevationLayers,c=[],d={context:r.__assign(r.__assign({},i),{layerContainerType:"operational-layers"})};(n.portalItem&&(d.context.portal=n.portalItem.portal||R.getDefault()),u.length>0)&&((a=r.__assign(r.__assign({},d),{context:r.__assign(r.__assign({},d.context),{layerContainerType:"ground"})})).defaultLayerType="ArcGISTiledElevationServiceLayer",c.push(e.populateOperationalLayers(n.ground.layers,u,a)));p.length>0&&((a=r.__assign(r.__assign({},d),{context:r.__assign(r.__assign({},d.context),{layerContainerType:"ground"})})).defaultLayerType="ArcGISTiledElevationServiceLayer",c.push(e.populateOperationalLayers(o,p,a)));return l&&l.length>0&&c.push(e.populateOperationalLayers(n.layers,l,d)),v.eachAlways(c).then((function(){}))})).then((function(){return n._loadObjectsWithLayers()})).then((function(){n.ground.layers.addMany(o)}))},n.prototype._ensureLoadBeforeSave=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),[4,this._loadObjectsWithLayers()];case 2:for(r.sent(),e=[],t=0,i=this.allLayers.items;t<i.length;t++)"beforeSave"in(n=i[t])&&"function"==typeof n.beforeSave&&(o=n.beforeSave())&&e.push(o);return[4,v.eachAlways(e)];case 3:return r.sent(),[2]}}))}))},n.prototype._loadObjectsWithLayers=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=[],this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach((function(t){t.basemap&&e.push(t.basemap.load())})),[4,v.eachAlways(e)];case 1:return t.sent(),[2]}}))}))},n.prototype._loadFromItem=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,e.load().catch((function(e){throw new s("webscene:load-portal-item","Failed to load portal item",{error:e})}))];case 1:if(r.sent(),"Web Scene"!==e.type)throw new s("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});return[4,e.fetchData()];case 2:return t=r.sent(),this.resourceInfo=t,i={origin:"web-scene",url:g.urlToObject(e.itemUrl),portal:e.portal||R.getDefault(),portalItem:e,readResourcePaths:[]},[4,this._readAndLoadFromJSON(t,i)];case 3:return r.sent(),this.resourceReferences={portalItem:e,paths:i.readResourcePaths},[2]}}))}))},n.prototype._validateSpatialReference=function(){var e,t=this.initialViewProperties,r=this._sceneSpatialReference;if("local"!==t.viewingMode){if(!V.isSpatialReferenceSupported(r,"global"))return v.reject(new s("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:r,viewingMode:t.viewingMode}));e=function(e){return!e||P.canProject(e,r)}}else{if(!V.isSpatialReferenceSupported(r,"local"))return v.reject(new s("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:r,viewingMode:t.viewingMode}));e=function(e){return!e||e.equals(r)}}var i=function(e){return e&&(e.camera&&e.camera.position&&e.camera.position.spatialReference||e.targetGeometry&&e.targetGeometry.spatialReference)},n=t.viewpoint,o=i(n);if(o&&!e(o))return v.reject(new s("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:o,sceneSpatialReference:r,viewingMode:t.viewingMode}));var a=this.presentation.slides.find((function(t){return!e(i(t.viewpoint))}));if(a){var l=i(a.viewpoint);return v.reject(new s("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:l,sceneSpatialReference:r,viewingMode:t.viewingMode}))}return v.resolve()},n.prototype._validateHeightModelInfo=function(){var e=this._sceneSpatialReference,t=A.validateWebSceneError(this.heightModelInfo,e);return t?v.reject(t):v.resolve()},n.prototype._validateJSON=function(e){var t=W.default.parse(e.version||"","webscene");return F.validate(t),e.version=t.major+"."+t.minor,1===t.major&&t.minor<=2&&(e.spatialReference=I.WebMercator.toJSON()),e},n.prototype._updateTypeKeywords=function(e){"local"===this.initialViewProperties.viewingMode?e.typeKeywords?-1===e.typeKeywords.indexOf("ViewingMode-Local")&&e.typeKeywords.push("ViewingMode-Local"):e.typeKeywords=["ViewingMode-Local"]:"global"===this.initialViewProperties.viewingMode&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((function(e){return"ViewingMode-Local"!==e}))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((function(e,t,r){return r.indexOf(e)===t})))},Object.defineProperty(n.prototype,"_sceneSpatialReference",{get:function(){return this.initialViewProperties.spatialReference||I.WebMercator},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_verifyItemRelativeRootPath",{get:function(){return this.portalItem&&this.portalItem.itemUrl?g.urlToObject(this.portalItem.itemUrl).path:null},enumerable:!1,configurable:!0}),n.prototype._enableVerifyItemRelativeUrls=function(e){var t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e},n.prototype._unscheduleLayersIdGC=function(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)},n.prototype._scheduleLayersIdGC=function(){var e=this;this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout((function(){e._layersIdGCTimeoutId=0,e._runLayersIdGC()}),3e3)},n.prototype._runLayersIdGC=function(){var e=this;this._unscheduleLayersIdGC();var t=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,r=function(t){return!!e.allLayers.find((function(e){return e.id===t}))};t&&t.layers&&(t.layers=t.layers.filter((function(e){return r(e.id)})));var i=this.presentation&&this.presentation.slides;i&&i.forEach((function(e){e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((function(e){return r(e.id)})))}))},n.fromJSON=function(e){if(!e)throw new s("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})},n.VERSION=F,r.__decorate([m.property({type:E,json:{write:!0}})],n.prototype,"applicationProperties",void 0),r.__decorate([m.property({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],n.prototype,"basemap",void 0),r.__decorate([m.property({type:b,json:{read:{source:"clippingArea.geometry",reader:O.fromJSON},write:{target:"clippingArea.geometry"}}})],n.prototype,"clippingArea",void 0),r.__decorate([m.writer("clippingArea")],n.prototype,"writeClippingArea",null),r.__decorate([m.property({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],n.prototype,"clippingEnabled",void 0),r.__decorate([m.reader("clippingEnabled",["clippingArea"])],n.prototype,"readClippingEnabled",null),r.__decorate([m.writer("clippingEnabled")],n.prototype,"writeClippingEnabled",null),r.__decorate([m.property({type:S,json:{write:!0}})],n.prototype,"heightModelInfo",void 0),r.__decorate([m.property({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],n.prototype,"layers",void 0),r.__decorate([m.writer("layers")],n.prototype,"writeLayers",null),r.__decorate([m.property({readOnly:!0,type:W.default,json:{type:k(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:function(){return{enabled:!0,allowNull:!0,ignoreOrigin:!0}}}}})],n.prototype,"sourceVersion",void 0),r.__decorate([m.reader("sourceVersion",["version"])],n.prototype,"readSourceVersion",null),r.__decorate([m.writer("sourceVersion")],n.prototype,"writeSourceVersion",null),r.__decorate([m.property({json:{read:!1,write:!1}})],n.prototype,"tables",void 0),r.__decorate([m.property({dependsOn:["portalItem.thumbnailUrl"]})],n.prototype,"thumbnailUrl",null),r.__decorate([m.property({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],n.prototype,"authoringApp",null),r.__decorate([m.writer("authoringApp")],n.prototype,"writeAuthoringApp",null),r.__decorate([m.property({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],n.prototype,"authoringAppVersion",null),r.__decorate([m.writer("authoringAppVersion")],n.prototype,"writeAuthoringAppVersion",null),r.__decorate([m.property({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],n.prototype,"ground",void 0),r.__decorate([m.writer("ground")],n.prototype,"writeGround",null),r.__decorate([m.property({type:a.ofType(G),json:{write:!0}})],n.prototype,"transportationNetworks",void 0),r.__decorate([m.property({type:T,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:function(e,t,i,n){if(e.slides&&e.slides.length>0){var o=r.__assign(r.__assign({},n),{isPresentation:!0});t.presentation=e.write(null,o)}}}}})],n.prototype,"presentation",void 0),r.__decorate([m.property({type:N,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:function(){return new N({viewingMode:"global",spatialReference:I.WebMercator})}}})],n.prototype,"initialViewProperties",void 0),r.__decorate([m.reader("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],n.prototype,"readInitialViewProperties",null),r.__decorate([m.property({type:I,dependsOn:["initialViewProperties.spatialReference"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],n.prototype,"spatialReference",null),r.__decorate([m.property({type:["local","global"],dependsOn:["initialViewProperties.viewingMode"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],n.prototype,"viewingMode",null),r.__decorate([m.property({type:L})],n.prototype,"portalItem",void 0),r.__decorate([m.property()],n.prototype,"resourceInfo",void 0),n=r.__decorate([m.subclass("esri.WebScene")],n)}(c.LoadableMixin(f.EsriPromiseMixin(y.MultiOriginJSONMixin(n))))}));