// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/Deferred","dojo/_base/array","dojo/_base/sniff","require","../config","../kernel","../lang","../request","../urlUtils","../Evented","../IdentityManager"],(function(e,t,i,r,n,s,a,o,l,u,c,h,p){var d={options:{disableIdentityLookup:!0},requestParams:{f:"json"}},m=function(e){if(!e)return e;function i(t){e[t]||(e[t]=function(){var i=arguments;return r.when(e,(function(e){return Array.prototype.unshift.call(i,e.results||e),m(n[t].apply(n,i))}))})}return e.then&&(e=t.delegate(e)),e.total||(e.total=r.when(e,(function(e){return u.isDefined(e.total)?e.total:e.length||0}))),i("forEach"),i("filter"),i("map"),i("some"),i("every"),e},f={useSSL:function(e,t){var i=d&&d.self||{};if(i&&!i.isPortal)return-1!==e.indexOf("https:")||i.allSSL?t.replace("http:","https:"):t;var r=f.getLocation(t);if(i.portalHostname.toLowerCase().indexOf(r.hostname.toLowerCase())>-1&&r.port&&"80"!==r.port&&"443"!==r.port){var n=r.pathname;return n=0===n.indexOf("/")?n:"/"+n,i.allSSL||e.indexOf("https:")>-1?"https://"+r.hostname+(i.httpsPort&&"443"!==i.httpsPort?":"+i.httpsPort:"")+n+r.search:"http://"+r.hostname+(i.httpPort&&"80"!==i.httpPort?":"+i.httpPort:"")+n+r.search}return-1!==e.indexOf("https:")||i.allSSL?t.replace("http:","https:"):t},formatUrl:function(e){var t=d.currentToken;return-1!==e.indexOf("null")?null:f.useSSL(window.location.protocol,t?e+(-1!==e.indexOf("?")?"&":"?")+"token="+t:e)},getLocation:function(e){var t=document.createElement("a");return t.href=e,{protocol:t.protocol,hostname:t.hostname,port:t.port,pathname:t.pathname,search:t.search,hash:t.hash,host:t.host}},resultsToTypedArray:function(e,i,r){return r=r?r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r:[],n.map(r,(function(r){return r=t.mixin(r,i||{}),e?new e(r):r}))},clearFieldsFromObject:function(e,i){var r,n,s=e.length;if(t.isArray(e))for(n=0;n<s;n++)delete i[e[n]];else for(r in e)delete i[r];return i},requestToTypedArray:function(e,i,r,n,s){return m(f.request(e,i,r).then(t.partial(f.resultsToTypedArray,n,s)))},request:function(e,i,r){var n,s,a,o,l;return i&&(i.portal&&delete i.portal,i.form&&(n=i.form,delete i.form),i.hasOwnProperty("withCredentials")&&(a=i.withCredentials,delete i.withCredentials)),s=t.mixin(t.mixin({},i||{}),d.requestParams),l={url:f.useSSL(window.location.protocol,e.url||e),content:s,callbackParamName:"callback",timeout:o&&o.timeout||0,form:n},null!=a&&(l.withCredentials=a),o=t.mixin(r||{},d.options),c(l,o)},formatQueryParams:function(e,i,r){var n=t.mixin(t.mixin({},e),t.isString(i)?{q:i}:i||{});return n.q=!r&&d.extraQuery?"("+n.q+")"+d.extraQuery:n.q,n}},g=e([],{declaredClass:"esri.arcgis.PortalComment",constructor:function(e){t.mixin(this,e),this.url=this.item.itemUrl+"/comments/"+this.id,this.created=this.created?new Date(this.created):null}}),y=e([],{declaredClass:"esri.arcgis.PortalRating",constructor:function(e){t.mixin(this,e),this.url=this.item.itemUrl+"/rating",this.created=this.created?new Date(this.created):null}}),b=e([],{declaredClass:"esri.arcgis.PortalItem",constructor:function(e){t.mixin(this,e),this.folderId=this.ownerFolder||this.folderId,this.itemUrl=(this.portal&&this.portal.portalUrl)+"content/items/"+this.id,this.userItemUrl=this.hasOwnProperty("ownerFolder")?this.itemUrl.replace("/content/","/content/users/"+this.owner+(this.folderId?"/"+this.folderId:"")+"/"):null,this.itemDataUrl=f.formatUrl(this.itemUrl+"/data"),this.thumbnailUrl=f.formatUrl(this.itemUrl+"/info/"+this.thumbnail),this.displayName=this._getDisplayName(),this.iconUrl=this._getIconUrl(),this.isPremiumContent=this._getIsPremiumContent(),this.created=this.created?new Date(this.created):null,this.uploaded=this.uploaded?new Date(this.uploaded):null,this.modified=this.modified?new Date(this.modified):null},getTypeInfo:function(){var e=this.type,t=this.typeKeywords||[];return{source:n.indexOf(t,"ArcGIS Server")>-1||"Feature Collection"===e?e:null,displayName:this.displayName,iconUrl:this.iconUrl,isPremiumContent:this.isPremiumContent,premiumIconUrl:this._getPremiumIconUrl()}},addComment:function(e){var i=t.isString(e)?{comment:e}:e;return f.request(this.itemUrl+"/addComment",i,{usePost:!0}).then(t.hitch(this,(function(e){return new g(t.mixin(i,{id:e.commentId,item:this}))})))},updateComment:function(e){if(e&&e.url&&e.comment){var t={comment:e.comment};return f.request(e.url+"/update",t,{usePost:!0}).then((function(t){return e.id=t.commentId,e}))}throw new Error},getComments:function(){return f.requestToTypedArray(this.itemUrl+"/comments",null,null,g,{item:this})},deleteComment:function(e){if(e&&e.url)return f.request(e.url+"/delete",null,{usePost:!0});throw new Error},addRating:function(e){var i=t.isObject(e)?e:{rating:parseFloat(e)};return f.request(this.itemUrl+"/addRating",i,{usePost:!0}).then(t.hitch(this,(function(e){return new y(t.mixin(i,{id:e.ratingId,item:this}))})))},getRating:function(){return f.request(this.itemUrl+"/rating").then(t.hitch(this,(function(e){return new y(t.mixin(e,{item:this}))})))},deleteRating:function(){return f.request(this.itemUrl+"/deleteRating",null,{usePost:!0})},_getDisplayName:function(){var e=this.type,t=this.typeKeywords||[],i=e;return"Feature Service"===e||"Feature Collection"===e?i=n.indexOf(t,"Table")>-1?"Table":n.indexOf(t,"Route Layer")>-1?"Route Layer":n.indexOf(t,"Markup")>-1?"Markup":"Feature Layer":"Image Service"===e?i=n.indexOf(t,"Elevation 3D Layer")>-1?"Elevation Layer":n.indexOf(t,"Tiled Imagery")>-1?"Tiled Imagery Layer":"Imagery Layer":"Scene Service"===e?i="Scene Layer":"Video Service"===e?i="Video Layer":"Scene Package"===e?i="Scene Layer Package":"Stream Service"===e?i="Feature Layer":"Geoprocessing Service"===e&&this.portal&&this.portal.isPortal?i=n.indexOf(t,"Web Tool")>-1?"Tool":"Geoprocessing Service":"Geoenrichment Service"===e?i="GeoEnrichment Service":"Geocoding Service"===e?i="Locator":"Microsoft Powerpoint"===e?i="Microsoft PowerPoint":"GeoJson"===e?(i="GeoJSON",this.type="GeoJSON"):"Globe Service"===e?i="Globe Layer":"Vector Tile Service"===e?i="Tile Layer":"netCDF"===e?i="NetCDF":"Map Service"===e?i=-1===n.indexOf(t,"Spatiotemporal")&&(n.indexOf(t,"Hosted Service")>-1||n.indexOf(t,"Tiled")>-1)&&-1===n.indexOf(t,"Relational")?"Tile Layer":"Map Image Layer":e&&e.toLowerCase().indexOf("add in")>-1?i=e.replace(/(add in)/gi,"Add-In"):"datastore catalog service"===e?i="Big Data File Share":"Compact Tile Package"===e?i="Tile Package (tpkx)":"Raster function template"===e?i="Raster Function Template":"OGCFeatureServer"===e?i="OGC Feature Layer":"web mapping application"===e&&n.indexOf(t,"configurableApp")>-1&&(i="Instant App"),i},_getIconUrl:function(){var e,t=this.type&&this.type.toLowerCase()||"",i=this.typeKeywords||[],r=!1,s=!1,o=!1,l=!1,u=!1,c=!1,h=!1;return t.indexOf("service")>0||"feature collection"===t||"kml"===t||"wms"===t||"wmts"===t||"wfs"===t?(r=n.indexOf(i,"Hosted Service")>-1,"feature service"===t||"feature collection"===t||"kml"===t||"wfs"===t?(l=n.indexOf(i,"Table")>-1,s=n.indexOf(i,"Route Layer")>-1,o=n.indexOf(i,"Markup")>-1,u=-1!==n.indexOf(i,"Spatiotemporal"),c=-1!==n.indexOf(i,"UtilityNetwork"),e=u&&l?"spatiotemporaltable":l?"table":s?"routelayer":o?"markup":u?"spatiotemporal":c?"utilitynetwork":r?"featureshosted":"features"):"map service"===t||"wms"===t||"wmts"===t?(u=-1!==n.indexOf(i,"Spatiotemporal"),h=-1!==n.indexOf(i,"Relational"),e=u||h?"mapimages":r||n.indexOf(i,"Tiled")>-1||"wmts"===t?"maptiles":"mapimages"):e="scene service"===t?n.indexOf(i,"Line")>-1?"sceneweblayerline":n.indexOf(i,"3DObject")>-1?"sceneweblayermultipatch":n.indexOf(i,"Point")>-1?"sceneweblayerpoint":n.indexOf(i,"IntegratedMesh")>-1?"sceneweblayermesh":n.indexOf(i,"PointCloud")>-1?"sceneweblayerpointcloud":n.indexOf(i,"Polygon")>-1?"sceneweblayerpolygon":n.indexOf(i,"Building")>-1?"sceneweblayerbuilding":n.indexOf(i,"Voxel")>-1?"sceneweblayervoxel":"sceneweblayer":"image service"===t?n.indexOf(i,"Elevation 3D Layer")>-1?"elevationlayer":n.indexOf(i,"Tiled Imagery")>-1?"tiledimagerylayer":"imagery":"stream service"===t?"streamlayer":"vector tile service"===t?"vectortile":"datastore catalog service"===t?"datastorecollection":"geocoding service"===t?"geocodeservice":"video service"===t?"mediaservice":"geoprocessing service"===t?n.indexOf(i,"Web Tool")>-1&&this.portal&&this.portal.isPortal?"tool":"layers":"geodata service"===t?"geodataservice":"layers"):e="web map"===t||"cityengine web scene"===t?"maps":"web scene"===t?n.indexOf(i,"ViewingMode-Local")>-1?"webscenelocal":"websceneglobal":"web mapping application"===t&&n.indexOf(i,"configurableApp")>-1?"instantapps":"web mapping application"===t||"mobile application"===t||"application"===t||"operation view"===t||"desktop application"===t?"apps":"map document"===t||"map package"===t||"published map"===t||"scene document"===t||"globe document"===t||"basemap package"===t||"mobile basemap package"===t||"mobile map package"===t||"project package"===t||"project template"===t||"pro map"===t||"layout"===t||"layer"===t&&n.indexOf(i,"ArcGIS Pro")>-1||"explorer map"===t&&n.indexOf(i,"Explorer Document")?"mapsgray":"service definition"===t||"csv"===t||"shapefile"===t||"cad drawing"===t||"geojson"===t||"360 vr experience"===t||"netcdf"===t||"administrative report"===t?"datafiles":"explorer add in"===t||"desktop add in"===t||"windows viewer add in"===t||"windows viewer configuration"===t?"appsgray":"arcgis pro add in"===t||"arcgis pro configuration"===t?"addindesktop":"rule package"===t||"file geodatabase"===t||"sqlite geodatabase"===t||"csv collection"===t||"kml collection"===t||"windows mobile package"===t||"map template"===t||"desktop application template"===t||"gml"===t||"arcpad package"===t||"code sample"===t||"form"===t||"document link"===t||"earth configuration"===t||"operations dashboard add in"===t||"rules package"===t||"image"===t||"workflow manager package"===t||"explorer map"===t&&n.indexOf(i,"Explorer Mapping Application")>-1||n.indexOf(i,"Document")>-1?"datafilesgray":"network analysis service"===t||"geoprocessing service"===t||"geodata service"===t||"geometry service"===t||"geoprocessing package"===t||"locator package"===t||"geoprocessing sample"===t||"workflow manager service"===t?"toolsgray":"layer"===t||"layer package"===t||"explorer layer"===t?"layersgray":"scene package"===t?"scenepackage":"mobile scene package"===t?"mobilescenepackage":"tile package"===t||"compact tile package"===t?"tilepackage":"task file"===t?"taskfile":"report template"===t?"report-template":"statistical data collection"===t?"statisticaldatacollection":"insights workbook"===t?"workbook":"insights model"===t?"insightsmodel":"insights page"===t?"insightspage":"insights theme"===t?"insightstheme":"hub initiative"===t?"hubinitiative":"hub page"===t?"hubpage":"hub site application"===t?"hubsite":"hub event"===t?"hubevent":"hub project"===t?"hubproject":"relational database connection"===t?"relationaldatabaseconnection":"big data file share"===t?"datastorecollection":"image collection"===t?"imagecollection":"desktop style"===t?"desktopstyle":"style"===t?"style":"dashboard"===t?"dashboard":"raster function template"===t?"rasterprocessingtemplate":"vector tile package"===t?"vectortilepackage":"ortho mapping project"===t?"orthomappingproject":"ortho mapping template"===t?"orthomappingtemplate":"solution"===t?"solutions":"geopackage"===t?"geopackage":"deep learning package"===t?"deeplearningpackage":"real time analytic"===t?"realtimeanalytics":"big data analytic"===t?"bigdataanalytics":"feed"===t?"feed":"excalibur imagery project"===t?"excaliburimageryproject":"notebook"===t?"notebook":"storymap"===t?"storymap":"survey123 add in"===t?"survey123addin":"mission"===t?"mission":"mission report"===t?"missionreport":"quickcapture project"===t?"quickcaptureproject":"pro report"===t?"proreport":"pro report template"===t?"proreporttemplate":"urban model"===t?"urbanmodel":"web experience"===t?"experiencebuilder":"web experience template"===t?"webexperiencetemplate":"experience builder widget"===t?"experiencebuilderwidget":"experience builder widget package"===t?"experiencebuilderwidgetpackage":"workflow"===t?"workflow":"kernel gateway connection"===t?"kernelgatewayconnection":"insights script"===t?"insightsscript":"hub initiative template"===t?"hubinitiativetemplate":"storymap theme"===t?"storymaptheme":"knowledge graph"===t?"knowledgegraph":"native application"===t?"nativeapp":"native application installer"===t?"nativeappinstaller":"link chart"===t?"linkchart":"investigation"===t?"investigation":"ogcfeatureserver"===t?"features":"pro project"===t?"proproject":"insights workbook package"===t?"insightsworkbookpackage":"apache parquet"===t?"apacheparquet":"notebook code snippets"===t||"notebook code snippet library"===t?"notebookcodesnippets":"suitability model"===t?"suitabilitymodel":"esri classifier definition"===t?"classifierdefinition":"esri classification schema"===t?"classificationschema":"insights data engineering workbook"===t?"dataengineeringworkbook":"insights data engineering model"===t?"dataengineeringmodel":"deep learning studio project"===t?"deeplearningproject":"discussion"===t?"discussion":"maps",e?a.toUrl("../css/images/item_type_icons/"+e+"16.png"):null},_getIsPremiumContent:function(){var e=this.typeKeywords,t=!1;return(n.indexOf(e,"Requires Subscription")>-1||n.indexOf(e,"Requires Credits")>-1)&&(t=!0),t},_getPremiumIconUrl:function(){var e,t=this.typeKeywords;return this.isPremiumContent&&(e=n.indexOf(t,"Requires Credits")>-1?"premiumcredits":"premiumitem"),e?a.toUrl("../css/images/item_type_icons/"+e+"16.png"):null},getThumbnailUrl:function(e){var t=this.thumbnailUrl;return t&&e&&(t+=(-1===t.indexOf("?")?"?":"&")+"w="+e),t}}),v=e([],{declaredClass:"esri.arcgis.PortalListing",constructor:function(e){for(var i in t.mixin(this,e),this.id=this.itemId,this.url=(this.portal&&this.portal.portalUrl)+"content/"+(this.userItemUrl?"items/":"listings/")+this.itemId,this.commentsUrl=this.url+"/comments",this.created=this.created?new Date(this.created):null,this.banner=this.banner?f.formatUrl(this.url+"/info/"+this.banner):"",this.thumbnail=this.thumbnail?f.formatUrl(this.url+"/info/"+this.thumbnail):"",this.largeThumbnail=this.largeThumbnail?f.formatUrl(this.url+"/info/"+this.largeThumbnail):"",this.avgRating=this.avgRating||0,this.numRatings=this.numRatings||0,this.numComments=this.numComments||0,this.listingProperties=this.listingProperties||{priceDesc:"",creditsPerTransaction:0,licenseType:"free",trialSupported:!1,trialDuration:0,listingAccess:"private"},this.listingProperties)this[i]&&(this.listingProperties[i]=this[i]);this.properties=this.properties||{systemRequirements:"",termsAndConditions:"",version:"1.0"},this.screenshots=n.map(this.screenshots,t.hitch(this,(function(e){return f.formatUrl(this.url+"/info/"+e)}))),this.vendorName=this.vendor.name,this.vendor.thumbnail=this.vendor.thumbnail?this.userItemUrl?f.formatUrl(this.portal.portalUrl+"/portals/self/resources/"+this.vendor.thumbnail):f.formatUrl(this.url+"/vendorinfo/"+this.vendor.thumbnail):""},getComments:function(){return f.requestToTypedArray(this.commentsUrl,null,null,g,{item:this})},getVendor:function(){return this.vendor}}),w=e([],{declaredClass:"esri.arcgis.PortalProvision",constructor:function(e){t.mixin(this,e),this.created=this.created?new Date(this.created):null,this.startDate=this.startDate?new Date(this.startDate):null,this.endDate=this.endDate&&-1!==this.endDate?new Date(this.endDate):null,this.listing=e.listing?new v(t.mixin(e.listing,{portal:this.portal})):null}}),x=e([],{declaredClass:"esri.arcgis.PortalGroup",constructor:function(e){t.mixin(this,e),this.url=(this.portal&&this.portal.portalUrl)+"community/groups/"+this.id,this.thumbnailUrl=f.formatUrl(this.url+"/info/"+this.thumbnail),this.modified=this.modified?new Date(this.modified):null,this.created=this.created?new Date(this.created):null},getMembers:function(){return f.request(this.url+"/users")},queryItems:function(e,t){return(e=f.formatQueryParams({},e,t)).q="group:"+this.id+(e.q?" "+e.q:""),this.portal.queryItems(e)},getThumbnailUrl:function(e){var t=this.thumbnailUrl;return t&&e&&(t+=(-1===t.indexOf("?")?"?":"&")+"w="+e),t}}),k=e([],{declaredClass:"esri.arcgis.PortalFolder",constructor:function(e){t.mixin(this,e),this.url=(this.portal&&this.portal.portalUrl)+"content/users/"+this.username+"/"+this.id,this.created=this.created?new Date(this.created):null},getItems:function(){return f.requestToTypedArray(this.url,null,null,b,{portal:this.portal,folderId:this.id})}}),U=e([],{declaredClass:"esri.arcgis.PortalUser",constructor:function(e){t.mixin(this,e),this.url=(this.portal&&this.portal.portalUrl)+"community/users/"+this.username,this.userContentUrl=(this.portal&&this.portal.portalUrl)+"content/users/"+this.username,this.thumbnailUrl=this.thumbnail?f.formatUrl(this.url+"/info/"+this.thumbnail):null,this.modified=this.modified?new Date(this.modified):null,this.created=this.created?new Date(this.created):null},getGroups:function(){return m(f.request(this.url).then(t.hitch(this,(function(e){return f.resultsToTypedArray(x,{portal:this.portal},e.groups)}))))},getNotifications:function(){return f.requestToTypedArray(this.url+"/notifications",null,null,null,{portal:this.portal})},getGroupInvitations:function(){return f.requestToTypedArray(this.url+"/invitations",null,null,null,{portal:this.portal})},getTags:function(){return f.requestToTypedArray(this.url+"/tags",null,null,null,{portal:this.portal})},getFolders:function(){return m(this.getContent(null,{num:1}).then((function(e){return e.folders})))},getItems:function(e){return m(this.getContent(e).then((function(e){return e.items})))},getItem:function(e){var i=this.portal.portalUrl+"content/items/"+e;return f.request(i).then(t.hitch(this,(function(e){return new b(t.mixin(e,{portal:this.portal}))})))},getContent:function(e,i){var r=this.url.replace("/community/","/content/")+(e?"/"+e:"");return f.request(r,i).then(t.hitch(this,(function(t){return t.folders=f.resultsToTypedArray(k,{portal:this.portal},t.folders),t.items=f.resultsToTypedArray(b,{portal:this.portal,folderId:e},t.items),t})))},getThumbnailUrl:function(e){var t=this.thumbnailUrl;return t&&e&&(t+=(-1===t.indexOf("?")?"?":"&")+"w="+e),t}}),P={Portal:e([p],{declaredClass:"esri.arcgis.Portal",onLoad:function(){},onError:function(){},constructor:function(e){var i,r=t.isObject(e)?e:{url:e};if(this.registerConnectEvents(),d={options:{disableIdentityLookup:!0},requestParams:{f:"json"}},r.self){d.self=r.self,t.mixin(this,{url:r.url||h.getProtocolForWebResource()+"//"+(r.self.urlKey?r.self.urlKey+"."+r.self.customBaseUrl:r.self.portalHostname)});var n=this.url.indexOf("/sharing");this.portalUrl=-1!==n?this.url+"/":this.url+"/sharing/rest/",i=r.self.user?this.signIn():this.init(this.url)}else r.url&&t.mixin(this,{url:r.url}),i=this.init(this.url);i.then(t.hitch(this,(function(){this.emit("ready",this),this.onLoad(this)})))},init:function(e,i){var r=(e=(e||this.portalUrl).replace(/\/+$/,"")).indexOf("/sharing");return this.portalUrl=-1!==r?e+"/":e+"/sharing/rest/",h.canUseXhr(this.portalUrl)||o.defaults.io.corsEnabledServers.push(this.portalUrl.replace(/^https?:\/\//i,"")),this._getSelf(this.portalUrl).then(t.hitch(this,(function(e){d.self=t.mixin({},e);var r=e.user;return r&&i&&(d.currentToken=i&&i.token,d.loggedInUser=new U(t.mixin(r,{portal:this,credential:i}))),d.self.id&&!1===d.self.canSearchPublic&&(d.extraQuery=" AND orgid:"+d.self.id),t.mixin(this,d.self),this.thumbnailUrl=f.formatUrl(this.portalUrl+"portals/self/resources/"+this.thumbnail),this.isOrganization=!(!this.access||!this.access.length),this.created=this.created?new Date(this.created):null,this.modified=this.modified?new Date(this.modified):null,this})),t.hitch(this,(function(e){throw this.onError(e),e})))},signIn:function(){var e=new r,i=t.hitch(this,(function(){this._onSignIn().then(t.hitch(this,(function(){e.resolve(d.loggedInUser)})),t.hitch(this,(function(t){e.reject(t)})))}));return d&&d.self?d&&d.loggedInUser?setTimeout((function(){e.resolve(d.loggedInUser)}),0):i():this.on("load",t.hitch(this,(function(){i()}))),e},signOut:function(){return d.loggedInUser.credential&&d.loggedInUser.credential.destroy(),d.loggedInUser=null,d.options.disableIdentityLookup=!0,f.clearFieldsFromObject(d.self,this),d.self=null,this.init(this.url)},getPortalUser:function(){return d.loggedInUser},addResource:function(e,t){var i={key:e,text:t};return f.request(this.portalUrl+"portals/self/addResource",i,{usePost:!0})},update:function(e){return f.request(this.portalUrl+"portals/self/update",e,{usePost:!0})},queryGroups:function(e,t){return this._queryPortal(this.portalUrl+"community/groups",f.formatQueryParams({},e,t),x)},queryItems:function(e,t){return this._queryPortal(this.portalUrl+"search",f.formatQueryParams({},e,t),b)},queryListings:function(e){var t=f.formatQueryParams({},e,!0),i="";return t.q&&t.q.toLowerCase().indexOf("mylistings:true")>-1?(t.q=t.q.toLowerCase().replace("mylistings:true",""),i="?mylistings=true"):t.q||(t.q='""'),this._queryPortal(this.portalUrl+"content/listings"+i,t,v)},queryCustomerList:function(e,t){var i=f.formatQueryParams({},e,!0);return this._queryPortal(this.portalUrl+"portals/self/customersList",i)},getProvisions:function(){return this.getCustomers().then(t.hitch(this,(function(e){return e.purchases})))},getInterests:function(){return this.getCustomers().then(t.hitch(this,(function(e){return e.interests})))},getTrials:function(){return this.getCustomers().then(t.hitch(this,(function(e){return e.trials})))},getCustomers:function(e){var t=this.portalUrl+"portals/self/customers",i={status:e||"all"};return f.request(t,i)},getMyPurchases:function(){return this.getPurchases().then((function(e){return e.purchases}))},getMyInterests:function(){return this.getPurchases().then((function(e){return e.interests}))},getPurchases:function(){var e=this.portalUrl+"portals/self/purchases";return f.request(e).then(t.hitch(this,(function(e){return e.interests=n.map(e.interests,(function(e){return t.mixin(e.provision,{listing:e.listing})})),e.purchases=n.map(e.purchases,(function(e){return t.mixin(e.provision,{listing:e.listing})})),e.trials=n.map(e.trials,(function(e){return t.mixin(e.provision,{listing:e.listing})})),e.interests=f.resultsToTypedArray(w,{portal:this},e.interests),e.trials=f.resultsToTypedArray(w,{portal:this},e.trials),e.purchases=f.resultsToTypedArray(w,{portal:this},e.purchases),e})))},queryUsers:function(e,t){return this._queryPortal(this.portalUrl+"community/users",f.formatQueryParams({sortField:"username"},e,t),U)},_onSignIn:function(){return d.options.disableIdentityLookup=!1,d.self=null,l.id.getCredential(this.portalUrl).then(t.hitch(this,"init",this.url)).then((function(){return d.loggedInUser}),t.hitch(this,(function(e){throw d.options.disableIdentityLookup=!0,this.onError(e),e})))},_getSelf:function(e){var t,n=e+"portals/self";return d.self?(t=new r,setTimeout((function(){t.resolve(d.self)}),0)):t=f.request(n,{culture:i.locale,withCredentials:!0}),t},_queryPortal:function(e,i,n){var s=t.mixin({num:10,start:0,sortField:"title",sortOrder:"asc"},i),a=["start","query","num","nextStart"],o=f.request(e,s).then(t.hitch(this,(function(e){return e.results=f.resultsToTypedArray(n,{portal:this},e),e.queryParams=t.mixin({},s),e.nextQueryParams=t.mixin(s,{start:e.nextStart}),f.clearFieldsFromObject(a,e)})));return(o=t.delegate(o)).queryParams=t.mixin({},s),o.nextQueryParams=r.when(o,(function(e){return e.nextQueryParams})),m(o)}}),PortalFolder:k,PortalGroup:x,PortalItem:b,PortalUser:U,PortalComment:g,PortalRating:y,PortalUtil:f,PortalResult:m,PortalListing:v};return s("extend-esri")&&t.mixin(t.getObject("arcgis",!0,l),P),P}));