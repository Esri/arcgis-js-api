// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/Deferred","dojo/_base/json","dojo/_base/url","dojo/on","dojo/DeferredList","dojo/dom-construct","dojo/sniff","dojox/gfx/_base","../kernel","../config","../Color","../lang","../request","../SpatialReference","../map","../urlUtils","../geometry/Point","../geometry/ScreenPoint","../geometry/Extent","../geometry/webMercatorUtils","../symbols/jsonUtils","../renderers/jsonUtils","../dijit/PopupTemplate","../dijit/Popup","../tasks/query","../tasks/GeometryService","../layers/ArcGISTiledMapServiceLayer","../layers/FeatureLayer","dojo/i18n!../nls/jsapi"],(function(e,r,i,a,n,t,o,s,l,c,f,y,p,u,d,m,b,h,g,v,I,S,L,D,w,x,M,k,_,E,T,O,P){var R,C,A,F,j,G,W,U,V,B,K,N,J,z,H,X,q,Q,Y,$,Z,ee,re,ie,ae,ne="../layers/LabelClass",te="../layers/vectorTiles/layers/support/vectorTileLayerLoader",oe="../virtualearth/VETiledLayer",se=["../layers/ArcGISDynamicMapServiceLayer","../layers/ArcGISImageServiceLayer","../layers/ArcGISImageServiceVectorLayer","../layers/CSVLayer","../layers/GeoRSSLayer","../layers/KMLLayer",ne,"../layers/OpenStreetMapLayer","../layers/RasterXLayer","../layers/StreamLayer","../layers/VectorTileLayer",oe,"../layers/WebTiledLayer","../layers/WFSLayer","../layers/WMSLayer"],le=["./csv","../layers/DynamicLayerInfo","../layers/ImageParameters","../layers/ImageServiceParameters","../layers/LayerDrawingOptions","../layers/MosaicRule","../layers/RasterFunction","../layers/TileInfo",te,"../layers/WMSLayerInfo"];function ce(e){return!(!e||"BingMapsAerial"!==e.layerType&&"BingMapsAerial"!==e.type)}function fe(e){return!(!e||"BingMapsRoad"!==e.layerType&&"BingMapsRoad"!==e.type)}function ye(e){return ce(e)||fe(e)||function(e){return!(!e||"BingMapsHybrid"!==e.layerType&&"BingMapsHybrid"!==e.type)}(e)}function pe(e){return!(!e||"OpenStreetMap"!==e.layerType&&"OpenStreetMap"!==e.type)}function ue(e){return!(!e||"CSV"!==e.layerType&&"CSV"!==e.type)}function de(e){return!(!e||"WMS"!==e.layerType&&"WMS"!==e.type)}function me(e){return!!(e&&e.url&&(["ArcGISFeatureLayer","ArcGISImageServiceLayer","ArcGISImageServiceVectorLayer","ArcGISMapServiceLayer","ArcGISStreamLayer","ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer"].indexOf(e.layerType)>-1||!e.layerType&&!e.type))}function be(e){return!(!e||"VectorTileLayer"!==e.layerType)}function he(e){return e?e.layerType||e.type:""}function ge(e,r){return e.match(r+"$")==r}function ve(e){var r=or(e.itemId)+"/data";return b({url:r,content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function Ie(e,r){var i={f:"json"};return r&&(i.token=r),b({url:e,content:i,callbackParamName:"callback"},{disableIdentityLookup:!0})}function Se(e){!e.layerDefinition||e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.labelingInfo||(e.showLabels=!1),e.itemProperties.layerDefinition&&(e.layerDefinition?(e.layerDefinition.drawingInfo||(e.layerDefinition.drawingInfo=e.itemProperties.layerDefinition.drawingInfo),m.isDefined(e.layerDefinition.definitionExpression)||(e.layerDefinition.definitionExpression=e.itemProperties.layerDefinition.definitionExpression),m.isDefined(e.layerDefinition.minScale)||(e.layerDefinition.minScale=e.itemProperties.layerDefinition.minScale),m.isDefined(e.layerDefinition.maxScale)||(e.layerDefinition.maxScale=e.itemProperties.layerDefinition.maxScale)):e.layerDefinition=e.itemProperties.layerDefinition),!e.itemProperties.popupInfo||e.popupInfo||e.disablePopup||(e.popupInfo=e.itemProperties.popupInfo),m.isDefined(e.itemProperties.showLabels)&&!m.isDefined(e.showLabels)&&(e.showLabels=e.itemProperties.showLabels),m.isDefined(e.itemProperties.showLegend)&&!m.isDefined(e.showLegend)&&(e.showLegend=e.itemProperties.showLegend),m.isDefined(e.itemProperties.refreshInterval)&&!m.isDefined(e.refreshInterval)&&(e.refreshInterval=e.itemProperties.refreshInterval)}function Le(e){Se(e),e.itemProperties.layerDefinition&&e.layerDefinition&&(!m.isDefined(e.layerDefinition.maximumTrackPoints)&&m.isDefined(e.itemProperties.layerDefinition.maximumTrackPoints)&&(e.layerDefinition.maximumTrackPoints=e.itemProperties.layerDefinition.maximumTrackPoints),!e.layerDefinition.definitionGeometry&&e.itemProperties.layerDefinition.definitionGeometry&&(e.layerDefinition.definitionGeometry=e.itemProperties.layerDefinition.definitionGeometry)),e.itemProperties.purgeOptions&&!e.purgeOptions&&(e.purgeOptions=e.itemProperties.purgeOptions)}function De(e,a){var t=new n,o=e.itemData,s=[],c=[];if(i.forEach(o.operationalLayers,(function(e){if(e.itemId&&me(e)){var r=e.url.toLowerCase();r.indexOf("/featureserver")>-1||r.indexOf("/mapserver/")>-1?(c.push(e),s.push(ve(e))):r.indexOf("/mapserver")>-1&&-1===r.indexOf("/mapserver/")&&(!e.layers||!m.isDefined(e.minScale)&&!m.isDefined(e.maxScale))?(c.push(e),s.push(ve(e))):r.indexOf("/imageserver")>-1?(c.push(e),s.push(ve(e))):r.indexOf("/streamserver")>-1&&(c.push(e),s.push(ve(e)))}})),o.baseMap&&o.baseMap.baseMapLayers&&i.forEach(o.baseMap.baseMapLayers,(function(e){e.itemId&&"VectorTileLayer"!==e.layerType&&(c.push(e),s.push(ve(e)))})),s.length>0){var f=new l(s),y={};f.addCallback((function(a){i.forEach(c,(function(e,n){var t=a[n][1];if(t&&!(t instanceof Error)&&(y[e.itemId]=t,me(e))){var o=e.url.toLowerCase();if((o.indexOf("/featureserver")>-1||o.indexOf("/mapserver/")>-1)&&t.layers)i.forEach(t.layers,(function(r){(ge(o,"/featureserver/"+r.id)||ge(o,"/mapserver/"+r.id))&&(e.itemProperties=r,Se(e))}));else if(o.indexOf("/streamserver")>-1)e.itemProperties=t,Le(e);else if(o.indexOf("/mapserver")>-1)t.layers&&!e.layers&&(e.layers=t.layers),m.isDefined(t.minScale)&&!m.isDefined(e.minScale)&&(e.minScale=t.minScale),m.isDefined(t.maxScale)&&!m.isDefined(e.maxScale)&&(e.maxScale=t.maxScale),m.isDefined(t.refreshInterval)&&!m.isDefined(e.refreshInterval)&&(e.refreshInterval=t.refreshInterval),t.visibleLayers&&!e.visibleLayers&&(e.visibleLayers=t.visibleLayers);else if(o.indexOf("/imageserver")>-1){m.isDefined(t.minScale)&&!m.isDefined(e.minScale)&&(e.minScale=t.minScale),m.isDefined(t.maxScale)&&!m.isDefined(e.maxScale)&&(e.maxScale=t.maxScale),m.isDefined(t.refreshInterval)&&!m.isDefined(e.refreshInterval)&&(e.refreshInterval=t.refreshInterval),!t.popupInfo||e.popupInfo||e.disablePopup||(e.popupInfo=t.popupInfo),t.renderingRule&&!e.renderingRule&&(e.renderingRule=t.renderingRule,t.renderingRule.functionName&&(e.renderingRule.rasterFunction=t.renderingRule.functionName)),t.bandIds&&!e.bandIds&&(e.bandIds=t.bandIds),t.mosaicRule&&!e.mosaicRule&&(e.mosaicRule=t.mosaicRule),t.format&&!e.format&&(e.format=t.format),m.isDefined(t.compressionQuality)&&!m.isDefined(e.compressionQuality)&&(e.compressionQuality=t.compressionQuality),!t.layerDefinition||!t.layerDefinition.definitionExpression||m.isDefined(e.layerDefinition)&&m.isDefined(e.layerDefinition.definitionExpression)||(e.layerDefinition=e.layerDefinition||{},e.layerDefinition.definitionExpression=t.layerDefinition.definitionExpression);var s=r.getObject("layerDefinition.drawingInfo.renderer",!1,t);null==r.getObject("layerDefinition.drawingInfo.renderer",!1,e)&&null!=s&&(e.layerDefinition=e.layerDefinition||{},e.layerDefinition.drawingInfo=e.layerDefinition.drawingInfo||{},e.layerDefinition.drawingInfo.renderer=s)}}})),e.relatedItemsData=y,t.callback(e)}))}else t.callback(e);return t}function we(e,i,n,t,o){if(o.bingKey){i.bingMapsKey=o.bingKey;var s=new Z({bingMapsKey:i.bingMapsKey,mapStyle:Z.MAP_STYLE_AERIAL});a.connect(s,"onLoad",r.hitch(this,(function(){t.callback([e,i])}))),a.connect(s,"onError",(function(r){delete i.bingMapsKey,e.itemData=Me(n);var a=e.itemData.baseMap.baseMapLayers[0];a.errors=[];a.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."}),t.callback([e,i])}))}else xe(e,i,n,t)}function xe(e,r,i,a){delete r.bingMapsKey,e.itemData=Me(i);var n=e.itemData.baseMap.baseMapLayers[0];n.errors=[];n.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),a.callback([e,r])}function Me(e){return ce(e.baseMap.baseMapLayers[0])?e.baseMap={title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:fe(e.baseMap.baseMapLayers[0])?e.baseMap={title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:e.baseMap={title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]},e}function ke(e,r,a,n){var t=e.dynamicLayerInfos||e.layerInfos,o=r.layers;if(o&&t)if(n.usePopupManager){var s;i.forEach(t,(function(e){var r,i=e.id;if(!e.subLayerIds)for(r=0;r<o.length;r++){var n=o[r];if(n.id===i&&n.popupInfo&&!n.disablePopup){s||(s={}),s[i]={infoTemplate:new a(n.popupInfo),layerUrl:n.layerUrl};break}}})),s&&e.setInfoTemplates(s)}else{var l=[],c=[],f=[],y=[],p=[],u=[];i.forEach(t,(function(r){var a,n=r.id;if(!r.subLayerIds&&-1!==i.indexOf(e.visibleLayers,n))for(a=0;a<o.length;a++){var t=o[a];if(t.id===n){c.push(n),l.push(t.popupInfo),f.push(t.layerUrl||""),t.layerDefinition&&t.layerDefinition.definitionExpression?y.push(t.layerDefinition.definitionExpression):y.push(""),p.push(m.isDefined(t.minScale)?t.minScale:null),u.push(m.isDefined(t.maxScale)?t.maxScale:null);break}}})),l.length&&(e.__popups=l,e.__popupIds=c,e.__popupUrls=f,e.__popupWhereClauses=y,e.__popupMinScales=p,e.__popupMaxScales=u,e.__resourceInfo=r.resourceInfo)}}function _e(e){if(!e)return!1;var r=new o(R.arcgisUrl).authority;return-1!==e.indexOf(".arcgis.com/")||-1!==e.indexOf(r)}function Ee(e){return!!e&&(-1!==e.indexOf("/services.arcgisonline.com/")||-1!==e.indexOf("/server.arcgisonline.com/"))}function Te(e){return"https:"===location.protocol&&(_e(e)||Ee(e))&&(e=e.replace("http:","https:")),e}function Oe(e,a,n){var t,o=[];e.displayLevels||(o=i.map(e.resourceInfo.tileInfo.lods,(function(e){return e.level}))),e.exclusionAreas&&(t=r.clone(e.exclusionAreas),t=i.map(t,(function(e){return e.geometry=new L(e.geometry),e})));var s,l=e.resourceInfo&&"Raster"===e.resourceInfo.cacheType;if(l){var c=e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer;s=new X(Te(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval,multidimensionalDefinition:e.multidimensionalDefinition,bandIds:e.bandIds,renderer:c||null})}else s=new T(Te(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,displayLevels:e.displayLevels||o,id:e.id,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval,exclusionAreas:t});return n.ignorePopups||(l&&e.popupInfo&&!e.disablePopup?s.setInfoTemplate(new a(e.popupInfo)):ke(s,e,a,n)),s}function Pe(e,r){if(!e||!r||0===r.length)return[];var i,a=","+r+",",n=[],t=",";for(i=0;i<e.length;i++)null!==e[i].subLayerIds?(-1===a.indexOf(","+e[i].id+",")||t.indexOf(","+e[i].id+",")>-1)&&(t+=e[i].subLayerIds.toString()+","):a.indexOf(","+e[i].id+",")>-1&&-1===t.indexOf(","+e[i].id+",")&&n.push(e[i].id);return n}function Re(e,a,n){var t=new U;t.format="png24",e.resourceInfo&&e.resourceInfo.supportedImageFormatTypes&&e.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")>-1&&(t.format="png32");var o=new C(Te(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,imageParameters:t,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval}),s=e.visibleLayers;if(!e.visibleLayers){var l="",c=o.layerInfos;i.forEach(c,(function(e){e.defaultVisibility&&(l+=(l.length>0?",":"")+e.id)})),s=l}if(e.layers&&e.layers.length>0){var f,y,p,u=[],d=[],m=[];i.forEach(e.layers,(function(a){var n=a.layerDefinition;if(n&&n.definitionExpression&&(u[a.id]=n.definitionExpression),n&&n.source){if(f=null,"mapLayer"===(p=n.source).type){var t=i.filter(e.resourceInfo.layers,(function(e){return e.id===p.mapLayerId}));t.length&&(f=r.mixin(t[0],a))}else f=r.mixin({},a);if(f){if(f.source=p,delete f.popupInfo,f=new G(f),e.visibleLayers){var o="string"==typeof e.visibleLayers?e.visibleLayers.split(","):e.visibleLayers;i.indexOf(o,a.id)>-1?f.defaultVisibility=!0:f.defaultVisibility=!1}d.push(f)}}if(n&&null!=n.transparency){var s=n.drawingInfo||{};null==s.transparency&&(s.transparency=n.transparency,n.drawingInfo=s)}n&&n.source&&n.drawingInfo&&(y=new N(n.drawingInfo),m[a.id]=y)}),this),u.length>0&&o.setLayerDefinitions(u),d.length>0?(o.setDynamicLayerInfos(d,!0),m.length>0&&o.setLayerDrawingOptions(m,!0)):(s=Pe(o.layerInfos,s),o.setVisibleLayers(s))}else s=Pe(o.layerInfos,s),o.setVisibleLayers(s);return n.ignorePopups||ke(o,e,a,n),o}function Ce(e,r,a){var n=[102113,102100,3857],t=a||new h(r[0].layerObject.fullExtent.spatialReference),o=new h(e.resourceInfo.fullExtent.spatialReference);return!(t.wkt!=o.wkt||!(t.wkid==o.wkid||m.isDefined(t.latestWkid)&&t.latestWkid==o.wkid||m.isDefined(o.latestWkid)&&t.wkid==o.latestWkid||m.isDefined(t.latestWkid)&&t.latestWkid==o.latestWkid))||!!(t.wkid&&o.wkid&&i.some(n,(function(e){return e===o.wkid}))&&i.some(n,(function(e){return e===t.wkid})))}function Ae(e,r,i){if(!r[0].layerObject.tileInfo)return!1;for(var a=e.resourceInfo.tileInfo,n=r[0].layerObject.tileInfo,t=i.width>i.height?i.width:i.height,o=!1,s=!1,l=0;l<a.lods.length;l++){for(var c=a.lods[l].scale/a.dpi,f=0;f<n.lods.length;f++){var y=n.lods[f].scale/n.dpi;if(Math.abs(y-c)/y<1/t){if(o){s=!0;break}o=!0}}if(s)break}return!!s||!(!o||1!==a.lods.length&&1!==n.lods.length)}function Fe(e,n,o,l,c,f){var u,d,b,g,I=o._clazz;if(pe(e))u=new z({id:e.id,opacity:e.opacity,visible:null===e.visibility||void 0===e.visibility||e.visibility});else if(!(g=e)||"WFS"!==g.layerType&&"WFS"!==g.type)if(de(e)){var S=[],D=[];i.forEach(e.layers,(function(e){D.push(new ae({name:e.name,title:e.title,legendURL:e.legendURL||e.legendUrl,queryable:e.queryable,showPopup:e.showPopup})),S.push(e.name)}),this),e.visibleLayers&&(S=e.visibleLayers);var k=new L(e.extent[0][0],e.extent[0][1],e.extent[1][0],e.extent[1][1],new h({wkid:4326})),_={customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,extent:k,layerInfos:D,version:e.version,maxWidth:e.maxWidth,maxHeight:e.maxHeight,featureInfoFormat:e.featureInfoFormat,getFeatureInfoURL:e.featureInfoUrl,getMapURL:e.mapUrl,spatialReferences:e.spatialReferences,title:e.title,copyright:e.copyright,minScale:e.minScale||0,maxScale:e.maxScale||0,format:e.format};(u=new ie(e.url,{id:e.id,visibleLayers:S,format:"png",transparent:!e.firstLayer,opacity:e.opacity,visible:null===e.visibility||e.visibility,resourceInfo:_,refreshInterval:e.refreshInterval})).spatialReference.wkid=_.spatialReferences[0]}else if(function(e){return!(!e||"KML"!==e.layerType&&"KML"!==e.type)}(e)){if(b=e.url,p.id){var E=p.id.findCredential(v.urlToObject(R.arcgisUrl).path);if(E){var T=R.arcgisUrl.substring(R.arcgisUrl.indexOf("//")+2,R.arcgisUrl.indexOf("/",R.arcgisUrl.indexOf("//")+3)),P=T.split("."),C=P[P.length-2]+"."+P[P.length-1],G=b.indexOf(C);G>-1&&(b="https://"+T+b.substring(G+C.length),b+="?token="+E.token)}}u=new B(b,{id:e.id,visible:null===e.visibility||e.visibility,outSR:l,refreshInterval:e.refreshInterval}),a.connect(u,"onLoad",(function(){(e.opacity||0===e.opacity)&&u.setOpacity(e.opacity),m.isDefined(e.minScale)&&m.isDefined(e.maxScale)&&u.setScaleRange(e.minScale,e.maxScale),e.visibleFolders&&i.forEach(u.folders,(function(r){i.indexOf(e.visibleFolders,r.id)>-1?u.setFolderVisibility(r,!0):u.setFolderVisibility(r,!1)}),this)}))}else if(function(e){return!(!e||"WebTiledLayer"!==e.layerType&&"WebTiledLayer"!==e.type)}(e))u=new ee(e.templateUrl,{id:e.id,visible:null===e.visibility||e.visibility,opacity:e.opacity,copyright:e.copyright,fullExtent:e.fullExtent&&new L(e.fullExtent),initialExtent:e.fullExtent&&new L(e.fullExtent),subDomains:e.subDomains,tileInfo:e.tileInfo?new Q(e.tileInfo):null,refreshInterval:e.refreshInterval,wmtsInfo:e.wmtsInfo}),(m.isDefined(e.minScale)||m.isDefined(e.maxScale))&&(u.loaded?u.setScaleRange(e.minScale,e.maxScale):a.connect(u,"onLoad",(function(){u.setScaleRange(e.minScale,e.maxScale)})));else if(function(e){return!(!e||"GeoRSS"!==e.layerType&&"GeoRSS"!==e.type)}(e))u=new W(e.url,{id:e.id,opacity:e.opacity,outSpatialReference:l,refreshInterval:e.refreshInterval}),a.connect(u,"onLoad",(function(){!1===e.visibility&&u.hide(),m.isDefined(e.minScale)&&m.isDefined(e.maxScale)&&u.setScaleRange(e.minScale,e.maxScale);var r=u.getFeatureLayers();i.forEach(r,(function(i){e.pointSymbol&&"esriGeometryPoint"===i.geometryType?(i.renderer.symbol=w.fromJson(e.pointSymbol),1===r.length&&(u.pointSymbol=w.fromJson(e.pointSymbol))):e.lineSymbol&&"esriGeometryPolyline"===i.geometryType?(i.renderer.symbol=w.fromJson(e.lineSymbol),1===r.length&&(u.polylineSymbol=w.fromJson(e.lineSymbol))):e.polygonSymbol&&"esriGeometryPolygon"===i.geometryType&&(i.renderer.symbol=w.fromJson(e.polygonSymbol),1===r.length&&(u.polygonSymbol=w.fromJson(e.polygonSymbol)))}))}));else if(ue(e)&&e.url){var U={layerDefinition:e.layerDefinition,columnDelimiter:e.columnDelimiter,id:e.id?e.id:null,visible:null===e.visibility||e.visibility,opacity:e.opacity,refreshInterval:e.refreshInterval};e.locationInfo&&(U.latitudeFieldName=e.locationInfo.latitudeFieldName,U.longitudeFieldName=e.locationInfo.longitudeFieldName),!o.ignorePopups&&e.popupInfo&&(U.infoTemplate=new I(e.popupInfo)),u=new j(e.url,U)}else if("VectorTileLayer"!==e.layerType||!e.styleUrl||e.resourceInfo&&e.resourceInfo instanceof Error){if(e.layerDefinition&&!e.url){var N=t.fromJson(t.toJson(e));delete N.id,delete N.opacity,delete N.visibility,u=new O(N,{id:e.id,opacity:e.opacity,visible:e.visibility,outFields:["*"],autoGeneralize:!0}),o.ignorePopups||!N.popupInfo||N.disablePopup||u.setInfoTemplate(new I(N.popupInfo)),Ue(u)}else if(ye(e))if(o.bingMapsKey){var X=Z.MAP_STYLE_AERIAL_WITH_LABELS;ce(e)?X=Z.MAP_STYLE_AERIAL:fe(e)&&(X=Z.MAP_STYLE_ROAD),u=new Z({bingMapsKey:o.bingMapsKey,mapStyle:X,opacity:e.opacity,id:e.id}),a.connect(u,"onError",r.hitch(this,(function(e){e.errors=e.errors||[];var r={message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+he(e)+"]"};e.errors.push(r)}),e))}else{e.errors=e.errors||[];var $={message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+he(e)+"]"};e.errors.push($)}else if(e.resourceInfo&&(e.resourceInfo.mapName||""===e.resourceInfo.mapName))u=!0===e.resourceInfo.singleFusedMapCache&&(e.baseMapLayer||Ce(e,n,l)&&Ae(e,c,f))?Oe(e,I,o):Re(e,I,o);else if(e.resourceInfo&&e.resourceInfo.pixelSizeX)u=!0===e.resourceInfo.singleFusedMapCache&&"ArcGISImageServiceLayer"!==e.layerType&&(e.baseMapLayer||"Raster"===e.resourceInfo.cacheType||Ce(e,n,l)&&Ae(e,c,f))?Oe(e,I,o):function(e,r,i){var a,n=new V;if(n.bandIds=e.bandIds,null!=e.format&&(n.format=e.format,null!=e.compressionQuality&&(n.compressionQuality=e.compressionQuality)),e.renderingRule&&e.renderingRule.rasterFunction){var t=new H(e.renderingRule);n.renderingRule=t}if(e.mosaicRule){var o=new J(e.mosaicRule);n.mosaicRule=o}m.isDefined(e.noData)&&(n.noData=e.noData),m.isDefined(e.noDataInterpretation)&&(n.noDataInterpretation=e.noDataInterpretation),m.isDefined(e.interpolation)&&(n.interpolation=e.interpolation);var s=!!e.layerType&&"ArcGISImageServiceVectorLayer"===e.layerType;m.isDefined(e.layerType)||(s=e.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===e.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===e.resourceInfo.serviceDataType));var l={resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,imageServiceParameters:n,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval};if(a=s?new F(Te(e.url),l):new A(Te(e.url),l),e.layerDefinition){if(e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer){var c=x.fromJson(e.layerDefinition.drawingInfo.renderer);a.setRenderer(c)}e.layerDefinition.definitionExpression&&a.setDefinitionExpression(e.layerDefinition.definitionExpression,!0)}return i.ignorePopups||!e.popupInfo||e.disablePopup||a.setInfoTemplate(new r(e.popupInfo)),a}(e,I,o);else if(e.resourceInfo&&"Feature Layer"===e.resourceInfo.type){var ne;if(e.capabilities&&(e.resourceInfo.capabilities=e.capabilities),!1===o.editable?ne=!1:o.privileges&&-1===i.indexOf(o.privileges,"features:user:edit")&&p.id&&p.id.findCredential(e.url)&&(ne=!1),u=new O(Te(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,mode:e.mode===O.MODE_SELECTION?O.MODE_SELECTION:O.MODE_AUTO,editable:ne,outFields:["*"],autoGeneralize:!0,refreshInterval:e.refreshInterval}),o.ignorePopups||!e.popupInfo||e.disablePopup||u.setInfoTemplate(new I(e.popupInfo)),e.layerDefinition){if(e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer){var te=x.fromJson(e.layerDefinition.drawingInfo.renderer,{geometryType:u.geometryType});te.isMaxInclusive=!0,u.setRenderer(te)}e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.labelingInfo&&(d=i.map(e.layerDefinition.drawingInfo.labelingInfo,(function(e){return new K(e)})),u.setLabelingInfo(d)),e.layerDefinition.definitionExpression&&u.setDefinitionExpression(e.layerDefinition.definitionExpression),m.isDefined(e.layerDefinition.minScale)&&u.setMinScale(e.layerDefinition.minScale),m.isDefined(e.layerDefinition.maxScale)&&u.setMaxScale(e.layerDefinition.maxScale)}Ue(u)}else if(e.resourceInfo&&e.resourceInfo.streamUrls){var oe,se,le,me={resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id};e.layerDefinition&&(se=e.layerDefinition.drawingInfo,e.layerDefinition.definitionGeometry&&((oe=oe||{}).geometry=e.layerDefinition.definitionGeometry),m.isDefined(e.layerDefinition.definitionExpression)&&((oe=oe||{}).where=e.layerDefinition.definitionExpression),m.isDefined(e.layerDefinition.maximumTrackPoints)&&(me.maximumTrackPoints=e.layerDefinition.maximumTrackPoints)),oe&&(me.filter=oe),e.purgeOptions&&(me.purgeOptions=e.purgeOptions),u=new q(Te(e.url),me),se&&se.renderer&&(le=se.renderer,u.setRenderer(x.fromJson(le,{geometryType:e.resourceInfo.geometryType}))),se&&se.labelingInfo&&(d=i.map(se.labelingInfo,(function(e){return new K(e)})),u.setLabelingInfo(d)),o.ignorePopups||!e.popupInfo||e.disablePopup||u.setInfoTemplate(new I(e.popupInfo)),e.layerDefinition&&(m.isDefined(e.layerDefinition.minScale)&&u.setMinScale(e.layerDefinition.minScale),m.isDefined(e.layerDefinition.maxScale)&&u.setMaxScale(e.layerDefinition.maxScale)),s.once(u,"error",(function(r){e.errors.push({message:"Error loading stream layer. Check websocket url"})}))}}else u=new Y(e.styleUrl,{id:e.id,minScale:e.minScale,maxScale:e.maxScale,opacity:e.opacity,visible:e.visibility,resourceInfo:e.resourceInfo});else{var be={customParameters:e.wfsInfo.customParameters,geometryType:e.layerDefinition.geometryType,id:e.id,labelingInfo:e.layerDefinition.drawingInfo.labelingInfo,maxFeatures:e.wfsInfo.maxFeatures,mode:e.mode,name:e.wfsInfo.name,showLabels:!0,swapXY:e.wfsInfo.swapXY,title:e.title,url:e.url,version:e.wfsInfo.version,visible:e.visibility,wkid:e.layerDefinition.spatialReference.wkid};(u=new re).fromJson(be,(function(){m.isDefined(e.opacity)&&u.setOpacity(e.opacity),m.isDefined(e.visibility)&&u.setVisibility(e.visibility),(e.minScale||e.maxScale)&&u.setScaleRange(e.minScale,e.maxScale),u.renderer=x.fromJson(e.layerDefinition.drawingInfo.renderer,{geometryType:be.geometryType}),!o.ignorePopups&&e.popupInfo&&u.setInfoTemplate(new I(e.popupInfo)),u.emit("fromJsonComplete")}))}if(u&&(u.arcgisProps={title:e.title},e.baseMapLayer&&(e.isReference?(u.attr("data-reference",!0),u._basemapGalleryLayerType="reference"):u._basemapGalleryLayerType="basemap"),u instanceof O&&e.layerDefinition&&e.layerDefinition.featureReduction&&"cluster"===e.layerDefinition.featureReduction.type)){var ge=e.layerDefinition.featureReduction;ge.clusterSize&&(ge.clusterSize=y.pt2px(ge.clusterSize)),ge.clusterRadius&&(ge.clusterRadius=y.pt2px(ge.clusterRadius)),ge.popupInfo&&(ge.infoTemplate=new M(ge.popupInfo),delete ge.popupInfo),u.setFeatureReduction(ge)}return u}function je(e,r,a,n,t){i.forEach(e,(function(i){i.layerObject=Fe(i,e,r,a,n,t)}));var o=i.filter(e,(function(e){return!e.isReference})),s=i.filter(e,(function(e){return!!e.isReference}));return e=o.concat(s)}function Ge(e){var r=null,i=e[0];return i.url&&me(i)&&i.resourceInfo.spatialReference&&(r=new h,i.resourceInfo.spatialReference.wkid&&(r.wkid=i.resourceInfo.spatialReference.wkid),i.resourceInfo.spatialReference.wkt&&(r.wkt=i.resourceInfo.spatialReference.wkt)),ye(i)||pe(i)?r=new h({wkid:102100}):de(i)&&(r=new h({wkid:i.spatialReferences[0]})),r}function We(e,r,a,n,t,o,s,l){return i.forEach(r,(function(r){(me(r)||be(r))&&(r.resourceInfo=e[r.deferredsPos][1],delete r.deferredsPos)})),r=je(r,a,o=o||Ge(r),s,l),t.callback(r),t}function Ue(e){if(!window.CanvasRenderingContext2D&&e.renderer&&"esri.renderer.HeatmapRenderer"===e.renderer.declaredClass){e.setRenderer(x.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}}function Ve(e,r,i){e.message?e.message+=" [url:"+r+"]":e.message="[url:"+r+"]",i.push(e),u.defaults.io.errorHandler(e)}function Be(e,r){var i=Te(e);return b({url:i,content:{f:"json"},callbackParamName:"callback",error:function(e,a){Ve(e,i,r)}})}function Ke(e){var r=or(e.itemId)+"/data";return b({url:r,content:{f:"json"},callbackParamName:"callback",error:function(i,a){e.errors=e.errors||[],Ve(i,r,e.errors)}})}function Ne(e,a,o){var s=new n;if(!(o.featureCollection&&o.featureCollection.layers||o.layers)){console.log("Invalid Feature Collection item data [item id: "+e.itemId+"]: ",o),e.errors=e.errors||[];var l={message:"Invalid Feature Collection item data. [item id: "+e.itemId+"]"};return e.errors.push(l),s.errback(),s}return o.layers&&(o.featureCollection={layers:o.layers},delete o.layers,m.isDefined(o.showLegend)&&(o.featureCollection.showLegend=o.showLegend,delete o.showLegend)),Je(e,o.featureCollection,a).then((function(a){o.featureCollection=a,e.featureCollection&&e.featureCollection.layers?i.forEach(o.featureCollection.layers,(function(i,a){var n=e.featureCollection.layers[a];n.popupInfo||n.layerDefinition?n.layerDefinition?(m.isDefined(n.layerDefinition.minScale)&&m.isDefined(n.layerDefinition.maxScale)&&(n.layerDefinition.minScale!==i.layerDefinition.minScale||n.layerDefinition.maxScale!==i.layerDefinition.maxScale)&&(delete i.layerDefinition.minScale,delete i.layerDefinition.maxScale),n.layerDefinition.drawingInfo&&t.toJson(n.layerDefinition.drawingInfo)!==t.toJson(i.layerDefinition.drawingInfo)&&delete i.layerDefinition.drawingInfo,n.layerDefinition.showLegend!==i.layerDefinition.showLegend&&delete i.layerDefinition.showLegend,n.layerDefinition=r.mixin(n.layerDefinition,i.layerDefinition)):n.layerDefinition=i.layerDefinition:(n.popupInfo=i.popupInfo,n.layerDefinition=i.layerDefinition),n.featureSet=i.featureSet,n.nextObjectId=i.nextObjectId})):(e.featureCollection=e.featureCollection||{},e.featureCollection=r.mixin(e.featureCollection,o.featureCollection)),s.callback(e)})),s}function Je(r,a,t){var o=new n;return e(["./csv"],(function(e){var n=[];i.forEach(a.layers,(function(r){if(r.featureSet&&r.featureSet.features&&r.featureSet.features.length&&r.featureSet.features[0].geometry&&r.featureSet.features[0].geometry.spatialReference){r.deferredsPos=n.length;var i=r.featureSet.features[0].geometry.spatialReference;n.push(e.projectFeatureCollection(r,t,i))}})),new l(n).addCallback((function(){i.forEach(a.layers,(function(e){if(m.isDefined(e.deferredsPos)){if(n[e.deferredsPos].results&&n[e.deferredsPos].results.length)e=n[e.deferredsPos].results[0];else{console.log("Errors projecting feature collection. ["+r.title+" - "+e.layerDefinition.name+"]"),e.errors=e.errors||[];var i={message:"Errors projecting feature collection. ["+r.title+" - "+e.layerDefinition.name+"]"};e.errors.push(i)}delete e.deferredsPos}})),o.callback(a)}))})),o}function ze(a,t,o,c,f){var y=new n,p=new n,u=[];return i.forEach(a.operationalLayers,(function(e){e.itemId&&"Feature Collection"==e.type&&u.push(Ke(e).then(r.hitch(null,Ne,e,o)))})),0===u.length?He(a,t,o,c,p,f):new l(u).addCallback((function(e){He(a,t,o,c,p,f)})),p.then((function(e){if(u=[],i.forEach(e,(function(e){var r;(e=e.layerObject)instanceof O&&!e.loaded&&!e.loadError?(r=new n,s.once(e,"load, error",(function(){r.callback(e)})),u.push(r)):e&&"esri.layers.WFSLayer"===e.declaredClass&&!e.loadError&&(r=new n,s.once(e,"fromJsonComplete, error",(function(i){r.callback(e)})),u.push(r))})),u.length){var r=new n;return new l(u).addCallback((function(){r.callback(e)})),r.promise}return e})).then((function(r){var a=[];i.forEach(r,(function(e){var r=e.layerObject;r&&(r instanceof O||"esri.layers.StreamLayer"===r.declaredClass)?r.loaded&&r.labelingInfo&&(e.showLabels||r._collection?a.push(r):r.setShowLabels&&r.setShowLabels(!1)):r&&"esri.layers.WFSLayer"===r.declaredClass&&r.loaded&&r.labelingInfo&&a.push(r)})),a.length?e(["../layers/LabelLayer"],(function(e){var n=new e;i.forEach(a,(function(e){n.addFeatureLayer(e)})),r.push({layerObject:n}),y.callback(r)})):y.callback(r)})),y}function He(e,r,a,n,t,o){var s=[],c=[],f=[];(i.forEach(e.operationalLayers,(function(e,r){if(e.featureCollection&&e.featureCollection.layers){var a=e.featureCollection.layers.length;i.forEach(e.featureCollection.layers,(function(n,t){var o=!0;e.visibleLayers&&-1==i.indexOf(e.visibleLayers,t)&&(o=!1);var s=null==e.visibility||!!e.visibility;n.visibility=s&&o,n.opacity=e.opacity,n.id=(e.id||"operational"+r)+"_"+t,e.title&&(1!==a&&n.layerDefinition.name&&e.title!==n.layerDefinition.name?n.title=e.title+" - "+n.layerDefinition.name:n.title=e.title),null==n.disablePopup&&(n.disablePopup=e.disablePopup),f.push(n)}),this)}else f.push(e)})),i.forEach(e.baseMap.baseMapLayers,(function(e,r){e.baseMapLayer=!0,e.id=e.id||"base"+r,s.push(e)})),i.forEach(f,(function(e,r){e.id=e.id||"operational"+r,s.push(e)})),i.forEach(s,(function(e){var r,i,a=be(e);(me(e)||a)&&(e.deferredsPos=c.length,e.errors=e.errors||[],a?c.push((r=e.styleUrl,i=e.errors,$.loadMetadata(r).otherwise((function(e){return Ve(e,r,i),e})))):c.push(Be(e.url,e.errors)))})),0===c.length)?(a=a||Ge(s),s=je(s,r,a,n,o),t.callback(s)):new l(c).addCallback((function(e){We(e,s,r,0,t,a,n,o)}));return t}function Xe(e,r,a,n){var t,o=e.minScale,s=e.maxScale;if(a.version<=10.1&&r){for(t=r.length-1;t>=0;t--)if(r[t].id==n){if(0==o&&r[t].minScale>0?o=r[t].minScale:o>0&&0==r[t].minScale?o=a.minScale:o>0&&r[t].minScale>0&&(o=Math.min(o,r[t].minScale)),s=Math.max(a.maxScale||0,r[t].maxScale||0),a.setScaleRange(o,s),!(r[t].parentLayerId>-1))break;n=r[t].parentLayerId}}else if(a.version>10.1){var l=e.layerInfos;i.forEach(l,(function(e){e.id==n&&(0==o&&e.minScale>0?o=e.minScale:o>0&&0==e.minScale||o>0&&e.minScale>0&&(o=Math.min(o,e.minScale)),s=Math.max(s||0,e.maxScale||0))})),a.setScaleRange(o,s)}}function qe(e,n,t,o){var s=e.url,l=e.__popups,c=e.__popupIds,f=e.__popupUrls,y=e.__popupWhereClauses,p=e.__popupMinScales,u=e.__popupMaxScales,d=e.__resourceInfo,b=[];if(i.forEach(l,(function(r,o){if(r){var l,h=[];if(i.forEach(r.fieldInfos,(function(e){"shape"!==e.fieldName.toLowerCase()&&h.push(e.fieldName)})),e.dynamicLayerInfos&&e.dynamicLayerInfos.length>0){var g=i.filter(e.dynamicLayerInfos,(function(e){return c[o]==e.id}))[0].source;l=new O(s+"/dynamicLayer",{parentLayer:e,id:e.id+"_"+c[o],source:g,outFields:h,mode:O.MODE_SELECTION,infoTemplate:r&&new t(r),drawMode:!1,visible:e.visible,autoGeneralize:!0});var v=function(r,i){if(y[r].length>0&&i.setDefinitionExpression(y[r]),m.isDefined(p[r])||m.isDefined(u[r]))if(m.isDefined(e.minScale)||m.isDefined(e.maxScale)){var a=e.minScale,t=e.maxScale;0==a&&p[r]>0?a=p[r]:a>0&&0==p[r]||a>0&&p[r]>0&&(a=Math.min(a,p[r])),t=Math.max(t||0,u[r]||0),i.setScaleRange(a,t)}else i.setScaleRange(p[r],u[r]);else Xe(e,n||d.layers,i,c[r])};l.loaded?v(o,l):a.connect(l,"onLoad",(function(e){v(o,l)}))}else{var I,S=null,L=s+"/"+c[o];if(f[o].length)L=f[o];else if(n)for(I=0;I<n.length;I++)if(n[I].id===c[o]){S=n[I];break}(l=new O(Te(L),{parentLayer:e,id:e.id+"_"+c[o],outFields:h,mode:O.MODE_SELECTION,infoTemplate:r&&new t(r),drawMode:!1,visible:e.visible,resourceInfo:S,autoGeneralize:!0})).loaded?(y[o].length>0&&l.setDefinitionExpression(y[o]),Xe(e,n||d.layers,l,c[o])):a.connect(l,"onLoad",(function(r){y[o].length>0&&l.setDefinitionExpression(y[o]),Xe(e,n||d.layers,r,c[o])}))}b.push(l)}})),b.length>0){a.connect(e,"onVisibilityChange",r.hitch(this,(function(e,r){i.forEach(e,(function(e){r?e.show():e.hide()}))}),b));a.connect(o,"onLayerRemove",r.hitch(this,(function(e,r,a){e.id===a.id&&i.forEach(r,(function(e){o.removeLayer(e)}))}),e,b))}return delete e.__popups,delete e.__popupIds,delete e.__popupUrls,delete e.__popupWhereClauses,delete e.__popupMinScales,delete e.__popupMaxScales,delete e.__resourceInfo,b}function Qe(e){return b({url:Te(e.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Ye(e,r,a){var n=[];i.forEach(e,(function(e){var r=e.__popups;r&&r.length>1&&e.version>=10&&(e.__deferredsPos=n.length,n.push(Qe(e)))}));var t=[];n.length>0?new l(n).addCallback((function(n){i.forEach(e,(function(e){if(e.__popups&&e.__popups.length>0)if(e.__deferredsPos||0===e.__deferredsPos){var i=n[e.__deferredsPos][1];t=t.concat(qe(e,i.layers,a,r)),delete e.__deferredsPos}else t=t.concat(qe(e,null,a,r))})),r.addLayers(t)})):(i.forEach(e,(function(e){e.__popups&&e.__popups.length>0&&(t=t.concat(qe(e,null,a,r)))})),r.addLayers(t))}function $e(e){i.forEach(e,(function(e){var r=e.layer;if(r.toJson){var a=r.toJson();a.featureSet&&r.name&&r.name.indexOf("Text")>-1&&i.forEach(a.featureSet.features,(function(e,i){if(e.attributes.TEXT){var a=r.graphics[i];a.symbol.setText(e.attributes.TEXT),e.symbol.horizontalAlignment&&(a.symbol.align=e.symbol.horizontalAlignment),a.setSymbol(a.symbol),a.setAttributes(e.attributes)}}),this)}}))}function Ze(e){var r=6;return i.forEach(e,(function(e){var a=e.renderer;if(a)if("esri.renderer.SimpleRenderer"===a.declaredClass){var n=a.symbol;n&&n.xoffset&&(r=Math.max(r,Math.abs(n.xoffset))),n&&n.yoffset&&(r=Math.max(r,Math.abs(n.yoffset)))}else"esri.renderer.UniqueValueRenderer"!==a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||i.forEach(a.infos,(function(e){var i=e.symbol;i&&i.xoffset&&(r=Math.max(r,Math.abs(i.xoffset))),i&&i.yoffset&&(r=Math.max(r,Math.abs(i.yoffset)))}))})),r}function er(e){var r=this,a=r.infoWindow,t=e.graphic;if(r.loaded){a.hide(),a.clearFeatures();var o=[];if(i.forEach(r.graphicsLayerIds,(function(e){var i=r.getLayer(e);i&&i instanceof O&&i.loaded&&i.visible&&(i.clearSelection(),i.infoTemplate&&!i.suspended&&o.push(i))})),i.forEach(r.layerIds,(function(e){var i=r.getLayer(e);i&&(-1!==i.declaredClass.indexOf("ArcGISImageServiceLayer")||-1!==i.declaredClass.indexOf("RasterXLayer"))&&i.loaded&&i.visible&&i.infoTemplate&&o.push(i)})),t=t&&t.getInfoTemplate()?t:null,o.length||t){var s=Ze(o),l=e.screenPoint,c=r.toMap(new S(l.x-s,l.y+s)),f=r.toMap(new S(l.x+s,l.y-s)),y=new L(c.x,c.y,f.x,f.y,r.spatialReference),p=new _;p.geometry=y,p.timeExtent=r.timeExtent;var u=!0,d=i.map(o,(function(r){var a,t=function(e){return e&&e.isFeatureReductionActive&&e.isFeatureReductionActive()}(r);if(-1!==(r=t?r.getFeatureReductionLayer():r).declaredClass.indexOf("ArcGISImageServiceLayer")){p.geometry=e.mapPoint,u=!1;var o={rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0};(a=r.queryVisibleRasters(p,o)).addCallback((function(){return r.getVisibleRasters()}))}else if(-1!==r.declaredClass.indexOf("RasterXLayer"))a=r.fetchPopupFromTiles({geometry:e.mapPoint});else if("function"==typeof r.selectFeatures)(a=r.selectFeatures(p)).addCallback((function(){return r.getSelectedFeatures()}));else{a=new n;var s=i.filter(r.graphics,(function(e){return e&&e.visible&&y.intersects(e.geometry)}));a.resolve(s)}return a}));if(t){var m=new n;m.callback([t]),d.splice(0,0,m)}if(!i.some(d,(function(e){return-1===e.fired}))){var b=t?1:0;if(i.forEach(o,(function(e){-1!==e.declaredClass.indexOf("ArcGISImageServiceLayer")?b+=e.getVisibleRasters().length:-1!==e.declaredClass.indexOf("RasterXLayer")?b+=e.getPopupFromTiles().length:b+=e.getSelectedFeatures().length})),!b)return}a.setFeatures(d),a.show(e.mapPoint,{closestFirst:u})}}}function rr(e,r,n,t,o,s){var l,f,y,p;if(t.map)l=t.map,f=t.clickEventHandle,y=t.clickEventListener,p=t.errors;else{var u=n.itemData;!o.mapOptions.backgroundColor&&u.background&&u.background.color&&null!=u.background.color[0]&&(o.mapOptions.backgroundColor=d.toDojoColor(u.background.color)),l=function(e,r){var i,n=r.mapOptions||{};n.infoWindow||(i=new k({visibleWhenEmpty:!1},c.create("div")),n.infoWindow=i),m.isDefined(n.showInfoWindowOnClick)||r.usePopupManager||(n.showInfoWindowOnClick=!1);var t=new g(e,n);return a.connect(t,"onLayersAddResult",$e),t}(t,o),o.ignorePopups||o.disableClickBehavior||o.usePopupManager||(f=a.connect(l,"onClick",er),y=er)}l.addLayers(e),o.ignorePopups||o.usePopupManager||Ye(e,l,o._clazz);var b=p||[];i.forEach(r,(function(e){e.errors&&(b=b.concat(e.errors))}),this),l.loaded?s.callback({map:l,itemInfo:n,errors:b,clickEventHandle:f,clickEventListener:y}):a.connect(l,"onLoad",(function(){s.callback({map:l,itemInfo:n,errors:b,clickEventHandle:f,clickEventListener:y})}))}function ir(e,a,n,t,o){var s=[];if(i.forEach(o,(function(e){r.isArray(e.layerObject)?i.forEach(e.layerObject,(function(e){s.push(e)})):s.push(e.layerObject)})),ye(o[0]))var l=setInterval((function(){if(o[0].layerObject&&o[0].layerObject.loaded)clearInterval(l),ar(e,a,n,t,o,s);else if(o[0].errors){clearInterval(l);var r="";o[0].errors&&o[0].errors.length&&(r=" ("+o[0].errors[0].message+")"),t.errback(new Error(P.arcgis.utils.baseLayerError+r))}}),10);else if(!s[0]&&o[0].baseMapLayer){var c="";o[0].errors&&o[0].errors.length&&(c=" ("+o[0].errors[0].message+")"),t.errback(new Error(P.arcgis.utils.baseLayerError+c))}else ar(e,a,n,t,o,s)}function ar(e,a,n,t,o,s){try{var l=n.mapOptions||{};if(n.mapOptions=l,s=i.filter(s,m.isDefined),a.map||l.extent)return void rr(s,o,e,a,n,t);var c=s[0].spatialReference;if(l.center&&(null!=l.zoom||l.scale)&&(r.isArray(l.center)&&(l.center=new I(l.center)),D.canProject(l.center,c)))return void rr(s,o,e,a,n,t);var f=e.item;if(f&&f.extent&&f.extent.length){var y=new L(f.extent[0][0],f.extent[0][1],f.extent[1][0],f.extent[1][1],new h({wkid:4326}));if(4326===c.wkid)l.extent=y,rr(s,o,e,a,n,t);else if(900913===c.wkid||102100===c.wkid||102113===c.wkid||3857===c.wkid)y.xmin=Math.max(y.xmin,-180),y.xmax=Math.min(y.xmax,180),y.ymin=Math.max(y.ymin,-89.99),y.ymax=Math.min(y.ymax,89.99),l.extent=D.geographicToWebMercator(y),rr(s,o,e,a,n,t);else{if(n.geometryServiceURL||u.defaults.geometryService)(n.geometryServiceURL?new E(n.geometryServiceURL):u.defaults.geometryService).project([y],c,(function(r){var i=r[0];l.extent=l.extent||i,rr(s,o,e,a,n,t)}),(function(){rr(s,o,e,a,n,t)}));else t.errback(new Error(P.arcgis.utils.geometryServiceError))}}else rr(s,o,e,a,n,t)}catch(e){t.errback(e)}}function nr(e){var r=[],a=e.baseMap.baseMapLayers;return e.operationalLayers&&(a=a.concat(e.operationalLayers)),i.forEach(a,(function(e){var a={};if(e.featureCollection&&!ue(e))!0===e.featureCollection.showLegend&&i.forEach(e.featureCollection.layers,(function(i){if(!1!==i.showLegend){var n=i.layerObject.renderer;a={layer:i.layerObject,title:e.title,defaultSymbol:!!(n&&n.defaultSymbol&&n.defaultLabel)},e.featureCollection.layers.length>1&&(a.title+=" - "+i.layerDefinition.name),r.push(a)}}));else if(e.baseMapLayer&&!0===e.showLegend&&e.layerObject||!e.baseMapLayer&&!1!==e.showLegend&&e.layerObject&&!(e.layerObject instanceof O&&e.layerObject.mode===O.MODE_SELECTION)){var n=e.layerObject.renderer,t=e.layerObject.declaredClass,o=!(n&&!(n&&n.defaultSymbol&&n.defaultLabel));if((e.layerObject.version<10.1&&("esri.layers.ArcGISDynamicMapServiceLayer"===t||"esri.layers.ArcGISTiledMapServiceLayer"===t)||"esri.layers.ArcGISImageServiceLayer"===t)&&(o=!0),a={layer:e.layerObject,title:e.title,defaultSymbol:o},e.layers){var s=i.map(i.filter(e.layers,(function(e){return!1===e.showLegend})),(function(e){return e.id}));s.length&&(a.hideLayers=s)}r.push(a)}})),r}function tr(t,o,s,l){!function(e){var r=e.itemData,a=function(e,r){"GroupLayer"===e.layerType?i.forEach(e.layers,(function(i){i.visibility=!1!==e.visibility&&i.visibility,i.opacity=m.isDefined(e.opacity)?m.isDefined(i.opacity)?i.opacity*e.opacity:e.opacity:i.opacity,a(i,r)})):r.push(e)},n=[];i.forEach(r.operationalLayers,(function(e){a(e,n)})),r.operationalLayers=n}(l);var c=l.itemData;c.baseMap&&c.baseMap.baseMapLayers&&c.baseMap.baseMapLayers.length&&(c.baseMap.baseMapLayers[0].firstLayer=!0);var f=o.layerMixins,y=f&&f.length;if(y){var u=function(e){for(var i=0;i<y;i++){var a=f[i];if(a.mixin)if(a.hasOwnProperty("id")){if(e.id===a.id){r.mixin(e,a.mixin);break}}else if(e.url===a.url){r.mixin(e,a.mixin);break}}};i.forEach(c.baseMap&&c.baseMap.baseMapLayers,u),i.forEach(c.operationalLayers,u)}(function(r,a){var t=new n,o=r.itemData,s=[];o.baseMap&&o.baseMap.baseMapLayers&&(s=s.concat(o.baseMap.baseMapLayers)),o.operationalLayers&&(s=s.concat(o.operationalLayers));for(var l=i.map(s,(function(e){return e&&e.layerType})),c=[],f=[],y=!1,p=0;p<l.length;p++){switch(l[p]){case"ArcGISFeatureLayer":-1===i.indexOf(c,ne)&&c.push(ne);break;case"ArcGISImageServiceLayer":case"ArcGISTiledImageServiceLayer":-1===i.indexOf(c,"../layers/ArcGISImageServiceLayer")&&(c.push("../layers/ArcGISImageServiceLayer"),f.push("../layers/ImageServiceParameters"),f.push("../layers/MosaicRule"),f.push("../layers/RasterFunction"),c.push("../layers/RasterXLayer"));break;case"ArcGISImageServiceVectorLayer":-1===i.indexOf(c,"../layers/ArcGISImageServiceVectorLayer")&&(c.push("../layers/ArcGISImageServiceVectorLayer"),f.push("../layers/ImageServiceParameters"),f.push("../layers/MosaicRule"),f.push("../layers/RasterFunction"));break;case"ArcGISMapServiceLayer":case"ArcGISTiledMapServiceLayer":-1===i.indexOf(c,"../layers/ArcGISDynamicMapServiceLayer")&&(c.push("../layers/ArcGISDynamicMapServiceLayer"),f.push("../layers/DynamicLayerInfo"),f.push("../layers/ImageParameters"),f.push("../layers/LayerDrawingOptions"));break;case"ArcGISStreamLayer":-1===i.indexOf(c,"../layers/StreamLayer")&&c.push("../layers/StreamLayer"),-1===i.indexOf(c,ne)&&c.push(ne);break;case"BingMapsAerial":case"BingMapsHybrid":case"BingMapsRoad":-1===i.indexOf(c,oe)&&c.push(oe);break;case"CSV":-1===i.indexOf(c,"../layers/CSVLayer")&&(c.push("../layers/CSVLayer"),f.push("./csv"));break;case"GeoRSS":-1===i.indexOf(c,"../layers/GeoRSSLayer")&&c.push("../layers/GeoRSSLayer");break;case"KML":-1===i.indexOf(c,"../layers/KMLLayer")&&c.push("../layers/KMLLayer");break;case"OpenStreetMap":-1===i.indexOf(c,"../layers/OpenStreetMapLayer")&&c.push("../layers/OpenStreetMapLayer");break;case"VectorTileLayer":-1===i.indexOf(c,"../layers/VectorTileLayer")&&c.push("../layers/VectorTileLayer"),-1===i.indexOf(f,te)&&f.push(te);break;case"WebTiledLayer":-1===i.indexOf(c,"../layers/WebTiledLayer")&&(c.push("../layers/WebTiledLayer"),f.push("../layers/TileInfo"));break;case"WFS":-1===i.indexOf(c,"../layers/WFSLayer")&&c.push("../layers/WFSLayer");break;case"WMS":-1===i.indexOf(c,"../layers/WMSLayer")&&(c.push("../layers/WMSLayer"),f.push("../layers/WMSLayerInfo"));break;default:y=!0}if(y)break}function u(e,r){i.forEach(e,(function(e,i){switch(e){case"../layers/ArcGISDynamicMapServiceLayer":C=r[i];break;case"../layers/ArcGISImageServiceLayer":A=r[i];break;case"../layers/ArcGISImageServiceVectorLayer":F=r[i];break;case"./csv":r[i];break;case"../layers/CSVLayer":j=r[i];break;case"../layers/DynamicLayerInfo":G=r[i];break;case"../layers/GeoRSSLayer":W=r[i];break;case"../layers/ImageParameters":U=r[i];break;case"../layers/ImageServiceParameters":V=r[i];break;case"../layers/KMLLayer":B=r[i];break;case ne:K=r[i];break;case"../layers/LayerDrawingOptions":N=r[i];break;case"../layers/MosaicRule":J=r[i];break;case"../layers/OpenStreetMapLayer":z=r[i];break;case"../layers/RasterFunction":H=r[i];break;case"../layers/RasterXLayer":X=r[i];break;case"../layers/StreamLayer":q=r[i];break;case"../layers/TileInfo":Q=r[i];break;case"../layers/VectorTileLayer":Y=r[i];break;case te:$=r[i];break;case oe:Z=r[i];break;case"../layers/WebTiledLayer":ee=r[i];break;case"../layers/WFSLayer":re=r[i];break;case"../layers/WMSLayer":ie=r[i];break;case"../layers/WMSLayerInfo":ae=r[i]}}))}return y&&(c=se,f=le),c.length?e(c,(function(){u(c,arguments),f.length?e(f,(function(){u(f,arguments),t.resolve()})):t.resolve()})):t.resolve(),t})(l).then((function(){return function(e){var r,i,a=new n,t=e.itemData,o=t.baseMap&&t.baseMap.baseMapLayers;if(Y&&!Y.supported())for(var s=0;s<o.length;s++){var l=o[s];if(!l.isReference){"VectorTileLayer"===l.layerType&&(r=l.itemId,i=s);break}}return r?sr(r,!1).addBoth((function(e){e&&e.item&&/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i.test(e.item.url)&&(o[i]={id:"FB_"+l.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in l?l.opacity:1,visibility:!("visibility"in l)||l.visibility,url:"https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"}),a.resolve()})):a.resolve(),a}(l)})).then((function(){return function(e,i){var t=new n,o=e.itemData,s=o.baseMap.baseMapLayers[0];if(ye(s))if(s.portalUrl&&p.id)delete i.bingMapsKey,p.id.checkSignInStatus(v.urlToObject(R.arcgisUrl).path).then(r.hitch(null,(function(e,i,a,n,t){Ie(s.portalUrl,t.token).then(r.hitch(null,we,e,i,a,n),r.hitch(null,xe,e,i,a,n))}),e,i,o,t),r.hitch(null,(function(e,i,a,n,t){Ie(s.portalUrl).then(r.hitch(null,we,e,i,a,n),r.hitch(null,xe,e,i,a,n))}),e,i,o,t));else if(i.bingMapsKey){var l=new Z({bingMapsKey:i.bingMapsKey,mapStyle:Z.MAP_STYLE_AERIAL});a.connect(l,"onLoad",r.hitch(this,(function(){t.callback([e,i])}))),a.connect(l,"onError",(function(r){delete i.bingMapsKey,e.itemData=Me(o),(s=e.itemData.baseMap.baseMapLayers[0]).errors=[];s.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."}),t.callback([e,i])}))}else{e.itemData=Me(o),(s=e.itemData.baseMap.baseMapLayers[0]).errors=[];s.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),t.callback([e,i])}else t.callback([e,i]);return t}(l,o)})).then((function(e){var a=e[0],o=e[1];if(a.itemData.operationalLayers&&0!==a.itemData.operationalLayers.length){var l=new n,c=a.itemData.baseMap.baseMapLayers.slice(),f=i.filter(a.itemData.baseMap.baseMapLayers,(function(e){return!e.isReference})),y={item:a.item,itemData:{baseMap:{baseMapLayers:f},background:r.clone(a.itemData.background)}};a.itemData.baseMap.baseMapLayers=i.filter(a.itemData.baseMap.baseMapLayers,(function(e){return e.isReference})),De(y).addCallback((function(e){ze(e.itemData,o).addCallback(r.hitch(null,ir,e,t,o,l))})),l.then((function(e){De(a).addCallback((function(r){ze(r.itemData,o,e.map.spatialReference,f,e.map).addCallback((function(i){r.itemData.baseMap.baseMapLayers=c,ir(r,e,o,s,i)}))}))}),r.hitch(s,s.errback))}else De(a).addCallback((function(e){ze(e.itemData,o).addCallback(r.hitch(null,ir,e,t,o,s))}))}))}function or(e){return R.arcgisUrl+"/"+e}function sr(e,r){void 0===r&&(r=!0),R._arcgisUrl&&R._arcgisUrl.length>0&&(R.arcgisUrl=R._arcgisUrl);var i={},a=new n;return b({url:or(e),content:{f:"json"},callbackParamName:"callback",load:function(n){i.item=n,r?b({url:or(e)+"/data",content:{f:"json"},callbackParamName:"callback",load:function(e){i.itemData=e,a.callback(i)},error:function(e){a.errback(e)}}):a.callback(i)},error:function(e){a.errback(e)}}),a}return R={arcgisUrl:v.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:sr,createMap:function(e,i,a){var t=new n,o=(a=a||{}).infoTemplateClass;return a._clazz=o&&(r.isObject(o)?o:r.getObject(o))||M,r.isString(e)?sr(e).addCallback(r.hitch(null,tr,i,a,t)).addErrback(r.hitch(t,t.errback)):tr(i,a,t,e),t.addCallback((function(e){var i=e.map;i&&(i.tables=r.getObject("itemInfo.itemData.tables",!1,e)||[])})),t},getLayerList:function(e){return e&&e.itemInfo&&e.itemInfo.itemData?(r=e.itemInfo.itemData,a=[],n=r.operationalLayers,i.forEach(n,(function(e){e.featureCollection?a.push({featureCollection:e.featureCollection,visibility:null==e.visibility||!!e.visibility,title:e.title}):e.layerObject&&a.push({layer:e.layerObject,visibility:null==e.visibility||!!e.visibility,title:e.title})})),a):[];var r,a,n},getLegendLayers:function(e){return e&&e.itemInfo&&e.itemInfo.itemData?nr(e.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:De,_getItemData:ve,_getBingKey:Ie,_portalUrlResponse:we,_portalUrlFailure:xe,_processFSItemProperties:Se,_processSSItemProperties:Le,_getLayers:ze,_preBuildLayerObjects:We,_buildLayerObjects:je,_preCreateMap:ir,_getMapSR:Ge,_createMap:rr,_addSelectionLayers:Ye,_createSelectionFeatureLayers:qe,_getServiceInfo:Be,_getFeatureCollectionItem:Ke,_mergeFeatureCollectionItem:Ne,_projectFeatureCollection:Je,_getLayersInfo:Qe,_initLayer:Fe,_loadAsCached:Oe,_loadAsDynamic:Re,_processPopups:ke,_onLayersAddResult:$e,_sameSpatialReferenceAsBasemap:Ce,_sameTilingSchemeAsBasemap:Ae,_showPopup:er,_calculateClickTolerance:Ze,_getVisibleFeatureLayers:Pe,_updateLayerScaleInfo:Xe,_checkUrl:Te,_isHostedService:_e,_isAgolService:Ee,_getLegendLayers:nr},r.setObject("arcgis.utils",R,p),R}));