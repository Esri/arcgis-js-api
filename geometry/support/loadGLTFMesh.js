/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../chunks/vec3f64","../../chunks/mat3f64","../../chunks/vec4f64","./MeshTexture","./MeshMaterialMetallicRoughness","../../chunks/mat3","../../views/3d/support/buffer/BufferView","../../chunks/vec32","./meshUtils/georeference","../../views/3d/webgl-engine/materials/DefaultMaterial","../../views/3d/glTF/DefaultLoadingContext","../../chunks/vec22","../../chunks/vec33","../../chunks/vec43","../../views/3d/support/buffer/utils","../../views/3d/glTF/loader","../../views/3d/glTF/internal/indexUtils","../../chunks/vec42"],(function(e,t,r,n,a,o,u,s,i,c,f,l,p,m,w,d,g,h,V,B){"use strict";async function v(e,t,r){const n=new p.DefaultLoadingContext,a=(await h.load(n,t,r,!0)).model,o=a.lods.shift(),u=new Map,s=new Map;return a.textures.forEach(((e,t)=>u.set(t,y(e)))),a.materials.forEach(((e,t)=>s.set(t,M(e,u)))),o.parts.map((t=>x(e,s,t,r)))}function y(e){return new o({data:e.data,wrap:S(e.parameters.wrap)})}function M(e,r){const n=C(e.color,e.opacity),a=e.emissiveFactor?R(e.emissiveFactor):null,o={color:n,colorTexture:t.unwrap(t.applySome(e.textureColor,(e=>r.get(e)))),normalTexture:t.unwrap(t.applySome(e.textureNormal,(e=>r.get(e)))),emissiveColor:a,emissiveTexture:t.unwrap(t.applySome(e.textureEmissive,(e=>r.get(e)))),occlusionTexture:t.unwrap(t.applySome(e.textureOcclusion,(e=>r.get(e)))),alphaMode:T(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.unwrap(t.applySome(e.textureMetallicRoughness,(e=>r.get(e))))};return new u(o)}function x(e,r,a,o){const u=g.createBuffer(i.BufferViewVec3f64,a.attributes.position.count);c.transformMat4(u,a.attributes.position,a.transform);const l=t.applySome(a.attributes.normal,(e=>{const t=g.createBuffer(i.BufferViewVec3f,e.count),r=s.normalFromMat4(n.create(),a.transform);return c.transformMat3(t,e,r),t.typedBuffer})),p=t.applySome(a.attributes.tangent,(e=>{const t=g.createBuffer(i.BufferViewVec4f,e.count),r=s.normalFromMat4(n.create(),a.transform);return B.transformMat3(t,e,r),t.typedBuffer})),h=t.applySome(a.attributes.texCoord0,(e=>{const t=g.createBuffer(i.BufferViewVec2f,e.count);return m.normalizeIntegerBuffer(t,e),t.typedBuffer})),V=t.applySome(a.attributes.color,(e=>{const t=g.createBuffer(i.BufferViewVec4u8,e.count);if(4===e.elementCount)e instanceof i.BufferViewVec4f?B.scale(t,e,255):e instanceof i.BufferViewVec4u8?d.copy(t,e):e instanceof i.BufferViewVec4u16&&B.shiftRight(t,e,8);else{d.fill(t,255,255,255,255);const r=new i.BufferViewVec3u8(t.buffer,0,4);e instanceof i.BufferViewVec3f?c.scale(r,e,255):e instanceof i.BufferViewVec3u8?w.copy(r,e):e instanceof i.BufferViewVec3u16&&c.shiftRight(r,e,8)}return t.typedBuffer})),v=f.georeference({position:u.typedBuffer,normal:t.unwrap(l),tangent:t.unwrap(p)},e,{...o,unit:"meters"}),y=b(a.indices||a.attributes.position.count,a.primitiveType);return{vertexAttributes:{position:v.position,normal:v.normal,tangent:v.tangent,uv:t.unwrap(h),color:t.unwrap(V)},components:[{faces:y,material:r.get(a.material),trustSourceNormals:!0}],spatialReference:e.spatialReference}}function b(e,t){switch(t){case 4:return V.trianglesToTriangles(e);case 5:return V.triangleStripToTriangles(e);case 6:return V.triangleFanToTriangles(e)}}function T(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function S(e){return{horizontal:F(e.s),vertical:F(e.t)}}function F(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function k(e){return e**(1/l.COLOR_GAMMA)*255}function C(e,t){return a.fromValues(k(e[0]),k(e[1]),k(e[2]),t)}function R(e){return r.fromValues(k(e[0]),k(e[1]),k(e[2]))}e.loadGLTFMesh=v,Object.defineProperty(e,"__esModule",{value:!0})}));
