/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../chunks/vec3f64","../../chunks/mat3f64","../../chunks/vec4f64","./MeshTexture","./MeshMaterialMetallicRoughness","../../chunks/mat3","../../views/3d/support/buffer/BufferView","../../chunks/vec32","./meshUtils/georeference","../../views/3d/webgl-engine/materials/DefaultMaterial","../../views/3d/glTF/DefaultLoadingContext","../../chunks/vec22","../../chunks/vec33","../../chunks/vec43","../../views/3d/support/buffer/utils","../../views/3d/glTF/loader","../../views/3d/glTF/internal/indexUtils","../../chunks/vec42"],(function(e,t,r,n,a,o,u,s,i,c,f,l,p,m,w,d,h,g,V,v){"use strict";function B(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function y(e){return{horizontal:M(e.s),vertical:M(e.t)}}function M(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function x(e){return 255*Math.pow(e,1/l.COLOR_GAMMA)}e.loadGLTFMesh=async function(e,l,M){const b=new p.DefaultLoadingContext,T=(await g.load(b,l,M)).model,S=T.lods.shift(),F=new Map,k=new Map;return T.textures.forEach(((e,t)=>{return F.set(t,new o({data:(r=e).data,wrap:y(r.parameters.wrap)}));var r})),T.materials.forEach(((e,n)=>k.set(n,function(e,n){const o=(c=e.color,f=e.opacity,a.fromValues(x(c[0]),x(c[1]),x(c[2]),f)),s=e.emissiveFactor?function(e){return r.fromValues(x(e[0]),x(e[1]),x(e[2]))}(e.emissiveFactor):null,i={color:o,colorTexture:t.unwrap(t.applySome(e.textureColor,(e=>n.get(e)))),normalTexture:t.unwrap(t.applySome(e.textureNormal,(e=>n.get(e)))),emissiveColor:s,emissiveTexture:t.unwrap(t.applySome(e.textureEmissive,(e=>n.get(e)))),occlusionTexture:t.unwrap(t.applySome(e.textureOcclusion,(e=>n.get(e)))),alphaMode:B(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.unwrap(t.applySome(e.textureMetallicRoughness,(e=>n.get(e))))};var c,f;return new u(i)}(e,F)))),S.parts.map((r=>function(e,r,a,o){const u=h.createBuffer(i.BufferViewVec3f64,a.attributes.position.count);c.transformMat4(u,a.attributes.position,a.transform);const l=t.applySome(a.attributes.normal,(e=>{const t=h.createBuffer(i.BufferViewVec3f,e.count),r=s.normalFromMat4(n.create(),a.transform);return c.transformMat3(t,e,r),t.typedBuffer})),p=t.applySome(a.attributes.tangent,(e=>{const t=h.createBuffer(i.BufferViewVec4f,e.count),r=s.normalFromMat4(n.create(),a.transform);return v.transformMat3(t,e,r),t.typedBuffer})),g=t.applySome(a.attributes.texCoord0,(e=>{const t=h.createBuffer(i.BufferViewVec2f,e.count);return m.normalizeIntegerBuffer(t,e),t.typedBuffer})),B=t.applySome(a.attributes.color,(e=>{const t=h.createBuffer(i.BufferViewVec4u8,e.count);if(4===e.elementCount)e instanceof i.BufferViewVec4f?v.scale(t,e,255):e instanceof i.BufferViewVec4u8?d.copy(t,e):e instanceof i.BufferViewVec4u16&&v.shiftRight(t,e,8);else{d.fill(t,255,255,255,255);const r=new i.BufferViewVec3u8(t.buffer,0,4);e instanceof i.BufferViewVec3f?c.scale(r,e,255):e instanceof i.BufferViewVec3u8?w.copy(r,e):e instanceof i.BufferViewVec3u16&&c.shiftRight(r,e,8)}return t.typedBuffer})),y=f.georeference({position:u.typedBuffer,normal:t.unwrap(l),tangent:t.unwrap(p)},e,{...o,unit:"meters"}),M=function(e,t){switch(t){case 4:return V.trianglesToTriangles(e);case 5:return V.triangleStripToTriangles(e);case 6:return V.triangleFanToTriangles(e)}}(a.indices||a.attributes.position.count,a.primitiveType);return{vertexAttributes:{position:y.position,normal:y.normal,tangent:y.tangent,uv:t.unwrap(g),color:t.unwrap(B)},components:[{faces:M,material:r.get(a.material),trustSourceNormals:!0}],spatialReference:e.spatialReference}}(e,k,r,M)))},Object.defineProperty(e,"__esModule",{value:!0})}));
