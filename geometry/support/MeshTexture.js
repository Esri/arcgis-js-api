// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","@dojo/framework/shim/WeakMap","../../core/compilerUtils","../../core/JSONSupport","../../core/accessorSupport/decorators","../../core/accessorSupport/ensureType","../../support/persistableUrlUtils","../../views/support/screenshotUtils"],(function(t,e,a,r,n,o,i,s,p,l){"use strict";var c=new r.default,u=0;return function(t){function e(e){var a=t.call(this,e)||this;return a.wrap="repeat",a}var r;return a.__extends(e,t),r=e,Object.defineProperty(e.prototype,"url",{get:function(){return this._get("url")||null},set:function(t){this._set("url",t),t&&this._set("data",null)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._get("data")||null},set:function(t){this._set("data",t),t&&this._set("url",null)},enumerable:!1,configurable:!0}),e.prototype.writeData=function(t,e,a,r){if(t instanceof HTMLImageElement){var n={type:"image-element",src:p.toJSON(t.src,r),crossOrigin:t.crossOrigin};e[a]=n}else if(t instanceof HTMLCanvasElement){var o=t.getContext("2d").getImageData(0,0,t.width,t.height);n={type:"canvas-element",imageData:this.encodeImageData(o)};e[a]=n}else if(t instanceof HTMLVideoElement){n={type:"video-element",src:p.toJSON(t.src,r),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[a]=n}else{n={type:"image-data",imageData:this.encodeImageData(t)};e[a]=n}},e.prototype.readData=function(t){switch(t.type){case"image-element":var e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e;case"canvas-element":var a=this.decodeImageData(t.imageData),r=document.createElement("canvas");return r.width=a.width,r.height=a.height,r.getContext("2d").putImageData(a,0,0),r;case"image-data":return this.decodeImageData(t.imageData);case"video-element":var o=document.createElement("video");return o.src=t.src,o.crossOrigin=t.crossOrigin,o.autoplay=t.autoplay,o.loop=t.loop,o.muted=t.muted,o.preload=t.preload,o;default:return void n.neverReached(t)}},Object.defineProperty(e.prototype,"transparent",{get:function(){var t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return this.imageDataContainsTransparent(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return this.imageDataContainsTransparent(t);if(e){var a=e.substr(e.length-4,4).toLowerCase(),r=e.substr(0,15).toLocaleLowerCase();if(".png"===a||"data:image/png;"===r)return!0}return!1},set:function(t){null!=t?this._override("transparent",t):this._clearOverride("transparent")},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"contentHash",{get:function(){var t=this,e="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?this.wrap.horizontal+"/"+this.wrap.vertical:"",a=function(a){return void 0===a&&(a=""),"d:"+a+",t:"+t.transparent+",w:"+e};return null!=this.url?a(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?a(this.data.src):(c.has(this.data)||c.set(this.data,++u),a(c.get(this.data))):a()},enumerable:!1,configurable:!0}),e.prototype.clone=function(){return new r({url:this.url,data:this.data,wrap:this.cloneWrap()})},e.prototype.cloneWithDeduplication=function(t){var e=t.get(this);if(e)return e;var a=new r({url:this.url,data:this.data,wrap:this.cloneWrap()});return t.set(this,a),a},e.prototype.cloneWrap=function(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}},e.prototype.encodeImageData=function(t){for(var e="",a=0;a<t.data.length;a++)e+=String.fromCharCode(t.data[a]);return{data:btoa(e),width:t.width,height:t.height}},e.prototype.decodeImageData=function(t){for(var e=atob(t.data),a=new Uint8ClampedArray(e.length),r=0;r<e.length;r++)a[r]=e.charCodeAt(r);return l.wrapImageData(a,t.width,t.height)},e.prototype.imageDataContainsTransparent=function(t){for(var e=3;e<t.data.length;e+=4)if(255!==t.data[e])return!0;return!1},e.from=function(t){return"string"==typeof t?new r({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new r({data:t}):s.ensureClass(r,t)},a.__decorate([i.property({type:String,json:{write:p.write}})],e.prototype,"url",null),a.__decorate([i.property({json:{write:{overridePolicy:function(){return{enabled:!this.url}}}}}),i.property()],e.prototype,"data",null),a.__decorate([i.writer("data")],e.prototype,"writeData",null),a.__decorate([i.reader("data")],e.prototype,"readData",null),a.__decorate([i.property({type:Boolean,dependsOn:["data","url"],json:{write:{overridePolicy:function(){return{enabled:this._isOverridden("transparent")}}}}})],e.prototype,"transparent",null),a.__decorate([i.property({json:{write:!0}})],e.prototype,"wrap",void 0),a.__decorate([i.property({readOnly:!0,dependsOn:["url","data","wrap","transparent"]})],e.prototype,"contentHash",null),e=r=a.__decorate([i.subclass("esri.geometry.support.MeshTexture")],e)}(o.JSONSupport)}));