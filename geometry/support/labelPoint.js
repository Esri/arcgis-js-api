/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../core/PriorityQueue","./aaBoundingRect","./boundsUtils","./centroid","./coordsUtils","./intersectsBase"],(function(e,n,t,i,o,r,s,a){"use strict";const c=100*222045e-21;function l(e){const{rings:n}=e;if(!n||0===n.length)return null;const t=o.getBoundsXY(i.create(),e);if(!t)return null;const a=4*(Math.abs(t[0])+Math.abs(t[2])+Math.abs(t[1])+Math.abs(t[3])+1)*c;let l=0,g=0;for(let i=0;i<n.length;i++){const e=s.getRingArea(n[i]);e>g&&(g=e,l=i)}if(Math.abs(g)<=2*a*a){const e=o.getPointsBounds(i.create(),n[l]);return[(e[0]+e[2])/2,(e[1]+e[3])/2]}const h=r.ringCentroid(n[l],!1,i.create());if(null===h)return null;if(1===n.length&&n[0].length<4)return h;const d=[[NaN,NaN],[NaN,NaN],[NaN,NaN],[NaN,NaN]],m=[NaN,NaN,NaN,NaN],b=[NaN,NaN,NaN,NaN];let y=!1,M=N(h,e,!0);0===M.distance&&(y=!0,d[0][0]=h[0],d[0][1]=h[1],M=N(h,e,!1)),m[0]=M.distance,b[0]=0;const C=[NaN,NaN];let q=!1,T=.25,k=-1;const B=o.getPointsBounds(i.create(),n[l]);let S=NaN;do{if(S=NaN,d[1]=f(e,P(B[0],B[2],T),a,t),isNaN(d[1][0])||isNaN(d[1][1])||(M=N(d[1],e,!1),S=M.distance),!isNaN(S)&&S>a&&u(d[1],e))q=!0,m[1]=S,b[1]=x(d[1],h);else if(!isNaN(S)&&S>k&&(k=S,C[0]=d[1][0],C[1]=d[1][1]),T-=.01,T<.1){if(!(k>=0))break;q=!0,m[1]=k,d[1][0]=C[0],d[1][1]=C[1],b[1]=x(d[1],h)}}while(!q);q=!1,T=.5,k=-1;let p=.01,z=1;do{if(S=NaN,d[2]=f(e,P(B[0],B[2],T),a,t),isNaN(d[2][0])||isNaN(d[2][1])||(M=N(d[2],e,!1),S=M.distance),!isNaN(S)&&S>a&&u(d[2],e))q=!0,m[2]=S,b[2]=x(d[2],h);else if(!isNaN(S)&&S>k)k=S,C[0]=d[2][0],C[1]=d[2][1];else if(S>k&&(k=S,C[0]=d[2][0],C[1]=d[2][1]),T=.5+p*z,p+=.01,z*=-1,T<.3||T>.7){if(!(k>=0))break;q=!0,m[2]=k,d[2][0]=C[0],d[2][1]=C[1],b[2]=x(d[2],h)}}while(!q);q=!1,T=.75,k=-1;do{if(S=NaN,d[3]=f(e,P(B[0],B[2],T),a,t),isNaN(d[3][0])||isNaN(d[3][1])||(M=N(d[3],e,!1),S=M.distance),!isNaN(S)&&S>a&&u(d[3],e))q=!0,m[3]=S,b[3]=x(d[3],h);else if(S>k&&(k=S,C[0]=d[3][0],C[1]=d[3][1]),T+=.01,T>.9){if(!(k>=0))break;q=!0,m[3]=k,d[3][0]=C[0],d[3][1]=C[1],b[3]=x(d[3],h)}}while(!q);const D=[0,1,2,3],R=y?0:1;let j;for(let i=R;i<4;i++)for(let e=R;e<3;e++){const n=b[e],t=b[e+1];w(n,t)>0&&(j=D[e],D[e]=D[e+1],D[e+1]=j,b[e]=t,b[e+1]=n)}let L=R,O=0,Q=0;for(let i=R;i<4;i++){switch(i){case 0:Q=2*m[D[i]];break;case 1:Q=1.66666666*m[D[i]];break;case 2:Q=1.33333333*m[D[i]];break;case 3:Q=m[D[i]]}Q>O&&(O=Q,L=D[i])}return d[L]}function u(e,n){const{rings:t}=n;let i=0;for(const o of t){const n=o.length;for(let t=1;t<n;++t){const n=o[t-1],r=o[t];if(n[1]>e[1]==r[1]>e[1])continue;(r[0]-n[0])*(e[1]-n[1])-(r[1]-n[1])*(e[0]-n[0])>0?i++:i--}}return 0!==i}function N(e,n,t){if(t&&u(e,n))return{coord:e,distance:0};let i=1/0,o=0,r=0;const a=[0,0],{rings:c}=n;for(const l of c)if(!(l.length<2))for(let n=0;n<l.length-1;n++){s.projectPointOnLine(a,e,l,n);const t=x(e,a);t<i&&(i=t,o=a[0],r=a[1])}return{coord:[o,r],distance:Math.sqrt(i)}}function f(e,n,t,o){const r=[n,0];let s=1/0,c=1/0,l=!1,u=!1;const N=[[n,o[1]-1],[n,o[3]+1]],f=[0,0],h=[0,0],d=[0,0],m=[[0,0],[0,0]],b=i.create(),{rings:M}=e;for(const i of M)if(!(i.length<2))for(let e=1;e<i.length;e++){if(m[0][0]=i[e-1][0],m[0][1]=i[e-1][1],m[1][0]=i[e][0],m[1][1]=i[e][1],null===g(b,m))continue;if(h[0]=N[0][0],h[1]=N[0][1],d[0]=N[1][0],d[1]=N[1][1],0===y(b,h,d))continue;if(!a.segmentIntersects(N[0],N[1],m[0],m[1],f))continue;const n=f[1];s>c?n<s&&(s=n,l=!0):n<c&&(c=n,u=!0)}return l&&u?r[1]=(s+c)/2:r[0]=r[1]=NaN,r}function g(e,n){if(n.length<2)return null;e||(e=i.create());const[t,o]=n[0],[r,s]=n[1];return e[0]=Math.min(t,r),e[1]=Math.min(o,s),e[2]=Math.max(t,r),e[3]=Math.max(o,s),e}const h=1,d=4,m=3,b=12;function y(e,n,t){let i=M(n,e),o=M(t,e);const r=e[0],s=e[1],a=e[2],c=e[3];if(i&o)return 0;if(!(i|o))return 4;const l=(i?1:0)|(o?2:0);do{const l=t[0]-n[0],u=t[1]-n[1];if(l>u)i&m?(i&h?(n[1]+=u*(r-n[0])/l,n[0]=r):(n[1]+=u*(a-n[0])/l,n[0]=a),i=M(n,e)):o&m?(o&h?(t[1]+=u*(r-t[0])/l,t[0]=r):(t[1]+=u*(a-t[0])/l,t[0]=a),o=M(t,e)):i?(i&d?(n[0]+=l*(s-n[1])/u,n[1]=s):(n[0]+=l*(c-n[1])/u,n[1]=c),i=M(n,e)):(o&d?(t[0]+=l*(s-t[1])/u,t[1]=s):(t[0]+=l*(c-t[1])/u,t[1]=c),o=M(t,e));else if(i&b?(i&d?(n[0]+=l*(s-n[1])/u,n[1]=s):(n[0]+=l*(c-n[1])/u,n[1]=c),i=M(n,e)):o&b?(o&d?(t[0]+=l*(s-t[1])/u,t[1]=s):(t[0]+=l*(c-t[1])/u,t[1]=c),o=M(t,e)):i?(i&h?(n[1]+=u*(r-n[0])/l,n[0]=r):(n[1]+=u*(a-n[0])/l,n[0]=a),i=M(n,e)):(o&h?(t[1]+=u*(r-t[0])/l,t[0]=r):(t[1]+=u*(a-t[0])/l,t[0]=a),o=M(t,e)),i&o)return 0}while(i|o);return l}function M(e,n){return(e[0]<n[0]?1:0)|(e[0]>n[2]?1:0)<<1|(e[1]<n[1]?1:0)<<2|(e[1]>n[3]?1:0)<<3}function P(e,n,t){return e+(n-e)*t}function x(e,n){return(e[0]-n[0])*(e[0]-n[0])+(e[1]-n[1])*(e[1]-n[1])}function w(e,n){if(e<n)return-1;if(e>n)return 1;if(e===n)return 0;const t=isNaN(e),i=isNaN(n);return t<i?-1:t>i?1:0}let C=function(e,n,t,i){this.x=e,this.y=n,this.cellSize=t,this.distancefromCellCenter=s.distanceFromPointToPolygon(e,n,i),this.maxDistanceToPolygon=this.distancefromCellCenter+this.cellSize*Math.SQRT2};const q=1,T=100;function k(e){if(!e||!e.rings||0===e.rings.length)return null;const s=o.getPointsBounds(i.create(),e.rings[0]);if(!s)return null;const a=s[2]-s[0],c=s[3]-s[1];if(0===a||0===c)return[s[0]+a/2,s[1]+c/2];const l=Math.max(Math.min(a,c)/T,q),u=new t(((e,n)=>n.maxDistanceToPolygon-e.maxDistanceToPolygon)),N=Math.min(a,c);let f=N/2,g=0,h=0;for(g=s[0];g<s[2];g+=N)for(h=s[1];h<s[3];h+=N)u.enqueue(new C(g+f,h+f,f,e));const d=r.ringsCentroid(e.rings,!1);if(null===d)return null;let m,b=new C(d[0],d[1],0,e);for(;u.size>0;)m=n.unwrap(u.dequeue()),m.distancefromCellCenter>b.distancefromCellCenter&&(b=m),m.maxDistanceToPolygon-b.distancefromCellCenter<=l||(f=m.cellSize/2,u.enqueue(new C(m.x-f,m.y-f,f,e)),u.enqueue(new C(m.x+f,m.y-f,f,e)),u.enqueue(new C(m.x-f,m.y+f,f,e)),u.enqueue(new C(m.x+f,m.y+f,f,e)));return[b.x,b.y]}e.getLabelPoint=l,e.getPolylabelPoint=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
