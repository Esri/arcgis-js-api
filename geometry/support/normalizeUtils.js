// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../config","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../Polygon","../Polyline","../SpatialReference","./spatialReferenceUtils","./webMercatorUtils","../../tasks/geometry/cut","../../tasks/geometry/simplify"],(function(e,r,n,t,i,a,o,s,l,f,u,p,h,c,g){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.normalizeMapX=r.getDenormalizedExtent=r.normalizeCentralMeridian=r.straightLineDensify=void 0;var m=a.getLogger("esri.geometry.support.normalizeUtils"),v={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new f({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:u.WebMercator}),minus180Line:new f({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:u.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new f({paths:[[[180,-180],[180,180]]],spatialReference:u.WGS84}),minus180Line:new f({paths:[[[-180,-180],[-180,180]]],spatialReference:u.WGS84})}};function x(e){return"polygon"===e.type}function y(e){return x(e)?e.rings:e.paths}function d(e,r){return Math.ceil((e-r)/(2*r))}function M(e,r){for(var n=0,t=y(e);n<t.length;n++)for(var i=0,a=t[n];i<a.length;i++){a[i][0]+=r}return e}function w(e){for(var r=[],n=0,t=0,i=0;i<e.length;i++){for(var a=e[i],o=null,s=0;s<a.length;s++)o=a[s],r.push(o),0===s?t=n=o[0]:(n=Math.min(n,o[0]),t=Math.max(t,o[0]));o&&r.push([(n+t)/2,0])}return r}function b(e,r){if(!(e instanceof f||e instanceof l)){var n="straightLineDensify: the input geometry is neither polyline nor polygon";throw m.error(n),new i(n)}for(var t=[],a=0,o=y(e);a<o.length;a++){var s=o[a],u=[];t.push(u),u.push([s[0][0],s[0][1]]);for(var p=0;p<s.length-1;p++){var h=s[p][0],c=s[p][1],g=s[p+1][0],v=s[p+1][1],d=Math.sqrt((g-h)*(g-h)+(v-c)*(v-c)),M=(v-c)/d,w=(g-h)/d,b=d/r;if(b>1){for(var R=1;R<=b-1;R++){var L=R*r,z=w*L+h,W=M*L+c;u.push([z,W])}var X=(d+Math.floor(b-1)*r)/2,P=w*X+h,_=M*X+c;u.push([P,_])}u.push([g,v])}}return x(e)?new l({rings:t,spatialReference:e.spatialReference}):new f({paths:t,spatialReference:e.spatialReference})}function R(e,r,n){if(r){var t=b(e,1e6);e=h.webMercatorToGeographic(t,!0)}return n&&(e=M(e,n)),e}function L(e,r,n){var t;if(Array.isArray(e)){if((t=e[0])>r){var i=d(t,r);e[0]=t+i*(-2*r)}else if(t<n){i=d(t,n);e[0]=t+i*(-2*n)}}else if((t=e.x)>r){i=d(t,r);e=e.clone().offset(i*(-2*r),0)}else if(t<n){i=d(t,n);e=e.clone().offset(i*(-2*n),0)}return e}r.straightLineDensify=b,r.normalizeCentralMeridian=function e(r,i,a){return n.__awaiter(this,void 0,void 0,(function(){var u,m,x,w,b,z,W,X,P,_,D,I,S,U,k,A,T,E,G,q,C,N,j,F,O,B,H,J,K,Q,V,Y,Z,$,ee,re,ne;return n.__generator(this,(function(n){switch(n.label){case 0:if(!Array.isArray(r))return[2,e([r],i)];for(u=i?i.url:t.geometryServiceUrl,_=0,D=[],I=[],S=0,U=r;S<U.length;S++)k=U[S],o.isNone(k)?I.push(k):(m||(m=k.spatialReference,x=p.getInfo(m),w=m.isWebMercator,b=v[W=w?102100:4326].maxX,z=v[W].minX,X=v[W].plus180Line,P=v[W].minus180Line),x?"mesh"===k.type?I.push(k):"point"===k.type?I.push(L(k.clone(),b,z)):"multipoint"===k.type?((A=k.clone()).points=A.points.map((function(e){return L(e,b,z)})),I.push(A)):"extent"===k.type?(E=k.clone(),T=E._normalize(!1,!1,x),I.push(T.rings?new l(T):T)):k.extent?(E=k.extent,G=d(E.xmin,z),C=0===(q=G*(2*b))?k.clone():M(k.clone(),q),E.offset(q,0),E.intersects(X)&&E.xmax!==b?(_=E.xmax>_?E.xmax:_,C=R(C,w),D.push(C),I.push("cut")):E.intersects(P)&&E.xmin!==z?(_=E.xmax*(2*b)>_?E.xmax*(2*b):_,C=R(C,w,360),D.push(C),I.push("cut")):I.push(C)):I.push(k.clone()):I.push(k));for(N=d(_,b),j=-90,F=N,O=new f;N>0;)B=360*N-180,O.addPath([[B,j],[B,-1*j]]),j*=-1,N--;return D.length>0&&F>0?[4,c.cut(u,D,O,a)]:[3,3];case 1:for(H=n.sent(),J=function(e,r){for(var n=-1,t=function(t){for(var i=r.cutIndexes[t],a=r.geometries[t],o=y(a),s=function(e){var r=o[e];r.some((function(n){if(n[0]<180)return!0;for(var t=0,i=0;i<r.length;i++){var o=r[i][0];t=o>t?o:t}for(var s=-360*d(t=Number(t.toFixed(9)),180),l=0;l<r.length;l++){var f=a.getPoint(e,l);a.setPoint(e,l,f.clone().offset(s,0))}return!0}))},l=0;l<o.length;l++)s(l);if(i===n){if("polygon"===e[0].type)for(var f=0,u=y(a);f<u.length;f++){var p=u[f];e[i]=e[i].addRing(p)}else if(function(e){return"polyline"===e[0].type}(e))for(var h=0,c=y(a);h<c.length;h++){var g=c[h];e[i]=e[i].addPath(g)}}else n=i,e[i]=a},i=0;i<r.cutIndexes.length;i++)t(i);return e}(D,H),K=[],Q=[],ee=0;ee<I.length;ee++)"cut"!==(re=I[ee])?Q.push(re):(ne=J.shift(),V=r[ee],o.isSome(V)&&"polygon"===V.type&&V.rings&&V.rings.length>1&&ne.rings.length>=V.rings.length?(K.push(ne),Q.push("simplify")):Q.push(w?h.geographicToWebMercator(ne):ne));return K.length?[4,g.simplify(u,K,a)]:[2,Q];case 2:for(Y=n.sent(),Z=[],ee=0;ee<Q.length;ee++)"simplify"!==(re=Q[ee])?Z.push(re):Z.push(w?h.geographicToWebMercator(Y.shift()):Y.shift());return[2,Z];case 3:for($=[],ee=0;ee<I.length;ee++)"cut"!==(re=I[ee])?$.push(re):(ne=D.shift(),$.push(!0===w?h.geographicToWebMercator(ne):ne));return[2,s.resolve($)]}}))}))},r.getDenormalizedExtent=function(e){var r;if(!e)return null;var n=e.extent;if(!n)return null;var t=e.spatialReference&&p.getInfo(e.spatialReference);if(!t)return n;var i,a=t.valid,o=a[0],s=a[1],l=2*s,f=n.width,u=n.xmin,h=n.xmax;if(u=(r=[h,u])[0],h=r[1],"extent"===e.type||0===f||f<=s||f>l||u<o||h>s)return n;switch(e.type){case"polygon":if(!(e.rings.length>1))return n;i=w(e.rings);break;case"polyline":if(!(e.paths.length>1))return n;i=w(e.paths);break;case"multipoint":i=e.points}for(var c=n.clone(),g=0;g<i.length;g++){var m=i[g][0];m<0?(m+=s,h=Math.max(m,h)):(m-=s,u=Math.min(m,u))}return c.xmin=u,c.xmax=h,c.width<f?(c.xmin-=s,c.xmax-=s,c):n},r.normalizeMapX=function(e,r){var n=p.getInfo(r);if(n){var t=n.valid,i=t[0],a=t[1],o=a-i;if(e<i)for(;e<i;)e+=o;if(e>a)for(;e>a;)e-=o}return e}}));