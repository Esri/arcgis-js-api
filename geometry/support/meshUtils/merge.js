/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../MeshComponent"],(function(t,e,o){"use strict";const n=e.getLogger("esri.geometry.support.triangleMeshMerge");function r(t,e,o){(function(t,e){return e.normal>0&&!t.vertexAttributes.normal})(t,e)&&"source"===o.shading&&(o.shading="flat")}function i(t,e,n,i,s){if(t.components)for(const o of t.components){const l=o.cloneWithDeduplication(n,i);for(let t=0;t<l.faces.length;t++)l.faces[t]+=e.position/3;r(t,e,l),s.push(l)}else if(t.vertexAttributes&&t.vertexAttributes.position){const n=t.vertexAttributes.position.length/3,i=new Uint32Array(n);for(let t=0;t<n;t++)i[t]=t+e.position;const l=new o({faces:i});r(t,e,l),s.push(l)}}function s(t,e,o,n,r){if(!e)return;const i=e.position;if(!i)return;const s=e[t];if(s)!function(t,e,o,n,r){for(let i=0;i<r;i++)o[n++]=t[e++]}(s,0,o[t],n[t],s.length),n[t]+=s.length;else{const e=o[t];let s=n[t];const a=l[t];if(e){for(let t=0;t<i.length;t+=3)for(let t=0;t<a;t++)e[s++]=r;n[t]=s}}}const l={position:3,normal:3,tangent:4,uv:2,color:4};t.merge=function(t,e){if(0===t.length)return n.error("merge()","Must specify one more more geometries to merge"),null;const o=t[0].spatialReference;if(t.some((t=>!t.spatialReference.equals(o))))return n.error("merge()","Geometries must all be in the same spatial reference"),null;const r=function(t){let e=0,o=0,n=0,r=0,i=0;const s=function(t){let e=!1,o=!1,n=!1,r=!1;for(const i of t){const t=i.vertexAttributes;if(t&&t.position&&(t.uv&&(e=!0),t.normal&&(o=!0),t.tangent&&(r=!0),t.color&&(n=!0),o&&e&&n&&r))break}return{normal:o,uv:e,color:n,tangent:r}}(t);for(const a of t){const t=a.vertexAttributes;t&&t.position&&(e+=t.position.length,s.uv&&(o+=t.position.length/l.position*l.uv),s.normal&&(n+=t.position.length/l.position*l.normal),s.color&&(r+=t.position.length/l.position*l.color),s.tangent&&(i+=t.position.length/l.position*l.tangent))}return{position:new Float64Array(e),uv:o?new Float32Array(o):null,normal:n?new Float32Array(n):null,tangent:i?new Float32Array(i):null,color:r?new Uint8Array(r):null}}(t),a=[],c={position:0,uv:0,normal:0,tangent:0,color:0},u=new Map,f=new Map;for(const o of t){const t=o.vertexAttributes;if(e&&e.reuseMaterials&&o.components)for(const t of o.components)t.material&&u.set(t.material,t.material);i(o,c,u,f,a),s("position",t,r,c,0),s("normal",t,r,c,0),s("tangent",t,r,c,0),s("uv",t,r,c,0),s("color",t,r,c,255)}return{vertexAttributes:r,components:a,spatialReference:o}},Object.defineProperty(t,"__esModule",{value:!0})}));
