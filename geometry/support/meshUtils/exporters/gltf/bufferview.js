/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/promiseUtils","./types","../../../../../views/webgl/enums"],(function(e,t,s,i,n){"use strict";let r=function(){function e(e,t,s,n,r){this._buffer=e,this._componentType=s,this._dataType=n,this._data=[],this._isFinalized=!1,this._accessorIndex=-1,this._accessorAttribute=null,this._accessorMin=null,this._accessorMax=null,t.bufferViews||(t.bufferViews=[]),this.index=t.bufferViews.length,this._bufferView={buffer:e.index,byteLength:-1,target:r};const a=this._getElementSize();a>=4&&r!==i.TargetBuffer.ELEMENT_ARRAY_BUFFER&&(this._bufferView.byteStride=a),t.bufferViews.push(this._bufferView),this._numComponentsForDataType=this._calculateNumComponentsForDataType()}var r=e.prototype;return r.push=function(e){const t=this._data.length;if(this._data.push(e),this._accessorIndex>=0){const s=t%this._numComponentsForDataType,i=this._accessorMin[s];this._accessorMin[s]="number"!=typeof i?e:Math.min(i,e);const n=this._accessorMax[s];this._accessorMax[s]="number"!=typeof n?e:Math.max(n,e)}},r.getByteOffset=function(){if(!this._isFinalized)throw new Error("Cannot get BufferView offset until it is finalized");return this._buffer.getByteOffset(this)},r._createTypedArray=function(e,t){switch(this._componentType){case n.DataType.BYTE:return new Int8Array(e,t);case n.DataType.FLOAT:return new Float32Array(e,t);case n.DataType.SHORT:return new Int16Array(e,t);case n.DataType.UNSIGNED_BYTE:return new Uint8Array(e,t);case n.DataType.UNSIGNED_INT:return new Uint32Array(e,t);case n.DataType.UNSIGNED_SHORT:return new Uint16Array(e,t)}},r.writeOutToBuffer=function(e,t){this._createTypedArray(e,t).set(this._data)},r.writeAsync=function(e){if(this._asyncWritePromise)throw new Error("Can't write multiple bufferView values asynchronously");return this._asyncWritePromise=e.then((e=>{const t=new Uint8Array(e);for(let s=0;s<t.length;++s)this._data.push(t[s]);delete this._asyncWritePromise})),this._asyncWritePromise},r.startAccessor=function(e){if(this._accessorIndex>=0)throw new Error("Accessor was started without ending the previous one");this._accessorIndex=this._data.length,this._accessorAttribute=e;const t=this._numComponentsForDataType;this._accessorMin=new Array(t),this._accessorMax=new Array(t)},r.endAccessor=function(){if(this._accessorIndex<0)throw new Error("An accessor was not started, but was attempted to be ended");const e=this._getElementSize(),t=this._numComponentsForDataType,s=(this._data.length-this._accessorIndex)/t;if(s%1)throw new Error("An accessor was ended with missing component values");for(let n=0;n<this._accessorMin.length;++n)"number"!=typeof this._accessorMin[n]&&(this._accessorMin[n]=0),"number"!=typeof this._accessorMax[n]&&(this._accessorMax[n]=0);const i={byteOffset:e*(this._accessorIndex/t),componentType:this._componentType,count:s,type:this._dataType,min:this._accessorMin,max:this._accessorMax,name:this._accessorAttribute};switch(this._accessorAttribute){case"TEXCOORD_0":case"TEXCOORD_1":case"COLOR_0":case"WEIGHTS_0":switch(this._componentType){case n.DataType.UNSIGNED_BYTE:case n.DataType.UNSIGNED_SHORT:i.normalized=!0}}return this._accessorIndex=-1,this._accessorAttribute=null,this._accessorMin=null,this._accessorMax=null,i},r.finalize=function(){const e=this._bufferView;return new Promise((e=>{const t=this._buffer.getViewFinalizePromises(this);this._asyncWritePromise&&t.push(this._asyncWritePromise),e(s.eachAlways(t))})).then((()=>{this._isFinalized=!0,e.byteOffset=this.getByteOffset(),e.byteLength=this.dataSize,this._finalizedPromiseResolve&&this._finalizedPromiseResolve()}))},r._getElementSize=function(){return this._sizeComponentType()*this._numComponentsForDataType},r._sizeComponentType=function(){switch(this._componentType){case n.DataType.BYTE:case n.DataType.UNSIGNED_BYTE:return 1;case n.DataType.SHORT:case n.DataType.UNSIGNED_SHORT:return 2;case n.DataType.UNSIGNED_INT:case n.DataType.FLOAT:return 4}},r._calculateNumComponentsForDataType=function(){switch(this._dataType){case i.AttributeType.SCALAR:return 1;case i.AttributeType.VEC2:return 2;case i.AttributeType.VEC3:return 3;case i.AttributeType.VEC4:case i.AttributeType.MAT2:return 4;case i.AttributeType.MAT3:return 9;case i.AttributeType.MAT4:return 16}},t._createClass(e,[{key:"dataSize",get:function(){return this._data.length*this._sizeComponentType()}},{key:"byteSize",get:function(){function e(e,t){return t*Math.ceil(e/t)}return e(this.dataSize,4)}},{key:"byteOffset",get:function(){if(!this._isFinalized)throw new Error("Cannot get BufferView offset until it is finalized");return this._buffer.getByteOffset(this)}},{key:"finalized",get:function(){return this._finalizedPromise?this._finalizedPromise:this._isFinalized?this._finalizedPromise=Promise.resolve():this._finalizedPromise=new Promise((e=>this._finalizedPromiseResolve=e))}}]),e}();e.BufferView=r,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
