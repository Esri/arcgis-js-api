// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","../../../../../core/promiseUtils","./gltftypes"],(function(e,t,s,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,s,n,r){this.buffer=e,this.componentType=s,this.dataType=n,this.data=[],this.isFinalized=!1,this.accessorIndex=-1,this.accessorAttribute=null,this.accessorMin=null,this.accessorMax=null,t.bufferViews||(t.bufferViews=[]),this.index=t.bufferViews.length,this.bufferView={buffer:e.index,byteLength:-1,target:r};var o=this.getElementSize();o>=4&&r!==i.TargetBuffer.ELEMENT_ARRAY_BUFFER&&(this.bufferView.byteStride=o),t.bufferViews.push(this.bufferView)}return e.prototype.push=function(e){var t=this.data.length;if(this.data.push(e),this.accessorIndex>=0){var s=t%this.numComponentsForDataType(),i=this.accessorMin[s];this.accessorMin[s]="number"!=typeof i?e:Math.min(i,e);var n=this.accessorMax[s];this.accessorMax[s]="number"!=typeof n?e:Math.max(n,e)}},Object.defineProperty(e.prototype,"dataSize",{get:function(){return this.data.length*this.sizeComponentType()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return e=this.dataSize,(t=4)*Math.ceil(e/t);var e,t},enumerable:!0,configurable:!0}),e.prototype.getByteOffset=function(){if(!this.isFinalized)throw new Error("Cannot get BufferView offset until it is finalized");return this.buffer.getByteOffset(this)},Object.defineProperty(e.prototype,"byteOffset",{get:function(){if(!this.isFinalized)throw new Error("Cannot get BufferView offset until it is finalized");return this.buffer.getByteOffset(this)},enumerable:!0,configurable:!0}),e.prototype.writeOutToBuffer=function(e,t){void 0===t&&(t=this.size);for(var s=new DataView(e,t),i=this.sizeComponentType(),n=0;n<this.data.length;++n)this.writeValue(s,n*i,this.data[n])},e.prototype.writeAsync=function(e){var t=this;if(this.asyncWritePromise)throw new Error("Can't write multiple bufferView vlaues asynchronously");return this.asyncWritePromise=e.then((function(e){for(var s=new Uint8Array(e),i=0;i<s.byteLength;++i)t.data.push(s[i]);delete t.asyncWritePromise})),this.asyncWritePromise},e.prototype.startAccessor=function(e){if(this.accessorIndex>=0)throw new Error("Accessor was started without ending the previous one");this.accessorIndex=this.data.length,this.accessorAttribute=e;var t=this.numComponentsForDataType();this.accessorMin=new Array(t),this.accessorMax=new Array(t)},e.prototype.endAccessor=function(){if(this.accessorIndex<0)throw new Error("An accessor was not started, but was attempted to be ended");var e=this.getElementSize(),t=this.numComponentsForDataType(),s=(this.data.length-this.accessorIndex)/t;if(s%1)throw new Error("An accessor was ended with missing component values");for(var n=0;n<this.accessorMin.length;++n)"number"!=typeof this.accessorMin[n]&&(this.accessorMin[n]=0),"number"!=typeof this.accessorMax[n]&&(this.accessorMax[n]=0);var r={byteOffset:e*(this.accessorIndex/t),componentType:this.componentType,count:s,type:this.dataType,min:this.accessorMin,max:this.accessorMax,name:this.accessorAttribute};switch(this.accessorAttribute){case"TEXCOORD_0":case"TEXCOORD_1":case"COLOR_0":case"WEIGHTS_0":switch(this.componentType){case i.ComponentType.UNSIGNED_BYTE:case i.ComponentType.UNSIGNED_SHORT:r.normalized=!0}}return this.accessorIndex=-1,this.accessorAttribute=null,this.accessorMin=null,this.accessorMax=null,r},Object.defineProperty(e.prototype,"finalized",{get:function(){var e=this;return this.finalizedPromise?this.finalizedPromise:this.isFinalized?this.finalizedPromise=s.resolve():this.finalizedPromise=s.create((function(t){return e.finalizedPromiseResolve=t}))},enumerable:!0,configurable:!0}),e.prototype.finalize=function(){var e=this,t=this.bufferView;return s.create((function(t){var i=e.buffer.getViewFinalizePromises(e);e.asyncWritePromise&&i.push(e.asyncWritePromise),t(s.eachAlways(i))})).then((function(){e.isFinalized=!0,t.byteOffset=e.getByteOffset(),t.byteLength=e.dataSize,e.finalizedPromiseResolve&&e.finalizedPromiseResolve()}))},e.prototype.getElementSize=function(){return this.sizeComponentType()*this.numComponentsForDataType()},e.prototype.sizeComponentType=function(){switch(this.componentType){case i.ComponentType.BYTE:case i.ComponentType.UNSIGNED_BYTE:return 1;case i.ComponentType.SHORT:case i.ComponentType.UNSIGNED_SHORT:return 2;case i.ComponentType.UNSIGNED_INT:case i.ComponentType.FLOAT:return 4}},e.prototype.numComponentsForDataType=function(){switch(this.dataType){case i.DataType.SCALAR:return 1;case i.DataType.VEC2:return 2;case i.DataType.VEC3:return 3;case i.DataType.VEC4:case i.DataType.MAT2:return 4;case i.DataType.MAT3:return 9;case i.DataType.MAT4:return 16}},e.prototype.writeValue=function(e,t,s){switch(this.componentType){case i.ComponentType.BYTE:e.setInt8(t,s);break;case i.ComponentType.UNSIGNED_BYTE:e.setUint8(t,s);break;case i.ComponentType.SHORT:e.setInt16(t,s,!0);break;case i.ComponentType.UNSIGNED_SHORT:e.setUint16(t,s,!0);break;case i.ComponentType.UNSIGNED_INT:e.setUint32(t,s,!0);break;case i.ComponentType.FLOAT:e.setFloat32(t,s,!0);break;default:throw new Error("Unsupported data type: "+this.componentType)}},e}();t.BufferView=n}));