// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/quat","../../../../../core/libs/gl-matrix-2/quatf64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../MeshMaterialMetallicRoughness","../../georeference","./buffer","./geometry","./gltftypes","./imageutils"],(function(e,t,r,s,a,i,n,o,u,l,f,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GLTF=void 0;var c=function(){function e(e,t,r){this.params={},this.materialMap=new Array,this.gltf={asset:{version:"2.0",copyright:e.copyright,generator:e.generator},extras:{options:t,binChunkBuffer:null,promises:[]}},r&&(this.params=r),this.addScenes(e)}return e.prototype.addScenes=function(e){var t=this;this.gltf.scene=e.defaultScene;var r=this.gltf.extras.options.bufferOutputType===f.BufferOutputType.GLB||this.gltf.extras.options.imageOutputType===f.ImageOutputType.GLB;r&&(this.gltf.extras.binChunkBuffer=new u.Buffer(this.gltf)),e.forEachScene((function(e){t.addScene(e)})),r&&this.gltf.extras.binChunkBuffer.finalize()},e.prototype.addScene=function(e){var t=this;this.gltf.scenes||(this.gltf.scenes=[]);var r={};e.name&&(r.name=e.name),e.forEachNode((function(e){r.nodes||(r.nodes=[]);var s=t.addNode(e);r.nodes.push(s)})),this.gltf.scenes.push(r)},e.prototype.addNode=function(e){var t=this;this.gltf.nodes||(this.gltf.nodes=[]);var n={};e.name&&(n.name=e.name);var o=e.translation;a.vec3.exactEquals(o,i.vec3f64.ZEROS)||(n.translation=i.vec3f64.clone(o));var u=e.rotation;r.quat.exactEquals(u,s.quatf64.IDENTITY)||(n.rotation=s.quatf64.clone(u));var l=e.scale;a.vec3.exactEquals(l,i.vec3f64.ONES)||(n.scale=i.vec3f64.clone(l)),e.mesh&&e.mesh.vertexAttributes.position?n.mesh=this.addMesh(e.mesh):e.forEachNode((function(e){n.children||(n.children=[]);var r=t.addNode(e);n.children.push(r)}));var f=this.gltf.nodes.length;return this.gltf.nodes.push(n),f},e.prototype.addMesh=function(e){this.gltf.meshes||(this.gltf.meshes=[]);var t,r={primitives:[]},s=this.gltf.extras.options.bufferOutputType===f.BufferOutputType.GLB;t=s?this.gltf.extras.binChunkBuffer:new u.Buffer(this.gltf);var a=e.clone();this.params.origin||(this.params.origin=l.computeOrigin(a)),a.rotate(-90,0,0,{origin:this.params.origin}),l.smoothNormalsMesh(a);var i=o.ungeoreference(a.vertexAttributes,this.params.origin,{geographic:this.params.geographic,unit:"meters"});a.vertexAttributes.position=i.position,a.vertexAttributes.normal=i.normal,a.vertexAttributes.tangent=i.tangent;var n,h,c,p,d=t.addBufferView(f.ComponentType.FLOAT,f.DataType.VEC3,f.TargetBuffer.ARRAY_BUFFER);a.vertexAttributes.normal&&(n=t.addBufferView(f.ComponentType.FLOAT,f.DataType.VEC3,f.TargetBuffer.ARRAY_BUFFER)),a.vertexAttributes.uv&&(h=t.addBufferView(f.ComponentType.FLOAT,f.DataType.VEC2,f.TargetBuffer.ARRAY_BUFFER)),a.vertexAttributes.tangent&&(c=t.addBufferView(f.ComponentType.FLOAT,f.DataType.VEC4,f.TargetBuffer.ARRAY_BUFFER)),a.vertexAttributes.color&&(p=t.addBufferView(f.ComponentType.UNSIGNED_BYTE,f.DataType.VEC4,f.TargetBuffer.ARRAY_BUFFER)),d.startAccessor("POSITION"),n&&n.startAccessor("NORMAL"),h&&h.startAccessor("TEXCOORD_0"),c&&c.startAccessor("TANGENT"),p&&p.startAccessor("COLOR_0");for(var g=a.vertexAttributes.position.length/3,m=0;m<g;++m)d.push(a.vertexAttributes.position[3*m+0]),d.push(a.vertexAttributes.position[3*m+1]),d.push(a.vertexAttributes.position[3*m+2]),n&&(n.push(a.vertexAttributes.normal[3*m+0]),n.push(a.vertexAttributes.normal[3*m+1]),n.push(a.vertexAttributes.normal[3*m+2])),h&&(h.push(a.vertexAttributes.uv[2*m+0]),h.push(a.vertexAttributes.uv[2*m+1])),c&&(c.push(a.vertexAttributes.tangent[4*m+0]),c.push(a.vertexAttributes.tangent[4*m+1]),c.push(a.vertexAttributes.tangent[4*m+2]),c.push(a.vertexAttributes.tangent[4*m+3])),p&&(p.push(a.vertexAttributes.color[4*m+0]),p.push(a.vertexAttributes.color[4*m+1]),p.push(a.vertexAttributes.color[4*m+2]),p.push(a.vertexAttributes.color[4*m+3]));var v,x,T,A,b,y=d.endAccessor(),R=this.addAccessor(d.index,y);if(n){var O=n.endAccessor();v=this.addAccessor(n.index,O)}if(h){var B=h.endAccessor();x=this.addAccessor(h.index,B)}if(c){var E=c.endAccessor();T=this.addAccessor(c.index,E)}if(p){var M=p.endAccessor();A=this.addAccessor(p.index,M)}a.components&&a.components.length>0&&a.components[0].faces?(b=t.addBufferView(f.ComponentType.UNSIGNED_INT,f.DataType.SCALAR,f.TargetBuffer.ELEMENT_ARRAY_BUFFER),this.addMeshVertexIndexed(b,a.components,r,R,v,x,T,A)):this.addMeshVertexNonIndexed(a.components,r,R,v,x,T,A),d.finalize(),n&&n.finalize(),h&&h.finalize(),c&&c.finalize(),b&&b.finalize(),p&&p.finalize(),s||t.finalize();var N=this.gltf.meshes.length;return this.gltf.meshes.push(r),N},e.prototype.addMaterial=function(e){if(null!==e){var t=this.materialMap.indexOf(e);if(-1!==t)return t;this.gltf.materials||(this.gltf.materials=[]);var r={};switch(e.alphaMode){case"mask":r.alphaMode=f.AlphaMode.MASK;break;case"auto":case"blend":r.alphaMode=f.AlphaMode.BLEND}.5!==e.alphaCutoff&&(r.alphaCutoff=e.alphaCutoff),e.doubleSided&&(r.doubleSided=e.doubleSided),r.pbrMetallicRoughness={};var s=function(e){return Math.pow(e,2.1)},a=function(e){var t=e.toRgba();return t[0]=s(t[0]/255),t[1]=s(t[1]/255),t[2]=s(t[2]/255),t};if(e.color&&(r.pbrMetallicRoughness.baseColorFactor=a(e.color)),e.colorTexture&&(r.pbrMetallicRoughness.baseColorTexture={index:this.addTexture(e.colorTexture)}),e.normalTexture&&(r.normalTexture={index:this.addTexture(e.normalTexture)}),e instanceof n){if(e.emissiveTexture&&(r.emissiveTexture={index:this.addTexture(e.emissiveTexture)}),e.emissiveColor){var i=a(e.emissiveColor);r.emissiveFactor=[i[0],i[1],i[2]]}e.occlusionTexture&&(r.occlusionTexture={index:this.addTexture(e.occlusionTexture)}),e.metallicRoughnessTexture&&(r.pbrMetallicRoughness.metallicRoughnessTexture={index:this.addTexture(e.metallicRoughnessTexture)}),r.pbrMetallicRoughness.metallicFactor=e.metallic,r.pbrMetallicRoughness.roughnessFactor=e.roughness}else r.pbrMetallicRoughness.metallicFactor=1,r.pbrMetallicRoughness.roughnessFactor=1;var o=this.gltf.materials.length;return this.gltf.materials.push(r),this.materialMap.push(e),o}},e.prototype.addTexture=function(e){this.gltf.textures||(this.gltf.textures=[]);var t={sampler:this.addSampler(e),source:this.addImage(e)},r=this.gltf.textures.length;return this.gltf.textures.push(t),r},e.prototype.addImage=function(e){this.gltf.images||(this.gltf.images=[]);var t={};if(e.url)t.uri=e.url;else{t.extras=e.data;for(var r=0;r<this.gltf.images.length;++r)if(e.data===this.gltf.images[r].extras)return r;switch(this.gltf.extras.options.imageOutputType){case f.ImageOutputType.GLB:var s=this.gltf.extras.binChunkBuffer.addBufferView(f.ComponentType.UNSIGNED_BYTE,f.DataType.SCALAR);s.writeAsync(h.imageToArrayBuffer(e.data)).then((function(){s.finalize()})),t.bufferView=s.index,t.mimeType="image/png";break;case f.ImageOutputType.DataURI:t.uri=h.imageToDataURI(e.data);break;default:this.gltf.extras.promises.push(h.imageToArrayBuffer(e.data).then((function(e){t.uri=e})))}}var a=this.gltf.images.length;return this.gltf.images.push(t),a},e.prototype.addSampler=function(e){this.gltf.samplers||(this.gltf.samplers=[]);var t=10497,r=10497;if("string"==typeof e.wrap)switch(e.wrap){case"clamp":t=33071,r=33071;break;case"mirror":t=33648,r=33648}else{switch(e.wrap.vertical){case"clamp":r=33071;break;case"mirror":r=33648}switch(e.wrap.horizontal){case"clamp":t=33071;break;case"mirror":t=33648}}for(var s={wrapS:t,wrapT:r},a=0;a<this.gltf.samplers.length;++a)if(JSON.stringify(s)===JSON.stringify(this.gltf.samplers[a]))return a;var i=this.gltf.samplers.length;return this.gltf.samplers.push(s),i},e.prototype.addAccessor=function(e,t){this.gltf.accessors||(this.gltf.accessors=[]);var r={bufferView:e,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type,min:t.min,max:t.max,name:t.name};t.normalized&&(r.normalized=!0);var s=this.gltf.accessors.length;return this.gltf.accessors.push(r),s},e.prototype.addMeshVertexIndexed=function(e,t,r,s,a,i,n,o){for(var u=0,l=t;u<l.length;u++){var f=l[u];e.startAccessor("INDICES");for(var h=0;h<f.faces.length;++h)e.push(f.faces[h]);var c=e.endAccessor(),p={attributes:{POSITION:s},indices:this.addAccessor(e.index,c),material:this.addMaterial(f.material)};a&&"flat"!==f.shading&&(p.attributes.NORMAL=a),i&&(p.attributes.TEXCOORD_0=i),n&&"flat"!==f.shading&&(p.attributes.TANGENT=n),o&&(p.attributes.COLOR_0=o),r.primitives.push(p)}},e.prototype.addMeshVertexNonIndexed=function(e,t,r,s,a,i,n){var o={attributes:{POSITION:r}};s&&(o.attributes.NORMAL=s),a&&(o.attributes.TEXCOORD_0=a),i&&(o.attributes.TANGENT=i),n&&(o.attributes.COLOR_0=n),e&&(o.material=this.addMaterial(e[0].material)),t.primitives.push(o)},e}();t.GLTF=c}));