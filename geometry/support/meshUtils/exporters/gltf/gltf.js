/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../../../core/maybe","../../../../../chunks/quat","../../../../../chunks/quatf64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../MeshMaterialMetallicRoughness","../../georeference","./buffer","./geometry","./types","./imageutils"],(function(e,t,s,r,i,a,n,o,u,c,l,h){"use strict";let f=function(){function e(e,t,s){this.params={},this.materialMap=new Array,this.gltf={asset:{version:"2.0",copyright:e.copyright,generator:e.generator},extras:{options:t,binChunkBuffer:null,promises:[]}},s&&(this.params=s),this.addScenes(e)}var f=e.prototype;return f.addScenes=function(e){this.gltf.scene=e.defaultScene;const t=this.gltf.extras.options.bufferOutputType===l.BufferOutputType.GLB||this.gltf.extras.options.imageOutputType===l.ImageOutputType.GLB;t&&(this.gltf.extras.binChunkBuffer=new u.Buffer(this.gltf)),e.forEachScene((e=>{this.addScene(e)})),t&&this.gltf.extras.binChunkBuffer.finalize()},f.addScene=function(e){this.gltf.scenes||(this.gltf.scenes=[]);const t={};e.name&&(t.name=e.name),e.forEachNode((e=>{t.nodes||(t.nodes=[]);const s=this.addNode(e);t.nodes.push(s)})),this.gltf.scenes.push(t)},f.addNode=function(e){this.gltf.nodes||(this.gltf.nodes=[]);const t={};e.name&&(t.name=e.name);const n=e.translation;i.exactEquals(n,a.ZEROS)||(t.translation=a.clone(n));const o=e.rotation;s.exactEquals(o,r.IDENTITY)||(t.rotation=r.clone(o));const u=e.scale;i.exactEquals(u,a.ONES)||(t.scale=a.clone(u)),e.mesh&&e.mesh.vertexAttributes.position?t.mesh=this.addMesh(e.mesh):e.forEachNode((e=>{t.children||(t.children=[]);const s=this.addNode(e);t.children.push(s)}));const c=this.gltf.nodes.length;return this.gltf.nodes.push(t),c},f.addMesh=function(e){this.gltf.meshes||(this.gltf.meshes=[]);const s={primitives:[]},r=this.gltf.extras.options.bufferOutputType===l.BufferOutputType.GLB;let i;i=r?this.gltf.extras.binChunkBuffer:new u.Buffer(this.gltf);const a=e.clone();this.params.origin||(this.params.origin=c.computeOrigin(a)),a.rotate(-90,0,0,{origin:this.params.origin}),c.smoothNormalsMesh(a);const n=o.ungeoreferenceByTransform(a.vertexAttributes,a.transform,this.params.origin,{geographic:this.params.geographic,unit:"meters"});a.vertexAttributes.position=n.position,a.vertexAttributes.normal=n.normal,a.vertexAttributes.tangent=n.tangent;const h=i.addBufferView(5126,l.AttributeType.VEC3,l.TargetBuffer.ARRAY_BUFFER);let f,d,p,g;a.vertexAttributes.normal&&(f=i.addBufferView(5126,l.AttributeType.VEC3,l.TargetBuffer.ARRAY_BUFFER)),a.vertexAttributes.uv&&(d=i.addBufferView(5126,l.AttributeType.VEC2,l.TargetBuffer.ARRAY_BUFFER)),a.vertexAttributes.tangent&&(p=i.addBufferView(5126,l.AttributeType.VEC4,l.TargetBuffer.ARRAY_BUFFER)),a.vertexAttributes.color&&(g=i.addBufferView(5121,l.AttributeType.VEC4,l.TargetBuffer.ARRAY_BUFFER)),h.startAccessor("POSITION"),f&&f.startAccessor("NORMAL"),d&&d.startAccessor("TEXCOORD_0"),p&&p.startAccessor("TANGENT"),g&&g.startAccessor("COLOR_0");const m=a.vertexAttributes.position.length/3;for(let o=0;o<m;++o)h.push(a.vertexAttributes.position[3*o+0]),h.push(a.vertexAttributes.position[3*o+1]),h.push(a.vertexAttributes.position[3*o+2]),f&&t.isSome(a.vertexAttributes.normal)&&(f.push(a.vertexAttributes.normal[3*o+0]),f.push(a.vertexAttributes.normal[3*o+1]),f.push(a.vertexAttributes.normal[3*o+2])),d&&t.isSome(a.vertexAttributes.uv)&&(d.push(a.vertexAttributes.uv[2*o+0]),d.push(a.vertexAttributes.uv[2*o+1])),p&&t.isSome(a.vertexAttributes.tangent)&&(p.push(a.vertexAttributes.tangent[4*o+0]),p.push(a.vertexAttributes.tangent[4*o+1]),p.push(a.vertexAttributes.tangent[4*o+2]),p.push(a.vertexAttributes.tangent[4*o+3])),g&&t.isSome(a.vertexAttributes.color)&&(g.push(a.vertexAttributes.color[4*o+0]),g.push(a.vertexAttributes.color[4*o+1]),g.push(a.vertexAttributes.color[4*o+2]),g.push(a.vertexAttributes.color[4*o+3]));const x=h.endAccessor(),A=this.addAccessor(h.index,x);let b,T,v,R,O;if(f){const e=f.endAccessor();b=this.addAccessor(f.index,e)}if(d){const e=d.endAccessor();T=this.addAccessor(d.index,e)}if(p){const e=p.endAccessor();v=this.addAccessor(p.index,e)}if(g){const e=g.endAccessor();R=this.addAccessor(g.index,e)}a.components&&a.components.length>0&&a.components[0].faces?(O=i.addBufferView(5125,l.AttributeType.SCALAR,l.TargetBuffer.ELEMENT_ARRAY_BUFFER),this.addMeshVertexIndexed(O,a.components,s,A,b,T,v,R)):this.addMeshVertexNonIndexed(a.components,s,A,b,T,v,R),h.finalize(),f&&f.finalize(),d&&d.finalize(),p&&p.finalize(),O&&O.finalize(),g&&g.finalize(),r||i.finalize();const y=this.gltf.meshes.length;return this.gltf.meshes.push(s),y},f.addMaterial=function(e){if(null===e)return;const s=this.materialMap.indexOf(e);if(-1!==s)return s;this.gltf.materials||(this.gltf.materials=[]);const r={};switch(e.alphaMode){case"mask":r.alphaMode=l.AlphaMode.MASK;break;case"auto":case"blend":r.alphaMode=l.AlphaMode.BLEND}.5!==e.alphaCutoff&&(r.alphaCutoff=e.alphaCutoff),e.doubleSided&&(r.doubleSided=e.doubleSided),r.pbrMetallicRoughness={};const i=e=>e**2.1,a=e=>{const t=e.toRgba();return t[0]=i(t[0]/255),t[1]=i(t[1]/255),t[2]=i(t[2]/255),t};if(t.isSome(e.color)&&(r.pbrMetallicRoughness.baseColorFactor=a(e.color)),t.isSome(e.colorTexture)&&(r.pbrMetallicRoughness.baseColorTexture={index:this.addTexture(e.colorTexture)}),t.isSome(e.normalTexture)&&(r.normalTexture={index:this.addTexture(e.normalTexture)}),e instanceof n){if(t.isSome(e.emissiveTexture)&&(r.emissiveTexture={index:this.addTexture(e.emissiveTexture)}),t.isSome(e.emissiveColor)){const t=a(e.emissiveColor);r.emissiveFactor=[t[0],t[1],t[2]]}t.isSome(e.occlusionTexture)&&(r.occlusionTexture={index:this.addTexture(e.occlusionTexture)}),t.isSome(e.metallicRoughnessTexture)&&(r.pbrMetallicRoughness.metallicRoughnessTexture={index:this.addTexture(e.metallicRoughnessTexture)}),r.pbrMetallicRoughness.metallicFactor=e.metallic,r.pbrMetallicRoughness.roughnessFactor=e.roughness}else r.pbrMetallicRoughness.metallicFactor=1,r.pbrMetallicRoughness.roughnessFactor=1;const o=this.gltf.materials.length;return this.gltf.materials.push(r),this.materialMap.push(e),o},f.addTexture=function(e){this.gltf.textures||(this.gltf.textures=[]);const t={sampler:this.addSampler(e),source:this.addImage(e)},s=this.gltf.textures.length;return this.gltf.textures.push(t),s},f.addImage=function(e){this.gltf.images||(this.gltf.images=[]);const t={};if(e.url)t.uri=e.url;else{t.extras=e.data;for(let t=0;t<this.gltf.images.length;++t)if(e.data===this.gltf.images[t].extras)return t;switch(this.gltf.extras.options.imageOutputType){case l.ImageOutputType.GLB:{const s=this.gltf.extras.binChunkBuffer.addBufferView(5121,l.AttributeType.SCALAR);s.writeAsync(h.imageToArrayBuffer(e.data)).then((()=>{s.finalize()})),t.bufferView=s.index,t.mimeType="image/png";break}case l.ImageOutputType.DataURI:t.uri=h.imageToDataURI(e.data);break;default:this.gltf.extras.promises.push(h.imageToArrayBuffer(e.data).then((e=>{t.uri=e})))}}const s=this.gltf.images.length;return this.gltf.images.push(t),s},f.addSampler=function(e){this.gltf.samplers||(this.gltf.samplers=[]);let t=10497,s=10497;if("string"==typeof e.wrap)switch(e.wrap){case"clamp":t=33071,s=33071;break;case"mirror":t=33648,s=33648}else{switch(e.wrap.vertical){case"clamp":s=33071;break;case"mirror":s=33648}switch(e.wrap.horizontal){case"clamp":t=33071;break;case"mirror":t=33648}}const r={wrapS:t,wrapT:s};for(let a=0;a<this.gltf.samplers.length;++a)if(JSON.stringify(r)===JSON.stringify(this.gltf.samplers[a]))return a;const i=this.gltf.samplers.length;return this.gltf.samplers.push(r),i},f.addAccessor=function(e,t){this.gltf.accessors||(this.gltf.accessors=[]);const s={bufferView:e,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type,min:t.min,max:t.max,name:t.name};t.normalized&&(s.normalized=!0);const r=this.gltf.accessors.length;return this.gltf.accessors.push(s),r},f.addMeshVertexIndexed=function(e,t,s,r,i,a,n,o){for(const u of t){e.startAccessor("INDICES");for(let s=0;s<u.faces.length;++s)e.push(u.faces[s]);const t=e.endAccessor(),c={attributes:{POSITION:r},indices:this.addAccessor(e.index,t),material:this.addMaterial(u.material)};i&&"flat"!==u.shading&&(c.attributes.NORMAL=i),a&&(c.attributes.TEXCOORD_0=a),n&&"flat"!==u.shading&&(c.attributes.TANGENT=n),o&&(c.attributes.COLOR_0=o),s.primitives.push(c)}},f.addMeshVertexNonIndexed=function(e,t,s,r,i,a,n){const o={attributes:{POSITION:s}};r&&(o.attributes.NORMAL=r),i&&(o.attributes.TEXCOORD_0=i),a&&(o.attributes.TANGENT=a),n&&(o.attributes.COLOR_0=n),e&&(o.material=this.addMaterial(e[0].material)),t.primitives.push(o)},e}();e.GLTF=f,Object.defineProperty(e,"__esModule",{value:!0})}));
