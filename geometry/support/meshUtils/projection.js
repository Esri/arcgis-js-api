/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../projection","../../projectionEllipsoid","../spatialReferenceUtils","../webMercatorUtils","../buffer/BufferView","../../../chunks/vec32"],(function(r,e,f,t,o,n,a,c,i,u,m,s,y,V){"use strict";const p=e.getLogger("esri.geometry.support.meshUtils.normalProjection");function l(r,e,f,t,o){return C(t)?(E(0,y.BufferViewVec3f.fromTypedArray(r),y.BufferViewVec3f64.fromTypedArray(e),y.BufferViewVec3f64.fromTypedArray(f),t,y.BufferViewVec3f.fromTypedArray(o)),o):(p.error("Cannot convert spatial reference to PCPF"),o)}function T(r,e,f,t,o){return C(t)?(E(1,y.BufferViewVec3f.fromTypedArray(r),y.BufferViewVec3f64.fromTypedArray(e),y.BufferViewVec3f64.fromTypedArray(f),t,y.BufferViewVec3f.fromTypedArray(o)),o):(p.error("Cannot convert to spatial reference from PCPF"),o)}function P(r,e,f){return i.projectBuffer(r,e,0,f,u.getSphericalPCPF(e),0,r.length/3),f}function B(r,e,f){return i.projectBuffer(r,u.getSphericalPCPF(f),0,e,f,0,r.length/3),e}function d(r,e,t){if(f.isNone(r))return e;const o=y.BufferViewVec3f64.fromTypedArray(r),n=y.BufferViewVec3f64.fromTypedArray(e);return V.transformMat4(n,o,t),e}function A(r,e,o){if(f.isNone(r))return e;t.normalFromMat4(S,o);const n=y.BufferViewVec3f.fromTypedArray(r),a=y.BufferViewVec3f.fromTypedArray(e);return V.transformMat3(a,n,S),t.isOrthoNormal(S)||V.normalize(a,a),e}function w(r,e,o){if(f.isNone(r))return e;t.normalFromMat4(S,o);const n=y.BufferViewVec3f.fromTypedArray(r,4*Float32Array.BYTES_PER_ELEMENT),a=y.BufferViewVec3f.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT);if(V.transformMat3(a,n,S),t.isOrthoNormal(S)||V.normalize(a,a),r!==e)for(let f=3;f<r.length;f+=4)e[f]=r[f];return e}function g(r,e,f,t,o){if(!C(t))return p.error("Cannot convert spatial reference to PCPF"),o;E(0,y.BufferViewVec3f.fromTypedArray(r,4*Float32Array.BYTES_PER_ELEMENT),y.BufferViewVec3f64.fromTypedArray(e),y.BufferViewVec3f64.fromTypedArray(f),t,y.BufferViewVec3f.fromTypedArray(o,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<r.length;n+=4)o[n]=r[n];return o}function F(r,e,f,t,o){if(!C(t))return p.error("Cannot convert to spatial reference from PCPF"),o;E(1,y.BufferViewVec3f.fromTypedArray(r,16),y.BufferViewVec3f64.fromTypedArray(e),y.BufferViewVec3f64.fromTypedArray(f),t,y.BufferViewVec3f.fromTypedArray(o,16));for(let n=3;n<r.length;n+=4)o[n]=r[n];return o}function E(r,e,f,o,n,c){if(!e)return;const m=f.count,y=u.getSphericalPCPF(n);if(M(n))for(let u=0;u<m;u++)o.getVec(u,j),e.getVec(u,N),i.computeLinearTransformation(y,j,_,y),t.fromMat4(S,_),1===r&&t.transpose(S,S),a.transformMat3(N,N,S),c.setVec(u,N);else for(let u=0;u<m;u++){o.getVec(u,j),e.getVec(u,N),i.computeLinearTransformation(y,j,_,y),t.fromMat4(S,_);const n=s.y2lat(f.get(u,1));let m=Math.cos(n);0===r&&(m=1/m),S[0]*=m,S[1]*=m,S[2]*=m,S[3]*=m,S[4]*=m,S[5]*=m,1===r&&t.transpose(S,S),a.transformMat3(N,N,S),a.normalize(N,N),c.setVec(u,N)}return c}function C(r){return M(r)||h(r)}function M(r){return r.isWGS84||m.isCGCS2000(r)||m.isMars(r)||m.isMoon(r)}function h(r){return r.isWebMercator}const j=c.create(),N=c.create(),_=n.create(),S=o.create();r.projectFromPCPF=B,r.projectNormalFromPCPF=T,r.projectNormalToPCPF=l,r.projectTangentFromPCPF=F,r.projectTangentToPCPF=g,r.projectToPCPF=P,r.transformNormal=A,r.transformPosition=d,r.transformTangent=w,Object.defineProperty(r,"__esModule",{value:!0})}));
