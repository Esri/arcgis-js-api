/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/Logger","../spatialReferenceUtils","../../../chunks/vec3f64","../../../chunks/vec3","../../projectionEllipsoid","../../projection","../../../chunks/mat3f64","../../../chunks/mat4f64","../../../chunks/mat3","../../../views/3d/support/buffer/BufferView"],(function(e,r,f,t,o,n,c,a,i,u,s){"use strict";const p=r.getLogger("esri.geometry.support.meshUtils.normalProjection");function l(e,r,t,a,i,s){if(!r)return;const p=i.isWGS84||f.isCGCS2000(i)||f.isMars(i)||f.isMoon(i),l=t.count;if(p)for(let f=0;f<l;f++){a.getVec(f,m),r.getVec(f,V);const t=n.getSphericalPCPF(i);c.computeLinearTransformation(t,m,y,t),u.fromMat4(E,y),1===e&&u.transpose(E,E),o.transformMat3(V,V,E),s.setVec(f,V)}else for(let f=0;f<l;f++){a.getVec(f,m),r.getVec(f,V),c.computeLinearTransformation(n.SphericalECEFSpatialReference,m,y,n.SphericalECEFSpatialReference),u.fromMat4(E,y);const i=c.webMercator.y2lat(t.get(f,1));let p=Math.cos(i);0===e&&(p=1/p),E[0]*=p,E[1]*=p,E[2]*=p,E[3]*=p,E[4]*=p,E[5]*=p,1===e&&u.transpose(E,E),o.transformMat3(V,V,E),o.normalize(V,V),s.setVec(f,V)}return s}const m=t.create(),V=t.create(),y=i.create(),E=a.create();e.projectFromECEF=function(e,r,f){return c.projectBuffer(e,n.getSphericalPCPF(f),0,r,f,0,e.length/3),r},e.projectNormalFromECEF=function(e,r,f,t,o){return t.isWebMercator||t.isWGS84?(l(1,s.BufferViewVec3f.fromTypedArray(e),s.BufferViewVec3f64.fromTypedArray(r),s.BufferViewVec3f64.fromTypedArray(f),t,s.BufferViewVec3f.fromTypedArray(o)),o):(p.error("Cannot convert to PCS spatial reference buffer from ECEF"),o)},e.projectNormalToECEF=function(e,r,f,t,o){return t.isWebMercator||t.isWGS84?(l(0,s.BufferViewVec3f.fromTypedArray(e),s.BufferViewVec3f64.fromTypedArray(r),s.BufferViewVec3f64.fromTypedArray(f),t,s.BufferViewVec3f.fromTypedArray(o)),o):(p.error("Cannot convert PCS spatial reference buffer to ECEF"),o)},e.projectTangentFromECEF=function(e,r,f,t,o){if(!t.isWebMercator&&!t.isWGS84)return p.error("Cannot convert to PCS spatial reference buffer from ECEF"),o;l(1,s.BufferViewVec3f.fromTypedArray(e,16),s.BufferViewVec3f64.fromTypedArray(r),s.BufferViewVec3f64.fromTypedArray(f),t,s.BufferViewVec3f.fromTypedArray(o,16));for(let r=3;r<e.length;r+=4)o[r]=e[r];return o},e.projectTangentToECEF=function(e,r,f,t,o){if(!t.isWebMercator&&!t.isWGS84)return p.error("Cannot convert PCS spatial reference buffer to ECEF"),o;l(0,s.BufferViewVec3f.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),s.BufferViewVec3f64.fromTypedArray(r),s.BufferViewVec3f64.fromTypedArray(f),t,s.BufferViewVec3f.fromTypedArray(o,4*Float32Array.BYTES_PER_ELEMENT));for(let r=3;r<e.length;r+=4)o[r]=e[r];return o},e.projectToECEF=function(e,r,f){return c.projectBuffer(e,r,0,f,n.getSphericalPCPF(r),0,e.length/3),f},e.transformBufferInPlace=function(e,r,f=!1){if(e)for(let t=0;t<e.length;t+=3){for(let r=0;r<3;r++)m[r]=e[t+r];o.transformMat4(m,m,r),f&&o.normalize(m,m);for(let r=0;r<3;r++)e[t+r]=m[r]}},Object.defineProperty(e,"__esModule",{value:!0})}));
