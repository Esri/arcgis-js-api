/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Color","../../../request","../../../core/MapUtils","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec32","../../../chunks/vec42","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/webgl-engine/lib/geometryDataUtils","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../views/webgl/enums","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec22"],(function(e,t,r,n,o,i,s,a,u,l,c,f,m,p,g,d,w,h,x,y,v,M,T,S,V,b,B,A){"use strict";function C(e,t,r){return R.apply(this,arguments)}function R(){return(R=t._asyncToGenerator((function*(e,t,r){const n=new y.DefaultLoadingContext(E(r)),o=(yield v.load(n,t,r,!0)).model,s=o.lods.shift(),a=new Map,u=new Map;o.textures.forEach(((e,t)=>a.set(t,k(e)))),o.materials.forEach(((e,t)=>u.set(t,L(e,a))));const l=O(s);for(const i of l.parts)I(l,i,u);const{position:c,normal:f,tangent:m,color:g,texCoord0:d}=l.vertexAttributes,w={position:c.typedBuffer,normal:i.isSome(f)?f.typedBuffer:null,tangent:i.isSome(m)?m.typedBuffer:null,uv:i.isSome(d)?d.typedBuffer:null,color:i.isSome(g)?g.typedBuffer:null},h=x.georeferenceByTransform(w,e,r);return{transform:h.transform,components:l.components,spatialReference:e.spatialReference,vertexAttributes:new p.MeshVertexAttributes({position:h.vertexAttributes.position,normal:h.vertexAttributes.normal,tangent:h.vertexAttributes.tangent,color:w.color,uv:w.uv})}}))).apply(this,arguments)}function E(e){return null!=e&&e.resolveFile?{busy:!1,request:(r=t._asyncToGenerator((function*(t,r,o){const s=e.resolveFile(t),a="image"===r?"image":"binary"===r?"array-buffer":"json";return(yield n(s,{responseType:a,signal:i.isSome(o)?o.signal:null})).data})),function(e,t,n){return r.apply(this,arguments)})}:null;var r}function F(e,t){if(i.isNone(e))return"-";const r=e.typedBuffer;return`${o.getOrCreateMapValue(t,r.buffer,(()=>t.size))}/${r.byteOffset}/${r.byteLength}`}function _(e){return i.isSome(e)?e.toString():"-"}function O(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},n=new Map,i=new Map,s=[];for(const a of e.parts){const{attributes:{position:e,normal:u,color:l,tangent:c,texCoord0:f}}=a,m=`\n      ${F(e,n)}/\n      ${F(u,n)}/\n      ${F(l,n)}/\n      ${F(c,n)}/\n      ${F(f,n)}/\n      ${_(a.transform)}\n    `;let p=!1;const g=o.getOrCreateMapValue(i,m,(()=>(p=!0,{start:t,length:e.count})));p&&(t+=e.count),u&&(r.normal=!0),l&&(r.color=!0),c&&(r.tangent=!0),f&&(r.texCoord0=!0),s.push({gltf:a,writeVertices:p,region:g})}return{vertexAttributes:{position:h.createBuffer(g.BufferViewVec3f64,t),normal:r.normal?h.createBuffer(g.BufferViewVec3f,t):null,tangent:r.tangent?h.createBuffer(g.BufferViewVec4f,t):null,color:r.color?h.createBuffer(g.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?h.createBuffer(g.BufferViewVec2f,t):null},parts:s,components:[]}}function k(e){return new m({data:e.data,wrap:N(e.parameters.wrap)})}function L(e,t){const n=new r(q(e.color,e.opacity)),o=e.emissiveFactor?new r(z(e.emissiveFactor)):null;return new f({color:n,colorTexture:i.unwrap(i.applySome(e.textureColor,(e=>t.get(e)))),normalTexture:i.unwrap(i.applySome(e.textureNormal,(e=>t.get(e)))),emissiveColor:o,emissiveTexture:i.unwrap(i.applySome(e.textureEmissive,(e=>t.get(e)))),occlusionTexture:i.unwrap(i.applySome(e.textureOcclusion,(e=>t.get(e)))),alphaMode:$(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:i.unwrap(i.applySome(e.textureMetallicRoughness,(e=>t.get(e))))})}function I(e,t,r){t.writeVertices&&P(e,t);const n=t.gltf,o=G(n.indices||n.attributes.position.count,n.primitiveType),i=t.region.start;if(i)for(let s=0;s<o.length;s++)o[s]+=i;e.components.push(new c({faces:o,material:r.get(n.material),trustSourceNormals:!0}))}function P(e,t){const{position:r,normal:n,tangent:o,color:u,texCoord0:l}=e.vertexAttributes,c=t.region.start,{attributes:f,transform:m}=t.gltf,p=f.position.count;if(d.transformMat4(r.slice(c,p),f.position,m),i.isSome(f.normal)&&i.isSome(n)){const e=s.normalFromMat4(a.create(),m);d.transformMat3(n.slice(c,p),f.normal,e)}else i.isSome(n)&&b.fill(n,0,0,1,{dstIndex:c,count:p});if(i.isSome(f.tangent)&&i.isSome(o)){const e=s.normalFromMat4(a.create(),m);w.transformMat3(o.slice(c,p),f.tangent,e)}else i.isSome(o)&&B.fill(o,0,0,1,1,{dstIndex:c,count:p});if(i.isSome(f.texCoord0)&&i.isSome(l)?A.normalizeIntegerBuffer(l.slice(c,p),f.texCoord0):i.isSome(l)&&A.fill(l,0,0,{dstIndex:c,count:p}),i.isSome(f.color)&&i.isSome(u)){const e=f.color,t=u.slice(c,p);if(4===e.elementCount)e instanceof g.BufferViewVec4f?w.scale(t,e,255):e instanceof g.BufferViewVec4u8?B.copy(t,e):e instanceof g.BufferViewVec4u16&&w.shiftRight(t,e,8);else{B.fill(t,255,255,255,255);const r=g.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof g.BufferViewVec3f?d.scale(r,e,255):e instanceof g.BufferViewVec3u8?b.copy(r,e):e instanceof g.BufferViewVec3u16&&d.shiftRight(r,e,8)}}else i.isSome(u)&&B.fill(u.slice(c,p),255,255,255,255)}function G(e,t){switch(t){case V.PrimitiveType.TRIANGLES:return M.trianglesToTriangles(e,T.generateIndexArray);case V.PrimitiveType.TRIANGLE_STRIP:return M.triangleStripToTriangles(e);case V.PrimitiveType.TRIANGLE_FAN:return M.triangleFanToTriangles(e)}}function $(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function N(e){return{horizontal:D(e.s),vertical:D(e.t)}}function D(e){switch(e){case V.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case V.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case V.TextureWrapMode.REPEAT:return"repeat"}}function U(e){return e**(1/S.COLOR_GAMMA)*255}function q(e,t){return l.fromValues(U(e[0]),U(e[1]),U(e[2]),t)}function z(e){return u.fromValues(U(e[0]),U(e[1]),U(e[2]))}e.loadGLTFMesh=C,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
