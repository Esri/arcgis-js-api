/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Color","../../../request","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec32","../../../chunks/vec42","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/webgl-engine/lib/geometryDataUtils","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec22"],(function(e,t,r,n,o,s,i,a,u,l,c,f,m,p,d,g,w,h,x,y,b,v,B,S,V,M){"use strict";function T(e,t,r){return C.apply(this,arguments)}function C(){return(C=t._asyncToGenerator((function*(e,t,r){const n=new x.DefaultLoadingContext(A(r)),s=(yield y.load(n,t,r,!0)).model,i=s.lods.shift(),a=new Map,u=new Map;s.textures.forEach(((e,t)=>a.set(t,k(e)))),s.materials.forEach(((e,t)=>u.set(t,R(e,a))));const l=F(i);for(const o of i.parts)I(l,o,u);const{position:c,normal:f,tangent:p,color:d,texCoord0:g}=l.vertexAttributes,w={position:c.typedBuffer,normal:o.isSome(f)?f.typedBuffer:null,tangent:o.isSome(p)?p.typedBuffer:null,uv:o.isSome(g)?g.typedBuffer:null,color:o.isSome(d)?d.typedBuffer:null},b=h.georeferenceByTransform(w,e,r);return{transform:b.transform,components:l.components,spatialReference:e.spatialReference,vertexAttributes:new m.default({position:b.vertexAttributes.position,normal:b.vertexAttributes.normal,tangent:b.vertexAttributes.tangent,color:w.color,uv:w.uv})}}))).apply(this,arguments)}function A(e){return null!=e&&e.resolveFile?{busy:!1,request:(r=t._asyncToGenerator((function*(t,r,s){const i=e.resolveFile(t),a="image"===r?"image":"binary"===r?"array-buffer":"json";return(yield n(i,{responseType:a,signal:o.isSome(s)?s.signal:null})).data})),function(e,t,n){return r.apply(this,arguments)})}:null;var r}function F(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:n,normal:o,color:s,tangent:i,texCoord0:a}}of e.parts)t+=n.count,o&&(r.normal=!0),s&&(r.color=!0),i&&(r.tangent=!0),a&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:w.createBuffer(p.BufferViewVec3f64,t),normal:r.normal?w.createBuffer(p.BufferViewVec3f,t):null,tangent:r.tangent?w.createBuffer(p.BufferViewVec4f,t):null,color:r.color?w.createBuffer(p.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?w.createBuffer(p.BufferViewVec2f,t):null},components:[]}}function k(e){return new f({data:e.data,wrap:L(e.parameters.wrap)})}function R(e,t){const n=new r(G(e.color,e.opacity)),s=e.emissiveFactor?new r(q(e.emissiveFactor)):null;return new c({color:n,colorTexture:o.unwrap(o.applySome(e.textureColor,(e=>t.get(e)))),normalTexture:o.unwrap(o.applySome(e.textureNormal,(e=>t.get(e)))),emissiveColor:s,emissiveTexture:o.unwrap(o.applySome(e.textureEmissive,(e=>t.get(e)))),occlusionTexture:o.unwrap(o.applySome(e.textureOcclusion,(e=>t.get(e)))),alphaMode:O(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:o.unwrap(o.applySome(e.textureMetallicRoughness,(e=>t.get(e))))})}function I(e,t,r){const{position:n,normal:a,tangent:u,color:c,texCoord0:f}=e.vertexAttributes,m=e.writeIndex,w=t.attributes.position.count;if(d.transformMat4(n.slice(m,w),t.attributes.position,t.transform),o.isSome(t.attributes.normal)&&o.isSome(a)){const e=s.normalFromMat4(i.create(),t.transform);d.transformMat3(a.slice(m,w),t.attributes.normal,e)}else o.isSome(a)&&S.fill(a,0,0,1,{dstIndex:m,count:w});if(o.isSome(t.attributes.tangent)&&o.isSome(u)){const e=s.normalFromMat4(i.create(),t.transform);g.transformMat3(u.slice(m,w),t.attributes.tangent,e)}else o.isSome(u)&&V.fill(u,0,0,1,1,{dstIndex:m,count:w});if(o.isSome(t.attributes.texCoord0)&&o.isSome(f)?M.normalizeIntegerBuffer(f.slice(m,w),t.attributes.texCoord0):o.isSome(f)&&M.fill(f,0,0,{dstIndex:m,count:w}),o.isSome(t.attributes.color)&&o.isSome(c)){const e=t.attributes.color,r=c.slice(m,w);if(4===e.elementCount)e instanceof p.BufferViewVec4f?g.scale(r,e,255):e instanceof p.BufferViewVec4u8?V.copy(r,e):e instanceof p.BufferViewVec4u16&&g.shiftRight(r,e,8);else{V.fill(r,255,255,255,255);const t=p.BufferViewVec3u8.fromTypedArray(r.typedBuffer,r.typedBufferStride);e instanceof p.BufferViewVec3f?d.scale(t,e,255):e instanceof p.BufferViewVec3u8?S.copy(t,e):e instanceof p.BufferViewVec3u16&&d.shiftRight(t,e,8)}}else o.isSome(c)&&V.fill(c.slice(m,w),255,255,255,255);const h=_(t.indices||w,t.primitiveType);if(m)for(let o=0;o<h.length;o++)h[o]+=m;e.components.push(new l({faces:h,material:r.get(t.material).clone(),trustSourceNormals:!0})),e.writeIndex+=w}function _(e,t){switch(t){case 4:return b.trianglesToTriangles(e,v.generateIndexArray);case 5:return b.triangleStripToTriangles(e);case 6:return b.triangleFanToTriangles(e)}}function O(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function L(e){return{horizontal:D(e.s),vertical:D(e.t)}}function D(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function E(e){return e**(1/B.COLOR_GAMMA)*255}function G(e,t){return u.fromValues(E(e[0]),E(e[1]),E(e[2]),t)}function q(e){return a.fromValues(E(e[0]),E(e[1]),E(e[2]))}e.loadGLTFMesh=T,Object.defineProperty(e,"__esModule",{value:!0})}));
