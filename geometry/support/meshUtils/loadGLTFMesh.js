/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Color","../../../request","../../../core/MapUtils","../../../core/mathUtils","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec32","../../../chunks/vec42","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/webgl-engine/lib/Indices","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../views/webgl/enums","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec22"],(function(e,t,r,n,o,s,i,a,u,l,c,f,m,p,g,d,T,x,h,w,v,y,M,S,V,b,B,A,C){"use strict";function R(e,t,r){return E.apply(this,arguments)}function E(){return(E=t._asyncToGenerator((function*(e,t,r){const n=new v.DefaultLoadingContext(F(r)),o=(yield y.loadGLTF(n,t,r,!0)).model,s=o.lods.shift(),a=new Map,u=new Map;o.textures.forEach(((e,t)=>a.set(t,k(e)))),o.materials.forEach(((e,t)=>u.set(t,I(e,a))));const l=O(s);for(const i of l.parts)G(l,i,u);const{position:c,normal:f,tangent:m,color:p,texCoord0:d}=l.vertexAttributes,T={position:c.typedBuffer,normal:i.isSome(f)?f.typedBuffer:null,tangent:i.isSome(m)?m.typedBuffer:null,uv:i.isSome(d)?d.typedBuffer:null,color:i.isSome(p)?p.typedBuffer:null},x=w.georeferenceByTransform(T,e,r);return{transform:x.transform,components:l.components,spatialReference:e.spatialReference,vertexAttributes:new g.MeshVertexAttributes({position:x.vertexAttributes.position,normal:x.vertexAttributes.normal,tangent:x.vertexAttributes.tangent,color:T.color,uv:T.uv})}}))).apply(this,arguments)}function F(e){const r=e?.resolveFile;return r?{busy:!1,request:(o=t._asyncToGenerator((function*(e,t,o){const s=r(e),a="image"===t?"image":"binary"===t?"array-buffer":"json";return(yield n(s,{responseType:a,signal:i.isSome(o)?o.signal:null})).data})),function(e,t,r){return o.apply(this,arguments)})}:null;var o}function _(e,t){if(i.isNone(e))return"-";const r=e.typedBuffer;return`${o.getOrCreateMapValue(t,r.buffer,(()=>t.size))}/${r.byteOffset}/${r.byteLength}`}function L(e){return i.isSome(e)?e.toString():"-"}function O(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},n=new Map,s=new Map,i=[];for(const a of e.parts){const{attributes:{position:e,normal:u,color:l,tangent:c,texCoord0:f}}=a,m=`\n      ${_(e,n)}/\n      ${_(u,n)}/\n      ${_(l,n)}/\n      ${_(c,n)}/\n      ${_(f,n)}/\n      ${L(a.transform)}\n    `;let p=!1;const g=o.getOrCreateMapValue(s,m,(()=>(p=!0,{start:t,length:e.count})));p&&(t+=e.count),u&&(r.normal=!0),l&&(r.color=!0),c&&(r.tangent=!0),f&&(r.texCoord0=!0),i.push({gltf:a,writeVertices:p,region:g})}return{vertexAttributes:{position:h.createBuffer(d.BufferViewVec3f64,t),normal:r.normal?h.createBuffer(d.BufferViewVec3f,t):null,tangent:r.tangent?h.createBuffer(d.BufferViewVec4f,t):null,color:r.color?h.createBuffer(d.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?h.createBuffer(d.BufferViewVec2f,t):null},parts:i,components:[]}}function k(e){return new p({data:e.data,wrap:D(e.parameters.wrap)})}function I(e,t){const n=new r(q(e.color,e.opacity)),o=e.emissiveFactor?new r(W(e.emissiveFactor)):null;return new m({color:n,colorTexture:i.unwrap(i.applySome(e.textureColor,(e=>t.get(e)))),normalTexture:i.unwrap(i.applySome(e.textureNormal,(e=>t.get(e)))),emissiveColor:o,emissiveTexture:i.unwrap(i.applySome(e.textureEmissive,(e=>t.get(e)))),occlusionTexture:i.unwrap(i.applySome(e.textureOcclusion,(e=>t.get(e)))),alphaMode:N(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:i.unwrap(i.applySome(e.textureMetallicRoughness,(e=>t.get(e)))),colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform})}function G(e,t,r){t.writeVertices&&P(e,t);const n=t.gltf,o=$(n.indices||n.attributes.position.count,n.primitiveType),s=t.region.start;if(s)for(let i=0;i<o.length;i++)o[i]+=s;e.components.push(new f({faces:o,material:r.get(n.material),trustSourceNormals:!0}))}function P(e,t){const{position:r,normal:n,tangent:o,color:l,texCoord0:c}=e.vertexAttributes,f=t.region.start,{attributes:m,transform:p}=t.gltf,g=m.position.count;if(T.transformMat4(r.slice(f,g),m.position,p),i.isSome(m.normal)&&i.isSome(n)){const e=a.normalFromMat4(u.create(),p),t=n.slice(f,g);T.transformMat3(t,m.normal,e),s.hasScaling(e)&&T.normalize(t,t)}else i.isSome(n)&&B.fill(n,0,0,1,{dstIndex:f,count:g});if(i.isSome(m.tangent)&&i.isSome(o)){const e=a.normalFromMat4(u.create(),p),t=o.slice(f,g);x.transformMat3(t,m.tangent,e),s.hasScaling(e)&&x.normalize(t,t)}else i.isSome(o)&&A.fill(o,0,0,1,1,{dstIndex:f,count:g});if(i.isSome(m.texCoord0)&&i.isSome(c)?C.normalizeIntegerBuffer(c.slice(f,g),m.texCoord0):i.isSome(c)&&C.fill(c,0,0,{dstIndex:f,count:g}),i.isSome(m.color)&&i.isSome(l)){const e=m.color,t=l.slice(f,g);if(4===e.elementCount)e instanceof d.BufferViewVec4f?x.scale(t,e,255):e instanceof d.BufferViewVec4u8?A.copy(t,e):e instanceof d.BufferViewVec4u16&&x.shiftRight(t,e,8);else{A.fill(t,255,255,255,255);const r=d.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof d.BufferViewVec3f?T.scale(r,e,255):e instanceof d.BufferViewVec3u8?B.copy(r,e):e instanceof d.BufferViewVec3u16&&T.shiftRight(r,e,8)}}else i.isSome(l)&&A.fill(l.slice(f,g),255,255,255,255)}function $(e,t){switch(t){case b.PrimitiveType.TRIANGLES:return M.trianglesToTriangles(e,S.generateIndexArray);case b.PrimitiveType.TRIANGLE_STRIP:return M.triangleStripToTriangles(e);case b.PrimitiveType.TRIANGLE_FAN:return M.triangleFanToTriangles(e)}}function N(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function D(e){return{horizontal:z(e.s),vertical:z(e.t)}}function z(e){switch(e){case b.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case b.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case b.TextureWrapMode.REPEAT:return"repeat"}}function U(e){return e**(1/V.COLOR_GAMMA)*255}function q(e,t){return c.fromValues(U(e[0]),U(e[1]),U(e[2]),t)}function W(e){return l.fromValues(U(e[0]),U(e[1]),U(e[2]))}e.loadGLTFMesh=R,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
