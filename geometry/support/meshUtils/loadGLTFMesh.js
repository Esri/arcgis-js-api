/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Color","../../../request","../../../core/MapUtils","../../../core/maybe","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec32","../../../chunks/vec42","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/webgl-engine/lib/geometryDataUtils","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec22"],(function(e,t,r,n,o,s,i,a,u,l,c,f,m,p,g,d,h,w,x,y,v,V,B,S,M,b,C){"use strict";function T(e,t,r){return A.apply(this,arguments)}function A(){return(A=t._asyncToGenerator((function*(e,t,r){const n=new y.DefaultLoadingContext(F(r)),o=(yield v.load(n,t,r,!0)).model,i=o.lods.shift(),a=new Map,u=new Map;o.textures.forEach(((e,t)=>a.set(t,$(e)))),o.materials.forEach(((e,t)=>u.set(t,_(e,a))));const l=R(i);for(const s of l.parts)L(l,s,u);const{position:c,normal:f,tangent:m,color:g,texCoord0:d}=l.vertexAttributes,h={position:c.typedBuffer,normal:s.isSome(f)?f.typedBuffer:null,tangent:s.isSome(m)?m.typedBuffer:null,uv:s.isSome(d)?d.typedBuffer:null,color:s.isSome(g)?g.typedBuffer:null},w=x.georeferenceByTransform(h,e,r);return{transform:w.transform,components:l.components,spatialReference:e.spatialReference,vertexAttributes:new p.default({position:w.vertexAttributes.position,normal:w.vertexAttributes.normal,tangent:w.vertexAttributes.tangent,color:h.color,uv:h.uv})}}))).apply(this,arguments)}function F(e){return null!=e&&e.resolveFile?{busy:!1,request:(r=t._asyncToGenerator((function*(t,r,o){const i=e.resolveFile(t),a="image"===r?"image":"binary"===r?"array-buffer":"json";return(yield n(i,{responseType:a,signal:s.isSome(o)?o.signal:null})).data})),function(e,t,n){return r.apply(this,arguments)})}:null;var r}function k(e,t){if(s.isNone(e))return"-";const r=e.typedBuffer;return`${o.getOrCreateMapValue(t,r.buffer,(()=>t.size))}/${r.byteOffset}/${r.byteLength}`}function O(e){return s.isSome(e)?e.toString():"-"}function R(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},n=new Map,s=new Map,i=[];for(const a of e.parts){const{attributes:{position:e,normal:u,color:l,tangent:c,texCoord0:f}}=a,m=`\n      ${k(e,n)}/\n      ${k(u,n)}/\n      ${k(l,n)}/\n      ${k(c,n)}/\n      ${k(f,n)}/\n      ${O(a.transform)}\n    `;let p=!1;const g=o.getOrCreateMapValue(s,m,(()=>(p=!0,{start:t,length:e.count})));p&&(t+=e.count),u&&(r.normal=!0),l&&(r.color=!0),c&&(r.tangent=!0),f&&(r.texCoord0=!0),i.push({gltf:a,writeVertices:p,region:g})}return{vertexAttributes:{position:w.createBuffer(g.BufferViewVec3f64,t),normal:r.normal?w.createBuffer(g.BufferViewVec3f,t):null,tangent:r.tangent?w.createBuffer(g.BufferViewVec4f,t):null,color:r.color?w.createBuffer(g.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?w.createBuffer(g.BufferViewVec2f,t):null},parts:i,components:[]}}function $(e){return new m({data:e.data,wrap:I(e.parameters.wrap)})}function _(e,t){const n=new r(q(e.color,e.opacity)),o=e.emissiveFactor?new r(z(e.emissiveFactor)):null;return new f({color:n,colorTexture:s.unwrap(s.applySome(e.textureColor,(e=>t.get(e)))),normalTexture:s.unwrap(s.applySome(e.textureNormal,(e=>t.get(e)))),emissiveColor:o,emissiveTexture:s.unwrap(s.applySome(e.textureEmissive,(e=>t.get(e)))),occlusionTexture:s.unwrap(s.applySome(e.textureOcclusion,(e=>t.get(e)))),alphaMode:G(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:s.unwrap(s.applySome(e.textureMetallicRoughness,(e=>t.get(e))))})}function L(e,t,r){t.writeVertices&&D(e,t);const n=t.gltf,o=E(n.indices||n.attributes.position.count,n.primitiveType),s=t.region.start;if(s)for(let i=0;i<o.length;i++)o[i]+=s;e.components.push(new c({faces:o,material:r.get(n.material),trustSourceNormals:!0}))}function D(e,t){const{position:r,normal:n,tangent:o,color:u,texCoord0:l}=e.vertexAttributes,c=t.region.start,{attributes:f,transform:m}=t.gltf,p=f.position.count;if(d.transformMat4(r.slice(c,p),f.position,m),s.isSome(f.normal)&&s.isSome(n)){const e=i.normalFromMat4(a.create(),m);d.transformMat3(n.slice(c,p),f.normal,e)}else s.isSome(n)&&M.fill(n,0,0,1,{dstIndex:c,count:p});if(s.isSome(f.tangent)&&s.isSome(o)){const e=i.normalFromMat4(a.create(),m);h.transformMat3(o.slice(c,p),f.tangent,e)}else s.isSome(o)&&b.fill(o,0,0,1,1,{dstIndex:c,count:p});if(s.isSome(f.texCoord0)&&s.isSome(l)?C.normalizeIntegerBuffer(l.slice(c,p),f.texCoord0):s.isSome(l)&&C.fill(l,0,0,{dstIndex:c,count:p}),s.isSome(f.color)&&s.isSome(u)){const e=f.color,t=u.slice(c,p);if(4===e.elementCount)e instanceof g.BufferViewVec4f?h.scale(t,e,255):e instanceof g.BufferViewVec4u8?b.copy(t,e):e instanceof g.BufferViewVec4u16&&h.shiftRight(t,e,8);else{b.fill(t,255,255,255,255);const r=g.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof g.BufferViewVec3f?d.scale(r,e,255):e instanceof g.BufferViewVec3u8?M.copy(r,e):e instanceof g.BufferViewVec3u16&&d.shiftRight(r,e,8)}}else s.isSome(u)&&b.fill(u.slice(c,p),255,255,255,255)}function E(e,t){switch(t){case 4:return V.trianglesToTriangles(e,B.generateIndexArray);case 5:return V.triangleStripToTriangles(e);case 6:return V.triangleFanToTriangles(e)}}function G(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function I(e){return{horizontal:N(e.s),vertical:N(e.t)}}function N(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function U(e){return e**(1/S.COLOR_GAMMA)*255}function q(e,t){return l.fromValues(U(e[0]),U(e[1]),U(e[2]),t)}function z(e){return u.fromValues(U(e[0]),U(e[1]),U(e[2]))}e.loadGLTFMesh=T,Object.defineProperty(e,"__esModule",{value:!0})}));
