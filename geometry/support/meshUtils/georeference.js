/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/unitUtils","../../../chunks/mat3f64","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/mat3","../../projection","../../projectionEllipsoid","../MeshTransform","../buffer/BufferView","../../../chunks/vec32","./geographicUtils","./projection"],(function(e,r,n,t,o,a,i,l,f,s,c,u,p,g){"use strict";function m(e,r,n){return p.isGeographicMesh(r.spatialReference,n)?w(e,r,n):T(e,r,n)}function y(e,n,t){const{position:o,normal:a,tangent:i}=e;if(r.isNone(n))return{position:o,normal:a,tangent:i};const l=n.localMatrix;return m({position:g.transformPosition(o,new Float64Array(o.length),l),normal:r.isSome(a)?g.transformNormal(a,new Float32Array(a.length),l):null,tangent:r.isSome(i)?g.transformTangent(i,new Float32Array(i.length),l):null},n.getOriginPoint(t),{geographic:n.geographic})}function h(e,r,n){if(null!=n&&n.useTransform){var t;const{position:o,normal:a,tangent:i}=e;return{vertexAttributes:{position:o,normal:a,tangent:i},transform:new s({origin:[r.x,r.y,null!=(t=r.z)?t:0],geographic:p.isGeographicMesh(r.spatialReference,n)})}}return{vertexAttributes:m(e,r,n),transform:null}}function A(e,r,n){return p.isGeographicMesh(r.spatialReference,n)?B(e,r,n):R(e,r,n)}function F(e,n,t,o){if(r.isNone(n))return A(e,t,o);const a=y(e,n,t.spatialReference);return t.equals(n.getOriginPoint(t.spatialReference))?R(a,t,o):p.isGeographicMesh(t.spatialReference,o)?B(a,t,o):R(a,t,o)}function T(e,r,n){const t=new Float64Array(e.position.length),o=e.position,a=r.x,i=r.y,l=r.z||0,{horizontal:f,vertical:s}=j(n?n.unit:null,r.spatialReference);for(let c=0;c<o.length;c+=3)t[c+0]=o[c+0]*f+a,t[c+1]=o[c+1]*f+i,t[c+2]=o[c+2]*s+l;return{position:t,normal:e.normal,tangent:e.tangent}}function w(e,r,n){const t=r.spatialReference,o=E(r,n,z),a=new Float64Array(e.position.length),l=P(e.position,o,t,a),f=i.normalFromMat4(_,o);return{position:l,normal:V(l,a,e.normal,f,t),tangent:M(l,a,e.tangent,f,t)}}function P(e,r,n,t){u.transformMat4(c.BufferViewVec3f64.fromTypedArray(t),c.BufferViewVec3f64.fromTypedArray(e),r);const o=new Float64Array(e.length);return g.projectFromPCPF(t,o,n)}function V(e,n,t,o,a){if(r.isNone(t))return null;const i=new Float32Array(t.length);return u.transformMat3(c.BufferViewVec3f.fromTypedArray(i),c.BufferViewVec3f.fromTypedArray(t),o),g.projectNormalFromPCPF(i,e,n,a,i),i}function M(e,n,t,o,a){if(r.isNone(t))return null;const i=new Float32Array(t.length);u.transformMat3(c.BufferViewVec3f.fromTypedArray(i,4*Float32Array.BYTES_PER_ELEMENT),c.BufferViewVec3f.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),o);for(let r=3;r<i.length;r+=4)i[r]=t[r];return g.projectTangentFromPCPF(i,e,n,a,i),i}function R(e,r,n){const t=new Float64Array(e.position.length),o=e.position,a=r.x,i=r.y,l=r.z||0,{horizontal:f,vertical:s}=j(n?n.unit:null,r.spatialReference);for(let c=0;c<o.length;c+=3)t[c+0]=(o[c+0]-a)/f,t[c+1]=(o[c+1]-i)/f,t[c+2]=(o[c+2]-l)/s;return{position:t,normal:e.normal,tangent:e.tangent}}function B(e,r,n){const t=r.spatialReference;E(r,n,z);const a=o.invert(x,z),l=new Float64Array(e.position.length),f=d(e.position,t,a,l),s=i.normalFromMat4(_,a);return{position:f,normal:N(e.normal,e.position,l,t,s),tangent:v(e.tangent,e.position,l,t,s)}}function E(e,r,n){l.computeLinearTransformation(e.spatialReference,[e.x,e.y,e.z||0],n,f.getSphericalPCPF(e.spatialReference));const{horizontal:t,vertical:a}=j(r?r.unit:null,e.spatialReference);return o.scale(n,n,[t,t,a]),n}function d(e,r,n,t){const o=g.projectToPCPF(e,r,t),a=c.BufferViewVec3f64.fromTypedArray(o),i=new Float64Array(o.length),l=c.BufferViewVec3f64.fromTypedArray(i);return u.transformMat4(l,a,n),i}function N(e,n,t,o,a){if(r.isNone(e))return null;const i=g.projectNormalToPCPF(e,n,t,o,new Float32Array(e.length)),l=c.BufferViewVec3f.fromTypedArray(i);return u.transformMat3(l,l,a),i}function v(e,n,t,o,a){if(r.isNone(e))return null;const i=g.projectTangentToPCPF(e,n,t,o,new Float32Array(e.length)),l=c.BufferViewVec3f.fromTypedArray(i,4*Float32Array.BYTES_PER_ELEMENT);return u.transformMat3(l,l,a),i}function j(e,t){if(r.isNone(e))return C;const o=t.isGeographic?1:n.getMetersPerUnit(t),a=t.isGeographic?1:n.getMetersPerVerticalUnitForSR(t),i=n.convertUnit(1,e,"meters");return{horizontal:i*o,vertical:i*a}}const z=a.create(),x=a.create(),_=t.create(),C={horizontal:1,vertical:1};e.georeference=m,e.georeferenceApplyTransform=y,e.georeferenceByTransform=h,e.ungeoreference=A,e.ungeoreferenceByTransform=F,Object.defineProperty(e,"__esModule",{value:!0})}));
