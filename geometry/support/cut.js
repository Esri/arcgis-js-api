/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{create as s}from"./aaBoundingRect.js";import{getBoundsXY as t,getPointsBoundsCenterX as e,getPointsBounds as n,getPointsBoundsWidth as o}from"./boundsUtils.js";import{isPolygon as f,isPolyline as r}from"./jsonUtils.js";import{getInfo as i}from"./spatialReferenceUtils.js";function l(s){if(!s)return null;if(!s.spatialReference)return s;const t=i(s.spatialReference);if(!t)return s;const e=t.valid[1];return f(s)?u(s,e):r(s)?h(s,e):s}function h(n,o){let f={paths:[],spatialReference:n.spatialReference};const[r,,i]=t(s(),n);let l=Math.ceil((r-o)/(2*o))*(2*o)+o;if(l>i)f=n;else{let s,t;for(;l<i;){const e=c(n,l);if(s=e[0],t=e[1],s)for(const t of s.paths)f.paths.push(t);if(null==t)break;n=t,l+=2*o}if(t)for(const e of t.paths)f.paths.push(e)}for(const s of f.paths){const t=j(e(s),o);for(const e of s)e[0]-=2*t*o}return f}function u(n,o){let f={rings:[],spatialReference:n.spatialReference};const[r,,i]=t(s(),n);let l=Math.ceil((r-o)/(2*o))*(2*o)+o;if(l>i)f=n;else{let s,t;for(;l<i;){if([s,t]=a(n,l),s)for(const t of s.rings)f.rings.push(t);if(null==t)break;n=t,l+=2*o}if(t)for(const e of t.rings)f.rings.push(e)}for(const s of f.rings){const t=j(e(s),o);for(const e of s)e[0]-=2*t*o}return f}const p=s();function c(s,e){const[o,,f]=t(p,s);let r,i;if(f<=e)r=s;else if(o>=e)i=s;else{r={paths:[]},i={paths:[]};const t=r.paths,o=i.paths;for(const f of s.paths){const[s,,r]=n(p,f);if(r<=e)t.push(f);else if(s>=e)o.push(f);else{let s=f[0],n=m(s,e),r=[];r.push(s);for(let i=1;i<f.length;i++){const l=f[i],h=m(l,e);if(h===n)r.push(l);else{const f=R(s,l,e);r.push(f),n?t.push(r):o.push(r),r=[f,l],n=h}s=l}n?t.push(r):o.push(r)}}}return[r,i]}function a(e,o){let f,r;const[i,,l]=t(s(),e);if(l<=o)f=e;else if(i>=o)r=e;else{const t=[],i=[],l=[];for(const f of e.rings){const[e,,r]=n(s(),f);if(r<=o)t.push(f);else if(e>=o)i.push(f);else{let s=f[f.length-1],e=m(s,o),n=[];for(const r of f){const f=m(r,o);if(f===e)n.push(r);else{const h=R(s,r,o);n.push(h),e?t.push(n):i.push(n),l.push(h[1]),n=[],n.push([h[0],h[1]]),n.push(r),e=f}s=r}e?t.push(n):i.push(n)}}l.sort(((s,t)=>s-t));for(let s=0;s<l.length-1;s+=2){const e=[];e.push([o,l[s]]),e.push([o,l[s+1]]),t.length>0&&t.push(e),i.length>0&&i.push(e)}t.length>0&&(f=g(t)),i.length>0&&(r=g(i))}return[f,r]}function g(s){let t;const e={rings:[]};for(;s.length>0;){const n=s[0];let f=!1;const[r,i]=n[0],[l,h]=n[n.length-1];if(r!==l||i!==h)for(let u=1;u<s.length;u++){const p=s[u],[c,a]=p[0],[g,m]=p[p.length-1];if(h===a&&l===c){for(t=1;t<p.length;t++)n.push([p[t][0],p[t][1]]);f=!0}else if(h===m&&l===g){for(t=p.length-2;t>=0;t--)n.push([p[t][0],p[t][1]]);f=!0}else if(i===m&&r===g){for(t=0;t<p.length-1;t++)n.splice(t,0,[p[t][0],p[t][1]]);f=!0}else if(i===a&&r===c){for(t=1;t<p.length;t++)n.unshift([p[t][0],p[t][1]]);f=!0}if(f){s.splice(u,1),b(n[0],n[n.length-1])&&(s.shift(),o(n)>0&&e.rings.push(n));break}}f||(s.shift(),n.length,e.rings.push(n))}return e}function m([s],t){return s<t}function R([s,t],[e,n],o){return[o,t+(n-t)/(e-s)*(o-s)]}function j(s,t){let e=(s+t)/(2*t);return e%2==1&&e--,Math.floor(e)}function b([s,t],[e,n]){return s===e&&t===n}export{l as normalize};
