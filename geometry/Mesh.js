// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../core/Error","../core/lang","../core/Logger","../core/promiseUtils","../core/accessorSupport/decorators","../core/libs/gl-matrix-2/vec3f64","../core/libs/gl-matrix-2/vec4f64","./Extent","./Geometry","./Point","./Polygon","./support/MeshComponent","./support/MeshVertexAttributes","./support/triangulationUtils","./support/meshUtils/centerAt","./support/meshUtils/merge","./support/meshUtils/offset","./support/meshUtils/primitives","./support/meshUtils/rotate","./support/meshUtils/scale","@dojo/framework/shim/Promise"],(function(e,t,n,r,o,i,a,s,c,p,u,l,f,m,h,x,d,y,v,g,b,w,_){"use strict";var A=i.getLogger("esri.geometry.Mesh"),M=function(t){function i(e){var n=t.call(this,e)||this;return n.components=null,n.hasZ=!0,n.hasM=!1,n.vertexAttributes=new x.MeshVertexAttributes,n.type="mesh",n}var c;return n.__extends(i,t),c=i,Object.defineProperty(i.prototype,"extent",{get:function(){var e=this.spatialReference,t=this.vertexAttributes&&this.vertexAttributes.position;if(!t||0===t.length||this.components&&0===this.components.length)return new u({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:e});var n={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,zmin:1/0,zmax:-1/0,spatialReference:e};if(!this.components)return new u(this.extendExtent(n,t,null));for(var r=0,o=this.components;r<o.length;r++){var i=o[r];if(!i.faces){this.extendExtent(n,t,null);break}this.extendExtent(n,t,i.faces)}return new u(n)},enumerable:!1,configurable:!0}),i.prototype.addComponent=function(e){this.components||(this.components=[]),this.components.push(h.from(e)),this.clearCache()},i.prototype.removeComponent=function(e){if(this.components){var t=this.components.indexOf(e);if(-1!==t)return void(this.components=this.components.splice(t,1))}A.error("removeComponent()","Provided component is not part of the list of components")},i.prototype.rotate=function(e,t,n,r){return w.axisAngleFrom(P.x,F(e),z),w.axisAngleFrom(P.y,F(t),G),w.axisAngleFrom(P.z,F(n),O),w.axisAngleMultiply(z,G,z),w.axisAngleMultiply(z,O,z),w.rotate(this,z,r),this},i.prototype.offset=function(e,t,n,r){return U[0]=e,U[1]=t,U[2]=n,g.offset(this,U,r),this},i.prototype.scale=function(e,t){return _.scale(this,e,t),this},i.prototype.centerAt=function(e,t){return y.centerAt(this,e,t),this},i.prototype.clone=function(){var e=this.components?new Map:null,t=this.components?new Map:null,n=this.components?this.components.map((function(n){return n.cloneWithDeduplication(e,t)})):null;return new c({components:n,spatialReference:this.spatialReference,vertexAttributes:o.clone(this.vertexAttributes)})},i.prototype.vertexAttributesChanged=function(){this.clearCache()},i.prototype.toJSON=function(e){return this.write(null,e)},i.prototype.forEachVertex=function(e,t,n){if(t)for(o=0;o<t.length;o++){var r=3*t[o];n(e[r+0],e[r+1],e[r+2])}else for(var o=0;o<e.length;o+=3)n(e[o+0],e[o+1],e[o+2])},i.prototype.extendExtent=function(e,t,n){return this.forEachVertex(t,n,(function(t,n,r){e.xmin=Math.min(e.xmin,t),e.xmax=Math.max(e.xmax,t),e.ymin=Math.min(e.ymin,n),e.ymax=Math.max(e.ymax,n),e.zmin=Math.min(e.zmin,r),e.zmax=Math.max(e.zmax,r)})),e},i.prototype.toBinaryGLTF=function(t){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(t,n){e(["./support/meshUtils/exporters/gltf/gltfexport"],t,n)}))];case 1:return[2,(0,n.sent().toBinaryGLTF)(this,t)]}}))}))},i.createBox=function(e,t){if(!(e instanceof f))return A.error(".createBox()","expected location to be a Point instance"),null;var n=new c(b.convertUnitGeometry(b.createUnitSizeBox(),e,t));return t&&t.imageFace&&"all"!==t.imageFace?function(e,t){for(var n=e.components[0],r=n.faces,o=b.boxFaceOrder[t],i=6*o,a=new Uint32Array(6),s=new Uint32Array(r.length-6),c=0,p=0,u=0;u<r.length;u++)u>=i&&u<i+6?a[c++]=r[u]:s[p++]=r[u];var l=new Float32Array(e.vertexAttributes.uv),f=4*o*2,m=[0,1,1,1,1,0,0,0];for(u=0;u<m.length;u++)l[f+u]=m[u];return e.vertexAttributes.uv=l,e.components=[new h({faces:a,material:n.material}),new h({faces:s})],e}(n,t.imageFace):n},i.createSphere=function(e,t){return e instanceof f?new c(b.convertUnitGeometry(b.createUnitSizeSphere(t&&t.densificationFactor||0),e,t)):(A.error(".createSphere()","expected location to be a Point instance"),null)},i.createCylinder=function(e,t){return e instanceof f?new c(b.convertUnitGeometry(b.createUnitSizeCylinder(t&&t.densificationFactor||0),e,t)):(A.error(".createCylinder()","expected location to be a Point instance"),null)},i.createPlane=function(e,t){return e instanceof f?new c(b.convertUnitGeometry(b.createUnitSizePlane(t&&t.facing||"up"),e,t)):(A.error(".createPlane()","expected location to be a Point instance"),null)},i.createFromPolygon=function(e,t){if(!(e instanceof m))return A.error(".createFromPolygon()","expected polygon to be a Polygon instance"),null;var n=d.triangulate(e);return new c({vertexAttributes:{position:n.position},components:[{faces:n.faces,shading:"flat",material:t&&t.material||null}],spatialReference:e.spatialReference})},i.createFromGLTF=function(t,o,i){return n.__awaiter(this,void 0,void 0,(function(){var s=this;return n.__generator(this,(function(p){if(!(t instanceof f))throw A.error(".createfromGLTF()","expected location to be a Point instance"),new r("invalid-input","Expected location to be a Point instance");return[2,a.create((function(p,u){new Promise((function(t,n){e(["./support/loadGLTFMesh"],t,n)})).then((function(e){return n.__awaiter(s,void 0,void 0,(function(){var s,l;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),a.throwIfAborted(i),[4,e.loadGLTFMesh(t,o,i)];case 1:return s=n.sent(),p(new c(v.merge(s.map((function(e){return new c(e)})),{reuseMaterials:!0}))),[3,3];case 2:return l=n.sent(),u(new r("gltf-loader-error","Failed to load glTF.","["+l.name+"] "+l.message)),[3,3];case 3:return[2]}}))}))}))}))]}))}))},n.__decorate([s.property({dependsOn:["vertexAttributes","vertexAttributes.position","components"],json:{read:!1}})],i.prototype,"cache",void 0),n.__decorate([s.property({type:[h]})],i.prototype,"components",void 0),n.__decorate([s.property({dependsOn:["cache"],readOnly:!0,json:{read:!1}})],i.prototype,"extent",null),n.__decorate([s.property({readOnly:!0,json:{read:!1,write:!1}})],i.prototype,"hasZ",void 0),n.__decorate([s.property({readOnly:!0,json:{read:!1,write:!1}})],i.prototype,"hasM",void 0),n.__decorate([s.property({type:x.MeshVertexAttributes,nonNullable:!0,json:{write:!0}})],i.prototype,"vertexAttributes",void 0),i=c=n.__decorate([s.subclass("esri.geometry.Mesh")],i)}(l);function F(e){return e/180*Math.PI}M.prototype.toJSON.isDefaultToJSON=!0;var P={x:c.vec3f64.fromValues(1,0,0),y:c.vec3f64.fromValues(0,1,0),z:c.vec3f64.fromValues(0,0,1)},U=c.vec3f64.create(),z=p.vec4f64.create(),G=p.vec4f64.create(),O=p.vec4f64.create();return M}));