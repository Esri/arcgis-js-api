// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator","./polyfill/tsSupport/assign","./polyfill/tsSupport/spreadarray","./polyfill/tsSupport/extends","./ArcadeModule","./ArcadeModuleLoader","./Dictionary","./executionError","./Feature","./FunctionWrapper","./languageUtils","./treeAnalysis","./functions/array","./functions/date","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","../geometry/Geometry","../SpatialReference"],(function(e,r,t,o,n,i,a,u,c,l,s,d,f,p,E,x,v,h,w,m,g,b,y,A){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.executeScript=r.extend=r.functionHelper=void 0;var C=function(e){function r(r,t){var o=e.call(this)||this;return o.definition=null,o.context=null,o.definition=r,o.context=t,o}return a(r,e),r.prototype.createFunction=function(e){var r=this;return function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];var n={spatialReference:r.context.spatialReference,console:r.context.console,timeReference:r.context.timeReference?r.context.timeReference:null,lrucache:r.context.lrucache,exports:r.context.exports,libraryResolver:r.context.libraryResolver,interceptor:r.context.interceptor,localScope:{},depthCounter:{depth:e.depthCounter.depth+1},globalScope:r.context.globalScope};if(n.depthCounter.depth>64)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.MaximumCallDepth,null);return L(r.definition,n,t,null)}},r.prototype.call=function(e,r){var t=this;return F(e,r,(function(o,n,i){var a,u={spatialReference:e.spatialReference,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,timeReference:null!==(a=e.timeReference)&&void 0!==a?a:null,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,localScope:{}};if(u.depthCounter.depth>64)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.MaximumCallDepth,r);return L(t.definition,u,i,r)}))},r.prototype.marshalledCall=function(e,r,t,o){var n=this;return o(e,r,(function(i,a,u){var c,l={spatialReference:e.spatialReference,globalScope:t.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,timeReference:null!==(c=e.timeReference)&&void 0!==c?c:null,lrucache:e.lrucache,interceptor:e.interceptor,localScope:{}};return u=u.map((function(r){return!p.isFunctionParameter(r)||r instanceof f.ScopeMarshalledFunction?r:f.wrapModuleScopedResponse(r,e,o)})),f.wrapModuleScopedResponse(L(n.definition,l,u,r),t,o)}))},r}(f.ArcadeFunction),S=function(e){function r(r){return e.call(this,r)||this}return a(r,e),r.prototype.global=function(e){var r=this.executingContext.globalScope[e.toLowerCase()];if(r.valueset||(r.value=N(this.executingContext,r.node),r.valueset=!0),p.isFunctionParameter(r.value)&&!(r.value instanceof f.ScopeMarshalledFunction)){var t=new f.ScopeMarshalledFunction;t.fn=r.value,t.parameterEvaluator=F,t.context=this.executingContext,r.value=t}return r.value},r.prototype.setGlobal=function(e,r){if(p.isFunctionParameter(r))throw new s.ArcadeExecutionError(null,s.ExecutionErrorCodes.AssignModuleFunction,null);this.executingContext.globalScope[e.toLowerCase()]={value:r,valueset:!0,node:null}},r.prototype.hasGlobal=function(e){return void 0===this.executingContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.executingContext.exports[e]},r.prototype.loadModule=function(e){var r,t=e.spatialReference;null==t&&(t=new A({wkid:102100})),this.moduleScope=D({},e.customfunctions,e.timeReference),this.executingContext={spatialReference:t,globalScope:this.moduleScope,localScope:null,libraryResolver:new c.ArcadeModuleLoader(e.libraryResolver._moduleSingletons,this.source.syntax.loadedModules),exports:{},console:e.console?e.console:U,timeReference:null!==(r=e.timeReference)&&void 0!==r?r:null,lrucache:e.lrucache,interceptor:e.interceptor,depthCounter:{depth:1}},N(this.executingContext,this.source.syntax)},r}(u.ArcadeModule);function R(e,r){for(var t=[],o=0;o<r.arguments.length;o++)t.push(N(e,r.arguments[o]));return t}function F(e,r,t){try{return!0===r.preparsed?t(e,null,r.arguments):t(e,r,R(e,r))}catch(e){throw e}}function N(e,r){try{switch(null==r?void 0:r.type){case"EmptyStatement":return p.voidOperation;case"VariableDeclarator":return function(e,r){var t=null===r.init?null:N(e,r.init);t===p.voidOperation&&(t=null);if("Identifier"!==r.id.type)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);var o=r.id.name.toLowerCase();null!=e.localScope?e.localScope[o]={value:t,valueset:!0,node:r.init}:e.globalScope[o]={value:t,valueset:!0,node:r.init};return p.voidOperation}(e,r);case"VariableDeclaration":return function(e,r){for(var t=0;t<r.declarations.length;t++)N(e,r.declarations[t]);return p.voidOperation}(e,r);case"ImportDeclaration":return function(e,r){var t,o,n=r.specifiers[0].local.name.toLowerCase(),i=e.libraryResolver.loadLibrary(n),a=null;(null===(t=e.libraryResolver._moduleSingletons)||void 0===t?void 0:t.has(i.uri))?a=e.libraryResolver._moduleSingletons.get(i.uri):((a=new S(i)).loadModule(e),null===(o=e.libraryResolver._moduleSingletons)||void 0===o||o.set(i.uri,a));return e.globalScope[n]={value:a,valueset:!0,node:r},p.voidOperation}(e,r);case"ExportNamedDeclaration":return function(e,r){if(N(e,r.declaration),"FunctionDeclaration"===r.declaration.type)e.exports[r.declaration.id.name.toLowerCase()]="function";else if("VariableDeclaration"===r.declaration.type)for(var t=0,o=r.declaration.declarations;t<o.length;t++){var n=o[t];e.exports[n.id.name.toLowerCase()]="variable"}return p.voidOperation}(e,r);case"BlockStatement":case"Program":return function(e,r){for(var t=p.voidOperation,o=0;o<r.body.length;o++)if((t=N(e,r.body[o]))instanceof p.ReturnResult||t===p.breakResult||t===p.continueResult)return t;return t}(e,r);case"FunctionDeclaration":return function(e,r){var t=r.id.name.toLowerCase();return e.globalScope[t]={valueset:!0,node:null,value:new C(r,e)},p.voidOperation}(e,r);case"ReturnStatement":return function(e,r){if(null===r.argument)return new p.ReturnResult(p.voidOperation);var t=N(e,r.argument);return new p.ReturnResult(t)}(e,r);case"IfStatement":return function(e,r){var t=N(e,r.test);if(!0===t)return N(e,r.consequent);if(!1===t)return null!==r.alternate?N(e,r.alternate):p.voidOperation;throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.BooleanConditionRequired,r)}(e,r);case"ExpressionStatement":return function(e,r){if("AssignmentExpression"===r.expression.type||"UpdateExpression"===r.expression.type)return N(e,r.expression);if("CallExpression"===r.expression.type){return(t=N(e,r.expression))===p.voidOperation?p.voidOperation:new p.ImplicitResult(t)}var t;if((t=N(e,r.expression))===p.voidOperation)return p.voidOperation;return new p.ImplicitResult(t)}(e,r);case"AssignmentExpression":return function(e,r){var t=null,o="";if("MemberExpression"===r.left.type){if(t=N(e,r.left.object),!0===r.left.computed)o=N(e,r.left.property);else{if("Identifier"!==r.left.property.type)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);o=r.left.property.name}var n=N(e,r.right);if(p.isArray(t)){if(!p.isNumber(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.ArrayAccessorMustBeNumber,r);if(o<0&&(o=t.length+o),o<0||o>t.length)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.OutOfBounds,r);if(o===t.length){if("="!==r.operator)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.OutOfBounds,r);t[o]=O(n,r.operator,t[o],r,e)}else t[o]=O(n,r.operator,t[o],r,e)}else if(t instanceof l){if(!1===p.isString(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0===t.hasField(o))t.setField(o,O(n,r.operator,t.field(o),r,e));else{if("="!==r.operator)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FieldNotFound,r,{key:o});t.setField(o,O(n,r.operator,null,r,e))}}else if(p.isFeature(t)){if(!1===p.isString(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0===t.hasField(o))t.setField(o,O(n,r.operator,t.field(o),r,e));else{if("="!==r.operator)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FieldNotFound,r,{key:o});t.setField(o,O(n,r.operator,null,r,e))}}else{if(p.isImmutableArray(t))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.Immutable,r);if(!(t instanceof S))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);if(!1===p.isString(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.ModuleAccessorMustBeString,r);if(!0!==t.hasGlobal(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.ModuleExportNotFound,r);t.setGlobal(o,O(n,r.operator,t.global(o),r,e))}return p.voidOperation}t=r.left.name.toLowerCase();var i=N(e,r.right);if(null!=e.localScope&&void 0!==e.localScope[t])return e.localScope[t]={value:O(i,r.operator,e.localScope[t].value,r,e),valueset:!0,node:r.right},p.voidOperation;if(void 0!==e.globalScope[t])return e.globalScope[t]={value:O(i,r.operator,e.globalScope[t].value,r,e),valueset:!0,node:r.right},p.voidOperation;throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r)}(e,r);case"UpdateExpression":return function(e,r){var t,o=null,n="";if("MemberExpression"===r.argument.type){if(o=N(e,r.argument.object),!0===r.argument.computed?n=N(e,r.argument.property):"Identifier"===r.argument.property.type&&(n=r.argument.property.name),p.isArray(o)){if(!p.isNumber(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.ArrayAccessorMustBeNumber,r);if(n<0&&(n=o.length+n),n<0||n>=o.length)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.OutOfBounds,r);t=p.toNumber(o[n]),o[n]="++"===r.operator?t+1:t-1}else if(o instanceof l){if(!1===p.isString(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==o.hasField(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FieldNotFound,r);t=p.toNumber(o.field(n)),o.setField(n,"++"===r.operator?t+1:t-1)}else if(p.isFeature(o)){if(!1===p.isString(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==o.hasField(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FieldNotFound,r);t=p.toNumber(o.field(n)),o.setField(n,"++"===r.operator?t+1:t-1)}else{if(p.isImmutableArray(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.Immutable,r);if(!(o instanceof S))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidParameter,r);if(!1===p.isString(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.ModuleAccessorMustBeString,r);if(!0!==o.hasGlobal(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.ModuleExportNotFound,r);t=p.toNumber(o.global(n)),o.setGlobal(n,"++"===r.operator?t+1:t-1)}return!1===r.prefix?t:"++"===r.operator?t+1:t-1}if(!(o="Identifier"===r.argument.type?r.argument.name.toLowerCase():""))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);if(null!=e.localScope&&void 0!==e.localScope[o])return t=p.toNumber(e.localScope[o].value),e.localScope[o]={value:"++"===r.operator?t+1:t-1,valueset:!0,node:r},!1===r.prefix?t:"++"===r.operator?t+1:t-1;if(void 0!==e.globalScope[o])return t=p.toNumber(e.globalScope[o].value),e.globalScope[o]={value:"++"===r.operator?t+1:t-1,valueset:!0,node:r},!1===r.prefix?t:"++"===r.operator?t+1:t-1;throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r)}(e,r);case"BreakStatement":return p.breakResult;case"ContinueStatement":return p.continueResult;case"TemplateElement":return function(e,r){return r.value?r.value.cooked:""}(0,r);case"TemplateLiteral":return function(e,r){for(var t="",o=0,n=0,i=r.quasis;n<i.length;n++){var a=i[n];if(t+=a.value?a.value.cooked:"",!1===a.tail){var u=r.expressions[o]?p.toString(M(N(e,r.expressions[o]),e,r)):"";t+=u,o++}}return t}(e,r);case"ForStatement":return function(e,r){null!==r.init&&N(e,r.init);var t={testResult:!0,lastAction:p.voidOperation};do{I(e,r,t)}while(!0===t.testResult);if(t.lastAction instanceof p.ReturnResult)return t.lastAction;return p.voidOperation}(e,r);case"ForInStatement":return function(e,r){var t=N(e,r.right);"VariableDeclaration"===r.left.type&&N(e,r.left);var o=null,n="";if("VariableDeclaration"===r.left.type){var i=r.left.declarations[0].id;"Identifier"===i.type&&(n=i.name)}else"Identifier"===r.left.type&&(n=r.left.name);if(!n)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);n=n.toLowerCase(),null!=e.localScope&&void 0!==e.localScope[n]&&(o=e.localScope[n]);null===o&&void 0!==e.globalScope[n]&&(o=e.globalScope[n]);if(null===o)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);if(p.isArray(t)||p.isString(t)){for(var a=t.length,u=0;u<a;u++){if(o.value=u,(f=N(e,r.body))===p.breakResult)break;if(f instanceof p.ReturnResult)return f}return p.voidOperation}if(p.isImmutableArray(t)){for(u=0;u<t.length();u++){if(o.value=u,(f=N(e,r.body))===p.breakResult)break;if(f instanceof p.ReturnResult)return f}return p.voidOperation}if(!(t instanceof l||p.isFeature(t)))return p.voidOperation;for(var c=t.keys(),d=0;d<c.length;d++){var f;if(o.value=c[d],(f=N(e,r.body))===p.breakResult)break;if(f instanceof p.ReturnResult)return f}}(e,r);case"WhileStatement":return function(e,r){var t={testResult:!0,lastAction:p.voidOperation};if(t.testResult=N(e,r.test),!1===t.testResult)return p.voidOperation;if(!0!==t.testResult)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.BooleanConditionRequired,r);for(;!0===t.testResult&&(t.lastAction=N(e,r.body),t.lastAction!==p.breakResult)&&!(t.lastAction instanceof p.ReturnResult);)if(t.testResult=N(e,r.test),!0!==t.testResult&&!1!==t.testResult)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.BooleanConditionRequired,r);if(t.lastAction instanceof p.ReturnResult)return t.lastAction;return p.voidOperation}(e,r);case"Identifier":return B(e,r);case"MemberExpression":return function(e,r){try{var t=N(e,r.object);if(null===t)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.MemberOfNull,r);if(!1===r.computed){if("Identifier"===r.property.type){if(t instanceof l||p.isFeature(t))return t.field(r.property.name);if(t instanceof y)return h.geometryMember(t,r.property.name,r,e);if(t instanceof S){if(!t.hasGlobal(r.property.name))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r);return t.global(r.property.name)}}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}var o=N(e,r.property);if(t instanceof l||p.isFeature(t)){if(p.isString(o))return t.field(o);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof S){if(p.isString(o))return t.global(o);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof y){if(p.isString(o))return h.geometryMember(t,o,r,e);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(p.isArray(t)){if(p.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(p.isString(t)){if(p.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(p.isImmutableArray(t)){if(p.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length()+o),o>=t.length()||o<0)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.OutOfBounds,r);return t.get(o)}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidMemberAccessKey,r)}catch(e){throw e}}(e,r);case"Literal":return r.value;case"CallExpression":return function(e,r){try{if("MemberExpression"===r.callee.type){var t=N(e,r.callee.object);if(!(t instanceof S))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FuncionNotFound,r);var o=!1===r.callee.computed?r.callee.property.name:N(e,r.callee.property);if(!t.hasGlobal(o))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FuncionNotFound,r);var n=t.global(o);if(!p.isFunctionParameter(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.CallNonFunction,r);return n.call(e,r)}if("Identifier"!==r.callee.type)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FuncionNotFound,r);if(null!=e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var i=e.localScope[r.callee.name.toLowerCase()];if(p.isFunctionParameter(i.value))return i.value.call(e,r);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.CallNonFunction,r)}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){i=e.globalScope[r.callee.name.toLowerCase()];if(p.isFunctionParameter(i.value))return i.value.call(e,r);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.CallNonFunction,r)}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.FuncionNotFound,r)}catch(e){throw e}}(e,r);case"UnaryExpression":return function(e,r){try{var t=N(e,r.argument);if(p.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*p.toNumber(t);if("+"===r.operator)return 1*p.toNumber(t);if("~"===r.operator)return~p.toNumber(t);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}if("~"===r.operator)return~p.toNumber(t);if("-"===r.operator)return-1*p.toNumber(t);if("+"===r.operator)return 1*p.toNumber(t);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}catch(e){throw e}}(e,r);case"BinaryExpression":return function(e,r){try{var t=[N(e,r.left),N(e,r.right)],o=t[0],n=t[1];switch(r.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return p.binaryOperator(p.toNumber(o),p.toNumber(n),r.operator);case"==":return p.equalityTest(o,n);case"!=":return!p.equalityTest(o,n);case"<":case">":case"<=":case">=":return p.greaterThanLessThan(o,n,r.operator);case"+":return p.isString(o)||p.isString(n)?p.toString(o)+p.toString(n):p.toNumber(o)+p.toNumber(n);case"-":return p.toNumber(o)-p.toNumber(n);case"*":return p.toNumber(o)*p.toNumber(n);case"/":return p.toNumber(o)/p.toNumber(n);case"%":return p.toNumber(o)%p.toNumber(n);default:throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.UnsupportedOperator,r)}}catch(e){throw e}}(e,r);case"LogicalExpression":return function(e,r){try{var t=N(e,r.left);if(p.isBoolean(t))switch(r.operator){case"||":if(!0===t)return t;var o=N(e,r.right);if(p.isBoolean(o))return o;throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.LogicExpressionOrAnd,r);case"&&":if(!1===t)return t;o=N(e,r.right);if(p.isBoolean(o))return o;throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.LogicExpressionOrAnd,r);default:throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.LogicExpressionOrAnd,r)}throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r)}catch(e){throw e}}(e,r);case"ArrayExpression":return function(e,r){try{for(var t=[],o=0;o<r.elements.length;o++){var n=N(e,r.elements[o]);if(p.isFunctionParameter(n))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.NoFunctionInArray,r);n===p.voidOperation?t.push(null):t.push(n)}return t}catch(e){throw e}}(e,r);case"ObjectExpression":return function(e,r){for(var t={},o=new Map,n=0;n<r.properties.length;n++){var i=N(e,r.properties[n]);if(p.isFunctionParameter(i.value))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.NoFunctionInDictionary,r);if(!1===p.isString(i.key))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.KeyMustBeString,r);var a=i.key.toString(),u=a.toLowerCase();o.has(u)?a=o.get(u):o.set(u,a),i.value===p.voidOperation?t[a]=null:t[a]=i.value}var c=new l(t);return c.immutable=!1,c}(e,r);case"Property":return function(e,r){return{key:"Identifier"===r.key.type?r.key.name:N(e,r.key),value:N(e,r.value)}}(e,r);default:throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.Unrecognised,r)}}catch(t){throw s.ensureArcadeExecutionError(e,r,t)}}function I(e,r,t){if(null!==r.test){if(t.testResult=N(e,r.test),!1===t.testResult)return;if(!0!==t.testResult)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.BooleanConditionRequired,r)}t.lastAction=N(e,r.body),t.lastAction!==p.breakResult?t.lastAction instanceof p.ReturnResult?t.testResult=!1:null!==r.update&&N(e,r.update):t.testResult=!1}function O(e,r,t,o,n){switch(r){case"=":return e===p.voidOperation?null:e;case"/=":return p.toNumber(t)/p.toNumber(e);case"*=":return p.toNumber(t)*p.toNumber(e);case"-=":return p.toNumber(t)-p.toNumber(e);case"+=":return p.isString(t)||p.isString(e)?p.toString(t)+p.toString(e):p.toNumber(t)+p.toNumber(e);case"%=":return p.toNumber(t)%p.toNumber(e);default:throw new s.ArcadeExecutionError(n,s.ExecutionErrorCodes.UnsupportedOperator,o)}}function M(e,r,t){if(p.isFunctionParameter(e))throw new s.ArcadeExecutionError(r,s.ExecutionErrorCodes.NoFunctionInTemplateLiteral,t);return e}function B(e,r){var t;try{var o=r.name.toLowerCase();if(null!=e.localScope&&void 0!==e.localScope[o])return!0===(t=e.localScope[o]).valueset?t.value:(t.value=N(e,t.node),t.valueset=!0,t.value);if(void 0!==e.globalScope[o])return!0===(t=e.globalScope[o]).valueset?t.value:(t.value=N(e,t.node),t.valueset=!0,t.value);throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.InvalidIdentifier,r)}catch(e){throw e}}var k={};function L(e,r,t,o){try{var n=e.body;if(t.length!==e.params.length)throw new s.ArcadeExecutionError(r,s.ExecutionErrorCodes.WrongNumberOfParameters,o);if(null!=r.localScope)for(var i=0;i<t.length;i++)r.localScope[e.params[i].name.toLowerCase()]={value:t[i],valueset:!0,node:null};var a=N(r,n);if(a instanceof p.ReturnResult)return a.value;if(a===p.breakResult)throw new s.ArcadeExecutionError(r,s.ExecutionErrorCodes.UnexpectedToken,o);if(a===p.continueResult)throw new s.ArcadeExecutionError(r,s.ExecutionErrorCodes.UnexpectedToken,o);return a instanceof p.ImplicitResult?a.value:a}catch(e){throw e}}for(var P in v.registerFunctions(k,F),b.registerFunctions(k,F),m.registerFunctions(k,F),h.registerFunctions(k,F),g.registerFunctions(k,F),w.registerFunctions(k,F),k.iif=function(e,r){try{p.pcCheck(null===r.arguments?[]:r.arguments,3,3,e,r);var t=N(e,r.arguments[0]);if(!1===p.isBoolean(t))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.BooleanConditionRequired,r);return N(e,!0===t?r.arguments[1]:r.arguments[2])}catch(e){throw e}},k.decode=function(e,r){try{if(r.arguments.length<2)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.WrongNumberOfParameters,r);if(2===r.arguments.length)return N(e,r.arguments[1]);if((r.arguments.length-1)%2==0)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.WrongNumberOfParameters,r);var t=N(e,r.arguments[0]);return function e(r,t,o,n){try{var i=N(r,t.arguments[o]);if(p.equalityTest(i,n))return N(r,t.arguments[o+1]);var a=t.arguments.length-o;return 1===a?N(r,t.arguments[o]):2===a?null:3===a?N(r,t.arguments[o+2]):e(r,t,o+2,n)}catch(e){throw e}}(e,r,1,t)}catch(e){throw e}},k.when=function(e,r){try{if(r.arguments.length<3)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.WrongNumberOfParameters,r);if(r.arguments.length%2==0)throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.WrongNumberOfParameters,r);var t=N(e,r.arguments[0]);if(!1===p.isBoolean(t))throw new s.ArcadeExecutionError(e,s.ExecutionErrorCodes.BooleanConditionRequired,r.arguments[0]);return function e(r,t,o,n){try{if(!0===n)return N(r,t.arguments[o+1]);if(3===t.arguments.length-o)return N(r,t.arguments[o+2]);var i=N(r,t.arguments[o+2]);if(!1===p.isBoolean(i))throw new s.ArcadeExecutionError(r,s.ExecutionErrorCodes.BooleanConditionRequired,t.arguments[o+2]);return e(r,t,o+2,i)}catch(e){throw e}}(e,r,0,t)}catch(e){throw e}},k)k[P]={value:new f.NativeFunction(k[P]),valueset:!0,node:null};var q=function(){};function D(e,r,t){var o=new q;e||(e={}),r||(r={});var n=new l({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});for(var i in n.immutable=!1,o.textformatting={value:n,valueset:!0,node:null},r)o[i]={value:new f.NativeFunction(r[i]),native:!0,valueset:!0,node:null};for(var i in e)e[i]&&"esri.Graphic"===e[i].declaredClass?o[i]={value:d.createFromGraphic(e[i],t),valueset:!0,node:null}:o[i]={value:e[i],valueset:!0,node:null};return o}(q.prototype=k).infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},q.prototype.pi={value:Math.PI,valueset:!0,node:null};var K={fixSpatialReference:p.fixSpatialReference,parseArguments:R,standardFunction:F};function U(e){console.log(e)}function T(e){for(var r={mode:"sync",compiled:!1,functions:{},signatures:[],standardFunction:F,evaluateIdentifier:B},t=0;t<e.length;t++)e[t].registerFunctions(r);for(var o in r.functions)k[o]={value:new f.NativeFunction(r.functions[o]),valueset:!0,node:null},q.prototype[o]=k[o];for(t=0;t<r.signatures.length;t++)E.addFunctionDeclaration(r.signatures[t],"sync")}r.functionHelper=K,r.extend=T,T([x]),r.executeScript=function(e,r){var t,o=r.spatialReference;null==o&&(o=new A({wkid:102100}));var n=null;e.usesModules&&(n=new c.ArcadeModuleLoader(new Map,e.loadedModules));var i={spatialReference:o,globalScope:D(r.vars,r.customfunctions,r.timeReference),localScope:null,exports:{},libraryResolver:n,console:r.console?r.console:U,timeReference:null!==(t=r.timeReference)&&void 0!==t?t:null,lrucache:r.lrucache,interceptor:r.interceptor,depthCounter:{depth:1}},a=N(i,e);if(a instanceof p.ReturnResult&&(a=a.value),a instanceof p.ImplicitResult&&(a=a.value),a===p.voidOperation&&(a=null),a===p.breakResult)throw new s.ArcadeExecutionError(i,s.ExecutionErrorCodes.IllegalResult,null);if(a===p.continueResult)throw new s.ArcadeExecutionError(i,s.ExecutionErrorCodes.IllegalResult,null);if(p.isFunctionParameter(a))throw new s.ArcadeExecutionError(i,s.ExecutionErrorCodes.IllegalResult,null);return a}}));