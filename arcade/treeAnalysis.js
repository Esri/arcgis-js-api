// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator"],(function(e,t,n,a){"use strict";for(var r in Object.defineProperty(t,"__esModule",{value:!0}),t.scriptUsesFeatureSet=t.findScriptDependencies=t.findFunctionCalls=t.checkScript=t.extractAllIssues=t.extractAllIssuesInFunction=t.makeError=t.nodeErrorMessage=t.validateLanguage=t.validateScript=t.constructGlobalScope=t.validateFunction=t.extractFunctionDeclaration=t.findExpectedFieldLiterals=t.findFieldLiterals=t.referencesFunction=t.referencesMember=t.testValidityOfExpression=t.validateLanguageNode=t.walk=t.findFunction=t.checkFunctionSignature=t.addFunctionDeclaration=t.functionDecls=void 0,t.functionDecls={all:{min:"2",max:"2"},none:{min:"2",max:"2"},any:{min:"2",max:"2"},reduce:{min:"2",max:"3"},map:{min:"2",max:"2"},filter:{min:"2",max:"2"},fromcodepoint:{min:"1",max:"*"},fromcharcode:{min:"1",max:"*"},tocodepoint:{min:"1",max:"2"},tocharcode:{min:"1",max:"2"},concatenate:{min:"0",max:"*"},expects:{min:"1",max:"*"},getfeatureset:{min:"1",max:"2"},week:{min:"1",max:"2"},fromjson:{min:"1",max:"1"},length3d:{min:"1",max:"2"},tohex:{min:"1",max:"1"},hash:{min:"1",max:"1"},isoweek:{min:"1",max:"1"},isoweekday:{min:"1",max:"1"},isomonth:{min:"1",max:"1"},isoyear:{min:"1",max:"1"},resize:{min:"2",max:"3"},slice:{min:"0",max:"*"},splice:{min:"0",max:"*"},push:{min:"2",max:"2"},pop:{min:"1",max:"1"},includes:{min:"2",max:"2"},array:{min:"1",max:"2"},front:{min:"1",max:"1"},back:{min:"1",max:"1"},insert:{min:"3",max:"3"},erase:{min:"2",max:"2"},split:{min:"2",max:"4"},guid:{min:"0",max:"1"},today:{min:"0",max:"0"},angle:{min:"2",max:"3"},bearing:{min:"2",max:"3"},urlencode:{min:"1",max:"1"},now:{min:"0",max:"0"},timestamp:{min:"0",max:"0"},day:{min:"1",max:"1"},month:{min:"1",max:"1"},year:{min:"1",max:"1"},hour:{min:"1",max:"1"},second:{min:"1",max:"1"},millisecond:{min:"1",max:"1"},minute:{min:"1",max:"1"},weekday:{min:"1",max:"1"},toutc:{min:"1",max:"1"},tolocal:{min:"1",max:"1"},date:{min:"0",max:"7"},datediff:{min:"2",max:"3"},dateadd:{min:"2",max:"3"},trim:{min:"1",max:"1"},text:{min:"1",max:"2"},left:{min:"2",max:"2"},right:{min:"2",max:"2"},mid:{min:"2",max:"3"},upper:{min:"1",max:"1"},proper:{min:"1",max:"2"},lower:{min:"1",max:"1"},find:{min:"2",max:"3"},iif:{min:"3",max:"3"},decode:{min:"2",max:"*"},when:{min:"2",max:"*"},defaultvalue:{min:"2",max:"2"},isempty:{min:"1",max:"1"},domaincode:{min:"2",max:"4"},domainname:{min:"2",max:"4"},polygon:{min:"1",max:"1"},point:{min:"1",max:"1"},polyline:{min:"1",max:"1"},extent:{min:"1",max:"1"},multipoint:{min:"1",max:"1"},ringisclockwise:{min:"1",max:"1"},geometry:{min:"1",max:"1"},count:{min:"0",max:"*"},number:{min:"1",max:"2"},acos:{min:"1",max:"1"},asin:{min:"1",max:"1"},atan:{min:"1",max:"1"},atan2:{min:"2",max:"2"},ceil:{min:"1",max:"2"},floor:{min:"1",max:"2"},round:{min:"1",max:"2"},cos:{min:"1",max:"1"},exp:{min:"1",max:"1"},log:{min:"1",max:"1"},min:{min:"0",max:"*"},constrain:{min:"3",max:"3"},console:{min:"0",max:"*"},max:{min:"0",max:"*"},pow:{min:"2",max:"2"},random:{min:"0",max:"0"},sqrt:{min:"1",max:"1"},sin:{min:"1",max:"1"},tan:{min:"1",max:"1"},abs:{min:"1",max:"1"},isnan:{min:"1",max:"1"},stdev:{min:"0",max:"*"},average:{min:"0",max:"*"},mean:{min:"0",max:"*"},sum:{min:"0",max:"*"},variance:{min:"0",max:"*"},distinct:{min:"0",max:"*"},first:{min:"1",max:"1"},top:{min:"2",max:"2"},boolean:{min:"1",max:"1"},dictionary:{min:"0",max:"*"},typeof:{min:"1",max:"1"},reverse:{min:"1",max:"1"},replace:{min:"3",max:"4"},sort:{min:"1",max:"2"},feature:{min:"1",max:"*"},haskey:{min:"2",max:"2"},indexof:{min:"2",max:"2"},disjoint:{min:"2",max:"2"},intersects:{min:"2",max:"2"},touches:{min:"2",max:"2"},crosses:{min:"2",max:"2"},within:{min:"2",max:"2"},contains:{min:"2",max:"2"},overlaps:{min:"2",max:"2"},equals:{min:"2",max:"2"},relate:{min:"3",max:"3"},intersection:{min:"2",max:"2"},union:{min:"1",max:"2"},difference:{min:"2",max:"2"},symmetricdifference:{min:"2",max:"2"},clip:{min:"2",max:"2"},cut:{min:"2",max:"2"},area:{min:"1",max:"2"},areageodetic:{min:"1",max:"2"},length:{min:"1",max:"2"},lengthgeodetic:{min:"1",max:"2"},distancegeodetic:{min:"2",max:"3"},distance:{min:"2",max:"3"},densify:{min:"2",max:"3"},densifygeodetic:{min:"2",max:"3"},generalize:{min:"2",max:"4"},buffer:{min:"2",max:"3"},buffergeodetic:{min:"2",max:"3"},offset:{min:"2",max:"6"},rotate:{min:"2",max:"3"},issimple:{min:"1",max:"1"},simplify:{min:"1",max:"1"},centroid:{min:"1",max:"1"},isselfintersecting:{min:"1",max:"1"},multiparttosinglepart:{min:"1",max:"1"},setgeometry:{min:"2",max:"2"},portal:{min:"1",max:"1"},getuser:{min:"1",max:"2"},subtypes:{min:"1",max:"1"},subtypecode:{min:"1",max:"1"},subtypename:{min:"1",max:"1"},domain:{min:"2",max:"3"},convertdirection:{min:"3",max:"3"},schema:{min:"1",max:"1"}},t.functionDecls)t.functionDecls[r].fmin=t.functionDecls[r].min,t.functionDecls[r].fmax=t.functionDecls[r].max;var i=["featureset","getuser","featuresetbyid","featuresetbyname","featuresetbyassociation","featuresetbyrelationshipname","featuresetbyurl","getfeatureset","attachments","featuresetbyportalitem"],s=["disjoint","intersects","touches","crosses","within","contains","overlaps","equals","relate","intersection","union","difference","symmetricdifference","clip","cut","area","areageodetic","length","length3d","lengthgeodetic","distance","distancegeodetic","densify","densifygeodetic","generalize","buffer","buffergeodetic","offset","rotate","issimple","simplify","multiparttosinglepart"];function o(e){return"string"==typeof e||e instanceof String}function c(e,t){return"0"!==e.min&&t.length<Number(e.min)?-2:"*"!==e.max&&t.length>Number(e.max)?-2:1}function l(e,t,n){if(null!==n.localScope&&void 0!==n.localScope[e.toLowerCase()]){if("FormulaFunction"===(a=n.localScope[e.toLowerCase()]).type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),c(a.signature,t);if("any"===a.type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),c(a.signature,t)}if(void 0!==n.globalScope[e.toLowerCase()]){var a;if("FormulaFunction"===(a=n.globalScope[e.toLowerCase()]).type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),c(a.signature,t);if("any"===a.type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),c(a.signature,t)}return-1}function m(e,t){if(e)for(var n=0,a=e;n<a.length;n++){u(a[n],t)}}function u(e,t){if(e&&!1!==t(e))switch(e.type){case"ArrayExpression":m(e.elements,t);break;case"AssignmentExpression":case"BinaryExpression":u(e.left,t),u(e.right,t);break;case"BlockStatement":m(e.body,t);break;case"BreakStatement":break;case"CallExpression":u(e.callee,t),m(e.arguments,t);break;case"ContinueStatement":case"EmptyStatement":break;case"ExpressionStatement":u(e.expression,t);break;case"ForInStatement":u(e.left,t),u(e.right,t),u(e.body,t);break;case"ForStatement":u(e.init,t),u(e.test,t),u(e.update,t),u(e.body,t);break;case"FunctionDeclaration":u(e.id,t),m(e.params,t),u(e.body,t);break;case"Identifier":break;case"IfStatement":u(e.test,t),u(e.consequent,t),u(e.alternate,t);break;case"Literal":break;case"LogicalExpression":u(e.left,t),u(e.right,t);break;case"MemberExpression":u(e.object,t),u(e.property,t);break;case"ObjectExpression":m(e.properties,t);break;case"Program":m(e.body,t);break;case"Property":u(e.key,t),u(e.value,t);break;case"ReturnStatement":case"UnaryExpression":case"UpdateExpression":u(e.argument,t);break;case"VariableDeclaration":m(e.declarations,t);break;case"VariableDeclarator":u(e.id,t),u(e.init,t);break;case"TemplateLiteral":m(e.expressions,t),m(e.quasis,t)}}function p(e,t){void 0===t&&(t=!0);var n=S(e,"SYNTAX","UNREOGNISED");try{switch(e.type){case"VariableDeclarator":return"Identifier"!==e.id.type?S(e,"SYNTAX","VARIABLEMUSTHAVEIDENTIFIER"):null!==e.init?p(e.init,!1):"";case"VariableDeclaration":for(var a=0;a<e.declarations.length;a++)if(""!==(n=p(e.declarations[a],t)))return n;return"";case"ForInStatement":if(""!==(n=p(e.left,t)))return n;if("VariableDeclaration"===e.left.type){if(e.left.declarations.length>1)return S(e,"SYNTAX","ONLY1VAR");if(null!==e.left.declarations[0].init)return S(e,"SYNTAX","CANNOTDECLAREVAL")}else if("Identifier"!==e.left.type)return S(e,"SYNTAX","LEFTNOTVAR");return""!==(n=p(e.right,t))?n:""!==(n=p(e.body,t))?n:"";case"ForStatement":return null!==e.test&&""!==(n=p(e.test,t))?n:null!==e.init&&""!==(n=p(e.init,t))?n:null!==e.update&&""!==(n=p(e.update,t))?n:null!==e.body&&""!==(n=p(e.body,t))?n:"";case"ContinueStatement":case"EmptyStatement":case"BreakStatement":return"";case"IfStatement":return""!==(n=p(e.test,t))?n:null!==e.consequent&&""!==(n=p(e.consequent,!1))?n:null!==e.alternate&&""!==(n=p(e.alternate,!1))?n:"";case"BlockStatement":var r=[];for(a=0;a<e.body.length;a++)"EmptyStatement"!==e.body[a].type&&r.push(e.body[a]);e.body=r;for(a=0;a<e.body.length;a++)if(""!==(n=p(e.body[a],t)))return n;return"";case"FunctionDeclaration":return!1===t?S(e,"SYNTAX","GLOBALFUNCTIONSONLY"):"Identifier"!==e.id.type?S(e,"SYNTAX","FUNCTIONMUSTHAVEIDENTIFIER"):p(e.body,!1);case"ReturnStatement":return null!==e.argument?p(e.argument,t):"";case"UpdateExpression":return"Identifier"!==e.argument.type&&"MemberExpression"!==e.argument.type?S(e,"SYNTAX","ASSIGNMENTTOVARSONLY"):p(e.argument,t);case"AssignmentExpression":if("Identifier"!==e.left.type&&"MemberExpression"!==e.left.type)return S(e,"SYNTAX","ASSIGNMENTTOVARSONLY");if(""!==(n=p(e.left,t)))return n;switch(e.operator){case"=":case"/=":case"*=":case"%=":case"+=":case"-=":break;default:return S(e,"SYNTAX","OPERATORNOTRECOGNISED")}return p(e.right,!1);case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?p(e.expression,!1):(e.expression.type,p(e.expression,!1));case"Identifier":n="";break;case"MemberExpression":return""!==(n=p(e.object,t))?n:!0===e.computed?p(e.property,t):"";case"Literal":case"TemplateElement":return"";case"CallExpression":if("Identifier"!==e.callee.type)return S(e,"SYNTAX","ONLYNODESSUPPORTED");n="";for(a=0;a<e.arguments.length;a++)if(""!==(n=p(e.arguments[a],t)))return n;return"";case"UnaryExpression":n=p(e.argument,t);break;case"BinaryExpression":if(""!==(n=p(e.left,t)))return n;if(""!==(n=p(e.right,t)))return n;switch(e.operator){case"|":case"&":case">>":case"<<":case">>>":case"^":case"==":case"!=":case"<":case"<=":case">":case">=":case"+":case"-":case"*":case"/":case"%":break;default:return S(e,"SYNTAX","OPERATORNOTRECOGNISED")}return"";case"LogicalExpression":if(""!==(n=p(e.left,t)))return n;if(""!==(n=p(e.right)))return n;switch(e.operator){case"&&":case"||":break;default:return S(e,"SYNTAX","OPERATORNOTRECOGNISED")}return"";case"ArrayExpression":n="";for(a=0;a<e.elements.length;a++)if(""!==(n=p(e.elements[a],t)))return n;return n;case"TemplateLiteral":n="";for(a=0;a<e.quasis.length;a++)if(""!==(n=p(e.quasis[a],t)))return n;for(a=0;a<e.expressions.length;a++)if(""!==(n=p(e.expressions[a],t)))return n;return n;case"ObjectExpression":n="";for(a=0;a<e.properties.length;a++){if(n="",null!==e.properties[a].key&&("Literal"!==e.properties[a].key.type&&"Identifier"!==e.properties[a].key.type&&(n=S(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING")),"Literal"===e.properties[a].key.type)){var i=e.properties[a].key,s="value"in i?i.value:null;"string"==typeof s||s instanceof String||(n=S(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING"))}if(""===n&&(n=p(e.properties[a],t)),""!==n)return n}return n;case"Property":return"Literal"!==e.key.type&&"Identifier"!==e.key.type?S(e,"SYNTAX","ONLYLITERAL"):"Identifier"!==e.key.type&&""!==(n=p(e.key,t))?n:n=p(e.value,t);default:return n}return n}catch(e){throw e}}function d(e,t){var n=S(e,"SYNTAX","UNREOGNISED"),a=null,r="";try{switch(e.type){case"VariableDeclarator":var i=null===e.init?"":d(e.init,t);return""!==i?i:("Identifier"===e.id.type&&(null===t.localScope?t.globalScope[e.id.name.toLowerCase()]={type:"any"}:t.localScope[e.id.name.toLowerCase()]={type:"any"}),"");case"FunctionDeclaration":return a=y(e.id.name.toLowerCase(),e),""!==(r=x(e,t))?r:null!==t.localScope?S(e,"SYNTAX","GLOBALFUNCTIONSONLY"):(a.isnative=!1,t.globalScope[e.id.name.toLowerCase()]={type:"FormulaFunction",signature:[a]},"");case"VariableDeclaration":n="";for(var s=0;s<e.declarations.length;s++)if(""!==(n=d(e.declarations[s],t)))return n;return n;case"IfStatement":return""!==(n=d(e.test,t))?n:"AssignmentExpression"===e.test.type||"UpdateExpression"===e.test.type?S(e.test,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"):null!==e.consequent&&""!==(n=d(e.consequent,t))?n:null!==e.alternate&&""!==(n=d(e.alternate,t))?n:"";case"EmptyStatement":return"";case"BlockStatement":for(s=0;s<e.body.length;s++)if(""!==(n=d(e.body[s],t)))return n;return"";case"ReturnStatement":return null!==e.argument?d(e.argument,t):"";case"ForInStatement":if("VariableDeclaration"===e.left.type){if(e.left.declarations.length>1)return S(e,"SYNTAX","ONLY1VAR");if(null!==e.left.declarations[0].init)return S(e,"SYNTAX","CANNOTDECLAREVAL")}else if("Identifier"!==e.left.type)return S(e,"SYNTAX","LEFTNOTVAR");return""!==(n=d(e.left,t))?n:""!==(n=d(e.right,t))?n:""!==(n=d(e.body,t))?n:"";case"ForStatement":return null!==e.init&&""!==(n=d(e.init,t))?n:null!==e.test&&""!==(n=d(e.test,t))?n:null!==e.body&&""!==(n=d(e.body,t))?n:null!==e.update&&""!==(n=d(e.update,t))?n:"";case"BreakStatement":case"ContinueStatement":return"";case"UpdateExpression":if("Identifier"!==e.argument.type&&"MemberExpression"!==e.argument.type)return S(e,"SYNTAX","ASSIGNMENTTOVARSONLY");var o=!1;return"MemberExpression"===e.argument.type?d(e.argument,t):(null!==t.localScope&&void 0!==t.localScope[e.argument.name.toLowerCase()]&&(o=!0),void 0!==t.globalScope[e.argument.name.toLowerCase()]&&(o=!0),!1===o?"Identifier "+e.argument.name+" has not been declared.":"");case"AssignmentExpression":if("Identifier"!==e.left.type&&"MemberExpression"!==e.left.type)return S(e,"SYNTAX","ASSIGNMENTTOVARSONLY");var c=d(e.right,t);if(""!==c)return c;o=!1;return"MemberExpression"===e.left.type?""!==(c=d(e.left,t))?c:"":(null!==t.localScope&&void 0!==t.localScope[e.left.name.toLowerCase()]&&(o=!0),void 0!==t.globalScope[e.left.name.toLowerCase()]&&(o=!0),!1===o?"Identifier "+e.left.name+" has not been declared.":"");case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?d(e.expression,t):(e.expression.type,d(e.expression,t));case"Identifier":var m=e.name.toLowerCase();if(null!==t.localScope&&void 0!==t.localScope[m])return"";n=void 0!==t.globalScope[m]?"":S(e,"SYNTAX","VARIABLENOTFOUND");break;case"MemberExpression":return""!==(n=d(e.object,t))?n:!0===e.computed?d(e.property,t):"";case"Literal":case"TemplateElement":return"";case"CallExpression":if("Identifier"!==e.callee.type)return S(e,"SYNTAX","ONLYNODESSUPPORTED");n="";for(s=0;s<e.arguments.length;s++)if(""!==(n=d(e.arguments[s],t)))return n;var u=l(e.callee.name,e.arguments,t);-1===u&&(n=S(e,"SYNTAX","NOTFOUND")),-2===u&&(n=S(e,"SYNTAX","WRONGSIGNATURE"));break;case"UnaryExpression":n=d(e.argument,t);break;case"BinaryExpression":return""!==(n=d(e.left,t))?n:""!==(n=d(e.right,t))?n:"";case"LogicalExpression":return""!==(n=d(e.left,t))?n:"AssignmentExpression"===e.left.type||"UpdateExpression"===e.left.type?S(e.left,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"):""!==(n=d(e.right,t))?n:"AssignmentExpression"===e.right.type||"UpdateExpression"===e.right.type?S(e.right,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"):"";case"ArrayExpression":n="";for(s=0;s<e.elements.length;s++)if(""!==(n=d(e.elements[s],t)))return n;return n;case"TemplateLiteral":n="";for(s=0;s<e.quasis.length;s++)if(""!==(n=d(e.quasis[s],t)))return n;for(s=0;s<e.expressions.length;s++)if(""!==(n=d(e.expressions[s],t)))return n;return n;case"ObjectExpression":n="";for(s=0;s<e.properties.length;s++){if(n="",null!==e.properties[s].key&&("Literal"!==e.properties[s].key.type&&"Identifier"!==e.properties[s].key.type&&(n=S(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING")),"Literal"===e.properties[s].key.type)){var p=e.properties[s].key,f="value"in p?p.value:null;"string"==typeof f||f instanceof String||(n=S(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING"))}if(""===n&&(n=d(e.properties[s],t)),""!==n)return n}return n;case"Property":return"Literal"!==e.key.type&&"Identifier"!==e.key.type?S(e,"SYNTAX","ONLYLITERAL"):"Identifier"!==e.key.type&&""!==(n=d(e.key,t))?n:n=d(e.value,t);case"Program":default:return n}return n}catch(e){throw e}}function f(e,t){var n=!1,a=t.toLowerCase();return u(e,(function(e){return!n&&("Identifier"===e.type&&e.name&&e.name.toLowerCase()===a&&(n=!0),!0)})),n}function y(e,t){var n=[];if(void 0!==t.params&&null!==t.params)for(var a=0;a<t.params.length;a++)n.push("any");return{name:e,return:"any",params:n}}function x(e,t){for(var n={globalScope:t.globalScope,localScope:{}},a=0;a<e.params.length;a++){var r=e.params[a].name;n.localScope[r.toLowerCase()]={type:"any"}}return d(e.body,n)}function N(e,t,n,a){var r={};for(var i in null==e&&(e={}),null==n&&(n={}),r.infinity={type:"any"},r.textformatting={type:"any"},r.pi={type:"any"},t)"sync"===a&&void 0!==t[i].min?r[i]={type:"FormulaFunction",signature:{min:t[i].min,max:t[i].max}}:"sync"!==a&&void 0!==t[i].fmin&&(r[i]={type:"FormulaFunction",signature:{min:t[i].fmin,max:t[i].fmax}});for(var s=0;s<n.length;s++){r[(i=n[s]).name]={type:"FormulaFunction",signature:i}}for(var i in e)r[i]=e[i],r[i].type="any";return r}function S(e,t,n){var a="";switch(t){case"SYNTAX":a="Syntax Error: ";break;case"RUNTIME":a="Runtime Error: ";break;default:a="Syntax Error: "}try{switch(e.type){case"IfStatement":switch(n){case"CANNOT_USE_ASSIGNMENT_IN_CONDITION":a+=" Assignments not be made in logical tests";break;case"CANNOT_USE_NONBOOLEAN_IN_CONDITION":a+=" Non Boolean used as Condition"}break;case"UpdateExpression":case"AssignmentExpression":switch(n){case"CANNOT_USE_ASSIGNMENT_IN_CONDITION":a+=" Assignments not be made in logical tests";break;case"ASSIGNMENTTOVARSONLY":a+=" Assignments can only be made to identifiers"}break;case"ExpressionStatement":a+=" Assignments can only be made to identifiers";break;case"FunctionDeclaration":switch(n){case"GLOBALFUNCTIONSONLY":a+=" Functions cannot be declared as variables";break;case"FUNCTIONMUSTHAVEIDENTIFIER":a+=" Function Definition must have an identifier"}break;case"VariableDeclaration":a+=" Only 1 variable can be declared at a time";break;case"VariableDeclarator":switch(n){case"FUNCTIONVARIABLEDECLARATOR":a+=" Functions cannot be declared as variables";break;case"VARIABLEMUSTHAVEIDENTIFIER":a+=" Variable Definition must have an identifier"}break;case"Identifier":a+=" Identifier Not Found. ",a+=e.name;break;case"ObjectExpression":switch(n){case"OBJECTPROPERTYMUSTBESTRING":a+=" Property name must be a string"}break;case"ForStatement":switch(n){case"CANNOT_USE_NONBOOLEAN_IN_CONDITION":a+=" Non Boolean used as Condition"}break;case"ForInStatement":switch(n){case"ONLY1VAR":a+=" Can only declare 1 var for use with IN";break;case"CANNOTDECLAREVAL":a+=" Can only declare value for use with IN";break;case"LEFTNOVAR":a+="Must provide a variable to iterate with.";break;case"VARIABLENOTDECLARED":a+="Variable must be declared before it is used..";break;case"CANNOTITERATETHISTYPE":a+="This type cannot be used in an IN loop"}break;case"MemberExpression":switch(n){case"PROPERTYNOTFOUND":a+="Cannot find member property. ",a+=!1===e.computed&&"Identifier"===e.property.type?e.property.name:"";break;case"OUTOFBOUNDS":a+="Out of Bounds. ",a+=!1===e.computed&&"Identifier"===e.property.type?e.property.name:"";break;case"NOTFOUND":a+="Cannot call member method on null. ",a+=!1===e.computed&&"Identifier"===e.property.type?e.property.name:"";break;case"INVALIDTYPE":a+="Cannot call member property on object of this type. ",a+=!1===e.computed&&"Identifier"===e.property.type?e.property.name:""}break;case"Property":switch(n){case"ONLYLITERAL":a+="Property names must be literals or identifiers"}break;case"Literal":break;case"CallExpression":switch(n){case"WRONGSIGNATURE":a+="Function signature does not match: ",a+="Identifier"===e.callee.type?e.callee.name:"";break;case"ONLYNODESUPPORTED":a+="Functions must be declared.",a+="Identifier"===e.callee.type?e.callee.name:"";break;case"NOTAFUNCTION":a+="Not a Function: ",a+="Identifier"===e.callee.type?e.callee.name:"";break;case"NOTFOUND":a+="Function Not Found: "+("Identifier"===e.callee.type?e.callee.name:"")}break;case"UnaryExpression":switch(n){case"NOTSUPPORTEDUNARYOPERATOR":a+="Operator "+e.operator+" not allowed in this context. Only ! can be used with boolean, and - with a number";break;case"NOTSUPPORTEDTYPE":a+="Unary operator "+e.operator+" cannot be used with this argument."}case"BinaryExpression":switch(n){case"OPERATORNOTRECOGNISED":a+="Binary Operator not recognised "+e.operator}break;case"LogicalExpression":switch(n){case"ONLYBOOLEAN":a+="Operator "+e.operator+" cannot be used. Only || or && are allowed values";break;case"ONLYORORAND":a+="Logical Expression "+e.operator+" being applied to parameters that are not boolean."}break;case"ArrayExpression":switch(n){case"FUNCTIONCONTEXTILLEGAL":a+=" Cannot Put Function inside Array."}break;default:a+="Expression contains unrecognised code structures."}}catch(e){throw e}return a}function E(e,t,n){return{line:e.loc.start.line,character:e.loc.start.column,reason:S(e,t,n)}}function b(e,t,n,a){for(var r={globalScope:t.globalScope,localScope:{}},i=0;i<e.params.length;i++){var s=e.params[i].name;r.localScope[s.toLowerCase()]={type:"any"}}g(e.body,r,n,a,!1)}function g(e,t,n,a,r){if(void 0===r&&(r=!0),null===e)throw new Error("Unnexpexted Expression Syntax");var i=null;try{switch(e.type){case"VariableDeclarator":return"Identifier"!==e.id.type?a.push(E(e,"SYNTAX","VARIABLEMUSTHAVEIDENTIFIER")):(null!==t.localScope?t.localScope[e.id.name.toLowerCase()]:t.globalScope[e.id.name.toLowerCase()],null===t.localScope?t.globalScope[e.id.name.toLowerCase()]={type:"any"}:t.localScope[e.id.name.toLowerCase()]={type:"any"}),void(null!==e.init&&g(e.init,t,n,a,r));case"FunctionDeclaration":return!1===r&&a.push(E(e,"SYNTAX","GLOBALFUNCTIONSONLY")),"Identifier"!==e.id.type&&a.push(E(e,"SYNTAX","FUNCTIONMUSTHAVEIDENTIFIER")),i=y("",e),b(e,t,n,a),null!==t.localScope&&a.push(E(e,"SYNTAX","GLOBALFUNCTIONSONLY")),i.isnative=!1,void("Identifier"===e.id.type&&(t.globalScope[e.id.name.toLowerCase()]={type:"FormulaFunction",signature:[i]}));case"VariableDeclaration":for(var s=0;s<e.declarations.length;s++)g(e.declarations[s],t,n,a,r);return;case"IfStatement":return null!==e.test&&(g(e.test,t,n,a,r),"AssignmentExpression"!==e.test.type&&"UpdateExpression"!==e.test.type||a.push(E(e.test,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),null!==e.consequent&&g(e.consequent,t,n,a,r),void(null!==e.alternate&&g(e.alternate,t,n,a,r));case"EmptyStatement":return;case"BlockStatement":if(null!==e.body)for(s=0;s<e.body.length;s++)g(e.body[s],t,n,a,r);return;case"ReturnStatement":return void(null!==e.argument&&g(e.argument,t,n,a,r));case"ForInStatement":return"VariableDeclaration"===e.left.type?(e.left.declarations.length>1&&a.push(E(e,"SYNTAX","ONLY1VAR")),null!==e.left.declarations[0].init&&a.push(E(e,"SYNTAX","CANNOTDECLAREVAL"))):"Identifier"!==e.left.type&&a.push(E(e,"SYNTAX","LEFTNOTVAR")),g(e.left,t,n,a,r),g(e.right,t,n,a,r),void g(e.body,t,n,a,r);case"ForStatement":return null!==e.init&&g(e.init,t,n,a,r),null!==e.test&&g(e.test,t,n,a,r),null!==e.body&&g(e.body,t,n,a,r),void(null!==e.update&&g(e.update,t,n,a,r));case"BreakStatement":case"ContinueStatement":return;case"UpdateExpression":if("Identifier"!==e.argument.type&&"MemberExpression"!==e.argument.type)a.push(E(e,"SYNTAX","ASSIGNMENTTOVARSONLY"));else{if("Identifier"===e.argument.type){var o=!1;!1===n&&(null!==t.localScope&&void 0!==t.localScope[e.argument.name.toLowerCase()]&&(o=!0),void 0!==t.globalScope[e.argument.name.toLowerCase()]&&(o=!0),!1===o&&a.push({line:null===e?0:e.loc.start.line,character:null===e?0:e.loc.start.column,reason:"Identifier "+e.argument.name+" has not been declared."}))}"MemberExpression"===e.argument.type&&g(e.argument,t,n,a,r)}return;case"AssignmentExpression":switch("Identifier"!==e.left.type&&"MemberExpression"!==e.left.type&&a.push(E(e,"SYNTAX","ASSIGNMENTTOVARSONLY")),e.operator){case"=":case"/=":case"*=":case"%=":case"+=":case"-=":break;default:a.push(E(e,"SYNTAX","OPERATORNOTRECOGNISED"))}g(e.right,t,n,a,r);o=!1;return"Identifier"===e.left.type&&(null!==t.localScope&&void 0!==t.localScope[e.left.name.toLowerCase()]&&(o=!0),void 0!==t.globalScope[e.left.name.toLowerCase()]&&(o=!0),!1===n&&!1===o&&a.push({line:null===e?0:e.loc.start.line,character:null===e?0:e.loc.start.column,reason:"Identifier "+e.left.name+" has not been declared."})),void("MemberExpression"===e.left.type&&g(e.left,t,n,a,r));case"ExpressionStatement":return void("AssignmentExpression"===e.expression.type?g(e.expression,t,n,a,r):(e.expression.type,g(e.expression,t,n,a,r)));case"Identifier":var c=e.name.toLowerCase();if(null!==t.localScope&&void 0!==t.localScope[c])return;if(void 0!==t.globalScope[c])return;!1===n&&a.push(E(e,"SYNTAX","VARIABLENOTFOUND"));break;case"MemberExpression":return g(e.object,t,n,a,r),void(!0===e.computed&&g(e.property,t,n,a,r));case"Literal":case"TemplateElement":return;case"CallExpression":"Identifier"!==e.callee.type&&a.push(E(e,"SYNTAX","ONLYNODESSUPPORTED"));for(s=0;s<e.arguments.length;s++)g(e.arguments[s],t,n,a,r);if("Identifier"===e.callee.type){var m=l(e.callee.name,e.arguments,t);!1===n&&-1===m&&a.push(E(e,"SYNTAX","NOTFOUND")),-2===m&&a.push(E(e,"SYNTAX","WRONGSIGNATURE"))}return;case"UnaryExpression":return void g(e.argument,t,n,a,r);case"BinaryExpression":switch(g(e.left,t,n,a,r),g(e.right,t,n,a,r),e.operator){case"==":case"!=":case"<":case"<=":case">":case">=":case"+":case"-":case"*":case"/":case"%":case"&":case"|":case"^":case"<<":case">>":case">>>":break;default:a.push(E(e,"SYNTAX","OPERATORNOTRECOGNISED"))}return;case"LogicalExpression":switch(e.operator){case"&&":case"||":break;default:a.push(E(e,"SYNTAX","OPERATORNOTRECOGNISED"))}return g(e.left,t,n,a,r),"AssignmentExpression"!==e.left.type&&"UpdateExpression"!==e.left.type||a.push(E(e,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION")),g(e.right,t,n,a,r),void("AssignmentExpression"!==e.right.type&&"UpdateExpression"!==e.right.type||a.push(E(e,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION")));case"ArrayExpression":for(s=0;s<e.elements.length;s++)g(e.elements[s],t,n,a,r);return;case"TemplateLiteral":for(s=0;s<e.quasis.length;s++)g(e.quasis[s],t,n,a,r);for(s=0;s<e.expressions.length;s++)g(e.expressions[s],t,n,a,r);return;case"ObjectExpression":for(s=0;s<e.properties.length;s++)g(e.properties[s],t,n,a,r);return;case"Property":return"Literal"!==e.key.type&&"Identifier"!==e.key.type&&a.push(E(e,"SYNTAX","ONLYLITERAL")),"Literal"===e.key.type&&g(e.key,t,n,a,r),void g(e.value,t,n,a,r);default:a.push(E(e,"SYNTAX","UNRECOGNISED"))}return}catch(t){a.push({line:null===e?0:e.loc.start.line,character:null===e?0:e.loc.start.column,reason:"Unnexpected Syntax"})}}function T(e){var t=[];return u(e,(function(e){return"CallExpression"===e.type&&"Identifier"===e.callee.type&&t.push(e.callee.name.toLowerCase()),!0})),t}t.addFunctionDeclaration=function(e,n){var a=t.functionDecls[e.name.toLowerCase()];void 0===a?t.functionDecls[e.name.toLowerCase()]="sync"===n?{min:e.min,max:e.max}:{fmin:e.min,fmax:e.max}:"sync"===n?(a.min=e.min,a.max=e.max):(a.fmin=e.min,a.fmax=e.max)},t.checkFunctionSignature=c,t.findFunction=l,t.walk=u,t.validateLanguageNode=p,t.testValidityOfExpression=d,t.referencesMember=f,t.referencesFunction=function(e,t){var n=!1,a=t.toLowerCase();return u(e,(function(e){return!n&&("CallExpression"!==e.type||"Identifier"!==e.callee.type||!e.callee.name||e.callee.name.toLowerCase()!==a||(n=!0,!1))})),n},t.findFieldLiterals=function(e){var t=[];return u(e,(function(e){return"MemberExpression"!==e.type||"Identifier"!==e.object.type||(!1===e.computed&&e.object&&e.object.name&&e.property&&"Identifier"===e.property.type&&e.property.name?t.push(e.object.name.toLowerCase()+"."+e.property.name.toLowerCase()):e.object&&e.object.name&&e.property&&"Literal"===e.property.type&&"string"==typeof e.property.value&&t.push(e.object.name.toLowerCase()+"."+e.property.value.toString().toLowerCase()),!1)})),t},t.findExpectedFieldLiterals=function(e){var t=[];return u(e,(function(e){if("CallExpression"===e.type){if("Identifier"===e.callee.type&&"expects"===e.callee.name.toLowerCase()){for(var n="",a=0;a<(e.arguments||[]).length;a++)0===a?"Identifier"===e.arguments[a].type&&(n=e.arguments[a].name.toLowerCase()):n&&"Literal"===e.arguments[a].type&&o(e.arguments[a].value)&&t.push(n+"."+e.arguments[a].value.toLowerCase());return!1}if("Identifier"===e.callee.type&&["domainname","domaincode","domain","haskey"].includes(e.callee.name.toLowerCase())&&e.arguments.length>=2){n="";return"Identifier"===e.arguments[0].type&&(n=e.arguments[0].name.toLowerCase()),n&&"Literal"===e.arguments[1].type&&o(e.arguments[1].value)&&t.push(n+"."+e.arguments[1].value.toLowerCase()),!1}}return"MemberExpression"!==e.type||"Identifier"!==e.object.type||(!1===e.computed&&e.object&&e.object.name&&e.property&&"Identifier"===e.property.type&&e.property.name?t.push(e.object.name.toLowerCase()+"."+e.property.name.toLowerCase()):e.object&&e.object.name&&e.property&&"Literal"===e.property.type&&"string"==typeof e.property.value&&t.push(e.object.name.toLowerCase()+"."+e.property.value.toString().toLowerCase()),!1)})),t},t.extractFunctionDeclaration=y,t.validateFunction=x,t.constructGlobalScope=N,t.validateScript=function(e,n,a,r){void 0===a&&(a="async"),void 0===r&&(r=t.functionDecls);var i={globalScope:N(n.vars,r,n.customFunctions,a),localScope:null};return d(e.body[0].body,i)},t.validateLanguage=function(e){return"BlockStatement"!==e.body[0].body.type?"Invalid formula content.":p(e.body[0].body)},t.nodeErrorMessage=S,t.makeError=E,t.extractAllIssuesInFunction=b,t.extractAllIssues=g,t.checkScript=function(e,n,a,r,i){void 0===r&&(r="async"),void 0===i&&(i=t.functionDecls);var s=[];if("BlockStatement"!==e.body[0].body.type)return[{line:0,character:0,reason:"Invalid Body"}];null==n&&(n={vars:{},customFunctions:[]});var o={globalScope:N(n.vars,i,n.customFunctions,r),localScope:null};try{g(e.body[0].body,o,a,s)}catch(e){}return s},t.findFunctionCalls=T,t.findScriptDependencies=function(e,t){void 0===t&&(t=[]);var n=null;if(void 0===e.usesFeatureSet){null===n&&(n=T(e)),e.usesFeatureSet=!1;for(var a=0;a<n.length;a++)i.includes(n[a])&&(e.usesFeatureSet=!0,e.isAsync=!0);if(!1===e.usesFeatureSet&&t&&t.length>0)for(var r=0,o=t;r<o.length;r++){if(f(e,o[r])){e.usesFeatureSet=!0,e.isAsync=!0;break}}}if(void 0===e.usesGeometry){e.usesGeometry=!1,null===n&&(n=T(e));for(a=0;a<n.length;a++)s.includes(n[a])&&(e.usesGeometry=!0)}},t.scriptUsesFeatureSet=function(e){for(var t=T(e),n=0;n<t.length;n++)if(i.includes(t[n]))return!0;return!1}}));