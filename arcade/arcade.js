// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator","./arcadeCompiler","./arcadeRuntime","./parser","./treeAnalysis","dojo/has"],(function(e,t,n,r,i,u,c,s,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.featureSetUtils=t.scriptTouchesGeometry=t.loadScriptDependencies=t.scriptIsAsync=t.scriptUsesFeatureSet=t.enableFeatureSetSupportImpl=t.enableFeatureSetSupport=t.isGeometryEnabled=t.isAsyncEnabled=t.isFeatureSetSupportEnabled=t.enableAsyncSupportImpl=t.enableAsyncSupport=t.enableGeometrySupportImpl=t.enableGeometrySupport=t.scriptUsesGeometryEngine=t.extractExpectedFieldLiterals=t.extractFieldLiterals=t.referencesFunction=t.referencesMember=t.executeScript=t.parseAndExecuteScript=t.scriptCheck=t.validateScript=t.parseScript=t.extend=t.compileScript=void 0;var a=["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"];var p=function(){if(o("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}(),l=!1,f=!1,d=null,S=[];function y(e,t){return void 0===t&&(t=[]),c.parseScript(e,t)}function m(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===d)throw new Error("Async Arcade must be enabled for this script");return d.executeScript(e,t)}return u.executeScript(e,t)}function v(e,t){return u.referencesMember(e,t)}function b(e,t){return void 0===t&&(t=[]),void 0===e.usesGeometry&&s.findScriptDependencies(e,t),!0===e.usesGeometry}t.compileScript=function(e,t){if(!0===t.useAsync||!0===e.isAsync)return function(e,t){if(null===d)throw new Error("Async Arcade must be enabled for this script");if(o("esri-csp-restrictions")||!1===p){return function(t){return d.executeScript(e,t)}}return i.compileScript(e,t,!0)}(e,t);if(o("esri-csp-restrictions")){return function(t){return u.executeScript(e,t)}}return i.compileScript(e,t)},t.extend=function(e){u.extend(e),i.extend(e,"sync"),null===d?S.push(e):(i.extend(e,"async"),d.extend(e))},t.parseScript=y,t.validateScript=function(e,t,n){return void 0===n&&(n=""),c.validateScript(e,t,n)},t.scriptCheck=function(e,t,n,r){return void 0===r&&(r=""),c.scriptCheck(e,t,n,r)},t.parseAndExecuteScript=function(e,t,n){return void 0===n&&(n=[]),m(c.parseScript(e,n),t)},t.executeScript=m,t.referencesMember=v,t.referencesFunction=function(e,t){return u.referencesFunction(e,t)},t.extractFieldLiterals=function(e,t){return void 0===t&&(t=!1),c.extractFieldLiterals(e,t)},t.extractExpectedFieldLiterals=function(e){return c.extractExpectedFieldLiterals(e)},t.scriptUsesGeometryEngine=b;var h=null;function x(){return h||(h=A())}function A(){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,new Promise((function(t,n){e(["../geometry/geometryEngine","./functions/geomsync"],(function(e,n){f=!0,n.setGeometryEngine(e),t(!0)}),(function(e){n(e)}))}))]}))}))}t.enableGeometrySupport=x,t.enableGeometrySupportImpl=A;var F=null;function g(){return null!==F?F:F=E()}function E(){return n(this,void 0,void 0,(function(){var t,n,u;return r(this,(function(r){switch(r.label){case 0:return[4,i.enableAsyncSupport()];case 1:return r.sent(),[4,new Promise((function(t,n){e(["./arcadeAsyncRuntime"],(function(e){t(e)}),n)}))];case 2:for(d=r.sent(),t=0,n=S;t<n.length;t++)u=n[t],d.extend(u),i.extend(u,"async");return S=null,[2,!0]}}))}))}function w(){return l}function G(){return!!d}function I(){return f}t.enableAsyncSupport=g,t.enableAsyncSupportImpl=E,t.isFeatureSetSupportEnabled=w,t.isAsyncEnabled=G,t.isGeometryEnabled=I;var U=null;function L(){return U||(U=k())}function k(){return n(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return[4,g()];case 1:return n.sent(),[4,new Promise((function(t,n){e(["./featureSetUtils","./functions/featuresetbase","./functions/featuresetgeom","./functions/featuresetstats","./functions/featuresetstring"],(function(e,n,r,i,u){t({featuresetutils:e,libraries:[n,r,i,u]})}),n)}))];case 2:return t=n.sent(),D=t.featuresetutils,d.extend(t.libraries),i.extend(t.libraries,"async"),l=!0,[2,!0]}}))}))}function C(e,t){return void 0===t&&(t=[]),void 0===e.usesFeatureSet&&s.findScriptDependencies(e,t),!0===e.usesFeatureSet}t.enableFeatureSetSupport=L,t.enableFeatureSetSupportImpl=k,t.scriptUsesFeatureSet=C,t.scriptIsAsync=function(e,t){return void 0===t&&(t=[]),void 0===e.isAsync&&s.findScriptDependencies(e,t),!0===e.isAsync},t.loadScriptDependencies=function(e,t,i,u){return void 0===i&&(i=[]),void 0===u&&(u=!1),n(this,void 0,void 0,(function(){var n,c;return r(this,(function(r){switch(r.label){case 0:return n="string"==typeof e?y(e):e,c=[],n&&(!1===I()&&(b(n)||u)&&c.push(x()),!1===G()&&(!0===n.isAsync||t)&&c.push(g()),!1===w()&&(C(n)||function(e,t){if(t){for(var n=0,r=t;n<r.length;n++){if(v(e,r[n]))return!0}return!1}return!1}(n,i))&&c.push(L())),c.length?[4,Promise.all(c)]:[3,2];case 1:return r.sent(),[2,!0];case 2:return[2,!0]}}))}))},t.scriptTouchesGeometry=function(e){if(b(e))return!0;for(var t=s.findFunctionCalls(e),n=!1,r=0;r<t.length;r++)if(a.includes(t[r])){n=!0;break}return n};var D=null;t.featureSetUtils=function(){return D}}));