// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.40/esri/copyright.txt for details.

define(["require","exports","./arcadeCompiler","./arcadeRuntime","./parser","./treeAnalysis","dojo/has","./polyfill/promiseUtils"],(function(e,t,n,r,i,c,u,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.featureSetUtils=t.scriptTouchesGeometry=t.loadScriptDependencies=t.scriptIsAsync=t.scriptUsesFeatureSet=t.enableFeatureSetSupport=t.isGeometryEnabled=t.isAsyncEnabled=t.isFeatureSetSupportEnabled=t.enableAsyncSupport=t.enableGeometrySupport=t.scriptUsesGeometryEngine=t.extractExpectedFieldLiterals=t.extractFieldLiterals=t.referencesFunction=t.referencesMember=t.executeScript=t.parseAndExecuteScript=t.scriptCheck=t.validateScript=t.parseScript=t.extend=t.compileScript=void 0;var o=["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"];var a=function(){if(u("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}(),p=!1,f=!1,l=null,d=[];function S(e,t){return void 0===t&&(t=[]),i.parseScript(e,t)}function y(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===l)throw new Error("Async Arcade must be enabled for this script");return l.executeScript(e,t)}return r.executeScript(e,t)}function v(e,t){return r.referencesMember(e,t)}function x(e,t){return void 0===t&&(t=[]),void 0===e.usesGeometry&&c.findScriptDependencies(e,t),!0===e.usesGeometry}t.compileScript=function(e,t){if(!0===t.useAsync||!0===e.isAsync)return function(e,t){if(null===l)throw new Error("Async Arcade must be enabled for this script");if(u("esri-csp-restrictions")||!1===a){return function(t){return l.executeScript(e,t)}}return n.compileScript(e,t,!0)}(e,t);if(u("esri-csp-restrictions")){return function(t){return r.executeScript(e,t)}}return n.compileScript(e,t)},t.extend=function(e){r.extend(e),n.extend(e,"sync"),null===l?d.push(e):(n.extend(e,"async"),l.extend(e))},t.parseScript=S,t.validateScript=function(e,t,n){return void 0===n&&(n=""),i.validateScript(e,t,n)},t.scriptCheck=function(e,t,n,r){return void 0===r&&(r=""),i.scriptCheck(e,t,n,r)},t.parseAndExecuteScript=function(e,t,n){return void 0===n&&(n=[]),y(i.parseScript(e,n),t)},t.executeScript=y,t.referencesMember=v,t.referencesFunction=function(e,t){return r.referencesFunction(e,t)},t.extractFieldLiterals=function(e,t){return void 0===t&&(t=!1),i.extractFieldLiterals(e,t)},t.extractExpectedFieldLiterals=function(e){return i.extractExpectedFieldLiterals(e)},t.scriptUsesGeometryEngine=x;var m=null;function b(){return m||(m=s.create((function(t,n){e(["../geometry/geometryEngine","./functions/geomsync"],(function(e,n){f=!0,n.setGeometryEngine(e),t(!0)}),(function(e){n(e)}))})))}t.enableGeometrySupport=b;var h=null;function A(){return null!==h?h:h=n.enableAsyncSupport().then((function(){return s.create((function(t,r){e(["./arcadeAsyncRuntime"],(function(e){try{l=e;for(var i=0,c=d;i<c.length;i++){var u=c[i];l.extend(u),n.extend(u,"async")}d=null,t(!0)}catch(e){r(e)}}),r)}))}))}function g(){return p}function F(){return!!l}function E(){return f}t.enableAsyncSupport=A,t.isFeatureSetSupportEnabled=g,t.isAsyncEnabled=F,t.isGeometryEnabled=E;var G=null;function U(){return G||(G=A().then((function(){return s.create((function(t,r){e(["./featureSetUtils","./functions/featuresetbase","./functions/featuresetgeom","./functions/featuresetstats","./functions/featuresetstring"],(function(e,i,c,u,s){try{L=e,l.extend([i,c,u,s]),n.extend([i,c,u,s],"async"),p=!0,t(!0)}catch(e){r(e)}}),r)}))})))}function w(e,t){return void 0===t&&(t=[]),void 0===e.usesFeatureSet&&c.findScriptDependencies(e,t),!0===e.usesFeatureSet}t.enableFeatureSetSupport=U,t.scriptUsesFeatureSet=w,t.scriptIsAsync=function(e,t){return void 0===t&&(t=[]),void 0===e.isAsync&&c.findScriptDependencies(e,t),!0===e.isAsync},t.loadScriptDependencies=function(e,t,n,r){return void 0===n&&(n=[]),void 0===r&&(r=!1),s.create((function(i,c){var u="string"==typeof e?S(e):e,o=[];u&&(!1===E()&&(x(u)||r)&&o.push(b()),!1===F()&&(!0===u.isAsync||t)&&o.push(A()),!1===g()&&(w(u)||function(e,t){if(t){for(var n=0,r=t;n<r.length;n++){if(v(e,r[n]))return!0}return!1}return!1}(u,n))&&o.push(U())),o.length?s.all(o).then((function(){i(!0)}),c):i(!0)}))},t.scriptTouchesGeometry=function(e){if(x(e))return!0;for(var t=c.findFunctionCalls(e),n=!1,r=0;r<t.length;r++)if(o.indexOf(t[r])>-1){n=!0;break}return n};var L=null;t.featureSetUtils=function(){return L}}));