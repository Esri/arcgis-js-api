// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator","./arcadeCompiler","./ArcadeModuleResolver","./arcadeRuntime","./executionError","./parser","./treeAnalysis","dojo/has","./polyfill/maybe"],(function(e,t,r,n,i,u,s,c,o,l,a,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.featureSetUtils=t.scriptTouchesGeometry=t.loadDependentModules=t.scriptUsesModules=t._loadScriptDependenciesImpl=t.loadScriptDependencies=t.scriptIsAsync=t.scriptUsesFeatureSet=t.enableFeatureSetSupportImpl=t.enableFeatureSetSupport=t.isGeometryEnabled=t.isAsyncEnabled=t.isFeatureSetSupportEnabled=t.enableAsyncSupportImpl=t.enableAsyncSupport=t.enableGeometrySupportImpl=t.enableGeometrySupport=t.scriptUsesGeometryEngine=t.extractExpectedFieldLiterals=t.extractFieldLiterals=t.referencesFunction=t.referencesMember=t.executeScript=t.parseAndExecuteScript=t.parseScript=t.extend=t.compileScript=void 0;var p=["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"];var f=function(){if(a("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}(),S=!1,y=!1,v=null,m=[];function b(e,t){return void 0===t&&(t=[]),o.parseScript(e,t)}function h(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===v)throw new c.ArcadeExecutionError(null,c.ExecutionErrorCodes.AsyncNotEnabled,null);return v.executeScript(e,t)}return s.executeScript(e,t)}function x(e,t){return l.referencesMember(e,t)}function E(e,t){return void 0===t&&(t=[]),void 0===e.usesGeometry&&l.findScriptDependencies(e,t),!0===e.usesGeometry}t.compileScript=function(e,t){if(!0===t.useAsync||!0===e.isAsync)return function(e,t){if(null===v)throw new c.ArcadeExecutionError(null,c.ExecutionErrorCodes.AsyncNotEnabled,null);if(a("esri-csp-restrictions")||!1===f){return function(t){return v.executeScript(e,t)}}try{return i.compileScript(e,t,!0)}catch(t){if("esri.arcade.arcadeuncompilableerror"===t.declaredRootClass)return function(t){return v.executeScript(e,t)};throw t}}(e,t);if(a("esri-csp-restrictions")){return function(t){return s.executeScript(e,t)}}try{return i.compileScript(e,t)}catch(t){if("esri.arcade.arcadeuncompilableerror"===t.declaredRootClass)return function(t){return s.executeScript(e,t)};throw t}},t.extend=function(e){s.extend(e),i.extend(e,"sync"),null===v?m.push(e):(i.extend(e,"async"),v.extend(e))},t.parseScript=b,t.parseAndExecuteScript=function(e,t,r){return void 0===r&&(r=[]),h(o.parseScript(e,r),t)},t.executeScript=h,t.referencesMember=x,t.referencesFunction=function(e,t){return l.referencesFunction(e,t)},t.extractFieldLiterals=function(e,t){return void 0===t&&(t=!1),void 0===t&&(t=!1),l.findFieldLiterals(e)},t.extractExpectedFieldLiterals=function(e){return l.findExpectedFieldLiterals(e)},t.scriptUsesGeometryEngine=E;var A=null;function g(){return A||(A=F())}function F(){return r(this,void 0,void 0,(function(){return n(this,(function(t){return[2,new Promise((function(t,r){e(["../geometry/geometryEngine","./functions/geomsync"],(function(e,r){y=!0,r.setGeometryEngine(e),t(!0)}),(function(e){r(e)}))}))]}))}))}t.enableGeometrySupport=g,t.enableGeometrySupportImpl=F;var w=null;function M(){return null!==w?w:w=G()}function G(){return r(this,void 0,void 0,(function(){var t,r,u;return n(this,(function(n){switch(n.label){case 0:return[4,i.enableAsyncSupport()];case 1:return n.sent(),[4,new Promise((function(t,r){e(["./arcadeAsyncRuntime"],(function(e){t(e)}),r)}))];case 2:for(v=n.sent(),t=0,r=m;t<r.length;t++)u=r[t],v.extend(u),i.extend(u,"async");return m=null,[2,!0]}}))}))}function I(){return S}function D(){return!!v}function U(){return y}t.enableAsyncSupport=M,t.enableAsyncSupportImpl=G,t.isFeatureSetSupportEnabled=I,t.isAsyncEnabled=D,t.isGeometryEnabled=U;var C=null;function L(){return C||(C=R())}function R(){return r(this,void 0,void 0,(function(){var t;return n(this,(function(r){switch(r.label){case 0:return[4,M()];case 1:return r.sent(),[4,new Promise((function(t,r){e(["./featureSetUtils","./functions/featuresetbase","./functions/featuresetgeom","./functions/featuresetstats","./functions/featuresetstring"],(function(e,r,n,i,u){t({featuresetutils:e,libraries:[r,n,i,u]})}),r)}))];case 2:return t=r.sent(),k=t.featuresetutils,v.extend(t.libraries),i.extend(t.libraries,"async"),S=!0,[2,!0]}}))}))}function P(e,t){return void 0===t&&(t=[]),void 0===e.usesFeatureSet&&l.findScriptDependencies(e,t),!0===e.usesFeatureSet}function _(e,t,i,u,s,c){return void 0===u&&(u=[]),void 0===s&&(s=!1),void 0===c&&(c=null),r(this,void 0,void 0,(function(){var r,o;return n(this,(function(n){switch(n.label){case 0:return r="string"==typeof t?b(t):t,o=[],r&&(!1===U()&&(E(r)||s)&&o.push(g()),!1===D()&&(!0===r.isAsync||i)&&o.push(M()),!1===I()&&(P(r)||function(e,t){if(t){for(var r=0,n=t;r<n.length;r++){if(x(e,n[r]))return!0}return!1}return!1}(r,u))&&o.push(L())),o.length?[4,Promise.all(o)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[4,j(e,r,c,i,s)];case 3:return n.sent(),[2,!0]}}))}))}function j(e,t,i,s,o){return void 0===i&&(i=null),void 0===s&&(s=!1),void 0===o&&(o=!1),r(this,void 0,void 0,(function(){var r,a,p,f,S,y;return n(this,(function(n){switch(n.label){case 0:r=l.findModuleImports(t),null===i&&r.length>0&&(i=u.ArcadeModuleResolver.getDefault()),t.loadedModules={},a=0,p=r,n.label=1;case 1:if(!(a<p.length))return[3,5];if(f=p[a],d.assertIsSome(i),S=i.normalizeModuleUri(f.source),e.has(S.uri))throw new c.ArcadeExecutionError(null,c.ExecutionErrorCodes.CircularModules,null);return e.add(S.uri),[4,i.fetchModule(S)];case 2:return y=n.sent(),[4,_(e,y,s,[],o,i)];case 3:n.sent(),e.delete(S.uri),y.isAsync&&(t.isAsync=!0),y.usesFeatureSet&&(t.usesFeatureSet=!0),y.usesGeometry&&(t.usesGeometry=!0),t.loadedModules[f.libname]={uri:S.uri,script:y},n.label=4;case 4:return a++,[3,1];case 5:return[2]}}))}))}t.enableFeatureSetSupport=L,t.enableFeatureSetSupportImpl=R,t.scriptUsesFeatureSet=P,t.scriptIsAsync=function(e,t){return void 0===t&&(t=[]),void 0===e.isAsync&&l.findScriptDependencies(e,t),!0===e.isAsync},t.loadScriptDependencies=function(e,t,i,u,s){return void 0===i&&(i=[]),void 0===u&&(u=!1),void 0===s&&(s=null),r(this,void 0,void 0,(function(){return n(this,(function(r){return[2,_(new Set,e,t,i,u,s)]}))}))},t._loadScriptDependenciesImpl=_,t.scriptUsesModules=function(e,t){return void 0===t&&(t=[]),void 0===e.usesModules&&l.findScriptDependencies(e,t),!0===e.usesModules},t.loadDependentModules=j,t.scriptTouchesGeometry=function(e){if(E(e))return!0;for(var t=l.findFunctionCalls(e),r=!1,n=0;n<t.length;n++)if(p.includes(t[n])){r=!0;break}return r};var k=null;t.featureSetUtils=function(){return k}}));