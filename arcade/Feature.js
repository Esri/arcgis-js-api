// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator","./polyfill/tsSupport/assign","./polyfill/tsSupport/spreadarray","./Dictionary","./ImmutableArray","./languageUtils","../geometry/Geometry","../geometry/Point","../geometry/jsonUtils","./executionError"],(function(t,e,r,i,s,a,o,n,u,l,f,h,y){"use strict";return function(){function t(){this.arcadeDeclaredClass="esri.arcade.Feature",this._geometry=null,this.attributes=null,this._layer=null,this._datesfixed=!0,this.immutable=!0,this._datefields=null,this.immutable=!0}return t.createFromGraphic=function(e){var r=new t;return r._geometry=e.geometry?e.geometry:null,void 0===e.attributes?r.attributes={}:null===e.attributes?r.attributes={}:r.attributes=e.attributes,e._sourceLayer?(r._layer=e._sourceLayer,r._datesfixed=!1):e._layer?(r._layer=e._layer,r._datesfixed=!1):e.layer&&"fields"in e.layer?(r._layer=e.layer,r._datesfixed=!1):e.sourceLayer&&"fields"in e.sourceLayer&&(r._layer=e.sourceLayer,r._datesfixed=!1),r},t.createFromArcadeFeature=function(e){var r=new t;return r._datesfixed=e._datesfixed,r.attributes=e.attributes,r._geometry=e._geometry,e._layer&&(r._layer=e._layer),r},t.createFromArcadeDictionary=function(e){var r=new t;return r.attributes=e.field("attributes"),null!==r.attributes&&r.attributes instanceof o?(r.attributes=r.attributes.attributes,null===r.attributes&&(r.attributes={})):r.attributes={},r._geometry=e.field("geometry"),null!==r._geometry&&(r._geometry instanceof o?r._geometry=t.parseGeometryFromDictionary(r._geometry):r._geometry instanceof l||(r._geometry=null)),r},t.createFromGraphicLikeObject=function(e,r,i){void 0===i&&(i=null);var s=new t;return null===r&&(r={}),s.attributes=r,s._geometry=e||null,s._layer=i,s._layer&&(s._datesfixed=!1),s},t.prototype.repurposeFromGraphicLikeObject=function(t,e,r){void 0===r&&(r=null),null===e&&(e={}),this.attributes=e,this._geometry=t||null,this._layer=r,this._layer?this._datesfixed=!1:this._datesfixed=!0},t.prototype.castToText=function(t){void 0===t&&(t=!1);var e="";for(var r in!1===this._datesfixed&&this._fixDates(),this.attributes){""!==e&&(e+=",");var i=this.attributes[r];null==i?e+=JSON.stringify(r)+":null":u.isBoolean(i)||u.isNumber(i)||u.isString(i)?e+=JSON.stringify(r)+":"+JSON.stringify(i):i instanceof l?e+=JSON.stringify(r)+":"+u.toStringExplicit(i):i instanceof n?e+=JSON.stringify(r)+":"+u.toStringExplicit(i,null,t):i instanceof Array?e+=JSON.stringify(r)+":"+u.toStringExplicit(i,null,t):i instanceof Date?e+=t?JSON.stringify(r)+":"+JSON.stringify(i.getTime()):JSON.stringify(r)+":"+JSON.stringify(i):null!==i&&"object"==typeof i&&void 0!==i.castToText&&(e+=JSON.stringify(r)+":"+i.castToText(t))}return'{"geometry":'+(null===this.geometry()?"null":u.toStringExplicit(this.geometry()))+',"attributes":{'+e+"}}"},t.prototype._fixDates=function(){if(null!==this._datefields)return this._datefields.length>0&&this._fixDateFields(this._datefields),void(this._datesfixed=!0);for(var t=[],e=this._layer.fields,r=0;r<e.length;r++){var i=e[r],s=i.type;"date"!==s&&"esriFieldTypeDate"!==s||t.push(i.name)}this._datefields=t,t.length>0&&this._fixDateFields(t),this._datesfixed=!0},t.prototype._fixDateFields=function(t){this.attributes=s({},this.attributes);for(var e=0;e<t.length;e++){var r=this.attributes[t[e]];if(null===r);else if(void 0===r){for(var i in this.attributes)if(i.toLowerCase()===t[e].toLowerCase()){null!==(r=this.attributes[i])&&(r instanceof Date||(this.attributes[i]=new Date(r)));break}}else r instanceof Date||(this.attributes[t[e]]=new Date(r))}},t.prototype.geometry=function(){return null===this._geometry?this._geometry:this._geometry instanceof l?this._geometry:(this._geometry=h.fromJson(this._geometry),this._geometry)},t.prototype.field=function(t){!1===this._datesfixed&&this._fixDates();var e=this.attributes[t];if(void 0!==e)return e;var r=t.toLowerCase();for(var i in this.attributes)if(i.toLowerCase()===r)return this.attributes[i];if(this._hasFieldDefinition(r))return null;throw new y.ArcadeExecutionError(null,y.ExecutionErrorCodes.FieldNotFound,null,{key:t})},t.prototype._hasFieldDefinition=function(t){if(null===this._layer)return!1;for(var e=0;e<this._layer.fields.length;e++){if(this._layer.fields[e].name.toLowerCase()===t)return!0}return!1},t.prototype.setField=function(t,e){if(this.immutable)throw new y.ArcadeExecutionError(null,y.ExecutionErrorCodes.Immutable,null);if(!1===u.isSimpleType(e))throw new y.ArcadeExecutionError(null,y.ExecutionErrorCodes.TypeNotAllowedInFeature,null);var r=t.toLowerCase();if(void 0===this.attributes[t]){for(var i in this.attributes)if(i.toLowerCase()===r)return void(this.attributes[i]=e);this.attributes[t]=e}else this.attributes[t]=e},t.prototype.hasField=function(t){var e=t.toLowerCase();if(void 0!==this.attributes[t])return!0;for(var r in this.attributes)if(r.toLowerCase()===e)return!0;return!!this._hasFieldDefinition(e)},t.prototype.keys=function(){var t=[],e={};for(var r in this.attributes)t.push(r),e[r.toLowerCase()]=1;if(null!==this._layer)for(var i=0;i<this._layer.fields.length;i++){var s=this._layer.fields[i];1!==e[s.name.toLowerCase()]&&t.push(s.name)}return t=t.sort()},t.parseGeometryFromDictionary=function(e){var r=t._convertDictionaryToJson(e,!0);return void 0!==r.hasm&&(r.hasM=r.hasm,delete r.hasm),void 0!==r.hasz&&(r.hasZ=r.hasz,delete r.hasz),void 0!==r.spatialreference&&(r.spatialReference=r.spatialreference,delete r.spatialreference),void 0!==r.rings&&(r.rings=this._fixPathArrays(r.rings,!0===r.hasZ,!0===r.hasZ)),void 0!==r.paths&&(r.paths=this._fixPathArrays(r.paths,!0===r.hasZ,!0===r.hasM)),void 0!==r.points&&(r.points=this._fixPointArrays(r.points,!0===r.hasZ,!0===r.hasM)),h.fromJson(r)},t._fixPathArrays=function(t,e,r){var i=[];if(t instanceof Array)for(var s=0;s<t.length;s++)i.push(this._fixPointArrays(t[s],e,r));else if(t instanceof n)for(s=0;s<t.length();s++)i.push(this._fixPointArrays(t.get(s),e,r));return i},t._fixPointArrays=function(t,e,r){var i=[];if(t instanceof Array)for(var s=0;s<t.length;s++){(a=t[s])instanceof f?e&&r?i.push([a.x,a.y,a.z,a.m]):e?i.push([a.x,a.y,a.z]):r?i.push([a.x,a.y,a.m]):i.push([a.x,a.y]):a instanceof n?i.push(a.toArray()):i.push(a)}else if(t instanceof n)for(s=0;s<t.length();s++){var a;(a=t.get(s))instanceof f?e&&r?i.push([a.x,a.y,a.z,a.m]):e?i.push([a.x,a.y,a.z]):r?i.push([a.x,a.y,a.m]):i.push([a.x,a.y]):a instanceof n?i.push(a.toArray()):i.push(a)}return i},t._convertDictionaryToJson=function(e,r){void 0===r&&(r=!1);var i={};for(var s in e.attributes){var a=e.attributes[s];a instanceof o&&(a=t._convertDictionaryToJson(a)),r?i[s.toLowerCase()]=a:i[s]=a}return i},t.parseAttributesFromDictionary=function(t){var e={};for(var r in t.attributes){var i=t.attributes[r];if(!u.isSimpleType(i))throw new y.ArcadeExecutionError(null,y.ExecutionErrorCodes.InvalidParameter,null);e[r]=i}return e},t.fromJson=function(e){var r=null;null!==e.geometry&&void 0!==e.geometry&&(r=h.fromJson(e.geometry));var i={};if(null!==e.attributes&&void 0!==e.attributes)for(var s in e.attributes){var a=e.attributes[s];if(null===a)i[s]=a;else{if(!(u.isString(a)||u.isNumber(a)||u.isBoolean(a)||u.isDate(a)))throw new y.ArcadeExecutionError(null,y.ExecutionErrorCodes.InvalidParameter,null);i[s]=a}}return t.createFromGraphicLikeObject(r,i,null)},t.prototype.fullSchema=function(){return this._layer},t.prototype.gdbVersion=function(){if(null===this._layer)return"";var t=this._layer.gdbVersion;return void 0===t?"":""===t&&this._layer.capabilities&&this._layer.capabilities.isVersioned?"SDE.DEFAULT":t},t.prototype.castAsJson=function(t){var e={attributes:{},geometry:!0===(null==t?void 0:t.keepGeometryType)?this.geometry():this.geometry().toJson()};for(var r in this.attributes){var i=this.attributes[r];void 0!==i&&(e.attributes[r]=u.castAsJson(i,t))}return e},t.prototype.castAsJsonAsync=function(t,e){return void 0===t&&(t=null),r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,this.castAsJson(e)]}))}))},t}()}));