/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","./Dictionary","./ImmutableArray","../chunks/languageUtils","../geometry/Geometry","../geometry/Point","../geometry/support/jsonUtils","../layers/graphics/featureConversionUtils","../core/maybe","./executionError"],(function(t,e,i,r,s,n,o,a,u,l){"use strict";let f=function(){function f(){this.arcadeDeclaredClass="esri.arcade.Feature",this._optimizedGeomDefinition=null,this._geometry=null,this.attributes=null,this._layer=null,this._datesfixed=!0,this.immutable=!0,this._datefields=null,this.immutable=!0}f.createFromGraphic=function(t){const e=new f;return e._geometry=u.isSome(t.geometry)?t.geometry:null,void 0===t.attributes||null===t.attributes?e.attributes={}:e.attributes=t.attributes,t._sourceLayer?(e._layer=t._sourceLayer,e._datesfixed=!1):t._layer?(e._layer=t._layer,e._datesfixed=!1):t.layer&&"fields"in t.layer?(e._layer=t.layer,e._datesfixed=!1):t.sourceLayer&&"fields"in t.sourceLayer&&(e._layer=t.sourceLayer,e._datesfixed=!1),e},f.createFromArcadeFeature=function(t){const e=new f;return e._datesfixed=t._datesfixed,e.attributes=t.attributes,e._geometry=t._geometry,e._optimizedGeomDefinition=t._optimizedGeomDefinition,t._layer&&(e._layer=t._layer),e},f.createFromOptimisedFeature=function(t,e,i){const r=new f;return r._geometry=t.geometry?{geometry:t.geometry}:null,r._optimizedGeomDefinition=i,r.attributes=t.attributes||{},r._layer=e,r._datesfixed=!1,r},f.createFromArcadeDictionary=function(t){const i=new f;return i.attributes=t.field("attributes"),null!==i.attributes&&i.attributes instanceof e?(i.attributes=i.attributes.attributes,null===i.attributes&&(i.attributes={})):i.attributes={},i._geometry=t.field("geometry"),null!==i._geometry&&(i._geometry instanceof e?i._geometry=f.parseGeometryFromDictionary(i._geometry):i._geometry instanceof s||(i._geometry=null)),i},f.createFromGraphicLikeObject=function(t,e,i=null){const r=new f;return null===e&&(e={}),r.attributes=e,r._geometry=u.isSome(t)?t:null,r._layer=i,r._layer&&(r._datesfixed=!1),r};var c=f.prototype;return c.repurposeFromGraphicLikeObject=function(t,e,i=null){null===e&&(e={}),this.attributes=e,this._geometry=t||null,this._layer=i,this._layer?this._datesfixed=!1:this._datesfixed=!0},c.castToText=function(t=!1){let e="";!1===this._datesfixed&&this._fixDates();for(const n in this.attributes){""!==e&&(e+=",");const o=this.attributes[n];null==o?e+=JSON.stringify(n)+":null":r.isBoolean(o)||r.isNumber(o)||r.isString(o)?e+=JSON.stringify(n)+":"+JSON.stringify(o):o instanceof s?e+=JSON.stringify(n)+":"+r.toStringExplicit(o):o instanceof i||o instanceof Array?e+=JSON.stringify(n)+":"+r.toStringExplicit(o,null,t):o instanceof Date?e+=t?JSON.stringify(n)+":"+JSON.stringify(o.getTime()):JSON.stringify(n)+":"+JSON.stringify(o):null!==o&&"object"==typeof o&&void 0!==o.castToText&&(e+=JSON.stringify(n)+":"+o.castToText(t))}return'{"geometry":'+(null===this.geometry()?"null":r.toStringExplicit(this.geometry()))+',"attributes":{'+e+"}}"},c._fixDates=function(){if(null!==this._datefields)return this._datefields.length>0&&this._fixDateFields(this._datefields),void(this._datesfixed=!0);const t=[],e=this._layer.fields;for(let i=0;i<e.length;i++){const r=e[i],s=r.type;"date"!==s&&"esriFieldTypeDate"!==s||t.push(r.name)}this._datefields=t,t.length>0&&this._fixDateFields(t),this._datesfixed=!0},c._fixDateFields=function(t){this.attributes={...this.attributes};for(let e=0;e<t.length;e++){let i=this.attributes[t[e]];if(null===i);else if(void 0===i){for(const r in this.attributes)if(r.toLowerCase()===t[e].toLowerCase()){i=this.attributes[r],null!==i&&(i instanceof Date||(this.attributes[r]=new Date(i)));break}}else i instanceof Date||(this.attributes[t[e]]=new Date(i))}},c.geometry=function(){return null===this._geometry||this._geometry instanceof s||(this._optimizedGeomDefinition?(this._geometry=u.unwrap(o.fromJSON(a.convertToGeometry(this._geometry,this._optimizedGeomDefinition.geometryType,this._optimizedGeomDefinition.hasZ,this._optimizedGeomDefinition.hasM))),this._geometry.spatialReference=this._optimizedGeomDefinition.spatialReference):this._geometry=u.unwrap(o.fromJSON(this._geometry))),this._geometry},c.field=function(t){!1===this._datesfixed&&this._fixDates();const e=this.attributes[t];if(void 0!==e)return e;const i=t.toLowerCase();for(const r in this.attributes)if(r.toLowerCase()===i)return this.attributes[r];if(this._hasFieldDefinition(i))return null;throw new l.ArcadeExecutionError(null,l.ExecutionErrorCodes.FieldNotFound,null,{key:t})},c._hasFieldDefinition=function(t){if(null===this._layer)return!1;for(let e=0;e<this._layer.fields.length;e++){if(this._layer.fields[e].name.toLowerCase()===t)return!0}return!1},c.setField=function(t,e){if(this.immutable)throw new l.ArcadeExecutionError(null,l.ExecutionErrorCodes.Immutable,null);if(!1===r.isSimpleType(e))throw new l.ArcadeExecutionError(null,l.ExecutionErrorCodes.TypeNotAllowedInFeature,null);const i=t.toLowerCase();if(void 0===this.attributes[t]){for(const t in this.attributes)if(t.toLowerCase()===i)return void(this.attributes[t]=e);this.attributes[t]=e}else this.attributes[t]=e},c.hasField=function(t){const e=t.toLowerCase();if(void 0!==this.attributes[t])return!0;for(const i in this.attributes)if(i.toLowerCase()===e)return!0;return!!this._hasFieldDefinition(e)},c.keys=function(){let t=[];const e={};for(const i in this.attributes)t.push(i),e[i.toLowerCase()]=1;if(null!==this._layer)for(let i=0;i<this._layer.fields.length;i++){const r=this._layer.fields[i];1!==e[r.name.toLowerCase()]&&t.push(r.name)}return t=t.sort(),t},f.parseGeometryFromDictionary=function(t){const e=f._convertDictionaryToJson(t,!0);return void 0!==e.hasm&&(e.hasM=e.hasm,delete e.hasm),void 0!==e.hasz&&(e.hasZ=e.hasz,delete e.hasz),void 0!==e.spatialreference&&(e.spatialReference=e.spatialreference,delete e.spatialreference),void 0!==e.rings&&(e.rings=this._fixPathArrays(e.rings,!0===e.hasZ,!0===e.hasZ)),void 0!==e.paths&&(e.paths=this._fixPathArrays(e.paths,!0===e.hasZ,!0===e.hasM)),void 0!==e.points&&(e.points=this._fixPointArrays(e.points,!0===e.hasZ,!0===e.hasM)),o.fromJSON(e)},f._fixPathArrays=function(t,e,r){const s=[];if(t instanceof Array)for(let i=0;i<t.length;i++)s.push(this._fixPointArrays(t[i],e,r));else if(t instanceof i)for(let i=0;i<t.length();i++)s.push(this._fixPointArrays(t.get(i),e,r));return s},f._fixPointArrays=function(t,e,r){const s=[];if(t instanceof Array)for(let o=0;o<t.length;o++){const a=t[o];a instanceof n?e&&r?s.push([a.x,a.y,a.z,a.m]):e?s.push([a.x,a.y,a.z]):r?s.push([a.x,a.y,a.m]):s.push([a.x,a.y]):a instanceof i?s.push(a.toArray()):s.push(a)}else if(t instanceof i)for(let o=0;o<t.length();o++){const a=t.get(o);a instanceof n?e&&r?s.push([a.x,a.y,a.z,a.m]):e?s.push([a.x,a.y,a.z]):r?s.push([a.x,a.y,a.m]):s.push([a.x,a.y]):a instanceof i?s.push(a.toArray()):s.push(a)}return s},f._convertDictionaryToJson=function(t,i=!1){const r={};for(const s in t.attributes){let n=t.attributes[s];n instanceof e&&(n=f._convertDictionaryToJson(n)),i?r[s.toLowerCase()]=n:r[s]=n}return r},f.parseAttributesFromDictionary=function(t){const e={};for(const i in t.attributes){const s=t.attributes[i];if(!r.isSimpleType(s))throw new l.ArcadeExecutionError(null,l.ExecutionErrorCodes.InvalidParameter,null);e[i]=s}return e},f.fromJson=function(t){let e=null;null!==t.geometry&&void 0!==t.geometry&&(e=o.fromJSON(t.geometry));const i={};if(null!==t.attributes&&void 0!==t.attributes)for(const s in t.attributes){const e=t.attributes[s];if(null===e)i[s]=e;else{if(!(r.isString(e)||r.isNumber(e)||r.isBoolean(e)||r.isDate(e)))throw new l.ArcadeExecutionError(null,l.ExecutionErrorCodes.InvalidParameter,null);i[s]=e}}return f.createFromGraphicLikeObject(e,i,null)},c.fullSchema=function(){return this._layer},c.gdbVersion=function(){if(null===this._layer)return"";const t=this._layer.gdbVersion;return void 0===t?"":""===t&&this._layer.capabilities&&this._layer.capabilities.isVersioned?"SDE.DEFAULT":t},c.castAsJson=function(t){const e={attributes:{},geometry:!0===t?.keepGeometryType?this.geometry():this.geometry().toJSON()};for(const i in this.attributes){const s=this.attributes[i];void 0!==s&&(e.attributes[i]=r.castAsJson(s,t))}return e},c.castAsJsonAsync=function(){var e=t._asyncToGenerator((function*(t=null,e){return this.castAsJson(e)}));function i(){return e.apply(this,arguments)}return i}(),f}();return f}));
