/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../kernel","../request","./featureSetCollection","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/shared","../core/promiseUtils","../core/sql/WhereClause","../layers/FeatureLayer","../portal/Portal","../portal/PortalItem"],(function(e,t,r,n,a,l,s,i,o,u,c,d,h,f,m,p,y,L,S,I){"use strict";function _(){null===f.applicationCache&&(f.applicationCache=new f)}function v(e,t){if(f.applicationCache){const r=f.applicationCache.getLayerInfo(e);if(r)return r.then((r=>p.resolve(new L({url:e,outFields:t,sourceJSON:r}))));const n=new L({url:e,outFields:t});let a=p.create(((e,t)=>{n.load().then((()=>{e(n.sourceJSON)}),(e=>{t(e)}))}));return f.applicationCache&&(f.applicationCache.setLayerInfo(e,a),a=a.catch((t=>{throw f.applicationCache.clearLayerInfo(e),t}))),a.then((()=>p.resolve(n)))}return p.resolve(new L({url:e,outFields:t}))}function F(e,t,r,n,a,l=null){return v(e,["*"]).then((e=>p.resolve(N(e,t,r,n,a,l))))}function N(e,t=null,r=null,n=!0,a=null,l=null){return!0===e._hasMemorySource()?new d({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:l}):new c({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:l})}function C(e){if(null!==f.applicationCache){const t=f.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=n(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return p.resolve(t)}return p.resolve(null)}));return null!==f.applicationCache&&(f.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw f.applicationCache.clearLayerInfo(e),t}))),t}function A(e,t){const r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==f.applicationCache){const e=f.applicationCache.getLayerInfo(r);if(null!==e)return e}let a=n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((e=>{if(e.data){const t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==f.applicationCache&&(f.applicationCache.setLayerInfo(r,a),a=a.catch((e=>{throw f.applicationCache.clearLayerInfo(r),e}))),a}function T(e){if(null!==f.applicationCache){const t=f.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=n(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),p.resolve(t)}const t={layers:[],tables:[]};return p.resolve(t)}));return null!==f.applicationCache&&(f.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw f.applicationCache.clearLayerInfo(e),t}))),t}function g(e,t){const r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return T(e).then((n=>{if(r.metadata=n,n.controllerDatasetLayers&&void 0!==n.controllerDatasetLayers.utilityNetworkLayerId&&null!==n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const e of n.layers)r.layerNameLkp[e.id]=e.name;if(n.tables)for(const e of n.tables)r.layerNameLkp[e.id]=e.name;const a=n.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=a,A(e,a).then((n=>{if(n){r.queryelem=n,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(const e of r.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(const e of r.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});return C(e+"/"+a).then((n=>{if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){const a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),F(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null,null).then((e=>e.load())).then((e=>r.unVersion>=4?(e=e.filter(y.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e)).then((e=>({lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals})))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function k(e,t,r,n=null,a=null,l=!0,s=null,i=null){let o=e.serviceUrl();return o?(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),F(o,n,a,l,s,i).then((o=>new h({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:l,lrucache:s,interceptor:i})))):null}l.registerAction(),s.registerAction(),i.registerAction(),o.registerAction(),u.registerAction();let O=function(e){function r(t,r=null,n=null,a=null){var l;return(l=e.call(this)||this)._map=t,l._overridespref=r,l.lrucache=n,l.interceptor=a,l._instantLayers=[],l}t._inheritsLoose(r,e);var n=r.prototype;return n.makeAndAddFeatureSet=function(e,t=!0,r=null){const n=N(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},n.featureSetByName=function(e,t=!0,r=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(e,t,r)}catch(n){return p.reject(n)}}));null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let l=0;l<this._instantLayers.length;l++){const r=this._instantLayers[l];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[l].featureset)}const a=this._map.layers.find((t=>t instanceof L&&t.title===e));if(a)return this.resolvePromise(this.makeAndAddFeatureSet(a,t,r));if(this._map.tables){const n=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(n){if(n instanceof L)return this.resolvePromise(this.makeAndAddFeatureSet(n,t,r));if(n._materializedTable);else{const e=n.outFields?n:{...n,outFields:["*"]};n._materializedTable=new L(e)}return n._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(n._materializedTable,t,r))))}}return this.resolvePromise(null)},n.featureSetById=function(e,t=!0,r=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(e,t,r)}catch(n){return p.reject(n)}}));null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let l=0;l<this._instantLayers.length;l++){const r=this._instantLayers[l];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[l].featureset)}const a=this._map.layers.find((t=>t instanceof L&&t.id===e));if(a)return this.resolvePromise(this.makeAndAddFeatureSet(a,t,r));if(this._map.tables){const n=this._map.tables.find((t=>t.id===e));if(n){if(n instanceof L)return this.resolvePromise(this.makeAndAddFeatureSet(n,t,r));if(n._materializedTable);else{const e={...n,outFields:["*"]};n._materializedTable=new L(e)}return n._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(n._materializedTable,t,r))))}}return this.resolvePromise(null)},r}(a),b=function(e){function r(t,r=null,n=null,a=null){var l;return(l=e.call(this)||this)._url=t,l._overridespref=r,l.lrucache=n,l.interceptor=a,l.metadata=null,l._instantLayers=[],l}t._inheritsLoose(r,e);var n=r.prototype;return n.makeAndAddFeatureSet=function(e,t=!0,r=null){const n=N(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},n._loadMetaData=function(){return T(this._url).then((e=>(this.metadata=e,e)))},n.load=function(){return this._loadMetaData()},n.clone=function(){return new r(this._url,this._overridespref,this.lrucache,this.interceptor)},n.featureSetByName=function(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])t.name===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])t.name===e&&(a=t);return a?v(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))},n.featureSetById=function(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);return a?v(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))},t._createClass(r,[{key:"url",get:function(){return this._url}}]),r}(a);function w(e,t,r=null,n=null){return new O(e,t,r,n)}function E(e,t,r=null,n=null){return new b(e,t,r,n)}function D(e,t){if(null===e)return t;return new S({url:e.field("url")})}function P(e,t,a){return r.id.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===a?p.resolve(e.user.sourceJSON):""===t?n(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===a?{}:{returnUserLicenseTypeExtensions:!0}}}).then((e=>{if(e.data){const t=e.data;if(t&&t.username)return p.resolve(t)}return p.resolve(null)})):n(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.error?null:p.resolve(t)}return p.resolve(null)})):p.resolve(null)}function q(e,t,r,n,a,l,s,i=null){if(f.applicationCache){const o=f.applicationCache.getLayerInfo(e+":"+l.url);if(o)return o.then((e=>{try{const l=new L({url:m.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return p.resolve(N(l,r,n,a,s,i))}catch(l){return p.reject(l)}}),(e=>p.reject(e)))}return p.create(((o,u)=>{const c=new I({id:e,portal:l}).load();f.applicationCache&&f.applicationCache.setLayerInfo(e+":"+l.url,c),c.then((e=>{try{const l=new L({url:m.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});o(N(l,r,n,a,s,i))}catch(l){u(l)}}),(t=>{f.applicationCache&&f.applicationCache.clearLayerInfo(e+":"+l.url),u(t)}))}))}e.constructAssociationMetaDataFeatureSetFromUrl=g,e.constructFeatureSet=N,e.constructFeatureSetFromPortalItem=q,e.constructFeatureSetFromRelationship=k,e.constructFeatureSetFromUrl=F,e.createFeatureSetCollectionFromMap=w,e.createFeatureSetCollectionFromService=E,e.getPortal=D,e.initialiseMetaDataCache=_,e.lookupUser=P,Object.defineProperty(e,"__esModule",{value:!0})}));
