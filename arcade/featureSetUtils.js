// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator","./polyfill/tsSupport/assign","./polyfill/tsSupport/extends","../IdentityManager","../request","./featureSetCollection","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerDynamicMap","./featureset/sources/FeatureLayerMemoryMap","./featureset/sources/FeatureSetRelated","./featureset/support/cache","./featureset/support/FeatureSet","./featureset/support/shared","./polyfill/sql/WhereClause","../arcgis/Portal","../layers/FeatureLayer"],(function(e,t,r,a,n,i,l,s,o,u,c,d,f,h,p,m,y,v,S,g,F,L,I,b){"use strict";function N(e){return r(this,void 0,void 0,(function(){var t,r,n,i,l;return a(this,(function(a){switch(a.label){case 0:if(null!==S.applicationCache&&null!==(t=S.applicationCache.getLayerInfo(e)))return[2,t];r=s({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}),null!==S.applicationCache&&S.applicationCache.setLayerInfo(e,r),n=null,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,r];case 2:return n=a.sent(),[3,4];case 3:throw i=a.sent(),null!==S.applicationCache&&S.applicationCache.clearLayerInfo(e),i;case 4:return n?((l=n).layers||(l.layers=[]),l.tables||(l.tables=[]),[2,l]):[2,{layers:[],tables:[]}]}}))}))}function _(e){return r(this,void 0,void 0,(function(){var t,r,n,i;return a(this,(function(a){switch(a.label){case 0:if(null!==S.applicationCache&&null!==(t=S.applicationCache.getLayerInfo(e)))return[2,t];r=s({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}),null!==S.applicationCache&&S.applicationCache.setLayerInfo(e,r),n=null,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,r];case 2:return n=a.sent(),[3,4];case 3:throw i=a.sent(),null!==S.applicationCache&&S.applicationCache.clearLayerInfo(e),i;case 4:return[2,n]}}))}))}function C(e,t){return r(this,void 0,void 0,(function(){var r,n,i,l,o,u;return a(this,(function(a){switch(a.label){case 0:if(r="QUERYDATAELEMTS:"+t.toString()+":"+e,null!==S.applicationCache&&null!==(n=S.applicationCache.getLayerInfo(r)))return[2,n];i=s({url:e+"/queryDataElements",usePost:!0,handleAs:"json",content:{layers:JSON.stringify([t.toString()]),f:"json"}}),null!==S.applicationCache&&S.applicationCache.setLayerInfo(r,i),l=null,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,i];case 2:return l=a.sent(),[3,4];case 3:throw o=a.sent(),S.applicationCache.clearLayerInfo(r),o;case 4:if(l&&(u=l).layerDataElements&&u.layerDataElements[0])return[2,u.layerDataElements[0]];throw new Error("Not Found")}}))}))}function w(e,t,r,a,n,i){return void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),void 0===i&&(i=null),null===r&&(r=["*"]),new p({url:e,outFields:r,spatialReference:t,includeGeometry:a,lrucache:n,interceptor:i})}function k(e,t,n,i,l,s){return void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null),void 0===s&&(s=null),r(this,void 0,void 0,(function(){return a(this,(function(r){return[2,w(e,t,n,i,l,s)]}))}))}function A(e,t,r,a,n,i){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),void 0===i&&(i=null),!e.getMap()){if(e.url)return w(e.url,t,r,a,n,i);throw new Error("FeatureSets can only be used once the layer is added to a Map")}if(e.mode===b.MODE_SNAPSHOT&&!e.url)return new y({layer:e,spatialReference:t,outFields:r,includeGeometry:a});if(e.mode===b.MODE_SNAPSHOT||e.mode===b.MODE_ONDEMAND||e.mode===b.MODE_AUTO)return new m({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n,interceptor:i});throw new Error("FeatureSets only support for Snapshot or OnDemand FeatureSet")}Object.defineProperty(t,"__esModule",{value:!0}),t.lookupUser=t.constructAssociationMetaDataFeatureSetFromUrl=t.constructFeatureSetFromRelationship=t.constructFeatureSetFromPortalItem=t.convertToFeatureSet=t.getPortal=t.createFeatureSetCollectionFromService=t.createFeatureSetCollectionFromMap=t.constructFeatureSet=t.constructFeatureSetFromUrl=t.constructFeatureSetFromUrlRaw=t.initialiseMetaDataCache=void 0,u.registerAction(),c.registerAction(),d.registerAction(),f.registerAction(),h.registerAction(),t.initialiseMetaDataCache=function(){null===S.applicationCache&&(S.applicationCache=new S)},t.constructFeatureSetFromUrlRaw=w,t.constructFeatureSetFromUrl=k,t.constructFeatureSet=A;var O=function(e){function t(t,r,a,n){void 0===r&&(r=null),void 0===a&&(a=null),void 0===n&&(n=null);var i=e.call(this)||this;return i._map=t,i._overridespref=r,i.lrucache=a,i.interceptor=n,i._instantLayers=[],i}return i(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=A(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.makeAndAddFeatureSetTable=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=w(e.url,this._overridespref,r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:a,opitem:{name:e.title,id:e.id},includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,n){return void 0===t&&(t=!0),void 0===n&&(n=null),r(this,void 0,void 0,(function(){var r,i,l,s,o,u,c,d,f;return a(this,(function(a){for(null===n&&(n=["*"]),n=(n=n.slice(0)).sort(),r=JSON.stringify(n),i=0;i<this._instantLayers.length;i++)if((l=this._instantLayers[i]).opitem.name===e&&l.includeGeometry===t&&l.outFields===r)return[2,this._instantLayers[i].featureset];for(s=null,o=0,u=this._map.graphicsLayerIds;o<u.length;o++)if(c=u[o],(d=this._map.getLayer(c))instanceof b&&d.name===e){s=d;break}return s?[2,this.makeAndAddFeatureSet(s,t,n)]:this._map.tables&&(f=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)})))?[2,this.makeAndAddFeatureSetTable(f,t,n)]:[2,null]}))}))},t.prototype.featureSetById=function(e,t,n){return void 0===t&&(t=!0),void 0===n&&(n=["*"]),r(this,void 0,void 0,(function(){var r,i,l,s,o,u,c,d,f;return a(this,(function(a){for(null===n&&(n=["*"]),n=(n=n.slice(0)).sort(),r=JSON.stringify(n),i=0;i<this._instantLayers.length;i++)if((l=this._instantLayers[i]).opitem.id===e&&l.includeGeometry===t&&l.outFields===r)return[2,this._instantLayers[i].featureset];for(s=null,o=0,u=this._map.graphicsLayerIds;o<u.length;o++)if(c=u[o],(d=this._map.getLayer(c))instanceof b&&d.id===e){s=d;break}return s?[2,this.makeAndAddFeatureSet(s,t,n)]:this._map.tables&&(f=this._map.tables.find((function(t){return!!(t.id&&t.id===e||t.id&&t.id===e)})))?[2,this.makeAndAddFeatureSetTable(f,t,n)]:[2,null]}))}))},t}(o);t.createFeatureSetCollectionFromMap=function(e,t,r,a){return void 0===r&&(r=null),void 0===a&&(a=null),new O(e,t,r,a)};var E=function(e){function t(t,r,a,n){void 0===r&&(r=null),void 0===a&&(a=null),void 0===n&&(n=null);var i=e.call(this)||this;return i._url=t,i._overridespref=r,i.lrucache=a,i.interceptor=n,i.metadata=null,i._instantLayers=[],i}return i(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0}),t.prototype._loadMetaData=function(){return r(this,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return[4,N(this._url)];case 1:return e=t.sent(),this.metadata=e,[2,e]}}))}))},t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=A(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache,this.interceptor)},t.prototype.featureSetByName=function(e,t,n){return void 0===t&&(t=!0),void 0===n&&(n=null),r(this,void 0,void 0,(function(){var r,i,l,s,o,u,c,d,f,h;return a(this,(function(a){switch(a.label){case 0:for(null===n&&(n=["*"]),n=(n=n.slice(0)).sort(),r=JSON.stringify(n),i=0;i<this._instantLayers.length;i++)if((l=this._instantLayers[i]).opitem.name===e&&l.includeGeometry===t&&l.outFields===r)return[2,this._instantLayers[i].featureset];return[4,this._loadMetaData()];case 1:for(s=a.sent(),o=null,u=0,c=s.layers?s.layers:[];u<c.length;u++)(h=c[u]).name===e&&(o=h);if(!o)for(d=0,f=s.tables?s.tables:[];d<f.length;d++)(h=f[d]).name===e&&(o=h);return o?[2,w(this._url+"/"+o.id,this._overridespref,n,t,this.lrucache,this.interceptor)]:[2,null]}}))}))},t.prototype.featureSetById=function(e,t,n){return void 0===t&&(t=!0),void 0===n&&(n=["*"]),r(this,void 0,void 0,(function(){var r,i,l,s,o,u,c,d,f,h;return a(this,(function(a){switch(a.label){case 0:for(null===n&&(n=["*"]),n=(n=n.slice(0)).sort(),r=JSON.stringify(n),e=null!=e?e.toString():"",i=0;i<this._instantLayers.length;i++)if((l=this._instantLayers[i]).opitem.id===e&&l.includeGeometry===t&&l.outFields===r)return[2,this._instantLayers[i].featureset];return[4,this._loadMetaData()];case 1:for(s=a.sent(),o=null,u=0,c=s.layers?s.layers:[];u<c.length;u++)null!==(h=c[u]).id&&void 0!==h.id&&h.id.toString()===e&&(o=h);if(!o)for(d=0,f=s.tables?s.tables:[];d<f.length;d++)null!==(h=f[d]).id&&void 0!==h.id&&h.id.toString()===e&&(o=h);return o?[2,w(this._url+"/"+o.id,this._overridespref,n,t,this.lrucache,this.interceptor)]:[2,null]}}))}))},t}(o);t.createFeatureSetCollectionFromService=function(e,t,r,a){return void 0===r&&(r=null),void 0===a&&(a=null),new E(e,t,r,a)},t.getPortal=function(e,t){return null===e?t:new I.Portal(e.field("url"))},t.convertToFeatureSet=function(e,t,r,a,n){if(null===e)return null;if(e instanceof b){switch(t){case"datasource":return A(e,n,e.getOutFields(),!0,r,a).getDataSourceFeatureSet();case"parent":case"root":return A(e,n,e.getOutFields(),!0,r,a)}return null}if(e instanceof g)switch(t){case"datasource":return e.getDataSourceFeatureSet();case"parent":return e;case"root":return e.getRootFeatureSet()}return null},t.constructFeatureSetFromPortalItem=function(e,t,n,i,l,o,u,c){return void 0===c&&(c=null),r(this,void 0,void 0,(function(){var d,f,h,p,m;return a(this,(function(y){switch(y.label){case 0:return S.applicationCache&&(d=S.applicationCache.getLayerInfo(e+":"+o.url))?[4,d]:[3,2];case 1:return f=y.sent(),[2,k(F.extractServiceUrl(f.item.url)+"/"+t,n,i,l,u,c)];case 2:h=function(e,t){return r(this,void 0,void 0,(function(){var r;return a(this,(function(a){switch(a.label){case 0:return r=t.portalUrl+(t.portalUrl.match(/\/$/)?"":"/")+"content/items/"+e,[4,s({url:r,content:{f:"json"},callbackParamName:"callback"})];case 1:return[2,{item:a.sent()}]}}))}))}(e,o),S.applicationCache&&S.applicationCache.setLayerInfo(e+":"+o.url,h),p=null,y.label=3;case 3:return y.trys.push([3,5,,6]),[4,h];case 4:return p=y.sent(),[3,6];case 5:throw m=y.sent(),S.applicationCache&&S.applicationCache.clearLayerInfo(e+":"+o.url),m;case 6:return[2,k(F.extractServiceUrl(p.item.url)+"/"+t,n,i,l,u,c)]}}))}))},t.constructFeatureSetFromRelationship=function(e,t,n,i,l,s,o,u){return void 0===i&&(i=null),void 0===l&&(l=null),void 0===s&&(s=!0),void 0===o&&(o=null),void 0===u&&(u=null),r(this,void 0,void 0,(function(){var r,c;return a(this,(function(a){switch(a.label){case 0:return(r=e.serviceUrl())?[4,k(r="/"===r.charAt(r.length-1)?r+t.relatedTableId.toString():r+"/"+t.relatedTableId.toString(),i,l,s,o,u)]:[2,null];case 1:return c=a.sent(),[2,new v({layer:e,relatedLayer:c,relationship:t,objectId:n,spatialReference:i,outFields:l,includeGeometry:s,lrucache:o,interceptor:u})]}}))}))},t.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){return r(this,void 0,void 0,(function(){var r,n,i,l,s,o,u,c,d,f,h,p,m,y,v,S,g,F,I,b,w,A,O,E,D,T,M;return a(this,(function(a){switch(a.label){case 0:return r={metadata:null,networkId:-1,terminals:[],unVersion:3,queryelem:null,layerNameLkp:{},lkp:null},[4,N(e)];case 1:if(n=a.sent(),r.metadata=n,!n.controllerDatasetLayers||void 0===n.controllerDatasetLayers.utilityNetworkLayerId||null===n.controllerDatasetLayers.utilityNetworkLayerId)return[3,10];if(n.layers)for(i=0,l=n.layers;i<l.length;i++)u=l[i],r.layerNameLkp[u.id]=u.name;if(n.tables)for(s=0,o=n.tables;s<o.length;s++)u=o[s],r.layerNameLkp[u.id]=u.name;return c=n.controllerDatasetLayers.utilityNetworkLayerId,r.networkId=c,[4,C(e,c)];case 2:if(!(d=a.sent()))return[3,9];for(r.queryelem=d,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]),f=0,h=r.queryelem.dataElement.domainNetworks;f<h.length;f++){for(p=h[f],m=0,y=p.edgeSources?p.edgeSources:[];m<y.length;m++)g=y[m],(F={layerId:g.layerId,sourceId:g.sourceId,className:r.layerNameLkp[g.layerId]?r.layerNameLkp[g.layerId]:null}).className&&(r.lkp[F.className]=F);for(v=0,S=p.junctionSources?p.junctionSources:[];v<S.length;v++)g=S[v],(F={layerId:g.layerId,sourceId:g.sourceId,className:r.layerNameLkp[g.layerId]?r.layerNameLkp[g.layerId]:null}).className&&(r.lkp[F.className]=F)}if(r.queryelem.dataElement.terminalConfigurations)for(I=0,b=r.queryelem.dataElement.terminalConfigurations;I<b.length;I++)for(w=b[I],A=0,O=w.terminals;A<O.length;A++)E=O[A],r.terminals.push({terminalId:E.terminalId,terminalName:E.terminalName});return[4,_(e+"/"+c)];case 3:return(D=a.sent()).systemLayers&&void 0!==D.systemLayers.associationsTableId&&null!==D.systemLayers.associationsTableId?(T=[],r.unVersion>=4&&(T.push("STATUS"),T.push("PERCENTALONG")),[4,k(e+"/"+D.systemLayers.associationsTableId.toString(),t,__spreadArray(["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],T),!1,null)]):[3,8];case 4:return[4,(M=a.sent()).load()];case 5:return M=a.sent(),r.unVersion>=4?[4,(M=M.filter(L.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",M.getFieldsIndex()))).load()]:[3,7];case 6:a.sent(),a.label=7;case 7:return[2,{lkp:r.lkp,associations:M,unVersion:r.unVersion,terminals:r.terminals}];case 8:case 9:case 10:return[2,{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}]}}))}))},t.lookupUser=function(e,t,i){return r(this,void 0,void 0,(function(){var r,o,u,c,d,f,h;return a(this,(function(a){switch(a.label){case 0:if(!l.findCredential(e.portalUrl))return[2,null];if(e.getPortalUser()&&""===t&&(r=e.getPortalUser())&&!1===i){for(o={},u=0,c=["username","id","fullName","availableCredits","assignedCredits","firstName","lastName","preferredView","description","email","idpUsername","favGroupId","lastLogin","mfaEnabled","access","storageUsage","storageQuota","orgId","role","privileges"];u<c.length;u++)void 0!==r[d=c[u]]&&(o[d]=r[d]);return[2,o]}return""!==t?[3,2]:[4,s({url:e.portalUrl+"community/self",content:n({f:"json"},!1===i?{}:{returnUserLicenseTypeExtensions:!0}),callbackParamName:"callback"})];case 1:return(f=a.sent())&&f.username?[2,f]:[2,null];case 2:return[4,s({url:e.portalUrl+"community/users/"+t,content:{f:"json"},callbackParamName:"callback"})];case 3:return(h=a.sent()).error?[2,null]:[2,h]}}))}))}}));