/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../request","./featureSetCollection","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/errorsupport","./featureset/support/FeatureSet","./featureset/support/shared","../core/sql/WhereClause","../layers/FeatureLayer","../portal/PortalItem"],(function(e,t,n,r,a,i,l,o,s,u,c,d,y,f,p,h,m,_,S){"use strict";function L(){null===y.applicationCache&&(y.applicationCache=new y)}function I(e,t){return F.apply(this,arguments)}function F(){return(F=t._asyncToGenerator((function*(e,n){if(y.applicationCache){const a=y.applicationCache.getLayerInfo(e);if(a){const t=yield a;return new _({url:e,outFields:n,sourceJSON:t})}const i=new _({url:e,outFields:n}),l=t._asyncToGenerator((function*(){return yield i.load(),i.sourceJSON}))();if(y.applicationCache){y.applicationCache.setLayerInfo(e,l);try{return yield l,i}catch(r){throw y.applicationCache.clearLayerInfo(e),r}}return yield l,i}return new _({url:e,outFields:n})}))).apply(this,arguments)}function T(e,t,n,r,a){return N.apply(this,arguments)}function N(){return(N=t._asyncToGenerator((function*(e,t,n,r,a,i=null){return C(yield I(e,["*"]),t,n,r,a,i)}))).apply(this,arguments)}function C(e,t=null,n=null,r=!0,a=null,i=null){const l={layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:a,interceptor:i};return!0===e._hasMemorySource()?new c(l):new u(l)}function g(e){return A.apply(this,arguments)}function A(){return(A=t._asyncToGenerator((function*(e){if(null!==y.applicationCache){const t=y.applicationCache.getLayerInfo(e);if(null!==t)return t}const r=t._asyncToGenerator((function*(){const t=yield n(e,{responseType:"json",query:{f:"json"}});return t.data?t.data:null}))();if(null!==y.applicationCache){y.applicationCache.setLayerInfo(e,r);try{return yield r}catch(a){throw y.applicationCache.clearLayerInfo(e),a}}return r}))).apply(this,arguments)}function k(e,t){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*(e,r){const a="QUERYDATAELEMTS:"+r.toString()+":"+e;if(null!==y.applicationCache){const e=y.applicationCache.getLayerInfo(a);if(null!==e)return e}const i=t._asyncToGenerator((function*(){const t=yield n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([r.toString()]),f:"json"}});if(t.data){const e=t.data;if(e.layerDataElements&&e.layerDataElements[0])return e.layerDataElements[0]}throw new f.FeatureSetError(f.FeatureSetErrorCodes.DataElementsNotFound)}))();if(null!==y.applicationCache){y.applicationCache.setLayerInfo(a,i);try{return yield i}catch(l){throw y.applicationCache.clearLayerInfo(a),l}}return i}))).apply(this,arguments)}function G(e){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e){if(null!==y.applicationCache){const t=y.applicationCache.getLayerInfo(e);if(null!==t)return t}const r=t._asyncToGenerator((function*(){const t=yield n(e,{responseType:"json",query:{f:"json"}});if(t.data){const e=t.data;return e.layers||(e.layers=[]),e.tables||(e.tables=[]),e}return{layers:[],tables:[]}}))();if(null!==y.applicationCache){y.applicationCache.setLayerInfo(e,r);try{return yield r}catch(a){throw y.applicationCache.clearLayerInfo(e),a}}return r}))).apply(this,arguments)}function E(e,t){return O.apply(this,arguments)}function O(){return(O=t._asyncToGenerator((function*(e,t){const n={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},r=yield G(e);if(n.metadata=r,r.controllerDatasetLayers&&void 0!==r.controllerDatasetLayers.utilityNetworkLayerId&&null!==r.controllerDatasetLayers.utilityNetworkLayerId){if(r.layers)for(const e of r.layers)n.layerNameLkp[e.id]=e.name;if(r.tables)for(const e of r.tables)n.layerNameLkp[e.id]=e.name;const a=r.controllerDatasetLayers.utilityNetworkLayerId;n.networkId=a;const i=yield k(e,a);if(i){n.queryelem=i,n.queryelem&&n.queryelem.dataElement&&void 0!==n.queryelem.dataElement.schemaGeneration&&(n.unVersion=n.queryelem.dataElement.schemaGeneration),n.lkp={},n.queryelem.dataElement.domainNetworks||(n.queryelem.dataElement.domainNetworks=[]);for(const e of n.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:n.layerNameLkp[t.layerId]?n.layerNameLkp[t.layerId]:null};e.className&&(n.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:n.layerNameLkp[t.layerId]?n.layerNameLkp[t.layerId]:null};e.className&&(n.lkp[e.className]=e)}}if(n.queryelem.dataElement.terminalConfigurations)for(const e of n.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)n.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});const r=yield g(e+"/"+a);if(r.systemLayers&&void 0!==r.systemLayers.associationsTableId&&null!==r.systemLayers.associationsTableId){const a=[];n.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG"));let i=yield T(e+"/"+r.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null,null);return yield i.load(),n.unVersion>=4&&(i=i.filter(m.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",i.getFieldsIndex())),yield i.load()),{lkp:n.lkp,associations:i,unVersion:n.unVersion,terminals:n.terminals}}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))).apply(this,arguments)}function v(e,t,n){return D.apply(this,arguments)}function D(){return(D=t._asyncToGenerator((function*(e,t,n,r=null,a=null,i=!0,l=null,o=null){let s=e.serviceUrl();if(!s)return null;s="/"===s.charAt(s.length-1)?s+t.relatedTableId.toString():s+"/"+t.relatedTableId.toString();const u=yield T(s,r,a,i,l,o);return new d({layer:e,relatedLayer:u,relationship:t,objectId:n,spatialReference:r,outFields:a,includeGeometry:i,lrucache:l,interceptor:o})}))).apply(this,arguments)}a.registerAction(),i.registerAction(),l.registerAction(),o.registerAction(),s.registerAction();let q=function(e){function n(t,n=null,r=null,a=null){var i;return(i=e.call(this)||this)._map=t,i._overridespref=n,i._lrucache=r,i._interceptor=a,i._instantLayers=[],i}t._inheritsLoose(n,e);var r=n.prototype;return r._makeAndAddFeatureSet=function(e,t=!0,n=null){const r=C(e,this._overridespref,null===n?["*"]:n,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r},r.featureSetByName=function(){var e=t._asyncToGenerator((function*(e,t=!0,n=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return yield this._map.load(),this.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const r=JSON.stringify(n);for(let i=0;i<this._instantLayers.length;i++){const n=this._instantLayers[i];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[i].featureset}const a=this._map.allLayers.find((t=>t instanceof _&&t.title===e));if(a)return this._makeAndAddFeatureSet(a,t,n);if(this._map.tables){const r=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(r){if(r instanceof _)return this._makeAndAddFeatureSet(r,t,n);if(r._materializedTable);else{const e=r.outFields?r:{...r,outFields:["*"]};r._materializedTable=new _(e)}return yield r._materializedTable.load(),this._makeAndAddFeatureSet(r._materializedTable,t,n)}}return null}));function n(t){return e.apply(this,arguments)}return n}(),r.featureSetById=function(){var e=t._asyncToGenerator((function*(e,t=!0,n=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return yield this._map.load(),this.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const r=JSON.stringify(n);for(let i=0;i<this._instantLayers.length;i++){const n=this._instantLayers[i];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[i].featureset}const a=this._map.allLayers.find((t=>t instanceof _&&t.id===e));if(a)return this._makeAndAddFeatureSet(a,t,n);if(this._map.tables){const r=this._map.tables.find((t=>t.id===e));if(r){if(r instanceof _)return this._makeAndAddFeatureSet(r,t,n);if(r._materializedTable);else{const e={...r,outFields:["*"]};r._materializedTable=new _(e)}return yield r._materializedTable.load(),this._makeAndAddFeatureSet(r._materializedTable,t,n)}}return null}));function n(t){return e.apply(this,arguments)}return n}(),n}(r),M=function(e){function n(t,n=null,r=null,a=null){var i;return(i=e.call(this)||this)._url=t,i._overridespref=n,i._lrucache=r,i._interceptor=a,i.metadata=null,i._instantLayers=[],i}t._inheritsLoose(n,e);var r=n.prototype;return r._makeAndAddFeatureSet=function(e,t=!0,n=null){const r=C(e,this._overridespref,null===n?["*"]:n,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r},r._loadMetaData=function(){var e=t._asyncToGenerator((function*(){const e=yield G(this._url);return this.metadata=e,e}));function n(){return e.apply(this,arguments)}return n}(),r.load=function(){return this._loadMetaData()},r.clone=function(){return new n(this._url,this._overridespref,this._lrucache,this._interceptor)},r.featureSetByName=function(){var e=t._asyncToGenerator((function*(e,t=!0,n=null){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const r=JSON.stringify(n);for(let l=0;l<this._instantLayers.length;l++){const n=this._instantLayers[l];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[l].featureset}const a=yield this._loadMetaData();let i=null;for(const l of a.layers?a.layers:[])l.name===e&&(i=l);if(!i)for(const l of a.tables?a.tables:[])l.name===e&&(i=l);if(i){const e=yield I(this._url+"/"+i.id,["*"]);return this._makeAndAddFeatureSet(e,t,n)}return null}));function n(t){return e.apply(this,arguments)}return n}(),r.featureSetById=function(){var e=t._asyncToGenerator((function*(e,t=!0,n=["*"]){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const r=JSON.stringify(n);e=null!=e?e.toString():"";for(let l=0;l<this._instantLayers.length;l++){const n=this._instantLayers[l];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[l].featureset}const a=yield this._loadMetaData();let i=null;for(const l of a.layers?a.layers:[])null!==l.id&&void 0!==l.id&&l.id.toString()===e&&(i=l);if(!i)for(const l of a.tables?a.tables:[])null!==l.id&&void 0!==l.id&&l.id.toString()===e&&(i=l);if(i){const e=yield I(this._url+"/"+i.id,["*"]);return this._makeAndAddFeatureSet(e,t,n)}return null}));function n(t){return e.apply(this,arguments)}return n}(),t._createClass(n,[{key:"url",get:function(){return this._url}}]),n}(r);function R(e,t,n=null,r=null){return new q(e,t,n,r)}function B(e,t,n=null,r=null){return new M(e,t,n,r)}function V(e,t,n,r,a){if(null===e)return null;if(e instanceof _){switch(t){case"datasource":return C(e,a,e.outFields,!0,n,r).getDataSourceFeatureSet();case"parent":case"root":return C(e,a,e.outFields,!0,n,r)}return null}if(e instanceof p)switch(t){case"datasource":return e.getDataSourceFeatureSet();case"parent":return e;case"root":return e.getRootFeatureSet()}return null}function j(e,t,n,r,a,i,l){return J.apply(this,arguments)}function J(){return(J=t._asyncToGenerator((function*(e,t,n,r,a,i,l,o=null){if(y.applicationCache){const s=y.applicationCache.getLayerInfo(e+":"+i.url);if(s){const e=yield s;return C(new _({url:h.extractServiceUrl(e.url)+"/"+t,outFields:["*"]}),n,r,a,l,o)}}const s=new S({id:e,portal:i}).load();y.applicationCache&&y.applicationCache.setLayerInfo(e+":"+i.url,s);try{const e=yield s;return C(new _({url:h.extractServiceUrl(e.url??"")+"/"+t,outFields:["*"]}),n,r,a,l,o)}catch(u){throw y.applicationCache&&y.applicationCache.clearLayerInfo(e+":"+i.url),u}}))).apply(this,arguments)}e.constructAssociationMetaDataFeatureSetFromUrl=E,e.constructFeatureSet=C,e.constructFeatureSetFromPortalItem=j,e.constructFeatureSetFromRelationship=v,e.constructFeatureSetFromUrl=T,e.convertToFeatureSet=V,e.createFeatureSetCollectionFromMap=R,e.createFeatureSetCollectionFromService=B,e.initialiseMetaDataCache=L,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
