/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../kernel","../request","./featureSetCollection","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/errorsupport","./featureset/support/FeatureSet","./featureset/support/shared","../core/sql/WhereClause","../layers/FeatureLayer","../portal/Portal","../portal/PortalItem"],(function(e,t,r,n,a,i,l,o,s,u,c,d,f,y,p,h,m,_,S,L,I){"use strict";function T(){null===y.applicationCache&&(y.applicationCache=new y)}function F(e,t){return N.apply(this,arguments)}function N(){return(N=t._asyncToGenerator((function*(e,r){if(y.applicationCache){const a=y.applicationCache.getLayerInfo(e);if(a){const t=yield a;return new S({url:e,outFields:r,sourceJSON:t})}const i=new S({url:e,outFields:r}),l=t._asyncToGenerator((function*(){return yield i.load(),i.sourceJSON}))();if(y.applicationCache){y.applicationCache.setLayerInfo(e,l);try{return yield l,i}catch(n){throw y.applicationCache.clearLayerInfo(e),n}}return yield l,i}return new S({url:e,outFields:r})}))).apply(this,arguments)}function C(e,t,r,n,a){return g.apply(this,arguments)}function g(){return(g=t._asyncToGenerator((function*(e,t,r,n,a,i=null){return A(yield F(e,["*"]),t,r,n,a,i)}))).apply(this,arguments)}function A(e,t=null,r=null,n=!0,a=null,i=null){const l={layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:i};return!0===e._hasMemorySource()?new d(l):new c(l)}function k(e){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*(e){if(null!==y.applicationCache){const t=y.applicationCache.getLayerInfo(e);if(null!==t)return t}const r=t._asyncToGenerator((function*(){const t=yield n(e,{responseType:"json",query:{f:"json"}});return t.data?t.data:null}))();if(null!==y.applicationCache){y.applicationCache.setLayerInfo(e,r);try{return yield r}catch(a){throw y.applicationCache.clearLayerInfo(e),a}}return r}))).apply(this,arguments)}function G(e,t){return O.apply(this,arguments)}function O(){return(O=t._asyncToGenerator((function*(e,r){const a="QUERYDATAELEMTS:"+r.toString()+":"+e;if(null!==y.applicationCache){const e=y.applicationCache.getLayerInfo(a);if(null!==e)return e}const i=t._asyncToGenerator((function*(){const t=yield n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([r.toString()]),f:"json"}});if(t.data){const e=t.data;if(e.layerDataElements&&e.layerDataElements[0])return e.layerDataElements[0]}throw new p.FeatureSetError(p.FeatureSetErrorCodes.DataElementsNotFound)}))();if(null!==y.applicationCache){y.applicationCache.setLayerInfo(a,i);try{return yield i}catch(l){throw y.applicationCache.clearLayerInfo(a),l}}return i}))).apply(this,arguments)}function b(e){return E.apply(this,arguments)}function E(){return(E=t._asyncToGenerator((function*(e){if(null!==y.applicationCache){const t=y.applicationCache.getLayerInfo(e);if(null!==t)return t}const r=t._asyncToGenerator((function*(){const t=yield n(e,{responseType:"json",query:{f:"json"}});if(t.data){const e=t.data;return e.layers||(e.layers=[]),e.tables||(e.tables=[]),e}return{layers:[],tables:[]}}))();if(null!==y.applicationCache){y.applicationCache.setLayerInfo(e,r);try{return yield r}catch(a){throw y.applicationCache.clearLayerInfo(e),a}}return r}))).apply(this,arguments)}function v(e,t){return D.apply(this,arguments)}function D(){return(D=t._asyncToGenerator((function*(e,t){const r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield b(e);if(r.metadata=n,n.controllerDatasetLayers&&void 0!==n.controllerDatasetLayers.utilityNetworkLayerId&&null!==n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const e of n.layers)r.layerNameLkp[e.id]=e.name;if(n.tables)for(const e of n.tables)r.layerNameLkp[e.id]=e.name;const a=n.controllerDatasetLayers.utilityNetworkLayerId;r.networkId=a;const i=yield G(e,a);if(i){r.queryelem=i,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(const e of r.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(const e of r.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});const n=yield k(e+"/"+a);if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){const a=[];r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG"));let i=yield C(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null,null);return yield i.load(),r.unVersion>=4&&(i=i.filter(_.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",i.getFieldsIndex())),yield i.load()),{lkp:r.lkp,associations:i,unVersion:r.unVersion,terminals:r.terminals}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))).apply(this,arguments)}function q(e,t,r){return M.apply(this,arguments)}function M(){return(M=t._asyncToGenerator((function*(e,t,r,n=null,a=null,i=!0,l=null,o=null){let s=e.serviceUrl();if(!s)return null;s="/"===s.charAt(s.length-1)?s+t.relatedTableId.toString():s+"/"+t.relatedTableId.toString();const u=yield C(s,n,a,i,l,o);return new f({layer:e,relatedLayer:u,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:i,lrucache:l,interceptor:o})}))).apply(this,arguments)}i.registerAction(),l.registerAction(),o.registerAction(),s.registerAction(),u.registerAction();let R=function(e){function r(t,r=null,n=null,a=null){var i;return(i=e.call(this)||this)._map=t,i._overridespref=r,i._lrucache=n,i._interceptor=a,i._instantLayers=[],i}t._inheritsLoose(r,e);var n=r.prototype;return n._makeAndAddFeatureSet=function(e,t=!0,r=null){const n=A(e,this._overridespref,null===r?["*"]:r,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},n.featureSetByName=function(){var e=t._asyncToGenerator((function*(e,t=!0,r=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return yield this._map.load(),this.featureSetByName(e,t,r);null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let i=0;i<this._instantLayers.length;i++){const r=this._instantLayers[i];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this._instantLayers[i].featureset}const a=this._map.allLayers.find((t=>t instanceof S&&t.title===e));if(a)return this._makeAndAddFeatureSet(a,t,r);if(this._map.tables){const n=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(n){if(n instanceof S)return this._makeAndAddFeatureSet(n,t,r);if(n._materializedTable);else{const e=n.outFields?n:{...n,outFields:["*"]};n._materializedTable=new S(e)}return yield n._materializedTable.load(),this._makeAndAddFeatureSet(n._materializedTable,t,r)}}return null}));function r(t){return e.apply(this,arguments)}return r}(),n.featureSetById=function(){var e=t._asyncToGenerator((function*(e,t=!0,r=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return yield this._map.load(),this.featureSetById(e,t,r);null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let i=0;i<this._instantLayers.length;i++){const r=this._instantLayers[i];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this._instantLayers[i].featureset}const a=this._map.allLayers.find((t=>t instanceof S&&t.id===e));if(a)return this._makeAndAddFeatureSet(a,t,r);if(this._map.tables){const n=this._map.tables.find((t=>t.id===e));if(n){if(n instanceof S)return this._makeAndAddFeatureSet(n,t,r);if(n._materializedTable);else{const e={...n,outFields:["*"]};n._materializedTable=new S(e)}return yield n._materializedTable.load(),this._makeAndAddFeatureSet(n._materializedTable,t,r)}}return null}));function r(t){return e.apply(this,arguments)}return r}(),r}(a),U=function(e){function r(t,r=null,n=null,a=null){var i;return(i=e.call(this)||this)._url=t,i._overridespref=r,i._lrucache=n,i._interceptor=a,i.metadata=null,i._instantLayers=[],i}t._inheritsLoose(r,e);var n=r.prototype;return n._makeAndAddFeatureSet=function(e,t=!0,r=null){const n=A(e,this._overridespref,null===r?["*"]:r,t,this._lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},n._loadMetaData=function(){var e=t._asyncToGenerator((function*(){const e=yield b(this._url);return this.metadata=e,e}));function r(){return e.apply(this,arguments)}return r}(),n.load=function(){return this._loadMetaData()},n.clone=function(){return new r(this._url,this._overridespref,this._lrucache,this._interceptor)},n.featureSetByName=function(){var e=t._asyncToGenerator((function*(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let l=0;l<this._instantLayers.length;l++){const r=this._instantLayers[l];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this._instantLayers[l].featureset}const a=yield this._loadMetaData();let i=null;for(const l of a.layers?a.layers:[])l.name===e&&(i=l);if(!i)for(const l of a.tables?a.tables:[])l.name===e&&(i=l);if(i){const e=yield F(this._url+"/"+i.id,["*"]);return this._makeAndAddFeatureSet(e,t,r)}return null}));function r(t){return e.apply(this,arguments)}return r}(),n.featureSetById=function(){var e=t._asyncToGenerator((function*(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let l=0;l<this._instantLayers.length;l++){const r=this._instantLayers[l];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this._instantLayers[l].featureset}const a=yield this._loadMetaData();let i=null;for(const l of a.layers?a.layers:[])null!==l.id&&void 0!==l.id&&l.id.toString()===e&&(i=l);if(!i)for(const l of a.tables?a.tables:[])null!==l.id&&void 0!==l.id&&l.id.toString()===e&&(i=l);if(i){const e=yield F(this._url+"/"+i.id,["*"]);return this._makeAndAddFeatureSet(e,t,r)}return null}));function r(t){return e.apply(this,arguments)}return r}(),t._createClass(r,[{key:"url",get:function(){return this._url}}]),r}(a);function j(e,t,r=null,n=null){return new R(e,t,r,n)}function B(e,t,r=null,n=null){return new U(e,t,r,n)}function V(e,t){if(null===e)return t;return new L({url:e.field("url")})}function J(e,t,r){return z.apply(this,arguments)}function z(){return(z=t._asyncToGenerator((function*(e,t,a){if(!r.id.findCredential(e.restUrl))return null;if("loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===a)return e.user.sourceJSON;if(""===t){const t=yield n(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===a?{}:{returnUserLicenseTypeExtensions:!0}}});if(t.data){const e=t.data;if(e&&e.username)return e}return null}const i=yield n(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}});if(i.data){const e=i.data;return e.error?null:e}return null}))).apply(this,arguments)}function P(e,t,r,n,a){if(null===e)return null;if(e instanceof S){switch(t){case"datasource":return A(e,a,e.outFields,!0,r,n).getDataSourceFeatureSet();case"parent":case"root":return A(e,a,e.outFields,!0,r,n)}return null}if(e instanceof h)switch(t){case"datasource":return e.getDataSourceFeatureSet();case"parent":return e;case"root":return e.getRootFeatureSet()}return null}function x(e,t,r,n,a,i,l){return W.apply(this,arguments)}function W(){return(W=t._asyncToGenerator((function*(e,t,r,n,a,i,l,o=null){if(y.applicationCache){const s=y.applicationCache.getLayerInfo(e+":"+i.url);if(s){const e=yield s;return A(new S({url:m.extractServiceUrl(e.url)+"/"+t,outFields:["*"]}),r,n,a,l,o)}}const s=new I({id:e,portal:i}).load();y.applicationCache&&y.applicationCache.setLayerInfo(e+":"+i.url,s);try{const e=yield s;return A(new S({url:m.extractServiceUrl(e.url??"")+"/"+t,outFields:["*"]}),r,n,a,l,o)}catch(u){throw y.applicationCache&&y.applicationCache.clearLayerInfo(e+":"+i.url),u}}))).apply(this,arguments)}e.constructAssociationMetaDataFeatureSetFromUrl=v,e.constructFeatureSet=A,e.constructFeatureSetFromPortalItem=x,e.constructFeatureSetFromRelationship=q,e.constructFeatureSetFromUrl=C,e.convertToFeatureSet=P,e.createFeatureSetCollectionFromMap=j,e.createFeatureSetCollectionFromService=B,e.getPortal=V,e.initialiseMetaDataCache=T,e.lookupUser=J,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
