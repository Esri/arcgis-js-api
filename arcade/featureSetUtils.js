// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),a=0;for(t=0;t<r;t++)for(var i=arguments[t],l=0,o=i.length;l<o;l++,a++)n[a]=i[l];return n};define(["require","exports","../IdentityManager","../request","./featureSetCollection","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerDynamicMap","./featureset/sources/FeatureLayerMemoryMap","./featureset/sources/FeatureSetRelated","./featureset/support/cache","./featureset/support/shared","./polyfill/promiseUtils","./polyfill/sql/WhereClause","../arcgis/Portal","../layers/FeatureLayer"],(function(e,t,r,n,a,i,l,o,s,u,c,d,f,p,h,m,y,v,_,g){"use strict";function S(e){if(null!==h.applicationCache){var t=h.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then((function(e){if(e){var t=e;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),y.resolve(t)}return y.resolve({layers:[],tables:[]})}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),r}function L(e,t,r,n,a,i){return void 0===r&&(r=null),void 0===n&&(n=!0),void 0===a&&(a=null),void 0===i&&(i=null),null===r&&(r=["*"]),new c({url:e,outFields:r,spatialReference:t,includeGeometry:n,lrucache:a,interceptor:i})}function F(e,t,r,n,a,i){return void 0===r&&(r=null),void 0===n&&(n=!0),void 0===a&&(a=null),void 0===i&&(i=null),y.resolve(L(e,t,r,n,a,i))}function I(e,t,r,n,a,i){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=!0),void 0===a&&(a=null),void 0===i&&(i=null),!e.getMap()){if(e.url)return L(e.url,t,r,n,a,i);throw new Error("FeatureSets can only be used once the layer is added to a Map")}if(e.mode===g.MODE_SNAPSHOT&&!e.url)return new f({layer:e,spatialReference:t,outFields:r,includeGeometry:n});if(e.mode===g.MODE_SNAPSHOT||e.mode===g.MODE_ONDEMAND||e.mode===g.MODE_AUTO)return new d({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:i});throw new Error("FeatureSets only support for Snapshot or OnDemand FeatureSet")}Object.defineProperty(t,"__esModule",{value:!0}),t.lookupUser=t.constructAssociationMetaDataFeatureSetFromUrl=t.constructFeatureSetFromRelationship=t.constructFeatureSetFromPortalItem=t.getPortal=t.createFeatureSetCollectionFromService=t.createFeatureSetCollectionFromMap=t.constructFeatureSet=t.constructFeatureSetFromUrl=t.constructFeatureSetFromUrlRaw=t.initialiseMetaDataCache=void 0,i.registerAction(),l.registerAction(),o.registerAction(),s.registerAction(),u.registerAction(),t.initialiseMetaDataCache=function(){null===h.applicationCache&&(h.applicationCache=new h)},t.constructFeatureSetFromUrlRaw=L,t.constructFeatureSetFromUrl=F,t.constructFeatureSet=I;var N=function(e){function t(t,r,n,a){void 0===r&&(r=null),void 0===n&&(n=null),void 0===a&&(a=null);var i=e.call(this)||this;return i._map=t,i._overridespref=r,i.lrucache=n,i.interceptor=a,i._instantLayers=[],i}return __extends(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var n=I(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},t.prototype.makeAndAddFeatureSetTable=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var n=L(e.url,this._overridespref,r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:{name:e.title,id:e.id},includeGeometry:t,outFields:JSON.stringify(r)}),n},t.prototype.featureSetByName=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var n=JSON.stringify(r),a=0;a<this._instantLayers.length;a++){var i=this._instantLayers[a];if(i.opitem.name===e&&i.includeGeometry===t&&i.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}for(var l=null,o=0,s=this._map.graphicsLayerIds;o<s.length;o++){var u=s[o],c=this._map.getLayer(u);if(c instanceof g&&c.name===e){l=c;break}}if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,r));if(this._map.tables){var d=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(d)return this.resolvePromise(this.makeAndAddFeatureSetTable(d,t,r))}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var n=JSON.stringify(r),a=0;a<this._instantLayers.length;a++){var i=this._instantLayers[a];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}for(var l=null,o=0,s=this._map.graphicsLayerIds;o<s.length;o++){var u=s[o],c=this._map.getLayer(u);if(c instanceof g&&c.id===e){l=c;break}}if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,r));if(this._map.tables){var d=this._map.tables.find((function(t){return!!(t.id&&t.id===e||t.id&&t.id===e)}));if(d)return this.resolvePromise(this.makeAndAddFeatureSetTable(d,t,r))}return this.resolvePromise(null)},t}(a);t.createFeatureSetCollectionFromMap=function(e,t,r,n){return void 0===r&&(r=null),void 0===n&&(n=null),new N(e,t,r,n)};var A=function(e){function t(t,r,n,a){void 0===r&&(r=null),void 0===n&&(n=null),void 0===a&&(a=null);var i=e.call(this)||this;return i._url=t,i._overridespref=r,i.lrucache=n,i.interceptor=a,i.metadata=null,i._instantLayers=[],i}return __extends(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0}),t.prototype._loadMetaData=function(){var e=this;return S(this._url).then((function(t){return e.metadata=t,t}))},t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var n=I(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache,this.interceptor)},t.prototype.featureSetByName=function(e,t,r){var n=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var a=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.name===e&&l.includeGeometry===t&&l.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(a){for(var i=null,l=0,o=a.layers?a.layers:[];l<o.length;l++){(c=o[l]).name===e&&(i=c)}if(!i)for(var s=0,u=a.tables?a.tables:[];s<u.length;s++){var c;(c=u[s]).name===e&&(i=c)}return i?n.resolvePromise(L(n._url+"/"+i.id,n._overridespref,r,t,n.lrucache,n.interceptor)):n.resolvePromise(null)}))},t.prototype.featureSetById=function(e,t,r){var n=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();var a=JSON.stringify(r);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(a){for(var i=null,l=0,o=a.layers?a.layers:[];l<o.length;l++){null!==(c=o[l]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}if(!i)for(var s=0,u=a.tables?a.tables:[];s<u.length;s++){var c;null!==(c=u[s]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}return i?n.resolvePromise(L(n._url+"/"+i.id,n._overridespref,r,t,n.lrucache,n.interceptor)):n.resolvePromise(null)}))},t}(a);t.createFeatureSetCollectionFromService=function(e,t,r,n){return void 0===r&&(r=null),void 0===n&&(n=null),new A(e,t,r,n)},t.getPortal=function(e,t){return null===e?t:new _.Portal(e.field("url"))},t.constructFeatureSetFromPortalItem=function(e,t,r,a,i,l,o,s){return void 0===s&&(s=null),y.create((function(u,c){if(h.applicationCache){var d=h.applicationCache.getLayerInfo(e+":"+l.url);if(d)return void d.then((function(e){try{var n=F(m.extractServiceUrl(e.item.url)+"/"+t,r,a,i,o,s);u(n)}catch(e){c(e)}}),(function(e){c(e)}))}var f=function(e,t){var r=t.portalUrl+(t.portalUrl.match(/\/$/)?"":"/")+"content/items/"+e;return y.create((function(e,t){return n({url:r,content:{f:"json"},callbackParamName:"callback",load:function(t){e({item:t})},error:function(e){t(e)}})}))}(e,l);h.applicationCache&&h.applicationCache.setLayerInfo(e+":"+l.url,f),f.then((function(e){try{var n=F(m.extractServiceUrl(e.item.url)+"/"+t,r,a,i,o,s);u(n)}catch(e){c(e)}}),(function(t){h.applicationCache&&h.applicationCache.clearLayerInfo(e+":"+l.url),c(t)}))}))},t.constructFeatureSetFromRelationship=function(e,t,r,n,a,i,l,o){void 0===n&&(n=null),void 0===a&&(a=null),void 0===i&&(i=!0),void 0===l&&(l=null),void 0===o&&(o=null);var s=e.serviceUrl();return s?F(s="/"===s.charAt(s.length-1)?s+t.relatedTableId.toString():s+"/"+t.relatedTableId.toString(),n,a,i,l,o).then((function(s){return new p({layer:e,relatedLayer:s,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:i,lrucache:l,interceptor:o})})):null},t.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){var r={metadata:null,networkId:-1,terminals:[],unVersion:3,queryelem:null,layerNameLkp:{},lkp:null};return S(e).then((function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(var i=0,l=a.layers;i<l.length;i++){var o=l[i];r.layerNameLkp[o.id]=o.name}if(a.tables)for(var s=0,u=a.tables;s<u.length;s++){o=u[s];r.layerNameLkp[o.id]=o.name}var c=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=c,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==h.applicationCache){var a=h.applicationCache.getLayerInfo(r);if(null!==a)return a}var i=n({url:e+"/queryDataElements",usePost:!0,handleAs:"json",content:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e){var t=e;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(r,i),i=i.catch((function(e){throw h.applicationCache.clearLayerInfo(r),e}))),i}(e,c).then((function(a){if(a){r.queryelem=a,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(var i=0,l=r.queryelem.dataElement.domainNetworks;i<l.length;i++){for(var o=l[i],s=0,u=o.edgeSources?o.edgeSources:[];s<u.length;s++){(m={layerId:(p=u[s]).layerId,sourceId:p.sourceId,className:r.layerNameLkp[p.layerId]?r.layerNameLkp[p.layerId]:null}).className&&(r.lkp[m.className]=m)}for(var d=0,f=o.junctionSources?o.junctionSources:[];d<f.length;d++){var p,m;(m={layerId:(p=f[d]).layerId,sourceId:p.sourceId,className:r.layerNameLkp[p.layerId]?r.layerNameLkp[p.layerId]:null}).className&&(r.lkp[m.className]=m)}}if(r.queryelem.dataElement.terminalConfigurations)for(var _=0,g=r.queryelem.dataElement.terminalConfigurations;_<g.length;_++)for(var S=0,L=g[_].terminals;S<L.length;S++){var I=L[S];r.terminals.push({terminalId:I.terminalId,terminalName:I.terminalName})}return function(e){if(null!==h.applicationCache){var t=h.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then((function(e){if(e){var t=e;return y.resolve(t)}return y.resolve(null)}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+c).then((function(n){if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){var a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),F(e+"/"+n.systemLayers.associationsTableId.toString(),t,__spreadArrays(["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],a),!1,null).then((function(e){return e.load()})).then((function(e){return r.unVersion>=4?(e=e.filter(v.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))},t.lookupUser=function(e,t,a){if(!r.findCredential(e.portalUrl))return y.resolve(null);if(e.getPortalUser()&&""===t){var i=e.getPortalUser();if(i&&!1===a){for(var l={},o=0,s=["username","id","fullName","availableCredits","assignedCredits","firstName","lastName","preferredView","description","email","idpUsername","favGroupId","lastLogin","mfaEnabled","access","storageUsage","storageQuota","orgId","role","privileges"];o<s.length;o++){var u=s[o];void 0!==i[u]&&(l[u]=i[u])}return y.resolve(l)}}return""===t?y.create((function(t,r){return n({url:e.portalUrl+"community/self",content:__assign({f:"json"},!1===a?{}:{returnUserLicenseTypeExtensions:!0}),callbackParamName:"callback",load:function(e){e&&e.username?t(e):t(null)},error:function(e){r(e)}})})):y.create((function(r,a){return n({url:e.portalUrl+"community/users/"+t,content:{f:"json"},callbackParamName:"callback",load:function(e){e.error?r(null):r(e)},error:function(e){a(e)}})}))}}));