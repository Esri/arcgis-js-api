/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../core/promiseUtils","../kernel","../request","../portal/Portal","../portal/PortalItem","./featureset/support/shared","./featureSetCollection","./featureset/support/cache","../core/sql/WhereClause","./featureset/actions/AttributeFilter","./featureset/actions/OrderBy","./featureset/actions/GroupBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","../layers/FeatureLayer","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated"],(function(e,t,r,n,a,l,s,i,o,u,c,d,h,f,m,y,p,L,S,I){"use strict";function _(e,t){if(u.applicationCache){const n=u.applicationCache.getLayerInfo(e);if(n)return n.then((n=>r.resolve(new p({url:e,outFields:t,sourceJSON:n}))));const a=new p({url:e,outFields:t});let l=r.create(((e,t)=>{a.load().then((()=>{e(a.sourceJSON)}),(e=>{t(e)}))}));return u.applicationCache&&(u.applicationCache.setLayerInfo(e,l),l=l.catch((t=>{throw u.applicationCache.clearLayerInfo(e),t}))),l.then((()=>r.resolve(a)))}return r.resolve(new p({url:e,outFields:t}))}function v(e,t,n,a,l){return _(e,["*"]).then((e=>r.resolve(F(e,t,n,a,l))))}function F(e,t=null,r=null,n=!0,a=null){return!0===e._hasMemorySource()?new S({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a}):new L({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a})}function N(e){if(null!==u.applicationCache){const t=u.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=a(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),r.resolve(t)}return r.resolve({layers:[],tables:[]})}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw u.applicationCache.clearLayerInfo(e),t}))),t}d.registerAction(),f.registerAction(),h.registerAction(),m.registerAction(),y.registerAction();let C=function(e){function n(t,r=null,n=null){var a;return(a=e.call(this)||this)._map=t,a._overridespref=r,a.lrucache=n,a._instantLayers=[],a}t._inheritsLoose(n,e);var a=n.prototype;return a.makeAndAddFeatureSet=function(e,t=!0,r=null){const n=F(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},a.featureSetByName=function(e,t=!0,n=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(e,t,n)}catch(e){return r.reject(e)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let r=0;r<this._instantLayers.length;r++){const n=this._instantLayers[r];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===a)return this.resolvePromise(this._instantLayers[r].featureset)}const l=this._map.layers.find((t=>t instanceof p&&t.title===e));if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,n));if(this._map.tables){const r=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(r){if(r instanceof p)return this.resolvePromise(this.makeAndAddFeatureSet(r,t,n));if(r._materializedTable);else{const e=r.outFields?r:{...r,outFields:["*"]};r._materializedTable=new p(e)}return r._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(r._materializedTable,t,n))))}}return this.resolvePromise(null)},a.featureSetById=function(e,t=!0,n=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(e,t,n)}catch(e){return r.reject(e)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let r=0;r<this._instantLayers.length;r++){const n=this._instantLayers[r];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===a)return this.resolvePromise(this._instantLayers[r].featureset)}const l=this._map.layers.find((t=>t instanceof p&&t.id===e));if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,n));if(this._map.tables){const r=this._map.tables.find((t=>t.id===e));if(r){if(r instanceof p)return this.resolvePromise(this.makeAndAddFeatureSet(r,t,n));if(r._materializedTable);else{const e={...r,outFields:["*"]};r._materializedTable=new p(e)}return r._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(r._materializedTable,t,n))))}}return this.resolvePromise(null)},n}(o),A=function(e){function r(t,r=null,n=null){var a;return(a=e.call(this)||this)._url=t,a._overridespref=r,a.lrucache=n,a.metadata=null,a._instantLayers=[],a}t._inheritsLoose(r,e);var n=r.prototype;return n.makeAndAddFeatureSet=function(e,t=!0,r=null){const n=F(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},n._loadMetaData=function(){return N(this._url).then((e=>(this.metadata=e,e)))},n.load=function(){return this._loadMetaData()},n.clone=function(){return new r(this._url,this._overridespref,this.lrucache)},n.featureSetByName=function(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let r=0;r<this._instantLayers.length;r++){const a=this._instantLayers[r];if(a.opitem.title===e&&a.includeGeometry===t&&a.outFields===n)return this.resolvePromise(this._instantLayers[r].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])t.name===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])t.name===e&&(a=t);return a?_(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))},n.featureSetById=function(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let r=0;r<this._instantLayers.length;r++){const a=this._instantLayers[r];if(a.opitem.id===e&&a.includeGeometry===t&&a.outFields===n)return this.resolvePromise(this._instantLayers[r].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);return a?_(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))},t._createClass(r,[{key:"url",get:function(){return this._url}}]),r}(o);e.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){const n={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return N(e).then((l=>{if(n.metadata=l,l.controllerDatasetLayers&&void 0!==l.controllerDatasetLayers.utilityNetworkLayerId&&null!==l.controllerDatasetLayers.utilityNetworkLayerId){if(l.layers)for(const e of l.layers)n.layerNameLkp[e.id]=e.name;if(l.tables)for(const e of l.tables)n.layerNameLkp[e.id]=e.name;const s=l.controllerDatasetLayers.utilityNetworkLayerId;return n.networkId=s,function(e,t){const r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==u.applicationCache){const e=u.applicationCache.getLayerInfo(r);if(null!==e)return e}let n=a(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((e=>{if(e.data){const t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(r,n),n=n.catch((e=>{throw u.applicationCache.clearLayerInfo(r),e}))),n}(e,s).then((l=>{if(l){n.queryelem=l,n.queryelem&&n.queryelem.dataElement&&void 0!==n.queryelem.dataElement.schemaGeneration&&(n.unVersion=n.queryelem.dataElement.schemaGeneration),n.lkp={},n.queryelem.dataElement.domainNetworks||(n.queryelem.dataElement.domainNetworks=[]);for(const e of n.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:n.layerNameLkp[t.layerId]?n.layerNameLkp[t.layerId]:null};e.className&&(n.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:n.layerNameLkp[t.layerId]?n.layerNameLkp[t.layerId]:null};e.className&&(n.lkp[e.className]=e)}}if(n.queryelem.dataElement.terminalConfigurations)for(const e of n.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)n.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});return function(e){if(null!==u.applicationCache){const t=u.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=a(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return r.resolve(t)}return r.resolve(null)}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw u.applicationCache.clearLayerInfo(e),t}))),t}(e+"/"+s).then((r=>{if(r.systemLayers&&void 0!==r.systemLayers.associationsTableId&&null!==r.systemLayers.associationsTableId){const a=[];return n.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),v(e+"/"+r.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null).then((e=>e.load())).then((e=>n.unVersion>=4?(e=e.filter(c.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e)).then((e=>({lkp:n.lkp,associations:e,unVersion:n.unVersion,terminals:n.terminals})))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))},e.constructFeatureSet=F,e.constructFeatureSetFromPortalItem=function(e,t,n,a,l,o,c){if(u.applicationCache){const s=u.applicationCache.getLayerInfo(e+":"+o.url);if(s)return s.then((e=>{try{const s=new p({url:i.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return r.resolve(F(s,n,a,l,c))}catch(e){return r.reject(e)}}),(e=>r.reject(e)))}return r.create(((r,d)=>{const h=new s({id:e,portal:o}).load();u.applicationCache&&u.applicationCache.setLayerInfo(e+":"+o.url,h),h.then((e=>{try{const s=new p({url:i.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});r(F(s,n,a,l,c))}catch(e){d(e)}}),(t=>{u.applicationCache&&u.applicationCache.clearLayerInfo(e+":"+o.url),d(t)}))}))},e.constructFeatureSetFromRelationship=function(e,t,r,n=null,a=null,l=!0,s=null){let i=e.serviceUrl();return i?(i="/"===i.charAt(i.length-1)?i+t.relatedTableId.toString():i+"/"+t.relatedTableId.toString(),v(i,n,a,l,s).then((i=>new I({layer:e,relatedLayer:i,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:l,lrucache:s})))):null},e.constructFeatureSetFromUrl=v,e.createFeatureSetCollectionFromMap=function(e,t,r=null){return new C(e,t,r)},e.createFeatureSetCollectionFromService=function(e,t,r=null){return new A(e,t,r)},e.getPortal=function(e,t){return null===e?t:new l({url:e.field("url")})},e.initialiseMetaDataCache=function(){null===u.applicationCache&&(u.applicationCache=new u)},e.lookupUser=function(e,t,l){return n.id.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===l?r.resolve(e.user.sourceJSON):""===t?a(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===l?{}:{returnUserLicenseTypeExtensions:!0}}}).then((e=>{if(e.data){const t=e.data;if(t&&t.username)return r.resolve(t)}return r.resolve(null)})):a(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.error?null:r.resolve(t)}return r.resolve(null)})):r.resolve(null)},Object.defineProperty(e,"__esModule",{value:!0})}));
