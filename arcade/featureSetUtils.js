/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../core/promiseUtils","../kernel","../request","../portal/Portal","../portal/PortalItem","./featureset/support/shared","./featureSetCollection","./featureset/support/cache","../core/sql/WhereClause","./featureset/actions/AttributeFilter","./featureset/actions/OrderBy","./featureset/actions/GroupBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","../layers/FeatureLayer","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated"],(function(e,t,r,n,a,l,s,i,o,u,c,d,h,f,m,p,y,L,S,I){"use strict";function _(){null===u.applicationCache&&(u.applicationCache=new u)}function v(e,t){if(u.applicationCache){const n=u.applicationCache.getLayerInfo(e);if(n)return n.then((n=>r.resolve(new y({url:e,outFields:t,sourceJSON:n}))));const a=new y({url:e,outFields:t});let l=r.create(((e,t)=>{a.load().then((()=>{e(a.sourceJSON)}),(e=>{t(e)}))}));return u.applicationCache&&(u.applicationCache.setLayerInfo(e,l),l=l.catch((t=>{throw u.applicationCache.clearLayerInfo(e),t}))),l.then((()=>r.resolve(a)))}return r.resolve(new y({url:e,outFields:t}))}function F(e,t,n,a,l,s=null){return v(e,["*"]).then((e=>r.resolve(N(e,t,n,a,l,s))))}function N(e,t=null,r=null,n=!0,a=null,l=null){return!0===e._hasMemorySource()?new S({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:l}):new L({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:l})}function C(e){if(null!==u.applicationCache){const t=u.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=a(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return r.resolve(t)}return r.resolve(null)}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw u.applicationCache.clearLayerInfo(e),t}))),t}function A(e,t){const r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==u.applicationCache){const e=u.applicationCache.getLayerInfo(r);if(null!==e)return e}let n=a(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((e=>{if(e.data){const t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(r,n),n=n.catch((e=>{throw u.applicationCache.clearLayerInfo(r),e}))),n}function T(e){if(null!==u.applicationCache){const t=u.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=a(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),r.resolve(t)}const t={layers:[],tables:[]};return r.resolve(t)}));return null!==u.applicationCache&&(u.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw u.applicationCache.clearLayerInfo(e),t}))),t}function g(e,t){const r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return T(e).then((n=>{if(r.metadata=n,n.controllerDatasetLayers&&void 0!==n.controllerDatasetLayers.utilityNetworkLayerId&&null!==n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const e of n.layers)r.layerNameLkp[e.id]=e.name;if(n.tables)for(const e of n.tables)r.layerNameLkp[e.id]=e.name;const a=n.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=a,A(e,a).then((n=>{if(n){r.queryelem=n,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(const e of r.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]?r.layerNameLkp[t.layerId]:null};e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(const e of r.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});return C(e+"/"+a).then((n=>{if(n.systemLayers&&void 0!==n.systemLayers.associationsTableId&&null!==n.systemLayers.associationsTableId){const a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),F(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null,null).then((e=>e.load())).then((e=>r.unVersion>=4?(e=e.filter(c.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e)).then((e=>({lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals})))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function k(e,t,r,n=null,a=null,l=!0,s=null,i=null){let o=e.serviceUrl();return o?(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),F(o,n,a,l,s,i).then((o=>new I({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:l,lrucache:s,interceptor:i})))):null}d.registerAction(),f.registerAction(),h.registerAction(),m.registerAction(),p.registerAction();let O=function(e){function n(t,r=null,n=null,a=null){var l;return(l=e.call(this)||this)._map=t,l._overridespref=r,l.lrucache=n,l.interceptor=a,l._instantLayers=[],l}t._inheritsLoose(n,e);var a=n.prototype;return a.makeAndAddFeatureSet=function(e,t=!0,r=null){const n=N(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},a.featureSetByName=function(e,t=!0,n=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(e,t,n)}catch(a){return r.reject(a)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let r=0;r<this._instantLayers.length;r++){const n=this._instantLayers[r];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===a)return this.resolvePromise(this._instantLayers[r].featureset)}const l=this._map.layers.find((t=>t instanceof y&&t.title===e));if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,n));if(this._map.tables){const r=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(r){if(r instanceof y)return this.resolvePromise(this.makeAndAddFeatureSet(r,t,n));if(r._materializedTable);else{const e=r.outFields?r:{...r,outFields:["*"]};r._materializedTable=new y(e)}return r._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(r._materializedTable,t,n))))}}return this.resolvePromise(null)},a.featureSetById=function(e,t=!0,n=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(e,t,n)}catch(a){return r.reject(a)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let r=0;r<this._instantLayers.length;r++){const n=this._instantLayers[r];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===a)return this.resolvePromise(this._instantLayers[r].featureset)}const l=this._map.layers.find((t=>t instanceof y&&t.id===e));if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,n));if(this._map.tables){const r=this._map.tables.find((t=>t.id===e));if(r){if(r instanceof y)return this.resolvePromise(this.makeAndAddFeatureSet(r,t,n));if(r._materializedTable);else{const e={...r,outFields:["*"]};r._materializedTable=new y(e)}return r._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(r._materializedTable,t,n))))}}return this.resolvePromise(null)},n}(o),b=function(e){function r(t,r=null,n=null,a=null){var l;return(l=e.call(this)||this)._url=t,l._overridespref=r,l.lrucache=n,l.interceptor=a,l.metadata=null,l._instantLayers=[],l}t._inheritsLoose(r,e);var n=r.prototype;return n.makeAndAddFeatureSet=function(e,t=!0,r=null){const n=N(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},n._loadMetaData=function(){return T(this._url).then((e=>(this.metadata=e,e)))},n.load=function(){return this._loadMetaData()},n.clone=function(){return new r(this._url,this._overridespref,this.lrucache,this.interceptor)},n.featureSetByName=function(e,t=!0,r=null){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.title===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])t.name===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])t.name===e&&(a=t);return a?v(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))},n.featureSetById=function(e,t=!0,r=["*"]){null===r&&(r=["*"]),r=(r=r.slice(0)).sort();const n=JSON.stringify(r);e=null!=e?e.toString():"";for(let a=0;a<this._instantLayers.length;a++){const r=this._instantLayers[a];if(r.opitem.id===e&&r.includeGeometry===t&&r.outFields===n)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((n=>{let a=null;for(const t of n.layers?n.layers:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);if(!a)for(const t of n.tables?n.tables:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(a=t);return a?v(this._url+"/"+a.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,r))):this.resolvePromise(null)}))},t._createClass(r,[{key:"url",get:function(){return this._url}}]),r}(o);function w(e,t,r=null,n=null){return new O(e,t,r,n)}function E(e,t,r=null,n=null){return new b(e,t,r,n)}function D(e,t){if(null===e)return t;return new l({url:e.field("url")})}function P(e,t,l){return n.id.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===l?r.resolve(e.user.sourceJSON):""===t?a(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===l?{}:{returnUserLicenseTypeExtensions:!0}}}).then((e=>{if(e.data){const t=e.data;if(t&&t.username)return r.resolve(t)}return r.resolve(null)})):a(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.error?null:r.resolve(t)}return r.resolve(null)})):r.resolve(null)}function q(e,t,n,a,l,o,c,d=null){if(u.applicationCache){const s=u.applicationCache.getLayerInfo(e+":"+o.url);if(s)return s.then((e=>{try{const s=new y({url:i.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return r.resolve(N(s,n,a,l,c,d))}catch(s){return r.reject(s)}}),(e=>r.reject(e)))}return r.create(((r,h)=>{const f=new s({id:e,portal:o}).load();u.applicationCache&&u.applicationCache.setLayerInfo(e+":"+o.url,f),f.then((e=>{try{const s=new y({url:i.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});r(N(s,n,a,l,c,d))}catch(s){h(s)}}),(t=>{u.applicationCache&&u.applicationCache.clearLayerInfo(e+":"+o.url),h(t)}))}))}e.constructAssociationMetaDataFeatureSetFromUrl=g,e.constructFeatureSet=N,e.constructFeatureSetFromPortalItem=q,e.constructFeatureSetFromRelationship=k,e.constructFeatureSetFromUrl=F,e.createFeatureSetCollectionFromMap=w,e.createFeatureSetCollectionFromService=E,e.getPortal=D,e.initialiseMetaDataCache=_,e.lookupUser=P,Object.defineProperty(e,"__esModule",{value:!0})}));
