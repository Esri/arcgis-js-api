// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../request","./featureSetCollection","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/shared","../core/promiseUtils","../core/sql/WhereClause","../layers/FeatureLayer","../portal/Portal","../portal/PortalItem"],(function(e,t,r,a,n,i,l,o,s,u,c,d,f,h,m,p,y,v,_,S){"use strict";function L(e,t){if(h.applicationCache){var r=h.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return p.resolve(new v({url:e,outFields:t,sourceJSON:r}))}));var a=new v({url:e,outFields:t}),n=p.create((function(e,t){a.load().then((function(){e(a.sourceJSON)}),(function(e){t(e)}))}));return h.applicationCache&&(h.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),n.then((function(){return p.resolve(a)}))}return p.resolve(new v({url:e,outFields:t}))}function F(e,t,r,a,n){return L(e,["*"]).then((function(e){return p.resolve(I(e,t,r,a,n))}))}function I(e,t,r,a,n){return void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),!0===e._hasMemorySource()?new d({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n}):new c({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n})}function g(e){if(null!==h.applicationCache){var t=h.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=a(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),p.resolve(t)}return p.resolve({layers:[],tables:[]})}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),r}Object.defineProperty(t,"__esModule",{value:!0}),t.constructFeatureSetFromPortalItem=t.getPortal=t.createFeatureSetCollectionFromService=t.createFeatureSetCollectionFromMap=t.constructFeatureSetFromRelationship=t.constructAssociationMetaDataFeatureSetFromUrl=t.constructFeatureSet=t.constructFeatureSetFromUrl=t.initialiseMetaDataCache=void 0,i.registerAction(),l.registerAction(),o.registerAction(),s.registerAction(),u.registerAction(),t.initialiseMetaDataCache=function(){null===h.applicationCache&&(h.applicationCache=new h)},t.constructFeatureSetFromUrl=F,t.constructFeatureSet=I,t.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){var n={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return g(e).then((function(i){if(n.metadata=i,i.controllerDatasetLayers&&void 0!==i.controllerDatasetLayers.utilityNetworkLayerId&&null!==i.controllerDatasetLayers.utilityNetworkLayerId){if(i.layers)for(var l=0,o=i.layers;l<o.length;l++){var s=o[l];n.layerNameLkp[s.id]=s.name}if(i.tables)for(var u=0,c=i.tables;u<c.length;u++){s=c[u];n.layerNameLkp[s.id]=s.name}var d=i.controllerDatasetLayers.utilityNetworkLayerId;return n.networkId=d,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==h.applicationCache){var n=h.applicationCache.getLayerInfo(r);if(null!==n)return n}var i=a(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(r,i),i=i.catch((function(e){throw h.applicationCache.clearLayerInfo(r),e}))),i}(e,d).then((function(i){if(i){n.queryelem=i,n.queryelem&&n.queryelem.dataElement&&void 0!==n.queryelem.dataElement.schemaGeneration&&(n.unVersion=n.queryelem.dataElement.schemaGeneration),n.lkp={},n.queryelem.dataElement.domainNetworks||(n.queryelem.dataElement.domainNetworks=[]);for(var l=0,o=n.queryelem.dataElement.domainNetworks;l<o.length;l++){for(var s=o[l],u=0,c=s.edgeSources?s.edgeSources:[];u<c.length;u++){(_={layerId:(v=c[u]).layerId,sourceId:v.sourceId,className:n.layerNameLkp[v.layerId]?n.layerNameLkp[v.layerId]:null}).className&&(n.lkp[_.className]=_)}for(var f=0,m=s.junctionSources?s.junctionSources:[];f<m.length;f++){var v,_;(_={layerId:(v=m[f]).layerId,sourceId:v.sourceId,className:n.layerNameLkp[v.layerId]?n.layerNameLkp[v.layerId]:null}).className&&(n.lkp[_.className]=_)}}if(n.queryelem.dataElement.terminalConfigurations)for(var S=0,L=n.queryelem.dataElement.terminalConfigurations;S<L.length;S++)for(var I=0,g=L[S].terminals;I<g.length;I++){var C=g[I];n.terminals.push({terminalId:C.terminalId,terminalName:C.terminalName})}return function(e){if(null!==h.applicationCache){var t=h.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=a(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return p.resolve(t)}return p.resolve(null)}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+d).then((function(a){if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){var i=[];return n.unVersion>=4&&(i.push("STATUS"),i.push("PERCENTALONG")),F(e+"/"+a.systemLayers.associationsTableId.toString(),t,r.__spreadArrays(["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],i),!1,null).then((function(e){return e.load()})).then((function(e){return n.unVersion>=4?(e=e.filter(y.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:n.lkp,associations:e,unVersion:n.unVersion,terminals:n.terminals}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))},t.constructFeatureSetFromRelationship=function(e,t,r,a,n,i,l){void 0===a&&(a=null),void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null);var o=e.serviceUrl();return o?F(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),a,n,i,l).then((function(o){return new f({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l})})):null};var C=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._map=t,n._overridespref=r,n.lrucache=a,n._instantLayers=[],n}return r.__extends(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=I(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,a){var n=this;if(void 0===t&&(t=!0),void 0===a&&(a=null),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return n.featureSetByName(e,t,a)}catch(e){return p.reject(e)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.title===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var s=this._map.layers.find((function(t){return t instanceof v&&t.title===e}));if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,t,a));if(this._map.tables){var u=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(u){if(u instanceof v)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,a));if(u._materializedTable);else{var c=u.outFields?u:r.__assign(r.__assign({},u),{outFields:["*"]});u._materializedTable=new v(c)}return u._materializedTable.load().then((function(){return n.resolvePromise(n.makeAndAddFeatureSet(u._materializedTable,t,a))}))}}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,a){var n=this;if(void 0===t&&(t=!0),void 0===a&&(a=["*"]),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return n.featureSetById(e,t,a)}catch(e){return p.reject(e)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.id===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var s=this._map.layers.find((function(t){return t instanceof v&&t.id===e}));if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,t,a));if(this._map.tables){var u=this._map.tables.find((function(t){return t.id===e}));if(u){if(u instanceof v)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,a));if(u._materializedTable);else{var c=r.__assign(r.__assign({},u),{outFields:["*"]});u._materializedTable=new v(c)}return u._materializedTable.load().then((function(){return n.resolvePromise(n.makeAndAddFeatureSet(u._materializedTable,t,a))}))}}return this.resolvePromise(null)},t}(n),N=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._url=t,n._overridespref=r,n.lrucache=a,n.metadata=null,n._instantLayers=[],n}return r.__extends(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0}),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=I(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype._loadMetaData=function(){var e=this;return g(this._url).then((function(t){return e.metadata=t,t}))},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var n=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){(c=o[l]).name===e&&(i=c)}if(!i)for(var s=0,u=n.tables?n.tables:[];s<u.length;s++){var c;(c=u[s]).name===e&&(i=c)}return i?L(a._url+"/"+i.id,["*"]).then((function(e){return a.makeAndAddFeatureSet(e,t,r)})):a.resolvePromise(null)}))},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();var n=JSON.stringify(r);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){null!==(c=o[l]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}if(!i)for(var s=0,u=n.tables?n.tables:[];s<u.length;s++){var c;null!==(c=u[s]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}return i?L(a._url+"/"+i.id,["*"]).then((function(e){return a.makeAndAddFeatureSet(e,t,r)})):a.resolvePromise(null)}))},t}(n);t.createFeatureSetCollectionFromMap=function(e,t,r){return void 0===r&&(r=null),new C(e,t,r)},t.createFeatureSetCollectionFromService=function(e,t,r){return void 0===r&&(r=null),new N(e,t,r)},t.getPortal=function(e,t){return null===e?t:new _({url:e.field("url")})},t.constructFeatureSetFromPortalItem=function(e,t,r,a,n,i,l){if(h.applicationCache){var o=h.applicationCache.getLayerInfo(e+":"+i.url);if(o)return o.then((function(e){try{var i=new v({url:m.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return p.resolve(I(i,r,a,n,l))}catch(e){return p.reject(e)}}),(function(e){return p.reject(e)}))}return p.create((function(o,s){var u=new S({id:e,portal:i}).load();h.applicationCache&&h.applicationCache.setLayerInfo(e+":"+i.url,u),u.then((function(e){try{var i=new v({url:m.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});o(I(i,r,a,n,l))}catch(e){s(e)}}),(function(t){h.applicationCache&&h.applicationCache.clearLayerInfo(e+":"+i.url),s(t)}))}))}}));