/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["require","exports","./ArcadePortal","./Attachment","./Dictionary","./Feature","./ImmutablePathArray","./ImmutablePointArray","../chunks/languageUtils","./treeAnalysis","../chunks/array","./functions/date","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","../core/promiseUtils","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","../geometry/SpatialReference","../views/2d/layers/features/support/FeatureSetReader"],(function(e,t,r,n,o,a,i,s,l,c,u,p,f,m,g,h,d,y,b,S,E,w,N,v,M,I){"use strict";function O(e,t){const r=[];for(let n=0;n<t.arguments.length;n++)r.push(A(e,t.arguments[n]));return r}function x(e,t,r){try{return r(e,null,t.arguments)}catch(n){throw n}}function T(e){return e instanceof Error?y.reject(e):y.reject(new Error(e))}function A(e,t){try{switch(t.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclarator":return G(e,t);case"VariableDeclaration":return V(e,t);case"BlockStatement":return j(e,t);case"FunctionDeclaration":return Y(e,t);case"ReturnStatement":return B(e,t);case"IfStatement":return L(e,t);case"ExpressionStatement":return k(e,t);case"AssignmentExpression":return P(e,t);case"UpdateExpression":return U(e,t);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"TemplateLiteral":return W(e,t);case"TemplateElement":return JSON.stringify(t.value?t.value.cooked:"");case"ForStatement":return _(e,t);case"ForInStatement":return F(e,t);case"Identifier":return Q(e,t);case"MemberExpression":return J(e,t);case"Literal":return null===t.value||void 0===t.value?"null":JSON.stringify(t.value);case"ThisExpression":case"ConditionalExpression":case"Array":throw new Error(c.nodeErrorMessage(t,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return $(e,t);case"UnaryExpression":return Z(e,t);case"BinaryExpression":return K(e,t);case"LogicalExpression":return X(e,t);case"ArrayExpression":return H(e,t);case"ObjectExpression":return R(e,t);case"Property":return C(e,t);default:throw new Error(c.nodeErrorMessage(t,"RUNTIME","UNREOGNISED"))}}catch(r){throw r}}function R(e,t){let r="lang.dictionary([";for(let n=0;n<t.properties.length;n++){const o=t.properties[n];n>0&&(r+=","),r+="lang.strCheck("+("Identifier"===o.key.type?"'"+o.key.name+"'":A(e,o.key))+",'ObjectExpression'),lang.aCheck("+A(e,o.value)+", 'ObjectExpression')"}return r+="])",r}function C(e,t){throw new Error("Should not get here")}function F(e,t){const r=ce(e),n=ce(e),o=ce(e);let a="var "+r+" = "+A(e,t.right)+";\n";"VariableDeclaration"===t.left.type&&(a+=A(e,t.left));let i="VariableDeclaration"===t.left.type?t.left.declarations[0].id.name:t.left.name;i=i.toLowerCase();let s="";return null!==e.localScope&&(void 0!==e.localScope[i]?s="lscope['"+i+"']":void 0!==e.localScope._SymbolsMap[i]&&(s="lscope['"+e.localScope._SymbolsMap[i]+"']")),""===s&&(void 0!==e.globalScope[i]?s="gscope['"+i+"']":void 0!==e.globalScope._SymbolsMap[i]&&(s="gscope['"+e.globalScope._SymbolsMap[i]+"']")),a+="if ("+r+"===null) {  lastStatement = lc.voidOperation; }\n ",a+="else if (lc.isArray("+r+") || lc.isString("+r+")) {",a+="var "+n+"="+r+".length; \n",a+="for(var "+o+"=0; "+o+"<"+n+"; "+o+"++) {\n",a+=s+"="+o+";\n",a+=A(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (lc.isImmutableArray("+r+")) {",a+="var "+n+"="+r+".length(); \n",a+="for(var "+o+"=0; "+o+"<"+n+"; "+o+"++) {\n",a+=s+"="+o+";\n",a+=A(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (( "+r+" instanceof lang.Dictionary) || ( "+r+" instanceof lang.Feature)) {",a+="var "+n+"="+r+".keys(); \n",a+="for(var "+o+"=0; "+o+"<"+n+".length; "+o+"++) {\n",a+=s+"="+n+"["+o+"];\n",a+=A(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",e.isAsync&&(a+="else if (lc.isFeatureSet("+r+")) {",a+="var "+n+"="+r+".iterator(runtimeCtx.abortSignal); \n",a+="for(var "+o+"=lang. graphicToFeature( yield "+n+".next(),"+r+"); "+o+"!=null; "+o+"=lang. graphicToFeature( yield "+n+".next(),"+r+")) {\n",a+=s+"="+o+";\n",a+=A(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n"),a+="else { lastStatement = lc.voidOperation; } \n",a}function _(e,t){let r="lastStatement = lc.voidOperation; \n";null!==t.init&&(r+=A(e,t.init)+"; ");const n=ce(e),o=ce(e);return r+="var "+n+" = true; ",r+="\n do { ",null!==t.update&&(r+=" if ("+n+"===false) {\n "+A(e,t.update)+"  \n}\n "+n+"=false; \n"),null!==t.test&&(r+="var "+o+" = "+A(e,t.test)+"; ",r+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error({type: '"+t.type+"'},'RUNTIME','CANNOT_USE_NONBOOLEAN_IN_CONDITION');   }\n"),r+=A(e,t.body),null!==t.update&&(r+="\n "+A(e,t.update)),r+="\n"+n+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",r}function U(e,t){let r=null,n="";if("MemberExpression"===t.argument.type)return r=A(e,t.argument.object),n=!0===t.argument.computed?A(e,t.argument.property):"'"+t.argument.property.name+"'","lang.memberupdate("+r+","+n+",'"+t.operator+"',"+t.prefix+")";if(r=t.argument.name.toLowerCase(),null!==e.localScope){if(void 0!==e.localScope[r])return"lang.update(lscope, '"+r+"','"+t.operator+"',"+t.prefix+")";if(void 0!==e.localScope._SymbolsMap[r])return"lang.update(lscope, '"+e.localScope._SymbolsMap[r]+"','"+t.operator+"',"+t.prefix+")"}if(void 0!==e.globalScope[r])return"lang.update(gscope, '"+r+"','"+t.operator+"',"+t.prefix+")";if(void 0!==e.globalScope._SymbolsMap[r])return"lang.update(gscope, '"+e.globalScope._SymbolsMap[r]+"','"+t.operator+"',"+t.prefix+")";throw new Error("Variable not recognised")}function P(e,t){const r=A(e,t.right);let n=null,o="";if("MemberExpression"===t.left.type)return n=A(e,t.left.object),o=!0===t.left.computed?A(e,t.left.property):"'"+t.left.property.name+"'","lang.assignmember("+n+","+o+",'"+t.operator+"',"+r+")";if(n=t.left.name.toLowerCase(),null!==e.localScope){if(void 0!==e.localScope[n])return"lscope['"+n+"']=lang.assign("+r+",'"+t.operator+"', lscope['"+n+"'])";if(void 0!==e.localScope._SymbolsMap[n])return"lscope['"+e.localScope._SymbolsMap[n]+"']=lang.assign("+r+",'"+t.operator+"', lscope['"+e.localScope._SymbolsMap[n]+"'])"}if(void 0!==e.globalScope[n])return"gscope['"+n+"']=lang.assign("+r+",'"+t.operator+"', gscope['"+n+"'])";if(void 0!==e.globalScope._SymbolsMap[n])return"gscope['"+e.globalScope._SymbolsMap[n]+"']=lang.assign("+r+",'"+t.operator+"', gscope['"+e.globalScope._SymbolsMap[n]+"'])";throw new Error("Variable not recognised")}function k(e,t){return"AssignmentExpression"===t.expression.type?"lastStatement = lc.voidOperation; "+A(e,t.expression)+"; \n ":(t.expression.type,"lastStatement = "+A(e,t.expression)+"; ")}function D(e,t){return"BlockStatement"===t.type?A(e,t):"ReturnStatement"===t.type||"BreakStatement"===t.type||"ContinueStatement"===t.type?A(e,t)+"; ":"UpdateExpression"===t.type?"lastStatement = "+A(e,t)+"; ":"ExpressionStatement"===t.type?A(e,t):"ObjectExpression"===t.type?"lastStatement = "+A(e,t)+"; ":A(e,t)+"; "}function L(e,t){if("AssignmentExpression"===t.test.type||"UpdateExpression"===t.test.type)throw new Error(c.nodeErrorMessage(t.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));const r=A(e,t.test),n=ce(e);let o="var "+n+" = "+r+";\n if ("+n+" === true) {\n"+D(e,t.consequent)+"\n }\n";return null!==t.alternate?o+="else if ("+n+"===false)   { \n"+D(e,t.alternate)+"}\n":o+="else if ("+n+"===false) { \n lastStatement = lc.voidOperation;\n }\n",o+="else { lang.error({type: '"+t.type+"'},'RUNTIME','CANNOT_USE_NONBOOLEAN_IN_CONDITION'); \n}\n",o}function j(e,t){let r="";for(let n=0;n<t.body.length;n++)"ReturnStatement"===t.body[n].type||"BreakStatement"===t.body[n].type||"ContinueStatement"===t.body[n].type?r+=A(e,t.body[n])+"; \n":"UpdateExpression"===t.body[n].type||"ObjectExpression"===t.body[n].type?r+="lastStatement = "+A(e,t.body[n])+"; \n":r+=A(e,t.body[n])+" \n";return r}function B(e,t){if(null===t.argument)return"return lc.voidOperation";return"return "+A(e,t.argument)}function Y(e,t){const r=t.id.name.toLowerCase(),n={isAsync:e.isAsync,spatialReference:e.spatialReference,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,symbols:e.symbols,mangleMap:e.mangleMap,localScope:{_SymbolsMap:{}},depthCounter:e.depthCounter+1,globalScope:e.globalScope};if(n.depthCounter>64)throw new Error("Exceeded maximum function depth");let o="new lc.SizzleFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n";for(let a=0;a<t.params.length;a++){const r=t.params[a].name.toLowerCase(),i=le(e);n.localScope._SymbolsMap[r]=i,n.mangleMap[r]=i,o+="lscope['"+i+"']=arguments["+a.toString()+"];\n"}if(!0===e.isAsync?(o+="return lang.__awaiter(this, void 0, void 0, function* () {\n",o+=j(n,t.body)+"\n return lastStatement; ",o+="});  }",o+=", runtimeCtx),"+t.params.length+")",o+="\n lastStatement = lc.voidOperation; \n"):(o+=j(n,t.body)+"\n return lastStatement; }, runtimeCtx),"+t.params.length+")",o+="\n lastStatement = lc.voidOperation; \n"),void 0!==e.globalScope[r])return"gscope['"+r+"']="+o;if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']="+o;{const t=le(e);return e.globalScope._SymbolsMap[r]=t,e.mangleMap[r]=t,"gscope['"+t+"']="+o}}function V(e,t){const r=[];for(let n=0;n<t.declarations.length;n++)r.push(A(e,t.declarations[n]));return r.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}function G(e,t){let r=null===t.init?null:A(e,t.init);r===l.voidOperation&&(r=null);const n=t.id.name.toLowerCase();if(null!==e.localScope){if(void 0!==e.localScope[n])return"lscope['"+n+"']="+r+"; ";if(void 0!==e.localScope._SymbolsMap[n])return"lscope['"+e.localScope._SymbolsMap[n]+"']="+r+"; ";{const t=le(e);return e.localScope._SymbolsMap[n]=t,e.mangleMap[n]=t,"lscope['"+t+"']="+r+"; "}}if(void 0!==e.globalScope[n])return"gscope['"+n+"']="+r+"; ";if(void 0!==e.globalScope._SymbolsMap[n])return"gscope['"+e.globalScope._SymbolsMap[n]+"']="+r+"; ";{const t=le(e);return e.globalScope._SymbolsMap[n]=t,e.mangleMap[n]=t,"gscope['"+t+"']="+r+"; "}}let z=0;function q(e,t,r){let n;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let r=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(r=!1),r&&(z++,e.spatialReference._arcadeCacheId=z,t=z)}const r=new o({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(r._arcadeCacheId="SPREF"+t.toString()),r}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const r=e[t];return void 0!==r?r:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":n=e.cache._arcadeCacheId,void 0===n&&(z++,n=z,e.cache._arcadeCacheId=n);return new i(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,n);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":n=e.cache._arcadeCacheId,void 0===n&&(z++,n=z,e.cache._arcadeCacheId=n);return new i(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,n);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":n=e.cache._arcadeCacheId,void 0===n&&(z++,n=z,e.cache._arcadeCacheId=n);return new s(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,n,1);case"type":return"Multipoint"}}throw new Error(c.nodeErrorMessage(r,"RUNTIME","PROPERTYNOTFOUND"))}function J(e,t){try{let r;return r=!0===t.computed?A(e,t.property):"'"+t.property.name+"'","lang.member("+A(e,t.object)+","+r+")"}catch(r){throw r}}function Z(e,t){try{return"lang.unary("+A(e,t.argument)+",'"+t.operator+"')"}catch(r){throw r}}function H(e,t){try{const r=[];for(let n=0;n<t.elements.length;n++)"Literal"===t.elements[n].type?r.push(A(e,t.elements[n])):r.push("lang.aCheck("+A(e,t.elements[n])+",'ArrayExpression')");return"["+r.join(",")+"]"}catch(r){throw r}}function W(e,t){try{const r=[];let n=0;for(const o of t.quasis)r.push(o.value?JSON.stringify(o.value.cooked):JSON.stringify("")),!1===o.tail&&(r.push(t.expressions[n]?"lang.castString(lang.aCheck("+A(e,t.expressions[n])+", 'TemplateLiteral'))":""),n++);return"(["+r.join(",")+"]).join('')"}catch(r){throw r}}function K(e,t){try{return"lang.binary("+A(e,t.left)+","+A(e,t.right)+",'"+t.operator+"')"}catch(r){throw r}}function X(e,t){try{if("AssignmentExpression"===t.left.type||"UpdateExpression"===t.left.type)throw new Error(c.nodeErrorMessage(t.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("AssignmentExpression"===t.right.type||"UpdateExpression"===t.right.type)throw new Error(c.nodeErrorMessage(t.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("&&"===t.operator||"||"===t.operator)return"(lang.logicalCheck("+A(e,t.left)+") "+t.operator+" lang.logicalCheck("+A(e,t.right)+"))";throw new Error(c.nodeErrorMessage(t,"RUNTIME","ONLYORORAND"))}catch(r){throw r}}function Q(e,t){try{const r=t.name.toLowerCase();if(null!==e.localScope){if(void 0!==e.localScope[r])return"lscope['"+r+"']";if(void 0!==e.localScope._SymbolsMap[r])return"lscope['"+e.localScope._SymbolsMap[r]+"']"}if(void 0!==e.globalScope[r])return"gscope['"+r+"']";if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']";throw new Error(c.nodeErrorMessage(t,"RUNTIME","VARIABLENOTFOUND"))}catch(r){throw r}}function $(e,t){try{if("Identifier"!==t.callee.type)throw new Error(c.nodeErrorMessage(t,"RUNTIME","ONLYNODESSUPPORTED"));const r=t.callee.name.toLowerCase();let n="";if(null!==e.localScope&&(void 0!==e.localScope[r]?n="lscope['"+r+"']":void 0!==e.localScope._SymbolsMap[r]&&(n="lscope['"+e.localScope._SymbolsMap[r]+"']")),""===n&&(void 0!==e.globalScope[r]?n="gscope['"+r+"']":void 0!==e.globalScope._SymbolsMap[r]&&(n="gscope['"+e.globalScope._SymbolsMap[r]+"']")),""!==n){let r="[";for(let n=0;n<t.arguments.length;n++)n>0&&(r+=", "),r+=A(e,t.arguments[n]);return r+="]",e.isAsync?"(yield lang.callfunc("+n+","+r+",runtimeCtx) )":"lang.callfunc("+n+","+r+",runtimeCtx)"}throw new Error(c.nodeErrorMessage(t,"RUNTIME","NOTFOUND"))}catch(r){throw r}}const ee={};function te(e){return null===e?"":l.isArray(e)||l.isImmutableArray(e)?"Array":l.isDate(e)?"Date":l.isString(e)?"String":l.isBoolean(e)?"Boolean":l.isNumber(e)?"Number":e instanceof n?"Attachment":e instanceof r?"Portal":e instanceof o?"Dictionary":e instanceof a?"Feature":e instanceof w?"Point":e instanceof N?"Polygon":e instanceof v?"Polyline":e instanceof E?"Multipoint":e instanceof b?"Extent":l.isFunctionParameter(e)?"Function":l.isFeatureSet(e)?"FeatureSet":l.isFeatureSetCollection(e)?"FeatureSetCollection":e===l.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function re(e,t,r,n){try{const o=t[r];if(l.equalityTest(o,n))return t[r+1];{const o=t.length-r;return 1===o?t[r]:2===o?null:3===o?t[r+2]:re(e,t,r+2,n)}}catch(o){throw o}}function ne(e,t,r,n){try{if(!0===n)return t[r+1];if(3===t.length-r)return t[r+2];{const n=t[r+2];if(!1===l.isBoolean(n))throw new Error("WHEN needs boolean test conditions");return ne(e,t,r+2,n)}}catch(o){throw o}}function oe(e,t){const r=e.length,n=Math.floor(r/2);return 0===r?[]:1===r?[e[0]]:ae(oe(e.slice(0,n),t),oe(e.slice(n,r),t),t)}function ae(e,t,r){const n=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=r(e[0],t[0]);isNaN(o)&&(o=0),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(t[0]),t=t.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):t.length>0&&(n.push(t[0]),t=t.slice(1));return n}function ie(e,t){try{const r=e.length,n=Math.floor(r/2);if(0===r)return y.resolve([]);if(1===r)return y.resolve([e[0]]);const o=[ie(e.slice(0,n),t),ie(e.slice(n,r),t)];return y.all(o).then((e=>se(e[0],e[1],t,[])))}catch(r){return y.reject(r)}}function se(e,t,r,n){return y.create(((o,a)=>{const i=n;e.length>0||t.length>0?e.length>0&&t.length>0?r(e[0],t[0]).then((s=>{try{isNaN(s)&&(s=1),s<=0?(i.push(e[0]),e=e.slice(1)):(i.push(t[0]),t=t.slice(1)),se(e,t,r,n).then((e=>{o(e)}),a)}catch(l){a(l)}}),a):e.length>0?(i.push(e[0]),se(e=e.slice(1),t,r,n).then((e=>{o(e)}),a)):t.length>0&&(i.push(t[0]),t=t.slice(1),se(e,t,r,n).then((e=>{o(e)}),a)):o(n)}))}function le(e){return e.symbols.symbolCounter++,"_T"+e.symbols.symbolCounter.toString()}function ce(e){return e.symbols.symbolCounter++,"_Tvar"+e.symbols.symbolCounter.toString()}p.registerFunctions(ee,x),d.registerFunctions(ee,x),g.registerFunctions(ee,x),f.registerFunctions(ee,x),h.registerFunctions(ee,x),ee.typeof=function(e,t){return x(e,t,(function(e,t,r){l.pcCheck(r,1,1);const n=te(r[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n}))},ee.iif=function(e,t){try{return x(e,t,(function(e,t,r){if(l.pcCheck(r,3,3),!1===l.isBoolean(r[0]))throw new Error("IF Function must have a boolean test condition");return r[0]?r[1]:r[2]}))}catch(r){throw r}},ee.decode=function(e,t){try{return x(e,t,(function(t,r,n){if(n.length<2)throw new Error("Missing Parameters");if(2===n.length)return n[1];{if((n.length-1)%2==0)throw new Error("Must have a default value result.");const t=n[0];return re(e,n,1,t)}}))}catch(r){throw r}},ee.when=function(e,t){try{return x(e,t,(function(t,r,n){if(n.length<3)throw new Error("Missing Parameters");if(n.length%2==0)throw new Error("Must have a default value result.");const o=n[0];if(!1===l.isBoolean(o))throw new Error("WHEN needs boolean test conditions");return ne(e,n,0,o)}))}catch(r){throw r}},ee.top=function(e,t){return x(e,t,(function(e,t,r){if(l.pcCheck(r,2,2),l.isArray(r[0]))return l.toNumber(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,l.toNumber(r[1]));if(l.isImmutableArray(r[0]))return l.toNumber(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,l.toNumber(r[1]));throw new Error("Top cannot accept this parameter type")}))},ee.first=function(e,t){return x(e,t,(function(e,t,r){return l.pcCheck(r,1,1),l.isArray(r[0])?0===r[0].length?null:r[0][0]:l.isImmutableArray(r[0])?0===r[0].length()?null:r[0].get(0):null}))},ee.sort=function(e,t){return x(e,t,(function(t,r,n){l.pcCheck(n,1,2);let o=n[0];if(l.isImmutableArray(o)&&(o=o.toArray()),!1===l.isArray(o))throw new Error("Illegal Argument");if(n.length>1){if(!1===l.isFunctionParameter(n[1]))throw new Error("Illegal Argument");let r=o;const a=function(e,r){return Ie.callfunc(n[1],[e,r],t)};return e.isAsync?ie(r,a):(r=oe(r,(function(e,t){return a(e,t)})),r)}{let e=o;if(0===e.length)return[];const t={};for(let o=0;o<e.length;o++){const r=te(e[o]);""!==r&&(t[r]=!0)}if(!0===t.Array||!0===t.Dictionary||!0===t.Feature||!0===t.Point||!0===t.Polygon||!0===t.Polyline||!0===t.Multipoint||!0===t.Extent||!0===t.Function)return e.slice(0);let r=0,n="";for(const o in t)r++,n=o;return e=r>1||"String"===n?oe(e,(function(e,t){if(null==e||e===l.voidOperation)return null==t||t===l.voidOperation?0:1;if(null==t||t===l.voidOperation)return-1;const r=l.toString(e),n=l.toString(t);return r<n?-1:r===n?0:1})):"Number"===n?oe(e,(function(e,t){return e-t})):"Boolean"===n?oe(e,(function(e,t){return e===t?0:t?-1:1})):"Date"===n?oe(e,(function(e,t){return t-e})):e.slice(0),e}}))};const ue={};for(const Ae in ee)ue[Ae]=new l.NativeFunction(ee[Ae]);m.registerFunctions(ee,x);for(const Ae in ee)ee[Ae]=new l.NativeFunction(ee[Ae]);const pe=function(){};pe.prototype=ee;const fe=function(){};function me(e,t,r){const n={};e||(e={}),r||(r={}),n._SymbolsMap={},n.textformatting=1,n.infinity=1,n.pi=1;for(const o in t)n[o]=1;for(const o in r)n[o]=1;for(const o in e)n[o]=1;return n}function ge(e,t,r){const n=r?new fe:new pe;e||(e={}),t||(t={});const i=new o({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});i.immutable=!1,n._SymbolsMap={textformatting:1,infinity:1,pi:1},n.textformatting=i,n.infinity=Number.POSITIVE_INFINITY,n.pi=Math.PI;for(const o in t)n[o]=t[o],n._SymbolsMap[o]=1;for(const o in e)n._SymbolsMap[o]=1,e[o]&&"esri.Graphic"===e[o].declaredClass?n[o]=a.createFromGraphic(e[o]):n[o]=e[o];return n}fe.prototype=ue;const he={fixSpatialReference:l.fixSpatialReference,parseArguments:O,standardFunction:x};function de(e,t){const r={mode:t,compiled:!0,functions:{},signatures:[],failDefferred:T,standardFunction:x,standardFunctionAsync:x,evaluateIdentifier:ve};for(let n=0;n<e.length;n++)e[n].registerFunctions(r);if("sync"===t){for(const e in r.functions)ee[e]=new l.NativeFunction(r.functions[e]),pe.prototype[e]=ee[e];for(let e=0;e<r.signatures.length;e++)c.addFunctionDeclaration(r.signatures[e],"sync")}else{for(const e in r.functions)ue[e]=new l.NativeFunction(r.functions[e]),fe.prototype[e]=ue[e];for(let e=0;e<r.signatures.length;e++)c.addFunctionDeclaration(r.signatures[e],"async")}}function ye(e,t){return e(t)}function be(e,t){return c.findFieldLiterals(e)}function Se(e){return c.findExpectedFieldLiterals(e)}function Ee(e,t){return c.validateScript(e,t,"sync")}function we(e,t){return c.referencesMember(e,t)}function Ne(e,t){return c.referencesFunction(e,t)}function ve(e,t){const r=t.name;if("_SymbolsMap"===r)throw"Illegal";if(e.localStack.length>0){if("_t"!==r.substr(0,2).toLowerCase()&&void 0!==e.localStack[e.localStack.length-1][r])return e.localStack[e.localStack.length-1][r];const t=e.mangleMap[r];if(void 0!==t&&void 0!==e.localStack[e.localStack.length-1][t])return e.localStack[e.localStack.length-1][t]}if("_t"!==r.substr(0,2).toLowerCase()&&void 0!==e.globalScope[r])return e.globalScope[r];if(1===e.globalScope._SymbolsMap[r])return e.globalScope[r];const n=e.mangleMap[r];return void 0!==n?e.globalScope[n]:void 0}de([u.ArrayFunctions],"sync"),de([u.ArrayFunctions],"async");let Me=0;const Ie={error(e,t,r){throw new Error(c.nodeErrorMessage(e,t,r))},__awaiter:(e,t,r,n)=>y.create(((r,o)=>{function a(e){try{s(n.next(e))}catch(t){o(t)}}function i(e){try{s(n.throw(e))}catch(t){o(t)}}function s(e){e.done?r(e.value):e.value&&e.value.then?e.value.then(a,i):(Me++,Me%100==0?setTimeout((()=>{Me=0,a(e.value)}),0):a(e.value))}s((n=n.apply(e,t||[])).next())})),functionDepthchecker:(e,t)=>function(){if(t.depthCounter++,t.localStack.push([]),t.depthCounter>64)throw new Error("Exceeded maximum function depth");const r=e.apply(this,arguments);return y.isPromiseLike(r)?r.then((e=>(t.depthCounter--,t.localStack.length=t.localStack.length-1,e))):(t.depthCounter--,t.localStack.length=t.localStack.length-1,r)},castString:e=>l.toString(e),aCheck(e,t){if(l.isFunctionParameter(e))throw new Error(c.nodeErrorMessage({type:t},"RUNTIME","FUNCTIONCONTEXTILLEGAL"));return e===l.voidOperation?null:e},Dictionary:o,Feature:a,dictionary(e){const t={};for(let n=0;n<e.length;n+=2){if(l.isFunctionParameter(e[n+1]))throw new Error("Illegal Argument");if(!1===l.isString(e[n]))throw new Error("Illegal Argument");e[n+1]===l.voidOperation?t[e[n].toString()]=null:t[e[n].toString()]=e[n+1]}const r=new o(t);return r.immutable=!1,r},strCheck(e){if(!1===l.isString(e))throw new Error("Illegal Argument");return e},unary(e,t){if(l.isBoolean(e)){if("!"===t)return!e;if("-"===t)return-1*l.toNumber(e);if("+"===t)return 1*l.toNumber(e);if("~"===t)return~l.toNumber(e);const r={type:"UnaryExpression",operator:t,prefix:null,argument:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}if("-"===t)return-1*l.toNumber(e);if("+"===t)return 1*l.toNumber(e);if("~"===t)return~l.toNumber(e);const r={type:"UnaryExpression",operator:t,prefix:null,argument:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))},logicalCheck(e){if(!1===l.isBoolean(e)){const e={type:"LogicalExpression",operator:null,left:null,right:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","ONLYORORAND"))}return e},logical(e,t,r){if(l.isBoolean(e)&&l.isBoolean(t))switch(r){case"||":return e||t;case"&&":return e&&t;default:{const e={type:"LogicalExpression",operator:null,left:null,right:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","ONLYORORAND"))}}const n={type:"LogicalExpression",operator:null,left:null,right:null};throw new Error(c.nodeErrorMessage(n,"RUNTIME","ONLYORORAND"))},binary(e,t,r){switch(r){case"|":case"<<":case">>":case">>>":case"^":case"&":return l.binaryOperator(l.toNumber(e),l.toNumber(t),r);case"==":case"=":return l.equalityTest(e,t);case"!=":return!l.equalityTest(e,t);case"<":case">":case"<=":case">=":return l.greaterThanLessThan(e,t,r);case"+":return l.isString(e)||l.isString(t)?l.toString(e)+l.toString(t):l.toNumber(e)+l.toNumber(t);case"-":return l.toNumber(e)-l.toNumber(t);case"*":return l.toNumber(e)*l.toNumber(t);case"/":return l.toNumber(e)/l.toNumber(t);case"%":return l.toNumber(e)%l.toNumber(t);default:{const n={type:"BinaryExpression",operator:r,left:e,right:t};throw new Error(c.nodeErrorMessage(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}},assign(e,t,r){switch(t){case"=":return e===l.voidOperation?null:e;case"/=":return l.toNumber(r)/l.toNumber(e);case"*=":return l.toNumber(r)*l.toNumber(e);case"-=":return l.toNumber(r)-l.toNumber(e);case"+=":return l.isString(r)||l.isString(e)?l.toString(r)+l.toString(e):l.toNumber(r)+l.toNumber(e);case"%=":return l.toNumber(r)%l.toNumber(e);default:{const e={type:"AssignmentExpression",operator:t,left:null,right:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","OPERATORNOTRECOGNISED"))}}},update(e,t,r,n){const o=l.toNumber(e[t]);return e[t]="++"===r?o+1:o-1,!1===n?o:"++"===r?o+1:o-1},graphicToFeature:(e,t)=>null===e?null:a.createFromGraphicLikeObject(e.geometry,e.attributes,t),memberupdate(e,t,r,n){let i;if(l.isArray(e)){if(!l.isNumber(t))throw new Error("Invalid Parameter");if(t<0&&(t=e.length+t),t<0||t>=e.length)throw new Error("Assignment outside of array bounds");i=l.toNumber(e[t]),e[t]="++"===r?i+1:i-1}else if(e instanceof o){if(!1===l.isString(t))throw new Error("Dictionary accessor must be a string");if(!0!==e.hasField(t))throw new Error("Invalid Parameter");i=l.toNumber(e.field(t)),e.setField(t,"++"===r?i+1:i-1)}else{if(!(e instanceof a))throw l.isImmutableArray(e)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===l.isString(t))throw new Error("Feature accessor must be a string");if(!0!==e.hasField(t))throw new Error("Invalid Parameter");i=l.toNumber(e.field(t)),e.setField(t,"++"===r?i+1:i-1)}return!1===n?i:"++"===r?i+1:i-1},assignmember(e,t,r,n){if(l.isArray(e)){if(!l.isNumber(t))throw new Error("Invalid Parameter");if(t<0&&(t=e.length+t),t<0||t>e.length)throw new Error("Assignment outside of array bounds");if(t===e.length){if("="!==r)throw new Error("Invalid Parameter");e[t]=this.assign(n,r,e[t])}else e[t]=this.assign(n,r,e[t])}else if(e instanceof o){if(!1===l.isString(t))throw new Error("Dictionary accessor must be a string");if(!0===e.hasField(t))e.setField(t,this.assign(n,r,e.field(t)));else{if("="!==r)throw new Error("Invalid Parameter");e.setField(t,this.assign(n,r,null))}}else{if(!(e instanceof a))throw l.isImmutableArray(e)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===l.isString(t))throw new Error("Feature accessor must be a string");if(!0===e.hasField(t))e.setField(t,this.assign(n,r,e.field(t)));else{if("="!==r)throw new Error("Invalid Parameter");e.setField(t,this.assign(n,r,null))}}},member(e,t){if(null===e){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","NOTFOUND"))}if(e instanceof I.FeatureSetReader){if(l.isString(t))return e.field(t);const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(e instanceof o||e instanceof a){if(l.isString(t))return e.field(t);const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(e instanceof S){if(l.isString(t))return q(e,t,"MemberExpression");const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(l.isArray(e)){if(l.isNumber(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length+t),t>=e.length||t<0){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","OUTOFBOUNDS"))}return e[t]}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(l.isString(e)){if(l.isNumber(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length+t),t>=e.length||t<0){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","OUTOFBOUNDS"))}return e[t]}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(l.isImmutableArray(e)){if(l.isNumber(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length()+t),t>=e.length()||t<0){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(e,"RUNTIME","OUTOFBOUNDS"))}return e.get(t)}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(c.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))},callfunc(e,t,r){return e instanceof l.NativeFunction?e.fn(r,{arguments:t,preparsed:!0}):e instanceof l.SizzleFunction?e.fn.apply(this,t):e.apply(this,t)}};function Oe(e){console.log(e)}function xe(e,t=null,r=!1){null===t&&(t={vars:{},customfunctions:{}});const n={isAsync:r,globalScope:me(t.vars,r?ue:ee,t.customfunctions),localScope:null,mangleMap:{},console:Oe,lrucache:t.lrucache,interceptor:t.interceptor,services:t.services,symbols:{symbolCounter:0}};let o=A(n,e.body[0].body);""===o&&(o="lc.voidOperation; ");let a="";a=r?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+o+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+o+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";const i={lc:l.lc,lang:Ie,mangles:n.mangleMap,postProcess(e){if(e instanceof l.ReturnResult&&(e=e.value),e instanceof l.ImplicitResult&&(e=e.value),e===l.voidOperation&&(e=null),e===l.breakResult)throw new Error("Cannot return BREAK");if(e===l.continueResult)throw new Error("Cannot return CONTINUE");if(l.isFunctionParameter(e))throw new Error("Cannot return FUNCTION");return e},prepare(e,t){let r=e.spatialReference;null==r&&(r=new M({wkid:102100}));const n=ge(e.vars,e.customfunctions,t);return{localStack:[],isAsync:t,mangleMap:this.mangles,spatialReference:r,globalScope:n,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console?e.console:Oe,lrucache:e.lrucache,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:1}}};return new Function("context","spatialReference",a).bind(i)}function Te(){return new Promise(((t,r)=>e(["./functions/geomasync"],t,r))).then((e=>(de([e],"async"),!0)))}t.compileScript=xe,t.enableAsyncSupport=Te,t.executeScript=ye,t.extend=de,t.extractExpectedFieldLiterals=Se,t.extractFieldLiterals=be,t.functionHelper=he,t.referencesFunction=Ne,t.referencesMember=we,t.validateScript=Ee,Object.defineProperty(t,"__esModule",{value:!0})}));
