// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","./polyfill/tsSupport/awaiter","./polyfill/tsSupport/generator","./polyfill/tsSupport/assign","./polyfill/tsSupport/spreadarray","./polyfill/tsSupport/extends","./Dictionary","./Feature","./languageUtils","./treeAnalysis","./functions/array","./functions/date","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","./polyfill/promiseUtils","../geometry/Geometry","../SpatialReference","./ArcadeModuleLoader","./ArcadeModule","./FunctionWrapper","./executionError"],(function(e,n,r,t,o,a,l,i,c,u,s,d,p,m,g,f,E,h,y,v,b,x,S,w,C){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.enableAsyncSupport=n.compileScript=n.executeScript=n.extend=n.functionHelper=n.UserDefinedCompiledFunction=void 0;var A=function(e){function n(n,r){var t=e.call(this)||this;return t.paramCount=r,t.fn=n,t}return l(n,e),n.prototype.createFunction=function(e){var n=this;return function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];if(r.length!==n.paramCount)throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.WrongNumberOfParameters,null);return n.fn.apply(n,r)}},n.prototype.call=function(e,n){return this.fn.apply(this,n.arguments)},n.prototype.marshalledCall=function(e,n,r,t){var o=this;return t(e,n,(function(n,a,l){l=l.map((function(n){return!u.isFunctionParameter(n)||n instanceof w.ScopeMarshalledFunction?n:w.wrapModuleScopedResponse(n,e,t)}));var i=o.call(r,{arguments:l});return y.isPromiseLike(i)?i.then((function(e){return w.wrapModuleScopedResponse(e,r,t)})):i}))},n}(w.ArcadeFunction);function F(e,n,r){try{return r(e,null,n.arguments)}catch(e){throw e}}function M(e,n){try{switch(n.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclarator":return function(e,n){var r=null===n.init?null:M(e,n.init);r===u.voidOperation&&(r=null);var t=n.id.name.toLowerCase();if(O(t),null!==e.localScope){if(void 0!==e.localScope[t])return"lscope['"+t+"']="+r+"; ";if(void 0!==e.localScope._SymbolsMap[t])return"lscope['"+e.localScope._SymbolsMap[t]+"']="+r+"; ";var o=k(e);return e.localScope._SymbolsMap[t]=o,e.mangleMap[t]=o,"lscope['"+o+"']="+r+"; "}if(void 0!==e.globalScope[t])return"gscope['"+t+"']="+r+"; ";if(void 0!==e.globalScope._SymbolsMap[t])return"gscope['"+e.globalScope._SymbolsMap[t]+"']="+r+"; ";if(e.undeclaredGlobalsInFunctions.has(t)){var a=e.undeclaredGlobalsInFunctions.get(t).manglename;return e.globalScope._SymbolsMap[t]=a,e.mangleMap[t]=a,e.undeclaredGlobalsInFunctions.delete(t),"gscope[lang.setAssig('"+a+"', runtimeCtx)]="+r+"; "}var l=k(e);return e.globalScope._SymbolsMap[t]=l,e.mangleMap[t]=l,"gscope['"+l+"']="+r+"; "}(e,n);case"VariableDeclaration":return function(e,n){for(var r=[],t=0;t<n.declarations.length;t++)r.push(M(e,n.declarations[t]));return r.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}(e,n);case"BlockStatement":case"Program":return N(e,n);case"FunctionDeclaration":return function(e,n){var r=n.id.name.toLowerCase();O(r);var t="",o=!1;void 0!==e.globalScope[r]?t=r:void 0!==e.globalScope._SymbolsMap[r]?t=e.globalScope._SymbolsMap[r]:e.undeclaredGlobalsInFunctions.has(r)?(t=e.undeclaredGlobalsInFunctions.get(r).manglename,e.globalScope._SymbolsMap[r]=t,e.mangleMap[r]=t,e.undeclaredGlobalsInFunctions.delete(r),o=!0):(t=k(e),e.globalScope._SymbolsMap[r]=t,e.mangleMap[r]=t);for(var a={isAsync:e.isAsync,console:e.console,exports:e.exports,undeclaredGlobalsInFunctions:e.undeclaredGlobalsInFunctions,customfunctions:e.customfunctions,moduleFactory:e.moduleFactory,moduleFactoryMap:e.moduleFactoryMap,libraryResolver:e.libraryResolver,lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,symbols:e.symbols,mangleMap:e.mangleMap,localScope:{_SymbolsMap:{}},depthCounter:e.depthCounter,globalScope:e.globalScope},l="new lang.UserDefinedCompiledFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n",i=0;i<n.params.length;i++){var c=n.params[i].name.toLowerCase();O(c);var u=k(e);a.localScope._SymbolsMap[c]=u,a.mangleMap[c]=u,l+="lscope['"+u+"']=arguments["+i.toString()+"];\n"}!0===e.isAsync?(l+="return lang.__awaiter(this, void 0, void 0, function* () {\n",l+=N(a,n.body)+"\n return lastStatement; ",l+="});  }",l+=", runtimeCtx),"+n.params.length+")",l+="\n lastStatement = lc.voidOperation; \n"):(l+=N(a,n.body)+"\n return lastStatement; }, runtimeCtx),"+n.params.length+")",l+="\n lastStatement = lc.voidOperation; \n");if(o)return"gscope[lang.setAssig('"+t+"', runtimeCtx)]="+l;return"gscope['"+t+"']="+l}(e,n);case"ImportDeclaration":return function(e,n){var r,t=n.specifiers[0].local.name.toLowerCase();O(t);var o=null===(r=e.libraryResolver)||void 0===r?void 0:r.loadLibrary(t),a=k(e);void 0===e.moduleFactory[o.uri]&&(e.moduleFactory[o.uri]=function(e,n,r){void 0===r&&(r=!1);var t={isAsync:r,moduleFactory:n.moduleFactory,moduleFactoryMap:{},libraryResolver:new x.ArcadeModuleLoader(null,e.loadedModules),globalScope:P(n.vars,r?G:_,n.customfunctions),customfunctions:n.customfunctions,localScope:null,mangleMap:{},undeclaredGlobalsInFunctions:new Map,depthCounter:{depth:1},exports:{},console:V,lrucache:n.lrucache,interceptor:n.interceptor,services:n.services,symbols:{symbolCounter:0}},o=M(t,e);""===o&&(o="lc.voidOperation; ");var a="";a=r?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+o+"\n return lastStatement; }); } \n yield mainBody(); \n return this.prepareModule(runtimeCtx); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+o+"\n return lastStatement; } \n mainBody(); \n return this.prepareModule(runtimeCtx); ";var l=t.moduleFactory,i=t.moduleFactoryMap,c=t.exports,s={};for(var d in c)s[d]=void 0!==t.mangleMap[d]?t.mangleMap[d]:d;var p={lc:u,lang:W,mangles:t.mangleMap,prepareModule:function(e){return new J(e)},prepare:function(e,n){var r=e.spatialReference;null==r&&(r=new b({wkid:102100}));var t=D(e.vars,e.customfunctions,n);return{localStack:[],isAsync:n,exports:c,exportmangle:s,gdefs:{},moduleFactory:l,moduleFactoryMap:i,moduleSingletons:e.moduleSingletons,mangleMap:this.mangles,spatialReference:r,globalScope:t,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console?e.console:V,lrucache:e.lrucache,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:e.depthCounter}}};return new Function("context","spatialReference",a).bind(p)}(o.syntax,{interceptor:e.interceptor,services:e.services,moduleFactory:e.moduleFactory,lrucache:e.lrucache,libraryResolver:e.libraryResolver,customfunctions:e.customfunctions,vars:{}},e.isAsync));e.moduleFactoryMap[a]=o.uri;var l="";l=e.isAsync?"(yield lang.loadModule('"+a+"', runtimeCtx) ); ":"lang.loadModule('"+a+"', runtimeCtx); ";if(void 0!==e.globalScope[t])return"gscope['"+t+"']="+l;if(void 0!==e.globalScope._SymbolsMap[t])return"gscope['"+e.globalScope._SymbolsMap[t]+"']="+l;var i="";e.undeclaredGlobalsInFunctions.has(t)?(i=e.undeclaredGlobalsInFunctions.get(t).manglename,e.undeclaredGlobalsInFunctions.delete(t)):i=k(e);return e.globalScope._SymbolsMap[t]=i,e.mangleMap[t]=i,"gscope[lang.setAssig('"+i+"', runtimeCtx)]="+l}(e,n);case"ExportNamedDeclaration":return function(e,n){var r=M(e,n.declaration);if("FunctionDeclaration"===n.declaration.type)e.exports[n.declaration.id.name.toLowerCase()]="function";else if("VariableDeclaration"===n.declaration.type)for(var t=0,o=n.declaration.declarations;t<o.length;t++){var a=o[t];e.exports[a.id.name.toLowerCase()]="variable"}return r}(e,n);case"ReturnStatement":return function(e,n){if(null===n.argument)return"return lc.voidOperation";return"return "+M(e,n.argument)}(e,n);case"IfStatement":return function e(n,r){if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)throw new C.ArcadeCompilationError(n,C.ExecutionErrorCodes.BooleanConditionRequired,r);return"if (lang.mustBoolean("+M(n,r.test)+", runtimeCtx) === true) {\n    "+I(n,r.consequent)+"\n  } "+(null!==r.alternate?"IfStatement"===r.alternate.type?" else "+e(n,r.alternate):" else {\n      "+I(n,r.alternate)+"\n    }\n":" else {\n      lastStatement = lc.voidOperation;\n    }\n")}(e,n);case"ExpressionStatement":return function(e,n){if("AssignmentExpression"===n.expression.type)return"lastStatement = lc.voidOperation; "+M(e,n.expression)+"; \n ";if("CallExpression"===n.expression.type)return"lastStatement = "+M(e,n.expression)+"; ";return"lastStatement = "+M(e,n.expression)+"; "}(e,n);case"AssignmentExpression":return function(e,n){var r=M(e,n.right),t=null,o="";if("MemberExpression"===n.left.type)return t=M(e,n.left.object),!0===n.left.computed?o=M(e,n.left.property):(o="'"+n.left.property.name+"'",O(n.left.property.name)),"lang.assignmember("+t+","+o+",'"+n.operator+"',"+r+")";if(O(t=n.left.name.toLowerCase()),null!==e.localScope){if(void 0!==e.localScope[t])return"lscope['"+t+"']=lang.assign("+r+",'"+n.operator+"', lscope['"+t+"'])";if(void 0!==e.localScope._SymbolsMap[t])return"lscope['"+e.localScope._SymbolsMap[t]+"']=lang.assign("+r+",'"+n.operator+"', lscope['"+e.localScope._SymbolsMap[t]+"'])"}if(void 0!==e.globalScope[t])return"gscope['"+t+"']=lang.assign("+r+",'"+n.operator+"', gscope['"+t+"'])";if(void 0!==e.globalScope._SymbolsMap[t])return"gscope['"+e.globalScope._SymbolsMap[t]+"']=lang.assign("+r+",'"+n.operator+"', gscope['"+e.globalScope._SymbolsMap[t]+"'])";if(null!==e.localScope){if(e.undeclaredGlobalsInFunctions.has(t))return"gscope[lang.chkAssig('"+e.undeclaredGlobalsInFunctions.get(t).manglename+"',runtimeCtx)]=lang.assign("+r+",'"+n.operator+"', gscope['"+e.undeclaredGlobalsInFunctions.get(t).manglename+"'])";var a={manglename:k(e),node:n.argument};return e.undeclaredGlobalsInFunctions.set(t,a),"gscope[lang.chkAssig('"+a.manglename+"',runtimeCtx)]=lang.assign("+r+",'"+n.operator+"', gscope['"+a.manglename+"'])"}throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.InvalidIdentifier,n)}(e,n);case"UpdateExpression":return function(e,n){var r=null,t="";if("MemberExpression"===n.argument.type)return r=M(e,n.argument.object),!0===n.argument.computed?t=M(e,n.argument.property):(t="'"+n.argument.property.name+"'",O(n.argument.property.name)),"lang.memberupdate("+r+","+t+",'"+n.operator+"',"+n.prefix+")";if(O(r=n.argument.name.toLowerCase()),null!==e.localScope){if(void 0!==e.localScope[r])return"lang.update(lscope, '"+r+"','"+n.operator+"',"+n.prefix+")";if(void 0!==e.localScope._SymbolsMap[r])return"lang.update(lscope, '"+e.localScope._SymbolsMap[r]+"','"+n.operator+"',"+n.prefix+")"}if(void 0!==e.globalScope[r])return"lang.update(gscope, '"+r+"','"+n.operator+"',"+n.prefix+")";if(void 0!==e.globalScope._SymbolsMap[r])return"lang.update(gscope, '"+e.globalScope._SymbolsMap[r]+"','"+n.operator+"',"+n.prefix+")";if(null!==e.localScope){if(e.undeclaredGlobalsInFunctions.has(r))return"lang.update(gscope,lang.chkAssig( '"+e.undeclaredGlobalsInFunctions.get(r).manglename+"',runtimeCtx),'"+n.operator+"',"+n.prefix+")";var o={manglename:k(e),node:n.argument};return e.undeclaredGlobalsInFunctions.set(r,o),"lang.update(gscope, lang.chkAssig('"+o.manglename+"',runtimeCtx),'"+n.operator+"',"+n.prefix+")"}throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.InvalidIdentifier,n)}(e,n);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"TemplateLiteral":return function(e,n){try{for(var r=[],t=0,o=0,a=n.quasis;o<a.length;o++){var l=a[o];r.push(l.value?JSON.stringify(l.value.cooked):JSON.stringify("")),!1===l.tail&&(r.push(n.expressions[t]?"lang.castString(lang.aCheck("+M(e,n.expressions[t])+", 'TemplateLiteral'))":""),t++)}return"(["+r.join(",")+"]).join('')"}catch(e){throw e}}(e,n);case"TemplateElement":return JSON.stringify(n.value?n.value.cooked:"");case"ForStatement":return function(e,n){var r="lastStatement = lc.voidOperation; \n";null!==n.init&&(r+=M(e,n.init)+"; ");var t=B(e),o=B(e);r+="var "+t+" = true; ",r+="\n do { ",null!==n.update&&(r+=" if ("+t+"===false) {\n "+M(e,n.update)+"  \n}\n "+t+"=false; \n");null!==n.test&&(r+="var "+o+" = "+M(e,n.test)+"; ",r+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error('"+C.ExecutionErrorCodes.BooleanConditionRequired+"');   }\n");r+=M(e,n.body),null!==n.update&&(r+="\n "+M(e,n.update));return r+="\n"+t+" = true; \n} while(true);  lastStatement = lc.voidOperation; "}(e,n);case"ForInStatement":return function(e,n){var r=B(e),t=B(e),o=B(e),a="var "+r+" = "+M(e,n.right)+";\n";"VariableDeclaration"===n.left.type&&(a+=M(e,n.left));var l="VariableDeclaration"===n.left.type?n.left.declarations[0].id.name:n.left.name;O(l=l.toLowerCase());var i="";null!==e.localScope&&(void 0!==e.localScope[l]?i="lscope['"+l+"']":void 0!==e.localScope._SymbolsMap[l]&&(i="lscope['"+e.localScope._SymbolsMap[l]+"']"));var c="";if(""===i)if(void 0!==e.globalScope[l])i="gscope['"+l+"']";else if(void 0!==e.globalScope._SymbolsMap[l])i="gscope['"+e.globalScope._SymbolsMap[l]+"']";else if(null!==e.localScope)if(e.undeclaredGlobalsInFunctions.has(l))i="gscope['"+e.undeclaredGlobalsInFunctions.get(l).manglename+"']",c=e.undeclaredGlobalsInFunctions.get(l).manglename;else{var u={manglename:k(e),node:n.left};e.undeclaredGlobalsInFunctions.set(l,u),i="gscope['"+u.manglename+"']",c=u.manglename}c&&(a+="lang.chkAssig('"+c+"',runtimeCtx); \n");a+="if ("+r+"===null) {  lastStatement = lc.voidOperation; }\n ",a+="else if (lc.isArray("+r+") || lc.isString("+r+")) {",a+="var "+t+"="+r+".length; \n",a+="for(var "+o+"=0; "+o+"<"+t+"; "+o+"++) {\n",a+=i+"="+o+";\n",a+=M(e,n.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (lc.isImmutableArray("+r+")) {",a+="var "+t+"="+r+".length(); \n",a+="for(var "+o+"=0; "+o+"<"+t+"; "+o+"++) {\n",a+=i+"="+o+";\n",a+=M(e,n.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (( "+r+" instanceof lang.Dictionary) || ( "+r+" instanceof lang.Feature)) {",a+="var "+t+"="+r+".keys(); \n",a+="for(var "+o+"=0; "+o+"<"+t+".length; "+o+"++) {\n",a+=i+"="+t+"["+o+"];\n",a+=M(e,n.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",e.isAsync&&(a+="else if (lc.isFeatureSet("+r+")) {",a+="var "+t+"="+r+".iterator(runtimeCtx.abortSignal); \n",a+="for(var "+o+"=lang. graphicToFeature( yield "+t+".next(),"+r+"); "+o+"!=null; "+o+"=lang. graphicToFeature( yield "+t+".next(),"+r+")) {\n",a+=i+"="+o+";\n",a+=M(e,n.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n");return a+="else { lastStatement = lc.voidOperation; } \n"}(e,n);case"WhileStatement":return function(e,n){var r="lastStatement = lc.voidOperation; \n",t=B(e);return r+="\n  var "+t+" = true;\n    do {\n      "+t+" = "+M(e,n.test)+";\n      if ("+t+"==false) {\n        break;\n      }\n      if ("+t+"!==true) {\n        lang.error('"+C.ExecutionErrorCodes.BooleanConditionRequired+"');\n      }\n      "+M(e,n.body)+"\n    }\n    while ("+t+" !== false);\n    lastStatement = lc.voidOperation;\n  "}(e,n);case"Identifier":return function(e,n){try{var r=n.name.toLowerCase();if(O(r),null!==e.localScope){if(void 0!==e.localScope[r])return"lscope['"+r+"']";if(void 0!==e.localScope._SymbolsMap[r])return"lscope['"+e.localScope._SymbolsMap[r]+"']"}if(void 0!==e.globalScope[r])return"gscope['"+r+"']";if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']";if(null!==e.localScope){if(e.undeclaredGlobalsInFunctions.has(r))return"gscope[lang.chkAssig('"+e.undeclaredGlobalsInFunctions.get(r).manglename+"',runtimeCtx)]";var t={manglename:k(e),node:n.argument};return e.undeclaredGlobalsInFunctions.set(r,t),"gscope[lang.chkAssig('"+t.manglename+"',runtimeCtx)]"}throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.InvalidIdentifier,n)}catch(e){throw e}}(e,n);case"MemberExpression":return function(e,n){try{var r=void 0;return!0===n.computed?r=M(e,n.property):(r="'"+n.property.name+"'",O(n.property.name)),"lang.member("+M(e,n.object)+","+r+")"}catch(e){throw e}}(e,n);case"Literal":return null===n.value||void 0===n.value?"null":JSON.stringify(n.value);case"CallExpression":return function(e,n){try{if("MemberExpression"===n.callee.type){var r=void 0;!0===n.callee.computed?r=M(e,n.callee.property):(r="'"+n.callee.property.name+"'",O(n.callee.property.name));for(var t="[",o=0;o<n.arguments.length;o++)o>0&&(t+=", "),t+=M(e,n.arguments[o]);return t+="]",e.isAsync?"(yield lang.callModuleFunction("+M(e,n.callee.object)+","+t+","+r+",runtimeCtx))":"lang.callModuleFunction("+M(e,n.callee.object)+","+t+","+r+",runtimeCtx)"}if("Identifier"!==n.callee.type)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.FuncionNotFound,n);var a=n.callee.name.toLowerCase();if("iif"===a)return function(e,n){try{if(3!==n.arguments.length)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.WrongNumberOfParameters,n);var r=B(e);return(e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {")+"\n        var "+r+" = "+M(e,n.arguments[0])+";\n       \n        if ("+r+" === true) {\n          return  "+M(e,n.arguments[1])+";\n        }\n        else if ("+r+" === false) {\n          return "+M(e,n.arguments[2])+";\n        }\n        else {\n          lang.error('ExecutionErrorCodes.BooleanConditionRequired');\n        }\n      "+(e.isAsync?"})}()))":"}()")}catch(e){throw e}}(e,n);if("when"===a)return function(e,n){try{if(n.arguments.length<3)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.WrongNumberOfParameters,n);if(n.arguments.length%2==0)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.WrongNumberOfParameters,n);for(var r=B(e),t="var ",o=0;o<n.arguments.length-1;o+=2)t+=r+" = lang.mustBoolean("+M(e,n.arguments[o])+", runtimeCtx);\n      if ("+r+" === true ) {\n        return "+M(e,n.arguments[o+1])+" \n      }\n";return(e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {")+"\n        "+t+"\n        return "+M(e,n.arguments[n.arguments.length-1])+"\n        "+(e.isAsync?"})}()))":"}()")}catch(e){throw e}}(e,n);if("decode"===a)return function(e,n){try{if(n.arguments.length<2)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.WrongNumberOfParameters,n);if(2===n.arguments.length)return"("+M(e,n.arguments[1])+")";if((n.arguments.length-1)%2==0)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.WrongNumberOfParameters,n);for(var r=B(e),t=B(e),o="var ",a=1;a<n.arguments.length-1;a+=2)o+=t+" = "+M(e,n.arguments[a])+";\n      if (lang.binary("+t+", "+r+', "==") === true ) {\n        return '+M(e,n.arguments[a+1])+" \n      }\n";return(e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {")+"\n        var "+r+" = "+M(e,n.arguments[0])+";\n        "+o+"\n        return "+M(e,n.arguments[n.arguments.length-1])+"\n        "+(e.isAsync?"})}()))":"}()")}catch(e){throw e}}(e,n);var l="";if(null!==e.localScope&&(void 0!==e.localScope[a]?l="lscope['"+a+"']":void 0!==e.localScope._SymbolsMap[a]&&(l="lscope['"+e.localScope._SymbolsMap[a]+"']")),""===l)if(void 0!==e.globalScope[a])l="gscope['"+a+"']";else if(void 0!==e.globalScope._SymbolsMap[a])l="gscope['"+e.globalScope._SymbolsMap[a]+"']";else if(null!==e.localScope)if(e.undeclaredGlobalsInFunctions.has(a))l="gscope[lang.chkAssig('"+e.undeclaredGlobalsInFunctions.get(a).manglename+"',runtimeCtx)]";else{var i={manglename:k(e),node:n.argument};e.undeclaredGlobalsInFunctions.set(a,i),l="gscope[lang.chkAssig('"+i.manglename+"',runtimeCtx)]"}if(""!==l){for(t="[",o=0;o<n.arguments.length;o++)o>0&&(t+=", "),t+=M(e,n.arguments[o]);return t+="]",e.isAsync?"(yield lang.callfunc("+l+","+t+",runtimeCtx) )":"lang.callfunc("+l+","+t+",runtimeCtx)"}throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.FuncionNotFound,n)}catch(e){throw e}}(e,n);case"UnaryExpression":return function(e,n){try{return"lang.unary("+M(e,n.argument)+",'"+n.operator+"')"}catch(e){throw e}}(e,n);case"BinaryExpression":return function(e,n){try{return"lang.binary("+M(e,n.left)+","+M(e,n.right)+",'"+n.operator+"')"}catch(e){throw e}}(e,n);case"LogicalExpression":return function(e,n){try{if("AssignmentExpression"===n.left.type||"UpdateExpression"===n.left.type)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,n);if("AssignmentExpression"===n.right.type||"UpdateExpression"===n.right.type)throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,n);if("&&"===n.operator||"||"===n.operator)return"(lang.logicalCheck("+M(e,n.left)+") "+n.operator+" lang.logicalCheck("+M(e,n.right)+"))";throw new C.ArcadeCompilationError(null,C.ExecutionErrorCodes.LogicExpressionOrAnd,null)}catch(e){throw e}}(e,n);case"ArrayExpression":return function(e,n){try{for(var r=[],t=0;t<n.elements.length;t++)"Literal"===n.elements[t].type?r.push(M(e,n.elements[t])):r.push("lang.aCheck("+M(e,n.elements[t])+",'ArrayExpression')");return"["+r.join(",")+"]"}catch(e){throw e}}(e,n);case"ObjectExpression":return function(e,n){for(var r="lang.dictionary([",t=0;t<n.properties.length;t++){var o=n.properties[t];O(o.key.name);var a="Identifier"===o.key.type?"'"+o.key.name+"'":M(e,o.key),l=M(e,o.value);t>0&&(r+=","),r+="lang.strCheck("+a+",'ObjectExpression'),lang.aCheck("+l+", 'ObjectExpression')"}return r+="])"}(e,n);case"Property":return function(e,n){throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.NeverReach,n)}(e,n);case"Array":throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.NeverReach,n);default:throw new C.ArcadeCompilationError(e,C.ExecutionErrorCodes.Unrecognised,n)}}catch(e){throw e}}function I(e,n){return"BlockStatement"===n.type?M(e,n):"ReturnStatement"===n.type?M(e,n)+"; ":"BreakStatement"===n.type?M(e,n)+"; ":"ContinueStatement"===n.type?M(e,n)+"; ":"UpdateExpression"===n.type?"lastStatement = "+M(e,n)+"; ":"ExpressionStatement"===n.type?M(e,n):"ObjectExpression"===n.type?"lastStatement = "+M(e,n)+"; ":M(e,n)+"; "}function N(e,n){for(var r="",t=0;t<n.body.length;t++)"EmptyStatement"!==n.body[t].type&&("ReturnStatement"===n.body[t].type?r+=M(e,n.body[t])+"; \n":"BreakStatement"===n.body[t].type?r+=M(e,n.body[t])+"; \n":"ContinueStatement"===n.body[t].type?r+=M(e,n.body[t])+"; \n":"UpdateExpression"===n.body[t].type?r+="lastStatement = "+M(e,n.body[t])+"; \n":"ObjectExpression"===n.body[t].type?r+="lastStatement = "+M(e,n.body[t])+"; \n":r+=M(e,n.body[t])+" \n");return r}function O(e){if("iif"===e)throw new C.ArcadeUncompilableError;if("decode"===e)throw new C.ArcadeUncompilableError;if("when"===e)throw new C.ArcadeUncompilableError}n.UserDefinedCompiledFunction=A;var _={};function k(e){return e.symbols.symbolCounter++,"_T"+e.symbols.symbolCounter.toString()}function B(e){return e.symbols.symbolCounter++,"_Tvar"+e.symbols.symbolCounter.toString()}p.registerFunctions(_,F),h.registerFunctions(_,F),f.registerFunctions(_,F),m.registerFunctions(_,F),E.registerFunctions(_,F),_.iif=function(e,n){try{return F(e,n,(function(r,t,o){throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.Unrecognised,n)}))}catch(e){throw e}},_.decode=function(e,n){try{return F(e,n,(function(r,t,o){throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.Unrecognised,n)}))}catch(e){throw e}},_.when=function(e,n){try{return F(e,n,(function(r,t,o){throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.Unrecognised,n)}))}catch(e){throw e}};var G={};for(var L in _)G[L]=new w.NativeFunction(_[L]);for(var L in g.registerFunctions(_,F),_)_[L]=new w.NativeFunction(_[L]);var R=function(){};R.prototype=_;var U=function(){};function P(e,n,r){var t={};for(var o in e||(e={}),r||(r={}),t._SymbolsMap={},t.textformatting=1,t.infinity=1,t.pi=1,n)t[o]=1;for(var o in r)t[o]=1;for(var o in e)t[o]=1;return t}function D(e,n,r){var t=r?new U:new R;e||(e={}),n||(n={});var o=new i({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});for(var a in o.immutable=!1,t._SymbolsMap={textformatting:1,infinity:1,pi:1},t.textformatting=o,t.infinity=Number.POSITIVE_INFINITY,t.pi=Math.PI,n)t[a]=n[a],t._SymbolsMap[a]=1;for(var a in e)t._SymbolsMap[a]=1,e[a]&&"esri.Graphic"===e[a].declaredClass?t[a]=c.createFromGraphic(e[a]):t[a]=e[a];return t}U.prototype=G;var j={fixSpatialReference:u.fixSpatialReference,parseArguments:function(e,n){for(var r=[],t=0;t<n.arguments.length;t++)r.push(M(e,n.arguments[t]));return r},standardFunction:F};function T(e,n){for(var r={mode:n,compiled:!0,functions:{},signatures:[],standardFunction:F,standardFunctionAsync:F,evaluateIdentifier:K},t=0;t<e.length;t++)e[t].registerFunctions(r);if("sync"===n){for(var o in r.functions)_[o]=new w.NativeFunction(r.functions[o]),R.prototype[o]=_[o];for(t=0;t<r.signatures.length;t++)s.addFunctionDeclaration(r.signatures[t],"sync")}else{for(var o in r.functions)G[o]=new w.NativeFunction(r.functions[o]),U.prototype[o]=G[o];for(t=0;t<r.signatures.length;t++)s.addFunctionDeclaration(r.signatures[t],"async")}}function K(e,n){var r=n.name;if("_SymbolsMap"===r)throw new C.ArcadeExecutionError(e,C.ExecutionErrorCodes.InvalidIdentifier,null);if(e.localStack.length>0){if("_t"!==r.substr(0,2).toLowerCase()&&void 0!==e.localStack[e.localStack.length-1][r])return e.localStack[e.localStack.length-1][r];var t=e.mangleMap[r];if(void 0!==t&&void 0!==e.localStack[e.localStack.length-1][t])return e.localStack[e.localStack.length-1][t]}if("_t"!==r.substr(0,2).toLowerCase()&&void 0!==e.globalScope[r])return e.globalScope[r];if(1===e.globalScope._SymbolsMap[r])return e.globalScope[r];var o=e.mangleMap[r];return void 0!==o?e.globalScope[o]:void 0}n.functionHelper=j,n.extend=T,T([d],"sync"),T([d],"async"),n.executeScript=function(e,n){return e(n)};var q=0,W={error:function(e){throw new C.ArcadeExecutionError(null,e,null)},__awaiter:function(e,n,r,t){return new Promise((function(r,o){function a(e){try{i(t.next(e))}catch(e){o(e)}}function l(e){try{i(t.throw(e))}catch(e){o(e)}}function i(e){e.done?r(e.value):e.value&&e.value.then?e.value.then(a,l):++q%100==0?setTimeout((function(){q=0,a(e.value)}),0):a(e.value)}i((t=t.apply(e,n||[])).next())}))},functionDepthchecker:function(e,n){return function(){if(n.depthCounter.depth++,n.localStack.push([]),n.depthCounter.depth>64)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.MaximumCallDepth,null);var r=e.apply(this,arguments);return y.isPromiseLike(r)?r.then((function(e){return n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,e})):(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,r)}},chkAssig:function(e,n){if(void 0===n.gdefs[e])throw new C.ArcadeExecutionError(n,C.ExecutionErrorCodes.InvalidIdentifier,null);return e},mustBoolean:function(e,n){if(!0===e||!1===e)return e;throw new C.ArcadeExecutionError(n,C.ExecutionErrorCodes.BooleanConditionRequired,null)},setAssig:function(e,n){return n.gdefs[e]=1,e},castString:function(e){return u.toString(e)},aCheck:function(e,n){if(u.isFunctionParameter(e)){if("ArrayExpression"===n)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.NoFunctionInArray,null);if("ObjectExpression"===n)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.NoFunctionInDictionary,null);throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.NoFunctionInTemplateLiteral,null)}return e===u.voidOperation?null:e},Dictionary:i,Feature:c,UserDefinedCompiledFunction:A,dictionary:function(e){for(var n={},r=new Map,t=0;t<e.length;t+=2){if(u.isFunctionParameter(e[t+1]))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.NoFunctionInDictionary,null);if(!1===u.isString(e[t]))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.KeyMustBeString,null);var o=e[t].toString(),a=o.toLowerCase();r.has(a)?o=r.get(a):r.set(a,o),e[t+1]===u.voidOperation?n[o]=null:n[o]=e[t+1]}var l=new i(n);return l.immutable=!1,l},strCheck:function(e){if(!1===u.isString(e))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.KeyMustBeString,null);return e},unary:function(e,n){if(u.isBoolean(e)){if("!"===n)return!e;if("-"===n)return-1*u.toNumber(e);if("+"===n)return 1*u.toNumber(e);if("~"===n)return~u.toNumber(e);throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.UnsupportedUnaryOperator,null)}if("-"===n)return-1*u.toNumber(e);if("+"===n)return 1*u.toNumber(e);if("~"===n)return~u.toNumber(e);throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.UnsupportedUnaryOperator,null)},logicalCheck:function(e){if(!1===u.isBoolean(e))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.LogicExpressionOrAnd,null);return e},logical:function(e,n,r){if(u.isBoolean(e)&&u.isBoolean(n))switch(r){case"||":return e||n;case"&&":return e&&n;default:throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.LogicExpressionOrAnd,null)}throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.LogicExpressionOrAnd,null)},binary:function(e,n,r){switch(r){case"|":case"<<":case">>":case">>>":case"^":case"&":return u.binaryOperator(u.toNumber(e),u.toNumber(n),r);case"==":case"=":return u.equalityTest(e,n);case"!=":return!u.equalityTest(e,n);case"<":case">":case"<=":case">=":return u.greaterThanLessThan(e,n,r);case"+":return u.isString(e)||u.isString(n)?u.toString(e)+u.toString(n):u.toNumber(e)+u.toNumber(n);case"-":return u.toNumber(e)-u.toNumber(n);case"*":return u.toNumber(e)*u.toNumber(n);case"/":return u.toNumber(e)/u.toNumber(n);case"%":return u.toNumber(e)%u.toNumber(n);default:throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.UnsupportedOperator,null)}},assign:function(e,n,r){switch(n){case"=":return e===u.voidOperation?null:e;case"/=":return u.toNumber(r)/u.toNumber(e);case"*=":return u.toNumber(r)*u.toNumber(e);case"-=":return u.toNumber(r)-u.toNumber(e);case"+=":return u.isString(r)||u.isString(e)?u.toString(r)+u.toString(e):u.toNumber(r)+u.toNumber(e);case"%=":return u.toNumber(r)%u.toNumber(e);default:throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.UnsupportedOperator,null)}},update:function(e,n,r,t){var o=u.toNumber(e[n]);return e[n]="++"===r?o+1:o-1,!1===t?o:"++"===r?o+1:o-1},graphicToFeature:function(e,n){return null===e?null:c.createFromGraphicLikeObject(e.geometry,e.attributes,n)},memberupdate:function(e,n,r,t){var o;if(u.isArray(e)){if(!u.isNumber(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.ArrayAccessorMustBeNumber,null);if(n<0&&(n=e.length+n),n<0||n>=e.length)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.OutOfBounds,null);o=u.toNumber(e[n]),e[n]="++"===r?o+1:o-1}else if(e instanceof i){if(!1===u.isString(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0!==e.hasField(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.FieldNotFound,null,{key:n});o=u.toNumber(e.field(n)),e.setField(n,"++"===r?o+1:o-1)}else if(u.isFeature(e)){if(!1===u.isString(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0!==e.hasField(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.FieldNotFound,null);o=u.toNumber(e.field(n)),e.setField(n,"++"===r?o+1:o-1)}else{if(u.isImmutableArray(e))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.Immutable,null);if(!(e instanceof J))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidIdentifier,null);if(!1===u.isString(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.ModuleAccessorMustBeString,null);if(!0!==e.hasGlobal(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.ModuleExportNotFound,null);o=u.toNumber(e.global(n)),e.setGlobal(n,"++"===r?o+1:o-1)}return!1===t?o:"++"===r?o+1:o-1},assignmember:function(e,n,r,t){if(u.isArray(e)){if(!u.isNumber(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.ArrayAccessorMustBeNumber,null);if(n<0&&(n=e.length+n),n<0||n>e.length)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.OutOfBounds,null);if(n===e.length){if("="!==r)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.OutOfBounds,null);e[n]=this.assign(t,r,e[n])}else e[n]=this.assign(t,r,e[n])}else if(e instanceof i){if(!1===u.isString(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0===e.hasField(n))e.setField(n,this.assign(t,r,e.field(n)));else{if("="!==r)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.FieldNotFound,null);e.setField(n,this.assign(t,r,null))}}else if(u.isFeature(e)){if(!1===u.isString(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0===e.hasField(n))e.setField(n,this.assign(t,r,e.field(n)));else{if("="!==r)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.FieldNotFound,null);e.setField(n,this.assign(t,r,null))}}else{if(u.isImmutableArray(e))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.Immutable,null);if(!(e instanceof J))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidIdentifier,null);if(!1===u.isString(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.ModuleAccessorMustBeString,null);if(!e.hasGlobal(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.ModuleExportNotFound,null);e.setGlobal(n,this.assign(t,r,e.global(n)))}},member:function(e,n){if(null===e)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.MemberOfNull,null);if(e instanceof i||u.isFeature(e)){if(u.isString(n))return e.field(n);throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(e instanceof v){if(u.isString(n))return m.geometryMember(e,n,null,null);throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(u.isArray(e)){if(u.isNumber(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.OutOfBounds,null);return e[n]}throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(u.isString(e)){if(u.isNumber(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.OutOfBounds,null);return e[n]}throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(u.isImmutableArray(e)){if(u.isNumber(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length()+n),n>=e.length()||n<0)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.OutOfBounds,null);return e.get(n)}throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(e instanceof J){if(u.isString(n))return e.global(n);throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)}throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidMemberAccessKey,null)},callfunc:function(e,n,r){return e.call(r,{arguments:n,preparsed:!0})},loadModule:function(e,n){var r=n.moduleFactoryMap[e];if(n.moduleSingletons[r])return n.moduleSingletons[r];var t=n.moduleFactory[r]({vars:{},moduleSingletons:n.moduleSingletons,depthCounter:n.depthCounter,console:n.console,abortSignal:n.abortSignal,isAsync:n.isAsync,services:n.services,lrucache:n.lrucache,interceptor:n.interceptor},n.spatialReference);return n.moduleSingletons[r]=t,t},callModuleFunction:function(e,n,r,t){if(!(e instanceof J))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.FuncionNotFound,null);var o=e.global(r);if(!1===u.isFunctionParameter(o))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.CallNonFunction,null);return o.call(t,{preparsed:!0,arguments:n})}};function V(e){console.log(e)}n.compileScript=function(e,n,r){void 0===r&&(r=!1),null===n&&(n={vars:{},customfunctions:{}});var t=null;e.usesModules&&(t=new x.ArcadeModuleLoader(null,e.loadedModules));var o={isAsync:r,globalScope:P(n.vars,r?G:_,n.customfunctions),moduleFactory:{},moduleFactoryMap:{},undeclaredGlobalsInFunctions:new Map,customfunctions:n.customfunctions,libraryResolver:t,localScope:null,mangleMap:{},depthCounter:{depth:1},exports:{},console:V,lrucache:n.lrucache,interceptor:n.interceptor,services:n.services,symbols:{symbolCounter:0}},a=M(o,e);""===a&&(a="lc.voidOperation; "),o.undeclaredGlobalsInFunctions.size>0&&o.undeclaredGlobalsInFunctions.forEach((function(e){throw new C.ArcadeCompilationError(n,C.ExecutionErrorCodes.InvalidIdentifier,e.node)}));var l="";l=r?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+a+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+a+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";var i=o.moduleFactory,c=o.moduleFactoryMap,s=o.exports,d={};for(var p in s)d[p]=void 0!==o.mangleMap[p]?o.mangleMap[p]:p;var m={lc:u,lang:W,mangles:o.mangleMap,postProcess:function(e){if(e instanceof u.ReturnResult&&(e=e.value),e instanceof u.ImplicitResult&&(e=e.value),e===u.voidOperation&&(e=null),e===u.breakResult)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.IllegalResult,null);if(e===u.continueResult)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.IllegalResult,null);if(u.isFunctionParameter(e))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.IllegalResult,null);return e},prepare:function(e,n){var r=e.spatialReference;null==r&&(r=new b({wkid:102100}));var t=D(e.vars,e.customfunctions,n);return{localStack:[],isAsync:n,moduleFactory:i,moduleFactoryMap:c,mangleMap:this.mangles,moduleSingletons:{},exports:s,gdefs:{},exportmangle:d,spatialReference:r,globalScope:t,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console?e.console:V,lrucache:e.lrucache,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:{depth:1}}}};return new Function("context","spatialReference",l).bind(m)},n.enableAsyncSupport=function(){return new Promise((function(n,r){e(["./functions/geomasync"],(function(e){T([e],"async"),n(!0)}),(function(e){r(e)}))}))};var J=function(e){function n(n){var r=e.call(this,null)||this;return r.moduleContext=n,r}return l(n,e),n.prototype.hasGlobal=function(e){return void 0===this.moduleContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.moduleContext.exports[e]},n.prototype.setGlobal=function(e,n){var r=this.moduleContext.globalScope,t=e.toLowerCase();if(u.isFunctionParameter(n))throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.AssignModuleFunction,null);r[this.moduleContext.exportmangle[t]]=n},n.prototype.global=function(e){var n=this.moduleContext.globalScope;e=e.toLowerCase();var r=n[this.moduleContext.exportmangle[e]];if(void 0===r)throw new C.ArcadeExecutionError(null,C.ExecutionErrorCodes.InvalidIdentifier,null);if(u.isFunctionParameter(r)&&!(r instanceof w.ScopeMarshalledFunction)){var t=new w.ScopeMarshalledFunction;return t.fn=r,t.parameterEvaluator=F,t.context=this.moduleContext,n[this.moduleContext.exportmangle[e]]=t,t}return r},n}(S.ArcadeModule)}));