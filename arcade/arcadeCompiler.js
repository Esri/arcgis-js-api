/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../core/promiseUtils","../geometry/SpatialReference","../geometry/Geometry","../geometry/Point","../geometry/Extent","../geometry/Multipoint","../geometry/Polygon","../geometry/Polyline","./ImmutablePointArray","./ImmutablePathArray","../chunks/languageUtils","./Dictionary","./ArcadePortal","./Attachment","./Feature","./treeAnalysis","./functions/array","./functions/date","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","../views/2d/layers/features/support/FeatureSetReader"],(function(e,t,r,n,o,a,i,s,l,c,u,p,f,g,m,h,d,y,b,S,E,w,N,M,v,O){"use strict";function I(e,t,r){try{return r(e,null,t)}catch(e){throw e}}function x(e){return e instanceof Error?r.reject(e):r.reject(new Error(e))}function T(e,t){try{switch(t.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclarator":return function(e,t){let r=null===t.init?null:T(e,t.init);r===f.voidOperation&&(r=null);const n=t.id.name.toLowerCase();if(null!==e.localScope){if(void 0!==e.localScope[n])return"lscope['"+n+"']="+r+"; ";if(void 0!==e.localScope._SymbolsMap[n])return"lscope['"+e.localScope._SymbolsMap[n]+"']="+r+"; ";{const t=j(e);return e.localScope._SymbolsMap[n]=t,e.mangleMap[n]=t,"lscope['"+t+"']="+r+"; "}}if(void 0!==e.globalScope[n])return"gscope['"+n+"']="+r+"; ";if(void 0!==e.globalScope._SymbolsMap[n])return"gscope['"+e.globalScope._SymbolsMap[n]+"']="+r+"; ";{const t=j(e);return e.globalScope._SymbolsMap[n]=t,e.mangleMap[n]=t,"gscope['"+t+"']="+r+"; "}}(e,t);case"VariableDeclaration":return function(e,t){const r=[];for(let n=0;n<t.declarations.length;n++)r.push(T(e,t.declarations[n]));return r.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}(e,t);case"BlockStatement":return C(e,t);case"FunctionDeclaration":return function(e,t){const r=t.id.name.toLowerCase(),n={isAsync:e.isAsync,spatialReference:e.spatialReference,console:e.console,lrucache:e.lrucache,services:e.services,symbols:e.symbols,mangleMap:e.mangleMap,localScope:{_SymbolsMap:{}},depthCounter:e.depthCounter+1,globalScope:e.globalScope};if(n.depthCounter>64)throw new Error("Exceeded maximum function depth");let o="new lc.SizzleFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n";for(let r=0;r<t.params.length;r++){const a=t.params[r].name.toLowerCase(),i=j(e);n.localScope._SymbolsMap[a]=i,n.mangleMap[a]=i,o+="lscope['"+i+"']=arguments["+r.toString()+"];\n"}!0===e.isAsync?(o+="return lang.__awaiter(this, void 0, void 0, function* () {\n",o+=C(n,t.body)+"\n return lastStatement; ",o+="});  }",o+=", runtimeCtx))",o+="\n lastStatement = lc.voidOperation; \n"):(o+=C(n,t.body)+"\n return lastStatement; }, runtimeCtx))",o+="\n lastStatement = lc.voidOperation; \n");if(void 0!==e.globalScope[r])return"gscope['"+r+"']="+o;if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']="+o;{const t=j(e);return e.globalScope._SymbolsMap[r]=t,e.mangleMap[r]=t,"gscope['"+t+"']="+o}}(e,t);case"ReturnStatement":return function(e,t){if(null===t.argument)return"return lc.voidOperation";return"return "+T(e,t.argument)}(e,t);case"IfStatement":return function(e,t){if("AssignmentExpression"===t.test.type||"UpdateExpression"===t.test.type)throw new Error(y.nodeErrorMessage(t.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));const r=T(e,t.test),n=B(e);let o="var "+n+" = "+r+";\n if ("+n+" === true) {\n"+R(e,t.consequent)+"\n }\n";null!==t.alternate?o+="else if ("+n+"===false)   { \n"+R(e,t.alternate)+"}\n":o+="else if ("+n+"===false) { \n lastStatement = lc.voidOperation;\n }\n";return o+="else { lang.error({type: '"+t.type+"'},'RUNTIME','CANNOT_USE_NONBOOLEAN_IN_CONDITION'); \n}\n",o}(e,t);case"ExpressionStatement":return function(e,t){if("AssignmentExpression"===t.expression.type)return"lastStatement = lc.voidOperation; "+T(e,t.expression)+"; \n ";if("CallExpression"===t.expression.type)return"lastStatement = "+T(e,t.expression)+"; ";return"lastStatement = "+T(e,t.expression)+"; "}(e,t);case"AssignmentExpression":return function(e,t){const r=T(e,t.right);let n=null,o="";if("MemberExpression"===t.left.type)return n=T(e,t.left.object),o=!0===t.left.computed?T(e,t.left.property):"'"+t.left.property.name+"'","lang.assignmember("+n+","+o+",'"+t.operator+"',"+r+")";if(n=t.left.name.toLowerCase(),null!==e.localScope){if(void 0!==e.localScope[n])return"lscope['"+n+"']=lang.assign("+r+",'"+t.operator+"', lscope['"+n+"'])";if(void 0!==e.localScope._SymbolsMap[n])return"lscope['"+e.localScope._SymbolsMap[n]+"']=lang.assign("+r+",'"+t.operator+"', lscope['"+e.localScope._SymbolsMap[n]+"'])"}if(void 0!==e.globalScope[n])return"gscope['"+n+"']=lang.assign("+r+",'"+t.operator+"', gscope['"+n+"'])";if(void 0!==e.globalScope._SymbolsMap[n])return"gscope['"+e.globalScope._SymbolsMap[n]+"']=lang.assign("+r+",'"+t.operator+"', gscope['"+e.globalScope._SymbolsMap[n]+"'])";throw new Error("Variable not recognised")}(e,t);case"UpdateExpression":return function(e,t){let r=null,n="";if("MemberExpression"===t.argument.type)return r=T(e,t.argument.object),n=!0===t.argument.computed?T(e,t.argument.property):"'"+t.argument.property.name+"'","lang.memberupdate("+r+","+n+",'"+t.operator+"',"+t.prefix+")";if(r=t.argument.name.toLowerCase(),null!==e.localScope){if(void 0!==e.localScope[r])return"lang.update(lscope, '"+r+"','"+t.operator+"',"+t.prefix+")";if(void 0!==e.localScope._SymbolsMap[r])return"lang.update(lscope, '"+e.localScope._SymbolsMap[r]+"','"+t.operator+"',"+t.prefix+")"}if(void 0!==e.globalScope[r])return"lang.update(gscope, '"+r+"','"+t.operator+"',"+t.prefix+")";if(void 0!==e.globalScope._SymbolsMap[r])return"lang.update(gscope, '"+e.globalScope._SymbolsMap[r]+"','"+t.operator+"',"+t.prefix+")";throw new Error("Variable not recognised")}(e,t);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"TemplateLiteral":return function(e,t){try{const r=[];let n=0;for(const o of t.quasis)r.push(o.value?JSON.stringify(o.value.cooked):JSON.stringify("")),!1===o.tail&&(r.push(t.expressions[n]?"lang.castString(lang.aCheck("+T(e,t.expressions[n])+", 'TemplateLiteral'))":""),n++);return"(["+r.join(",")+"]).join('')"}catch(e){throw e}}(e,t);case"TemplateElement":return JSON.stringify(t.value?t.value.cooked:"");case"ForStatement":return function(e,t){let r="lastStatement = lc.voidOperation; \n";null!==t.init&&(r+=T(e,t.init)+"; ");const n=B(e),o=B(e);r+="var "+n+" = true; ",r+="\n do { ",null!==t.update&&(r+=" if ("+n+"===false) {\n "+T(e,t.update)+"  \n}\n "+n+"=false; \n");null!==t.test&&(r+="var "+o+" = "+T(e,t.test)+"; ",r+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error({type: '"+t.type+"'},'RUNTIME','CANNOT_USE_NONBOOLEAN_IN_CONDITION');   }\n");r+=T(e,t.body),null!==t.update&&(r+="\n "+T(e,t.update));return r+="\n"+n+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",r}(e,t);case"ForInStatement":return function(e,t){const r=B(e),n=B(e),o=B(e);let a="var "+r+" = "+T(e,t.right)+";\n";"VariableDeclaration"===t.left.type&&(a+=T(e,t.left));let i="VariableDeclaration"===t.left.type?t.left.declarations[0].id.name:t.left.name;i=i.toLowerCase();let s="";null!==e.localScope&&(void 0!==e.localScope[i]?s="lscope['"+i+"']":void 0!==e.localScope._SymbolsMap[i]&&(s="lscope['"+e.localScope._SymbolsMap[i]+"']"));""===s&&(void 0!==e.globalScope[i]?s="gscope['"+i+"']":void 0!==e.globalScope._SymbolsMap[i]&&(s="gscope['"+e.globalScope._SymbolsMap[i]+"']"));a+="if ("+r+"===null) {  lastStatement = lc.voidOperation; }\n ",a+="else if (lc.isArray("+r+") || lc.isString("+r+")) {",a+="var "+n+"="+r+".length; \n",a+="for(var "+o+"=0; "+o+"<"+n+"; "+o+"++) {\n",a+=s+"="+o+";\n",a+=T(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (lc.isImmutableArray("+r+")) {",a+="var "+n+"="+r+".length(); \n",a+="for(var "+o+"=0; "+o+"<"+n+"; "+o+"++) {\n",a+=s+"="+o+";\n",a+=T(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (( "+r+" instanceof lang.Dictionary) || ( "+r+" instanceof lang.Feature)) {",a+="var "+n+"="+r+".keys(); \n",a+="for(var "+o+"=0; "+o+"<"+n+".length; "+o+"++) {\n",a+=s+"="+n+"["+o+"];\n",a+=T(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",e.isAsync&&(a+="else if (lc.isFeatureSet("+r+")) {",a+="var "+n+"="+r+".iterator(runtimeCtx.abortSignal); \n",a+="for(var "+o+"=lang. graphicToFeature( yield "+n+".next(),"+r+"); "+o+"!=null; "+o+"=lang. graphicToFeature( yield "+n+".next(),"+r+")) {\n",a+=s+"="+o+";\n",a+=T(e,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n");return a+="else { lastStatement = lc.voidOperation; } \n",a}(e,t);case"Identifier":return function(e,t){try{const r=t.name.toLowerCase();if(null!==e.localScope){if(void 0!==e.localScope[r])return"lscope['"+r+"']";if(void 0!==e.localScope._SymbolsMap[r])return"lscope['"+e.localScope._SymbolsMap[r]+"']"}if(void 0!==e.globalScope[r])return"gscope['"+r+"']";if(void 0!==e.globalScope._SymbolsMap[r])return"gscope['"+e.globalScope._SymbolsMap[r]+"']";throw new Error(y.nodeErrorMessage(t,"RUNTIME","VARIABLENOTFOUND"))}catch(e){throw e}}(e,t);case"MemberExpression":return function(e,t){try{let r;return r=!0===t.computed?T(e,t.property):"'"+t.property.name+"'","lang.member("+T(e,t.object)+","+r+")"}catch(e){throw e}}(e,t);case"Literal":return null===t.value||void 0===t.value?"null":JSON.stringify(t.value);case"ThisExpression":throw new Error(y.nodeErrorMessage(t,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return function(e,t){try{if("Identifier"!==t.callee.type)throw new Error(y.nodeErrorMessage(t,"RUNTIME","ONLYNODESSUPPORTED"));const r=t.callee.name.toLowerCase();let n="";if(null!==e.localScope&&(void 0!==e.localScope[r]?n="lscope['"+r+"']":void 0!==e.localScope._SymbolsMap[r]&&(n="lscope['"+e.localScope._SymbolsMap[r]+"']")),""===n&&(void 0!==e.globalScope[r]?n="gscope['"+r+"']":void 0!==e.globalScope._SymbolsMap[r]&&(n="gscope['"+e.globalScope._SymbolsMap[r]+"']")),""!==n){let r="[";for(let n=0;n<t.arguments.length;n++)n>0&&(r+=", "),r+=T(e,t.arguments[n]);return r+="]",e.isAsync?"(yield lang.callfunc("+n+","+r+",runtimeCtx) )":"lang.callfunc("+n+","+r+",runtimeCtx)"}throw new Error(y.nodeErrorMessage(t,"RUNTIME","NOTFOUND"))}catch(e){throw e}}(e,t);case"UnaryExpression":return function(e,t){try{return"lang.unary("+T(e,t.argument)+",'"+t.operator+"')"}catch(e){throw e}}(e,t);case"BinaryExpression":return function(e,t){try{return"lang.binary("+T(e,t.left)+","+T(e,t.right)+",'"+t.operator+"')"}catch(e){throw e}}(e,t);case"LogicalExpression":return function(e,t){try{if("AssignmentExpression"===t.left.type||"UpdateExpression"===t.left.type)throw new Error(y.nodeErrorMessage(t.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("AssignmentExpression"===t.right.type||"UpdateExpression"===t.right.type)throw new Error(y.nodeErrorMessage(t.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("&&"===t.operator||"||"===t.operator)return"(lang.logicalCheck("+T(e,t.left)+") "+t.operator+" lang.logicalCheck("+T(e,t.right)+"))";throw new Error(y.nodeErrorMessage(t,"RUNTIME","ONLYORORAND"))}catch(e){throw e}}(e,t);case"ConditionalExpression":throw new Error(y.nodeErrorMessage(t,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return function(e,t){try{const r=[];for(let n=0;n<t.elements.length;n++)"Literal"===t.elements[n].type?r.push(T(e,t.elements[n])):r.push("lang.aCheck("+T(e,t.elements[n])+",'ArrayExpression')");return"["+r.join(",")+"]"}catch(e){throw e}}(e,t);case"ObjectExpression":return function(e,t){let r="lang.dictionary([";for(let n=0;n<t.properties.length;n++){const o=t.properties[n];n>0&&(r+=","),r+="lang.strCheck("+("Identifier"===o.key.type?"'"+o.key.name+"'":T(e,o.key))+",'ObjectExpression'),lang.aCheck("+T(e,o.value)+", 'ObjectExpression')"}return r+="])",r}(e,t);case"Property":return function(e,t){throw new Error("Should not get here")}();case"Array":throw new Error(y.nodeErrorMessage(t,"RUNTIME","NOTSUPPORTED"));default:throw new Error(y.nodeErrorMessage(t,"RUNTIME","UNREOGNISED"))}}catch(e){throw e}}function R(e,t){return"BlockStatement"===t.type?T(e,t):"ReturnStatement"===t.type||"BreakStatement"===t.type||"ContinueStatement"===t.type?T(e,t)+"; ":"UpdateExpression"===t.type?"lastStatement = "+T(e,t)+"; ":"ExpressionStatement"===t.type?T(e,t):"ObjectExpression"===t.type?"lastStatement = "+T(e,t)+"; ":T(e,t)+"; "}function C(e,t){let r="";for(let n=0;n<t.body.length;n++)"ReturnStatement"===t.body[n].type||"BreakStatement"===t.body[n].type||"ContinueStatement"===t.body[n].type?r+=T(e,t.body[n])+"; \n":"UpdateExpression"===t.body[n].type||"ObjectExpression"===t.body[n].type?r+="lastStatement = "+T(e,t.body[n])+"; \n":r+=T(e,t.body[n])+" \n";return r}let A=0;const _={};function F(e){return null===e?"":f.isArray(e)||f.isImmutableArray(e)?"Array":f.isDate(e)?"Date":f.isString(e)?"String":f.isBoolean(e)?"Boolean":f.isNumber(e)?"Number":e instanceof h?"Attachment":e instanceof m?"Portal":e instanceof g?"Dictionary":e instanceof d?"Feature":e instanceof a?"Point":e instanceof l?"Polygon":e instanceof c?"Polyline":e instanceof s?"Multipoint":e instanceof i?"Extent":f.isFunctionParameter(e)?"Function":f.isFeatureSet(e)?"FeatureSet":f.isFeatureSetCollection(e)?"FeatureSetCollection":e===f.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function U(e,t,r,n){try{const o=t[r];if(f.equalityTest(o,n))return t[r+1];{const o=t.length-r;return 1===o?t[r]:2===o?null:3===o?t[r+2]:U(e,t,r+2,n)}}catch(e){throw e}}function P(e,t,r,n){try{if(!0===n)return t[r+1];if(3===t.length-r)return t[r+2];{const n=t[r+2];if(!1===f.isBoolean(n))throw new Error("WHEN needs boolean test conditions");return P(e,t,r+2,n)}}catch(e){throw e}}function k(e,t){const r=e.length,n=Math.floor(r/2);return 0===r?[]:1===r?[e[0]]:function(e,t,r){const n=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=r(e[0],t[0]);isNaN(o)&&(o=0),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(t[0]),t=t.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):t.length>0&&(n.push(t[0]),t=t.slice(1));return n}(k(e.slice(0,n),t),k(e.slice(n,r),t),t)}function D(e,t){try{const n=e.length,o=Math.floor(n/2);if(0===n)return r.resolve([]);if(1===n)return r.resolve([e[0]]);const a=[D(e.slice(0,o),t),D(e.slice(o,n),t)];return r.all(a).then((e=>L(e[0],e[1],t,[])))}catch(e){return r.reject(e)}}function L(e,t,n,o){return r.create(((r,a)=>{const i=o;e.length>0||t.length>0?e.length>0&&t.length>0?n(e[0],t[0]).then((s=>{try{isNaN(s)&&(s=1),s<=0?(i.push(e[0]),e=e.slice(1)):(i.push(t[0]),t=t.slice(1)),L(e,t,n,o).then((e=>{r(e)}),a)}catch(e){a(e)}}),a):e.length>0?(i.push(e[0]),L(e=e.slice(1),t,n,o).then((e=>{r(e)}),a)):t.length>0&&(i.push(t[0]),t=t.slice(1),L(e,t,n,o).then((e=>{r(e)}),a)):r(o)}))}function j(e){return e.symbols.symbolCounter++,"_T"+e.symbols.symbolCounter.toString()}function B(e){return e.symbols.symbolCounter++,"_Tvar"+e.symbols.symbolCounter.toString()}b.registerFunctions(_,I),S.registerFunctions(_,I),v.registerFunctions(_,I),N.registerFunctions(_,I),E.registerFunctions(_,I),M.registerFunctions(_,I),_.typeof=function(e,t){return I(e,t,(function(e,t,r){f.pcCheck(r,1,1);const n=F(r[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n}))},_.iif=function(e,t){try{return I(e,t,(function(e,t,r){if(f.pcCheck(r,3,3),!1===f.isBoolean(r[0]))throw new Error("IF Function must have a boolean test condition");return r[0]?r[1]:r[2]}))}catch(e){throw e}},_.decode=function(e,t){try{return I(e,t,(function(t,r,n){if(n.length<2)throw new Error("Missing Parameters");if(2===n.length)return n[1];{if((n.length-1)%2==0)throw new Error("Must have a default value result.");const t=n[0];return U(e,n,1,t)}}))}catch(e){throw e}},_.when=function(e,t){try{return I(e,t,(function(t,r,n){if(n.length<3)throw new Error("Missing Parameters");if(n.length%2==0)throw new Error("Must have a default value result.");const o=n[0];if(!1===f.isBoolean(o))throw new Error("WHEN needs boolean test conditions");return P(e,n,0,o)}))}catch(e){throw e}},_.top=function(e,t){return I(e,t,(function(e,t,r){if(f.pcCheck(r,2,2),f.isArray(r[0]))return f.toNumber(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,f.toNumber(r[1]));if(f.isImmutableArray(r[0]))return f.toNumber(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,f.toNumber(r[1]));throw new Error("Top cannot accept this parameter type")}))},_.first=function(e,t){return I(e,t,(function(e,t,r){return f.pcCheck(r,1,1),f.isArray(r[0])?0===r[0].length?null:r[0][0]:f.isImmutableArray(r[0])?0===r[0].length()?null:r[0].get(0):null}))},_.sort=function(e,t){return I(e,t,(function(t,r,n){f.pcCheck(n,1,2);let o=n[0];if(f.isImmutableArray(o)&&(o=o.toArray()),!1===f.isArray(o))throw new Error("Illegal Argument");if(n.length>1){if(!1===f.isFunctionParameter(n[1]))throw new Error("Illegal Argument");let r=o;const a=function(e,r){return W.callfunc(n[1],[e,r],t)};return e.isAsync?D(r,a):(r=k(r,(function(e,t){return a(e,t)})),r)}{let e=o;if(0===e.length)return[];const t={};for(let r=0;r<e.length;r++){const n=F(e[r]);""!==n&&(t[n]=!0)}if(!0===t.Array||!0===t.Dictionary||!0===t.Feature||!0===t.Point||!0===t.Polygon||!0===t.Polyline||!0===t.Multipoint||!0===t.Extent||!0===t.Function)return e.slice(0);let r=0,n="";for(const e in t)r++,n=e;return e=r>1||"String"===n?k(e,(function(e,t){if(null==e||e===f.voidOperation)return null==t||t===f.voidOperation?0:1;if(null==t||t===f.voidOperation)return-1;const r=f.toString(e),n=f.toString(t);return r<n?-1:r===n?0:1})):"Number"===n?k(e,(function(e,t){return e-t})):"Boolean"===n?k(e,(function(e,t){return e===t?0:t?-1:1})):"Date"===n?k(e,(function(e,t){return t-e})):e.slice(0),e}}))};const Y={};for(const e in _)Y[e]=new f.NativeFunction(_[e]);w.registerFunctions(_,I);for(const e in _)_[e]=new f.NativeFunction(_[e]);const V=function(){};V.prototype=_;const G=function(){};function z(e,t,r){const n={};e||(e={}),r||(r={}),n._SymbolsMap={},n.textformatting=1,n.infinity=1,n.pi=1;for(const e in t)n[e]=1;for(const e in r)n[e]=1;for(const t in e)n[t]=1;return n}G.prototype=Y;const q={fixSpatialReference:f.fixSpatialReference,parseArguments:function(e,t){const r=[];for(let n=0;n<t.arguments.length;n++)r.push(T(e,t.arguments[n]));return r},standardFunction:I};function J(e,t){const r={mode:t,compiled:!0,functions:{},signatures:[],failDefferred:x,standardFunction:I,standardFunctionAsync:I,evaluateIdentifier:Z};for(let t=0;t<e.length;t++)e[t].registerFunctions(r);if("sync"===t){for(const e in r.functions)_[e]=new f.NativeFunction(r.functions[e]),V.prototype[e]=_[e];for(let e=0;e<r.signatures.length;e++)y.addFunctionDeclaration(r.signatures[e],"sync")}else{for(const e in r.functions)Y[e]=new f.NativeFunction(r.functions[e]),G.prototype[e]=Y[e];for(let e=0;e<r.signatures.length;e++)y.addFunctionDeclaration(r.signatures[e],"async")}}function Z(e,t){const r=t.name;if("_SymbolsMap"===r)throw"Illegal";if(e.localStack.length>0){if("_t"!==r.substr(0,2).toLowerCase()&&void 0!==e.localStack[e.localStack.length-1][r])return e.localStack[e.localStack.length-1][r];const t=e.mangleMap[r];if(void 0!==t&&void 0!==e.localStack[e.localStack.length-1][t])return e.localStack[e.localStack.length-1][t]}if("_t"!==r.substr(0,2).toLowerCase()&&void 0!==e.globalScope[r])return e.globalScope[r];if(1===e.globalScope._SymbolsMap[r])return e.globalScope[r];const n=e.mangleMap[r];return void 0!==n?e.globalScope[n]:void 0}let H=0;const W={error(e,t,r){throw new Error(y.nodeErrorMessage(e,t,r))},__awaiter:(e,t,n,o)=>r.create(((r,n)=>{function a(e){try{s(o.next(e))}catch(e){n(e)}}function i(e){try{s(o.throw(e))}catch(e){n(e)}}function s(e){e.done?r(e.value):e.value&&e.value.then?e.value.then(a,i):(H++,H%100==0?setTimeout((()=>{H=0,a(e.value)}),0):a(e.value))}s((o=o.apply(e,t||[])).next())})),functionDepthchecker:(e,t)=>function(){if(t.depthCounter++,t.localStack.push([]),t.depthCounter>64)throw new Error("Exceeded maximum function depth");const n=e.apply(this,arguments);return r.isPromiseLike(n)?n.then((e=>(t.depthCounter--,t.localStack.length=t.localStack.length-1,e))):(t.depthCounter--,t.localStack.length=t.localStack.length-1,n)},castString:e=>f.toString(e),aCheck(e,t){if(f.isFunctionParameter(e))throw new Error(y.nodeErrorMessage({type:t},"RUNTIME","FUNCTIONCONTEXTILLEGAL"));return e===f.voidOperation?null:e},Dictionary:g,Feature:d,dictionary(e){const t={};for(let r=0;r<e.length;r+=2){if(f.isFunctionParameter(e[r+1]))throw new Error("Illegal Argument");if(!1===f.isString(e[r]))throw new Error("Illegal Argument");e[r+1]===f.voidOperation?t[e[r].toString()]=null:t[e[r].toString()]=e[r+1]}const r=new g(t);return r.immutable=!1,r},strCheck(e){if(!1===f.isString(e))throw new Error("Illegal Argument");return e},unary(e,t){if(f.isBoolean(e)){if("!"===t)return!e;if("-"===t)return-1*f.toNumber(e);if("+"===t)return 1*f.toNumber(e);if("~"===t)return~f.toNumber(e);const r={type:"UnaryExpression",operator:t,prefix:null,argument:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}if("-"===t)return-1*f.toNumber(e);if("+"===t)return 1*f.toNumber(e);if("~"===t)return~f.toNumber(e);const r={type:"UnaryExpression",operator:t,prefix:null,argument:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))},logicalCheck(e){if(!1===f.isBoolean(e)){const e={type:"LogicalExpression",operator:null,left:null,right:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","ONLYORORAND"))}return e},logical(e,t,r){if(f.isBoolean(e)&&f.isBoolean(t))switch(r){case"||":return e||t;case"&&":return e&&t;default:{const e={type:"LogicalExpression",operator:null,left:null,right:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","ONLYORORAND"))}}throw new Error(y.nodeErrorMessage({type:"LogicalExpression",operator:null,left:null,right:null},"RUNTIME","ONLYORORAND"))},binary(e,t,r){switch(r){case"|":case"<<":case">>":case">>>":case"^":case"&":return f.binaryOperator(f.toNumber(e),f.toNumber(t),r);case"==":case"=":return f.equalityTest(e,t);case"!=":return!f.equalityTest(e,t);case"<":case">":case"<=":case">=":return f.greaterThanLessThan(e,t,r);case"+":return f.isString(e)||f.isString(t)?f.toString(e)+f.toString(t):f.toNumber(e)+f.toNumber(t);case"-":return f.toNumber(e)-f.toNumber(t);case"*":return f.toNumber(e)*f.toNumber(t);case"/":return f.toNumber(e)/f.toNumber(t);case"%":return f.toNumber(e)%f.toNumber(t);default:{const n={type:"BinaryExpression",operator:r,left:e,right:t};throw new Error(y.nodeErrorMessage(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}},assign(e,t,r){switch(t){case"=":return e===f.voidOperation?null:e;case"/=":return f.toNumber(r)/f.toNumber(e);case"*=":return f.toNumber(r)*f.toNumber(e);case"-=":return f.toNumber(r)-f.toNumber(e);case"+=":return f.isString(r)||f.isString(e)?f.toString(r)+f.toString(e):f.toNumber(r)+f.toNumber(e);case"%=":return f.toNumber(r)%f.toNumber(e);default:{const e={type:"AssignmentExpression",operator:t,left:null,right:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","OPERATORNOTRECOGNISED"))}}},update(e,t,r,n){const o=f.toNumber(e[t]);return e[t]="++"===r?o+1:o-1,!1===n?o:"++"===r?o+1:o-1},graphicToFeature:(e,t)=>null===e?null:d.createFromGraphicLikeObject(e.geometry,e.attributes,t),memberupdate(e,t,r,n){let o;if(f.isArray(e)){if(!f.isNumber(t))throw new Error("Invalid Parameter");if(t<0&&(t=e.length+t),t<0||t>=e.length)throw new Error("Assignment outside of array bounds");o=f.toNumber(e[t]),e[t]="++"===r?o+1:o-1}else if(e instanceof g){if(!1===f.isString(t))throw new Error("Dictionary accessor must be a string");if(!0!==e.hasField(t))throw new Error("Invalid Parameter");o=f.toNumber(e.field(t)),e.setField(t,"++"===r?o+1:o-1)}else{if(!(e instanceof d))throw f.isImmutableArray(e)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===f.isString(t))throw new Error("Feature accessor must be a string");if(!0!==e.hasField(t))throw new Error("Invalid Parameter");o=f.toNumber(e.field(t)),e.setField(t,"++"===r?o+1:o-1)}return!1===n?o:"++"===r?o+1:o-1},assignmember(e,t,r,n){if(f.isArray(e)){if(!f.isNumber(t))throw new Error("Invalid Parameter");if(t<0&&(t=e.length+t),t<0||t>e.length)throw new Error("Assignment outside of array bounds");if(t===e.length){if("="!==r)throw new Error("Invalid Parameter");e[t]=this.assign(n,r,e[t])}else e[t]=this.assign(n,r,e[t])}else if(e instanceof g){if(!1===f.isString(t))throw new Error("Dictionary accessor must be a string");if(!0===e.hasField(t))e.setField(t,this.assign(n,r,e.field(t)));else{if("="!==r)throw new Error("Invalid Parameter");e.setField(t,this.assign(n,r,null))}}else{if(!(e instanceof d))throw f.isImmutableArray(e)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===f.isString(t))throw new Error("Feature accessor must be a string");if(!0===e.hasField(t))e.setField(t,this.assign(n,r,e.field(t)));else{if("="!==r)throw new Error("Invalid Parameter");e.setField(t,this.assign(n,r,null))}}},member(e,t){if(null===e){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","NOTFOUND"))}if(e instanceof O.FeatureSetReader){if(f.isString(t))return e.field(t);const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(e instanceof g||e instanceof d){if(f.isString(t))return e.field(t);const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(e instanceof o){if(f.isString(t))return function(e,t,r){let n;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let r=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(r=!1),r&&(A++,e.spatialReference._arcadeCacheId=A,t=A)}const r=new g({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(r._arcadeCacheId="SPREF"+t.toString()),r}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const r=e[t];return void 0!==r?r:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":return n=e.cache._arcadeCacheId,void 0===n&&(A++,n=A,e.cache._arcadeCacheId=n),new p(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,n);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":return n=e.cache._arcadeCacheId,void 0===n&&(A++,n=A,e.cache._arcadeCacheId=n),new p(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,n);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":return n=e.cache._arcadeCacheId,void 0===n&&(A++,n=A,e.cache._arcadeCacheId=n),new u(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,n,1);case"type":return"Multipoint"}}throw new Error(y.nodeErrorMessage(r,"RUNTIME","PROPERTYNOTFOUND"))}(e,t,"MemberExpression");const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(f.isArray(e)){if(f.isNumber(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length+t),t>=e.length||t<0){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","OUTOFBOUNDS"))}return e[t]}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(f.isString(e)){if(f.isNumber(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length+t),t>=e.length||t<0){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","OUTOFBOUNDS"))}return e[t]}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(f.isImmutableArray(e)){if(f.isNumber(t)&&isFinite(t)&&Math.floor(t)===t){if(t<0&&(t=e.length()+t),t>=e.length()||t<0){const e={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(e,"RUNTIME","OUTOFBOUNDS"))}return e.get(t)}const r={type:"MemberExpression",object:null,property:null,computed:null};throw new Error(y.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}throw new Error(y.nodeErrorMessage({type:"MemberExpression",object:null,property:null,computed:null},"RUNTIME","INVALIDTYPE"))},callfunc(e,t,r){return e instanceof f.NativeFunction?e.fn(r,t):e instanceof f.SizzleFunction?e.fn.apply(this,t):e.apply(this,t)}};function K(e){console.log(e)}t.compileScript=function(e,t=null,r=!1){null===t&&(t={vars:{},customfunctions:{}});const o={isAsync:r,globalScope:z(t.vars,r?Y:_,t.customfunctions),localScope:null,mangleMap:{},console:K,lrucache:t.lrucache,services:t.services,symbols:{symbolCounter:0}};let a=T(o,e.body[0].body);""===a&&(a="lc.voidOperation; ");let i="";i=r?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+a+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+a+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";const s={lc:f.lc,lang:W,mangles:o.mangleMap,postProcess(e){if(e instanceof f.ReturnResult&&(e=e.value),e instanceof f.ImplicitResult&&(e=e.value),e===f.voidOperation&&(e=null),e===f.breakResult)throw new Error("Cannot return BREAK");if(e===f.continueResult)throw new Error("Cannot return CONTINUE");if(f.isFunctionParameter(e))throw new Error("Cannot return FUNCTION");return e},prepare(e,t){let r=e.spatialReference;null==r&&(r=new n({wkid:102100}));const o=function(e,t,r){const n=r?new G:new V;e||(e={}),t||(t={});const o=new g({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});o.immutable=!1,n._SymbolsMap={textformatting:1,infinity:1,pi:1},n.textformatting=o,n.infinity=Number.POSITIVE_INFINITY,n.pi=Math.PI;for(const e in t)n[e]=t[e],n._SymbolsMap[e]=1;for(const t in e)n._SymbolsMap[t]=1,e[t]&&"esri.Graphic"===e[t].declaredClass?n[t]=d.createFromGraphic(e[t]):n[t]=e[t];return n}(e.vars,e.customfunctions,t);return{localStack:[],isAsync:t,mangleMap:this.mangles,spatialReference:r,globalScope:o,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console?e.console:K,lrucache:e.lrucache,symbols:{symbolCounter:0},depthCounter:1}}};return new Function("context","spatialReference",i).bind(s)},t.enableAsyncSupport=function(){return new Promise((function(t,r){e(["./functions/geomasync"],t,r)})).then((e=>(J([e],"async"),!0)))},t.executeScript=function(e,t){return e(t)},t.extend=J,t.extractFieldLiterals=function(e,t){return y.findFieldLiterals(e)},t.functionHelper=q,t.referencesFunction=function(e,t){return y.referencesFunction(e,t)},t.referencesMember=function(e,t){return y.referencesMember(e,t)},t.validateScript=function(e,t){return y.validateScript(e,t,"sync")},Object.defineProperty(t,"__esModule",{value:!0})}));
