/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","./ArcadePortal","./Attachment","./Dictionary","./Feature","./FunctionWrapper","./ImmutablePathArray","./ImmutablePointArray","../chunks/languageUtils","./treeAnalysis","./featureset/support/shared","./functions/array","./functions/date","./functions/geomasync","./functions/geometry","./functions/maths","./functions/stats","./functions/string","../core/promiseUtils","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","../geometry/SpatialReference"],(function(e,t,r,n,o,a,i,s,c,l,u,f,h,d,p,g,m,v,E,y,N,b,w,I,R,S){"use strict";function O(e){return e&&"function"==typeof e.then}const T=100;function M(e){return e instanceof Error?E.reject(e):E.reject(new Error(e))}function A(e){return E.resolve(e)}function F(e,t){const r=[];for(let n=0;n<t.arguments.length;n++)r.push(x(e,t.arguments[n]));return E.all(r)}function C(e,t,r){return E.create(((n,o)=>{F(e,t).then((a=>{try{n(r(e,t,a))}catch(i){o(i)}}),o)}))}function U(e,t,r){try{return F(e,t).then((n=>{try{const o=r(e,t,n);return O(o)?o:E.resolve(o)}catch(o){return M(o)}}))}catch(n){return M(n)}}function x(e,t,r){try{if(t.breakpoint&&!0!==r){return t.breakpoint().then((()=>x(e,t,!0)))}switch(t.type){case"VariableDeclarator":return ne(e,t);case"VariableDeclaration":return re(e,t,0);case"BlockStatement":return Q(e,t);case"FunctionDeclaration":return te(e,t);case"ReturnStatement":return ee(e,t);case"IfStatement":return J(e,t);case"ExpressionStatement":return X(e,t);case"UpdateExpression":return W(e,t);case"AssignmentExpression":return K(e,t);case"ForStatement":return _(e,t);case"ForInStatement":return H(e,t);case"BreakStatement":return E.resolve(c.breakResult);case"EmptyStatement":return E.resolve(c.voidOperation);case"ContinueStatement":return E.resolve(c.continueResult);case"TemplateElement":return de(e,t);case"TemplateLiteral":return pe(e,t);case"Identifier":return fe(e,t);case"MemberExpression":return ie(e,t);case"Literal":return A(t.value);case"CallExpression":return he(e,t);case"UnaryExpression":return se(e,t);case"BinaryExpression":return le(e,t);case"LogicalExpression":return ue(e,t);case"ArrayExpression":return ce(e,t);case"ObjectExpression":return P(e,t);case"Property":return k(e,t);default:return M(l.nodeErrorMessage(t,"RUNTIME","UNREOGNISED"))}}catch(n){return M(n)}}function P(e,t){try{const r=[];for(let n=0;n<t.properties.length;n++)r.push(x(e,t.properties[n]));return E.all(r).then((e=>E.create((t=>{const r={};for(let n=0;n<e.length;n++){const t=e[n];if(c.isFunctionParameter(t.value))throw new Error("Illegal Argument");if(!1===c.isString(t.key))throw new Error("Illegal Argument");t.value===c.voidOperation?r[t.key.toString()]=null:r[t.key.toString()]=t.value}const o=new n(r);o.immutable=!1,t(o)}))))}catch(r){return M(r)}}function k(e,t){try{return x(e,t.value).then((r=>E.create((n=>{"Identifier"===t.key.type?n({key:t.key.name,value:r}):x(e,t.key).then((e=>{n({key:e,value:r})}))}))))}catch(r){return E.reject(r)}}function D(e,t,r){try{return x(e,t.body).then((n=>{try{return r.lastAction=n,r.lastAction===c.breakResult||r.lastAction instanceof c.ReturnResult?(r.testResult=!1,E.resolve(r)):null!==t.update?x(e,t.update).then((()=>E.resolve(r))):E.resolve(r)}catch(o){return E.reject(o)}}))}catch(n){return E.reject(n)}}function L(e,t,r){try{return null!==t.test?x(e,t.test).then((n=>{try{return!0===e.abortSignal.aborted?E.reject(new Error("Cancelled")):(r.testResult=n,!1===r.testResult?E.resolve(r):!0!==r.testResult?E.reject(new Error(l.nodeErrorMessage(t,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):D(e,t,r))}catch(o){return E.reject(o)}})):D(e,t,r)}catch(n){return E.reject(n)}}function j(e,t,r,n,o,a){try{L(e,t,r).then((()=>{try{!0===r.testResult?++a>T?(a=0,setTimeout((()=>{j(e,t,r,n,o,a)}),0)):j(e,t,r,n,o,a):r.lastAction instanceof c.ReturnResult?n(r.lastAction):n(c.voidOperation)}catch(i){o(i)}}),(e=>{o(e)}))}catch(i){o(i)}}function _(e,t){try{return null!==t.init?x(e,t.init).then((()=>E.create(((r,n)=>{const o={testResult:!0,lastAction:c.voidOperation};j(e,t,o,(e=>{r(e)}),(e=>{n(e)}),0)})))):E.create(((r,n)=>{const o={testResult:!0,lastAction:c.voidOperation};j(e,t,o,(e=>{r(e)}),(e=>{n(e)}),0)}))}catch(r){return E.reject(r)}}function B(e,t,r,n,o,a,i,s,l,u){try{if(n<=a)return void s(c.voidOperation);o.value="k"===i?r[a]:a,x(e,t.body).then((f=>{try{f instanceof c.ReturnResult?s(f):f===c.breakResult?s(c.voidOperation):++u>T?(u=0,setTimeout((()=>{B(e,t,r,n,o,a+1,i,s,l,u)}),0)):B(e,t,r,n,o,a+1,i,s,l,u)}catch(h){l(h)}}),(e=>{l(e)}))}catch(f){l(f)}}function V(e,t,r,n,o,a,i,s,l){try{if(r.length()<=o)return void i(c.voidOperation);n.value="k"===a?r.get(o):o,x(e,t.body).then((u=>{u instanceof c.ReturnResult?i(u):u===c.breakResult?i(c.voidOperation):++l>T?(l=0,setTimeout((()=>{V(e,t,r,n,o+1,a,i,s,l)}),0)):V(e,t,r,n,o+1,a,i,s,l)}),(e=>{s(e)}))}catch(u){s(u)}}function Y(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(c.voidOperation);B(e,t,r,r.length,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(i){n.reject(i)}}function G(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(c.voidOperation);V(e,t,r,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(i){n.reject(i)}}function q(e,t,r,n,o){try{Y(e,t,r.keys(),n,o,"k")}catch(a){n.reject(a)}}function z(e,t,r,n,a,i,s,l){try{e.next().then((u=>{try{if(null===u)i(c.voidOperation);else{const f=o.createFromGraphicLikeObject(u.geometry,u.attributes,n);f._underlyingGraphic=u,a.value=f;x(t,r.body).then((o=>{try{o===c.breakResult?i(c.voidOperation):o instanceof c.ReturnResult?i(o):++l>T?(l=0,setTimeout((()=>{z(e,t,r,n,a,i,s,l)}),0)):z(e,t,r,n,a,i,s,l)}catch(u){s(u)}}),(e=>{s(e)}))}}catch(f){s(f)}}),(e=>{s(e)}))}catch(u){s(u)}}function H(e,t){return E.create(((r,a)=>{x(e,t.right).then((i=>{try{let s=null;s="VariableDeclaration"===t.left.type?x(e,t.left):E.resolve(),s.then((()=>{try{let s="";if("VariableDeclaration"===t.left.type){const e=t.left.declarations[0].id;"Identifier"===e.type&&(s=e.name)}else"Identifier"===t.left.type&&(s=t.left.name);if(!s)throw new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDVARIABLE"));s=s.toLowerCase();let u=null;if(null!==e.localScope&&void 0!==e.localScope[s]&&(u=e.localScope[s]),null===u&&void 0!==e.globalScope[s]&&(u=e.globalScope[s]),null===u)return void a(new Error(l.nodeErrorMessage(t,"RUNTIME","VARIABLENOTDECLARED")));c.isArray(i)||c.isString(i)?Y(e,t,i,{reject:a,resolve:r},u):c.isImmutableArray(i)?G(e,t,i,{reject:a,resolve:r},u):i instanceof n||i instanceof o?q(e,t,i,{reject:a,resolve:r},u):c.isFeatureSet(i)?z(i.iterator(e.abortSignal),e,t,i,u,(e=>{r(e)}),(e=>{a(e)}),0):Y(e,t,[],{reject:a,resolve:r},u)}catch(s){a(s)}}),a)}catch(s){a(s)}}),a)}))}function W(e,t){try{const r=t.argument;if("MemberExpression"===r.type){const a={t:null};return x(e,r.object).then((t=>{let n=null;return a.t=t,!0===r.computed?n=x(e,r.property):"Identifier"===r.property.type&&(n=E.resolve(r.property.name)),n})).then((e=>E.create((r=>{const i=a.t;let s;if(c.isArray(i)){if(!c.isNumber(e))throw new Error("Invalid Parameter");if(e<0&&(e=i.length+e),e<0||e>=i.length)throw new Error("Assignment outside of array bounds");s=c.toNumber(i[e]),i[e]="++"===t.operator?s+1:s-1}else if(i instanceof n){if(!1===c.isString(e))throw new Error("Dictionary accessor must be a string");if(!0!==i.hasField(e))throw new Error("Invalid Parameter");s=c.toNumber(i.field(e)),i.setField(e,"++"===t.operator?s+1:s-1)}else{if(!(i instanceof o))throw c.isImmutableArray(i)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===c.isString(e))throw new Error("Feature accessor must be a string");if(!0!==i.hasField(e))throw new Error("Invalid Parameter");s=c.toNumber(i.field(e)),i.setField(e,"++"===t.operator?s+1:s-1)}!1===t.prefix?r(s):r("++"===t.operator?s+1:s-1)}))))}return E.create(((r,n)=>{const o="Identifier"===t.argument.type?t.argument.name.toLowerCase():"";if(!o)throw new Error("Invalid identifier");let a;return null!==e.localScope&&void 0!==e.localScope[o]?(a=c.toNumber(e.localScope[o].value),e.localScope[o]={value:"++"===t.operator?a+1:a-1,valueset:!0,node:t},void(!1===t.prefix?r(a):r("++"===t.operator?a+1:a-1))):void 0!==e.globalScope[o]?(a=c.toNumber(e.globalScope[o].value),e.globalScope[o]={value:"++"===t.operator?a+1:a-1,valueset:!0,node:t},void(!1===t.prefix?r(a):r("++"===t.operator?a+1:a-1))):void n(new Error("Variable not recognised"))}))}catch(r){return E.reject(r)}}function Z(e,t,r,n){switch(t){case"=":return e===c.voidOperation?null:e;case"/=":return c.toNumber(r)/c.toNumber(e);case"*=":return c.toNumber(r)*c.toNumber(e);case"-=":return c.toNumber(r)-c.toNumber(e);case"+=":return c.isString(r)||c.isString(e)?c.toString(r)+c.toString(e):c.toNumber(r)+c.toNumber(e);case"%=":return c.toNumber(r)%c.toNumber(e);default:throw new Error(l.nodeErrorMessage(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}function K(e,t){return E.create(((r,a)=>{const i=t.left;if("MemberExpression"===i.type)x(e,t.right).then((s=>{try{x(e,i.object).then((l=>{try{let u=null;if(!0===i.computed)u=x(e,i.property);else{if("Identifier"!==i.property.type)throw new Error("Expected computed or identifier for assignemnt target");u=E.resolve(i.property.name)}u.then((e=>{try{if(c.isArray(l)){if(!c.isNumber(e))throw new Error("Invalid Parameter");if(e<0&&(e=l.length+e),e<0||e>l.length)throw new Error("Assignment outside of array bounds");if(e===l.length){if("="!==t.operator)throw new Error("Invalid Parameter");l[e]=Z(s,t.operator,l[e],t)}else l[e]=Z(s,t.operator,l[e],t)}else if(l instanceof n){if(!1===c.isString(e))throw new Error("Dictionary accessor must be a string");if(!0===l.hasField(e))l.setField(e,Z(s,t.operator,l.field(e),t));else{if("="!==t.operator)throw new Error("Invalid Parameter");l.setField(e,Z(s,t.operator,null,t))}}else{if(!(l instanceof o))throw c.isImmutableArray(l)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===c.isString(e))throw new Error("Feature accessor must be a string");if(!0===l.hasField(e))l.setField(e,Z(s,t.operator,l.field(e),t));else{if("="!==t.operator)throw new Error("Invalid Parameter");l.setField(e,Z(s,t.operator,null,t))}}r(c.voidOperation)}catch(i){a(i)}}),a)}catch(u){a(u)}}),a)}catch(l){a(l)}}),a);else{const n=i.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[n])return void x(e,t.right).then((o=>{try{e.localScope[n]={value:Z(o,t.operator,e.localScope[n].value,t),valueset:!0,node:t.right},r(c.voidOperation)}catch(i){a(i)}}),a);void 0!==e.globalScope[n]?x(e,t.right).then((o=>{try{e.globalScope[n]={value:Z(o,t.operator,e.globalScope[n].value,t),valueset:!0,node:t.right},r(c.voidOperation)}catch(i){a(i)}}),a):a(new Error("Cannot assign undeclared variable"))}}))}function X(e,t){try{return"AssignmentExpression"===t.expression.type?x(e,t.expression):(t.expression.type,x(e,t.expression).then((e=>E.create((t=>{e===c.voidOperation?t(c.voidOperation):t(new c.ImplicitResult(e))})))))}catch(r){return E.reject(r)}}function J(e,t){return E.create(((r,n)=>{"AssignmentExpression"!==t.test.type&&"UpdateExpression"!==t.test.type?x(e,t.test).then((o=>{try{!0===o?x(e,t.consequent).then(r,n):!1===o?null!==t.alternate?x(e,t.alternate).then(r,n):r(c.voidOperation):n(new Error(l.nodeErrorMessage(t.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))}catch(a){n(a)}}),n):n(new Error(l.nodeErrorMessage(t.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION")))}))}function Q(e,t){try{return $(e,t,0)}catch(r){return M(r)}}function $(e,t,r){try{return r>=t.body.length?E.resolve(c.voidOperation):E.create(((n,o)=>{x(e,t.body[r]).then((a=>{try{a instanceof c.ReturnResult||a===c.breakResult||a===c.continueResult||r===t.body.length-1?n(a):$(e,t,r+1).then(n,o)}catch(i){o(i)}}),o)}))}catch(n){return M(n)}}function ee(e,t){return E.create(((r,n)=>{null===t.argument?r(new c.ReturnResult(c.voidOperation)):x(e,t.argument).then((e=>{try{r(new c.ReturnResult(e))}catch(t){n(t)}}),n)}))}function te(e,t){try{const r=t.id.name.toLowerCase();return e.globalScope[r]={valueset:!0,node:null,value:new a(t,e)},E.resolve(c.voidOperation)}catch(r){return M(r)}}function re(e,t,r){return E.create(((n,o)=>{r>=t.declarations.length?n(c.voidOperation):x(e,t.declarations[r]).then((()=>{r===t.declarations.length-1?n(c.voidOperation):re(e,t,r+1).then((()=>{n(c.voidOperation)}),o)}),o)}))}function ne(e,t){try{let r=null;return r=null===t.init?E.resolve(null):x(e,t.init),null!==e.localScope?r.then((r=>E.create((n=>{if(r===c.voidOperation&&(r=null),"Identifier"!==t.id.type)throw new Error("Can only assign a regular variable");const o=t.id.name.toLowerCase();e.localScope[o]={value:r,valueset:!0,node:t.init},n(c.voidOperation)})))):r.then((r=>E.create((n=>{if("Identifier"!==t.id.type)throw new Error("Can only assign a regular variable");const o=t.id.name.toLowerCase();r===c.voidOperation&&(r=null),e.globalScope[o]={value:r,valueset:!0,node:t.init},n(c.voidOperation)}))))}catch(r){return M(r)}}let oe=0;function ae(e,t,r,o){let a;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let r=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(r=!1),r&&(oe++,e.spatialReference._arcadeCacheId=oe,t=oe)}const r=new n({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(r._arcadeCacheId="SPREF"+t.toString()),r}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const r=e[t];return void 0!==r?r:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":a=e.cache._arcadeCacheId,void 0===a&&(oe++,a=oe,e.cache._arcadeCacheId=a);return new i(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,a);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":a=e.cache._arcadeCacheId,void 0===a&&(oe++,a=oe,e.cache._arcadeCacheId=a);return new i(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,a);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":a=e.cache._arcadeCacheId,void 0===a&&(oe++,a=oe,e.cache._arcadeCacheId=a);return new s(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,a,1);case"type":return"Multipoint"}}throw new Error(l.nodeErrorMessage(o,"RUNTIME","PROPERTYNOTFOUND"))}function ie(e,t){try{return x(e,t.object).then((r=>{try{return null===r?E.reject(new Error(l.nodeErrorMessage(t,"RUNTIME","NOTFOUND"))):!1===t.computed?"Identifier"===t.property.type?r instanceof n||r instanceof o?E.resolve(r.field(t.property.name)):r instanceof N?E.resolve(ae(r,t.property.name,e,t)):E.reject(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE"))):E.reject(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE"))):x(e,t.property).then((a=>E.create(((i,s)=>{if(r instanceof n||r instanceof o)c.isString(a)?i(r.field(a)):s(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE")));else if(r instanceof N)c.isString(a)?i(ae(r,a,e,t)):s(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE")));else if(c.isArray(r))if(c.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=r.length+a),a>=r.length||a<0)throw new Error(l.nodeErrorMessage(t,"RUNTIME","OUTOFBOUNDS"));i(r[a])}else s(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE")));else if(c.isImmutableArray(r))if(c.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=r.length()+a),a>=r.length()||a<0)throw new Error(l.nodeErrorMessage(t,"RUNTIME","OUTOFBOUNDS"));i(r.get(a))}else s(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE")));else if(c.isString(r))if(c.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=r.length+a),a>=r.length||a<0)throw new Error(l.nodeErrorMessage(t,"RUNTIME","OUTOFBOUNDS"));i(r[a])}else s(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE")));else s(new Error(l.nodeErrorMessage(t,"RUNTIME","INVALIDTYPE")))}))))}catch(a){return M(a)}}))}catch(r){return M(r)}}function se(e,t){try{return x(e,t.argument).then((e=>E.create(((r,n)=>{c.isBoolean(e)&&"!"===t.operator?r(!e):"-"===t.operator?r(-1*c.toNumber(e)):"+"===t.operator?r(1*c.toNumber(e)):"~"===t.operator?r(~c.toNumber(e)):n(new Error(l.nodeErrorMessage(t,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))}))))}catch(r){return M(r)}}function ce(e,t){try{const r=[];for(let n=0;n<t.elements.length;n++)r.push(x(e,t.elements[n]));return E.all(r).then((e=>E.create(((r,n)=>{for(let o=0;o<e.length;o++){if(c.isFunctionParameter(e[o]))return void n(new Error(l.nodeErrorMessage(t,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[o]===c.voidOperation&&(e[o]=null)}r(e)}))))}catch(r){return M(r)}}function le(e,t){try{return E.all([x(e,t.left),x(e,t.right)]).then((e=>E.create(((r,n)=>{const o=e[0],a=e[1];switch(t.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":r(c.binaryOperator(c.toNumber(o),c.toNumber(a),t.operator));case"==":r(c.equalityTest(o,a));break;case"!=":r(!c.equalityTest(o,a));break;case"<":case">":case"<=":case">=":r(c.greaterThanLessThan(o,a,t.operator));break;case"+":c.isString(o)||c.isString(a)?r(c.toString(o)+c.toString(a)):r(c.toNumber(o)+c.toNumber(a));break;case"-":r(c.toNumber(o)-c.toNumber(a));break;case"*":r(c.toNumber(o)*c.toNumber(a));break;case"/":r(c.toNumber(o)/c.toNumber(a));break;case"%":r(c.toNumber(o)%c.toNumber(a));break;default:n(new Error(l.nodeErrorMessage(t,"RUNTIME","OPERATORNOTRECOGNISED")))}}))))}catch(r){return M(r)}}function ue(e,t){return E.create(((r,n)=>{"AssignmentExpression"!==t.left.type&&"UpdateExpression"!==t.left.type?"AssignmentExpression"!==t.right.type&&"UpdateExpression"!==t.right.type?x(e,t.left).then((o=>{try{if(!c.isBoolean(o))throw new Error(l.nodeErrorMessage(t,"RUNTIME","ONLYBOOLEAN"));switch(t.operator){case"||":!0===o?r(o):x(e,t.right).then((e=>{try{if(!c.isBoolean(e))throw new Error(l.nodeErrorMessage(t,"RUNTIME","ONLYORORAND"));r(e)}catch(o){n(o)}}),n);break;case"&&":!1===o?r(o):x(e,t.right).then((e=>{try{if(!c.isBoolean(e))throw new Error(l.nodeErrorMessage(t,"RUNTIME","ONLYORORAND"));r(e)}catch(o){n(o)}}),n);break;default:throw new Error(l.nodeErrorMessage(t,"RUNTIME","ONLYORORAND"))}}catch(a){n(a)}}),n):n(new Error(l.nodeErrorMessage(t.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))):n(new Error(l.nodeErrorMessage(t.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION")))}))}function fe(e,t){return E.create(((r,n)=>{const o=t.name.toLowerCase();if(null===e.localScope||void 0===e.localScope[o])if(void 0===e.globalScope[o])n(new Error(l.nodeErrorMessage(t,"RUNTIME","VARIABLENOTFOUND")));else{const t=e.globalScope[o];!0===t.valueset?r(t.value):null!==t.d?t.d.then(r,n):(t.d=x(e,t.node),t.d.then((e=>{try{t.value=e,t.valueset=!0,r(e)}catch(o){n(o)}}),n))}else{const t=e.localScope[o];!0===t.valueset?r(t.value):null!==t.d?t.d.then(r,n):(t.d=x(e,t.node),t.d.then((e=>{try{t.value=e,t.valueset=!0,r(e)}catch(o){n(o)}}),n))}}))}function he(e,t){try{if("Identifier"!==t.callee.type)return M(l.nodeErrorMessage(t,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[t.callee.name.toLowerCase()]){const r=e.localScope[t.callee.name.toLowerCase()];return r.value instanceof c.NativeFunction?r.value.fn(e,t):r.value instanceof a?Re(e,t,r.value.definition):M(l.nodeErrorMessage(t,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[t.callee.name.toLowerCase()]){const r=e.globalScope[t.callee.name.toLowerCase()];return r.value instanceof c.NativeFunction?r.value.fn(e,t):r.value instanceof a?Re(e,t,r.value.definition):M(l.nodeErrorMessage(t,"RUNTIME","NOTAFUNCTION"))}return M(l.nodeErrorMessage(t,"RUNTIME","NOTFOUND"))}catch(r){return M(r)}}function de(e,t){return E.resolve(t.value?t.value.cooked:"")}function pe(e,t){return E.create((r=>{const n=[];u.reduceArrayWithPromises(t.expressions,((t,r,o,a)=>x(e,r).then((e=>{n[o]=c.toString(e)})))).then((()=>{let e="",o=0;for(const r of t.quasis)if(e+=r.value?r.value.cooked:"",!1===r.tail){e+=n[o]?n[o]:"",o++}r(e)}))}))}const ge={};function me(e){return null===e?"":c.isArray(e)||c.isImmutableArray(e)?"Array":c.isDate(e)?"Date":c.isString(e)?"String":c.isBoolean(e)?"Boolean":c.isNumber(e)?"Number":e instanceof r?"Attachment":e instanceof t?"Portal":e instanceof n?"Dictionary":e instanceof o?"Feature":e instanceof w?"Point":e instanceof I?"Polygon":e instanceof R?"Polyline":e instanceof b?"Multipoint":e instanceof y?"Extent":c.isFunctionParameter(e)?"Function":c.isFeatureSet(e)?"FeatureSet":c.isFeatureSetCollection(e)?"FeatureSetCollection":e===c.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function ve(e,t,r,n){return E.create(((o,a)=>{x(e,t.arguments[r]).then((i=>{try{if(c.equalityTest(i,n))return void x(e,t.arguments[r+1]).then(o,a);{const i=t.arguments.length-r;return 1===i?void x(e,t.arguments[r]).then(o,a):(2===i&&o(null),3===i?void x(e,t.arguments[r+2]).then(o,a):void ve(e,t,r+2,n).then(o,a))}}catch(s){a(s)}}),a)}))}function Ee(e,t,r,n){return E.create(((o,a)=>{if(!0===n)x(e,t.arguments[r+1]).then(o,a);else{3===t.arguments.length-r?x(e,t.arguments[r+2]).then(o,a):x(e,t.arguments[r+2]).then((n=>{try{if(!1===c.isBoolean(n))return void a(new Error("WHEN needs boolean test conditions"));Ee(e,t,r+2,n).then(o,a)}catch(i){a(i)}}))}}))}function ye(e,t){try{const r=e.length,n=Math.floor(r/2);return 0===r?E.resolve([]):1===r?E.resolve([e[0]]):E.create(((o,a)=>{const i=[ye(e.slice(0,n),t),ye(e.slice(n,r),t)];E.all(i).then((e=>{try{Ne(e[0],e[1],t,[]).then(o,a)}catch(r){a(r)}}),a)}))}catch(r){return M(r)}}function Ne(e,t,r,n){return E.create(((o,a)=>{const i=n;e.length>0||t.length>0?e.length>0&&t.length>0?r(e[0],t[0]).then((s=>{try{isNaN(s)&&(s=1),s<=0?(i.push(e[0]),e=e.slice(1)):(i.push(t[0]),t=t.slice(1)),Ne(e,t,r,n).then(o,a)}catch(c){a(c)}}),a):e.length>0?(i.push(e[0]),Ne(e=e.slice(1),t,r,n).then(o,a)):t.length>0&&(i.push(t[0]),t=t.slice(1),Ne(e,t,r,n).then(o,a)):o(n)}))}function be(e,t){const r=e.length,n=Math.floor(r/2);return t||(t=function(e,t){return e<t?-1:e===t?0:1}),0===r?[]:1===r?[e[0]]:we(be(e.slice(0,n),t),be(e.slice(n,r),t),t)}function we(e,t,r){const n=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=r(e[0],t[0]);isNaN(o)&&(o=1),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(t[0]),t=t.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):t.length>0&&(n.push(t[0]),t=t.slice(1));return n}function Ie(e,t,r){try{const n=e.body;if(r.length!==e.params.length)return M(new Error("Invalid Parameter calls to function."));for(let o=0;o<r.length;o++){const n=e.params[o];"Identifier"===n.type&&(t.localScope[n.name.toLowerCase()]={d:null,value:r[o],valueset:!0,node:null})}return x(t,n).then((e=>E.create(((t,r)=>{e instanceof c.ReturnResult?t(e.value):e!==c.breakResult?e!==c.continueResult?e instanceof c.ImplicitResult?t(e.value):t(e):r(new Error("Cannot Continue from a Function")):r(new Error("Cannot Break from a Function"))}))))}catch(n){return E.reject(n)}}function Re(e,t,r){return U(e,t,(function(t,n,o){const a={spatialReference:e.spatialReference,services:e.services,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return Ie(r,a,o)}))}function Se(e){const t=function(){const t={abortSignal:e.context.abortSignal,spatialReference:e.context.spatialReference,console:e.context.console,lrucache:e.context.lrucache,interceptor:e.context.interceptor,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(t.depthCounter>64)throw new Error("Exceeded maximum function depth");return Ie(e.definition,t,arguments)};return t}f.registerFunctions(ge,C),h.registerFunctions(ge,C),v.registerFunctions(ge,C),g.registerFunctions(ge,C),p.registerFunctions(ge,C),m.registerFunctions(ge,C),d.registerFunctions({functions:ge,compiled:!1,signatures:null,failDefferred:null,evaluateIdentifier:null,arcadeCustomFunctionHandler:null,mode:"async",standardFunction:C,standardFunctionAsync:U}),ge.typeof=function(e,t){return C(e,t,(function(e,t,r){c.pcCheck(r,1,1);const n=me(r[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n}))},ge.iif=function(e,t){return E.create(((r,n)=>{c.pcCheck(null===t.arguments?[]:t.arguments,3,3),x(e,t.arguments[0]).then((o=>{try{if(!1===c.isBoolean(o))return void n(new Error("IF Function must have a boolean test condition"));E.all([x(e,t.arguments[1]),x(e,t.arguments[2])]).then((e=>{r(o?e[0]:e[1])}),n)}catch(a){n(a)}}),n)}))},ge.decode=function(e,t){return E.create(((r,n)=>{t.arguments.length<2?n(new Error("Missing Parameters")):2!==t.arguments.length?(t.arguments.length-1)%2!=0?x(e,t.arguments[0]).then((o=>{try{ve(e,t,1,o).then(r,n)}catch(a){n(a)}}),n):n(new Error("Must have a default value result.")):x(e,t.arguments[1]).then(r,n)}))},ge.when=function(e,t){try{return t.arguments.length<3?M("Missing Parameters"):t.arguments.length%2==0?M("Must have a default value result."):x(e,t.arguments[0]).then((r=>E.create(((n,o)=>{if(!1===c.isBoolean(r))return void o(new Error("WHEN needs boolean test conditions"));Ee(e,t,0,r).then(n,o)}))))}catch(r){return M(r)}},ge.sort=function(e,t){return U(e,t,(function(e,t,r){c.pcCheck(r,1,2);let n=r[0];if(c.isImmutableArray(n)&&(n=n.toArray()),!1===c.isArray(n))return M(Error("Illegal Argument"));if(r.length>1){if(!1===c.isFunctionParameter(r[1]))return M(Error("Illegal Argument"));return ye(n,Se(r[1]))}{let e=n;if(0===e.length)return E.resolve([]);const t={};for(let n=0;n<e.length;n++){const r=me(e[n]);""!==r&&(t[r]=!0)}if(!0===t.Array||!0===t.Dictionary||!0===t.Feature||!0===t.Point||!0===t.Polygon||!0===t.Polyline||!0===t.Multipoint||!0===t.Extent||!0===t.Function)return E.resolve(e.slice(0));let r=0,o="";for(const n in t)r++,o=n;return r>1||"String"===o?e=be(e,(function(e,t){if(null==e||e===c.voidOperation)return null==t||t===c.voidOperation?0:1;if(null==t||t===c.voidOperation)return-1;const r=c.toString(e),n=c.toString(t);return r<n?-1:r===n?0:1})):"Number"===o?e=be(e,(function(e,t){return e-t})):"Boolean"===o?e=be(e,(function(e,t){return e===t?0:t?-1:1})):"Date"===o&&(e=be(e,(function(e,t){return t-e}))),E.resolve(e)}}))};const Oe={failDefferred:M,resolveDeffered:A,fixSpatialReference:c.fixSpatialReference,parseArguments:F,standardFunction:C,standardFunctionAsync:U,evaluateIdentifier:fe,arcadeCustomFunction:Se};for(const je in ge)ge[je]={value:new c.NativeFunction(ge[je]),valueset:!0,node:null};const Te=function(){};function Me(e,t){const r=new Te;null==e&&(e={}),null==t&&(t={});const a=new n({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});a.immutable=!1,r.textformatting={value:a,valueset:!0,node:null};for(const n in t)r[n]={value:new c.NativeFunction(t[n]),native:!0,valueset:!0,node:null};for(const n in e)e[n]&&"esri.Graphic"===e[n].declaredClass?r[n]={value:o.createFromGraphic(e[n]),valueset:!0,node:null}:r[n]={value:e[n],valueset:!0,node:null};return r}function Ae(e){console.log(e)}Te.prototype=ge,Te.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},Te.prototype.pi={value:Math.PI,valueset:!0,node:null};const Fe=Oe;function Ce(e){const t={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:C,standardFunctionAsync:U,failDefferred:M,evaluateIdentifier:fe,arcadeCustomFunctionHandler:Se};for(let r=0;r<e.length;r++)e[r].registerFunctions(t);for(const r in t.functions)ge[r]={value:new c.NativeFunction(t.functions[r]),valueset:!0,node:null},Te.prototype[r]=ge[r];for(let r=0;r<t.signatures.length;r++)l.addFunctionDeclaration(t.signatures[r],"async")}function Ue(e,t){let r=t.spatialReference;null==r&&(r=new S({wkid:102100}));const n=Me(t.vars,t.customfunctions);return x({spatialReference:r,services:t.services,abortSignal:void 0===t.abortSignal||null===t.abortSignal?{aborted:!1}:t.abortSignal,globalScope:n,console:t.console?t.console:Ae,lrucache:t.lrucache,interceptor:t.interceptor,localScope:null,depthCounter:1},e.body[0].body).then((e=>E.create(((t,r)=>{e instanceof c.ReturnResult&&(e=e.value),e instanceof c.ImplicitResult&&(e=e.value),e===c.voidOperation&&(e=null),e!==c.breakResult?e!==c.continueResult?e instanceof c.NativeFunction||e instanceof a?r(new Error("Cannot return FUNCTION")):t(e):r(new Error("Cannot return CONTINUE")):r(new Error("Cannot return BREAK"))}))))}function xe(e,t){return l.findFieldLiterals(e)}function Pe(e,t){return l.validateScript(e,t,"full")}function ke(e,t){return l.referencesMember(e,t)}function De(e,t){return l.referencesFunction(e,t)}function Le(e){return l.findFunctionCalls(e)}e.executeScript=Ue,e.extend=Ce,e.extractFieldLiterals=xe,e.findFunctionCalls=Le,e.functionHelper=Fe,e.referencesFunction=De,e.referencesMember=ke,e.validateScript=Pe,Object.defineProperty(e,"__esModule",{value:!0})}));
