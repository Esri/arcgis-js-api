// COPYRIGHT © 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","./assert","./character","./messages","./token"],(function(e,t,i,s,r,n){"use strict";function h(e){return"0123456789abcdef".indexOf(e.toLowerCase())}function a(e){return"01234567".indexOf(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.Scanner=void 0;var o=function(){function e(e,t){this.source=e,this.errorHandler=t,this.trackComment=!1,this.isModule=!1,this.length=e.length,this.index=0,this.lineNumber=e.length>0?1:0,this.lineStart=0,this.curlyStack=[]}return e.prototype.saveState=function(){return{index:this.index,lineNumber:this.lineNumber,lineStart:this.lineStart,curlyStack:this.curlyStack.slice()}},e.prototype.restoreState=function(e){this.index=e.index,this.lineNumber=e.lineNumber,this.lineStart=e.lineStart,this.curlyStack=e.curlyStack},e.prototype.eof=function(){return this.index>=this.length},e.prototype.throwUnexpectedToken=function(e){return void 0===e&&(e=r.Messages.UnexpectedTokenIllegal),this.errorHandler.throwError(this.index,this.lineNumber,this.index-this.lineStart+1,e)},e.prototype._tolerateUnexpectedToken=function(e){void 0===e&&(e=r.Messages.UnexpectedTokenIllegal),this.errorHandler.tolerateError(this.index,this.lineNumber,this.index-this.lineStart+1,e)},e.prototype._skipSingleLineComment=function(e){var t=[],i=0,r=null;for(this.trackComment&&(t=[],i=this.index-e,r={start:{line:this.lineNumber,column:this.index-this.lineStart-e},end:{line:0,column:0}});!this.eof();){var n=this.source.charCodeAt(this.index);if(++this.index,s.Character.isLineTerminator(n)){if(r){r.end={line:this.lineNumber,column:this.index-this.lineStart-1};var h={multiLine:!1,slice:[i+e,this.index-1],range:[i,this.index-1],loc:r};t.push(h)}return 13===n&&10===this.source.charCodeAt(this.index)&&++this.index,++this.lineNumber,this.lineStart=this.index,t}}if(r){r.end={line:this.lineNumber,column:this.index-this.lineStart};h={multiLine:!1,slice:[i+e,this.index],range:[i,this.index],loc:r};t.push(h)}return t},e.prototype._skipMultiLineComment=function(){var e=[],t=0,i=null;for(this.trackComment&&(t=this.index-2,i={start:{line:this.lineNumber,column:this.index-this.lineStart-2},end:{line:0,column:0}});!this.eof();){var r=this.source.charCodeAt(this.index);if(s.Character.isLineTerminator(r))13===r&&10===this.source.charCodeAt(this.index+1)&&++this.index,++this.lineNumber,++this.index,this.lineStart=this.index;else if(42===r){if(47===this.source.charCodeAt(this.index+1)){if(this.index+=2,i){i.end={line:this.lineNumber,column:this.index-this.lineStart};var n={multiLine:!0,slice:[t+2,this.index-2],range:[t,this.index],loc:i};e.push(n)}return e}++this.index}else++this.index}if(i){i.end={line:this.lineNumber,column:this.index-this.lineStart};n={multiLine:!0,slice:[t+2,this.index],range:[t,this.index],loc:i};e.push(n)}return this._tolerateUnexpectedToken(),e},e.prototype.scanComments=function(){var e=null;this.trackComment&&(e=[]);for(var t=0===this.index;!this.eof();){var i=this.source.charCodeAt(this.index);if(s.Character.isWhiteSpace(i))++this.index;else if(s.Character.isLineTerminator(i))++this.index,13===i&&10===this.source.charCodeAt(this.index)&&++this.index,++this.lineNumber,this.lineStart=this.index,t=!0;else if(47===i)if(47===(i=this.source.charCodeAt(this.index+1))){this.index+=2;var r=this._skipSingleLineComment(2);e&&(e=e.concat(r)),t=!0}else{if(42!==i)break;this.index+=2;r=this._skipMultiLineComment();e&&(e=e.concat(r))}else if(t&&45===i){if(45!==this.source.charCodeAt(this.index+1)||62!==this.source.charCodeAt(this.index+2))break;this.index+=3;r=this._skipSingleLineComment(3);e&&(e=e.concat(r))}else{if(60!==i||this.isModule)break;if("!--"!==this.source.slice(this.index+1,this.index+4))break;this.index+=4;r=this._skipSingleLineComment(4);e&&(e=e.concat(r))}}return e},e.prototype._isKeyword=function(e){switch((e=e.toLowerCase()).length){case 2:return"if"===e||"in"===e;case 3:return"var"===e||"for"===e;case 4:return"else"===e;case 5:return"break"===e;case 6:return"return"===e;case 8:return"function"===e||"continue"===e;default:return!1}},e.prototype._codePointAt=function(e){var t=this.source.charCodeAt(e);if(t>=55296&&t<=56319){var i=this.source.charCodeAt(e+1);if(i>=56320&&i<=57343)t=1024*(t-55296)+i-56320+65536}return t},e.prototype._scanHexEscape=function(e){for(var t="u"===e?4:2,i=0,r=0;r<t;++r){if(this.eof()||!s.Character.isHexDigit(this.source.charCodeAt(this.index)))return null;i=16*i+h(this.source[this.index++])}return String.fromCharCode(i)},e.prototype._scanUnicodeCodePointEscape=function(){var e=this.source[this.index],t=0;for("}"===e&&this.throwUnexpectedToken();!this.eof()&&(e=this.source[this.index++],s.Character.isHexDigit(e.charCodeAt(0)));)t=16*t+h(e);return(t>1114111||"}"!==e)&&this.throwUnexpectedToken(),s.Character.fromCodePoint(t)},e.prototype._getIdentifier=function(){for(var e=this.index++;!this.eof();){var t=this.source.charCodeAt(this.index);if(92===t)return this.index=e,this._getComplexIdentifier();if(t>=55296&&t<57343)return this.index=e,this._getComplexIdentifier();if(!s.Character.isIdentifierPart(t))break;++this.index}return this.source.slice(e,this.index)},e.prototype._getComplexIdentifier=function(){var e,t=this._codePointAt(this.index),i=s.Character.fromCodePoint(t);for(this.index+=i.length,92===t&&(117!==this.source.charCodeAt(this.index)&&this.throwUnexpectedToken(),++this.index,"{"===this.source[this.index]?(++this.index,e=this._scanUnicodeCodePointEscape()):null!==(e=this._scanHexEscape("u"))&&"\\"!==e&&s.Character.isIdentifierStart(e.charCodeAt(0))||this.throwUnexpectedToken(),i=e);!this.eof()&&(t=this._codePointAt(this.index),s.Character.isIdentifierPart(t));)i+=e=s.Character.fromCodePoint(t),this.index+=e.length,92===t&&(i=i.substr(0,i.length-1),117!==this.source.charCodeAt(this.index)&&this.throwUnexpectedToken(),++this.index,"{"===this.source[this.index]?(++this.index,e=this._scanUnicodeCodePointEscape()):null!==(e=this._scanHexEscape("u"))&&"\\"!==e&&s.Character.isIdentifierPart(e.charCodeAt(0))||this.throwUnexpectedToken(),i+=e);return i},e.prototype._octalToDecimal=function(e){var t="0"!==e,i=a(e);return!this.eof()&&s.Character.isOctalDigit(this.source.charCodeAt(this.index))&&(t=!0,i=8*i+a(this.source[this.index++]),"0123".includes(e)&&!this.eof()&&s.Character.isOctalDigit(this.source.charCodeAt(this.index))&&(i=8*i+a(this.source[this.index++]))),{code:i,octal:t}},e.prototype._scanIdentifier=function(){var e,t=this.index,i=92===this.source.charCodeAt(t)?this._getComplexIdentifier():this._getIdentifier();if((e=1===i.length?n.TokenType.Identifier:this._isKeyword(i)?n.TokenType.Keyword:"null"===i.toLowerCase()?n.TokenType.NullLiteral:"true"===i.toLowerCase()||"false"===i.toLowerCase()?n.TokenType.BooleanLiteral:n.TokenType.Identifier)!==n.TokenType.Identifier&&t+i.length!==this.index){var s=this.index;this.index=t,this._tolerateUnexpectedToken(r.Messages.InvalidEscapedReservedWord),this.index=s}return{type:e,value:i,lineNumber:this.lineNumber,lineStart:this.lineStart,start:t,end:this.index}},e.prototype._scanPunctuator=function(){var e=this.index,t=this.source[this.index];switch(t){case"(":case"{":"{"===t&&this.curlyStack.push("{"),++this.index;break;case".":++this.index;break;case"}":++this.index,this.curlyStack.pop();break;case")":case";":case",":case"[":case"]":case":":case"?":case"~":++this.index;break;default:">>>="===(t=this.source.substr(this.index,4))?this.index+=4:"==="===(t=t.substr(0,3))||"!=="===t||">>>"===t||"<<="===t||">>="===t||"**="===t?this.index+=3:"&&"===(t=t.substr(0,2))||"||"===t||"=="===t||"!="===t||"+="===t||"-="===t||"*="===t||"/="===t||"++"===t||"--"===t||"<<"===t||">>"===t||"&="===t||"|="===t||"^="===t||"%="===t||"<="===t||">="===t||"=>"===t||"**"===t?this.index+=2:(t=this.source[this.index],"<>=!+-*%&|^/".includes(t)&&++this.index)}return this.index===e&&this.throwUnexpectedToken(),{type:n.TokenType.Punctuator,value:t,lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}},e.prototype._scanHexLiteral=function(e){for(var t="";!this.eof()&&s.Character.isHexDigit(this.source.charCodeAt(this.index));)t+=this.source[this.index++];return 0===t.length&&this.throwUnexpectedToken(),s.Character.isIdentifierStart(this.source.charCodeAt(this.index))&&this.throwUnexpectedToken(),{type:n.TokenType.NumericLiteral,value:parseInt("0x"+t,16),lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}},e.prototype._scanBinaryLiteral=function(e){for(var t="";!this.eof();){if("0"!==(i=this.source[this.index])&&"1"!==i)break;t+=this.source[this.index++]}if(0===t.length&&this.throwUnexpectedToken(),!this.eof()){var i=this.source.charCodeAt(this.index);(s.Character.isIdentifierStart(i)||s.Character.isDecimalDigit(i))&&this.throwUnexpectedToken()}return{type:n.TokenType.NumericLiteral,value:parseInt(t,2),lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}},e.prototype._scanOctalLiteral=function(e,t){var i="",r=!1;for(s.Character.isOctalDigit(e.charCodeAt(0))?(r=!0,i="0"+this.source[this.index++]):++this.index;!this.eof()&&s.Character.isOctalDigit(this.source.charCodeAt(this.index));)i+=this.source[this.index++];return r||0!==i.length||this.throwUnexpectedToken(),(s.Character.isIdentifierStart(this.source.charCodeAt(this.index))||s.Character.isDecimalDigit(this.source.charCodeAt(this.index)))&&this.throwUnexpectedToken(),{type:n.TokenType.NumericLiteral,value:parseInt(i,8),octal:r,lineNumber:this.lineNumber,lineStart:this.lineStart,start:t,end:this.index}},e.prototype._scanNumericLiteral=function(){var e=this.index,t=this.source[e];i.assert(s.Character.isDecimalDigit(t.charCodeAt(0))||"."===t,"Numeric literal must start with a decimal digit or a decimal point");var r="";if("."!==t){if(r=this.source[this.index++],t=this.source[this.index],"0"===r){if("x"===t||"X"===t)return++this.index,this._scanHexLiteral(e);if("b"===t||"B"===t)return++this.index,this._scanBinaryLiteral(e);if("o"===t||"O"===t)return this._scanOctalLiteral(t,e)}for(;s.Character.isDecimalDigit(this.source.charCodeAt(this.index));)r+=this.source[this.index++];t=this.source[this.index]}if("."===t){for(r+=this.source[this.index++];s.Character.isDecimalDigit(this.source.charCodeAt(this.index));)r+=this.source[this.index++];t=this.source[this.index]}if("e"===t||"E"===t)if(r+=this.source[this.index++],"+"!==(t=this.source[this.index])&&"-"!==t||(r+=this.source[this.index++]),s.Character.isDecimalDigit(this.source.charCodeAt(this.index)))for(;s.Character.isDecimalDigit(this.source.charCodeAt(this.index));)r+=this.source[this.index++];else this.throwUnexpectedToken();return s.Character.isIdentifierStart(this.source.charCodeAt(this.index))&&this.throwUnexpectedToken(),{type:n.TokenType.NumericLiteral,value:parseFloat(r),lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}},e.prototype._scanStringLiteral=function(){var e=this.index,t=this.source[e];i.assert("'"===t||'"'===t,"String literal must starts with a quote"),++this.index;for(var h=!1,a="";!this.eof();){var o=this.source[this.index++];if(o===t){t="";break}if("\\"===o)if((o=this.source[this.index++])&&s.Character.isLineTerminator(o.charCodeAt(0)))++this.lineNumber,"\r"===o&&"\n"===this.source[this.index]&&++this.index,this.lineStart=this.index;else switch(o){case"u":if("{"===this.source[this.index])++this.index,a+=this._scanUnicodeCodePointEscape();else{var c=this._scanHexEscape(o);null===c&&this.throwUnexpectedToken(),a+=c}break;case"x":var d=this._scanHexEscape(o);null===d&&this.throwUnexpectedToken(r.Messages.InvalidHexEscapeSequence),a+=d;break;case"n":a+="\n";break;case"r":a+="\r";break;case"t":a+="\t";break;case"b":a+="\b";break;case"f":a+="\f";break;case"v":a+="\v";break;case"8":case"9":a+=o,this._tolerateUnexpectedToken();break;default:if(o&&s.Character.isOctalDigit(o.charCodeAt(0))){var u=this._octalToDecimal(o);h=u.octal||h,a+=String.fromCharCode(u.code)}else a+=o}else{if(s.Character.isLineTerminator(o.charCodeAt(0)))break;a+=o}}return""!==t&&(this.index=e,this.throwUnexpectedToken()),{type:n.TokenType.StringLiteral,value:a,octal:h,lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}},e.prototype._scanTemplate=function(){var e="",t=!1,i=this.index,h="`"===this.source[i],a=!1,o=2;for(++this.index;!this.eof();){var c=this.source[this.index++];if("`"===c){o=1,a=!0,t=!0;break}if("$"===c){if("{"===this.source[this.index]){this.curlyStack.push("${"),++this.index,t=!0;break}e+=c}else if("\\"===c)if(c=this.source[this.index++],s.Character.isLineTerminator(c.charCodeAt(0)))++this.lineNumber,"\r"===c&&"\n"===this.source[this.index]&&++this.index,this.lineStart=this.index;else switch(c){case"n":e+="\n";break;case"r":e+="\r";break;case"t":e+="\t";break;case"u":if("{"===this.source[this.index])++this.index,e+=this._scanUnicodeCodePointEscape();else{var d=this.index,u=this._scanHexEscape(c);null!==u?e+=u:(this.index=d,e+=c)}break;case"x":var l=this._scanHexEscape(c);null===l&&this.throwUnexpectedToken(r.Messages.InvalidHexEscapeSequence),e+=l;break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:"0"===c?(s.Character.isDecimalDigit(this.source.charCodeAt(this.index))&&this.throwUnexpectedToken(r.Messages.TemplateOctalLiteral),e+="\0"):s.Character.isOctalDigit(c.charCodeAt(0))?this.throwUnexpectedToken(r.Messages.TemplateOctalLiteral):e+=c}else s.Character.isLineTerminator(c.charCodeAt(0))?(++this.lineNumber,"\r"===c&&"\n"===this.source[this.index]&&++this.index,this.lineStart=this.index,e+="\n"):e+=c}return t||this.throwUnexpectedToken(),h||this.curlyStack.pop(),{type:n.TokenType.Template,value:this.source.slice(i+1,this.index-o),cooked:e,head:h,tail:a,lineNumber:this.lineNumber,lineStart:this.lineStart,start:i,end:this.index}},e.prototype._testRegExp=function(e,t){var i=this,s=e;t.includes("u")&&(s=s.replace(/\\u\{([0-9a-fA-F]+)\}|\\u([a-fA-F0-9]{4})/g,(function(e,t,s){var n=parseInt(t||s,16);return n>1114111&&i.throwUnexpectedToken(r.Messages.InvalidRegExp),n<=65535?String.fromCharCode(n):"￿"})).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"￿"));try{RegExp(s)}catch(e){this.throwUnexpectedToken(r.Messages.InvalidRegExp)}try{return new RegExp(e,t)}catch(e){return null}},e.prototype._scanRegExpBody=function(){var e=this.source[this.index];i.assert("/"===e,"Regular expression literal must start with a slash");for(var t=this.source[this.index++],n=!1,h=!1;!this.eof();)if(t+=e=this.source[this.index++],"\\"===e)e=this.source[this.index++],s.Character.isLineTerminator(e.charCodeAt(0))&&this.throwUnexpectedToken(r.Messages.UnterminatedRegExp),t+=e;else if(s.Character.isLineTerminator(e.charCodeAt(0)))this.throwUnexpectedToken(r.Messages.UnterminatedRegExp);else if(n)"]"===e&&(n=!1);else{if("/"===e){h=!0;break}"["===e&&(n=!0)}return h||this.throwUnexpectedToken(r.Messages.UnterminatedRegExp),t.substr(1,t.length-2)},e.prototype._scanRegExpFlags=function(){for(var e="";!this.eof();){var t=this.source[this.index];if(!s.Character.isIdentifierPart(t.charCodeAt(0)))break;if(++this.index,"\\"!==t||this.eof())e+=t,t;else if("u"===(t=this.source[this.index])){++this.index;var i=this.index,r=this._scanHexEscape("u");if(null!==r)for(e+=r,"\\u";i<this.index;++i)this.source[i];else this.index=i,e+="u","\\u";this._tolerateUnexpectedToken()}else"\\",this._tolerateUnexpectedToken()}return e},e.prototype.scanRegExp=function(){var e=this.index,t=this._scanRegExpBody(),i=this._scanRegExpFlags(),s=this._testRegExp(t,i);return{type:n.TokenType.RegularExpression,value:"",pattern:t,flags:i,regex:s,lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}},e.prototype.lex=function(){if(this.eof())return{type:n.TokenType.EOF,value:"",lineNumber:this.lineNumber,lineStart:this.lineStart,start:this.index,end:this.index};var e=this.source.charCodeAt(this.index);return s.Character.isIdentifierStart(e)?this._scanIdentifier():40===e||41===e||59===e?this._scanPunctuator():39===e||34===e?this._scanStringLiteral():46===e?s.Character.isDecimalDigit(this.source.charCodeAt(this.index+1))?this._scanNumericLiteral():this._scanPunctuator():s.Character.isDecimalDigit(e)?this._scanNumericLiteral():96===e||125===e&&"${"===this.curlyStack[this.curlyStack.length-1]?this._scanTemplate():e>=55296&&e<57343&&s.Character.isIdentifierStart(this._codePointAt(this.index))?this._scanIdentifier():this._scanPunctuator()},e}();t.Scanner=o}));