// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../polyfill/tsSupport/assign","../polyfill/tsSupport/spreadarray","../polyfill/tsSupport/extends","./comment-handler","./error-handler","./scanner","./types"],(function(t,e,r,i,n,a,s,o,h){"use strict";var p,c;function u(t,e){void 0===e&&(e=0);var r=t.start-t.lineStart,i=t.lineNumber;return r<0&&(r+=e,i--),{index:t.start,line:i,column:r}}function l(t){return[r({index:t.range[0]},t.loc.start),r({index:t.range[1]},t.loc.end)]}function m(t){var e;return null!==(e=h.OperatorPrecedence[t])&&void 0!==e?e:0}Object.defineProperty(e,"__esModule",{value:!0}),e.Parser=e.binaryOperatorPrecedence=void 0,function(t){t[t.None=0]="None",t[t.Function=1]="Function",t[t.IfClause=2]="IfClause",t[t.ForLoop=4]="ForLoop",t[t.WhileLoop=8]="WhileLoop"}(p||(p={})),function(t){t[t.AsObject=0]="AsObject",t[t.Automatic=1]="Automatic"}(c||(c={})),e.binaryOperatorPrecedence=m;var d=function(){function t(t,e,r){void 0===e&&(e={}),this.delegate=r,this.hasLineTerminator=!1,this.options={tokens:"boolean"==typeof e.tokens&&e.tokens,comments:"boolean"==typeof e.comments&&e.comments,tolerant:"boolean"==typeof e.tolerant&&e.tolerant},this.options.comments&&(this.commentHandler=new a.CommentHandler),this.errorHandler=new s.ErrorHandler(this.options.tolerant),this.scanner=new o.Scanner(t,this.errorHandler),this.context={isAssignmentTarget:!1,blockContext:p.None,curlyParsingType:c.AsObject},this.rawToken={type:2,value:"",lineNumber:this.scanner.lineNumber,lineStart:0,start:0,end:0},this.tokens=[],this.startMarker={index:0,line:this.scanner.lineNumber,column:0},this.endMarker={index:0,line:this.scanner.lineNumber,column:0},this.readNextRawToken(),this.endMarker={index:this.scanner.index,line:this.scanner.lineNumber,column:this.scanner.index-this.scanner.lineStart}}return t.prototype.throwIfInvalidType=function(t,e,r){var i=r.validTypes,n=r.invalidTypes;null!=i&&i.some((function(e){return t.type===e}))||(null==n?void 0:n.some((function(e){return t.type===e})))&&this.throwError(h.ParsingErrorCodes.InvalidExpression,e)},t.prototype.throwError=function(t,e,r){void 0===r&&(r=this.endMarker);var i=e.index,n=e.line,a=e.column,s=r.index-i-1;this.errorHandler.throwError({code:t,index:i,line:n,column:a+1,len:s})},t.prototype.tolerateError=function(t,e){throw new Error("######################################### !!!")},t.prototype.unexpectedTokenError=function(t){void 0===t&&(t={});var e,r=t.rawToken,i=t.code,n=t.data;if(r){if(!i)switch(r.type){case 2:i=h.ParsingErrorCodes.UnexpectedEndOfScript;break;case 3:i=h.ParsingErrorCodes.UnexpectedIdentifier;break;case 6:i=h.ParsingErrorCodes.UnexpectedNumber;break;case 8:i=h.ParsingErrorCodes.UnexpectedString;break;case 10:i=h.ParsingErrorCodes.UnexpectedTemplate}e=r.value.toString()}else e="ILLEGAL";i=null!=i?i:h.ParsingErrorCodes.UnexpectedToken,n||(n={value:e});var a=s.formatErrorDescription(i,n);if(r){var o=r.start,p=r.lineNumber,c=r.start-r.lineStart+1;return new h.ParsingError({code:i,index:o,line:p,column:c,len:r.end-r.start-1,data:n,description:a})}var u=this.endMarker,l=u.index,m=u.line;return new h.ParsingError({code:i,index:l,line:m,column:this.endMarker.column+1,data:n,description:a})},t.prototype.throwUnexpectedToken=function(t){var e;throw void 0===t&&(t={}),t.rawToken=null!==(e=t.rawToken)&&void 0!==e?e:this.rawToken,this.unexpectedTokenError(t)},t.prototype.collectComments=function(t){var e=this,r=this.commentHandler;r&&t.length&&t.forEach((function(t){var i={type:t.multiLine?"BlockComment":"LineComment",value:e.getSourceValue(t),range:t.range,loc:t.loc};r.collectComment(i)}))},t.prototype.peekAhead=function(t){var e=this,r=this.scanner.saveState(),i=t.call(this,(function(){return e.scanner.scanComments(),e.scanner.lex()}));return this.scanner.restoreState(r),i},t.prototype.getSourceValue=function(t){return this.scanner.source.slice(t.start,t.end)},t.prototype.convertToToken=function(t){return{type:h.TokenNames[t.type],value:this.getSourceValue(t),range:[t.start,t.end],loc:{start:{line:this.startMarker.line,column:this.startMarker.column},end:{line:this.scanner.lineNumber,column:this.scanner.index-this.scanner.lineStart}}}},t.prototype.readNextRawToken=function(){this.endMarker.index=this.scanner.index,this.endMarker.line=this.scanner.lineNumber,this.endMarker.column=this.scanner.index-this.scanner.lineStart;var t=this.rawToken;this.collectComments(this.scanner.scanComments()),this.scanner.index!==this.startMarker.index&&(this.startMarker.index=this.scanner.index,this.startMarker.line=this.scanner.lineNumber,this.startMarker.column=this.scanner.index-this.scanner.lineStart),this.rawToken=this.scanner.lex(),this.hasLineTerminator=t.lineNumber!==this.rawToken.lineNumber,this.options.tokens&&2!==this.rawToken.type&&this.tokens.push(this.convertToToken(this.rawToken))},t.prototype.captureStartMarker=function(){return{index:this.startMarker.index,line:this.startMarker.line,column:this.startMarker.column}},t.prototype.getItemLocation=function(t){return{range:[t.index,this.endMarker.index],loc:{start:{line:t.line,column:t.column},end:{line:this.endMarker.line,column:this.endMarker.column}}}},t.prototype.finalize=function(t){var e,r;return(this.delegate||this.commentHandler)&&(null===(e=this.commentHandler)||void 0===e||e.attachComments(t),null===(r=this.delegate)||void 0===r||r.call(this,t)),t},t.prototype.expectPunctuator=function(t){var e=this.rawToken;this.matchPunctuator(t)?this.readNextRawToken():this.throwUnexpectedToken({rawToken:e,code:h.ParsingErrorCodes.PunctuatorExpected,data:{value:t}})},t.prototype.expectKeyword=function(t){4!==this.rawToken.type||this.rawToken.value.toLowerCase()!==t?this.throwUnexpectedToken({rawToken:this.rawToken}):this.readNextRawToken()},t.prototype.expectContextualKeyword=function(t){3!==this.rawToken.type||this.rawToken.value.toLowerCase()!==t?this.throwUnexpectedToken({rawToken:this.rawToken}):this.readNextRawToken()},t.prototype.matchKeyword=function(t){return 4===this.rawToken.type&&this.rawToken.value.toLowerCase()===t},t.prototype.matchContextualKeyword=function(t){return 3===this.rawToken.type&&this.rawToken.value===t},t.prototype.matchPunctuator=function(t){return 7===this.rawToken.type&&this.rawToken.value===t},t.prototype.getMatchingPunctuator=function(t){if("string"==typeof t&&(t=t.split("")),7===this.rawToken.type&&(null==t?void 0:t.length))return t.find(this.matchPunctuator,this)},t.prototype.isolateCoverGrammar=function(t){var e=this.context.isAssignmentTarget;this.context.isAssignmentTarget=!0;var r=t.call(this);return this.context.isAssignmentTarget=e,r},t.prototype.inheritCoverGrammar=function(t){var e=this.context.isAssignmentTarget;this.context.isAssignmentTarget=!0;var r=t.call(this);return this.context.isAssignmentTarget=this.context.isAssignmentTarget&&e,r},t.prototype.withBlockContext=function(t,e){var r=this.context.blockContext;this.context.blockContext=this.context.blockContext|t;var i=this.context.curlyParsingType;this.context.curlyParsingType=c.Automatic;var n=e.call(this);return this.context.blockContext=r,this.context.curlyParsingType=i,n},t.prototype.consumeSemicolon=function(){if(this.matchPunctuator(";"))this.readNextRawToken();else if(!this.hasLineTerminator)return 2===this.rawToken.type||this.matchPunctuator("}")?(this.endMarker.index=this.startMarker.index,this.endMarker.line=this.startMarker.line,void(this.endMarker.column=this.startMarker.column)):void this.throwUnexpectedToken({rawToken:this.rawToken})},t.prototype.parsePrimaryExpression=function(){var t=this.captureStartMarker(),e=this.rawToken;switch(e.type){case 3:return this.readNextRawToken(),this.finalize(r({type:"Identifier",name:e.value},this.getItemLocation(t)));case 6:case 8:return this.context.isAssignmentTarget=!1,this.readNextRawToken(),this.finalize(r({type:"Literal",value:e.value,raw:this.getSourceValue(e),isString:"string"==typeof e.value},this.getItemLocation(t)));case 1:return this.context.isAssignmentTarget=!1,this.readNextRawToken(),this.finalize(r({type:"Literal",value:e.value.toLowerCase()===h.Keywords.True,raw:this.getSourceValue(e),isString:!1},this.getItemLocation(t)));case 5:return this.context.isAssignmentTarget=!1,this.readNextRawToken(),this.finalize(r({type:"Literal",value:null,raw:this.getSourceValue(e),isString:!1},this.getItemLocation(t)));case 10:return this.parseTemplateLiteral();case 7:switch(e.value){case"(":return this.inheritCoverGrammar(this.parseGroupExpression);case"[":return this.inheritCoverGrammar(this.parseArrayInitializer);case"{":return this.inheritCoverGrammar(this.parseObjectExpression);default:return this.throwUnexpectedToken({rawToken:this.rawToken})}case 4:return this.context.isAssignmentTarget=!1,this.throwUnexpectedToken({rawToken:this.rawToken});default:return this.throwUnexpectedToken({rawToken:this.rawToken})}},t.prototype.parseArrayInitializer=function(){var t=this.captureStartMarker();this.expectPunctuator("[");for(var e=[];!this.matchPunctuator("]");){var i=this.captureStartMarker();this.matchPunctuator(",")?(this.readNextRawToken(),this.throwError(h.ParsingErrorCodes.InvalidExpression,i)):(e.push(this.inheritCoverGrammar(this.parseAssignmentExpression)),this.matchPunctuator("]")||this.expectPunctuator(","))}return this.expectPunctuator("]"),this.finalize(r({type:"ArrayExpression",elements:e},this.getItemLocation(t)))},t.prototype.parseObjectPropertyKey=function(){var t=this.captureStartMarker(),e=this.rawToken;switch(e.type){case 8:return this.readNextRawToken(),this.finalize(r({type:"Literal",value:e.value,raw:this.getSourceValue(e),isString:!0},this.getItemLocation(t)));case 3:case 1:case 5:case 4:return this.readNextRawToken(),this.finalize(r({type:"Identifier",name:e.value},this.getItemLocation(t)));default:this.throwError(h.ParsingErrorCodes.KeyMustBeString,t)}},t.prototype.parseObjectProperty=function(){var t=this.rawToken,e=this.captureStartMarker(),i=this.parseObjectPropertyKey(),n=!1,a=null;return this.matchPunctuator(":")?(this.readNextRawToken(),a=this.inheritCoverGrammar(this.parseAssignmentExpression)):3===t.type?(n=!0,a=this.finalize(r({type:"Identifier",name:t.value},this.getItemLocation(e)))):this.throwUnexpectedToken({rawToken:this.rawToken}),this.finalize(r({type:"Property",kind:"init",key:i,value:a,shorthand:n},this.getItemLocation(e)))},t.prototype.parseObjectExpression=function(){var t=this.captureStartMarker();this.expectPunctuator("{");for(var e=[];!this.matchPunctuator("}");)e.push(this.parseObjectProperty()),this.matchPunctuator("}")||this.expectPunctuator(",");return this.expectPunctuator("}"),this.finalize(r({type:"ObjectExpression",properties:e},this.getItemLocation(t)))},t.prototype.parseTemplateElement=function(t){void 0===t&&(t=!1);var e=this.rawToken;10!==e.type&&this.throwUnexpectedToken({rawToken:e}),t&&!e.head&&this.throwUnexpectedToken({code:h.ParsingErrorCodes.InvalidTemplateHead,rawToken:e});var i=this.captureStartMarker();this.readNextRawToken();var n=e.value,a=e.cooked,s=e.tail,o=this.finalize(r({type:"TemplateElement",value:{raw:n,cooked:a},tail:s},this.getItemLocation(i)));return o.loc.start.column++,o.loc.end.column=o.loc.end.column-(s?1:2),o},t.prototype.parseTemplateLiteral=function(){var t=this.captureStartMarker(),e=[],i=[],n=this.parseTemplateElement(!0);for(i.push(n);!n.tail;)e.push(this.parseExpression()),n=this.parseTemplateElement(),i.push(n);return this.finalize(r({type:"TemplateLiteral",quasis:i,expressions:e},this.getItemLocation(t)))},t.prototype.parseGroupExpression=function(){this.expectPunctuator("(");var t=this.inheritCoverGrammar(this.parseAssignmentExpression);return this.expectPunctuator(")"),t},t.prototype.parseArguments=function(){this.expectPunctuator("(");var t=[];if(!this.matchPunctuator(")"))for(;;){var e=this.isolateCoverGrammar(this.parseAssignmentExpression);if(t.push(e),this.matchPunctuator(")"))break;if(this.expectPunctuator(","),this.matchPunctuator(")"))break}return this.expectPunctuator(")"),t},t.prototype.parseMemberName=function(){var t=this.rawToken,e=this.captureStartMarker();return this.readNextRawToken(),5!==t.type&&3!==t.type&&4!==t.type&&1!==t.type&&this.throwUnexpectedToken({rawToken:t}),this.finalize(r({type:"Identifier",name:t.value},this.getItemLocation(e)))},t.prototype.parseLeftHandSideExpression=function(){for(var t,e=this.captureStartMarker(),i=this.inheritCoverGrammar(this.parsePrimaryExpression),n=this.captureStartMarker();t=this.getMatchingPunctuator("([.");)switch(t){case"(":this.context.isAssignmentTarget=!1,"Identifier"!==i.type&&"MemberExpression"!==i.type&&this.throwError(h.ParsingErrorCodes.IdentiferExpected,e,n);var a=this.parseArguments();i=this.finalize(r({type:"CallExpression",callee:i,arguments:a},this.getItemLocation(e)));continue;case"[":this.context.isAssignmentTarget=!0,this.expectPunctuator("[");var s=this.isolateCoverGrammar(this.parseExpression);this.expectPunctuator("]"),i=this.finalize(r({type:"MemberExpression",computed:!0,object:i,property:s},this.getItemLocation(e)));continue;case".":this.context.isAssignmentTarget=!0,this.expectPunctuator(".");s=this.parseMemberName();i=this.finalize(r({type:"MemberExpression",computed:!1,object:i,property:s},this.getItemLocation(e)));continue}return i},t.prototype.parseUpdateExpression=function(){var t=this.captureStartMarker(),e=this.getMatchingPunctuator(h.UpdateOperators);if(e){this.readNextRawToken();var i=this.captureStartMarker(),n=this.inheritCoverGrammar(this.parseUnaryExpression);return"Identifier"!==n.type&&"MemberExpression"!==n.type&&"CallExpression"!==n.type&&this.throwError(h.ParsingErrorCodes.InvalidExpression,i),this.context.isAssignmentTarget||this.tolerateError(h.ParsingErrorCodes.InvalidLeftHandSideInAssignment,t),this.context.isAssignmentTarget=!1,this.finalize(r({type:"UpdateExpression",operator:e,argument:n,prefix:!0},this.getItemLocation(t)))}var a=this.captureStartMarker(),s=this.inheritCoverGrammar(this.parseLeftHandSideExpression),o=this.captureStartMarker();return this.hasLineTerminator?s:(e=this.getMatchingPunctuator(h.UpdateOperators))?("Identifier"!==s.type&&"MemberExpression"!==s.type&&this.throwError(h.ParsingErrorCodes.InvalidExpression,a,o),this.context.isAssignmentTarget||this.tolerateError(h.ParsingErrorCodes.InvalidLeftHandSideInAssignment,t),this.readNextRawToken(),this.context.isAssignmentTarget=!1,this.finalize(r({type:"UpdateExpression",operator:e,argument:s,prefix:!1},this.getItemLocation(t)))):s},t.prototype.parseUnaryExpression=function(){var t=this.getMatchingPunctuator(h.UnaryOperators);if(t){var e=this.captureStartMarker();this.readNextRawToken();var i=this.inheritCoverGrammar(this.parseUnaryExpression);return this.context.isAssignmentTarget=!1,this.finalize(r({type:"UnaryExpression",operator:t,argument:i,prefix:!0},this.getItemLocation(e)))}return this.parseUpdateExpression()},t.prototype.parseBinaryExpression=function(){var t=this.rawToken,e=this.inheritCoverGrammar(this.parseUnaryExpression);if(7!==this.rawToken.type)return e;var r=this.rawToken.value,i=m(r);if(0===i)return e;this.readNextRawToken(),this.context.isAssignmentTarget=!1;for(var n=[t,this.rawToken],a=e,s=this.inheritCoverGrammar(this.parseUnaryExpression),o=[a,r,s],h=[i];7===this.rawToken.type&&(i=m(this.rawToken.value))>0;){for(;o.length>2&&i<=h[h.length-1];){s=o.pop();var p=o.pop();h.pop(),a=o.pop(),n.pop();var c=n[n.length-1],l=u(c,c.lineStart);o.push(this.finalize(this.createBinaryOrLogicalExpression(l,p,a,s)))}o.push(this.rawToken.value),h.push(i),n.push(this.rawToken),this.readNextRawToken(),o.push(this.inheritCoverGrammar(this.parseUnaryExpression))}var d=o.length-1;e=o[d];for(var x=n.pop();d>1;){var y=n.pop();if(!y)break;l=u(y,null==x?void 0:x.lineStart);var k=o[d-1];e=this.finalize(this.createBinaryOrLogicalExpression(l,k,o[d-2],e)),d-=2,x=y}return e},t.prototype.createBinaryOrLogicalExpression=function(t,e,n,a){var s=h.LogicalOperators.includes(e)?"LogicalExpression":"BinaryExpression";return"BinaryExpression"===s?r({type:s,operator:e,left:n,right:a},this.getItemLocation(t)):("AssignmentExpression"!==n.type&&"UpdateExpression"!==n.type||this.throwError.apply(this,i([h.ParsingErrorCodes.InvalidExpression],l(n))),"AssignmentExpression"!==a.type&&"UpdateExpression"!==a.type||this.throwError.apply(this,i([h.ParsingErrorCodes.InvalidExpression],l(n))),r({type:s,operator:e,left:n,right:a},this.getItemLocation(t)))},t.prototype.parseAssignmentExpression=function(){var t=this.captureStartMarker(),e=this.inheritCoverGrammar(this.parseBinaryExpression),i=this.captureStartMarker(),n=this.getMatchingPunctuator(h.AssignmentOperators);if(!n)return e;"Identifier"!==e.type&&"MemberExpression"!==e.type&&this.throwError(h.ParsingErrorCodes.InvalidExpression,t,i),this.context.isAssignmentTarget||this.tolerateError(h.ParsingErrorCodes.InvalidLeftHandSideInAssignment,t),this.matchPunctuator("=")||(this.context.isAssignmentTarget=!1),this.readNextRawToken();var a=this.isolateCoverGrammar(this.parseAssignmentExpression);return this.finalize(r({type:"AssignmentExpression",left:e,operator:n,right:a},this.getItemLocation(t)))},t.prototype.parseExpression=function(){return this.isolateCoverGrammar(this.parseAssignmentExpression)},t.prototype.parseStatements=function(t){for(var e=[];2!==this.rawToken.type&&!this.matchPunctuator(t);){var r=this.parseStatementListItem();h.isEmptyStatement(r)||e.push(r)}return e},t.prototype.parseStatementListItem=function(){return this.context.isAssignmentTarget=!0,this.matchKeyword(h.Keywords.Function)?this.parseFunctionDeclaration():this.matchKeyword(h.Keywords.Export)?this.parseExportDeclaration():this.matchKeyword(h.Keywords.Import)?this.parseImportDeclaration():this.parseStatement()},t.prototype.parseBlock=function(){var t=this.captureStartMarker();this.expectPunctuator("{");var e=this.parseStatements("}");return this.expectPunctuator("}"),this.finalize(r({type:"BlockStatement",body:e},this.getItemLocation(t)))},t.prototype.parseObjectStatement=function(){var t=this.captureStartMarker(),e=this.parseObjectExpression();return this.finalize(r({type:"ExpressionStatement",expression:e},this.getItemLocation(t)))},t.prototype.parseBlockOrObjectStatement=function(){return this.context.curlyParsingType===c.AsObject?this.parseObjectStatement():this.peekAhead((function(t){var e=t();return(3===e.type||8===e.type)&&(7===(e=t()).type&&":"===e.value)}))?this.parseObjectStatement():this.parseBlock()},t.prototype.parseIdentifier=function(){var t=this.rawToken;if(3!==t.type)return null;var e=this.captureStartMarker();return this.readNextRawToken(),this.finalize(r({type:"Identifier",name:t.value},this.getItemLocation(e)))},t.prototype.parseVariableDeclarator=function(){var t=this.captureStartMarker(),e=this.parseIdentifier();e||this.throwUnexpectedToken({code:h.ParsingErrorCodes.IdentiferExpected});var i=null;if(this.matchPunctuator("=")){this.readNextRawToken();var n=this.rawToken;try{i=this.isolateCoverGrammar(this.parseAssignmentExpression)}catch(t){this.throwUnexpectedToken({rawToken:n,code:h.ParsingErrorCodes.InvalidVariableAssignment})}}return this.finalize(r({type:"VariableDeclarator",id:e,init:i},this.getItemLocation(t)))},t.prototype.parseVariableDeclarationList=function(){for(var t=[this.parseVariableDeclarator()];this.matchPunctuator(",");)this.readNextRawToken(),t.push(this.parseVariableDeclarator());return t},t.prototype.parseVariableDeclaration=function(){var t=this.captureStartMarker();this.expectKeyword(h.Keywords.Var);var e=this.parseVariableDeclarationList();return this.consumeSemicolon(),this.finalize(r({type:"VariableDeclaration",declarations:e,kind:"var"},this.getItemLocation(t)))},t.prototype.parseEmptyStatement=function(){var t=this.captureStartMarker();return this.expectPunctuator(";"),this.finalize(r({type:"EmptyStatement"},this.getItemLocation(t)))},t.prototype.parseExpressionStatement=function(){var t=this.captureStartMarker(),e=this.parseExpression();return this.consumeSemicolon(),this.finalize(r({type:"ExpressionStatement",expression:e},this.getItemLocation(t)))},t.prototype.parseIfClause=function(){return this.withBlockContext(p.IfClause,this.parseStatement)},t.prototype.parseIfStatement=function(){var t=this.captureStartMarker();this.expectKeyword(h.Keywords.If),this.expectPunctuator("(");var e=this.captureStartMarker(),i=this.parseExpression(),n=this.captureStartMarker();this.expectPunctuator(")"),"AssignmentExpression"!==i.type&&"UpdateExpression"!==i.type||this.throwError(h.ParsingErrorCodes.InvalidExpression,e,n);var a=this.parseIfClause(),s=null;return this.matchKeyword(h.Keywords.Else)&&(this.readNextRawToken(),s=this.parseIfClause()),this.finalize(r({type:"IfStatement",test:i,consequent:a,alternate:s},this.getItemLocation(t)))},t.prototype.parseWhileStatement=function(){var t=this.captureStartMarker();this.expectKeyword(h.Keywords.While),this.expectPunctuator("(");var e=this.captureStartMarker(),i=this.parseExpression(),n=this.captureStartMarker();this.expectPunctuator(")"),"AssignmentExpression"!==i.type&&"UpdateExpression"!==i.type||this.throwError(h.ParsingErrorCodes.InvalidExpression,e,n);var a=this.withBlockContext(p.WhileLoop,this.parseStatement);return this.finalize(r({type:"WhileStatement",test:i,body:a},this.getItemLocation(t)))},t.prototype.parseForStatement=function(){var t=this,e=null,i=null,n=null,a=null,s=null,o=this.captureStartMarker();if(this.expectKeyword(h.Keywords.For),this.expectPunctuator("("),this.matchPunctuator(";"))this.readNextRawToken();else if(this.matchKeyword(h.Keywords.Var)){var c=this.captureStartMarker();this.readNextRawToken();var u=this.parseVariableDeclarationList();if(1===u.length&&this.matchKeyword(h.Keywords.In))u[0].init&&this.throwError(h.ParsingErrorCodes.ForInOfLoopInitializer,c),a=this.finalize(r({type:"VariableDeclaration",declarations:u,kind:"var"},this.getItemLocation(c))),this.readNextRawToken(),s=this.parseExpression();else this.matchKeyword(h.Keywords.In)&&this.throwError(h.ParsingErrorCodes.InvalidLeftHandSideInForIn,c),e=this.finalize(r({type:"VariableDeclaration",declarations:u,kind:"var"},this.getItemLocation(c))),this.expectPunctuator(";")}else{var l=this.context.isAssignmentTarget;c=this.captureStartMarker();e=this.inheritCoverGrammar(this.parseAssignmentExpression),this.matchKeyword(h.Keywords.In)?(this.context.isAssignmentTarget||this.tolerateError(h.ParsingErrorCodes.InvalidLeftHandSideInForIn,c),"Identifier"!==e.type&&this.throwError(h.ParsingErrorCodes.InvalidLeftHandSideInForIn,c),this.readNextRawToken(),a=e,s=this.parseExpression(),e=null):(this.context.isAssignmentTarget=l,this.expectPunctuator(";"))}a||(this.matchPunctuator(";")||(i=this.isolateCoverGrammar(this.parseExpression)),this.expectPunctuator(";"),this.matchPunctuator(")")||(n=this.isolateCoverGrammar(this.parseExpression))),this.expectPunctuator(")");var m=this.withBlockContext(p.ForLoop,(function(){return t.isolateCoverGrammar(t.parseStatement)}));return a&&s?this.finalize(r({type:"ForInStatement",left:a,right:s,body:m},this.getItemLocation(o))):this.finalize(r({type:"ForStatement",init:e,test:i,update:n,body:m},this.getItemLocation(o)))},t.prototype.parseContinueStatement=function(){var t=this.captureStartMarker();return this.expectKeyword(h.Keywords.Continue),this.consumeSemicolon(),this.finalize(r({type:"ContinueStatement"},this.getItemLocation(t)))},t.prototype.parseBreakStatement=function(){var t=this.captureStartMarker();return this.expectKeyword(h.Keywords.Break),this.consumeSemicolon(),this.finalize(r({type:"BreakStatement"},this.getItemLocation(t)))},t.prototype.parseReturnStatement=function(){var t=this.captureStartMarker();this.expectKeyword(h.Keywords.Return);var e=!this.matchPunctuator(";")&&!this.matchPunctuator("}")&&!this.hasLineTerminator&&2!==this.rawToken.type||8===this.rawToken.type||10===this.rawToken.type?this.parseExpression():null;return this.consumeSemicolon(),this.finalize(r({type:"ReturnStatement",argument:e},this.getItemLocation(t)))},t.prototype.parseStatement=function(){switch(this.rawToken.type){case 1:case 5:case 6:case 8:case 10:case 3:return this.parseExpressionStatement();case 7:return"{"===this.rawToken.value?this.parseBlockOrObjectStatement():"("===this.rawToken.value?this.parseExpressionStatement():";"===this.rawToken.value?this.parseEmptyStatement():this.parseExpressionStatement();case 4:switch(this.rawToken.value.toLowerCase()){case h.Keywords.Break:return this.parseBreakStatement();case h.Keywords.Continue:return this.parseContinueStatement();case h.Keywords.For:return this.parseForStatement();case h.Keywords.Function:return this.parseFunctionDeclaration();case h.Keywords.If:return this.parseIfStatement();case h.Keywords.Return:return this.parseReturnStatement();case h.Keywords.Var:return this.parseVariableDeclaration();case h.Keywords.While:return this.parseWhileStatement();default:return this.parseExpressionStatement()}default:return this.throwUnexpectedToken({rawToken:this.rawToken})}},t.prototype.parseFormalParameters=function(){var t=[];if(this.expectPunctuator("("),!this.matchPunctuator(")"))for(;2!==this.rawToken.type;){var e=this.parseIdentifier();if(e||this.throwUnexpectedToken({rawToken:this.rawToken,code:h.ParsingErrorCodes.IdentiferExpected}),t.push(e),this.matchPunctuator(")"))break;if(this.expectPunctuator(","),this.matchPunctuator(")"))break}return this.expectPunctuator(")"),t},t.prototype.parseFunctionDeclaration=function(){(this.context.blockContext&p.Function)===p.Function&&this.throwUnexpectedToken({code:h.ParsingErrorCodes.NoFunctionInsideFunction}),(this.context.blockContext&p.WhileLoop)!==p.WhileLoop&&(this.context.blockContext&p.IfClause)!==p.IfClause||this.throwUnexpectedToken({code:h.ParsingErrorCodes.NoFunctionInsideBlock});var t=this.captureStartMarker();this.expectKeyword(h.Keywords.Function);var e=this.parseIdentifier();e||this.throwUnexpectedToken({code:h.ParsingErrorCodes.InvalidFunctionIdentifier});var i=this.parseFormalParameters(),n=this.context.blockContext;this.context.blockContext=this.context.blockContext|p.Function;var a=this.parseBlock();return this.context.blockContext=n,this.finalize(r({type:"FunctionDeclaration",id:e,params:i,body:a},this.getItemLocation(t)))},t.prototype.parseScript=function(){var t=this.captureStartMarker(),e=this.parseStatements(),i=this.finalize(r({type:"Program",body:e},this.getItemLocation(t)));return this.options.tokens&&(i.tokens=this.tokens),this.options.tolerant&&(i.errors=this.errorHandler.errors),i},t.prototype.parseExportDeclaration=function(){this.context.blockContext!==p.None&&this.throwUnexpectedToken({code:h.ParsingErrorCodes.ModuleExportRootOnly});var t=null,e=this.captureStartMarker();return this.expectKeyword(h.Keywords.Export),this.matchKeyword(h.Keywords.Var)?t=this.parseVariableDeclaration():this.matchKeyword("function")?t=this.parseFunctionDeclaration():this.throwUnexpectedToken({code:h.ParsingErrorCodes.InvalidExpression}),this.finalize(r({type:"ExportNamedDeclaration",declaration:t,specifiers:[],source:null},this.getItemLocation(e)))},t.prototype.parseModuleSpecifier=function(){var t=this.captureStartMarker(),e=this.rawToken;if(8===e.type)return this.readNextRawToken(),this.finalize(r({type:"Literal",value:e.value,raw:this.getSourceValue(e),isString:!0},this.getItemLocation(t)));this.throwError(h.ParsingErrorCodes.InvalidModuleUri,t)},t.prototype.parseDefaultSpecifier=function(){var t=this.captureStartMarker(),e=this.parseIdentifier();return e||this.throwUnexpectedToken({code:h.ParsingErrorCodes.IdentiferExpected}),this.finalize(r({type:"ImportDefaultSpecifier",local:e},this.getItemLocation(t)))},t.prototype.parseImportDeclaration=function(){this.context.blockContext!==p.None&&this.throwUnexpectedToken({code:h.ParsingErrorCodes.ModuleImportRootOnly});var t=this.captureStartMarker();this.expectKeyword(h.Keywords.Import);var e=this.parseDefaultSpecifier();this.expectContextualKeyword(h.Keywords.From);var i=this.parseModuleSpecifier();return this.finalize(r({type:"ImportDeclaration",specifiers:[e],source:i},this.getItemLocation(t)))},t}();e.Parser=d}));