/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../core/promiseUtils"],(function(t){"use strict";return function(){function e(t,e){this._lastId=-1,this._progress=e,this._parent=t}var n=e.prototype;return n.reset=function(){this._lastId=-1},n.nextBatch=function(e){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((t=>this.nextBatch(e)),(t=>this.nextBatch(e)));const n={returnpromise:null,hasset:!1},s=[];return n.returnpromise=t.create(((t,r)=>{this._parent._getSet(this._progress).then((a=>{let h=a._known.length-1;if("GETPAGES"===a._known[a._known.length-1]&&(h-=1),this._lastId+e>h&&a._known.length>0&&"GETPAGES"===a._known[a._known.length-1])this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,0,this._progress).then((s=>{n.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(e).then(t,r)}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}));else{if(h>=this._lastId+e||0===a._candidates.length){for(let t=0;t<e;t++){const e=t+this._lastId+1;if(e>=a._known.length)break;s[t]=a._known[e]}return this._lastId+=s.length,0===s.length&&(n.hasset=!0,this._parent._mainSetInUse=null,t([])),void this._parent._getFeatureBatch(s,this._progress).then((e=>{n.hasset=!0,this._parent._mainSetInUse=null,t(e)}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}))}this._parent._refineSetBlock(a,this._parent._maxProcessingRate(),this._progress).then((()=>{n.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(e).then(t,r)}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}))}}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}))})),!1===n.hasset&&(this._parent._mainSetInUse=n.returnpromise,n.hasset=!0),n.returnpromise},n.next=function(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((t=>this.next()),(t=>this.next()));const e={returnpromise:null,hasset:!1};return e.returnpromise=t.create(((t,n)=>{this._parent._getSet(this._progress).then((s=>{this._lastId<s._known.length-1?"GETPAGES"===s._known[this._lastId+1]?this._parent._expandPagedSet(s,this._parent._maxQueryRate(),0,0,this._progress).then((t=>(e.hasset=!0,this._parent._mainSetInUse=null,this.next()))).then(t,n):(this._lastId+=1,this._parent._getFeature(s,s._known[this._lastId],this._progress).then((n=>{e.hasset=!0,this._parent._mainSetInUse=null,t(n)}),(t=>{e.hasset=!0,this._parent._mainSetInUse=null,n(t)}))):s._candidates.length>0?this._parent._refineSetBlock(s,this._parent._maxProcessingRate(),this._progress).then((()=>{e.hasset=!0,this._parent._mainSetInUse=null,this.next().then(t,n)}),(t=>{e.hasset=!0,this._parent._mainSetInUse=null,n(t)})):(e.hasset=!0,this._parent._mainSetInUse=null,t(null))}),(t=>{e.hasset=!0,this._parent._mainSetInUse=null,n(t)}))})),!1===e.hasset&&(this._parent._mainSetInUse=e.returnpromise,e.hasset=!0),e.returnpromise},n.count=function(){return-1!==this._parent._totalCount?t.resolve(this._parent._totalCount):this._parent._getSet(this._progress).then((t=>this._refineAllSets(t))).then((e=>(this._parent._totalCount=e._known.length,t.resolve(this._parent._totalCount))))},n._refineAllSets=function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,1,this._progress).then((t=>this._refineAllSets(e))).then((e=>t.resolve(e))):e._candidates.length>0?"GETPAGES"===e._known[e._candidates.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,2,this._progress).then((t=>this._refineAllSets(e))).then((e=>t.resolve(e))):this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then((e=>e._candidates.length>0?this._refineAllSets(e):t.resolve(e))):t.resolve(e)},e}()}));
