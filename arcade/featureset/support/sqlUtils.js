/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../ArcadeDate","./shared","../../../core/sql/WhereClause","./errorsupport","../../arcadeTimeUtils","../../../chunks/datetime"],(function(e,r,a,t,s,n,c){"use strict";function o(e,r){return y(e?.parseTree,r,e?.parameters)}function i(e,r,a,s){return u(t.WhereClause.create(e,r.fieldsIndex),a,s)}function u(e,r,t){const s=n.convertTimeReference(r),c=n.convertTimeReference(t);return y(e.parseTree,a.FeatureServiceDatabaseType.Standardised,null,null,null,{inputTimeReference:s,outputTimeReference:c})}function l(e,r,a){return y(e,r,a)}function d(e,r,s,n){return t.WhereClause.create(y(e.parseTree,a.FeatureServiceDatabaseType.Standardised,e.parameters,r,s),n)}function p(e,r,s="AND"){return t.WhereClause.create("(("+o(e,a.FeatureServiceDatabaseType.Standardised)+")"+s+"("+o(r,a.FeatureServiceDatabaseType.Standardised)+"))",e.fieldsIndex)}function y(e,r,t,n=null,c=null,o=null){let i,u,l,d;switch(e.type){case"interval":return I(y(e.value,r,t,n,c,o),e.qualifier,e.op);case"case-expression":{let a=" CASE ";"simple"===e.format&&(a+=y(e.operand,r,t,n,c,o));for(let s=0;s<e.clauses.length;s++)a+=" WHEN "+y(e.clauses[s].operand,r,t,n,c,o)+" THEN "+y(e.clauses[s].value,r,t,n,c,o);return null!==e.else&&(a+=" ELSE "+y(e.else,r,t,n,c,o)),a+=" END ",a}case"parameter":{const s=t[e.value.toLowerCase()];if("string"==typeof s){return"'"+t[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(a.isDate(s))return f(s,r,o);if(a.isArcadeDate(s))return T(s,r,o);if(s instanceof Array){const e=[];for(let t=0;t<s.length;t++)"string"==typeof s[t]?e.push("'"+s[t].toString().replace(/'/g,"''")+"'"):a.isDate(s[t])?e.push(f(s[t],r,o)):a.isArcadeDate(s[t])?e.push(T(s[t],r,o)):e.push(s[t].toString());return e}return s.toString()}case"expression-list":u=[];for(const a of e.value)u.push(y(a,r,t,n,c,o));return u;case"unary-expression":return" ( NOT "+y(e.expr,r,t,n,c,o)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+y(e.left,r,t,n,c,o)+" AND "+y(e.right,r,t,n,c,o)+") ";case"OR":return" ("+y(e.left,r,t,n,c,o)+" OR "+y(e.right,r,t,n,c,o)+") ";case"IS":if("null"!==e.right.type)throw new s.SqlError(s.SqlErrorCodes.UnsupportedIsRhs);return" ("+y(e.left,r,t,n,c,o)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new s.SqlError(s.SqlErrorCodes.UnsupportedIsRhs);return" ("+y(e.left,r,t,n,c,o)+" IS NOT NULL )";case"IN":return i=[],"expression-list"===e.right.type?(i=y(e.right,r,t,n,c)," ("+y(e.left,r,t,n,c,o)+" IN ("+i.join(",")+")) "):(d=y(e.right,r,t,n,c,o),d instanceof Array?" ("+y(e.left,r,t,n,c,o)+" IN ("+d.join(",")+")) ":" ("+y(e.left,r,t,n,c,o)+" IN ("+d+")) ");case"NOT IN":return i=[],"expression-list"===e.right.type?(i=y(e.right,r,t,n,c)," ("+y(e.left,r,t,n,c,o)+" NOT IN ("+i.join(",")+")) "):(d=y(e.right,r,t,n,c,o),d instanceof Array?" ("+y(e.left,r,t,n,c,o)+" NOT IN ("+d.join(",")+")) ":" ("+y(e.left,r,t,n,c,o)+" NOT IN ("+d+")) ");case"BETWEEN":return l=y(e.right,r,t,n,c,o)," ("+y(e.left,r,t,n,c,o)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=y(e.right,r,t,n,c,o)," ("+y(e.left,r,t,n,c,o)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+y(e.left,r,t,n,c,o)+" LIKE "+y(e.right,r,t,n,c,o)+" ESCAPE '"+e.escape+"') ":" ("+y(e.left,r,t,n,c,o)+" LIKE "+y(e.right,r,t,n,c,o)+") ";case"NOT LIKE":return""!==e.escape?" ("+y(e.left,r,t,n,c,o)+" NOT LIKE "+y(e.right,r,t,n,c,o)+" ESCAPE '"+e.escape+"') ":" ("+y(e.left,r,t,n,c,o)+" NOT LIKE "+y(e.right,r,t,n,c,o)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+y(e.left,r,t,n,c,o)+" "+e.operator+" "+y(e.right,r,t,n,c,o)+") ";case"||":return" ("+y(e.left,r,t,n,c,o)+" "+(r===a.FeatureServiceDatabaseType.SqlServer?"+":e.operator)+" "+y(e.right,r,t,n,c,o)+") "}throw new s.SqlError(s.SqlErrorCodes.UnsupportedOperator,{operator:e.operator});case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return f(e.value,r,o);case"number":return e.value.toString();case"current-time":return m("date"===e.mode,r);case"column-reference":return n&&n.toLowerCase()===e.column.toLowerCase()?"("+c+")":e.column;case"data-type":return e.value;case"function":{const a=y(e.args,r,t,n,c,o);return S(e.name,a,r)}}throw new s.SqlError(s.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}function S(e,r,t){switch(e.toLowerCase().trim()){case"cos":case"sin":case"tan":case"cosh":case"tanh":case"sinh":case"acos":case"asin":case"atan":case"floor":case"log10":case"log":case"abs":if(1!==r.length)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:e.toLowerCase().trim()});return`${e.toUpperCase().trim()}(${r[0]})`;case"ceiling":case"ceil":if(1!==r.length)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(t){case a.FeatureServiceDatabaseType.Standardised:case a.FeatureServiceDatabaseType.StandardisedNoInterval:}return"CEILING("+r[0]+")";case"mod":case"power":case"nullif":if(2!==r.length)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:e.toLowerCase().trim()});return`${e.toUpperCase().trim()}(${r[0]},${r[1]})`;case"round":if(2===r.length)return"ROUND("+r[0]+","+r[1]+")";if(1===r.length)return"ROUND("+r[0]+")";throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});case"truncate":if(r.length<1||r.length>2)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});return t===a.FeatureServiceDatabaseType.SqlServer?"ROUND("+r[0]+(1===r.length?"0":","+r[1])+",1)":"TRUNCATE("+r[0]+(1===r.length?")":","+r[1]+")");case"char_length":case"len":if(1!==r.length)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(t){case a.FeatureServiceDatabaseType.SqlServer:return"LEN("+r[0]+")";case a.FeatureServiceDatabaseType.Oracle:return"LENGTH("+r[0]+")";default:return"CHAR_LENGTH("+r[0]+")"}case"coalesce":case"concat":{if(r.length<1)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:e.toLowerCase()});let a=e.toUpperCase().trim()+"(";for(let e=0;e<r.length;e++)0!==e&&(a+=","),a+=r[e];return a+=")",a}case"lower":case"lcase":if(1!==r.length)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+r[0]+")";case"upper":case"ucase":if(1!==r.length)throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"upper"});return"UPPER("+r[0]+")";case"substring":{let e="";switch(t){case a.FeatureServiceDatabaseType.Oracle:return e="SUBSTR("+r[0]+","+r[1],3===r.length&&(e+=","+r[2]),e+=")",e;case a.FeatureServiceDatabaseType.SqlServer:return e=3===r.length?"SUBSTRING("+r[0]+","+r[1]+","+r[2]+")":"SUBSTRING("+r[0]+",  "+r[1]+", LEN("+r[0]+") - "+r[1]+")",e;default:return e="SUBSTRING("+r[0]+" FROM "+r[1],3===r.length&&(e+=" FOR "+r[2]),e+=")",e}}case"extract":return"EXTRACT("+r[0].replace(/\'/g,"")+" FROM "+r[1]+")";case"cast":{let e="";switch(t){case a.FeatureServiceDatabaseType.Oracle:switch(r[1].type){case"date":e="DATE";break;case"float":e="DOUBLE";break;case"integer":e="INTEGER";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="TIMESTAMP";break;case"varchar":e="VARCHAR("+r[1].size.toString()+")"}return`CAST(${r[0]} AS ${e})`;case a.FeatureServiceDatabaseType.Postgres:switch(r[1].type){case"date":e="DATE";break;case"float":e="DOUBLE PRECISION";break;case"integer":e="INT";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="TIMESTAMP";break;case"varchar":e="VARCHAR("+r[1].size.toString()+")"}return`CAST(${r[0]} AS ${e})`;case a.FeatureServiceDatabaseType.SqlServer:switch(r[1].type){case"date":e="DATE";break;case"float":e="FLOAT";break;case"integer":e="INT";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="DATETIME";break;case"varchar":e="VARCHAR("+r[1].size.toString()+")"}return`CAST(${r[0]} AS ${e})`;default:switch(r[1].type){case"date":e="DATE";break;case"float":e="FLOAT";break;case"integer":e="INTEGER";break;case"real":e="REAL";break;case"smallint":e="SMALLINT";break;case"timestamp":e="TIMESTAMP";break;case"varchar":e="VARCHAR("+r[1].size.toString()+")"}return`CAST(${r[0]} AS ${e})`}}}throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:e})}function T(e,t,s,n){s?.outputTimeReference&&(e=r.ArcadeDate.arcadeDateAndZoneToArcadeDate(e,s?.outputTimeReference));const c=e.toDateTime(),o=0===c.hour&&0===c.minute&&0===c.second&&0===c.millisecond;switch(t){case a.FeatureServiceDatabaseType.FILEGDB:case a.FeatureServiceDatabaseType.Standardised:case a.FeatureServiceDatabaseType.StandardisedNoInterval:return o?`date '${c.toFormat("yyyy-LL-dd")}'`:`date '${c.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case a.FeatureServiceDatabaseType.Oracle:return o?`TO_DATE('${c.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${c.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case a.FeatureServiceDatabaseType.SqlServer:return`'${c.toFormat(o?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case a.FeatureServiceDatabaseType.PGDB:return`#${c.toFormat(o?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case a.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${c.toFormat(o?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${c.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function f(e,r,t,s){let n=a.isDate(e)?c.DateTime.fromJSDate(e):c.DateTime.fromSQL(e);const o=0===n.hour&&0===n.minute&&0===n.second&&0===n.millisecond;switch(t?.inputTimeReference&&(n=c.DateTime.fromObject({day:n.day,year:n.year,month:n.month,hour:n.hour,minute:n.minute,second:n.second,millisecond:n.millisecond},{zone:t.inputTimeReference})),t?.outputTimeReference&&(n=n.setZone(t.outputTimeReference)),r){case a.FeatureServiceDatabaseType.FILEGDB:case a.FeatureServiceDatabaseType.Standardised:case a.FeatureServiceDatabaseType.StandardisedNoInterval:return o?`date '${n.toFormat("yyyy-LL-dd")}'`:`date '${n.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case a.FeatureServiceDatabaseType.Oracle:return o?`TO_DATE('${n.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${n.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case a.FeatureServiceDatabaseType.SqlServer:return`'${n.toFormat(o?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case a.FeatureServiceDatabaseType.PGDB:return`#${n.toFormat(o?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case a.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${n.toFormat(o?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${n.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function m(e,r){switch(r){case a.FeatureServiceDatabaseType.FILEGDB:case a.FeatureServiceDatabaseType.Standardised:case a.FeatureServiceDatabaseType.StandardisedNoInterval:case a.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case a.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case a.FeatureServiceDatabaseType.PGDB:case a.FeatureServiceDatabaseType.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function g(e,r,a={}){const t={},s={},n={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",guid:"guid",globalid:"guid",string:"string"};for(const c of r){const e=c.type?n[c.type]:void 0;t[c.name.toLowerCase()]=void 0===e?"":e}for(const c in a){const e=n[a[c]];s[c.toLowerCase()]=void 0===e?"":e}switch(h(t,e.parseTree,e.parameters,s)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"string":return"string";case"global-id":case"guid":return"guid"}return""}function h(e,r,t,n){let c;switch(r.type){case"interval":return"integer";case"case-expression":{const a=[];if("simple"===r.format){for(let s=0;s<r.clauses.length;s++)a.push(h(e,r.clauses[s].value,t,n));null!==r.else&&a.push(h(e,r.else,t,n))}else{for(let s=0;s<r.clauses.length;s++)a.push(h(e,r.else,t,n));null!==r.else&&a.push(h(e,r.else,t,n))}return b(a)}case"parameter":{const e=n[r.value.toLowerCase()];if(void 0===e&&t){const e=t[r.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(a.isDate(e))return"date";if(a.isArcadeDate(e))return"date";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expression-list":{const a=[];for(const s of r.value)a.push(h(e,s,t,n));return a}case"unary-expression":return"boolean";case"binary-expression":switch(r.operator){case"AND":case"OR":case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"IS":case"ISNOT":if("null"!==r.right.type)throw new s.SqlError(s.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case"*":case"-":case"+":case"/":return b([h(e,r.left,t,n),h(e,r.right,t,n)]);case"||":return"string";default:throw new s.SqlError(s.SqlErrorCodes.UnsupportedOperator,{operator:r.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===r.value?"":r.value%1==0?"integer":"double";case"date":case"timestamp":case"current-time":return"date";case"column-reference":{const a=e[r.column.toLowerCase()];return void 0===a?"":a}case"function":switch(r.name.toLowerCase()){case"cast":switch(r.args?.value[1]?.value.type??""){case"integer":case"smallint":return"integer";case"real":case"float":return"double";case"date":case"timestamp":return"date";case"varchar":return"string";default:return""}case"position":case"extract":case"char_length":case"mod":return"integer";case"round":if(c=h(e,r.args,t,n),c instanceof Array){if(c.length<=0)return"double";c=c[0]}return c;case"sign":return"integer";case"ceiling":case"floor":case"abs":return c=h(e,r.args,t,n),c instanceof Array&&(c=b(c)),"integer"===c||"double"===c?c:"double";case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"cosh":case"sinh":case"tanh":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"nullif":case"coalesce":return c=h(e,r.args,t,n),c instanceof Array?c.length>0?c[0]:"":c}return""}throw new s.SqlError(s.SqlErrorCodes.UnsupportedSyntax,{node:r.type})}const E={boolean:1,string:2,integer:3,double:4,date:5};function b(e){if(e){let r="";for(const a of e)""!==a&&(r=""===r||E[r]<E[a]?a:r);return r}return""}function D(e,r){return v(e.parseTree,r)}function L(e){return"column-reference"===e?.parseTree.type}function v(e,r){if(null==e)return!1;switch(e.type){case"when-clause":return v(e.operand,r)||v(e.value,r);case"case-expression":for(const a of e.clauses)if(v(a,r))return!0;return!("simple"!==e.format||!v(e.operand,r))||!(null===e.else||!v(e.else,r));case"parameter":case"null":case"boolean":case"date":case"timestamp":case"string":case"number":return!1;case"expression-list":for(const a of e.value)if(v(a,r))return!0;return!1;case"unary-expression":return v(e.expr,r);case"binary-expression":return v(e.left,r)||v(e.right,r);case"column-reference":return r.toLowerCase()===e.column.toLowerCase();case"function":return v(e.args,r)}return!1}function F(e){let r="";return r+=e.period.toUpperCase(),r}function I(e,r,a){let t="";return t="interval-period"===r.type?F(r):F(r.start)+" TO "+F(r.end),"INTERVAL "+a+" "+e+" "+t}e.arcadeDateToSqlString=T,e.changeSqlTimeZones=i,e.changeWhereClauseTimeZone=u,e.combine=p,e.convertIntervalToSql=I,e.isSingleField=L,e.makeDateString=f,e.makeToday=m,e.predictType=g,e.reformulateWithoutField=d,e.scanForField=D,e.toWhereClause=o,e.toWhereClauseFromTree=l,e.translateFunctionToDatabaseSpecific=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
