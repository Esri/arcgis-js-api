/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","./shared","../../../core/sql/WhereClause","./errorsupport","../../../chunks/datetime"],(function(e,r,t,a,n){"use strict";function s(e,r){return u(e?.parseTree,r,e?.parameters)}function o(e,r,t){return u(e,r,t)}function c(e,a,n,s){return t.WhereClause.create(u(e.parseTree,r.FeatureServiceDatabaseType.Standardised,e.parameters,a,n),s)}function i(e,a,n="AND"){return t.WhereClause.create("(("+s(e,r.FeatureServiceDatabaseType.Standardised)+")"+n+"("+s(a,r.FeatureServiceDatabaseType.Standardised)+"))",e.fieldsIndex)}function u(e,r,t,n=null,s=null){let o,c,i,f;switch(e.type){case"interval":return v(u(e.value,r,t,n,s),e.qualifier,e.op);case"case-expression":{let a=" CASE ";"simple"===e.format&&(a+=u(e.operand,r,t,n,s));for(let o=0;o<e.clauses.length;o++)a+=" WHEN "+u(e.clauses[o].operand,r,t,n,s)+" THEN "+u(e.clauses[o].value,r,t,n,s);return null!==e.else&&(a+=" ELSE "+u(e.else,r,t,n,s)),a+=" END ",a}case"parameter":{const a=t[e.value.toLowerCase()];if("string"==typeof a){return"'"+t[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(a instanceof Date)return d(a,r);if(a instanceof Array){const e=[];for(let t=0;t<a.length;t++)"string"==typeof a[t]?e.push("'"+a[t].toString().replace(/'/g,"''")+"'"):a[t]instanceof Date?e.push(d(a[t],r)):e.push(a[t].toString());return e}return a.toString()}case"expression-list":c=[];for(const a of e.value)c.push(u(a,r,t,n,s));return c;case"unary-expression":return" ( NOT "+u(e.expr,r,t,n,s)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+u(e.left,r,t,n,s)+" AND "+u(e.right,r,t,n,s)+") ";case"OR":return" ("+u(e.left,r,t,n,s)+" OR "+u(e.right,r,t,n,s)+") ";case"IS":if("null"!==e.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return" ("+u(e.left,r,t,n,s)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return" ("+u(e.left,r,t,n,s)+" IS NOT NULL )";case"IN":return o=[],"expression-list"===e.right.type?(o=u(e.right,r,t,n,s)," ("+u(e.left,r,t,n,s)+" IN ("+o.join(",")+")) "):(f=u(e.right,r,t,n,s),f instanceof Array?" ("+u(e.left,r,t,n,s)+" IN ("+f.join(",")+")) ":" ("+u(e.left,r,t,n,s)+" IN ("+f+")) ");case"NOT IN":return o=[],"expression-list"===e.right.type?(o=u(e.right,r,t,n,s)," ("+u(e.left,r,t,n,s)+" NOT IN ("+o.join(",")+")) "):(f=u(e.right,r,t,n,s),f instanceof Array?" ("+u(e.left,r,t,n,s)+" NOT IN ("+f.join(",")+")) ":" ("+u(e.left,r,t,n,s)+" NOT IN ("+f+")) ");case"BETWEEN":return i=u(e.right,r,t,n,s)," ("+u(e.left,r,t,n,s)+" BETWEEN "+i[0]+" AND "+i[1]+" ) ";case"NOTBETWEEN":return i=u(e.right,r,t,n,s)," ("+u(e.left,r,t,n,s)+" NOT BETWEEN "+i[0]+" AND "+i[1]+" ) ";case"LIKE":return""!==e.escape?" ("+u(e.left,r,t,n,s)+" LIKE "+u(e.right,r,t,n,s)+" ESCAPE '"+e.escape+"') ":" ("+u(e.left,r,t,n,s)+" LIKE "+u(e.right,r,t,n,s)+") ";case"NOT LIKE":return""!==e.escape?" ("+u(e.left,r,t,n,s)+" NOT LIKE "+u(e.right,r,t,n,s)+" ESCAPE '"+e.escape+"') ":" ("+u(e.left,r,t,n,s)+" NOT LIKE "+u(e.right,r,t,n,s)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+u(e.left,r,t,n,s)+" "+e.operator+" "+u(e.right,r,t,n,s)+") "}throw new a.SqlError(a.SqlErrorCodes.UnsupportedOperator,{operator:e.operator});case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return d(e.value,r);case"number":return e.value.toString();case"current-time":return p("date"===e.mode,r);case"column-reference":return n&&n.toLowerCase()===e.column.toLowerCase()?"("+s+")":e.column;case"function":{const a=u(e.args,r,t,n,s);return l(e.name,a,r)}}throw new a.SqlError(a.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}function l(e,t,n){switch(e.toLowerCase().trim()){case"abs":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"abs"});return"abs("+t[0]+")";case"ceiling":case"ceil":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(n){case r.FeatureServiceDatabaseType.Standardised:case r.FeatureServiceDatabaseType.StandardisedNoInterval:}return"CEILING("+t[0]+")";case"floor":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"floor"});return"FLOOR("+t[0]+")";case"log":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"log"});return"LOG("+t[0]+")";case"log10":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"log10"});return"LOG10("+t[0]+")";case"power":if(2!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"power"});return"POWER("+t[0]+","+t[1]+")";case"round":if(2===t.length)return"ROUND("+t[0]+","+t[1]+")";if(1===t.length)return"ROUND("+t[0]+")";throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});case"truncate":if(t.length<1||t.length>2)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});return n===r.FeatureServiceDatabaseType.SqlServer?"ROUND("+t[0]+(1===t.length?"0":","+t[1])+",1)":"TRUNCATE("+t[0]+(1===t.length?")":","+t[1]+")");case"char_length":case"len":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(n){case r.FeatureServiceDatabaseType.SqlServer:return"LEN("+t[0]+")";case r.FeatureServiceDatabaseType.Oracle:return"LENGTH("+t[0]+")";default:return"CHAR_LENGTH("+t[0]+")"}case"concat":if(t.length<1)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"concat"});{let e="CONCAT(";for(let r=0;r<t.length;r++)0!==r&&(e+=","),e+=t[r];return e+=")",e}case"lower":case"lcase":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+t[0]+")";case"upper":case"ucase":if(1!==t.length)throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:"upper"});return"UPPER("+t[0]+")";case"substring":{let e="";switch(n){case r.FeatureServiceDatabaseType.Oracle:return e="SUBSTR("+t[0]+","+t[1],3===t.length&&(e+=","+t[2]),e+=")",e;case r.FeatureServiceDatabaseType.SqlServer:return e=3===t.length?"SUBSTRING("+t[0]+","+t[1]+","+t[2]+")":"SUBSTRING("+t[0]+",  "+t[1]+", LEN("+t[0]+") - "+t[1]+")",e;default:return e="SUBSTRING("+t[0]+" FROM "+t[1],3===t.length&&(e+=" FOR "+t[2]),e+=")",e}}case"extract":return"EXTRACT("+t[0].replace(/\'/g,"")+" FROM "+t[1]+")"}throw new a.SqlError(a.SqlErrorCodes.InvalidFunctionParameters,{function:e})}function d(e,t){const a=e instanceof Date?n.DateTime.fromJSDate(e):n.DateTime.fromSQL(e),s=0===a.hour&&0===a.minute&&0===a.second&&0===a.millisecond;switch(t){case r.FeatureServiceDatabaseType.FILEGDB:case r.FeatureServiceDatabaseType.Standardised:case r.FeatureServiceDatabaseType.StandardisedNoInterval:return s?`date '${a.toFormat("yyyy-LL-dd")}'`:`date '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case r.FeatureServiceDatabaseType.Oracle:return s?`TO_DATE('${a.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${a.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case r.FeatureServiceDatabaseType.SqlServer:return`'${a.toFormat(s?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case r.FeatureServiceDatabaseType.PGDB:return`#${a.toFormat(s?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case r.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${a.toFormat(s?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function p(e,t){switch(t){case r.FeatureServiceDatabaseType.FILEGDB:case r.FeatureServiceDatabaseType.Standardised:case r.FeatureServiceDatabaseType.StandardisedNoInterval:case r.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case r.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case r.FeatureServiceDatabaseType.PGDB:case r.FeatureServiceDatabaseType.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function f(e,r,t={}){const a={},n={},s={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"};for(const o of r){const e=o.type?s[o.type]:void 0;a[o.name.toLowerCase()]=void 0===e?"":e}for(const o in t){const e=s[t[o]];n[o.toLowerCase()]=void 0===e?"":e}switch(S(a,e.parseTree,e.parameters,n)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"string":return"string"}return""}function S(e,r,t,n){let s;switch(r.type){case"interval":return"integer";case"case-expression":{const a=[];if("simple"===r.format){for(let s=0;s<r.clauses.length;s++)a.push(S(e,r.clauses[s].value,t,n));null!==r.else&&a.push(S(e,r.else,t,n))}else{for(let s=0;s<r.clauses.length;s++)a.push(S(e,r.else,t,n));null!==r.else&&a.push(S(e,r.else,t,n))}return y(a)}case"parameter":{const e=n[r.value.toLowerCase()];if(void 0===e&&t){const e=t[r.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(e instanceof Date)return"date";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expression-list":{const a=[];for(const s of r.value)a.push(S(e,s,t,n));return a}case"unary-expression":return"boolean";case"binary-expression":switch(r.operator){case"AND":case"OR":case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"IS":case"ISNOT":if("null"!==r.right.type)throw new a.SqlError(a.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case"*":case"-":case"+":case"/":return y([S(e,r.left,t,n),S(e,r.right,t,n)]);default:throw new a.SqlError(a.SqlErrorCodes.UnsupportedOperator,{operator:r.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===r.value?"":r.value%1==0?"integer":"double";case"date":case"timestamp":case"current-time":return"date";case"column-reference":{const t=e[r.column.toLowerCase()];return void 0===t?"":t}case"function":switch(r.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return s=S(e,r.args,t,n),s instanceof Array?s.length>0?s[0]:"":s;case"sign":return s=S(e,r.args,t,n),s instanceof Array&&(s=y(s)),"integer"===s||"double"===s?s:"double";case"ceiling":case"floor":case"abs":{const a=S(e,r.args,t,n);return a instanceof Array?y(a):a}case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":case"truncate":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string"}return""}throw new a.SqlError(a.SqlErrorCodes.UnsupportedSyntax,{node:r.type})}const g={boolean:1,string:2,integer:3,double:4,date:5};function y(e){if(e){let r="";for(const t of e)""!==t&&(r=""===r||g[r]<g[t]?t:r);return r}return""}function h(e,r){return T(e.parseTree,r)}function E(e){return"column-reference"===e?.parseTree.type}function T(e,r){if(null==e)return!1;switch(e.type){case"when-clause":return T(e.operand,r)||T(e.value,r);case"case-expression":for(const t of e.clauses)if(T(t,r))return!0;return!("simple"!==e.format||!T(e.operand,r))||!(null===e.else||!T(e.else,r));case"parameter":case"null":case"boolean":case"date":case"timestamp":case"string":case"number":return!1;case"expression-list":for(const t of e.value)if(T(t,r))return!0;return!1;case"unary-expression":return T(e.expr,r);case"binary-expression":return T(e.left,r)||T(e.right,r);case"column-reference":return r.toLowerCase()===e.column.toLowerCase();case"function":return T(e.args,r)}return!1}function m(e){let r="";return r+=e.period.toUpperCase(),r}function v(e,r,t){let a="";return a="interval-period"===r.type?m(r):m(r.start)+" TO "+m(r.end),"INTERVAL "+t+" "+e+" "+a}e.combine=i,e.convertIntervalToSql=v,e.isSingleField=E,e.makeDateString=d,e.makeToday=p,e.predictType=f,e.reformulateWithoutField=c,e.scanForField=h,e.toWhereClause=s,e.toWhereClauseFromTree=o,e.translateFunctionToDatabaseSpecific=l,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
