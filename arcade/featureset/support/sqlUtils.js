/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/languageUtils","./shared","../../../core/sql/WhereClause"],(function(e,r,t,a){"use strict";function n(e,r){return u(e.parseTree,r,e.parameters)}function s(e,r,t){return u(e,r,t)}function o(e,r,n,s){return a.WhereClause.create(u(e.parseTree,t.FeatureServiceDatabaseType.Standardised,e.parameters,r,n),s)}function c(e,r,s="AND"){return a.WhereClause.create("(("+n(e,t.FeatureServiceDatabaseType.Standardised)+")"+s+"("+n(r,t.FeatureServiceDatabaseType.Standardised)+"))",e.fieldsIndex)}function u(e,r,t,a=null,n=null){let s,o,c,p;switch(e.type){case"interval":return D(u(e.value,r,t,a,n),e.qualifier,e.op);case"case_expression":{let s=" CASE ";"simple"===e.format&&(s+=u(e.operand,r,t,a,n));for(let o=0;o<e.clauses.length;o++)s+=" WHEN "+u(e.clauses[o].operand,r,t,a,n)+" THEN "+u(e.clauses[o].value,r,t,a,n);return null!==e.else&&(s+=" ELSE "+u(e.else,r,t,a,n)),s+=" END ",s}case"param":{const a=t[e.value.toLowerCase()];if("string"==typeof a){return"'"+t[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(a instanceof Date)return l(a,r);if(a instanceof Array){const e=[];for(let t=0;t<a.length;t++)"string"==typeof a[t]?e.push("'"+a[t].toString().replace(/'/g,"''")+"'"):a[t]instanceof Date?e.push(l(a[t],r)):e.push(a[t].toString());return e}return a.toString()}case"expr_list":o=[];for(const s of e.value)o.push(u(s,r,t,a,n));return o;case"unary_expr":return" ( NOT "+u(e.expr,r,t,a,n)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+u(e.left,r,t,a,n)+" AND "+u(e.right,r,t,a,n)+") ";case"OR":return" ("+u(e.left,r,t,a,n)+" OR "+u(e.right,r,t,a,n)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+u(e.left,r,t,a,n)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+u(e.left,r,t,a,n)+" IS NOT NULL )";case"IN":return s=[],"expr_list"===e.right.type?(s=u(e.right,r,t,a,n)," ("+u(e.left,r,t,a,n)+" IN ("+s.join(",")+")) "):(p=u(e.right,r,t,a,n),p instanceof Array?" ("+u(e.left,r,t,a,n)+" IN ("+p.join(",")+")) ":" ("+u(e.left,r,t,a,n)+" IN ("+p+")) ");case"NOT IN":return s=[],"expr_list"===e.right.type?(s=u(e.right,r,t,a,n)," ("+u(e.left,r,t,a,n)+" NOT IN ("+s.join(",")+")) "):(p=u(e.right,r,t,a,n),p instanceof Array?" ("+u(e.left,r,t,a,n)+" NOT IN ("+p.join(",")+")) ":" ("+u(e.left,r,t,a,n)+" NOT IN ("+p+")) ");case"BETWEEN":return c=u(e.right,r,t,a,n)," ("+u(e.left,r,t,a,n)+" BETWEEN "+c[0]+" AND "+c[1]+" ) ";case"NOTBETWEEN":return c=u(e.right,r,t,a,n)," ("+u(e.left,r,t,a,n)+" NOT BETWEEN "+c[0]+" AND "+c[1]+" ) ";case"LIKE":return""!==e.escape?" ("+u(e.left,r,t,a,n)+" LIKE "+u(e.right,r,t,a,n)+" ESCAPE '"+e.escape+"') ":" ("+u(e.left,r,t,a,n)+" LIKE "+u(e.right,r,t,a,n)+") ";case"NOT LIKE":return""!==e.escape?" ("+u(e.left,r,t,a,n)+" NOT LIKE "+u(e.right,r,t,a,n)+" ESCAPE '"+e.escape+"') ":" ("+u(e.left,r,t,a,n)+" NOT LIKE "+u(e.right,r,t,a,n)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+u(e.left,r,t,a,n)+" "+e.operator+" "+u(e.right,r,t,a,n)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return l(e.value,r);case"number":return e.value.toString();case"current_time":return f("date"===e.mode,r);case"column_ref":return a&&a.toLowerCase()===e.column.toLowerCase()?"("+n+")":e.column;case"function":{const s=u(e.args,r,t,a,n);return i(e.name,s,r)}}throw new Error("Unsupported sql syntax "+e.type)}function i(e,r,a){switch(e.toLowerCase().trim()){case"abs":if(1!==r.length)throw new Error("Invalid Parameter for call to ABS");return"abs("+r[0]+")";case"ceiling":case"ceil":if(1!==r.length)throw new Error("Invalid Parameter for call to CEILING");switch(a){case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:default:return"CEILING("+r[0]+")"}case"floor":if(1!==r.length)throw new Error("Invalid Parameter for call to Floor");return"FLOOR("+r[0]+")";case"log":if(1!==r.length)throw new Error("Invalid Parameter for call to LOG");return"LOG("+r[0]+")";case"log10":if(1!==r.length)throw new Error("Invalid Parameter for call to LOG10");return"LOG10("+r[0]+")";case"power":if(2!==r.length)throw new Error("Invalid Parameter for call to POWER");return"POWER("+r[0]+","+r[1]+")";case"round":if(2===r.length)return"ROUND("+r[0]+","+r[1]+")";if(1===r.length)return"ROUND("+r[0]+")";throw new Error("Invalid Parameter for call to ROUND");case"truncate":if(r.length<1||r.length>2)throw new Error("Invalid Parameter for TRUNCATE function");switch(a){case t.FeatureServiceDatabaseType.SqlServer:return"ROUND("+r[0]+(1===r.length?"0":","+r[1])+",1)";default:return"TRUNCATE("+r[0]+(1===r.length?")":","+r[1]+")")}case"char_length":case"len":if(1!==r.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");switch(a){case t.FeatureServiceDatabaseType.SqlServer:return"LEN("+r[0]+")";case t.FeatureServiceDatabaseType.Oracle:return"LENGTH("+r[0]+")";default:return"CHAR_LENGTH("+r[0]+")"}case"concat":if(r.length<1)throw new Error("Invalid Parameter for CONCAT function");{let e="CONCAT(";for(let t=0;t<r.length;t++)0!==t&&(e+=","),e+=r[t];return e+=")",e}case"lower":case"lcase":if(1!==r.length)throw new Error("Invalid Parameter for Lower function");return"LOWER("+r[0]+")";case"upper":case"ucase":if(1!==r.length)throw new Error("Invalid Parameter for Upper function");return"UPPER("+r[0]+")";case"substring":{let e="";switch(a){case t.FeatureServiceDatabaseType.Oracle:return e="SUBSTR("+r[0]+","+r[1],3===r.length&&(e+=","+r[2]),e+=")",e;case t.FeatureServiceDatabaseType.SqlServer:return e=3===r.length?"SUBSTRING("+r[0]+","+r[1]+","+r[2]+")":"SUBSTRING("+r[0]+",  "+r[1]+", LEN("+r[0]+") - "+r[1]+")",e;default:return e="SUBSTRING("+r[0]+" FROM "+r[1],3===r.length&&(e+=" FOR "+r[2]),e+=")",e}}case"extract":return"EXTRACT("+r[0].replace(/\'/g,"")+" FROM "+r[1]+")"}throw new Error("Function Not Recognised")}function l(e,a){const n=r.MomentLibrary.Moment(e),s=0===n.minute()&&0===n.hour()&&0===n.second()&&0===n.millisecond();switch(a){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:return s?"date '"+n.format("YYYY-MM-DD")+"'":"date '"+n.format("YYYY-MM-DD HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.Oracle:return s?"TO_DATE('"+n.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+n.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case t.FeatureServiceDatabaseType.SqlServer:return"'"+n.format(s?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.PGDB:return"#"+n.format(s?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case t.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+n.format(s?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+n.format("YYYY-MM-DD HH:mm:ss")+"'"}}function f(e,r){switch(r){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:case t.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case t.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case t.FeatureServiceDatabaseType.PGDB:case t.FeatureServiceDatabaseType.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function p(e,r,t={}){const a={},n={},s={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"};for(const o of r){const e=s[o.type];a[o.name.toLowerCase()]=void 0===e?"":e}for(const o in t){const e=s[t[o]];n[o.toLowerCase()]=void 0===e?"":e}switch(d(a,e.parseTree,e.parameters,n)){case"double":return"double";case"integer":return"integer";case"double":return"double";case"date":return"date";case"string":return"string"}return""}function d(e,r,t,a){let n;switch(r.type){case"interval":return"integer";case"case_expression":{const n=[];if("simple"===r.format){for(let s=0;s<r.clauses.length;s++)n.push(d(e,r.clauses[s].value,t,a));null!==r.else&&n.push(d(e,r.else,t,a))}else{for(let s=0;s<r.clauses.length;s++)n.push(d(e,r.else,t,a));null!==r.else&&n.push(d(e,r.else,t,a))}return h(n)}case"param":{const e=a[r.value.toLowerCase()];if(void 0===e&&t){const e=t[r.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(e instanceof Date)return"date";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expr_list":{const n=[];for(const s of r.value)n.push(d(e,s,t,a));return n}case"unary_expr":return"boolean";case"binary_expr":switch(r.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==r.right.type)throw new Error("Unsupported RHS for IS");return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return h([d(e,r.left,t,a),d(e,r.right,t,a)]);default:throw new Error("Not Supported Operator "+r.operator)}case"null":return"";case"bool":return"boolean";case"string":return"string";case"number":return null===r.value?"":r.value%1==0?"integer":"double";case"date":case"timestamp":case"current_time":return"date";case"column_ref":{const t=e[r.column.toLowerCase()];return void 0===t?"":t}case"function":switch(r.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return n=d(e,r.args,t,a),n instanceof Array?n.length>0?n[0]:"":n;case"sign":return n=d(e,r.args,t,a),n instanceof Array&&(n=h(n)),"integer"===n||"double"===n?n:"double";case"ceiling":case"floor":case"abs":{const n=d(e,r.args,t,a);return n instanceof Array?h(n):n}case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"round":return n=d(e,r.args,t,a),n instanceof Array?n.length>0?n[0]:"":n}return""}throw new Error("Unsupported sql syntax "+r.type)}const g={boolean:1,string:2,integer:3,double:4,date:5};function h(e){if(e){let r="";for(const t of e)""!==t&&(r=""===r||g[r]<g[t]?t:r);return r}return""}function T(e,r){return E(e.parseTree,r)}function S(e){return"column_ref"===e.parseTree.type}function E(e,r){if(null==e)return!1;switch(e.type){case"when_clause":return E(e.operand,r)||E(e.value,r);case"case_expression":for(const t of e.clauses)if(E(t,r))return!0;return!("simple"!==e.format||!E(e.operand,r))||!(null===e.else||!E(e.else,r));case"param":return!1;case"expr_list":for(const t of e.value)if(E(t,r))return!0;return!1;case"unary_expr":return E(e.expr,r);case"binary_expr":return E(e.left,r)||E(e.right,r);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return!1;case"column_ref":return r.toLowerCase()===e.column.toLowerCase();case"function":return E(e.args,r)}return!1}function m(e){let r="";return r+=e.period.toUpperCase(),r}function D(e,r,t){let a="";return a="interval-period"===r.type?m(r):m(r.start)+" TO "+m(r.end),"INTERVAL "+t+" "+e+" "+a}e.combine=c,e.convertIntervalToSql=D,e.isSingleField=S,e.makeDateString=l,e.makeToday=f,e.predictType=p,e.reformulateWithoutField=o,e.scanForField=T,e.toWhereClause=n,e.toWhereClauseFromTree=s,e.translateFunctionToDatabaseSpecific=i,Object.defineProperty(e,"__esModule",{value:!0})}));
