// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../../ArcadeDate","./shared","../../polyfill/sql/WhereClause","./errorsupport","../../arcadeTimeUtils","./shared","../../polyfill/sql/FieldsIndex","../../../libs/luxon/luxon"],(function(e,r,a,t,s,n,o,c,i,u){"use strict";function l(e,r){return p(null==e?void 0:e.parseTree,r,null==e?void 0:e.parameters)}function d(e,r,a){var s=o.convertTimeReference(r),n=o.convertTimeReference(a);return p(e.parseTree,t.FeatureServiceDatabaseType.Standardised,null,null,null,{inputTimeReference:s,outputTimeReference:n})}function p(e,r,a,s,o,i){var u,l,d,f;switch(void 0===s&&(s=null),void 0===o&&(o=null),void 0===i&&(i=null),e.type){case"interval":return h(p(e.value,r,a,s,o,i),e.qualifier,e.op);case"case-expression":var g=" CASE ";"simple"===e.format&&(g+=p(e.operand,r,a,s,o,i));for(var v=0;v<e.clauses.length;v++)g+=" WHEN "+p(e.clauses[v].operand,r,a,s,o,i)+" THEN "+p(e.clauses[v].value,r,a,s,o,i);return null!==e.else&&(g+=" ELSE "+p(e.else,r,a,s,o,i)),g+=" END ";case"parameter":var E=a[e.value.toLowerCase()];if("string"==typeof E)return"'"+a[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(c.isDate(E))return T(E,r,i,"parameter");if(c.isArcadeDate(E))return S(E,r,i,"parameter");if(E instanceof Array){var b=[];for(v=0;v<E.length;v++)"string"==typeof E[v]?b.push("'"+E[v].toString().replace(/'/g,"''")+"'"):c.isDate(E[v])?b.push(T(E[v],r,i,"parameter")):c.isArcadeDate(E[v])?b.push(S(E[v],r,i,"parameter")):b.push(E[v].toString());return b}return E.toString();case"expression-list":l=[];for(var D=0,L=e.value;D<L.length;D++){var F=L[D];l.push(p(F,r,a,s,o,i))}return l;case"unary-expression":return" ( NOT "+p(e.expr,r,a,s,o,i)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+p(e.left,r,a,s,o,i)+" AND "+p(e.right,r,a,s,o,i)+") ";case"OR":return" ("+p(e.left,r,a,s,o,i)+" OR "+p(e.right,r,a,s,o,i)+") ";case"IS":if("null"!==e.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return" ("+p(e.left,r,a,s,o,i)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return" ("+p(e.left,r,a,s,o,i)+" IS NOT NULL )";case"IN":return u=[],"expression-list"===e.right.type?(u=p(e.right,r,a,s,o)," ("+p(e.left,r,a,s,o,i)+" IN ("+u.join(",")+")) "):(f=p(e.right,r,a,s,o,i))instanceof Array?" ("+p(e.left,r,a,s,o,i)+" IN ("+f.join(",")+")) ":" ("+p(e.left,r,a,s,o,i)+" IN ("+f+")) ";case"NOT IN":return u=[],"expression-list"===e.right.type?(u=p(e.right,r,a,s,o)," ("+p(e.left,r,a,s,o,i)+" NOT IN ("+u.join(",")+")) "):(f=p(e.right,r,a,s,o,i))instanceof Array?" ("+p(e.left,r,a,s,o,i)+" NOT IN ("+f.join(",")+")) ":" ("+p(e.left,r,a,s,o,i)+" NOT IN ("+f+")) ";case"BETWEEN":return d=p(e.right,r,a,s,o,i)," ("+p(e.left,r,a,s,o,i)+" BETWEEN "+d[0]+" AND "+d[1]+" ) ";case"NOTBETWEEN":return d=p(e.right,r,a,s,o,i)," ("+p(e.left,r,a,s,o,i)+" NOT BETWEEN "+d[0]+" AND "+d[1]+" ) ";case"LIKE":return""!==e.escape?" ("+p(e.left,r,a,s,o,i)+" LIKE "+p(e.right,r,a,s,o,i)+" ESCAPE '"+e.escape+"') ":" ("+p(e.left,r,a,s,o,i)+" LIKE "+p(e.right,r,a,s,o,i)+") ";case"NOT LIKE":return""!==e.escape?" ("+p(e.left,r,a,s,o,i)+" NOT LIKE "+p(e.right,r,a,s,o,i)+" ESCAPE '"+e.escape+"') ":" ("+p(e.left,r,a,s,o,i)+" NOT LIKE "+p(e.right,r,a,s,o,i)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+p(e.left,r,a,s,o,i)+" "+e.operator+" "+p(e.right,r,a,s,o,i)+") ";case"||":return" ("+p(e.left,r,a,s,o,i)+" "+(r===t.FeatureServiceDatabaseType.SqlServer?"+":e.operator)+" "+p(e.right,r,a,s,o,i)+") "}throw new n.SqlError(n.SqlErrorCodes.UnsupportedOperator,{operator:e.operator});case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":return T(e.value,r,i,"timestamp");case"date":return T(e.value,r,i,"date");case"number":return e.value.toString();case"current-time":return m("date"===e.mode,r);case"column-reference":return s&&s.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"data-type":return e.value;case"function":var I=p(e.args,r,a,s,o,i);return y(e.name,I,r)}throw new n.SqlError(n.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}function y(e,r,a){switch(e.toLowerCase().trim()){case"cos":case"sin":case"tan":case"cosh":case"tanh":case"sinh":case"acos":case"asin":case"atan":case"floor":case"log10":case"log":case"abs":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:e.toLowerCase().trim()});return e.toUpperCase().trim()+"("+r[0]+")";case"ceiling":case"ceil":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(a){case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:default:return"CEILING("+r[0]+")"}case"mod":case"power":case"nullif":if(2!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:e.toLowerCase().trim()});return e.toUpperCase().trim()+"("+r[0]+","+r[1]+")";case"round":if(2===r.length)return"ROUND("+r[0]+","+r[1]+")";if(1===r.length)return"ROUND("+r[0]+")";throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});case"truncate":if(r.length<1||r.length>2)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});switch(a){case t.FeatureServiceDatabaseType.SqlServer:return"ROUND("+r[0]+(1===r.length?"0":","+r[1])+",1)";default:return"TRUNCATE("+r[0]+(1===r.length?")":","+r[1]+")")}case"char_length":case"len":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(a){case t.FeatureServiceDatabaseType.SqlServer:return"LEN("+r[0]+")";case t.FeatureServiceDatabaseType.Oracle:return"LENGTH("+r[0]+")";default:return"CHAR_LENGTH("+r[0]+")"}case"coalesce":case"concat":if(r.length<1)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:e.toLowerCase()});for(var s=e.toUpperCase().trim()+"(",o=0;o<r.length;o++)0!==o&&(s+=","),s+=r[o];return s+=")";case"lower":case"lcase":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+r[0]+")";case"upper":case"ucase":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"upper"});return"UPPER("+r[0]+")";case"substring":var c="";switch(a){case t.FeatureServiceDatabaseType.Oracle:return c="SUBSTR("+r[0]+","+r[1],3===r.length&&(c+=","+r[2]),c+=")";case t.FeatureServiceDatabaseType.SqlServer:return c=3===r.length?"SUBSTRING("+r[0]+","+r[1]+","+r[2]+")":"SUBSTRING("+r[0]+",  "+r[1]+", LEN("+r[0]+") - "+r[1]+")";default:return c="SUBSTRING("+r[0]+" FROM "+r[1],3===r.length&&(c+=" FOR "+r[2]),c+=")"}case"extract":return"EXTRACT("+r[0].replace(/\'/g,"")+" FROM "+r[1]+")";case"cast":c="";switch(a){case t.FeatureServiceDatabaseType.Oracle:switch(r[1].type){case"date":c="DATE";break;case"float":c="DOUBLE";break;case"integer":c="INTEGER";break;case"real":c="REAL";break;case"smallint":c="SMALLINT";break;case"timestamp":c="TIMESTAMP";break;case"varchar":c="VARCHAR("+r[1].size.toString()+")"}return"CAST("+r[0]+" AS "+c+")";case t.FeatureServiceDatabaseType.Postgres:switch(r[1].type){case"date":c="DATE";break;case"float":c="DOUBLE PRECISION";break;case"integer":c="INT";break;case"real":c="REAL";break;case"smallint":c="SMALLINT";break;case"timestamp":c="TIMESTAMP";break;case"varchar":c="VARCHAR("+r[1].size.toString()+")"}return"CAST("+r[0]+" AS "+c+")";case t.FeatureServiceDatabaseType.SqlServer:switch(r[1].type){case"date":c="DATE";break;case"float":c="FLOAT";break;case"integer":c="INT";break;case"real":c="REAL";break;case"smallint":c="SMALLINT";break;case"timestamp":c="DATETIME";break;case"varchar":c="VARCHAR("+r[1].size.toString()+")"}return"CAST("+r[0]+" AS "+c+")";default:switch(r[1].type){case"date":c="DATE";break;case"float":c="FLOAT";break;case"integer":c="INTEGER";break;case"real":c="REAL";break;case"smallint":c="SMALLINT";break;case"timestamp":c="TIMESTAMP";break;case"varchar":c="VARCHAR("+r[1].size.toString()+")"}return"CAST("+r[0]+" AS "+c+")"}}throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:e})}function S(e,r,s,n){(null==s?void 0:s.outputTimeReference)&&(e=a.ArcadeDate.arcadeDateAndZoneToArcadeDate(e,null==s?void 0:s.outputTimeReference));var o=e.toDateTime(),c=0===o.hour&&0===o.minute&&0===o.second&&0===o.millisecond;switch(r){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:return c?"date '"+o.toFormat("yyyy-LL-dd")+"'":"date '"+o.toFormat("yyyy-LL-dd HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.Oracle:return c?"TO_DATE('"+o.toFormat("yyyy-LL-dd")+"','YYYY-MM-DD')":"TO_DATE('"+o.toFormat("yyyy-LL-dd HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case t.FeatureServiceDatabaseType.SqlServer:return"'"+o.toFormat(c?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.PGDB:return"#"+o.toFormat(c?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")+"#";case t.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+o.toFormat(c?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")+"'";default:return"date '"+o.toFormat("yyyy-LL-dd HH:mm:ss")+"'"}}function T(e,r,a,s){var n=c.isDate(e)?u.DateTime.fromJSDate(e):u.DateTime.fromSQL(e),o=0===n.hour&&0===n.minute&&0===n.second&&0===n.millisecond;switch((null==a?void 0:a.inputTimeReference)&&(n=u.DateTime.fromObject({day:n.day,year:n.year,month:n.month,hour:n.hour,minute:n.minute,second:n.second,millisecond:n.millisecond},{zone:a.inputTimeReference})),(null==a?void 0:a.outputTimeReference)&&(n=n.setZone(a.outputTimeReference)),r){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:return o?"date '"+n.toFormat("yyyy-LL-dd")+"'":"date '"+n.toFormat("yyyy-LL-dd HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.Oracle:return o?"TO_DATE('"+n.toFormat("yyyy-LL-dd")+"','YYYY-MM-DD')":"TO_DATE('"+n.toFormat("yyyy-LL-dd HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case t.FeatureServiceDatabaseType.SqlServer:return"'"+n.toFormat(o?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.PGDB:return"#"+n.toFormat(o?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")+"#";case t.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+n.toFormat(o?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")+"'";default:return"date '"+n.toFormat("yyyy-LL-dd HH:mm:ss")+"'"}}function m(e,r){switch(r){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:case t.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case t.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case t.FeatureServiceDatabaseType.PGDB:case t.FeatureServiceDatabaseType.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}Object.defineProperty(r,"__esModule",{value:!0}),r.convertIntervalToSql=r.isSingleField=r.scanForField=r.predictType=r.makeToday=r.makeDateString=r.arcadeDateToSqlString=r.translateFunctionToDatabaseSpecific=r.combine=r.reformulateWithoutField=r.toWhereClauseFromTree=r.changeWhereClauseTimeZone=r.changeSqlTimeZones=r.toWhereClause=void 0,r.toWhereClause=l,r.changeSqlTimeZones=function(e,r,a,t){return d(s.WhereClause.create(e,new i(r.fields)),a,t)},r.changeWhereClauseTimeZone=d,r.toWhereClauseFromTree=function(e,r,a){return p(e,r,a)},r.reformulateWithoutField=function(e,r,a,n){return s.WhereClause.create(p(e.parseTree,t.FeatureServiceDatabaseType.Standardised,e.parameters,r,a),n)},r.combine=function(e,r,a){return void 0===a&&(a="AND"),s.WhereClause.create("(("+l(e,t.FeatureServiceDatabaseType.Standardised)+")"+a+"("+l(r,t.FeatureServiceDatabaseType.Standardised)+"))",e.fieldsIndex)},r.translateFunctionToDatabaseSpecific=y,r.arcadeDateToSqlString=S,r.makeDateString=T,r.makeToday=m,r.predictType=function(e,r,a){void 0===a&&(a={});for(var t={},s={},o={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",guid:"guid",globalid:"guid",string:"string"},i=0,u=r;i<u.length;i++){var l=(d=u[i]).type?o[d.type]:void 0;t[d.name.toLowerCase()]=void 0===l?"":l}for(var d in a){l=o[a[d]];s[d.toLowerCase()]=void 0===l?"":l}switch(function e(r,a,t,s){var o,i,u,l;switch(a.type){case"interval":return"integer";case"case-expression":var d=[];if("simple"===a.format){for(var p=0;p<a.clauses.length;p++)d.push(e(r,a.clauses[p].value,t,s));null!==a.else&&d.push(e(r,a.else,t,s))}else{for(p=0;p<a.clauses.length;p++)d.push(e(r,a.else,t,s));null!==a.else&&d.push(e(r,a.else,t,s))}return g(d);case"parameter":var y=s[a.value.toLowerCase()];if(void 0===y&&t){var S=t[a.value.toLowerCase()];if(void 0===S)return"";if(null===S)return"";if("string"==typeof S||S instanceof String)return"string";if("boolean"==typeof S)return"boolean";if(c.isDate(S))return"date";if(c.isArcadeDate(S))return"date";if("number"==typeof S)return S%1==0?"integer":"double"}return void 0===y?"":y;case"expression-list":for(var T=[],m=0,f=a.value;m<f.length;m++){var v=f[m];T.push(e(r,v,t,s))}return T;case"unary-expression":return"boolean";case"binary-expression":switch(a.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==a.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return g([e(r,a.left,t,s),e(r,a.right,t,s)]);case"||":return"string";default:throw new n.SqlError(n.SqlErrorCodes.UnsupportedOperator,{operator:a.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===a.value?"":a.value%1==0?"integer":"double";case"date":case"timestamp":case"current-time":return"date";case"column-reference":var h=r[a.column.toLowerCase()];return void 0===h?"":h;case"function":switch(a.name.toLowerCase()){case"cast":switch(null!==(u=null===(i=null===(o=a.args)||void 0===o?void 0:o.value[1])||void 0===i?void 0:i.value.type)&&void 0!==u?u:""){case"integer":case"smallint":return"integer";case"real":case"float":return"double";case"date":case"timestamp":return"date";case"varchar":return"string";default:return""}case"position":case"extract":case"char_length":case"mod":return"integer";case"round":if((l=e(r,a.args,t,s))instanceof Array){if(l.length<=0)return"double";l=l[0]}return l;case"sign":return"integer";case"ceiling":case"floor":case"abs":return(l=e(r,a.args,t,s))instanceof Array&&(l=g(l)),"integer"===l||"double"===l?l:"double";case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"cosh":case"sinh":case"tanh":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"nullif":case"coalesce":return(l=e(r,a.args,t,s))instanceof Array?l.length>0?l[0]:"":l}return""}throw new n.SqlError(n.SqlErrorCodes.UnsupportedSyntax,{node:a.type})}(t,e.parseTree,e.parameters,s)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"string":return"string";case"global-id":case"guid":return"guid"}return""};var f={boolean:1,string:2,integer:3,double:4,date:5};function g(e){if(e){for(var r="",a=0,t=e;a<t.length;a++){var s=t[a];""!==s&&(r=""===r?s:f[r]<f[s]?s:r)}return r}return""}function v(e){var r="";return r+=e.period.toUpperCase()}function h(e,r,a){return"INTERVAL "+a+" "+e+" "+("interval-period"===r.type?v(r):v(r.start)+" TO "+v(r.end))}r.scanForField=function(e,r){return function e(r,a){if(null==r)return!1;switch(r.type){case"when-clause":return e(r.operand,a)||e(r.value,a);case"case-expression":for(var t=0,s=r.clauses;t<s.length;t++){var n=s[t];if(e(n,a))return!0}return!("simple"!==r.format||!e(r.operand,a))||!(null===r.else||!e(r.else,a));case"parameter":return!1;case"expression-list":for(var o=0,c=r.value;o<c.length;o++){n=c[o];if(e(n,a))return!0}return!1;case"unary-expression":return e(r.expr,a);case"binary-expression":return e(r.left,a)||e(r.right,a);case"null":case"boolean":case"date":case"timestamp":case"string":case"number":return!1;case"column-reference":return a.toLowerCase()===r.column.toLowerCase();case"function":return e(r.args,a)}return!1}(e.parseTree,r)},r.isSingleField=function(e){return"column-reference"===(null==e?void 0:e.parseTree.type)},r.convertIntervalToSql=h}));