// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","./shared","../../polyfill/sql/WhereClause","./errorsupport","../../../libs/luxon/luxon"],(function(e,r,t,a,n,s){"use strict";function o(e,r){return i(null==e?void 0:e.parseTree,r,null==e?void 0:e.parameters)}function i(e,r,t,a,s){var o,d,p,f;switch(void 0===a&&(a=null),void 0===s&&(s=null),e.type){case"interval":return S(i(e.value,r,t,a,s),e.qualifier,e.op);case"case-expression":var g=" CASE ";"simple"===e.format&&(g+=i(e.operand,r,t,a,s));for(var h=0;h<e.clauses.length;h++)g+=" WHEN "+i(e.clauses[h].operand,r,t,a,s)+" THEN "+i(e.clauses[h].value,r,t,a,s);return null!==e.else&&(g+=" ELSE "+i(e.else,r,t,a,s)),g+=" END ";case"parameter":var v=t[e.value.toLowerCase()];if("string"==typeof v)return"'"+t[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(v instanceof Date)return u(v,r);if(v instanceof Array){var y=[];for(h=0;h<v.length;h++)"string"==typeof v[h]?y.push("'"+v[h].toString().replace(/'/g,"''")+"'"):v[h]instanceof Date?y.push(u(v[h],r)):y.push(v[h].toString());return y}return v.toString();case"expression-list":d=[];for(var T=0,E=e.value;T<E.length;T++){var m=E[T];d.push(i(m,r,t,a,s))}return d;case"unary-expression":return" ( NOT "+i(e.expr,r,t,a,s)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+i(e.left,r,t,a,s)+" AND "+i(e.right,r,t,a,s)+") ";case"OR":return" ("+i(e.left,r,t,a,s)+" OR "+i(e.right,r,t,a,s)+") ";case"IS":if("null"!==e.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return" ("+i(e.left,r,t,a,s)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return" ("+i(e.left,r,t,a,s)+" IS NOT NULL )";case"IN":return o=[],"expression-list"===e.right.type?(o=i(e.right,r,t,a,s)," ("+i(e.left,r,t,a,s)+" IN ("+o.join(",")+")) "):(f=i(e.right,r,t,a,s))instanceof Array?" ("+i(e.left,r,t,a,s)+" IN ("+f.join(",")+")) ":" ("+i(e.left,r,t,a,s)+" IN ("+f+")) ";case"NOT IN":return o=[],"expression-list"===e.right.type?(o=i(e.right,r,t,a,s)," ("+i(e.left,r,t,a,s)+" NOT IN ("+o.join(",")+")) "):(f=i(e.right,r,t,a,s))instanceof Array?" ("+i(e.left,r,t,a,s)+" NOT IN ("+f.join(",")+")) ":" ("+i(e.left,r,t,a,s)+" NOT IN ("+f+")) ";case"BETWEEN":return p=i(e.right,r,t,a,s)," ("+i(e.left,r,t,a,s)+" BETWEEN "+p[0]+" AND "+p[1]+" ) ";case"NOTBETWEEN":return p=i(e.right,r,t,a,s)," ("+i(e.left,r,t,a,s)+" NOT BETWEEN "+p[0]+" AND "+p[1]+" ) ";case"LIKE":return""!==e.escape?" ("+i(e.left,r,t,a,s)+" LIKE "+i(e.right,r,t,a,s)+" ESCAPE '"+e.escape+"') ":" ("+i(e.left,r,t,a,s)+" LIKE "+i(e.right,r,t,a,s)+") ";case"NOT LIKE":return""!==e.escape?" ("+i(e.left,r,t,a,s)+" NOT LIKE "+i(e.right,r,t,a,s)+" ESCAPE '"+e.escape+"') ":" ("+i(e.left,r,t,a,s)+" NOT LIKE "+i(e.right,r,t,a,s)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+i(e.left,r,t,a,s)+" "+e.operator+" "+i(e.right,r,t,a,s)+") "}throw new n.SqlError(n.SqlErrorCodes.UnsupportedOperator,{operator:e.operator});case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return u(e.value,r);case"number":return e.value.toString();case"current-time":return l("date"===e.mode,r);case"column-reference":return a&&a.toLowerCase()===e.column.toLowerCase()?"("+s+")":e.column;case"function":var w=i(e.args,r,t,a,s);return c(e.name,w,r)}throw new n.SqlError(n.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}function c(e,r,a){switch(e.toLowerCase().trim()){case"abs":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"abs"});return"abs("+r[0]+")";case"ceiling":case"ceil":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(a){case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:default:return"CEILING("+r[0]+")"}case"floor":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"floor"});return"FLOOR("+r[0]+")";case"log":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"log"});return"LOG("+r[0]+")";case"log10":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"log10"});return"LOG10("+r[0]+")";case"power":if(2!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"power"});return"POWER("+r[0]+","+r[1]+")";case"round":if(2===r.length)return"ROUND("+r[0]+","+r[1]+")";if(1===r.length)return"ROUND("+r[0]+")";throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});case"truncate":if(r.length<1||r.length>2)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});switch(a){case t.FeatureServiceDatabaseType.SqlServer:return"ROUND("+r[0]+(1===r.length?"0":","+r[1])+",1)";default:return"TRUNCATE("+r[0]+(1===r.length?")":","+r[1]+")")}case"char_length":case"len":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(a){case t.FeatureServiceDatabaseType.SqlServer:return"LEN("+r[0]+")";case t.FeatureServiceDatabaseType.Oracle:return"LENGTH("+r[0]+")";default:return"CHAR_LENGTH("+r[0]+")"}case"concat":if(r.length<1)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"concat"});for(var s="CONCAT(",o=0;o<r.length;o++)0!==o&&(s+=","),s+=r[o];return s+=")";case"lower":case"lcase":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+r[0]+")";case"upper":case"ucase":if(1!==r.length)throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:"upper"});return"UPPER("+r[0]+")";case"substring":var i="";switch(a){case t.FeatureServiceDatabaseType.Oracle:return i="SUBSTR("+r[0]+","+r[1],3===r.length&&(i+=","+r[2]),i+=")";case t.FeatureServiceDatabaseType.SqlServer:return i=3===r.length?"SUBSTRING("+r[0]+","+r[1]+","+r[2]+")":"SUBSTRING("+r[0]+",  "+r[1]+", LEN("+r[0]+") - "+r[1]+")";default:return i="SUBSTRING("+r[0]+" FROM "+r[1],3===r.length&&(i+=" FOR "+r[2]),i+=")"}case"extract":return"EXTRACT("+r[0].replace(/\'/g,"")+" FROM "+r[1]+")"}throw new n.SqlError(n.SqlErrorCodes.InvalidFunctionParameters,{function:e})}function u(e,r){var a=e instanceof Date?s.DateTime.fromJSDate(e):s.DateTime.fromSQL(e),n=0===a.hour&&0===a.minute&&0===a.second&&0===a.millisecond;switch(r){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:return n?"date '"+a.toFormat("yyyy-LL-dd")+"'":"date '"+a.toFormat("yyyy-LL-dd HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.Oracle:return n?"TO_DATE('"+a.toFormat("yyyy-LL-dd")+"','YYYY-MM-DD')":"TO_DATE('"+a.toFormat("yyyy-LL-dd HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case t.FeatureServiceDatabaseType.SqlServer:return"'"+a.toFormat(n?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")+"'";case t.FeatureServiceDatabaseType.PGDB:return"#"+a.toFormat(n?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")+"#";case t.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+a.toFormat(n?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")+"'";default:return"date '"+a.toFormat("yyyy-LL-dd HH:mm:ss")+"'"}}function l(e,r){switch(r){case t.FeatureServiceDatabaseType.FILEGDB:case t.FeatureServiceDatabaseType.Standardised:case t.FeatureServiceDatabaseType.StandardisedNoInterval:case t.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case t.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case t.FeatureServiceDatabaseType.PGDB:case t.FeatureServiceDatabaseType.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}Object.defineProperty(r,"__esModule",{value:!0}),r.convertIntervalToSql=r.isSingleField=r.scanForField=r.predictType=r.makeToday=r.makeDateString=r.translateFunctionToDatabaseSpecific=r.combine=r.reformulateWithoutField=r.toWhereClauseFromTree=r.toWhereClause=void 0,r.toWhereClause=o,r.toWhereClauseFromTree=function(e,r,t){return i(e,r,t)},r.reformulateWithoutField=function(e,r,n,s){return a.WhereClause.create(i(e.parseTree,t.FeatureServiceDatabaseType.Standardised,e.parameters,r,n),s)},r.combine=function(e,r,n){return void 0===n&&(n="AND"),a.WhereClause.create("(("+o(e,t.FeatureServiceDatabaseType.Standardised)+")"+n+"("+o(r,t.FeatureServiceDatabaseType.Standardised)+"))",e.fieldsIndex)},r.translateFunctionToDatabaseSpecific=c,r.makeDateString=u,r.makeToday=l,r.predictType=function(e,r,t){void 0===t&&(t={});for(var a={},s={},o={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"},i=0,c=r;i<c.length;i++){var u=(l=c[i]).type?o[l.type]:void 0;a[l.name.toLowerCase()]=void 0===u?"":u}for(var l in t){u=o[t[l]];s[l.toLowerCase()]=void 0===u?"":u}switch(function e(r,t,a,s){var o;switch(t.type){case"interval":return"integer";case"case-expression":var i=[];if("simple"===t.format){for(var c=0;c<t.clauses.length;c++)i.push(e(r,t.clauses[c].value,a,s));null!==t.else&&i.push(e(r,t.else,a,s))}else{for(c=0;c<t.clauses.length;c++)i.push(e(r,t.else,a,s));null!==t.else&&i.push(e(r,t.else,a,s))}return p(i);case"parameter":var u=s[t.value.toLowerCase()];if(void 0===u&&a){var l=a[t.value.toLowerCase()];if(void 0===l)return"";if(null===l)return"";if("string"==typeof l||l instanceof String)return"string";if("boolean"==typeof l)return"boolean";if(l instanceof Date)return"date";if("number"==typeof l)return l%1==0?"integer":"double"}return void 0===u?"":u;case"expression-list":for(var d=[],f=0,S=t.value;f<S.length;f++){var g=S[f];d.push(e(r,g,a,s))}return d;case"unary-expression":return"boolean";case"binary-expression":switch(t.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==t.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return p([e(r,t.left,a,s),e(r,t.right,a,s)]);default:throw new n.SqlError(n.SqlErrorCodes.UnsupportedOperator,{operator:t.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===t.value?"":t.value%1==0?"integer":"double";case"date":case"timestamp":case"current-time":return"date";case"column-reference":var h=r[t.column.toLowerCase()];return void 0===h?"":h;case"function":switch(t.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return(o=e(r,t.args,a,s))instanceof Array?o.length>0?o[0]:"":o;case"sign":return(o=e(r,t.args,a,s))instanceof Array&&(o=p(o)),"integer"===o||"double"===o?o:"double";case"ceiling":case"floor":case"abs":var v=e(r,t.args,a,s);return v instanceof Array?p(v):v;case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double"}return""}throw new n.SqlError(n.SqlErrorCodes.UnsupportedSyntax,{node:t.type})}(a,e.parseTree,e.parameters,s)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"string":return"string"}return""};var d={boolean:1,string:2,integer:3,double:4,date:5};function p(e){if(e){for(var r="",t=0,a=e;t<a.length;t++){var n=a[t];""!==n&&(r=""===r?n:d[r]<d[n]?n:r)}return r}return""}function f(e){var r="";return r+=e.period.toUpperCase()}function S(e,r,t){return"INTERVAL "+t+" "+e+" "+("interval-period"===r.type?f(r):f(r.start)+" TO "+f(r.end))}r.scanForField=function(e,r){return function e(r,t){if(null==r)return!1;switch(r.type){case"when-clause":return e(r.operand,t)||e(r.value,t);case"case-expression":for(var a=0,n=r.clauses;a<n.length;a++){var s=n[a];if(e(s,t))return!0}return!("simple"!==r.format||!e(r.operand,t))||!(null===r.else||!e(r.else,t));case"parameter":return!1;case"expression-list":for(var o=0,i=r.value;o<i.length;o++){s=i[o];if(e(s,t))return!0}return!1;case"unary-expression":return e(r.expr,t);case"binary-expression":return e(r.left,t)||e(r.right,t);case"null":case"boolean":case"date":case"timestamp":case"string":case"number":return!1;case"column-reference":return t.toLowerCase()===r.column.toLowerCase();case"function":return e(r.args,t)}return!1}(e.parseTree,r)},r.isSingleField=function(e){return"column-reference"===(null==e?void 0:e.parseTree.type)},r.convertIntervalToSql=S}));