/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","./FeatureSetIterator","./IdSet","./shared","./cache","./stats","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/geometryEngineAsync","../../../geometry/SpatialReference","../../../layers/support/FieldsIndex"],(function(e,t,n,i,r,s,a,u,c,l,h){"use strict";let o=function(){function o(e){this.recentlyUsedQueries=null,this.featureSetQueryInterceptor=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=i.FeatureServiceDatabaseType.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache),e&&e.interceptor&&(this.featureSetQueryInterceptor=e.interceptor)}var d=o.prototype;return d.optimisePagingFeatureQueries=function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)},d._hasMemorySource=function(){return!0},d.prop=function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)},d.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent},d._ensureLoaded=function(){return this.load()},d.load=function(){return null===this._loadPromise&&(this._loadPromise=a.create(((e,t)=>{if(!0===this._parent.loaded)return this._initialiseFeatureSet(),void e(this);this._parent.load().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(n){t(n)}}),t)}))),this._loadPromise},d._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new l({wkid:4326}),this.geometryType=i.layerGeometryEsriConstants.point)},d.getField=function(e,t){let n;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((t=>(t&&t.name.toLowerCase()===e&&(n=t),!!n)))),n},d.getFieldsIndex=function(){return null===this._fieldsIndex&&(this._fieldsIndex=new h(this.fields)),this._fieldsIndex},d._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())},d._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery},d._checkCancelled=function(e){if(null!==e&&e.aborted)throw new Error("Operation has been cancelled.")},d.nativeCapabilities=function(){return this._parent.nativeCapabilities()},d._canDoAggregates=function(e,t,n,i,r){return null===this._parent?a.resolve(!1):this._parent._canDoAggregates(e,t,n,i,r)},d._getAggregatePagesDataSourceDefinition=function(e,t,n,i,r,s,u){return null===this._parent?a.reject(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,n,i,r,s,u)},d._getAgregagtePhysicalPage=function(e,t,n){return null===this._parent?a.reject(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,t,n)},d.databaseType=function(){if(this._databaseType===i.FeatureServiceDatabaseType.NotEvaluated){if(null!==r.applicationCache){const e=r.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==e)return e}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;const e=[{thetype:i.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:i.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:i.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];let t=a.create(((t,n)=>{this._getDatabaseTypeImpl(e,0).then((e=>{this._databaseType=e,t(this._databaseType)}),(e=>{n(e)}))}));return null!==r.applicationCache&&(r.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),t),t=t.catch((e=>{throw r.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}))),this._databaseTypeProbed=t,this._databaseTypeProbed}return a.resolve(this._databaseType)},d._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"},d._getDatabaseTypeImpl=function(e,t){return t>=e.length?a.resolve(i.FeatureServiceDatabaseType.StandardisedNoInterval):this._runDatabaseProbe(e[t].testwhere).then((n=>!0===n?e[t].thetype:this._getDatabaseTypeImpl(e,t+1)))},d._runDatabaseProbe=function(e){return null!==this._parent?this._parent._runDatabaseProbe(e):a.reject(new Error("Not Implemented"))},d.isTable=function(){return this._parent.isTable()},d._featureFromCache=function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]},d._isInFeatureSet=function(e){return i.IdState.Unknown},d._getSet=function(e){throw new Error("Not implemented in abstract class")},d._getFeature=function(e,t,n){try{return this._checkCancelled(n),void 0!==this._featureFromCache(t)?a.resolve(this._featureFromCache(t)):this._getFeatures(e,t,this._maxProcessingRate(),n).then((()=>(this._checkCancelled(n),void 0!==this._featureFromCache(t)?this._featureFromCache(t):a.reject(new Error("Feature Not Found")))))}catch(i){return a.reject(i)}},d._getFeatureBatch=function(e,t){try{this._checkCancelled(t);const i=new n([],e,!1,null),r=[];return this._getFeatures(i,-1,e.length,t).then((()=>{this._checkCancelled(t);for(const t of e)void 0!==this._featureFromCache(t)&&r.push(this._featureFromCache(t));return r}))}catch(i){return a.reject(i)}},d._getFeatures=function(e,t,n,i){return a.resolve("success")},d._getFilteredSet=function(e,t,n,i,r){throw new Error("Not implemented in abstract class")},d._refineSetBlock=function(e,t,n){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return this._expandPagedSet(e,this._maxQueryRate(),0,0,n).then((()=>this._refineSetBlock(e,t,n)));this._checkCancelled(n);const i=e._candidates.length;this._refineKnowns(e,t);let r=i-e._candidates.length;return 0===e._candidates.length||r>=t?a.resolve(e):this._refineIfParentKnown(e,t-r,n).then((()=>{if(this._checkCancelled(n),this._refineKnowns(e,t-r),r=i-e._candidates.length,r<t&&e._candidates.length>0){const i=t-r,s=this._prepareFetchAndRefineSet(e._candidates);return this._fetchAndRefineFeatures(s,s.length>i?i:e._candidates.length,n).then((()=>(this._checkCancelled(n),this._refineKnowns(e,t-r),e)))}return e}))}catch(i){return a.reject(i)}},d._fetchAndRefineFeatures=function(e,t,n){return null},d._prepareFetchAndRefineSet=function(e){const t=[];for(let n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&t.push(e[n]);return t},d._isPhysicalFeature=function(e){return null===this._parent||this._parent._isPhysicalFeature(e)},d._refineKnowns=function(e,t){let n=0,r=null;const s=[];t=this._maxQueryRate();for(let a=0;a<e._candidates.length&&"GETPAGES"!==e._candidates[a];a++){let u=!1;const c=this._candidateIdTransform(e._candidates[a]);c!==e._candidates[a]&&(u=!0);const l=this._isInFeatureSet(c);if(l===i.IdState.InFeatureSet)!0===u?e._known.indexOf(c)<0&&(e._known.push(c),n+=1):(e._known.push(e._candidates[a]),n+=1),null===r?r={start:a,end:a}:r.end===a-1?r.end=a:(s.push(r),r={start:a,end:a});else if(l===i.IdState.NotInFeatureSet)null===r?r={start:a,end:a}:r.end===a-1?r.end=a:(s.push(r),r={start:a,end:a}),n+=1;else if(l===i.IdState.Unknown&&(n+=1,!0===e._ordered))break;if(n>=t)break}null!==r&&s.push(r);for(let i=s.length-1;i>=0;i--)e._candidates.splice(s[i].start,s[i].end-s[i].start+1)},d._refineIfParentKnown=function(e,t,i){const r=new n([],[],e._ordered,null);return r._candidates=e._candidates.slice(0),this._parent._refineSetBlock(r,t,i)},d._candidateIdTransform=function(e){return this._parent._candidateIdTransform(e)},d._checkIfNeedToExpandKnownPage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let i=e._lastFetchedIndex;i<e._known.length;i++){if("GETPAGES"===e._known[i])return!0;if(void 0===this._featureCache[e._known[i]]&&(n+=1,n>=t))break}return!1},d._checkIfNeedToExpandCandidatePage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let i=0;i<e._candidates.length;i++){if("GETPAGES"===e._candidates[i])return!0;if(n+=1,n>=t)break}return!1},d._expandPagedSet=function(e,t,n,i,r){return null===this._parent?a.reject(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,t,n,i,r)},d._expandPagedSetFeatureSet=function(e,t,n,i,r){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(i=1),0===i&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(i=2),0===i?a.resolve("finished"):this._getPage(e,i,r).then((i=>n+i<t?this._expandPagedSet(e,t,n+i,0,r):"success"))},d._getPage=function(e,t,n){const i=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){i.length=i.length-1;let t=0;for(let r=0;r<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+r>=e.pagesDefinition.internal.set.length);r++)i[i.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+r],t++;e.pagesDefinition.resultOffset+=t;let n=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(n=!0),!1===n&&i.push("GETPAGES"),a.resolve(t)}return this._getPhysicalPage(e,t,n).then((()=>this._getPage(e,t,n)))},d._getPhysicalPage=function(e,t,n){return null},d._clonePageDefinition=function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)},d._first=function(e){return this.iterator(e).next()},d.first=function(e){return this._first(e)},d.calculateStatistic=function(e,t,n,i){return this._ensureLoaded().then((()=>this._stat(e,t,"",null,null,n,i).then((r=>!1===r.calculated?this._manualStat(e,t,n,i).then((e=>e.result)):r.result))))},d._manualStat=function(e,t,n,i){switch(e.toLowerCase()){case"count":return s.count(this,i).then((e=>({calculated:!0,result:e})));case"distinct":return s.distinct(this,t,n).then((e=>({calculated:!0,result:e})));case"avg":case"mean":return s.mean(this,t,i).then((e=>({calculated:!0,result:e})));case"stdev":return s.stdev(this,t,i).then((e=>({calculated:!0,result:e})));case"variance":return s.variance(this,t,i).then((e=>({calculated:!0,result:e})));case"sum":return s.sum(this,t,i).then((e=>({calculated:!0,result:e})));case"min":return s.min(this,t,i).then((e=>({calculated:!0,result:e})));case"max":return s.max(this,t,i).then((e=>({calculated:!0,result:e})));default:return a.resolve({calculated:!0,result:0})}},d._stat=function(e,t,n,i,r,s,a){return this._parent._stat(e,t,n,i,r,s,a).then((u=>!1===u.calculated?null===r&&""===n&&null===i?this._manualStat(e,t,s,a):{calculated:!1}:u))},d._unionAllGeomSelf=function(e){const t=this.iterator(this._defaultTracker(e)),n=[];return a.create(((e,i)=>{this._unionShapeInBatches(n,t,e,i)}))},d._unionAllGeom=function(e){return a.create(((t,n)=>{const i=this.iterator(this._defaultTracker(e)),r=[];this._unionShapeInBatches(r,i,t,n)}))},d._unionShapeInBatches=function(e,t,n,i){t.next().then((r=>{try{null!==r&&null!==r.geometry&&e.push(r.geometry),e.length>30||null===r&&e.length>1?c.union(e).then((s=>{try{null===r?n(s):(e=[s],this._unionShapeInBatches(e,t,n,i))}catch(a){i(a)}}),i):null===r?1===e.length?n(e[0]):n(null):this._unionShapeInBatches(e,t,n,i)}catch(s){i(s)}}),i)},d.iterator=function(e){return new t(this,e)},d.intersection=function(e,t=!1){return o._featuresetFunctions.intersection.bind(this)(e,t)},d.difference=function(e,t=!1,n=!0){return o._featuresetFunctions.difference.bind(this)(e,t,n)},d.symmetricDifference=function(e,t=!1,n=!0){return o._featuresetFunctions.symmetricDifference.bind(this)(e,t,n)},d.morphShape=function(e,t,n="unknown",i=null){return o._featuresetFunctions.morphShape.bind(this)(e,t,n,i)},d.morphShapeAndAttributes=function(e,t,n="unknown"){return o._featuresetFunctions.morphShapeAndAttributes.bind(this)(e,t,n)},d.union=function(e,t=!1){return o._featuresetFunctions.union.bind(this)(e,t)},d.intersects=function(e){return o._featuresetFunctions.intersects.bind(this)(e)},d.envelopeIntersects=function(e){return o._featuresetFunctions.envelopeIntersects.bind(this)(e)},d.contains=function(e){return o._featuresetFunctions.contains.bind(this)(e)},d.overlaps=function(e){return o._featuresetFunctions.overlaps.bind(this)(e)},d.relate=function(e,t){return o._featuresetFunctions.relate.bind(this)(e,t)},d.within=function(e){return o._featuresetFunctions.within.bind(this)(e)},d.touches=function(e){return o._featuresetFunctions.touches.bind(this)(e)},d.top=function(e){return o._featuresetFunctions.top.bind(this)(e)},d.crosses=function(e){return o._featuresetFunctions.crosses.bind(this)(e)},d.buffer=function(e,t,n,i=!0){return o._featuresetFunctions.buffer.bind(this)(e,t,n,i)},d.filter=function(e,t=null){return o._featuresetFunctions.filter.bind(this)(e,t)},d.orderBy=function(e){return o._featuresetFunctions.orderBy.bind(this)(e)},d.dissolve=function(e,t){return o._featuresetFunctions.dissolve.bind(this)(e,t)},d.groupby=function(e,t){return o._featuresetFunctions.groupby.bind(this)(e,t)},d.reduce=function(e,t=null,n){return a.create(((i,r)=>{this._reduceImpl(this.iterator(this._defaultTracker(n)),e,t,0,i,r,0)}))},d._reduceImpl=function(e,t,n,i,r,s,u){try{if(++u>1e3)return void setTimeout((()=>{u=0,this._reduceImpl(e,t,n,i,r,s,u)}));e.next().then((c=>{try{if(null===c)r(n);else{const l=t(n,c,i,this);a.isPromiseLike(l)?l.then((n=>{this._reduceImpl(e,t,n,i+1,r,s,u)}),s):this._reduceImpl(e,t,l,i+1,r,s,u)}}catch(l){s(l)}}),s)}catch(c){s(c)}},d.removeField=function(e){return o._featuresetFunctions.removeField.bind(this)(e)},d.addField=function(e,t,n=null){return o._featuresetFunctions.addField.bind(this)(e,t,n)},d.sumArea=function(e,t=!1,n){const r=i.convertSquareUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?c.geodesicArea(n.geometry,r).then((t=>e+t)):c.planarArea(n.geometry,r).then((t=>e+t))),0,n)},d.sumLength=function(e,t=!1,n){const r=i.convertLinearUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?c.geodesicLength(n.geometry,r).then((t=>e+t)):c.planarLength(n.geometry,r).then((t=>e+t))),0,n)},d._substituteVars=function(e,t){if(null!==t){const n={};for(const e in t)n[e.toLowerCase()]=t[e];e.parameters=n}},d.distinct=function(e,t=1e3,n=null,i){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,n),this.calculateStatistic("distinct",r,t,this._defaultTracker(i))}))},d.min=function(e,t=null,n){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("min",i,-1,this._defaultTracker(n))}))},d.max=function(e,t=null,n){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("max",i,-1,this._defaultTracker(n))}))},d.avg=function(e,t=null,n){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("avg",i,-1,this._defaultTracker(n))}))},d.sum=function(e,t=null,n){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("sum",i,-1,this._defaultTracker(n))}))},d.stdev=function(e,t=null,n){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("stdev",i,-1,this._defaultTracker(n))}))},d.variance=function(e,t=null,n){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("variance",i,-1,this._defaultTracker(n))}))},d.count=function(e){return this.load().then((()=>this.calculateStatistic("count",u.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(e))))},d._defaultTracker=function(e){return e||{aborted:!1}},d.forEach=function(e,t){return a.create(((n,i)=>{this._forEachImpl(this.iterator(this._defaultTracker(t)),e,this,n,i,0)}))},d._forEachImpl=function(e,t,n,i,r,s){try{if(++s>1e3)return void setTimeout((()=>{s=0,this._forEachImpl(e,t,n,i,r,s)}),0);e.next().then((u=>{try{if(null===u)i(n);else{const c=t(u);null==c?this._forEachImpl(e,t,n,i,r,s):a.isPromiseLike(c)?c.then((()=>{try{this._forEachImpl(e,t,n,i,r,s)}catch(a){r(a)}}),r):this._forEachImpl(e,t,n,i,r,s)}}catch(c){r(c)}}),r)}catch(u){r(u)}},d.convertToJSON=function(e){const t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let n=0;n<this.fields.length;n++)t.layerDefinition.fields.push(i.esriFieldToJson(this.fields[n]));return this.reduce(((e,n)=>{const i={geometry:n.geometry&&n.geometry.toJSON(),attributes:{}};for(const t in n.attributes)i.attributes[t]=n.attributes[t];return t.featureSet.features.push(i),1}),0,e).then((()=>t))},d.castToText=function(){return"object, FeatureSet"},d.queryAttachments=function(e,t,n,i){return this._parent.queryAttachments(e,t,n,i)},d.serviceUrl=function(){return this._parent.serviceUrl()},d.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((e=>({name:e.name,code:e.id}))):[]}:null},d.relationshipMetaData=function(){return this._parent.relationshipMetaData()},d.schema=function(){const e=[];for(const n of this.fields)e.push(i.esriFieldToJson(n));const t={objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===i.layerGeometryEsriRestConstants[this.geometryType]?"":i.layerGeometryEsriRestConstants[this.geometryType],fields:e};return t},d.convertToText=function(e,t){return"schema"===e?this._ensureLoaded().then((()=>JSON.stringify(this.schema()))):"featureset"===e?this._ensureLoaded().then((()=>{const e=[];return this.reduce(((t,n)=>{const i={geometry:n.geometry?n.geometry.toJSON():null,attributes:n.attributes};return null!==i.geometry&&i.geometry.spatialReference&&delete i.geometry.spatialReference,e.push(i),1}),0,t).then((()=>{const t=this.schema();return t.features=e,t.spatialReference=this.spatialReference.toJSON(),JSON.stringify(t)}))})):a.resolve(this.castToText())},d.getFeatureByObjectId=function(e,t){return this._parent.getFeatureByObjectId(e,t)},d.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()},d.getIdentityUser=function(){return this._parent.getIdentityUser()},e._createClass(o,[{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}}]),o}();return o._featuresetFunctions={},o}));
