/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","./FeatureSetIterator","./IdSet","./shared","./cache","./stats","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/geometryEngineAsync","../../../geometry/SpatialReference","../../../layers/support/FieldsIndex"],(function(e,t,n,r,i,s,a,u,l,c,o){"use strict";let h=function(){function h(e){this.recentlyUsedQueries=null,this.featureSetQueryInterceptor=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=r.FeatureServiceDatabaseType.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache),e&&e.interceptor&&(this.featureSetQueryInterceptor=e.interceptor)}var d=h.prototype;return d.optimisePagingFeatureQueries=function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)},d._hasMemorySource=function(){return!0},d.prop=function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)},d.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent},d._ensureLoaded=function(){return this.load()},d.load=function(){return null===this._loadPromise&&(this._loadPromise=a.create(((e,t)=>{if(!0===this._parent.loaded)return this._initialiseFeatureSet(),void e(this);this._parent.load().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(n){t(n)}}),t)}))),this._loadPromise},d._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new c({wkid:4326}),this.geometryType=r.layerGeometryEsriConstants.point)},d.getField=function(e,t){let n;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((t=>(t&&t.name.toLowerCase()===e&&(n=t),!!n)))),n},d.getFieldsIndex=function(){return null===this._fieldsIndex&&(this._fieldsIndex=new o(this.fields)),this._fieldsIndex},d._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())},d._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery},d._checkCancelled=function(e){if(null!==e&&e.aborted)throw new Error("Operation has been cancelled.")},d.nativeCapabilities=function(){return this._parent.nativeCapabilities()},d._canDoAggregates=function(e,t,n,r,i){return null===this._parent?a.resolve(!1):this._parent._canDoAggregates(e,t,n,r,i)},d._getAggregatePagesDataSourceDefinition=function(e,t,n,r,i,s,u){return null===this._parent?a.reject(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,n,r,i,s,u)},d._getAgregagtePhysicalPage=function(e,t,n){return null===this._parent?a.reject(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,t,n)},d.databaseType=function(){if(this._databaseType===r.FeatureServiceDatabaseType.NotEvaluated){if(null!==i.applicationCache){const e=i.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==e)return e}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;const e=[{thetype:r.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:r.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:r.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];let t=a.create(((t,n)=>{this._getDatabaseTypeImpl(e,0).then((e=>{this._databaseType=e,t(this._databaseType)}),(e=>{n(e)}))}));return null!==i.applicationCache&&(i.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),t),t=t.catch((e=>{throw i.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}))),this._databaseTypeProbed=t,this._databaseTypeProbed}return a.resolve(this._databaseType)},d._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"},d._getDatabaseTypeImpl=function(e,t){return t>=e.length?a.resolve(r.FeatureServiceDatabaseType.StandardisedNoInterval):this._runDatabaseProbe(e[t].testwhere).then((n=>!0===n?e[t].thetype:this._getDatabaseTypeImpl(e,t+1)))},d._runDatabaseProbe=function(e){return null!==this._parent?this._parent._runDatabaseProbe(e):a.reject(new Error("Not Implemented"))},d.isTable=function(){return this._parent.isTable()},d._featureFromCache=function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]},d._isInFeatureSet=function(e){return r.IdState.Unknown},d._getSet=function(e){throw new Error("Not implemented in abstract class")},d._getFeature=function(e,t,n){try{return this._checkCancelled(n),void 0!==this._featureFromCache(t)?a.resolve(this._featureFromCache(t)):this._getFeatures(e,t,this._maxProcessingRate(),n).then((()=>(this._checkCancelled(n),void 0!==this._featureFromCache(t)?this._featureFromCache(t):a.reject(new Error("Feature Not Found")))))}catch(r){return a.reject(r)}},d._getFeatureBatch=function(e,t){try{this._checkCancelled(t);const r=new n([],e,!1,null),i=[];return this._getFeatures(r,-1,e.length,t).then((()=>{this._checkCancelled(t);for(const t of e)void 0!==this._featureFromCache(t)&&i.push(this._featureFromCache(t));return i}))}catch(r){return a.reject(r)}},d._getFeatures=function(e,t,n,r){return a.resolve("success")},d._getFilteredSet=function(e,t,n,r,i){throw new Error("Not implemented in abstract class")},d._refineSetBlock=function(e,t,n){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return this._expandPagedSet(e,this._maxQueryRate(),0,0,n).then((()=>this._refineSetBlock(e,t,n)));this._checkCancelled(n);const r=e._candidates.length;this._refineKnowns(e,t);let i=r-e._candidates.length;return 0===e._candidates.length||i>=t?a.resolve(e):this._refineIfParentKnown(e,t-i,n).then((()=>{if(this._checkCancelled(n),this._refineKnowns(e,t-i),i=r-e._candidates.length,i<t&&e._candidates.length>0){const r=t-i,s=this._prepareFetchAndRefineSet(e._candidates);return this._fetchAndRefineFeatures(s,s.length>r?r:e._candidates.length,n).then((()=>(this._checkCancelled(n),this._refineKnowns(e,t-i),e)))}return e}))}catch(r){return a.reject(r)}},d._fetchAndRefineFeatures=function(e,t,n){return null},d._prepareFetchAndRefineSet=function(e){const t=[];for(let n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&t.push(e[n]);return t},d._isPhysicalFeature=function(e){return null===this._parent||this._parent._isPhysicalFeature(e)},d._refineKnowns=function(e,t){let n=0,i=null;const s=[];t=this._maxQueryRate();for(let a=0;a<e._candidates.length&&"GETPAGES"!==e._candidates[a];a++){let u=!1;const l=this._candidateIdTransform(e._candidates[a]);l!==e._candidates[a]&&(u=!0);const c=this._isInFeatureSet(l);if(c===r.IdState.InFeatureSet)!0===u?e._known.indexOf(l)<0&&(e._known.push(l),n+=1):(e._known.push(e._candidates[a]),n+=1),null===i?i={start:a,end:a}:i.end===a-1?i.end=a:(s.push(i),i={start:a,end:a});else if(c===r.IdState.NotInFeatureSet)null===i?i={start:a,end:a}:i.end===a-1?i.end=a:(s.push(i),i={start:a,end:a}),n+=1;else if(c===r.IdState.Unknown&&(n+=1,!0===e._ordered))break;if(n>=t)break}null!==i&&s.push(i);for(let r=s.length-1;r>=0;r--)e._candidates.splice(s[r].start,s[r].end-s[r].start+1)},d._refineIfParentKnown=function(e,t,r){const i=new n([],[],e._ordered,null);return i._candidates=e._candidates.slice(0),this._parent._refineSetBlock(i,t,r)},d._candidateIdTransform=function(e){return this._parent._candidateIdTransform(e)},d._checkIfNeedToExpandKnownPage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let r=e._lastFetchedIndex;r<e._known.length;r++){if("GETPAGES"===e._known[r])return!0;if(void 0===this._featureCache[e._known[r]]&&(n+=1,n>=t))break}return!1},d._checkIfNeedToExpandCandidatePage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let r=0;r<e._candidates.length;r++){if("GETPAGES"===e._candidates[r])return!0;if(n+=1,n>=t)break}return!1},d._expandPagedSet=function(e,t,n,r,i){return null===this._parent?a.reject(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,t,n,r,i)},d._expandPagedSetFeatureSet=function(e,t,n,r,i){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(r=1),0===r&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(r=2),0===r?a.resolve("finished"):this._getPage(e,r,i).then((r=>n+r<t?this._expandPagedSet(e,t,n+r,0,i):"success"))},d._getPage=function(e,t,n){const r=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){r.length=r.length-1;let t=0;for(let i=0;i<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+i>=e.pagesDefinition.internal.set.length);i++)r[r.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+i],t++;e.pagesDefinition.resultOffset+=t;let n=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(n=!0),!1===n&&r.push("GETPAGES"),a.resolve(t)}return this._getPhysicalPage(e,t,n).then((()=>this._getPage(e,t,n)))},d._getPhysicalPage=function(e,t,n){return null},d._clonePageDefinition=function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)},d._first=function(e){return this.iterator(e).next()},d.first=function(e){return this._first(e)},d.calculateStatistic=function(e,t,n,r){return this._ensureLoaded().then((()=>this._stat(e,t,"",null,null,n,r).then((i=>!1===i.calculated?this._manualStat(e,t,n,r).then((e=>e.result)):i.result))))},d._manualStat=function(e,t,n,r){switch(e.toLowerCase()){case"count":return s.count(this,r).then((e=>({calculated:!0,result:e})));case"distinct":return s.distinct(this,t,n).then((e=>({calculated:!0,result:e})));case"avg":case"mean":return s.mean(this,t,r).then((e=>({calculated:!0,result:e})));case"stdev":return s.stdev(this,t,r).then((e=>({calculated:!0,result:e})));case"variance":return s.variance(this,t,r).then((e=>({calculated:!0,result:e})));case"sum":return s.sum(this,t,r).then((e=>({calculated:!0,result:e})));case"min":return s.min(this,t,r).then((e=>({calculated:!0,result:e})));case"max":return s.max(this,t,r).then((e=>({calculated:!0,result:e})));default:return a.resolve({calculated:!0,result:0})}},d._stat=function(e,t,n,r,i,s,a){return this._parent._stat(e,t,n,r,i,s,a).then((u=>!1===u.calculated?null===i&&""===n&&null===r?this._manualStat(e,t,s,a):{calculated:!1}:u))},d._unionAllGeomSelf=function(e){const t=this.iterator(this._defaultTracker(e)),n=[];return a.create(((e,r)=>{this._unionShapeInBatches(n,t,e,r)}))},d._unionAllGeom=function(e){return a.create(((t,n)=>{const r=this.iterator(this._defaultTracker(e)),i=[];this._unionShapeInBatches(i,r,t,n)}))},d._unionShapeInBatches=function(e,t,n,r){t.next().then((i=>{try{null!==i&&null!==i.geometry&&e.push(i.geometry),e.length>30||null===i&&e.length>1?l.union(e).then((s=>{try{null===i?n(s):(e=[s],this._unionShapeInBatches(e,t,n,r))}catch(a){r(a)}}),r):null===i?1===e.length?n(e[0]):n(null):this._unionShapeInBatches(e,t,n,r)}catch(s){r(s)}}),r)},d.iterator=function(e){return new t(this,e)},d.intersection=function(e,t=!1){return h._featuresetFunctions.intersection.bind(this)(e,t)},d.difference=function(e,t=!1,n=!0){return h._featuresetFunctions.difference.bind(this)(e,t,n)},d.symmetricDifference=function(e,t=!1,n=!0){return h._featuresetFunctions.symmetricDifference.bind(this)(e,t,n)},d.morphShape=function(e,t,n="unknown",r=null){return h._featuresetFunctions.morphShape.bind(this)(e,t,n,r)},d.morphShapeAndAttributes=function(e,t,n="unknown"){return h._featuresetFunctions.morphShapeAndAttributes.bind(this)(e,t,n)},d.union=function(e,t=!1){return h._featuresetFunctions.union.bind(this)(e,t)},d.intersects=function(e){return h._featuresetFunctions.intersects.bind(this)(e)},d.envelopeIntersects=function(e){return h._featuresetFunctions.envelopeIntersects.bind(this)(e)},d.contains=function(e){return h._featuresetFunctions.contains.bind(this)(e)},d.overlaps=function(e){return h._featuresetFunctions.overlaps.bind(this)(e)},d.relate=function(e,t){return h._featuresetFunctions.relate.bind(this)(e,t)},d.within=function(e){return h._featuresetFunctions.within.bind(this)(e)},d.touches=function(e){return h._featuresetFunctions.touches.bind(this)(e)},d.top=function(e){return h._featuresetFunctions.top.bind(this)(e)},d.crosses=function(e){return h._featuresetFunctions.crosses.bind(this)(e)},d.buffer=function(e,t,n,r=!0){return h._featuresetFunctions.buffer.bind(this)(e,t,n,r)},d.filter=function(e,t=null){return h._featuresetFunctions.filter.bind(this)(e,t)},d.orderBy=function(e){return h._featuresetFunctions.orderBy.bind(this)(e)},d.dissolve=function(e,t){return h._featuresetFunctions.dissolve.bind(this)(e,t)},d.groupby=function(e,t){return h._featuresetFunctions.groupby.bind(this)(e,t)},d.reduce=function(e,t=null,n){return a.create(((r,i)=>{this._reduceImpl(this.iterator(this._defaultTracker(n)),e,t,0,r,i,0)}))},d._reduceImpl=function(e,t,n,r,i,s,u){try{if(++u>1e3)return void setTimeout((()=>{u=0,this._reduceImpl(e,t,n,r,i,s,u)}));e.next().then((l=>{try{if(null===l)i(n);else{const c=t(n,l,r,this);a.isPromiseLike(c)?c.then((n=>{this._reduceImpl(e,t,n,r+1,i,s,u)}),s):this._reduceImpl(e,t,c,r+1,i,s,u)}}catch(c){s(c)}}),s)}catch(l){s(l)}},d.removeField=function(e){return h._featuresetFunctions.removeField.bind(this)(e)},d.addField=function(e,t,n=null){return h._featuresetFunctions.addField.bind(this)(e,t,n)},d.sumArea=function(e,t=!1,n){const i=r.convertSquareUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?l.geodesicArea(n.geometry,i).then((t=>e+t)):l.planarArea(n.geometry,i).then((t=>e+t))),0,n)},d.sumLength=function(e,t=!1,n){const i=r.convertLinearUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?l.geodesicLength(n.geometry,i).then((t=>e+t)):l.planarLength(n.geometry,i).then((t=>e+t))),0,n)},d._substituteVars=function(e,t){if(null!==t){const n={};for(const e in t)n[e.toLowerCase()]=t[e];e.parameters=n}},d.distinct=function(e,t=1e3,n=null,r){return this.load().then((()=>{const i=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,n),this.calculateStatistic("distinct",i,t,this._defaultTracker(r))}))},d.min=function(e,t=null,n){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("min",r,-1,this._defaultTracker(n))}))},d.max=function(e,t=null,n){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("max",r,-1,this._defaultTracker(n))}))},d.avg=function(e,t=null,n){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("avg",r,-1,this._defaultTracker(n))}))},d.sum=function(e,t=null,n){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("sum",r,-1,this._defaultTracker(n))}))},d.stdev=function(e,t=null,n){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("stdev",r,-1,this._defaultTracker(n))}))},d.variance=function(e,t=null,n){return this.load().then((()=>{const r=u.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("variance",r,-1,this._defaultTracker(n))}))},d.count=function(e){return this.load().then((()=>this.calculateStatistic("count",u.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(e))))},d._defaultTracker=function(e){return e||{aborted:!1}},d.forEach=function(e,t){return a.create(((n,r)=>{this._forEachImpl(this.iterator(this._defaultTracker(t)),e,this,n,r,0)}))},d._forEachImpl=function(e,t,n,r,i,s){try{if(++s>1e3)return void setTimeout((()=>{s=0,this._forEachImpl(e,t,n,r,i,s)}),0);e.next().then((u=>{try{if(null===u)r(n);else{const l=t(u);null==l?this._forEachImpl(e,t,n,r,i,s):a.isPromiseLike(l)?l.then((()=>{try{this._forEachImpl(e,t,n,r,i,s)}catch(a){i(a)}}),i):this._forEachImpl(e,t,n,r,i,s)}}catch(l){i(l)}}),i)}catch(u){i(u)}},d.convertToJSON=function(e){const t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let n=0;n<this.fields.length;n++)t.layerDefinition.fields.push(r.esriFieldToJson(this.fields[n]));return this.reduce(((e,n)=>{const r={geometry:n.geometry&&n.geometry.toJSON(),attributes:{}};for(const t in n.attributes)r.attributes[t]=n.attributes[t];return t.featureSet.features.push(r),1}),0,e).then((()=>t))},d.castToText=function(){return"object, FeatureSet"},d.queryAttachments=function(e,t,n,r,i){return this._parent.queryAttachments(e,t,n,r,i)},d.serviceUrl=function(){return this._parent.serviceUrl()},d.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((e=>({name:e.name,code:e.id}))):[]}:null},d.relationshipMetaData=function(){return this._parent.relationshipMetaData()},d.schema=function(){const e=[];for(const n of this.fields)e.push(r.esriFieldToJson(n));const t={objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===r.layerGeometryEsriRestConstants[this.geometryType]?"":r.layerGeometryEsriRestConstants[this.geometryType],fields:e};return t},d.convertToText=function(e,t){return"schema"===e?this._ensureLoaded().then((()=>JSON.stringify(this.schema()))):"featureset"===e?this._ensureLoaded().then((()=>{const e=[];return this.reduce(((t,n)=>{const r={geometry:n.geometry?n.geometry.toJSON():null,attributes:n.attributes};return null!==r.geometry&&r.geometry.spatialReference&&delete r.geometry.spatialReference,e.push(r),1}),0,t).then((()=>{const t=this.schema();return t.features=e,t.spatialReference=this.spatialReference.toJSON(),JSON.stringify(t)}))})):a.resolve(this.castToText())},d.getFeatureByObjectId=function(e,t){return this._parent.getFeatureByObjectId(e,t)},d.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()},d.getIdentityUser=function(){return this._parent.getIdentityUser()},d.getRootFeatureSet=function(){return null!==this._parent?this._parent.getRootFeatureSet():this},d.getDataSourceFeatureSet=function(){return null!==this._parent?this._parent.getDataSourceFeatureSet():this},d.castAsJson=function(e=null){return"keeptype"===(null==e?void 0:e.featureset)?this:"none"===(null==e?void 0:e.featureset)?null:{type:"FeatureSet"}},d.castAsJsonAsync=function(e=null,t=null){return"keeptype"===(null==t?void 0:t.featureset)?a.resolve(this):"schema"===(null==t?void 0:t.featureset)?this._ensureLoaded().then((()=>JSON.parse(JSON.stringify(this.schema())))):"none"===(null==t?void 0:t.featureset)?a.resolve(null):this._ensureLoaded().then((()=>{const n=[];return this.reduce(((e,r)=>{const i={geometry:r.geometry?!0===(null==t?void 0:t.keepGeometryType)?r.geometry:r.geometry.toJSON():null,attributes:r.attributes};return null!==i.geometry&&i.geometry.spatialReference&&!0!==(null==t?void 0:t.keepGeometryType)&&delete i.geometry.spatialReference,n.push(i),1}),0,e).then((()=>{const e=this.schema();return e.features=n,e.spatialReference=!0===(null==t?void 0:t.keepGeometryType)?this.spatialReference:this.spatialReference.toJSON(),e}))}))},e._createClass(h,[{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}}]),h}();return h._featuresetFunctions={},h}));
