// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/spreadarray","../../arcadeTimeUtils","./cache","./errorsupport","./FeatureSetIterator","./IdSet","./shared","./stats","../../polyfill/promiseUtils","../../polyfill/sql/WhereClause","../../../geometry/geometryEngineAsync","../../../SpatialReference","../../polyfill/sql/FieldsIndex"],(function(e,t,n,r,i,s,a,o,u,c,l,h,d,p,f,_,y,v){"use strict";return function(){function e(e){this.recentlyUsedQueries=null,this.featureSetQueryInterceptor=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=h.FeatureServiceDatabaseType.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.typeIdField=null,this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,this._dateFieldIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache),e&&e.interceptor&&(this.featureSetQueryInterceptor=e.interceptor)}return e.prototype.optimisePagingFeatureQueries=function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)},e.prototype._hasMemorySource=function(){return!0},e.prototype.prop=function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)},e.prototype.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent},e.prototype._ensureLoaded=function(){return this.load()},e.prototype.load=function(){return null===this._loadPromise&&(this._loadPromise=this.loadImpl()),this._loadPromise},e.prototype.loadImpl=function(){var e,t;return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return!0===(null===(e=this._parent)||void 0===e?void 0:e.loaded)?(this._initialiseFeatureSet(),[2,this]):[4,null===(t=this._parent)||void 0===t?void 0:t.load()];case 1:return n.sent(),this._initialiseFeatureSet(),[2,this]}}))}))},e.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new y({wkid:4326}),this.geometryType=h.layerGeometryEsriConstants.point)},e.prototype.getField=function(e,t){var n;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((function(t){return t&&t.name.toLowerCase()===e&&(n=t),!!n}))),n},e.prototype.getFieldsIndex=function(){return null===this._fieldsIndex&&(this._fieldsIndex=new v(this.fields)),this._fieldsIndex},e.prototype._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())},e.prototype._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery},e.prototype._checkCancelled=function(e){if(null!=e&&e.aborted)throw new u.FeatureSetError(u.FeatureSetErrorCodes.Cancelled)},e.prototype.nativeCapabilities=function(){return this._parent.nativeCapabilities()},e.prototype._canDoAggregates=function(e,t,i,s,a){return n(this,void 0,void 0,(function(){return r(this,(function(n){return null===this._parent?[2,!1]:[2,this._parent._canDoAggregates(e,t,i,s,a)]}))}))},e.prototype._getAggregatePagesDataSourceDefinition=function(e,t,i,s,a,o,c){return n(this,void 0,void 0,(function(){return r(this,(function(n){if(null===this._parent)throw new u.FeatureSetError(u.FeatureSetErrorCodes.NeverReach);return[2,this._parent._getAggregatePagesDataSourceDefinition(e,t,i,s,a,o,c)]}))}))},e.prototype._getAgregagtePhysicalPage=function(e,t,i){return n(this,void 0,void 0,(function(){return r(this,(function(n){if(null===this._parent)throw new u.FeatureSetError(u.FeatureSetErrorCodes.NeverReach);return[2,this._parent._getAgregagtePhysicalPage(e,t,i)]}))}))},e.prototype.databaseType=function(){return n(this,void 0,void 0,(function(){var e;return r(this,(function(t){if(this._databaseType===h.FeatureServiceDatabaseType.NotEvaluated){if(null!==o.applicationCache&&null!==(e=o.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey())))return[2,e];if(null!==this._databaseTypeProbed)return[2,this._databaseTypeProbed];try{this._databaseTypeProbed=this._getDatabaseTypeImpl(),null!==o.applicationCache&&o.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),this._databaseTypeProbed)}catch(e){throw null!==o.applicationCache&&o.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}return[2,this._databaseTypeProbed]}return[2,this._databaseType]}))}))},e.prototype._getDatabaseTypeImpl=function(){return n(this,void 0,void 0,(function(){var e,t,n,i;return r(this,(function(r){switch(r.label){case 0:e=[{thetype:h.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:h.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:h.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}],t=0,n=e,r.label=1;case 1:return t<n.length?(i=n[t],[4,this._runDatabaseProbe(i.testwhere)]):[3,4];case 2:if(!0===r.sent())return[2,i.thetype];r.label=3;case 3:return t++,[3,1];case 4:return[2,h.FeatureServiceDatabaseType.StandardisedNoInterval]}}))}))},e.prototype._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"},e.prototype._runDatabaseProbe=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){if(null!==this._parent)return[2,this._parent._runDatabaseProbe(e)];throw new u.FeatureSetError(u.FeatureSetErrorCodes.NotImplemented)}))}))},e.prototype.isTable=function(){var e,t;return null!==(t=null===(e=this._parent)||void 0===e?void 0:e.isTable())&&void 0!==t&&t},e.prototype._featureFromCache=function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]},e.prototype._isInFeatureSet=function(e){return h.IdState.Unknown},e.prototype._getSet=function(e){throw new u.FeatureSetError(u.FeatureSetErrorCodes.NotImplemented)},e.prototype._getFeature=function(e,t,i){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return this._checkCancelled(i),void 0!==this._featureFromCache(t)?[2,this._featureFromCache(t)]:[4,this._getFeatures(e,t,this._maxProcessingRate(),i)];case 1:if(n.sent(),this._checkCancelled(i),void 0!==this._featureFromCache(t))return[2,this._featureFromCache(t)];throw new u.FeatureSetError(u.FeatureSetErrorCodes.MissingFeatures)}}))}))},e.prototype._getFeatureBatch=function(e,t){return n(this,void 0,void 0,(function(){var n,i,s,a,o;return r(this,(function(r){switch(r.label){case 0:return this._checkCancelled(t),n=new l([],e,!1,null),i=[],[4,this._getFeatures(n,-1,e.length,t)];case 1:for(r.sent(),this._checkCancelled(t),s=0,a=e;s<a.length;s++)o=a[s],void 0!==this._featureFromCache(o)&&i.push(this._featureFromCache(o));return[2,i]}}))}))},e.prototype._getFeatures=function(e,t,i,s){return n(this,void 0,void 0,(function(){return r(this,(function(e){return[2,"success"]}))}))},e.prototype._getFilteredSet=function(e,t,n,r,i){throw new u.FeatureSetError(u.FeatureSetErrorCodes.NotImplemented)},e.prototype._refineSetBlock=function(e,t,i){return n(this,void 0,void 0,(function(){var n,s,a,o;return r(this,(function(r){switch(r.label){case 0:return!0!==this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate())?[3,2]:[4,this._expandPagedSet(e,this._maxQueryRate(),0,0,i)];case 1:return r.sent(),[2,this._refineSetBlock(e,t,i)];case 2:return this._checkCancelled(i),n=e._candidates.length,this._refineKnowns(e,t),s=n-e._candidates.length,0===e._candidates.length?[2,e]:s>=t?[2,e]:[4,this._refineIfParentKnown(e,t-s,i)];case 3:return r.sent(),this._checkCancelled(i),this._refineKnowns(e,t-s),(s=n-e._candidates.length)<t&&e._candidates.length>0?(a=t-s,o=this._prepareFetchAndRefineSet(e._candidates),[4,this._fetchAndRefineFeatures(o,o.length>a?a:e._candidates.length,i)]):[3,5];case 4:return r.sent(),this._checkCancelled(i),this._refineKnowns(e,t-s),[2,e];case 5:return[2,e]}}))}))},e.prototype._fetchAndRefineFeatures=function(e,t,n){return null},e.prototype._prepareFetchAndRefineSet=function(e){for(var t=[],n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&t.push(e[n]);return t},e.prototype._isPhysicalFeature=function(e){return null===this._parent||this._parent._isPhysicalFeature(e)},e.prototype._refineKnowns=function(e,t){var n=0,r=null,i=[];t=this._maxQueryRate();for(var s=0;s<e._candidates.length&&"GETPAGES"!==e._candidates[s];s++){var a=!1,o=this._candidateIdTransform(e._candidates[s]);o!==e._candidates[s]&&(a=!0);var u=this._isInFeatureSet(o);if(u===h.IdState.InFeatureSet)!0===a?e._known.includes(o)||(e._known.push(o),n+=1):(e._known.push(e._candidates[s]),n+=1),null===r?r={start:s,end:s}:r.end===s-1?r.end=s:(i.push(r),r={start:s,end:s});else if(u===h.IdState.NotInFeatureSet)null===r?r={start:s,end:s}:r.end===s-1?r.end=s:(i.push(r),r={start:s,end:s}),n+=1;else if(u===h.IdState.Unknown&&(n+=1,!0===e._ordered))break;if(n>=t)break}null!==r&&i.push(r);for(var c=i.length-1;c>=0;c--)e._candidates.splice(i[c].start,i[c].end-i[c].start+1)},e.prototype._refineIfParentKnown=function(e,t,n){var r=new l([],[],e._ordered,null);return r._candidates=e._candidates.slice(0),this._parent._refineSetBlock(r,t,n)},e.prototype._candidateIdTransform=function(e){return this._parent._candidateIdTransform(e)},e.prototype._checkIfNeedToExpandKnownPage=function(e,t){if(null===e.pagesDefinition)return!1;for(var n=0,r=e._lastFetchedIndex;r<e._known.length;r++){if("GETPAGES"===e._known[r])return!0;if(void 0===this._featureCache[e._known[r]]&&(n+=1)>=t)break}return!1},e.prototype._checkIfNeedToExpandCandidatePage=function(e,t){if(null===e.pagesDefinition)return!1;for(var n=0,r=0;r<e._candidates.length;r++){if("GETPAGES"===e._candidates[r])return!0;if((n+=1)>=t)break}return!1},e.prototype._expandPagedSet=function(e,t,i,s,a){return n(this,void 0,void 0,(function(){return r(this,(function(n){if(null===this._parent)throw new u.FeatureSetError(u.FeatureSetErrorCodes.NotImplemented);return[2,this._parent._expandPagedSet(e,t,i,s,a)]}))}))},e.prototype._expandPagedSetFeatureSet=function(e,t,i,s,a){return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(s=1),0===s&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(s=2),0===s?[2,"finished"]:[4,this._getPage(e,s,a)];case 1:return n=r.sent(),i+n<t?[2,this._expandPagedSet(e,t,i+n,0,a)]:[2,"success"]}}))}))},e.prototype._getPage=function(e,t,i){return n(this,void 0,void 0,(function(){var n,s,a,o;return r(this,(function(r){switch(r.label){case 0:if(n=1===t?e._known:e._candidates,e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){for(n.length=n.length-1,s=0,a=0;a<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+a>=e.pagesDefinition.internal.set.length);a++)n[n.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+a],s++;return e.pagesDefinition.resultOffset+=s,o=!1,!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(o=!0),!1===o&&n.push("GETPAGES"),[2,s]}return[4,this._getPhysicalPage(e,t,i)];case 1:return r.sent(),[2,this._getPage(e,t,i)]}}))}))},e.prototype._getPhysicalPage=function(e,t,n){return null},e.prototype._clonePageDefinition=function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)},e.prototype._first=function(e){return this.iterator(e).next()},e.prototype.first=function(e){return this._first(e)},e.prototype.calculateStatistic=function(e,t,i,s){return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:return r.sent(),[4,this._stat(e,t,"",null,null,i,s)];case 2:return!1!==(n=r.sent()).calculated?[3,4]:[4,this._manualStat(e,t,i,s)];case 3:n=r.sent(),r.label=4;case 4:return[2,n.result]}}))}))},e.prototype._manualStat=function(e,t,i,s){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:switch(null,e.toLowerCase()){case"count":return[3,1];case"distinct":return[3,3];case"avg":case"mean":return[3,5];case"stdev":return[3,7];case"variance":return[3,9];case"sum":return[3,11];case"min":return[3,13];case"max":return[3,15]}return[3,17];case 1:return[4,d.count(this,s)];case 2:return[2,{calculated:!0,result:n.sent()}];case 3:return[4,d.distinct(this,t,i,s)];case 4:return[2,{calculated:!0,result:n.sent()}];case 5:return[4,d.mean(this,t,s)];case 6:return[2,{calculated:!0,result:n.sent()}];case 7:return[4,d.stdev(this,t,s)];case 8:return[2,{calculated:!0,result:n.sent()}];case 9:return[4,d.variance(this,t,s)];case 10:return[2,{calculated:!0,result:n.sent()}];case 11:return[4,d.sum(this,t,s)];case 12:return[2,{calculated:!0,result:n.sent()}];case 13:return[4,d.min(this,t,s)];case 14:return[2,{calculated:!0,result:n.sent()}];case 15:return[4,d.max(this,t,s)];case 16:return[2,{calculated:!0,result:n.sent()}];case 17:return[2,{calculated:!0,result:0}]}}))}))},e.prototype._stat=function(e,t,i,s,a,o,u){return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this._parent._stat(e,t,i,s,a,o,u)];case 1:return!1===(n=r.sent()).calculated?null===a&&""===i&&null===s?[2,this._manualStat(e,t,o,u)]:[2,{calculated:!1}]:[2,n]}}))}))},e.prototype._unionAllGeomSelf=function(e){var t=this,n=this.iterator(this._defaultTracker(e)),r=[];return new Promise((function(e,i){t._unionShapeInBatches(r,n,e,i)}))},e.prototype._unionAllGeom=function(e){var t=this;return new Promise((function(n,r){var i=t.iterator(t._defaultTracker(e));t._unionShapeInBatches([],i,n,r)}))},e.prototype._unionShapeInBatches=function(e,t,n,r){var i=this;t.next().then((function(s){try{null!==s&&null!==s.geometry&&e.push(s.geometry),e.length>30||null===s&&e.length>1?_.union(e).then((function(a){try{null===s?n(a):(e=[a],i._unionShapeInBatches(e,t,n,r))}catch(e){r(e)}}),r):null===s?1===e.length?n(e[0]):n(null):i._unionShapeInBatches(e,t,n,r)}catch(e){r(e)}}),r)},e.prototype.iterator=function(e){return new c(this,e)},e.prototype.intersection=function(t,n){return void 0===n&&(n=!1),e._featuresetFunctions.intersection.bind(this)(t,n)},e.prototype.difference=function(t,n,r){return void 0===n&&(n=!1),void 0===r&&(r=!0),e._featuresetFunctions.difference.bind(this)(t,n,r)},e.prototype.symmetricDifference=function(t,n,r){return void 0===n&&(n=!1),void 0===r&&(r=!0),e._featuresetFunctions.symmetricDifference.bind(this)(t,n,r)},e.prototype.morphShape=function(t,n,r,i){return void 0===r&&(r="unknown"),void 0===i&&(i=null),e._featuresetFunctions.morphShape.bind(this)(t,n,r,i)},e.prototype.morphShapeAndAttributes=function(t,n,r){return void 0===r&&(r="unknown"),e._featuresetFunctions.morphShapeAndAttributes.bind(this)(t,n,r)},e.prototype.union=function(t,n){return void 0===n&&(n=!1),e._featuresetFunctions.union.bind(this)(t,n)},e.prototype.intersects=function(t){return e._featuresetFunctions.intersects.bind(this)(t)},e.prototype.envelopeIntersects=function(t){return e._featuresetFunctions.envelopeIntersects.bind(this)(t)},e.prototype.contains=function(t){return e._featuresetFunctions.contains.bind(this)(t)},e.prototype.overlaps=function(t){return e._featuresetFunctions.overlaps.bind(this)(t)},e.prototype.relate=function(t,n){return e._featuresetFunctions.relate.bind(this)(t,n)},e.prototype.within=function(t){return e._featuresetFunctions.within.bind(this)(t)},e.prototype.touches=function(t){return e._featuresetFunctions.touches.bind(this)(t)},e.prototype.top=function(t){return e._featuresetFunctions.top.bind(this)(t)},e.prototype.crosses=function(t){return e._featuresetFunctions.crosses.bind(this)(t)},e.prototype.buffer=function(t,n,r,i){return void 0===i&&(i=!0),e._featuresetFunctions.buffer.bind(this)(t,n,r,i)},e.prototype.filter=function(t,n){return void 0===n&&(n=null),e._featuresetFunctions.filter.bind(this)(t,n)},e.prototype.orderBy=function(t){return e._featuresetFunctions.orderBy.bind(this)(t)},e.prototype.dissolve=function(t,n){return e._featuresetFunctions.dissolve.bind(this)(t,n)},e.prototype.groupby=function(t,n){return e._featuresetFunctions.groupby.bind(this)(t,n)},e.prototype.reduce=function(e,t,n){var r=this;return void 0===t&&(t=null),new Promise((function(i,s){r._reduceImpl(r.iterator(r._defaultTracker(n)),e,t,0,i,s,0)}))},e.prototype._reduceImpl=function(e,t,n,r,i,s,a){var o=this;try{if(++a>1e3)return void setTimeout((function(){a=0,o._reduceImpl(e,t,n,r,i,s,a)}));e.next().then((function(u){try{if(null===u)i(n);else{var c=t(n,u,r,o);p.isPromiseLike(c)?c.then((function(n){o._reduceImpl(e,t,n,r+1,i,s,a)}),s):o._reduceImpl(e,t,c,r+1,i,s,a)}}catch(e){s(e)}}),s)}catch(e){s(e)}},e.prototype.removeField=function(t){return e._featuresetFunctions.removeField.bind(this)(t)},e.prototype.addField=function(t,n,r){return void 0===r&&(r=null),e._featuresetFunctions.addField.bind(this)(t,n,r)},e.prototype.sumArea=function(e,t,n){void 0===t&&(t=!1);var r=h.convertSquareUnitsToCode(e);return this.reduce((function(e,n){return null===n.geometry?0:t?_.geodesicArea(n.geometry,r).then((function(t){return e+t})):_.planarArea(n.geometry,r).then((function(t){return e+t}))}),0,n)},e.prototype.sumLength=function(e,t,n){void 0===t&&(t=!1);var r=h.convertLinearUnitsToCode(e);return this.reduce((function(e,n){return null===n.geometry?0:t?_.geodesicLength(n.geometry,r).then((function(t){return e+t})):_.planarLength(n.geometry,r).then((function(t){return e+t}))}),0,n)},e.prototype._substituteVars=function(e,t){if(null!==t){var n={};for(var r in t)n[r.toLowerCase()]=t[r];e.parameters=n}},e.prototype.distinct=function(e,t,i,s){return void 0===t&&(t=1e3),void 0===i&&(i=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,i),[2,this.calculateStatistic("distinct",n,t,this._defaultTracker(s))]}}))}))},e.prototype.min=function(e,t,i){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,t),[2,this.calculateStatistic("min",n,-1,this._defaultTracker(i))]}}))}))},e.prototype.max=function(e,t,i){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,t),[2,this.calculateStatistic("max",n,-1,this._defaultTracker(i))]}}))}))},e.prototype.avg=function(e,t,i){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,t),[2,this.calculateStatistic("avg",n,-1,this._defaultTracker(i))]}}))}))},e.prototype.sum=function(e,t,i){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,t),[2,this.calculateStatistic("sum",n,-1,this._defaultTracker(i))]}}))}))},e.prototype.stdev=function(e,t,i){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,t),[2,this.calculateStatistic("stdev",n,-1,this._defaultTracker(i))]}}))}))},e.prototype.variance=function(e,t,i){return void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:return r.sent(),n=f.WhereClause.create(e,this.getFieldsIndex()),this._substituteVars(n,t),[2,this.calculateStatistic("variance",n,-1,this._defaultTracker(i))]}}))}))},e.prototype.count=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),[2,this.calculateStatistic("count",f.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(e))]}}))}))},e.prototype._defaultTracker=function(e){return e||{aborted:!1}},e.prototype.forEach=function(e,t){var n=this;return new Promise((function(r,i){n._forEachImpl(n.iterator(n._defaultTracker(t)),e,n,r,i,0)}))},e.prototype._forEachImpl=function(e,t,n,r,i,s){var a=this;try{if(++s>1e3)return void setTimeout((function(){s=0,a._forEachImpl(e,t,n,r,i,s)}),0);e.next().then((function(o){try{if(null===o)r(n);else{var u=t(o);null==u?a._forEachImpl(e,t,n,r,i,s):p.isPromiseLike(u)?u.then((function(){try{a._forEachImpl(e,t,n,r,i,s)}catch(e){i(e)}}),i):a._forEachImpl(e,t,n,r,i,s)}}catch(e){i(e)}}),i)}catch(e){i(e)}},e.prototype.convertToJSON=function(e){for(var t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}},n=0;n<this.fields.length;n++)t.layerDefinition.fields.push(h.esriFieldToJson(this.fields[n]));return this.reduce((function(e,n){var r={geometry:n.geometry&&n.geometry.toJson(),attributes:{}};for(var i in n.attributes)r.attributes[i]=n.attributes[i];return t.featureSet.features.push(r),1}),0,e).then((function(){return t}))},e.prototype.castToText=function(e){return void 0===e&&(e=!1),"object, FeatureSet"},e.prototype.queryAttachments=function(e,t,n,r,i){return this._parent.queryAttachments(e,t,n,r,i)},e.prototype.serviceUrl=function(){return this._parent.serviceUrl()},e.prototype.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((function(e){return{name:e.name,code:e.id}})):[]}:null},e.prototype.relationshipMetaData=function(){return this._parent.relationshipMetaData()},Object.defineProperty(e.prototype,"gdbVersion",{get:function(){return this._parent?this._parent.gdbVersion:""},enumerable:!1,configurable:!0}),e.prototype.schema=function(){for(var e=[],t=0,n=this.fields;t<n.length;t++){var r=n[t];e.push(h.esriFieldToJson(r))}return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===h.layerGeometryEsriRestConstants[this.geometryType]?"esriGeometryNull":h.layerGeometryEsriRestConstants[this.geometryType],fields:e}},e.prototype.convertToText=function(e,t){return n(this,void 0,void 0,(function(){var n,i;return r(this,(function(r){switch(r.label){case 0:return"schema"!==e?[3,2]:[4,this._ensureLoaded()];case 1:return r.sent(),[2,JSON.stringify(this.schema())];case 2:return"featureset"!==e?[3,5]:[4,this._ensureLoaded()];case 3:return r.sent(),n=[],[4,this.reduce((function(e,t){var r={geometry:t.geometry?t.geometry.toJson():null,attributes:t.attributes};return null!==r.geometry&&r.geometry.spatialReference&&delete r.geometry.spatialReference,n.push(r),1}),0,t)];case 4:return r.sent(),(i=this.schema()).features=n,i.spatialReference=this.spatialReference.toJson(),[2,JSON.stringify(i)];case 5:return[2,this.castToText()]}}))}))},e.prototype.getFeatureByObjectId=function(e,t){return this._parent.getFeatureByObjectId(e,t)},e.prototype.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()},e.prototype.getIdentityUser=function(){return this._parent.getIdentityUser()},e.prototype.getRootFeatureSet=function(){return null!==this._parent?this._parent.getRootFeatureSet():this},e.prototype.getDataSourceFeatureSet=function(){return null!==this._parent?this._parent.getDataSourceFeatureSet():this},e.prototype.castAsJson=function(e){return void 0===e&&(e=null),"keeptype"===(null==e?void 0:e.featureset)?this:"none"===(null==e?void 0:e.featureset)?null:{type:"FeatureSet"}},e.prototype.castAsJsonAsync=function(e,t){var i;return void 0===e&&(e=null),void 0===t&&(t=null),n(this,void 0,void 0,(function(){var n,s;return r(this,(function(r){switch(r.label){case 0:return"keeptype"===(null==t?void 0:t.featureset)?[2,this]:"schema"!==(null==t?void 0:t.featureset)?[3,2]:[4,this._ensureLoaded()];case 1:return r.sent(),[2,JSON.parse(JSON.stringify(this.schema()))];case 2:return"none"===(null==t?void 0:t.featureset)?[2,null]:[4,this._ensureLoaded()];case 3:return r.sent(),n=[],[4,this.reduce((function(e,r){var i={geometry:r.geometry?r.geometry.toJson():null,attributes:r.attributes};return null!==i.geometry&&i.geometry.spatialReference&&!0!==(null==t?void 0:t.keepGeometryType)&&delete i.geometry.spatialReference,n.push(i),1}),0,e)];case 4:return r.sent(),(s=this.schema()).features=n,s.spatialReference=!0===(null==t?void 0:t.keepGeometryType)?this.spatialReference:null===(i=this.spatialReference)||void 0===i?void 0:i.toJson(),[2,s]}}))}))},Object.defineProperty(e.prototype,"dateTimeReferenceFieldIndex",{get:function(){return null===this._dateFieldIndex&&(this._dateFieldIndex=a.DateTimeReferenceFieldIndex.create(this.getFieldsIndex(),this)),this._dateFieldIndex},enumerable:!1,configurable:!0}),e.prototype.fieldTimeZone=function(e){return this.dateTimeReferenceFieldIndex.fieldTimeZone(e)},Object.defineProperty(e.prototype,"preferredTimeReference",{get:function(){var e,t;return null!==(t=null===(e=this._parent)||void 0===e?void 0:e.preferredTimeReference)&&void 0!==t?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dateFieldsTimeReference",{get:function(){var e,t;return null!==(t=null===(e=this._parent)||void 0===e?void 0:e.dateFieldsTimeReference)&&void 0!==t?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"datesInUnknownTimezone",{get:function(){return this._parent.datesInUnknownTimezone},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"editFieldsInfo",{get:function(){var e,t;return null!==(t=null===(e=this._parent)||void 0===e?void 0:e.editFieldsInfo)&&void 0!==t?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"timeInfo",{get:function(){var e,t;return null!==(t=null===(e=this._parent)||void 0===e?void 0:e.timeInfo)&&void 0!==t?t:null},enumerable:!1,configurable:!0}),e._featuresetFunctions={},e}()}));