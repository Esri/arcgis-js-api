/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../arcadeTimeUtils","./cache","./errorsupport","./FeatureSetIterator","./IdSet","./shared","./stats","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/geometryEngineAsync","../../../geometry/SpatialReference","../../../layers/support/FieldsIndex"],(function(e,t,n,r,i,s,a,u,o,c,l,h,d){"use strict";let f=function(){function f(e){this.recentlyUsedQueries=null,this.featureSetQueryInterceptor=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=a.FeatureServiceDatabaseType.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.typeIdField=null,this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,this._dateFieldIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache),e&&e.interceptor&&(this.featureSetQueryInterceptor=e.interceptor)}var _=f.prototype;return _.optimisePagingFeatureQueries=function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)},_._hasMemorySource=function(){return!0},_.prop=function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)},_.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent},_._ensureLoaded=function(){return this.load()},_.load=function(){return null===this._loadPromise&&(this._loadPromise=this.loadImpl()),this._loadPromise},_.loadImpl=function(){var t=e._asyncToGenerator((function*(){return!0===this._parent?.loaded?(this._initialiseFeatureSet(),this):(yield this._parent?.load(),this._initialiseFeatureSet(),this)}));function n(){return t.apply(this,arguments)}return n}(),_._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new h({wkid:4326}),this.geometryType=a.layerGeometryEsriConstants.point)},_.getField=function(e,t){let n;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((t=>(t&&t.name.toLowerCase()===e&&(n=t),!!n)))),n},_.getFieldsIndex=function(){return null===this._fieldsIndex&&(this._fieldsIndex=new d(this.fields)),this._fieldsIndex},_._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())},_._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery},_._checkCancelled=function(e){if(null!=e&&e.aborted)throw new r.FeatureSetError(r.FeatureSetErrorCodes.Cancelled)},_.nativeCapabilities=function(){return this._parent.nativeCapabilities()},_._canDoAggregates=function(){var t=e._asyncToGenerator((function*(e,t,n,r,i){return null!==this._parent&&this._parent._canDoAggregates(e,t,n,r,i)}));function n(e,n,r,i,s){return t.apply(this,arguments)}return n}(),_._getAggregatePagesDataSourceDefinition=function(){var t=e._asyncToGenerator((function*(e,t,n,i,s,a,u){if(null===this._parent)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);return this._parent._getAggregatePagesDataSourceDefinition(e,t,n,i,s,a,u)}));function n(e,n,r,i,s,a,u){return t.apply(this,arguments)}return n}(),_._getAgregagtePhysicalPage=function(){var t=e._asyncToGenerator((function*(e,t,n){if(null===this._parent)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);return this._parent._getAgregagtePhysicalPage(e,t,n)}));function n(e,n,r){return t.apply(this,arguments)}return n}(),_.databaseType=function(){var t=e._asyncToGenerator((function*(){if(this._databaseType===a.FeatureServiceDatabaseType.NotEvaluated){if(null!==n.applicationCache){const e=n.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==e)return e}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;try{this._databaseTypeProbed=this._getDatabaseTypeImpl(),null!==n.applicationCache&&n.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),this._databaseTypeProbed)}catch(e){throw null!==n.applicationCache&&n.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}return this._databaseTypeProbed}return this._databaseType}));function r(){return t.apply(this,arguments)}return r}(),_._getDatabaseTypeImpl=function(){var t=e._asyncToGenerator((function*(){const e=[{thetype:a.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:a.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:a.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];for(const t of e){if(!0===(yield this._runDatabaseProbe(t.testwhere)))return t.thetype}return a.FeatureServiceDatabaseType.StandardisedNoInterval}));function n(){return t.apply(this,arguments)}return n}(),_._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"},_._runDatabaseProbe=function(){var t=e._asyncToGenerator((function*(e){if(null!==this._parent)return this._parent._runDatabaseProbe(e);throw new r.FeatureSetError(r.FeatureSetErrorCodes.NotImplemented)}));function n(e){return t.apply(this,arguments)}return n}(),_.isTable=function(){return this._parent?.isTable()??!1},_._featureFromCache=function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]},_._isInFeatureSet=function(e){return a.IdState.Unknown},_._getSet=function(e){throw new r.FeatureSetError(r.FeatureSetErrorCodes.NotImplemented)},_._getFeature=function(){var t=e._asyncToGenerator((function*(e,t,n){if(this._checkCancelled(n),void 0!==this._featureFromCache(t))return this._featureFromCache(t);if(yield this._getFeatures(e,t,this._maxProcessingRate(),n),this._checkCancelled(n),void 0!==this._featureFromCache(t))return this._featureFromCache(t);throw new r.FeatureSetError(r.FeatureSetErrorCodes.MissingFeatures)}));function n(e,n,r){return t.apply(this,arguments)}return n}(),_._getFeatureBatch=function(){var t=e._asyncToGenerator((function*(e,t){this._checkCancelled(t);const n=new s([],e,!1,null),r=[];yield this._getFeatures(n,-1,e.length,t),this._checkCancelled(t);for(const i of e)void 0!==this._featureFromCache(i)&&r.push(this._featureFromCache(i));return r}));function n(e,n){return t.apply(this,arguments)}return n}(),_._getFeatures=function(){var t=e._asyncToGenerator((function*(e,t,n,r){return"success"}));function n(e,n,r,i){return t.apply(this,arguments)}return n}(),_._getFilteredSet=function(e,t,n,i,s){throw new r.FeatureSetError(r.FeatureSetErrorCodes.NotImplemented)},_._refineSetBlock=function(){var t=e._asyncToGenerator((function*(e,t,n){if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return yield this._expandPagedSet(e,this._maxQueryRate(),0,0,n),this._refineSetBlock(e,t,n);this._checkCancelled(n);const r=e._candidates.length;this._refineKnowns(e,t);let i=r-e._candidates.length;if(0===e._candidates.length)return e;if(i>=t)return e;if(yield this._refineIfParentKnown(e,t-i,n),this._checkCancelled(n),this._refineKnowns(e,t-i),i=r-e._candidates.length,i<t&&e._candidates.length>0){const r=t-i,s=this._prepareFetchAndRefineSet(e._candidates);return yield this._fetchAndRefineFeatures(s,s.length>r?r:e._candidates.length,n),this._checkCancelled(n),this._refineKnowns(e,t-i),e}return e}));function n(e,n,r){return t.apply(this,arguments)}return n}(),_._fetchAndRefineFeatures=function(e,t,n){return null},_._prepareFetchAndRefineSet=function(e){const t=[];for(let n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&t.push(e[n]);return t},_._isPhysicalFeature=function(e){return null===this._parent||this._parent._isPhysicalFeature(e)},_._refineKnowns=function(e,t){let n=0,r=null;const i=[];t=this._maxQueryRate();for(let s=0;s<e._candidates.length&&"GETPAGES"!==e._candidates[s];s++){let u=!1;const o=this._candidateIdTransform(e._candidates[s]);o!==e._candidates[s]&&(u=!0);const c=this._isInFeatureSet(o);if(c===a.IdState.InFeatureSet)!0===u?e._known.includes(o)||(e._known.push(o),n+=1):(e._known.push(e._candidates[s]),n+=1),null===r?r={start:s,end:s}:r.end===s-1?r.end=s:(i.push(r),r={start:s,end:s});else if(c===a.IdState.NotInFeatureSet)null===r?r={start:s,end:s}:r.end===s-1?r.end=s:(i.push(r),r={start:s,end:s}),n+=1;else if(c===a.IdState.Unknown&&(n+=1,!0===e._ordered))break;if(n>=t)break}null!==r&&i.push(r);for(let s=i.length-1;s>=0;s--)e._candidates.splice(i[s].start,i[s].end-i[s].start+1)},_._refineIfParentKnown=function(e,t,n){const r=new s([],[],e._ordered,null);return r._candidates=e._candidates.slice(0),this._parent._refineSetBlock(r,t,n)},_._candidateIdTransform=function(e){return this._parent._candidateIdTransform(e)},_._checkIfNeedToExpandKnownPage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let r=e._lastFetchedIndex;r<e._known.length;r++){if("GETPAGES"===e._known[r])return!0;if(void 0===this._featureCache[e._known[r]]&&(n+=1,n>=t))break}return!1},_._checkIfNeedToExpandCandidatePage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let r=0;r<e._candidates.length;r++){if("GETPAGES"===e._candidates[r])return!0;if(n+=1,n>=t)break}return!1},_._expandPagedSet=function(){var t=e._asyncToGenerator((function*(e,t,n,i,s){if(null===this._parent)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NotImplemented);return this._parent._expandPagedSet(e,t,n,i,s)}));function n(e,n,r,i,s){return t.apply(this,arguments)}return n}(),_._expandPagedSetFeatureSet=function(){var t=e._asyncToGenerator((function*(e,t,n,r,i){if(e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(r=1),0===r&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(r=2),0===r)return"finished";const s=yield this._getPage(e,r,i);return n+s<t?this._expandPagedSet(e,t,n+s,0,i):"success"}));function n(e,n,r,i,s){return t.apply(this,arguments)}return n}(),_._getPage=function(){var t=e._asyncToGenerator((function*(e,t,n){const r=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){r.length=r.length-1;let t=0;for(let i=0;i<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+i>=e.pagesDefinition.internal.set.length);i++)r[r.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+i],t++;e.pagesDefinition.resultOffset+=t;let n=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(n=!0),!1===n&&r.push("GETPAGES"),t}return yield this._getPhysicalPage(e,t,n),this._getPage(e,t,n)}));function n(e,n,r){return t.apply(this,arguments)}return n}(),_._getPhysicalPage=function(e,t,n){return null},_._clonePageDefinition=function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)},_._first=function(e){return this.iterator(e).next()},_.first=function(e){return this._first(e)},_.calculateStatistic=function(){var t=e._asyncToGenerator((function*(e,t,n,r){yield this._ensureLoaded();let i=yield this._stat(e,t,"",null,null,n,r);return!1===i.calculated&&(i=yield this._manualStat(e,t,n,r)),i.result}));function n(e,n,r,i){return t.apply(this,arguments)}return n}(),_._manualStat=function(){var t=e._asyncToGenerator((function*(e,t,n,r){let i=null;switch(e.toLowerCase()){case"count":return i=yield u.count(this,r),{calculated:!0,result:i};case"distinct":return i=yield u.distinct(this,t,n,r),{calculated:!0,result:i};case"avg":case"mean":return i=yield u.mean(this,t,r),{calculated:!0,result:i};case"stdev":return i=yield u.stdev(this,t,r),{calculated:!0,result:i};case"variance":return i=yield u.variance(this,t,r),{calculated:!0,result:i};case"sum":return i=yield u.sum(this,t,r),{calculated:!0,result:i};case"min":return i=yield u.min(this,t,r),{calculated:!0,result:i};case"max":return i=yield u.max(this,t,r),{calculated:!0,result:i};default:return{calculated:!0,result:0}}}));function n(e,n,r,i){return t.apply(this,arguments)}return n}(),_._stat=function(){var t=e._asyncToGenerator((function*(e,t,n,r,i,s,a){const u=yield this._parent._stat(e,t,n,r,i,s,a);return!1===u.calculated?null===i&&""===n&&null===r?this._manualStat(e,t,s,a):{calculated:!1}:u}));function n(e,n,r,i,s,a,u){return t.apply(this,arguments)}return n}(),_._unionAllGeomSelf=function(e){const t=this.iterator(this._defaultTracker(e)),n=[];return new Promise(((e,r)=>{this._unionShapeInBatches(n,t,e,r)}))},_._unionAllGeom=function(e){return new Promise(((t,n)=>{const r=this.iterator(this._defaultTracker(e)),i=[];this._unionShapeInBatches(i,r,t,n)}))},_._unionShapeInBatches=function(e,t,n,r){t.next().then((i=>{try{null!==i&&null!==i.geometry&&e.push(i.geometry),e.length>30||null===i&&e.length>1?l.union(e).then((s=>{try{null===i?n(s):(e=[s],this._unionShapeInBatches(e,t,n,r))}catch(a){r(a)}}),r):null===i?1===e.length?n(e[0]):n(null):this._unionShapeInBatches(e,t,n,r)}catch(s){r(s)}}),r)},_.iterator=function(e){return new i(this,e)},_.intersection=function(e,t=!1){return f._featuresetFunctions.intersection.bind(this)(e,t)},_.difference=function(e,t=!1,n=!0){return f._featuresetFunctions.difference.bind(this)(e,t,n)},_.symmetricDifference=function(e,t=!1,n=!0){return f._featuresetFunctions.symmetricDifference.bind(this)(e,t,n)},_.morphShape=function(e,t,n="unknown",r=null){return f._featuresetFunctions.morphShape.bind(this)(e,t,n,r)},_.morphShapeAndAttributes=function(e,t,n="unknown"){return f._featuresetFunctions.morphShapeAndAttributes.bind(this)(e,t,n)},_.union=function(e,t=!1){return f._featuresetFunctions.union.bind(this)(e,t)},_.intersects=function(e){return f._featuresetFunctions.intersects.bind(this)(e)},_.envelopeIntersects=function(e){return f._featuresetFunctions.envelopeIntersects.bind(this)(e)},_.contains=function(e){return f._featuresetFunctions.contains.bind(this)(e)},_.overlaps=function(e){return f._featuresetFunctions.overlaps.bind(this)(e)},_.relate=function(e,t){return f._featuresetFunctions.relate.bind(this)(e,t)},_.within=function(e){return f._featuresetFunctions.within.bind(this)(e)},_.touches=function(e){return f._featuresetFunctions.touches.bind(this)(e)},_.top=function(e){return f._featuresetFunctions.top.bind(this)(e)},_.crosses=function(e){return f._featuresetFunctions.crosses.bind(this)(e)},_.buffer=function(e,t,n,r=!0){return f._featuresetFunctions.buffer.bind(this)(e,t,n,r)},_.filter=function(e,t=null){return f._featuresetFunctions.filter.bind(this)(e,t)},_.orderBy=function(e){return f._featuresetFunctions.orderBy.bind(this)(e)},_.dissolve=function(e,t){return f._featuresetFunctions.dissolve.bind(this)(e,t)},_.groupby=function(e,t){return f._featuresetFunctions.groupby.bind(this)(e,t)},_.reduce=function(e,t=null,n){return new Promise(((r,i)=>{this._reduceImpl(this.iterator(this._defaultTracker(n)),e,t,0,r,i,0)}))},_._reduceImpl=function(e,t,n,r,i,s,a){try{if(++a>1e3)return void setTimeout((()=>{a=0,this._reduceImpl(e,t,n,r,i,s,a)}));e.next().then((u=>{try{if(null===u)i(n);else{const c=t(n,u,r,this);o.isPromiseLike(c)?c.then((n=>{this._reduceImpl(e,t,n,r+1,i,s,a)}),s):this._reduceImpl(e,t,c,r+1,i,s,a)}}catch(c){s(c)}}),s)}catch(u){s(u)}},_.removeField=function(e){return f._featuresetFunctions.removeField.bind(this)(e)},_.addField=function(e,t,n=null){return f._featuresetFunctions.addField.bind(this)(e,t,n)},_.sumArea=function(e,t=!1,n){const r=a.convertSquareUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?l.geodesicArea(n.geometry,r).then((t=>e+t)):l.planarArea(n.geometry,r).then((t=>e+t))),0,n)},_.sumLength=function(e,t=!1,n){const r=a.convertLinearUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?l.geodesicLength(n.geometry,r).then((t=>e+t)):l.planarLength(n.geometry,r).then((t=>e+t))),0,n)},_._substituteVars=function(e,t){if(null!==t){const n={};for(const e in t)n[e.toLowerCase()]=t[e];e.parameters=n}},_.distinct=function(){var t=e._asyncToGenerator((function*(e,t=1e3,n=null,r){yield this.load();const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,n),this.calculateStatistic("distinct",i,t,this._defaultTracker(r))}));function n(e){return t.apply(this,arguments)}return n}(),_.min=function(){var t=e._asyncToGenerator((function*(e,t=null,n){yield this.load();const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("min",r,-1,this._defaultTracker(n))}));function n(e){return t.apply(this,arguments)}return n}(),_.max=function(){var t=e._asyncToGenerator((function*(e,t=null,n){yield this.load();const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("max",r,-1,this._defaultTracker(n))}));function n(e){return t.apply(this,arguments)}return n}(),_.avg=function(){var t=e._asyncToGenerator((function*(e,t=null,n){yield this.load();const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("avg",r,-1,this._defaultTracker(n))}));function n(e){return t.apply(this,arguments)}return n}(),_.sum=function(){var t=e._asyncToGenerator((function*(e,t=null,n){yield this.load();const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("sum",r,-1,this._defaultTracker(n))}));function n(e){return t.apply(this,arguments)}return n}(),_.stdev=function(){var t=e._asyncToGenerator((function*(e,t=null,n){yield this.load();const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("stdev",r,-1,this._defaultTracker(n))}));function n(e){return t.apply(this,arguments)}return n}(),_.variance=function(){var t=e._asyncToGenerator((function*(e,t=null,n){yield this.load();const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("variance",r,-1,this._defaultTracker(n))}));function n(e){return t.apply(this,arguments)}return n}(),_.count=function(){var t=e._asyncToGenerator((function*(e){return yield this.load(),this.calculateStatistic("count",c.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(e))}));function n(e){return t.apply(this,arguments)}return n}(),_._defaultTracker=function(e){return e||{aborted:!1}},_.forEach=function(e,t){return new Promise(((n,r)=>{this._forEachImpl(this.iterator(this._defaultTracker(t)),e,this,n,r,0)}))},_._forEachImpl=function(e,t,n,r,i,s){try{if(++s>1e3)return void setTimeout((()=>{s=0,this._forEachImpl(e,t,n,r,i,s)}),0);e.next().then((a=>{try{if(null===a)r(n);else{const u=t(a);null==u?this._forEachImpl(e,t,n,r,i,s):o.isPromiseLike(u)?u.then((()=>{try{this._forEachImpl(e,t,n,r,i,s)}catch(a){i(a)}}),i):this._forEachImpl(e,t,n,r,i,s)}}catch(u){i(u)}}),i)}catch(a){i(a)}},_.convertToJSON=function(e){const t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let n=0;n<this.fields.length;n++)t.layerDefinition.fields.push(a.esriFieldToJson(this.fields[n]));return this.reduce(((e,n)=>{const r={geometry:n.geometry&&n.geometry.toJSON(),attributes:{}};for(const t in n.attributes)r.attributes[t]=n.attributes[t];return t.featureSet.features.push(r),1}),0,e).then((()=>t))},_.castToText=function(e=!1){return"object, FeatureSet"},_.queryAttachments=function(e,t,n,r,i){return this._parent.queryAttachments(e,t,n,r,i)},_.serviceUrl=function(){return this._parent.serviceUrl()},_.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((e=>({name:e.name,code:e.id}))):[]}:null},_.relationshipMetaData=function(){return this._parent.relationshipMetaData()},_.schema=function(){const e=[];for(const n of this.fields)e.push(a.esriFieldToJson(n));const t={objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===a.layerGeometryEsriRestConstants[this.geometryType]?"esriGeometryNull":a.layerGeometryEsriRestConstants[this.geometryType],fields:e};return t},_.convertToText=function(){var t=e._asyncToGenerator((function*(e,t){if("schema"===e)return yield this._ensureLoaded(),JSON.stringify(this.schema());if("featureset"===e){yield this._ensureLoaded();const e=[];yield this.reduce(((t,n)=>{const r={geometry:n.geometry?n.geometry.toJSON():null,attributes:n.attributes};return null!==r.geometry&&r.geometry.spatialReference&&delete r.geometry.spatialReference,e.push(r),1}),0,t);const n=this.schema();return n.features=e,n.spatialReference=this.spatialReference.toJSON(),JSON.stringify(n)}return this.castToText()}));function n(e,n){return t.apply(this,arguments)}return n}(),_.getFeatureByObjectId=function(e,t){return this._parent.getFeatureByObjectId(e,t)},_.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()},_.getIdentityUser=function(){return this._parent.getIdentityUser()},_.getRootFeatureSet=function(){return null!==this._parent?this._parent.getRootFeatureSet():this},_.getDataSourceFeatureSet=function(){return null!==this._parent?this._parent.getDataSourceFeatureSet():this},_.castAsJson=function(e=null){return"keeptype"===e?.featureset?this:"none"===e?.featureset?null:{type:"FeatureSet"}},_.castAsJsonAsync=function(){var t=e._asyncToGenerator((function*(e=null,t=null){if("keeptype"===t?.featureset)return this;if("schema"===t?.featureset)return yield this._ensureLoaded(),JSON.parse(JSON.stringify(this.schema()));if("none"===t?.featureset)return null;yield this._ensureLoaded();const n=[];yield this.reduce(((e,r)=>{const i={geometry:r.geometry?!0===t?.keepGeometryType?r.geometry:r.geometry.toJSON():null,attributes:r.attributes};return null!==i.geometry&&i.geometry.spatialReference&&!0!==t?.keepGeometryType&&delete i.geometry.spatialReference,n.push(i),1}),0,e);const r=this.schema();return r.features=n,r.spatialReference=!0===t?.keepGeometryType?this.spatialReference:this.spatialReference?.toJSON(),r}));function n(){return t.apply(this,arguments)}return n}(),_.fieldTimeZone=function(e){return this.dateTimeReferenceFieldIndex.fieldTimeZone(e)},e._createClass(f,[{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}},{key:"dateTimeReferenceFieldIndex",get:function(){return null===this._dateFieldIndex&&(this._dateFieldIndex=t.DateTimeReferenceFieldIndex.create(this.getFieldsIndex(),this)),this._dateFieldIndex}},{key:"preferredTimeReference",get:function(){return this._parent?.preferredTimeReference??null}},{key:"dateFieldsTimeReference",get:function(){return this._parent?.dateFieldsTimeReference??null}},{key:"datesInUnknownTimezone",get:function(){return this._parent.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return this._parent?.editFieldsInfo??null}},{key:"timeInfo",get:function(){return this._parent?.timeInfo??null}}]),f}();return f._featuresetFunctions={},f}));
