/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/promiseUtils","../../../geometry/SpatialReference","./shared","../../../geometry/geometryEngineAsync","./FeatureSetIterator","./IdSet","./cache","../../../core/sql/WhereClause","./stats","../../../layers/support/FieldsIndex"],(function(e,t,n,i,r,s,a,u,c,l,h){"use strict";let o=function(){function o(e){this.recentlyUsedQueries=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=i.FeatureServiceDatabaseType.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache)}var d=o.prototype;return d.optimisePagingFeatureQueries=function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)},d._hasMemorySource=function(){return!0},d.prop=function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)},d.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent},d._ensureLoaded=function(){return this.load()},d.load=function(){return null===this._loadPromise&&(this._loadPromise=t.create(((e,t)=>{if(!0===this._parent.loaded)return this._initialiseFeatureSet(),void e(this);this._parent.load().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}}),t)}))),this._loadPromise},d._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new n({wkid:4326}),this.geometryType=i.layerGeometryEsriConstants.point)},d.getField=function(e,t){let n;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((t=>(t&&t.name.toLowerCase()===e&&(n=t),!!n)))),n},d.getFieldsIndex=function(){return null===this._fieldsIndex&&(this._fieldsIndex=new h(this.fields)),this._fieldsIndex},d._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())},d._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery},d._checkCancelled=function(e){if(null!==e&&e.aborted)throw new Error("Operation has been cancelled.")},d.nativeCapabilities=function(){return this._parent.nativeCapabilities()},d._canDoAggregates=function(e,n,i,r,s){return null===this._parent?t.resolve(!1):this._parent._canDoAggregates(e,n,i,r,s)},d._getAggregatePagesDataSourceDefinition=function(e,n,i,r,s,a,u){return null===this._parent?t.reject(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,n,i,r,s,a,u)},d._getAgregagtePhysicalPage=function(e,n,i){return null===this._parent?t.reject(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,n,i)},d.databaseType=function(){if(this._databaseType===i.FeatureServiceDatabaseType.NotEvaluated){if(null!==u.applicationCache){const e=u.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==e)return e}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;const e=[{thetype:i.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:i.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:i.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];let n=t.create(((t,n)=>{this._getDatabaseTypeImpl(e,0).then((e=>{this._databaseType=e,t(this._databaseType)}),(e=>{n(e)}))}));return null!==u.applicationCache&&(u.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),n),n=n.catch((e=>{throw u.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}))),this._databaseTypeProbed=n,this._databaseTypeProbed}return t.resolve(this._databaseType)},d._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"},d._getDatabaseTypeImpl=function(e,n){return n>=e.length?t.resolve(i.FeatureServiceDatabaseType.StandardisedNoInterval):this._runDatabaseProbe(e[n].testwhere).then((t=>!0===t?e[n].thetype:this._getDatabaseTypeImpl(e,n+1)))},d._runDatabaseProbe=function(e){return null!==this._parent?this._parent._runDatabaseProbe(e):t.reject(new Error("Not Implemented"))},d.isTable=function(){return this._parent.isTable()},d._featureFromCache=function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]},d._isInFeatureSet=function(e){return i.IdState.Unknown},d._getSet=function(e){throw new Error("Not implemented in abstract class")},d._getFeature=function(e,n,i){try{return this._checkCancelled(i),void 0!==this._featureFromCache(n)?t.resolve(this._featureFromCache(n)):this._getFeatures(e,n,this._maxProcessingRate(),i).then((()=>(this._checkCancelled(i),void 0!==this._featureFromCache(n)?this._featureFromCache(n):t.reject(new Error("Feature Not Found")))))}catch(e){return t.reject(e)}},d._getFeatureBatch=function(e,n){try{this._checkCancelled(n);const t=new a([],e,!1,null),i=[];return this._getFeatures(t,-1,e.length,n).then((()=>{this._checkCancelled(n);for(const t of e)void 0!==this._featureFromCache(t)&&i.push(this._featureFromCache(t));return i}))}catch(e){return t.reject(e)}},d._getFeatures=function(e,n,i,r){return t.resolve("success")},d._getFilteredSet=function(e,t,n,i,r){throw new Error("Not implemented in abstract class")},d._refineSetBlock=function(e,n,i){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return this._expandPagedSet(e,this._maxQueryRate(),0,0,i).then((()=>this._refineSetBlock(e,n,i)));this._checkCancelled(i);const r=e._candidates.length;this._refineKnowns(e,n);let s=r-e._candidates.length;return 0===e._candidates.length||s>=n?t.resolve(e):this._refineIfParentKnown(e,n-s,i).then((()=>{if(this._checkCancelled(i),this._refineKnowns(e,n-s),s=r-e._candidates.length,s<n&&e._candidates.length>0){const t=n-s,r=this._prepareFetchAndRefineSet(e._candidates);return this._fetchAndRefineFeatures(r,r.length>t?t:e._candidates.length,i).then((()=>(this._checkCancelled(i),this._refineKnowns(e,n-s),e)))}return e}))}catch(e){return t.reject(e)}},d._fetchAndRefineFeatures=function(e,t,n){return null},d._prepareFetchAndRefineSet=function(e){const t=[];for(let n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&t.push(e[n]);return t},d._isPhysicalFeature=function(e){return null===this._parent||this._parent._isPhysicalFeature(e)},d._refineKnowns=function(e,t){let n=0,r=null;const s=[];t=this._maxQueryRate();for(let a=0;a<e._candidates.length&&"GETPAGES"!==e._candidates[a];a++){let u=!1;const c=this._candidateIdTransform(e._candidates[a]);c!==e._candidates[a]&&(u=!0);const l=this._isInFeatureSet(c);if(l===i.IdState.InFeatureSet)!0===u?e._known.indexOf(c)<0&&(e._known.push(c),n+=1):(e._known.push(e._candidates[a]),n+=1),null===r?r={start:a,end:a}:r.end===a-1?r.end=a:(s.push(r),r={start:a,end:a});else if(l===i.IdState.NotInFeatureSet)null===r?r={start:a,end:a}:r.end===a-1?r.end=a:(s.push(r),r={start:a,end:a}),n+=1;else if(l===i.IdState.Unknown&&(n+=1,!0===e._ordered))break;if(n>=t)break}null!==r&&s.push(r);for(let t=s.length-1;t>=0;t--)e._candidates.splice(s[t].start,s[t].end-s[t].start+1)},d._refineIfParentKnown=function(e,t,n){const i=new a([],[],e._ordered,null);return i._candidates=e._candidates.slice(0),this._parent._refineSetBlock(i,t,n)},d._candidateIdTransform=function(e){return this._parent._candidateIdTransform(e)},d._checkIfNeedToExpandKnownPage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let i=e._lastFetchedIndex;i<e._known.length;i++){if("GETPAGES"===e._known[i])return!0;if(void 0===this._featureCache[e._known[i]]&&(n+=1,n>=t))break}return!1},d._checkIfNeedToExpandCandidatePage=function(e,t){if(null===e.pagesDefinition)return!1;let n=0;for(let i=0;i<e._candidates.length;i++){if("GETPAGES"===e._candidates[i])return!0;if(n+=1,n>=t)break}return!1},d._expandPagedSet=function(e,n,i,r,s){return null===this._parent?t.reject(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,n,i,r,s)},d._expandPagedSetFeatureSet=function(e,n,i,r,s){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(r=1),0===r&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(r=2),0===r?t.resolve("finished"):this._getPage(e,r,s).then((t=>i+t<n?this._expandPagedSet(e,n,i+t,0,s):"success"))},d._getPage=function(e,n,i){const r=1===n?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){r.length=r.length-1;let n=0;for(let t=0;t<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+t>=e.pagesDefinition.internal.set.length);t++)r[r.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+t],n++;e.pagesDefinition.resultOffset+=n;let i=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(i=!0),!1===i&&r.push("GETPAGES"),t.resolve(n)}return this._getPhysicalPage(e,n,i).then((()=>this._getPage(e,n,i)))},d._getPhysicalPage=function(e,t,n){return null},d._clonePageDefinition=function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)},d._first=function(e){return this.iterator(e).next()},d.first=function(e){return this._first(e)},d.calculateStatistic=function(e,t,n,i){return this._ensureLoaded().then((()=>this._stat(e,t,"",null,null,n,i).then((r=>!1===r.calculated?this._manualStat(e,t,n,i).then((e=>e.result)):r.result))))},d._manualStat=function(e,n,i,r){switch(e.toLowerCase()){case"count":return l.count(this,r).then((e=>({calculated:!0,result:e})));case"distinct":return l.distinct(this,n,i).then((e=>({calculated:!0,result:e})));case"avg":case"mean":return l.mean(this,n,r).then((e=>({calculated:!0,result:e})));case"stdev":return l.stdev(this,n,r).then((e=>({calculated:!0,result:e})));case"variance":return l.variance(this,n,r).then((e=>({calculated:!0,result:e})));case"sum":return l.sum(this,n,r).then((e=>({calculated:!0,result:e})));case"min":return l.min(this,n,r).then((e=>({calculated:!0,result:e})));case"max":return l.max(this,n,r).then((e=>({calculated:!0,result:e})));default:return t.resolve({calculated:!0,result:0})}},d._stat=function(e,t,n,i,r,s,a){return this._parent._stat(e,t,n,i,r,s,a).then((u=>!1===u.calculated?null===r&&""===n&&null===i?this._manualStat(e,t,s,a):{calculated:!1}:u))},d._unionAllGeomSelf=function(e){const n=this.iterator(this._defaultTracker(e)),i=[];return t.create(((e,t)=>{this._unionShapeInBatches(i,n,e,t)}))},d._unionAllGeom=function(e){return t.create(((t,n)=>{const i=this.iterator(this._defaultTracker(e));this._unionShapeInBatches([],i,t,n)}))},d._unionShapeInBatches=function(e,t,n,i){t.next().then((s=>{try{null!==s&&null!==s.geometry&&e.push(s.geometry),e.length>30||null===s&&e.length>1?r.union(e).then((r=>{try{null===s?n(r):(e=[r],this._unionShapeInBatches(e,t,n,i))}catch(e){i(e)}}),i):null===s?1===e.length?n(e[0]):n(null):this._unionShapeInBatches(e,t,n,i)}catch(e){i(e)}}),i)},d.iterator=function(e){return new s(this,e)},d.intersection=function(e,t=!1){return o._featuresetFunctions.intersection.bind(this)(e,t)},d.difference=function(e,t=!1,n=!0){return o._featuresetFunctions.difference.bind(this)(e,t,n)},d.symmetricDifference=function(e,t=!1,n=!0){return o._featuresetFunctions.symmetricDifference.bind(this)(e,t,n)},d.morphShape=function(e,t,n="unknown",i=null){return o._featuresetFunctions.morphShape.bind(this)(e,t,n,i)},d.morphShapeAndAttributes=function(e,t,n="unknown"){return o._featuresetFunctions.morphShapeAndAttributes.bind(this)(e,t,n)},d.union=function(e,t=!1){return o._featuresetFunctions.union.bind(this)(e,t)},d.intersects=function(e){return o._featuresetFunctions.intersects.bind(this)(e)},d.envelopeIntersects=function(e){return o._featuresetFunctions.envelopeIntersects.bind(this)(e)},d.contains=function(e){return o._featuresetFunctions.contains.bind(this)(e)},d.overlaps=function(e){return o._featuresetFunctions.overlaps.bind(this)(e)},d.relate=function(e,t){return o._featuresetFunctions.relate.bind(this)(e,t)},d.within=function(e){return o._featuresetFunctions.within.bind(this)(e)},d.touches=function(e){return o._featuresetFunctions.touches.bind(this)(e)},d.top=function(e){return o._featuresetFunctions.top.bind(this)(e)},d.crosses=function(e){return o._featuresetFunctions.crosses.bind(this)(e)},d.buffer=function(e,t,n,i=!0){return o._featuresetFunctions.buffer.bind(this)(e,t,n,i)},d.filter=function(e,t=null){return o._featuresetFunctions.filter.bind(this)(e,t)},d.orderBy=function(e){return o._featuresetFunctions.orderBy.bind(this)(e)},d.dissolve=function(e,t){return o._featuresetFunctions.dissolve.bind(this)(e,t)},d.groupby=function(e,t){return o._featuresetFunctions.groupby.bind(this)(e,t)},d.reduce=function(e,n=null,i){return t.create(((t,r)=>{this._reduceImpl(this.iterator(this._defaultTracker(i)),e,n,0,t,r,0)}))},d._reduceImpl=function(e,n,i,r,s,a,u){try{if(++u>1e3)return void setTimeout((()=>{u=0,this._reduceImpl(e,n,i,r,s,a,u)}));e.next().then((c=>{try{if(null===c)s(i);else{const l=n(i,c,r,this);t.isPromiseLike(l)?l.then((t=>{this._reduceImpl(e,n,t,r+1,s,a,u)}),a):this._reduceImpl(e,n,l,r+1,s,a,u)}}catch(e){a(e)}}),a)}catch(e){a(e)}},d.removeField=function(e){return o._featuresetFunctions.removeField.bind(this)(e)},d.addField=function(e,t,n=null){return o._featuresetFunctions.addField.bind(this)(e,t,n)},d.sumArea=function(e,t=!1,n){const s=i.convertSquareUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?r.geodesicArea(n.geometry,s).then((t=>e+t)):r.planarArea(n.geometry,s).then((t=>e+t))),0,n)},d.sumLength=function(e,t=!1,n){const s=i.convertLinearUnitsToCode(e);return this.reduce(((e,n)=>null===n.geometry?0:t?r.geodesicLength(n.geometry,s).then((t=>e+t)):r.planarLength(n.geometry,s).then((t=>e+t))),0,n)},d._substituteVars=function(e,t){if(null!==t){const n={};for(const e in t)n[e.toLowerCase()]=t[e];e.parameters=n}},d.distinct=function(e,t=1e3,n=null,i){return this.load().then((()=>{const r=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,n),this.calculateStatistic("distinct",r,t,this._defaultTracker(i))}))},d.min=function(e,t=null,n){return this.load().then((()=>{const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("min",i,-1,this._defaultTracker(n))}))},d.max=function(e,t=null,n){return this.load().then((()=>{const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("max",i,-1,this._defaultTracker(n))}))},d.avg=function(e,t=null,n){return this.load().then((()=>{const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("avg",i,-1,this._defaultTracker(n))}))},d.sum=function(e,t=null,n){return this.load().then((()=>{const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("sum",i,-1,this._defaultTracker(n))}))},d.stdev=function(e,t=null,n){return this.load().then((()=>{const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("stdev",i,-1,this._defaultTracker(n))}))},d.variance=function(e,t=null,n){return this.load().then((()=>{const i=c.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(i,t),this.calculateStatistic("variance",i,-1,this._defaultTracker(n))}))},d.count=function(e){return this.load().then((()=>this.calculateStatistic("count",c.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(e))))},d._defaultTracker=function(e){return e||{aborted:!1}},d.forEach=function(e,n){return t.create(((t,i)=>{this._forEachImpl(this.iterator(this._defaultTracker(n)),e,this,t,i,0)}))},d._forEachImpl=function(e,n,i,r,s,a){try{if(++a>1e3)return void setTimeout((()=>{a=0,this._forEachImpl(e,n,i,r,s,a)}),0);e.next().then((u=>{try{if(null===u)r(i);else{const c=n(u);null==c?this._forEachImpl(e,n,i,r,s,a):t.isPromiseLike(c)?c.then((()=>{try{this._forEachImpl(e,n,i,r,s,a)}catch(e){s(e)}}),s):this._forEachImpl(e,n,i,r,s,a)}}catch(e){s(e)}}),s)}catch(e){s(e)}},d.convertToJSON=function(e){const t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let e=0;e<this.fields.length;e++)t.layerDefinition.fields.push(i.esriFieldToJson(this.fields[e]));return this.reduce(((e,n)=>{const i={geometry:n.geometry&&n.geometry.toJSON(),attributes:{}};for(const e in n.attributes)i.attributes[e]=n.attributes[e];return t.featureSet.features.push(i),1}),0,e).then((()=>t))},d.castToText=function(){return"object, FeatureSet"},d.queryAttachments=function(e,t,n,i){return this._parent.queryAttachments(e,t,n,i)},d.serviceUrl=function(){return this._parent.serviceUrl()},d.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((e=>({name:e.name,code:e.id}))):[]}:null},d.relationshipMetaData=function(){return this._parent.relationshipMetaData()},d.schema=function(){const e=[];for(const t of this.fields)e.push(i.esriFieldToJson(t));const t={objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===i.layerGeometryEsriRestConstants[this.geometryType]?"":i.layerGeometryEsriRestConstants[this.geometryType],fields:e};return t},d.convertToText=function(e,n){return"schema"===e?this._ensureLoaded().then((()=>JSON.stringify(this.schema()))):"featureset"===e?this._ensureLoaded().then((()=>{const e=[];return this.reduce(((t,n)=>{const i={geometry:n.geometry?n.geometry.toJSON():null,attributes:n.attributes};return null!==i.geometry&&i.geometry.spatialReference&&delete i.geometry.spatialReference,e.push(i),1}),0,n).then((()=>{const t=this.schema();return t.features=e,t.spatialReference=this.spatialReference.toJSON(),JSON.stringify(t)}))})):t.resolve(this.castToText())},d.getFeatureByObjectId=function(e,t){return this._parent.getFeatureByObjectId(e,t)},d.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()},d.getIdentityUser=function(){return this._parent.getIdentityUser()},e._createClass(o,[{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}}]),o}();return o._featuresetFunctions={},o}));
