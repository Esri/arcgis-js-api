/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../../../rest/support/RelationshipQuery"],(function(e,t,r,i,n,s,a){"use strict";let l=function(i){function l(e){var t;return(t=i.call(this,e)||this).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",t._findObjectId=-1,t._requestStandardised=!1,t._removeGeometry=!1,t._overrideFields=null,t.featureObjectId=null,e.spatialReference&&(t.spatialReference=e.spatialReference),t._transparent=!0,t._maxProcessing=1e3,t._layer=e.layer,t._wset=null,t._findObjectId=e.objectId,t.featureObjectId=e.objectId,t.relationship=e.relationship,t._relatedLayer=e.relatedLayer,void 0!==e.outFields&&(t._overrideFields=e.outFields),void 0!==e.includeGeometry&&(t._removeGeometry=!1===e.includeGeometry),t}e._inheritsLoose(l,i);var o=l.prototype;return o._maxQueryRate=function(){return s.defaultMaxRecords},o.end=function(){return this._layer},o.optimisePagingFeatureQueries=function(){},o.loadImpl=function(){var t=e._asyncToGenerator((function*(){return yield Promise.all([this._layer.load(),this._relatedLayer?.load()]),this._initialiseFeatureSet(),this}));function r(){return t.apply(this,arguments)}return r}(),o.nativeCapabilities=function(){return this._relatedLayer.nativeCapabilities()},o._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const i of this._overrideFields)if(i.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types},o.databaseType=function(){var t=e._asyncToGenerator((function*(){return yield this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType}));function r(){return t.apply(this,arguments)}return r}(),o.isTable=function(){return this._relatedLayer.isTable()},o._isInFeatureSet=function(){return s.IdState.InFeatureSet},o._candidateIdTransform=function(e){return e},o._getSet=function(){var t=e._asyncToGenerator((function*(e){if(null===this._wset){yield this._ensureLoaded();const t=yield this._getFilteredSet("",null,null,null,e);return this._wset=t,t}return this._wset}));function r(e){return t.apply(this,arguments)}return r}(),o._changeFeature=function(e){const r={};for(const t of this.fields)r[t.name]=e.attributes[t.name];return new t({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})},o._getFilteredSet=function(){var t=e._asyncToGenerator((function*(e,t,r,i,s){if(yield this.databaseType(),this.isTable()&&t&&null!==e&&""!==e){return new n([],[],!0,null)}const l=this._layer.nativeCapabilities();if(!1===l.canQueryRelated){return new n([],[],!0,null)}if(l.capabilities?.queryRelated&&l.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,r,i,s);let o="",u=!1;null!==i&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(o=i.constructClause(),u=!0);const d=new a;d.objectIds=[this._findObjectId];const c=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((e=>e.name)):["*"]);d.outFields=c,d.relationshipId=this.relationship.id,d.where="1=1";let h=!0;!0===this._removeGeometry&&(h=!1),d.returnGeometry=h,this._requestStandardised&&(d.sqlFormat="standard"),d.outSpatialReference=this.spatialReference,d.orderByFields=""!==o?o.split(","):null;const f=yield l.source.queryRelatedFeatures(d);this._checkCancelled(s);const y=f[this._findObjectId]?f[this._findObjectId].features:[],p=[];for(let n=0;n<y.length;n++)this._featureCache[y[n].attributes[this._relatedLayer.objectIdField]]=y[n],p.push(y[n].attributes[this._relatedLayer.objectIdField]);const _=t&&null!==e&&""!==e,g=null!=r;return new n(_||g?p:[],_||g?[]:p,u,null)}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),o._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let r=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t},o._getFilteredSetUsingPaging=function(){var t=e._asyncToGenerator((function*(e,t,r,i,s){let a="",l=!1;const o=this._layer.nativeCapabilities();null!==i&&o&&o.capabilities?.queryRelated&&!0===o.capabilities.queryRelated.supportsOrderBy&&(a=i.constructClause(),l=!0),yield this.databaseType();const u="1=1";let d=this._maxQueryRate();const c=o.capabilities?.query.maxRecordCount;null!=c&&c<d&&(d=c);const h=t&&null!==e&&""!==e,f=null!=r;let y=null,p=!0;!0===this._removeGeometry&&(p=!1);const _=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((e=>e.name)):["*"]);return y=new n(h||f?["GETPAGES"]:[],h||f?[]:["GETPAGES"],l,{outFields:_.join(","),resultRecordCount:d,resultOffset:0,objectIds:[this._findObjectId],where:u,orderByFields:a,returnGeometry:p,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield this._expandPagedSet(y,d,0,0,s),y}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),o._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},o._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},o._getPhysicalPage=function(){var t=e._asyncToGenerator((function*(e,t,r){const i=e.pagesDefinition.internal.lastRetrieved,n=i,s=e.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),o=new a;!0===this._requestStandardised&&(o.sqlFormat="standard"),o.relationshipId=this.relationship.id,o.objectIds=e.pagesDefinition.objectIds,o.resultOffset=e.pagesDefinition.internal.lastPage,o.resultRecordCount=e.pagesDefinition.resultRecordCount,o.outFields=e.pagesDefinition.outFields.split(","),o.where=e.pagesDefinition.where,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,o.returnGeometry=e.pagesDefinition.returnGeometry,o.outSpatialReference=this.spatialReference;const u=yield l.source.queryRelatedFeatures(o);if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return 0;const d=u[this._findObjectId]?u[this._findObjectId].features:[];for(let a=0;a<d.length;a++)e.pagesDefinition.internal.set[n+a]=d[a].attributes[this._relatedLayer.objectIdField];for(let a=0;a<d.length;a++)this._featureCache[d[a].attributes[this._relatedLayer.objectIdField]]=d[a];const c=!u[this._findObjectId]||!1===u[this._findObjectId].exceededTransferLimit;return d.length!==e.pagesDefinition.resultRecordCount&&c&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+d.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,d.length}));function r(e,r,i){return t.apply(this,arguments)}return r}(),o._getFeatures=function(){var t=e._asyncToGenerator((function*(e,t,i,n){const s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);const a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return yield this._expandPagedSet(e,a,0,0,n),this._getFeatures(e,t,i,n);let l=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(l++,l<=i&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[r]&&void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&s.push(e._known[r]),s.length>i)))&&!(l>=i&&0===s.length);r++);if(0===s.length)return"success";throw new r.FeatureSetError(r.FeatureSetErrorCodes.MissingFeatures)}));function i(e,r,i,n){return t.apply(this,arguments)}return i}(),o._refineSetBlock=function(){var t=e._asyncToGenerator((function*(e,t,r){return e}));function r(e,r,i){return t.apply(this,arguments)}return r}(),o._stat=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,s,a){return{calculated:!1}}));function r(e,r,i,n,s,a,l){return t.apply(this,arguments)}return r}(),o._canDoAggregates=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n){return!1}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),o.relationshipMetaData=function(){return this._relatedLayer.relationshipMetaData()},o.serviceUrl=function(){return this._relatedLayer.serviceUrl()},o.queryAttachments=function(e,t,r,i,n){return this._relatedLayer.queryAttachments(e,t,r,i,n)},o.getFeatureByObjectId=function(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)},o.getOwningSystemUrl=function(){return this._relatedLayer.getOwningSystemUrl()},o.getIdentityUser=function(){return this._relatedLayer.getIdentityUser()},o.getDataSourceFeatureSet=function(){return this._relatedLayer},e._createClass(l,[{key:"gdbVersion",get:function(){return this._relatedLayer.gdbVersion}},{key:"preferredTimeReference",get:function(){return this._relatedLayer?.preferredTimeReference??null}},{key:"dateFieldsTimeReference",get:function(){return this._relatedLayer?.dateFieldsTimeReference??null}},{key:"datesInUnknownTimezone",get:function(){return this._relatedLayer?.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return this._relatedLayer?.editFieldsInfo??null}},{key:"timeInfo",get:function(){return this._relatedLayer?.timeInfo??null}}]),l}(i);return l}));
