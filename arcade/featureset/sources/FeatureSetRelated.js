// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/extends","../../polyfill/tsSupport/assign","../../../graphic","../support/FeatureSet","../support/IdSet","../support/shared","../../../tasks/RelationshipQuery"],(function(e,t,r,i,n,s,a,o,l,u,d){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",r._findObjectId=-1,r._requestStandardised=!1,r._removeGeometry=!1,r._overrideFields=null,r.featureObjectId=null,r.relatedLayer=null,r.relationship=null,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,r._findObjectId=t.objectId,r.featureObjectId=t.objectId,r.relationship=t.relationship,r.relatedLayer=t.relatedLayer,void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return n(t,e),t.prototype._maxQueryRate=function(){return u.defaultMaxRecords},t.prototype.end=function(){return this._layer},t.prototype.optimisePagingFeatureQueries=function(e){},t.prototype.loadImpl=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,Promise.all([this._layer.load(),this.relatedLayer.load()])];case 1:return e.sent(),this._initialiseFeatureSet(),[2,this]}}))}))},t.prototype.nativeCapabilities=function(){return this.relatedLayer.nativeCapabilities()},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return this.relatedLayer.gdbVersion},enumerable:!1,configurable:!0}),t.prototype._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{for(var e=[],t=[],r=0,i=this.fields;r<i.length;r++){var n=i[r];if("oid"===n.type)e.push(n),t.push(n.name);else for(var s=0,a=this._overrideFields;s<a.length;s++){if(a[s].toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}}}this.fields=e,this._overrideFields=t}var o=this._layer.nativeCapabilities();o&&(this._databaseType=o.databaseType,this._requestStandardised=o.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types},t.prototype.databaseType=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.relatedLayer.databaseType()];case 1:return e.sent(),this._databaseType=this.relatedLayer._databaseType,[2,this._databaseType]}}))}))},t.prototype.isTable=function(){return this.relatedLayer.isTable()},t.prototype._isInFeatureSet=function(e){return u.IdState.InFeatureSet},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return r.sent(),[4,this._getFilteredSet("",null,null,null,e)];case 2:return t=r.sent(),this._wset=t,[2,t];case 3:return[2,this._wset]}}))}))},t.prototype._changeFeature=function(e){for(var t={},r=0,i=this.fields;r<i.length;r++){var n=i[r];t[n.name]=e.attributes[n.name]}return new a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})},t.prototype._getFilteredSet=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var r,o,u,c,h,p,f,y,g,_,b,F;return i(this,(function(i){switch(i.label){case 0:return[4,this.databaseType()];case 1:return i.sent(),this.isTable()&&t&&null!==e&&""!==e?[2,new l([],[],!0,null)]:!1===(r=this._layer.nativeCapabilities()).canQueryRelated?[2,new l([],[],!0,null)]:r.capabilities.queryRelated&&r.capabilities.queryRelated.supportsPagination?[2,this._getFilteredSetUsingPaging(e,t,n,s,a)]:(o="",u=!1,null!==s&&r.capabilities&&r.capabilities.queryRelated&&!0===r.capabilities.queryRelated.supportsOrderBy&&(o=s.constructClause(),u=!0),(c=new d).objectIds=[this._findObjectId],h=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((function(e){return e.name})):["*"]),c.outFields=h,c.relationshipId=this.relationship.id,c.definitionExpression="1=1",p=!0,!0===this._removeGeometry&&(p=!1),c.returnGeometry=p,this._requestStandardised&&(c.sqlFormat="standard"),c.outSpatialReference=this.spatialReference,c.orderByFields=""!==o?o.split(","):null,[4,r.source.queryRelatedFeatures(c)]);case 2:for(f=i.sent(),this._checkCancelled(a),y=f[this._findObjectId]?f[this._findObjectId].features:[],g=[],_=0;_<y.length;_++)this._featureCache[y[_].attributes[this._layer.objectIdField]]=y[_],g.push(y[_].attributes[this._layer.objectIdField]);return F=null!=n,[2,new l((b=t&&null!==e&&""!==e)||F?g:[],b||F?[]:g,u,null)]}}))}))},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,i=0,n=t;i<n.length;i++){if(n[i].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFilteredSetUsingPaging=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var r,o,u,d,c,h,p,f,y,g;return i(this,(function(i){switch(i.label){case 0:return r="",o=!1,u=this._layer.nativeCapabilities(),null!==s&&u&&u.capabilities.queryRelated&&!0===u.capabilities.queryRelated.supportsOrderBy&&(r=s.constructClause(),o=!0),[4,this.databaseType()];case 1:return i.sent(),"1=1",d=this._maxQueryRate(),void 0!==(c=u.capabilities.query.maxRecordCount)&&c<d&&(d=c),h=t&&null!==e&&""!==e,p=null!=n,f=null,y=!0,!0===this._removeGeometry&&(y=!1),g=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((function(e){return e.name})):["*"]),f=new l(h||p?["GETPAGES"]:[],h||p?[]:["GETPAGES"],o,{outFields:g.join(","),resultRecordCount:d,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:r,returnGeometry:y,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}}),[4,this._expandPagedSet(f,d,0,0,a)];case 2:return i.sent(),[2,f]}}))}))},t.prototype._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,n){return r(this,void 0,void 0,(function(){var t,r,s,a,o,l,u,c;return i(this,(function(i){switch(i.label){case 0:return t=e.pagesDefinition.internal.lastRetrieved,r=t,s=this._layer.nativeCapabilities(),a=new d,!0===this._requestStandardised&&(a.sqlFormat="standard"),a.relationshipId=this.relationship.id,a.objectIds=e.pagesDefinition.objectIds,a.resultOffset=e.pagesDefinition.internal.lastRetrieved,a.resultRecordCount=e.pagesDefinition.resultRecordCount,a.outFields=e.pagesDefinition.outFields.split(","),a.definitionExpression=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,[4,s.source.queryRelatedFeatures(a)];case 1:if(o=i.sent(),this._checkCancelled(n),e.pagesDefinition.internal.lastRetrieved!==t)return[2,0];for(l=o[this._findObjectId]?o[this._findObjectId].features:[],u=0;u<l.length;u++)e.pagesDefinition.internal.set[r+u]=l[u].attributes[this._layer.objectIdField];for(u=0;u<l.length;u++)this._featureCache[l[u].attributes[this._layer.objectIdField]]=l[u];return c=!o[this._findObjectId]||!1===o[this._findObjectId].exceededTransferLimit,l.length!==e.pagesDefinition.resultRecordCount&&c&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+l.length,[2,l.length]}}))}))},t.prototype._getFeatures=function(e,t,n,s){return r(this,void 0,void 0,(function(){var r,a,o,l;return i(this,(function(i){switch(i.label){case 0:return r=[],-1!==t&&void 0===this._featureCache[t]&&r.push(t),a=this._maxQueryRate(),!0!==this._checkIfNeedToExpandKnownPage(e,a)?[3,2]:[4,this._expandPagedSet(e,a,0,0,s)];case 1:return i.sent(),[2,this._getFeatures(e,t,n,s)];case 2:for(o=0,l=e._lastFetchedIndex;l<e._known.length&&(++o<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[l]&&void 0===this._featureCache[e._known[l]]&&(e._known[l]!==t&&r.push(e._known[l]),r.length>n)))&&!(o>=n&&0===r.length);l++);if(0===r.length)return[2,"success"];throw new Error("Unaccounted for Features. Not in Feature Collection")}}))}))},t.prototype._refineSetBlock=function(e,t,n){return r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,e]}))}))},t.prototype._stat=function(e,t,n,s,a,o,l){return r(this,void 0,void 0,(function(){return i(this,(function(e){return[2,{calculated:!1}]}))}))},t.prototype._canDoAggregates=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){return i(this,(function(e){return[2,!1]}))}))},t.prototype.relationshipMetaData=function(){return this.relatedLayer.relationshipMetaData()},t.prototype.serviceUrl=function(){return this.relatedLayer.serviceUrl()},t.prototype.queryAttachments=function(e,t,r,i,n){return this.relatedLayer.queryAttachments(e,t,r,i,n)},t.prototype.getFeatureByObjectId=function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)},t.prototype.getIdentityUser=function(){return this.relatedLayer.getIdentityUser()},t.prototype.getOwningSystemUrl=function(){return this.relatedLayer.getOwningSystemUrl()},t.prototype.getDataSourceFeatureSet=function(){return this.relatedLayer},t}(o)}));