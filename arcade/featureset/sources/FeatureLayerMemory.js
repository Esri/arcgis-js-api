/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../../geometry/Geometry","../../../layers/FeatureLayer","../../../layers/support/FeatureType","../../../layers/support/Field","../../../rest/support/Query"],(function(e,t,r,i,n,s,a,o,l,u,c,f){"use strict";let y=function(i){function y(e){var t;return(t=i.call(this,e)||this).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",t._removeGeometry=!1,t._overrideFields=null,t._forceIsTable=!1,e.spatialReference&&(t.spatialReference=e.spatialReference),t._transparent=!0,t._maxProcessing=1e3,t._layer=e.layer,t._wset=null,!0===e.isTable&&(t._forceIsTable=!0),void 0!==e.outFields&&(t._overrideFields=e.outFields),void 0!==e.includeGeometry&&(t._removeGeometry=!1===e.includeGeometry),t}e._inheritsLoose(y,i);var h=y.prototype;return h._maxQueryRate=function(){return s.defaultMaxRecords},h.end=function(){return this._layer},h.optimisePagingFeatureQueries=function(){},h.loadImpl=function(){var t=e._asyncToGenerator((function*(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(yield this._layer.load(),this._initialiseFeatureSet(),this)}));function r(){return t.apply(this,arguments)}return r}(),h._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const r of this._layer.outFields)if(r.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}else;if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const i of this._overrideFields)if(i.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=s.FeatureServiceDatabaseType.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},h.isTable=function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType},h._isInFeatureSet=function(){return s.IdState.InFeatureSet},h._candidateIdTransform=function(e){return e},h._getSet=function(){var t=e._asyncToGenerator((function*(e){if(null===this._wset){yield this._ensureLoaded();const t=yield this._getFilteredSet("",null,null,null,e);return this._wset=t,t}return this._wset}));function r(e){return t.apply(this,arguments)}return r}(),h._changeFeature=function(e){const r={};for(const t of this.fields)r[t.name]=e.attributes[t.name];return new t({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})},h._getFilteredSet=function(){var t=e._asyncToGenerator((function*(e,t,r,i,o){let l="",u=!1;if(null!==i&&(l=i.constructClause(),u=!0),this.isTable()&&t&&null!==e&&""!==e){return new n([],[],!0,null)}const c=new f;c.where=null===r?null===t?"1=1":"":a.toWhereClause(r,s.FeatureServiceDatabaseType.Standardised),c.spatialRelationship=this._makeRelationshipEnum(e),c.outSpatialReference=this.spatialReference,c.orderByFields=""!==l?l.split(","):null,c.geometry=null===t?null:t,c.returnGeometry=!0,c.relationParameter=this._makeRelationshipParam(e);const y=yield this._layer.queryFeatures(c);if(null===y)return new n([],[],u,null);this._checkCancelled(o);const h=[];y.features.forEach((e=>{const t=e.attributes[this._layer.objectIdField];h.push(t),this._featureCache[t]=this._changeFeature(e)}));return new n([],h,u,null)}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),h._makeRelationshipEnum=function(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},h._makeRelationshipParam=function(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""},h._queryAllFeatures=function(){var t=e._asyncToGenerator((function*(){if(this._wset)return this._wset;const e=new f;if(e.where="1=1",yield this._ensureLoaded(),this._layer.source&&this._layer.source.items){const e=[];return this._layer.source.items.forEach((t=>{const r=t.attributes[this._layer.objectIdField];e.push(r),this._featureCache[r]=this._changeFeature(t)})),this._wset=new n([],e,!1,null),this._wset}const t=yield this._layer.queryFeatures(e),r=[];return t.features.forEach((e=>{const t=e.attributes[this._layer.objectIdField];r.push(t),this._featureCache[t]=this._changeFeature(e)})),this._wset=new n([],r,!1,null),this._wset}));function r(){return t.apply(this,arguments)}return r}(),h._getFeatures=function(){var t=e._asyncToGenerator((function*(e,t,i){const n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);for(let r=e._lastFetchedIndex;r<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&n.push(e._known[r]),n.length>i)));r++);if(0===n.length)return"success";throw new r.FeatureSetError(r.FeatureSetErrorCodes.MissingFeatures)}));function i(e,r,i){return t.apply(this,arguments)}return i}(),h._refineSetBlock=function(){var t=e._asyncToGenerator((function*(e){return e}));function r(e){return t.apply(this,arguments)}return r}(),h._stat=function(){var t=e._asyncToGenerator((function*(){return{calculated:!1}}));function r(){return t.apply(this,arguments)}return r}(),h._canDoAggregates=function(){var t=e._asyncToGenerator((function*(){return!1}));function r(){return t.apply(this,arguments)}return r}(),h.relationshipMetaData=function(){return[]},y._cloneAttr=function(e){const t={};for(const r in e)t[r]=e[r];return t},h.nativeCapabilities=function(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}},y.create=function(e,t){let r=e.layerDefinition.objectIdField;const i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",n=[];if(e.layerDefinition.types)for(const o of e.layerDefinition.types)n.push(u.fromJSON(o));let s=e.layerDefinition.geometryType;void 0===s&&(s=e.featureSet.geometryType||"");let a=e.featureSet.features;const f=t.toJSON();if(""===r||void 0===r){let t=!1;for(const i of e.layerDefinition.fields)if("oid"===i.type||"esriFieldTypeOID"===i.type){r=i.name,t=!0;break}if(!1===t){let t="FID",i=!0,n=0;for(;i;){let r=!0;for(const i of e.layerDefinition.fields)if(i.name===t){r=!1;break}!0===r?i=!1:(n++,t="FID"+n.toString())}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:t,alias:t});const s=[];for(let r=0;r<a.length;r++)s.push({geometry:e.featureSet.features[r].geometry,attributes:e.featureSet.features[r].attributes?this._cloneAttr(e.featureSet.features[r].attributes):{}}),s[r].attributes[t]=r;a=s,r=t}}const h=[];for(const o of e.layerDefinition.fields)o instanceof c?h.push(o):h.push(c.fromJSON(o));let d=s;switch(d||(d=""),d){case"esriGeometryPoint":d="point";break;case"esriGeometryPolyline":d="polyline";break;case"esriGeometryPolygon":d="polygon";break;case"esriGeometryExtent":d="extent";break;case"esriGeometryMultipoint":d="multipoint";break;case"":case"esriGeometryNull":d="esriGeometryNull"}if("esriGeometryNull"!==d)for(const l of a)l.geometry&&l.geometry instanceof o==!1&&(l.geometry.type=d,void 0===l.geometry.spatialReference&&(l.geometry.spatialReference=f));else for(const o of a)o.geometry&&(o.geometry=null);const p={outFields:["*"],source:a,fields:h,types:n,typeIdField:i,objectIdField:r,spatialReference:t};""!==d&&"esriGeometryNull"!==d&&null!==d&&(p.geometryType=d);return new y({layer:new l(p),spatialReference:t,isTable:null===d||""===d||"esriGeometryNull"===d})},h.queryAttachments=function(){var t=e._asyncToGenerator((function*(){return[]}));function r(){return t.apply(this,arguments)}return r}(),h.getFeatureByObjectId=function(){var t=e._asyncToGenerator((function*(e){const t=new f;t.where=this.objectIdField+"="+e.toString();const r=yield this._layer.queryFeatures(t);return 1===r.features.length?r.features[0]:null}));function r(e){return t.apply(this,arguments)}return r}(),h.getOwningSystemUrl=function(){var t=e._asyncToGenerator((function*(){return""}));function r(){return t.apply(this,arguments)}return r}(),h.getIdentityUser=function(){var t=e._asyncToGenerator((function*(){return""}));function r(){return t.apply(this,arguments)}return r}(),e._createClass(y,[{key:"gdbVersion",get:function(){return""}},{key:"preferredTimeReference",get:function(){return this._layer?.preferredTimeReference?.toJSON()??null}},{key:"dateFieldsTimeReference",get:function(){return this._layer?.dateFieldsTimeReference?.toJSON()??null}},{key:"datesInUnknownTimezone",get:function(){return this._layer?.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return this._layer?.editFieldsInfo?.toJSON()??null}},{key:"timeInfo",get:function(){return this._layer?.timeInfo?.toJSON()??null}}]),y}(i);return y}));
