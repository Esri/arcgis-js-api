// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.40/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","../../../graphic","../support/FeatureSet","../support/IdSet","../support/shared","../../polyfill/promiseUtils","../../../geometry/Geometry","../../../geometry/geometryEngineAsync","../../../geometry/jsonUtils","../../../layers/Field"],(function(e,t,r,n,o,i,a,s,l,u,p){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.source=[],t.spatialReference&&(r.spatialReference=t.spatialReference),r.types=t.types,r.geometryType=t.geometryType,r.typeIdField=t.typeIdField,r.globalIdField=t.globalIdField,r.objectIdField=t.objectIdField,r.fields=t.fields.slice(0),r.source=t.source,r._transparent=!0,r._maxProcessing=1e3,r._wset=null,r}return __extends(t,e),t.prototype._maxQueryRate=function(){return i.defaultMaxRecords},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=a.create((function(t,r){e._initialiseFeatureSet(),t(e)}))),this._loadPromise},t.prototype._initialiseFeatureSet=function(){this._databaseType=i.FeatureServiceDatabaseType.Standardised},t.prototype.optimisePagingFeatureQueries=function(e){},t.prototype.relationshipMetaData=function(){return[]},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return""},enumerable:!1,configurable:!0}),t.prototype.nativeCapabilities=function(){return{title:"",source:this,canQueryRelated:!1,capabilities:{query:{maxRecordCount:1e3},queryRelated:{supportsOrderBy:!1,supportsPagination:!1}},databaseType:this._databaseType,requestStandardised:!1}},t.prototype._allFeatures=function(){return this.source},t.prototype._isInFeatureSet=function(e){return i.IdState.InFeatureSet},t.prototype.isTable=function(){return null===this.geometryType||""===this.geometryType},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):a.resolve(this._wset)},t.prototype._getFilteredSet=function(e,t,r,n,i){var s=this;try{return this._ensureLoaded().then((function(){if(s.isTable()&&t&&null!==e&&""!==e)return new o([],[],!0,null);if(null===s._wset){var n=[];s._allFeatures().forEach((function(e){void 0===e.geometry&&(e.geometry=null);var t=e.attributes[s.objectIdField];n.push(t),s._featureCache[t]=e})),s._wset=new o([],n,!1,null)}var a=s._wset._known.slice(0);return s._checkCancelled(i),s.fetchAndRefineFeaturesByWhere(a,r,i).then((function(r){return s._checkCancelled(i),null!==t?s.fetchAndRefineFeaturesSpatially(r,t,e,i).then((function(e){return new o([],e,!1,null)})):new o([],r,!1,null)}))}))}catch(e){return a.reject(e)}},t.prototype.executeSpatialRelationTest=function(e,t,r,n){if(null===e.geometry)return a.resolve(!1);switch(t){case"esriSpatialRelEnvelopeIntersects":var o=i.shapeExtent(r),s=i.shapeExtent(e.geometry);return l.intersects(o,s);case"esriSpatialRelIntersects":return l.intersects(r,e.geometry);case"esriSpatialRelContains":return l.contains(r,e.geometry);case"esriSpatialRelOverlaps":return l.overlaps(r,e.geometry);case"esriSpatialRelWithin":return l.within(r,e.geometry);case"esriSpatialRelTouches":return l.touches(r,e.geometry);case"esriSpatialRelCrosses":return l.crosses(r,e.geometry);case"esriSpatialRelRelation":return l.relate(r,e.geometry,n)}},t.prototype.executeWhereTest=function(e,t){return t.testFeature(e)},t.prototype.fetchAndRefineFeaturesSpatially=function(e,t,r,n){var o=[],i=[],s="";r.indexOf("esriSpatialRelRelation")>=0&&(s=r.split(":")[1],r="esriSpatialRelRelation");for(var l=0;l<e.length;l++){var u=this._featureFromCache(e[l]);i.push(this.executeSpatialRelationTest(u,r,t,s))}return 0===i.length?a.resolve(o):a.all(i).then((function(t){for(var r=0;r<e.length;r++)!0===t[r]&&o.push(e[r]);return o}))},t.prototype.fetchAndRefineFeaturesByWhere=function(e,t,r){var n=[];if(null===t)return a.resolve(e);for(var o=0;o<e.length;o++){var i=this._featureFromCache(e[o]);this.executeWhereTest(i,t)&&n.push(e[o])}return a.resolve(n)},t.prototype._getFeatures=function(e,t,r,n){var o=[];-1!==t&&void 0===this._featureCache[t]&&o.push(t);for(var i=e._lastFetchedIndex;i<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[i]]&&(e._known[i]!==t&&o.push(e._known[i]),o.length>r)));i++);return 0===o.length?a.resolve("success"):a.reject(new Error("Unaccounted for Features. Not in Feature Collection"))},t.prototype._refineSetBlock=function(e,t,r){return a.resolve(e)},t.prototype._stat=function(e,t,r,n,o,i,s){return a.resolve({calculated:!1})},t.prototype._canDoAggregates=function(e,t,r,n,o){return a.resolve(!1)},t._cloneAttr=function(e){var t={};for(var r in e)t[r]=e[r];return t},t.create=function(e,n){var o=n.toJson(),i=e.layerDefinition.objectIdField,a=e.layerDefinition.globalIdField?e.layerDefinition.globalIdField:"",l=e.layerDefinition.geometryType,c=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",f=[];if(e.layerDefinition.types)for(var y=0,d=e.layerDefinition.types;y<d.length;y++){var h=d[y];f.push(h)}void 0===l&&(l=e.featureSet.geometryType),void 0===l&&(l="");var g=e.featureSet.features;if(""===i||void 0===i){for(var v=!1,_=0,m=e.layerDefinition.fields;_<m.length;_++){if("oid"===(B=m[_]).type||"esriFieldTypeOID"===B.type){i=B.name,v=!0;break}}if(!1===v){for(var F="FID",S=!0,b=0;S;){for(var I=!0,R=0,w=e.layerDefinition.fields;R<w.length;R++){if((B=w[R]).name===F){I=!1;break}}!0===I?S=!1:F="FID"+(++b).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:F,alias:F});for(var T=[],D=0;D<g.length;D++)T.push({geometry:e.featureSet.features[D].geometry,attributes:e.featureSet.features[D].attributes?this._cloneAttr(e.featureSet.features[D].attributes):{}}),T[D].attributes[F]=D;g=T,i=F}}for(var x=[],j=0,C=e.layerDefinition.fields;j<C.length;j++){(B=C[j])instanceof p?x.push(B):x.push(new p(B))}for(var O=[],A=0,k=g;A<k.length;A++){var B;(B=k[A]).geometry&&B.geometry instanceof s==!1&&void 0===B.geometry.spatialReference&&(B.geometry.spatialReference=o),O.push(new r(null===B.geometry||void 0===B.geometry?null:u.fromJson(B.geometry),null,B.attributes))}return new t({source:O,types:f,typeIdField:c,globalIdField:a,fields:x,objectIdField:i,geometryType:l,spatialReference:n})},t.prototype.canBeBigDataFeatureSet=function(){return!1},t.prototype.shouldBeResolvedAsBigData=function(){return!1},t.prototype.queryAttachments=function(e,t,r,n){return a.resolve([])},t.prototype.getFeatureByObjectId=function(e,t){for(var r=0,n=this.source;r<n.length;r++){var o=n[r];if(o.attributes[this.objectIdField]===e)return a.resolve(o)}return a.resolve(null)},t.prototype.getIdentityUser=function(){return a.resolve("")},t.prototype.getOwningSystemUrl=function(){return a.resolve("")},t}(n)}));