/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../../../request","../../Attachment","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../../core/MD5","../../../kernel","../../../geometry/support/jsonUtils","../../../layers/FeatureLayer","../../../layers/graphics/featureConversionUtils","../../../core/Error","../../../core/has","../../../core/Logger","../../../layers/support/source/DataLayerSource","../../../rest/query/executeQueryJSON","../../../config","../../../core/arrayUtils","../../../core/urlUtils","../../../core/unitUtils","../../../geometry/support/spatialReferenceUtils","../../../rest/query/operations/query","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../rest/query/support/AttachmentInfo","../../../rest/support/AttachmentQuery","../../../rest/query/executeForCount","../../../geometry","../../../rest/query/executeForIds","../../../rest/support/RelationshipQuery","../../../geometry/support/normalizeUtils","../../../rest/support/TopFeaturesQuery","../../../rest/query/operations/pbfOptimizedFeatureSet","../../../rest/support/StatisticDefinition","../../Dictionary","../support/errorsupport"],(function(e,t,r,i,n,s,a,l,o,u,c,d,h,p,y,f,_,g,m,S,F,R,b,D,I,w,T,v,C,x,P,k,q,O,E,U,G,Q,B){"use strict";let L=function(n){function y(e){var t;return(t=n.call(this,e)||this).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",t._removeGeometry=!1,t._overrideFields=null,t.formulaCredential=null,t._pageJustIds=!1,t._requestStandardised=!1,t._useDefinitionExpression=!0,t._cachedDateMetaData={},e.spatialReference&&(t.spatialReference=e.spatialReference),t._transparent=!0,t._maxProcessing=1e3,t._layer=e.layer,t._wset=null,void 0!==e.outFields&&(t._overrideFields=e.outFields),void 0!==e.includeGeometry&&(t._removeGeometry=!1===e.includeGeometry),t}e._inheritsLoose(y,n);var f=y.prototype;return f._maxQueryRate=function(){return a.defaultMaxRecords},f.end=function(){return this._layer},f.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},f.convertQueryToLruCacheKey=function(e){const t=this.urlQueryPath+","+a.stableStringify(e.toJSON());return u.createMD5Hash(t,u.outputTypes.String)},f.loadImpl=function(){var t=e._asyncToGenerator((function*(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(yield this._layer.load(),this._initialiseFeatureSet(),this)}));function r(){return t.apply(this,arguments)}return r}(),f._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const r of this._layer.outFields)if(r.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}else;if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const i of this._overrideFields)if(i.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=a.FeatureServiceDatabaseType.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=a.FeatureServiceDatabaseType.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=a.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=a.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types},f._isInFeatureSet=function(){return a.IdState.InFeatureSet},f._refineSetBlock=function(){var t=e._asyncToGenerator((function*(e){return e}));function r(e){return t.apply(this,arguments)}return r}(),f._candidateIdTransform=function(e){return e},f._getSet=function(){var t=e._asyncToGenerator((function*(e){if(null===this._wset){yield this._ensureLoaded();const t=yield this._getFilteredSet("",null,null,null,e);return this._wset=t,t}return this._wset}));function r(e){return t.apply(this,arguments)}return r}(),f._runDatabaseProbe=function(){var t=e._asyncToGenerator((function*(e){yield this._ensureLoaded();const t=new T;this.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t.where=e.replace("OBJECTID",this._layer.objectIdField);try{return yield this._layer.queryObjectIds(t),!0}catch(r){return!1}}));function r(e){return t.apply(this,arguments)}return r}(),f._canUsePagination=function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)},f._cacheableFeatureSetSourceKey=function(){return this._layer.url},f.pbfSupportedForQuery=function(e){const t=this._layer?.capabilities?.query;return!e.outStatistics&&!0===t?.supportsFormatPBF&&!0===t?.supportsQuantizationEditMode},f.queryPBF=function(){var t=e._asyncToGenerator((function*(e){e.quantizationParameters={mode:"edit"};const t=yield I.executeQueryPBF(this._layer.parsedUrl,e,new U.OptimizedFeatureSetParserContext({}));return w.fromJSON(p.convertToFeatureSet(t.data)).unquantize()}));function r(e){return t.apply(this,arguments)}return r}(),f.nativeCapabilities=function(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}},f.executeQuery=function(e,t){const r="execute"===t?m.executeQueryJSON:"executeForCount"===t?x.executeForCount:k.executeForIds,i="execute"===t&&this.pbfSupportedForQuery(e);let n=null;if(this.recentlyUsedQueries){const t=this.convertQueryToLruCacheKey(e);n=this.recentlyUsedQueries.getFromCache(t),null===n&&(n=!0!==i?r(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(t,n),n=n.catch((e=>{throw this.recentlyUsedQueries?.removeFromCache(t),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===n&&(n=!0!==i?r(this._layer.parsedUrl.path,e):this.queryPBF(e)),n},f._getFilteredSet=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n){const a=yield this.databaseType();if(this.isTable()&&t&&null!==e&&""!==e){return new s([],[],!0,null)}if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,r,i,n);let o="",u=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),u=!0);const c=new T;this.datesInUnknownTimezone&&(c.timeReferenceUnknownClient=!0),c.where=null===r?null===t?"1=1":"":l.toWhereClause(r,a),this._requestStandardised&&(c.sqlFormat="standard"),c.spatialRelationship=this._makeRelationshipEnum(e),c.outSpatialReference=this.spatialReference,c.orderByFields=""!==o?o.split(","):null,c.geometry=null===t?null:t,c.relationParameter=this._makeRelationshipParam(e);let d=yield this.executeQuery(c,"executeForIds");null===d&&(d=[]),this._checkCancelled(n);return new s([],d,u,null)}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),f._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},f._getFilteredSetUsingPaging=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n){let a="",o=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(a=i.constructClause(),o=!0);const u=yield this.databaseType();let c=null===r?null===t?"1=1":"":l.toWhereClause(r,u);this._layer.definitionExpression&&this._useDefinitionExpression&&(c=""!==c?"(("+this._layer.definitionExpression+") AND ("+c+"))":this._layer.definitionExpression);let d=this._maxQueryRate();const h=this._layer.capabilities?.query.maxRecordCount;null!=h&&h<d&&(d=h);let p=null;if(!0===this._pageJustIds)p=new s([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?null:t,where:c,orderByFields:a,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let r=!0;!0===this._removeGeometry&&(r=!1);const i=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);p=new s([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:i.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?null:t,where:c,orderByFields:a,returnGeometry:r,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield this._expandPagedSet(p,d,0,1,n),p}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),f._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},f._getPhysicalPage=function(){var t=e._asyncToGenerator((function*(e,t,r){const i=e.pagesDefinition.internal.lastRetrieved,n=i,s=e.pagesDefinition.internal.lastPage,a=new T;this._requestStandardised&&(a.sqlFormat="standard"),this.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParameter=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastPage,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference;const l=yield this.executeQuery(a,"execute");if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return"done";const o=this._layer.objectIdField;for(let u=0;u<l.features.length;u++)e.pagesDefinition.internal.set[n+u]=l.features[u].attributes[o];if(!1===this._pageJustIds)for(let u=0;u<l.features.length;u++)this._featureCache[l.features[u].attributes[o]]=l.features[u];return(void 0===l.exceededTransferLimit&&l.features.length!==e.pagesDefinition.resultRecordCount||!1===l.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+l.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}));function r(e,r,i){return t.apply(this,arguments)}return r}(),f._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let r=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t},f._getFeatures=function(){var t=e._asyncToGenerator((function*(e,t,r,i){const n=[];if(-1!==t&&void 0===this._featureCache[t]&&n.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return yield this._expandPagedSet(e,this._maxProcessingRate(),0,0,i),this._getFeatures(e,t,r,i);let s=0;for(let u=e._lastFetchedIndex;u<e._known.length;u++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[u]]){let r=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const t=this._layer._mode;if(void 0!==t._featureMap[e._known[u]]){const i=t._featureMap[e._known[u]];null!==i&&(r=!0,this._featureCache[e._known[u]]=i)}}if(!1===r&&(e._known[u]!==t&&n.push(e._known[u]),n.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===n.length)break}if(0===n.length)return"success";const a=new T;this._requestStandardised&&(a.sqlFormat="standard"),this.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0),a.objectIds=n,a.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),a.returnGeometry=!0,!0===this._removeGeometry&&(a.returnGeometry=!1),a.outSpatialReference=this.spatialReference;const l=yield this.executeQuery(a,"execute");if(this._checkCancelled(i),void 0!==l.error)throw new B.FeatureSetError(B.FeatureSetErrorCodes.RequestFailed,{reason:l.error});const o=this._layer.objectIdField;for(let u=0;u<l.features.length;u++)this._featureCache[l.features[u].attributes[o]]=l.features[u];return"success"}));function r(e,r,i,n){return t.apply(this,arguments)}return r}(),f._getDistinctPages=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,s,a,o,u){yield this._ensureLoaded();const c=yield this.databaseType();let d=r.parseTree.column;const h=this._layer.fields??[];for(let l=0;l<h.length;l++)if(h[l].name.toLowerCase()===d.toLowerCase()){d=h[l].name;break}const p=new T;this._requestStandardised&&(p.sqlFormat="standard"),this.datesInUnknownTimezone&&(p.timeReferenceUnknownClient=!0);let y=null===s?null===n?"1=1":"":l.toWhereClause(s,c);this._layer.definitionExpression&&this._useDefinitionExpression&&(y=""!==y?"(("+this._layer.definitionExpression+") AND ("+y+"))":this._layer.definitionExpression),p.where=y,p.spatialRelationship=this._makeRelationshipEnum(i),p.relationParameter=this._makeRelationshipParam(i),p.geometry=null===n?null:n,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[d];const f=yield this.executeQuery(p,"execute");if(this._checkCancelled(u),!f.hasOwnProperty("features"))throw new B.FeatureSetError(B.FeatureSetErrorCodes.InvalidStatResponse);let _=!1;for(let l=0;l<h.length;l++)if(h[l].name===d){"date"===h[l].type&&(_=!0);break}for(let l=0;l<f.features.length;l++){if(_){const e=f.features[l].attributes[d];null!==e?o.push(new Date(e)):o.push(e)}else o.push(f.features[l].attributes[d]);if(o.length>=a)break}if(0===f.features.length)return o;if(f.features.length===this._layer.capabilities?.query.maxRecordCount&&o.length<a){return{calculated:!0,result:yield this._getDistinctPages(e+f.features.length,t,r,i,n,s,a,o,u)}}return o}));function r(e,r,i,n,s,a,l,o,u){return t.apply(this,arguments)}return r}(),f._distinctStat=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,s,a){return{calculated:!0,result:yield this._getDistinctPages(0,e,t,r,i,n,s,[],a)}}));function r(e,r,i,n,s,a,l){return t.apply(this,arguments)}return r}(),f.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType},f._countstat=function(){var t=e._asyncToGenerator((function*(e,t,r,i){const n=yield this.databaseType(),s=new T;if(this._requestStandardised&&(s.sqlFormat="standard"),this.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===i?null===r?"1=1":"":l.toWhereClause(i,n);this._layer.definitionExpression&&this._useDefinitionExpression&&(a=""!==a?"(("+this._layer.definitionExpression+") AND ("+a+"))":this._layer.definitionExpression),s.where=a,this.datesInUnknownTimezone&&(s.timeReferenceUnknownClient=!0),s.where=a,s.spatialRelationship=this._makeRelationshipEnum(t),s.relationParameter=this._makeRelationshipParam(t),s.geometry=null===r?null:r,s.returnGeometry=!1;return{calculated:!0,result:yield this.executeQuery(s,"executeForCount")}}));function r(e,r,i,n){return t.apply(this,arguments)}return r}(),f._stats=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,s,a){yield this._ensureLoaded();const u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,c=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,d=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===e)return d?this._countstat(e,r,i,n):{calculated:!1};if(!1===c||!1===l.isSingleField(t)&&!1===u||!1===t.isStandardized)return""!==r||null!==n?{calculated:!1}:this._manualStat(e,t,s,a);if("distinct"===e)return!1===d?""!==r||null!==n?{calculated:!1}:this._manualStat(e,t,s,a):this._distinctStat(e,t,r,i,n,s,a);const h=yield this.databaseType();if(this.isTable()&&i&&null!==r&&""!==r)return{calculated:!0,result:null};const p=new T;this._requestStandardised&&(p.sqlFormat="standard");let y=null===n?null===i?"1=1":"":l.toWhereClause(n,h);this._layer.definitionExpression&&this._useDefinitionExpression&&(y=""!==y?"(("+this._layer.definitionExpression+") AND ("+y+"))":this._layer.definitionExpression),p.where=y,p.spatialRelationship=this._makeRelationshipEnum(r),p.relationParameter=this._makeRelationshipParam(r),p.geometry=null===i?null:i,this.datesInUnknownTimezone&&(p.timeReferenceUnknownClient=!0);const f=new G;f.statisticType=o.decodeStatType(e),f.onStatisticField=l.toWhereClause(t,h),f.outStatisticFieldName="ARCADE_STAT_RESULT",p.returnGeometry=!1;let _="ARCADE_STAT_RESULT";p.outStatistics=[f];const g=yield this.executeQuery(p,"execute");if(!g.hasOwnProperty("features")||0===g.features.length)throw new B.FeatureSetError(B.FeatureSetErrorCodes.InvalidStatResponse);let m=!1;const S=g.fields??[];for(let l=0;l<S.length;l++)if("ARCADE_STAT_RESULT"===S[l].name.toUpperCase()){_=S[l].name,"date"===S[l].type&&(m=!0);break}if(m){let e=g.features[0].attributes[_];return null!==e&&(e=new Date(g.features[0].attributes[_])),{calculated:!0,result:e}}return{calculated:!0,result:g.features[0].attributes[_]}}));function r(e,r,i,n,s,a,l){return t.apply(this,arguments)}return r}(),f._stat=function(e,t,r,i,n,s,a){return this._stats(e,t,r,i,n,s,a)},f._canDoAggregates=function(){var t=e._asyncToGenerator((function*(e,t){yield this._ensureLoaded();let r=!1;const i=this._layer.capabilities?.query,n=!0===i?.supportsSqlExpression;if(null!=i&&!0===i.supportsStatistics&&!0===i.supportsOrderBy&&(r=!0),r)for(let s=0;s<t.length-1;s++)(!1===t[s].workingexpr?.isStandardized||!1===l.isSingleField(t[s].workingexpr)&&!1===n)&&(r=!1);return!1!==r}));function r(e,r){return t.apply(this,arguments)}return r}(),f._makeRelationshipEnum=function(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},f._makeRelationshipParam=function(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""},f._getAggregatePagesDataSourceDefinition=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,a,o){yield this._ensureLoaded();const u=yield this.databaseType();let c="",d=!1,h=!1;null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(c=a.constructClause(),h=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(h=!1,d=!0,c=this._layer.objectIdField);const p=[];for(let s=0;s<t.length;s++){const e=new G;e.onStatisticField=null!==t[s].workingexpr?l.toWhereClause(t[s].workingexpr,u):"",e.outStatisticFieldName=t[s].field,e.statisticType=t[s].toStatisticsName(),p.push(e)}""===c&&(c=e.join(","));let y=this._maxQueryRate();const f=this._layer.capabilities?.query.maxRecordCount;null!=f&&f<y&&(y=f);let _=null===n?null===i?"1=1":"":l.toWhereClause(n,u);this._layer.definitionExpression&&this._useDefinitionExpression&&(_=""!==_?"(("+this._layer.definitionExpression+") AND ("+_+"))":this._layer.definitionExpression);return new s([],["GETPAGES"],h,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(r),relationParam:this._makeRelationshipParam(r),outFields:["*"],useOIDpagination:d,generatedOid:o,resultRecordCount:y,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:p,geometry:null===i?null:i,where:_,orderByFields:c,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}));function r(e,r,i,n,s,a,l){return t.apply(this,arguments)}return r}(),f._getAgregagtePhysicalPage=function(){var r=e._asyncToGenerator((function*(e,r,i){let n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const s=e.pagesDefinition.internal.lastRetrieved,a=s,l=e.pagesDefinition.internal.lastPage,o=new T;if(this._requestStandardised&&(o.sqlFormat="standard"),o.where=n,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.returnGeometry=e.pagesDefinition.returnGeometry,this.datesInUnknownTimezone&&(o.timeReferenceUnknownClient=!0),o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship)return[];const u=yield this.executeQuery(o,"execute");if(this._checkCancelled(i),!u.hasOwnProperty("features"))throw new B.FeatureSetError(B.FeatureSetErrorCodes.InvalidStatResponse);const c=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(let t=0;t<u.features.length;t++)e.pagesDefinition.internal.set[a+t]=u.features[t].attributes[e.pagesDefinition.generatedOid];for(let d=0;d<u.features.length;d++)c.push(new t({attributes:u.features[d].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===u.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=u.features[u.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===u.exceededTransferLimit&&u.features.length!==e.pagesDefinition.resultRecordCount||!1===u.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+u.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,c}));function i(e,t,i){return r.apply(this,arguments)}return i}(),y.create=function(e,t,r,i,n){return new y({layer:new h({url:e,outFields:null===t?["*"]:t}),spatialReference:r,lrucache:i,interceptor:n})},f.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]},f.serviceUrl=function(){return a.extractServiceUrl(this._layer.parsedUrl.path)},f.queryAttachments=function(){var t=e._asyncToGenerator((function*(e,t,r,n,s){const a=this._layer.capabilities;if(a?.data.supportsAttachment&&a?.operations.supportsQueryAttachments){const a={objectIds:[e],returnMetadata:s};(t&&t>0||r&&r>0)&&(a.size=[t&&t>0?t:0,r&&r>0?r:t+1]),n&&n.length>0&&(a.attachmentTypes=n),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:"attachments"});const l=yield this._layer.queryAttachments(a),o=[];return l&&l[e]&&l[e].forEach((t=>{const r=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();let n=null;s&&t.exifInfo&&(n=Q.convertJsonToArcade(t.exifInfo,"system",!0)),o.push(new i(t.id,t.name,t.contentType,t.size,r,n))})),o}return[]}));function r(e,r,i,n,s){return t.apply(this,arguments)}return r}(),f.queryRelatedFeatures=function(){var i=e._asyncToGenerator((function*(e){const i={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields?.join(","),returnGeometry:e.returnGeometry.toString()};void 0!==e.resultOffset&&null!==e.resultOffset&&(i.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(i.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(i.orderByFields=e.orderByFields.join(",")),e.objectIds&&e.objectIds.length>0&&(i.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(i.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:i,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});const n=yield r(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:i});if(n.data){const e={},r=n.data;if(r&&r.relatedRecordGroups){const i=r.spatialReference;for(const n of r.relatedRecordGroups){const s=n.objectId,a=[];for(const e of n.relatedRecords){e.geometry&&(e.geometry.spatialReference=i);const r=new t({geometry:e.geometry?d.fromJSON(e.geometry):null,attributes:e.attributes});a.push(r)}e[s]={features:a,exceededTransferLimit:!0===r.exceededTransferLimit}}}return e}throw new B.FeatureSetError(B.FeatureSetErrorCodes.InvalidRequest)}));function n(e){return i.apply(this,arguments)}return n}(),f.getFeatureByObjectId=function(){var t=e._asyncToGenerator((function*(e,t){const r=new T;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),this.datesInUnknownTimezone&&(r.timeReferenceUnknownClient=!0),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:r,method:"execute"});const i=yield m.executeQueryJSON(this._layer.parsedUrl.path,r);return 1===i.features.length?i.features[0]:null}));function r(e,r){return t.apply(this,arguments)}return r}(),f.getIdentityUser=function(){var t=e._asyncToGenerator((function*(){yield this.load();const e=c.id?.findCredential(this._layer.url);return e?e.userId:null}));function r(){return t.apply(this,arguments)}return r}(),f.getOwningSystemUrl=function(){var t=e._asyncToGenerator((function*(){yield this.load();const e=c.id?.findServerInfo(this._layer.url);if(e)return e.owningSystemUrl;let t=this._layer.url;const i=t.toLowerCase().indexOf("/rest/services");if(t=i>-1?t.substring(0,i):t,t){t+="/rest/info";try{const e=yield r(t,{query:{f:"json"}});let i="";return e.data&&e.data.owningSystemUrl&&(i=e.data.owningSystemUrl),i}catch(n){return""}}return""}));function i(){return t.apply(this,arguments)}return i}(),f.getDataSourceFeatureSet=function(){const e=new y({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return e._useDefinitionExpression=!1,e},e._createClass(y,[{key:"urlQueryPath",get:function(){return this._layer.parsedUrl.path||""}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}},{key:"preferredTimeReference",get:function(){return void 0===this._cachedDateMetaData.preferredTimeReference&&(this._cachedDateMetaData.preferredTimeReference=this._layer?.preferredTimeReference?.toJSON()??null),this._cachedDateMetaData.preferredTimeReference}},{key:"dateFieldsTimeReference",get:function(){return void 0===this._cachedDateMetaData.dateFieldsTimeReference&&(this._cachedDateMetaData.dateFieldsTimeReference=this._layer?.dateFieldsTimeReference?.toJSON()??null),this._cachedDateMetaData.dateFieldsTimeReference}},{key:"datesInUnknownTimezone",get:function(){return this._layer.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return void 0===this._cachedDateMetaData.editFieldsInfo&&(this._cachedDateMetaData.editFieldsInfo=this._layer?.editFieldsInfo?.toJSON()??null),this._cachedDateMetaData.editFieldsInfo}},{key:"timeInfo",get:function(){return void 0===this._cachedDateMetaData.timeInfo&&(this._cachedDateMetaData.timeInfo=this._layer?.timeInfo?.toJSON()??null),this._cachedDateMetaData.timeInfo}}]),y}(n);return L}));
