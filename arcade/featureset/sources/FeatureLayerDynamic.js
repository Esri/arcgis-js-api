/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../../../request","../../Attachment","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../../core/MD5","../../../kernel","../../../core/promiseUtils","../../../geometry/support/jsonUtils","../../../layers/FeatureLayer","../../../layers/graphics/featureConversionUtils","../../../core/urlUtils","../../../core/unitUtils","../../../rest/query/support/AttachmentInfo","../../../rest/support/AttachmentQuery","../../../rest/query/executeForCount","../../../geometry","../../../rest/query/operations/query","../../../rest/support/Query","../../../rest/query/executeForIds","../../../rest/query/executeQueryJSON","../../../core/has","../../../geometry/support/spatialReferenceUtils","../../../rest/support/FeatureSet","../../../rest/support/RelationshipQuery","../../../geometry/support/normalizeUtils","../../../rest/support/TopFeaturesQuery","../../../rest/query/operations/pbfOptimizedFeatureSet","../../../rest/support/StatisticDefinition","../../Dictionary"],(function(e,t,r,i,s,a,n,l,o,u,d,c,h,p,y,f,_,g,m,S,F,b,R,D,x,w,I,v,q,P,C,O,T,E){"use strict";return function(s){function f(e){var t;return(t=s.call(this,e)||this).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",t._removeGeometry=!1,t._overrideFields=null,t.formulaCredential=null,t._pageJustIds=!1,t._requestStandardised=!1,t._useDefinitionExpression=!0,e.spatialReference&&(t.spatialReference=e.spatialReference),t._transparent=!0,t._maxProcessing=1e3,t._layer=e.layer,t._wset=null,void 0!==e.outFields&&(t._overrideFields=e.outFields),void 0!==e.includeGeometry&&(t._removeGeometry=!1===e.includeGeometry),t}e._inheritsLoose(f,s);var _=f.prototype;return _._maxQueryRate=function(){return n.defaultMaxRecords},_.end=function(){return this._layer},_.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},_.convertQueryToLruCacheKey=function(e){const t=n.stableStringify(e.toJSON());return u.createMD5Hash(t,u.outputTypes.String)},_.load=function(){return null===this._loadPromise&&(this._loadPromise=c.create(((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(r){t(r)}}),t),this._layer.load()}catch(r){t(r)}}))),this._loadPromise},_._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const r of this._layer.outFields)if(r.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}else;if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if("oid"===r.type)e.push(r),t.push(r.name);else for(const i of this._overrideFields)if(i.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=n.FeatureServiceDatabaseType.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=n.FeatureServiceDatabaseType.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=n.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=n.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},_._isInFeatureSet=function(){return n.IdState.InFeatureSet},_._refineSetBlock=function(e){return c.resolve(e)},_._candidateIdTransform=function(e){return e},_._getSet=function(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((e=>(this._wset=e,e))):c.resolve(this._wset)},_._runDatabaseProbe=function(e){return c.create(((t,r)=>{try{this._ensureLoaded().then((()=>{try{const i=new R;i.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(i).then((()=>{t(!0)}),(()=>{try{t(!1)}catch(e){r(e)}}))}catch(i){r(i)}}))}catch(i){r(i)}}))},_._canUsePagination=function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)},_._cacheableFeatureSetSourceKey=function(){return this._layer.url},_.pbfSupportedForQuery=function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode},_.queryPBF=function(e){return e.quantizationParameters={mode:"edit"},b.executeQueryPBF(this._layer.parsedUrl,e,new O.OptimizedFeatureSetParserContext({})).then((e=>v.fromJSON(y.convertToFeatureSet(e.data)).unquantize()))},_.nativeCapabilities=function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}},_.executeQuery=function(e,t){const r="execute"===t?x.executeQueryJSON:"executeForCount"===t?S.executeForCount:D.executeForIds,i="execute"===t&&this.pbfSupportedForQuery(e);let s=null;if(this.recentlyUsedQueries){const t=this.convertQueryToLruCacheKey(e);s=this.recentlyUsedQueries.getFromCache(t),null===s&&(s=!0!==i?r(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(t,s),s=s.catch((e=>{throw this.recentlyUsedQueries.removeFromCache(t),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===s&&(s=!0!==i?r(this._layer.parsedUrl.path,e):this.queryPBF(e)),s},_._getFilteredSet=function(e,t,r,i,s){return this.databaseType().then((n=>{if(this.isTable()&&t&&null!==e&&""!==e){return new a([],[],!0,null)}if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,r,i,s);let o="",u=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),u=!0);const d=new R;return d.where=null===r?null===t?"1=1":"":l.toWhereClause(r,n),this._requestStandardised&&(d.sqlFormat="standard"),d.spatialRelationship=this._makeRelationshipEnum(e),d.outSpatialReference=this.spatialReference,d.orderByFields=""!==o?o.split(","):null,d.geometry=null===t?null:t,d.relationParameter=this._makeRelationshipParam(e),this.executeQuery(d,"executeForIds").then((e=>{null===e&&(e=[]),this._checkCancelled(s);return new a([],e,u,null)}))}))},_._expandPagedSet=function(e,t,r,i,s){return this._expandPagedSetFeatureSet(e,t,r,i,s)},_._getFilteredSetUsingPaging=function(e,t,r,i,s){try{let n="",o=!1;return null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(n=i.constructClause(),o=!0),this.databaseType().then((i=>{let u=null===r?null===t?"1=1":"":l.toWhereClause(r,i);this._layer.definitionExpression&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.definitionExpression+") AND ("+u+"))":this._layer.definitionExpression);let d=this._maxQueryRate();const c=this._layer.capabilities.query.maxRecordCount;void 0!==c&&c<d&&(d=c);let h=null;if(!0===this._pageJustIds)h=new a([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:n,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let r=!0;!0===this._removeGeometry&&(r=!1);const i=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);h=new a([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:i.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:n,returnGeometry:r,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(h,d,0,1,s).then((()=>h))}))}catch(n){return c.reject(n)}},_._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},_._getPhysicalPage=function(e,t,r){try{const t=e.pagesDefinition.internal.lastRetrieved,i=t,s=e.pagesDefinition.internal.lastPage,a=new R;return this._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParameter=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastPage,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,this.executeQuery(a,"execute").then((a=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return"done";for(let t=0;t<a.features.length;t++)e.pagesDefinition.internal.set[i+t]=a.features[t].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let e=0;e<a.features.length;e++)this._featureCache[a.features[e].attributes[this._layer.objectIdField]]=a.features[e];return(void 0===a.exceededTransferLimit&&a.features.length!==e.pagesDefinition.resultRecordCount||!1===a.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+a.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(i){return c.reject(i)}},_._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let r=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t},_._getFeatures=function(e,t,r,i){const s=[];try{if(-1!==t&&void 0===this._featureCache[t]&&s.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,i).then((()=>this._getFeatures(e,t,r,i)));let n=0;for(let i=e._lastFetchedIndex;i<e._known.length;i++){if(e._lastFetchedIndex+=1,n++,void 0===this._featureCache[e._known[i]]){let r=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const t=this._layer._mode;if(void 0!==t._featureMap[e._known[i]]){const s=t._featureMap[e._known[i]];null!==s&&(r=!0,this._featureCache[e._known[i]]=s)}}if(!1===r&&(e._known[i]!==t&&s.push(e._known[i]),s.length>=this._maxProcessingRate()-1))break}if(n>=r&&0===s.length)break}if(0===s.length)return c.resolve("success");try{const e=new R;return this._requestStandardised&&(e.sqlFormat="standard"),e.objectIds=s,e.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),e.returnGeometry=!0,!0===this._removeGeometry&&(e.returnGeometry=!1),e.outSpatialReference=this.spatialReference,this.executeQuery(e,"execute").then((e=>{if(this._checkCancelled(i),void 0!==e.error)return c.reject(new Error(e.error));for(let t=0;t<e.features.length;t++)this._featureCache[e.features[t].attributes[this._layer.objectIdField]]=e.features[t];return"success"}))}catch(a){return c.reject(a)}}catch(a){return c.reject(a)}},_._getDistinctPages=function(e,t,r,i,s,a,n,o,u){return this._ensureLoaded().then((()=>this.databaseType())).then((d=>{let h=r.parseTree.column;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name.toLowerCase()===h.toLowerCase()){h=this._layer.fields[e].name;break}const p=new R;this._requestStandardised&&(p.sqlFormat="standard");let y=null===a?null===s?"1=1":"":l.toWhereClause(a,d);return this._layer.definitionExpression&&this._useDefinitionExpression&&(y=""!==y?"(("+this._layer.definitionExpression+") AND ("+y+"))":this._layer.definitionExpression),p.where=y,p.spatialRelationship=this._makeRelationshipEnum(i),p.relationParameter=this._makeRelationshipParam(i),p.geometry=null===s?null:s,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[h],this.executeQuery(p,"execute").then((l=>{if(this._checkCancelled(u),!l.hasOwnProperty("features"))return c.reject(new Error("Unnexected Result querying statistics from layer"));let d=!1;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name===h){"date"===this._layer.fields[e].type&&(d=!0);break}for(let e=0;e<l.features.length;e++){if(d){const t=l.features[e].attributes[h];null!==t?o.push(new Date(t)):o.push(t)}else o.push(l.features[e].attributes[h]);if(o.length>=n)break}return 0===l.features.length?o:l.features.length===this._layer.capabilities.query.maxRecordCount&&o.length<n?this._getDistinctPages(e+l.features.length,t,r,i,s,a,n,o,u).then((e=>({calculated:!0,result:e}))):o}))}))},_._distinctStat=function(e,t,r,i,s,a,n){return this._getDistinctPages(0,e,t,r,i,s,a,[],n).then((e=>({calculated:!0,result:e})))},_.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType},_._countstat=function(e,t,r,i){return this.databaseType().then((e=>{const s=new R;if(this._requestStandardised&&(s.sqlFormat="standard"),this.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===i?null===r?"1=1":"":l.toWhereClause(i,e);return this._layer.definitionExpression&&this._useDefinitionExpression&&(a=""!==a?"(("+this._layer.definitionExpression+") AND ("+a+"))":this._layer.definitionExpression),s.where=a,s.where=a,s.spatialRelationship=this._makeRelationshipEnum(t),s.relationParameter=this._makeRelationshipParam(t),s.geometry=null===r?null:r,s.returnGeometry=!1,this.executeQuery(s,"executeForCount").then((e=>({calculated:!0,result:e})))}))},_._stats=function(e,t,r,i,s,a,n){return this._ensureLoaded().then((()=>{const u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,d=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,h=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?h?this._countstat(e,r,i,s):{calculated:!1}:!1===d||!1===l.isSingleField(t)&&!1===u||!1===t.isStandardized?""!==r||null!==s?{calculated:!1}:this._manualStat(e,t,a,n):"distinct"===e?!1===h?""!==r||null!==s?{calculated:!1}:this._manualStat(e,t,a,n):this._distinctStat(e,t,r,i,s,a,n):this.databaseType().then((a=>{if(this.isTable()&&i&&null!==r&&""!==r)return{calculated:!0,result:null};const n=new R;this._requestStandardised&&(n.sqlFormat="standard");let u=null===s?null===i?"1=1":"":l.toWhereClause(s,a);this._layer.definitionExpression&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.definitionExpression+") AND ("+u+"))":this._layer.definitionExpression),n.where=u,n.spatialRelationship=this._makeRelationshipEnum(r),n.relationParameter=this._makeRelationshipParam(r),n.geometry=null===i?null:i;const d=new T;d.statisticType=o.decodeStatType(e),d.onStatisticField=l.toWhereClause(t,a),d.outStatisticFieldName="ARCADE_STAT_RESULT",n.returnGeometry=!1;let h="ARCADE_STAT_RESULT";return n.outStatistics=[d],this.executeQuery(n,"execute").then((e=>{if(!e.hasOwnProperty("features")||0===e.features.length)return c.reject(new Error("Unnexected Result querying statistics from layer"));let t=!1;for(let r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){h=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){let t=e.features[0].attributes[h];return null!==t&&(t=new Date(e.features[0].attributes[h])),{calculated:!0,result:t}}return{calculated:!0,result:e.features[0].attributes[h]}}))}))}))},_._stat=function(e,t,r,i,s,a,n){return this._stats(e,t,r,i,s,a,n)},_._canDoAggregates=function(e,t){return this._ensureLoaded().then((()=>{let e=!1;const r=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(let i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized||!1===l.isSingleField(t[i].workingexpr)&&!1===r)&&(e=!1);return!1!==e}))},_._makeRelationshipEnum=function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},_._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},_._getAggregatePagesDataSourceDefinition=function(e,t,r,i,s,n,o){return this._ensureLoaded().then((()=>this.databaseType())).then((u=>{let d="",c=!1,h=!1;null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(d=n.constructClause(),h=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(h=!1,c=!0,d=this._layer.objectIdField);const p=[];for(let e=0;e<t.length;e++){const r=new T;r.onStatisticField=null!==t[e].workingexpr?l.toWhereClause(t[e].workingexpr,u):"",r.outStatisticFieldName=t[e].field,r.statisticType=t[e].toStatisticsName(),p.push(r)}""===d&&(d=e.join(","));let y=this._maxQueryRate();const f=this._layer.capabilities.query.maxRecordCount;void 0!==f&&f<y&&(y=f);let _=null===s?null===i?"1=1":"":l.toWhereClause(s,u);this._layer.definitionExpression&&this._useDefinitionExpression&&(_=""!==_?"(("+this._layer.definitionExpression+") AND ("+_+"))":this._layer.definitionExpression);return new a([],["GETPAGES"],h,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(r),relationParam:this._makeRelationshipParam(r),outFields:["*"],useOIDpagination:c,generatedOid:o,resultRecordCount:y,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:p,geometry:null===i?null:i,where:_,orderByFields:d,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))},_._getAgregagtePhysicalPage=function(e,r,i){try{let r=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(r=""!==r?"("+r+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const s=e.pagesDefinition.internal.lastRetrieved,a=s,n=e.pagesDefinition.internal.lastPage,l=new R;return this._requestStandardised&&(l.sqlFormat="standard"),l.where=r,l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields,l.outStatistics=e.pagesDefinition.outStatistics,l.geometry=e.pagesDefinition.geometry,l.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.returnGeometry=e.pagesDefinition.returnGeometry,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&l.geometry&&l.spatialRelationship?c.resolve([]):this.executeQuery(l,"execute").then((r=>{if(this._checkCancelled(i),!r.hasOwnProperty("features"))return c.reject(new Error("Unnexected Result querying aggregates from layer"));const l=[];if(e.pagesDefinition.internal.lastPage!==n)return[];for(let t=0;t<r.features.length;t++)e.pagesDefinition.internal.set[a+t]=r.features[t].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<r.features.length;e++)l.push(new t({attributes:r.features[e].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===r.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=r.features[r.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===r.exceededTransferLimit&&r.features.length!==e.pagesDefinition.resultRecordCount||!1===r.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+r.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,l}))}catch(s){return c.reject(s)}},f.create=function(e,t,r,i,s){return new f({layer:new p({url:e,outFields:null===t?["*"]:t}),spatialReference:r,lrucache:i,interceptor:s})},_.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]},_.serviceUrl=function(){return n.extractServiceUrl(this._layer.parsedUrl.path)},_.queryAttachments=function(e,t,r,s,a){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const n={objectIds:[e],returnMetadata:a};return(t&&t>0||r&&r>0)&&(n.size=[t&&t>0?t:0,r&&r>0?r:t+1]),s&&s.length>0&&(n.attachmentTypes=s),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:"attachments"}),this._layer.queryAttachments(n).then((t=>{const r=[];return t&&t[e]&&t[e].forEach((t=>{const s=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();let n=null;a&&t.exifInfo&&(n=E.convertJsonToArcade(t.exifInfo,!0)),r.push(new i(t.id,t.name,t.contentType,t.size,s,n))})),r}))}return c.resolve([])},_.queryRelatedFeatures=function(e){const i={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(i.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(i.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(i.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(i.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(i.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:i,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),r(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:i}).then((e=>{if(e.data){const r={},i=e.data;if(i&&i.relatedRecordGroups){const e=i.spatialReference;for(const s of i.relatedRecordGroups){const a=s.objectId,n=[];for(const r of s.relatedRecords){r.geometry&&(r.geometry.spatialReference=e);const i=new t({geometry:r.geometry?h.fromJSON(r.geometry):null,attributes:r.attributes});n.push(i)}r[a]={features:n,exceededTransferLimit:!0===i.exceededTransferLimit}}}return r}return c.reject("Invalid Request")}))},_.getFeatureByObjectId=function(e,t){const r=new R;return r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:r,method:"execute"}),x.executeQueryJSON(this._layer.parsedUrl.path,r).then((e=>1===e.features.length?e.features[0]:null))},_.getIdentityUser=function(){return this.load().then((()=>{var e;const t=null==(e=d.id)?void 0:e.findCredential(this._layer.url);return t?t.userId:null}))},_.getOwningSystemUrl=function(){return this.load().then((()=>{var e;const t=null==(e=d.id)?void 0:e.findServerInfo(this._layer.url);if(t)return c.resolve(t.owningSystemUrl);let i=this._layer.url;const s=i.toLowerCase().indexOf("/rest/services");return i=s>-1?i.substring(0,s):i,i?(i+="/rest/info",c.create(((e,t)=>{r(i,{query:{f:"json"}}).then((t=>{let r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)}),(t=>{e("")}))}))):c.resolve("")}))},_.getDataSourceFeatureSet=function(){const e=new f({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e},e._createClass(f,[{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}}]),f}(s)}));
