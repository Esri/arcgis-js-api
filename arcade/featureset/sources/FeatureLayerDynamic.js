/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/promiseUtils","../../../geometry/support/jsonUtils","../../../kernel","../../../request","../../../Graphic","../../Attachment","../support/shared","../../../layers/graphics/featureConversionUtils","../support/IdSet","../support/sqlUtils","../support/stats","../support/FeatureSet","../../../core/MD5","../../../tasks/support/FeatureSet","../../../tasks/support/StatisticDefinition","../../../tasks/support/Query","../../../layers/FeatureLayer","../../../tasks/operations/pbfOptimizedFeatureSet","../../../tasks/operations/query","../../../tasks/QueryTask"],(function(e,t,i,r,s,a,n,l,o,u,d,h,c,p,y,f,_,g,m,F,S){"use strict";return function(c){function b(e){var t;return(t=c.call(this,e)||this).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",t._removeGeometry=!1,t._overrideFields=null,t.formulaCredential=null,t._pageJustIds=!1,t._requestStandardised=!1,e.spatialReference&&(t.spatialReference=e.spatialReference),t._transparent=!0,t._maxProcessing=1e3,t._layer=e.layer,t._wset=null,void 0!==e.outFields&&(t._overrideFields=e.outFields),void 0!==e.includeGeometry&&(t._removeGeometry=!1===e.includeGeometry),t}e._inheritsLoose(b,c);var R=b.prototype;return R._maxQueryRate=function(){return l.defaultMaxRecords},R.end=function(){return this._layer},R.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},R.convertQueryToLruCacheKey=function(e){const t=l.stableStringify(e.toJSON());return p.createMD5Hash(t,p.outputTypes.String)},R.load=function(){return null===this._loadPromise&&(this._loadPromise=t.create(((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}}),t),this._layer.load()}catch(e){t(e)}}))),this._loadPromise},R._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const i of this._layer.outFields)if(i.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}else;if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const i of this.fields)if("oid"===i.type)e.push(i),t.push(i.name);else for(const r of this._overrideFields)if(r.toLowerCase()===i.name.toLowerCase()){e.push(i),t.push(i.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=l.FeatureServiceDatabaseType.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=l.FeatureServiceDatabaseType.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=l.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=l.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},R._isInFeatureSet=function(){return l.IdState.InFeatureSet},R._refineSetBlock=function(e){return t.resolve(e)},R._candidateIdTransform=function(e){return e},R._getSet=function(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((e=>(this._wset=e,e))):t.resolve(this._wset)},R._runDatabaseProbe=function(e){return t.create(((t,i)=>{try{this._ensureLoaded().then((()=>{try{const r=new _;r.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(r).then((()=>{t(!0)}),(()=>{try{t(!1)}catch(e){i(e)}}))}catch(e){i(e)}}))}catch(e){i(e)}}))},R._canUsePagination=function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)},R._cacheableFeatureSetSourceKey=function(){return this._layer.url},R.pbfSupportedForQuery=function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode},R.queryPBF=function(e){return e.quantizationParameters={mode:"edit"},F.executeQueryPBF(this._layer.parsedUrl,e,new m.OptimizedFeatureSetParserContext({})).then((e=>y.fromJSON(o.convertToFeatureSet(e.data)).unquantize()))},R.nativeCapabilities=function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}},R.executeQuery=function(e,t){const i=new S({url:this._layer.parsedUrl.path}),r="execute"===t&&this.pbfSupportedForQuery(e);let s=null;if(this.recentlyUsedQueries){const a=this.convertQueryToLruCacheKey(e);s=this.recentlyUsedQueries.getFromCache(a),null===s&&(s=!0!==r?i[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(a,s),s=s.catch((e=>{throw this.recentlyUsedQueries.removeFromCache(a),e})))}return null===s&&(s=!0!==r?i[t](e):this.queryPBF(e)),s},R._getFilteredSet=function(e,t,i,r,s){return this.databaseType().then((a=>{if(this.isTable()&&t&&null!==e&&""!==e){return new u([],[],!0,null)}if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,i,r,s);let n="",l=!1;null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(n=r.constructClause(),l=!0);const o=new _;return o.where=null===i?null===t?"1=1":"":d.toWhereClause(i,a),this._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=this._makeRelationshipEnum(e),o.outSpatialReference=this.spatialReference,o.orderByFields=""!==n?n.split(","):null,o.geometry=null===t?null:t,o.relationParameter=this._makeRelationshipParam(e),this.executeQuery(o,"executeForIds").then((e=>{null===e&&(e=[]),this._checkCancelled(s);return new u([],e,l,null)}))}))},R._expandPagedSet=function(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)},R._getFilteredSetUsingPaging=function(e,i,r,s,a){try{let t="",n=!1;return null!==s&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(t=s.constructClause(),n=!0),this.databaseType().then((s=>{let l=null===r?null===i?"1=1":"":d.toWhereClause(r,s);this._layer.definitionExpression&&(l=""!==l?"(("+this._layer.definitionExpression+") AND ("+l+"))":this._layer.definitionExpression);let o=this._maxQueryRate();const h=this._layer.capabilities.query.maxRecordCount;void 0!==h&&h<o&&(o=h);let c=null;if(!0===this._pageJustIds)c=new u([],["GETPAGES"],n,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===i?null:i,where:l,orderByFields:t,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let r=!0;!0===this._removeGeometry&&(r=!1);const s=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);c=new u([],["GETPAGES"],n,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:s.join(","),resultRecordCount:o,resultOffset:0,geometry:null===i?null:i,where:l,orderByFields:t,returnGeometry:r,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(c,o,0,1,a).then((()=>c))}))}catch(e){return t.reject(e)}},R._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},R._getPhysicalPage=function(e,i,r){try{const t=e.pagesDefinition.internal.lastRetrieved,i=t,s=e.pagesDefinition.internal.lastPage,a=new _;return this._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParameter=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastPage,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,this.executeQuery(a,"execute").then((a=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return"done";for(let t=0;t<a.features.length;t++)e.pagesDefinition.internal.set[i+t]=a.features[t].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let e=0;e<a.features.length;e++)this._featureCache[a.features[e].attributes[this._layer.objectIdField]]=a.features[e];return(void 0===a.exceededTransferLimit&&a.features.length!==e.pagesDefinition.resultRecordCount||!1===a.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+a.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(e){return t.reject(e)}},R._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let i=!1;for(const e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){i=!0;break}return!1===i&&t.push(this.objectIdField),t},R._getFeatures=function(e,i,r,s){const a=[];try{if(-1!==i&&void 0===this._featureCache[i]&&a.push(i),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,s).then((()=>this._getFeatures(e,i,r,s)));let n=0;for(let t=e._lastFetchedIndex;t<e._known.length;t++){if(e._lastFetchedIndex+=1,n++,void 0===this._featureCache[e._known[t]]){let r=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const i=this._layer._mode;if(void 0!==i._featureMap[e._known[t]]){const s=i._featureMap[e._known[t]];null!==s&&(r=!0,this._featureCache[e._known[t]]=s)}}if(!1===r&&(e._known[t]!==i&&a.push(e._known[t]),a.length>=this._maxProcessingRate()-1))break}if(n>=r&&0===a.length)break}if(0===a.length)return t.resolve("success");try{const e=new _;return this._requestStandardised&&(e.sqlFormat="standard"),e.objectIds=a,e.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),e.returnGeometry=!0,!0===this._removeGeometry&&(e.returnGeometry=!1),e.outSpatialReference=this.spatialReference,this.executeQuery(e,"execute").then((e=>{if(this._checkCancelled(s),void 0!==e.error)return t.reject(new Error(e.error));for(let t=0;t<e.features.length;t++)this._featureCache[e.features[t].attributes[this._layer.objectIdField]]=e.features[t];return"success"}))}catch(e){return t.reject(e)}}catch(e){return t.reject(e)}},R._getDistinctPages=function(e,i,r,s,a,n,l,o,u){return this._ensureLoaded().then((()=>this.databaseType())).then((h=>{let c=r.parseTree.column;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name.toLowerCase()===c.toLowerCase()){c=this._layer.fields[e].name;break}const p=new _;this._requestStandardised&&(p.sqlFormat="standard");let y=null===n?null===a?"1=1":"":d.toWhereClause(n,h);return this._layer.definitionExpression&&(y=""!==y?"(("+this._layer.definitionExpression+") AND ("+y+"))":this._layer.definitionExpression),p.where=y,p.spatialRelationship=this._makeRelationshipEnum(s),p.relationParameter=this._makeRelationshipParam(s),p.geometry=null===a?null:a,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[c],this.executeQuery(p,"execute").then((d=>{if(this._checkCancelled(u),!d.hasOwnProperty("features"))return t.reject(new Error("Unnexected Result querying statistics from layer"));let h=!1;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name===c){"date"===this._layer.fields[e].type&&(h=!0);break}for(let e=0;e<d.features.length;e++){if(h){const t=d.features[e].attributes[c];null!==t?o.push(new Date(t)):o.push(t)}else o.push(d.features[e].attributes[c]);if(o.length>=l)break}return 0===d.features.length?o:d.features.length===this._layer.capabilities.query.maxRecordCount&&o.length<l?this._getDistinctPages(e+d.features.length,i,r,s,a,n,l,o,u).then((e=>({calculated:!0,result:e}))):o}))}))},R._distinctStat=function(e,t,i,r,s,a,n){return this._getDistinctPages(0,e,t,i,r,s,a,[],n).then((e=>({calculated:!0,result:e})))},R.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType},R._countstat=function(e,t,i,r){return this.databaseType().then((e=>{const s=new _;if(this._requestStandardised&&(s.sqlFormat="standard"),this.isTable()&&i&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===r?null===i?"1=1":"":d.toWhereClause(r,e);return this._layer.definitionExpression&&(a=""!==a?"(("+this._layer.definitionExpression+") AND ("+a+"))":this._layer.definitionExpression),s.where=a,s.where=a,s.spatialRelationship=this._makeRelationshipEnum(t),s.relationParameter=this._makeRelationshipParam(t),s.geometry=null===i?null:i,s.returnGeometry=!1,this.executeQuery(s,"executeForCount").then((e=>({calculated:!0,result:e})))}))},R._stats=function(e,i,r,s,a,n,l){return this._ensureLoaded().then((()=>{const o=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,c=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?c?this._countstat(e,r,s,a):{calculated:!1}:!1===u||!1===d.isSingleField(i)&&!1===o||!1===i.isStandardized?""!==r||null!==a?{calculated:!1}:this._manualStat(e,i,n,l):"distinct"===e?!1===c?""!==r||null!==a?{calculated:!1}:this._manualStat(e,i,n,l):this._distinctStat(e,i,r,s,a,n,l):this.databaseType().then((n=>{if(this.isTable()&&s&&null!==r&&""!==r)return{calculated:!0,result:null};const l=new _;this._requestStandardised&&(l.sqlFormat="standard");let o=null===a?null===s?"1=1":"":d.toWhereClause(a,n);this._layer.definitionExpression&&(o=""!==o?"(("+this._layer.definitionExpression+") AND ("+o+"))":this._layer.definitionExpression),l.where=o,l.spatialRelationship=this._makeRelationshipEnum(r),l.relationParameter=this._makeRelationshipParam(r),l.geometry=null===s?null:s;const u=new f;u.statisticType=h.decodeStatType(e),u.onStatisticField=d.toWhereClause(i,n),u.outStatisticFieldName="ARCADE_STAT_RESULT",l.returnGeometry=!1;let c="ARCADE_STAT_RESULT";return l.outStatistics=[u],this.executeQuery(l,"execute").then((e=>{if(!e.hasOwnProperty("features")||0===e.features.length)return t.reject(new Error("Unnexected Result querying statistics from layer"));let i=!1;for(let t=0;t<e.fields.length;t++)if("ARCADE_STAT_RESULT"===e.fields[t].name.toUpperCase()){c=e.fields[t].name,"date"===e.fields[t].type&&(i=!0);break}if(i){let t=e.features[0].attributes[c];return null!==t&&(t=new Date(e.features[0].attributes[c])),{calculated:!0,result:t}}return{calculated:!0,result:e.features[0].attributes[c]}}))}))}))},R._stat=function(e,t,i,r,s,a,n){return this._stats(e,t,i,r,s,a,n)},R._canDoAggregates=function(e,t){return this._ensureLoaded().then((()=>{let e=!1;const i=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(let r=0;r<t.length-1;r++)null!==t[r].workingexpr&&(!1===t[r].workingexpr.isStandardized||!1===d.isSingleField(t[r].workingexpr)&&!1===i)&&(e=!1);return!1!==e}))},R._makeRelationshipEnum=function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},R._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},R._getAggregatePagesDataSourceDefinition=function(e,t,i,r,s,a,n){return this._ensureLoaded().then((()=>this.databaseType())).then((l=>{let o="",h=!1,c=!1;null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(o=a.constructClause(),c=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(c=!1,h=!0,o=this._layer.objectIdField);const p=[];for(let e=0;e<t.length;e++){const i=new f;i.onStatisticField=null!==t[e].workingexpr?d.toWhereClause(t[e].workingexpr,l):"",i.outStatisticFieldName=t[e].field,i.statisticType=t[e].toStatisticsName(),p.push(i)}""===o&&(o=e.join(","));let y=this._maxQueryRate();const _=this._layer.capabilities.query.maxRecordCount;void 0!==_&&_<y&&(y=_);let g=null===s?null===r?"1=1":"":d.toWhereClause(s,l);this._layer.definitionExpression&&(g=""!==g?"(("+this._layer.definitionExpression+") AND ("+g+"))":this._layer.definitionExpression);return new u([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(i),relationParam:this._makeRelationshipParam(i),outFields:["*"],useOIDpagination:h,generatedOid:n,resultRecordCount:y,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:p,geometry:null===r?null:r,where:g,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))},R._getAgregagtePhysicalPage=function(e,i,r){try{let i=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(i=""!==i?"("+i+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const s=e.pagesDefinition.internal.lastRetrieved,n=s,l=e.pagesDefinition.internal.lastPage,o=new _;return this._requestStandardised&&(o.sqlFormat="standard"),o.where=i,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.returnGeometry=e.pagesDefinition.returnGeometry,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship?t.resolve([]):this.executeQuery(o,"execute").then((i=>{if(this._checkCancelled(r),!i.hasOwnProperty("features"))return t.reject(new Error("Unnexected Result querying aggregates from layer"));const o=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(let t=0;t<i.features.length;t++)e.pagesDefinition.internal.set[n+t]=i.features[t].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<i.features.length;e++)o.push(new a({attributes:i.features[e].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===i.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=i.features[i.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===i.exceededTransferLimit&&i.features.length!==e.pagesDefinition.resultRecordCount||!1===i.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+i.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,o}))}catch(e){return t.reject(e)}},b.create=function(e,t,i,r){return new b({layer:new g({url:e,outFields:null===t?["*"]:t}),spatialReference:i,lrucache:r})},R.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]},R.serviceUrl=function(){return l.extractServiceUrl(this._layer.parsedUrl.path)},R.queryAttachments=function(e,i,r,s){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const t={objectIds:[e]};return(i&&i>0||r&&r>0)&&(t.size=[i&&i>0?i:0,r&&r>0?r:i+1]),s&&s.length>0&&(t.attachmentTypes=s),this._layer.queryAttachments(t).then((t=>{const i=[];return t&&t[e]&&t[e].forEach((t=>{const r=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();i.push(new n(t.id,t.name,t.contentType,t.size,r))})),i}))}return t.resolve([])},R.queryRelatedFeatures=function(e){const r={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(r.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(r.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(r.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(r.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(r.outSR=JSON.stringify(e.outSpatialReference.toJSON())),s(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:r}).then((e=>{if(e.data){const t={},r=e.data;if(r&&r.relatedRecordGroups){const e=r.spatialReference;for(const s of r.relatedRecordGroups){const n=s.objectId,l=[];for(const t of s.relatedRecords){t.geometry&&(t.geometry.spatialReference=e);const r=new a({geometry:t.geometry?i.fromJSON(t.geometry):null,attributes:t.attributes});l.push(r)}t[n]={features:l,exceededTransferLimit:!0===r.exceededTransferLimit}}}return t}return t.reject("Invalid Request")}))},R.getFeatureByObjectId=function(e,t){const i=new S({url:this._layer.parsedUrl.path}),r=new _;return r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),i.execute(r).then((e=>1===e.features.length?e.features[0]:null))},R.getIdentityUser=function(){return this.load().then((()=>{var e;const t=null==(e=r.id)?void 0:e.findCredential(this._layer.url);return t?t.userId:null}))},R.getOwningSystemUrl=function(){return this.load().then((()=>{var e;const i=null==(e=r.id)?void 0:e.findServerInfo(this._layer.url);if(i)return t.resolve(i.owningSystemUrl);let a=this._layer.url;const n=a.toLowerCase().indexOf("/rest/services");return a=n>-1?a.substring(0,n):a,a?(a+="/rest/info",t.create(((e,t)=>{s(a,{query:{f:"json"}}).then((t=>{let i="";t.data&&t.data.owningSystemUrl&&(i=t.data.owningSystemUrl),e(i)}),(t=>{e("")}))}))):t.resolve("")}))},e._createClass(b,[{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}}]),b}(c)}));
