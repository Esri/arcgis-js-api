// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.36/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};define(["require","exports","dojox/encoding/digests/_base","dojox/encoding/digests/MD5","../../../graphic","../../../IdentityManager","../../../request","../../../sniff","../../../SpatialReference","../../../urlUtils","../../Attachment","../support/cache","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../polyfill/promiseUtils","../../../geometry/Extent","../../../geometry/jsonUtils","../../../layers/FeatureType","../../../layers/Field","../../../tasks/query","../../../tasks/QueryTask","../../../tasks/StatisticDefinition"],(function(e,t,r,a,i,n,s,o,l,u,d,p,c,y,f,h,_,g,m,v,b,F,R,S,C){"use strict";var I=!!o("esri-pbf"),x=!!o("esri-featurelayer-pbf"),D=function(){function e(e,t,r){void 0===r&&(r=null),this.url=e,this.outFields=t,this.spatialReference=r,this._url=null,this.supportsFormatPBF=!1,this.supportsQuantizationEditMode=!1,this.metadata=null,this.supportsAttachments=!1,this.relationships=[],this._loadPromise=null,this._queryTask=null,this.gdbVersion="",this.currentVersion=0,this.useStandardizedQueries=!1,this.fields=[],this._url=u.urlToObject(e)}return e.prototype._canFetchPBFForQuery=function(e){return I&&x&&this.supportsFormatPBF&&!e.outStatistics&&this.supportsQuantizationEditMode},e.prototype._loadMetaData=function(e){if(null!==p.applicationCache){var t=p.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=g.create((function(t,r){s({url:e,content:{f:"json"},callbackParamName:"callback",load:function(e){t(e)},error:function(e){r(e)}})}));return null!==p.applicationCache&&(p.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw p.applicationCache.clearLayerInfo(e),t}))),r},e.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=g.create((function(t,r){var a=e._url.path;e._loadMetaData(a).then((function(i){try{if(e.metadata=i,e.relationships=i.relationships,e._queryTask=new S(a),e.objectIdField=i.objectIdField,e.globalIdField=i.globalIdField,e.supportsAttachments=!0===i.hasAttachments,!e.objectIdField)for(var n=i.fields,s=0;s<n.length;s++){var o=n[s];if("esriFieldTypeOID"===o.type){e.objectIdField=o.name;break}}if(e.geometryType=i.geometryType,e.typeIdField=i.typeIdField,e.fullExtent=new m(i.fullExtent),e.advancedQueryCapabilities=i.advancedQueryCapabilities||{supportsStatistics:i.supportsStatistics,supportsOrderBy:i.supportsAdvancedQueries,supportsDistinct:i.supportsAdvancedQueries},i.supportedQueryFormats)for(var u=0,d=i.supportedQueryFormats.split(",");u<d.length;u++){if("pbf"===d[u].replace(/^\s+|\s+$/gm,"").toLowerCase()){e.supportsFormatPBF=!0;break}}if(!0===i.supportsQuantizationEditMode&&(e.supportsQuantizationEditMode=!0),!0===i.useStandardizedQueries&&(e.useStandardizedQueries=!0),void 0!==i.currentVersion&&(e.currentVersion=i.currentVersion),i.types){e.types=[];for(var p=0,c=i.types;p<c.length;p++){var y=c[p],f=new b(y);e.types.push(f)}}if(i.spatialReference&&!e.spatialReference&&(e.spatialReference=new l(i.spatialReference)),1===e.outFields.length&&"*"===e.outFields[0])for(var h=0,_=i.fields;h<_.length;h++){y=_[h];var g=new F(y);e.fields.push(g)}else for(var v=0,R=i.fields;v<R.length;v++){if("esriFieldTypeOID"===(y=R[v]).type){g=new F(y);e.fields.push(g)}else{for(var C=!1,I=0,x=e.outFields;I<x.length;I++){var D=x[I];if(y.name.toUpperCase()===D.toUpperCase()){C=!0;break}}if(C){g=new F(y);e.fields.push(g)}}}e.definitionExpression="",t(e)}catch(e){r(e)}}),r)}))),this._loadPromise},e.prototype.queryIds=function(e){var t=this;return g.create((function(r,a){t._queryTask.executeForIds(e,r,a)}))},e.prototype.queryAttachments=function(e){var t=this,r=__assign(__assign({},e),{f:"json"});return r.objectIds.length>0&&(r.objectIds=r.objectIds.join(",")),r.size&&(r.size=r.size.join(",")),r.attachmentTypes&&(r.attachmentTypes=r.attachmentTypes.join(",")),g.create((function(e,a){s({url:t._url.path+"/queryAttachments",content:r,callbackParamName:"callback",load:function(t){var r={};if(t&&t.attachmentGroups)for(var a=0,i=t.attachmentGroups;a<i.length;a++){var n=i[a];void 0===r[n.parentObjectId]&&(r[n.parentObjectId]=[]);for(var s=0,o=n.attachmentInfos;s<o.length;s++){var l=o[s];r[n.parentObjectId].push({id:l.id,globalId:l.globalId,name:l.name,contentType:l.contentType,size:l.size})}}e(r)},error:function(e){a(e)}})}))},e}();return function(e){function t(t){var r=e.call(this,t)||this;return r._layer=null,r._removeGeometry=!1,r.formulaCredential=null,r._pageJustIds=!1,r._requestStandardised=!1,t.spatialReference&&(r.spatialReference=t.spatialReference),r._layer=new D(t.url,t.outFields,r.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._wset=null,void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return __extends(t,e),t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype._maxQueryRate=function(){return f.defaultMaxRecords},t.prototype.convertQueryToLruCacheKey=function(e){var t=f.stableStringify(e.toJson());return a(t,r.outputTypes.String)},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=g.create((function(t,r){e._layer.load().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(e){r(e)}}),(function(e){r(e)}))}))),this._loadPromise},t.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,void 0===this.geometryType&&(this.geometryType=""),this.fields=this._layer.fields.slice(0);var e=this._layer.currentVersion;!0===this._layer.useStandardizedQueries?(this._databaseType=f.FeatureServiceDatabaseType.StandardisedNoInterval,null!=e&&e>=10.7&&(this._databaseType=f.FeatureServiceDatabaseType.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=f.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),e>=10.7&&(this._databaseType=f.FeatureServiceDatabaseType.Standardised)),this.objectIdField=this._layer.objectIdField,this.globalIdField=this._layer.globalIdField,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return f.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e,t){return g.resolve(e)},t.prototype._candidateIdTransform=function(e){return e},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):g.resolve(this._wset)},t.prototype.nativeCapabilities=function(){return{title:this._layer.metadata.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return this._layer&&this._layer.metadata&&this._layer.metadata.isDataVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""},enumerable:!1,configurable:!0}),t.prototype._runDatabaseProbe=function(e){var t=this;return g.create((function(r,a){try{t._ensureLoaded().then((function(){try{var i=new R;i.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryIds(i).then((function(e){r(!0)}),(function(e){try{r(!1)}catch(e){a(e)}}))}catch(e){a(e)}}))}catch(e){a(e)}}))},t.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype._getFilteredSet=function(e,t,r,a,i){var n=this;return this.databaseType().then((function(s){if(n.isTable()&&t&&null!==e&&""!==e)return new y([],[],!0,null);if(n._canUsePagination())return n._getFilteredSetUsingPaging(e,t,r,a,i);var o="",l=!1;null!==a&&void 0!==n._layer.advancedQueryCapabilities&&null!==n._layer.advancedQueryCapabilities&&!0===n._layer.advancedQueryCapabilities.supportsOrderBy&&(o=a.constructClause(),l=!0);var u=new R;return n._requestStandardised&&(u.sqlFormat="standard"),u.where=null===r?null===t?"1=1":"":h.toWhereClause(r,s),u.spatialRelationship=n._makeRelationshipEnum(e),u.outSpatialReference=n.spatialReference,u.orderByFields=""!==o?o.split(","):null,u.geometry=null===t?null:t,u.relationParam=n._makeRelationshipParam(e),n.executeQuery(u,"executeForIds").then((function(e){return null===e&&(e=[]),n._checkCancelled(i),new y([],e,l,null)}))}))},t.prototype._expandPagedSet=function(e,t,r,a,i){return this._expandPagedSetFeatureSet(e,t,r,a,i)},t.prototype._getFilteredSetUsingPaging=function(e,t,r,a,i){var n=this;try{var s="",o=!1;return null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(s=a.constructClause(),o=!0),this.databaseType().then((function(a){var l=null===r?null===t?"1=1":"":h.toWhereClause(r,a);n._layer.definitionExpression&&(l=""!==l?"(("+n._layer.definitionExpression+") AND ("+l+"))":n._layer.definitionExpression);var u=n._maxQueryRate();void 0!==n._layer.maxRecordCount&&n._layer.maxRecordCount<u&&(u=n._layer.maxRecordCount);var d=null;if(!0===n._pageJustIds)d=new y([],["GETPAGES"],o,{spatialRel:n._makeRelationshipEnum(e),relationParam:n._makeRelationshipParam(e),outFields:n._layer.objectIdField,resultRecordCount:u,resultOffset:0,geometry:null===t?"":t,where:l,orderByFields:s,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});else{var p=!0;!0===n._removeGeometry&&(p=!1);var c=n._fieldsIncludingObjectId(n._layer.outFields);d=new y([],["GETPAGES"],o,{spatialRel:n._makeRelationshipEnum(e),relationParam:n._makeRelationshipParam(e),outFields:c.join(","),resultRecordCount:u,resultOffset:0,geometry:null===t?"":t,where:l,orderByFields:s,returnGeometry:p,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})}return n._expandPagedSet(d,u,0,1,i).then((function(e){return d}))}))}catch(e){return g.reject(e)}},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,r){var a=this;try{var i=e.pagesDefinition.internal.lastRetrieved,n=i,s=new R;return this._requestStandardised&&(s.sqlFormat="standard"),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParam=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastRetrieved,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,this.executeQuery(s,"execute").then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastRetrieved!==i)return"done";for(var s=0;s<t.features.length;s++)void 0===t.features[s].geometry&&(t.features[s].geometry=null),e.pagesDefinition.internal.set[n+s]=t.features[s].attributes[a._layer.objectIdField];if(!1===a._pageJustIds)for(s=0;s<t.features.length;s++)a._featureCache[t.features[s].attributes[a._layer.objectIdField]]=t.features[s];return t.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+e.pagesDefinition.resultRecordCount,"done"}))}catch(e){return g.reject(e)}},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,a=0,i=t;a<i.length;a++){if(i[a].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,r,a){var i=this,n=[];try{if(-1!==t&&void 0===this._featureCache[t]&&n.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,a).then((function(n){return i._getFeatures(e,t,r,a)}));for(var s=0,o=e._lastFetchedIndex;o<e._known.length;o++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[o]]){var l=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var u=this._layer._mode;if(void 0!==u._featureMap[e._known[o]]){var d=u._featureMap[e._known[o]];null!==d&&(l=!0,this._featureCache[e._known[o]]=d)}}if(!1===l&&(e._known[o]!==t&&n.push(e._known[o]),n.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===n.length)break}if(0===n.length)return g.resolve("success");try{var p=new R;return this._requestStandardised&&(p.sqlFormat="standard"),p.objectIds=n,p.outFields=this._fieldsIncludingObjectId(this._layer.outFields),p.returnGeometry=!0,!0===this._removeGeometry&&(p.returnGeometry=!1),p.outSpatialReference=this.spatialReference,this.executeQuery(p,"execute").then((function(e){if(i._checkCancelled(a),void 0!==e.error)return g.reject(new Error(e.error));for(var t=0;t<e.features.length;t++)void 0===e.features[t].geometry&&(e.features[t].geometry=null),i._featureCache[e.features[t].attributes[i._layer.objectIdField]]=e.features[t];return"success"}))}catch(e){return g.reject(e)}}catch(e){return g.reject(e)}},t.prototype._layerUrl=function(){return this._layer.url},t.prototype.pbfSupportedForQuery=function(e){return this._layer._canFetchPBFForQuery(e)},t.prototype.executeQuery=function(e,t){var r=new S(this._layerUrl()),a="execute"===t&&this.pbfSupportedForQuery(e);a&&(e.quantizationParameters={mode:"edit"});var i=null;if(this.recentlyUsedQueries){var n=this.convertQueryToLruCacheKey(e);(i=this.recentlyUsedQueries.getFromCache(n))&&i.isRejected()&&(i=null,this.recentlyUsedQueries.removeFromCache(n)),null===i&&(i=!0!==a?r[t](e):r[t](e,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(n,i))}return null===i&&(i=!0!==a?r[t](e):r[t](e,null,null,{format:"pbf"})),i},t.prototype._getDistinctPages=function(e,t,r,a,i,n,s,o,l){var u=this;return this._ensureLoaded().then((function(){for(var d=r.parseTree.column,p=0;p<u._layer.fields.length;p++)if(u._layer.fields[p].name.toLowerCase()===d.toLowerCase()){d=u._layer.fields[p].name;break}return u.databaseType().then((function(p){var c=new R;u._requestStandardised&&(c.sqlFormat="standard");var y=null===n?null===i?"1=1":"":h.toWhereClause(n,p);return u._layer.definitionExpression&&(y=""!==y?"(("+u._layer.definitionExpression+") AND ("+y+"))":u._layer.definitionExpression),c.where=y,c.spatialRelationship=u._makeRelationshipEnum(a),c.relationParam=u._makeRelationshipParam(a),c.geometry=null===i?null:i,c.returnDistinctValues=!0,c.returnGeometry=!1,c.outFields=[d],u.executeQuery(c,"execute").then((function(p){if(u._checkCancelled(l),!p.hasOwnProperty("features"))return g.reject(new Error("Unnexected Result querying statistics from layer"));for(var c=!1,y=0;y<u._layer.fields.length;y++)if(u._layer.fields[y].name===d){"esriFieldTypeDate"===u._layer.fields[y].type&&(c=!0);break}for(y=0;y<p.features.length;y++){if(c){var f=p.features[y].attributes[d];null!==f?o.push(new Date(f)):o.push(f)}else o.push(p.features[y].attributes[d]);if(o.length>=s)break}return 0===p.features.length?o:p.features.length===u._layer.maxRecordCount&&o.length<s?u._getDistinctPages(e+p.features.length,t,r,a,i,n,s,o,l).then((function(e){return{calculated:!0,result:e}})):o}))}))}))},t.prototype._distinctStat=function(e,t,r,a,i,n,s){return this._getDistinctPages(0,e,t,r,a,i,n,[],s).then((function(e){return{calculated:!0,result:e}}))},t.prototype.isTable=function(){return null===this._layer.geometryType||""===this._layer.geometryType||void 0===this._layer.geometryType},t.prototype._countstat=function(e,t,r,a,i){var n=this;return this.databaseType().then((function(e){var i=new R;if(n._requestStandardised&&(i.sqlFormat="standard"),n.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var s=null===a?null===r?"1=1":"":h.toWhereClause(a,e);return n._layer.definitionExpression&&(s=""!==s?"(("+n._layer.definitionExpression+") AND ("+s+"))":n._layer.definitionExpression),i.where=s,i.where=s,i.spatialRelationship=n._makeRelationshipEnum(t),i.relationParam=n._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1,n.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))},t.prototype._stats=function(e,t,r,a,i,n,s){var o=this;return this._ensureLoaded().then((function(){var l=o._layer.advancedQueryCapabilities&&!0===o._layer.advancedQueryCapabilities.supportsSqlExpression,u=o._layer.advancedQueryCapabilities&&!0===o._layer.advancedQueryCapabilities.supportsStatistics,d=o._layer.advancedQueryCapabilities&&!0===o._layer.advancedQueryCapabilities.supportsDistinct;return"count"===e?d?o._countstat(e,r,a,i,s):{calculated:!1}:!1===u||!1===h.isSingleField(t)&&!1===l||!1===t.isStandardized?""!==r||null!==i?{calculated:!1}:o._manualStat(e,t,n,s):"distinct"===e?!1===d?""!==r||null!==i?{calculated:!1}:o._manualStat(e,t,n,s):o._distinctStat(e,t,r,a,i,n,s):o.databaseType().then((function(n){if(o.isTable()&&a&&null!==r&&""!==r)return{calculated:!0,result:null};var s=new R;o._requestStandardised&&(s.sqlFormat="standard");var l=null===i?null===a?"1=1":"":h.toWhereClause(i,n);o._layer.definitionExpression&&(l=""!==l?"(("+o._layer.definitionExpression+") AND ("+l+"))":o._layer.definitionExpression),s.where=l,s.spatialRelationship=o._makeRelationshipEnum(r),s.relationParam=o._makeRelationshipParam(r),s.geometry=null===a?null:a;var u=new C;u.statisticType=_.decodeStatType(e),u.onStatisticField=h.toWhereClause(t,n),u.outStatisticFieldName="ARCADE_STAT_RESULT";var d="ARCADE_STAT_RESULT";return s.returnGeometry=!1,s.outStatistics=[u],o.executeQuery(s,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return g.reject(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){d=e.fields[r].name,"esriFieldTypeDate"===e.fields[r].type&&(t=!0);break}if(t){var a=e.features[0].attributes[d];return null!==a&&(a=new Date(e.features[0].attributes[d])),{calculated:!0,result:a}}return{calculated:!0,result:e.features[0].attributes[d]}}))}))}))},t.prototype._stat=function(e,t,r,a,i,n,s){return this._stats(e,t,r,a,i,n,s)},t.prototype._canDoAggregates=function(e,t,r,a,i){var n=this;return this._ensureLoaded().then((function(e){var r=!1,a=n._layer.advancedQueryCapabilities&&!0===n._layer.advancedQueryCapabilities.supportsSqlExpression;if(void 0!==n._layer.advancedQueryCapabilities&&null!==n._layer.advancedQueryCapabilities&&!0===n._layer.advancedQueryCapabilities.supportsStatistics&&!0===n._layer.advancedQueryCapabilities.supportsOrderBy&&(r=!0),r)for(var i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized?r=!1:!1===h.isSingleField(t[i].workingexpr)&&!1===a&&(r=!1));return!1!==r}))},t.prototype._makeRelationshipEnum=function(e){return e.indexOf("esriSpatialRelRelation")>=0?"esriSpatialRelRelation":e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,a,i,n,s){var o=this;return this._ensureLoaded().then((function(l){return o.databaseType().then((function(l){var u="",d=!1,p=!1;null!==n&&void 0!==o._layer.advancedQueryCapabilities&&null!==o._layer.advancedQueryCapabilities&&!0===o._layer.advancedQueryCapabilities.supportsOrderBy&&(u=n.constructClause(),p=!0),void 0!==o._layer.advancedQueryCapabilities&&null!==o._layer.advancedQueryCapabilities&&!1===o._layer.advancedQueryCapabilities.supportsPagination&&(p=!1,d=!0,u=o._layer.objectIdField);for(var c=[],f=0;f<t.length;f++){var _=new C;_.onStatisticField=null!==t[f].workingexpr?h.toWhereClause(t[f].workingexpr,l):"",_.outStatisticFieldName=t[f].field,_.statisticType=t[f].toStatisticsName(),c.push(_)}""===u&&(u=e.join(","));var g=o._maxQueryRate();void 0!==o._layer.maxRecordCount&&o._layer.maxRecordCount<g&&(g=o._layer.maxRecordCount);var m=null===i?null===a?"1=1":"":h.toWhereClause(i,l);return o._layer.definitionExpression&&(m=""!==m?"(("+o._layer.definitionExpression+") AND ("+m+"))":o._layer.definitionExpression),new y([],["GETPAGES"],p,{groupbypage:!0,spatialRel:o._makeRelationshipEnum(r),relationParam:o._makeRelationshipParam(r),outFields:["*"],useOIDpagination:d,generatedOid:s,resultRecordCount:g,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:c,geometry:null===a?null:a,where:m,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})}))}))},t.prototype._getAgregagtePhysicalPage=function(e,t,r){var a=this;try{var n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var s=e.pagesDefinition.internal.lastRetrieved,o=s,l=new R;return this._requestStandardised&&(l.sqlFormat="standard"),l.where=n,l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParam=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields,l.outStatistics=e.pagesDefinition.outStatistics,l.geometry=e.pagesDefinition.geometry,l.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastRetrieved,l.returnGeometry=e.pagesDefinition.returnGeometry,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&l.geometry&&l.spatialRelationship?g.resolve([]):this.executeQuery(l,"execute").then((function(t){if(a._checkCancelled(r),!t.hasOwnProperty("features"))return g.reject(new Error("Unnexected Result querying aggregates from layer"));var n=[];if(e.pagesDefinition.internal.lastRetrieved!==s)return g.resolve([]);for(var l=0;l<t.features.length;l++)void 0===t.features[l].geometry&&(t.features[l].geometry=null),e.pagesDefinition.internal.set[o+l]=t.features[l].attributes[e.pagesDefinition.generatedOid];for(l=0;l<t.features.length;l++)n.push(new i({attributes:t.features[l].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:t.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+e.pagesDefinition.resultRecordCount,n}))}catch(e){return g.reject(e)}},t.create=function(e,r,a){return new t({url:e,outFields:null===r?["*"]:r,spatialReference:a})},t.prototype.queryAttachments=function(e,t,r,a){var i=this;if(this._layer.supportsAttachments){var n={objectIds:[e]};return(t&&t>0||r&&r>0)&&(n.size=[t&&t>0?t:0,r&&r>0?r:t+1]),a&&a.length>0&&(n.attachmentTypes=a),this._layer.queryAttachments(n).then((function(t){var r=[];if(t&&t[e]){var a=i._layer._url.path;t[e].forEach((function(t){var i=a+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new d(t.id,t.name,t.contentType,t.size,i))}))}return r}))}return g.resolve([])},t.prototype.serviceUrl=function(){return f.extractServiceUrl(this._layer._url.path)},t.prototype.relationshipMetaData=function(){return this._layer.relationships},t.prototype.queryRelatedFeatures=function(e){var t=this,r={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.definitionExpression,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(r.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(r.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(r.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(r.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(r.outSR=JSON.stringify(e.outSpatialReference.toJson())),g.create((function(e,a){s({url:t._layer._url.path+"/queryRelatedRecords",content:r,callbackParamName:"callback",load:function(t){var r={};if(t&&t.relatedRecordGroups)for(var a=t.spatialReference,n=0,s=t.relatedRecordGroups;n<s.length;n++){for(var o=s[n],l=o.objectId,u=[],d=0,p=o.relatedRecords;d<p.length;d++){var c=p[d];c.geometry&&(c.geometry.spatialReference=a);var y=new i({geometry:c.geometry?v.fromJson(c.geometry):null,attributes:c.attributes});u.push(y)}r[l]={features:u,exceededTransferLimit:!0===t.exceededTransferLimit}}e(r)},error:function(e){a(e)}})}))},t.prototype.getFeatureByObjectId=function(e,t){var r=new S(this._layer._url.path),a=new R;return a.outFields=t,a.returnGeometry=!1,a.outSpatialReference=this.spatialReference,a.where=this.objectIdField+"="+e.toString(),r.execute(a).then((function(e){return 1===e.features.length?e.features[0]:null}))},t.prototype.getIdentityUser=function(){var e=this;return this.load().then((function(){return g.resolve(n.findCredential(e._layer._url.path))})).then((function(e){return e?e.userId:null}))},t.prototype.getOwningSystemUrl=function(){var e=this;return this.load().then((function(){var t=n.findServerInfo(e._layer._url.path);if(t)return g.resolve(t.owningSystemUrl);var r=e._layer.url,a=r.toLowerCase().indexOf("/rest/services");return(r=a>-1?r.substring(0,a):r)?(r+="/rest/info",g.create((function(e){s({url:r,content:{f:"json"},callbackParamName:"callback",load:function(t){var r="";t&&t.owningSystemUrl&&(r=t.owningSystemUrl),e(r)},error:function(t){e("")}})}))):g.resolve("")}))},t}(c)}));