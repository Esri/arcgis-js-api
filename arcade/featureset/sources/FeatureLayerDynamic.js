// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/extends","dojox/encoding/digests/_base","dojox/encoding/digests/MD5","../../../graphic","../../../IdentityManager","../../../request","../../../sniff","../../Attachment","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../../geometry/jsonUtils","../../../tasks/query","../../../tasks/QueryTask","../../../tasks/StatisticDefinition","../../Dictionary","./FeatureLayerSource"],(function(e,t,r,i,n,a,s,o,l,u,d,c,p,h,y,f,_,g,m,b,v,R,S,F){"use strict";c("esri-pbf"),c("esri-featurelayer-pbf");return function(e){function t(t){var r=e.call(this,t)||this;return r._layer=null,r._removeGeometry=!1,r.formulaCredential=null,r._pageJustIds=!1,r._requestStandardised=!1,r._useDefinitionExpression=!0,t.spatialReference&&(r.spatialReference=t.spatialReference),r._layer=new F(t.url,t.outFields,r.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._wset=null,void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return a(t,e),t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype._maxQueryRate=function(){return f.defaultMaxRecords},t.prototype.convertQueryToLruCacheKey=function(e){var t=f.stableStringify(e.toJson());return o(t,s.outputTypes.String)},t.prototype.loadImpl=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this._layer.load()];case 1:return e.sent(),this._initialiseFeatureSet(),[2,this]}}))}))},t.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,void 0===this.geometryType&&(this.geometryType=""),this.fields=this._layer.fields.slice(0);var e=this._layer.currentVersion;!0===this._layer.useStandardizedQueries?(this._databaseType=f.FeatureServiceDatabaseType.StandardisedNoInterval,null!=e&&e>=10.7&&(this._databaseType=f.FeatureServiceDatabaseType.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=f.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),e>=10.7&&(this._databaseType=f.FeatureServiceDatabaseType.Standardised)),this.objectIdField=this._layer.objectIdField,this.globalIdField=this._layer.globalIdField,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return f.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e,t){return r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,e]}))}))},t.prototype._candidateIdTransform=function(e){return e},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._getSet=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return r.sent(),[4,this._getFilteredSet("",null,null,null,e)];case 2:return t=r.sent(),this._wset=t,[2,t];case 3:return[2,this._wset]}}))}))},t.prototype.nativeCapabilities=function(){return{title:this._layer.metadata.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return this._layer&&this._layer.metadata&&this._layer.metadata.isDataVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""},enumerable:!1,configurable:!0}),t.prototype._runDatabaseProbe=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:r.sent(),r.label=2;case 2:return r.trys.push([2,4,,5]),(t=new b).where=e.replace("OBJECTID",this._layer.objectIdField),[4,this._layer.queryIds(t)];case 3:return r.sent(),[2,!0];case 4:return r.sent(),[2,!1];case 5:return[2]}}))}))},t.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype._getFilteredSet=function(e,t,n,a,s){return r(this,void 0,void 0,(function(){var r,o,l,u,d;return i(this,(function(i){switch(i.label){case 0:return[4,this.databaseType()];case 1:return r=i.sent(),this.isTable()&&t&&null!==e&&""!==e?[2,new y([],[],!0,null)]:this._canUsePagination()?[2,this._getFilteredSetUsingPaging(e,t,n,a,s)]:(o="",l=!1,null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(o=a.constructClause(),l=!0),u=new b,this._requestStandardised&&(u.sqlFormat="standard"),u.where=null===n?null===t?"1=1":"":_.toWhereClause(n,r),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==o?o.split(","):null,u.geometry=null===t?null:t,u.relationParam=this._makeRelationshipParam(e),[4,this.executeQuery(u,"executeForIds")]);case 2:return null===(d=i.sent())&&(d=[]),this._checkCancelled(s),[2,new y([],d,l,null)]}}))}))},t.prototype._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},t.prototype._getFilteredSetUsingPaging=function(e,t,n,a,s){return r(this,void 0,void 0,(function(){var r,o,l,u,d,c,p,h;return i(this,(function(i){switch(i.label){case 0:return r="",o=!1,null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(r=a.constructClause(),o=!0),[4,this.databaseType()];case 1:return l=i.sent(),u=null===n?null===t?"1=1":"":_.toWhereClause(n,l),this._layer.definitionExpression&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.definitionExpression+") AND ("+u+"))":this._layer.definitionExpression),d=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<d&&(d=this._layer.maxRecordCount),c=null,!0===this._pageJustIds?c=new y([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:r,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}}):(p=!0,!0===this._removeGeometry&&(p=!1),h=this._fieldsIncludingObjectId(this._layer.outFields),c=new y([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:r,returnGeometry:p,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})),[4,this._expandPagedSet(c,d,0,1,s)];case 2:return i.sent(),[2,c]}}))}))},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,n){return r(this,void 0,void 0,(function(){var t,r,a,s,o;return i(this,(function(i){switch(i.label){case 0:return t=e.pagesDefinition.internal.lastRetrieved,r=t,a=new b,this._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParam=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastRetrieved,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,[4,this.executeQuery(a,"execute")];case 1:if(s=i.sent(),this._checkCancelled(n),e.pagesDefinition.internal.lastRetrieved!==t)return[2,"done"];for(o=0;o<s.features.length;o++)void 0===s.features[o].geometry&&(s.features[o].geometry=null),e.pagesDefinition.internal.set[r+o]=s.features[o].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(o=0;o<s.features.length;o++)this._featureCache[s.features[o].attributes[this._layer.objectIdField]]=s.features[o];return s.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+e.pagesDefinition.resultRecordCount,[2,"done"]}}))}))},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,i=0,n=t;i<n.length;i++){if(n[i].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,n,a){return r(this,void 0,void 0,(function(){var r,s,o,l,u,d,c,p;return i(this,(function(i){switch(i.label){case 0:return r=[],-1!==t&&void 0===this._featureCache[t]&&r.push(t),!0!==this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate())?[3,2]:[4,this._expandPagedSet(e,this._maxProcessingRate(),0,0,a)];case 1:return i.sent(),[2,this._getFeatures(e,t,n,a)];case 2:for(s=0,p=e._lastFetchedIndex;p<e._known.length&&(e._lastFetchedIndex+=1,s++,!(void 0===this._featureCache[e._known[p]]&&(o=!1,null!==this._layer._mode&&void 0!==this._layer._mode&&void 0!==(l=this._layer._mode)._featureMap[e._known[p]]&&null!==(u=l._featureMap[e._known[p]])&&(o=!0,this._featureCache[e._known[p]]=u),!1===o&&(e._known[p]!==t&&r.push(e._known[p]),r.length>=this._maxProcessingRate()-1))))&&!(s>=n&&0===r.length);p++);return 0===r.length?[2,"success"]:(d=new b,this._requestStandardised&&(d.sqlFormat="standard"),d.objectIds=r,d.outFields=this._fieldsIncludingObjectId(this._layer.outFields),d.returnGeometry=!0,!0===this._removeGeometry&&(d.returnGeometry=!1),d.outSpatialReference=this.spatialReference,[4,this.executeQuery(d,"execute")]);case 3:if(c=i.sent(),this._checkCancelled(a),void 0!==c.error)throw new Error(c.error);for(p=0;p<c.features.length;p++)void 0===c.features[p].geometry&&(c.features[p].geometry=null),this._featureCache[c.features[p].attributes[this._layer.objectIdField]]=c.features[p];return[2,"success"]}}))}))},t.prototype._layerUrl=function(){return this._layer.url},t.prototype.pbfSupportedForQuery=function(e){return this._layer._canFetchPBFForQuery(e)},t.prototype.executeQuery=function(e,t){return r(this,void 0,void 0,(function(){var r,n,a,s,o,l;return i(this,(function(i){switch(i.label){case 0:if(r=new v(this._layerUrl()),(n="execute"===t&&this.pbfSupportedForQuery(e))&&(e.quantizationParameters={mode:"edit"}),a=null,!this.recentlyUsedQueries)return[3,5];if(s=this.convertQueryToLruCacheKey(e),null!==(a=this.recentlyUsedQueries.getFromCache(s)))return[3,5];a=!0!==n?r[t](e):r[t](e,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(s,a),o=null,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,a];case 2:return o=i.sent(),[3,4];case 3:throw l=i.sent(),this.recentlyUsedQueries.removeFromCache(s),l;case 4:return[2,o];case 5:return null===a&&(a=!0!==n?r[t](e):r[t](e,null,null,{format:"pbf"})),[2,a]}}))}))},t.prototype._getDistinctPages=function(e,t,n,a,s,o,l,u,d){return r(this,void 0,void 0,(function(){var r,c,p,h,y,f,g,m;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:for(i.sent(),r=n.parseTree.column,g=0;g<this._layer.fields.length;g++)if(this._layer.fields[g].name.toLowerCase()===r.toLowerCase()){r=this._layer.fields[g].name;break}return[4,this.databaseType()];case 2:return c=i.sent(),p=new b,this._requestStandardised&&(p.sqlFormat="standard"),h=null===o?null===s?"1=1":"":_.toWhereClause(o,c),this._layer.definitionExpression&&this._useDefinitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression),p.where=h,p.spatialRelationship=this._makeRelationshipEnum(a),p.relationParam=this._makeRelationshipParam(a),p.geometry=null===s?null:s,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[r],[4,this.executeQuery(p,"execute")];case 3:if(y=i.sent(),this._checkCancelled(d),!y.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");for(f=!1,g=0;g<this._layer.fields.length;g++)if(this._layer.fields[g].name===r){"esriFieldTypeDate"===this._layer.fields[g].type&&(f=!0);break}for(g=0;g<y.features.length&&(f?null!==(m=y.features[g].attributes[r])?u.push(new Date(m)):u.push(m):u.push(y.features[g].attributes[r]),!(u.length>=l));g++);return 0===y.features.length?[2,u]:y.features.length===this._layer.maxRecordCount&&u.length<l?[4,this._getDistinctPages(e+y.features.length,t,n,a,s,o,l,u,d)]:[3,5];case 4:return[2,{calculated:!0,result:i.sent()}];case 5:return[2,u]}}))}))},t.prototype._distinctStat=function(e,t,n,a,s,o,l){return r(this,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,this._getDistinctPages(0,e,t,n,a,s,o,[],l)];case 1:return[2,{calculated:!0,result:r.sent()}]}}))}))},t.prototype.isTable=function(){return null===this._layer.geometryType||""===this._layer.geometryType||void 0===this._layer.geometryType},t.prototype._countstat=function(e,t,n,a,s){return r(this,void 0,void 0,(function(){var e,r,s;return i(this,(function(i){switch(i.label){case 0:return[4,this.databaseType()];case 1:return e=i.sent(),r=new b,this._requestStandardised&&(r.sqlFormat="standard"),this.isTable()&&n&&null!==t&&""!==t?[2,{calculated:!0,result:0}]:(s=null===a?null===n?"1=1":"":_.toWhereClause(a,e),this._layer.definitionExpression&&this._useDefinitionExpression&&(s=""!==s?"(("+this._layer.definitionExpression+") AND ("+s+"))":this._layer.definitionExpression),r.where=s,r.where=s,r.spatialRelationship=this._makeRelationshipEnum(t),r.relationParam=this._makeRelationshipParam(t),r.geometry=null===n?null:n,r.returnGeometry=!1,[4,this.executeQuery(r,"executeForCount")]);case 2:return[2,{calculated:!0,result:i.sent()}]}}))}))},t.prototype._stats=function(e,t,n,a,s,o,l){return r(this,void 0,void 0,(function(){var r,u,d,c,p,h,y,f,m,v,S,F;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:return i.sent(),r=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,u=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics,d=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsDistinct,"count"===e?d?[2,this._countstat(e,n,a,s,l)]:[2,{calculated:!1}]:!1===u||!1===_.isSingleField(t)&&!1===r||!1===t.isStandardized?""!==n||null!==s?[2,{calculated:!1}]:[2,this._manualStat(e,t,o,l)]:"distinct"===e?!1===d?""!==n||null!==s?[2,{calculated:!1}]:[2,this._manualStat(e,t,o,l)]:[2,this._distinctStat(e,t,n,a,s,o,l)]:[4,this.databaseType()];case 2:return c=i.sent(),this.isTable()&&a&&null!==n&&""!==n?[2,{calculated:!0,result:null}]:(p=new b,this._requestStandardised&&(p.sqlFormat="standard"),h=null===s?null===a?"1=1":"":_.toWhereClause(s,c),this._layer.definitionExpression&&this._useDefinitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression),p.where=h,p.spatialRelationship=this._makeRelationshipEnum(n),p.relationParam=this._makeRelationshipParam(n),p.geometry=null===a?null:a,(y=new R).statisticType=g.decodeStatType(e),y.onStatisticField=_.toWhereClause(t,c),y.outStatisticFieldName="ARCADE_STAT_RESULT",f="ARCADE_STAT_RESULT",p.returnGeometry=!1,p.outStatistics=[y],[4,this.executeQuery(p,"execute")]);case 3:if(!(m=i.sent()).hasOwnProperty("features")||0===m.features.length)throw new Error("Unnexected Result querying statistics from layer");for(v=!1,S=0;S<m.fields.length;S++)if("ARCADE_STAT_RESULT"===m.fields[S].name.toUpperCase()){f=m.fields[S].name,"esriFieldTypeDate"===m.fields[S].type&&(v=!0);break}return v?(null!==(F=m.features[0].attributes[f])&&(F=new Date(m.features[0].attributes[f])),[2,{calculated:!0,result:F}]):[2,{calculated:!0,result:m.features[0].attributes[f]}]}}))}))},t.prototype._stat=function(e,t,r,i,n,a,s){return this._stats(e,t,r,i,n,a,s)},t.prototype._canDoAggregates=function(e,t,n,a,s){return r(this,void 0,void 0,(function(){var e,r,n;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:if(i.sent(),e=!1,r=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(e=!0),e)for(n=0;n<t.length-1;n++)null!==t[n].workingexpr&&(!1===t[n].workingexpr.isStandardized?e=!1:!1===_.isSingleField(t[n].workingexpr)&&!1===r&&(e=!1));return!1===e?[2,!1]:[2,!0]}}))}))},t.prototype._makeRelationshipEnum=function(e){return e.indexOf("esriSpatialRelRelation")>=0?"esriSpatialRelRelation":e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,n,a,s,o,l){return r(this,void 0,void 0,(function(){var r,u,d,c,p,h,f,g,m;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:return i.sent(),[4,this.databaseType()];case 2:for(r=i.sent(),u="",d=!1,c=!1,null!==o&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(u=o.constructClause(),c=!0),void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!1===this._layer.advancedQueryCapabilities.supportsPagination&&(c=!1,d=!0,u=this._layer.objectIdField),p=[],h=0;h<t.length;h++)(f=new R).onStatisticField=null!==t[h].workingexpr?_.toWhereClause(t[h].workingexpr,r):"",f.outStatisticFieldName=t[h].field,f.statisticType=t[h].toStatisticsName(),p.push(f);return""===u&&(u=e.join(",")),g=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<g&&(g=this._layer.maxRecordCount),m=null===s?null===a?"1=1":"":_.toWhereClause(s,r),this._layer.definitionExpression&&this._useDefinitionExpression&&(m=""!==m?"(("+this._layer.definitionExpression+") AND ("+m+"))":this._layer.definitionExpression),[2,new y([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(n),relationParam:this._makeRelationshipParam(n),outFields:["*"],useOIDpagination:d,generatedOid:l,resultRecordCount:g,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:p,geometry:null===a?null:a,where:m,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})]}}))}))},t.prototype._getAgregagtePhysicalPage=function(e,t,n){return r(this,void 0,void 0,(function(){var t,r,a,s,o,u,d;return i(this,(function(i){switch(i.label){case 0:return t=e.pagesDefinition.where,!0===e.pagesDefinition.useOIDpagination&&(t=""!==t?"("+t+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()),r=e.pagesDefinition.internal.lastRetrieved,a=r,s=new b,this._requestStandardised&&(s.sqlFormat="standard"),s.where=t,s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParam=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields,s.outStatistics=e.pagesDefinition.outStatistics,s.geometry=e.pagesDefinition.geometry,s.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastRetrieved,s.returnGeometry=e.pagesDefinition.returnGeometry,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&s.geometry&&s.spatialRelationship?[2,[]]:[4,this.executeQuery(s,"execute")];case 1:if(o=i.sent(),this._checkCancelled(n),!o.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");if(u=[],e.pagesDefinition.internal.lastRetrieved!==r)return[2,[]];for(d=0;d<o.features.length;d++)void 0===o.features[d].geometry&&(o.features[d].geometry=null),e.pagesDefinition.internal.set[a+d]=o.features[d].attributes[e.pagesDefinition.generatedOid];for(d=0;d<o.features.length;d++)u.push(new l({attributes:o.features[d].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===o.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=o.features[o.features.length-1].attributes[e.pagesDefinition.generatedOid]:o.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=r+e.pagesDefinition.resultRecordCount,[2,u]}}))}))},t.create=function(e,r,i){return new t({url:e,outFields:null===r?["*"]:r,spatialReference:i})},t.prototype.queryAttachments=function(e,t,n,a,s){return r(this,void 0,void 0,(function(){var r,o,l,u;return i(this,(function(i){switch(i.label){case 0:return this._layer.supportsAttachments?(r={objectIds:[e],returnMetadata:s},(t&&t>0||n&&n>0)&&(r.size=[t&&t>0?t:0,n&&n>0?n:t+1]),a&&a.length>0&&(r.attachmentTypes=a),[4,this._layer.queryAttachments(r)]):[3,2];case 1:return o=i.sent(),l=[],o&&o[e]&&(u=this._layer._url.path,o[e].forEach((function(t){var r=u+"/"+e.toString()+"/attachments/"+t.id.toString(),i=null;s&&t.exifInfo&&(i=S.convertJsonToArcade(t.exifInfo,"system",!0)),l.push(new p(t.id,t.name,t.contentType,t.size,r,i))}))),[2,l];case 2:return[2,[]]}}))}))},t.prototype.serviceUrl=function(){return f.extractServiceUrl(this._layer._url.path)},t.prototype.relationshipMetaData=function(){return this._layer.relationships},t.prototype.queryRelatedFeatures=function(e){return r(this,void 0,void 0,(function(){var t,r,n,a,s,o,u,c,p,h,y,f,_;return i(this,(function(i){switch(i.label){case 0:return t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.definitionExpression,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()},void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJson())),[4,d({url:this._layer._url.path+"/queryRelatedRecords",content:t,callbackParamName:"callback"})];case 1:if(r=i.sent(),n={},r&&r.relatedRecordGroups)for(a=r.spatialReference,s=0,o=r.relatedRecordGroups;s<o.length;s++){for(u=o[s],c=u.objectId,p=[],h=0,y=u.relatedRecords;h<y.length;h++)(f=y[h]).geometry&&(f.geometry.spatialReference=a),_=new l({geometry:f.geometry?m.fromJson(f.geometry):null,attributes:f.attributes}),p.push(_);n[c]={features:p,exceededTransferLimit:!0===r.exceededTransferLimit}}return[2,n]}}))}))},t.prototype.getFeatureByObjectId=function(e,t){return r(this,void 0,void 0,(function(){var r,n,a;return i(this,(function(i){switch(i.label){case 0:return r=new v(this._layer._url.path),(n=new b).outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+e.toString(),[4,r.execute(n)];case 1:return 1===(a=i.sent()).features.length?[2,a.features[0]]:[2,null]}}))}))},t.prototype.getIdentityUser=function(){return r(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),(e=u.findCredential(this._layer._url.path))?[2,e.userId]:[2,null]}}))}))},t.prototype.getOwningSystemUrl=function(){return r(this,void 0,void 0,(function(){var e,t,r,n,a;return i(this,(function(i){switch(i.label){case 0:return[4,this.load()];case 1:if(i.sent(),e=u.findServerInfo(this._layer._url.path))return[2,e.owningSystemUrl];if(t=this._layer.url,r=t.toLowerCase().indexOf("/rest/services"),!(t=r>-1?t.substring(0,r):t))return[3,5];t+="/rest/info",i.label=2;case 2:return i.trys.push([2,4,,5]),[4,d({url:t,content:{f:"json"},callbackParamName:"callback"})];case 3:return n=i.sent(),a="",n&&n.owningSystemUrl&&(a=n.owningSystemUrl),[2,a];case 4:return i.sent(),[2,""];case 5:return[2,""]}}))}))},t.prototype.getDataSourceFeatureSet=function(){var e=new t({url:this._layer.url,spatialReference:this.spatialReference,outFields:this._layer.outFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e},Object.defineProperty(t.prototype,"preferredTimeReference",{get:function(){return this._layer.preferredTimeReference},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dateFieldsTimeReference",{get:function(){return this._layer.dateFieldsTimeReference},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"datesInUnknownTimezone",{get:function(){return this._layer.datesInUnknownTimezone},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"editFieldsInfo",{get:function(){return this._layer.editFieldsInfo},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"timeInfo",{get:function(){return this._layer.timeInfo?this._layer.timeInfo:null},enumerable:!1,configurable:!0}),t}(h)}));