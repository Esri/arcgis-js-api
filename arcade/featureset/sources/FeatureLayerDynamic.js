// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/extends","dojox/encoding/digests/_base","dojox/encoding/digests/MD5","../../../graphic","../../../IdentityManager","../../../request","../../../sniff","../../../SpatialReference","../../../urlUtils","../../Attachment","../support/cache","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../../geometry/Extent","../../../geometry/jsonUtils","../../../layers/FeatureType","../../../layers/Field","../../../tasks/query","../../../tasks/QueryTask","../../../tasks/StatisticDefinition","../../Dictionary"],(function(e,t,i,r,s,a,n,o,l,u,d,c,p,h,y,f,_,g,m,b,v,F,R,S,w,C,I,x,D){"use strict";var T=!!c("esri-pbf"),P=!!c("esri-featurelayer-pbf"),Q=function(){function e(e,t,i){void 0===i&&(i=null),this.url=e,this.outFields=t,this.spatialReference=i,this._url=null,this.supportsFormatPBF=!1,this.supportsQuantizationEditMode=!1,this.metadata=null,this.supportsAttachments=!1,this.relationships=[],this._loadPromise=null,this._queryTask=null,this.gdbVersion="",this.currentVersion=0,this.useStandardizedQueries=!1,this.fields=[],this._url=h.urlToObject(e)}return e.prototype._canFetchPBFForQuery=function(e){return T&&P&&this.supportsFormatPBF&&!e.outStatistics&&this.supportsQuantizationEditMode},e.prototype._loadMetaData=function(e){return i(this,void 0,void 0,(function(){var t,i,s,a;return r(this,(function(r){switch(r.label){case 0:if(null!==f.applicationCache&&null!==(t=f.applicationCache.getLayerInfo(e)))return[2,t];i=d({url:e,content:{f:"json"},callbackParamName:"callback"}),null!==f.applicationCache&&f.applicationCache.setLayerInfo(e,i),s=null,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,i];case 2:return s=r.sent(),[3,4];case 3:throw a=r.sent(),null!==f.applicationCache&&f.applicationCache.clearLayerInfo(e),a;case 4:return[2,s]}}))}))},e.prototype.load=function(){return null===this._loadPromise&&(this._loadPromise=this.loadImpl()),this._loadPromise},e.prototype.loadImpl=function(){return i(this,void 0,void 0,(function(){var e,t,i,s,a,n,o,l,u,d,c,h,y,f,_,g,m,b,v,R;return r(this,(function(r){switch(r.label){case 0:return e=this._url.path,[4,this._loadMetaData(e)];case 1:if(t=r.sent(),this.metadata=t,this.relationships=t.relationships,this._queryTask=new I(e),this.objectIdField=t.objectIdField,this.globalIdField=t.globalIdField,this.supportsAttachments=!0===t.hasAttachments,!this.objectIdField)for(i=t.fields,s=0;s<i.length;s++)if("esriFieldTypeOID"===(a=i[s]).type){this.objectIdField=a.name;break}if(this.geometryType=t.geometryType,this.typeIdField=t.typeIdField,this.fullExtent=new F(t.fullExtent),this.advancedQueryCapabilities=t.advancedQueryCapabilities||{supportsStatistics:t.supportsStatistics,supportsOrderBy:t.supportsAdvancedQueries,supportsDistinct:t.supportsAdvancedQueries},t.supportedQueryFormats)for(n=0,o=t.supportedQueryFormats.split(",");n<o.length;n++)if("pbf"===o[n].replace(/^\s+|\s+$/gm,"").toLowerCase()){this.supportsFormatPBF=!0;break}if(!0===t.supportsQuantizationEditMode&&(this.supportsQuantizationEditMode=!0),!0===t.useStandardizedQueries&&(this.useStandardizedQueries=!0),void 0!==t.currentVersion&&(this.currentVersion=t.currentVersion),t.types)for(this.types=[],l=0,u=t.types;l<u.length;l++)_=u[l],d=new S(_),this.types.push(d);if(t.spatialReference&&!this.spatialReference&&(this.spatialReference=new p(t.spatialReference)),1===this.outFields.length&&"*"===this.outFields[0])for(c=0,h=t.fields;c<h.length;c++)_=h[c],R=new w(_),this.fields.push(R);else for(y=0,f=t.fields;y<f.length;y++)if("esriFieldTypeOID"===(_=f[y]).type)R=new w(_),this.fields.push(R);else{for(g=!1,m=0,b=this.outFields;m<b.length;m++)if(v=b[m],_.name.toUpperCase()===v.toUpperCase()){g=!0;break}g&&(R=new w(_),this.fields.push(R))}return this.definitionExpression="",[2,this]}}))}))},e.prototype.queryIds=function(e){var t=this;return new Promise((function(i,r){t._queryTask.executeForIds(e,i,r)}))},e.prototype.queryAttachments=function(e){return i(this,void 0,void 0,(function(){var t,i,a,n,o,l,u,c,p;return r(this,(function(r){switch(r.label){case 0:return(t=s(s({},e),{f:"json"})).objectIds.length>0&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),[4,d({url:this._url.path+"/queryAttachments",content:t,callbackParamName:"callback"})];case 1:if(i=r.sent(),a={},i&&i.attachmentGroups)for(n=0,o=i.attachmentGroups;n<o.length;n++)for(l=o[n],void 0===a[l.parentObjectId]&&(a[l.parentObjectId]=[]),u=0,c=l.attachmentInfos;u<c.length;u++)p=c[u],a[l.parentObjectId].push({id:p.id,globalId:p.globalId,name:p.name,contentType:p.contentType,size:p.size,exifInfo:p.exifInfo?p.exifInfo:null});return[2,a]}}))}))},e}();return function(e){function t(t){var i=e.call(this,t)||this;return i._layer=null,i._removeGeometry=!1,i.formulaCredential=null,i._pageJustIds=!1,i._requestStandardised=!1,i._useDefinitionExpression=!0,t.spatialReference&&(i.spatialReference=t.spatialReference),i._layer=new Q(t.url,t.outFields,i.spatialReference),i._transparent=!0,i._maxProcessing=1e3,i._wset=null,void 0!==t.includeGeometry&&(i._removeGeometry=!1===t.includeGeometry),i}return a(t,e),t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype._maxQueryRate=function(){return m.defaultMaxRecords},t.prototype.convertQueryToLruCacheKey=function(e){var t=m.stableStringify(e.toJson());return o(t,n.outputTypes.String)},t.prototype.loadImpl=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this._layer.load()];case 1:return e.sent(),this._initialiseFeatureSet(),[2,this]}}))}))},t.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,void 0===this.geometryType&&(this.geometryType=""),this.fields=this._layer.fields.slice(0);var e=this._layer.currentVersion;!0===this._layer.useStandardizedQueries?(this._databaseType=m.FeatureServiceDatabaseType.StandardisedNoInterval,null!=e&&e>=10.7&&(this._databaseType=m.FeatureServiceDatabaseType.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=m.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),e>=10.7&&(this._databaseType=m.FeatureServiceDatabaseType.Standardised)),this.objectIdField=this._layer.objectIdField,this.globalIdField=this._layer.globalIdField,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return m.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e,t){return i(this,void 0,void 0,(function(){return r(this,(function(t){return[2,e]}))}))},t.prototype._candidateIdTransform=function(e){return e},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._getSet=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(i){switch(i.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return i.sent(),[4,this._getFilteredSet("",null,null,null,e)];case 2:return t=i.sent(),this._wset=t,[2,t];case 3:return[2,this._wset]}}))}))},t.prototype.nativeCapabilities=function(){return{title:this._layer.metadata.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.metadata.advancedQueryCapabilities&&this._layer.metadata.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return this._layer&&this._layer.metadata&&this._layer.metadata.isDataVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""},enumerable:!1,configurable:!0}),t.prototype._runDatabaseProbe=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,4,,5]),(t=new C).where=e.replace("OBJECTID",this._layer.objectIdField),[4,this._layer.queryIds(t)];case 3:return i.sent(),[2,!0];case 4:return i.sent(),[2,!1];case 5:return[2]}}))}))},t.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype._getFilteredSet=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var i,o,l,u,d;return r(this,(function(r){switch(r.label){case 0:return[4,this.databaseType()];case 1:return i=r.sent(),this.isTable()&&t&&null!==e&&""!==e?[2,new g([],[],!0,null)]:this._canUsePagination()?[2,this._getFilteredSetUsingPaging(e,t,s,a,n)]:(o="",l=!1,null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(o=a.constructClause(),l=!0),u=new C,this._requestStandardised&&(u.sqlFormat="standard"),u.where=null===s?null===t?"1=1":"":b.toWhereClause(s,i),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==o?o.split(","):null,u.geometry=null===t?null:t,u.relationParam=this._makeRelationshipParam(e),[4,this.executeQuery(u,"executeForIds")]);case 2:return null===(d=r.sent())&&(d=[]),this._checkCancelled(n),[2,new g([],d,l,null)]}}))}))},t.prototype._expandPagedSet=function(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)},t.prototype._getFilteredSetUsingPaging=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var i,o,l,u,d,c,p,h;return r(this,(function(r){switch(r.label){case 0:return i="",o=!1,null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(i=a.constructClause(),o=!0),[4,this.databaseType()];case 1:return l=r.sent(),u=null===s?null===t?"1=1":"":b.toWhereClause(s,l),this._layer.definitionExpression&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.definitionExpression+") AND ("+u+"))":this._layer.definitionExpression),d=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<d&&(d=this._layer.maxRecordCount),c=null,!0===this._pageJustIds?c=new g([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:i,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}}):(p=!0,!0===this._removeGeometry&&(p=!1),h=this._fieldsIncludingObjectId(this._layer.outFields),c=new g([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:i,returnGeometry:p,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})),[4,this._expandPagedSet(c,d,0,1,n)];case 2:return r.sent(),[2,c]}}))}))},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,s){return i(this,void 0,void 0,(function(){var t,i,a,n,o;return r(this,(function(r){switch(r.label){case 0:return t=e.pagesDefinition.internal.lastRetrieved,i=t,a=new C,this._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParam=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastRetrieved,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,[4,this.executeQuery(a,"execute")];case 1:if(n=r.sent(),this._checkCancelled(s),e.pagesDefinition.internal.lastRetrieved!==t)return[2,"done"];for(o=0;o<n.features.length;o++)void 0===n.features[o].geometry&&(n.features[o].geometry=null),e.pagesDefinition.internal.set[i+o]=n.features[o].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(o=0;o<n.features.length;o++)this._featureCache[n.features[o].attributes[this._layer.objectIdField]]=n.features[o];return n.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+e.pagesDefinition.resultRecordCount,[2,"done"]}}))}))},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var i=!1,r=0,s=t;r<s.length;r++){if(s[r].toUpperCase()===this.objectIdField.toUpperCase()){i=!0;break}}return!1===i&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,s,a){return i(this,void 0,void 0,(function(){var i,n,o,l,u,d,c,p;return r(this,(function(r){switch(r.label){case 0:return i=[],-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0!==this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate())?[3,2]:[4,this._expandPagedSet(e,this._maxProcessingRate(),0,0,a)];case 1:return r.sent(),[2,this._getFeatures(e,t,s,a)];case 2:for(n=0,p=e._lastFetchedIndex;p<e._known.length&&(e._lastFetchedIndex+=1,n++,!(void 0===this._featureCache[e._known[p]]&&(o=!1,null!==this._layer._mode&&void 0!==this._layer._mode&&void 0!==(l=this._layer._mode)._featureMap[e._known[p]]&&null!==(u=l._featureMap[e._known[p]])&&(o=!0,this._featureCache[e._known[p]]=u),!1===o&&(e._known[p]!==t&&i.push(e._known[p]),i.length>=this._maxProcessingRate()-1))))&&!(n>=s&&0===i.length);p++);return 0===i.length?[2,"success"]:(d=new C,this._requestStandardised&&(d.sqlFormat="standard"),d.objectIds=i,d.outFields=this._fieldsIncludingObjectId(this._layer.outFields),d.returnGeometry=!0,!0===this._removeGeometry&&(d.returnGeometry=!1),d.outSpatialReference=this.spatialReference,[4,this.executeQuery(d,"execute")]);case 3:if(c=r.sent(),this._checkCancelled(a),void 0!==c.error)throw new Error(c.error);for(p=0;p<c.features.length;p++)void 0===c.features[p].geometry&&(c.features[p].geometry=null),this._featureCache[c.features[p].attributes[this._layer.objectIdField]]=c.features[p];return[2,"success"]}}))}))},t.prototype._layerUrl=function(){return this._layer.url},t.prototype.pbfSupportedForQuery=function(e){return this._layer._canFetchPBFForQuery(e)},t.prototype.executeQuery=function(e,t){return i(this,void 0,void 0,(function(){var i,s,a,n,o,l;return r(this,(function(r){switch(r.label){case 0:if(i=new I(this._layerUrl()),(s="execute"===t&&this.pbfSupportedForQuery(e))&&(e.quantizationParameters={mode:"edit"}),a=null,!this.recentlyUsedQueries)return[3,5];if(n=this.convertQueryToLruCacheKey(e),null!==(a=this.recentlyUsedQueries.getFromCache(n)))return[3,5];a=!0!==s?i[t](e):i[t](e,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(n,a),o=null,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,a];case 2:return o=r.sent(),[3,4];case 3:throw l=r.sent(),this.recentlyUsedQueries.removeFromCache(n),l;case 4:return[2,o];case 5:return null===a&&(a=!0!==s?i[t](e):i[t](e,null,null,{format:"pbf"})),[2,a]}}))}))},t.prototype._getDistinctPages=function(e,t,s,a,n,o,l,u,d){return i(this,void 0,void 0,(function(){var i,c,p,h,y,f,_,g;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:for(r.sent(),i=s.parseTree.column,_=0;_<this._layer.fields.length;_++)if(this._layer.fields[_].name.toLowerCase()===i.toLowerCase()){i=this._layer.fields[_].name;break}return[4,this.databaseType()];case 2:return c=r.sent(),p=new C,this._requestStandardised&&(p.sqlFormat="standard"),h=null===o?null===n?"1=1":"":b.toWhereClause(o,c),this._layer.definitionExpression&&this._useDefinitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression),p.where=h,p.spatialRelationship=this._makeRelationshipEnum(a),p.relationParam=this._makeRelationshipParam(a),p.geometry=null===n?null:n,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[i],[4,this.executeQuery(p,"execute")];case 3:if(y=r.sent(),this._checkCancelled(d),!y.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");for(f=!1,_=0;_<this._layer.fields.length;_++)if(this._layer.fields[_].name===i){"esriFieldTypeDate"===this._layer.fields[_].type&&(f=!0);break}for(_=0;_<y.features.length&&(f?null!==(g=y.features[_].attributes[i])?u.push(new Date(g)):u.push(g):u.push(y.features[_].attributes[i]),!(u.length>=l));_++);return 0===y.features.length?[2,u]:y.features.length===this._layer.maxRecordCount&&u.length<l?[4,this._getDistinctPages(e+y.features.length,t,s,a,n,o,l,u,d)]:[3,5];case 4:return[2,{calculated:!0,result:r.sent()}];case 5:return[2,u]}}))}))},t.prototype._distinctStat=function(e,t,s,a,n,o,l){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this._getDistinctPages(0,e,t,s,a,n,o,[],l)];case 1:return[2,{calculated:!0,result:i.sent()}]}}))}))},t.prototype.isTable=function(){return null===this._layer.geometryType||""===this._layer.geometryType||void 0===this._layer.geometryType},t.prototype._countstat=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var e,i,n;return r(this,(function(r){switch(r.label){case 0:return[4,this.databaseType()];case 1:return e=r.sent(),i=new C,this._requestStandardised&&(i.sqlFormat="standard"),this.isTable()&&s&&null!==t&&""!==t?[2,{calculated:!0,result:0}]:(n=null===a?null===s?"1=1":"":b.toWhereClause(a,e),this._layer.definitionExpression&&this._useDefinitionExpression&&(n=""!==n?"(("+this._layer.definitionExpression+") AND ("+n+"))":this._layer.definitionExpression),i.where=n,i.where=n,i.spatialRelationship=this._makeRelationshipEnum(t),i.relationParam=this._makeRelationshipParam(t),i.geometry=null===s?null:s,i.returnGeometry=!1,[4,this.executeQuery(i,"executeForCount")]);case 2:return[2,{calculated:!0,result:r.sent()}]}}))}))},t.prototype._stats=function(e,t,s,a,n,o,l){return i(this,void 0,void 0,(function(){var i,u,d,c,p,h,y,f,_,g,m,F;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:return r.sent(),i=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,u=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics,d=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsDistinct,"count"===e?d?[2,this._countstat(e,s,a,n,l)]:[2,{calculated:!1}]:!1===u||!1===b.isSingleField(t)&&!1===i||!1===t.isStandardized?""!==s||null!==n?[2,{calculated:!1}]:[2,this._manualStat(e,t,o,l)]:"distinct"===e?!1===d?""!==s||null!==n?[2,{calculated:!1}]:[2,this._manualStat(e,t,o,l)]:[2,this._distinctStat(e,t,s,a,n,o,l)]:[4,this.databaseType()];case 2:return c=r.sent(),this.isTable()&&a&&null!==s&&""!==s?[2,{calculated:!0,result:null}]:(p=new C,this._requestStandardised&&(p.sqlFormat="standard"),h=null===n?null===a?"1=1":"":b.toWhereClause(n,c),this._layer.definitionExpression&&this._useDefinitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression),p.where=h,p.spatialRelationship=this._makeRelationshipEnum(s),p.relationParam=this._makeRelationshipParam(s),p.geometry=null===a?null:a,(y=new x).statisticType=v.decodeStatType(e),y.onStatisticField=b.toWhereClause(t,c),y.outStatisticFieldName="ARCADE_STAT_RESULT",f="ARCADE_STAT_RESULT",p.returnGeometry=!1,p.outStatistics=[y],[4,this.executeQuery(p,"execute")]);case 3:if(!(_=r.sent()).hasOwnProperty("features")||0===_.features.length)throw new Error("Unnexected Result querying statistics from layer");for(g=!1,m=0;m<_.fields.length;m++)if("ARCADE_STAT_RESULT"===_.fields[m].name.toUpperCase()){f=_.fields[m].name,"esriFieldTypeDate"===_.fields[m].type&&(g=!0);break}return g?(null!==(F=_.features[0].attributes[f])&&(F=new Date(_.features[0].attributes[f])),[2,{calculated:!0,result:F}]):[2,{calculated:!0,result:_.features[0].attributes[f]}]}}))}))},t.prototype._stat=function(e,t,i,r,s,a,n){return this._stats(e,t,i,r,s,a,n)},t.prototype._canDoAggregates=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var e,i,s;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:if(r.sent(),e=!1,i=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(e=!0),e)for(s=0;s<t.length-1;s++)null!==t[s].workingexpr&&(!1===t[s].workingexpr.isStandardized?e=!1:!1===b.isSingleField(t[s].workingexpr)&&!1===i&&(e=!1));return!1===e?[2,!1]:[2,!0]}}))}))},t.prototype._makeRelationshipEnum=function(e){return e.indexOf("esriSpatialRelRelation")>=0?"esriSpatialRelRelation":e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,s,a,n,o,l){return i(this,void 0,void 0,(function(){var i,u,d,c,p,h,y,f,_;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:return r.sent(),[4,this.databaseType()];case 2:for(i=r.sent(),u="",d=!1,c=!1,null!==o&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(u=o.constructClause(),c=!0),void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!1===this._layer.advancedQueryCapabilities.supportsPagination&&(c=!1,d=!0,u=this._layer.objectIdField),p=[],h=0;h<t.length;h++)(y=new x).onStatisticField=null!==t[h].workingexpr?b.toWhereClause(t[h].workingexpr,i):"",y.outStatisticFieldName=t[h].field,y.statisticType=t[h].toStatisticsName(),p.push(y);return""===u&&(u=e.join(",")),f=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<f&&(f=this._layer.maxRecordCount),_=null===n?null===a?"1=1":"":b.toWhereClause(n,i),this._layer.definitionExpression&&this._useDefinitionExpression&&(_=""!==_?"(("+this._layer.definitionExpression+") AND ("+_+"))":this._layer.definitionExpression),[2,new g([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:d,generatedOid:l,resultRecordCount:f,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:p,geometry:null===a?null:a,where:_,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})]}}))}))},t.prototype._getAgregagtePhysicalPage=function(e,t,s){return i(this,void 0,void 0,(function(){var t,i,a,n,o,u,d;return r(this,(function(r){switch(r.label){case 0:return t=e.pagesDefinition.where,!0===e.pagesDefinition.useOIDpagination&&(t=""!==t?"("+t+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()),i=e.pagesDefinition.internal.lastRetrieved,a=i,n=new C,this._requestStandardised&&(n.sqlFormat="standard"),n.where=t,n.spatialRelationship=e.pagesDefinition.spatialRel,n.relationParam=e.pagesDefinition.relationParam,n.outFields=e.pagesDefinition.outFields,n.outStatistics=e.pagesDefinition.outStatistics,n.geometry=e.pagesDefinition.geometry,n.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,n.num=e.pagesDefinition.resultRecordCount,n.start=e.pagesDefinition.internal.lastRetrieved,n.returnGeometry=e.pagesDefinition.returnGeometry,n.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&n.geometry&&n.spatialRelationship?[2,[]]:[4,this.executeQuery(n,"execute")];case 1:if(o=r.sent(),this._checkCancelled(s),!o.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");if(u=[],e.pagesDefinition.internal.lastRetrieved!==i)return[2,[]];for(d=0;d<o.features.length;d++)void 0===o.features[d].geometry&&(o.features[d].geometry=null),e.pagesDefinition.internal.set[a+d]=o.features[d].attributes[e.pagesDefinition.generatedOid];for(d=0;d<o.features.length;d++)u.push(new l({attributes:o.features[d].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===o.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=o.features[o.features.length-1].attributes[e.pagesDefinition.generatedOid]:o.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+e.pagesDefinition.resultRecordCount,[2,u]}}))}))},t.create=function(e,i,r){return new t({url:e,outFields:null===i?["*"]:i,spatialReference:r})},t.prototype.queryAttachments=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var i,o,l,u;return r(this,(function(r){switch(r.label){case 0:return this._layer.supportsAttachments?(i={objectIds:[e],returnMetadata:n},(t&&t>0||s&&s>0)&&(i.size=[t&&t>0?t:0,s&&s>0?s:t+1]),a&&a.length>0&&(i.attachmentTypes=a),[4,this._layer.queryAttachments(i)]):[3,2];case 1:return o=r.sent(),l=[],o&&o[e]&&(u=this._layer._url.path,o[e].forEach((function(t){var i=u+"/"+e.toString()+"/attachments/"+t.id.toString(),r=null;n&&t.exifInfo&&(r=D.convertJsonToArcade(t.exifInfo,!0)),l.push(new y(t.id,t.name,t.contentType,t.size,i,r))}))),[2,l];case 2:return[2,[]]}}))}))},t.prototype.serviceUrl=function(){return m.extractServiceUrl(this._layer._url.path)},t.prototype.relationshipMetaData=function(){return this._layer.relationships},t.prototype.queryRelatedFeatures=function(e){return i(this,void 0,void 0,(function(){var t,i,s,a,n,o,u,c,p,h,y,f,_;return r(this,(function(r){switch(r.label){case 0:return t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.definitionExpression,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()},void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJson())),[4,d({url:this._layer._url.path+"/queryRelatedRecords",content:t,callbackParamName:"callback"})];case 1:if(i=r.sent(),s={},i&&i.relatedRecordGroups)for(a=i.spatialReference,n=0,o=i.relatedRecordGroups;n<o.length;n++){for(u=o[n],c=u.objectId,p=[],h=0,y=u.relatedRecords;h<y.length;h++)(f=y[h]).geometry&&(f.geometry.spatialReference=a),_=new l({geometry:f.geometry?R.fromJson(f.geometry):null,attributes:f.attributes}),p.push(_);s[c]={features:p,exceededTransferLimit:!0===i.exceededTransferLimit}}return[2,s]}}))}))},t.prototype.getFeatureByObjectId=function(e,t){return i(this,void 0,void 0,(function(){var i,s,a;return r(this,(function(r){switch(r.label){case 0:return i=new I(this._layer._url.path),(s=new C).outFields=t,s.returnGeometry=!1,s.outSpatialReference=this.spatialReference,s.where=this.objectIdField+"="+e.toString(),[4,i.execute(s)];case 1:return 1===(a=r.sent()).features.length?[2,a.features[0]]:[2,null]}}))}))},t.prototype.getIdentityUser=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),(e=u.findCredential(this._layer._url.path))?[2,e.userId]:[2,null]}}))}))},t.prototype.getOwningSystemUrl=function(){return i(this,void 0,void 0,(function(){var e,t,i,s,a;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:if(r.sent(),e=u.findServerInfo(this._layer._url.path))return[2,e.owningSystemUrl];if(t=this._layer.url,i=t.toLowerCase().indexOf("/rest/services"),!(t=i>-1?t.substring(0,i):t))return[3,5];t+="/rest/info",r.label=2;case 2:return r.trys.push([2,4,,5]),[4,d({url:t,content:{f:"json"},callbackParamName:"callback"})];case 3:return s=r.sent(),a="",s&&s.owningSystemUrl&&(a=s.owningSystemUrl),[2,a];case 4:return r.sent(),[2,""];case 5:return[2,""]}}))}))},t.prototype.getDataSourceFeatureSet=function(){var e=new t({url:this._layer.url,spatialReference:this.spatialReference,outFields:this._layer.outFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e},t}(_)}));