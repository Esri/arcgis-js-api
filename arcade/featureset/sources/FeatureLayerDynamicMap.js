// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/extends","dojox/encoding/digests/_base","dojox/encoding/digests/MD5","../../../graphic","../../../IdentityManager","../../../request","../../Attachment","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../../geometry/jsonUtils","../../../layers/FeatureLayer","../../../tasks/query","../../../tasks/QueryTask","../../../tasks/StatisticDefinition","../../Dictionary"],(function(e,t,r,i,n,s,a,o,l,u,d,c,h,p,y,f,g,_,m,v,b,F,R){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;if(r.declaredClass="esri.layers.featureset.sources.FeatureLayerDynamic",r._removeGeometry=!1,r._overrideFields=null,r.formulaCredential=null,r._pageJustIds=!1,r._requestStandardised=!1,r._useDefinitionExpression=!0,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,!1===r._layer.loaded)throw new Error("Can only create FeatureSets from Loaded FeatureLayers. Use FeatureLayer or FeatureCollection classes");return void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return s(t,e),t.prototype._maxQueryRate=function(){return y.defaultMaxRecords},t.prototype.convertQueryToLruCacheKey=function(e){var t=y.stableStringify(e.toJson());return o(t,a.outputTypes.String)},t.prototype.end=function(){return this._layer},t.prototype.loadImpl=function(){return r(this,void 0,void 0,(function(){return i(this,(function(e){return this._initialiseFeatureSet(),[2,this]}))}))},t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype._initialiseFeatureSet=function(){if(!this._layer.getMap())throw new Error("Can only use featuresets with layers attached to map");null==this.spatialReference&&(this.spatialReference=this._layer.getMap().spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0);var e=this._layer.getOutFields();if(1===e.length&&"*"===e[0]);else{for(var t=[],r=0,i=this.fields;r<i.length;r++){if("esriFieldTypeOID"===(u=i[r]).type)t.push(u);else for(var n=0,s=e;n<s.length;n++){if(s[n].toLowerCase()===u.name.toLowerCase()){t.push(u);break}}}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{t=[];for(var a=[],o=0,l=this.fields;o<l.length;o++){var u;if("esriFieldTypeOID"===(u=l[o]).type)t.push(u),a.push(u.name);else for(var d=0,c=this._overrideFields;d<c.length;d++){if(c[d].toLowerCase()===u.name.toLowerCase()){t.push(u),a.push(u.name);break}}}this.fields=t,this._overrideFields=a}if(this._layer){var h=this._layer.version;!0===this._layer.useStandardizedQueries?(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,null!=h&&h>=10.61&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised)):null!=h&&(h>=10.5&&(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),h>=10.61&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField,this.globalIdField=this._layer.globalIdField,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return y.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e,t){return r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,e]}))}))},t.prototype._candidateIdTransform=function(e){return e},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._getSet=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return r.sent(),[4,this._getFilteredSet("",null,null,null,e)];case 2:return t=r.sent(),this._wset=t,[2,t];case 3:return[2,this._wset]}}))}))},t.prototype.nativeCapabilities=function(){return{title:this._layer.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.advancedQueryCapabilities&&this._layer.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.advancedQueryCapabilities&&this._layer.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT"},enumerable:!1,configurable:!0}),t.prototype._runDatabaseProbe=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:r.sent(),(t=new v).where=e.replace("OBJECTID",this._layer.objectIdField),r.label=2;case 2:return r.trys.push([2,4,,5]),[4,this.executeQuery(t,"executeForIds")];case 3:return r.sent(),[2,!0];case 4:return r.sent(),[2,!1];case 5:return[2]}}))}))},t.prototype.pbfSupportedForQuery=function(e){return this._layer._canFetchPBFForQuery(e)&&this._layer.supportsQuantizationEditMode},t.prototype.executeQuery=function(e,t){return r(this,void 0,void 0,(function(){var r,n,s,a,o,l;return i(this,(function(i){switch(i.label){case 0:if(r=new b(this._layerUrl()),(n="execute"===t&&this.pbfSupportedForQuery(e))&&(e.quantizationParameters={mode:"edit"}),s=null,!this.recentlyUsedQueries)return[3,5];if(a=this.convertQueryToLruCacheKey(e),null!==(s=this.recentlyUsedQueries.getFromCache(a)))return[3,5];s=!0!==n?r[t](e):r[t](e,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(a,s),o=null,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,s];case 2:return o=i.sent(),[3,4];case 3:throw l=i.sent(),this.recentlyUsedQueries.removeFromCache(a),l;case 4:return[2,o];case 5:return null===s&&(s=!0!==n?r[t](e):r[t](e,null,null,{format:"pbf"})),[2,s]}}))}))},t.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype._getFilteredSet=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var r,o,l,u,d;return i(this,(function(i){switch(i.label){case 0:return[4,this.databaseType()];case 1:return r=i.sent(),this.isTable()&&t&&null!==e&&""!==e?[2,new p([],[],!0,null)]:this._canUsePagination()?[2,this._getFilteredSetUsingPaging(e,t,n,s,a)]:(o="",l=!1,null!==s&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(o=s.constructClause(),l=!0),u=new v,this._requestStandardised&&(u.sqlFormat="standard"),u.where=null===n?null===t?"1=1":"":f.toWhereClause(n,r),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==o?o.split(","):null,u.geometry=null===t?"":t,u.relationParam=this._makeRelationshipParam(e),[4,this.executeQuery(u,"executeForIds")]);case 2:return null===(d=i.sent())&&(d=[]),this._checkCancelled(a),[2,new p([],d,l,null)]}}))}))},t.prototype._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},t.prototype._getFilteredSetUsingPaging=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var r,o,l,u,d,c,h,y;return i(this,(function(i){switch(i.label){case 0:return r="",o=!1,null!==s&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(r=s.constructClause(),o=!0),[4,this.databaseType()];case 1:return l=i.sent(),u=null===n?null===t?"1=1":"":f.toWhereClause(n,l),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.getDefinitionExpression()+") AND ("+u+"))":this._layer.getDefinitionExpression()),d=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<d&&(d=this._layer.maxRecordCount),c=null,!0===this._pageJustIds?c=new p([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:r,returnGeometry:"false",returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}}):(h=!0,!0===this._removeGeometry&&(h=!1),y=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.getOutFields()),c=new p([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:y.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:r,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})),[4,this._expandPagedSet(c,d,0,1,a)];case 2:return i.sent(),[2,c]}}))}))},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,n){return r(this,void 0,void 0,(function(){var t,r,s,a,o;return i(this,(function(i){switch(i.label){case 0:return t=e.pagesDefinition.internal.lastRetrieved,r=t,s=new v,this._requestStandardised&&(s.sqlFormat="standard"),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParam=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastRetrieved,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,[4,this.executeQuery(s,"execute")];case 1:if(a=i.sent(),this._checkCancelled(n),e.pagesDefinition.internal.lastRetrieved!==t)return[2,"done"];for(o=0;o<a.features.length;o++)void 0===a.features[o].geometry&&(a.features[o].geometry=null),e.pagesDefinition.internal.set[r+o]=a.features[o].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(o=0;o<a.features.length;o++)this._featureCache[a.features[o].attributes[this._layer.objectIdField]]=a.features[o];return a.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+e.pagesDefinition.resultRecordCount,[2,"done"]}}))}))},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,i=0,n=t;i<n.length;i++){if(n[i].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,n,s){return r(this,void 0,void 0,(function(){var r,a,o,l,u,d,c,h;return i(this,(function(i){switch(i.label){case 0:return r=[],-1!==t&&void 0===this._featureCache[t]&&r.push(t),!0!==this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate())?[3,2]:[4,this._expandPagedSet(e,this._maxProcessingRate(),0,0,s)];case 1:return i.sent(),[2,this._getFeatures(e,t,n,s)];case 2:for(a=0,h=e._lastFetchedIndex;h<e._known.length&&(e._lastFetchedIndex+=1,a++,!(void 0===this._featureCache[e._known[h]]&&(o=!1,null!==this._layer._mode&&void 0!==this._layer._mode&&void 0!==(l=this._layer._mode)._featureMap[e._known[h]]&&null!==(u=l._featureMap[e._known[h]])&&(o=!0,this._featureCache[e._known[h]]=u),!1===o&&(e._known[h]!==t&&r.push(e._known[h]),r.length>=this._maxProcessingRate()-1))))&&!(a>=n&&0===r.length);h++);return 0===r.length?[2,"success"]:(d=new v,this._requestStandardised&&(d.sqlFormat="standard"),d.objectIds=r,d.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.getOutFields()),d.returnGeometry=!0,!0===this._removeGeometry&&(d.returnGeometry=!1),d.outSpatialReference=this.spatialReference,[4,this.executeQuery(d,"execute")]);case 3:if(c=i.sent(),this._checkCancelled(s),void 0!==c.error)throw new Error(c.error);for(h=0;h<c.features.length;h++)void 0===c.features[h].geometry&&(c.features[h].geometry=null),this._featureCache[c.features[h].attributes[this._layer.objectIdField]]=c.features[h];return[2,"success"]}}))}))},t.prototype._layerUrl=function(){return this._layer.url},t.prototype._getDistinctPages=function(e,t,n,s,a,o,l,u,d){return r(this,void 0,void 0,(function(){var r,c,h,p,y,g,_,m;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:for(i.sent(),r=n.parseTree.column,_=0;_<this._layer.fields.length;_++)if(this._layer.fields[_].name.toLowerCase()===r.toLowerCase()){r=this._layer.fields[_].name;break}return[4,this.databaseType()];case 2:return c=i.sent(),h=new v,this._requestStandardised&&(h.sqlFormat="standard"),p=null===o?null===a?"1=1":"":f.toWhereClause(o,c),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(p=""!==p?"(("+this._layer.getDefinitionExpression()+") AND ("+p+"))":this._layer.getDefinitionExpression()),h.where=p,h.spatialRelationship=this._makeRelationshipEnum(s),h.relationParam=this._makeRelationshipParam(s),h.geometry=null===a?null:a,h.returnDistinctValues=!0,h.returnGeometry=!1,h.outFields=[r],[4,this.executeQuery(h,"execute")];case 3:if(y=i.sent(),this._checkCancelled(d),!y.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");for(g=!1,_=0;_<this._layer.fields.length;_++)if(this._layer.fields[_].name===r){"esriFieldTypeDate"===this._layer.fields[_].type&&(g=!0);break}for(_=0;_<y.features.length&&(g?null!==(m=y.features[_].attributes[r])?u.push(new Date(m)):u.push(m):u.push(y.features[_].attributes[r]),!(u.length>=l));_++);return 0===y.features.length?[2,u]:y.features.length===this._layer.maxRecordCount&&u.length<l?[4,this._getDistinctPages(e+y.features.length,t,n,s,a,o,l,u,d)]:[3,5];case 4:return[2,{calculated:!0,result:i.sent()}];case 5:return[2,u]}}))}))},t.prototype._distinctStat=function(e,t,n,s,a,o,l){return r(this,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,this._getDistinctPages(0,e,t,n,s,a,o,[],l)];case 1:return[2,{calculated:!0,result:r.sent()}]}}))}))},t.prototype.isTable=function(){return!1},t.prototype._countstat=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var e,r,a;return i(this,(function(i){switch(i.label){case 0:return[4,this.databaseType()];case 1:return e=i.sent(),r=new v,this._requestStandardised&&(r.sqlFormat="standard"),this.isTable()&&n&&null!==t&&""!==t?[2,{calculated:!0,result:0}]:(a=null===s?null===n?"1=1":"":f.toWhereClause(s,e),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(a=""!==a?"(("+this._layer.getDefinitionExpression()+") AND ("+a+"))":this._layer.getDefinitionExpression()),r.where=a,r.where=a,r.spatialRelationship=this._makeRelationshipEnum(t),r.relationParam=this._makeRelationshipParam(t),r.geometry=null===n?null:n,r.returnGeometry=!1,new b(this._layerUrl()),[4,this.executeQuery(r,"executeForCount")]);case 2:return[2,{calculated:!0,result:i.sent()}]}}))}))},t.prototype._stats=function(e,t,n,s,a,o,l){return r(this,void 0,void 0,(function(){var r,u,d,c,h,p,y,_,m,b,R,S;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:return i.sent(),r=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,u=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics,d=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsDistinct,"count"===e?d?[2,this._countstat(e,n,s,a,l)]:[2,{calculated:!1}]:!1===u||!1===f.isSingleField(t)&&!1===r||!1===t.isStandardized?""!==n||null!==a?[2,{calculated:!1}]:[2,this._manualStat(e,t,o,l)]:"distinct"===e?!1===d?""!==n||null!==a?[2,{calculated:!1}]:[2,this._manualStat(e,t,o,l)]:[2,this._distinctStat(e,t,n,s,a,o,l)]:[4,this.databaseType()];case 2:return c=i.sent(),this.isTable()&&s&&null!==n&&""!==n?[2,{calculated:!0,result:null}]:(h=new v,this._requestStandardised&&(h.sqlFormat="standard"),p=null===a?null===s?"1=1":"":f.toWhereClause(a,c),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(p=""!==p?"(("+this._layer.getDefinitionExpression()+") AND ("+p+"))":this._layer.getDefinitionExpression()),h.where=p,h.spatialRelationship=this._makeRelationshipEnum(n),h.relationParam=this._makeRelationshipParam(n),h.geometry=null===s?null:s,(y=new F).statisticType=g.decodeStatType(e),y.onStatisticField=f.toWhereClause(t,c),y.outStatisticFieldName="ARCADE_STAT_RESULT",_="ARCADE_STAT_RESULT",h.returnGeometry=!1,h.outStatistics=[y],[4,this.executeQuery(h,"execute")]);case 3:if(!(m=i.sent()).hasOwnProperty("features")||0===m.features.length)throw new Error("Unnexected Result querying statistics from layer");for(b=!1,R=0;R<m.fields.length;R++)if("ARCADE_STAT_RESULT"===m.fields[R].name.toUpperCase()){_=m.fields[R].name,"esriFieldTypeDate"===m.fields[R].type&&(b=!0);break}return b?(null!==(S=m.features[0].attributes[_])&&(S=new Date(m.features[0].attributes[_])),[2,{calculated:!0,result:S}]):[2,{calculated:!0,result:m.features[0].attributes[_]}]}}))}))},t.prototype._stat=function(e,t,r,i,n,s,a){return this._stats(e,t,r,i,n,s,a)},t.prototype._canDoAggregates=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var e,r,n;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:if(i.sent(),e=!1,r=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(e=!0),e)for(n=0;n<t.length-1;n++)null!==t[n].workingexpr&&(!1===t[n].workingexpr.isStandardized?e=!1:!1===f.isSingleField(t[n].workingexpr)&&!1===r&&(e=!1));return!1===e?[2,!1]:[2,!0]}}))}))},t.prototype._makeRelationshipEnum=function(e){return e.indexOf("esriSpatialRelRelation")>=0?"esriSpatialRelRelation":e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,n,s,a,o,l){return r(this,void 0,void 0,(function(){var r,u,d,c,h,y,g,_,m;return i(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:return i.sent(),[4,this.databaseType()];case 2:for(r=i.sent(),u="",d=!1,c=!1,null!==o&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(u=o.constructClause(),c=!0),void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!1===this._layer.advancedQueryCapabilities.supportsPagination&&(c=!1,d=!0,u=this._layer.objectIdField),h=[],y=0;y<t.length;y++)(g=new F).onStatisticField=null!==t[y].workingexpr?f.toWhereClause(t[y].workingexpr,r):"",g.outStatisticFieldName=t[y].field,g.statisticType=t[y].toStatisticsName(),h.push(g);return""===u&&(u=e.join(",")),_=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<_&&(_=this._layer.maxRecordCount),m=null===a?null===s?"1=1":"":f.toWhereClause(a,r),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(m=""!==m?"(("+this._layer.getDefinitionExpression()+") AND ("+m+"))":this._layer.getDefinitionExpression()),[2,new p([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(n),relationParam:this._makeRelationshipParam(n),outFields:["*"],useOIDpagination:d,generatedOid:l,resultRecordCount:_,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:h,geometry:null===s?null:s,where:m,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})]}}))}))},t.prototype._getAgregagtePhysicalPage=function(e,t,n){return r(this,void 0,void 0,(function(){var t,r,s,a,o,u,d;return i(this,(function(i){switch(i.label){case 0:return t=e.pagesDefinition.where,!0===e.pagesDefinition.useOIDpagination&&(t=""!==t?"("+t+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()),r=e.pagesDefinition.internal.lastRetrieved,s=r,a=new v,this._requestStandardised&&(a.sqlFormat="standard"),a.where=t,a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParam=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields,a.outStatistics=e.pagesDefinition.outStatistics,a.geometry=e.pagesDefinition.geometry,a.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastRetrieved,a.returnGeometry=e.pagesDefinition.returnGeometry,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&a.geometry&&a.spatialRelationship?[2,[]]:[4,this.executeQuery(a,"execute")];case 1:if(o=i.sent(),this._checkCancelled(n),!o.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");if(u=[],e.pagesDefinition.internal.lastRetrieved!==r)return[2,[]];for(d=0;d<o.features.length;d++)void 0===o.features[d].geometry&&(o.features[d].geometry=null),e.pagesDefinition.internal.set[s+d]=o.features[d].attributes[e.pagesDefinition.generatedOid];for(d=0;d<o.features.length;d++)u.push(new l({attributes:o.features[d].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===o.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=o.features[o.features.length-1].attributes[e.pagesDefinition.generatedOid]:o.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=r+e.pagesDefinition.resultRecordCount,[2,u]}}))}))},t.create=function(e,r,i){return new t({layer:new m({url:e,outFields:null===r?["*"]:r}),spatialReference:i})},t.prototype._queryAttachments=function(e){return r(this,void 0,void 0,(function(){var t,r,s,a,o,l,u,c,h;return i(this,(function(i){switch(i.label){case 0:return(t=n(n({},e),{f:"json"})).objectIds.length>0&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),[4,d({url:this._layer._url.path+"/queryAttachments",content:t,callbackParamName:"callback"})];case 1:if(r=i.sent(),s={},r&&r.attachmentGroups)for(a=0,o=r.attachmentGroups;a<o.length;a++)for(l=o[a],void 0===s[l.parentObjectId]&&(s[l.parentObjectId]=[]),u=0,c=l.attachmentInfos;u<c.length;u++)h=c[u],s[l.parentObjectId].push({id:h.id,globalId:h.globalId,name:h.name,contentType:h.contentType,size:h.size,exifInfo:h.exifInfo?h.exifInfo:null});return[2,s]}}))}))},t.prototype.queryAttachments=function(e,t,n,s,a){return r(this,void 0,void 0,(function(){var r,o,l,u;return i(this,(function(i){switch(i.label){case 0:return this._layer.hasAttachments?(r={objectIds:[e],returnMetadata:a},(t&&t>0||n&&n>0)&&(r.size=[t&&t>0?t:0,n&&n>0?n:t+1]),s&&s.length>0&&(r.attachmentTypes=s),[4,this._queryAttachments(r)]):[3,2];case 1:return o=i.sent(),l=[],o&&o[e]&&(u=this._layer._url.path,o[e].forEach((function(t){var r=u+"/"+e.toString()+"/attachments/"+t.id.toString(),i=null;a&&t.exifInfo&&(i=R.convertJsonToArcade(t.exifInfo,"system",!0)),l.push(new c(t.id,t.name,t.contentType,t.size,r,i))}))),[2,l];case 2:return[2,[]]}}))}))},t.prototype.serviceUrl=function(){return y.extractServiceUrl(this._layer._url.path)},t.prototype.relationshipMetaData=function(){return this._layer.relationships},t.prototype.queryRelatedFeatures=function(e){return r(this,void 0,void 0,(function(){var t,r,n,s,a,o,u,c,h,p,y,f,g;return i(this,(function(i){switch(i.label){case 0:return t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.definitionExpression,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()},void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJson())),[4,d({url:this._layer._url.path+"/queryRelatedRecords",content:t,callbackParamName:"callback"})];case 1:if(r=i.sent(),n={},r&&r.relatedRecordGroups)for(s=r.spatialReference,a=0,o=r.relatedRecordGroups;a<o.length;a++){for(u=o[a],c=u.objectId,h=[],p=0,y=u.relatedRecords;p<y.length;p++)(f=y[p]).geometry&&(f.geometry.spatialReference=s),g=new l({geometry:f.geometry?_.fromJson(f.geometry):null,attributes:f.attributes}),h.push(g);n[c]={features:h,exceededTransferLimit:!0===r.exceededTransferLimit}}return[2,n]}}))}))},t.prototype.getFeatureByObjectId=function(e,t){return r(this,void 0,void 0,(function(){var r,n,s;return i(this,(function(i){switch(i.label){case 0:return r=new b(this._layerUrl()),(n=new v).outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+e.toString(),[4,r.execute(n)];case 1:return 1===(s=i.sent()).features.length?[2,s.features[0]]:[2,null]}}))}))},t.prototype.getIdentityUser=function(){return r(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),(e=u.findCredential(this._layer.url))?[2,e.userId]:[2,null]}}))}))},t.prototype.getOwningSystemUrl=function(){return r(this,void 0,void 0,(function(){var e,t,r,n,s;return i(this,(function(i){switch(i.label){case 0:return[4,this.load()];case 1:if(i.sent(),e=u.findServerInfo(this._layer.url))return[2,e.owningSystemUrl];if(t=this._layer.url,r=t.toLowerCase().indexOf("/rest/services"),!(t=r>-1?t.substring(0,r):t))return[3,5];t+="/rest/info",i.label=2;case 2:return i.trys.push([2,4,,5]),[4,d({url:t,content:{f:"json"},callbackParamName:"callback"})];case 3:return n=i.sent(),s="",n&&n.owningSystemUrl&&(s=n.owningSystemUrl),[2,s];case 4:return i.sent(),[2,""];case 5:return[2,""]}}))}))},t.prototype.getDataSourceFeatureSet=function(){var e=new t({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e},Object.defineProperty(t.prototype,"preferredTimeReference",{get:function(){return this._layer.preferredTimeReference||null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dateFieldsTimeReference",{get:function(){return this._layer.dateFieldsTimeReference},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"datesInUnknownTimezone",{get:function(){return this._layer.datesInUnknownTimezone},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"editFieldsInfo",{get:function(){return this._layer.editFieldsInfo},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"timeInfo",{get:function(){return this._layer.timeInfo?this._layer.timeInfo:null},enumerable:!1,configurable:!0}),t}(h)}));