// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/extends","dojox/encoding/digests/_base","dojox/encoding/digests/MD5","../../../graphic","../../../IdentityManager","../../../request","../../Attachment","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../support/stats","../../../geometry/jsonUtils","../../../layers/FeatureLayer","../../../tasks/query","../../../tasks/QueryTask","../../../tasks/StatisticDefinition","../../Dictionary"],(function(e,t,i,r,s,a,n,l,o,u,d,c,h,p,y,f,g,_,m,v,b,F,R){"use strict";return function(e){function t(t){var i=e.call(this,t)||this;if(i.declaredClass="esri.layers.featureset.sources.FeatureLayerDynamic",i._removeGeometry=!1,i._overrideFields=null,i.formulaCredential=null,i._pageJustIds=!1,i._requestStandardised=!1,i._useDefinitionExpression=!0,t.spatialReference&&(i.spatialReference=t.spatialReference),i._transparent=!0,i._maxProcessing=1e3,i._layer=t.layer,i._wset=null,!1===i._layer.loaded)throw new Error("Can only create FeatureSets from Loaded FeatureLayers. Use FeatureLayer or FeatureCollection classes");return void 0!==t.outFields&&(i._overrideFields=t.outFields),void 0!==t.includeGeometry&&(i._removeGeometry=!1===t.includeGeometry),i}return a(t,e),t.prototype._maxQueryRate=function(){return y.defaultMaxRecords},t.prototype.convertQueryToLruCacheKey=function(e){var t=y.stableStringify(e.toJson());return l(t,n.outputTypes.String)},t.prototype.end=function(){return this._layer},t.prototype.loadImpl=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){return this._initialiseFeatureSet(),[2,this]}))}))},t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype._initialiseFeatureSet=function(){if(!this._layer.getMap())throw new Error("Can only use featuresets with layers attached to map");null==this.spatialReference&&(this.spatialReference=this._layer.getMap().spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0);var e=this._layer.getOutFields();if(1===e.length&&"*"===e[0]);else{for(var t=[],i=0,r=this.fields;i<r.length;i++){if("esriFieldTypeOID"===(u=r[i]).type)t.push(u);else for(var s=0,a=e;s<a.length;s++){if(a[s].toLowerCase()===u.name.toLowerCase()){t.push(u);break}}}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{t=[];for(var n=[],l=0,o=this.fields;l<o.length;l++){var u;if("esriFieldTypeOID"===(u=o[l]).type)t.push(u),n.push(u.name);else for(var d=0,c=this._overrideFields;d<c.length;d++){if(c[d].toLowerCase()===u.name.toLowerCase()){t.push(u),n.push(u.name);break}}}this.fields=t,this._overrideFields=n}if(this._layer){var h=this._layer.version;!0===this._layer.useStandardizedQueries?(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,null!=h&&h>=10.61&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised)):null!=h&&(h>=10.5&&(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),h>=10.61&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField,this.globalIdField=this._layer.globalIdField,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return y.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e,t){return i(this,void 0,void 0,(function(){return r(this,(function(t){return[2,e]}))}))},t.prototype._candidateIdTransform=function(e){return e},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._getSet=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(i){switch(i.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return i.sent(),[4,this._getFilteredSet("",null,null,null,e)];case 2:return t=i.sent(),this._wset=t,[2,t];case 3:return[2,this._wset]}}))}))},t.prototype.nativeCapabilities=function(){return{title:this._layer.name,source:this,canQueryRelated:!0,capabilities:{query:{maxRecordCount:this._layer.maxRecordCount},queryRelated:{supportsOrderBy:this._layer.advancedQueryCapabilities&&this._layer.advancedQueryCapabilities.supportsAdvancedQueryRelated,supportsPagination:this._layer.advancedQueryCapabilities&&this._layer.advancedQueryCapabilities.supportsQueryRelatedPagination}},databaseType:this._databaseType,requestStandardised:this._requestStandardised}},Object.defineProperty(t.prototype,"gdbVersion",{get:function(){return this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT"},enumerable:!1,configurable:!0}),t.prototype._runDatabaseProbe=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(i){switch(i.label){case 0:return[4,this._ensureLoaded()];case 1:i.sent(),(t=new v).where=e.replace("OBJECTID",this._layer.objectIdField),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.executeQuery(t,"executeForIds")];case 3:return i.sent(),[2,!0];case 4:return i.sent(),[2,!1];case 5:return[2]}}))}))},t.prototype.pbfSupportedForQuery=function(e){return this._layer._canFetchPBFForQuery(e)&&this._layer.supportsQuantizationEditMode},t.prototype.executeQuery=function(e,t){return i(this,void 0,void 0,(function(){var i,s,a,n,l,o;return r(this,(function(r){switch(r.label){case 0:if(i=new b(this._layerUrl()),(s="execute"===t&&this.pbfSupportedForQuery(e))&&(e.quantizationParameters={mode:"edit"}),a=null,!this.recentlyUsedQueries)return[3,5];if(n=this.convertQueryToLruCacheKey(e),null!==(a=this.recentlyUsedQueries.getFromCache(n)))return[3,5];a=!0!==s?i[t](e):i[t](e,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(n,a),l=null,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,a];case 2:return l=r.sent(),[3,4];case 3:throw o=r.sent(),this.recentlyUsedQueries.removeFromCache(n),o;case 4:return[2,l];case 5:return null===a&&(a=!0!==s?i[t](e):i[t](e,null,null,{format:"pbf"})),[2,a]}}))}))},t.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype._getFilteredSet=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var i,l,o,u,d;return r(this,(function(r){switch(r.label){case 0:return[4,this.databaseType()];case 1:return i=r.sent(),this.isTable()&&t&&null!==e&&""!==e?[2,new p([],[],!0,null)]:this._canUsePagination()?[2,this._getFilteredSetUsingPaging(e,t,s,a,n)]:(l="",o=!1,null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(l=a.constructClause(),o=!0),u=new v,this._requestStandardised&&(u.sqlFormat="standard"),u.where=null===s?null===t?"1=1":"":f.toWhereClause(s,i),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===t?"":t,u.relationParam=this._makeRelationshipParam(e),[4,this.executeQuery(u,"executeForIds")]);case 2:return null===(d=r.sent())&&(d=[]),this._checkCancelled(n),[2,new p([],d,o,null)]}}))}))},t.prototype._expandPagedSet=function(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)},t.prototype._getFilteredSetUsingPaging=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var i,l,o,u,d,c,h,y;return r(this,(function(r){switch(r.label){case 0:return i="",l=!1,null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(i=a.constructClause(),l=!0),[4,this.databaseType()];case 1:return o=r.sent(),u=null===s?null===t?"1=1":"":f.toWhereClause(s,o),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.getDefinitionExpression()+") AND ("+u+"))":this._layer.getDefinitionExpression()),d=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<d&&(d=this._layer.maxRecordCount),c=null,!0===this._pageJustIds?c=new p([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:i,returnGeometry:"false",returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}}):(h=!0,!0===this._removeGeometry&&(h=!1),y=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.getOutFields()),c=new p([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:y.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?"":t,where:u,orderByFields:i,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})),[4,this._expandPagedSet(c,d,0,1,n)];case 2:return r.sent(),[2,c]}}))}))},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,s){return i(this,void 0,void 0,(function(){var t,i,a,n,l;return r(this,(function(r){switch(r.label){case 0:return t=e.pagesDefinition.internal.lastRetrieved,i=t,a=new v,this._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParam=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastRetrieved,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,[4,this.executeQuery(a,"execute")];case 1:if(n=r.sent(),this._checkCancelled(s),e.pagesDefinition.internal.lastRetrieved!==t)return[2,"done"];for(l=0;l<n.features.length;l++)void 0===n.features[l].geometry&&(n.features[l].geometry=null),e.pagesDefinition.internal.set[i+l]=n.features[l].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(l=0;l<n.features.length;l++)this._featureCache[n.features[l].attributes[this._layer.objectIdField]]=n.features[l];return n.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+e.pagesDefinition.resultRecordCount,[2,"done"]}}))}))},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var i=!1,r=0,s=t;r<s.length;r++){if(s[r].toUpperCase()===this.objectIdField.toUpperCase()){i=!0;break}}return!1===i&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,s,a){return i(this,void 0,void 0,(function(){var i,n,l,o,u,d,c,h;return r(this,(function(r){switch(r.label){case 0:return i=[],-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0!==this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate())?[3,2]:[4,this._expandPagedSet(e,this._maxProcessingRate(),0,0,a)];case 1:return r.sent(),[2,this._getFeatures(e,t,s,a)];case 2:for(n=0,h=e._lastFetchedIndex;h<e._known.length&&(e._lastFetchedIndex+=1,n++,!(void 0===this._featureCache[e._known[h]]&&(l=!1,null!==this._layer._mode&&void 0!==this._layer._mode&&void 0!==(o=this._layer._mode)._featureMap[e._known[h]]&&null!==(u=o._featureMap[e._known[h]])&&(l=!0,this._featureCache[e._known[h]]=u),!1===l&&(e._known[h]!==t&&i.push(e._known[h]),i.length>=this._maxProcessingRate()-1))))&&!(n>=s&&0===i.length);h++);return 0===i.length?[2,"success"]:(d=new v,this._requestStandardised&&(d.sqlFormat="standard"),d.objectIds=i,d.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.getOutFields()),d.returnGeometry=!0,!0===this._removeGeometry&&(d.returnGeometry=!1),d.outSpatialReference=this.spatialReference,[4,this.executeQuery(d,"execute")]);case 3:if(c=r.sent(),this._checkCancelled(a),void 0!==c.error)throw new Error(c.error);for(h=0;h<c.features.length;h++)void 0===c.features[h].geometry&&(c.features[h].geometry=null),this._featureCache[c.features[h].attributes[this._layer.objectIdField]]=c.features[h];return[2,"success"]}}))}))},t.prototype._layerUrl=function(){return this._layer.url},t.prototype._getDistinctPages=function(e,t,s,a,n,l,o,u,d){return i(this,void 0,void 0,(function(){var i,c,h,p,y,g,_,m;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:for(r.sent(),i=s.parseTree.column,_=0;_<this._layer.fields.length;_++)if(this._layer.fields[_].name.toLowerCase()===i.toLowerCase()){i=this._layer.fields[_].name;break}return[4,this.databaseType()];case 2:return c=r.sent(),h=new v,this._requestStandardised&&(h.sqlFormat="standard"),p=null===l?null===n?"1=1":"":f.toWhereClause(l,c),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(p=""!==p?"(("+this._layer.getDefinitionExpression()+") AND ("+p+"))":this._layer.getDefinitionExpression()),h.where=p,h.spatialRelationship=this._makeRelationshipEnum(a),h.relationParam=this._makeRelationshipParam(a),h.geometry=null===n?null:n,h.returnDistinctValues=!0,h.returnGeometry=!1,h.outFields=[i],[4,this.executeQuery(h,"execute")];case 3:if(y=r.sent(),this._checkCancelled(d),!y.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");for(g=!1,_=0;_<this._layer.fields.length;_++)if(this._layer.fields[_].name===i){"esriFieldTypeDate"===this._layer.fields[_].type&&(g=!0);break}for(_=0;_<y.features.length&&(g?null!==(m=y.features[_].attributes[i])?u.push(new Date(m)):u.push(m):u.push(y.features[_].attributes[i]),!(u.length>=o));_++);return 0===y.features.length?[2,u]:y.features.length===this._layer.maxRecordCount&&u.length<o?[4,this._getDistinctPages(e+y.features.length,t,s,a,n,l,o,u,d)]:[3,5];case 4:return[2,{calculated:!0,result:r.sent()}];case 5:return[2,u]}}))}))},t.prototype._distinctStat=function(e,t,s,a,n,l,o){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this._getDistinctPages(0,e,t,s,a,n,l,[],o)];case 1:return[2,{calculated:!0,result:i.sent()}]}}))}))},t.prototype.isTable=function(){return!1},t.prototype._countstat=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var e,i,n;return r(this,(function(r){switch(r.label){case 0:return[4,this.databaseType()];case 1:return e=r.sent(),i=new v,this._requestStandardised&&(i.sqlFormat="standard"),this.isTable()&&s&&null!==t&&""!==t?[2,{calculated:!0,result:0}]:(n=null===a?null===s?"1=1":"":f.toWhereClause(a,e),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(n=""!==n?"(("+this._layer.getDefinitionExpression()+") AND ("+n+"))":this._layer.getDefinitionExpression()),i.where=n,i.where=n,i.spatialRelationship=this._makeRelationshipEnum(t),i.relationParam=this._makeRelationshipParam(t),i.geometry=null===s?null:s,i.returnGeometry=!1,new b(this._layerUrl()),[4,this.executeQuery(i,"executeForCount")]);case 2:return[2,{calculated:!0,result:r.sent()}]}}))}))},t.prototype._stats=function(e,t,s,a,n,l,o){return i(this,void 0,void 0,(function(){var i,u,d,c,h,p,y,_,m,b,R,S;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:return r.sent(),i=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,u=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics,d=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsDistinct,"count"===e?d?[2,this._countstat(e,s,a,n,o)]:[2,{calculated:!1}]:!1===u||!1===f.isSingleField(t)&&!1===i||!1===t.isStandardized?""!==s||null!==n?[2,{calculated:!1}]:[2,this._manualStat(e,t,l,o)]:"distinct"===e?!1===d?""!==s||null!==n?[2,{calculated:!1}]:[2,this._manualStat(e,t,l,o)]:[2,this._distinctStat(e,t,s,a,n,l,o)]:[4,this.databaseType()];case 2:return c=r.sent(),this.isTable()&&a&&null!==s&&""!==s?[2,{calculated:!0,result:null}]:(h=new v,this._requestStandardised&&(h.sqlFormat="standard"),p=null===n?null===a?"1=1":"":f.toWhereClause(n,c),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(p=""!==p?"(("+this._layer.getDefinitionExpression()+") AND ("+p+"))":this._layer.getDefinitionExpression()),h.where=p,h.spatialRelationship=this._makeRelationshipEnum(s),h.relationParam=this._makeRelationshipParam(s),h.geometry=null===a?null:a,(y=new F).statisticType=g.decodeStatType(e),y.onStatisticField=f.toWhereClause(t,c),y.outStatisticFieldName="ARCADE_STAT_RESULT",_="ARCADE_STAT_RESULT",h.returnGeometry=!1,h.outStatistics=[y],[4,this.executeQuery(h,"execute")]);case 3:if(!(m=r.sent()).hasOwnProperty("features")||0===m.features.length)throw new Error("Unnexected Result querying statistics from layer");for(b=!1,R=0;R<m.fields.length;R++)if("ARCADE_STAT_RESULT"===m.fields[R].name.toUpperCase()){_=m.fields[R].name,"esriFieldTypeDate"===m.fields[R].type&&(b=!0);break}return b?(null!==(S=m.features[0].attributes[_])&&(S=new Date(m.features[0].attributes[_])),[2,{calculated:!0,result:S}]):[2,{calculated:!0,result:m.features[0].attributes[_]}]}}))}))},t.prototype._stat=function(e,t,i,r,s,a,n){return this._stats(e,t,i,r,s,a,n)},t.prototype._canDoAggregates=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var e,i,s;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:if(r.sent(),e=!1,i=this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsSqlExpression,void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsStatistics&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(e=!0),e)for(s=0;s<t.length-1;s++)null!==t[s].workingexpr&&(!1===t[s].workingexpr.isStandardized?e=!1:!1===f.isSingleField(t[s].workingexpr)&&!1===i&&(e=!1));return!1===e?[2,!1]:[2,!0]}}))}))},t.prototype._makeRelationshipEnum=function(e){return e.indexOf("esriSpatialRelRelation")>=0?"esriSpatialRelRelation":e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,s,a,n,l,o){return i(this,void 0,void 0,(function(){var i,u,d,c,h,y,g,_,m;return r(this,(function(r){switch(r.label){case 0:return[4,this._ensureLoaded()];case 1:return r.sent(),[4,this.databaseType()];case 2:for(i=r.sent(),u="",d=!1,c=!1,null!==l&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(u=l.constructClause(),c=!0),void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!1===this._layer.advancedQueryCapabilities.supportsPagination&&(c=!1,d=!0,u=this._layer.objectIdField),h=[],y=0;y<t.length;y++)(g=new F).onStatisticField=null!==t[y].workingexpr?f.toWhereClause(t[y].workingexpr,i):"",g.outStatisticFieldName=t[y].field,g.statisticType=t[y].toStatisticsName(),h.push(g);return""===u&&(u=e.join(",")),_=this._maxQueryRate(),void 0!==this._layer.maxRecordCount&&this._layer.maxRecordCount<_&&(_=this._layer.maxRecordCount),m=null===n?null===a?"1=1":"":f.toWhereClause(n,i),this._layer.getDefinitionExpression()&&this._useDefinitionExpression&&(m=""!==m?"(("+this._layer.getDefinitionExpression()+") AND ("+m+"))":this._layer.getDefinitionExpression()),[2,new p([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:d,generatedOid:o,resultRecordCount:_,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:h,geometry:null===a?null:a,where:m,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})]}}))}))},t.prototype._getAgregagtePhysicalPage=function(e,t,s){return i(this,void 0,void 0,(function(){var t,i,a,n,l,u,d;return r(this,(function(r){switch(r.label){case 0:return t=e.pagesDefinition.where,!0===e.pagesDefinition.useOIDpagination&&(t=""!==t?"("+t+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()),i=e.pagesDefinition.internal.lastRetrieved,a=i,n=new v,this._requestStandardised&&(n.sqlFormat="standard"),n.where=t,n.spatialRelationship=e.pagesDefinition.spatialRel,n.relationParam=e.pagesDefinition.relationParam,n.outFields=e.pagesDefinition.outFields,n.outStatistics=e.pagesDefinition.outStatistics,n.geometry=e.pagesDefinition.geometry,n.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,n.num=e.pagesDefinition.resultRecordCount,n.start=e.pagesDefinition.internal.lastRetrieved,n.returnGeometry=e.pagesDefinition.returnGeometry,n.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&n.geometry&&n.spatialRelationship?[2,[]]:[4,this.executeQuery(n,"execute")];case 1:if(l=r.sent(),this._checkCancelled(s),!l.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");if(u=[],e.pagesDefinition.internal.lastRetrieved!==i)return[2,[]];for(d=0;d<l.features.length;d++)void 0===l.features[d].geometry&&(l.features[d].geometry=null),e.pagesDefinition.internal.set[a+d]=l.features[d].attributes[e.pagesDefinition.generatedOid];for(d=0;d<l.features.length;d++)u.push(new o({attributes:l.features[d].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===l.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=l.features[l.features.length-1].attributes[e.pagesDefinition.generatedOid]:l.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+e.pagesDefinition.resultRecordCount,[2,u]}}))}))},t.create=function(e,i,r){return new t({layer:new m({url:e,outFields:null===i?["*"]:i}),spatialReference:r})},t.prototype._queryAttachments=function(e){return i(this,void 0,void 0,(function(){var t,i,a,n,l,o,u,c,h;return r(this,(function(r){switch(r.label){case 0:return(t=s(s({},e),{f:"json"})).objectIds.length>0&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),[4,d({url:this._layer._url.path+"/queryAttachments",content:t,callbackParamName:"callback"})];case 1:if(i=r.sent(),a={},i&&i.attachmentGroups)for(n=0,l=i.attachmentGroups;n<l.length;n++)for(o=l[n],void 0===a[o.parentObjectId]&&(a[o.parentObjectId]=[]),u=0,c=o.attachmentInfos;u<c.length;u++)h=c[u],a[o.parentObjectId].push({id:h.id,globalId:h.globalId,name:h.name,contentType:h.contentType,size:h.size,exifInfo:h.exifInfo?h.exifInfo:null});return[2,a]}}))}))},t.prototype.queryAttachments=function(e,t,s,a,n){return i(this,void 0,void 0,(function(){var i,l,o,u;return r(this,(function(r){switch(r.label){case 0:return this._layer.hasAttachments?(i={objectIds:[e],returnMetadata:n},(t&&t>0||s&&s>0)&&(i.size=[t&&t>0?t:0,s&&s>0?s:t+1]),a&&a.length>0&&(i.attachmentTypes=a),[4,this._queryAttachments(i)]):[3,2];case 1:return l=r.sent(),o=[],l&&l[e]&&(u=this._layer._url.path,l[e].forEach((function(t){var i=u+"/"+e.toString()+"/attachments/"+t.id.toString(),r=null;n&&t.exifInfo&&(r=R.convertJsonToArcade(t.exifInfo,!0)),o.push(new c(t.id,t.name,t.contentType,t.size,i,r))}))),[2,o];case 2:return[2,[]]}}))}))},t.prototype.serviceUrl=function(){return y.extractServiceUrl(this._layer._url.path)},t.prototype.relationshipMetaData=function(){return this._layer.relationships},t.prototype.queryRelatedFeatures=function(e){return i(this,void 0,void 0,(function(){var t,i,s,a,n,l,u,c,h,p,y,f,g;return r(this,(function(r){switch(r.label){case 0:return t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.definitionExpression,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()},void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJson())),[4,d({url:this._layer._url.path+"/queryRelatedRecords",content:t,callbackParamName:"callback"})];case 1:if(i=r.sent(),s={},i&&i.relatedRecordGroups)for(a=i.spatialReference,n=0,l=i.relatedRecordGroups;n<l.length;n++){for(u=l[n],c=u.objectId,h=[],p=0,y=u.relatedRecords;p<y.length;p++)(f=y[p]).geometry&&(f.geometry.spatialReference=a),g=new o({geometry:f.geometry?_.fromJson(f.geometry):null,attributes:f.attributes}),h.push(g);s[c]={features:h,exceededTransferLimit:!0===i.exceededTransferLimit}}return[2,s]}}))}))},t.prototype.getFeatureByObjectId=function(e,t){return i(this,void 0,void 0,(function(){var i,s,a;return r(this,(function(r){switch(r.label){case 0:return i=new b(this._layerUrl()),(s=new v).outFields=t,s.returnGeometry=!1,s.outSpatialReference=this.spatialReference,s.where=this.objectIdField+"="+e.toString(),[4,i.execute(s)];case 1:return 1===(a=r.sent()).features.length?[2,a.features[0]]:[2,null]}}))}))},t.prototype.getIdentityUser=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),(e=u.findCredential(this._layer.url))?[2,e.userId]:[2,null]}}))}))},t.prototype.getOwningSystemUrl=function(){return i(this,void 0,void 0,(function(){var e,t,i,s,a;return r(this,(function(r){switch(r.label){case 0:return[4,this.load()];case 1:if(r.sent(),e=u.findServerInfo(this._layer.url))return[2,e.owningSystemUrl];if(t=this._layer.url,i=t.toLowerCase().indexOf("/rest/services"),!(t=i>-1?t.substring(0,i):t))return[3,5];t+="/rest/info",r.label=2;case 2:return r.trys.push([2,4,,5]),[4,d({url:t,content:{f:"json"},callbackParamName:"callback"})];case 3:return s=r.sent(),a="",s&&s.owningSystemUrl&&(a=s.owningSystemUrl),[2,a];case 4:return r.sent(),[2,""];case 5:return[2,""]}}))}))},t.prototype.getDataSourceFeatureSet=function(){var e=new t({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e},t}(h)}));