/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../../kernel","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/SpatialReference"],(function(e,t,r,a,i,s,n,l,o,u,h){"use strict";let c=function(){function e(e){this.field=e,this.sqlRewritable=!1}return e.prototype.postInitialization=function(e,t){},e}(),d=function(e){function r(t){var r;return(r=e.call(this,t)||this).sqlRewritable=!0,r}t._inheritsLoose(r,e);var a=r.prototype;return a.extractValue=function(e){return e.attributes[this.field.name]},a.rewriteSql=function(e){return{rewritten:this.sqlRewritable,where:e}},r}(c),f=function(e){function r(t,r,a){var i;return(i=e.call(this,n.cloneField(t))||this).originalField=t,i.sqlRewritable=!0,i.field.name=r,i.field.alias=a,i}t._inheritsLoose(r,e);var a=r.prototype;return a.rewriteSql=function(e,t){return{rewritten:this.sqlRewritable,where:l.reformulateWithoutField(e,this.field.name,this.originalField.name,t.getFieldsIndex())}},a.extractValue=function(e){return e.attributes[this.originalField.name]},r}(c),p=function(e){function r(t,r,a){var i;(i=e.call(this,t)||this).codefield=r,i.lkp=a,i.reverseLkp={};for(const e in a)i.reverseLkp[a[e]]=e;return i.sqlRewritable=!0,i}t._inheritsLoose(r,e);var a=r.prototype;return a.rewriteSql=function(e,t){const a=this.evaluateNodeToWhereClause(e.parseTree,n.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof u.WhereClause?l.toWhereClause(this.codefield,n.FeatureServiceDatabaseType.Standardised):this.codefield,e.parameters);return a.indexOf(r.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:u.WhereClause.create(a,t._parent.getFieldsIndex())}},a.evaluateNodeToWhereClause=function(e,t,a=null,i=null,s){let n,o,u,h;switch(e.type){case"interval":return l.convertIntervalToSql(this.evaluateNodeToWhereClause(e.value,t,a,i,s),e.qualifier,e.op);case"case_expression":{let i=" CASE ";"simple"===e.format&&(i+=this.evaluateNodeToWhereClause(e.operand,t,a,r.BADNESS,s));for(let n=0;n<e.clauses.length;n++)i+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[n].operand,t,a,r.BADNESS,s)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[n].value,t,a,r.BADNESS,s);return null!==e.else&&(i+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,a,r.BADNESS,s)),i+=" END ",i}case"param":{const r=s[e.value.toLowerCase()];if("string"==typeof r){return"'"+s[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(r instanceof Date)return l.makeDateString(r,t);if(r instanceof Array){const e=[];for(let a=0;a<r.length;a++)"string"==typeof r[a]?e.push("'"+r[a].toString().replace(/'/g,"''")+"'"):r[a]instanceof Date?e.push(l.makeDateString(r[a],t)):e.push(r[a].toString());return e}return r.toString()}case"expr_list":o=[];for(const r of e.value)o.push(this.evaluateNodeToWhereClause(r,t,a,i,s));return o;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,a,r.BADNESS,s)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" AND "+this.evaluateNodeToWhereClause(e.right,t,a,i,s)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" OR "+this.evaluateNodeToWhereClause(e.right,t,a,i,s)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" IS NOT NULL )";case"IN":if(n=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let n=!0;for(const t of e.right.value){if("string"!==t.type){n=!1;break}if(void 0===this.lkp[t.value]){n=!1;break}r.push(this.lkp[t.value].toString())}if(n)return" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" IN ("+r.join(",")+")) "}return n=this.evaluateNodeToWhereClause(e.right,t,a,i,s)," ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" IN ("+n.join(",")+")) "}return h=this.evaluateNodeToWhereClause(e.right,t,a,i,s),h instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" IN ("+h+")) ";case"NOT IN":if(n=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let n=!0;for(const t of e.right.value){if("string"!==t.type){n=!1;break}if(void 0===this.lkp[t.value]){n=!1;break}r.push(this.lkp[t.value].toString())}if(n)return" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" NOT IN ("+r.join(",")+")) "}return n=this.evaluateNodeToWhereClause(e.right,t,a,i,s)," ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" NOT IN ("+n.join(",")+")) "}return h=this.evaluateNodeToWhereClause(e.right,t,a,i,s),h instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" NOT IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,a,i,s)+" NOT IN ("+h+")) ";case"BETWEEN":return u=this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)," ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" BETWEEN "+u[0]+" AND "+u[1]+" ) ";case"NOTBETWEEN":return u=this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)," ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" NOT BETWEEN "+u[0]+" AND "+u[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+i+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,a,r.BADNESS,s)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,a,r.BADNESS,s)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return l.makeDateString(e.value,t);case"number":return e.value.toString();case"current_time":return l.makeToday("date"===e.mode,t);case"column_ref":return a&&a.toLowerCase()===e.column.toLowerCase()?"("+i+")":e.column;case"function":{const i=this.evaluateNodeToWhereClause(e.args,t,a,r.BADNESS,s);return l.translateFunctionToDatabaseSpecific(e.name,i,t)}}throw new Error("Unsupported sql syntax "+e.type)},a.extractValue=function(e){return this.codefield instanceof u.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]},r}(c);p.BADNESS="_!!!_BAD_LKP_!!!!";let g=function(e){function r(t,r){var a;return(a=e.call(this,t)||this).sql=r,a}t._inheritsLoose(r,e);var a=r.prototype;return a.rewriteSql=function(e,t){return{rewritten:!0,where:l.reformulateWithoutField(e,this.field.name,l.toWhereClause(this.sql,n.FeatureServiceDatabaseType.Standardised),t.getFieldsIndex())}},a.extractValue=function(e){return this.sql.calculateValueCompiled(e)},r}(c),_=function(e){function i(t){var r;return(r=e.call(this,t)||this)._calcFunc=null,r.declaredClass="esri.arcade.featureset.actions.Adapted",r.adaptedFields=null,r._extraFilter=null,r._extraFilter=t.extraFilter,r._parent=t.parentfeatureset,r._maxProcessing=30,r.adaptedFields=t.adaptedFields,r}t._inheritsLoose(i,e),i.findField=function(e,t){for(const r of e)if(r.name.toLowerCase()===t.toString().toLowerCase())return r;return null};var u=i.prototype;return u._initialiseFeatureSet=function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new h({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=n.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null),this.fields=[];for(const e of this.adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)},u._getSet=function(e){return null===this._wset?this._ensureLoaded().then((()=>this._extraFilter?this._getFilteredSet("",null,null,null,e):this._parent._getSet(e))).then((t=>(this._checkCancelled(e),this._wset=new s(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):o.resolve(this._wset)},u._isInFeatureSet=function(e){return this._parent._isInFeatureSet(e)},u._getFeatures=function(e,t,i,n){const l=[];-1!==t&&void 0===this._featureCache[t]&&l.push(t);const u=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,u))return this._expandPagedSet(e,u,0,0,n).then((()=>this._getFeatures(e,t,i,n)));let h=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(h++,h<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&l.push(e._known[r]),l.length>=u)));r++);if(0===l.length)return o.resolve("success");e=new s([],l,e._ordered,null);const c=Math.min(l.length,i);return this._parent._getFeatures(e,-1,c,n).then((()=>{this._checkCancelled(n);const e=[];for(let t=0;t<c;t++){const r=this._parent._featureFromCache(l[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:l[t]})}for(const t of e){const e=[];for(const r of this.adaptedFields)e[r.field.name]=r.extractValue(t);this._featureCache[t.id]=new r({attributes:e,geometry:a.cloneGeometry(t.geometry)})}return"success"}))},u._fetchAndRefineFeatures=function(){return o.reject(new Error("Fetch and Refine should not be called in this featureset"))},u._getFilteredSet=function(e,t,r,a,i){let n=!1;const o=this._reformulateWithoutAdaptions(r);n=o.cannot,r=o.where;let u=!1;if(null!==a){u=!0;const e=[];for(const t of this.adaptedFields)if(!(t instanceof d)&&!0===a.scanForField(t.field.name)){if(!(t instanceof f)){a=null,u=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}a&&e.length>0&&(a=a.replaceFields(e))}return null!==r?null!==this._extraFilter&&(r=l.combine(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,t,r,a,i))).then((e=>{let t;return this._checkCancelled(i),t=!0===n?new s(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===u&&e._ordered,this._clonePageDefinition(e.pagesDefinition)):new s(e._candidates.slice(0),e._known.slice(0),!0===u&&e._ordered,this._clonePageDefinition(e.pagesDefinition)),t}))},u._reformulateWithoutAdaptions=function(e){const t={cannot:!1,where:e};if(null!==e)for(const r of this.adaptedFields)if(!0===l.scanForField(e,r.field.name)){const a=r.rewriteSql(e,this);if(!0!==a.rewritten){t.cannot=!0,t.where=null;break}t.where=a.where}return t},u._stat=function(e,t,r,a,i,s,n){let u=!1,h=this._reformulateWithoutAdaptions(t);return u=h.cannot,t=h.where,h=this._reformulateWithoutAdaptions(i),u=u||h.cannot,null!==(i=h.where)?null!==this._extraFilter&&(i=l.combine(this._extraFilter,i)):i=this._extraFilter,!0===u?null===i&&""===r&&null===a?this._manualStat(e,t,s,n):o.resolve({calculated:!1}):this._parent._stat(e,t,r,a,i,s,n).then((l=>!1===l.calculated?null===i&&""===r&&null===a?this._manualStat(e,t,s,n):{calculated:!1}:l))},u._canDoAggregates=function(e,t,r,a,i){if(null===this._parent)return o.resolve(!1);for(let l=0;l<e.length;l++)for(const t of this.adaptedFields)if(e[l].toLowerCase()===t.field.name.toLowerCase()&&!(t instanceof d))return o.resolve(!1);const s=[];for(let l=0;l<t.length;l++){const e=t[l];if(null!==e.workingexpr){const t=this._reformulateWithoutAdaptions(e.workingexpr);if(t.cannot)return o.resolve(!1);const r=e.clone();r.workingexpr=t.where,s.push(r)}else s.push(e)}const n=this._reformulateWithoutAdaptions(i);return n.cannot?o.resolve(!1):(null!==(i=n.where)?null!==this._extraFilter&&(i=l.combine(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,s,r,a,i))},u._getAggregatePagesDataSourceDefinition=function(e,t,r,a,i,s,n){if(null===this._parent)return o.reject(new Error("Should never be called"));const u=[];for(let l=0;l<t.length;l++){const e=t[l];if(null!==e.workingexpr){const t=this._reformulateWithoutAdaptions(e.workingexpr);if(t.cannot)return o.reject(new Error("Should never be called"));const r=e.clone();r.workingexpr=t.where,u.push(r)}else u.push(e)}const h=this._reformulateWithoutAdaptions(i);return h.cannot?o.reject(new Error("Should never be called")):(null!==(i=h.where)?null!==this._extraFilter&&(i=l.combine(this._extraFilter,i)):i=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,u,r,a,i,s,n))},i}(i);e.AdaptedFeatureSet=_,e.AdaptedField=c,e.FieldRename=f,e.OriginalField=d,e.SqlExpressionAdapted=g,e.StringToCodeAdapted=p,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
