/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../../ArcadeDate","../../kernel","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../../core/maybe","../../../core/sql/WhereClause","../../../geometry/SpatialReference"],(function(e,t,r,a,i,n,s,o,l,u,h,c,d){"use strict";let f=function(){function e(e){this.field=e,this.sqlRewritable=!1}return e.prototype.postInitialization=function(e,t){},e}(),p=function(e){function r(t){var r;return(r=e.call(this,t)||this).sqlRewritable=!0,r}t._inheritsLoose(r,e);var a=r.prototype;return a.extractValue=function(e){return e.attributes[this.field.name]},a.rewriteSql=function(e){return{rewritten:this.sqlRewritable,where:e}},r}(f),g=function(e){function r(t,r,a){var i;return(i=e.call(this,l.cloneField(t))||this).originalField=t,i.sqlRewritable=!0,i.field.name=r,i.field.alias=a,i}t._inheritsLoose(r,e);var a=r.prototype;return a.rewriteSql=function(e,t){return{rewritten:this.sqlRewritable,where:u.reformulateWithoutField(e,this.field.name,this.originalField.name,t.getFieldsIndex())}},a.extractValue=function(e){return e.attributes[this.originalField.name]},r}(f),S=function(e){function r(t,r,a){var i;(i=e.call(this,t)||this).codefield=r,i.lkp=a,i.reverseLkp={};for(const e in a)i.reverseLkp[a[e]]=e;return i.sqlRewritable=!0,i}t._inheritsLoose(r,e);var i=r.prototype;return i.rewriteSql=function(e,t){const a=this.evaluateNodeToWhereClause(e.parseTree,l.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof c.WhereClause?u.toWhereClause(this.codefield,l.FeatureServiceDatabaseType.Standardised):this.codefield,e.parameters);return a.includes(r.BADNESS)?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:c.WhereClause.create(a,h.unwrapOrThrow(t._parent).getFieldsIndex())}},i.evaluateNodeToWhereClause=function(e,t,i=null,s=null,o){let l,h,c,d;switch(e.type){case"interval":return u.convertIntervalToSql(this.evaluateNodeToWhereClause(e.value,t,i,s,o),e.qualifier,e.op);case"case-expression":{let a=" CASE ";"simple"===e.format&&(a+=this.evaluateNodeToWhereClause(e.operand,t,i,r.BADNESS,o));for(let n=0;n<e.clauses.length;n++)a+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[n].operand,t,i,r.BADNESS,o)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[n].value,t,i,r.BADNESS,o);return null!==e.else&&(a+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,i,r.BADNESS,o)),a+=" END ",a}case"parameter":{const r=o[e.value.toLowerCase()];if("string"==typeof r)return"'"+r.toString().replace(/'/g,"''")+"'";if(r instanceof Date)return u.makeDateString(r,t,null);if(r instanceof a.ArcadeDate)return u.arcadeDateToSqlString(r,t,null);if(r instanceof Array){const e=[];for(let i=0;i<r.length;i++)"string"==typeof r[i]?e.push("'"+r[i].toString().replace(/'/g,"''")+"'"):r[i]instanceof Date?e.push(u.makeDateString(r[i],t,null)):r[i]instanceof a.ArcadeDate?e.push(u.arcadeDateToSqlString(r[i],t,null)):e.push(r[i].toString());return e}return r.toString()}case"expression-list":h=[];for(const r of e.value)h.push(this.evaluateNodeToWhereClause(r,t,i,s,o));return h;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,i,r.BADNESS,o)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" AND "+this.evaluateNodeToWhereClause(e.right,t,i,s,o)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" OR "+this.evaluateNodeToWhereClause(e.right,t,i,s,o)+") ";case"IS":if("null"!==e.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new n.SqlError(n.SqlErrorCodes.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" IS NOT NULL )";case"IN":if(l=[],"expression-list"===e.right.type){if("column-reference"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let a=!0;for(const t of e.right.value){if("string"!==t.type){a=!1;break}if(void 0===this.lkp[t.value]){a=!1;break}r.push(this.lkp[t.value].toString())}if(a)return" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" IN ("+r.join(",")+")) "}return l=this.evaluateNodeToWhereClause(e.right,t,i,s,o)," ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" IN ("+l.join(",")+")) "}return d=this.evaluateNodeToWhereClause(e.right,t,i,s,o),d instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" IN ("+d.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" IN ("+d+")) ";case"NOT IN":if(l=[],"expression-list"===e.right.type){if("column-reference"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let a=!0;for(const t of e.right.value){if("string"!==t.type){a=!1;break}if(void 0===this.lkp[t.value]){a=!1;break}r.push(this.lkp[t.value].toString())}if(a)return" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" NOT IN ("+r.join(",")+")) "}return l=this.evaluateNodeToWhereClause(e.right,t,i,s,o)," ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" NOT IN ("+l.join(",")+")) "}return d=this.evaluateNodeToWhereClause(e.right,t,i,s,o),d instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" NOT IN ("+d.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,s,o)+" NOT IN ("+d+")) ";case"BETWEEN":return c=this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)," ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" BETWEEN "+c[0]+" AND "+c[1]+" ) ";case"NOTBETWEEN":return c=this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)," ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" NOT BETWEEN "+c[0]+" AND "+c[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)+") ";case"<>":case"=":if("column-reference"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+s+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column-reference"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+s+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r.BADNESS,o)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,i,r.BADNESS,o)+") "}case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return u.makeDateString(e.value,t,null);case"number":return e.value.toString();case"current-time":return u.makeToday("date"===e.mode,t);case"column-reference":return i&&i.toLowerCase()===e.column.toLowerCase()?"("+s+")":e.column;case"data-type":return e.value;case"function":{const a=this.evaluateNodeToWhereClause(e.args,t,i,r.BADNESS,o);return u.translateFunctionToDatabaseSpecific(e.name,a,t)}}throw new n.SqlError(n.SqlErrorCodes.UnsupportedSyntax,{node:e.type})},i.extractValue=function(e){return this.codefield instanceof c.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]},r}(f);S.BADNESS="_!!!_BAD_LKP_!!!!";let _=function(e){function r(t,r){var a;return(a=e.call(this,t)||this)._sql=r,a}t._inheritsLoose(r,e);var a=r.prototype;return a.rewriteSql=function(e,t){return{rewritten:!0,where:u.reformulateWithoutField(e,this.field.name,u.toWhereClause(this._sql,l.FeatureServiceDatabaseType.Standardised),t.getFieldsIndex())}},a.extractValue=function(e){return this._sql.calculateValueCompiled(e)},r}(f),N=function(e){function a(t){var r;return(r=e.call(this,t)||this)._calcFunc=null,r.declaredClass="esri.arcade.featureset.actions.Adapted",r.adaptedFields=[],r._extraFilter=null,r._extraFilter=t.extraFilter,r._parent=t.parentfeatureset,r._maxProcessing=30,r.adaptedFields=t.adaptedFields,r}t._inheritsLoose(a,e),a.findField=function(e,t){for(const r of e)if(r.name.toLowerCase()===t.toString().toLowerCase())return r;return null};var s=a.prototype;return s._initialiseFeatureSet=function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new d({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=l.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null),this.fields=[];for(const e of this.adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)},s._getSet=function(){var e=t._asyncToGenerator((function*(e){if(null===this._wset){yield this._ensureLoaded();let t=null;return t=this._extraFilter?yield this._getFilteredSet("",null,null,null,e):yield this._parent?._getSet(e),this._checkCancelled(e),h.assertIsSome(t),this._wset=new o(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset}return this._wset}));function r(t){return e.apply(this,arguments)}return r}(),s._isInFeatureSet=function(e){return h.unwrapOrThrow(this._parent)._isInFeatureSet(e)},s._getFeatures=function(){var e=t._asyncToGenerator((function*(e,t,a,n){const s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);const l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return yield this._expandPagedSet(e,l,0,0,n),this._getFeatures(e,t,a,n);let u=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(u++,u<=a&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&s.push(e._known[r]),s.length>=l)));r++);if(0===s.length)return"success";e=new o([],s,e._ordered,null);const h=Math.min(s.length,a);yield this._parent?._getFeatures(e,-1,h,n),this._checkCancelled(n);const c=[];for(let r=0;r<h;r++){const e=this._parent?._featureFromCache(s[r]);void 0!==e&&c.push({geometry:e.geometry,attributes:e.attributes,id:s[r]})}for(const o of c){const e=[];for(const t of this.adaptedFields)e[t.field.name]=t.extractValue(o);this._featureCache[o.id]=new r({attributes:e,geometry:i.cloneGeometry(o.geometry)})}return"success"}));function a(t,r,a,i){return e.apply(this,arguments)}return a}(),s._fetchAndRefineFeatures=function(){var e=t._asyncToGenerator((function*(){throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach)}));function r(){return e.apply(this,arguments)}return r}(),s._getFilteredSet=function(){var e=t._asyncToGenerator((function*(e,t,r,a,i){let n=!1;const s=this._reformulateWithoutAdaptions(r);n=s.cannot,r=s.where;let l=!1;if(null!==a){l=!0;const e=[];for(const t of this.adaptedFields)if(!(t instanceof p)&&!0===a.scanForField(t.field.name)){if(!(t instanceof g)){a=null,l=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}a&&e.length>0&&(a=a.replaceFields(e))}null!==r?null!==this._extraFilter&&(r=u.combine(this._extraFilter,r)):r=this._extraFilter,yield this._ensureLoaded();const c=yield h.unwrapOrThrow(this._parent)._getFilteredSet(e,t,r,a,i);let d;return this._checkCancelled(i),d=!0===n?new o(c._candidates.slice(0).concat(c._known.slice(0)),[],!0===l&&c._ordered,this._clonePageDefinition(c.pagesDefinition)):new o(c._candidates.slice(0),c._known.slice(0),!0===l&&c._ordered,this._clonePageDefinition(c.pagesDefinition)),d}));function r(t,r,a,i,n){return e.apply(this,arguments)}return r}(),s._reformulateWithoutAdaptions=function(e){const t={cannot:!1,where:e};if(null!==e)for(const r of this.adaptedFields)if(!0===u.scanForField(e,r.field.name)){const a=r.rewriteSql(e,this);if(!0!==a.rewritten){t.cannot=!0,t.where=null;break}t.where=a.where}return t},s._stat=function(){var e=t._asyncToGenerator((function*(e,t,r,a,i,n,s){let o=!1,l=this._reformulateWithoutAdaptions(t);if(o=l.cannot,t=l.where,l=this._reformulateWithoutAdaptions(i),o=o||l.cannot,null!==(i=l.where)?null!==this._extraFilter&&(i=u.combine(this._extraFilter,i)):i=this._extraFilter,!0===o)return null===i&&""===r&&null===a?this._manualStat(e,t,n,s):{calculated:!1};const c=yield h.unwrapOrThrow(this._parent)._stat(e,t,r,a,i,n,s);return!1===c.calculated?null===i&&""===r&&null===a?this._manualStat(e,t,n,s):{calculated:!1}:c}));function r(t,r,a,i,n,s,o){return e.apply(this,arguments)}return r}(),s._canDoAggregates=function(){var e=t._asyncToGenerator((function*(e,t,r,a,i){if(null===this._parent)return!1;for(let o=0;o<e.length;o++)for(const t of this.adaptedFields)if(e[o].toLowerCase()===t.field.name.toLowerCase()&&!(t instanceof p))return!1;const n=[];for(let o=0;o<t.length;o++){const e=t[o];if(null!==e.workingexpr){const t=this._reformulateWithoutAdaptions(e.workingexpr);if(t.cannot)return!1;const r=e.clone();r.workingexpr=t.where,n.push(r)}else n.push(e)}const s=this._reformulateWithoutAdaptions(i);return!s.cannot&&(null!==(i=s.where)?null!==this._extraFilter&&(i=u.combine(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,n,r,a,i))}));function r(t,r,a,i,n){return e.apply(this,arguments)}return r}(),s._getAggregatePagesDataSourceDefinition=function(){var e=t._asyncToGenerator((function*(e,t,r,a,i,s,o){if(null===this._parent)throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach);const l=[];for(let u=0;u<t.length;u++){const e=t[u];if(null!==e.workingexpr){const t=this._reformulateWithoutAdaptions(e.workingexpr);if(t.cannot)throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach);const r=e.clone();r.workingexpr=t.where,l.push(r)}else l.push(e)}const h=this._reformulateWithoutAdaptions(i);if(h.cannot)throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach);return null!==(i=h.where)?null!==this._extraFilter&&(i=u.combine(this._extraFilter,i)):i=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,l,r,a,i,s,o)}));function r(t,r,a,i,n,s,o){return e.apply(this,arguments)}return r}(),a}(s);e.AdaptedFeatureSet=N,e.AdaptedField=f,e.FieldRename=g,e.OriginalField=p,e.SqlExpressionAdapted=_,e.StringToCodeAdapted=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
