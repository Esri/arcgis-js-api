// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/extends","../../../graphic","../../ArcadeDate","../../kernel","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../polyfill/maybe","../../polyfill/sql/WhereClause","../../../SpatialReference"],(function(e,t,r,a,i,n,s,l,o,u,h,d,c,p,f,v){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdaptedFeatureSet=t.SqlExpressionAdapted=t.StringToCodeAdapted=t.FieldRename=t.OriginalField=t.AdaptedField=void 0;var g=function(){function e(e){this.field=e,this.sqlRewritable=!1}return e.prototype.postInitialization=function(e,t){},e}();t.AdaptedField=g;var S=function(e){function t(t){var r=e.call(this,t)||this;return r.sqlRewritable=!0,r}return i(t,e),t.prototype.extractValue=function(e){return e.attributes[this.field.name]},t.prototype.rewriteSql=function(e){return{rewritten:this.sqlRewritable,where:e}},t}(g);t.OriginalField=S;var _=function(e){function t(t,r,a){var i=e.call(this,d.cloneField(t))||this;return i.originalField=t,i.sqlRewritable=!0,i.field.name=r,i.field.alias=a,i}return i(t,e),t.prototype.rewriteSql=function(e,t){return{rewritten:this.sqlRewritable,where:c.reformulateWithoutField(e,this.field.name,this.originalField.name,t.getFieldsIndex())}},t.prototype.extractValue=function(e){return e.attributes[this.originalField.name]},t}(g);t.FieldRename=_;var N=function(e){function t(t,r,a){var i=e.call(this,t)||this;for(var n in i.codefield=r,i.lkp=a,i.reverseLkp={},a)i.reverseLkp[a[n]]=n;return i.sqlRewritable=!0,i}return i(t,e),t.prototype.rewriteSql=function(e,r){var a=this.evaluateNodeToWhereClause(e.parseTree,d.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof f.WhereClause?c.toWhereClause(this.codefield,d.FeatureServiceDatabaseType.Standardised):this.codefield,e.parameters);return a.includes(t.BADNESS)?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:f.WhereClause.create(a,p.unwrapOrThrow(r._parent).getFieldsIndex())}},t.prototype.evaluateNodeToWhereClause=function(e,r,a,i,n){var l,u,h,d;switch(void 0===a&&(a=null),void 0===i&&(i=null),e.type){case"interval":return c.convertIntervalToSql(this.evaluateNodeToWhereClause(e.value,r,a,i,n),e.qualifier,e.op);case"case-expression":var p=" CASE ";"simple"===e.format&&(p+=this.evaluateNodeToWhereClause(e.operand,r,a,t.BADNESS,n));for(var f=0;f<e.clauses.length;f++)p+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[f].operand,r,a,t.BADNESS,n)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[f].value,r,a,t.BADNESS,n);return null!==e.else&&(p+=" ELSE "+this.evaluateNodeToWhereClause(e.else,r,a,t.BADNESS,n)),p+=" END ";case"parameter":var v=n[e.value.toLowerCase()];if("string"==typeof v)return"'"+v.toString().replace(/'/g,"''")+"'";if(v instanceof Date)return c.makeDateString(v,r,null,"parameter");if(v instanceof s.ArcadeDate)return c.arcadeDateToSqlString(v,r,null,"parameter");if(v instanceof Array){var g=[];for(f=0;f<v.length;f++)"string"==typeof v[f]?g.push("'"+v[f].toString().replace(/'/g,"''")+"'"):v[f]instanceof Date?g.push(c.makeDateString(v[f],r,null,"parameter")):v[f]instanceof s.ArcadeDate?g.push(c.arcadeDateToSqlString(v[f],r,null,"parameter")):g.push(v[f].toString());return g}return v.toString();case"expression-list":u=[];for(var S=0,_=e.value;S<_.length;S++){var N=_[S];u.push(this.evaluateNodeToWhereClause(N,r,a,i,n))}return u;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,r,a,t.BADNESS,n)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" AND "+this.evaluateNodeToWhereClause(e.right,r,a,i,n)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" OR "+this.evaluateNodeToWhereClause(e.right,r,a,i,n)+") ";case"IS":if("null"!==e.right.type)throw new o.SqlError(o.SqlErrorCodes.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new o.SqlError(o.SqlErrorCodes.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" IS NOT NULL )";case"IN":if(l=[],"expression-list"===e.right.type){if("column-reference"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){for(var w=[],C=!0,m=0,F=e.right.value;m<F.length;m++){if("string"!==(E=F[m]).type){C=!1;break}if(void 0===this.lkp[E.value]){C=!1;break}w.push(this.lkp[E.value].toString())}if(C)return" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" IN ("+w.join(",")+")) "}return l=this.evaluateNodeToWhereClause(e.right,r,a,i,n)," ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" IN ("+l.join(",")+")) "}return(d=this.evaluateNodeToWhereClause(e.right,r,a,i,n))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" IN ("+d.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" IN ("+d+")) ";case"NOT IN":if(l=[],"expression-list"===e.right.type){if("column-reference"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){w=[],C=!0;for(var T=0,y=e.right.value;T<y.length;T++){var E;if("string"!==(E=y[T]).type){C=!1;break}if(void 0===this.lkp[E.value]){C=!1;break}w.push(this.lkp[E.value].toString())}if(C)return" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" NOT IN ("+w.join(",")+")) "}return l=this.evaluateNodeToWhereClause(e.right,r,a,i,n)," ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" NOT IN ("+l.join(",")+")) "}return(d=this.evaluateNodeToWhereClause(e.right,r,a,i,n))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" NOT IN ("+d.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,a,i,n)+" NOT IN ("+d+")) ";case"BETWEEN":return h=this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)," ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"NOTBETWEEN":return h=this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)," ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" NOT BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)+") ";case"<>":case"=":if("column-reference"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+i+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column-reference"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(e.left,r,a,t.BADNESS,n)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,r,a,t.BADNESS,n)+") "}case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":return c.makeDateString(e.value,r,null,"timestamp");case"date":return c.makeDateString(e.value,r,null,"date");case"number":return e.value.toString();case"current-time":return c.makeToday("date"===e.mode,r);case"column-reference":return a&&a.toLowerCase()===e.column.toLowerCase()?"("+i+")":e.column;case"data-type":return e.value;case"function":var W=this.evaluateNodeToWhereClause(e.args,r,a,t.BADNESS,n);return c.translateFunctionToDatabaseSpecific(e.name,W,r)}throw new o.SqlError(o.SqlErrorCodes.UnsupportedSyntax,{node:e.type})},t.prototype.extractValue=function(e){return this.codefield instanceof f.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]},t.BADNESS="_!!!_BAD_LKP_!!!!",t}(g);t.StringToCodeAdapted=N;var w=function(e){function t(t,r){var a=e.call(this,t)||this;return a._sql=r,a}return i(t,e),t.prototype.rewriteSql=function(e,t){return{rewritten:!0,where:c.reformulateWithoutField(e,this.field.name,c.toWhereClause(this._sql,d.FeatureServiceDatabaseType.Standardised),t.getFieldsIndex())}},t.prototype.extractValue=function(e){return this._sql.calculateValueCompiled(e)},t}(g);t.SqlExpressionAdapted=w;var C=function(e){function t(t){var r=e.call(this,t)||this;return r._calcFunc=null,r.declaredClass="esri.arcade.featureset.actions.Adapted",r.adaptedFields=[],r._extraFilter=null,r._extraFilter=t.extraFilter,r._parent=t.parentfeatureset,r._maxProcessing=30,r.adaptedFields=t.adaptedFields,r}return i(t,e),t.findField=function(e,t){for(var r=0,a=e;r<a.length;r++){var i=a[r];if(i.name.toLowerCase()===t.toString().toLowerCase())return i}return null},t.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new v({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=d.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null),this.fields=[];for(var e=0,t=this.adaptedFields;e<t.length;e++){var r=t[e];r.postInitialization(this,this._parent),this.fields.push(r.field)}},t.prototype._getSet=function(e){var t;return r(this,void 0,void 0,(function(){var r;return a(this,(function(a){switch(a.label){case 0:return null!==this._wset?[3,6]:[4,this._ensureLoaded()];case 1:return a.sent(),r=null,this._extraFilter?[3,3]:[4,null===(t=this._parent)||void 0===t?void 0:t._getSet(e)];case 2:return r=a.sent(),[3,5];case 3:return[4,this._getFilteredSet("",null,null,null,e)];case 4:r=a.sent(),a.label=5;case 5:return this._checkCancelled(e),p.assertIsSome(r),this._wset=new h(r._candidates.slice(0),r._known.slice(0),r._ordered,this._clonePageDefinition(r.pagesDefinition)),[2,this._wset];case 6:return[2,this._wset]}}))}))},t.prototype._isInFeatureSet=function(e){return p.unwrapOrThrow(this._parent)._isInFeatureSet(e)},t.prototype._getFeatures=function(e,t,i,s){var o,u;return r(this,void 0,void 0,(function(){var r,d,c,p,f,v,g,S,_,N,w,C,m,F;return a(this,(function(a){switch(a.label){case 0:return r=[],-1!==t&&void 0===this._featureCache[t]&&r.push(t),d=this._maxQueryRate(),!0!==this._checkIfNeedToExpandKnownPage(e,d)?[3,2]:[4,this._expandPagedSet(e,d,0,0,s)];case 1:return a.sent(),[2,this._getFeatures(e,t,i,s)];case 2:for(c=0,v=e._lastFetchedIndex;v<e._known.length&&(++c<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[v]]&&(e._known[v]!==t&&r.push(e._known[v]),r.length>=d)));v++);return 0===r.length?[2,"success"]:(e=new h([],r,e._ordered,null),p=Math.min(r.length,i),[4,null===(o=this._parent)||void 0===o?void 0:o._getFeatures(e,-1,p,s)]);case 3:for(a.sent(),this._checkCancelled(s),f=[],v=0;v<p;v++)void 0!==(g=null===(u=this._parent)||void 0===u?void 0:u._featureFromCache(r[v]))&&f.push({geometry:g.geometry,attributes:g.attributes,id:r[v]});for(S=0,_=f;S<_.length;S++){for(N=_[S],w=[],C=0,m=this.adaptedFields;C<m.length;C++)F=m[C],w[F.field.name]=F.extractValue(N);this._featureCache[N.id]=new n({attributes:w,geometry:l.cloneGeometry(N.geometry)})}return[2,"success"]}}))}))},t.prototype._fetchAndRefineFeatures=function(){return r(this,void 0,void 0,(function(){return a(this,(function(e){throw new o.FeatureSetError(o.FeatureSetErrorCodes.NeverReach)}))}))},t.prototype._getFilteredSet=function(e,t,i,n,s){return r(this,void 0,void 0,(function(){var r,l,o,u,d,f,v,g;return a(this,(function(a){switch(a.label){case 0:if(r=!1,l=this._reformulateWithoutAdaptions(i),r=l.cannot,i=l.where,o=!1,null!==n){for(o=!0,u=[],d=0,f=this.adaptedFields;d<f.length;d++)if(!((v=f[d])instanceof S)&&!0===n.scanForField(v.field.name)){if(!(v instanceof _)){n=null,o=!1;break}u.push({field:v.field.name,newfield:v.originalField.name})}n&&u.length>0&&(n=n.replaceFields(u))}return null!==i?null!==this._extraFilter&&(i=c.combine(this._extraFilter,i)):i=this._extraFilter,[4,this._ensureLoaded()];case 1:return a.sent(),[4,p.unwrapOrThrow(this._parent)._getFilteredSet(e,t,i,n,s)];case 2:return g=a.sent(),this._checkCancelled(s),[2,!0===r?new h(g._candidates.slice(0).concat(g._known.slice(0)),[],!0===o&&g._ordered,this._clonePageDefinition(g.pagesDefinition)):new h(g._candidates.slice(0),g._known.slice(0),!0===o&&g._ordered,this._clonePageDefinition(g.pagesDefinition))]}}))}))},t.prototype._reformulateWithoutAdaptions=function(e){var t={cannot:!1,where:e};if(null!==e)for(var r=0,a=this.adaptedFields;r<a.length;r++){var i=a[r];if(!0===c.scanForField(e,i.field.name)){var n=i.rewriteSql(e,this);if(!0!==n.rewritten){t.cannot=!0,t.where=null;break}t.where=n.where}}return t},t.prototype._stat=function(e,t,i,n,s,l,o){return r(this,void 0,void 0,(function(){var r,u,h;return a(this,(function(a){switch(a.label){case 0:return r=!1,u=this._reformulateWithoutAdaptions(t),r=u.cannot,t=u.where,u=this._reformulateWithoutAdaptions(s),r=r||u.cannot,null!==(s=u.where)?null!==this._extraFilter&&(s=c.combine(this._extraFilter,s)):s=this._extraFilter,!0===r?null===s&&""===i&&null===n?[2,this._manualStat(e,t,l,o)]:[2,{calculated:!1}]:[4,p.unwrapOrThrow(this._parent)._stat(e,t,i,n,s,l,o)];case 1:return!1===(h=a.sent()).calculated?null===s&&""===i&&null===n?[2,this._manualStat(e,t,l,o)]:[2,{calculated:!1}]:[2,h]}}))}))},t.prototype._canDoAggregates=function(e,t,i,n,s){return r(this,void 0,void 0,(function(){var r,l,o,u,h,d,p,f,v;return a(this,(function(a){if(null===this._parent)return[2,!1];for(h=0;h<e.length;h++)for(r=0,l=this.adaptedFields;r<l.length;r++)if(o=l[r],e[h].toLowerCase()===o.field.name.toLowerCase()&&!(o instanceof S))return[2,!1];for(u=[],h=0;h<t.length;h++)if(null!==(d=t[h]).workingexpr){if((p=this._reformulateWithoutAdaptions(d.workingexpr)).cannot)return[2,!1];(f=d.clone()).workingexpr=p.where,u.push(f)}else u.push(d);return(v=this._reformulateWithoutAdaptions(s)).cannot?[2,!1]:(null!==(s=v.where)?null!==this._extraFilter&&(s=c.combine(this._extraFilter,s)):s=this._extraFilter,[2,this._parent._canDoAggregates(e,u,i,n,s)])}))}))},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,i,n,s,l,u){return r(this,void 0,void 0,(function(){var r,h,d,p,f,v;return a(this,(function(a){if(null===this._parent)throw new o.FeatureSetError(o.FeatureSetErrorCodes.NeverReach);for(r=[],h=0;h<t.length;h++)if(null!==(d=t[h]).workingexpr){if((p=this._reformulateWithoutAdaptions(d.workingexpr)).cannot)throw new o.FeatureSetError(o.FeatureSetErrorCodes.NeverReach);(f=d.clone()).workingexpr=p.where,r.push(f)}else r.push(d);if((v=this._reformulateWithoutAdaptions(s)).cannot)throw new o.FeatureSetError(o.FeatureSetErrorCodes.NeverReach);return null!==(s=v.where)?null!==this._extraFilter&&(s=c.combine(this._extraFilter,s)):s=this._extraFilter,[2,this._parent._getAggregatePagesDataSourceDefinition(e,r,i,n,s,l,u)]}))}))},t}(u);t.AdaptedFeatureSet=C}));