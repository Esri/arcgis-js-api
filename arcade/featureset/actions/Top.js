// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/spreadarray","../../polyfill/tsSupport/extends","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared"],(function(t,e,n,s,i,r,o,a,u,h,_){"use strict";return function(t){function e(e){var n=t.call(this,e)||this;return n._topnum=0,n.declaredClass="esri.arcade.featureset.actions.Top",n._countedin=0,n._maxProcessing=100,n._topnum=e.topnum,n._parent=e.parentfeatureset,n}return o(e,t),e.prototype._getSet=function(t){return n(this,void 0,void 0,(function(){var e;return s(this,(function(n){switch(n.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return n.sent(),[4,this._parent._getSet(t)];case 2:return e=n.sent(),this._wset=new h(e._candidates.slice(0),e._known.slice(0),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),[2,this._wset];case 3:return[2,this._wset]}}))}))},e.prototype._setKnownLength=function(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length},e.prototype._isInFeatureSet=function(t){var e=this._parent._isInFeatureSet(t);if(e===_.IdState.NotInFeatureSet)return e;var n=this._idstates[t];return n===_.IdState.InFeatureSet||n===_.IdState.NotInFeatureSet?n:e===_.IdState.InFeatureSet&&void 0===n?this._countedin<this._topnum?(this._idstates[t]=_.IdState.InFeatureSet,this._countedin++,_.IdState.InFeatureSet):(this._idstates[t]=_.IdState.NotInFeatureSet,_.IdState.NotInFeatureSet):_.IdState.Unknown},e.prototype._expandPagedSet=function(t,e,i,r,o){return n(this,void 0,void 0,(function(){var n,u;return s(this,(function(s){switch(s.label){case 0:if(null===this._parent)throw new a.FeatureSetError(a.FeatureSetErrorCodes.NotImplemented);return e>this._topnum&&(e=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset?((n=t._known.length)>0&&"GETPAGES"===t._known[n-1]&&(t._known.length=n-1),(n=t._candidates.length)>0&&"GETPAGES"===t._candidates[n-1]&&(t._candidates.length=n-1),[2,"success"]):[4,this._parent._expandPagedSet(t,e,i,r,o)];case 1:return u=s.sent(),this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),[2,u]}}))}))},e.prototype._getFeatures=function(t,e,i,r){return n(this,void 0,void 0,(function(){var n,o,a,u,_,d,c;return s(this,(function(s){switch(s.label){case 0:return n=[],o=this._maxQueryRate(),!0!==this._checkIfNeedToExpandKnownPage(t,o)?[3,2]:[4,this._expandPagedSet(t,o,0,0,r)];case 1:return s.sent(),[2,this._getFeatures(t,e,i,r)];case 2:for(-1!==e&&void 0===this._featureCache[e]&&n.push(e),a=0,d=t._lastFetchedIndex;d<t._known.length&&(++a<=i&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[d]]&&(t._known[d]!==e&&n.push(t._known[d]),n.length>o)));d++);return 0===n.length?[2,"success"]:(u=new h([],n,!1,null),_=Math.min(n.length,i),[4,this._parent._getFeatures(u,-1,_,r)]);case 3:for(s.sent(),d=0;d<_;d++)void 0!==(c=this._parent._featureFromCache(n[d]))&&(this._featureCache[n[d]]=c);return[2,"success"]}}))}))},e.prototype._getFilteredSet=function(t,e,i,r,o){return n(this,void 0,void 0,(function(){var t;return s(this,(function(e){switch(e.label){case 0:return[4,this._ensureLoaded()];case 1:return e.sent(),[4,this._getSet(o)];case 2:return t=e.sent(),[2,new h(t._candidates.slice(0).concat(t._known.slice(0)),[],!1,this._clonePageDefinition(t.pagesDefinition))]}}))}))},e.prototype._refineKnowns=function(t,e){for(var n=0,s=null,i=[],r=0;r<t._candidates.length;r++){var o=this._isInFeatureSet(t._candidates[r]);if(o===_.IdState.InFeatureSet){if(t._known.push(t._candidates[r]),n+=1,null===s?s={start:r,end:r}:s.end===r-1?s.end=r:(i.push(s),s={start:r,end:r}),t._known.length>=this._topnum)break}else if(o===_.IdState.NotInFeatureSet)null===s?s={start:r,end:r}:s.end===r-1?s.end=r:(i.push(s),s={start:r,end:r}),n+=1;else if(o===_.IdState.Unknown)break;if(n>=e)break}null!==s&&i.push(s);for(var a=i.length-1;a>=0;a--)t._candidates.splice(i[a].start,i[a].end-i[a].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])},e.prototype._stat=function(){return n(this,void 0,void 0,(function(){return s(this,(function(t){return[2,{calculated:!1}]}))}))},e.prototype._canDoAggregates=function(){return n(this,void 0,void 0,(function(){return s(this,(function(t){return[2,!1]}))}))},e.registerAction=function(){u._featuresetFunctions.top=function(t){return new e({parentfeatureset:this,topnum:t})}},e}(u)}));