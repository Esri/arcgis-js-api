/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import t from"../support/FeatureSet.js";import e from"../support/IdSet.js";import{IdState as n}from"../support/shared.js";class s extends t{constructor(t){super(t),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const n=await this._parent._getSet(t);return this._wset=new e(n._candidates.slice(0),n._known.slice(0),!1,this._clonePageDefinition(n.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===n.NotInFeatureSet)return e;const s=this._idstates[t];return s===n.InFeatureSet||s===n.NotInFeatureSet?s:e===n.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=n.InFeatureSet,this._countedin++,n.InFeatureSet):(this._idstates[t]=n.NotInFeatureSet,n.NotInFeatureSet):n.Unknown}async _expandPagedSet(t,e,n,s,i){if(null===this._parent)throw new Error("Parent Paging not implemented");if(e>this._topnum&&(e=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset){let e=t._known.length;return e>0&&"GETPAGES"===t._known[e-1]&&(t._known.length=e-1),e=t._candidates.length,e>0&&"GETPAGES"===t._candidates[e-1]&&(t._candidates.length=e-1),"success"}const a=await this._parent._expandPagedSet(t,e,n,s,i);return this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),a}async _getFeatures(t,n,s,i){const a=[],o=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,o))return await this._expandPagedSet(t,o,0,0,i),this._getFeatures(t,n,s,i);-1!==n&&void 0===this._featureCache[n]&&a.push(n);let r=0;for(let e=t._lastFetchedIndex;e<t._known.length&&(r++,r<=s&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[e]]&&(t._known[e]!==n&&a.push(t._known[e]),a.length>o)));e++);if(0===a.length)return"success";const _=new e([],a,!1,null),h=Math.min(a.length,s);await this._parent._getFeatures(_,-1,h,i);for(let e=0;e<h;e++){const t=this._parent._featureFromCache(a[e]);void 0!==t&&(this._featureCache[a[e]]=t)}return"success"}async _getFilteredSet(t,n,s,i,a){await this._ensureLoaded();const o=await this._getSet(a);return new e(o._candidates.slice(0).concat(o._known.slice(0)),[],!1,this._clonePageDefinition(o.pagesDefinition))}_refineKnowns(t,e){let s=0,i=null;const a=[];for(let o=0;o<t._candidates.length;o++){const r=this._isInFeatureSet(t._candidates[o]);if(r===n.InFeatureSet){if(t._known.push(t._candidates[o]),s+=1,null===i?i={start:o,end:o}:i.end===o-1?i.end=o:(a.push(i),i={start:o,end:o}),t._known.length>=this._topnum)break}else if(r===n.NotInFeatureSet)null===i?i={start:o,end:o}:i.end===o-1?i.end=o:(a.push(i),i={start:o,end:o}),s+=1;else if(r===n.Unknown)break;if(s>=e)break}null!==i&&a.push(i);for(let n=a.length-1;n>=0;n--)t._candidates.splice(a[n].start,a[n].end-a[n].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){t._featuresetFunctions.top=function(t){return new s({parentfeatureset:this,topnum:t})}}}export{s as default};
