/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared"],(function(t,e,n,s,i){"use strict";let r=function(r){function a(t){var e;return(e=r.call(this,t)||this)._topnum=0,e.declaredClass="esri.arcade.featureset.actions.Top",e._countedin=0,e._maxProcessing=100,e._topnum=t.topnum,e._parent=t.parentfeatureset,e}t._inheritsLoose(a,r);var o=a.prototype;return o._getSet=function(){var e=t._asyncToGenerator((function*(t){if(null===this._wset){yield this._ensureLoaded();const e=yield this._parent._getSet(t);return this._wset=new s(e._candidates.slice(0),e._known.slice(0),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}));function n(t){return e.apply(this,arguments)}return n}(),o._setKnownLength=function(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length},o._isInFeatureSet=function(t){const e=this._parent._isInFeatureSet(t);if(e===i.IdState.NotInFeatureSet)return e;const n=this._idstates[t];return n===i.IdState.InFeatureSet||n===i.IdState.NotInFeatureSet?n:e===i.IdState.InFeatureSet&&void 0===n?this._countedin<this._topnum?(this._idstates[t]=i.IdState.InFeatureSet,this._countedin++,i.IdState.InFeatureSet):(this._idstates[t]=i.IdState.NotInFeatureSet,i.IdState.NotInFeatureSet):i.IdState.Unknown},o._expandPagedSet=function(){var n=t._asyncToGenerator((function*(t,n,s,i,r){if(null===this._parent)throw new e.FeatureSetError(e.FeatureSetErrorCodes.NotImplemented);if(n>this._topnum&&(n=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset){let e=t._known.length;return e>0&&"GETPAGES"===t._known[e-1]&&(t._known.length=e-1),e=t._candidates.length,e>0&&"GETPAGES"===t._candidates[e-1]&&(t._candidates.length=e-1),"success"}const a=yield this._parent._expandPagedSet(t,n,s,i,r);return this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),a}));function s(t,e,s,i,r){return n.apply(this,arguments)}return s}(),o._getFeatures=function(){var e=t._asyncToGenerator((function*(t,e,n,i){const r=[],a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,a))return yield this._expandPagedSet(t,a,0,0,i),this._getFeatures(t,e,n,i);-1!==e&&void 0===this._featureCache[e]&&r.push(e);let o=0;for(let s=t._lastFetchedIndex;s<t._known.length&&(o++,o<=n&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[s]]&&(t._known[s]!==e&&r.push(t._known[s]),r.length>a)));s++);if(0===r.length)return"success";const u=new s([],r,!1,null),_=Math.min(r.length,n);yield this._parent._getFeatures(u,-1,_,i);for(let s=0;s<_;s++){const t=this._parent._featureFromCache(r[s]);void 0!==t&&(this._featureCache[r[s]]=t)}return"success"}));function n(t,n,s,i){return e.apply(this,arguments)}return n}(),o._getFilteredSet=function(){var e=t._asyncToGenerator((function*(t,e,n,i,r){yield this._ensureLoaded();const a=yield this._getSet(r);return new s(a._candidates.slice(0).concat(a._known.slice(0)),[],!1,this._clonePageDefinition(a.pagesDefinition))}));function n(t,n,s,i,r){return e.apply(this,arguments)}return n}(),o._refineKnowns=function(t,e){let n=0,s=null;const r=[];for(let a=0;a<t._candidates.length;a++){const o=this._isInFeatureSet(t._candidates[a]);if(o===i.IdState.InFeatureSet){if(t._known.push(t._candidates[a]),n+=1,null===s?s={start:a,end:a}:s.end===a-1?s.end=a:(r.push(s),s={start:a,end:a}),t._known.length>=this._topnum)break}else if(o===i.IdState.NotInFeatureSet)null===s?s={start:a,end:a}:s.end===a-1?s.end=a:(r.push(s),s={start:a,end:a}),n+=1;else if(o===i.IdState.Unknown)break;if(n>=e)break}null!==s&&r.push(s);for(let i=r.length-1;i>=0;i--)t._candidates.splice(r[i].start,r[i].end-r[i].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])},o._stat=function(){var e=t._asyncToGenerator((function*(){return{calculated:!1}}));function n(){return e.apply(this,arguments)}return n}(),o._canDoAggregates=function(){var e=t._asyncToGenerator((function*(){return!1}));function n(){return e.apply(this,arguments)}return n}(),a.registerAction=function(){n._featuresetFunctions.top=function(t){return new a({parentfeatureset:this,topnum:t})}},a}(n);return r}));
