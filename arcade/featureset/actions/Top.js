/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/promiseUtils","../support/shared","../support/IdSet","../support/FeatureSet"],(function(t,e,n,s,i){"use strict";return function(a){function o(t){var e;return(e=a.call(this,t)||this)._topnum=0,e.declaredClass="esri.arcade.featureset.actions.Top",e._countedin=0,e._maxProcessing=100,e._topnum=t.topnum,e._parent=t.parentfeatureset,e}t._inheritsLoose(o,a);var r=o.prototype;return r._getSet=function(t){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getSet(t))).then((t=>(this._wset=new s(t._candidates.slice(0),t._known.slice(0),!1,this._clonePageDefinition(t.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset))):e.resolve(this._wset)},r._setKnownLength=function(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length},r._isInFeatureSet=function(t){const e=this._parent._isInFeatureSet(t);if(e===n.IdState.NotInFeatureSet)return e;const s=this._idstates[t];return s===n.IdState.InFeatureSet||s===n.IdState.NotInFeatureSet?s:e===n.IdState.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=n.IdState.InFeatureSet,this._countedin++,n.IdState.InFeatureSet):(this._idstates[t]=n.IdState.NotInFeatureSet,n.IdState.NotInFeatureSet):n.IdState.Unknown},r._expandPagedSet=function(t,n,s,i,a){if(null===this._parent)return e.reject(new Error("Parent Paging not implemented"));if(n>this._topnum&&(n=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset){let n=t._known.length;return n>0&&"GETPAGES"===t._known[n-1]&&(t._known.length=n-1),n=t._candidates.length,n>0&&"GETPAGES"===t._candidates[n-1]&&(t._candidates.length=n-1),e.resolve("success")}return this._parent._expandPagedSet(t,n,s,i,a).then((e=>(this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),e)))},r._getFeatures=function(t,n,i,a){const o=[],r=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,r))return this._expandPagedSet(t,r,0,0,a).then((()=>this._getFeatures(t,n,i,a)));-1!==n&&void 0===this._featureCache[n]&&o.push(n);let _=0;for(let e=t._lastFetchedIndex;e<t._known.length&&(_++,_<=i&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[e]]&&(t._known[e]!==n&&o.push(t._known[e]),o.length>r-1)));e++);if(0===o.length)return e.resolve("success");const u=new s([],o,!1,null),h=Math.min(o.length,i);return this._parent._getFeatures(u,-1,h,a).then((()=>{for(let t=0;t<h;t++){const e=this._parent._featureFromCache(o[t]);void 0!==e&&(this._featureCache[o[t]]=e)}return"success"}))},r._getFilteredSet=function(t,e,n,i,a){return this._ensureLoaded().then((()=>this._getSet(a))).then((t=>new s(t._candidates.slice(0).concat(t._known.slice(0)),[],!1,this._clonePageDefinition(t.pagesDefinition))))},r._refineKnowns=function(t,e){let s=0,i=null;const a=[];for(let o=0;o<t._candidates.length;o++){const r=this._isInFeatureSet(t._candidates[o]);if(r===n.IdState.InFeatureSet){if(t._known.push(t._candidates[o]),s+=1,null===i?i={start:o,end:o}:i.end===o-1?i.end=o:(a.push(i),i={start:o,end:o}),t._known.length>=this._topnum)break}else if(r===n.IdState.NotInFeatureSet)null===i?i={start:o,end:o}:i.end===o-1?i.end=o:(a.push(i),i={start:o,end:o}),s+=1;else if(r===n.IdState.Unknown)break;if(s>=e)break}null!==i&&a.push(i);for(let e=a.length-1;e>=0;e--)t._candidates.splice(a[e].start,a[e].end-a[e].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])},r._stat=function(){return e.resolve({calculated:!1})},r._canDoAggregates=function(){return e.resolve(!1)},o.registerAction=function(){i._featuresetFunctions.top=function(t){return new o({parentfeatureset:this,topnum:t})}},o}(i)}));
