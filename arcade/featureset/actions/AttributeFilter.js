// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/extends","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../polyfill/promiseUtils","../../polyfill/sql/WhereClause","../../../SpatialReference"],(function(e,t,n,i,r,s,a,u,l,o,h,c,_){"use strict";return function(e){function t(t){var n=e.call(this,t)||this;return n.declaredClass="esri.arcade.featureset.actions.AttributeFilter",n._maxProcessing=1e3,n._parent=t.parentfeatureset,t.whereclause instanceof c.WhereClause?(n._whereclause=t.whereclause,n._whereClauseFunction=null):(n._whereClauseFunction=t.whereclause,n._whereclause=null),n}return r(t,e),t.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new _({wkid:4326}),this.geometryType=l.layerGeometryEsriConstants.point)},t.prototype._getSet=function(e){return n(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return n.sent(),[4,this._parent._getFilteredSet("",null,this._whereclause,null,e)];case 2:return t=n.sent(),this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new u(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new u(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),[2,this._wset];case 3:return[2,this._wset]}}))}))},t.prototype._isInFeatureSet=function(e){var t,n=null===(t=this._parent)||void 0===t?void 0:t._isInFeatureSet(e);return n===l.IdState.NotInFeatureSet?n:void 0===(n=this._idstates[e])?l.IdState.Unknown:n},t.prototype._getFeature=function(e,t,n){return this._parent._getFeature(e,t,n)},t.prototype._getFeatures=function(e,t,n,i){return this._parent._getFeatures(e,t,n,i)},t.prototype._featureFromCache=function(e){return this._parent._featureFromCache(e)},t.prototype.executeWhereClause=function(e){var t,n;return null!==(n=null===(t=this._whereclause)||void 0===t?void 0:t.testFeature(e))&&void 0!==n&&n},t.prototype.executeWhereClauseDeferred=function(e){return n(this,void 0,void 0,(function(){var t;return i(this,(function(n){return null!==this._whereClauseFunction?(t=this._whereClauseFunction(e),h.isPromiseLike(t),[2,t]):[2,this.executeWhereClause(e)]}))}))},t.prototype._fetchAndRefineFeatures=function(e,t,r){var s,a,o;return n(this,void 0,void 0,(function(){var n,h,c,_,p,d,f;return i(this,(function(i){switch(i.label){case 0:return n=new u([],e,!1,null),h=Math.min(t,e.length),[4,null===(s=this._parent)||void 0===s?void 0:s._getFeatures(n,-1,h,r)];case 1:if(i.sent(),this._checkCancelled(r),null==this._whereClauseFunction){for(f=0;f<h;f++)_=null===(a=this._parent)||void 0===a?void 0:a._featureFromCache(e[f]),!0===this.executeWhereClause(_)?this._idstates[e[f]]=l.IdState.InFeatureSet:this._idstates[e[f]]=l.IdState.NotInFeatureSet;return[2,"success"]}c=[],f=0,i.label=2;case 2:return f<h?(_=null===(o=this._parent)||void 0===o?void 0:o._featureFromCache(e[f]),d=(p=c).push,[4,this.executeWhereClauseDeferred(_)]):[3,5];case 3:d.apply(p,[i.sent()]),i.label=4;case 4:return f++,[3,2];case 5:for(f=0;f<t;f++)!0===c[f]?this._idstates[e[f]]=l.IdState.InFeatureSet:this._idstates[e[f]]=l.IdState.NotInFeatureSet;return[2,"success"]}}))}))},t.prototype._getFilteredSet=function(e,t,r,s,a){return n(this,void 0,void 0,(function(){var n;return i(this,(function(i){switch(i.label){case 0:return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=o.combine(this._whereclause,r)):r=this._whereclause),[4,this._ensureLoaded()];case 1:return i.sent(),[4,this._parent._getFilteredSet(e,t,r,s,a)];case 2:return n=i.sent(),this._checkCancelled(a),[2,null!==this._whereClauseFunction?new u(n._candidates.slice(0).concat(n._known.slice(0)),[],n._ordered,this._clonePageDefinition(n.pagesDefinition)):new u(n._candidates.slice(0),n._known.slice(0),n._ordered,this._clonePageDefinition(n.pagesDefinition))]}}))}))},t.prototype._stat=function(e,t,r,s,a,u,l){return n(this,void 0,void 0,(function(){var n,h;return i(this,(function(i){switch(i.label){case 0:return null!==this._whereClauseFunction?null===a&&""===r&&null===s?[2,this._manualStat(e,t,u,l)]:[2,{calculated:!1}]:(n=this._whereclause,null!==a&&null!==this._whereclause&&(n=o.combine(this._whereclause,a)),[4,this._parent._stat(e,t,r,s,n,u,l)]);case 1:return!1===(h=i.sent()).calculated?null===a&&""===r&&null===s?[2,this._manualStat(e,t,u,l)]:[2,{calculated:!1}]:[2,h]}}))}))},t.prototype._canDoAggregates=function(e,t,r,s,a){return n(this,void 0,void 0,(function(){return i(this,(function(n){return null!==this._whereClauseFunction?[2,!1]:(null!==a?null!==this._whereclause&&(a=o.combine(this._whereclause,a)):a=this._whereclause,null===this._parent?[2,!1]:[2,this._parent._canDoAggregates(e,t,r,s,a)])}))}))},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,a,u,l,h){return n(this,void 0,void 0,(function(){return i(this,(function(n){if(null===this._parent)throw new s.FeatureSetError(s.FeatureSetErrorCodes.NeverReach);return null!==u?null!==this._whereclause&&(u=o.combine(this._whereclause,u)):u=this._whereclause,[2,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,u,l,h)]}))}))},t.registerAction=function(){a._featuresetFunctions.filter=function(e){if("function"==typeof e)return new t({parentfeatureset:this,whereclause:e});var n=null;return e instanceof c.WhereClause&&(n=e),new t({parentfeatureset:this,whereclause:n})}},t}(a)}));