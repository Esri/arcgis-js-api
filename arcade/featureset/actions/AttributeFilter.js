// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/extends","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../polyfill/promiseUtils","../../polyfill/sql/WhereClause","../../../SpatialReference"],(function(e,t,n,i,s,r,a,u,l,o,h,c){"use strict";return function(e){function t(t){var n=e.call(this,t)||this;return n.declaredClass="esri.arcade.featureset.actions.AttributeFilter",n._maxProcessing=1e3,n._parent=t.parentfeatureset,t.whereclause instanceof h.WhereClause?(n._whereclause=t.whereclause,n._whereClauseFunction=null):(n._whereClauseFunction=t.whereclause,n._whereclause=null),n}return s(t,e),t.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new c({wkid:4326}),this.geometryType=u.layerGeometryEsriConstants.point)},t.prototype._getSet=function(e){return n(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return null!==this._wset?[3,3]:[4,this._ensureLoaded()];case 1:return n.sent(),[4,this._parent._getFilteredSet("",null,this._whereclause,null,e)];case 2:return t=n.sent(),this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new a(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new a(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),[2,this._wset];case 3:return[2,this._wset]}}))}))},t.prototype._isInFeatureSet=function(e){var t=this._parent._isInFeatureSet(e);return t===u.IdState.NotInFeatureSet?t:void 0===(t=this._idstates[e])?u.IdState.Unknown:t},t.prototype._getFeature=function(e,t,n){return this._parent._getFeature(e,t,n)},t.prototype._getFeatures=function(e,t,n,i){return this._parent._getFeatures(e,t,n,i)},t.prototype._featureFromCache=function(e){return this._parent._featureFromCache(e)},t.prototype.executeWhereClause=function(e){return this._whereclause.testFeature(e)},t.prototype.executeWhereClauseDeferred=function(e){return n(this,void 0,void 0,(function(){var t;return i(this,(function(n){return null!==this._whereClauseFunction?(t=this._whereClauseFunction(e),o.isPromiseLike(t),[2,t]):[2,this.executeWhereClause(e)]}))}))},t.prototype._fetchAndRefineFeatures=function(e,t,s){return n(this,void 0,void 0,(function(){var n,r,l,o,h,c,_;return i(this,(function(i){switch(i.label){case 0:return n=new a([],e,!1,null),r=Math.min(t,e.length),[4,this._parent._getFeatures(n,-1,r,s)];case 1:if(i.sent(),this._checkCancelled(s),null==this._whereClauseFunction){for(_=0;_<r;_++)o=this._parent._featureFromCache(e[_]),!0===this.executeWhereClause(o)?this._idstates[e[_]]=u.IdState.InFeatureSet:this._idstates[e[_]]=u.IdState.NotInFeatureSet;return[2,"success"]}l=[],_=0,i.label=2;case 2:return _<r?(o=this._parent._featureFromCache(e[_]),c=(h=l).push,[4,this.executeWhereClauseDeferred(o)]):[3,5];case 3:c.apply(h,[i.sent()]),i.label=4;case 4:return _++,[3,2];case 5:for(_=0;_<t;_++)!0===l[_]?this._idstates[e[_]]=u.IdState.InFeatureSet:this._idstates[e[_]]=u.IdState.NotInFeatureSet;return[2,"success"]}}))}))},t.prototype._getFilteredSet=function(e,t,s,r,u){return n(this,void 0,void 0,(function(){var n;return i(this,(function(i){switch(i.label){case 0:return null!==this._whereClauseFunction||(null!==s?null!==this._whereclause&&(s=l.combine(this._whereclause,s)):s=this._whereclause),[4,this._ensureLoaded()];case 1:return i.sent(),[4,this._parent._getFilteredSet(e,t,s,r,u)];case 2:return n=i.sent(),this._checkCancelled(u),[2,null!==this._whereClauseFunction?new a(n._candidates.slice(0).concat(n._known.slice(0)),[],n._ordered,this._clonePageDefinition(n.pagesDefinition)):new a(n._candidates.slice(0),n._known.slice(0),n._ordered,this._clonePageDefinition(n.pagesDefinition))]}}))}))},t.prototype._stat=function(e,t,s,r,a,u,o){return n(this,void 0,void 0,(function(){var n,h;return i(this,(function(i){switch(i.label){case 0:return null!==this._whereClauseFunction?null===a&&""===s&&null===r?[2,this._manualStat(e,t,u,o)]:[2,{calculated:!1}]:(n=this._whereclause,null!==a&&null!==this._whereclause&&(n=l.combine(this._whereclause,a)),[4,this._parent._stat(e,t,s,r,n,u,o)]);case 1:return!1===(h=i.sent()).calculated?null===a&&""===s&&null===r?[2,this._manualStat(e,t,u,o)]:[2,{calculated:!1}]:[2,h]}}))}))},t.prototype._canDoAggregates=function(e,t,s,r,a){return n(this,void 0,void 0,(function(){return i(this,(function(n){return null!==this._whereClauseFunction?[2,!1]:(null!==a?null!==this._whereclause&&(a=l.combine(this._whereclause,a)):a=this._whereclause,null===this._parent?[2,!1]:[2,this._parent._canDoAggregates(e,t,s,r,a)])}))}))},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,s,r,a,u,o){return n(this,void 0,void 0,(function(){return i(this,(function(n){if(null===this._parent)throw new Error("Should never be called");return null!==a?null!==this._whereclause&&(a=l.combine(this._whereclause,a)):a=this._whereclause,[2,this._parent._getAggregatePagesDataSourceDefinition(e,t,s,r,a,u,o)]}))}))},t.registerAction=function(){r._featuresetFunctions.filter=function(e){if("function"==typeof e)return new t({parentfeatureset:this,whereclause:e});var n=null;return e instanceof h.WhereClause&&(n=e),new t({parentfeatureset:this,whereclause:n})}},t}(r)}));