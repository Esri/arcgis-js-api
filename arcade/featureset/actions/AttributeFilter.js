/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/SpatialReference"],(function(e,t,n,s,i,r,a,l){"use strict";return function(u){function h(e){var t;return(t=u.call(this,e)||this).declaredClass="esri.arcade.featureset.actions.AttributeFilter",t._maxProcessing=1e3,t._parent=e.parentfeatureset,e.whereclause instanceof a.WhereClause?(t._whereclause=e.whereclause,t._whereClauseFunction=null):(t._whereClauseFunction=e.whereclause,t._whereclause=null),t}e._inheritsLoose(h,u);var c=h.prototype;return c._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new l({wkid:4326}),this.geometryType=s.layerGeometryEsriConstants.point)},c._getSet=function(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("",null,this._whereclause,null,e))).then((t=>(this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new n(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new n(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):r.resolve(this._wset)},c._isInFeatureSet=function(e){let t=this._parent._isInFeatureSet(e);return t===s.IdState.NotInFeatureSet?t:(t=this._idstates[e],void 0===t?s.IdState.Unknown:t)},c._getFeature=function(e,t,n){return this._parent._getFeature(e,t,n)},c._getFeatures=function(e,t,n,s){return this._parent._getFeatures(e,t,n,s)},c._featureFromCache=function(e){return this._parent._featureFromCache(e)},c.executeWhereClause=function(e){return this._whereclause.testFeature(e)},c.executeWhereClauseDeferred=function(e){if(null!==this._whereClauseFunction)try{const t=this._whereClauseFunction(e);return r.isPromiseLike(t)?t:r.resolve(t)}catch(t){return r.reject(t)}return r.resolve(this.executeWhereClause(e))},c._fetchAndRefineFeatures=function(e,t,i){const a=new n([],e,!1,null),l=Math.min(t,e.length);return this._parent._getFeatures(a,-1,l,i).then((()=>{if(this._checkCancelled(i),null==this._whereClauseFunction){for(let t=0;t<l;t++){const n=this._parent._featureFromCache(e[t]);!0===this.executeWhereClause(n)?this._idstates[e[t]]=s.IdState.InFeatureSet:this._idstates[e[t]]=s.IdState.NotInFeatureSet}return"success"}const n=[];for(let t=0;t<l;t++){const s=this._parent._featureFromCache(e[t]);n.push(this.executeWhereClauseDeferred(s))}return r.all(n).then((n=>{for(let i=0;i<t;i++)!0===n[i]?this._idstates[e[i]]=s.IdState.InFeatureSet:this._idstates[e[i]]=s.IdState.NotInFeatureSet;return"success"}))}))},c._getFilteredSet=function(e,t,s,r,a){return null!==this._whereClauseFunction||(null!==s?null!==this._whereclause&&(s=i.combine(this._whereclause,s)):s=this._whereclause),this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,t,s,r,a))).then((e=>{let t;return this._checkCancelled(a),t=null!==this._whereClauseFunction?new n(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new n(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),t}))},c._stat=function(e,t,n,s,a,l,u){if(null!==this._whereClauseFunction)return null===a&&""===n&&null===s?this._manualStat(e,t,l,u):r.resolve({calculated:!1});let h=this._whereclause;return null!==a&&null!==this._whereclause&&(h=i.combine(this._whereclause,a)),this._parent._stat(e,t,n,s,h,l,u).then((i=>!1===i.calculated?null===a&&""===n&&null===s?this._manualStat(e,t,l,u):{calculated:!1}:i))},c._canDoAggregates=function(e,t,n,s,a){return null!==this._whereClauseFunction?r.resolve(!1):(null!==a?null!==this._whereclause&&(a=i.combine(this._whereclause,a)):a=this._whereclause,null===this._parent?r.resolve(!1):this._parent._canDoAggregates(e,t,n,s,a))},c._getAggregatePagesDataSourceDefinition=function(e,t,n,s,a,l,u){return null===this._parent?r.reject(new Error("Should never be called")):(null!==a?null!==this._whereclause&&(a=i.combine(this._whereclause,a)):a=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,n,s,a,l,u))},h.registerAction=function(){t._featuresetFunctions.filter=function(e){if("function"==typeof e)return new h({parentfeatureset:this,whereclause:e});let t=null;return e instanceof a.WhereClause&&(t=e),new h({parentfeatureset:this,whereclause:t})}},h}(t)}));
