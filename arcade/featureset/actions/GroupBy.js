// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../Graphic","../../languageUtils","./Adapted","./AttributeFilter","./OrderBy","../support/FeatureSet","../support/IdSet","../support/OrderbyClause","../support/sha","../support/shared","../support/sqlUtils","../support/sqlUtils","../support/stats","../support/StatsField","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/SpatialReference","../../../layers/support/Field","../../../layers/support/FieldsIndex"],function(e,t,r,i,n,a,s,l,o,d,u,f,p,c,g,h,_,y,m,v,b,F){function w(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var S=function(e){function t(t){var r=e.call(this,t)||this;return r._decodedStatsfield=[],r._decodedGroupbyfield=[],r._candosimplegroupby=!0,r.phsyicalgroupbyfields=[],r.objectIdField="ROW__ID",r._internalObjectIdField="ROW__ID",r._adaptedFields=[],r.declaredClass="esri.arcade.featureset.actions.Aggregate",r._uniqueIds=1,r._maxQuery=10,r._maxProcessing=10,r._parent=t.parentfeatureset,r._config=t,r}return r(t,e),t.prototype.isTable=function(){return!0},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then(function(e){return t._wset=e,t._wset}):y.resolve(this._wset)},t.prototype._isInFeatureSet=function(e){return p.IdState.InFeatureSet},t.prototype.nextUniqueName=function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t},t.prototype.convertToEsriFieldType=function(e){return e},t.prototype._initialiseFeatureSet=function(){var e={},t=!1,r=1,i=this._parent?this._parent.getFieldsIndex():new F([]);for(this.objectIdField="ROW__ID";!1===t;){for(var n=!1,s=0;s<this._config.groupbyfields.length;s++)if(this._config.groupbyfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}if(!1===n)for(var s=0;s<this._config.statsfields.length;s++)if(this._config.statsfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}!1===n?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}for(var l=0,o=this._config.statsfields;l<o.length;l++){var d=o[l],u=new _;u.field=d.name,u.tofieldname=d.name,u.workingexpr=d.expression instanceof m.WhereClause?d.expression:m.WhereClause.create(d.expression,i),u.typeofstat=w(d.statistic),this._decodedStatsfield.push(u)}this._decodedGroupbyfield=[];for(var f=0,h=this._config.groupbyfields;f<h.length;f++){var d=h[f],y={name:d.name,singlefield:null,tofieldname:d.name,expression:d.expression instanceof m.WhereClause?d.expression:m.WhereClause.create(d.expression,i)};this._decodedGroupbyfield.push(y)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(var S=0,I=this._parent.fields;S<I.length;S++){var d=I[S];e[d.name.toUpperCase()]=1}this.types=null}else this.geometryType=p.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new v({wkid:4326});this.fields=[];var x=new _;x.field=this.nextUniqueName(e),x.tofieldname=this.objectIdField,x.workingexpr=m.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),x.typeofstat="MIN",this._decodedStatsfield.push(x);for(var D=0,k=this._decodedGroupbyfield;D<k.length;D++){var C=k[D],A=new b;if(C.name=this.nextUniqueName(e),A.name=C.tofieldname,A.alias=A.name,c.isSingleField(C.expression)){var T=this._parent.getField(g.toWhereClause(C.expression,p.FeatureServiceDatabaseType.Standardised));if(!T)throw new Error("Field is not present for Aggregation");C.name=T.name,C.singlefield=T.name,this.phsyicalgroupbyfields.push(T.name),A.type=T.type}else{A.type=this.convertToEsriFieldType(g.predictType(C.expression,this._parent.fields));var G=new b;G.name=C.name,G.alias=G.name,this.phsyicalgroupbyfields.push(C.name),this._adaptedFields.push(new a.SqlExpressionAdapted(G,C.expression)),this._candosimplegroupby=!1}this.fields.push(A)}if(this._adaptedFields.length>0)for(var W=0,O=this._parent.fields;W<O.length;W++){var d=O[W];this._adaptedFields.push(new a.OriginalField(d))}for(var s=0;s<this._decodedStatsfield.length;s++){var A=new b,T=null,C=this._decodedStatsfield[s];C.field=this.nextUniqueName(e),C.tofieldname===this.objectIdField&&(this._internalObjectIdField=C.field),A.name=C.tofieldname,A.alias=A.name;var j=null!==C.workingexpr&&c.isSingleField(C.workingexpr)?g.toWhereClause(C.workingexpr,p.FeatureServiceDatabaseType.Standardised):"";switch(this._decodedStatsfield[s].typeofstat){case"SUM":if(""!==j){if(!(T=this._parent.getField(j)))throw new Error("Field is not present for Aggregation");A.type=T.type}else A.type="double";break;case"MIN":case"MAX":if(""!==j){if(!(T=this._parent.getField(j)))throw new Error("Field is not present for Aggregation");A.type=T.type}else A.type="double";break;case"COUNT":A.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==j&&!(T=this._parent.getField(j)))throw new Error("Field is not present for Aggregation");A.type="double"}this.fields.push(A)}},t.prototype._canDoAggregates=function(e,t,r,i,n){return y.resolve(!1)},t.prototype._getFeatures=function(e,t,r,i){var n=this,a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);var s=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,s,i)?this._expandPagedSet(e,s,0,0,i).then(function(a){return n._getFeatures(e,t,r,i)}):y.resolve("success")},t.prototype._getFilteredSet=function(e,t,r,i,n){var o=this;if(""!==e)return y.resolve(new d([],[],!0,null));var f=null,p={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then(function(){if(null!==r)for(var e=0;e<o._decodedStatsfield.length;e++)if(!0===c.scanForField(r,o._decodedStatsfield[e].tofieldname)){p.nowhereclause=!0,r=null;break}if(null!==i){p.ordered=!0;for(var e=0;e<o._decodedStatsfield.length;e++)if(!0===i.scanForField(o._decodedStatsfield[e].tofieldname)){i=null,p.ordered=!1;break}if(null!==i)for(var t=0,n=o._decodedGroupbyfield;t<n.length;t++){var a=n[t];if(null===a.singlefield&&!0===i.scanForField(a.tofieldname)){i=null,p.ordered=!1;break}}}return!1===o._candosimplegroupby?y.resolve(!1):o._parent._canDoAggregates(o.phsyicalgroupbyfields,o._decodedStatsfield,"",null,null)}).then(function(e){if(e){var t=null;r&&(t=o._reformulateWhereClauseWithoutGroupByFields(r));var c=null;return i&&(c=o._reformulateOrderClauseWithoutGroupByFields(i)),o._parent._getAggregatePagesDataSourceDefinition(o.phsyicalgroupbyfields,o._decodedStatsfield,"",null,t,c,o._internalObjectIdField).then(function(e){return o._checkCancelled(n),f=!0===p.nowhereclause?new d(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===p.ordered&&e._ordered,o._clonePageDefinition(e.pagesDefinition)):new d(e._candidates.slice(0),e._known.slice(0),!0===p.ordered&&e._ordered,o._clonePageDefinition(e.pagesDefinition))})}var g=o._parent;if(o._adaptedFields.length>0&&(g=new a.AdaptedFeatureSet({parentfeatureset:o._parent,adaptedFields:o._adaptedFields,extraFilter:null})),!0===p.nowhereclause)f=new d(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:o._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new l({parentfeatureset:g,orderbyclause:new u(o.phsyicalgroupbyfields.join(",")+","+o._parent.objectIdField+" ASC")})}});else{var h=g;if(null!==r){var _=null;r&&(_=o._reformulateWhereClauseWithoutGroupByFields(r)),h=new s({parentfeatureset:h,whereclause:_})}f=new d(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:o._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new l({parentfeatureset:h,orderbyclause:new u(o.phsyicalgroupbyfields.join(",")+","+o._parent.objectIdField+" ASC")})}})}return f})},t.prototype._reformulateWhereClauseWithoutStatsFields=function(e){for(var t=0,r=this._decodedStatsfield;t<r.length;t++){var i=r[t];e=g.reformulateWithoutField(e,i.tofieldname,g.toWhereClause(i.workingexpr,p.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex())}return e},t.prototype._reformulateWhereClauseWithoutGroupByFields=function(e){for(var t=0,r=this._decodedGroupbyfield;t<r.length;t++){var i=r[t];i.tofieldname!==i.name&&(e=g.reformulateWithoutField(e,i.tofieldname,g.toWhereClause(i.expression,p.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()))}return e},t.prototype._reformulateOrderClauseWithoutGroupByFields=function(e){for(var t=[],r=0,i=this._decodedGroupbyfield;r<i.length;r++){var n=i[r];n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name})}return t.length>0?e.replaceFields(t):e},t.prototype._clonePageDefinition=function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)},t.prototype._refineSetBlock=function(e,t,r){var i=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery,r))return this._expandPagedSet(e,this._maxQuery,0,0,r).then(function(n){return i._refineSetBlock(e,t,r)});this._checkCancelled(r);var n=e._candidates.length;this._refineKnowns(e,t);e._candidates.length;return e._candidates.length,y.resolve(e)}catch(e){return y.reject(e)}},t.prototype._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},t.prototype._getPhysicalPage=function(e,t,r){var n=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?y.create(function(t,i){n._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then(function(e){t(e)},i)}):this._getAgregagtePhysicalPage(e,t,r).then(function(e){for(var t=0,r=e;t<r.length;t++){for(var a=r[t],s={geometry:a.geometry,attributes:{}},l=0,o=n._decodedGroupbyfield;l<o.length;l++){var d=o[l];s.attributes[d.tofieldname]=a.attributes[d.name]}for(var u=0,f=n._decodedStatsfield;u<f.length;u++){var d=f[u];s.attributes[d.tofieldname]=a.attributes[d.field]}n._featureCache[s.attributes[n.objectIdField]]=new i(s)}return e.length})},t.prototype._sequentialGetPhysicalItem=function(e,t,r,i){var n=this;return y.create(function(a,s){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved?a(i.length):0===t?a(i.length):n._nextAggregateItem(e,t,r,i,function(s){null===s?a(i.length):(t-=1,a(n._sequentialGetPhysicalItem(e,t,r,i)))},s)})},t.prototype._nextAggregateItem=function(e,t,r,i,a,s){var l=this;try{n.tick(e.pagesDefinition.internal.iterator.next()).then(function(n){if(null===n)if(null!==e.pagesDefinition.internal.workingItem){var o=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);i.push(o),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(o.attributes[l.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{var d=l._generateAggregateHash(n);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[n],id:d};else{if(d!==e.pagesDefinition.internal.workingItem.id){var o=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return i.push(o),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(o.attributes[l.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[n],id:d},void a(o)}e.pagesDefinition.internal.workingItem.features.push(n)}l._nextAggregateItem(e,t,r,i,a,s)}},s)}catch(e){s(e)}},t.prototype._calculateFieldStat=function(e,t,r){for(var i=[],n=0;n<e.features.length;n++)if(null!==t.workingexpr){var a=t.workingexpr.calculateValue(e.features[n]);null!==a&&i.push(a)}else i.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=h.calculateStat("min",i,-1);break;case"MAX":r.attributes[t.tofieldname]=h.calculateStat("max",i,-1);break;case"SUM":r.attributes[t.tofieldname]=h.calculateStat("sum",i,-1);break;case"COUNT":r.attributes[t.tofieldname]=i.length;break;case"VAR":r.attributes[t.tofieldname]=h.calculateStat("var",i,-1);break;case"STDDEV":r.attributes[t.tofieldname]=h.calculateStat("stddev",i,-1);break;case"AVG":r.attributes[t.tofieldname]=h.calculateStat("avg",i,-1)}return!0},t.prototype._calculateAndAppendAggregateItem=function(e){for(var t={attributes:{},geometry:null},r=0,n=this._decodedGroupbyfield;r<n.length;r++){var a=n[r],s=a.singlefield?e.features[0].attributes[a.singlefield]:a.expression.calculateValue(e.features[0]);t.attributes[a.tofieldname]=s}for(var l=0,o=this._decodedStatsfield;l<o.length;l++){var d=o[l];this._calculateFieldStat(e,d,t)}for(var u=[],f=0;f<this._decodedStatsfield.length;f++)u.push(this._calculateFieldStat(e,this._decodedStatsfield[f],t));return this._featureCache[t.attributes[this.objectIdField]]=new i({attributes:t.attributes,geometry:t.geometry}),t},t.prototype._generateAggregateHash=function(e){for(var t="",r=0,i=this._decodedGroupbyfield;r<i.length;r++){var n=i[r],a=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null===a||void 0===a?":":":"+a.toString()}return new f(t,"TEXT").getHash("SHA-1","B64")},t.prototype._stat=function(e,t,r,i,n,a,s){return y.resolve({calculated:!1})},t.prototype.getFeatureByObjectId=function(e,t){return y.resolve(null)},t}(o);return o._featuresetFunctions.groupby=function(e,t){return new S({parentfeatureset:this,groupbyfields:e,statsfields:t})},S});