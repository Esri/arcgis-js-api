// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../../polyfill/tsSupport/awaiter","../../polyfill/tsSupport/generator","../../polyfill/tsSupport/assign","../../polyfill/tsSupport/spreadarray","../../polyfill/tsSupport/extends","../../../graphic","../../languageUtils","./Adapted","./AttributeFilter","./OrderBy","../support/FeatureSet","../support/IdSet","../support/OrderbyClause","../support/shared","../support/sqlUtils","../support/stats","../support/StatsField","dojox/encoding/digests/_base","dojox/encoding/digests/MD5","../../polyfill/sql/WhereClause","../../../SpatialReference","../../../layers/Field","../../polyfill/sql/FieldsIndex","../support/errorsupport"],(function(e,t,i,r,n,a,s,l,o,d,u,f,p,c,h,g,_,y,m,b,F,S,w,v,I,x){"use strict";function C(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}return function(e){function t(t){var i=e.call(this,t)||this;return i._decodedStatsfield=[],i._decodedGroupbyfield=[],i._candosimplegroupby=!0,i.phsyicalgroupbyfields=[],i.objectIdField="ROW__ID",i._internalObjectIdField="ROW__ID",i._adaptedFields=[],i.declaredClass="esri.arcade.featureset.actions.Aggregate",i._uniqueIds=1,i._maxQuery=10,i._maxProcessing=10,i._parent=t.parentfeatureset,i._config=t,i}return s(t,e),t.prototype.isTable=function(){return!0},t.prototype._getSet=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(i){switch(i.label){case 0:return null!==this._wset?[3,2]:[4,this._getFilteredSet("",null,null,null,e)];case 1:return t=i.sent(),this._wset=t,[2,this._wset];case 2:return[2,this._wset]}}))}))},t.prototype._isInFeatureSet=function(){return g.IdState.InFeatureSet},t.prototype._nextUniqueName=function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t},t.prototype._convertToEsriFieldType=function(e){return e},t.prototype._initialiseFeatureSet=function(){var e={},t=!1,i=1,r=this._parent?this._parent.getFieldsIndex():new I([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var n=!1,a=0;a<this._config.groupbyfields.length;a++)if(this._config.groupbyfields[a].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}if(!1===n)for(a=0;a<this._config.statsfields.length;a++)if(this._config.statsfields[a].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}!1===n?t=!0:(this.objectIdField="ROW__ID"+i.toString(),i++)}for(var s=0,l=this._config.statsfields;s<l.length;s++){var o=l[s],u=new m;u.field=o.name,u.tofieldname=o.name,u.workingexpr=o.expression instanceof S.WhereClause?o.expression:S.WhereClause.create(o.expression,r),u.typeofstat=C(o.statistic),this._decodedStatsfield.push(u)}this._decodedGroupbyfield=[];for(var f=0,p=this._config.groupbyfields;f<p.length;f++){var c={name:(o=p[f]).name,singlefield:null,tofieldname:o.name,expression:o.expression instanceof S.WhereClause?o.expression:S.WhereClause.create(o.expression,r)};this._decodedGroupbyfield.push(c)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(var h=0,y=this._parent.fields;h<y.length;h++){e[(o=y[h]).name.toUpperCase()]=1}this.types=null}else this.geometryType=g.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new w({wkid:4326});this.fields=[];var b=new m;b.field=this._nextUniqueName(e),b.tofieldname=this.objectIdField,b.workingexpr=S.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),b.typeofstat="MIN",this._decodedStatsfield.push(b);for(var F=0,D=this._decodedGroupbyfield;F<D.length;F++){var k=D[F],A=new v;if(k.name=this._nextUniqueName(e),A.name=k.tofieldname,A.alias=A.name,_.isSingleField(k.expression)){if(!(j=this._parent.getField(_.toWhereClause(k.expression,g.FeatureServiceDatabaseType.Standardised))))throw new x.FeatureSetError(x.FeatureSetErrorCodes.AggregationFieldNotFound);k.name=j.name,k.singlefield=j.name,this.phsyicalgroupbyfields.push(j.name),A.type=j.type}else{A.type=this._convertToEsriFieldType(_.predictType(k.expression,this._parent.fields));var T=new v;T.name=k.name,T.alias=T.name,this.phsyicalgroupbyfields.push(k.name),this._adaptedFields.push(new d.SqlExpressionAdapted(T,k.expression)),this._candosimplegroupby=!1}this.fields.push(A)}if(this._adaptedFields.length>0)for(var G=0,W=this._parent.fields;G<W.length;G++){o=W[G];this._adaptedFields.push(new d.OriginalField(o))}for(a=0;a<this._decodedStatsfield.length;a++){A=new v;var j=null;(k=this._decodedStatsfield[a]).field=this._nextUniqueName(e),k.tofieldname===this.objectIdField&&(this._internalObjectIdField=k.field),A.name=k.tofieldname,A.alias=A.name;var O=null!==k.workingexpr&&_.isSingleField(k.workingexpr)?_.toWhereClause(k.workingexpr,g.FeatureServiceDatabaseType.Standardised):"";switch(this._decodedStatsfield[a].typeofstat){case"SUM":if(""!==O){if(!(j=this._parent.getField(O)))throw new x.FeatureSetError(x.FeatureSetErrorCodes.AggregationFieldNotFound);A.type=j.type}else A.type="double";break;case"MIN":case"MAX":if(""!==O){if(!(j=this._parent.getField(O)))throw new x.FeatureSetError(x.FeatureSetErrorCodes.AggregationFieldNotFound);A.type=j.type}else A.type="double";break;case"COUNT":A.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==O&&!(j=this._parent.getField(O)))throw new x.FeatureSetError(x.FeatureSetErrorCodes.AggregationFieldNotFound);A.type="double"}this.fields.push(A)}},t.prototype._canDoAggregates=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){return[2,!1]}))}))},t.prototype._getFeatures=function(e,t,n,a){return i(this,void 0,void 0,(function(){var i,s;return r(this,(function(r){switch(r.label){case 0:return i=[],-1!==t&&void 0===this._featureCache[t]&&i.push(t),s=this._maxQuery,!0!==this._checkIfNeedToExpandKnownPage(e,s)?[3,2]:[4,this._expandPagedSet(e,s,0,0,a)];case 1:return r.sent(),[2,this._getFeatures(e,t,n,a)];case 2:return[2,"success"]}}))}))},t.prototype._getFilteredSet=function(e,t,n,a,s){return i(this,void 0,void 0,(function(){var t,i,l,o,p,g,y,m,b,F,S,w,v;return r(this,(function(r){switch(r.label){case 0:return""!==e?[2,new c([],[],!0,null)]:(t=null,i={ordered:!1,nowhereclause:!1},[4,this._ensureLoaded()]);case 1:if(r.sent(),null!==n)for(l=0;l<this._decodedStatsfield.length;l++)if(!0===_.scanForField(n,this._decodedStatsfield[l].tofieldname)){i.nowhereclause=!0,n=null;break}if(null!==a){for(i.ordered=!0,l=0;l<this._decodedStatsfield.length;l++)if(!0===a.scanForField(this._decodedStatsfield[l].tofieldname)){a=null,i.ordered=!1;break}if(null!==a)for(o=0,p=this._decodedGroupbyfield;o<p.length;o++)if(null===(g=p[o]).singlefield&&!0===a.scanForField(g.tofieldname)){a=null,i.ordered=!1;break}}return!1!==this._candosimplegroupby?[3,2]:(y=!1,[3,4]);case 2:return[4,this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)];case 3:y=r.sent(),r.label=4;case 4:return y?(m=null,n&&(m=this._reformulateWhereClauseWithoutGroupByFields(n)),b=null,a&&(b=this._reformulateOrderClauseWithoutGroupByFields(a)),[4,this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,m,b,this._internalObjectIdField)]):[3,6];case 5:return F=r.sent(),this._checkCancelled(s),[2,t=!0===i.nowhereclause?new c(F._candidates.slice(0).concat(F._known.slice(0)),[],!0===i.ordered&&F._ordered,this._clonePageDefinition(F.pagesDefinition)):new c(F._candidates.slice(0),F._known.slice(0),!0===i.ordered&&F._ordered,this._clonePageDefinition(F.pagesDefinition))];case 6:return S=this._parent,this._adaptedFields.length>0&&(S=new d.AdaptedFeatureSet({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===i.nowhereclause?t=new c(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new f({parentfeatureset:S,orderbyclause:new h(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}):(w=S,null!==n&&(v=null,n&&(v=this._reformulateWhereClauseWithoutGroupByFields(n)),w=new u({parentfeatureset:w,whereclause:v})),t=new c(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new f({parentfeatureset:w,orderbyclause:new h(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})),[2,t]}}))}))},t.prototype._reformulateWhereClauseWithoutStatsFields=function(e){for(var t=0,i=this._decodedStatsfield;t<i.length;t++){var r=i[t];e=_.reformulateWithoutField(e,r.tofieldname,_.toWhereClause(r.workingexpr,g.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex())}return e},t.prototype._reformulateWhereClauseWithoutGroupByFields=function(e){for(var t=0,i=this._decodedGroupbyfield;t<i.length;t++){var r=i[t];r.tofieldname!==r.name&&(e=_.reformulateWithoutField(e,r.tofieldname,_.toWhereClause(r.expression,g.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()))}return e},t.prototype._reformulateOrderClauseWithoutGroupByFields=function(e){for(var t=[],i=0,r=this._decodedGroupbyfield;i<r.length;i++){var n=r[i];n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name})}return t.length>0?e.replaceFields(t):e},t.prototype._clonePageDefinition=function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)},t.prototype._refineSetBlock=function(e,t,n){return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return!0!==this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?[3,2]:[4,this._expandPagedSet(e,this._maxQuery,0,0,n)];case 1:return r.sent(),[2,this._refineSetBlock(e,t,n)];case 2:return this._checkCancelled(n),i=e._candidates.length,this._refineKnowns(e,t),i-e._candidates.length,e._candidates.length,[2,e]}}))}))},t.prototype._expandPagedSet=function(e,t,i,r,n){return this._expandPagedSetFeatureSet(e,t,i,r,n)},t.prototype._getPhysicalPage=function(e,t,n){return i(this,void 0,void 0,(function(){var i,a,s,o,d,u,f,p,c,h;return r(this,(function(r){switch(r.label){case 0:return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?[2,this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[])]:[4,this._getAgregagtePhysicalPage(e,t,n)];case 1:for(i=r.sent(),a=0,s=i;a<s.length;a++){for(o=s[a],d={geometry:o.geometry,attributes:{}},u=0,f=this._decodedGroupbyfield;u<f.length;u++)h=f[u],d.attributes[h.tofieldname]=o.attributes[h.name];for(p=0,c=this._decodedStatsfield;p<c.length;p++)h=c[p],d.attributes[h.tofieldname]=o.attributes[h.field];this._featureCache[d.attributes[this.objectIdField]]=new l(d)}return[2,i.length]}}))}))},t.prototype._sequentialGetPhysicalItem=function(e,t,i,r){var n=this;return new Promise((function(a,s){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(i)),!0===e.pagesDefinition.internal.fullyResolved?a(r.length):0===t?a(r.length):n._nextAggregateItem(e,t,i,r,(function(s){null===s?a(r.length):(t-=1,a(n._sequentialGetPhysicalItem(e,t,i,r)))}),s)}))},t.prototype._nextAggregateItem=function(e,t,i,r,n,a){var s=this;try{o.tick(e.pagesDefinition.internal.iterator.next()).then((function(l){if(null===l)if(null!==e.pagesDefinition.internal.workingItem){var o=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(o),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(o.attributes[s.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,n(null)}else e.pagesDefinition.internal.fullyResolved=!0,n(null);else{var d=s._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:d};else{if(d!==e.pagesDefinition.internal.workingItem.id){o=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(o),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(o.attributes[s.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:d},void n(o)}e.pagesDefinition.internal.workingItem.features.push(l)}s._nextAggregateItem(e,t,i,r,n,a)}}),a)}catch(e){a(e)}},t.prototype._calculateFieldStat=function(e,t,i){for(var r=[],n=0;n<e.features.length;n++)if(null!==t.workingexpr){var a=t.workingexpr.calculateValue(e.features[n]);null!==a&&r.push(a)}else r.push(null);switch(t.typeofstat){case"MIN":i.attributes[t.tofieldname]=y.calculateStat("min",r,-1);break;case"MAX":i.attributes[t.tofieldname]=y.calculateStat("max",r,-1);break;case"SUM":i.attributes[t.tofieldname]=y.calculateStat("sum",r,-1);break;case"COUNT":i.attributes[t.tofieldname]=r.length;break;case"VAR":i.attributes[t.tofieldname]=y.calculateStat("var",r,-1);break;case"STDDEV":i.attributes[t.tofieldname]=y.calculateStat("stddev",r,-1);break;case"AVG":i.attributes[t.tofieldname]=y.calculateStat("avg",r,-1)}return!0},t.prototype._calculateAndAppendAggregateItem=function(e){for(var t={attributes:{},geometry:null},i=0,r=this._decodedGroupbyfield;i<r.length;i++){var n=r[i],a=n.singlefield?e.features[0].attributes[n.singlefield]:n.expression.calculateValue(e.features[0]);t.attributes[n.tofieldname]=a}for(var s=0,o=this._decodedStatsfield;s<o.length;s++){var d=o[s];this._calculateFieldStat(e,d,t)}for(var u=[],f=0;f<this._decodedStatsfield.length;f++)u.push(this._calculateFieldStat(e,this._decodedStatsfield[f],t));return this._featureCache[t.attributes[this.objectIdField]]=new l({attributes:t.attributes,geometry:t.geometry}),t},t.prototype._generateAggregateHash=function(e){for(var t="",i=0,r=this._decodedGroupbyfield;i<r.length;i++){var n=r[i],a=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==a?":":":"+a.toString()}return F(t,b.outputTypes.String)},t.prototype._stat=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){return[2,{calculated:!1}]}))}))},t.prototype.getFeatureByObjectId=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){return[2,null]}))}))},t.registerAction=function(){p._featuresetFunctions.groupby=function(e,i){return new t({parentfeatureset:this,groupbyfields:e,statsfields:i})}},t}(p)}));