/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../sources/Empty","../support/FeatureSet","../support/IdSet","../support/shared","../../../core/promiseUtils","../../../geometry/geometryEngineAsync"],(function(e,t,n,i,r,a,s){"use strict";return function(l){function o(e){var t;return(t=l.call(this,e)||this)._relation="",t._relationGeom=null,t._relationString="",t.declaredClass="esri.arcade.featureset.actions.SpatialFilter",t._relationString=e.relationString,t._parent=e.parentfeatureset,t._maxProcessing=40,t._relation=e.relation,t._relationGeom=e.relationGeom,t}e._inheritsLoose(o,l);var u=o.prototype;return u._getSet=function(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,null,null,e))).then((t=>(this._checkCancelled(e),this._wset=new i(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):a.resolve(this._wset)},u._isInFeatureSet=function(e){let t=this._parent._isInFeatureSet(e);return t===r.IdState.NotInFeatureSet?t:(t=this._idstates[e],void 0===t?r.IdState.Unknown:t)},u._getFeature=function(e,t,n){return this._parent._getFeature(e,t,n)},u._getFeatures=function(e,t,n,i){return this._parent._getFeatures(e,t,n,i)},u._featureFromCache=function(e){return this._parent._featureFromCache(e)},u.executeSpatialRelationTest=function(e){if(null===e.geometry)return a.resolve(!1);switch(this._relation){case"esriSpatialRelEnvelopeIntersects":{const t=r.shapeExtent(this._relationGeom),n=r.shapeExtent(e.geometry);return s.intersects(t,n)}case"esriSpatialRelIntersects":return s.intersects(this._relationGeom,e.geometry);case"esriSpatialRelContains":return s.contains(this._relationGeom,e.geometry);case"esriSpatialRelOverlaps":return s.overlaps(this._relationGeom,e.geometry);case"esriSpatialRelWithin":return s.within(this._relationGeom,e.geometry);case"esriSpatialRelTouches":return s.touches(this._relationGeom,e.geometry);case"esriSpatialRelCrosses":return s.crosses(this._relationGeom,e.geometry);case"esriSpatialRelRelation":return s.relate(this._relationGeom,e.geometry,this._relationString)}},u._fetchAndRefineFeatures=function(e,t,n){const s=new i([],e,!1,null),l=Math.min(t,e.length);return this._parent._getFeatures(s,-1,l,n).then((()=>{this._checkCancelled(n);const t=[];for(let n=0;n<l;n++){const i=this._parent._featureFromCache(e[n]);t.push(this.executeSpatialRelationTest(i))}return a.all(t)})).then((n=>{for(let i=0;i<t;i++)!0===n[i]?this._idstates[e[i]]=r.IdState.InFeatureSet:this._idstates[e[i]]=r.IdState.NotInFeatureSet;return"success"}))},u._getFilteredSet=function(e,t,n,r,a){return this._ensureLoaded().then((()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,n,r,a))).then((e=>{let n;return this._checkCancelled(a),n=null!==t?new i(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new i(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),n}))},u._stat=function(e,t,n,i,r,s,l){return""!==n?a.resolve({calculated:!1}):this._parent._stat(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,r,s,l).then((a=>!1===a.calculated?null===r&&""===n&&null===i?this._manualStat(e,t,s,l):{calculated:!1}:a))},u._canDoAggregates=function(e,t,n,i,r){return""!==n||null!==i||null===this._parent?a.resolve(!1):this._parent._canDoAggregates(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,r)},u._getAggregatePagesDataSourceDefinition=function(e,t,n,i,r,s,l){return null===this._parent?a.reject(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,r,s,l)},o.registerAction=function(){n._featuresetFunctions.intersects=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:e})},n._featuresetFunctions.envelopeIntersects=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:e})},n._featuresetFunctions.contains=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:e})},n._featuresetFunctions.overlaps=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:e})},n._featuresetFunctions.within=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:e})},n._featuresetFunctions.touches=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:e})},n._featuresetFunctions.crosses=function(e){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:e})},n._featuresetFunctions.relate=function(e,n){return null==e?new t({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:e,relationString:n})}},o}(n)}));
