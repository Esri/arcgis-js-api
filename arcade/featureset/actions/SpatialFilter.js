/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/promiseUtils","../support/shared","../../../geometry/geometryEngineAsync","../support/IdSet","../support/FeatureSet","../sources/Empty"],(function(e,t,n,i,r,a,s){"use strict";return function(l){function o(e){var t;return(t=l.call(this,e)||this)._relation="",t._relationGeom=null,t._relationString="",t.declaredClass="esri.arcade.featureset.actions.SpatialFilter",t._relationString=e.relationString,t._parent=e.parentfeatureset,t._maxProcessing=40,t._relation=e.relation,t._relationGeom=e.relationGeom,t}e._inheritsLoose(o,l);var u=o.prototype;return u._getSet=function(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,null,null,e))).then((t=>(this._checkCancelled(e),this._wset=new r(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):t.resolve(this._wset)},u._isInFeatureSet=function(e){let t=this._parent._isInFeatureSet(e);return t===n.IdState.NotInFeatureSet?t:(t=this._idstates[e],void 0===t?n.IdState.Unknown:t)},u._getFeature=function(e,t,n){return this._parent._getFeature(e,t,n)},u._getFeatures=function(e,t,n,i){return this._parent._getFeatures(e,t,n,i)},u._featureFromCache=function(e){return this._parent._featureFromCache(e)},u.executeSpatialRelationTest=function(e){if(null===e.geometry)return t.resolve(!1);switch(this._relation){case"esriSpatialRelEnvelopeIntersects":{const t=n.shapeExtent(this._relationGeom),r=n.shapeExtent(e.geometry);return i.intersects(t,r)}case"esriSpatialRelIntersects":return i.intersects(this._relationGeom,e.geometry);case"esriSpatialRelContains":return i.contains(this._relationGeom,e.geometry);case"esriSpatialRelOverlaps":return i.overlaps(this._relationGeom,e.geometry);case"esriSpatialRelWithin":return i.within(this._relationGeom,e.geometry);case"esriSpatialRelTouches":return i.touches(this._relationGeom,e.geometry);case"esriSpatialRelCrosses":return i.crosses(this._relationGeom,e.geometry);case"esriSpatialRelRelation":return i.relate(this._relationGeom,e.geometry,this._relationString)}},u._fetchAndRefineFeatures=function(e,i,a){const s=new r([],e,!1,null),l=Math.min(i,e.length);return this._parent._getFeatures(s,-1,l,a).then((()=>{this._checkCancelled(a);const n=[];for(let t=0;t<l;t++){const i=this._parent._featureFromCache(e[t]);n.push(this.executeSpatialRelationTest(i))}return t.all(n)})).then((t=>{for(let r=0;r<i;r++)!0===t[r]?this._idstates[e[r]]=n.IdState.InFeatureSet:this._idstates[e[r]]=n.IdState.NotInFeatureSet;return"success"}))},u._getFilteredSet=function(e,t,n,i,a){return this._ensureLoaded().then((()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,n,i,a))).then((e=>{let n;return this._checkCancelled(a),n=null!==t?new r(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new r(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),n}))},u._stat=function(e,n,i,r,a,s,l){return""!==i?t.resolve({calculated:!1}):this._parent._stat(e,n,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,a,s,l).then((t=>!1===t.calculated?null===a&&""===i&&null===r?this._manualStat(e,n,s,l):{calculated:!1}:t))},u._canDoAggregates=function(e,n,i,r,a){return""!==i||null!==r||null===this._parent?t.resolve(!1):this._parent._canDoAggregates(e,n,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,a)},u._getAggregatePagesDataSourceDefinition=function(e,n,i,r,a,s,l){return null===this._parent?t.reject(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,n,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,a,s,l)},o.registerAction=function(){a._featuresetFunctions.intersects=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:e})},a._featuresetFunctions.envelopeIntersects=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:e})},a._featuresetFunctions.contains=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:e})},a._featuresetFunctions.overlaps=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:e})},a._featuresetFunctions.within=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:e})},a._featuresetFunctions.touches=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:e})},a._featuresetFunctions.crosses=function(e){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:e})},a._featuresetFunctions.relate=function(e,t){return null==e?new s({parentfeatureset:this}):new o({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:e,relationString:t})}},o}(a)}));
