/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{X as e}from"../../../chunks/languageUtils.js";import t from"../support/FeatureSet.js";import n from"../support/IdSet.js";import r from"../support/OrderbyClause.js";class s extends t{constructor(e){super(e),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=e.orderbyclause,this._parent=e.parentfeatureset}async _getSet(e){if(null===this._wset){await this._ensureLoaded();const t=await this._getFilteredSet("",null,null,this._orderbyclause,e);return this._checkCancelled(e),this._wset=t,this._wset}return this._wset}async manualOrderSet(e,t){const r=await this.getIdColumnDictionary(e,[],-1,t);this._orderbyclause.order(r);const s=new n([],[],!0,null);for(let n=0;n<r.length;n++)s._known.push(r[n].id);return s}async getIdColumnDictionary(t,n,r,s){if(r<t._known.length-1){const i=this._maxQueryRate();if("GETPAGES"===t._known[r+1])return await e(this._parent._expandPagedSet(t,i,0,0,s)),this.getIdColumnDictionary(t,n,r,s);let a=r+1;const o=[];for(;a<t._known.length&&"GETPAGES"!==t._known[a];)o.push(t._known[a]),a++;r+=o.length;const c=await e(this._parent._getFeatureBatch(o,s));this._checkCancelled(s);for(const e of c)n.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(t,n,r,s)}return t._candidates.length>0?(await e(this._refineSetBlock(t,this._maxProcessingRate(),s)),this._checkCancelled(s),this.getIdColumnDictionary(t,n,r,s)):n}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}_featureFromCache(e){if(void 0===this._featureCache[e]){const t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}async _fetchAndRefineFeatures(){throw new Error("Fetch and Refine should not be called in this featureset")}async _getFilteredSet(e,t,r,s,i){await this._ensureLoaded();const a=await this._parent._getFilteredSet(e,t,r,null===s?this._orderbyclause:s,i);this._checkCancelled(i);const o=new n(a._candidates.slice(0),a._known.slice(0),a._ordered,this._clonePageDefinition(a.pagesDefinition));let c=!0;if(a._candidates.length>0&&(c=!1),!1===o._ordered){let e=await this.manualOrderSet(o,i);return!1===c&&(null===t&&null===r||(e=new n(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)))),e}return o}static registerAction(){t._featuresetFunctions.orderBy=function(e){return""===e?this:new s({parentfeatureset:this,orderbyclause:new r(e)})}}}export{s as default};
