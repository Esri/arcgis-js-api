// COPYRIGHT © 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../Dictionary","../executionError","../languageUtils","../polyfill/maybe"],(function(e,r,n,t,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.convertDirection=r.preciseDivide=r.preciseMultiply=r.preciseMinus=r.preciseAdd=void 0;var c=function(e){return function(r,n,t){return t=t||14,+e(r,n).toFixed(t)}},s=function(e,r){return e+r},a=function(e,r){return e-r},u=function(e,r){return e*r},l=function(e,r){return e/r};r.preciseAdd=function(e,r,n){return c(s)(e,r,n)};r.preciseMinus=function(e,r,n){return c(a)(e,r,n)};r.preciseMultiply=function(e,r,n){return c(u)(e,r,n)};r.preciseDivide=function(e,r,n){return c(l)(e,r,n)};var d,E,f,h,g=2*Math.PI,m=648e3/Math.PI,p=String.fromCharCode(7501);function A(e){if(!1===o.isString(e))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.InvalidParameter,null);return e}function w(e,r){var n=Math.pow(10,r);return Math.round(e*n)/n}function v(e){var r,n=parseFloat(e.toString().replace(function(e){return e=+e,isFinite(e)?e-e%1||(e<0?-0:0===e?e:0):e}(e).toString(),"0"))*(((r=e)>0)-(r<0)||+r);return e<0?{fraction:n,integer:Math.ceil(e)}:{fraction:n,integer:Math.floor(e)}}function D(e,r){switch(e){case 0:return"SHORT"===r?"N":"North";case 1:return"SHORT"===r?"E":"East";case 2:return"SHORT"===r?"S":"South";case 3:return"SHORT"===r?"W":"West"}}function x(e,r,n){for(;e.length<n;)e=r+e;return e}function _(e,r){return e-Math.floor(e/r)*r}function S(e){switch(e){case 6:case 1:return 360;case 4:return g;case 5:return 400;case 2:return 1296e3;case 7:case 8:return 60;default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unsupported evaluations"})}}function T(e){switch(e.toUpperCase().trim()){case"NORTH":case"NORTHAZIMUTH":case"NORTH AZIMUTH":return 1;case"POLAR":return 2;case"QUADRANT":return 3;case"SOUTH":case"SOUTHAZIMUTH":case"SOUTH AZIMUTH":return 4}throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unsupported directionType"})}function M(e){switch(e.toUpperCase().trim()){case"D":case"DD":case"DECIMALDEGREE":case"DECIMAL DEGREE":case"DEGREE":case"DECIMALDEGREES":case"DECIMAL DEGREES":case"DEGREES":return 1;case"DMS":case"DEGREESMINUTESSECONDS":case"DEGREES MINUTES SECONDS":return 3;case"R":case"RAD":case"RADS":case"RADIAN":case"RADIANS":return 4;case"G":case"GON":case"GONS":case"GRAD":case"GRADS":case"GRADIAN":case"GRADIANS":return 5}throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unsupported units"})}!function(e){e[e.north=0]="north",e[e.east=1]="east",e[e.south=2]="south",e[e.west=3]="west"}(d||(d={})),function(e){e[e.decimal_degrees=1]="decimal_degrees",e[e.seconds=2]="seconds",e[e.degrees_minutes_seconds=3]="degrees_minutes_seconds",e[e.radians=4]="radians",e[e.gradians=5]="gradians",e[e.truncated_degrees=6]="truncated_degrees",e[e.fractional_degree_minutes=7]="fractional_degree_minutes",e[e.fractional_minute_seconds=8]="fractional_minute_seconds"}(E||(E={})),function(e){e[e.north_azimuth=1]="north_azimuth",e[e.polar=2]="polar",e[e.quadrant=3]="quadrant",e[e.south_azimuth=4]="south_azimuth"}(f||(f={})),function(e){e[e.meridian=0]="meridian",e[e.direction=1]="direction"}(h||(h={}));var R=function(){function e(e,r,n){this.m_degrees=e,this.m_minutes=r,this.m_seconds=n}return e.prototype.getField=function(e){switch(e){case 1:case 6:return this.m_degrees;case 7:return this.m_minutes;case 2:case 8:return this.m_seconds;default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unexpected evaluation"})}},e.secondsToDMS=function(r){var n=v(r).fraction,t=v(r).integer,o=Math.floor(t/3600);t-=3600*o;var i=Math.floor(t/60);return new e(o,i,(t-=60*i)+n)},e.numberToDms=function(n){var t=v(n).fraction,o=v(n).integer,i=r.preciseMultiply(v(100*t).fraction,100);return new e(o,v(100*t).integer,i)},e.prototype.format=function(n,t){var o=w(this.m_seconds,t),i=this.m_minutes,c=this.m_degrees;if(2===n||8===n)60<=o&&(o-=60,++i),60<=i&&(i=0,++c),360<=c&&(c=0);else if(7===n)o=0,i=30<=this.m_seconds?this.m_minutes+1:this.m_minutes,c=this.m_degrees,60<=i&&(i=0,++c),360<=c&&(c=0);else if(1===n||6===n){var s=r.preciseDivide(this.m_seconds,3600),a=r.preciseDivide(this.m_minutes,60);c=Math.round(this.m_degrees+a+s),i=0,o=0}return new e(c,i,o)},e.dmsToSeconds=function(e,r,n){return 3600*e+60*r+n},e}(),y=function(){function e(e,r,n){this.meridian=e,this.angle=r,this.direction=n}return e.prototype.fetchAzimuth=function(e){return e===h.meridian?this.meridian:this.direction},e}(),F=function(){function e(e){this._angle=e}return e.createFromAngleAndDirection=function(r,n){return new e(new L(e._convertDirectionFormat(r.extractAngularUnits(2),n,1)))},e.prototype.getAngle=function(r){var n=this._angle.extractAngularUnits(2);switch(r){case 1:case 4:case 2:return new L(e._convertDirectionFormat(n,1,r));case 3:var t=e.secondsNorthAzimuthToQuadrant(n);return new L(t.angle)}},e.prototype.getMeridian=function(r){var n=this._angle.extractAngularUnits(2);switch(r){case 1:return 0;case 4:return 2;case 2:return 1;case 3:return e.secondsNorthAzimuthToQuadrant(n).meridian}},e.prototype.getDirection=function(r){var n=this._angle.extractAngularUnits(2);switch(r){case 1:return 1;case 4:return 3;case 2:return 0;case 3:return e.secondsNorthAzimuthToQuadrant(n).direction}},e.secondsNorthAzimuthToQuadrant=function(e){var r=e<=324e3||e>=972e3?0:2,n=0===r?Math.min(1296e3-e,e):Math.abs(e-648e3);return new y(r,n,e>648e3?3:1)},e.createFromAngleMeridianAndDirection=function(r,n,t){return new e(new L(e.secondsQuadrantToNorthAzimuth(r.extractAngularUnits(2),n,t)))},e.secondsQuadrantToNorthAzimuth=function(e,r,n){return 0===r?1===n?e:1296e3-e:1===n?648e3-e:648e3+e},e._convertDirectionFormat=function(e,r,n){var o=0;switch(r){case 1:o=e;break;case 2:o=324e3-e;break;case 3:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unexpected evaluation"});case 4:o=e+648e3}var i=0;switch(n){case 1:i=o;break;case 2:i=324e3-o;break;case 3:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unexpected evaluation"});case 4:i=o-648e3}return(i=i%1296e3)<0?1296e3+i:i},e}();function C(e,n,o){var i=null;switch(n){case 1:i=r.preciseMultiply(e,3600);break;case 2:i=e;break;case 5:i=r.preciseMultiply(e,3240);break;case 4:i=r.preciseMultiply(e,m);break;default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unexpected evaluation"})}switch(o){case 1:return r.preciseDivide(i,3600);case 2:return i;case 5:return r.preciseDivide(i,3240);case 4:return i/m;default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unexpected evaluation"})}}var L=function(){function e(e){this._seconds=e}return e.createFromAngleAndUnits=function(r,n){return new e(C(r,n,2))},e.prototype.extractAngularUnits=function(e){return C(this._seconds,2,U(e))},e.createFromDegreesMinutesSeconds=function(n,t,o){return new e(r.preciseAdd(r.preciseAdd(r.preciseMultiply(n,3600),r.preciseMultiply(t,60)),o))},e}();function U(e){switch(i.assertIsSome(e),e){case 1:case 6:case 3:return 1;case 5:return 5;case 7:return 7;case 4:return 4;case 2:case 8:return 2}}var N=function(){function e(e,r,n,t){this.view=e,this.angle=r,this.merdian=n,this.direction=t,this._dms=null,this._formattedDms=null}return e.createFromStringAndBearing=function(r,n,t){return new e(r,n.getAngle(t),n.getMeridian(t),n.getDirection(t))},e.prototype.fetchAngle=function(){return this.angle},e.prototype.fetchMeridian=function(){return this.merdian},e.prototype.fetchDirection=function(){return this.direction},e.prototype.fetchView=function(){return this.view},e.prototype.fetchDms=function(){return null===this._dms&&this._calculateDms(),this._dms},e.prototype.fetchFormattedDms=function(){return null===this._formattedDms&&this._calculateDms(),this._formattedDms},e.prototype._calculateDms=function(){for(var e=null,r=6,n=0,t=0;t<this.view.length;t++){var o=this.view[t];switch(o){case"m":r=6===r?7:r,t=(e=k(this.view,t,o)).newpos;continue;case"s":r=8,n=n<(e=k(this.view,t,o)).rounding?e.rounding:n,t=e.newpos;continue;default:continue}}this._dms=R.secondsToDMS(this.angle.extractAngularUnits(2)),this._formattedDms=R.secondsToDMS(this.angle.extractAngularUnits(2)).format(r,n)},e}();function b(e,r,n,o,i){switch(r){case 1:case 4:case 5:return x(_(w(e.extractAngularUnits(r),o),S(r)).toFixed(o),"0",n+o+(o>0?1:0));case 6:case 7:return x(_(i.fetchFormattedDms().getField(r),S(r)).toFixed(o),"0",n+o+(o>0?1:0));case 8:return x(_(w(i.fetchDms().getField(r),o),S(r)).toFixed(o),"0",n+o+(o>0?1:0));default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"unexpected evaluation"})}}function I(e){switch(e.toUpperCase().trim()){case"N":case"NORTH":return 0;case"E":case"EAST":return 1;case"S":case"SOUTH":return 2;case"W":case"WEST":return 3}return null}function O(e){var r=parseFloat(e);if(o.isNumber(r)){if(isNaN(r))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"invalid conversion"});return r}throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"invalid conversion"})}function G(e,r,n){var i=3===n,c=null,s=null,a=0,u=0,l=0;if(i){if(e.length<2)throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"conversion error"});l=1;var d=function(e){switch(o.toNumber(e)){case 1:return{first:0,second:1};case 2:return{first:2,second:1};case 3:return{first:2,second:3};case 4:return{first:0,second:3}}return null}(o.toString(e[e.length-1]));if(d?(c=d.first,s=d.second):(a=1,c=I(o.toString(e[0])),s=I(o.toString(e[e.length-1]))),null===c||null===s)throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"invalid conversion"})}switch(r){case 1:case 4:case 5:if(0===e.length)throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"invalid conversion"});return i?F.createFromAngleMeridianAndDirection(L.createFromAngleAndUnits(O(e[a]),U(r)),c,s):F.createFromAngleAndDirection(L.createFromAngleAndUnits(O(e[a]),U(r)),n);case 3:if(3===(u=e.length-l-a)){var E=L.createFromDegreesMinutesSeconds(O(e[a]),O(e[a+1]),O(e[a+2]));return i?F.createFromAngleMeridianAndDirection(E,c,s):F.createFromAngleAndDirection(E,n)}if(1===u){var f=O(e[a]),h=R.numberToDms(f),g=L.createFromDegreesMinutesSeconds(h.m_degrees,h.m_minutes,h.m_seconds);return i?F.createFromAngleMeridianAndDirection(g,c,s):F.createFromAngleAndDirection(g,n)}}throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"invalid conversion"})}function H(e,r,n){if(o.isNumber(e))return function(e,r,n){if(3===n)throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"conversion error"});if(3===r){var o=R.numberToDms(e);return F.createFromAngleAndDirection(L.createFromDegreesMinutesSeconds(o.m_degrees,o.m_minutes,o.m_seconds),n)}return F.createFromAngleAndDirection(L.createFromAngleAndUnits(e,U(r)),n)}(o.toNumber(e),r,n);if(o.isString(e))return G(function(e){for(var r=[" ","-","/","'",'"',"\\","^","°",p,"\t","\r","\n","*"],n="",t=0;t<e.length;t++){var o=e.charAt(t);r.includes(o)?n+="RRSPLITRRSPLITRR":n+=o}return n.split("RRSPLITRRSPLITRR").filter((function(e){return""!==e}))}(e),r,n);if(o.isArray(e))return G(e,r,n);if(o.isImmutableArray(e))return G(e.toArray(),r,n);throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"conversion error"})}function k(e,r,n){for(var t={padding:0,rounding:0,newpos:r},o=!1;r<e.length;){var i=e[r];if(i===n)o?t.rounding++:t.padding++,r++;else{if("."!==i)break;o=!0,r++}}return t.newpos=r-1,t}function P(e,r,n){var t={escaped:"",newpos:r};for(r++;r<e.length;){var o=e[r];if(r++,"]"===o)break;t.escaped+=o}return t.newpos=r-1,t}r.convertDirection=function(e,r,i){if(!(r instanceof n))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.InvalidParameter,null);if(!1===r.hasField("directionType"))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"missing directionType"});if(!1===r.hasField("angleType"))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"missing angleType"});var c=T(A(r.field("directiontype"))),s=H(e,M(A(r.field("angletype"))),c);if(!(i instanceof n))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.InvalidParameter,null);if(!1===i.hasField("directionType"))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"missing directionType"});if(!1===i.hasField("outputType"))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"missing angleType"});var a=T(A(i.field("directiontype"))),u=i.hasField("angleType")?M(A(i.field("angletype"))):null,l=A(i.field("outputType")).toUpperCase().trim();if(!a||!l)throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"conversion error"});if(!(u||"TEXT"===l&&i.hasField("format")))throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"invalid unit"});switch(l){case"VALUE":return 3===a||3===u?function(e,r,n){var t=e.getAngle(r);if(3===r&&3===n){var o=R.secondsToDMS(t.extractAngularUnits(2));return[D(e.getMeridian(r),"SHORT"),o.m_degrees,o.m_minutes,o.m_seconds,D(e.getDirection(r),"SHORT")]}return 3===n?[(o=R.secondsToDMS(t.extractAngularUnits(2))).m_degrees,o.m_minutes,o.m_seconds]:3===r?[D(e.getMeridian(r),"SHORT"),t.extractAngularUnits(n),D(e.getDirection(r),"SHORT")]:[t.extractAngularUnits(n)]}(s,a,u):function(e,r,n){var o=U(n);if(o&&3!==n)return e.getAngle(r).extractAngularUnits(o);throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"conversion error"})}(s,a,u);case"TEXT":var d="";return i.hasField("format")&&(d=o.toString(i.field("format"))),null!==d&&""!==d||(d=function(e,r){var n="";switch(e){case 1:n=3===r?"DD.DD°":"DDD.DD°";break;case 3:n=3===r?"dd° mm' ss\"":"ddd° mm' ss.ss\"";break;case 4:n="R.RR";break;case 5:n="GGG.GG"+p;break;default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.LogicError,null,{reason:"conversion error"})}return 3===r&&(n="p "+n+" b"),n}(u,a)),function(e,r,n){for(var t="",o=null,i=N.createFromStringAndBearing(r,e,n),c={D:1,d:6,m:7,s:8,R:4,G:5},s=0;s<r.length;s++){var a=r[s];switch(a){case"[":t+=(o=P(r,s)).escaped,s=o.newpos;continue;case"D":case"d":case"m":case"s":case"R":case"G":o=k(r,s,a),t+=b(e.getAngle(n),c[a],o.padding,o.rounding,i),s=o.newpos;continue;case"P":case"p":t+=D(i.fetchMeridian(),"p"===a?"SHORT":"LONG");continue;case"B":case"b":t+=D(i.fetchDirection(),"b"===a?"SHORT":"LONG");continue;default:t+=a}}return t}(s,d,a);default:throw new t.ArcadeExecutionError(null,t.ExecutionErrorCodes.InvalidParameter,null)}}}));