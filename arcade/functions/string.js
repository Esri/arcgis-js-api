// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../polyfill/tsSupport/assign","../polyfill/tsSupport/spreadarray","../ArcadePortal","../Attachment","../Dictionary","../executionError","../languageUtils","../featureset/support/shared","./convertdirection","./hash","../../geometry/Extent","../../geometry/Multipoint","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../SpatialReference"],(function(e,r,t,n,o,i,a,u,c,d,p,f,s,l,h,g,y,m){"use strict";function E(e,r){return e&&r?e.x===r.x&&e.y===r.y:e===r}Object.defineProperty(r,"__esModule",{value:!0}),r.registerFunctions=void 0,r.registerFunctions=function(e,r){e.portal=function(e,t){return r(e,t,(function(r,n,i){return c.pcCheck(i,1,1,e,t),new o(c.toString(i[0]))}))},e.typeof=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,1,1,e,t);var i=c.getType(o[0]);if("Unrecognised Type"===i)throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.UnrecognisedType,t);return i}))},e.trim=function(e,t){return r(e,t,(function(r,n,o){return c.pcCheck(o,1,1,e,t),c.toString(o[0]).trim()}))},e.tohex=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,1,1,e,t);var i=c.toNumber(o[0]);return isNaN(i)?i:i.toString(16)}))},e.upper=function(e,t){return r(e,t,(function(r,n,o){return c.pcCheck(o,1,1,e,t),c.toString(o[0]).toUpperCase()}))},e.proper=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,1,2,e,t);var i=1;2===o.length&&"firstword"===c.toString(o[1]).toLowerCase()&&(i=2);for(var a=/\s/,u=c.toString(o[0]),d="",p=!0,f=0;f<u.length;f++){var s=u[f];if(a.test(s))1===i&&(p=!0);else s.toUpperCase()!==s.toLowerCase()&&(p?(s=s.toUpperCase(),p=!1):s=s.toLowerCase());d+=s}return d}))},e.lower=function(e,t){return r(e,t,(function(r,n,o){return c.pcCheck(o,1,1,e,t),c.toString(o[0]).toLowerCase()}))},e.guid=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,0,1,e,t),o.length>0)switch(c.toString(o[0]).toLowerCase()){case"digits":return c.generateUUID().replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return c.generateUUID();case"digits-hyphen-braces":return"{"+c.generateUUID()+"}";case"digits-hyphen-parentheses":return"("+c.generateUUID()+")"}return"{"+c.generateUUID()+"}"}))},e.standardizeguid=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,2,2,e,t);var i=c.toString(o[0]);if(""===i||null===i)return"";var a=/^(\{|\()?([0-9a-z]{8})(\-?)([0-9a-z]{4})(\-?)([0-9a-z]{4})(\-?)([0-9a-z]{4})(\-?)([0-9a-z]{12})(\}|\))?$/gim.exec(i);if(!a)return"";for(var u=[],d=1;d<a.length;d++){var p=a[d];void 0!==p&&""!==p&&null!==p&&["-","}","{","(",")"].indexOf(p)<0&&u.push(p)}if(5!==u.length)return"";switch(i=u[0]+"-"+u[1]+"-"+u[2]+"-"+u[3]+"-"+u[4],c.toString(o[1]).toLowerCase()){case"digits":return i.replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return i;case"digits-hyphen-braces":return"{"+i+"}";case"digits-hyphen-parentheses":return"("+i+")"}return"{"+i+"}"}))},e.console=function(e,t){return r(e,t,(function(r,t,n){return 0===n.length||(1===n.length?e.console(c.toString(n[0])):e.console(c.toString(n))),c.voidOperation}))},e.mid=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,2,3,e,t);var i=c.toNumber(o[1]);if(isNaN(i))return"";if(i<0&&(i=0),2===o.length)return c.toString(o[0]).substr(i);var a=c.toNumber(o[2]);return isNaN(a)?"":(a<0&&(a=0),c.toString(o[0]).substr(i,a))}))},e.find=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,2,3,e,t);var i=0;if(o.length>2){if(i=c.toNumber(c.defaultUndefined(o[2],0)),isNaN(i))return-1;i<0&&(i=0)}return c.toString(o[1]).indexOf(c.toString(o[0]),i)}))},e.left=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,2,2,e,t);var i=c.toNumber(o[1]);return isNaN(i)?"":(i<0&&(i=0),c.toString(o[0]).substr(0,i))}))},e.right=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,2,2,e,t);var i=c.toNumber(o[1]);return isNaN(i)?"":(i<0&&(i=0),c.toString(o[0]).substr(-1*i,i))}))},e.split=function(e,t){return r(e,t,(function(r,n,o){var i;c.pcCheck(o,2,4,e,t);var a=c.toNumber(c.defaultUndefined(o[2],-1)),u=c.toBoolean(c.defaultUndefined(o[3],!1));if(-1===a||null===a||!0===u?i=c.toString(o[0]).split(c.toString(o[1])):(isNaN(a)&&(a=-1),a<-1&&(a=-1),i=c.toString(o[0]).split(c.toString(o[1]),a)),!1===u)return i;for(var d=[],p=0;p<i.length&&!(-1!==a&&d.length>=a);p++)""!==i[p]&&void 0!==i[p]&&d.push(i[p]);return d}))},e.text=function(e,t){return r(e,t,(function(r,n,o){return c.pcCheck(o,1,2,e,t),c.toStringExplicit(o[0],o[1])}))},e.concatenate=function(e,t){return r(e,t,(function(e,r,t){var n=[];if(t.length<1)return"";if(c.isArray(t[0])){for(var o=c.defaultUndefined(t[2],""),i=0;i<t[0].length;i++)n[i]=c.toStringExplicit(t[0][i],o);return t.length>1?n.join(t[1]):n.join("")}if(c.isImmutableArray(t[0])){for(o=c.defaultUndefined(t[2],""),i=0;i<t[0].length();i++)n[i]=c.toStringExplicit(t[0].get(i),o);return t.length>1?n.join(t[1]):n.join("")}for(i=0;i<t.length;i++)n[i]=c.toStringExplicit(t[i]);return n.join("")}))},e.reverse=function(e,t){return r(e,t,(function(r,n,o){var i;if(c.pcCheck(o,1,1,e,t),c.isArray(o[0]))return(i=o[0].slice(0)).reverse(),i;if(c.isImmutableArray(o[0]))return(i=o[0].toArray().slice(0)).reverse(),i;throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.replace=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,3,4,e,t);var i=c.toString(o[0]),a=c.toString(o[1]),u=c.toString(o[2]);return 4!==o.length||c.toBoolean(o[3])?c.multiReplace(i,a,u):i.replace(a,u)}))},e.schema=function(e,t){return r(e,t,(function(r,n,o){if(c.isFeature(o[0])){var i=c.featureSchema(o[0]);return i?a.convertObjectToArcadeDictionary(i):null}throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.subtypes=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,1,1,e,t),c.isFeature(o[0])){var i=c.featureSubtypes(o[0]);return i?a.convertObjectToArcadeDictionary(i):null}throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.subtypecode=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,1,1,e,t),c.isFeature(o[0])){var i=c.featureSubtypes(o[0]);if(!i)return null;if(i.subtypeField&&o[0].hasField(i.subtypeField)){for(var a=o[0].field(i.subtypeField),d=0,p=i.subtypes;d<p.length;d++){var f=p[d];if(f.code===a)return f.code}return null}return null}throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.subtypename=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,1,1,e,t),c.isFeature(o[0])){var i=c.featureSubtypes(o[0]);if(!i)return"";if(i.subtypeField&&o[0].hasField(i.subtypeField)){for(var a=o[0].field(i.subtypeField),d=0,p=i.subtypes;d<p.length;d++){var f=p[d];if(f.code===a)return f.name}return""}return""}throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.gdbversion=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,1,1,e,t),c.isFeature(o[0]))return o[0].gdbVersion();throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.domain=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,2,3,e,t),c.isFeature(o[0])){var i=c.featureFullDomain(o[0],c.toString(o[1]),void 0===o[2]?void 0:c.toNumber(o[2]));return i&&i.domain?"coded-value"===i.domain.type||"codedValue"===i.domain.type?a.convertObjectToArcadeDictionary({type:"codedValue",name:i.domain.name,dataType:d.layerFieldEsriConstants[i.field.type],codedValues:i.domain.codedValues.map((function(e){return{name:e.name,code:e.code}}))}):a.convertObjectToArcadeDictionary({type:"range",name:i.domain.name,dataType:d.layerFieldEsriConstants[i.field.type],min:i.domain.min,max:i.domain.max}):null}throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.domainname=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,2,4,e,t),c.isFeature(o[0]))return c.featureDomainValueLookup(o[0],c.toString(o[1]),o[2],void 0===o[3]?void 0:c.toNumber(o[3]));throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.domaincode=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,2,4,e,t),c.isFeature(o[0]))return c.featureDomainCodeLookup(o[0],c.toString(o[1]),o[2],void 0===o[3]?void 0:c.toNumber(o[3]));throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t)}))},e.urlencode=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,1,1,e,t),null===o[0])return"";if(o[0]instanceof a){for(var i="",u=0,d=o[0].keys();u<d.length;u++){var p=d[u],f=o[0].field(p);""!==i&&(i+="&"),i+=null===f?encodeURIComponent(p)+"=":encodeURIComponent(p)+"="+encodeURIComponent(f)}return i}return encodeURIComponent(c.toString(o[0]))}))},e.hash=function(e,t){return r(e,t,(function(r,n,d){c.pcCheck(d,1,1,e,t);var p=new f.XXH(0);return function e(r,t,n){if(null!==r)if(c.isArray(r)){if(t.updateUint8Array([61]),n.map.has(r)){var d=n.map.get(r);t.updateIntArray([61237541^d])}else{n.map.set(r,n.currentLength++);for(var p=0,f=r;p<f.length;p++){e(f[p],t,n)}n.map.delete(r),n.currentLength--}t.updateUint8Array([199])}else if(c.isImmutableArray(r)){if(t.updateUint8Array([61]),n.map.has(r)){d=n.map.get(r);t.updateIntArray([61237541^d])}else{n.map.set(r,n.currentLength++);for(var A=0,v=r.toArray();A<v.length;A++){e(v[A],t,n)}n.map.delete(r),n.currentLength--}t.updateUint8Array([199])}else{if(c.isDate(r))return t.updateIntArray([r.getTime()]),void t.updateUint8Array([241]);if(c.isString(r))return t.updateIntArray([r.length]),t.updateWithString(r),void t.updateUint8Array([41]);if(c.isBoolean(r))t.updateUint8Array([!0===r?1:0,113]);else{if(c.isNumber(r))return t.updateFloatArray([r]),void t.updateUint8Array([173]);if(r instanceof i)throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);if(r instanceof o)throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);if(!(r instanceof a)){if(c.isFeature(r))throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);if(r instanceof h)return t.updateIntArray([3833836621]),t.updateIntArray([0]),t.updateFloatArray([r.x]),t.updateIntArray([1]),t.updateFloatArray([r.y]),t.updateIntArray([3765347959]),void e(r.spatialReference.wkid,t,n);if(r instanceof g){t.updateIntArray([1266616829]);for(var x=0;x<r.rings.length;x++){for(var C=r.rings[x],w=[],I=null,S=null,b=0;b<C.length;b++){var U=r.getPoint(x,b);if(0===b)I=U;else if(E(S,U))continue;S=U,b===C.length-1&&E(I,U)||w.push(U)}t.updateIntArray([1397116793,w.length]);for(b=0;b<w.length;b++){U=w[b];t.updateIntArray([3962308117,b]),e(U,t,n),t.updateIntArray([2716288009])}t.updateIntArray([2278822459])}return t.updateIntArray([3878477243]),void e(r.spatialReference.wkid,t,n)}if(r instanceof y){t.updateIntArray([4106883559]);for(x=0;x<r.paths.length;x++){C=r.paths[x];t.updateIntArray([1397116793,C.length]);for(b=0;b<C.length;b++)t.updateIntArray([3962308117,b]),e(r.getPoint(x,b),t,n),t.updateIntArray([2716288009]);t.updateIntArray([2278822459])}return t.updateIntArray([2568784753]),void e(r.spatialReference.wkid,t,n)}if(r instanceof l){t.updateIntArray([588535921,r.points.length]);for(b=0;b<r.points.length;b++){var k=r.getPoint(b);t.updateIntArray([b]),e(k,t,n)}return t.updateIntArray([1700171621]),void e(r.spatialReference.wkid,t,n)}if(r instanceof s)return t.updateIntArray([3483648373]),t.updateIntArray([0]),t.updateFloatArray([r.xmax]),t.updateIntArray([1]),t.updateFloatArray([r.xmin]),t.updateIntArray([2]),t.updateFloatArray([r.ymax]),t.updateIntArray([3]),t.updateFloatArray([r.ymin]),t.updateIntArray([3622027469]),void e(r.spatialReference.wkid,t,n);if(r instanceof m)return t.updateIntArray([14]),void 0!==r.wkid&&null!==r.wkid&&t.updateIntArray([r.wkid]),void(r.wkt&&t.updateWithString(r.wkt));if(c.isFunctionParameter(r))throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);if(c.isFeatureSet(r))throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);if(c.isFeatureSetCollection(r))throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);if(r===c.voidOperation)throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node);throw new u.ArcadeExecutionError(n.context,u.ExecutionErrorCodes.UnsupportedHashType,n.node)}if(t.updateUint8Array([223]),n.map.has(r)){d=n.map.get(r);t.updateIntArray([61237541^d])}else{n.map.set(r,n.currentLength++);for(var N=0,F=r.keys();N<F.length;N++){var P=F[N];t.updateIntArray([P.length]),t.updateWithString(P),t.updateUint8Array([251]),e(r.field(P),t,n),t.updateUint8Array([239])}n.map.delete(r),n.currentLength--}t.updateUint8Array([73])}}else t.updateUint8Array([0,139])}(d[0],p,{context:e,node:t,map:new Map,currentLength:0}),p.digest()}))},e.convertdirection=function(e,t){return r(e,t,(function(r,n,o){return c.pcCheck(o,3,3,e,t),p.convertDirection(o[0],o[1],o[2])}))},e.fromjson=function(e,t){return r(e,t,(function(r,n,o){if(c.pcCheck(o,1,1,e,t),!1===c.isString(o[0]))throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.InvalidParameter,t);return a.convertJsonToArcade(JSON.parse(c.toString(o[0])))}))},e.expects=function(e,t){return r(e,t,(function(r,n,o){if(o.length<1)throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.WrongNumberOfParameters,t);return c.voidOperation}))},e.tocharcode=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,1,2,e,t);var i=c.toNumber(c.defaultUndefined(o[1],0)),a=c.toString(o[0]);if(0===a.length&&1===o.length)return null;if(a.length<=i||i<0)throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.OutOfBounds,t);return a.charCodeAt(i)}))},e.tocodepoint=function(e,t){return r(e,t,(function(r,n,o){c.pcCheck(o,1,2,e,t);var i=c.toNumber(c.defaultUndefined(o[1],0)),a=c.toString(o[0]);if(0===a.length&&1===o.length)return null;if(a.length<=i||i<0)throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.OutOfBounds,t);return a.codePointAt(i)}))},e.fromcharcode=function(e,t){return r(e,t,(function(r,n,o){if(o.length<1)throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.WrongNumberOfParameters,t);var i=o.map((function(e){return Math.trunc(c.toNumber(e))})).filter((function(e){return e>=0&&e<=65535}));return 0===i.length?null:String.fromCharCode.apply(null,i)}))},e.fromcodepoint=function(e,t){return r(e,t,(function(r,n,o){if(o.length<1)throw new u.ArcadeExecutionError(e,u.ExecutionErrorCodes.WrongNumberOfParameters,t);var i;try{i=o.map((function(e){return Math.trunc(c.toNumber(e))})).filter((function(e){return e<=1114111&&e>>>0===e}))}catch(e){return null}return 0===i.length?null:String.fromCodePoint.apply(null,i)}))}}}));