/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../ArcadePortal","../Attachment","../Dictionary","../executionError","../../chunks/languageUtils","../featureset/support/shared","./convertdirection","./hash","../../geometry/Extent","../../geometry/Multipoint","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry/SpatialReference","../../core/urlUtils"],(function(e,r,t,n,o,i,a,u,c,d,s,l,p,f,h,g){"use strict";function y(e){if("loaded"===e.loadStatus&&e.user&&e.user.sourceJSON){return e.user.sourceJSON}return null}function m(e,r){return!!e&&g.hasSamePortal(e,r?.restUrl||"")}function A(e,r){if(!e||!r)return e===r;if(e.x===r.x&&e.y===r.y){if(e.hasZ){if(e.z!==r.z)return!1}else if(r.hasZ)return!1;if(e.hasM){if(e.m!==r.m)return!1}else if(r.hasM)return!1;return!0}return!1}function E(e,a,u){if(null!==e)if(i.isArray(e)){if(a.updateUint8Array([61]),u.map.has(e)){const r=u.map.get(e);a.updateIntArray([61237541^r])}else{u.map.set(e,u.currentLength++);for(const r of e)E(r,a,u);u.map.delete(e),u.currentLength--}a.updateUint8Array([199])}else if(i.isImmutableArray(e)){if(a.updateUint8Array([61]),u.map.has(e)){const r=u.map.get(e);a.updateIntArray([61237541^r])}else{u.map.set(e,u.currentLength++);for(const r of e.toArray())E(r,a,u);u.map.delete(e),u.currentLength--}a.updateUint8Array([199])}else{if(i.isDate(e))return a.updateIntArray([e.toNumber()]),void a.updateUint8Array([241]);if(i.isString(e))return a.updateIntArray([e.length]),a.updateWithString(e),void a.updateUint8Array([41]);if(i.isBoolean(e))a.updateUint8Array([!0===e?1:0,113]);else{if(i.isNumber(e))return a.updateFloatArray([e]),void a.updateUint8Array([173]);if(e instanceof t)throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);if(e instanceof r)throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);if(!(e instanceof n)){if(i.isFeature(e))throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);if(e instanceof l)return a.updateIntArray([3833836621]),a.updateIntArray([0]),a.updateFloatArray([e.x]),a.updateIntArray([1]),a.updateFloatArray([e.y]),e.hasZ&&(a.updateIntArray([2]),a.updateFloatArray([e.z])),e.hasM&&(a.updateIntArray([3]),a.updateFloatArray([e.m])),a.updateIntArray([3765347959]),void E(e.spatialReference.wkid,a,u);if(e instanceof p){a.updateIntArray([1266616829]);for(let r=0;r<e.rings.length;r++){const t=e.rings[r],n=[];let o=null,i=null;for(let a=0;a<t.length;a++){const u=e.getPoint(r,a);if(0===a)o=u;else if(A(i,u))continue;i=u,a===t.length-1&&A(o,u)||n.push(u)}a.updateIntArray([1397116793,n.length]);for(let e=0;e<n.length;e++){const r=n[e];a.updateIntArray([3962308117,e]),E(r,a,u),a.updateIntArray([2716288009])}a.updateIntArray([2278822459])}return a.updateIntArray([3878477243]),void E(e.spatialReference.wkid,a,u)}if(e instanceof f){a.updateIntArray([4106883559]);for(let r=0;r<e.paths.length;r++){const t=e.paths[r];a.updateIntArray([1397116793,t.length]);for(let n=0;n<t.length;n++)a.updateIntArray([3962308117,n]),E(e.getPoint(r,n),a,u),a.updateIntArray([2716288009]);a.updateIntArray([2278822459])}return a.updateIntArray([2568784753]),void E(e.spatialReference.wkid,a,u)}if(e instanceof s){a.updateIntArray([588535921,e.points.length]);for(let r=0;r<e.points.length;r++){const t=e.getPoint(r);a.updateIntArray([r]),E(t,a,u)}return a.updateIntArray([1700171621]),void E(e.spatialReference.wkid,a,u)}if(e instanceof d)return a.updateIntArray([3483648373]),a.updateIntArray([0]),a.updateFloatArray([e.xmax]),a.updateIntArray([1]),a.updateFloatArray([e.xmin]),a.updateIntArray([2]),a.updateFloatArray([e.ymax]),a.updateIntArray([3]),a.updateFloatArray([e.ymin]),e.hasZ&&(a.updateIntArray([4]),a.updateFloatArray([e.zmax]),a.updateIntArray([5]),a.updateFloatArray([e.zmin])),e.hasM&&(a.updateIntArray([6]),a.updateFloatArray([e.mmax]),a.updateIntArray([7]),a.updateFloatArray([e.mmin])),a.updateIntArray([3622027469]),void E(e.spatialReference.wkid,a,u);if(e instanceof h)return a.updateIntArray([14]),void 0!==e.wkid&&null!==e.wkid&&a.updateIntArray([e.wkid]),void(e.wkt&&a.updateWithString(e.wkt));if(i.isFunctionParameter(e))throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);if(i.isFeatureSet(e))throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);if(i.isFeatureSetCollection(e))throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);if(e===i.voidOperation)throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node);throw new o.ArcadeExecutionError(u.context,o.ExecutionErrorCodes.UnsupportedHashType,u.node)}if(a.updateUint8Array([223]),u.map.has(e)){const r=u.map.get(e);a.updateIntArray([61237541^r])}else{u.map.set(e,u.currentLength++);for(const r of e.keys()){a.updateIntArray([r.length]),a.updateWithString(r),a.updateUint8Array([251]);E(e.field(r),a,u),a.updateUint8Array([239])}u.map.delete(e),u.currentLength--}a.updateUint8Array([73])}}else a.updateUint8Array([0,139])}function x(e,t){e.portal=function(e,n){return t(e,n,((t,o,a)=>(i.pcCheck(a,1,1,e,n),new r(i.toString(a[0])))))},e.typeof=function(e,r){return t(e,r,((t,n,a)=>{i.pcCheck(a,1,1,e,r);const u=i.getType(a[0]);if("Unrecognised Type"===u)throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.UnrecognisedType,r);return u}))},e.trim=function(e,r){return t(e,r,((t,n,o)=>(i.pcCheck(o,1,1,e,r),i.toString(o[0]).trim())))},e.tohex=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,1,1,e,r);const a=i.toNumber(o[0]);return isNaN(a)?a:a.toString(16)}))},e.upper=function(e,r){return t(e,r,((t,n,o)=>(i.pcCheck(o,1,1,e,r),i.toString(o[0]).toUpperCase())))},e.proper=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,1,2,e,r);let a=1;2===o.length&&"firstword"===i.toString(o[1]).toLowerCase()&&(a=2);const u=/\s/,c=i.toString(o[0]);let d="",s=!0;for(let e=0;e<c.length;e++){let r=c[e];if(u.test(r))1===a&&(s=!0);else{r.toUpperCase()!==r.toLowerCase()&&(s?(r=r.toUpperCase(),s=!1):r=r.toLowerCase())}d+=r}return d}))},e.lower=function(e,r){return t(e,r,((t,n,o)=>(i.pcCheck(o,1,1,e,r),i.toString(o[0]).toLowerCase())))},e.guid=function(e,r){return t(e,r,((t,n,o)=>{if(i.pcCheck(o,0,1,e,r),o.length>0)switch(i.toString(o[0]).toLowerCase()){case"digits":return i.generateUUID().replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return i.generateUUID();case"digits-hyphen-braces":return"{"+i.generateUUID()+"}";case"digits-hyphen-parentheses":return"("+i.generateUUID()+")"}return"{"+i.generateUUID()+"}"}))},e.standardizeguid=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,2,2,e,r);let a=i.toString(o[0]);if(""===a||null===a)return"";const u=/^(\{|\()?(?<partA>[0-9a-z]{8})(\-?)(?<partB>[0-9a-z]{4})(\-?)(?<partC>[0-9a-z]{4})(\-?)(?<partD>[0-9a-z]{4})(\-?)(?<partE>[0-9a-z]{12})(\}|\))?$/gim.exec(a);if(!u)return"";const c=u.groups;switch(a=c.partA+"-"+c.partB+"-"+c.partC+"-"+c.partD+"-"+c.partE,i.toString(o[1]).toLowerCase()){case"digits":return a.replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return a;case"digits-hyphen-braces":return"{"+a+"}";case"digits-hyphen-parentheses":return"("+a+")"}return"{"+a+"}"}))},e.console=function(e,r){return t(e,r,((r,t,n)=>(0===n.length||(1===n.length?e.console(i.toString(n[0])):e.console(i.toString(n))),i.voidOperation)))},e.mid=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,2,3,e,r);let a=i.toNumber(o[1]);if(isNaN(a))return"";if(a<0&&(a=0),2===o.length)return i.toString(o[0]).substr(a);let u=i.toNumber(o[2]);return isNaN(u)?"":(u<0&&(u=0),i.toString(o[0]).substr(a,u))}))},e.find=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,2,3,e,r);let a=0;if(o.length>2){if(a=i.toNumber(i.defaultUndefined(o[2],0)),isNaN(a))return-1;a<0&&(a=0)}return i.toString(o[1]).indexOf(i.toString(o[0]),a)}))},e.left=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,2,2,e,r);let a=i.toNumber(o[1]);return isNaN(a)?"":(a<0&&(a=0),i.toString(o[0]).substr(0,a))}))},e.right=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,2,2,e,r);let a=i.toNumber(o[1]);return isNaN(a)?"":(a<0&&(a=0),i.toString(o[0]).substr(-1*a,a))}))},e.split=function(e,r){return t(e,r,((t,n,o)=>{let a;i.pcCheck(o,2,4,e,r);let u=i.toNumber(i.defaultUndefined(o[2],-1));const c=i.toBoolean(i.defaultUndefined(o[3],!1));if(-1===u||null===u||!0===c?a=i.toString(o[0]).split(i.toString(o[1])):(isNaN(u)&&(u=-1),u<-1&&(u=-1),a=i.toString(o[0]).split(i.toString(o[1]),u)),!1===c)return a;const d=[];for(let e=0;e<a.length&&!(-1!==u&&d.length>=u);e++)""!==a[e]&&void 0!==a[e]&&d.push(a[e]);return d}))},e.text=function(e,r){return t(e,r,((t,n,o)=>(i.pcCheck(o,1,2,e,r),i.toStringExplicit(o[0],o[1]))))},e.concatenate=function(e,r){return t(e,r,((e,r,t)=>{const n=[];if(t.length<1)return"";if(i.isArray(t[0])){const e=i.defaultUndefined(t[2],"");for(let r=0;r<t[0].length;r++)n[r]=i.toStringExplicit(t[0][r],e);return t.length>1?n.join(t[1]):n.join("")}if(i.isImmutableArray(t[0])){const e=i.defaultUndefined(t[2],"");for(let r=0;r<t[0].length();r++)n[r]=i.toStringExplicit(t[0].get(r),e);return t.length>1?n.join(t[1]):n.join("")}for(let o=0;o<t.length;o++)n[o]=i.toStringExplicit(t[o]);return n.join("")}))},e.reverse=function(e,r){return t(e,r,((t,n,a)=>{if(i.pcCheck(a,1,1,e,r),i.isArray(a[0])){const e=a[0].slice(0);return e.reverse(),e}if(i.isImmutableArray(a[0])){const e=a[0].toArray().slice(0);return e.reverse(),e}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.replace=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,3,4,e,r);const a=i.toString(o[0]),u=i.toString(o[1]),c=i.toString(o[2]);return 4!==o.length||i.toBoolean(o[3])?i.multiReplace(a,u,c):a.replace(u,c)}))},e.schema=function(e,r){return t(e,r,((t,a,u)=>{if(i.isFeature(u[0])){const r=i.featureSchema(u[0]);return r?n.convertObjectToArcadeDictionary(r,i.defaultTimeZone(e)):null}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.subtypes=function(e,r){return t(e,r,((t,a,u)=>{if(i.pcCheck(u,1,1,e,r),i.isFeature(u[0])){const r=i.featureSubtypes(u[0]);return r?n.convertObjectToArcadeDictionary(r,i.defaultTimeZone(e)):null}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.subtypecode=function(e,r){return t(e,r,((t,n,a)=>{if(i.pcCheck(a,1,1,e,r),i.isFeature(a[0])){const e=i.featureSubtypes(a[0]);if(!e)return null;if(e.subtypeField&&a[0].hasField(e.subtypeField)){const r=a[0].field(e.subtypeField);for(const t of e.subtypes)if(t.code===r)return t.code;return null}return null}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.subtypename=function(e,r){return t(e,r,((t,n,a)=>{if(i.pcCheck(a,1,1,e,r),i.isFeature(a[0])){const e=i.featureSubtypes(a[0]);if(!e)return"";if(e.subtypeField&&a[0].hasField(e.subtypeField)){const r=a[0].field(e.subtypeField);for(const t of e.subtypes)if(t.code===r)return t.name;return""}return""}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.gdbversion=function(e,r){return t(e,r,((t,n,a)=>{if(i.pcCheck(a,1,1,e,r),i.isFeature(a[0]))return a[0].gdbVersion();throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.domain=function(e,r){return t(e,r,((t,u,c)=>{if(i.pcCheck(c,2,3,e,r),i.isFeature(c[0])){const r=i.featureFullDomain(c[0],i.toString(c[1]),void 0===c[2]?void 0:i.toNumber(c[2]));return r&&r.domain?"coded-value"===r.domain.type||"codedValue"===r.domain.type?n.convertObjectToArcadeDictionary({type:"codedValue",name:r.domain.name,dataType:a.layerFieldEsriConstants[r.field.type],codedValues:r.domain.codedValues.map((e=>({name:e.name,code:e.code})))},i.defaultTimeZone(e)):n.convertObjectToArcadeDictionary({type:"range",name:r.domain.name,dataType:a.layerFieldEsriConstants[r.field.type],min:r.domain.min,max:r.domain.max},i.defaultTimeZone(e)):null}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.domainname=function(e,r){return t(e,r,((t,n,a)=>{if(i.pcCheck(a,2,4,e,r),i.isFeature(a[0]))return i.featureDomainValueLookup(a[0],i.toString(a[1]),a[2],void 0===a[3]?void 0:i.toNumber(a[3]));throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.domaincode=function(e,r){return t(e,r,((t,n,a)=>{if(i.pcCheck(a,2,4,e,r),i.isFeature(a[0]))return i.featureDomainCodeLookup(a[0],i.toString(a[1]),a[2],void 0===a[3]?void 0:i.toNumber(a[3]));throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r)}))},e.urlencode=function(e,r){return t(e,r,((t,o,a)=>{if(i.pcCheck(a,1,1,e,r),null===a[0])return"";if(a[0]instanceof n){let e="";for(const r of a[0].keys()){const t=a[0].field(r);""!==e&&(e+="&"),e+=null===t?encodeURIComponent(r)+"=":encodeURIComponent(r)+"="+encodeURIComponent(t)}return e}return encodeURIComponent(i.toString(a[0]))}))},e.hash=function(e,r){return t(e,r,((t,n,o)=>{i.pcCheck(o,1,1,e,r);const a=new c.XXH(0);return E(o[0],a,{context:e,node:r,map:new Map,currentLength:0}),a.digest()}))},e.convertdirection=function(e,r){return t(e,r,((t,n,o)=>(i.pcCheck(o,3,3,e,r),u.convertDirection(o[0],o[1],o[2]))))},e.fromjson=function(e,r){return t(e,r,((t,a,u)=>{if(i.pcCheck(u,1,1,e,r),!1===i.isString(u[0]))throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,r);return n.convertJsonToArcade(JSON.parse(i.toString(u[0])),i.defaultTimeZone(e))}))},e.expects=function(e,r){return t(e,r,((t,n,a)=>{if(a.length<1)throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.WrongNumberOfParameters,r);return i.voidOperation}))},e.tocharcode=function(e,r){return t(e,r,((t,n,a)=>{i.pcCheck(a,1,2,e,r);const u=i.toNumber(i.defaultUndefined(a[1],0)),c=i.toString(a[0]);if(0===c.length&&1===a.length)return null;if(c.length<=u||u<0)throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.OutOfBounds,r);return c.charCodeAt(u)}))},e.tocodepoint=function(e,r){return t(e,r,((t,n,a)=>{i.pcCheck(a,1,2,e,r);const u=i.toNumber(i.defaultUndefined(a[1],0)),c=i.toString(a[0]);if(0===c.length&&1===a.length)return null;if(c.length<=u||u<0)throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.OutOfBounds,r);return c.codePointAt(u)}))},e.fromcharcode=function(e,r){return t(e,r,((t,n,a)=>{if(a.length<1)throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.WrongNumberOfParameters,r);const u=a.map((e=>Math.trunc(i.toNumber(e)))).filter((e=>e>=0&&e<=65535));return 0===u.length?null:String.fromCharCode.apply(null,u)}))},e.fromcodepoint=function(e,r){return t(e,r,((t,n,a)=>{if(a.length<1)throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.WrongNumberOfParameters,r);let u;try{u=a.map((e=>Math.trunc(i.toNumber(e)))).filter((e=>e<=1114111&&e>>>0===e))}catch(c){return null}return 0===u.length?null:String.fromCodePoint.apply(null,u)}))},e.getuser=function(e,a){return t(e,a,((t,u,c)=>{i.pcCheck(c,0,2,e,a);let d=i.defaultUndefined(c[1],"");if(d=!0===d||!1===d?"":i.toString(d),null!==d&&""!==d)return null;if(0===c.length||c[0]instanceof r){let r=null;if(e.services&&e.services.portal&&(r=e.services.portal),c.length>0){if(!m(c[0].field("url"),r))return null}if(!r)return null;if(""===d){const t=y(r);if(t){const r=JSON.parse(JSON.stringify(t));for(const e of["lastLogin","created","modified"])void 0!==r[e]&&null!==r[e]&&(r[e]=new Date(r[e]));return n.convertObjectToArcadeDictionary(r,i.defaultTimeZone(e))}}return null}throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,a)}))}}e.registerFunctions=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
