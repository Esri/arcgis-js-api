// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../polyfill/tsSupport/assign","../polyfill/tsSupport/spreadarray","../Dictionary","../Feature","../ImmutablePointArray","../languageUtils","../../geometry/Extent","../../geometry/Geometry","../../geometry/Multipoint","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","./centroid","../../geometry/jsonUtils","../executionError","../ImmutablePathArray"],(function(e,r,n,t,a,i,o,c,s,l,u,f,d,m,E,p,h,x){"use strict";function w(e){return e&&"esri.arcade.Feature"===e.arcadeDeclaredClass}Object.defineProperty(r,"__esModule",{value:!0}),r.geometryMember=r.registerFunctions=void 0,r.registerFunctions=function(e,r){e.ringisclockwise=function(e,n){return r(e,n,(function(r,t,a){c.pcCheck(a,1,1,e,n);var i=[];if(null===a[0])return!1;if(c.isArray(a[0])){for(var s=0,l=a[0];s<l.length;s++){if(!((E=l[s])instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);i.push([E.x,E.y])}i.length>0&&(a[0][0].hasZ,a[0][0].hasM)}else if(a[0]instanceof o)(i=a[0]._elements).length>0&&(a[0]._hasZ,a[0]._hasM);else{if(!c.isImmutableArray(a[0]))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);for(var u=0,m=a[0].toArray();u<m.length;u++){var E;if(!((E=m[u])instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);i.push([E.x,E.y])}i.length>0&&(a[0].get(0).hasZ,a[0].get(0).hasM)}return!(i.length<3)&&new d({rings:[],spatialReference:{wkid:4326}}).isClockwise(i)}))},e.polygon=function(e,n){return r(e,n,(function(r,t,o){c.pcCheck(o,1,1,e,n);var s=null;if(o[0]instanceof a){if((s=c.fixSpatialReference(i.parseGeometryFromDictionary(o[0]),e.spatialReference))instanceof d==!1)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}else s=o[0]instanceof d?p.fromJson(o[0].toJson()):c.fixSpatialReference(new d(JSON.parse(o[0])),e.spatialReference);if(null!==s&&!1===s.spatialReference.equals(e.spatialReference))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongSpatialReference,n);return c.fixNullGeometry(s)}))},e.polyline=function(e,n){return r(e,n,(function(r,t,o){c.pcCheck(o,1,1,e,n);var s=null;if(o[0]instanceof a){if((s=c.fixSpatialReference(i.parseGeometryFromDictionary(o[0]),e.spatialReference))instanceof m==!1)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}else s=o[0]instanceof m?p.fromJson(o[0].toJson()):c.fixSpatialReference(new m(JSON.parse(o[0])),e.spatialReference);if(null!==s&&!1===s.spatialReference.equals(e.spatialReference))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongSpatialReference,n);return c.fixNullGeometry(s)}))},e.point=function(e,n){return r(e,n,(function(r,t,o){c.pcCheck(o,1,1,e,n);var s=null;if(o[0]instanceof a){if((s=c.fixSpatialReference(i.parseGeometryFromDictionary(o[0]),e.spatialReference))instanceof f==!1)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}else s=o[0]instanceof f?p.fromJson(o[0].toJson()):c.fixSpatialReference(new f(JSON.parse(o[0])),e.spatialReference);if(null!==s&&!1===s.spatialReference.equals(e.spatialReference))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongSpatialReference,n);return c.fixNullGeometry(s)}))},e.multipoint=function(e,n){return r(e,n,(function(r,t,o){c.pcCheck(o,1,1,e,n);var s=null;if(o[0]instanceof a){if((s=c.fixSpatialReference(i.parseGeometryFromDictionary(o[0]),e.spatialReference))instanceof u==!1)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}else s=o[0]instanceof u?p.fromJson(o[0].toJson()):c.fixSpatialReference(new u(JSON.parse(o[0])),e.spatialReference);if(null!==s&&!1===s.spatialReference.equals(e.spatialReference))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongSpatialReference,n);return c.fixNullGeometry(s)}))},e.extent=function(e,n){return r(e,n,(function(r,t,o){o=c.autoCastFeatureToGeometry(o),c.pcCheck(o,1,1,e,n);var l=null;if(o[0]instanceof a)l=c.fixSpatialReference(i.parseGeometryFromDictionary(o[0]),e.spatialReference);else if(o[0]instanceof f){var E={xmin:o[0].x,ymin:o[0].y,xmax:o[0].x,ymax:o[0].y,spatialReference:o[0].spatialReference.toJson()},x=o[0];x.hasZ?(E.zmin=x.z,E.zmax=x.z):x.hasM&&(E.mmin=x.m,E.mmax=x.m),l=p.fromJson(E)}else l=o[0]instanceof d?p.fromJson(o[0].getExtent().toJson()):o[0]instanceof m?p.fromJson(o[0].getExtent().toJson()):o[0]instanceof u?p.fromJson(o[0].getExtent().toJson()):o[0]instanceof s?p.fromJson(o[0].toJson()):c.fixSpatialReference(new s(JSON.parse(o[0])),e.spatialReference);if(null!==l&&!1===l.spatialReference.equals(e.spatialReference))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongSpatialReference,n);return c.fixNullGeometry(l)}))},e.geometry=function(e,n){return r(e,n,(function(r,t,o){c.pcCheck(o,1,1,e,n);var s=null;if(null===o[0])return null;if(null!==(s=w(o[0])?c.fixSpatialReference(o[0].geometry(),e.spatialReference):o[0]instanceof a?c.fixSpatialReference(i.parseGeometryFromDictionary(o[0]),e.spatialReference):c.fixSpatialReference(p.fromJson(JSON.parse(o[0])),e.spatialReference))&&!1===s.spatialReference.equals(e.spatialReference))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongSpatialReference,n);return c.fixNullGeometry(s)}))},e.setgeometry=function(e,n){return r(e,n,(function(r,t,a){if(c.pcCheck(a,2,2,e,n),!w(a[0]))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(!0===a[0].immutable)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.Immutable,n);if(!(a[1]instanceof l||null===a[1]))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);return a[0]._geometry=a[1],c.voidOperation}))},e.feature=function(e,n){return r(e,n,(function(r,t,o){if(0===o.length)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongNumberOfParameters,n);var s=null;if(1===o.length)if(c.isString(o[0]))s=i.fromJson(JSON.parse(o[0]));else if(w(o[0]))s=i.createFromArcadeFeature(o[0]);else if(o[0]instanceof l)s=i.createFromGraphicLikeObject(o[0],null,null);else{if(!(o[0]instanceof a))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);var u=o[0].hasField("geometry")?o[0].field("geometry"):null,f=o[0].hasField("attributes")?o[0].field("attributes"):null;null!==u&&u instanceof a&&(u=i.parseGeometryFromDictionary(u)),null!==f&&(f=i.parseAttributesFromDictionary(f)),s=i.createFromGraphicLikeObject(u,f,null)}else if(2===o.length){u=null,f=null;if(null!==o[0])if(o[0]instanceof l)u=o[0];else{if(!(u instanceof a))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);u=i.parseGeometryFromDictionary(o[0])}if(null!==o[1]){if(!(o[1]instanceof a))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);f=i.parseAttributesFromDictionary(o[1])}s=i.createFromGraphicLikeObject(u,f,null)}else{u=null,f={};if(null!==o[0])if(o[0]instanceof l)u=o[0];else{if(!(u instanceof a))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);u=i.parseGeometryFromDictionary(o[0])}for(var d=1;d<o.length;d+=2){var m=c.toString(o[d]),E=o[d+1];if(!(null==E||c.isString(E)||isNaN(E)||c.isDate(E)||c.isNumber(E)||c.isBoolean(E)))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(c.isFunctionParameter(E)||!1===c.isSimpleType(E))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);E===c.voidOperation?f[m]=null:f[m]=E}s=i.createFromGraphicLikeObject(u,f,null)}return s._geometry=c.fixSpatialReference(s.geometry(),e.spatialReference),s.immutable=!1,s}))},e.dictionary=function(e,n){return r(e,n,(function(r,t,i){if(0===i.length){var o=new a;return o.immutable=!1,o}if(1===i.length&&c.isString(i[0]))try{var s=JSON.parse(i[0]),l=a.convertObjectToArcadeDictionary(s,!1);return l.immutable=!1,l}catch(r){throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}if(i.length%2!=0)throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.WrongNumberOfParameters,n);for(var u={},f=0;f<i.length;f+=2){var d=c.toString(i[f]),m=i[f+1];if(!(null==m||c.isString(m)||isNaN(m)||c.isDate(m)||c.isNumber(m)||c.isBoolean(m)||c.isArray(m)||c.isImmutableArray(m)))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(c.isFunctionParameter(m))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);m===c.voidOperation?u[d]=null:u[d]=m}var E=new a(u);return E.immutable=!1,E}))},e.haskey=function(e,n){return r(e,n,(function(r,t,i){c.pcCheck(i,2,2,e,n);var o=c.toString(i[1]);if(w(i[0]))return i[0].hasField(o);if(i[0]instanceof a)return i[0].hasField(o);if(i[0]instanceof l){var s=g(i[0],o,null,null,2);return!s||"notfound"!==s.keystate}throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}))},e.hasvalue=function(e,n){return r(e,n,(function(r,t,i){if(c.pcCheck(i,2,2,e,n),null===i[0]||null===i[1])return!1;var o=c.toString(i[1]);return c.isFeature(i[0])?!!i[0].hasField(o)&&null!==i[0].field(o):i[0]instanceof a?!!i[0].hasField(o)&&null!==i[0].field(o):i[0]instanceof l&&null!==g(i[0],o,null,null,0)}))},e.indexof=function(e,n){return r(e,n,(function(r,t,a){c.pcCheck(a,2,2,e,n);var i=a[1];if(c.isArray(a[0])){for(var o=0;o<a[0].length;o++)if(c.equalityTest(i,a[0][o]))return o;return-1}if(c.isImmutableArray(a[0])){var s=a[0].length();for(o=0;o<s;o++)if(c.equalityTest(i,a[0].get(o)))return o;return-1}throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n)}))},e.angle=function(e,n){return r(e,n,(function(r,t,a){if(a=c.autoCastFeatureToGeometry(a),c.pcCheck(a,2,3,e,n),!(a[0]instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(!(a[1]instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(a.length>2&&!(a[2]instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);return 2===a.length?E.angle2D(a[0],a[1]):E.angleBetween2D(a[0],a[1],a[2])}))},e.bearing=function(e,n){return r(e,n,(function(r,t,a){if(a=c.autoCastFeatureToGeometry(a),c.pcCheck(a,2,3,e,n),!(a[0]instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(!(a[1]instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);if(a.length>2&&!(a[2]instanceof f))throw new h.ArcadeExecutionError(e,h.ExecutionErrorCodes.InvalidParameter,n);return 2===a.length?E.bearing2D(a[0],a[1]):E.bearingBetween2D(a[0],a[1],a[2])}))},e.isselfintersecting=function(e,n){return r(e,n,(function(r,t,a){a=c.autoCastFeatureToGeometry(a),c.pcCheck(a,1,1,e,n);var i=a[0];if(i instanceof d)return i.isSelfIntersecting(i);if(i instanceof m)return i=i.paths,E.pathsSelfIntersecting(i);if(i instanceof u)for(var o=i.points,s=0;s<o.length;s++)for(var l=0;l<o.length;l++)if(l!==s){for(var f=!0,p=0;p<o[s].length;p++)if(o[s][p]!==o[l][p]){f=!1;break}if(!0===f)return!0}return!(!c.isArray(i)&&!c.isImmutableArray(i))&&(null!==(i=c.autoCastArrayOfPointsToPolyline(i,e.spatialReference))&&(i=i.paths),E.pathsSelfIntersecting(i))}))}};var y=0;function g(e,r,n,t,i){var c;switch(void 0===i&&(i=1),r=r.toLowerCase()){case"hasz":var s=e.hasZ;return void 0!==s&&s;case"hasm":var l=e.hasM;return void 0!==l&&l;case"spatialreference":var u=e.spatialReference._arcadeCacheId;if(void 0===u){var f=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(f=!1),f&&(y++,e.spatialReference._arcadeCacheId=y,u=y)}var d=new a({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==u&&(d._arcadeCacheId="SPREF"+u.toString()),d}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var m=e[r];return void 0!==m?m:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":return void 0===(c=e.getCacheValue("_arcadeCacheId"))&&(c=++y,e.setCacheValue("_arcadeCacheId",c)),new x(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,c);case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":return void 0===(c=e.getCacheValue("_arcadeCacheId"))&&(c=++y,e.setCacheValue("_arcadeCacheId",c)),new x(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,c);case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":return void 0===(c=e.getCacheValue("_arcadeCacheId"))&&(c=++y,e.setCacheValue("_arcadeCacheId",c)),new o(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,c,1);case"type":return"Multipoint"}}if(1===i)throw new h.ArcadeExecutionError(n,h.ExecutionErrorCodes.InvalidIdentifier,t);return 2===i?{keystate:"notfound"}:null}r.geometryMember=g}));