/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../ArcadePortal","../Dictionary","../executionError","../Feature","../featureSetCollection","../featureSetUtils","../ImmutableArray","../../chunks/languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../../core/promiseUtils","../../core/sql/WhereClause","../../layers/FeatureLayer","../../layers/support/Field"],(function(e,t,n,r,i,a,o,s,l,u,c,d,f,p,m,y,E,h,g,F,A,x,S,I){"use strict";function w(e,t,n,r){if(1===r.length){if(u.isArray(r[0]))return F.calculateStat(e,r[0],-1);if(u.isImmutableArray(r[0]))return F.calculateStat(e,r[0].toArray(),-1)}return F.calculateStat(e,r,-1)}function C(e,t,n){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t,n){const r=e.getVariables();if(r.length>0){const i=[];for(let e=0;e<r.length;e++){const a={name:r[e]};i.push(yield t.evaluateIdentifier(n,a))}const a={};for(let e=0;e<r.length;e++)a[r[e]]=i[e];return e.parameters=a,e}return e}))).apply(this,arguments)}function D(e,t,n=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return n}function N(e){if(null===e)return null;const t={type:D(e,"type",""),name:D(e,"name","")};if("range"===t.type)t.range=D(e,"range",[]);else{t.codedValues=[];for(const n of D(e,"codedValues",[]))t.codedValues.push({name:D(n,"name",""),code:D(n,"code",null)})}return t}function v(e){if(null===e)return null;const t={},n=D(e,"wkt",null);null!==n&&(t.wkt=n);const r=D(e,"wkid",null);return null!==r&&(t.wkid=r),t}function T(e){if(null===e)return null;const t={hasZ:D(e,"hasz",!1),hasM:D(e,"hasm",!1)},n=D(e,"spatialreference",null);n&&(t.spatialReference=v(n));const r=D(e,"x",null);if(null!==r)return t.x=r,t.y=D(e,"y",null),t;const i=D(e,"rings",null);if(null!==i)return t.rings=i,t;const a=D(e,"paths",null);if(null!==a)return t.paths=a,t;const o=D(e,"points",null);if(null!==o)return t.points=o,t;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const n=D(e,s,null);null!==n&&(t[s]=n)}return t}function $(e,t){for(const n of t)if(n===e)return!0;return!1}function L(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==$(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==u.isArray(e.layerDefinition.fields)&&!1!==u.isArray(e.featureSet.features)))))}function P(e){"async"===e.mode&&(e.functions.getuser=function(a,o){return e.standardFunctionAsync(a,o,function(){var e=t._asyncToGenerator((function*(e,t,l){u.pcCheck(l,0,2,a,o);let c=u.defaultUndefined(l[1],""),d=!0===c;if(c=!0===c||!1===c?"":u.toString(c),0===l.length||l[0]instanceof n){let e=null;a.services&&a.services.portal&&(e=a.services.portal),l.length>0&&(e=s.getPortal(l[0],e));const t=yield s.lookupUser(e,c,d);if(t){const e=JSON.parse(JSON.stringify(t));for(const t of["lastLogin","created","modified"])void 0!==e[t]&&null!==e[t]&&(e[t]=new Date(e[t]));return r.convertObjectToArcadeDictionary(e)}return null}let f=null;if(u.isFeatureSet(l[0])&&(f=l[0]),f){if(d=!1,c)return null;yield f.load();const e=yield f.getOwningSystemUrl();if(!e){if(!c){const e=yield f.getIdentityUser();return e?r.convertObjectToArcadeDictionary({username:e}):null}return null}let t=null;a.services&&a.services.portal&&(t=a.services.portal),t=s.getPortal(new n(e),t);const i=yield s.lookupUser(t,c,d);if(i){const e=JSON.parse(JSON.stringify(i));for(const t of["lastLogin","created","modified"])void 0!==e[t]&&null!==e[t]&&(e[t]=new Date(e[t]));return r.convertObjectToArcadeDictionary(e)}return null}throw new i.ArcadeExecutionError(a,i.ExecutionErrorCodes.InvalidParameter,o)}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"getuser",min:1,max:2}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,((e,r,a)=>{if(u.pcCheck(a,2,4,t,n),a[0]instanceof o){const e=u.toString(a[1]);let r=u.defaultUndefined(a[2],null);const o=u.toBoolean(u.defaultUndefined(a[3],!0));if(null===r&&(r=["*"]),!1===u.isArray(r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);return a[0].featureSetById(e,o,r)}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"featuresetbyid",min:2,max:4}),e.functions.getfeatureset=function(t,n){return e.standardFunctionAsync(t,n,((e,r,a)=>{if(u.pcCheck(a,1,2,t,n),u.isFeature(a[0])){let e=u.defaultUndefined(a[1],"datasource");return null===e&&(e="datasource"),e=u.toString(e).toLowerCase(),s.convertToFeatureSet(a[0].fullSchema(),e,t.lrucache,t.interceptor,t.spatialReference)}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"getfeatureset",min:1,max:2}),e.functions.featuresetbyportalitem=function(t,r){return e.standardFunctionAsync(t,r,((e,a,o)=>{if(u.pcCheck(o,2,5,t,r),null===o[0])throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.PortalRequired,r);if(o[0]instanceof n){const e=u.toString(o[1]),n=u.toString(o[2]);let a=u.defaultUndefined(o[3],null);const l=u.toBoolean(u.defaultUndefined(o[4],!0));if(null===a&&(a=["*"]),!1===u.isArray(a))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,r);let c=null;return t.services&&t.services.portal&&(c=t.services.portal),c=s.getPortal(o[0],c),s.constructFeatureSetFromPortalItem(e,n,t.spatialReference,a,l,c,t.lrucache,t.interceptor)}if(!1===u.isString(o[0]))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.PortalRequired,r);const l=u.toString(o[0]),c=u.toString(o[1]);let d=u.defaultUndefined(o[2],null);const f=u.toBoolean(u.defaultUndefined(o[3],!0));if(null===d&&(d=["*"]),!1===u.isArray(d))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,r);if(t.services&&t.services.portal)return s.constructFeatureSetFromPortalItem(l,c,t.spatialReference,d,f,t.services.portal,t.lrucache,t.interceptor);throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.PortalRequired,r)}))},e.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,((e,r,a)=>{if(u.pcCheck(a,2,4,t,n),a[0]instanceof o){const e=u.toString(a[1]);let r=u.defaultUndefined(a[2],null);const o=u.toBoolean(u.defaultUndefined(a[3],!0));if(null===r&&(r=["*"]),!1===u.isArray(r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);return a[0].featureSetByName(e,o,r)}throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n)}))},e.signatures.push({name:"featuresetbyname",min:2,max:4}),e.functions.featureset=function(t,n){return e.standardFunction(t,n,((e,a,o)=>{u.pcCheck(o,1,1,t,n);let s=o[0];const l={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(u.isString(s))s=JSON.parse(s),void 0!==s.layerDefinition?(l.layerDefinition=s.layerDefinition,l.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(l.featureSet.features=s.features,l.featureSet.geometryType=s.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=s.objectIdFieldName,l.layerDefinition.typeIdField=s.typeIdFieldName,l.layerDefinition.globalIdField=s.globalIdFieldName,l.layerDefinition.fields=s.fields,s.spatialReference&&(l.layerDefinition.spatialReference=s.spatialReference));else{if(!(o[0]instanceof r))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);{s=JSON.parse(o[0].castToText(!0));const e=D(s,"layerdefinition");if(null!==e){l.layerDefinition.geometryType=D(e,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.globalIdField=D(e,"globalidfield",""),l.layerDefinition.objectIdField=D(e,"objectidfield",""),l.layerDefinition.typeIdField=D(e,"typeidfield","");const t=D(e,"spatialreference",null);t&&(l.layerDefinition.spatialReference=v(t));for(const r of D(e,"fields",[])){const e={name:D(r,"name",""),alias:D(r,"alias",""),type:D(r,"type",""),nullable:D(r,"nullable",!0),editable:D(r,"editable",!0),length:D(r,"length",null),domain:N(D(r,"domain"))};l.layerDefinition.fields.push(e)}const n=D(s,"featureset",null);if(n){const e={};for(const t of l.layerDefinition.fields)e[t.name.toLowerCase()]=t.name;for(const t of D(n,"features",[])){const n={},r=D(t,"attributes",{});for(const t in r)n[e[t.toLowerCase()]]=r[t];l.featureSet.features.push({attributes:n,geometry:T(D(t,"geometry",null))})}}}else{l.layerDefinition.geometryType=D(s,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=D(s,"objectidfieldname",""),l.layerDefinition.typeIdField=D(s,"typeidfieldname","");const e=D(s,"spatialreference",null);e&&(l.layerDefinition.spatialReference=v(e));for(const n of D(s,"fields",[])){const e={name:D(n,"name",""),alias:D(n,"alias",""),type:D(n,"type",""),nullable:D(n,"nullable",!0),editable:D(n,"editable",!0),length:D(n,"length",null),domain:N(D(n,"domain"))};l.layerDefinition.fields.push(e)}const t={};for(const n of l.layerDefinition.fields)t[n.name.toLowerCase()]=n.name;for(const n of D(s,"features",[])){const e={},r=D(n,"attributes",{});for(const n in r)e[t[n.toLowerCase()]]=r[n];l.featureSet.features.push({attributes:e,geometry:T(D(n,"geometry",null))})}}}}if(!1===L(l))throw new i.ArcadeExecutionError(t,i.ExecutionErrorCodes.InvalidParameter,n);return y.create(l,t.spatialReference)}))},e.signatures.push({name:"featureset",min:1,max:1}),e.functions.filter=function(n,r){return e.standardFunctionAsync(n,r,function(){var a=t._asyncToGenerator((function*(t,a,o){if(u.pcCheck(o,2,2,n,r),u.isArray(o[0])||u.isImmutableArray(o[0])){const e=[];let t=o[0];t instanceof l&&(t=t.toArray());let a=null;if(!u.isFunctionParameter(o[1]))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r);a=o[1].createFunction(n);for(const n of t){const t=a(n);A.isPromiseLike(t)?!0===(yield t)&&e.push(n):!0===t&&e.push(n)}return e}if(u.isFeatureSet(o[0])){const t=yield o[0].load(),r=x.WhereClause.create(o[1],t.getFieldsIndex()),i=r.getVariables();if(i.length>0){const t=[];for(let r=0;r<i.length;r++){const a={name:i[r]};t.push(yield e.evaluateIdentifier(n,a))}const a={};for(let e=0;e<i.length;e++)a[i[e]]=t[e];return r.parameters=a,new d({parentfeatureset:o[0],whereclause:r})}return new d({parentfeatureset:o[0],whereclause:r})}throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r)}));return function(e,t,n){return a.apply(this,arguments)}}())},e.signatures.push({name:"filter",min:2,max:2}),e.functions.orderby=function(n,r){return e.standardFunctionAsync(n,r,function(){var e=t._asyncToGenerator((function*(e,t,a){if(u.pcCheck(a,2,2,n,r),u.isFeatureSet(a[0])){const e=new E(a[1]);return new f({parentfeatureset:a[0],orderbyclause:e})}throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r)}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"orderby",min:2,max:2}),e.functions.top=function(n,r){return e.standardFunctionAsync(n,r,function(){var e=t._asyncToGenerator((function*(e,t,a){if(u.pcCheck(a,2,2,n,r),u.isFeatureSet(a[0]))return new p({parentfeatureset:a[0],topnum:a[1]});if(u.isArray(a[0]))return u.toNumber(a[1])>=a[0].length?a[0].slice(0):a[0].slice(0,u.toNumber(a[1]));if(u.isImmutableArray(a[0]))return u.toNumber(a[1])>=a[0].length()?a[0].slice(0):a[0].slice(0,u.toNumber(a[1]));throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r)}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"top",min:2,max:2}),e.functions.first=function(n,r){return e.standardFunctionAsync(n,r,function(){var e=t._asyncToGenerator((function*(e,t,i){if(u.pcCheck(i,1,1,n,r),u.isFeatureSet(i[0])){const t=yield i[0].first(e.abortSignal);if(null!==t){const e=a.createFromGraphicLikeObject(t.geometry,t.attributes,i[0]);return e._underlyingGraphic=t,e}return t}return u.isArray(i[0])?0===i[0].length?null:i[0][0]:u.isImmutableArray(i[0])?0===i[0].length()?null:i[0].get(0):null}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"first",min:1,max:1}),e.functions.attachments=function(n,a){return e.standardFunctionAsync(n,a,function(){var e=t._asyncToGenerator((function*(e,t,o){u.pcCheck(o,1,2,n,a);const l={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(o.length>1)if(o[1]instanceof r){if(o[1].hasField("minsize")&&(l.minsize=u.toNumber(o[1].field("minsize"))),o[1].hasField("metadata")&&(l.returnMetadata=u.toBoolean(o[1].field("metadata"))),o[1].hasField("maxsize")&&(l.maxsize=u.toNumber(o[1].field("maxsize"))),o[1].hasField("types")){const e=u.toStringArray(o[1].field("types"),!1);e.length>0&&(l.types=e)}}else if(null!==o[1])throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);if(u.isFeature(o[0])){let e=o[0]._layer;return e instanceof S&&(e=s.constructFeatureSet(e,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===e?[]:!1===u.isFeatureSet(e)?[]:(yield e.load(),e.queryAttachments(o[0].field(e.objectIdField),l.minsize,l.maxsize,l.types,l.returnMetadata))}if(null===o[0])return[];throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a)}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"attachments",min:1,max:2}),e.functions.featuresetbyrelationshipname=function(n,r){return e.standardFunctionAsync(n,r,function(){var e=t._asyncToGenerator((function*(e,t,a){u.pcCheck(a,2,4,n,r);const o=a[0],l=u.toString(a[1]);let c=u.defaultUndefined(a[2],null);const d=u.toBoolean(u.defaultUndefined(a[3],!0));if(null===c&&(c=["*"]),!1===u.isArray(c))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r);if(null===a[0])return null;if(!u.isFeature(a[0]))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r);let f=o._layer;if(f instanceof S&&(f=s.constructFeatureSet(f,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===f)return null;if(!1===u.isFeatureSet(f))return null;f=yield f.load();const p=f.relationshipMetaData().filter((e=>e.name===l));if(0===p.length)return null;if(void 0!==p[0].relationshipTableId&&null!==p[0].relationshipTableId&&p[0].relationshipTableId>-1)return s.constructFeatureSetFromRelationship(f,p[0],o.field(f.objectIdField),f.spatialReference,c,d,n.lrucache,n.interceptor);let y=f.serviceUrl();if(!y)return null;y="/"===y.charAt(y.length-1)?y+p[0].relatedTableId.toString():y+"/"+p[0].relatedTableId.toString();const E=yield s.constructFeatureSetFromUrl(y,f.spatialReference,c,d,n.lrucache,n.interceptor);yield E.load();let h=E.relationshipMetaData();if(h=h.filter((e=>e.id===p[0].id)),!1===o.hasField(p[0].keyField)||null===o.field(p[0].keyField)){const e=yield f.getFeatureByObjectId(o.field(f.objectIdField),[p[0].keyField]);if(e){const t=x.WhereClause.create(h[0].keyField+"= @id",E.getFieldsIndex());return t.parameters={id:e.attributes[p[0].keyField]},E.filter(t)}return new m({parentfeatureset:E})}const g=x.WhereClause.create(h[0].keyField+"= @id",E.getFieldsIndex());return g.parameters={id:o.field(p[0].keyField)},E.filter(g)}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),e.functions.featuresetbyassociation=function(n,r){return e.standardFunctionAsync(n,r,function(){var e=t._asyncToGenerator((function*(e,t,a){u.pcCheck(a,2,3,n,r);const o=a[0],l=u.toString(u.defaultUndefined(a[1],"")).toLowerCase(),d=u.isString(a[2])?u.toString(a[2]):null;if(null===a[0])return null;if(!u.isFeature(a[0]))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r);let f=o._layer;if(f instanceof S&&(f=s.constructFeatureSet(f,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===f)return null;if(!1===u.isFeatureSet(f))return null;yield f.load();const p=f.serviceUrl(),m=yield s.constructAssociationMetaDataFeatureSetFromUrl(p,n.spatialReference);let y=null,E=null,g=!1;if(null!==d&&""!==d&&void 0!==d){for(const e of m.terminals)e.terminalName===d&&(E=e.terminalId);null===E&&(g=!0)}const F=m.associations.getFieldsIndex(),A=F.get("TOGLOBALID").name,w=F.get("FROMGLOBALID").name,C=F.get("TOTERMINALID").name,b=F.get("FROMTERMINALID").name,D=F.get("FROMNETWORKSOURCEID").name,N=F.get("TONETWORKSOURCEID").name,v=F.get("ASSOCIATIONTYPE").name,T=F.get("ISCONTENTVISIBLE").name,$=F.get("OBJECTID").name;for(const n of f.fields)if("global-id"===n.type){y=o.field(n.name);break}let L=null,P=new c.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"double"}),x.WhereClause.create("0",m.associations.getFieldsIndex())),R=new c.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"string"}),x.WhereClause.create("''",m.associations.getFieldsIndex()));const k="globalid",O="globalId",M={};for(const n in m.lkp)M[n]=m.lkp[n].sourceId;const W=new c.StringToCodeAdapted(new I({name:"classname",alias:"classname",type:"string"}),null,M);let U="";switch(l){case"midspan":{U=`((${A}='${y}') OR ( ${w}='${y}')) AND (${v} IN (5))`,W.codefield=x.WhereClause.create(`CASE WHEN (${A}='${y}') THEN ${D} ELSE ${N} END`,m.associations.getFieldsIndex());const e=h.cloneField(c.AdaptedFeatureSet.findField(m.associations.fields,w));e.name=k,e.alias=k,L=new c.SqlExpressionAdapted(e,x.WhereClause.create(`CASE WHEN (${w}='${y}') THEN ${A} ELSE ${w} END`,m.associations.getFieldsIndex())),P=m.unVersion>=4?new c.OriginalField(c.AdaptedFeatureSet.findField(m.associations.fields,F.get("PERCENTALONG").name)):new c.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"double"}),x.WhereClause.create("0",m.associations.getFieldsIndex()));break}case"junctionedge":{U=`((${A}='${y}') OR ( ${w}='${y}')) AND (${v} IN (4,6))`,W.codefield=x.WhereClause.create(`CASE WHEN (${A}='${y}') THEN ${D} ELSE ${N} END`,m.associations.getFieldsIndex());const e=h.cloneField(c.AdaptedFeatureSet.findField(m.associations.fields,w));e.name=k,e.alias=k,L=new c.SqlExpressionAdapted(e,x.WhereClause.create(`CASE WHEN (${w}='${y}') THEN ${A} ELSE ${w} END`,m.associations.getFieldsIndex())),R=new c.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"string"}),x.WhereClause.create(`CASE WHEN (${v}=4) THEN 'from' ELSE 'to' END`,m.associations.getFieldsIndex()));break}case"connected":{let e=`${A}='@T'`,t=`${w}='@T'`;null!==E&&(e+=` AND ${C}=@A`,t+=` AND ${b}=@A`),U="(("+e+") OR ("+t+"))",U=u.multiReplace(U,"@T",y??""),e=u.multiReplace(e,"@T",y??""),null!==E&&(e=u.multiReplace(e,"@A",E.toString()),U=u.multiReplace(U,"@A",E.toString())),W.codefield=x.WhereClause.create("CASE WHEN "+e+` THEN ${D} ELSE ${N} END`,m.associations.getFieldsIndex());const n=h.cloneField(c.AdaptedFeatureSet.findField(m.associations.fields,w));n.name=k,n.alias=k,L=new c.SqlExpressionAdapted(n,x.WhereClause.create("CASE WHEN "+e+` THEN ${w} ELSE ${A} END`,m.associations.getFieldsIndex()));break}case"container":U=`${A}='${y}' AND ${v} = 2`,null!==E&&(U+=` AND ${C} = `+E.toString()),W.codefield=D,U="( "+U+" )",L=new c.FieldRename(c.AdaptedFeatureSet.findField(m.associations.fields,w),k,k);case"content":U=`(${w}='${y}' AND ${v} = 2)`,null!==E&&(U+=` AND ${b} = `+E.toString()),W.codefield=N,U="( "+U+" )",L=new c.FieldRename(c.AdaptedFeatureSet.findField(m.associations.fields,A),k,k);break;case"structure":U=`(${A}='${y}' AND ${v} = 3)`,null!==E&&(U+=` AND ${C} = `+E.toString()),W.codefield=D,U="( "+U+" )",L=new c.FieldRename(c.AdaptedFeatureSet.findField(m.associations.fields,w),k,O);break;case"attached":U=`(${w}='${y}' AND ${v} = 3)`,null!==E&&(U+=` AND ${b} = `+E.toString()),W.codefield=N,U="( "+U+" )",L=new c.FieldRename(c.AdaptedFeatureSet.findField(m.associations.fields,A),k,O);break;default:throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,r)}g&&(U="1 <> 1");return new c.AdaptedFeatureSet({parentfeatureset:m.associations,adaptedFields:[new c.OriginalField(c.AdaptedFeatureSet.findField(m.associations.fields,$)),new c.OriginalField(c.AdaptedFeatureSet.findField(m.associations.fields,T)),L,R,W,P],extraFilter:U?x.WhereClause.create(U,m.associations.getFieldsIndex()):null})}));return function(t,n,r){return e.apply(this,arguments)}}())},e.signatures.push({name:"featuresetbyassociation",min:2,max:6}),e.functions.groupby=function(n,a){return e.standardFunctionAsync(n,a,function(){var o=t._asyncToGenerator((function*(t,o,s){if(u.pcCheck(s,3,3,n,a),!u.isFeatureSet(s[0]))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);const l=yield s[0].load(),c=[],d=[];let f=!1,p=[];if(u.isString(s[1]))p.push(s[1]);else if(s[1]instanceof r)p.push(s[1]);else if(u.isArray(s[1]))p=s[1];else{if(!u.isImmutableArray(s[1]))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);p=s[1].toArray()}for(const e of p)if(u.isString(e)){const t=x.WhereClause.create(u.toString(e),l.getFieldsIndex()),n=!0===g.isSingleField(t)?u.toString(e):"%%%%FIELDNAME";c.push({name:n,expression:t}),"%%%%FIELDNAME"===n&&(f=!0)}else{if(!(e instanceof r))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);{const t=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",r=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===t&&(f=!0),!t)throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);c.push({name:t,expression:x.WhereClause.create(r||t,l.getFieldsIndex())})}}if(p=[],u.isString(s[2]))p.push(s[2]);else if(u.isArray(s[2]))p=s[2];else if(u.isImmutableArray(s[2]))p=s[2].toArray();else{if(!(s[2]instanceof r))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);p.push(s[2])}for(const e of p){if(!(e instanceof r))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);{const t=e.hasField("name")?e.field("name"):"",r=e.hasField("statistic")?e.field("statistic"):"",o=e.hasField("expression")?e.field("expression"):"";if(!t||!r||!o)throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);d.push({name:t,statistic:r.toLowerCase(),expression:x.WhereClause.create(o,l.getFieldsIndex())})}}if(f){const e={};for(const n of l.fields)e[n.name.toLowerCase()]=1;for(const n of c)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);for(const n of d)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of c)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}for(const r of c)yield C(r.expression,e,n);for(const r of d)yield C(r.expression,e,n);return s[0].groupby(c,d)}));return function(e,t,n){return o.apply(this,arguments)}}())},e.signatures.push({name:"groupby",min:3,max:3}),e.functions.distinct=function(n,a){return e.standardFunctionAsync(n,a,function(){var o=t._asyncToGenerator((function*(t,o,s){if(u.isFeatureSet(s[0])){u.pcCheck(s,2,2,n,a);const t=yield s[0].load(),o=[];let l=[];if(u.isString(s[1]))l.push(s[1]);else if(s[1]instanceof r)l.push(s[1]);else if(u.isArray(s[1]))l=s[1];else{if(!u.isImmutableArray(s[1]))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);l=s[1].toArray()}let c=!1;for(const e of l)if(u.isString(e)){const n=x.WhereClause.create(u.toString(e),t.getFieldsIndex()),r=!0===g.isSingleField(n)?u.toString(e):"%%%%FIELDNAME";o.push({name:r,expression:n}),"%%%%FIELDNAME"===r&&(c=!0)}else{if(!(e instanceof r))throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",s=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(c=!0),!r)throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.InvalidParameter,a);o.push({name:r,expression:x.WhereClause.create(s||r,t.getFieldsIndex())})}}if(c){const e={};for(const r of t.fields)e[r.name.toLowerCase()]=1;for(const t of o)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let n=0;for(const t of o)if("%%%%FIELDNAME"===t.name){for(;1===e["field_"+n.toString()];)n++;e["field_"+n.toString()]=1,t.name="FIELD_"+n.toString()}}for(const r of o)yield C(r.expression,e,n);return s[0].groupby(o,[])}return w("distinct",t,o,s)}));return function(e,t,n){return o.apply(this,arguments)}}())})}e.registerFunctions=P,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
