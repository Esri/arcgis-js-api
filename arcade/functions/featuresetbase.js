// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","../polyfill/tsSupport/awaiter","../polyfill/tsSupport/generator","../polyfill/tsSupport/assign","../polyfill/tsSupport/spreadarray","../ArcadePortal","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../FunctionWrapper","../ImmutableArray","../languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../polyfill/promiseUtils","../polyfill/sql/WhereClause","../../layers/FeatureLayer","../../layers/Field"],(function(e,t,r,n,a,i,l,s,o,u,c,d,f,p,m,g,h,y,F,S,w,v,b,E,I,A,D,N){"use strict";function x(e,t,r,n){if(1===n.length){if(p.isArray(n[0]))return E.calculateStat(e,n[0],-1);if(p.isImmutableArray(n[0]))return E.calculateStat(e,n[0].toArray(),-1)}return E.calculateStat(e,n,-1)}function C(e,t,a){return r(this,void 0,void 0,(function(){var r,i,l,s,o,u,c,d;return n(this,(function(n){switch(n.label){case 0:if(!((r=e.getVariables()).length>0))return[3,5];i=[],l=0,n.label=1;case 1:return l<r.length?(s={name:r[l]},u=(o=i).push,[4,t.evaluateIdentifier(a,s)]):[3,4];case 2:u.apply(o,[n.sent()]),n.label=3;case 3:return l++,[3,1];case 4:for(c={},d=0;d<r.length;d++)c[r[d]]=i[d];return e.parameters=c,[2,e];case 5:return[2,e]}}))}))}function T(e,t,r){for(var n in void 0===r&&(r=null),e)if(n.toLowerCase()===t.toLowerCase())return e[n];return r}function L(e){if(null===e)return null;var t={type:T(e,"type",""),name:T(e,"name","")};if("range"===t.type)t.range=T(e,"range",[]);else{t.codedValues=[];for(var r=0,n=T(e,"codedValues",[]);r<n.length;r++){var a=n[r];t.codedValues.push({name:T(a,"name",""),code:T(a,"code",null)})}}return t}function R(e){if(null===e)return null;var t={},r=T(e,"wkt",null);null!==r&&(t.wkt=r);var n=T(e,"wkid",null);return null!==n&&(t.wkid=n),t}function k(e){if(null===e)return null;var t={hasZ:T(e,"hasz",!1),hasM:T(e,"hasm",!1)},r=T(e,"spatialreference",null);r&&(t.spatialReference=R(r));var n=T(e,"x",null);if(null!==n)return t.x=n,t.y=T(e,"y",null),t;var a=T(e,"rings",null);if(null!==a)return t.rings=a,t;var i=T(e,"paths",null);if(null!==i)return t.paths=i,t;var l=T(e,"points",null);if(null!==l)return t.points=l,t;for(var s=0,o=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];s<o.length;s++){var u=o[s],c=T(e,u,null);null!==c&&(t[u]=c)}return t}Object.defineProperty(t,"__esModule",{value:!0}),t.registerFunctions=void 0,t.registerFunctions=function(e){"async"===e.mode&&(e.functions.getuser=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,a,o){return r(i,void 0,void 0,(function(){var e,r,a,i,u,d,f,m,g,h,y,F,S;return n(this,(function(n){switch(n.label){case 0:return p.pcCheck(o,1,2),e=p.defaultUndefined(o[1],""),r=!0===e,e=!0===e||!1===e?"":p.toString(e),o[0]instanceof l?(m=null,t.services&&t.services.portal&&(m=t.services.portal),m=c.getPortal(o[0],m),[4,c.lookupUser(m,e,r)]):[3,2];case 1:if(g=n.sent()){for(h=JSON.parse(JSON.stringify(g)),a=0,i=["lastLogin","created","modified"];a<i.length;a++)void 0!==h[S=i[a]]&&null!==h[S]&&(h[S]=new Date(h[S]));return[2,s.convertObjectToArcadeDictionary(h)]}return[2,null];case 2:return u=null,p.isFeatureSet(o[0])&&(u=o[0]),u?(r=!1,e?[2,null]:[4,u.load()]):[3,9];case 3:return n.sent(),[4,u.getOwningSystemUrl()];case 4:return(d=n.sent())?[3,7]:e?[3,6]:[4,u.getIdentityUser()];case 5:return(f=n.sent())?[2,s.convertObjectToArcadeDictionary({username:f})]:[2,null];case 6:return[2,null];case 7:return m=null,t.services&&t.services.portal&&(m=t.services.portal),m=c.getPortal(new l(d),m),[4,c.lookupUser(m,e,r)];case 8:if(g=n.sent()){for(h=JSON.parse(JSON.stringify(g)),y=0,F=["lastLogin","created","modified"];y<F.length;y++)void 0!==h[S=F[y]]&&null!==h[S]&&(h[S]=new Date(h[S]));return[2,s.convertObjectToArcadeDictionary(h)]}return[2,null];case 9:throw new Error("Invalid Parameter")}}))}))}))},e.signatures.push({name:"getuser",min:"1",max:"2"}),e.functions.featuresetbyid=function(t,r){return e.standardFunctionAsync(t,r,(function(e,t,r){if(p.pcCheck(r,2,4),r[0]instanceof u){var n=p.toString(r[1]),a=p.defaultUndefined(r[2],null),i=p.toBoolean(p.defaultUndefined(r[3],!0));if(null===a&&(a=["*"]),!1===p.isArray(a))throw new Error("Invalid Parameter");return r[0].featureSetById(n,i,a)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.getfeatureset=function(t,r){return e.standardFunctionAsync(t,r,(function(e,r,n){if(p.pcCheck(n,1,2),p.isFeature(n[0])){var a=p.defaultUndefined(n[1],"datasource");return null===a&&(a="datasource"),a=p.toString(a).toLowerCase(),c.convertToFeatureSet(n[0].fullSchema(),a,t.lrucache,t.interceptor,t.spatialReference)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getfeatureset",min:"1",max:"2"}),e.functions.featuresetbyportalitem=function(t,r){return e.standardFunctionAsync(t,r,(function(e,r,n){if(p.pcCheck(n,2,5),null===n[0])throw new Error("Portal is required");if(n[0]instanceof l){var a=p.toString(n[1]),i=p.toString(n[2]),s=p.defaultUndefined(n[3],null),o=p.toBoolean(p.defaultUndefined(n[4],!0));if(null===s&&(s=["*"]),!1===p.isArray(s))throw new Error("Invalid Parameter");var u=null;return t.services&&t.services.portal&&(u=t.services.portal),u=c.getPortal(n[0],u),c.constructFeatureSetFromPortalItem(a,i,t.spatialReference,s,o,u,t.lrucache,t.interceptor)}if(!1===p.isString(n[0]))throw new Error("Portal is required");var d=p.toString(n[0]),f=p.toString(n[1]),m=p.defaultUndefined(n[2],null),g=p.toBoolean(p.defaultUndefined(n[3],!0));if(null===m&&(m=["*"]),!1===p.isArray(m))throw new Error("Invalid Parameter");if(t.services&&t.services.portal)return c.constructFeatureSetFromPortalItem(d,f,t.spatialReference,m,g,t.services.portal,t.lrucache,t.interceptor);throw new Error("Portal is required")}))},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(t,r){return e.standardFunctionAsync(t,r,(function(e,t,r){if(p.pcCheck(r,2,4),r[0]instanceof u){var n=p.toString(r[1]),a=p.defaultUndefined(r[2],null),i=p.toBoolean(p.defaultUndefined(r[3],!0));if(null===a&&(a=["*"]),!1===p.isArray(a))throw new Error("Invalid Parameter");return r[0].featureSetByName(n,i,a)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(t,r){return e.standardFunction(t,r,(function(e,r,n){p.pcCheck(n,1,1);var a,i=n[0],l={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(p.isString(i))void 0!==(i=JSON.parse(i)).layerDefinition?(l.layerDefinition=i.layerDefinition,l.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(l.featureSet.features=i.features,l.featureSet.geometryType=i.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=i.objectIdFieldName,l.layerDefinition.typeIdField=i.typeIdFieldName,l.layerDefinition.globalIdField=i.globalIdFieldName,l.layerDefinition.fields=i.fields,i.spatialReference&&(l.layerDefinition.spatialReference=i.spatialReference));else{if(!(n[0]instanceof s))throw new Error("Invalid Parameter");var o=T(i=JSON.parse(n[0].castToText()),"layerdefinition");if(null!==o){l.layerDefinition.geometryType=T(o,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.globalIdField=T(o,"globalidfield",""),l.layerDefinition.objectIdField=T(o,"objectidfield",""),l.layerDefinition.typeIdField=T(o,"typeidfield",""),(E=T(o,"spatialreference",null))&&(l.layerDefinition.spatialReference=R(E));for(var u=0,c=T(o,"fields",[]);u<c.length;u++){var d={name:T(D=c[u],"name",""),alias:T(D,"alias",""),type:T(D,"type",""),nullable:T(D,"nullable",!0),editable:T(D,"editable",!0),length:T(D,"length",null),domain:L(T(D,"domain"))};l.layerDefinition.fields.push(d)}var f=T(i,"featureset",null);if(f){for(var m={},g=0,h=l.layerDefinition.fields;g<h.length;g++){m[(b=h[g]).name.toLowerCase()]=b.name}for(var y=0,F=T(f,"features",[]);y<F.length;y++){var w={},v=T(P=F[y],"attributes",{});for(var b in v)w[m[b.toLowerCase()]]=v[b];l.featureSet.features.push({attributes:w,geometry:k(T(P,"geometry",null))})}}}else{var E;l.layerDefinition.geometryType=T(i,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=T(i,"objectidfieldname",""),l.layerDefinition.typeIdField=T(i,"typeidfieldname",""),(E=T(i,"spatialreference",null))&&(l.layerDefinition.spatialReference=R(E));for(var I=0,A=T(i,"fields",[]);I<A.length;I++){var D;d={name:T(D=A[I],"name",""),alias:T(D,"alias",""),type:T(D,"type",""),nullable:T(D,"nullable",!0),editable:T(D,"editable",!0),length:T(D,"length",null),domain:L(T(D,"domain"))};l.layerDefinition.fields.push(d)}m={};for(var N=0,x=l.layerDefinition.fields;N<x.length;N++){m[(b=x[N]).name.toLowerCase()]=b.name}for(var C=0,O=T(i,"features",[]);C<O.length;C++){var P;w={},v=T(P=O[C],"attributes",{});for(var b in v)w[m[b.toLowerCase()]]=v[b];l.featureSet.features.push({attributes:w,geometry:k(T(P,"geometry",null))})}}}if(!1==(!!(a=l).layerDefinition&&!!a.featureSet&&!1!==function(e,t){for(var r=0,n=t;r<n.length;r++)if(n[r]===e)return!0;return!1}(a.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&null!==a.layerDefinition.objectIdField&&""!==a.layerDefinition.objectIdField&&!1!==p.isArray(a.layerDefinition.fields)&&!1!==p.isArray(a.featureSet.features)))throw new Error("Invalid Parameter");return S.create(l,t.spatialReference)}))},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(a,l,s){return r(i,void 0,void 0,(function(){var r,a,i,l,o,u,c,m,h,y,F,S,w,v,b,E,D;return n(this,(function(n){switch(n.label){case 0:if(p.pcCheck(s,2,2),!p.isArray(s[0])&&!p.isImmutableArray(s[0]))return[3,6];if(r=[],(a=s[0])instanceof f&&(a=a.toArray()),i=null,s[1]instanceof d)i=e.arcadeCustomFunctionHandler(s[1]);else if(s[1]instanceof p.NativeFunction)i=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return s[1].fn(t,{preparsed:!0,arguments:e})};else{if(!(s[1]instanceof p.SizzleFunction))throw new Error("Invalid Parameter");i=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(t.length!==s[1].paramCount)throw new Error("Invalid parameters");return(e=s[1]).fn.apply(e,t)}}l=0,o=a,n.label=1;case 1:return l<o.length?(u=o[l],c=i(u),I.isPromiseLike(c)?[4,c]:[3,3]):[3,5];case 2:return!0===n.sent()&&r.push(u),[3,4];case 3:!0===c&&r.push(u),n.label=4;case 4:return l++,[3,1];case 5:return[2,r];case 6:return p.isFeatureSet(s[0])?[4,s[0].load()]:[3,13];case 7:if(m=n.sent(),h=A.WhereClause.create(s[1],m.getFieldsIndex()),!((y=h.getVariables()).length>0))return[3,12];F=[],S=0,n.label=8;case 8:return S<y.length?(w={name:y[S]},b=(v=F).push,[4,e.evaluateIdentifier(t,w)]):[3,11];case 9:b.apply(v,[n.sent()]),n.label=10;case 10:return S++,[3,8];case 11:for(E={},D=0;D<y.length;D++)E[y[D]]=F[D];return h.parameters=E,[2,new g({parentfeatureset:s[0],whereclause:h})];case 12:return[2,new g({parentfeatureset:s[0],whereclause:h})];case 13:throw new Error("Filter cannot accept this parameter type")}}))}))}))},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,t,a){return r(i,void 0,void 0,(function(){var e;return n(this,(function(t){if(p.pcCheck(a,2,2),p.isFeatureSet(a[0]))return e=new w(a[1]),[2,new h({parentfeatureset:a[0],orderbyclause:e})];throw new Error("Order cannot accept this parameter type")}))}))}))},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,t,a){return r(i,void 0,void 0,(function(){return n(this,(function(e){if(p.pcCheck(a,2,2),p.isFeatureSet(a[0]))return[2,new y({parentfeatureset:a[0],topnum:a[1]})];if(p.isArray(a[0]))return p.toNumber(a[1])>=a[0].length?[2,a[0].slice(0)]:[2,a[0].slice(0,p.toNumber(a[1]))];if(p.isImmutableArray(a[0]))return p.toNumber(a[1])>=a[0].length()?[2,a[0].slice(0)]:[2,a[0].slice(0,p.toNumber(a[1]))];throw new Error("Top cannot accept this parameter type")}))}))}))},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,t,a){return r(i,void 0,void 0,(function(){var t,r;return n(this,(function(n){switch(n.label){case 0:return p.pcCheck(a,1,1),p.isFeatureSet(a[0])?[4,a[0].first(e.abortSignal)]:[3,2];case 1:return null!==(t=n.sent())?((r=o.createFromGraphicLikeObject(t.geometry,t.attributes,a[0]))._underlyingGraphic=t,[2,r]):[2,t];case 2:return p.isArray(a[0])?0===a[0].length?[2,null]:[2,a[0][0]]:p.isImmutableArray(a[0])?0===a[0].length()?[2,null]:[2,a[0].get(0)]:[2,null]}}))}))}))},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,a,l){return r(i,void 0,void 0,(function(){var e,r,a;return n(this,(function(n){switch(n.label){case 0:if(p.pcCheck(l,1,2),e={minsize:-1,maxsize:-1,types:null,returnMetadata:!1},l.length>1)if(l[1]instanceof s)l[1].hasField("minsize")&&(e.minsize=p.toNumber(l[1].field("minsize"))),l[1].hasField("metadata")&&(e.returnMetadata=p.toBoolean(l[1].field("metadata"))),l[1].hasField("maxsize")&&(e.maxsize=p.toNumber(l[1].field("maxsize"))),l[1].hasField("types")&&(r=p.toStringArray(l[1].field("types"),!1)).length>0&&(e.types=r);else if(null!==l[1])throw new Error("Invalid Parameter");return p.isFeature(l[0])?((a=l[0]._layer)instanceof D&&(a=c.constructFeatureSet(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===a?[2,[]]:!1===p.isFeatureSet(a)?[2,[]]:[4,a.load()]):[3,2];case 1:return n.sent(),[2,a.queryAttachments(l[0].field(a.objectIdField),e.minsize,e.maxsize,e.types,e.returnMetadata)];case 2:if(null===l[0])return[2,[]];throw new Error("Invalid Parameter")}}))}))}))},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,a,l){return r(i,void 0,void 0,(function(){var e,r,a,i,s,o,u,d,f,m,g,h,y;return n(this,(function(n){switch(n.label){case 0:if(p.pcCheck(l,2,4),e=l[0],r=p.toString(l[1]),a=p.defaultUndefined(l[2],null),i=p.toBoolean(p.defaultUndefined(l[3],!0)),null===a&&(a=["*"]),!1===p.isArray(a))throw new Error("Invalid Parameter");if(null===l[0])return[2,null];if(!p.isFeature(l[0]))throw new Error("Invalid Parameter");return(s=e._layer)instanceof D&&(s=c.constructFeatureSet(s,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===s?[2,null]:!1===p.isFeatureSet(s)?[2,null]:[4,s.load()];case 1:return s=n.sent(),o=s.relationshipMetaData(),0===(u=o.filter((function(e){return e.name===r}))).length?[2,null]:void 0!==u[0].relationshipTableId&&null!==u[0].relationshipTableId&&u[0].relationshipTableId>-1?[2,c.constructFeatureSetFromRelationship(s,u[0],e.field(s.objectIdField),s.spatialReference,a,i,t.lrucache,t.interceptor)]:(d=s.serviceUrl())?(d="/"===d.charAt(d.length-1)?d+u[0].relatedTableId.toString():d+"/"+u[0].relatedTableId.toString(),[4,c.constructFeatureSetFromUrl(d,s.spatialReference,a,i,t.lrucache,t.interceptor)]):[2,null];case 2:return[4,(f=n.sent()).load()];case 3:return n.sent(),m=(m=f.relationshipMetaData()).filter((function(e){return e.id===u[0].id})),!1!==e.hasField(u[0].keyField)&&null!==e.field(u[0].keyField)?[3,5]:[4,s.getFeatureByObjectId(e.field(s.objectIdField),[u[0].keyField])];case 4:return(g=n.sent())?((h=A.WhereClause.create(m[0].keyField+"= @id",f.getFieldsIndex())).parameters={id:g.attributes[u[0].keyField]},[2,f.filter(h)]):[2,new F({parentfeatureset:f})];case 5:return(y=A.WhereClause.create(m[0].keyField+"= @id",f.getFieldsIndex())).parameters={id:e.field(u[0].keyField)},[2,f.filter(y)]}}))}))}))},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(e,a,l){return r(i,void 0,void 0,(function(){var e,r,a,i,s,o,u,d,f,g,h,y,F,S,w,b,E,I,x,C,T,L,R,k,O,P,W,M,U,B,G,j,V,z,H,q,_;return n(this,(function(n){switch(n.label){case 0:if(p.pcCheck(l,2,3),e=l[0],r=p.toString(p.defaultUndefined(l[1],"")).toLowerCase(),a=p.isString(l[2])?p.toString(l[2]):null,null===l[0])return[2,null];if(!p.isFeature(l[0]))throw new Error("Invalid Parameter");return(i=e._layer)instanceof D&&(i=c.constructFeatureSet(i,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===i?[2,null]:!1===p.isFeatureSet(i)?[2,null]:[4,i.load()];case 1:return n.sent(),s=i.serviceUrl(),[4,c.constructAssociationMetaDataFeatureSetFromUrl(s,t.spatialReference)];case 2:if(o=n.sent(),u=null,d=null,f=!1,null!==a&&""!==a&&void 0!==a){for(g=0,h=o.terminals;g<h.length;g++)(y=h[g]).terminalName===a&&(d=y.terminalId);null===d&&(f=!0)}for(F=o.associations.getFieldsIndex(),S=F.get("TOGLOBALID").name,w=F.get("FROMGLOBALID").name,b=F.get("TOTERMINALID").name,E=F.get("FROMTERMINALID").name,I=F.get("FROMNETWORKSOURCEID").name,x=F.get("TONETWORKSOURCEID").name,C=F.get("ASSOCIATIONTYPE").name,T=F.get("ISCONTENTVISIBLE").name,L=F.get("OBJECTID").name,R=0,k=i.fields;R<k.length;R++)if("esriFieldTypeGlobalID"===(O=k[R]).type){u=e.field(O.name);break}for(B in P=null,W=new m.SqlExpressionAdapted(new N({name:"percentalong",alias:"percentalong",type:"esrFieldTypeDouble"}),A.WhereClause.create("0",o.associations.getFieldsIndex())),M=new m.SqlExpressionAdapted(new N({name:"side",alias:"side",type:"esrFieldTypeString"}),A.WhereClause.create("''",o.associations.getFieldsIndex())),"globalid","globalId",U={},o.lkp)U[B]=o.lkp[B].sourceId;switch(G=new m.StringToCodeAdapted(new N({name:"classname",alias:"classname",type:"esriFieldTypeString"}),null,U),j="",r){case"midspan":j="(("+S+"='"+u+"') OR ( "+w+"='"+u+"')) AND ("+C+" IN (5))",G.codefield=A.WhereClause.create("CASE WHEN ("+S+"='"+u+"') THEN "+I+" ELSE "+x+" END",o.associations.getFieldsIndex()),(V=v.cloneField(m.AdaptedFeatureSet.findField(o.associations.fields,w))).name="globalid",V.alias="globalid",P=new m.SqlExpressionAdapted(V,A.WhereClause.create("CASE WHEN ("+w+"='"+u+"') THEN "+S+" ELSE "+w+" END",o.associations.getFieldsIndex())),W=o.unVersion>=4?new m.OriginalField(m.AdaptedFeatureSet.findField(o.associations.fields,F.get("PERCENTALONG").name)):new m.SqlExpressionAdapted(new N({name:"percentalong",alias:"percentalong",type:"esrFieldTypeDouble"}),A.WhereClause.create("0",o.associations.getFieldsIndex()));break;case"junctionedge":j="(("+S+"='"+u+"') OR ( "+w+"='"+u+"')) AND ("+C+" IN (4,6))",G.codefield=A.WhereClause.create("CASE WHEN ("+S+"='"+u+"') THEN "+I+" ELSE "+x+" END",o.associations.getFieldsIndex()),(z=v.cloneField(m.AdaptedFeatureSet.findField(o.associations.fields,w))).name="globalid",z.alias="globalid",P=new m.SqlExpressionAdapted(z,A.WhereClause.create("CASE WHEN ("+w+"='"+u+"') THEN "+S+" ELSE "+w+" END",o.associations.getFieldsIndex())),M=new m.SqlExpressionAdapted(new N({name:"side",alias:"side",type:"esrFieldTypeString"}),A.WhereClause.create("CASE WHEN ("+C+"=4) THEN 'from' ELSE 'to' END",o.associations.getFieldsIndex()));break;case"connected":H=S+"='@T'",q=w+"='@T'",null!==d&&(H+=" AND "+b+"=@A",q+=" AND "+E+"=@A"),j="(("+H+") OR ("+q+"))",j=p.multiReplace(j,"@T",u),H=p.multiReplace(H,"@T",u),null!==d&&(H=p.multiReplace(H,"@A",d.toString()),j=p.multiReplace(j,"@A",d.toString())),G.codefield=A.WhereClause.create("CASE WHEN "+H+" THEN "+I+" ELSE "+x+" END",o.associations.getFieldsIndex()),(_=v.cloneField(m.AdaptedFeatureSet.findField(o.associations.fields,w))).name="globalid",_.alias="globalid",P=new m.SqlExpressionAdapted(_,A.WhereClause.create("CASE WHEN "+H+" THEN "+w+" ELSE "+S+" END",o.associations.getFieldsIndex()));break;case"container":j=S+"='"+u+"' AND "+C+" = 2",null!==d&&(j+=" AND "+b+" = "+d.toString()),G.codefield=I,j="( "+j+" )",P=new m.FieldRename(m.AdaptedFeatureSet.findField(o.associations.fields,w),"globalid","globalid");case"content":j="("+w+"='"+u+"' AND "+C+" = 2)",null!==d&&(j+=" AND "+E+" = "+d.toString()),G.codefield=x,j="( "+j+" )",P=new m.FieldRename(m.AdaptedFeatureSet.findField(o.associations.fields,S),"globalid","globalid");break;case"structure":j="("+S+"='"+u+"' AND "+C+" = 3)",null!==d&&(j+=" AND "+b+" = "+d.toString()),G.codefield=I,j="( "+j+" )",P=new m.FieldRename(m.AdaptedFeatureSet.findField(o.associations.fields,w),"globalid","globalId");break;case"attached":j="("+w+"='"+u+"' AND "+C+" = 3)",null!==d&&(j+=" AND "+E+" = "+d.toString()),G.codefield=x,j="( "+j+" )",P=new m.FieldRename(m.AdaptedFeatureSet.findField(o.associations.fields,S),"globalid","globalId");break;default:throw new Error("Invalid Parameter")}return f&&(j="1 <> 1"),[2,new m.AdaptedFeatureSet({parentfeatureset:o.associations,adaptedFields:[new m.OriginalField(m.AdaptedFeatureSet.findField(o.associations.fields,L)),new m.OriginalField(m.AdaptedFeatureSet.findField(o.associations.fields,T)),P,M,G,W],extraFilter:j?A.WhereClause.create(j,o.associations.getFieldsIndex()):null})]}}))}))}))},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(a,l,o){return r(i,void 0,void 0,(function(){var r,a,i,l,u,c,d,f,m,g,h,y,F,S,w,v,E,I,D,N,x,T,L,R,k,O,P,W,M,U;return n(this,(function(n){switch(n.label){case 0:if(p.pcCheck(o,3,3),!p.isFeatureSet(o[0]))throw new Error("Illegal Value: GroupBy");return[4,o[0].load()];case 1:if(r=n.sent(),a=[],i=[],l=!1,u=[],p.isString(o[1]))u.push(o[1]);else if(o[1]instanceof s)u.push(o[1]);else if(p.isArray(o[1]))u=o[1];else{if(!p.isImmutableArray(o[1]))throw new Error("Illegal Value: GroupBy");u=o[1].toArray()}for(c=0,d=u;c<d.length;c++)if(y=d[c],p.isString(y))w=A.WhereClause.create(p.toString(y),r.getFieldsIndex()),f=!0===b.isSingleField(w)?p.toString(y):"%%%%FIELDNAME",a.push({name:f,expression:w}),"%%%%FIELDNAME"===f&&(l=!0);else{if(!(y instanceof s))throw new Error("Illegal Value: GroupBy");if(m=y.hasField("name")?y.field("name"):"%%%%FIELDNAME",w=y.hasField("expression")?y.field("expression"):"","%%%%FIELDNAME"===m&&(l=!0),!m)throw new Error("Illegal Value: GroupBy");a.push({name:m,expression:A.WhereClause.create(w||m,r.getFieldsIndex())})}if(u=[],p.isString(o[2]))u.push(o[2]);else if(p.isArray(o[2]))u=o[2];else if(p.isImmutableArray(o[2]))u=o[2].toArray();else{if(!(o[2]instanceof s))throw new Error("Illegal Value: GroupBy");u.push(o[2])}for(g=0,h=u;g<h.length;g++){if(!((y=h[g])instanceof s))throw new Error("Illegal Value: GroupBy");if(F=y.hasField("name")?y.field("name"):"",S=y.hasField("statistic")?y.field("statistic"):"",w=y.hasField("expression")?y.field("expression"):"",!F||!S||!w)throw new Error("Illegal Value: GroupBy");i.push({name:F,statistic:S.toLowerCase(),expression:A.WhereClause.create(w,r.getFieldsIndex())})}if(l){for(v={},E=0,I=r.fields;E<I.length;E++)O=I[E],v[O.name.toLowerCase()]=1;for(D=0,N=a;D<N.length;D++)"%%%%FIELDNAME"!==(O=N[D]).name&&(v[O.name.toLowerCase()]=1);for(x=0,T=i;x<T.length;x++)"%%%%FIELDNAME"!==(O=T[x]).name&&(v[O.name.toLowerCase()]=1);for(L=0,R=0,k=a;R<k.length;R++)if("%%%%FIELDNAME"===(O=k[R]).name){for(;1===v["field_"+L.toString()];)L++;v["field_"+L.toString()]=1,O.name="FIELD_"+L.toString()}}P=0,W=a,n.label=2;case 2:return P<W.length?[4,C(W[P].expression,e,t)]:[3,5];case 3:n.sent(),n.label=4;case 4:return P++,[3,2];case 5:M=0,U=i,n.label=6;case 6:return M<U.length?[4,C(U[M].expression,e,t)]:[3,9];case 7:n.sent(),n.label=8;case 8:return M++,[3,6];case 9:return[2,o[0].groupby(a,i)]}}))}))}))},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(t,a){var i=this;return e.standardFunctionAsync(t,a,(function(a,l,o){return r(i,void 0,void 0,(function(){var r,a,i,l,u,c,d,f,m,g,h,y,F,S,w,v,E,I,D,N,T;return n(this,(function(n){switch(n.label){case 0:return p.isFeatureSet(o[0])?(p.pcCheck(o,2,2),[4,o[0].load()]):[3,6];case 1:if(r=n.sent(),a=[],i=[],p.isString(o[1]))i.push(o[1]);else if(o[1]instanceof s)i.push(o[1]);else if(p.isArray(o[1]))i=o[1];else{if(!p.isImmutableArray(o[1]))throw new Error("Illegal Value: GroupBy");i=o[1].toArray()}for(l=!1,u=0,c=i;u<c.length;u++)if(d=c[u],p.isString(d))g=A.WhereClause.create(p.toString(d),r.getFieldsIndex()),f=!0===b.isSingleField(g)?p.toString(d):"%%%%FIELDNAME",a.push({name:f,expression:g}),"%%%%FIELDNAME"===f&&(l=!0);else{if(!(d instanceof s))throw new Error("Illegal Value: GroupBy");if(m=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",g=d.hasField("expression")?d.field("expression"):"","%%%%FIELDNAME"===m&&(l=!0),!m)throw new Error("Illegal Value: GroupBy");a.push({name:m,expression:A.WhereClause.create(g||m,r.getFieldsIndex())})}if(l){for(h={},y=0,F=r.fields;y<F.length;y++)D=F[y],h[D.name.toLowerCase()]=1;for(S=0,w=a;S<w.length;S++)"%%%%FIELDNAME"!==(D=w[S]).name&&(h[D.name.toLowerCase()]=1);for(v=0,E=0,I=a;E<I.length;E++)if("%%%%FIELDNAME"===(D=I[E]).name){for(;1===h["field_"+v.toString()];)v++;h["field_"+v.toString()]=1,D.name="FIELD_"+v.toString()}}N=0,T=a,n.label=2;case 2:return N<T.length?[4,C(T[N].expression,e,t)]:[3,5];case 3:n.sent(),n.label=4;case 4:return N++,[3,2];case 5:return[2,o[0].groupby(a,[])];case 6:return[2,x("distinct",0,0,o)]}}))}))}))})}}));