/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../ArcadePortal","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../FunctionWrapper","../ImmutableArray","../../chunks/languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../../core/promiseUtils","../../core/sql/WhereClause","../../layers/FeatureLayer","../../layers/support/Field"],(function(e,t,n,r,a,i,l,s,o,u,f,c,d,p,m,y,g,h,F,S,I,A,E){"use strict";function D(e,t,n,r){if(1===r.length){if(o.isArray(r[0]))return F.calculateStat(e,r[0],-1);if(o.isImmutableArray(r[0]))return F.calculateStat(e,r[0].toArray(),-1)}return F.calculateStat(e,r,-1)}function w(e,t,n){const r=e.getVariables();if(r.length>0){const a=[];for(let e=0;e<r.length;e++){const i={name:r[e]};a.push(t.evaluateIdentifier(n,i))}return S.all(a).then((t=>{const n={};for(let e=0;e<r.length;e++)n[r[e]]=t[e];return e.parameters=n,e}))}return S.resolve(e)}function b(e,t,n=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return n}function N(e){if(null===e)return null;const t={type:b(e,"type",""),name:b(e,"name","")};if("range"===t.type)t.range=b(e,"range",[]);else{t.codedValues=[];for(const n of b(e,"codedValues",[]))t.codedValues.push({name:b(n,"name",""),code:b(n,"code",null)})}return t}function x(e){if(null===e)return null;const t={},n=b(e,"wkt",null);null!==n&&(t.wkt=n);const r=b(e,"wkid",null);return null!==r&&(t.wkid=r),t}function C(e){if(null===e)return null;const t={hasZ:b(e,"hasz",!1),hasM:b(e,"hasm",!1)},n=b(e,"spatialreference",null);n&&(t.spatialReference=x(n));const r=b(e,"x",null);if(null!==r)return t.x=r,t.y=b(e,"y",null),t;const a=b(e,"rings",null);if(null!==a)return t.rings=a,t;const i=b(e,"paths",null);if(null!==i)return t.paths=i,t;const l=b(e,"points",null);if(null!==l)return t.points=l,t;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const n=b(e,s,null);null!==n&&(t[s]=n)}return t}function v(e,t){for(const n of t)if(n===e)return!0;return!1}function T(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==v(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==o.isArray(e.layerDefinition.fields)&&!1!==o.isArray(e.featureSet.features)))))}function $(e){"async"===e.mode&&(e.functions.getuser=function(r,a){return e.standardFunctionAsync(r,a,((e,a,l)=>{o.pcCheck(l,1,2);let s=o.defaultUndefined(l[1],""),u=!0===s;if(s=!0===s||!1===s?"":o.toString(s),l[0]instanceof t){let e=null;return r.services&&r.services.portal&&(e=r.services.portal),e=i.getPortal(l[0],e),i.lookupUser(e,s,u).then((e=>{if(e){const t=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return n.convertObjectToArcadeDictionary(t)}return null}))}let f=null;if(o.isFeatureSet(l[0])&&(f=l[0]),f)return u=!1,s?null:f.load().then((()=>f.getOwningSystemUrl())).then((e=>{if(!e)return s?null:f.getIdentityUser().then((e=>e?n.convertObjectToArcadeDictionary({username:e}):null));let a=null;return r.services&&r.services.portal&&(a=r.services.portal),a=i.getPortal(new t(e),a),i.lookupUser(a,s,u).then((e=>{if(e){const t=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return n.convertObjectToArcadeDictionary(t)}return null}))}));throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getuser",min:"1",max:"2"}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,((e,t,n)=>{if(o.pcCheck(n,2,4),n[0]instanceof a){const e=o.toString(n[1]);let t=o.defaultUndefined(n[2],null);const r=o.toBoolean(o.defaultUndefined(n[3],!0));if(null===t&&(t=["*"]),!1===o.isArray(t))throw new Error("Invalid Parameter");return n[0].featureSetById(e,r,t)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.getfeatureset=function(t,n){return e.standardFunctionAsync(t,n,((e,n,r)=>{if(o.pcCheck(r,1,2),o.isFeature(r[0])){let e=o.defaultUndefined(r[1],"datasource");return null===e&&(e="datasource"),e=o.toString(e).toLowerCase(),i.convertToFeatureSet(r[0].fullSchema(),e,t.lrucache,t.interceptor,t.spatialReference)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getfeatureset",min:"1",max:"2"}),e.functions.featuresetbyportalitem=function(n,r){return e.standardFunctionAsync(n,r,((e,r,a)=>{if(o.pcCheck(a,2,5),null===a[0])throw new Error("Portal is required");if(a[0]instanceof t){const e=o.toString(a[1]),t=o.toString(a[2]);let r=o.defaultUndefined(a[3],null);const l=o.toBoolean(o.defaultUndefined(a[4],!0));if(null===r&&(r=["*"]),!1===o.isArray(r))throw new Error("Invalid Parameter");let s=null;return n.services&&n.services.portal&&(s=n.services.portal),s=i.getPortal(a[0],s),i.constructFeatureSetFromPortalItem(e,t,n.spatialReference,r,l,s,n.lrucache,n.interceptor)}if(!1===o.isString(a[0]))throw new Error("Portal is required");const l=o.toString(a[0]),s=o.toString(a[1]);let u=o.defaultUndefined(a[2],null);const f=o.toBoolean(o.defaultUndefined(a[3],!0));if(null===u&&(u=["*"]),!1===o.isArray(u))throw new Error("Invalid Parameter");if(n.services&&n.services.portal)return i.constructFeatureSetFromPortalItem(l,s,n.spatialReference,u,f,n.services.portal,n.lrucache,n.interceptor);throw new Error("Portal is required")}))},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,((e,t,n)=>{if(o.pcCheck(n,2,4),n[0]instanceof a){const e=o.toString(n[1]);let t=o.defaultUndefined(n[2],null);const r=o.toBoolean(o.defaultUndefined(n[3],!0));if(null===t&&(t=["*"]),!1===o.isArray(t))throw new Error("Invalid Parameter");return n[0].featureSetByName(e,r,t)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(t,r){return e.standardFunction(t,r,((e,r,a)=>{o.pcCheck(a,1,1);let i=a[0];const l={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(o.isString(i))i=JSON.parse(i),void 0!==i.layerDefinition?(l.layerDefinition=i.layerDefinition,l.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(l.featureSet.features=i.features,l.featureSet.geometryType=i.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=i.objectIdFieldName,l.layerDefinition.typeIdField=i.typeIdFieldName,l.layerDefinition.globalIdField=i.globalIdFieldName,l.layerDefinition.fields=i.fields,i.spatialReference&&(l.layerDefinition.spatialReference=i.spatialReference));else{if(!(a[0]instanceof n))throw new Error("Invalid Parameter");{i=JSON.parse(a[0].castToText());const e=b(i,"layerdefinition");if(null!==e){l.layerDefinition.geometryType=b(e,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.globalIdField=b(e,"globalidfield",""),l.layerDefinition.objectIdField=b(e,"objectidfield",""),l.layerDefinition.typeIdField=b(e,"typeidfield","");const t=b(e,"spatialreference",null);t&&(l.layerDefinition.spatialReference=x(t));for(const r of b(e,"fields",[])){const e={name:b(r,"name",""),alias:b(r,"alias",""),type:b(r,"type",""),nullable:b(r,"nullable",!0),editable:b(r,"editable",!0),length:b(r,"length",null),domain:N(b(r,"domain"))};l.layerDefinition.fields.push(e)}const n=b(i,"featureset",null);if(n){const e={};for(const t of l.layerDefinition.fields)e[t.name.toLowerCase()]=t.name;for(const t of b(n,"features",[])){const n={},r=b(t,"attributes",{});for(const t in r)n[e[t.toLowerCase()]]=r[t];l.featureSet.features.push({attributes:n,geometry:C(b(t,"geometry",null))})}}}else{l.layerDefinition.geometryType=b(i,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=b(i,"objectidfieldname",""),l.layerDefinition.typeIdField=b(i,"typeidfieldname","");const e=b(i,"spatialreference",null);e&&(l.layerDefinition.spatialReference=x(e));for(const n of b(i,"fields",[])){const e={name:b(n,"name",""),alias:b(n,"alias",""),type:b(n,"type",""),nullable:b(n,"nullable",!0),editable:b(n,"editable",!0),length:b(n,"length",null),domain:N(b(n,"domain"))};l.layerDefinition.fields.push(e)}const t={};for(const n of l.layerDefinition.fields)t[n.name.toLowerCase()]=n.name;for(const n of b(i,"features",[])){const e={},r=b(n,"attributes",{});for(const n in r)e[t[n.toLowerCase()]]=r[n];l.featureSet.features.push({attributes:e,geometry:C(b(n,"geometry",null))})}}}}if(!1===T(l))throw new Error("Invalid Parameter");return m.create(l,t.spatialReference)}))},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(t,n){return e.standardFunctionAsync(t,n,((n,r,a)=>{if(o.pcCheck(a,2,2),o.isArray(a[0])||o.isImmutableArray(a[0])){const n=[];let r=a[0];r instanceof s&&(r=r.toArray());let i=null;if(a[1]instanceof l)i=e.arcadeCustomFunctionHandler(a[1]);else if(a[1]instanceof o.NativeFunction)i=(...e)=>a[1].fn(t,{preparsed:!0,arguments:e});else{if(!(a[1]instanceof o.SizzleFunction))throw new Error("Invalid Parameter");i=(...e)=>{if(e.length!==a[1].paramCount)throw new Error("Invalid parameters");return a[1].fn(...e)}}return r.reduce(((e,t,a)=>e.then((e=>{a>0&&!0===e&&n.push(r[a-1]);const l=i(t);return S.isPromiseLike(l)?l:S.resolve(l)}))),Promise.resolve(!1)).then((e=>(!0===e&&r.length>0&&n.push(r[r.length-1]),n)))}return o.isFeatureSet(a[0])?a[0].load().then((n=>{const r=I.WhereClause.create(a[1],n.getFieldsIndex()),i=r.getVariables();if(i.length>0){const n=[];for(let r=0;r<i.length;r++){const a={name:i[r]};n.push(e.evaluateIdentifier(t,a))}return S.all(n).then((e=>{const t={};for(let n=0;n<i.length;n++)t[i[n]]=e[n];return r.parameters=t,new f({parentfeatureset:a[0],whereclause:r})}))}return S.resolve(new f({parentfeatureset:a[0],whereclause:r}))})):e.failDefferred("Filter cannot accept this parameter type")}))},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(t,n){return e.standardFunctionAsync(t,n,((t,n,r)=>{if(o.pcCheck(r,2,2),o.isFeatureSet(r[0])){const e=new y(r[1]);return S.resolve(new c({parentfeatureset:r[0],orderbyclause:e}))}return e.failDefferred("Order cannot accept this parameter type")}))},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(t,n){return e.standardFunctionAsync(t,n,((t,n,r)=>(o.pcCheck(r,2,2),o.isFeatureSet(r[0])?S.resolve(new d({parentfeatureset:r[0],topnum:r[1]})):o.isArray(r[0])?o.toNumber(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,o.toNumber(r[1])):o.isImmutableArray(r[0])?o.toNumber(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,o.toNumber(r[1])):e.failDefferred("Top cannot accept this parameter type"))))},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(t,n){return e.standardFunctionAsync(t,n,((e,t,n)=>(o.pcCheck(n,1,1),o.isFeatureSet(n[0])?n[0].first(e.abortSignal).then((e=>{if(null!==e){const t=r.createFromGraphicLikeObject(e.geometry,e.attributes,n[0]);t._underlyingGraphic=e,e=t}return e})):o.isArray(n[0])?0===n[0].length?S.resolve(null):S.resolve(n[0][0]):o.isImmutableArray(n[0])?0===n[0].length()?S.resolve(null):S.resolve(n[0].get(0)):null)))},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(t,r){return e.standardFunctionAsync(t,r,((e,r,a)=>{o.pcCheck(a,1,2);const l={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(a.length>1)if(a[1]instanceof n){if(a[1].hasField("minsize")&&(l.minsize=o.toNumber(a[1].field("minsize"))),a[1].hasField("metadata")&&(l.returnMetadata=o.toBoolean(a[1].field("metadata"))),a[1].hasField("maxsize")&&(l.maxsize=o.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){const e=o.toStringArray(a[1].field("types"),!1);e.length>0&&(l.types=e)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(o.isFeature(a[0])){let e=a[0]._layer;return e instanceof A&&(e=i.constructFeatureSet(e,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===e||!1===o.isFeatureSet(e)?[]:e.load().then((()=>e.queryAttachments(a[0].field(e.objectIdField),l.minsize,l.maxsize,l.types,l.returnMetadata)))}if(null===a[0])return[];throw new Error("Invalid Parameter")}))},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(t,n){return e.standardFunctionAsync(t,n,((e,n,r)=>{o.pcCheck(r,2,4);const a=r[0],l=o.toString(r[1]);let s=o.defaultUndefined(r[2],null);const u=o.toBoolean(o.defaultUndefined(r[3],!0));if(null===s&&(s=["*"]),!1===o.isArray(s))throw new Error("Invalid Parameter");if(null===r[0])return null;if(!o.isFeature(r[0]))throw new Error("Invalid Parameter");let f=a._layer;return f instanceof A&&(f=i.constructFeatureSet(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===f||!1===o.isFeatureSet(f)?null:f.load().then((e=>{const n=e.relationshipMetaData().filter((e=>e.name===l));if(0===n.length)return null;if(void 0!==n[0].relationshipTableId&&null!==n[0].relationshipTableId&&n[0].relationshipTableId>-1)return i.constructFeatureSetFromRelationship(e,n[0],a.field(e.objectIdField),e.spatialReference,s,u,t.lrucache,t.interceptor);let r=e.serviceUrl();return r?(r="/"===r.charAt(r.length-1)?r+n[0].relatedTableId.toString():r+"/"+n[0].relatedTableId.toString(),i.constructFeatureSetFromUrl(r,e.spatialReference,s,u,t.lrucache,t.interceptor).then((t=>t.load().then((()=>t.relationshipMetaData())).then((r=>{if(r=r.filter((e=>e.id===n[0].id)),!1===a.hasField(n[0].keyField)||null===a.field(n[0].keyField))return e.getFeatureByObjectId(a.field(e.objectIdField),[n[0].keyField]).then((e=>{if(e){const a=I.WhereClause.create(r[0].keyField+"= @id",t.getFieldsIndex());return a.parameters={id:e.attributes[n[0].keyField]},t.filter(a)}return new p({parentfeatureset:t})}));const i=I.WhereClause.create(r[0].keyField+"= @id",t.getFieldsIndex());return i.parameters={id:a.field(n[0].keyField)},t.filter(i)}))))):null}))}))},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(t,n){return e.standardFunctionAsync(t,n,((e,n,r)=>{o.pcCheck(r,2,3);const a=r[0],l=o.toString(o.defaultUndefined(r[1],"")).toLowerCase(),s=o.isString(r[2])?o.toString(r[2]):null;if(null===r[0])return null;if(!o.isFeature(r[0]))throw new Error("Invalid Parameter");let f=a._layer;return f instanceof A&&(f=i.constructFeatureSet(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===f||!1===o.isFeatureSet(f)?null:f.load().then((()=>{const e=f.serviceUrl();return i.constructAssociationMetaDataFeatureSetFromUrl(e,t.spatialReference)})).then((e=>{let t=null,n=null,r=!1;if(null!==s&&""!==s&&void 0!==s){for(const t of e.terminals)t.terminalName===s&&(n=t.terminalId);null===n&&(r=!0)}const i=e.associations.getFieldsIndex(),c=i.get("TOGLOBALID").name,d=i.get("FROMGLOBALID").name,p=i.get("TOTERMINALID").name,m=i.get("FROMTERMINALID").name,y=i.get("FROMNETWORKSOURCEID").name,h=i.get("TONETWORKSOURCEID").name,F=i.get("ASSOCIATIONTYPE").name,S=i.get("ISCONTENTVISIBLE").name,A=i.get("OBJECTID").name;for(const l of f.fields)if("global-id"===l.type){t=a.field(l.name);break}let D=null,w=new u.SqlExpressionAdapted(new E({name:"percentalong",alias:"percentalong",type:"double"}),I.WhereClause.create("0",e.associations.getFieldsIndex())),b=new u.SqlExpressionAdapted(new E({name:"side",alias:"side",type:"string"}),I.WhereClause.create("''",e.associations.getFieldsIndex()));const N="globalid",x="globalId",C={};for(const a in e.lkp)C[a]=e.lkp[a].sourceId;const v=new u.StringToCodeAdapted(new E({name:"classname",alias:"classname",type:"string"}),null,C);let T="";switch(l){case"midspan":{T=`((${c}='${t}') OR ( ${d}='${t}')) AND (${F} IN (5))`,v.codefield=I.WhereClause.create(`CASE WHEN (${c}='${t}') THEN ${y} ELSE ${h} END`,e.associations.getFieldsIndex());const n=g.cloneField(u.AdaptedFeatureSet.findField(e.associations.fields,d));n.name=N,n.alias=N,D=new u.SqlExpressionAdapted(n,I.WhereClause.create(`CASE WHEN (${d}='${t}') THEN ${c} ELSE ${d} END`,e.associations.getFieldsIndex())),w=e.unVersion>=4?new u.OriginalField(u.AdaptedFeatureSet.findField(e.associations.fields,i.get("PERCENTALONG").name)):new u.SqlExpressionAdapted(new E({name:"percentalong",alias:"percentalong",type:"double"}),I.WhereClause.create("0",e.associations.getFieldsIndex()));break}case"junctionedge":{T=`((${c}='${t}') OR ( ${d}='${t}')) AND (${F} IN (4,6))`,v.codefield=I.WhereClause.create(`CASE WHEN (${c}='${t}') THEN ${y} ELSE ${h} END`,e.associations.getFieldsIndex());const n=g.cloneField(u.AdaptedFeatureSet.findField(e.associations.fields,d));n.name=N,n.alias=N,D=new u.SqlExpressionAdapted(n,I.WhereClause.create(`CASE WHEN (${d}='${t}') THEN ${c} ELSE ${d} END`,e.associations.getFieldsIndex())),b=new u.SqlExpressionAdapted(new E({name:"side",alias:"side",type:"string"}),I.WhereClause.create(`CASE WHEN (${F}=4) THEN 'from' ELSE 'to' END`,e.associations.getFieldsIndex()));break}case"connected":{let r=`${c}='@T'`,a=`${d}='@T'`;null!==n&&(r+=` AND ${p}=@A`,a+=` AND ${m}=@A`),T="(("+r+") OR ("+a+"))",T=o.multiReplace(T,"@T",t),r=o.multiReplace(r,"@T",t),null!==n&&(r=o.multiReplace(r,"@A",n.toString()),T=o.multiReplace(T,"@A",n.toString())),v.codefield=I.WhereClause.create("CASE WHEN "+r+` THEN ${y} ELSE ${h} END`,e.associations.getFieldsIndex());const i=g.cloneField(u.AdaptedFeatureSet.findField(e.associations.fields,d));i.name=N,i.alias=N,D=new u.SqlExpressionAdapted(i,I.WhereClause.create("CASE WHEN "+r+` THEN ${d} ELSE ${c} END`,e.associations.getFieldsIndex()));break}case"container":T=`${c}='${t}' AND ${F} = 2`,null!==n&&(T+=` AND ${p} = `+n.toString()),v.codefield=y,T="( "+T+" )",D=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,d),N,N);case"content":T=`(${d}='${t}' AND ${F} = 2)`,null!==n&&(T+=` AND ${m} = `+n.toString()),v.codefield=h,T="( "+T+" )",D=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,c),N,N);break;case"structure":T=`(${c}='${t}' AND ${F} = 3)`,null!==n&&(T+=` AND ${p} = `+n.toString()),v.codefield=y,T="( "+T+" )",D=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,d),N,x);break;case"attached":T=`(${d}='${t}' AND ${F} = 3)`,null!==n&&(T+=` AND ${m} = `+n.toString()),v.codefield=h,T="( "+T+" )",D=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,c),N,x);break;default:throw new Error("Invalid Parameter")}r&&(T="1 <> 1");return new u.AdaptedFeatureSet({parentfeatureset:e.associations,adaptedFields:[new u.OriginalField(u.AdaptedFeatureSet.findField(e.associations.fields,A)),new u.OriginalField(u.AdaptedFeatureSet.findField(e.associations.fields,S)),D,b,v,w],extraFilter:T?I.WhereClause.create(T,e.associations.getFieldsIndex()):null})}))}))},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(t,r){return e.standardFunctionAsync(t,r,((r,a,i)=>(o.pcCheck(i,3,3),o.isFeatureSet(i[0])?i[0].load().then((r=>{const a=[],l=[];let s=!1,u=[];if(o.isString(i[1]))u.push(i[1]);else if(i[1]instanceof n)u.push(i[1]);else if(o.isArray(i[1]))u=i[1];else{if(!o.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");u=i[1].toArray()}for(const t of u)if(o.isString(t)){const e=I.WhereClause.create(o.toString(t),r.getFieldsIndex()),n=!0===h.isSingleField(e)?o.toString(t):"%%%%FIELDNAME";a.push({name:n,expression:e}),"%%%%FIELDNAME"===n&&(s=!0)}else{if(!(t instanceof n))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",i=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(s=!0),!n)return e.failDefferred("Illegal Value: GroupBy");a.push({name:n,expression:I.WhereClause.create(i||n,r.getFieldsIndex())})}}if(u=[],o.isString(i[2]))u.push(i[2]);else if(o.isArray(i[2]))u=i[2];else if(o.isImmutableArray(i[2]))u=i[2].toArray();else{if(!(i[2]instanceof n))return e.failDefferred("Illegal Value: GroupBy");u.push(i[2])}for(const t of u){if(!(t instanceof n))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"",a=t.hasField("statistic")?t.field("statistic"):"",i=t.hasField("expression")?t.field("expression"):"";if(!n||!a||!i)return e.failDefferred("Illegal Value: GroupBy");l.push({name:n,statistic:a.toLowerCase(),expression:I.WhereClause.create(i,r.getFieldsIndex())})}}if(s){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const n of a)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);for(const n of l)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of a)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}const f=[];for(const n of a)f.push(w(n.expression,e,t));for(const n of l)f.push(w(n.expression,e,t));return f.length>0?S.all(f).then((()=>S.resolve(i[0].groupby(a,l)))):S.resolve(i[0].groupby(a,l))})):e.failDefferred("Illegal Value: GroupBy"))))},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(t,r){return e.standardFunctionAsync(t,r,((r,a,i)=>o.isFeatureSet(i[0])?(o.pcCheck(i,2,2),i[0].load().then((r=>{const a=[];let l=[];if(o.isString(i[1]))l.push(i[1]);else if(i[1]instanceof n)l.push(i[1]);else if(o.isArray(i[1]))l=i[1];else{if(!o.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");l=i[1].toArray()}let s=!1;for(const t of l)if(o.isString(t)){const e=I.WhereClause.create(o.toString(t),r.getFieldsIndex()),n=!0===h.isSingleField(e)?o.toString(t):"%%%%FIELDNAME";a.push({name:n,expression:e}),"%%%%FIELDNAME"===n&&(s=!0)}else{if(!(t instanceof n))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",i=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(s=!0),!n)return e.failDefferred("Illegal Value: GroupBy");a.push({name:n,expression:I.WhereClause.create(i||n,r.getFieldsIndex())})}}if(s){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const n of a)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of a)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}const u=[];for(const n of a)u.push(w(n.expression,e,t));return u.length>0?S.all(u).then((()=>S.resolve(i[0].groupby(a,[])))):S.resolve(i[0].groupby(a,[]))}))):D("distinct",r,a,i)))})}e.registerFunctions=$,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
