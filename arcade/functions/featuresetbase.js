// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.40/esri/copyright.txt for details.

define(["require","exports","../ArcadePortal","../Dictionary","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../FunctionWrapper","../ImmutableArray","../languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../polyfill/promiseUtils","../polyfill/sql/WhereClause","../../layers/FeatureLayer","../../layers/Field"],(function(e,r,t,n,a,i,l,s,o,u,f,d,c,p,m,g,y,h,v,F,S,I,A,E,b){"use strict";function D(e,r,t){var n=e.getVariables();if(n.length>0){for(var a=[],i=0;i<n.length;i++){var l={name:n[i]};a.push(r.evaluateIdentifier(t,l))}return I.all(a).then((function(r){for(var t={},a=0;a<n.length;a++)t[n[a]]=r[a];return e.parameters=t,e}))}return I.resolve(e)}function w(e,r,t){for(var n in void 0===t&&(t=null),e)if(n.toLowerCase()===r.toLowerCase())return e[n];return t}function N(e){if(null===e)return null;var r={type:w(e,"type",""),name:w(e,"name","")};if("range"===r.type)r.range=w(e,"range",[]);else{r.codedValues=[];for(var t=0,n=w(e,"codedValues",[]);t<n.length;t++){var a=n[t];r.codedValues.push({name:w(a,"name",""),code:w(a,"code",null)})}}return r}function x(e){if(null===e)return null;var r={},t=w(e,"wkt",null);null!==t&&(r.wkt=t);var n=w(e,"wkid",null);return null!==n&&(r.wkid=n),r}function C(e){if(null===e)return null;var r={hasZ:w(e,"hasz",!1),hasM:w(e,"hasm",!1)},t=w(e,"spatialreference",null);t&&(r.spatialReference=x(t));var n=w(e,"x",null);if(null!==n)return r.x=n,r.y=w(e,"y",null),r;var a=w(e,"rings",null);if(null!==a)return r.rings=a,r;var i=w(e,"paths",null);if(null!==i)return r.paths=i,r;var l=w(e,"points",null);if(null!==l)return r.points=l,r;for(var s=0,o=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];s<o.length;s++){var u=o[s],f=w(e,u,null);null!==f&&(r[u]=f)}return r}Object.defineProperty(r,"__esModule",{value:!0}),r.registerFunctions=void 0,r.registerFunctions=function(e){"async"===e.mode&&(e.functions.getuser=function(r,a){return e.standardFunctionAsync(r,a,(function(e,a,i){f.pcCheck(i,1,2);var l=f.defaultUndefined(i[1],""),o=!0===l;if(l=!0===l||!1===l?"":f.toString(l),i[0]instanceof t){var u=null;return r.services&&r.services.portal&&(u=r.services.portal),u=s.getPortal(i[0],u),s.lookupUser(u,l,o).then((function(e){if(e){for(var r=JSON.parse(JSON.stringify(e)),t=0,a=["lastLogin","created","modified"];t<a.length;t++){var i=a[t];void 0!==r[i]&&null!==r[i]&&(r[i]=new Date(r[i]))}return n.convertObjectToArcadeDictionary(r)}return null}))}var d=null;if(f.isFeatureSet(i[0])&&(d=i[0]),d)return o=!1,l?null:d.load().then((function(){return d.getOwningSystemUrl()})).then((function(e){if(!e)return l?null:d.getIdentityUser().then((function(e){return e?n.convertObjectToArcadeDictionary({username:e}):null}));var a=null;return r.services&&r.services.portal&&(a=r.services.portal),a=s.getPortal(new t(e),a),s.lookupUser(a,l,o).then((function(e){if(e){for(var r=JSON.parse(JSON.stringify(e)),t=0,a=["lastLogin","created","modified"];t<a.length;t++){var i=a[t];void 0!==r[i]&&null!==r[i]&&(r[i]=new Date(r[i]))}return n.convertObjectToArcadeDictionary(r)}return null}))}));throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getuser",min:"1",max:"2"}),e.functions.featuresetbyid=function(r,t){return e.standardFunctionAsync(r,t,(function(e,r,t){if(f.pcCheck(t,2,4),t[0]instanceof l){var n=f.toString(t[1]),a=f.defaultUndefined(t[2],null),i=f.toBoolean(f.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===f.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetById(n,i,a)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.getfeatureset=function(r,t){return e.standardFunctionAsync(r,t,(function(e,t,n){if(f.pcCheck(n,1,2),n[0]instanceof i){var a=f.defaultUndefined(n[1],"datasource");return null===a&&(a="datasource"),a=f.toString(a).toLowerCase(),s.convertToFeatureSet(n[0]._layer,a,r.lrucache,r.interceptor,r.spatialReference)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getfeatureset",min:"1",max:"2"}),e.functions.featuresetbyportalitem=function(r,n){return e.standardFunctionAsync(r,n,(function(e,n,a){if(f.pcCheck(a,2,5),null===a[0])throw new Error("Portal is required");if(a[0]instanceof t){var i=f.toString(a[1]),l=f.toString(a[2]),o=f.defaultUndefined(a[3],null),u=f.toBoolean(f.defaultUndefined(a[4],!0));if(null===o&&(o=["*"]),!1===f.isArray(o))throw new Error("Invalid Parameter");var d=null;return r.services&&r.services.portal&&(d=r.services.portal),d=s.getPortal(a[0],d),s.constructFeatureSetFromPortalItem(i,l,r.spatialReference,o,u,d,r.lrucache,r.interceptor)}if(!1===f.isString(a[0]))throw new Error("Portal is required");var c=f.toString(a[0]),p=f.toString(a[1]),m=f.defaultUndefined(a[2],null),g=f.toBoolean(f.defaultUndefined(a[3],!0));if(null===m&&(m=["*"]),!1===f.isArray(m))throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return s.constructFeatureSetFromPortalItem(c,p,r.spatialReference,m,g,r.services.portal,r.lrucache,r.interceptor);throw new Error("Portal is required")}))},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(r,t){return e.standardFunctionAsync(r,t,(function(e,r,t){if(f.pcCheck(t,2,4),t[0]instanceof l){var n=f.toString(t[1]),a=f.defaultUndefined(t[2],null),i=f.toBoolean(f.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===f.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetByName(n,i,a)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(r,t){return e.standardFunction(r,t,(function(e,t,a){f.pcCheck(a,1,1);var i,l=a[0],s={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(f.isString(l))void 0!==(l=JSON.parse(l)).layerDefinition?(s.layerDefinition=l.layerDefinition,s.featureSet=l.featureSet,l.layerDefinition.spatialReference&&(s.layerDefinition.spatialReference=l.layerDefinition.spatialReference)):(s.featureSet.features=l.features,s.featureSet.geometryType=l.geometryType,s.layerDefinition.geometryType=s.featureSet.geometryType,s.layerDefinition.objectIdField=l.objectIdFieldName,s.layerDefinition.typeIdField=l.typeIdFieldName,s.layerDefinition.globalIdField=l.globalIdFieldName,s.layerDefinition.fields=l.fields,l.spatialReference&&(s.layerDefinition.spatialReference=l.spatialReference));else{if(!(a[0]instanceof n))throw new Error("Invalid Parameter");var o=w(l=JSON.parse(a[0].castToText()),"layerdefinition");if(null!==o){s.layerDefinition.geometryType=w(o,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.globalIdField=w(o,"globalidfield",""),s.layerDefinition.objectIdField=w(o,"objectidfield",""),s.layerDefinition.typeIdField=w(o,"typeidfield",""),(E=w(o,"spatialreference",null))&&(s.layerDefinition.spatialReference=x(E));for(var u=0,d=w(o,"fields",[]);u<d.length;u++){var c={name:w(T=d[u],"name",""),alias:w(T,"alias",""),type:w(T,"type",""),nullable:w(T,"nullable",!0),editable:w(T,"editable",!0),length:w(T,"length",null),domain:N(w(T,"domain"))};s.layerDefinition.fields.push(c)}var p=w(l,"featureset",null);if(p){for(var m={},g=0,h=s.layerDefinition.fields;g<h.length;g++){m[(A=h[g]).name.toLowerCase()]=A.name}for(var v=0,F=w(p,"features",[]);v<F.length;v++){var S={},I=w(P=F[v],"attributes",{});for(var A in I)S[m[A.toLowerCase()]]=I[A];s.featureSet.features.push({attributes:S,geometry:C(w(P,"geometry",null))})}}}else{var E;s.layerDefinition.geometryType=w(l,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.objectIdField=w(l,"objectidfieldname",""),s.layerDefinition.typeIdField=w(l,"typeidfieldname",""),(E=w(l,"spatialreference",null))&&(s.layerDefinition.spatialReference=x(E));for(var b=0,D=w(l,"fields",[]);b<D.length;b++){var T;c={name:w(T=D[b],"name",""),alias:w(T,"alias",""),type:w(T,"type",""),nullable:w(T,"nullable",!0),editable:w(T,"editable",!0),length:w(T,"length",null),domain:N(w(T,"domain"))};s.layerDefinition.fields.push(c)}m={};for(var L=0,R=s.layerDefinition.fields;L<R.length;L++){m[(A=R[L]).name.toLowerCase()]=A.name}for(var k=0,O=w(l,"features",[]);k<O.length;k++){var P;S={},I=w(P=O[k],"attributes",{});for(var A in I)S[m[A.toLowerCase()]]=I[A];s.featureSet.features.push({attributes:S,geometry:C(w(P,"geometry",null))})}}}if(!1==(!!(i=s).layerDefinition&&!!i.featureSet&&!1!==function(e,r){for(var t=0,n=r;t<n.length;t++)if(n[t]===e)return!0;return!1}(i.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&null!==i.layerDefinition.objectIdField&&""!==i.layerDefinition.objectIdField&&!1!==f.isArray(i.layerDefinition.fields)&&!1!==f.isArray(i.featureSet.features)))throw new Error("Invalid Parameter");return y.create(s,r.spatialReference)}))},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(r,t){return e.standardFunctionAsync(r,t,(function(t,n,a){if(f.pcCheck(a,2,2),f.isArray(a[0])||f.isImmutableArray(a[0])){var i=[],l=a[0];l instanceof u&&(l=l.toArray());var s=null;if(a[1]instanceof o)s=e.arcadeCustomFunctionHandler(a[1]);else if(a[1]instanceof f.NativeFunction)s=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return a[1].fn(r,{preparsed:!0,arguments:e})};else{if(!(a[1]instanceof f.SizzleFunction))throw new Error("Invalid Parameter");s=function(){for(var e,r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];if(r.length!==a[1].paramCount)throw new Error("Invalid parameters");return(e=a[1]).fn.apply(e,r)}}return l.reduce((function(e,r,t){return e.then((function(e){t>0&&!0===e&&i.push(l[t-1]);var n=s(r);return I.isPromiseLike(n)?n:I.resolve(n)}))}),Promise.resolve(!1)).then((function(e){return!0===e&&l.length>0&&i.push(l[l.length-1]),i}))}return f.isFeatureSet(a[0])?a[0].load().then((function(t){var n=A.WhereClause.create(a[1],t.getFieldsIndex()),i=n.getVariables();if(i.length>0){for(var l=[],s=0;s<i.length;s++){var o={name:i[s]};l.push(e.evaluateIdentifier(r,o))}return I.all(l).then((function(e){for(var r={},t=0;t<i.length;t++)r[i[t]]=e[t];return n.parameters=r,new c({parentfeatureset:a[0],whereclause:n})}))}return I.resolve(new c({parentfeatureset:a[0],whereclause:n}))})):e.failDefferred("Filter cannot accept this parameter type")}))},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(r,t){return e.standardFunctionAsync(r,t,(function(r,t,n){if(f.pcCheck(n,2,2),f.isFeatureSet(n[0])){var a=new h(n[1]);return I.resolve(new p({parentfeatureset:n[0],orderbyclause:a}))}return e.failDefferred("Order cannot accept this parameter type")}))},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(r,t){return e.standardFunctionAsync(r,t,(function(r,t,n){return f.pcCheck(n,2,2),f.isFeatureSet(n[0])?I.resolve(new m({parentfeatureset:n[0],topnum:n[1]})):f.isArray(n[0])?f.toNumber(n[1])>=n[0].length?n[0].slice(0):n[0].slice(0,f.toNumber(n[1])):f.isImmutableArray(n[0])?f.toNumber(n[1])>=n[0].length()?n[0].slice(0):n[0].slice(0,f.toNumber(n[1])):e.failDefferred("Top cannot accept this parameter type")}))},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(r,t){return e.standardFunctionAsync(r,t,(function(e,r,t){return f.pcCheck(t,1,1),f.isFeatureSet(t[0])?t[0].first(e.abortSignal).then((function(e){if(null!==e){var r=i.createFromGraphicLikeObject(e.geometry,e.attributes,t[0]);r._underlyingGraphic=e,e=r}return e})):f.isArray(t[0])?0===t[0].length?I.resolve(null):I.resolve(t[0][0]):f.isImmutableArray(t[0])?0===t[0].length()?I.resolve(null):I.resolve(t[0].get(0)):null}))},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(r,t){return e.standardFunctionAsync(r,t,(function(e,t,a){f.pcCheck(a,1,2);var l={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(a.length>1)if(a[1]instanceof n){if(a[1].hasField("minsize")&&(l.minsize=f.toNumber(a[1].field("minsize"))),a[1].hasField("metadata")&&(l.returnMetadata=f.toBoolean(a[1].field("metadata"))),a[1].hasField("maxsize")&&(l.maxsize=f.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){var o=f.toStringArray(a[1].field("types"),!1);o.length>0&&(l.types=o)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(a[0]instanceof i){var u=a[0]._layer;return u instanceof E&&(u=s.constructFeatureSet(u,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),null===u?[]:!1===f.isFeatureSet(u)?[]:u.load().then((function(){return u.queryAttachments(a[0].field(u.objectIdField),l.minsize,l.maxsize,l.types,l.returnMetadata)}))}if(null===a[0])return[];throw new Error("Invalid Parameter")}))},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(r,t){return e.standardFunctionAsync(r,t,(function(e,t,n){f.pcCheck(n,2,4);var a=n[0],l=f.toString(n[1]),o=f.defaultUndefined(n[2],null),u=f.toBoolean(f.defaultUndefined(n[3],!0));if(null===o&&(o=["*"]),!1===f.isArray(o))throw new Error("Invalid Parameter");if(null===n[0])return null;if(!(n[0]instanceof i))throw new Error("Invalid Parameter");var d=a._layer;return d instanceof E&&(d=s.constructFeatureSet(d,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),null===d?null:!1===f.isFeatureSet(d)?null:d.load().then((function(e){var t=e.relationshipMetaData().filter((function(e){return e.name===l}));if(0===t.length)return null;if(void 0!==t[0].relationshipTableId&&null!==t[0].relationshipTableId&&t[0].relationshipTableId>-1)return s.constructFeatureSetFromRelationship(e,t[0],a.field(e.objectIdField),e.spatialReference,o,u,r.lrucache,r.interceptor);var n=e.serviceUrl();return n?(n="/"===n.charAt(n.length-1)?n+t[0].relatedTableId.toString():n+"/"+t[0].relatedTableId.toString(),s.constructFeatureSetFromUrl(n,e.spatialReference,o,u,r.lrucache,r.interceptor).then((function(r){return r.load().then((function(){return r.relationshipMetaData()})).then((function(n){if(n=n.filter((function(e){return e.id===t[0].id})),!1===a.hasField(t[0].keyField)||null===a.field(t[0].keyField))return e.getFeatureByObjectId(a.field(e.objectIdField),[t[0].keyField]).then((function(e){if(e){var a=A.WhereClause.create(n[0].keyField+"= @id",r.getFieldsIndex());return a.parameters={id:e.attributes[t[0].keyField]},r.filter(a)}return new g({parentfeatureset:r})}));var i=A.WhereClause.create(n[0].keyField+"= @id",r.getFieldsIndex());return i.parameters={id:a.field(t[0].keyField)},r.filter(i)}))}))):null}))}))},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(r,t){return e.standardFunctionAsync(r,t,(function(e,t,n){f.pcCheck(n,2,3);var a=n[0],l=f.toString(f.defaultUndefined(n[1],"")).toLowerCase(),o=f.isString(n[2])?f.toString(n[2]):null;if(null===n[0])return null;if(!(n[0]instanceof i))throw new Error("Invalid Parameter");var u=a._layer;return u instanceof E&&(u=s.constructFeatureSet(u,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),null===u?null:!1===f.isFeatureSet(u)?null:u.load().then((function(){var e=u.serviceUrl();return s.constructAssociationMetaDataFeatureSetFromUrl(e,r.spatialReference)})).then((function(e){var r=null,t=null,n=!1;if(null!==o&&""!==o&&void 0!==o){for(var i=0,s=e.terminals;i<s.length;i++){var c=s[i];c.terminalName===o&&(t=c.terminalId)}null===t&&(n=!0)}for(var p=e.associations.getFieldsIndex(),m=p.get("TOGLOBALID").name,g=p.get("FROMGLOBALID").name,y=p.get("TOTERMINALID").name,h=p.get("FROMTERMINALID").name,F=p.get("FROMNETWORKSOURCEID").name,S=p.get("TONETWORKSOURCEID").name,I=p.get("ASSOCIATIONTYPE").name,E=p.get("ISCONTENTVISIBLE").name,D=p.get("OBJECTID").name,w=0,N=u.fields;w<N.length;w++){var x=N[w];if("esriFieldTypeGlobalID"===x.type){r=a.field(x.name);break}}var C=null,T=new d.SqlExpressionAdapted(new b({name:"percentalong",alias:"percentalong",type:"esrFieldTypeDouble"}),A.WhereClause.create("0",e.associations.getFieldsIndex())),L=new d.SqlExpressionAdapted(new b({name:"side",alias:"side",type:"esrFieldTypeString"}),A.WhereClause.create("''",e.associations.getFieldsIndex())),R={};for(var k in e.lkp)R[k]=e.lkp[k].sourceId;var O=new d.StringToCodeAdapted(new b({name:"classname",alias:"classname",type:"esriFieldTypeString"}),null,R),P="";switch(l){case"midspan":P="(("+m+"='"+r+"') OR ( "+g+"='"+r+"')) AND ("+I+" IN (5))",O.codefield=A.WhereClause.create("CASE WHEN ("+m+"='"+r+"') THEN "+F+" ELSE "+S+" END",e.associations.getFieldsIndex());var W=v.cloneField(d.AdaptedFeatureSet.findField(e.associations.fields,g));W.name="globalid",W.alias="globalid",C=new d.SqlExpressionAdapted(W,A.WhereClause.create("CASE WHEN ("+g+"='"+r+"') THEN "+m+" ELSE "+g+" END",e.associations.getFieldsIndex())),T=e.unVersion>=4?new d.OriginalField(d.AdaptedFeatureSet.findField(e.associations.fields,p.get("PERCENTALONG").name)):new d.SqlExpressionAdapted(new b({name:"percentalong",alias:"percentalong",type:"esrFieldTypeDouble"}),A.WhereClause.create("0",e.associations.getFieldsIndex()));break;case"junctionedge":P="(("+m+"='"+r+"') OR ( "+g+"='"+r+"')) AND ("+I+" IN (4,6))",O.codefield=A.WhereClause.create("CASE WHEN ("+m+"='"+r+"') THEN "+F+" ELSE "+S+" END",e.associations.getFieldsIndex());var M=v.cloneField(d.AdaptedFeatureSet.findField(e.associations.fields,g));M.name="globalid",M.alias="globalid",C=new d.SqlExpressionAdapted(M,A.WhereClause.create("CASE WHEN ("+g+"='"+r+"') THEN "+m+" ELSE "+g+" END",e.associations.getFieldsIndex())),L=new d.SqlExpressionAdapted(new b({name:"side",alias:"side",type:"esrFieldTypeString"}),A.WhereClause.create("CASE WHEN ("+I+"=4) THEN 'from' ELSE 'to' END",e.associations.getFieldsIndex()));break;case"connected":var U=m+"='@T'",B=g+"='@T'";null!==t&&(U+=" AND "+y+"=@A",B+=" AND "+h+"=@A"),P="(("+U+") OR ("+B+"))",P=f.multiReplace(P,"@T",r),U=f.multiReplace(U,"@T",r),null!==t&&(U=f.multiReplace(U,"@A",t.toString()),P=f.multiReplace(P,"@A",t.toString())),O.codefield=A.WhereClause.create("CASE WHEN "+U+" THEN "+F+" ELSE "+S+" END",e.associations.getFieldsIndex());var G=v.cloneField(d.AdaptedFeatureSet.findField(e.associations.fields,g));G.name="globalid",G.alias="globalid",C=new d.SqlExpressionAdapted(G,A.WhereClause.create("CASE WHEN "+U+" THEN "+g+" ELSE "+m+" END",e.associations.getFieldsIndex()));break;case"container":P=m+"='"+r+"' AND "+I+" = 2",null!==t&&(P+=" AND "+y+" = "+t.toString()),O.codefield=F,P="( "+P+" )",C=new d.FieldRename(d.AdaptedFeatureSet.findField(e.associations.fields,g),"globalid","globalid");case"content":P="("+g+"='"+r+"' AND "+I+" = 2)",null!==t&&(P+=" AND "+h+" = "+t.toString()),O.codefield=S,P="( "+P+" )",C=new d.FieldRename(d.AdaptedFeatureSet.findField(e.associations.fields,m),"globalid","globalid");break;case"structure":P="("+m+"='"+r+"' AND "+I+" = 3)",null!==t&&(P+=" AND "+y+" = "+t.toString()),O.codefield=F,P="( "+P+" )",C=new d.FieldRename(d.AdaptedFeatureSet.findField(e.associations.fields,g),"globalid","globalId");break;case"attached":P="("+g+"='"+r+"' AND "+I+" = 3)",null!==t&&(P+=" AND "+h+" = "+t.toString()),O.codefield=S,P="( "+P+" )",C=new d.FieldRename(d.AdaptedFeatureSet.findField(e.associations.fields,m),"globalid","globalId");break;default:throw new Error("Invalid Parameter")}return n&&(P="1 <> 1"),new d.AdaptedFeatureSet({parentfeatureset:e.associations,adaptedFields:[new d.OriginalField(d.AdaptedFeatureSet.findField(e.associations.fields,D)),new d.OriginalField(d.AdaptedFeatureSet.findField(e.associations.fields,E)),C,L,O,T],extraFilter:P?A.WhereClause.create(P,e.associations.getFieldsIndex()):null})}))}))},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(r,t){return e.standardFunctionAsync(r,t,(function(t,n,i){return f.pcCheck(i,3,3),f.isFeatureSet(i[0])?i[0].load().then((function(t){var n=[],l=[],s=!1,o=[];if(f.isString(i[1]))o.push(i[1]);else if(i[1]instanceof a)o.push(i[1]);else if(f.isArray(i[1]))o=i[1];else{if(!f.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");o=i[1].toArray()}for(var u=0,d=o;u<d.length;u++){var c=d[u];if(f.isString(c)){var p=A.WhereClause.create(f.toString(c),t.getFieldsIndex()),m=!0===F.isSingleField(p)?f.toString(c):"%%%%FIELDNAME";n.push({name:m,expression:p}),"%%%%FIELDNAME"===m&&(s=!0)}else{if(!(c instanceof a))return e.failDefferred("Illegal Value: GroupBy");var g=c.hasField("name")?c.field("name"):"%%%%FIELDNAME";p=c.hasField("expression")?c.field("expression"):"";if("%%%%FIELDNAME"===g&&(s=!0),!g)return e.failDefferred("Illegal Value: GroupBy");n.push({name:g,expression:A.WhereClause.create(p||g,t.getFieldsIndex())})}}if(o=[],f.isString(i[2]))o.push(i[2]);else if(f.isArray(i[2]))o=i[2];else if(f.isImmutableArray(i[2]))o=i[2].toArray();else{if(!(i[2]instanceof a))return e.failDefferred("Illegal Value: GroupBy");o.push(i[2])}for(var y=0,h=o;y<h.length;y++){if(!((c=h[y])instanceof a))return e.failDefferred("Illegal Value: GroupBy");var v=c.hasField("name")?c.field("name"):"",S=c.hasField("statistic")?c.field("statistic"):"";p=c.hasField("expression")?c.field("expression"):"";if(!v||!S||!p)return e.failDefferred("Illegal Value: GroupBy");l.push({name:v,statistic:S.toLowerCase(),expression:A.WhereClause.create(p,t.getFieldsIndex())})}if(s){for(var E={},b=0,w=t.fields;b<w.length;b++){E[(O=w[b]).name.toLowerCase()]=1}for(var N=0,x=n;N<x.length;N++){"%%%%FIELDNAME"!==(O=x[N]).name&&(E[O.name.toLowerCase()]=1)}for(var C=0,T=l;C<T.length;C++){"%%%%FIELDNAME"!==(O=T[C]).name&&(E[O.name.toLowerCase()]=1)}for(var L=0,R=0,k=n;R<k.length;R++){var O;if("%%%%FIELDNAME"===(O=k[R]).name){for(;1===E["field_"+L.toString()];)L++;E["field_"+L.toString()]=1,O.name="FIELD_"+L.toString()}}}for(var P=[],W=0,M=n;W<M.length;W++){var U=M[W];P.push(D(U.expression,e,r))}for(var B=0,G=l;B<G.length;B++){U=G[B];P.push(D(U.expression,e,r))}return P.length>0?I.all(P).then((function(){return I.resolve(i[0].groupby(n,l))})):I.resolve(i[0].groupby(n,l))})):e.failDefferred("Illegal Value: GroupBy")}))},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(r,t){return e.standardFunctionAsync(r,t,(function(t,n,i){return f.isFeatureSet(i[0])?(f.pcCheck(i,2,2),i[0].load().then((function(t){var n=[],l=[];if(f.isString(i[1]))l.push(i[1]);else if(i[1]instanceof a)l.push(i[1]);else if(f.isArray(i[1]))l=i[1];else{if(!f.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");l=i[1].toArray()}for(var s=!1,o=0,u=l;o<u.length;o++){var d=u[o];if(f.isString(d)){var c=A.WhereClause.create(f.toString(d),t.getFieldsIndex()),p=!0===F.isSingleField(c)?f.toString(d):"%%%%FIELDNAME";n.push({name:p,expression:c}),"%%%%FIELDNAME"===p&&(s=!0)}else{if(!(d instanceof a))return e.failDefferred("Illegal Value: GroupBy");var m=d.hasField("name")?d.field("name"):"%%%%FIELDNAME";c=d.hasField("expression")?d.field("expression"):"";if("%%%%FIELDNAME"===m&&(s=!0),!m)return e.failDefferred("Illegal Value: GroupBy");n.push({name:m,expression:A.WhereClause.create(c||m,t.getFieldsIndex())})}}if(s){for(var g={},y=0,h=t.fields;y<h.length;y++){g[(N=h[y]).name.toLowerCase()]=1}for(var v=0,S=n;v<S.length;v++){"%%%%FIELDNAME"!==(N=S[v]).name&&(g[N.name.toLowerCase()]=1)}for(var E=0,b=0,w=n;b<w.length;b++){var N;if("%%%%FIELDNAME"===(N=w[b]).name){for(;1===g["field_"+E.toString()];)E++;g["field_"+E.toString()]=1,N.name="FIELD_"+E.toString()}}}for(var x=[],C=0,T=n;C<T.length;C++){var L=T[C];x.push(D(L.expression,e,r))}return x.length>0?I.all(x).then((function(){return I.resolve(i[0].groupby(n,[]))})):I.resolve(i[0].groupby(n,[]))}))):function(e,r,t,n){if(1===n.length){if(f.isArray(n[0]))return S.calculateStat(e,n[0],-1);if(f.isImmutableArray(n[0]))return S.calculateStat(e,n[0].toArray(),-1)}return S.calculateStat(e,n,-1)}("distinct",0,0,i)}))})}}));