/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../ArcadePortal","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../../chunks/languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../../core/promiseUtils","../../core/sql/WhereClause","../../layers/FeatureLayer","../../layers/support/Field"],(function(e,t,n,r,i,a,l,s,o,u,f,c,d,p,m,y,g,h,F,S,I){"use strict";function E(e,t,n,r){if(1===r.length){if(l.isArray(r[0]))return g.calculateStat(e,r[0],-1);if(l.isImmutableArray(r[0]))return g.calculateStat(e,r[0].toArray(),-1)}return g.calculateStat(e,r,-1)}function A(e,t,n){const r=e.getVariables();if(r.length>0){const i=[];for(let e=0;e<r.length;e++){const a={name:r[e]};i.push(t.evaluateIdentifier(n,a))}return h.all(i).then((t=>{const n={};for(let e=0;e<r.length;e++)n[r[e]]=t[e];return e.parameters=n,e}))}return h.resolve(e)}function D(e,t,n=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return n}function b(e){if(null===e)return null;const t={type:D(e,"type",""),name:D(e,"name","")};if("range"===t.type)t.range=D(e,"range",[]);else{t.codedValues=[];for(const n of D(e,"codedValues",[]))t.codedValues.push({name:D(n,"name",""),code:D(n,"code",null)})}return t}function w(e){if(null===e)return null;const t={},n=D(e,"wkt",null);null!==n&&(t.wkt=n);const r=D(e,"wkid",null);return null!==r&&(t.wkid=r),t}function N(e){if(null===e)return null;const t={hasZ:D(e,"hasz",!1),hasM:D(e,"hasm",!1)},n=D(e,"spatialreference",null);n&&(t.spatialReference=w(n));const r=D(e,"x",null);if(null!==r)return t.x=r,t.y=D(e,"y",null),t;const i=D(e,"rings",null);if(null!==i)return t.rings=i,t;const a=D(e,"paths",null);if(null!==a)return t.paths=a,t;const l=D(e,"points",null);if(null!==l)return t.points=l,t;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const n=D(e,s,null);null!==n&&(t[s]=n)}return t}function x(e,t){for(const n of t)if(n===e)return!0;return!1}function C(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==x(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==l.isArray(e.layerDefinition.fields)&&!1!==l.isArray(e.featureSet.features)))))}function v(e){"async"===e.mode&&(e.functions.getuser=function(r,i){return e.standardFunctionAsync(r,i,((e,i,s)=>{l.pcCheck(s,1,2);let o=l.defaultUndefined(s[1],""),u=!0===o;if(o=!0===o||!1===o?"":l.toString(o),s[0]instanceof t){let e=null;return r.services&&r.services.portal&&(e=r.services.portal),e=a.getPortal(s[0],e),a.lookupUser(e,o,u).then((e=>{if(e){const t=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return n.convertObjectToArcadeDictionary(t)}return null}))}let f=null;if(l.isFeatureSet(s[0])&&(f=s[0]),f)return u=!1,o?null:f.load().then((()=>f.getOwningSystemUrl())).then((e=>{if(!e)return o?null:f.getIdentityUser().then((e=>e?n.convertObjectToArcadeDictionary({username:e}):null));let i=null;return r.services&&r.services.portal&&(i=r.services.portal),i=a.getPortal(new t(e),i),a.lookupUser(i,o,u).then((e=>{if(e){const t=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])void 0!==t[e]&&null!==t[e]&&(t[e]=new Date(t[e]));return n.convertObjectToArcadeDictionary(t)}return null}))}));throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getuser",min:"1",max:"2"}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,((e,t,n)=>{if(l.pcCheck(n,2,4),n[0]instanceof i){const e=l.toString(n[1]);let t=l.defaultUndefined(n[2],null);const r=l.toBoolean(l.defaultUndefined(n[3],!0));if(null===t&&(t=["*"]),!1===l.isArray(t))throw new Error("Invalid Parameter");return n[0].featureSetById(e,r,t)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(n,r){return e.standardFunctionAsync(n,r,((e,r,i)=>{if(l.pcCheck(i,2,5),null===i[0])throw new Error("Portal is required");if(i[0]instanceof t){const e=l.toString(i[1]),t=l.toString(i[2]);let r=l.defaultUndefined(i[3],null);const s=l.toBoolean(l.defaultUndefined(i[4],!0));if(null===r&&(r=["*"]),!1===l.isArray(r))throw new Error("Invalid Parameter");let o=null;return n.services&&n.services.portal&&(o=n.services.portal),o=a.getPortal(i[0],o),a.constructFeatureSetFromPortalItem(e,t,n.spatialReference,r,s,o,n.lrucache,n.interceptor)}if(!1===l.isString(i[0]))throw new Error("Portal is required");const s=l.toString(i[0]),o=l.toString(i[1]);let u=l.defaultUndefined(i[2],null);const f=l.toBoolean(l.defaultUndefined(i[3],!0));if(null===u&&(u=["*"]),!1===l.isArray(u))throw new Error("Invalid Parameter");if(n.services&&n.services.portal)return a.constructFeatureSetFromPortalItem(s,o,n.spatialReference,u,f,n.services.portal,n.lrucache,n.interceptor);throw new Error("Portal is required")}))},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,((e,t,n)=>{if(l.pcCheck(n,2,4),n[0]instanceof i){const e=l.toString(n[1]);let t=l.defaultUndefined(n[2],null);const r=l.toBoolean(l.defaultUndefined(n[3],!0));if(null===t&&(t=["*"]),!1===l.isArray(t))throw new Error("Invalid Parameter");return n[0].featureSetByName(e,r,t)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(t,r){return e.standardFunction(t,r,((e,r,i)=>{l.pcCheck(i,1,1);let a=i[0];const s={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(l.isString(a))a=JSON.parse(a),void 0!==a.layerDefinition?(s.layerDefinition=a.layerDefinition,s.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(s.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(s.featureSet.features=a.features,s.featureSet.geometryType=a.geometryType,s.layerDefinition.geometryType=s.featureSet.geometryType,s.layerDefinition.objectIdField=a.objectIdFieldName,s.layerDefinition.typeIdField=a.typeIdFieldName,s.layerDefinition.globalIdField=a.globalIdFieldName,s.layerDefinition.fields=a.fields,a.spatialReference&&(s.layerDefinition.spatialReference=a.spatialReference));else{if(!(i[0]instanceof n))throw new Error("Invalid Parameter");{a=JSON.parse(i[0].castToText());const e=D(a,"layerdefinition");if(null!==e){s.layerDefinition.geometryType=D(e,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.globalIdField=D(e,"globalidfield",""),s.layerDefinition.objectIdField=D(e,"objectidfield",""),s.layerDefinition.typeIdField=D(e,"typeidfield","");const t=D(e,"spatialreference",null);t&&(s.layerDefinition.spatialReference=w(t));for(const r of D(e,"fields",[])){const e={name:D(r,"name",""),alias:D(r,"alias",""),type:D(r,"type",""),nullable:D(r,"nullable",!0),editable:D(r,"editable",!0),length:D(r,"length",null),domain:b(D(r,"domain"))};s.layerDefinition.fields.push(e)}const n=D(a,"featureset",null);if(n){const e={};for(const t of s.layerDefinition.fields)e[t.name.toLowerCase()]=t.name;for(const t of D(n,"features",[])){const n={},r=D(t,"attributes",{});for(const t in r)n[e[t.toLowerCase()]]=r[t];s.featureSet.features.push({attributes:n,geometry:N(D(t,"geometry",null))})}}}else{s.layerDefinition.geometryType=D(a,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.objectIdField=D(a,"objectidfieldname",""),s.layerDefinition.typeIdField=D(a,"typeidfieldname","");const e=D(a,"spatialreference",null);e&&(s.layerDefinition.spatialReference=w(e));for(const n of D(a,"fields",[])){const e={name:D(n,"name",""),alias:D(n,"alias",""),type:D(n,"type",""),nullable:D(n,"nullable",!0),editable:D(n,"editable",!0),length:D(n,"length",null),domain:b(D(n,"domain"))};s.layerDefinition.fields.push(e)}const t={};for(const n of s.layerDefinition.fields)t[n.name.toLowerCase()]=n.name;for(const n of D(a,"features",[])){const e={},r=D(n,"attributes",{});for(const n in r)e[t[n.toLowerCase()]]=r[n];s.featureSet.features.push({attributes:e,geometry:N(D(n,"geometry",null))})}}}}if(!1===C(s))throw new Error("Invalid Parameter");return d.create(s,t.spatialReference)}))},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(t,n){return e.standardFunctionAsync(t,n,((n,r,i)=>(l.pcCheck(i,2,2),l.isFeatureSet(i[0])?i[0].load().then((n=>{const r=F.WhereClause.create(i[1],n.getFieldsIndex()),a=r.getVariables();if(a.length>0){const n=[];for(let r=0;r<a.length;r++){const i={name:a[r]};n.push(e.evaluateIdentifier(t,i))}return h.all(n).then((e=>{const t={};for(let n=0;n<a.length;n++)t[a[n]]=e[n];return r.parameters=t,new o({parentfeatureset:i[0],whereclause:r})}))}return h.resolve(new o({parentfeatureset:i[0],whereclause:r}))})):e.failDefferred("Filter cannot accept this parameter type"))))},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(t,n){return e.standardFunctionAsync(t,n,((t,n,r)=>{if(l.pcCheck(r,2,2),l.isFeatureSet(r[0])){const e=new p(r[1]);return h.resolve(new u({parentfeatureset:r[0],orderbyclause:e}))}return e.failDefferred("Order cannot accept this parameter type")}))},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(t,n){return e.standardFunctionAsync(t,n,((t,n,r)=>(l.pcCheck(r,2,2),l.isFeatureSet(r[0])?h.resolve(new f({parentfeatureset:r[0],topnum:r[1]})):l.isArray(r[0])?l.toNumber(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,l.toNumber(r[1])):l.isImmutableArray(r[0])?l.toNumber(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,l.toNumber(r[1])):e.failDefferred("Top cannot accept this parameter type"))))},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(t,n){return e.standardFunctionAsync(t,n,((e,t,n)=>(l.pcCheck(n,1,1),l.isFeatureSet(n[0])?n[0].first(e.abortSignal).then((e=>{if(null!==e){const t=r.createFromGraphicLikeObject(e.geometry,e.attributes,n[0]);t._underlyingGraphic=e,e=t}return e})):l.isArray(n[0])?0===n[0].length?h.resolve(null):h.resolve(n[0][0]):l.isImmutableArray(n[0])?0===n[0].length()?h.resolve(null):h.resolve(n[0].get(0)):null)))},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(t,i){return e.standardFunctionAsync(t,i,((e,i,s)=>{l.pcCheck(s,1,2);const o={minsize:-1,maxsize:-1,types:null};if(s.length>1)if(s[1]instanceof n){if(s[1].hasField("minsize")&&(o.minsize=l.toNumber(s[1].field("minsize"))),s[1].hasField("maxsize")&&(o.maxsize=l.toNumber(s[1].field("maxsize"))),s[1].hasField("types")){const e=l.toStringArray(s[1].field("types"),!1);e.length>0&&(o.types=e)}}else if(null!==s[1])throw new Error("Invalid Parameter");if(s[0]instanceof r){let e=s[0]._layer;return e instanceof S&&(e=a.constructFeatureSet(e,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===e||!1===l.isFeatureSet(e)?[]:e.load().then((()=>e.queryAttachments(s[0].field(e.objectIdField),o.minsize,o.maxsize,o.types)))}if(null===s[0])return[];throw new Error("Invalid Parameter")}))},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(t,n){return e.standardFunctionAsync(t,n,((e,n,i)=>{l.pcCheck(i,2,4);const s=i[0],o=l.toString(i[1]);let u=l.defaultUndefined(i[2],null);const f=l.toBoolean(l.defaultUndefined(i[3],!0));if(null===u&&(u=["*"]),!1===l.isArray(u))throw new Error("Invalid Parameter");if(null===i[0])return null;if(!(i[0]instanceof r))throw new Error("Invalid Parameter");let d=s._layer;return d instanceof S&&(d=a.constructFeatureSet(d,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===d||!1===l.isFeatureSet(d)?null:d.load().then((e=>{const n=e.relationshipMetaData().filter((e=>e.name===o));if(0===n.length)return null;if(void 0!==n[0].relationshipTableId&&null!==n[0].relationshipTableId&&n[0].relationshipTableId>-1)return a.constructFeatureSetFromRelationship(e,n[0],s.field(e.objectIdField),e.spatialReference,u,f,t.lrucache,t.interceptor);let r=e.serviceUrl();return r?(r="/"===r.charAt(r.length-1)?r+n[0].relatedTableId.toString():r+"/"+n[0].relatedTableId.toString(),a.constructFeatureSetFromUrl(r,e.spatialReference,u,f,t.lrucache,t.interceptor).then((t=>t.load().then((()=>t.relationshipMetaData())).then((r=>{if(r=r.filter((e=>e.id===n[0].id)),!1===s.hasField(n[0].keyField)||null===s.field(n[0].keyField))return e.getFeatureByObjectId(s.field(e.objectIdField),[n[0].keyField]).then((e=>{if(e){const i=F.WhereClause.create(r[0].keyField+"= @id",t.getFieldsIndex());return i.parameters={id:e.attributes[n[0].keyField]},t.filter(i)}return new c({parentfeatureset:t})}));const i=F.WhereClause.create(r[0].keyField+"= @id",t.getFieldsIndex());return i.parameters={id:s.field(n[0].keyField)},t.filter(i)}))))):null}))}))},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(t,n){return e.standardFunctionAsync(t,n,((e,n,i)=>{l.pcCheck(i,2,3);const o=i[0],u=l.toString(l.defaultUndefined(i[1],"")).toLowerCase(),f=l.isString(i[2])?l.toString(i[2]):null;if(null===i[0])return null;if(!(i[0]instanceof r))throw new Error("Invalid Parameter");let c=o._layer;return c instanceof S&&(c=a.constructFeatureSet(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===c||!1===l.isFeatureSet(c)?null:c.load().then((()=>{const e=c.serviceUrl();return a.constructAssociationMetaDataFeatureSetFromUrl(e,t.spatialReference)})).then((e=>{let t=null,n=null,r=!1;if(null!==f&&""!==f&&void 0!==f){for(const t of e.terminals)t.terminalName===f&&(n=t.terminalId);null===n&&(r=!0)}const i=e.associations.getFieldsIndex(),a=i.get("TOGLOBALID").name,d=i.get("FROMGLOBALID").name,p=i.get("TOTERMINALID").name,y=i.get("FROMTERMINALID").name,g=i.get("FROMNETWORKSOURCEID").name,h=i.get("TONETWORKSOURCEID").name,S=i.get("ASSOCIATIONTYPE").name,E=i.get("ISCONTENTVISIBLE").name,A=i.get("OBJECTID").name;for(const l of c.fields)if("global-id"===l.type){t=o.field(l.name);break}let D=null,b=new s.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"double"}),F.WhereClause.create("0",e.associations.getFieldsIndex())),w=new s.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"string"}),F.WhereClause.create("''",e.associations.getFieldsIndex()));const N="globalid",x="globalId",C={};for(const l in e.lkp)C[l]=e.lkp[l].sourceId;const v=new s.StringToCodeAdapted(new I({name:"classname",alias:"classname",type:"string"}),null,C);let $="";switch(u){case"midspan":{$=`((${a}='${t}') OR ( ${d}='${t}')) AND (${S} IN (5))`,v.codefield=F.WhereClause.create(`CASE WHEN (${a}='${t}') THEN ${g} ELSE ${h} END`,e.associations.getFieldsIndex());const n=m.cloneField(s.AdaptedFeatureSet.findField(e.associations.fields,d));n.name=N,n.alias=N,D=new s.SqlExpressionAdapted(n,F.WhereClause.create(`CASE WHEN (${d}='${t}') THEN ${a} ELSE ${d} END`,e.associations.getFieldsIndex())),b=e.unVersion>=4?new s.OriginalField(s.AdaptedFeatureSet.findField(e.associations.fields,i.get("PERCENTALONG").name)):new s.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"double"}),F.WhereClause.create("0",e.associations.getFieldsIndex()));break}case"junctionedge":{$=`((${a}='${t}') OR ( ${d}='${t}')) AND (${S} IN (4,6))`,v.codefield=F.WhereClause.create(`CASE WHEN (${a}='${t}') THEN ${g} ELSE ${h} END`,e.associations.getFieldsIndex());const n=m.cloneField(s.AdaptedFeatureSet.findField(e.associations.fields,d));n.name=N,n.alias=N,D=new s.SqlExpressionAdapted(n,F.WhereClause.create(`CASE WHEN (${d}='${t}') THEN ${a} ELSE ${d} END`,e.associations.getFieldsIndex())),w=new s.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"string"}),F.WhereClause.create(`CASE WHEN (${S}=4) THEN 'from' ELSE 'to' END`,e.associations.getFieldsIndex()));break}case"connected":{let r=`${a}='@T'`,i=`${d}='@T'`;null!==n&&(r+=` AND ${p}=@A`,i+=` AND ${y}=@A`),$="(("+r+") OR ("+i+"))",$=l.multiReplace($,"@T",t),r=l.multiReplace(r,"@T",t),null!==n&&(r=l.multiReplace(r,"@A",n.toString()),$=l.multiReplace($,"@A",n.toString())),v.codefield=F.WhereClause.create("CASE WHEN "+r+` THEN ${g} ELSE ${h} END`,e.associations.getFieldsIndex());const o=m.cloneField(s.AdaptedFeatureSet.findField(e.associations.fields,d));o.name=N,o.alias=N,D=new s.SqlExpressionAdapted(o,F.WhereClause.create("CASE WHEN "+r+` THEN ${d} ELSE ${a} END`,e.associations.getFieldsIndex()));break}case"container":$=`${a}='${t}' AND ${S} = 2`,null!==n&&($+=` AND ${p} = `+n.toString()),v.codefield=g,$="( "+$+" )",D=new s.FieldRename(s.AdaptedFeatureSet.findField(e.associations.fields,d),N,N);case"content":$=`(${d}='${t}' AND ${S} = 2)`,null!==n&&($+=` AND ${y} = `+n.toString()),v.codefield=h,$="( "+$+" )",D=new s.FieldRename(s.AdaptedFeatureSet.findField(e.associations.fields,a),N,N);break;case"structure":$=`(${a}='${t}' AND ${S} = 3)`,null!==n&&($+=` AND ${p} = `+n.toString()),v.codefield=g,$="( "+$+" )",D=new s.FieldRename(s.AdaptedFeatureSet.findField(e.associations.fields,d),N,x);break;case"attached":$=`(${d}='${t}' AND ${S} = 3)`,null!==n&&($+=` AND ${y} = `+n.toString()),v.codefield=h,$="( "+$+" )",D=new s.FieldRename(s.AdaptedFeatureSet.findField(e.associations.fields,a),N,x);break;default:throw new Error("Invalid Parameter")}r&&($="1 <> 1");return new s.AdaptedFeatureSet({parentfeatureset:e.associations,adaptedFields:[new s.OriginalField(s.AdaptedFeatureSet.findField(e.associations.fields,A)),new s.OriginalField(s.AdaptedFeatureSet.findField(e.associations.fields,E)),D,w,v,b],extraFilter:$?F.WhereClause.create($,e.associations.getFieldsIndex()):null})}))}))},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(t,r){return e.standardFunctionAsync(t,r,((r,i,a)=>(l.pcCheck(a,3,3),l.isFeatureSet(a[0])?a[0].load().then((r=>{const i=[],s=[];let o=!1,u=[];if(l.isString(a[1]))u.push(a[1]);else if(a[1]instanceof n)u.push(a[1]);else if(l.isArray(a[1]))u=a[1];else{if(!l.isImmutableArray(a[1]))return e.failDefferred("Illegal Value: GroupBy");u=a[1].toArray()}for(const t of u)if(l.isString(t)){const e=F.WhereClause.create(l.toString(t),r.getFieldsIndex()),n=!0===y.isSingleField(e)?l.toString(t):"%%%%FIELDNAME";i.push({name:n,expression:e}),"%%%%FIELDNAME"===n&&(o=!0)}else{if(!(t instanceof n))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",a=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(o=!0),!n)return e.failDefferred("Illegal Value: GroupBy");i.push({name:n,expression:F.WhereClause.create(a||n,r.getFieldsIndex())})}}if(u=[],l.isString(a[2]))u.push(a[2]);else if(l.isArray(a[2]))u=a[2];else if(l.isImmutableArray(a[2]))u=a[2].toArray();else{if(!(a[2]instanceof n))return e.failDefferred("Illegal Value: GroupBy");u.push(a[2])}for(const t of u){if(!(t instanceof n))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"",i=t.hasField("statistic")?t.field("statistic"):"",a=t.hasField("expression")?t.field("expression"):"";if(!n||!i||!a)return e.failDefferred("Illegal Value: GroupBy");s.push({name:n,statistic:i.toLowerCase(),expression:F.WhereClause.create(a,r.getFieldsIndex())})}}if(o){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const n of i)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);for(const n of s)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of i)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}const f=[];for(const n of i)f.push(A(n.expression,e,t));for(const n of s)f.push(A(n.expression,e,t));return f.length>0?h.all(f).then((()=>h.resolve(a[0].groupby(i,s)))):h.resolve(a[0].groupby(i,s))})):e.failDefferred("Illegal Value: GroupBy"))))},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(t,r){return e.standardFunctionAsync(t,r,((r,i,a)=>l.isFeatureSet(a[0])?(l.pcCheck(a,2,2),a[0].load().then((r=>{const i=[];let s=[];if(l.isString(a[1]))s.push(a[1]);else if(a[1]instanceof n)s.push(a[1]);else if(l.isArray(a[1]))s=a[1];else{if(!l.isImmutableArray(a[1]))return e.failDefferred("Illegal Value: GroupBy");s=a[1].toArray()}let o=!1;for(const t of s)if(l.isString(t)){const e=F.WhereClause.create(l.toString(t),r.getFieldsIndex()),n=!0===y.isSingleField(e)?l.toString(t):"%%%%FIELDNAME";i.push({name:n,expression:e}),"%%%%FIELDNAME"===n&&(o=!0)}else{if(!(t instanceof n))return e.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",a=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(o=!0),!n)return e.failDefferred("Illegal Value: GroupBy");i.push({name:n,expression:F.WhereClause.create(a||n,r.getFieldsIndex())})}}if(o){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const n of i)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let t=0;for(const n of i)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}const u=[];for(const n of i)u.push(A(n.expression,e,t));return u.length>0?h.all(u).then((()=>h.resolve(a[0].groupby(i,[])))):h.resolve(a[0].groupby(i,[]))}))):E("distinct",r,i,a)))})}e.registerFunctions=v,Object.defineProperty(e,"__esModule",{value:!0})}));
