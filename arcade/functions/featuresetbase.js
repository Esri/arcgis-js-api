// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../polyfill/tsSupport/awaiter","../polyfill/tsSupport/generator","../ArcadePortal","../Dictionary","../executionError","../Feature","../featureSetCollection","../featureSetUtils","../ImmutableArray","../languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../polyfill/promiseUtils","../polyfill/sql/WhereClause","../../layers/FeatureLayer","../../layers/Field"],(function(e,r,t,n,a,i,l,s,o,u,c,d,f,m,p,h,E,g,y,F,A,x,v,S,w,I){"use strict";function b(e,r,t,n){if(1===n.length){if(d.isArray(n[0]))return x.calculateStat(e,n[0],-1);if(d.isImmutableArray(n[0]))return x.calculateStat(e,n[0].toArray(),-1)}return x.calculateStat(e,n,-1)}function C(e,r,a){return t(this,void 0,void 0,(function(){var t,i,l,s,o,u,c,d;return n(this,(function(n){switch(n.label){case 0:if(!((t=e.getVariables()).length>0))return[3,5];i=[],l=0,n.label=1;case 1:return l<t.length?(s={name:t[l]},u=(o=i).push,[4,r.evaluateIdentifier(a,s)]):[3,4];case 2:u.apply(o,[n.sent()]),n.label=3;case 3:return l++,[3,1];case 4:for(c={},d=0;d<t.length;d++)c[t[d]]=i[d];return e.parameters=c,[2,e];case 5:return[2,e]}}))}))}function D(e,r,t){for(var n in void 0===t&&(t=null),e)if(n.toLowerCase()===r.toLowerCase())return e[n];return t}function N(e){if(null===e)return null;var r={type:D(e,"type",""),name:D(e,"name","")};if("range"===r.type)r.range=D(e,"range",[]);else{r.codedValues=[];for(var t=0,n=D(e,"codedValues",[]);t<n.length;t++){var a=n[t];r.codedValues.push({name:D(a,"name",""),code:D(a,"code",null)})}}return r}function T(e){if(null===e)return null;var r={},t=D(e,"wkt",null);null!==t&&(r.wkt=t);var n=D(e,"wkid",null);return null!==n&&(r.wkid=n),r}function L(e){if(null===e)return null;var r={hasZ:D(e,"hasz",!1),hasM:D(e,"hasm",!1)},t=D(e,"spatialreference",null);t&&(r.spatialReference=T(t));var n=D(e,"x",null);if(null!==n)return r.x=n,r.y=D(e,"y",null),r;var a=D(e,"rings",null);if(null!==a)return r.rings=a,r;var i=D(e,"paths",null);if(null!==i)return r.paths=i,r;var l=D(e,"points",null);if(null!==l)return r.points=l,r;for(var s=0,o=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];s<o.length;s++){var u=o[s],c=D(e,u,null);null!==c&&(r[u]=c)}return r}Object.defineProperty(r,"__esModule",{value:!0}),r.registerFunctions=void 0,r.registerFunctions=function(e){"async"===e.mode&&(e.functions.getuser=function(r,s){var o=this;return e.standardFunctionAsync(r,s,(function(e,c,f){return t(o,void 0,void 0,(function(){var e,t,o,c,m,p,h,E,g,y,F,A,x;return n(this,(function(n){switch(n.label){case 0:return d.pcCheck(f,0,2,r,s),e=d.defaultUndefined(f[1],""),t=!0===e,e=!0===e||!1===e?"":d.toString(e),0===f.length||f[0]instanceof a?(E=null,r.services&&r.services.portal&&(E=r.services.portal),f.length>0&&(E=u.getPortal(f[0],E)),[4,u.lookupUser(E,e,t)]):[3,2];case 1:if(g=n.sent()){for(y=JSON.parse(JSON.stringify(g)),o=0,c=["lastLogin","created","modified"];o<c.length;o++)void 0!==y[x=c[o]]&&null!==y[x]&&(y[x]=new Date(y[x]));return[2,i.convertObjectToArcadeDictionary(y)]}return[2,null];case 2:return m=null,d.isFeatureSet(f[0])&&(m=f[0]),m?(t=!1,e?[2,null]:[4,m.load()]):[3,9];case 3:return n.sent(),[4,m.getOwningSystemUrl()];case 4:return(p=n.sent())?[3,7]:e?[3,6]:[4,m.getIdentityUser()];case 5:return(h=n.sent())?[2,i.convertObjectToArcadeDictionary({username:h})]:[2,null];case 6:return[2,null];case 7:return E=null,r.services&&r.services.portal&&(E=r.services.portal),E=u.getPortal(new a(p),E),[4,u.lookupUser(E,e,t)];case 8:if(g=n.sent()){for(y=JSON.parse(JSON.stringify(g)),F=0,A=["lastLogin","created","modified"];F<A.length;F++)void 0!==y[x=A[F]]&&null!==y[x]&&(y[x]=new Date(y[x]));return[2,i.convertObjectToArcadeDictionary(y)]}return[2,null];case 9:throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,s)}}))}))}))},e.signatures.push({name:"getuser",min:1,max:2}),e.functions.featuresetbyid=function(r,t){return e.standardFunctionAsync(r,t,(function(e,n,a){if(d.pcCheck(a,2,4,r,t),a[0]instanceof o){var i=d.toString(a[1]),s=d.defaultUndefined(a[2],null),u=d.toBoolean(d.defaultUndefined(a[3],!0));if(null===s&&(s=["*"]),!1===d.isArray(s))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t);return a[0].featureSetById(i,u,s)}throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t)}))},e.signatures.push({name:"featuresetbyid",min:2,max:4}),e.functions.getfeatureset=function(r,t){return e.standardFunctionAsync(r,t,(function(e,n,a){if(d.pcCheck(a,1,2,r,t),d.isFeature(a[0])){var i=d.defaultUndefined(a[1],"datasource");return null===i&&(i="datasource"),i=d.toString(i).toLowerCase(),u.convertToFeatureSet(a[0].fullSchema(),i,r.lrucache,r.interceptor,r.spatialReference)}throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t)}))},e.signatures.push({name:"getfeatureset",min:1,max:2}),e.functions.featuresetbyportalitem=function(r,t){return e.standardFunctionAsync(r,t,(function(e,n,i){if(d.pcCheck(i,2,5,r,t),null===i[0])throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.PortalRequired,t);if(i[0]instanceof a){var s=d.toString(i[1]),o=d.toString(i[2]),c=d.defaultUndefined(i[3],null),f=d.toBoolean(d.defaultUndefined(i[4],!0));if(null===c&&(c=["*"]),!1===d.isArray(c))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t);var m=null;return r.services&&r.services.portal&&(m=r.services.portal),m=u.getPortal(i[0],m),u.constructFeatureSetFromPortalItem(s,o,r.spatialReference,c,f,m,r.lrucache,r.interceptor)}if(!1===d.isString(i[0]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.PortalRequired,t);var p=d.toString(i[0]),h=d.toString(i[1]),E=d.defaultUndefined(i[2],null),g=d.toBoolean(d.defaultUndefined(i[3],!0));if(null===E&&(E=["*"]),!1===d.isArray(E))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t);if(r.services&&r.services.portal)return u.constructFeatureSetFromPortalItem(p,h,r.spatialReference,E,g,r.services.portal,r.lrucache,r.interceptor);throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.PortalRequired,t)}))},e.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),e.functions.featuresetbyname=function(r,t){return e.standardFunctionAsync(r,t,(function(e,n,a){if(d.pcCheck(a,2,4,r,t),a[0]instanceof o){var i=d.toString(a[1]),s=d.defaultUndefined(a[2],null),u=d.toBoolean(d.defaultUndefined(a[3],!0));if(null===s&&(s=["*"]),!1===d.isArray(s))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t);return a[0].featureSetByName(i,u,s)}throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t)}))},e.signatures.push({name:"featuresetbyname",min:2,max:4}),e.functions.featureset=function(r,t){return e.standardFunction(r,t,(function(e,n,a){d.pcCheck(a,1,1,r,t);var s,o=a[0],u={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(d.isString(o))void 0!==(o=JSON.parse(o)).layerDefinition?(u.layerDefinition=o.layerDefinition,u.featureSet=o.featureSet,o.layerDefinition.spatialReference&&(u.layerDefinition.spatialReference=o.layerDefinition.spatialReference)):(u.featureSet.features=o.features,u.featureSet.geometryType=o.geometryType,u.layerDefinition.geometryType=u.featureSet.geometryType,u.layerDefinition.objectIdField=o.objectIdFieldName,u.layerDefinition.typeIdField=o.typeIdFieldName,u.layerDefinition.globalIdField=o.globalIdFieldName,u.layerDefinition.fields=o.fields,o.spatialReference&&(u.layerDefinition.spatialReference=o.spatialReference));else{if(!(a[0]instanceof i))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t);var c=D(o=JSON.parse(a[0].castToText(!0)),"layerdefinition");if(null!==c){u.layerDefinition.geometryType=D(c,"geometrytype",""),u.featureSet.geometryType=u.layerDefinition.geometryType,u.layerDefinition.globalIdField=D(c,"globalidfield",""),u.layerDefinition.objectIdField=D(c,"objectidfield",""),u.layerDefinition.typeIdField=D(c,"typeidfield",""),(I=D(c,"spatialreference",null))&&(u.layerDefinition.spatialReference=T(I));for(var f=0,m=D(c,"fields",[]);f<m.length;f++){var p={name:D(P=m[f],"name",""),alias:D(P,"alias",""),type:D(P,"type",""),nullable:D(P,"nullable",!0),editable:D(P,"editable",!0),length:D(P,"length",null),domain:N(D(P,"domain"))};u.layerDefinition.fields.push(p)}var h=D(o,"featureset",null);if(h){for(var E={},y=0,F=u.layerDefinition.fields;y<F.length;y++){E[(w=F[y]).name.toLowerCase()]=w.name}for(var A=0,x=D(h,"features",[]);A<x.length;A++){var v={},S=D(M=x[A],"attributes",{});for(var w in S)v[E[w.toLowerCase()]]=S[w];u.featureSet.features.push({attributes:v,geometry:L(D(M,"geometry",null))})}}}else{var I;u.layerDefinition.geometryType=D(o,"geometrytype",""),u.featureSet.geometryType=u.layerDefinition.geometryType,u.layerDefinition.objectIdField=D(o,"objectidfieldname",""),u.layerDefinition.typeIdField=D(o,"typeidfieldname",""),(I=D(o,"spatialreference",null))&&(u.layerDefinition.spatialReference=T(I));for(var b=0,C=D(o,"fields",[]);b<C.length;b++){var P;p={name:D(P=C[b],"name",""),alias:D(P,"alias",""),type:D(P,"type",""),nullable:D(P,"nullable",!0),editable:D(P,"editable",!0),length:D(P,"length",null),domain:N(D(P,"domain"))};u.layerDefinition.fields.push(p)}E={};for(var R=0,k=u.layerDefinition.fields;R<k.length;R++){E[(w=k[R]).name.toLowerCase()]=w.name}for(var O=0,W=D(o,"features",[]);O<W.length;O++){var M;v={},S=D(M=W[O],"attributes",{});for(var w in S)v[E[w.toLowerCase()]]=S[w];u.featureSet.features.push({attributes:v,geometry:L(D(M,"geometry",null))})}}}if(!1==(!!(s=u).layerDefinition&&!!s.featureSet&&!1!==function(e,r){for(var t=0,n=r;t<n.length;t++)if(n[t]===e)return!0;return!1}(s.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&null!==s.layerDefinition.objectIdField&&""!==s.layerDefinition.objectIdField&&!1!==d.isArray(s.layerDefinition.fields)&&!1!==d.isArray(s.featureSet.features)))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,t);return g.create(u,r.spatialReference)}))},e.signatures.push({name:"featureset",min:1,max:1}),e.functions.filter=function(r,a){var i=this;return e.standardFunctionAsync(r,a,(function(s,o,u){return t(i,void 0,void 0,(function(){var t,i,s,o,f,p,h,E,g,y,F,A,x,w,I,b,C;return n(this,(function(n){switch(n.label){case 0:if(d.pcCheck(u,2,2,r,a),!d.isArray(u[0])&&!d.isImmutableArray(u[0]))return[3,6];if(t=[],(i=u[0])instanceof c&&(i=i.toArray()),s=null,!d.isFunctionParameter(u[1]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);s=u[1].createFunction(r),o=0,f=i,n.label=1;case 1:return o<f.length?(p=f[o],h=s(p),v.isPromiseLike(h)?[4,h]:[3,3]):[3,5];case 2:return!0===n.sent()&&t.push(p),[3,4];case 3:!0===h&&t.push(p),n.label=4;case 4:return o++,[3,1];case 5:return[2,t];case 6:return d.isFeatureSet(u[0])?[4,u[0].load()]:[3,13];case 7:if(E=n.sent(),g=S.WhereClause.create(u[1],E.getFieldsIndex()),!((y=g.getVariables()).length>0))return[3,12];F=[],A=0,n.label=8;case 8:return A<y.length?(x={name:y[A]},I=(w=F).push,[4,e.evaluateIdentifier(r,x)]):[3,11];case 9:I.apply(w,[n.sent()]),n.label=10;case 10:return A++,[3,8];case 11:for(b={},C=0;C<y.length;C++)b[y[C]]=F[C];return g.parameters=b,[2,new m({parentfeatureset:u[0],whereclause:g})];case 12:return[2,new m({parentfeatureset:u[0],whereclause:g})];case 13:throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a)}}))}))}))},e.signatures.push({name:"filter",min:2,max:2}),e.functions.orderby=function(r,a){var i=this;return e.standardFunctionAsync(r,a,(function(e,s,o){return t(i,void 0,void 0,(function(){var e;return n(this,(function(t){if(d.pcCheck(o,2,2,r,a),d.isFeatureSet(o[0]))return e=new y(o[1]),[2,new p({parentfeatureset:o[0],orderbyclause:e})];throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a)}))}))}))},e.signatures.push({name:"orderby",min:2,max:2}),e.functions.top=function(r,a){var i=this;return e.standardFunctionAsync(r,a,(function(e,s,o){return t(i,void 0,void 0,(function(){return n(this,(function(e){if(d.pcCheck(o,2,2,r,a),d.isFeatureSet(o[0]))return[2,new h({parentfeatureset:o[0],topnum:o[1]})];if(d.isArray(o[0]))return d.toNumber(o[1])>=o[0].length?[2,o[0].slice(0)]:[2,o[0].slice(0,d.toNumber(o[1]))];if(d.isImmutableArray(o[0]))return d.toNumber(o[1])>=o[0].length()?[2,o[0].slice(0)]:[2,o[0].slice(0,d.toNumber(o[1]))];throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a)}))}))}))},e.signatures.push({name:"top",min:2,max:2}),e.functions.first=function(r,a){var i=this;return e.standardFunctionAsync(r,a,(function(e,l,o){return t(i,void 0,void 0,(function(){var t,i;return n(this,(function(n){switch(n.label){case 0:return d.pcCheck(o,1,1,r,a),d.isFeatureSet(o[0])?[4,o[0].first(e.abortSignal)]:[3,2];case 1:return null!==(t=n.sent())?((i=s.createFromGraphicLikeObject(t.geometry,t.attributes,o[0]))._underlyingGraphic=t,[2,i]):[2,t];case 2:return d.isArray(o[0])?0===o[0].length?[2,null]:[2,o[0][0]]:d.isImmutableArray(o[0])?0===o[0].length()?[2,null]:[2,o[0].get(0)]:[2,null]}}))}))}))},e.signatures.push({name:"first",min:1,max:1}),e.functions.attachments=function(r,a){var s=this;return e.standardFunctionAsync(r,a,(function(e,o,c){return t(s,void 0,void 0,(function(){var e,t,s;return n(this,(function(n){switch(n.label){case 0:if(d.pcCheck(c,1,2,r,a),e={minsize:-1,maxsize:-1,types:null,returnMetadata:!1},c.length>1)if(c[1]instanceof i)c[1].hasField("minsize")&&(e.minsize=d.toNumber(c[1].field("minsize"))),c[1].hasField("metadata")&&(e.returnMetadata=d.toBoolean(c[1].field("metadata"))),c[1].hasField("maxsize")&&(e.maxsize=d.toNumber(c[1].field("maxsize"))),c[1].hasField("types")&&(t=d.toStringArray(c[1].field("types"),!1)).length>0&&(e.types=t);else if(null!==c[1])throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);return d.isFeature(c[0])?((s=c[0]._layer)instanceof w&&(s=u.constructFeatureSet(s,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),null===s?[2,[]]:!1===d.isFeatureSet(s)?[2,[]]:[4,s.load()]):[3,2];case 1:return n.sent(),[2,s.queryAttachments(c[0].field(s.objectIdField),e.minsize,e.maxsize,e.types,e.returnMetadata)];case 2:if(null===c[0])return[2,[]];throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a)}}))}))}))},e.signatures.push({name:"attachments",min:1,max:2}),e.functions.featuresetbyrelationshipname=function(r,a){var i=this;return e.standardFunctionAsync(r,a,(function(e,s,o){return t(i,void 0,void 0,(function(){var e,t,i,s,c,f,m,p,h,g,y,F,A;return n(this,(function(n){switch(n.label){case 0:if(d.pcCheck(o,2,4,r,a),e=o[0],t=d.toString(o[1]),i=d.defaultUndefined(o[2],null),s=d.toBoolean(d.defaultUndefined(o[3],!0)),null===i&&(i=["*"]),!1===d.isArray(i))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);if(null===o[0])return[2,null];if(!d.isFeature(o[0]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);return(c=e._layer)instanceof w&&(c=u.constructFeatureSet(c,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),null===c?[2,null]:!1===d.isFeatureSet(c)?[2,null]:[4,c.load()];case 1:return c=n.sent(),f=c.relationshipMetaData(),0===(m=f.filter((function(e){return e.name===t}))).length?[2,null]:void 0!==m[0].relationshipTableId&&null!==m[0].relationshipTableId&&m[0].relationshipTableId>-1?[2,u.constructFeatureSetFromRelationship(c,m[0],e.field(c.objectIdField),c.spatialReference,i,s,r.lrucache,r.interceptor)]:(p=c.serviceUrl())?(p="/"===p.charAt(p.length-1)?p+m[0].relatedTableId.toString():p+"/"+m[0].relatedTableId.toString(),[4,u.constructFeatureSetFromUrl(p,c.spatialReference,i,s,r.lrucache,r.interceptor)]):[2,null];case 2:return[4,(h=n.sent()).load()];case 3:return n.sent(),g=(g=h.relationshipMetaData()).filter((function(e){return e.id===m[0].id})),!1!==e.hasField(m[0].keyField)&&null!==e.field(m[0].keyField)?[3,5]:[4,c.getFeatureByObjectId(e.field(c.objectIdField),[m[0].keyField])];case 4:return(y=n.sent())?((F=S.WhereClause.create(g[0].keyField+"= @id",h.getFieldsIndex())).parameters={id:y.attributes[m[0].keyField]},[2,h.filter(F)]):[2,new E({parentfeatureset:h})];case 5:return(A=S.WhereClause.create(g[0].keyField+"= @id",h.getFieldsIndex())).parameters={id:e.field(m[0].keyField)},[2,h.filter(A)]}}))}))}))},e.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),e.functions.featuresetbyassociation=function(r,a){var i=this;return e.standardFunctionAsync(r,a,(function(e,s,o){return t(i,void 0,void 0,(function(){var e,t,i,s,c,m,p,h,E,g,y,A,x,v,b,C,D,N,T,L,P,R,k,O,W,M,U,j,q,B,H,z,_,G,J,V,K;return n(this,(function(n){switch(n.label){case 0:if(d.pcCheck(o,2,3,r,a),e=o[0],t=d.toString(d.defaultUndefined(o[1],"")).toLowerCase(),i=d.isString(o[2])?d.toString(o[2]):null,null===o[0])return[2,null];if(!d.isFeature(o[0]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);return(s=e._layer)instanceof w&&(s=u.constructFeatureSet(s,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),null===s?[2,null]:!1===d.isFeatureSet(s)?[2,null]:[4,s.load()];case 1:return n.sent(),c=s.serviceUrl(),[4,u.constructAssociationMetaDataFeatureSetFromUrl(c,r.spatialReference)];case 2:if(m=n.sent(),p=null,h=null,E=!1,null!==i&&""!==i&&void 0!==i){for(g=0,y=m.terminals;g<y.length;g++)(A=y[g]).terminalName===i&&(h=A.terminalId);null===h&&(E=!0)}for(x=m.associations.getFieldsIndex(),v=x.get("TOGLOBALID").name,b=x.get("FROMGLOBALID").name,C=x.get("TOTERMINALID").name,D=x.get("FROMTERMINALID").name,N=x.get("FROMNETWORKSOURCEID").name,T=x.get("TONETWORKSOURCEID").name,L=x.get("ASSOCIATIONTYPE").name,P=x.get("ISCONTENTVISIBLE").name,R=x.get("OBJECTID").name,k=0,O=s.fields;k<O.length;k++)if("esriFieldTypeGlobalID"===(W=O[k]).type){p=e.field(W.name);break}for(B in M=null,U=new f.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"esrFieldTypeDouble"}),S.WhereClause.create("0",m.associations.getFieldsIndex())),j=new f.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"esrFieldTypeString"}),S.WhereClause.create("''",m.associations.getFieldsIndex())),"globalid","globalId",q={},m.lkp)q[B]=m.lkp[B].sourceId;switch(H=new f.StringToCodeAdapted(new I({name:"classname",alias:"classname",type:"esriFieldTypeString"}),null,q),z="",t){case"midspan":z="(("+v+"='"+p+"') OR ( "+b+"='"+p+"')) AND ("+L+" IN (5))",H.codefield=S.WhereClause.create("CASE WHEN ("+v+"='"+p+"') THEN "+N+" ELSE "+T+" END",m.associations.getFieldsIndex()),(_=F.cloneField(f.AdaptedFeatureSet.findField(m.associations.fields,b))).name="globalid",_.alias="globalid",M=new f.SqlExpressionAdapted(_,S.WhereClause.create("CASE WHEN ("+b+"='"+p+"') THEN "+v+" ELSE "+b+" END",m.associations.getFieldsIndex())),U=m.unVersion>=4?new f.OriginalField(f.AdaptedFeatureSet.findField(m.associations.fields,x.get("PERCENTALONG").name)):new f.SqlExpressionAdapted(new I({name:"percentalong",alias:"percentalong",type:"esrFieldTypeDouble"}),S.WhereClause.create("0",m.associations.getFieldsIndex()));break;case"junctionedge":z="(("+v+"='"+p+"') OR ( "+b+"='"+p+"')) AND ("+L+" IN (4,6))",H.codefield=S.WhereClause.create("CASE WHEN ("+v+"='"+p+"') THEN "+N+" ELSE "+T+" END",m.associations.getFieldsIndex()),(G=F.cloneField(f.AdaptedFeatureSet.findField(m.associations.fields,b))).name="globalid",G.alias="globalid",M=new f.SqlExpressionAdapted(G,S.WhereClause.create("CASE WHEN ("+b+"='"+p+"') THEN "+v+" ELSE "+b+" END",m.associations.getFieldsIndex())),j=new f.SqlExpressionAdapted(new I({name:"side",alias:"side",type:"esrFieldTypeString"}),S.WhereClause.create("CASE WHEN ("+L+"=4) THEN 'from' ELSE 'to' END",m.associations.getFieldsIndex()));break;case"connected":J=v+"='@T'",V=b+"='@T'",null!==h&&(J+=" AND "+C+"=@A",V+=" AND "+D+"=@A"),z="(("+J+") OR ("+V+"))",z=d.multiReplace(z,"@T",null!=p?p:""),J=d.multiReplace(J,"@T",null!=p?p:""),null!==h&&(J=d.multiReplace(J,"@A",h.toString()),z=d.multiReplace(z,"@A",h.toString())),H.codefield=S.WhereClause.create("CASE WHEN "+J+" THEN "+N+" ELSE "+T+" END",m.associations.getFieldsIndex()),(K=F.cloneField(f.AdaptedFeatureSet.findField(m.associations.fields,b))).name="globalid",K.alias="globalid",M=new f.SqlExpressionAdapted(K,S.WhereClause.create("CASE WHEN "+J+" THEN "+b+" ELSE "+v+" END",m.associations.getFieldsIndex()));break;case"container":z=v+"='"+p+"' AND "+L+" = 2",null!==h&&(z+=" AND "+C+" = "+h.toString()),H.codefield=N,z="( "+z+" )",M=new f.FieldRename(f.AdaptedFeatureSet.findField(m.associations.fields,b),"globalid","globalid");case"content":z="("+b+"='"+p+"' AND "+L+" = 2)",null!==h&&(z+=" AND "+D+" = "+h.toString()),H.codefield=T,z="( "+z+" )",M=new f.FieldRename(f.AdaptedFeatureSet.findField(m.associations.fields,v),"globalid","globalid");break;case"structure":z="("+v+"='"+p+"' AND "+L+" = 3)",null!==h&&(z+=" AND "+C+" = "+h.toString()),H.codefield=N,z="( "+z+" )",M=new f.FieldRename(f.AdaptedFeatureSet.findField(m.associations.fields,b),"globalid","globalId");break;case"attached":z="("+b+"='"+p+"' AND "+L+" = 3)",null!==h&&(z+=" AND "+D+" = "+h.toString()),H.codefield=T,z="( "+z+" )",M=new f.FieldRename(f.AdaptedFeatureSet.findField(m.associations.fields,v),"globalid","globalId");break;default:throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a)}return E&&(z="1 <> 1"),[2,new f.AdaptedFeatureSet({parentfeatureset:m.associations,adaptedFields:[new f.OriginalField(f.AdaptedFeatureSet.findField(m.associations.fields,R)),new f.OriginalField(f.AdaptedFeatureSet.findField(m.associations.fields,P)),M,j,H,U],extraFilter:z?S.WhereClause.create(z,m.associations.getFieldsIndex()):null})]}}))}))}))},e.signatures.push({name:"featuresetbyassociation",min:2,max:6}),e.functions.groupby=function(r,a){var s=this;return e.standardFunctionAsync(r,a,(function(o,u,c){return t(s,void 0,void 0,(function(){var t,s,o,u,f,m,p,h,E,g,y,F,x,v,w,I,b,D,N,T,L,P,R,k,O,W,M,U,j,q;return n(this,(function(n){switch(n.label){case 0:if(d.pcCheck(c,3,3,r,a),!d.isFeatureSet(c[0]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);return[4,c[0].load()];case 1:if(t=n.sent(),s=[],o=[],u=!1,f=[],d.isString(c[1]))f.push(c[1]);else if(c[1]instanceof i)f.push(c[1]);else if(d.isArray(c[1]))f=c[1];else{if(!d.isImmutableArray(c[1]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);f=c[1].toArray()}for(m=0,p=f;m<p.length;m++)if(F=p[m],d.isString(F))w=S.WhereClause.create(d.toString(F),t.getFieldsIndex()),h=!0===A.isSingleField(w)?d.toString(F):"%%%%FIELDNAME",s.push({name:h,expression:w}),"%%%%FIELDNAME"===h&&(u=!0);else{if(!(F instanceof i))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);if(E=F.hasField("name")?F.field("name"):"%%%%FIELDNAME",w=F.hasField("expression")?F.field("expression"):"","%%%%FIELDNAME"===E&&(u=!0),!E)throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);s.push({name:E,expression:S.WhereClause.create(w||E,t.getFieldsIndex())})}if(f=[],d.isString(c[2]))f.push(c[2]);else if(d.isArray(c[2]))f=c[2];else if(d.isImmutableArray(c[2]))f=c[2].toArray();else{if(!(c[2]instanceof i))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);f.push(c[2])}for(g=0,y=f;g<y.length;g++){if(!((F=y[g])instanceof i))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);if(x=F.hasField("name")?F.field("name"):"",v=F.hasField("statistic")?F.field("statistic"):"",w=F.hasField("expression")?F.field("expression"):"",!x||!v||!w)throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);o.push({name:x,statistic:v.toLowerCase(),expression:S.WhereClause.create(w,t.getFieldsIndex())})}if(u){for(I={},b=0,D=t.fields;b<D.length;b++)W=D[b],I[W.name.toLowerCase()]=1;for(N=0,T=s;N<T.length;N++)"%%%%FIELDNAME"!==(W=T[N]).name&&(I[W.name.toLowerCase()]=1);for(L=0,P=o;L<P.length;L++)"%%%%FIELDNAME"!==(W=P[L]).name&&(I[W.name.toLowerCase()]=1);for(R=0,k=0,O=s;k<O.length;k++)if("%%%%FIELDNAME"===(W=O[k]).name){for(;1===I["field_"+R.toString()];)R++;I["field_"+R.toString()]=1,W.name="FIELD_"+R.toString()}}M=0,U=s,n.label=2;case 2:return M<U.length?[4,C(U[M].expression,e,r)]:[3,5];case 3:n.sent(),n.label=4;case 4:return M++,[3,2];case 5:j=0,q=o,n.label=6;case 6:return j<q.length?[4,C(q[j].expression,e,r)]:[3,9];case 7:n.sent(),n.label=8;case 8:return j++,[3,6];case 9:return[2,c[0].groupby(s,o)]}}))}))}))},e.signatures.push({name:"groupby",min:3,max:3}),e.functions.distinct=function(r,a){var s=this;return e.standardFunctionAsync(r,a,(function(o,u,c){return t(s,void 0,void 0,(function(){var t,s,o,u,f,m,p,h,E,g,y,F,x,v,w,I,D,N,T,L,P;return n(this,(function(n){switch(n.label){case 0:return d.isFeatureSet(c[0])?(d.pcCheck(c,2,2,r,a),[4,c[0].load()]):[3,6];case 1:if(t=n.sent(),s=[],o=[],d.isString(c[1]))o.push(c[1]);else if(c[1]instanceof i)o.push(c[1]);else if(d.isArray(c[1]))o=c[1];else{if(!d.isImmutableArray(c[1]))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);o=c[1].toArray()}for(u=!1,f=0,m=o;f<m.length;f++)if(p=m[f],d.isString(p))g=S.WhereClause.create(d.toString(p),t.getFieldsIndex()),h=!0===A.isSingleField(g)?d.toString(p):"%%%%FIELDNAME",s.push({name:h,expression:g}),"%%%%FIELDNAME"===h&&(u=!0);else{if(!(p instanceof i))throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);if(E=p.hasField("name")?p.field("name"):"%%%%FIELDNAME",g=p.hasField("expression")?p.field("expression"):"","%%%%FIELDNAME"===E&&(u=!0),!E)throw new l.ArcadeExecutionError(r,l.ExecutionErrorCodes.InvalidParameter,a);s.push({name:E,expression:S.WhereClause.create(g||E,t.getFieldsIndex())})}if(u){for(y={},F=0,x=t.fields;F<x.length;F++)T=x[F],y[T.name.toLowerCase()]=1;for(v=0,w=s;v<w.length;v++)"%%%%FIELDNAME"!==(T=w[v]).name&&(y[T.name.toLowerCase()]=1);for(I=0,D=0,N=s;D<N.length;D++)if("%%%%FIELDNAME"===(T=N[D]).name){for(;1===y["field_"+I.toString()];)I++;y["field_"+I.toString()]=1,T.name="FIELD_"+I.toString()}}L=0,P=s,n.label=2;case 2:return L<P.length?[4,C(P[L].expression,e,r)]:[3,5];case 3:n.sent(),n.label=4;case 4:return L++,[3,2];case 5:return[2,c[0].groupby(s,[])];case 6:return[2,b("distinct",0,0,c)]}}))}))}))})}}));