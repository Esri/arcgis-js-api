// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","exports","../polyfill/tsSupport/assign","../polyfill/tsSupport/spreadarray","../lib/arcade-parser","./diagnosticMessages","./languageKeywords","./types"],(function(i,e,t,n,o,r,a,s){"use strict";function d(i,e){return e?i.replace(/\${(.*?)}/g,(function(i,t){var n,o;return null!==(o=null===(n=e[t])||void 0===n?void 0:n.toString())&&void 0!==o?o:""})):i}function c(i){return!!i&&"dictionary"!==i.type}Object.defineProperty(e,"__esModule",{value:!0}),e.validateScript=e.ArcadeValidationService=e.isValueVariable=e.format=void 0,e.format=d,e.isValueVariable=c;var l=function(){function i(i,e){void 0===e&&(e=[]),this._apiDefinitions=i,this._profileVariables=e,this._isInBlock=!1,this._identifierBeingAssigned=void 0,this._assignmentValidationMode="disabled",this._scriptScopeIdentifiers=new Map,this._diagnostics=new Array,this._undeclaredIdentifiersInFunctions=new Map}return i.prototype.validateScript=function(i){var e=this;if(!i)return{diagnostics:[],program:null};this._isInBlock=!1,this._identifierBeingAssigned=void 0,this._assignmentValidationMode="disabled",this._diagnostics=[],this._scriptScopeIdentifiers.clear(),this._undeclaredIdentifiersInFunctions.clear(),this._functionScopeIdentifiers=void 0;var t=null;try{t=o.parse(i,{tolerant:!0}),this.handleErrors(t.errors),t.body.forEach((function(i){return e.validateStatement(i)})),this.diagnoseIdentifiers(),this._undeclaredIdentifiersInFunctions.size>0&&this._undeclaredIdentifiersInFunctions.forEach((function(i){for(var t=0,n=i;t<n.length;t++){var o=n[t];e.logDiagnostic(o.node.loc,{code:r.DiagnosticCodes.NotDefined,data:{identifier:o.node.name}})}}))}catch(i){this.handleException(i)}return{diagnostics:this._diagnostics,program:t}},i.prototype.disableRecordIdentifierAssignment=function(i,e){var t=this._assignmentValidationMode;this._assignmentValidationMode="disabled",i.call(this,e),this._assignmentValidationMode=t},i.prototype.inBlock=function(i,e){var t=this._isInBlock;this._isInBlock=!0,i.call(this,e),this._isInBlock=t},Object.defineProperty(i.prototype,"_isInFunctionScope",{get:function(){return!!this._functionScopeIdentifiers},enumerable:!1,configurable:!0}),i.prototype.inFunctionScope=function(i){this._functionScopeIdentifiers=new Map,i.call(this),this.diagnoseIdentifiers(),this._functionScopeIdentifiers=void 0},i.prototype.logDiagnostic=function(i,e){var n,a=t(t({severity:s.DiagnosticSeverity.Error},e),{message:d(null!==(n=r.DiagnosticMessages[e.code])&&void 0!==n?n:o.ParsingErrorMessages[e.code],e.data),range:{start:{line:i.start.line-1,character:i.start.column},end:{line:i.end.line-1,character:i.end.column}}});this._diagnostics.push(a)},i.prototype.handleErrors=function(i){(null!=i?i:[]).forEach(this.handleException,this)},i.prototype.handleException=function(i){if(function(i){var e;return"ParsingError"===(null===(e=i)||void 0===e?void 0:e.name)}(i)){var e=i.range,t=i.code,n=i.data;this.logDiagnostic(e,{code:t,data:n})}else this.logDiagnostic({start:{line:1,column:0},end:{line:1,column:0}},{code:r.DiagnosticCodes.ExecutionError,data:{stack:i.stack}})},i.prototype.getIdentifierInfo=function(i){var e,t;return null!==(t=null===(e=this._functionScopeIdentifiers)||void 0===e?void 0:e.get(i))&&void 0!==t?t:this._scriptScopeIdentifiers.get(i)},i.prototype.setIdentiferInfo=function(i,e){var t;this._functionScopeIdentifiers?this._functionScopeIdentifiers.set(i,e):((null!==(t=this._functionScopeIdentifiers)&&void 0!==t?t:this._scriptScopeIdentifiers).set(i,e),this._functionScopeIdentifiers||this._undeclaredIdentifiersInFunctions.has(i)&&(this._undeclaredIdentifiersInFunctions.delete(i),e.used=!0))},i.prototype.isProfileVariable=function(i){var e;return(null!==(e=this._profileVariables)&&void 0!==e?e:[]).some((function(e){return e.name.toLowerCase()===i}))},i.prototype.isApiItem=function(i){var e,t,n,o,r=!!(null===(t=null===(e=this._apiDefinitions)||void 0===e?void 0:e.constantDefinitions)||void 0===t?void 0:t.get(i)),a=!!(null===(o=null===(n=this._apiDefinitions)||void 0===n?void 0:n.functionDefinitions)||void 0===o?void 0:o.get(i));return r||a},i.prototype.validateStatement=function(i){var e=this;if(i)switch(i.type){case"BlockStatement":return void i.body.forEach((function(i){return e.validateStatement(i)}));case"VariableDeclaration":return void i.declarations.forEach((function(i){return e.validateVariableDeclarator(i)}));case"FunctionDeclaration":return void this.validateFunctionDeclaration(i);case"ExportNamedDeclaration":return void this.validateExportDeclaration(i);case"ImportDeclaration":return void this.validateImportDeclaration(i);case"WhileStatement":return void this.validateWhileStatement(i);case"ForStatement":return void this.validateForStatement(i);case"ForInStatement":return void this.validateForInStatement(i);case"IfStatement":return void this.validateIfStatement(i);case"ReturnStatement":return void this.validateExpression(i.argument);case"ExpressionStatement":return void this.validateExpression(i.expression);case"BreakStatement":case"ContinueStatement":case"EmptyStatement":return}},i.prototype.validateVariableDeclarator=function(i){this.validateExpression(i.init),this.recordVariableIdentifier(i.id,{initialized:!!i.init})},i.prototype.validateFunctionDeclaration=function(i){var e=this;this.recordFunctionIdentifier(i),this.inFunctionScope((function(){i.params.forEach((function(i){return e.recordParamAsIdentifier(i)})),p(i.body)&&e.logDiagnostic(i.body.loc,{code:r.DiagnosticCodes.UnexpectedEmptyFunction,data:{identifier:i.id.name},severity:s.DiagnosticSeverity.Warning}),e.validateStatement(i.body)}))},i.prototype.validateExportDeclaration=function(i){this.validateStatement(i.declaration)},i.prototype.validateImportDeclaration=function(i){this.recordImportIdentifier(i)},i.prototype.validateForStatement=function(i){o.isVariableDeclaration(i.init)?this.inBlock(this.validateStatement,i.init):this.validateExpression(i.init),this.validateExpression(i.update),this.validateExpression(i.test),p(i.body)&&this.logDiagnostic(i.body.loc,{code:r.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.body)},i.prototype.validateWhileStatement=function(i){this.validateExpression(i.test),p(i.body)&&this.logDiagnostic(i.body.loc,{code:r.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.body)},i.prototype.validateForInStatement=function(i){o.isIdentifier(i.left)?this.validateExpression(i.left):this.recordVariableIdentifier(i.left.declarations[0].id,{initialized:!0,inBlock:!0}),this.validateExpression(i.right),p(i.body)&&this.logDiagnostic(i.body.loc,{code:r.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.validateStatement(i.body)},i.prototype.validateIfStatement=function(i){this.validateExpression(i.test),p(i.consequent)&&this.logDiagnostic(i.consequent.loc,{code:r.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),i.alternate&&p(i.alternate)&&this.logDiagnostic(i.alternate.loc,{code:r.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.consequent),this.inBlock(this.validateStatement,i.alternate)},i.prototype.validateExpression=function(i){var e=this;if(i)switch(i.type){case"AssignmentExpression":return void this.validateAssignmentExpression(i);case"CallExpression":return void this.validateCallExpression(i);case"Identifier":return void this.validateIdentifier(i);case"Literal":return void this.validateLiteral(i);case"ArrayExpression":return void i.elements.forEach((function(i){return e.validateExpression(i)}));case"ObjectExpression":return void this.validateObjectExpression(i);case"UnaryExpression":return void this.validateUnaryExpression(i);case"UpdateExpression":return void this.validateUpdateExpression(i);case"BinaryExpression":case"LogicalExpression":return void this.validateBinaryAndLogicalExpression(i);case"MemberExpression":return void this.validateMemberExpression(i);case"TemplateLiteral":return void i.expressions.forEach((function(i){return e.validateExpression(i)}));default:return}},i.prototype.validateAssignmentExpression=function(i){var e=this._identifierBeingAssigned,t=this._assignmentValidationMode;o.isIdentifier(i.left)&&(this._identifierBeingAssigned=i.left.name.toLowerCase(),this._assignmentValidationMode="left"),this.validateExpression(i.left),o.isIdentifier(i.left)&&(this._assignmentValidationMode="right"),this.validateExpression(i.right),this._identifierBeingAssigned=e,this._assignmentValidationMode=t},i.prototype.validateCallExpression=function(i){var e,t,n=this;if(this.validateExpression(i.callee),o.isIdentifier(i.callee)){var a=i.callee.name.toLowerCase(),s=this.getIdentifierInfo(a),d=null===(t=null===(e=this._apiDefinitions)||void 0===e?void 0:e.functionDefinitions)||void 0===t?void 0:t.get(a);if(!s&&d){var c=function(i,e){if(!i||null==e||e<0)return null;var t=i.overloads.reduce((function(i,e){var t=e.parametersInfo,n=t.min,o=t.max;return i.min>=0&&(i.min=Math.min(n,i.min)),i.max>=0&&(i.max=o<0?o:Math.max(o,i.max)),i}),{min:1/0,max:0}),n=t.min,o=t.max;if(e<n)return n>0?{code:r.DiagnosticCodes.NotEnoughArguments,data:{min:n}}:{code:r.DiagnosticCodes.NoArgumentExpected};if(o>=0&&e>o)return{code:r.DiagnosticCodes.TooManyArguments,data:{max:o}};return null}(d,i.arguments.length);c&&this.logDiagnostic(i.loc,c)}}i.arguments.forEach((function(i){return n.validateExpression(i)}))},i.prototype.validateIdentifier=function(i){var e=i.name.toLowerCase(),t=this.getIdentifierInfo(e);if(t){if("left"===this._assignmentValidationMode&&this._identifierBeingAssigned===e)return void(t.initialized=!0);if("right"===this._assignmentValidationMode&&this._identifierBeingAssigned===e)return;t.used=!0}else if(!this.isProfileVariable(e)&&!this.isApiItem(e)){if(this._isInFunctionScope){var n=this._undeclaredIdentifiersInFunctions.get(e);return n||(n=[],this._undeclaredIdentifiersInFunctions.set(e,n)),void n.push({node:i,identifier:e})}this.logDiagnostic(i.loc,{code:r.DiagnosticCodes.NotDefined,data:{identifier:i.name}})}},i.prototype.validateLiteral=function(i){var e=this;(function(i){var e=[],t=null!=i?i:"",n=null;for(;n=f.exec(t);)e.push(n[0].slice(1));return e})(i.raw).forEach((function(i){var t=e.getIdentifierInfo(i.toLowerCase());t&&(t.used=!0)}))},i.prototype.logProfileOrApiConflict=function(i){var e=i.name.toLowerCase(),t=this.isProfileVariable(e),n=this.isApiItem(e);(t||n)&&this.logDiagnostic(i.loc,{code:t?r.DiagnosticCodes.ProfileVariablesConflict:r.DiagnosticCodes.ApiConflict,severity:s.DiagnosticSeverity.Warning,data:{identifier:i.name}})},i.prototype.logReservedKeywordsConflict=function(i){var e=i.name.toLowerCase();a.ArcadeReservedKeywords.includes(e)&&this.logDiagnostic(i.loc,{code:r.DiagnosticCodes.ReservedKeyword,severity:s.DiagnosticSeverity.Warning,data:{identifier:i.name}})},i.prototype.validateObjectExpression=function(i){var e=this;i.properties.forEach((function(i){e.validateExpression(i.value)}))},i.prototype.validateUnaryExpression=function(i){this.validateExpression(i.argument)},i.prototype.validateUpdateExpression=function(i){this.validateExpression(i.argument)},i.prototype.validateBinaryAndLogicalExpression=function(i){this.validateExpression(i.left),this.validateExpression(i.right)},i.prototype.validateMemberExpression=function(i){var e=this.flattenMemberExpressionAndValidate(i),t=e[0].object;this.disableRecordIdentifierAssignment(this.validateExpression,t),o.isIdentifier(t)&&(this.getIdentifierInfo(t.name.toLowerCase())||this.validateMemberExpressionWithProfile(e)||this.validateConstantMemberExpression(e))},i.prototype.flattenMemberExpressionAndValidate=function(i){switch(i.type){case"MemberExpression":return o.isIdentifier(i.property)&&!i.computed||this.validateExpression(i.property),n(n([],this.flattenMemberExpressionAndValidate(i.object)),[i]);default:return[]}},i.prototype.extractAndValidatePropertyName=function(i){switch(i.type){case"Identifier":return i.name.toLowerCase();case"Literal":return"string"!=typeof i.value?(this.logDiagnostic(i.loc,{code:r.DiagnosticCodes.UnexpectedPropertyIdentifier}),null):i.value.toLowerCase();default:return this.logDiagnostic(i.loc,{code:r.DiagnosticCodes.UnexpectedPropertyIdentifier}),null}},i.prototype.validateConstantMemberExpression=function(i){var e,t,n=i[0];if(!o.isIdentifier(n.object))return!1;var a=n.object.name.toLowerCase(),s=null===(t=null===(e=this._apiDefinitions)||void 0===e?void 0:e.constantDefinitions)||void 0===t?void 0:t.get(a);if(!s)return!1;if("namespace"!==s.type)return this.logDiagnostic(n.property.loc,{code:r.DiagnosticCodes.NotADictionary,data:{identifier:a}}),!0;var d=this.extractAndValidatePropertyName(n.property);if(!d)return!0;if(!s.members.some((function(i){return i.key===d}))){var c=s.members.reduce((function(i,e){return i+(i?" | ":"")+e.completion.label.split(".").pop()}),"");this.logDiagnostic(n.property.loc,{code:r.DiagnosticCodes.InvalidConstantIdentifier,data:{list:c}})}return i.length>1&&this.logDiagnostic(i[1].property.loc,{code:r.DiagnosticCodes.UnexpectedPropertyIdentifier}),!0},i.prototype.validateMemberExpressionWithProfile=function(i){var e,t,n,o=i[0];if("Identifier"!==o.object.type)return!1;var a=o.object.name.toLowerCase(),d=null===(e=this._profileVariables)||void 0===e?void 0:e.find((function(i){return i.key===a}));if(!d)return!1;if(c(d))return this.logDiagnostic(o.object.loc,{code:r.DiagnosticCodes.NotADictionary,data:{identifier:d.name}}),!0;if(this._identifierBeingAssigned===a)return this.logDiagnostic(o.loc,{code:r.DiagnosticCodes.ProfileVariablesAreImmutable}),!0;for(var l=d,p=function(e){if(i[e].computed)return{value:!0};if(c(l))return f.logDiagnostic(null!==(n=null===(t=i[e-1])||void 0===t?void 0:t.property.loc)&&void 0!==n?n:i[e].object.loc,{code:r.DiagnosticCodes.NotADictionary,data:{identifier:l.name}}),{value:!0};var o=f.extractAndValidatePropertyName(i[e].property);if(!o)return{value:!0};if(0===l.properties.length)return f.logDiagnostic(i[e].property.loc,{code:r.DiagnosticCodes.UnknownPropertyIdentifier,data:{identifier:o},severity:s.DiagnosticSeverity.Warning}),{value:!0};var a=l.properties.find((function(i){return i.name.toLowerCase()===o}));if(!a){var d=l.properties.reduce((function(i,e){return i+(i?" | ":"")+e.name.split(".").pop()}),"");return f.logDiagnostic(i[e].property.loc,{code:r.DiagnosticCodes.InvalidPropertyIdentifier,data:{list:d}}),{value:!0}}l=a},f=this,u=0;u<i.length;u++){var v=p(u);if("object"==typeof v)return v.value}return!0},i.prototype.recordVariableIdentifier=function(i,e){var t;this.logReservedKeywordsConflict(i),this.logProfileOrApiConflict(i);var n=i.name.toLowerCase(),o=this.getIdentifierInfo(n),a=o&&this._isInFunctionScope&&"function"===o.scope,d=o&&!this._isInFunctionScope&&"script"===o.scope;(a||d)&&this.logDiagnostic(i.loc,{code:r.DiagnosticCodes.AlreadyDefined,data:{identifier:i.name},severity:s.DiagnosticSeverity.Warning});var c=null!==(t=e.inBlock)&&void 0!==t?t:this._isInBlock,l=e.initialized;!o||this._isInFunctionScope&&"function"!==o.scope?o={node:i,used:!1,initialized:l,scope:this._isInFunctionScope?"function":c?"block":"script"}:(o.node=i,o.used=!1,o.initialized=l);return"block"!==o.scope||c||(o.scope="script",this.logDiagnostic(i.loc,{code:r.DiagnosticCodes.AlreadyDefined,data:{identifier:i.name},severity:s.DiagnosticSeverity.Warning})),this.setIdentiferInfo(n,o),!1},i.prototype.recordImportIdentifier=function(i){var e=i.specifiers[0].local;this.logProfileOrApiConflict(e);var n=e.name.toLowerCase(),o=this.getIdentifierInfo(n);(null==o?void 0:o.scope)&&this.logDiagnostic(i.specifiers[0].local.loc,{code:r.DiagnosticCodes.AlreadyDefined,data:{identifier:i.specifiers[0].local.name},severity:s.DiagnosticSeverity.Warning}),o=t(t({node:i.specifiers[0].local,used:!1},o),{scope:"script",initialized:!0}),this.setIdentiferInfo(n,o)},i.prototype.recordFunctionIdentifier=function(i){this.logProfileOrApiConflict(i.id);var e=i.id.name.toLowerCase(),n=this.getIdentifierInfo(e);(null==n?void 0:n.scope)&&this.logDiagnostic(i.id.loc,{code:r.DiagnosticCodes.AlreadyDefined,data:{identifier:i.id.name},severity:s.DiagnosticSeverity.Warning}),n=t(t({node:i.id,used:!1},n),{scope:"script",initialized:!0}),this.setIdentiferInfo(e,n)},i.prototype.recordParamAsIdentifier=function(i){return this.recordVariableIdentifier(i,{initialized:!0})},i.prototype.diagnoseIdentifiers=function(){var i,e=this;(null!==(i=this._functionScopeIdentifiers)&&void 0!==i?i:this._scriptScopeIdentifiers).forEach((function(i){i.node&&(i.used?i.initialized||e.logDiagnostic(i.node.loc,{code:r.DiagnosticCodes.DefinedNeverAssigned,data:{identifier:i.node.name},severity:s.DiagnosticSeverity.Warning}):e.logDiagnostic(i.node.loc,{code:i.initialized?r.DiagnosticCodes.AssignedNeverUsed:r.DiagnosticCodes.DefinedNeverUsed,data:{identifier:i.node.name},severity:s.DiagnosticSeverity.Warning}))}))},i}();function p(i){return o.isEmptyStatement(i)||o.isBlockStatement(i)&&!(null==i?void 0:i.body.length)}e.ArcadeValidationService=l;var f=new RegExp(/\B@\w+/g);e.validateScript=function(i,e,t){return void 0===e&&(e=[]),i?new l(t,e).validateScript(i):{diagnostics:[]}}}));