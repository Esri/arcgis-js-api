/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../lib/arcade-parser","./diagnosticMessages","./types","../lib/types"],(function(i,e,t,n,s,o){"use strict";function a(i,e){return e?i.replace(/\${(.*?)}/g,((i,t)=>e[t]?.toString()??"")):i}function r(i){return!!i&&"dictionary"!==i.type}let c=function(){function i(i,e=[]){this._apiDefinitions=i,this._profileVariables=e,this._isInBlock=!1,this._recordIdentifierAssignment=!1,this._scriptScopeIdentifiers=new Map,this._diagnostics=new Array,this._undeclaredIdentifiersInFunctions=new Map}var c=i.prototype;return c.validateScript=function(i){if(!i)return{diagnostics:[],program:null};this._isInBlock=!1,this._recordIdentifierAssignment=!1,this._diagnostics=[],this._scriptScopeIdentifiers.clear(),this._undeclaredIdentifiersInFunctions.clear(),this._functionScopeIdentifiers=void 0;let e=null;try{e=t.parse(i,{tolerant:!0}),this.handleErrors(e.errors),e.body.forEach((i=>this.validateStatement(i))),this.diagnoseIdentifiers(),this._undeclaredIdentifiersInFunctions.size>0&&this._undeclaredIdentifiersInFunctions.forEach((i=>{for(const e of i)this.logDiagnostic(e.node.loc,{code:n.DiagnosticCodes.NotDefined,data:{identifier:e.node.name}})}))}catch(s){this.handleException(s)}return{diagnostics:this._diagnostics,program:e}},c.recordIdentifierAssignment=function(i,e,t=!0){const n=this._recordIdentifierAssignment;this._recordIdentifierAssignment=t,i.call(this,e),this._recordIdentifierAssignment=n},c.inBlock=function(i,e){const t=this._isInBlock;this._isInBlock=!0,i.call(this,e),this._isInBlock=t},c.inFunctionScope=function(i){this._functionScopeIdentifiers=new Map,i.call(this),this.diagnoseIdentifiers(),this._functionScopeIdentifiers=void 0},c.logDiagnostic=function(i,e){const t={severity:s.DiagnosticSeverity.Error,...e,message:a(n.DiagnosticMessages[e.code]??o.ParsingErrorMessages[e.code],e.data),range:{start:{line:i.start.line-1,character:i.start.column},end:{line:i.end.line-1,character:i.end.column}}};this._diagnostics.push(t)},c.handleErrors=function(i){(i??[]).forEach(this.handleException,this)},c.handleException=function(i){if(d(i)){const{range:e,code:t,data:n}=i;this.logDiagnostic(e,{code:t,data:n})}else this.logDiagnostic({start:{line:1,column:0},end:{line:1,column:0}},{code:n.DiagnosticCodes.ExecutionError,data:{stack:i.stack}})},c.getIdentifierInfo=function(i){return this._functionScopeIdentifiers?.get(i)??this._scriptScopeIdentifiers.get(i)},c.setIdentiferInfo=function(i,e){this._functionScopeIdentifiers?this._functionScopeIdentifiers.set(i,e):((this._functionScopeIdentifiers??this._scriptScopeIdentifiers).set(i,e),this._functionScopeIdentifiers||this._undeclaredIdentifiersInFunctions.has(i)&&(this._undeclaredIdentifiersInFunctions.delete(i),e.used=!0))},c.isProfileVariable=function(i){return(this._profileVariables??[]).some((e=>e.name.toLowerCase()===i))},c.isApiItem=function(i){const e=!!this._apiDefinitions?.constantDefinitions?.get(i),t=!!this._apiDefinitions?.functionDefinitions?.get(i);return e||t},c.validateStatement=function(i){if(i)switch(i.type){case o.Syntax.BlockStatement:return void i.body.forEach((i=>this.validateStatement(i)));case o.Syntax.VariableDeclaration:return void i.declarations.forEach((i=>this.validateVariableDeclarator(i)));case o.Syntax.FunctionDeclaration:return void this.validateFunctionDeclaration(i);case o.Syntax.ExportNamedDeclaration:return void this.validateExportDeclaration(i);case o.Syntax.ImportDeclaration:return void this.validateImportDeclaration(i);case o.Syntax.WhileStatement:return void this.validateWhileStatement(i);case o.Syntax.ForStatement:return void this.validateForStatement(i);case o.Syntax.ForInStatement:return void this.validateForInStatement(i);case o.Syntax.IfStatement:return void this.validateIfStatement(i);case o.Syntax.ReturnStatement:return void this.validateExpression(i.argument);case o.Syntax.ExpressionStatement:return void this.validateExpression(i.expression);case o.Syntax.BreakStatement:case o.Syntax.ContinueStatement:case o.Syntax.EmptyStatement:return}},c.validateVariableDeclarator=function(i){this.validateExpression(i.init),this.recordVariableIdentifier(i.id,{initialized:!!i.init})},c.validateFunctionDeclaration=function(i){this.recordFunctionIdentifier(i),this.inFunctionScope((()=>{i.params.forEach((i=>this.recordParamAsIdentifier(i))),l(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.UnexpectedEmptyFunction,data:{identifier:i.id.name},severity:s.DiagnosticSeverity.Warning}),this.validateStatement(i.body)}))},c.validateExportDeclaration=function(i){this.validateStatement(i.declaration)},c.validateImportDeclaration=function(i){this.recordImportIdentifier(i)},c.validateForStatement=function(i){o.isVariableDeclaration(i.init)?this.inBlock(this.validateStatement,i.init):this.validateExpression(i.init),this.validateExpression(i.update),this.validateExpression(i.test),l(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.body)},c.validateWhileStatement=function(i){this.validateExpression(i.test),l(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.body)},c.validateForInStatement=function(i){o.isIdentifier(i.left)?this.validateExpression(i.left):this.recordVariableIdentifier(i.left.declarations[0].id,{initialized:!0,inBlock:!0}),this.validateExpression(i.right),l(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.validateStatement(i.body)},c.validateIfStatement=function(i){this.validateExpression(i.test),l(i.consequent)&&this.logDiagnostic(i.consequent.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),i.alternate&&l(i.alternate)&&this.logDiagnostic(i.alternate.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:s.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.consequent),this.inBlock(this.validateStatement,i.alternate)},c.validateExpression=function(i){if(i)switch(i.type){case o.Syntax.AssignmentExpression:return void this.validateAssignmentExpression(i);case o.Syntax.CallExpression:return void this.validateCallExpression(i);case o.Syntax.Identifier:return void this.validateIdentifier(i);case o.Syntax.Literal:return;case o.Syntax.ArrayExpression:return void i.elements.forEach((i=>this.validateExpression(i)));case o.Syntax.ObjectExpression:return void this.validateObjectExpression(i);case o.Syntax.UnaryExpression:return void this.validateUnaryExpression(i);case o.Syntax.UpdateExpression:return void this.validateUpdateExpression(i);case o.Syntax.BinaryExpression:case o.Syntax.LogicalExpression:return void this.validateBinaryAndLogicalExpression(i);case o.Syntax.MemberExpression:return void this.validateMemberExpression(i);case o.Syntax.TemplateLiteral:return void i.expressions.forEach((i=>this.validateExpression(i)));default:return}},c.validateAssignmentExpression=function(i){this.recordIdentifierAssignment(this.validateExpression,i.left),this.validateExpression(i.right)},c.validateCallExpression=function(i){if(this.validateExpression(i.callee),o.isIdentifier(i.callee)){const e=i.callee.name.toLowerCase(),t=this.getIdentifierInfo(e),n=this._apiDefinitions?.functionDefinitions?.get(e);if(!t&&n){const e=f(n,i.arguments.length);e&&this.logDiagnostic(i.loc,e)}}i.arguments.forEach((i=>this.validateExpression(i)))},c.validateIdentifier=function(i){const e=i.name.toLowerCase(),t=this.getIdentifierInfo(e);if(t)return this._recordIdentifierAssignment?void(t.initialized=!0):void(t.used=!0);if(!this.isProfileVariable(e)&&!this.isApiItem(e)){if(this._isInFunctionScope){let t=this._undeclaredIdentifiersInFunctions.get(e);return t||(t=[],this._undeclaredIdentifiersInFunctions.set(e,t)),void t.push({node:i,identifier:e})}this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.NotDefined,data:{identifier:i.name}})}},c.logProfileOrApiConflict=function(i){const e=i.name.toLowerCase(),t=this.isProfileVariable(e),o=this.isApiItem(e);(t||o)&&this.logDiagnostic(i.loc,{code:t?n.DiagnosticCodes.ProfileVariablesConflict:n.DiagnosticCodes.ApiConflict,severity:s.DiagnosticSeverity.Warning,data:{identifier:i.name}})},c.validateObjectExpression=function(i){i.properties.forEach((i=>{this.validateExpression(i.value)}))},c.validateUnaryExpression=function(i){this.validateExpression(i.argument)},c.validateUpdateExpression=function(i){this.validateExpression(i.argument)},c.validateBinaryAndLogicalExpression=function(i){this.validateExpression(i.left),this.validateExpression(i.right)},c.validateMemberExpression=function(i){const e=this.flattenMemberExpressionAndValidate(i),t=e[0].object;this.recordIdentifierAssignment(this.validateExpression,t,!1),o.isIdentifier(t)&&(this.getIdentifierInfo(t.name.toLowerCase())||this.validateMemberExpressionWithProfile(e)||this.validateConstantMemberExpression(e))},c.flattenMemberExpressionAndValidate=function(i){return i.type===o.Syntax.MemberExpression?(o.isIdentifier(i.property)&&!i.computed||this.validateExpression(i.property),[...this.flattenMemberExpressionAndValidate(i.object),i]):[]},c.extractAndValidatePropertyName=function(i){switch(i.type){case"Identifier":return i.name.toLowerCase();case"Literal":return"string"!=typeof i.value?(this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.UnexpectedPropertyIdentifier}),null):i.value.toLowerCase();default:return this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.UnexpectedPropertyIdentifier}),null}},c.validateConstantMemberExpression=function(i){const e=i[0];if(!o.isIdentifier(e.object))return!1;const t=e.object.name.toLowerCase(),s=this._apiDefinitions?.constantDefinitions?.get(t);if(!s)return!1;if("namespace"!==s.type)return this.logDiagnostic(e.property.loc,{code:n.DiagnosticCodes.NotADictionary,data:{identifier:t}}),!0;const a=this.extractAndValidatePropertyName(e.property);if(!a)return!0;if(!s.members.some((i=>i.key===a))){const i=s.members.reduce(((i,e)=>`${i}${i?" | ":""}${e.completion.label.split(".").pop()}`),"");this.logDiagnostic(e.property.loc,{code:n.DiagnosticCodes.InvalidConstantIdentifier,data:{list:i}})}return i.length>1&&this.logDiagnostic(i[1].property.loc,{code:n.DiagnosticCodes.UnexpectedPropertyIdentifier}),!0},c.validateMemberExpressionWithProfile=function(i){const e=i[0];if(e.object.type!==o.Syntax.Identifier)return!1;const t=e.object.name.toLowerCase(),a=this._profileVariables?.find((i=>i.key===t));if(!a)return!1;if(r(a))return this.logDiagnostic(e.object.loc,{code:n.DiagnosticCodes.NotADictionary,data:{identifier:a.name}}),!0;if(this._recordIdentifierAssignment)return this.logDiagnostic(e.loc,{code:n.DiagnosticCodes.ProfileVariablesAreImmutable}),!0;let c=a;for(let o=0;o<i.length;o++){if(i[o].computed)return!0;if(r(c))return this.logDiagnostic(i[o-1]?.property.loc??i[o].object.loc,{code:n.DiagnosticCodes.NotADictionary,data:{identifier:c.name}}),!0;const e=this.extractAndValidatePropertyName(i[o].property);if(!e)return!0;if(0===c.properties.length)return this.logDiagnostic(i[o].property.loc,{code:n.DiagnosticCodes.UnknownPropertyIdentifier,data:{identifier:e},severity:s.DiagnosticSeverity.Warning}),!0;const t=c.properties.find((i=>i.name.toLowerCase()===e));if(!t){const e=c.properties.reduce(((i,e)=>`${i}${i?" | ":""}${e.name.split(".").pop()}`),"");return this.logDiagnostic(i[o].property.loc,{code:n.DiagnosticCodes.InvalidPropertyIdentifier,data:{list:e}}),!0}c=t}return!0},c.recordVariableIdentifier=function(i,e){this.logProfileOrApiConflict(i);const t=i.name.toLowerCase();let o=this.getIdentifierInfo(t);const a=o&&this._isInFunctionScope&&"function"===o.scope,r=o&&!this._isInFunctionScope&&"script"===o.scope;(a||r)&&this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.name},severity:s.DiagnosticSeverity.Warning});const c=e.inBlock??this._isInBlock,{initialized:d}=e;if(!o||this._isInFunctionScope&&"function"!==o.scope){o={node:i,used:!1,initialized:d,scope:this._isInFunctionScope?"function":c?"block":"script"}}else o.node=i,o.used=!1,o.initialized=d;return"block"!==o.scope||c||(o.scope="script",this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.name},severity:s.DiagnosticSeverity.Warning})),this.setIdentiferInfo(t,o),!1},c.recordImportIdentifier=function(i){const e=i.specifiers[0].local;this.logProfileOrApiConflict(e);const t=e.name.toLowerCase();let o=this.getIdentifierInfo(t);o?.scope&&this.logDiagnostic(i.specifiers[0].local.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.specifiers[0].local.name},severity:s.DiagnosticSeverity.Warning}),o={node:i.specifiers[0].local,used:!1,...o,scope:"script",initialized:!0},this.setIdentiferInfo(t,o)},c.recordFunctionIdentifier=function(i){this.logProfileOrApiConflict(i.id);const e=i.id.name.toLowerCase();let t=this.getIdentifierInfo(e);t?.scope&&this.logDiagnostic(i.id.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.id.name},severity:s.DiagnosticSeverity.Warning}),t={node:i.id,used:!1,...t,scope:"script",initialized:!0},this.setIdentiferInfo(e,t)},c.recordParamAsIdentifier=function(i){return this.recordVariableIdentifier(i,{initialized:!0})},c.diagnoseIdentifiers=function(){(this._functionScopeIdentifiers??this._scriptScopeIdentifiers).forEach((i=>{i.node&&(i.used?i.initialized||this.logDiagnostic(i.node.loc,{code:n.DiagnosticCodes.DefinedNeverAssigned,data:{identifier:i.node.name},severity:s.DiagnosticSeverity.Warning}):this.logDiagnostic(i.node.loc,{code:i.initialized?n.DiagnosticCodes.AssignedNeverUsed:n.DiagnosticCodes.DefinedNeverUsed,data:{identifier:i.node.name},severity:s.DiagnosticSeverity.Warning}))}))},e._createClass(i,[{key:"_isInFunctionScope",get:function(){return!!this._functionScopeIdentifiers}}]),i}();function d(i){return"ParsingError"===i?.name}function l(i){return o.isEmptyStatement(i)||o.isBlockStatement(i)&&!i?.body.length}function f(i,e){if(!i||null==e||e<0)return null;let t=null;for(const s of i.overloads){const{min:i,max:o}=s.parametersInfo;if(e<i)t=i>0?{code:n.DiagnosticCodes.NotEnoughArguments,data:{min:i}}:{code:n.DiagnosticCodes.NoArgumentExpected};else{if(!(o>=0&&e>o))return null;t={code:n.DiagnosticCodes.TooManyArguments,data:{max:o}}}}return t}function p(i,e=[],t){if(!i)return{diagnostics:[]};return new c(t,e).validateScript(i)}i.ArcadeValidationService=c,i.format=a,i.isValueVariable=r,i.validateScript=p,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
