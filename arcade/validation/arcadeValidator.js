/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../lib/arcade-parser","./diagnosticMessages","./languageKeywords","./types","../lib/types"],(function(i,e,t,n,s,o,a){"use strict";function r(i,e){return e?i.replace(/\${(.*?)}/g,((i,t)=>e[t]?.toString()??"")):i}function c(i){return!!i&&"dictionary"!==i.type}let d=function(){function i(i,e=[]){this._apiDefinitions=i,this._profileVariables=e,this._isInBlock=!1,this._identifierBeingAssigned=void 0,this._assignmentValidationMode="disabled",this._scriptScopeIdentifiers=new Map,this._diagnostics=new Array,this._undeclaredIdentifiersInFunctions=new Map}var d=i.prototype;return d.validateScript=function(i){if(!i)return{diagnostics:[],program:null};this._isInBlock=!1,this._identifierBeingAssigned=void 0,this._assignmentValidationMode="disabled",this._diagnostics=[],this._scriptScopeIdentifiers.clear(),this._undeclaredIdentifiersInFunctions.clear(),this._functionScopeIdentifiers=void 0;let e=null;try{e=t.parse(i,{tolerant:!0}),this.handleErrors(e.errors),e.body.forEach((i=>this.validateStatement(i))),this.diagnoseIdentifiers(),this._undeclaredIdentifiersInFunctions.size>0&&this._undeclaredIdentifiersInFunctions.forEach((i=>{for(const e of i)this.logDiagnostic(e.node.loc,{code:n.DiagnosticCodes.NotDefined,data:{identifier:e.node.name}})}))}catch(s){this.handleException(s)}return{diagnostics:this._diagnostics,program:e}},d.disableRecordIdentifierAssignment=function(i,e){const t=this._assignmentValidationMode;this._assignmentValidationMode="disabled",i.call(this,e),this._assignmentValidationMode=t},d.inBlock=function(i,e){const t=this._isInBlock;this._isInBlock=!0,i.call(this,e),this._isInBlock=t},d.inFunctionScope=function(i){this._functionScopeIdentifiers=new Map,i.call(this),this.diagnoseIdentifiers(),this._functionScopeIdentifiers=void 0},d.logDiagnostic=function(i,e){const t={severity:o.DiagnosticSeverity.Error,...e,message:r(n.DiagnosticMessages[e.code]??a.ParsingErrorMessages[e.code],e.data),range:{start:{line:i.start.line-1,character:i.start.column},end:{line:i.end.line-1,character:i.end.column}}};this._diagnostics.push(t)},d.handleErrors=function(i){(i??[]).forEach(this.handleException,this)},d.handleException=function(i){if(l(i)){const{range:e,code:t,data:n}=i;this.logDiagnostic(e,{code:t,data:n})}else this.logDiagnostic({start:{line:1,column:0},end:{line:1,column:0}},{code:n.DiagnosticCodes.ExecutionError,data:{stack:i.stack}})},d.getIdentifierInfo=function(i){return this._functionScopeIdentifiers?.get(i)??this._scriptScopeIdentifiers.get(i)},d.setIdentiferInfo=function(i,e){this._functionScopeIdentifiers?this._functionScopeIdentifiers.set(i,e):((this._functionScopeIdentifiers??this._scriptScopeIdentifiers).set(i,e),this._functionScopeIdentifiers||this._undeclaredIdentifiersInFunctions.has(i)&&(this._undeclaredIdentifiersInFunctions.delete(i),e.used=!0))},d.isProfileVariable=function(i){return(this._profileVariables??[]).some((e=>e.name.toLowerCase()===i))},d.isApiItem=function(i){const e=!!this._apiDefinitions?.constantDefinitions?.get(i),t=!!this._apiDefinitions?.functionDefinitions?.get(i);return e||t},d.validateStatement=function(i){if(i)switch(i.type){case a.Syntax.BlockStatement:return void i.body.forEach((i=>this.validateStatement(i)));case a.Syntax.VariableDeclaration:return void i.declarations.forEach((i=>this.validateVariableDeclarator(i)));case a.Syntax.FunctionDeclaration:return void this.validateFunctionDeclaration(i);case a.Syntax.ExportNamedDeclaration:return void this.validateExportDeclaration(i);case a.Syntax.ImportDeclaration:return void this.validateImportDeclaration(i);case a.Syntax.WhileStatement:return void this.validateWhileStatement(i);case a.Syntax.ForStatement:return void this.validateForStatement(i);case a.Syntax.ForInStatement:return void this.validateForInStatement(i);case a.Syntax.IfStatement:return void this.validateIfStatement(i);case a.Syntax.ReturnStatement:return void this.validateExpression(i.argument);case a.Syntax.ExpressionStatement:return void this.validateExpression(i.expression);case a.Syntax.BreakStatement:case a.Syntax.ContinueStatement:case a.Syntax.EmptyStatement:return}},d.validateVariableDeclarator=function(i){this.validateExpression(i.init),this.recordVariableIdentifier(i.id,{initialized:!!i.init})},d.validateFunctionDeclaration=function(i){this.recordFunctionIdentifier(i),this.inFunctionScope((()=>{i.params.forEach((i=>this.recordParamAsIdentifier(i))),f(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.UnexpectedEmptyFunction,data:{identifier:i.id.name},severity:o.DiagnosticSeverity.Warning}),this.validateStatement(i.body)}))},d.validateExportDeclaration=function(i){this.validateStatement(i.declaration)},d.validateImportDeclaration=function(i){this.recordImportIdentifier(i)},d.validateForStatement=function(i){a.isVariableDeclaration(i.init)?this.inBlock(this.validateStatement,i.init):this.validateExpression(i.init),this.validateExpression(i.update),this.validateExpression(i.test),f(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:o.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.body)},d.validateWhileStatement=function(i){this.validateExpression(i.test),f(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:o.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.body)},d.validateForInStatement=function(i){a.isIdentifier(i.left)?this.validateExpression(i.left):this.recordVariableIdentifier(i.left.declarations[0].id,{initialized:!0,inBlock:!0}),this.validateExpression(i.right),f(i.body)&&this.logDiagnostic(i.body.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:o.DiagnosticSeverity.Warning}),this.validateStatement(i.body)},d.validateIfStatement=function(i){this.validateExpression(i.test),f(i.consequent)&&this.logDiagnostic(i.consequent.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:o.DiagnosticSeverity.Warning}),i.alternate&&f(i.alternate)&&this.logDiagnostic(i.alternate.loc,{code:n.DiagnosticCodes.EmptyBlockStatement,severity:o.DiagnosticSeverity.Warning}),this.inBlock(this.validateStatement,i.consequent),this.inBlock(this.validateStatement,i.alternate)},d.validateExpression=function(i){if(i)switch(i.type){case a.Syntax.AssignmentExpression:return void this.validateAssignmentExpression(i);case a.Syntax.CallExpression:return void this.validateCallExpression(i);case a.Syntax.Identifier:return void this.validateIdentifier(i);case a.Syntax.Literal:return void this.validateLiteral(i);case a.Syntax.ArrayExpression:return void i.elements.forEach((i=>this.validateExpression(i)));case a.Syntax.ObjectExpression:return void this.validateObjectExpression(i);case a.Syntax.UnaryExpression:return void this.validateUnaryExpression(i);case a.Syntax.UpdateExpression:return void this.validateUpdateExpression(i);case a.Syntax.BinaryExpression:case a.Syntax.LogicalExpression:return void this.validateBinaryAndLogicalExpression(i);case a.Syntax.MemberExpression:return void this.validateMemberExpression(i);case a.Syntax.TemplateLiteral:return void i.expressions.forEach((i=>this.validateExpression(i)));default:return}},d.validateAssignmentExpression=function(i){const e=this._identifierBeingAssigned,t=this._assignmentValidationMode;a.isIdentifier(i.left)&&(this._identifierBeingAssigned=i.left.name.toLowerCase(),this._assignmentValidationMode="left"),this.validateExpression(i.left),a.isIdentifier(i.left)&&(this._assignmentValidationMode="right"),this.validateExpression(i.right),this._identifierBeingAssigned=e,this._assignmentValidationMode=t},d.validateCallExpression=function(i){if(this.validateExpression(i.callee),a.isIdentifier(i.callee)){const e=i.callee.name.toLowerCase(),t=this.getIdentifierInfo(e),n=this._apiDefinitions?.functionDefinitions?.get(e);if(!t&&n){const e=h(n,i.arguments.length);e&&this.logDiagnostic(i.loc,e)}}i.arguments.forEach((i=>this.validateExpression(i)))},d.validateIdentifier=function(i){const e=i.name.toLowerCase(),t=this.getIdentifierInfo(e);if(t){if("left"===this._assignmentValidationMode&&this._identifierBeingAssigned===e)return void(t.initialized=!0);if("right"===this._assignmentValidationMode&&this._identifierBeingAssigned===e)return;t.used=!0}else if(!this.isProfileVariable(e)&&!this.isApiItem(e)){if(this._isInFunctionScope){let t=this._undeclaredIdentifiersInFunctions.get(e);return t||(t=[],this._undeclaredIdentifiersInFunctions.set(e,t)),void t.push({node:i,identifier:e})}this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.NotDefined,data:{identifier:i.name}})}},d.validateLiteral=function(i){p(i.raw).forEach((i=>{const e=this.getIdentifierInfo(i.toLowerCase());e&&(e.used=!0)}))},d.logProfileOrApiConflict=function(i){const e=i.name.toLowerCase(),t=this.isProfileVariable(e),s=this.isApiItem(e);(t||s)&&this.logDiagnostic(i.loc,{code:t?n.DiagnosticCodes.ProfileVariablesConflict:n.DiagnosticCodes.ApiConflict,severity:o.DiagnosticSeverity.Warning,data:{identifier:i.name}})},d.logReservedKeywordsConflict=function(i){const e=i.name.toLowerCase();s.ArcadeReservedKeywords.includes(e)&&this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.ReservedKeyword,severity:o.DiagnosticSeverity.Warning,data:{identifier:i.name}})},d.validateObjectExpression=function(i){i.properties.forEach((i=>{this.validateExpression(i.value)}))},d.validateUnaryExpression=function(i){this.validateExpression(i.argument)},d.validateUpdateExpression=function(i){this.validateExpression(i.argument)},d.validateBinaryAndLogicalExpression=function(i){this.validateExpression(i.left),this.validateExpression(i.right)},d.validateMemberExpression=function(i){const e=this.flattenMemberExpressionAndValidate(i),t=e[0].object;this.disableRecordIdentifierAssignment(this.validateExpression,t),a.isIdentifier(t)&&(this.getIdentifierInfo(t.name.toLowerCase())||this.validateMemberExpressionWithProfile(e)||this.validateConstantMemberExpression(e))},d.flattenMemberExpressionAndValidate=function(i){return i.type===a.Syntax.MemberExpression?(a.isIdentifier(i.property)&&!i.computed||this.validateExpression(i.property),[...this.flattenMemberExpressionAndValidate(i.object),i]):[]},d.extractAndValidatePropertyName=function(i){switch(i.type){case"Identifier":return i.name.toLowerCase();case"Literal":return"string"!=typeof i.value?(this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.UnexpectedPropertyIdentifier}),null):i.value.toLowerCase();default:return this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.UnexpectedPropertyIdentifier}),null}},d.validateConstantMemberExpression=function(i){const e=i[0];if(!a.isIdentifier(e.object))return!1;const t=e.object.name.toLowerCase(),s=this._apiDefinitions?.constantDefinitions?.get(t);if(!s)return!1;if("namespace"!==s.type)return this.logDiagnostic(e.property.loc,{code:n.DiagnosticCodes.NotADictionary,data:{identifier:t}}),!0;const o=this.extractAndValidatePropertyName(e.property);if(!o)return!0;if(!s.members.some((i=>i.key===o))){const i=s.members.reduce(((i,e)=>`${i}${i?" | ":""}${e.completion.label.split(".").pop()}`),"");this.logDiagnostic(e.property.loc,{code:n.DiagnosticCodes.InvalidConstantIdentifier,data:{list:i}})}return i.length>1&&this.logDiagnostic(i[1].property.loc,{code:n.DiagnosticCodes.UnexpectedPropertyIdentifier}),!0},d.validateMemberExpressionWithProfile=function(i){const e=i[0];if(e.object.type!==a.Syntax.Identifier)return!1;const t=e.object.name.toLowerCase(),s=this._profileVariables?.find((i=>i.key===t));if(!s)return!1;if(c(s))return this.logDiagnostic(e.object.loc,{code:n.DiagnosticCodes.NotADictionary,data:{identifier:s.name}}),!0;if(this._identifierBeingAssigned===t)return this.logDiagnostic(e.loc,{code:n.DiagnosticCodes.ProfileVariablesAreImmutable}),!0;let r=s;for(let a=0;a<i.length;a++){if(i[a].computed)return!0;if(c(r))return this.logDiagnostic(i[a-1]?.property.loc??i[a].object.loc,{code:n.DiagnosticCodes.NotADictionary,data:{identifier:r.name}}),!0;const e=this.extractAndValidatePropertyName(i[a].property);if(!e)return!0;if(0===r.properties.length)return this.logDiagnostic(i[a].property.loc,{code:n.DiagnosticCodes.UnknownPropertyIdentifier,data:{identifier:e},severity:o.DiagnosticSeverity.Warning}),!0;const t=r.properties.find((i=>i.name.toLowerCase()===e));if(!t){const e=r.properties.reduce(((i,e)=>`${i}${i?" | ":""}${e.name.split(".").pop()}`),"");return this.logDiagnostic(i[a].property.loc,{code:n.DiagnosticCodes.InvalidPropertyIdentifier,data:{list:e}}),!0}r=t}return!0},d.recordVariableIdentifier=function(i,e){this.logReservedKeywordsConflict(i),this.logProfileOrApiConflict(i);const t=i.name.toLowerCase();let s=this.getIdentifierInfo(t);const a=s&&this._isInFunctionScope&&"function"===s.scope,r=s&&!this._isInFunctionScope&&"script"===s.scope;(a||r)&&this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.name},severity:o.DiagnosticSeverity.Warning});const c=e.inBlock??this._isInBlock,{initialized:d}=e;if(!s||this._isInFunctionScope&&"function"!==s.scope){s={node:i,used:!1,initialized:d,scope:this._isInFunctionScope?"function":c?"block":"script"}}else s.node=i,s.used=!1,s.initialized=d;return"block"!==s.scope||c||(s.scope="script",this.logDiagnostic(i.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.name},severity:o.DiagnosticSeverity.Warning})),this.setIdentiferInfo(t,s),!1},d.recordImportIdentifier=function(i){const e=i.specifiers[0].local;this.logProfileOrApiConflict(e);const t=e.name.toLowerCase();let s=this.getIdentifierInfo(t);s?.scope&&this.logDiagnostic(i.specifiers[0].local.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.specifiers[0].local.name},severity:o.DiagnosticSeverity.Warning}),s={node:i.specifiers[0].local,used:!1,...s,scope:"script",initialized:!0},this.setIdentiferInfo(t,s)},d.recordFunctionIdentifier=function(i){this.logProfileOrApiConflict(i.id);const e=i.id.name.toLowerCase();let t=this.getIdentifierInfo(e);t?.scope&&this.logDiagnostic(i.id.loc,{code:n.DiagnosticCodes.AlreadyDefined,data:{identifier:i.id.name},severity:o.DiagnosticSeverity.Warning}),t={node:i.id,used:!1,...t,scope:"script",initialized:!0},this.setIdentiferInfo(e,t)},d.recordParamAsIdentifier=function(i){return this.recordVariableIdentifier(i,{initialized:!0})},d.diagnoseIdentifiers=function(){(this._functionScopeIdentifiers??this._scriptScopeIdentifiers).forEach((i=>{i.node&&(i.used?i.initialized||this.logDiagnostic(i.node.loc,{code:n.DiagnosticCodes.DefinedNeverAssigned,data:{identifier:i.node.name},severity:o.DiagnosticSeverity.Warning}):this.logDiagnostic(i.node.loc,{code:i.initialized?n.DiagnosticCodes.AssignedNeverUsed:n.DiagnosticCodes.DefinedNeverUsed,data:{identifier:i.node.name},severity:o.DiagnosticSeverity.Warning}))}))},e._createClass(i,[{key:"_isInFunctionScope",get:function(){return!!this._functionScopeIdentifiers}}]),i}();function l(i){return"ParsingError"===i?.name}function f(i){return a.isEmptyStatement(i)||a.isBlockStatement(i)&&!i?.body.length}function h(i,e){if(!i||null==e||e<0)return null;const{min:t,max:s}=i.overloads.reduce(((i,e)=>{const{min:t,max:n}=e.parametersInfo;return i.min>=0&&(i.min=Math.min(t,i.min)),i.max>=0&&(i.max=n<0?n:Math.max(n,i.max)),i}),{min:1/0,max:0});return e<t?t>0?{code:n.DiagnosticCodes.NotEnoughArguments,data:{min:t}}:{code:n.DiagnosticCodes.NoArgumentExpected}:s>=0&&e>s?{code:n.DiagnosticCodes.TooManyArguments,data:{max:s}}:null}const g=new RegExp(/\B@\w+/g);function p(i){return Array.from((i??"").matchAll(g),(i=>i[0].slice(1)))}function u(i,e=[],t){if(!i)return{diagnostics:[]};return new d(t,e).validateScript(i)}i.ArcadeValidationService=d,i.format=r,i.isValueVariable=c,i.validateScript=u,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})}));
