// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../config","../intl","../kernel","../request","../core/Error","../core/JSONSupport","../core/lang","../core/Loadable","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../geometry/Extent","./PortalQueryParams","./PortalQueryResult","./PortalUser","@dojo/framework/shim/Promise"],(function(e,r,t,o,n,a,i,p,u,s,l,c,d,y,_,h,f,v,m){"use strict";var g,S={PortalGroup:function(){return new Promise((function(r,t){e(["./PortalGroup"],r,t)}))},PortalItem:function(){return new Promise((function(r,t){e(["./PortalItem"],r,t)}))},PortalUser:function(){return new Promise((function(r,t){e(["./PortalUser"],r,t)}))}};return function(r){function u(e){var t=r.call(this,e)||this;return t.access=null,t.allSSL=!1,t.authMode="auto",t.authorizedCrossOriginDomains=null,t.basemapGalleryGroupQuery=null,t.bingKey=null,t.canListApps=!1,t.canListData=!1,t.canListPreProvisionedItems=!1,t.canProvisionDirectPurchase=!1,t.canSearchPublic=!0,t.canShareBingPublic=!1,t.canSharePublic=!1,t.canSignInArcGIS=!1,t.canSignInIDP=!1,t.colorSetsGroupQuery=null,t.commentsEnabled=!1,t.created=null,t.culture=null,t.customBaseUrl=null,t.defaultBasemap=null,t.defaultExtent=null,t.defaultVectorBasemap=null,t.description=null,t.eueiEnabled=null,t.featuredGroups=null,t.featuredItemsGroupQuery=null,t.galleryTemplatesGroupQuery=null,t.livingAtlasGroupQuery=null,t.hasCategorySchema=!1,t.helperServices=null,t.homePageFeaturedContent=null,t.homePageFeaturedContentCount=null,t.httpPort=null,t.httpsPort=null,t.id=null,t.ipCntryCode=null,t.isPortal=!1,t.isReadOnly=!1,t.layerTemplatesGroupQuery=null,t.maxTokenExpirationMinutes=null,t.modified=null,t.name=null,t.portalHostname=null,t.portalMode=null,t.portalProperties=null,t.region=null,t.rotatorPanels=null,t.showHomePageDescription=!1,t.sourceJSON=null,t.supportsHostedServices=!1,t.symbolSetsGroupQuery=null,t.templatesGroupQuery=null,t.units=null,t.url=o.portalUrl,t.urlKey=null,t.user=null,t.useStandardizedQuery=!1,t.useVectorBasemaps=!1,t.vectorBasemapGalleryGroupQuery=null,t}var l;return t.__extends(u,r),l=u,u.prototype.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e},u.prototype.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},u.prototype.readAuthorizedCrossOriginDomains=function(e){if(e)for(var r=0,t=e;r<t.length;r++){var n=t[r];-1===o.request.trustedServers.indexOf(n)&&o.request.trustedServers.push(n)}return e},u.prototype.readDefaultBasemap=function(e){if(e){var r=g.fromJSON(e);return r.portalItem={portal:this},r}return null},u.prototype.readDefaultVectorBasemap=function(e){if(e){var r=g.fromJSON(e);return r.portalItem={portal:this},r}return null},Object.defineProperty(u.prototype,"extraQuery",{get:function(){var e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?" AND orgid:"+this.id:null},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"isOrganization",{get:function(){return!!this.access},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"restUrl",{get:function(){var e=this.url;if(e){var r=e.indexOf("/sharing");e=r>0?e.substring(0,r):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"thumbnailUrl",{get:function(){var e=this.restUrl,r=this.thumbnail;return e&&r?this._normalizeSSL(e+"/portals/self/resources/"+r):null},enumerable:!1,configurable:!0}),u.prototype.readUrlKey=function(e){return e?e.toLowerCase():e},u.prototype.readUser=function(e){var r=null;return e&&((r=m.fromJSON(e)).portal=this),r},u.prototype.load=function(r){var t=this,o=new Promise((function(r,t){e(["../Basemap"],r,t)})).then((function(e){d.throwIfAborted(r),g=e})).then((function(){return t.sourceJSON?t.sourceJSON:t._fetchSelf(t.authMode,!1,r)})).then((function(e){if(a.id){var r=a.id;t.credential=r.findCredential(t.restUrl),t.credential||t.authMode!==l.AUTH_MODE_AUTO||(t._esriId_credentialCreateHandle=r.on("credential-create",(function(){r.findCredential(t.restUrl)&&t._signIn()})))}t.sourceJSON=e,t.read(e)}));return this.addResolvingPromise(o),d.resolve(this)},u.prototype.createClosestFacilityTask=function(){return t.__awaiter(this,void 0,void 0,(function(){var r;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),r=this._getHelperServiceUrl("closestFacility"),[4,new Promise((function(r,t){e(["../tasks/ClosestFacilityTask"],r,t)}))];case 2:return[2,new(t.sent())(r)]}}))}))},u.prototype.createElevationLayers=function(){return t.__awaiter(this,void 0,void 0,(function(){var r,o;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),r=this._getHelperService("defaultElevationLayers"),[4,new Promise((function(r,t){e(["../layers/ElevationLayer"],r,t)}))];case 2:return o=t.sent(),[2,r?r.map((function(e){return new o({id:e.id,url:e.url})})):[]]}}))}))},u.prototype.createGeometryService=function(){return t.__awaiter(this,void 0,void 0,(function(){var r;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),r=this._getHelperServiceUrl("geometry"),[4,new Promise((function(r,t){e(["../tasks/GeometryService"],r,t)}))];case 2:return[2,new(t.sent())({url:r})]}}))}))},u.prototype.createPrintTask=function(){return t.__awaiter(this,void 0,void 0,(function(){var r;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),r=this._getHelperServiceUrl("printTask"),[4,new Promise((function(r,t){e(["../tasks/PrintTask"],r,t)}))];case 2:return[2,new(t.sent())(r)]}}))}))},u.prototype.createRouteTask=function(){return t.__awaiter(this,void 0,void 0,(function(){var r;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),r=this._getHelperServiceUrl("route"),[4,new Promise((function(r,t){e(["../tasks/RouteTask"],r,t)}))];case 2:return[2,new(t.sent())(r)]}}))}))},u.prototype.createServiceAreaTask=function(){return t.__awaiter(this,void 0,void 0,(function(){var r;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,this.load()];case 1:return t.sent(),r=this._getHelperServiceUrl("serviceArea"),[4,new Promise((function(r,t){e(["../tasks/ServiceAreaTask"],r,t)}))];case 2:return[2,new(t.sent())(r)]}}))}))},u.prototype.fetchBasemaps=function(e,r){var t=new f;return t.query=e||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),t.disableExtraQuery=!0,this.queryGroups(t,r).then((function(e){if(t.num=100,t.query='type:"Web Map" -type:"Web Application"',e.total){var o=e.results[0];return t.sortField=o.sortField||"name",t.sortOrder=o.sortOrder||"desc",o.queryItems(t,r)}return null})).then((function(e){return e&&e.total?e.results.filter((function(e){return"Web Map"===e.type})).map((function(e){return new g({portalItem:e})})):[]}))},u.prototype.fetchCategorySchema=function(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then((function(e){return e.categorySchema})):d.isAborted(e)?d.reject(d.createAbortError()):d.resolve([])},u.prototype.fetchFeaturedGroups=function(e){var r=this.featuredGroups,t=new f;if(t.num=100,t.sortField="title",r&&r.length){for(var o=[],n=0,a=r;n<a.length;n++){var i=a[n];o.push('(title:"'+i.title+'" AND owner:'+i.owner+")")}return t.query=o.join(" OR "),this.queryGroups(t,e).then((function(e){return e.results}))}return d.isAborted(e)?d.reject(d.createAbortError()):d.resolve([])},u.prototype.fetchRegions=function(e){var r=this.user&&this.user.culture||this.culture||n.getLocale();return this._request(this.restUrl+"/portals/regions",t.__assign(t.__assign({},e),{query:{culture:r}}))},u.getDefault=function(){return l._default&&!l._default.destroyed||(l._default=new l),l._default},u.prototype.queryGroups=function(e,r){return this._queryPortal("/community/groups",e,"PortalGroup",r)},u.prototype.queryItems=function(e,r){return this._queryPortal("/search",e,"PortalItem",r)},u.prototype.queryUsers=function(e,r){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",r)},u.prototype.toJSON=function(){throw new p("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},u.fromJSON=function(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new l({sourceJSON:e})},u.prototype._getHelperService=function(e){var r=this.helperServices&&this.helperServices[e];if(!r)throw new p("portal:service-not-found",'The `helperServices` do not include an entry named "'+e+'"');return r},u.prototype._getHelperServiceUrl=function(e){var r=this._getHelperService(e);if(!r.url)throw new p("portal:service-url-not-found",'The `helperServices` entry "'+e+'" does not include a `url` value');return r.url},u.prototype._fetchSelf=function(e,r,o){void 0===e&&(e=this.authMode),void 0===r&&(r=!1);var a=this.restUrl+"/portals/self",i=t.__assign({authMode:e,query:{culture:n.getLocale().toLowerCase()}},o);return"auto"===i.authMode&&(i.authMode="no-prompt"),r&&(i.query.default=!0),this._request(a,i)},u.prototype._queryPortal=function(e,r,o,n){var a=this,i=_.ensureType(f,r),p=function(r){return a._request(a.restUrl+e,t.__assign(t.__assign({},i.toRequestOptions(a)),n)).then((function(e){var t=i.clone();return t.start=e.nextStart,new v({nextQueryParams:t,queryParams:i,total:e.total,results:l._resultsToTypedArray(r,{portal:a},e,n)})})).then((function(e){return d.all(e.results.map((function(r){return"function"==typeof r.when?r.when():e}))).then((function(){return e}),(function(r){return d.throwIfAbortError(r),e}))}))};return o&&S[o]?S[o]().then((function(e){return d.throwIfAborted(n),p(e)})):p()},u.prototype._signIn=function(){var e=this;if(this.authMode===l.AUTH_MODE_ANONYMOUS)return d.reject(new p("portal:invalid-auth-mode",'Current "authMode"\' is "'+this.authMode+'"'));if("failed"===this.loadStatus)return d.reject(this.loadError);var r=function(r){return d.resolve().then((function(){return"not-loaded"===e.loadStatus?(r||(e.authMode="immediate"),e.load().then((function(){return null}))):"loading"===e.loadStatus?e.load().then((function(){return e.credential?null:(e.credential=r,e._fetchSelf("immediate"))})):e.user&&e.credential===r?null:(e.credential=r,e._fetchSelf("immediate"))})).then((function(r){r&&(e.sourceJSON=r,e.read(r))}))};return a.id?a.id.getCredential(this.restUrl).then((function(e){return r(e)})):r(this.credential)},u.prototype._normalizeSSL=function(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")},u.prototype._normalizeUrl=function(e){var r=this.credential&&this.credential.token;return this._normalizeSSL(r?e+(e.indexOf("?")>-1?"&":"?")+"token="+r:e)},u.prototype._requestToTypedArray=function(e,r,t){var o=this;return this._request(e,r).then((function(e){var r=l._resultsToTypedArray(t,{portal:o},e);return d.all(r.map((function(r){return"function"==typeof r.when?r.when():e}))).then((function(){return r}),(function(){return r}))}))},u.prototype._request=function(e,r){void 0===r&&(r={});var o=t.__assign({f:"json"},r.query),n=r.authMode,a=void 0===n?this.authMode===l.AUTH_MODE_ANONYMOUS?"anonymous":"auto":n,p=r.body,u=void 0===p?null:p,s=r.cacheBust,c=void 0!==s&&s,d=r.method,y=void 0===d?"auto":d,_=r.responseType,h={authMode:a,body:u,cacheBust:c,method:y,query:o,responseType:void 0===_?"json":_,timeout:0,signal:r.signal};return i(this._normalizeSSL(e),h).then((function(e){return e.data}))},u._resultsToTypedArray=function(e,r,t,o){var n;if(t){var a=c.isSome(o)?o.signal:null;n=t.listings||t.notifications||t.userInvitations||t.tags||t.items||t.groups||t.comments||t.provisions||t.results||t.relatedItems||t,(e||r)&&(n=n.map((function(t){var o=s.mixin(e?e.fromJSON(t):t,r);return"function"==typeof o.load&&o.load(a),o})))}else n=[];return n},u.AUTH_MODE_ANONYMOUS="anonymous",u.AUTH_MODE_AUTO="auto",u.AUTH_MODE_IMMEDIATE="immediate",t.__decorate([y.property()],u.prototype,"access",void 0),t.__decorate([y.property()],u.prototype,"allSSL",void 0),t.__decorate([y.property()],u.prototype,"authMode",void 0),t.__decorate([y.property()],u.prototype,"authorizedCrossOriginDomains",void 0),t.__decorate([y.reader("authorizedCrossOriginDomains")],u.prototype,"readAuthorizedCrossOriginDomains",null),t.__decorate([y.property()],u.prototype,"basemapGalleryGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"bingKey",void 0),t.__decorate([y.property()],u.prototype,"canListApps",void 0),t.__decorate([y.property()],u.prototype,"canListData",void 0),t.__decorate([y.property()],u.prototype,"canListPreProvisionedItems",void 0),t.__decorate([y.property()],u.prototype,"canProvisionDirectPurchase",void 0),t.__decorate([y.property()],u.prototype,"canSearchPublic",void 0),t.__decorate([y.property()],u.prototype,"canShareBingPublic",void 0),t.__decorate([y.property()],u.prototype,"canSharePublic",void 0),t.__decorate([y.property()],u.prototype,"canSignInArcGIS",void 0),t.__decorate([y.property()],u.prototype,"canSignInIDP",void 0),t.__decorate([y.property()],u.prototype,"colorSetsGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"commentsEnabled",void 0),t.__decorate([y.property({type:Date})],u.prototype,"created",void 0),t.__decorate([y.property()],u.prototype,"credential",void 0),t.__decorate([y.property()],u.prototype,"culture",void 0),t.__decorate([y.property()],u.prototype,"currentVersion",void 0),t.__decorate([y.property()],u.prototype,"customBaseUrl",void 0),t.__decorate([y.property()],u.prototype,"defaultBasemap",void 0),t.__decorate([y.reader("defaultBasemap")],u.prototype,"readDefaultBasemap",null),t.__decorate([y.property({type:h})],u.prototype,"defaultExtent",void 0),t.__decorate([y.property()],u.prototype,"defaultVectorBasemap",void 0),t.__decorate([y.reader("defaultVectorBasemap")],u.prototype,"readDefaultVectorBasemap",null),t.__decorate([y.property()],u.prototype,"description",void 0),t.__decorate([y.property()],u.prototype,"eueiEnabled",void 0),t.__decorate([y.property({dependsOn:["user","id","canSearchPublic"],readOnly:!0})],u.prototype,"extraQuery",null),t.__decorate([y.property()],u.prototype,"featuredGroups",void 0),t.__decorate([y.property()],u.prototype,"featuredItemsGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"galleryTemplatesGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"livingAtlasGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"hasCategorySchema",void 0),t.__decorate([y.property()],u.prototype,"helpBase",void 0),t.__decorate([y.property()],u.prototype,"helperServices",void 0),t.__decorate([y.property()],u.prototype,"helpMap",void 0),t.__decorate([y.property()],u.prototype,"homePageFeaturedContent",void 0),t.__decorate([y.property()],u.prototype,"homePageFeaturedContentCount",void 0),t.__decorate([y.property()],u.prototype,"httpPort",void 0),t.__decorate([y.property()],u.prototype,"httpsPort",void 0),t.__decorate([y.property()],u.prototype,"id",void 0),t.__decorate([y.property()],u.prototype,"ipCntryCode",void 0),t.__decorate([y.property({dependsOn:["access"],readOnly:!0})],u.prototype,"isOrganization",null),t.__decorate([y.property()],u.prototype,"isPortal",void 0),t.__decorate([y.property()],u.prototype,"isReadOnly",void 0),t.__decorate([y.property()],u.prototype,"layerTemplatesGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"maxTokenExpirationMinutes",void 0),t.__decorate([y.property({type:Date})],u.prototype,"modified",void 0),t.__decorate([y.property()],u.prototype,"name",void 0),t.__decorate([y.property()],u.prototype,"portalHostname",void 0),t.__decorate([y.property()],u.prototype,"portalMode",void 0),t.__decorate([y.property()],u.prototype,"portalProperties",void 0),t.__decorate([y.property()],u.prototype,"region",void 0),t.__decorate([y.property({dependsOn:["url"],readOnly:!0})],u.prototype,"restUrl",null),t.__decorate([y.property()],u.prototype,"rotatorPanels",void 0),t.__decorate([y.property()],u.prototype,"showHomePageDescription",void 0),t.__decorate([y.property()],u.prototype,"sourceJSON",void 0),t.__decorate([y.property()],u.prototype,"staticImagesUrl",void 0),t.__decorate([y.property()],u.prototype,"stylesGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"supportsHostedServices",void 0),t.__decorate([y.property()],u.prototype,"symbolSetsGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"templatesGroupQuery",void 0),t.__decorate([y.property()],u.prototype,"thumbnail",void 0),t.__decorate([y.property({dependsOn:["restUrl","thumbnail"],readOnly:!0})],u.prototype,"thumbnailUrl",null),t.__decorate([y.property()],u.prototype,"units",void 0),t.__decorate([y.property()],u.prototype,"url",void 0),t.__decorate([y.property()],u.prototype,"urlKey",void 0),t.__decorate([y.reader("urlKey")],u.prototype,"readUrlKey",null),t.__decorate([y.property()],u.prototype,"user",void 0),t.__decorate([y.reader("user")],u.prototype,"readUser",null),t.__decorate([y.property()],u.prototype,"useStandardizedQuery",void 0),t.__decorate([y.property()],u.prototype,"useVectorBasemaps",void 0),t.__decorate([y.property()],u.prototype,"vectorBasemapGalleryGroupQuery",void 0),u=l=t.__decorate([y.subclass("esri.portal.Portal")],u)}(u.JSONSupportMixin(l))}));