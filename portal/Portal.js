/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../config","../kernel","../request","../core/deprecate","../core/Error","../core/JSONSupport","../core/Loadable","../core/Logger","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/Extent","../intl/locale","./PortalQueryParams","./PortalQueryResult","./PortalUser","../support/apiKeyUtils"],(function(e,r,t,o,a,s,n,i,l,p,u,d,c,y,h,_,m,f,v,g,S,P,G,O,U){"use strict";const w=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var b;let T;const A={PortalGroup:()=>new Promise(((r,t)=>e(["./PortalGroup"],(e=>r(w(e))),t))),PortalItem:()=>new Promise(((r,t)=>e(["./PortalItem"],(e=>r(w(e))),t))),PortalUser:()=>new Promise(((r,t)=>e(["./PortalUser"],(e=>r(w(e))),t)))};let C=b=function(t){function l(e){var r;return(r=t.call(this,e)||this).access=null,r.allSSL=!1,r.authMode="auto",r.authorizedCrossOriginDomains=null,r.basemapGalleryGroupQuery=null,r.bingKey=null,r.canListApps=!1,r.canListData=!1,r.canListPreProvisionedItems=!1,r.canProvisionDirectPurchase=!1,r.canSearchPublic=!0,r.canShareBingPublic=!1,r.canSharePublic=!1,r.canSignInArcGIS=!1,r.canSignInIDP=!1,r.colorSetsGroupQuery=null,r.commentsEnabled=!1,r.created=null,r.culture=null,r.customBaseUrl=null,r.defaultBasemap=null,r.defaultDevBasemap=null,r.defaultExtent=null,r.defaultVectorBasemap=null,r.description=null,r.devBasemapGalleryGroupQuery=null,r.eueiEnabled=null,r.featuredGroups=null,r.featuredItemsGroupQuery=null,r.galleryTemplatesGroupQuery=null,r.livingAtlasGroupQuery=null,r.hasCategorySchema=!1,r.helperServices=null,r.homePageFeaturedContent=null,r.homePageFeaturedContentCount=null,r.httpPort=null,r.httpsPort=null,r.id=null,r.ipCntryCode=null,r.isPortal=!1,r.isReadOnly=!1,r.layerTemplatesGroupQuery=null,r.maxTokenExpirationMinutes=null,r.modified=null,r.name=null,r.portalHostname=null,r.portalMode=null,r.portalProperties=null,r.region=null,r.rotatorPanels=null,r.showHomePageDescription=!1,r.sourceJSON=null,r.supportsHostedServices=!1,r.symbolSetsGroupQuery=null,r.templatesGroupQuery=null,r.units=null,r.url=o.portalUrl,r.urlKey=null,r.user=null,r.useStandardizedQuery=!1,r.useVectorBasemaps=!1,r.vectorBasemapGalleryGroupQuery=null,r}r._inheritsLoose(l,t);var p=l.prototype;return p.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e},p.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},p.readAuthorizedCrossOriginDomains=function(e){if(e)for(const r of e)-1===o.request.trustedServers.indexOf(r)&&o.request.trustedServers.push(r);return e},p.readDefaultBasemap=function(e){return this._readBasemap(e)},p.readDefaultDevBasemap=function(e){return this._readBasemap(e)},p.readDefaultVectorBasemap=function(e){return this._readBasemap(e)},p.readUrlKey=function(e){return e?e.toLowerCase():e},p.readUser=function(e){let r=null;return e&&(r=O.fromJSON(e),r.portal=this),r},p.load=function(r){const t=new Promise(((r,t)=>e(["../Basemap"],(e=>r(w(e))),t))).then((({default:e})=>{c.throwIfAborted(r),T=e})).then((()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,r))).then((e=>{if(a.id){const e=a.id;this.credential=e.findCredential(this.restUrl),this.credential||this.authMode!==b.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=e.on("credential-create",(()=>{e.findCredential(this.restUrl)&&this._signIn()})))}this.sourceJSON=e,this.read(e)}));return this.addResolvingPromise(t),Promise.resolve(this)},p.createClosestFacilityTask=function(){var t=r._asyncToGenerator((function*(){n.deprecatedFunction(u.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/closestFacility",version:"4.21"}),yield this.load();const r=this._getHelperServiceUrl("closestFacility");return new(0,(yield new Promise(((r,t)=>e(["../tasks/ClosestFacilityTask"],(e=>r(w(e))),t)))).default)(r)}));function o(){return t.apply(this,arguments)}return o}(),p.createElevationLayers=function(){var t=r._asyncToGenerator((function*(){yield this.load();const r=this._getHelperService("defaultElevationLayers"),t=(yield new Promise(((r,t)=>e(["../layers/ElevationLayer"],(e=>r(w(e))),t)))).default;return r?r.map((e=>new t({id:e.id,url:e.url}))):[]}));function o(){return t.apply(this,arguments)}return o}(),p.createGeometryService=function(){var t=r._asyncToGenerator((function*(){n.deprecatedFunction(u.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/geometryService",version:"4.21"}),yield this.load();const r=this._getHelperServiceUrl("geometry");return new(0,(yield new Promise(((r,t)=>e(["../tasks/GeometryService"],(e=>r(w(e))),t)))).default)({url:r})}));function o(){return t.apply(this,arguments)}return o}(),p.createPrintTask=function(){var t=r._asyncToGenerator((function*(){n.deprecatedFunction(u.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/print",version:"4.21"}),yield this.load();const r=this._getHelperServiceUrl("printTask");return new(0,(yield new Promise(((r,t)=>e(["../tasks/PrintTask"],(e=>r(w(e))),t)))).default)(r)}));function o(){return t.apply(this,arguments)}return o}(),p.createRouteTask=function(){var t=r._asyncToGenerator((function*(){n.deprecatedFunction(u.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/route",version:"4.21"}),yield this.load();const r=this._getHelperServiceUrl("route");return new(0,(yield new Promise(((r,t)=>e(["../tasks/RouteTask"],(e=>r(w(e))),t)))).default)(r)}));function o(){return t.apply(this,arguments)}return o}(),p.createServiceAreaTask=function(){var t=r._asyncToGenerator((function*(){n.deprecatedFunction(u.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/serviceArea",version:"4.21"}),yield this.load();const r=this._getHelperServiceUrl("serviceArea");return new(0,(yield new Promise(((r,t)=>e(["../tasks/ServiceAreaTask"],(e=>r(w(e))),t)))).default)(r)}));function o(){return t.apply(this,arguments)}return o}(),p.fetchBasemaps=function(e,r){const t=new P;return t.query=e||(o.apiKey&&U.supportsApiKey(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),t.disableExtraQuery=!0,this.queryGroups(t,r).then((e=>{if(t.num=100,t.query='type:"Web Map" -type:"Web Application"',e.total){const o=e.results[0];return t.sortField=o.sortField||"name",t.sortOrder=o.sortOrder||"desc",o.queryItems(t,r)}return null})).then((e=>{let r;return r=e&&e.total?e.results.filter((e=>"Web Map"===e.type)).map((e=>new T({portalItem:e}))):[],r}))},p.fetchCategorySchema=function(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then((e=>e.categorySchema)):c.isAborted(e)?Promise.reject(c.createAbortError()):Promise.resolve([])},p.fetchFeaturedGroups=function(e){const r=this.featuredGroups,t=new P;if(t.num=100,t.sortField="title",r&&r.length){const o=[];for(const e of r)o.push(`(title:"${e.title}" AND owner:${e.owner})`);return t.query=o.join(" OR "),this.queryGroups(t,e).then((e=>e.results))}return c.isAborted(e)?Promise.reject(c.createAbortError()):Promise.resolve([])},p.fetchRegions=function(e){var r;const t=(null==(r=this.user)?void 0:r.culture)||this.culture||S.getLocale();return this._request(this.restUrl+"/portals/regions",{...e,query:{culture:t}})},p.fetchSettings=function(e){var r;const t=(null==(r=this.user)?void 0:r.culture)||this.culture||S.getLocale();return this._request(this.restUrl+"/portals/self/settings",{...e,query:{culture:t}})},l.getDefault=function(){return b._default&&!b._default.destroyed||(b._default=new b),b._default},p.queryGroups=function(e,r){return this._queryPortal("/community/groups",e,"PortalGroup",r)},p.queryItems=function(e,r){return this._queryPortal("/search",e,"PortalItem",r)},p.queryUsers=function(e,r){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",r)},p.toJSON=function(){throw new i("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},l.fromJSON=function(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new b({sourceJSON:e})},p._getHelperService=function(e){const r=this.helperServices&&this.helperServices[e];if(!r)throw new i("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return r},p._getHelperServiceUrl=function(e){const r=this._getHelperService(e);if(!r.url)throw new i("portal:service-url-not-found",`The \`helperServices\` entry "${e}" does not include a \`url\` value`);return r.url},p._fetchSelf=function(e=this.authMode,r=!1,t){const o=this.restUrl+"/portals/self",a={authMode:e,query:{culture:S.getLocale().toLowerCase()},...t};return"auto"===a.authMode&&(a.authMode="no-prompt"),r&&(a.query.default=!0),this._request(o,a)},p._queryPortal=function(e,r,t,o){const a=m.ensureType(P,r),s=r=>this._request(this.restUrl+e,{...a.toRequestOptions(this),...o}).then((e=>{const t=a.clone();return t.start=e.nextStart,new G({nextQueryParams:t,queryParams:a,total:e.total,results:b._resultsToTypedArray(r,{portal:this},e,o)})})).then((e=>Promise.all(e.results.map((r=>"function"==typeof r.when?r.when():e))).then((()=>e),(r=>(c.throwIfAbortError(r),e)))));return t&&A[t]?A[t]().then((({default:e})=>(c.throwIfAborted(o),s(e)))):s()},p._signIn=function(){if(this.authMode===b.AUTH_MODE_ANONYMOUS)return Promise.reject(new i("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if("failed"===this.loadStatus)return Promise.reject(this.loadError);const e=e=>Promise.resolve().then((()=>"not-loaded"===this.loadStatus?(e||(this.authMode="immediate"),this.load().then((()=>null))):"loading"===this.loadStatus?this.load().then((()=>this.credential?null:(this.credential=e,this._fetchSelf("immediate")))):this.user&&this.credential===e?null:(this.credential=e,this._fetchSelf("immediate")))).then((e=>{e&&(this.sourceJSON=e,this.read(e))}));return a.id?a.id.getCredential(this.restUrl).then((r=>e(r))):e(this.credential)},p._normalizeSSL=function(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")},p._normalizeUrl=function(e){const r=this.credential&&this.credential.token;return this._normalizeSSL(r?e+(e.indexOf("?")>-1?"&":"?")+"token="+r:e)},p._requestToTypedArray=function(e,r,t){return this._request(e,r).then((e=>{const r=b._resultsToTypedArray(t,{portal:this},e);return Promise.all(r.map((r=>"function"==typeof r.when?r.when():e))).then((()=>r),(()=>r))}))},p._readBasemap=function(e){if(e){const r=T.fromJSON(e);return r.portalItem={portal:this},r}return null},p._request=function(e,r={}){const t={f:"json",...r.query},{authMode:o=(this.authMode===b.AUTH_MODE_ANONYMOUS?"anonymous":"auto"),body:a=null,cacheBust:n=!1,method:i="auto",responseType:l="json",signal:p}=r,u={authMode:o,body:a,cacheBust:n,method:i,query:t,responseType:l,timeout:0,signal:p};return s(this._normalizeSSL(e),u).then((e=>e.data))},l._resultsToTypedArray=function(e,r,t,o){let a;if(t){const s=d.isSome(o)?o.signal:null;a=t.listings||t.notifications||t.userInvitations||t.tags||t.items||t.groups||t.comments||t.provisions||t.results||t.relatedItems||t,(e||r)&&(a=a.map((t=>{const o=Object.assign(e?e.fromJSON(t):t,r);return"function"==typeof o.load&&o.load(s),o})))}else a=[];return a},r._createClass(l,[{key:"extraQuery",get:function(){const e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?` AND orgid:${this.id}`:null}},{key:"isOrganization",get:function(){return!!this.access}},{key:"restUrl",get:function(){let e=this.url;if(e){const r=e.indexOf("/sharing");e=r>0?e.substring(0,r):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}},{key:"stylesGroupQuery",get:function(){return n.deprecatedProperty(u.getLogger(this.declaredClass),"stylesGroupQuery",{replacement:"stylesGroupQuery3d",version:"4.21"}),this.stylesGroupQuery3d}},{key:"thumbnailUrl",get:function(){const e=this.restUrl,r=this.thumbnail;return e&&r?this._normalizeSSL(e+"/portals/self/resources/"+r):null}}]),l}(l.JSONSupportMixin(p));C.AUTH_MODE_ANONYMOUS="anonymous",C.AUTH_MODE_AUTO="auto",C.AUTH_MODE_IMMEDIATE="immediate",t.__decorate([y.property()],C.prototype,"access",void 0),t.__decorate([y.property()],C.prototype,"allSSL",void 0),t.__decorate([y.property()],C.prototype,"authMode",void 0),t.__decorate([y.property()],C.prototype,"authorizedCrossOriginDomains",void 0),t.__decorate([f.reader("authorizedCrossOriginDomains")],C.prototype,"readAuthorizedCrossOriginDomains",null),t.__decorate([y.property()],C.prototype,"basemapGalleryGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"bingKey",void 0),t.__decorate([y.property()],C.prototype,"canListApps",void 0),t.__decorate([y.property()],C.prototype,"canListData",void 0),t.__decorate([y.property()],C.prototype,"canListPreProvisionedItems",void 0),t.__decorate([y.property()],C.prototype,"canProvisionDirectPurchase",void 0),t.__decorate([y.property()],C.prototype,"canSearchPublic",void 0),t.__decorate([y.property()],C.prototype,"canShareBingPublic",void 0),t.__decorate([y.property()],C.prototype,"canSharePublic",void 0),t.__decorate([y.property()],C.prototype,"canSignInArcGIS",void 0),t.__decorate([y.property()],C.prototype,"canSignInIDP",void 0),t.__decorate([y.property()],C.prototype,"colorSetsGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"commentsEnabled",void 0),t.__decorate([y.property({type:Date})],C.prototype,"created",void 0),t.__decorate([y.property()],C.prototype,"credential",void 0),t.__decorate([y.property()],C.prototype,"culture",void 0),t.__decorate([y.property()],C.prototype,"currentVersion",void 0),t.__decorate([y.property()],C.prototype,"customBaseUrl",void 0),t.__decorate([y.property()],C.prototype,"defaultBasemap",void 0),t.__decorate([f.reader("defaultBasemap")],C.prototype,"readDefaultBasemap",null),t.__decorate([y.property()],C.prototype,"defaultDevBasemap",void 0),t.__decorate([f.reader("defaultDevBasemap")],C.prototype,"readDefaultDevBasemap",null),t.__decorate([y.property({type:g})],C.prototype,"defaultExtent",void 0),t.__decorate([y.property()],C.prototype,"defaultVectorBasemap",void 0),t.__decorate([f.reader("defaultVectorBasemap")],C.prototype,"readDefaultVectorBasemap",null),t.__decorate([y.property()],C.prototype,"description",void 0),t.__decorate([y.property()],C.prototype,"devBasemapGalleryGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"eueiEnabled",void 0),t.__decorate([y.property({readOnly:!0})],C.prototype,"extraQuery",null),t.__decorate([y.property()],C.prototype,"featuredGroups",void 0),t.__decorate([y.property()],C.prototype,"featuredItemsGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"galleryTemplatesGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"livingAtlasGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"hasCategorySchema",void 0),t.__decorate([y.property()],C.prototype,"helpBase",void 0),t.__decorate([y.property()],C.prototype,"helperServices",void 0),t.__decorate([y.property()],C.prototype,"helpMap",void 0),t.__decorate([y.property()],C.prototype,"homePageFeaturedContent",void 0),t.__decorate([y.property()],C.prototype,"homePageFeaturedContentCount",void 0),t.__decorate([y.property()],C.prototype,"httpPort",void 0),t.__decorate([y.property()],C.prototype,"httpsPort",void 0),t.__decorate([y.property()],C.prototype,"id",void 0),t.__decorate([y.property()],C.prototype,"ipCntryCode",void 0),t.__decorate([y.property({readOnly:!0})],C.prototype,"isOrganization",null),t.__decorate([y.property()],C.prototype,"isPortal",void 0),t.__decorate([y.property()],C.prototype,"isReadOnly",void 0),t.__decorate([y.property()],C.prototype,"layerTemplatesGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"maxTokenExpirationMinutes",void 0),t.__decorate([y.property({type:Date})],C.prototype,"modified",void 0),t.__decorate([y.property()],C.prototype,"name",void 0),t.__decorate([y.property()],C.prototype,"portalHostname",void 0),t.__decorate([y.property()],C.prototype,"portalMode",void 0),t.__decorate([y.property()],C.prototype,"portalProperties",void 0),t.__decorate([y.property()],C.prototype,"region",void 0),t.__decorate([y.property({readOnly:!0})],C.prototype,"restUrl",null),t.__decorate([y.property()],C.prototype,"rotatorPanels",void 0),t.__decorate([y.property()],C.prototype,"showHomePageDescription",void 0),t.__decorate([y.property()],C.prototype,"sourceJSON",void 0),t.__decorate([y.property()],C.prototype,"staticImagesUrl",void 0),t.__decorate([y.property({readOnly:!0,json:{read:!1}})],C.prototype,"stylesGroupQuery",null),t.__decorate([y.property({json:{name:"2DStylesGroupQuery"}})],C.prototype,"stylesGroupQuery2d",void 0),t.__decorate([y.property({json:{name:"stylesGroupQuery"}})],C.prototype,"stylesGroupQuery3d",void 0),t.__decorate([y.property()],C.prototype,"supportsHostedServices",void 0),t.__decorate([y.property()],C.prototype,"symbolSetsGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"templatesGroupQuery",void 0),t.__decorate([y.property()],C.prototype,"thumbnail",void 0),t.__decorate([y.property({readOnly:!0})],C.prototype,"thumbnailUrl",null),t.__decorate([y.property()],C.prototype,"units",void 0),t.__decorate([y.property()],C.prototype,"url",void 0),t.__decorate([y.property()],C.prototype,"urlKey",void 0),t.__decorate([f.reader("urlKey")],C.prototype,"readUrlKey",null),t.__decorate([y.property()],C.prototype,"user",void 0),t.__decorate([f.reader("user")],C.prototype,"readUser",null),t.__decorate([y.property()],C.prototype,"useStandardizedQuery",void 0),t.__decorate([y.property()],C.prototype,"useVectorBasemaps",void 0),t.__decorate([y.property()],C.prototype,"vectorBasemapGalleryGroupQuery",void 0),C=b=t.__decorate([v.subclass("esri.portal.Portal")],C);return C}));
