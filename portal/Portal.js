/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../config","../intl","../kernel","../request","../core/deprecate","../core/Error","../core/JSONSupport","../core/Loadable","../core/Logger","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/Extent","./PortalQueryParams","./PortalQueryResult","./PortalUser","../intl/locale"],(function(e,t,r,o,n,a,s,i,l,p,u,c,d,y,h,_,f,m,v,S,g,P,G,O){"use strict";function w(e){return Object.freeze({__proto__:null,default:e})}var U;let b;const T={PortalGroup:()=>new Promise((function(t,r){e(["./PortalGroup"],(function(e){t(w(e))}),r)})),PortalItem:()=>new Promise((function(t,r){e(["./PortalItem"],(function(e){t(w(e))}),r)})),PortalUser:()=>new Promise((function(t,r){e(["./PortalUser"],(function(e){t(w(e))}),r)}))};let C=U=function(r){function n(e){var t;return(t=r.call(this,e)||this).access=null,t.allSSL=!1,t.authMode="auto",t.authorizedCrossOriginDomains=null,t.basemapGalleryGroupQuery=null,t.bingKey=null,t.canListApps=!1,t.canListData=!1,t.canListPreProvisionedItems=!1,t.canProvisionDirectPurchase=!1,t.canSearchPublic=!0,t.canShareBingPublic=!1,t.canSharePublic=!1,t.canSignInArcGIS=!1,t.canSignInIDP=!1,t.colorSetsGroupQuery=null,t.commentsEnabled=!1,t.created=null,t.culture=null,t.customBaseUrl=null,t.defaultBasemap=null,t.defaultExtent=null,t.defaultVectorBasemap=null,t.description=null,t.eueiEnabled=null,t.featuredGroups=null,t.featuredItemsGroupQuery=null,t.galleryTemplatesGroupQuery=null,t.livingAtlasGroupQuery=null,t.hasCategorySchema=!1,t.helperServices=null,t.homePageFeaturedContent=null,t.homePageFeaturedContentCount=null,t.httpPort=null,t.httpsPort=null,t.id=null,t.ipCntryCode=null,t.isPortal=!1,t.isReadOnly=!1,t.layerTemplatesGroupQuery=null,t.maxTokenExpirationMinutes=null,t.modified=null,t.name=null,t.portalHostname=null,t.portalMode=null,t.portalProperties=null,t.region=null,t.rotatorPanels=null,t.showHomePageDescription=!1,t.sourceJSON=null,t.supportsHostedServices=!1,t.symbolSetsGroupQuery=null,t.templatesGroupQuery=null,t.units=null,t.url=o.portalUrl,t.urlKey=null,t.user=null,t.useStandardizedQuery=!1,t.useVectorBasemaps=!1,t.vectorBasemapGalleryGroupQuery=null,t}t._inheritsLoose(n,r);var p=n.prototype;return p.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e},p.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},p.readAuthorizedCrossOriginDomains=function(e){if(e)for(const t of e)-1===o.request.trustedServers.indexOf(t)&&o.request.trustedServers.push(t);return e},p.readDefaultBasemap=function(e){if(e){const t=b.fromJSON(e);return t.portalItem={portal:this},t}return null},p.readDefaultVectorBasemap=function(e){if(e){const t=b.fromJSON(e);return t.portalItem={portal:this},t}return null},p.readUrlKey=function(e){return e?e.toLowerCase():e},p.readUser=function(e){let t=null;return e&&(t=G.fromJSON(e),t.portal=this),t},p.load=function(t){const r=new Promise((function(t,r){e(["../Basemap"],(function(e){t(w(e))}),r)})).then((({default:e})=>{y.throwIfAborted(t),b=e})).then((()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,t))).then((e=>{if(a.id){const e=a.id;this.credential=e.findCredential(this.restUrl),this.credential||this.authMode!==U.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=e.on("credential-create",(()=>{e.findCredential(this.restUrl)&&this._signIn()})))}this.sourceJSON=e,this.read(e)}));return this.addResolvingPromise(r),Promise.resolve(this)},p.createClosestFacilityTask=function(){var r=t._asyncToGenerator((function*(){i.deprecatedFunction(c.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/closestFacility",version:"4.21"}),yield this.load();const t=this._getHelperServiceUrl("closestFacility");return new(0,(yield new Promise((function(t,r){e(["../tasks/ClosestFacilityTask"],(function(e){t(w(e))}),r)}))).default)(t)}));function o(){return r.apply(this,arguments)}return o}(),p.createElevationLayers=function(){var r=t._asyncToGenerator((function*(){yield this.load();const t=this._getHelperService("defaultElevationLayers"),r=(yield new Promise((function(t,r){e(["../layers/ElevationLayer"],(function(e){t(w(e))}),r)}))).default;return t?t.map((e=>new r({id:e.id,url:e.url}))):[]}));function o(){return r.apply(this,arguments)}return o}(),p.createGeometryService=function(){var r=t._asyncToGenerator((function*(){i.deprecatedFunction(c.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/geometryService",version:"4.21"}),yield this.load();const t=this._getHelperServiceUrl("geometry");return new(0,(yield new Promise((function(t,r){e(["../tasks/GeometryService"],(function(e){t(w(e))}),r)}))).default)({url:t})}));function o(){return r.apply(this,arguments)}return o}(),p.createPrintTask=function(){var r=t._asyncToGenerator((function*(){i.deprecatedFunction(c.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/print",version:"4.21"}),yield this.load();const t=this._getHelperServiceUrl("printTask");return new(0,(yield new Promise((function(t,r){e(["../tasks/PrintTask"],(function(e){t(w(e))}),r)}))).default)(t)}));function o(){return r.apply(this,arguments)}return o}(),p.createRouteTask=function(){var r=t._asyncToGenerator((function*(){i.deprecatedFunction(c.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/route",version:"4.21"}),yield this.load();const t=this._getHelperServiceUrl("route");return new(0,(yield new Promise((function(t,r){e(["../tasks/RouteTask"],(function(e){t(w(e))}),r)}))).default)(t)}));function o(){return r.apply(this,arguments)}return o}(),p.createServiceAreaTask=function(){var r=t._asyncToGenerator((function*(){i.deprecatedFunction(c.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/serviceArea",version:"4.21"}),yield this.load();const t=this._getHelperServiceUrl("serviceArea");return new(0,(yield new Promise((function(t,r){e(["../tasks/ServiceAreaTask"],(function(e){t(w(e))}),r)}))).default)(t)}));function o(){return r.apply(this,arguments)}return o}(),p.fetchBasemaps=function(e,t){const r=new g;return r.query=e||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),r.disableExtraQuery=!0,this.queryGroups(r,t).then((e=>{if(r.num=100,r.query='type:"Web Map" -type:"Web Application"',e.total){const o=e.results[0];return r.sortField=o.sortField||"name",r.sortOrder=o.sortOrder||"desc",o.queryItems(r,t)}return null})).then((e=>{let t;return t=e&&e.total?e.results.filter((e=>"Web Map"===e.type)).map((e=>new b({portalItem:e}))):[],t}))},p.fetchCategorySchema=function(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then((e=>e.categorySchema)):y.isAborted(e)?Promise.reject(y.createAbortError()):Promise.resolve([])},p.fetchFeaturedGroups=function(e){const t=this.featuredGroups,r=new g;if(r.num=100,r.sortField="title",t&&t.length){const o=[];for(const e of t)o.push(`(title:"${e.title}" AND owner:${e.owner})`);return r.query=o.join(" OR "),this.queryGroups(r,e).then((e=>e.results))}return y.isAborted(e)?Promise.reject(y.createAbortError()):Promise.resolve([])},p.fetchRegions=function(e){const t=this.user&&this.user.culture||this.culture||O.getLocale();return this._request(this.restUrl+"/portals/regions",{...e,query:{culture:t}})},n.getDefault=function(){return U._default&&!U._default.destroyed||(U._default=new U),U._default},p.queryGroups=function(e,t){return this._queryPortal("/community/groups",e,"PortalGroup",t)},p.queryItems=function(e,t){return this._queryPortal("/search",e,"PortalItem",t)},p.queryUsers=function(e,t){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",t)},p.toJSON=function(){throw new l("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},n.fromJSON=function(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new U({sourceJSON:e})},p._getHelperService=function(e){const t=this.helperServices&&this.helperServices[e];if(!t)throw new l("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return t},p._getHelperServiceUrl=function(e){const t=this._getHelperService(e);if(!t.url)throw new l("portal:service-url-not-found",`The \`helperServices\` entry "${e}" does not include a \`url\` value`);return t.url},p._fetchSelf=function(e=this.authMode,t=!1,r){const o=this.restUrl+"/portals/self",n={authMode:e,query:{culture:O.getLocale().toLowerCase()},...r};return"auto"===n.authMode&&(n.authMode="no-prompt"),t&&(n.query.default=!0),this._request(o,n)},p._queryPortal=function(e,t,r,o){const n=f.ensureType(g,t),a=t=>this._request(this.restUrl+e,{...n.toRequestOptions(this),...o}).then((e=>{const r=n.clone();return r.start=e.nextStart,new P({nextQueryParams:r,queryParams:n,total:e.total,results:U._resultsToTypedArray(t,{portal:this},e,o)})})).then((e=>Promise.all(e.results.map((t=>"function"==typeof t.when?t.when():e))).then((()=>e),(t=>(y.throwIfAbortError(t),e)))));return r&&T[r]?T[r]().then((({default:e})=>(y.throwIfAborted(o),a(e)))):a()},p._signIn=function(){if(this.authMode===U.AUTH_MODE_ANONYMOUS)return Promise.reject(new l("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if("failed"===this.loadStatus)return Promise.reject(this.loadError);const e=e=>Promise.resolve().then((()=>"not-loaded"===this.loadStatus?(e||(this.authMode="immediate"),this.load().then((()=>null))):"loading"===this.loadStatus?this.load().then((()=>this.credential?null:(this.credential=e,this._fetchSelf("immediate")))):this.user&&this.credential===e?null:(this.credential=e,this._fetchSelf("immediate")))).then((e=>{e&&(this.sourceJSON=e,this.read(e))}));return a.id?a.id.getCredential(this.restUrl).then((t=>e(t))):e(this.credential)},p._normalizeSSL=function(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")},p._normalizeUrl=function(e){const t=this.credential&&this.credential.token;return this._normalizeSSL(t?e+(e.indexOf("?")>-1?"&":"?")+"token="+t:e)},p._requestToTypedArray=function(e,t,r){return this._request(e,t).then((e=>{const t=U._resultsToTypedArray(r,{portal:this},e);return Promise.all(t.map((t=>"function"==typeof t.when?t.when():e))).then((()=>t),(()=>t))}))},p._request=function(e,t={}){const r={f:"json",...t.query},{authMode:o=(this.authMode===U.AUTH_MODE_ANONYMOUS?"anonymous":"auto"),body:n=null,cacheBust:a=!1,method:i="auto",responseType:l="json",signal:p}=t,u={authMode:o,body:n,cacheBust:a,method:i,query:r,responseType:l,timeout:0,signal:p};return s(this._normalizeSSL(e),u).then((e=>e.data))},n._resultsToTypedArray=function(e,t,r,o){let n;if(r){const a=d.isSome(o)?o.signal:null;n=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(e||t)&&(n=n.map((r=>{const o=Object.assign(e?e.fromJSON(r):r,t);return"function"==typeof o.load&&o.load(a),o})))}else n=[];return n},t._createClass(n,[{key:"extraQuery",get:function(){const e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?` AND orgid:${this.id}`:null}},{key:"isOrganization",get:function(){return!!this.access}},{key:"restUrl",get:function(){let e=this.url;if(e){const t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}},{key:"stylesGroupQuery",get:function(){return i.deprecatedProperty(c.getLogger(this.declaredClass),"stylesGroupQuery",{replacement:"stylesGroupQuery3d",version:"4.21"}),this.stylesGroupQuery3d}},{key:"thumbnailUrl",get:function(){const e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null}}]),n}(p.JSONSupportMixin(u));return C.AUTH_MODE_ANONYMOUS="anonymous",C.AUTH_MODE_AUTO="auto",C.AUTH_MODE_IMMEDIATE="immediate",r.__decorate([h.property()],C.prototype,"access",void 0),r.__decorate([h.property()],C.prototype,"allSSL",void 0),r.__decorate([h.property()],C.prototype,"authMode",void 0),r.__decorate([h.property()],C.prototype,"authorizedCrossOriginDomains",void 0),r.__decorate([m.reader("authorizedCrossOriginDomains")],C.prototype,"readAuthorizedCrossOriginDomains",null),r.__decorate([h.property()],C.prototype,"basemapGalleryGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"bingKey",void 0),r.__decorate([h.property()],C.prototype,"canListApps",void 0),r.__decorate([h.property()],C.prototype,"canListData",void 0),r.__decorate([h.property()],C.prototype,"canListPreProvisionedItems",void 0),r.__decorate([h.property()],C.prototype,"canProvisionDirectPurchase",void 0),r.__decorate([h.property()],C.prototype,"canSearchPublic",void 0),r.__decorate([h.property()],C.prototype,"canShareBingPublic",void 0),r.__decorate([h.property()],C.prototype,"canSharePublic",void 0),r.__decorate([h.property()],C.prototype,"canSignInArcGIS",void 0),r.__decorate([h.property()],C.prototype,"canSignInIDP",void 0),r.__decorate([h.property()],C.prototype,"colorSetsGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"commentsEnabled",void 0),r.__decorate([h.property({type:Date})],C.prototype,"created",void 0),r.__decorate([h.property()],C.prototype,"credential",void 0),r.__decorate([h.property()],C.prototype,"culture",void 0),r.__decorate([h.property()],C.prototype,"currentVersion",void 0),r.__decorate([h.property()],C.prototype,"customBaseUrl",void 0),r.__decorate([h.property()],C.prototype,"defaultBasemap",void 0),r.__decorate([m.reader("defaultBasemap")],C.prototype,"readDefaultBasemap",null),r.__decorate([h.property({type:S})],C.prototype,"defaultExtent",void 0),r.__decorate([h.property()],C.prototype,"defaultVectorBasemap",void 0),r.__decorate([m.reader("defaultVectorBasemap")],C.prototype,"readDefaultVectorBasemap",null),r.__decorate([h.property()],C.prototype,"description",void 0),r.__decorate([h.property()],C.prototype,"eueiEnabled",void 0),r.__decorate([h.property({readOnly:!0})],C.prototype,"extraQuery",null),r.__decorate([h.property()],C.prototype,"featuredGroups",void 0),r.__decorate([h.property()],C.prototype,"featuredItemsGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"galleryTemplatesGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"livingAtlasGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"hasCategorySchema",void 0),r.__decorate([h.property()],C.prototype,"helpBase",void 0),r.__decorate([h.property()],C.prototype,"helperServices",void 0),r.__decorate([h.property()],C.prototype,"helpMap",void 0),r.__decorate([h.property()],C.prototype,"homePageFeaturedContent",void 0),r.__decorate([h.property()],C.prototype,"homePageFeaturedContentCount",void 0),r.__decorate([h.property()],C.prototype,"httpPort",void 0),r.__decorate([h.property()],C.prototype,"httpsPort",void 0),r.__decorate([h.property()],C.prototype,"id",void 0),r.__decorate([h.property()],C.prototype,"ipCntryCode",void 0),r.__decorate([h.property({readOnly:!0})],C.prototype,"isOrganization",null),r.__decorate([h.property()],C.prototype,"isPortal",void 0),r.__decorate([h.property()],C.prototype,"isReadOnly",void 0),r.__decorate([h.property()],C.prototype,"layerTemplatesGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"maxTokenExpirationMinutes",void 0),r.__decorate([h.property({type:Date})],C.prototype,"modified",void 0),r.__decorate([h.property()],C.prototype,"name",void 0),r.__decorate([h.property()],C.prototype,"portalHostname",void 0),r.__decorate([h.property()],C.prototype,"portalMode",void 0),r.__decorate([h.property()],C.prototype,"portalProperties",void 0),r.__decorate([h.property()],C.prototype,"region",void 0),r.__decorate([h.property({readOnly:!0})],C.prototype,"restUrl",null),r.__decorate([h.property()],C.prototype,"rotatorPanels",void 0),r.__decorate([h.property()],C.prototype,"showHomePageDescription",void 0),r.__decorate([h.property()],C.prototype,"sourceJSON",void 0),r.__decorate([h.property()],C.prototype,"staticImagesUrl",void 0),r.__decorate([h.property({readOnly:!0,json:{read:!1}})],C.prototype,"stylesGroupQuery",null),r.__decorate([h.property({json:{name:"2DStylesGroupQuery"}})],C.prototype,"stylesGroupQuery2d",void 0),r.__decorate([h.property({json:{name:"stylesGroupQuery"}})],C.prototype,"stylesGroupQuery3d",void 0),r.__decorate([h.property()],C.prototype,"supportsHostedServices",void 0),r.__decorate([h.property()],C.prototype,"symbolSetsGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"templatesGroupQuery",void 0),r.__decorate([h.property()],C.prototype,"thumbnail",void 0),r.__decorate([h.property({readOnly:!0})],C.prototype,"thumbnailUrl",null),r.__decorate([h.property()],C.prototype,"units",void 0),r.__decorate([h.property()],C.prototype,"url",void 0),r.__decorate([h.property()],C.prototype,"urlKey",void 0),r.__decorate([m.reader("urlKey")],C.prototype,"readUrlKey",null),r.__decorate([h.property()],C.prototype,"user",void 0),r.__decorate([m.reader("user")],C.prototype,"readUser",null),r.__decorate([h.property()],C.prototype,"useStandardizedQuery",void 0),r.__decorate([h.property()],C.prototype,"useVectorBasemaps",void 0),r.__decorate([h.property()],C.prototype,"vectorBasemapGalleryGroupQuery",void 0),C=U=r.__decorate([v.subclass("esri.portal.Portal")],C),C}));
