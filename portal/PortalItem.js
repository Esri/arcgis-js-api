// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../assets","../core/Error","../core/JSONSupport","../core/lang","../core/Loadable","../core/maybe","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../geometry/Extent","./Portal","./PortalItemResource","./PortalRating","@dojo/framework/shim/Promise"],(function(e,t,r,o,i,a,n,s,p,l,c,d,u,y,m,h,g){"use strict";return function(t){function a(e){var r=t.call(this,e)||this;return r.access=null,r.accessInformation=null,r.applicationProxies=null,r.avgRating=null,r.categories=null,r.created=null,r.culture=null,r.description=null,r.extent=null,r.groupCategories=null,r.id=null,r.itemControl=null,r.licenseInfo=null,r.modified=null,r.name=null,r.numComments=null,r.numRatings=null,r.numViews=null,r.owner=null,r.ownerFolder=null,r.portal=null,r.screenshots=null,r.size=null,r.snippet=null,r.sourceJSON=null,r.tags=null,r.title=null,r.type=null,r.typeKeywords=null,r.url=null,r}var s;return r.__extends(a,t),s=a,a.from=function(e){return u.ensureClass(s,e)},a.prototype.destroy=function(){this.portal=null},Object.defineProperty(a.prototype,"displayName",{get:function(){var e=this.type,t=this.typeKeywords||[],r=e;return"Feature Service"===e||"Feature Collection"===e?r=t.indexOf("Table")>-1?"Table":t.indexOf("Route Layer")>-1?"Route Layer":t.indexOf("Markup")>-1?"Markup":"Feature Layer":"Image Service"===e?r=t.indexOf("Elevation 3D Layer")>-1?"Elevation Layer":t.indexOf("Tiled Imagery")>-1?"Tiled Imagery Layer":"Imagery Layer":"Scene Service"===e?r="Scene Layer":"Scene Package"===e?r="Scene Layer Package":"Stream Service"===e?r="Feature Layer":"Geoprocessing Service"===e&&this.portal&&this.portal.isPortal?r=t.indexOf("Web Tool")>-1?"Tool":"Geoprocessing Service":"Geocoding Service"===e?r="Locator":"Microsoft Powerpoint"===e?r="Microsoft PowerPoint":"GeoJson"===e?r="GeoJSON":"Globe Service"===e?r="Globe Layer":"Vector Tile Service"===e?r="Tile Layer":"netCDF"===e?r="NetCDF":"Map Service"===e?r=-1===t.indexOf("Spatiotemporal")&&(t.indexOf("Hosted Service")>-1||t.indexOf("Tiled")>-1)&&-1===t.indexOf("Relational")?"Tile Layer":"Map Image Layer":e&&e.toLowerCase().indexOf("add in")>-1?r=e.replace(/(add in)/gi,"Add-In"):"datastore catalog service"===e?r="Big Data File Share":"Compact Tile Package"===e&&(r="Tile Package (tpkx)"),r},enumerable:!1,configurable:!0}),a.prototype.readExtent=function(e){return e&&e.length?new y(e[0][0],e[0][1],e[1][0],e[1][1]):null},Object.defineProperty(a.prototype,"iconUrl",{get:function(){var e,t=this.type&&this.type.toLowerCase()||"",r=this.typeKeywords||[],i=!1,a=!1,n=!1,s=!1,p=!1;return t.indexOf("service")>0||"feature collection"===t||"kml"===t||"wms"===t||"wmts"===t||"wfs"===t?(i=r.indexOf("Hosted Service")>-1,"feature service"===t||"feature collection"===t||"kml"===t||"wfs"===t?(a=r.indexOf("Table")>-1,n=r.indexOf("Route Layer")>-1,s=r.indexOf("Markup")>-1,e=(p=-1!==r.indexOf("Spatiotemporal"))&&a?"spatiotemporaltable":a?"table":n?"routelayer":s?"markup":p?"spatiotemporal":i?"featureshosted":"features"):e="map service"===t||"wms"===t||"wmts"===t?i||r.indexOf("Tiled")>-1||"wmts"===t?"maptiles":"mapimages":"scene service"===t?r.indexOf("Line")>-1?"sceneweblayerline":r.indexOf("3DObject")>-1?"sceneweblayermultipatch":r.indexOf("Point")>-1?"sceneweblayerpoint":r.indexOf("IntegratedMesh")>-1?"sceneweblayermesh":r.indexOf("PointCloud")>-1?"sceneweblayerpointcloud":r.indexOf("Polygon")>-1?"sceneweblayerpolygon":r.indexOf("Building")>-1?"sceneweblayerbuilding":"sceneweblayer":"image service"===t?r.indexOf("Elevation 3D Layer")>-1?"elevationlayer":r.indexOf("Tiled Imagery")>-1?"tiledimagerylayer":"imagery":"stream service"===t?"streamlayer":"vector tile service"===t?"vectortile":"datastore catalog service"===t?"datastorecollection":"geocoding service"===t?"geocodeservice":"geoprocessing service"===t&&r.indexOf("Web Tool")>-1&&this.portal&&this.portal.isPortal?"tool":"layers"):e="web map"===t||"cityengine web scene"===t?"maps":"web scene"===t?r.indexOf("ViewingMode-Local")>-1?"webscenelocal":"websceneglobal":"web mapping application"===t||"mobile application"===t||"application"===t||"operation view"===t||"desktop application"===t?"apps":"map document"===t||"map package"===t||"published map"===t||"scene document"===t||"globe document"===t||"basemap package"===t||"mobile basemap package"===t||"mobile map package"===t||"project package"===t||"project template"===t||"pro map"===t||"layout"===t||"layer"===t&&r.indexOf("ArcGIS Pro")>-1||"explorer map"===t&&r.indexOf("Explorer Document")?"mapsgray":"service definition"===t||"csv"===t||"shapefile"===t||"cad drawing"===t||"geojson"===t||"360 vr experience"===t||"netcdf"===t||"administrative report"===t?"datafiles":"explorer add in"===t||"desktop add in"===t||"windows viewer add in"===t||"windows viewer configuration"===t?"appsgray":"arcgis pro add in"===t||"arcgis pro configuration"===t?"addindesktop":"rule package"===t||"file geodatabase"===t||"sqlite geodatabase"===t||"csv collection"===t||"kml collection"===t||"windows mobile package"===t||"map template"===t||"desktop application template"===t||"gml"===t||"arcpad package"===t||"code sample"===t||"form"===t||"document link"===t||"operations dashboard add in"===t||"rules package"===t||"image"===t||"workflow manager package"===t||"explorer map"===t&&r.indexOf("Explorer Mapping Application")>-1||r.indexOf("Document")>-1?"datafilesgray":"network analysis service"===t||"geoprocessing service"===t||"geodata service"===t||"geometry service"===t||"geoprocessing package"===t||"locator package"===t||"geoprocessing sample"===t||"workflow manager service"===t?"toolsgray":"layer"===t||"layer package"===t||"explorer layer"===t?"layersgray":"scene package"===t?"scenepackage":"mobile scene package"===t?"mobilescenepackage":"tile package"===t||"compact tile package"===t?"tilepackage":"task file"===t?"taskfile":"report template"===t?"report-template":"statistical data collection"===t?"statisticaldatacollection":"insights workbook"===t?"workbook":"insights model"===t?"insightsmodel":"insights page"===t?"insightspage":"insights theme"===t?"insightstheme":"hub initiative"===t?"hubinitiative":"hubpage"===t?"hubpage":"hub event"===t?"hubevent":"hub site application"===t?"hubsite":"relational database connection"===t?"relationaldatabaseconnection":"big data file share"===t?"datastorecollection":"image collection"===t?"imagecollection":"style"===t?"style":"desktop style"===t?"desktopstyle":"dashboard"===t?"dashboard":"raster function template"===t?"rasterprocessingtemplate":"vector tile package"===t?"vectortilepackage":"ortho mapping project"===t?"orthomappingproject":"ortho mapping template"===t?"orthomappingtemplate":"solution"===t?"solutions":"geopackage"===t?"geopackage":"deep learning package"===t?"deeplearningpackage":"real time analytic"===t?"realtimeanalytics":"big data analytic"===t?"bigdataanalytics":"feed"===t?"feed":"excalibur imagery project"===t?"excaliburimageryproject":"notebook"===t?"notebook":"storymap"===t?"storymap":"survey123 add in"===t?"survey123addin":"mission"===t?"mission":"mission report"===t?"missionreport":"quickcapture project"===t?"quickcaptureproject":"pro report"===t?"proreport":"urban model"===t?"urbanmodel":"web experience"===t?"experiencebuilder":"web experience template"===t?"webexperiencetemplate":"workflow"===t?"workflow":"insights script"===t?"insightsscript":"kernel gateway connection"===t?"kernelgatewayconnection":"hub initiative template"===t?"hubinitiativetemplate":"storymap theme"===t?"storymaptheme":"maps",e?o.getAssetUrl("esri/images/portal/"+e+"16.png"):null},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"isLayer",{get:function(){return["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","WMTS","WMS"].indexOf(this.type)>-1},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"itemUrl",{get:function(){var e=this.get("portal.restUrl");return e?e+"/content/items/"+this.id:null},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"thumbnailUrl",{get:function(){var e=this.itemUrl,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(e+"/info/"+t+"?f=json"):null},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"userItemUrl",{get:function(){var e=this.get("portal.restUrl");if(!e)return null;var t=this.owner||this.get("portal.user.username");return t?e+"/content/users/"+(this.ownerFolder?t+"/"+this.ownerFolder:t)+"/items/"+this.id:null},enumerable:!1,configurable:!0}),a.prototype.load=function(e){var t=this;this.portal||(this.portal=m.getDefault());var r=this.portal.load(e).then((function(){return t.sourceJSON?t.sourceJSON:t.id&&t.itemUrl?t.portal._request(t.itemUrl,{signal:p.isSome(e)?e.signal:null}):{}})).then((function(e){t.sourceJSON=e,t.read(e)}));return this.addResolvingPromise(r),l.resolve(this)},a.prototype.addRating=function(e){var t={method:"post",query:{}};return e instanceof g&&(e=e.rating),isNaN(e)||"number"!=typeof e||(t.query.rating=e),this.portal._request(this.itemUrl+"/addRating",t).then((function(){return new g({rating:e,created:new Date})}))},a.prototype.clone=function(){var e={access:this.access,accessInformation:this.accessInformation,applicationProxies:n.clone(this.applicationProxies),avgRating:this.avgRating,categories:n.clone(this.categories),created:n.clone(this.created),culture:this.culture,description:this.description,extent:n.clone(this.extent),groupCategories:n.clone(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:n.clone(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:n.clone(this.screenshots),size:this.size,snippet:this.snippet,tags:n.clone(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:n.clone(this.typeKeywords),url:this.url};return this.loaded&&(e.loadStatus="loaded"),new s({sourceJSON:this.sourceJSON}).set(e)},a.prototype.createPostQuery=function(){var e=this.toJSON();for(var t in e)"tags"===t&&null!==e[t]&&(e[t]=e[t].join(", ")),"typeKeywords"===t&&null!==e[t]&&(e[t]=e[t].join(", ")),"extent"===t&&e[t]&&(e[t]=JSON.stringify(e[t]));return e},a.prototype.deleteRating=function(){return this.portal._request(this.itemUrl+"/deleteRating",{method:"post"}).then((function(){}))},a.prototype.fetchData=function(e,t){return void 0===e&&(e="json"),this.portal._request(this.itemUrl+"/data",r.__assign({responseType:e},t))},a.prototype.fetchRating=function(e){return this.portal._request(this.itemUrl+"/rating",e).then((function(e){return null!=e.rating?(e.created=new Date(e.created),new g(e)):null}))},a.prototype.fetchRelatedItems=function(e,t){return this.portal._requestToTypedArray(this.itemUrl+"/relatedItems",r.__assign({query:e},t),s)},a.prototype.getThumbnailUrl=function(e){var t=this.thumbnailUrl;return t&&e&&(t+="&w="+e),t},a.prototype.reload=function(){var e=this;return this.portal._request(this.itemUrl,{cacheBust:!0}).then((function(t){return e.sourceJSON=t,e.read(t),e}))},a.prototype.update=function(e){var t=this;return this.id?this.load().then((function(){return t.portal._signIn()})).then((function(){var r=e&&e.data,o={method:"post"};for(var i in o.query=t.createPostQuery(),o.query)null===o.query[i]&&(o.query[i]="");return o.query.clearEmptyFields=!0,null!=r&&("string"==typeof r?o.query.text=r:"object"==typeof r&&(o.query.text=JSON.stringify(r))),t.portal._request(t.userItemUrl+"/update",o).then((function(){return t.reload()}))})):l.reject(new i("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))},a.prototype.updateThumbnail=function(e){var t=this;return this.id?this.load().then((function(){return t.portal._signIn()})).then((function(){var r=e.thumbnail,o=e.filename,i={method:"post"};if("string"==typeof r)c.isDataProtocol(r)?i.query={data:r}:i.query={url:c.makeAbsolute(r)},p.isSome(o)&&(i.query.filename=o);else{var a=new FormData;p.isSome(o)?a.append("file",r,o):a.append("file",r),i.body=a}return t.portal._request(t.userItemUrl+"/updateThumbnail",i).then((function(){return t.reload()}))})):l.reject(new i("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))},a.prototype.fetchResources=function(t,o){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["./support/resourceUtils"],t,r)}))];case 1:return[2,r.sent().fetchResources(this,t,o)]}}))}))},a.prototype.addResource=function(t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["./support/resourceUtils"],t,r)}))];case 1:return a=r.sent(),t.portalItem=this,[2,a.addOrUpdateResource(t,"add",o,i)]}}))}))},a.prototype.removeResource=function(t,o){return r.__awaiter(this,void 0,void 0,(function(){var a;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["./support/resourceUtils"],t,r)}))];case 1:if(a=r.sent(),t.portalItem&&t.portalItem.itemUrl!==this.itemUrl)throw new i("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return[2,a.removeResource(this,t,o)]}}))}))},a.prototype.removeAllResources=function(t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["./support/resourceUtils"],t,r)}))];case 1:return[2,r.sent().removeAllResources(this,t)]}}))}))},a.prototype.resourceFromPath=function(e){return new h({portalItem:this,path:e})},a.prototype.toJSON=function(){var e=this.extent,t={created:this.created&&this.created.getTime(),description:this.description,extent:e&&[[e.xmin,e.ymin],[e.xmax,e.ymax]],id:this.id,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,tags:this.tags,thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:this.typeKeywords,url:this.url};return n.fixJson(t)},a.fromJSON=function(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new s({sourceJSON:e})},a.prototype._getPostQuery=function(){var e=this.toJSON();for(var t in e)"tags"===t&&null!==e[t]&&(e[t]=e[t].join(", ")),"typeKeywords"===t&&null!==e[t]&&(e[t]=e[t].join(", ")),"extent"===t&&e[t]&&(e[t]=JSON.stringify(e[t]));return e},r.__decorate([d.property({type:["private","shared","org","public"]})],a.prototype,"access",void 0),r.__decorate([d.property()],a.prototype,"accessInformation",void 0),r.__decorate([d.property({json:{read:{source:"appProxies"}}})],a.prototype,"applicationProxies",void 0),r.__decorate([d.property()],a.prototype,"avgRating",void 0),r.__decorate([d.property()],a.prototype,"categories",void 0),r.__decorate([d.property({type:Date})],a.prototype,"created",void 0),r.__decorate([d.property()],a.prototype,"culture",void 0),r.__decorate([d.property()],a.prototype,"description",void 0),r.__decorate([d.property({dependsOn:["type","typeKeywords"],readOnly:!0})],a.prototype,"displayName",null),r.__decorate([d.property({type:y})],a.prototype,"extent",void 0),r.__decorate([d.reader("extent")],a.prototype,"readExtent",null),r.__decorate([d.property()],a.prototype,"groupCategories",void 0),r.__decorate([d.property({dependsOn:["type","typeKeywords"],readOnly:!0})],a.prototype,"iconUrl",null),r.__decorate([d.property()],a.prototype,"id",void 0),r.__decorate([d.property({dependsOn:["type"],readOnly:!0})],a.prototype,"isLayer",null),r.__decorate([d.property()],a.prototype,"itemControl",void 0),r.__decorate([d.property({dependsOn:["portal.restUrl","id"],readOnly:!0})],a.prototype,"itemUrl",null),r.__decorate([d.property()],a.prototype,"licenseInfo",void 0),r.__decorate([d.property({type:Date})],a.prototype,"modified",void 0),r.__decorate([d.property()],a.prototype,"name",void 0),r.__decorate([d.property()],a.prototype,"numComments",void 0),r.__decorate([d.property()],a.prototype,"numRatings",void 0),r.__decorate([d.property()],a.prototype,"numViews",void 0),r.__decorate([d.property()],a.prototype,"owner",void 0),r.__decorate([d.property()],a.prototype,"ownerFolder",void 0),r.__decorate([d.property({type:m})],a.prototype,"portal",void 0),r.__decorate([d.property()],a.prototype,"screenshots",void 0),r.__decorate([d.property()],a.prototype,"size",void 0),r.__decorate([d.property()],a.prototype,"snippet",void 0),r.__decorate([d.property()],a.prototype,"sourceJSON",void 0),r.__decorate([d.property()],a.prototype,"tags",void 0),r.__decorate([d.property()],a.prototype,"thumbnail",void 0),r.__decorate([d.property({dependsOn:["itemUrl","thumbnail","portal.credential.token"],readOnly:!0})],a.prototype,"thumbnailUrl",null),r.__decorate([d.property()],a.prototype,"title",void 0),r.__decorate([d.property()],a.prototype,"type",void 0),r.__decorate([d.property()],a.prototype,"typeKeywords",void 0),r.__decorate([d.property()],a.prototype,"url",void 0),r.__decorate([d.property({dependsOn:["portal.restUrl","portal.user.username","owner","ownerFolder","id"],readOnly:!0})],a.prototype,"userItemUrl",null),a=s=r.__decorate([d.subclass("esri.portal.PortalItem")],a)}(a.JSONSupportMixin(s))}));