/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../portal/schemas/webScene","./utils"],(function(e,t,n,r,s,i){"use strict";const o=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function a(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}function c(e){return"array"===e.type?`${c(e.items)}[]`:e.type}function u(e){const t={count:e.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},n=new Set;for(const r in e){const s=e[r];s.$ref?t.refsCount++:s.type&&(t.typesCount++,n.add(c(s)))}return n.forEach((e=>t.distinctTypes.push(e))),t.distinctTypes.sort(),t.refsCount===t.count?t.type="refs":2===t.count&&t.refsCount>0&&1===t.distinctTypes.length&&"null"===t.distinctTypes[0]?t.type="refsAndNull":t.typesCount===t.count?(t.type="types",t.distinctTypes=t.distinctTypes):t.type="mix",t}function l(e){return"array"===e.type||!("properties"in e)}function p(e,t,n){if(!n.hasFilteredProperties)return`${e}--${t}`;return`${e}--${t}--${n.filteredPropertiesArray.join("/")}`}function f(e,t,n,r,s){return y.apply(this,arguments)}function y(){return(y=n._asyncToGenerator((function*(e,t,n,r,s){s.schemaStack.push(e);const i=a(e,n);if(r=r?r.replace("<?TYPE?>",i?`<${i}>`:""):null,l(n)){const i=s.currentClass?null:{type:e,name:e,id:`${e}--${t}`,typeValue:t,properties:[]};return i&&s.push(null,i),yield A(n,r,s),s.schemaStack.pop(),i}const o=p(e,t,s),c="drawingInfo_schema.json"!==e&&"layer_schema.json"!==e&&s.seen.get(o);if(c&&r)return s.addProperty({name:r,type:c}),s.schemaStack.pop(),c;const u={type:e,name:e,id:o,typeValue:t,properties:[]};return r&&s.addProperty({name:r,type:u}),s.push(r,u),yield A(n,"",s),s.schemaStack.pop(),s.pop()}))).apply(this,arguments)}function h(e,t,n){return d.apply(this,arguments)}function d(){return(d=n._asyncToGenerator((function*(e,t,n){const r=yield n.requestSchema(e.$ref),s=q(r.schema);if(s){for(const e of s){const s={...r.schema};s.properties={...s.properties,type:{type:"string",enum:[e]}};const i=-1===t.indexOf("<?TYPE?>")?`${t}<?TYPE?>`:t;yield f(r.schemaId,e,s,i,n)}return}const i="layer_schema.json"===r.schemaId&&n.schemaStack.length?n.schemaStack[n.schemaStack.length-1].replace(/_schema\.json/,""):null;yield f(r.schemaId,i,r.schema,t,n)}))).apply(this,arguments)}function m(e,t){if(!j(e))return!1;const n=e.stack.map((e=>e.klass.type)).join("/");return/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(n)&&"renderer"===t}function _(e,t){if(!j(e))return!1;const n=e.stack.map((e=>e.klass.type)).join("/");return/.*(imageServiceLayer|tiledImageServiceLayer)_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(n)&&"renderer"===t}function j(e){return e.currentClass&&"drawingInfo_schema.json"===e.currentClass.name}function g(e){switch(e.schemaStack[e.schemaStack.length-1]){case"operationalLayers_schema.json":case"elevationLayers_schema.json":case"baseMapLayer_schema.json":return!0}return!1}const $=/raster.*Renderer|vectorFieldRenderer/,P=/(uniqueValueRenderer|classBreaksRenderer|raster.*Renderer|vectorFieldRenderer)/,S=/(rasterUniqueValueRenderer|rasterClassBreaksRenderer)/;function T(e,t,n){if(j(n)){const r=m(n,t),s=_(n,t);return e.filter((e=>{if(/uniqueValueFromStyleRenderer_schema\.json$/.test(e.$ref))return!1;if(s)return P.test(e.$ref)&&!S.test(e.$ref);if($.test(e.$ref))return!1;const t=/pointCloud.*Renderer/.test(e.$ref);return r===t}))}if(g(n)){const t=["kmlLayer","rasterDataElevationLayer","rasterDataLayer"];return e.filter((e=>!t.some((t=>e.$ref.replace(/.*\//,"")===`${t}_schema.json`))))}return e}function w(e,t,n){return k.apply(this,arguments)}function k(){return(k=n._asyncToGenerator((function*(e,t,n){yield A(e.items,`${t}[]`,n)}))).apply(this,arguments)}function R(e,t,n){return v.apply(this,arguments)}function v(){return(v=n._asyncToGenerator((function*(e,t,r){for(const s in e.properties)if(("webscene_schema.json"!==r.currentClass.name||"tables"!==s&&"mapRangeInfo"!==s&&"widgets"!==s)&&("baseMap_schema.json"!==r.currentClass.name||"elevationLayers"!==s)){if(j(r)){const e=r.stack.map((e=>e.klass.type)).join("/");if(/imageServiceLayer|tiledImageServiceLayer/.test(e)&&"transparency"===s)continue}yield r.withFilter(s,n._asyncToGenerator((function*(){const n=t?`${t}.${s}`:s;yield A(e.properties[s],n,r)})))}}))).apply(this,arguments)}function O(e,t="",n=new Set){for(const r of e)if("properties"in r)for(const e in r.properties){const s=r.properties[e],i=t?`${t}.${e}`:e,o=Object.keys(s);if(0===o.length||1===o.length&&"$ref"===o[0])n.add(i);else{if(1!==o.length||"allOf"!==o[0])throw new Error(`unexpected allOf filter construct: ${JSON.stringify(s)}`);n.add(i),O(s.allOf,i,n)}}return n}function b(e,t,n){return C.apply(this,arguments)}function C(){return(C=n._asyncToGenerator((function*(e,t,n){let r=null;for(const i of e.allOf)if("$ref"in i){if(r)throw new Error("Cannot process more than 1 ref in an allOf construct");r=i}else if(!("properties"in i))throw new Error("allOf construct only allows simple top-level property filters");const s=O(e.allOf);yield n.addFilter(s,(()=>h(r,t,n)))}))).apply(this,arguments)}function L(e,t,n){return G.apply(this,arguments)}function G(){return(G=n._asyncToGenerator((function*(e,t,n){const r=u(e.oneOf);if("refs"!==r.type&&"refsAndNull"!==r.type)if("types"!==r.type)for(const s in e.oneOf){const r=`.oneOf[${s}]`;yield A(e.oneOf[s],`${t}${r}`,n)}else n.addProperty({name:t,type:i.sorted(r.distinctTypes).join("|")});else{const r=T(e.oneOf,t,n);for(const e of r)if("null"===e.type);else{const s=`${t||""}`+(1!==r.length?"<?TYPE?>":"");yield A(e,s,n)}}}))).apply(this,arguments)}function q(e){if("layerDefinition"===e.title)return null;const t=e.properties&&e.properties.type;return t&&t.enum?t.enum:null}function E(e,t,n){return I.apply(this,arguments)}function I(){return(I=n._asyncToGenerator((function*(e,t,n){yield h(e,t,n)}))).apply(this,arguments)}function F(e,t,n){return x.apply(this,arguments)}function x(){return(x=n._asyncToGenerator((function*(e,t,n){let r="unknown";e.type&&(r=Array.isArray(e.type)?i.sorted(e.type).join("|"):e.type.replace(/ /g,"").split(",").join("|"));const s={name:t,type:r,default:e.default};e.enum&&(s.enum=i.sorted(e.enum).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|")),n.addProperty(s)}))).apply(this,arguments)}function A(e,t,n){return D.apply(this,arguments)}function D(){return(D=n._asyncToGenerator((function*(e,t,n){return"array"===e.type?w(e,t,n):"properties"in e?R(e,t,n):"allOf"in e?b(e,t,n):"oneOf"in e?L(e,t,n):"$ref"in e?E(e,t,n):F(e,t,n)}))).apply(this,arguments)}const M="#/definitions/";function V(e){return 0===e.indexOf(M)?e.slice(M.length):e}function Y(e,t){return z.apply(this,arguments)}function z(){return(z=n._asyncToGenerator((function*(e,t){const n=yield B.create(e,t);return f(`${e||"webscene"}_schema.json`,null,n.schemaRoot,null,n)}))).apply(this,arguments)}let B=function(t){function i(e,r,s){var i;return(i=t.call(this)||this).definitions=e,i.schemaRoot=r,i.requestSchema=s,i.filteredProperties=null,i.schemaStack=[],i.requestSchema.bind(n._assertThisInitialized(i)),i}n._inheritsLoose(i,t);var a=i.prototype;return a.withFilter=function(){var e=n._asyncToGenerator((function*(e,t){if(!this.hasFilteredProperties)return t();if(!this.filteredProperties.has(e))return;const n=this.filteredProperties;this.filteredProperties=null;const r=e=>{this.filteredProperties||(this.filteredProperties=new Set),this.filteredProperties.add(e)};n.forEach((t=>{const n=t.split(".",2);n.length>1&&n[0]===e&&r(n[1])})),yield t(),this.filteredProperties=n}));function t(t,n){return e.apply(this,arguments)}return t}(),a.addFilter=function(){var e=n._asyncToGenerator((function*(e,t){const n=this.filteredProperties;this.filteredProperties=null;const r=e=>{this.filteredProperties||(this.filteredProperties=new Set),this.filteredProperties.add(e)};n&&n.forEach(r),e&&e.forEach(r);const s=yield t();return this.filteredProperties=n,s}));function t(t,n){return e.apply(this,arguments)}return t}(),i.create=function(){var e=n._asyncToGenerator((function*(e,t){return t&&t.useRemoteSchema?i.createRemote(e,t.baseUrl):i.createLocal(e)}));function t(t,n){return e.apply(this,arguments)}return t}(),i.createLocal=function(e){const t=e&&"webscene"!==e?s.json.definitions[`${e}_schema.json`]:s.json;return new i(s.json.definitions,t,i._getLocalSchemaRequest())},i.createRemote=function(){var e=n._asyncToGenerator((function*(e,t){const n=yield i._getRemoteSchemaRequest(t),r=new i({},null,n),s=(yield r.requestSchema(`${e||"webscene"}_schema.json`)).schema;return new i(r.definitions,s,n)}));function t(t,n){return e.apply(this,arguments)}return t}(),i._getLocalSchemaRequest=function(){return function(e){const t=V(e),n=this.definitions[t];return n?Promise.resolve({schemaId:t,schema:n}):Promise.reject(new r("spec-certification:spec-invalid-local-schema","Schema reference is not a local reference"))}},i._getRemoteSchemaRequest=function(){var t=n._asyncToGenerator((function*(t){if(!t)return Promise.reject(new r("spec-certification:spec-missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"));const n=i._getLocalSchemaRequest(),s=(yield new Promise(((t,n)=>e(["../../request"],(e=>t(o(e))),n)))).default;return function(e){return n.call(this,e).catch((()=>s(`${t}/${e}`,{responseType:"json"}).then((t=>(this.definitions[V(e)]=t.data,{schemaId:e,schema:t.data})))))}}));function s(e){return t.apply(this,arguments)}return s}(),n._createClass(i,[{key:"hasFilteredProperties",get:function(){return this.filteredProperties&&this.filteredProperties.size>0}},{key:"filteredPropertiesArray",get:function(){const e=[];return this.filteredProperties.forEach((t=>e.push(t))),e}}]),i}(i.ScanContext);const N=Object.keys(s.json.definitions).map((e=>e.replace(/_schema\.json$/,"")));t.scan=Y,t.schemaDefinitions=N,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
