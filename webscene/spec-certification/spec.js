/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/promiseUtils","../../portal/schemas/webScene","./utils"],(function(e,t,n,r,s,i,o){"use strict";function a(e){return Object.freeze({__proto__:null,default:e})}function c(e){return"array"===e.type?`${c(e.items)}[]`:e.type}async function l(e,t,n,r,s){s.schemaStack.push(e);const i=function(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}(e,n);if(r=r?r.replace("<?TYPE?>",i?`<${i}>`:""):null,function(e){return"array"===e.type||!("properties"in e)}(n)){const i=s.currentClass?null:{type:e,name:e,id:`${e}--${t}`,typeValue:t,properties:[]};return i&&s.push(null,i),await $(n,r,s),s.schemaStack.pop(),i}const o=function(e,t,n){return n.hasFilteredProperties?`${e}--${t}--${n.filteredPropertiesArray.join("/")}`:`${e}--${t}`}(e,t,s),a="drawingInfo_schema.json"!==e&&"layer_schema.json"!==e&&s.seen.get(o);if(a&&r)return s.addProperty({name:r,type:a}),s.schemaStack.pop(),a;const c={type:e,name:e,id:o,typeValue:t,properties:[]};return r&&s.addProperty({name:r,type:c}),s.push(r,c),await $(n,"",s),s.schemaStack.pop(),s.pop()}async function u(e,t,n){const r=await n.requestSchema(e.$ref),s=function(e){if("layerDefinition"===e.title)return null;const t=e.properties&&e.properties.type;if(!t||!t.enum)return null;return t.enum}(r.schema);if(s){for(const e of s){const s={...r.schema};s.properties={...s.properties,type:{type:"string",enum:[e]}};const i=-1===t.indexOf("<?TYPE?>")?`${t}<?TYPE?>`:t;await l(r.schemaId,e,s,i,n)}return}const i="layer_schema.json"===r.schemaId&&n.schemaStack.length?n.schemaStack[n.schemaStack.length-1].replace(/_schema\.json/,""):null;await l(r.schemaId,i,r.schema,t,n)}function f(e){return e.currentClass&&"drawingInfo_schema.json"===e.currentClass.name}const p=/raster.*Renderer|vectorFieldRenderer/,h=/(uniqueValueRenderer|classBreaksRenderer|raster.*Renderer|vectorFieldRenderer)/,m=/(rasterUniqueValueRenderer|rasterClassBreaksRenderer)/;function y(e,t,n){if(f(n)){const r=function(e,t){if(!f(e))return!1;const n=e.stack.map((e=>e.klass.type)).join("/");return/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(n)&&"renderer"===t}(n,t),s=function(e,t){if(!f(e))return!1;const n=e.stack.map((e=>e.klass.type)).join("/");return/.*(imageServiceLayer|tiledImageServiceLayer)_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(n)&&"renderer"===t}(n,t);return e.filter((e=>{if(/uniqueValueFromStyleRenderer_schema\.json$/.test(e.$ref))return!1;if(s)return h.test(e.$ref)&&!m.test(e.$ref);if(p.test(e.$ref))return!1;const t=/pointCloud.*Renderer/.test(e.$ref);return r===t}))}if(function(e){switch(e.schemaStack[e.schemaStack.length-1]){case"operationalLayers_schema.json":case"elevationLayers_schema.json":case"baseMapLayer_schema.json":return!0}return!1}(n)){const t=["kmlLayer","rasterDataElevationLayer","rasterDataLayer"];return e.filter((e=>!t.some((t=>e.$ref.replace(/.*\//,"")===`${t}_schema.json`))))}return e}function d(e,t="",n=new Set){for(const r of e)if("properties"in r)for(const e in r.properties){const s=r.properties[e],i=t?`${t}.${e}`:e,o=Object.keys(s);if(0===o.length||1===o.length&&"$ref"===o[0])n.add(i);else{if(1!==o.length||"allOf"!==o[0])throw new Error(`unexpected allOf filter construct: ${JSON.stringify(s)}`);n.add(i),d(s.allOf,i,n)}}return n}async function w(e,t,n){let r=null;for(const t of e.allOf)if("$ref"in t){if(r)throw new Error("Cannot process more than 1 ref in an allOf construct");r=t}else if(!("properties"in t))throw new Error("allOf construct only allows simple top-level property filters");const s=d(e.allOf);await n.addFilter(s,(()=>u(r,t,n)))}async function j(e,t,n){const r=function(e){const t={count:e.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},n=new Set;for(const r in e){const s=e[r];s.$ref?t.refsCount++:s.type&&(t.typesCount++,n.add(c(s)))}return n.forEach((e=>t.distinctTypes.push(e))),t.distinctTypes.sort(),t.refsCount===t.count?t.type="refs":2===t.count&&t.refsCount>0&&1===t.distinctTypes.length&&"null"===t.distinctTypes[0]?t.type="refsAndNull":t.typesCount===t.count?(t.type="types",t.distinctTypes=t.distinctTypes):t.type="mix",t}(e.oneOf);if("refs"!==r.type&&"refsAndNull"!==r.type)if("types"!==r.type)for(const r in e.oneOf){const s=`.oneOf[${r}]`;await $(e.oneOf[r],`${t}${s}`,n)}else n.addProperty({name:t,type:o.sorted(r.distinctTypes).join("|")});else{const r=y(e.oneOf,t,n);for(const e of r)if("null"===e.type);else{const s=`${t||""}`+(1!==r.length?"<?TYPE?>":"");await $(e,s,n)}}}async function $(e,t,n){return"array"===e.type?async function(e,t,n){await $(e.items,`${t}[]`,n)}(e,t,n):"properties"in e?async function(e,t,n){for(const r in e.properties)if(("webscene_schema.json"!==n.currentClass.name||"tables"!==r&&"mapRangeInfo"!==r&&"widgets"!==r)&&("baseMap_schema.json"!==n.currentClass.name||"elevationLayers"!==r)){if(f(n)){const e=n.stack.map((e=>e.klass.type)).join("/");if(/imageServiceLayer|tiledImageServiceLayer/.test(e)&&"transparency"===r)continue}await n.withFilter(r,(async()=>{const s=t?`${t}.${r}`:r;await $(e.properties[r],s,n)}))}}(e,t,n):"allOf"in e?w(e,t,n):"oneOf"in e?j(e,t,n):"$ref"in e?async function(e,t,n){await u(e,t,n)}(e,t,n):async function(e,t,n){let r="unknown";e.type&&(r=Array.isArray(e.type)?o.sorted(e.type).join("|"):e.type.replace(/ /g,"").split(",").join("|"));const s={name:t,type:r,default:e.default};e.enum&&(s.enum=o.sorted(e.enum).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|")),n.addProperty(s)}(e,t,n)}const g="#/definitions/";function _(e){return 0===e.indexOf(g)?e.slice(g.length):e}let P=function(t){function o(e,r,s){var i;return(i=t.call(this)||this).definitions=e,i.schemaRoot=r,i.requestSchema=s,i.filteredProperties=null,i.schemaStack=[],i.requestSchema.bind(n._assertThisInitialized(i)),i}n._inheritsLoose(o,t);var c=o.prototype;return c.withFilter=async function(e,t){if(!this.hasFilteredProperties)return t();if(!this.filteredProperties.has(e))return;const n=this.filteredProperties;this.filteredProperties=null;const r=e=>{this.filteredProperties||(this.filteredProperties=new Set),this.filteredProperties.add(e)};n.forEach((t=>{const n=t.split(".",2);n.length>1&&n[0]===e&&r(n[1])})),await t(),this.filteredProperties=n},c.addFilter=async function(e,t){const n=this.filteredProperties;this.filteredProperties=null;const r=e=>{this.filteredProperties||(this.filteredProperties=new Set),this.filteredProperties.add(e)};n&&n.forEach(r),e&&e.forEach(r);const s=await t();return this.filteredProperties=n,s},o.create=async function(e,t){return t&&t.useRemoteSchema?o.createRemote(e,t.baseUrl):o.createLocal(e)},o.createLocal=function(e){const t=e&&"webscene"!==e?i.json.definitions[`${e}_schema.json`]:i.json;return new o(i.json.definitions,t,o.getLocalSchemaRequest())},o.createRemote=async function(e,t){const n=await o.getRemoteSchemaRequest(t),r=new o({},null,n),s=(await r.requestSchema(`${e||"webscene"}_schema.json`)).schema;return new o(r.definitions,s,n)},o.getLocalSchemaRequest=function(){return function(e){const t=_(e),n=this.definitions[t];return n?s.resolve({schemaId:t,schema:n}):s.reject(new r("spec-certification:spec-invalid-local-schema","Schema reference is not a local reference"))}},o.getRemoteSchemaRequest=async function(t){if(!t)return s.reject(new r("spec-certification:spec-missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"));const n=o.getLocalSchemaRequest(),i=(await new Promise((function(t,n){e(["../../request"],(function(e){t(a(e))}),n)}))).default;return function(e){return n.call(this,e).catch((()=>i(`${t}/${e}`,{responseType:"json"}).then((t=>(this.definitions[_(e)]=t.data,{schemaId:e,schema:t.data})))))}},n._createClass(o,[{key:"hasFilteredProperties",get:function(){return this.filteredProperties&&this.filteredProperties.size>0}},{key:"filteredPropertiesArray",get:function(){const e=[];return this.filteredProperties.forEach((t=>e.push(t))),e}}]),o}(o.ScanContext);const S=Object.keys(i.json.definitions).map((e=>e.replace(/_schema\.json$/,"")));t.scan=async function(e,t){const n=await P.create(e,t);return l(`${e||"webscene"}_schema.json`,null,n.schemaRoot,null,n)},t.schemaDefinitions=S,Object.defineProperty(t,"__esModule",{value:!0})}));
