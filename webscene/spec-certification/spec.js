/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../portal/schemas/webScene","./utils"],(function(e,t,n,r,s,i){"use strict";function o(e){return Object.freeze({__proto__:null,default:e})}function a(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}function c(e){return"array"===e.type?`${c(e.items)}[]`:e.type}function l(e){const t={count:e.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},n=new Set;for(const r in e){const s=e[r];s.$ref?t.refsCount++:s.type&&(t.typesCount++,n.add(c(s)))}return n.forEach((e=>t.distinctTypes.push(e))),t.distinctTypes.sort(),t.refsCount===t.count?t.type="refs":2===t.count&&t.refsCount>0&&1===t.distinctTypes.length&&"null"===t.distinctTypes[0]?t.type="refsAndNull":t.typesCount===t.count?(t.type="types",t.distinctTypes=t.distinctTypes):t.type="mix",t}function u(e){return"array"===e.type||!("properties"in e)}function f(e,t,n){if(!n.hasFilteredProperties)return`${e}--${t}`;return`${e}--${t}--${n.filteredPropertiesArray.join("/")}`}async function p(e,t,n,r,s){s.schemaStack.push(e);const i=a(e,n);if(r=r?r.replace("<?TYPE?>",i?`<${i}>`:""):null,u(n)){const i=s.currentClass?null:{type:e,name:e,id:`${e}--${t}`,typeValue:t,properties:[]};return i&&s.push(null,i),await T(n,r,s),s.schemaStack.pop(),i}const o=f(e,t,s),c="drawingInfo_schema.json"!==e&&"layer_schema.json"!==e&&s.seen.get(o);if(c&&r)return s.addProperty({name:r,type:c}),s.schemaStack.pop(),c;const l={type:e,name:e,id:o,typeValue:t,properties:[]};return r&&s.addProperty({name:r,type:l}),s.push(r,l),await T(n,"",s),s.schemaStack.pop(),s.pop()}async function h(e,t,n){const r=await n.requestSchema(e.$ref),s=b(r.schema);if(s){for(const e of s){const s={...r.schema};s.properties={...s.properties,type:{type:"string",enum:[e]}};const i=-1===t.indexOf("<?TYPE?>")?`${t}<?TYPE?>`:t;await p(r.schemaId,e,s,i,n)}return}const i="layer_schema.json"===r.schemaId&&n.schemaStack.length?n.schemaStack[n.schemaStack.length-1].replace(/_schema\.json/,""):null;await p(r.schemaId,i,r.schema,t,n)}function m(e,t){if(!d(e))return!1;const n=e.stack.map((e=>e.klass.type)).join("/");return/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(n)&&"renderer"===t}function y(e,t){if(!d(e))return!1;const n=e.stack.map((e=>e.klass.type)).join("/");return/.*(imageServiceLayer|tiledImageServiceLayer)_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(n)&&"renderer"===t}function d(e){return e.currentClass&&"drawingInfo_schema.json"===e.currentClass.name}function w(e){switch(e.schemaStack[e.schemaStack.length-1]){case"operationalLayers_schema.json":case"elevationLayers_schema.json":case"baseMapLayer_schema.json":return!0}return!1}const j=/raster.*Renderer|vectorFieldRenderer/,$=/(uniqueValueRenderer|classBreaksRenderer|raster.*Renderer|vectorFieldRenderer)/,g=/(rasterUniqueValueRenderer|rasterClassBreaksRenderer)/;function _(e,t,n){if(d(n)){const r=m(n,t),s=y(n,t);return e.filter((e=>{if(/uniqueValueFromStyleRenderer_schema\.json$/.test(e.$ref))return!1;if(s)return $.test(e.$ref)&&!g.test(e.$ref);if(j.test(e.$ref))return!1;const t=/pointCloud.*Renderer/.test(e.$ref);return r===t}))}if(w(n)){const t=["kmlLayer","rasterDataElevationLayer","rasterDataLayer"];return e.filter((e=>!t.some((t=>e.$ref.replace(/.*\//,"")===`${t}_schema.json`))))}return e}async function P(e,t,n){await T(e.items,`${t}[]`,n)}async function S(e,t,n){for(const r in e.properties)if(("webscene_schema.json"!==n.currentClass.name||"tables"!==r&&"mapRangeInfo"!==r&&"widgets"!==r)&&("baseMap_schema.json"!==n.currentClass.name||"elevationLayers"!==r)){if(d(n)){const e=n.stack.map((e=>e.klass.type)).join("/");if(/imageServiceLayer|tiledImageServiceLayer/.test(e)&&"transparency"===r)continue}await n.withFilter(r,(async()=>{const s=t?`${t}.${r}`:r;await T(e.properties[r],s,n)}))}}function k(e,t="",n=new Set){for(const r of e)if("properties"in r)for(const e in r.properties){const s=r.properties[e],i=t?`${t}.${e}`:e,o=Object.keys(s);if(0===o.length||1===o.length&&"$ref"===o[0])n.add(i);else{if(1!==o.length||"allOf"!==o[0])throw new Error(`unexpected allOf filter construct: ${JSON.stringify(s)}`);n.add(i),k(s.allOf,i,n)}}return n}async function R(e,t,n){let r=null;for(const i of e.allOf)if("$ref"in i){if(r)throw new Error("Cannot process more than 1 ref in an allOf construct");r=i}else if(!("properties"in i))throw new Error("allOf construct only allows simple top-level property filters");const s=k(e.allOf);await n.addFilter(s,(()=>h(r,t,n)))}async function O(e,t,n){const r=l(e.oneOf);if("refs"!==r.type&&"refsAndNull"!==r.type)if("types"!==r.type)for(const s in e.oneOf){const r=`.oneOf[${s}]`;await T(e.oneOf[s],`${t}${r}`,n)}else n.addProperty({name:t,type:i.sorted(r.distinctTypes).join("|")});else{const r=_(e.oneOf,t,n);for(const e of r)if("null"===e.type);else{const s=`${t||""}`+(1!==r.length?"<?TYPE?>":"");await T(e,s,n)}}}function b(e){if("layerDefinition"===e.title)return null;const t=e.properties&&e.properties.type;return t&&t.enum?t.enum:null}async function C(e,t,n){await h(e,t,n)}async function L(e,t,n){let r="unknown";e.type&&(r=Array.isArray(e.type)?i.sorted(e.type).join("|"):e.type.replace(/ /g,"").split(",").join("|"));const s={name:t,type:r,default:e.default};e.enum&&(s.enum=i.sorted(e.enum).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|")),n.addProperty(s)}async function T(e,t,n){return"array"===e.type?P(e,t,n):"properties"in e?S(e,t,n):"allOf"in e?R(e,t,n):"oneOf"in e?O(e,t,n):"$ref"in e?C(e,t,n):L(e,t,n)}const v="#/definitions/";function q(e){return 0===e.indexOf(v)?e.slice(v.length):e}async function E(e,t){const n=await I.create(e,t);return p(`${e||"webscene"}_schema.json`,null,n.schemaRoot,null,n)}let I=function(t){function i(e,r,s){var i;return(i=t.call(this)||this).definitions=e,i.schemaRoot=r,i.requestSchema=s,i.filteredProperties=null,i.schemaStack=[],i.requestSchema.bind(n._assertThisInitialized(i)),i}n._inheritsLoose(i,t);var a=i.prototype;return a.withFilter=async function(e,t){if(!this.hasFilteredProperties)return t();if(!this.filteredProperties.has(e))return;const n=this.filteredProperties;this.filteredProperties=null;const r=e=>{this.filteredProperties||(this.filteredProperties=new Set),this.filteredProperties.add(e)};n.forEach((t=>{const n=t.split(".",2);n.length>1&&n[0]===e&&r(n[1])})),await t(),this.filteredProperties=n},a.addFilter=async function(e,t){const n=this.filteredProperties;this.filteredProperties=null;const r=e=>{this.filteredProperties||(this.filteredProperties=new Set),this.filteredProperties.add(e)};n&&n.forEach(r),e&&e.forEach(r);const s=await t();return this.filteredProperties=n,s},i.create=async function(e,t){return t&&t.useRemoteSchema?i.createRemote(e,t.baseUrl):i.createLocal(e)},i.createLocal=function(e){const t=e&&"webscene"!==e?s.json.definitions[`${e}_schema.json`]:s.json;return new i(s.json.definitions,t,i.getLocalSchemaRequest())},i.createRemote=async function(e,t){const n=await i.getRemoteSchemaRequest(t),r=new i({},null,n),s=(await r.requestSchema(`${e||"webscene"}_schema.json`)).schema;return new i(r.definitions,s,n)},i.getLocalSchemaRequest=function(){return function(e){const t=q(e),n=this.definitions[t];return n?Promise.resolve({schemaId:t,schema:n}):Promise.reject(new r("spec-certification:spec-invalid-local-schema","Schema reference is not a local reference"))}},i.getRemoteSchemaRequest=async function(t){if(!t)return Promise.reject(new r("spec-certification:spec-missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"));const n=i.getLocalSchemaRequest(),s=(await new Promise((function(t,n){e(["../../request"],(function(e){t(o(e))}),n)}))).default;return function(e){return n.call(this,e).catch((()=>s(`${t}/${e}`,{responseType:"json"}).then((t=>(this.definitions[q(e)]=t.data,{schemaId:e,schema:t.data})))))}},n._createClass(i,[{key:"hasFilteredProperties",get:function(){return this.filteredProperties&&this.filteredProperties.size>0}},{key:"filteredPropertiesArray",get:function(){const e=[];return this.filteredProperties.forEach((t=>e.push(t))),e}}]),i}(i.ScanContext);const F=Object.keys(s.json.definitions).map((e=>e.replace(/_schema\.json$/,"")));t.scan=E,t.schemaDefinitions=F,Object.defineProperty(t,"__esModule",{value:!0})}));
