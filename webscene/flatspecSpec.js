// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/Error","../core/promiseUtils","./schema"],function(e,t,n,r,s,a,i){function c(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}function o(e,t){var n={cnt:e.length,refsCnt:0,typesCnt:0,distinctTypes:[],summary:""},r=new Set;for(var s in e){var a=e[s];a.$ref?n.refsCnt++:a.type&&(n.typesCnt++,r.add(a.type))}return r.forEach(function(e){return n.distinctTypes.push(e)}),n.refsCnt===n.cnt?n.summary="refs":2===n.cnt&&n.refsCnt>0&&1===n.distinctTypes.length&&"null"===n.distinctTypes[0]?n.summary="refsAndNull":n.typesCnt===n.cnt?(n.summary="types",n.distinctTypes=n.distinctTypes):n.summary="mix",n}function u(e,t,s,a){return r(this,void 0,void 0,function(){var r,i;return n(this,function(n){switch(n.label){case 0:return r=[],(i=c(e,t),i&&/<\?TYPE\?>/.test(s)?s=s.replace("?TYPE?",i):s.indexOf("<?TYPE?>")&&(s=s.replace("<?TYPE?>","")),a.classPaths&&(a.classPaths[s]=e),a.schemaPath.indexOf(e)>0)?(r.push({path:s,type:"LOOP0!"}),[3,3]):[3,1];case 1:return a.schemaPath.push(e),[4,m(t,s,a)];case 2:r=n.sent(),a.schemaPath.pop(),n.label=3;case 3:return[2,r]}})})}function l(e,t,s){return r(this,void 0,void 0,function(){return n(this,function(n){return[2,s.requestSchema(e.$ref).then(function(e){return u(e.schemaId,e.schema,t,s)})]})})}function h(e){return!(e.schemaPath.length<4)&&"pointCloudLayer_schema.json/layerDefinition_schema.json/drawingInfo_schema.json/renderer_schema.json"===e.schemaPath.slice(e.schemaPath.length-4).join("/")}function p(e){return"renderer_schema.json"===e.schemaPath[e.schemaPath.length-1]}function f(e,t){var n=p(t),r=h(t);return n?e.filter(function(e){var t="pointCloudRenderer_schema.json"===e.$ref;return r===t}):e}function m(e,t,s){return r(this,void 0,void 0,function(){var r,a,i,c,u,h,p,d,y,v,j,P,w,b,g,_,O,T,C,S,E,x,R,q,Y,$,A,I,H,L,N,U,$,k,D,M,z,B,F;return n(this,function(n){switch(n.label){case 0:return r=[],(a=s.filteredProperties,s.filteredProperties=null,"array"!==e.type)?[3,2]:(c=(i=r).concat,[4,m(e.items,t+"[]",s)]);case 1:return r=c.apply(i,[n.sent()]),[3,24];case 2:if(!("properties"in e))return[3,7];u=[];for(h in e.properties)u.push(h);p=0,n.label=3;case 3:return p<u.length?(d=u[p],a&&!a.has(d)?[3,5]:(y=t?t+"."+d:d,j=(v=r).concat,[4,m(e.properties[d],y,s)])):[3,6];case 4:r=j.apply(v,[n.sent()]),n.label=5;case 5:return p++,[3,3];case 6:return[3,24];case 7:if(!("allOf"in e))return[3,9];for(P=null,w=new Set,b=0,g=e.allOf;b<g.length;b++)if("$ref"in(_=g[b])){if(P)throw new Error("Cannot process more than 1 ref in an allOf construct");P=_}else{if(!("properties"in _))throw new Error("allOf construct only allows simple top-level property filters");for(O in _.properties)w.add(O)}return T=s.filteredProperties,s.filteredProperties=w,S=(C=r).concat,[4,l(P,t,s)];case 8:return r=S.apply(C,[n.sent()]),s.filteredProperties=T,[3,24];case 9:if(!("oneOf"in e))return[3,21];if(E=o(e.oneOf,s),"refs"!==E.summary&&"refsAndNull"!==E.summary)return[3,15];x=f(e.oneOf,s),R=0,q=x,n.label=10;case 10:return R<q.length?(Y=q[R],"null"!==Y.type?[3,11]:[3,13]):[3,14];case 11:return $="<?TYPE?>",I=(A=r).concat,[4,m(Y,""+t+$,s)];case 12:r=I.apply(A,[n.sent()]),n.label=13;case 13:return R++,[3,10];case 14:return[3,20];case 15:return"types"!==E.summary?[3,16]:(r.push({path:t,type:E.distinctTypes.join("|")}),[3,20]);case 16:H=[];for(L in e.oneOf)H.push(L);N=0,n.label=17;case 17:return N<H.length?(U=H[N],$=".oneOf["+U+"]",D=(k=r).concat,[4,m(e.oneOf[U],""+t+$,s)]):[3,20];case 18:r=D.apply(k,[n.sent()]),n.label=19;case 19:return N++,[3,17];case 20:return[3,24];case 21:return"$ref"in e?(z=(M=r).concat,[4,l(e,t,s)]):[3,23];case 22:return r=z.apply(M,[n.sent()]),[3,24];case 23:B="unknown",e.type&&(B=Array.isArray(e.type)?e.type.join("|"):e.type.replace(/ /g,"").split(",").join("|")),F={path:t,type:B},e.enum&&(F.enum=e.enum.join("|")),r.push(F),n.label=24;case 24:return s.filteredProperties=a,[2,r]}})})}function d(e){return 0===e.indexOf(b)?e.slice(b.length):e}function y(e){return function(t){var n=d(t),r=e.definitions[n];return r?a.resolve({schemaId:n,schema:r}):a.reject(new s("flatspec-spec:invalid-local-schema","Schema reference is not a local reference"))}}function v(t,i){return r(this,void 0,void 0,function(){var r,c;return n(this,function(n){switch(n.label){case 0:return t?(r=y(i),[4,a.create(function(t){return e(["../request"],t)})]):[2,a.reject(new s("flatspec-spec:missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"))];case 1:return c=n.sent(),[2,function(e){return r(e).catch(function(){return c(t+"/"+e,{responseType:"json"}).then(function(t){return i.definitions[d(e)]=t.data,{schemaId:e,schema:t.data}})})}]}})})}function j(e,t){return r(this,void 0,void 0,function(){var r,s,a;return n(this,function(n){switch(n.label){case 0:return r={schemaRoot:null,definitions:{},schemaPath:[]},t&&t.useRemoteSchema?(s=r,[4,v(t.baseUrl,r)]):[3,3];case 1:return s.requestSchema=n.sent(),a=r,[4,r.requestSchema((e||"webscene")+"_schema.json")];case 2:return a.schemaRoot=n.sent().schema,[2,r];case 3:return r.requestSchema=y(r),r.definitions=i.json.definitions,r.schemaRoot=e?r.definitions[e+"_schema.json"]:i.json,[2,r]}})})}function P(e,t){return r(this,void 0,void 0,function(){var s=this;return n(this,function(a){return[2,j(e,t).then(function(t){return r(s,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return[4,u((e||"webScene")+"_schema.json",t.schemaRoot,"",t)];case 1:return r=n.sent(),r.sort(function(e,t){return e.path.localeCompare(t.path)}),[2,r.filter(function(e,t){return 0===t||r[t-1].path!==e.path})]}})})})]})})}function w(e){var t=e?i.json.definitions[e+"_schema.json"]:i.json,n={definitions:i.json.definitions,schemaRoot:i.json,schemaPath:[],classPaths:{}};return u(e||"webScene",t,"",n),a.resolve(n.classPaths)}Object.defineProperty(t,"__esModule",{value:!0});var b="#/definitions/";t.scan=P,t.collectClassPaths=w});