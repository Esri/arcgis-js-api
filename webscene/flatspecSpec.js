// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.9/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/Error","../core/promiseUtils","./schema"],function(e,t,n,r,s,i,a){function c(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}function o(e,t){var n={cnt:e.length,refsCnt:0,typesCnt:0,distinctTypes:[],summary:""},r=new Set;for(var s in e){var i=e[s];i.$ref?n.refsCnt++:i.type&&(n.typesCnt++,r.add(i.type))}return r.forEach(function(e){return n.distinctTypes.push(e)}),n.refsCnt===n.cnt?n.summary="refs":2===n.cnt&&n.refsCnt>0&&1===n.distinctTypes.length&&"null"===n.distinctTypes[0]?n.summary="refsAndNull":n.typesCnt===n.cnt?(n.summary="types",n.distinctTypes=n.distinctTypes):n.summary="mix",n}function u(e,t,s,i){return r(this,void 0,void 0,function(){var r,a;return n(this,function(n){switch(n.label){case 0:return r=[],(a=c(e,t),a&&/<\?TYPE\?>/.test(s)?s=s.replace("?TYPE?",a):s.indexOf("<?TYPE?>")&&(s=s.replace("<?TYPE?>","")),i.classPaths&&(i.classPaths[s]=e),i.schemaPath.indexOf(e)>0)?(r.push({path:s,type:"LOOP0!"}),[3,3]):[3,1];case 1:return i.schemaPath.push(e),[4,d(t,s,i)];case 2:r=n.sent(),i.schemaPath.pop(),n.label=3;case 3:return[2,r]}})})}function l(e,t,s){return r(this,void 0,void 0,function(){return n(this,function(n){return[2,s.requestSchema(e.$ref).then(function(e){return u(e.schemaId,e.schema,t,s)})]})})}function h(e){return!(e.schemaPath.length<4)&&"pointCloudLayer_schema.json/layerDefinition_schema.json/drawingInfo_schema.json/renderer_schema.json"===e.schemaPath.slice(e.schemaPath.length-4).join("/")}function p(e){return"renderer_schema.json"===e.schemaPath[e.schemaPath.length-1]}function f(e,t){var n=p(t),r=h(t);return n?e.filter(function(e){var t="pointCloudRenderer_schema.json"===e.$ref;return r===t}):e}function m(e){var t=e.slice();return t.sort(),t}function d(e,t,s){return r(this,void 0,void 0,function(){var r,i,a,c,u,h,p,y,v,j,P,w,b,g,_,O,T,C,S,E,x,R,q,Y,$,A,I,H,L,N,U,k,A,D,M,z,B,F,G;return n(this,function(n){switch(n.label){case 0:return r=[],(i=s.filteredProperties,s.filteredProperties=null,"array"!==e.type)?[3,2]:(c=(a=r).concat,[4,d(e.items,t+"[]",s)]);case 1:return r=c.apply(a,[n.sent()]),[3,24];case 2:if(!("properties"in e))return[3,7];u=[];for(h in e.properties)u.push(h);p=0,n.label=3;case 3:return p<u.length?(y=u[p],i&&!i.has(y)?[3,5]:(v=t?t+"."+y:y,P=(j=r).concat,[4,d(e.properties[y],v,s)])):[3,6];case 4:r=P.apply(j,[n.sent()]),n.label=5;case 5:return p++,[3,3];case 6:return[3,24];case 7:if(!("allOf"in e))return[3,9];for(w=null,b=new Set,g=0,_=e.allOf;g<_.length;g++)if("$ref"in(O=_[g])){if(w)throw new Error("Cannot process more than 1 ref in an allOf construct");w=O}else{if(!("properties"in O))throw new Error("allOf construct only allows simple top-level property filters");for(T in O.properties)b.add(T)}return C=s.filteredProperties,s.filteredProperties=b,E=(S=r).concat,[4,l(w,t,s)];case 8:return r=E.apply(S,[n.sent()]),s.filteredProperties=C,[3,24];case 9:if(!("oneOf"in e))return[3,21];if(x=o(e.oneOf,s),"refs"!==x.summary&&"refsAndNull"!==x.summary)return[3,15];R=f(e.oneOf,s),q=0,Y=R,n.label=10;case 10:return q<Y.length?($=Y[q],"null"!==$.type?[3,11]:[3,13]):[3,14];case 11:return A="<?TYPE?>",H=(I=r).concat,[4,d($,""+t+A,s)];case 12:r=H.apply(I,[n.sent()]),n.label=13;case 13:return q++,[3,10];case 14:return[3,20];case 15:return"types"!==x.summary?[3,16]:(r.push({path:t,type:x.distinctTypes.join("|")}),[3,20]);case 16:L=[];for(N in e.oneOf)L.push(N);U=0,n.label=17;case 17:return U<L.length?(k=L[U],A=".oneOf["+k+"]",M=(D=r).concat,[4,d(e.oneOf[k],""+t+A,s)]):[3,20];case 18:r=M.apply(D,[n.sent()]),n.label=19;case 19:return U++,[3,17];case 20:return[3,24];case 21:return"$ref"in e?(B=(z=r).concat,[4,l(e,t,s)]):[3,23];case 22:return r=B.apply(z,[n.sent()]),[3,24];case 23:F="unknown",e.type&&(F=Array.isArray(e.type)?e.type.join("|"):e.type.replace(/ /g,"").split(",").join("|")),G={path:t,type:F},e.enum&&(G.enum=m(e.enum).join("|")),r.push(G),n.label=24;case 24:return s.filteredProperties=i,[2,r]}})})}function y(e){return 0===e.indexOf(g)?e.slice(g.length):e}function v(e){return function(t){var n=y(t),r=e.definitions[n];return r?i.resolve({schemaId:n,schema:r}):i.reject(new s("flatspec-spec:invalid-local-schema","Schema reference is not a local reference"))}}function j(t,a){return r(this,void 0,void 0,function(){var r,c;return n(this,function(n){switch(n.label){case 0:return t?(r=v(a),[4,i.create(function(t){return e(["../request"],t)})]):[2,i.reject(new s("flatspec-spec:missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"))];case 1:return c=n.sent(),[2,function(e){return r(e).catch(function(){return c(t+"/"+e,{responseType:"json"}).then(function(t){return a.definitions[y(e)]=t.data,{schemaId:e,schema:t.data}})})}]}})})}function P(e,t){return r(this,void 0,void 0,function(){var r,s,i;return n(this,function(n){switch(n.label){case 0:return r={schemaRoot:null,definitions:{},schemaPath:[]},t&&t.useRemoteSchema?(s=r,[4,j(t.baseUrl,r)]):[3,3];case 1:return s.requestSchema=n.sent(),i=r,[4,r.requestSchema((e||"webscene")+"_schema.json")];case 2:return i.schemaRoot=n.sent().schema,[2,r];case 3:return r.requestSchema=v(r),r.definitions=a.json.definitions,r.schemaRoot=e?r.definitions[e+"_schema.json"]:a.json,[2,r]}})})}function w(e,t){return r(this,void 0,void 0,function(){var s=this;return n(this,function(i){return[2,P(e,t).then(function(t){return r(s,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return[4,u((e||"webScene")+"_schema.json",t.schemaRoot,"",t)];case 1:return r=n.sent(),r.sort(function(e,t){return e.path.localeCompare(t.path)}),[2,r.filter(function(e,t){return 0===t||r[t-1].path!==e.path})]}})})})]})})}function b(e){var t=e?a.json.definitions[e+"_schema.json"]:a.json,n={definitions:a.json.definitions,schemaRoot:a.json,schemaPath:[],classPaths:{}};return u(e||"webScene",t,"",n),i.resolve(n.classPaths)}Object.defineProperty(t,"__esModule",{value:!0});var g="#/definitions/";t.scan=w,t.collectClassPaths=b});