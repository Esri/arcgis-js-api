// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Error","../../core/promiseUtils","../../portal/schemas/webScene","./utils","@dojo/framework/shim/Promise"],(function(e,t,r,n,i,s,a){"use strict";function o(e){return"array"===e.type?o(e.items)+"[]":e.type}function c(e,t,n,i,s){return r.__awaiter(this,void 0,void 0,(function(){var a,o,c,u,l;return r.__generator(this,(function(r){switch(r.label){case 0:return s.schemaStack.push(e),a=function(e,t){if(t.properties){if("layerType"in t.properties)return t.properties.layerType.enum[0];if("type"in t.properties)return t.properties.type.enum[0]}switch(e){case"multipoint_geometry_schema.json":return"multipoint";case"point_geometry_schema.json":return"point";case"polyline_geometry_schema.json":return"polyline";case"polygon_geometry_schema.json":return"polygon";case"extent_schema.json":return"extent"}}(e,n),i=i?i.replace("<?TYPE?>",a?"<"+a+">":""):null,function(e){return"array"===e.type||!("properties"in e)}(n)?((o=s.currentClass?null:{type:e,name:e,id:e+"--"+t,typeValue:t,properties:[]})&&s.push(null,o),[4,j(n,i,s)]):[3,2];case 1:return r.sent(),s.schemaStack.pop(),[2,o];case 2:return c=function(e,t,r){return r.hasFilteredProperties?e+"--"+t+"--"+r.filteredPropertiesArray.join("/"):e+"--"+t}(e,t,s),(u="drawingInfo_schema.json"!==e&&"layer_schema.json"!==e&&s.seen.get(c))&&i?(s.addProperty({name:i,type:u}),s.schemaStack.pop(),[2,u]):(l={type:e,name:e,id:c,typeValue:t,properties:[]},i&&s.addProperty({name:i,type:l}),s.push(i,l),[4,j(n,"",s)]);case 3:return r.sent(),s.schemaStack.pop(),[2,s.pop()]}}))}))}function u(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,s,a,o,u,l,f,p;return r.__generator(this,(function(h){switch(h.label){case 0:return[4,n.requestSchema(e.$ref)];case 1:if(i=h.sent(),!(s=function(e){if("layerDefinition"===e.title)return null;var t=e.properties&&e.properties.type;if(!t||!t.enum)return null;return t.enum}(i.schema)))return[3,6];a=0,o=s,h.label=2;case 2:return a<o.length?(u=o[a],(l=r.__assign({},i.schema)).properties=r.__assign(r.__assign({},l.properties),{type:{type:"string",enum:[u]}}),f=-1===t.indexOf("<?TYPE?>")?t+"<?TYPE?>":t,[4,c(i.schemaId,u,l,f,n)]):[3,5];case 3:h.sent(),h.label=4;case 4:return a++,[3,2];case 5:return[2,void 0];case 6:return p="layer_schema.json"===i.schemaId&&n.schemaStack.length?n.schemaStack[n.schemaStack.length-1].replace(/_schema\.json/,""):null,[4,c(i.schemaId,p,i.schema,t,n)];case 7:return h.sent(),[2]}}))}))}function l(e){return e.currentClass&&"drawingInfo_schema.json"===e.currentClass.name}Object.defineProperty(t,"__esModule",{value:!0}),t.schemaDefinitions=t.scan=void 0;var f=/raster.*Renderer|vectorFieldRenderer/,p=/(uniqueValueRenderer|classBreaksRenderer|raster.*Renderer|vectorFieldRenderer)/,h=/(rasterUniqueValueRenderer|rasterClassBreaksRenderer)/;function d(e,t,r){if(l(r)){var n=function(e,t){if(!l(e))return!1;var r=e.stack.map((function(e){return e.klass.type})).join("/");return/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(r)&&"renderer"===t}(r,t),i=function(e,t){if(!l(e))return!1;var r=e.stack.map((function(e){return e.klass.type})).join("/");return/.*(imageServiceLayer|tiledImageServiceLayer)_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(r)&&"renderer"===t}(r,t);return e.filter((function(e){if(/uniqueValueFromStyleRenderer_schema\.json$/.test(e.$ref))return!1;if(i)return p.test(e.$ref)&&!h.test(e.$ref);if(f.test(e.$ref))return!1;var t=/pointCloud.*Renderer/.test(e.$ref);return n===t}))}if(function(e){switch(e.schemaStack[e.schemaStack.length-1]){case"operationalLayers_schema.json":case"elevationLayers_schema.json":case"baseMapLayer_schema.json":return!0}return!1}(r)){var s=["kmlLayer","rasterDataElevationLayer","rasterDataLayer"];return e.filter((function(e){return!s.some((function(t){return e.$ref.replace(/.*\//,"")===t+"_schema.json"}))}))}return e}function m(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,j(e.items,t+"[]",n)];case 1:return r.sent(),[2]}}))}))}function _(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,s,a,o,c,u=this;return r.__generator(this,(function(f){switch(f.label){case 0:for(a in i=function(i){var s;return r.__generator(this,(function(a){switch(a.label){case 0:return"webscene_schema.json"!==n.currentClass.name||"tables"!==i&&"mapRangeInfo"!==i&&"widgets"!==i?"baseMap_schema.json"===n.currentClass.name&&"elevationLayers"===i?[2,"continue"]:l(n)&&(s=n.stack.map((function(e){return e.klass.type})).join("/"),/imageServiceLayer|tiledImageServiceLayer/.test(s)&&"transparency"===i)?[2,"continue"]:[4,n.withFilter(i,(function(){return r.__awaiter(u,void 0,void 0,(function(){var s;return r.__generator(this,(function(r){switch(r.label){case 0:return s=t?t+"."+i:i,[4,j(e.properties[i],s,n)];case 1:return r.sent(),[2]}}))}))}))]:[2,"continue"];case 1:return a.sent(),[2]}}))},s=[],e.properties)s.push(a);o=0,f.label=1;case 1:return o<s.length?(c=s[o],[5,i(c)]):[3,4];case 2:f.sent(),f.label=3;case 3:return o++,[3,1];case 4:return[2]}}))}))}function y(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,s,a,o,c;return r.__generator(this,(function(r){switch(r.label){case 0:for(i=null,s=0,a=e.allOf;s<a.length;s++)if("$ref"in(o=a[s])){if(i)throw new Error("Cannot process more than 1 ref in an allOf construct");i=o}else if(!("properties"in o))throw new Error("allOf construct only allows simple top-level property filters");return c=function e(t,r,n){void 0===r&&(r=""),void 0===n&&(n=new Set);for(var i=0,s=t;i<s.length;i++){var a=s[i];if("properties"in a)for(var o in a.properties){var c=a.properties[o],u=r?r+"."+o:o,l=Object.keys(c);if(0===l.length||1===l.length&&"$ref"===l[0])n.add(u);else{if(1!==l.length||"allOf"!==l[0])throw new Error("unexpected allOf filter construct: "+JSON.stringify(c));n.add(u),e(c.allOf,u,n)}}}return n}(e.allOf),[4,n.addFilter(c,(function(){return u(i,t,n)}))];case 1:return r.sent(),[2]}}))}))}function v(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,s,c,u,l,f,p,h,m,_,y;return r.__generator(this,(function(r){switch(r.label){case 0:if("refs"!==(i=function(e){var t={count:e.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},r=new Set;for(var n in e){var i=e[n];i.$ref?t.refsCount++:i.type&&(t.typesCount++,r.add(o(i)))}return r.forEach((function(e){return t.distinctTypes.push(e)})),t.distinctTypes.sort(),t.refsCount===t.count?t.type="refs":2===t.count&&t.refsCount>0&&1===t.distinctTypes.length&&"null"===t.distinctTypes[0]?t.type="refsAndNull":t.typesCount===t.count?(t.type="types",t.distinctTypes=t.distinctTypes):t.type="mix",t}(e.oneOf)).type&&"refsAndNull"!==i.type)return[3,6];s=d(e.oneOf,t,n),c=0,u=s,r.label=1;case 1:return c<u.length?"null"!==(l=u[c]).type?[3,2]:[3,4]:[3,5];case 2:return f=(t||"")+(1!==s.length?"<?TYPE?>":""),[4,j(l,f,n)];case 3:r.sent(),r.label=4;case 4:return c++,[3,1];case 5:return[2];case 6:if("types"===i.type)return n.addProperty({name:t,type:a.sorted(i.distinctTypes).join("|")}),[2];for(h in p=[],e.oneOf)p.push(h);m=0,r.label=7;case 7:return m<p.length?(_=p[m],y=".oneOf["+_+"]",[4,j(e.oneOf[_],""+t+y,n)]):[3,10];case 8:r.sent(),r.label=9;case 9:return m++,[3,7];case 10:return[2]}}))}))}function g(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,u(e,t,n)];case 1:return r.sent(),[2]}}))}))}function w(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,s;return r.__generator(this,(function(r){return i="unknown",e.type&&(i=Array.isArray(e.type)?a.sorted(e.type).join("|"):e.type.replace(/ /g,"").split(",").join("|")),s={name:t,type:i,default:e.default},e.enum&&(s.enum=a.sorted(e.enum).map((function(e){return"string"==typeof e?'"'+e+'"':""+e})).join("|")),n.addProperty(s),[2]}))}))}function j(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return"array"===e.type?[2,m(e,t,n)]:"properties"in e?[2,_(e,t,n)]:"allOf"in e?[2,y(e,t,n)]:"oneOf"in e?[2,v(e,t,n)]:"$ref"in e?[2,g(e,t,n)]:[2,w(e,t,n)]}))}))}function b(e){return 0===e.indexOf("#/definitions/")?e.slice("#/definitions/".length):e}t.scan=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,P.create(e,t)];case 1:return n=r.sent(),[2,c((e||"webscene")+"_schema.json",null,n.schemaRoot,null,n)]}}))}))};var P=function(t){function a(e,r,n){var i=t.call(this)||this;return i.definitions=e,i.schemaRoot=r,i.requestSchema=n,i.filteredProperties=null,i.schemaStack=[],i.requestSchema.bind(i),i}return r.__extends(a,t),Object.defineProperty(a.prototype,"hasFilteredProperties",{get:function(){return this.filteredProperties&&this.filteredProperties.size>0},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"filteredPropertiesArray",{get:function(){var e=[];return this.filteredProperties.forEach((function(t){return e.push(t)})),e},enumerable:!1,configurable:!0}),a.prototype.withFilter=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,s=this;return r.__generator(this,(function(r){switch(r.label){case 0:return this.hasFilteredProperties?this.filteredProperties.has(e)?(n=this.filteredProperties,this.filteredProperties=null,i=function(e){s.filteredProperties||(s.filteredProperties=new Set),s.filteredProperties.add(e)},n.forEach((function(t){var r=t.split(".",2);r.length>1&&r[0]===e&&i(r[1])})),[4,t()]):[2]:[2,t()];case 1:return r.sent(),this.filteredProperties=n,[2]}}))}))},a.prototype.addFilter=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,s,a=this;return r.__generator(this,(function(r){switch(r.label){case 0:return n=this.filteredProperties,this.filteredProperties=null,i=function(e){a.filteredProperties||(a.filteredProperties=new Set),a.filteredProperties.add(e)},n&&n.forEach(i),e&&e.forEach(i),[4,t()];case 1:return s=r.sent(),this.filteredProperties=n,[2,s]}}))}))},a.create=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return t&&t.useRemoteSchema?[2,a.createRemote(e,t.baseUrl)]:[2,a.createLocal(e)]}))}))},a.createLocal=function(e){var t=e&&"webscene"!==e?s.json.definitions[e+"_schema.json"]:s.json;return new a(s.json.definitions,t,a.getLocalSchemaRequest())},a.createRemote=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,a.getRemoteSchemaRequest(t)];case 1:return n=r.sent(),[4,(i=new a({},null,n)).requestSchema((e||"webscene")+"_schema.json")];case 2:return s=r.sent().schema,[2,new a(i.definitions,s,n)]}}))}))},a.getLocalSchemaRequest=function(){return function(e){var t=b(e),r=this.definitions[t];return r?i.resolve({schemaId:t,schema:r}):i.reject(new n("flatspec-spec:invalid-local-schema","Schema reference is not a local reference"))}},a.getRemoteSchemaRequest=function(t){return r.__awaiter(this,void 0,void 0,(function(){var s,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t?(s=a.getLocalSchemaRequest(),[4,new Promise((function(t,r){e(["../../request"],t,r)}))]):[2,i.reject(new n("flatspec-spec:missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"))];case 1:return o=r.sent(),[2,function(e){var r=this;return s.call(this,e).catch((function(){return o(t+"/"+e,{responseType:"json"}).then((function(t){return r.definitions[b(e)]=t.data,{schemaId:e,schema:t.data}}))}))}]}}))}))},a}(a.ScanContext);t.schemaDefinitions=Object.keys(s.json.definitions).map((function(e){return e.replace(/_schema\.json$/,"")}))}));