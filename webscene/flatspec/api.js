// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Basemap","../../Ground","../../WebScene","../../core/compilerUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/extensions/serializableProperty/type","../../layers/GroupLayer","../../layers/KMLLayer","../../layers/mixins/OperationalLayer","./utils"],function(e,t,r,n,a,u,s,p,i,o,y,l,c,f){function d(e){return n(this,void 0,void 0,function(){var t;return r(this,function(r){return t=new f.ScanContext,[2,_(null,{typeName:"json",type:e},t)]})})}function m(e,t,a){return n(this,void 0,void 0,function(){var n;return r(this,function(r){switch(r.label){case 0:switch(n=t.typeName){case"array":return[3,1];case"union":return[3,3];case"json":return[3,5];case"native":return[3,7];case"enum":return[3,9]}return[3,11];case 1:return[4,g(e,t,a)];case 2:return r.sent(),[3,12];case 3:return[4,w(e,t,a)];case 4:return r.sent(),[3,12];case 5:return[4,_(e,t,a)];case 6:return r.sent(),[3,12];case 7:return[4,v(e,t,a)];case 8:return r.sent(),[3,12];case 9:return[4,b(e,t,a)];case 10:return r.sent(),[3,12];case 11:p.neverReached(t),r.label=12;case 12:return[2]}})})}function v(e,t,a){return n(this,void 0,void 0,function(){return r(this,function(r){return a.addProperty({name:e,type:S(t),default:t.default}),[2]})})}function h(e){var t=e.slice();return t.sort(),t}function b(e,t,a){return n(this,void 0,void 0,function(){var n;return r(this,function(r){return n=t.values.slice(),t.nullable&&n.push(null),a.currentClass&&a.currentClass.typeValue&&"type"===e?a.addProperty({name:e,type:"string",enum:'"'+a.currentClass.typeValue+'"'}):a.addProperty({name:e,type:S(t),enum:h(n).map(function(e){return"string"==typeof e?'"'+e+'"':""+e}).join("|"),default:t.default}),[2]})})}function g(e,t,a){return n(this,void 0,void 0,function(){return r(this,function(r){switch(r.label){case 0:return[4,m(e+"[]",t.elementType,a)];case 1:return r.sent(),[2]}})})}function N(e,t){if("json"===e.typeName){var r=e.type.__accessorMetadata__,n=r&&r.properties&&r.properties&&r.properties.type,a=n&&I(n),u=a&&a.type,s=u||n&&n.type;if(s&&Array.isArray(s)&&1===s.length&&"string"==typeof s[0])return u?s[0]:B(n,s[0])}return t}function w(e,t,a){return n(this,void 0,void 0,function(){var n,u,s,p,i,o;return r(this,function(r){switch(r.label){case 0:n=[],u=0,s=t.types,r.label=1;case 1:return u<s.length?(p=s[u],"native"!==p.type.typeName&&t.key?[3,2]:(n.push(p.type),[3,4])):[3,5];case 2:return i=e+"<"+N(p.type,p.value)+">",[4,m(i,p.type,a)];case 3:r.sent(),r.label=4;case 4:return u++,[3,1];case 5:return n.length&&(o=n.map(S),t.nullable&&o.push("null"),o.sort(),a.addProperty({type:o.join("|"),name:e,default:t.default})),[2]}})})}function j(e,t,p){return n(this,void 0,void 0,function(){return r(this,function(r){return e.type===s&&"layers"===t?[2,k("web-scene/operational-layers")]:e.type===a&&"baseLayers"===t?[2,k("web-scene/basemap")]:e.type===u&&"layers"===t?[2,k("web-scene/ground")]:e.type===y&&"layers"===t?[2,k("web-scene/operational-layers",function(e){return e!==y})]:[2,A(p)]})})}function T(e){return e.prototype.declaredClass.replace(/\./g,"/")}function _(e,t,a){return n(this,void 0,void 0,function(){var n,u,s,p,i,o,y,l,c,f,d,v,h,b,g,N;return r(this,function(r){switch(r.label){case 0:if(n=t.type.__accessorMetadata__,u=T(t.type),!(s=n&&n.properties))return e&&a.addProperty({name:e,type:"unknown"}),[2,null];if(p=u,i=null,o=e&&e.match(/<([^>]+)>$/),o&&(p+="--"+o[1],i=o[1]),(y=a.seen.get(p))&&e)return a.addProperty({name:e,type:y}),[2,y];l={type:t.type,name:u,id:p,properties:[]},e&&(a.addProperty({name:e,type:l}),l.typeValue=i),a.push(e,l),c=[];for(f in s)c.push(f);d=0,r.label=1;case 1:return d<c.length?(v=c[d],h=s[v],(b=W(h))&&b.enabled?(g=b.target,"string"!=typeof g&&null!=g?[3,4]:[4,j(t,v,h)]):[3,6]):[3,7];case 2:return N=r.sent(),N?[4,m("string"==typeof g?g:v,N,a)]:[3,6];case 3:return r.sent(),[3,6];case 4:return[4,M(g,a)];case 5:r.sent(),r.label=6;case 6:return d++,[3,1];case 7:return[2,a.pop()]}})})}function M(e,t){return n(this,void 0,void 0,function(){var n,a,u,s,p,i;return r(this,function(r){switch(r.label){case 0:n=[];for(a in e)n.push(a);u=0,r.label=1;case 1:return u<n.length?(s=n[u],p=e[s],i=void 0,i=p.types?L(p.types):R(p.type),i.default=p.default,i=P(i),[4,m(s,i,t)]):[3,4];case 2:r.sent(),r.label=3;case 3:return u++,[3,1];case 4:return[2]}})})}function k(e,t){return n(this,void 0,void 0,function(){var n,a,u,s,p,i,o,y;return r(this,function(r){switch(r.label){case 0:n=c.supportedTypes[e],a={typeName:"union",key:"layerType",types:[]},u=[];for(s in n)u.push(s);p=0,r.label=1;case 1:return p<u.length?(i=u[p],[4,c.typeModuleMap[i]()]):[3,4];case 2:if(!(o=r.sent()))return[3,3];if(t&&!t(o))return[3,3];if(o===l)return[3,3];a.types.push({type:{typeName:"json",type:o},value:i}),r.label=3;case 3:return p++,[3,1];case 4:return 0===a.types.length?[2,null]:(y={typeName:"array",elementType:1===a.types.length?a.types[0].type:a},[2,y])}})})}function S(e){switch(e.typeName){case"array":return S(e.elementType)+"[]";case"union":var t=e.types.map(function(e){return S(e.type)});return e.nullable&&t.push("null"),t.sort(),""+t.join(" | ");case"native":switch(e.type){case Number:return"number";case i.Integer:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string";default:return void p.neverReached(e)}}function C(e){var t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:R(t)};if(t.typeMap){var r=[];for(var n in t.typeMap){var a=t.typeMap[n];r.push({type:R(a),value:H(a)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:r}}}}function O(e){if("json"!==e.typeName)return null;var t=e.type.__accessorMetadata__,r=t&&t.properties&&t.properties.type,n=r&&I(r),a=n&&n.type,u=a||r&&r.type;return u&&Array.isArray(u)&&"string"==typeof u[0]?a||r.type.map(function(e){return B(r,e)}):null}function P(e){if("array"===e.typeName)return e.elementType=P(e.elementType),e;var t=O(e);return t?{typeName:"union",key:"type",types:t.map(function(t){return{value:t,type:e}})}:e}function A(e){var t=I(e);return t.types?L(t.types):!t.type&&e.types?L(e.types):P(J(e))}function L(e){if(Array.isArray(e))return{typeName:"array",elementType:L(e[0])};var t=[];for(var r in e.typeMap){var n=e.typeMap[r];t.push({type:R(n),value:H(n)?null:r})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function x(e){return null!=e&&e.name&&-1!==e.name.indexOf("JSONMapWrite")}function B(e,t){var r=W(e);if(x(r.writer)){var n={value:""};return r.writer(t,n,"value"),n.value}return t}function J(e){var t=I(e),r=W(e),n=t&&t.type,a=R(n||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(a.default=B(e,t.default)),r.allowNull&&(a.nullable=!0),a}function R(e){return e?i.isLongFormType(e)?V(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map(function(e){return{type:R(e),value:null}})}:{typeName:"array",elementType:R(e[0])}:o.isCollection(e)?C(e):H(e)?{typeName:"native",type:e}:G(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function V(e){switch(e.type){case"native":return{typeName:"native",type:e.value};case"array":return{typeName:"array",elementType:R(e.value)};case"one-of":return{typeName:"union",key:null,types:e.values.map(function(e){return{type:V(e),value:null}})};default:return void p.neverReached(e)}}function G(e){var t=e._meta&&e._meta.bases;return!!t&&t.some(function(e){return e&&e.prototype&&("esri.core.JSONSupport"===e.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===e.prototype.declaredClass)})}function H(e){return e===String||e===Boolean||e===Number||e===i.Integer||e===Object}function I(e){if(!e.json)return null;var t=e.json.origins,r=e.json,n=t&&t["web-scene"],a=t&&t["web-document"];return n||a||r||null}function W(e){if(!e.json)return null;var t=e.json.origins,r=e.json.write,n=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return n||a||r||null}Object.defineProperty(t,"__esModule",{value:!0}),t.scan=d});