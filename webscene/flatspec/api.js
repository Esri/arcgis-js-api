// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Basemap","../../Ground","../../WebScene","../../core/compilerUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/extensions/serializableProperty/type","../../layers/GroupLayer","../../layers/KMLLayer","../../layers/mixins/operationalLayerModuleMap","../../layers/mixins/operationalLayers","../../layers/support/Sublayer","../../layers/support/source/DataLayerSource","../../layers/support/source/JoinTableDataSource","../../layers/support/source/MapLayerSource","./utils"],(function(e,t,r,n,a,u,s,i,o,p,y,l,c,f,d,v,m,h){"use strict";function _(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:switch(t.typeName){case"array":return[3,1];case"union":return[3,3];case"json":return[3,5];case"native":return[3,7];case"enum":return[3,9]}return[3,11];case 1:return[4,w(e,t,n)];case 2:return r.sent(),[3,12];case 3:return[4,N(e,t,n)];case 4:return r.sent(),[3,12];case 5:return[4,j(e,t,n)];case 6:return r.sent(),[3,12];case 7:return[4,b(e,t,n)];case 8:return r.sent(),[3,12];case 9:return[4,g(e,t,n)];case 10:return r.sent(),[3,12];case 11:s.neverReached(t),r.label=12;case 12:return[2]}}))}))}function b(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return n.addProperty({name:e,type:L(t),default:t.default}),[2]}))}))}function g(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var a;return r.__generator(this,(function(r){var u,s;return a=t.values.slice(),t.nullable&&a.push(null),n.currentClass&&n.currentClass.typeValue&&"type"===e?n.addProperty({name:e,type:"string",enum:'"'+n.currentClass.typeValue+'"'}):n.addProperty({name:e,type:L(t),enum:(u=a,s=u.slice(),s.sort(),s).map((function(e){return"string"==typeof e?'"'+e+'"':""+e})).join("|"),default:t.default}),[2]}))}))}function w(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,_(e+"[]",t.elementType,n)];case 1:return r.sent(),[2]}}))}))}function N(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var a,u,s,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:a=[],u=0,s=t.types,r.label=1;case 1:return u<s.length?"native"!==(i=s[u]).type.typeName&&t.key?[3,2]:(a.push(i.type),[3,4]):[3,5];case 2:return[4,_(e+"<"+function(e,t){if("json"===e.typeName){var r=e.type.__accessorMetadata__,n=r&&r.properties&&r.properties&&r.properties.type,a=n&&D(n),u=a&&a.type,s=u||n&&n.type;if(s&&Array.isArray(s)&&1===s.length&&"string"==typeof s[0])return u?s[0]:A(n,s[0])}return t}(i.type,i.value)+">",i.type,n)];case 3:r.sent(),r.label=4;case 4:return u++,[3,1];case 5:return a.length&&(o=a.map(L),t.nullable&&o.push("null"),o.sort(),n.addProperty({type:o.join("|"),name:e,default:t.default})),[2]}}))}))}function S(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return e.type===u&&"layers"===t?[2,k("web-scene/operational-layers")]:e.type!==n||"baseLayers"!==t&&"baseMapLayers"!==t?e.type===n&&"elevationLayers"===t?[2,k("web-scene/ground")]:e.type===a&&"layers"===t?[2,k("web-scene/ground")]:e.type===p&&"layers"===t?[2,k("web-scene/operational-layers",(function(e){return e!==p}))]:e.type!==v.JoinTableDataSource||"leftTableSource"!==t&&"rightTableSource"!==t?[2,null]:[2,O({key:"type",base:null,typeMap:{"data-layer":d.DataLayerSource,"map-layer":m.MapLayerSource}})]:[2,k("web-scene/basemap")]}))}))}function T(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var a;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,S(e,t)];case 1:return(a=r.sent())?[2,a]:[2,C(n)]}}))}))}function j(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var a,u,s,i,o,p,y,l,c,d,v,m,h,b,g,w,N,S;return r.__generator(this,(function(r){switch(r.label){case 0:if(a=t.type.__accessorMetadata__,j=t.type,u=j.prototype.declaredClass.replace(/\./g,"/"),!(s=a&&a.properties))return e&&n.addProperty({name:e,type:"unknown"}),[2,null];if(i=u,o=null,(p=e&&e.match(/<([^>]+)>$/))&&(i+="--"+p[1],o=p[1]),t.type===f&&(i+="--"+n.currentClass.name,o=n.currentClass.name),(y=n.seen.get(i))&&e)return n.addProperty({name:e,type:y}),[2,y];for(d in l={type:t.type,name:u,id:i,properties:[]},e&&(n.addProperty({name:e,type:l}),l.typeValue=o),n.push(e,l),c=[],s)c.push(d);v=0,r.label=1;case 1:return v<c.length?(m=c[v],h=s[m],(b=B(h))&&b.enabled?t.type===f&&(g=n.stack[n.stack.length-2],w="esri/layers/TileLayer"!==g.klass.name,f.test.isSublayerStructureOverridePolicy(b.overridePolicy)&&!w)?[3,6]:"string"!=typeof(N=b.target)&&null!=N?[3,4]:[4,T(t,m,h)]:[3,6]):[3,7];case 2:return(S=r.sent())?[4,_("string"==typeof N?N:m,S,n)]:[3,6];case 3:return r.sent(),[3,6];case 4:return[4,M(t,N,n)];case 5:r.sent(),r.label=6;case 6:return v++,[3,1];case 7:return[2,n.pop()]}var j}))}))}function M(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var a,u,s,i,o,p;return r.__generator(this,(function(r){switch(r.label){case 0:for(u in a=[],t)a.push(u);s=0,r.label=1;case 1:return s<a.length?(i=a[s],[4,S(e,i)]):[3,5];case 2:return(o=r.sent())||(p=t[i],(o=p.types?O(p.types):x(p.type)).default=p.default,o=P(o)),[4,_(i,o,n)];case 3:r.sent(),r.label=4;case 4:return s++,[3,1];case 5:return[2]}}))}))}function k(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,a,u,s,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:for(u in n={typeName:"union",key:"layerType",types:[]},a=[],c.supportedTypes[e])a.push(u);s=0,r.label=1;case 1:return s<a.length?(i=a[s],"web-scene/operational-layers"===e&&"ArcGISTiledElevationServiceLayer"===i?[3,3]:[4,l.typeModuleMap[i]()]):[3,4];case 2:if(!(o=r.sent()))return[3,3];if(t&&!t(o))return[3,3];if(o===y)return[3,3];n.types.push({type:{typeName:"json",type:o},value:i}),r.label=3;case 3:return s++,[3,1];case 4:return 0===n.types.length?[2,null]:[2,{typeName:"array",elementType:1===n.types.length?n.types[0].type:n}]}}))}))}function L(e){switch(e.typeName){case"array":return L(e.elementType)+"[]";case"union":var t=e.types.map((function(e){return L(e.type)}));return e.nullable&&t.push("null"),t.sort(),""+t.join(" | ");case"native":switch(e.type){case Number:return"number";case i.Integer:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string";default:return void s.neverReached(e)}}function P(e){if("array"===e.typeName)return e.elementType=P(e.elementType),e;var t=function(e){if("json"!==e.typeName)return null;var t=e.type.__accessorMetadata__,r=t&&t.properties&&t.properties.type,n=r&&D(r),a=n&&n.type,u=a||r&&r.type;return u&&Array.isArray(u)&&"string"==typeof u[0]?a||r.type.map((function(e){return A(r,e)})):null}(e);return t?{typeName:"union",key:"type",types:t.map((function(t){return{value:t,type:e}}))}:e}function C(e){var t=D(e);return t.types?O(t.types):!t.type&&e.types?O(e.types):P(function(e){var t=D(e),r=B(e),n=x(t&&t.type||e.type);t&&void 0!==t.default&&"function"!=typeof t.default&&(n.default=A(e,t.default));r.allowNull&&(n.nullable=!0);return n}(e))}function O(e){if(Array.isArray(e))return{typeName:"array",elementType:O(e[0])};var t=[];for(var r in e.typeMap){var n=e.typeMap[r];t.push({type:x(n),value:J(n)?null:r})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function A(e,t){var r,n=B(e);if(null!=(r=n.writer)&&r.isJSONMapWriter){var a={value:""};return n.writer(t,a,"value"),a.value}return t}function x(e){return e?i.isLongFormType(e)?function e(t){switch(t.type){case"native":return{typeName:"native",type:t.value};case"array":return{typeName:"array",elementType:x(t.value)};case"one-of":return{typeName:"union",key:null,types:t.values.map((function(t){return{type:e(t),value:null}}))};default:return void s.neverReached(t)}}(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map((function(e){return{type:x(e),value:null}}))}:{typeName:"array",elementType:x(e[0])}:o.isCollection(e)?function(e){var t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:x(t)};if(t.typeMap){var r=[];for(var n in t.typeMap){var a=t.typeMap[n];r.push({type:x(a),value:J(a)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:r}}}}(e):J(e)?{typeName:"native",type:e}:function(e){var t=e;for(;t;){if(t.prototype&&("esri.core.JSONSupport"===t.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===t.prototype.declaredClass))return!0;t=Object.getPrototypeOf(t)}return!1}(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function J(e){return e===String||e===Boolean||e===Number||e===i.Integer||e===Object}function D(e){if(!e.json)return null;var t=e.json.origins,r=e.json,n=t&&t["web-scene"],a=t&&t["web-document"];return n||a||r||null}function B(e){if(!e.json)return null;var t=e.json.origins,r=e.json.write,n=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return n||a||r||null}Object.defineProperty(t,"__esModule",{value:!0}),t.scan=void 0,t.scan=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){return t=new h.ScanContext,[2,j(null,{typeName:"json",type:e},t)]}))}))}}));