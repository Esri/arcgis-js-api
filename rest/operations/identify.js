/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../core/sql","../../geometry/support/jsonUtils","../../geometry/support/scaleUtils","../../layers/support/floorFilterUtils","../../layers/support/sublayerUtils"],(function(e,t,r,i,n,s,l){"use strict";const o=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function a(e,r){const{dpi:n,gdbVersion:s,geometry:l,geometryPrecision:a,height:f,layerOption:p,mapExtent:c,maxAllowableOffset:u,returnFieldName:m,returnGeometry:d,returnUnformattedValues:g,returnZ:x,spatialReference:S,timeExtent:b,tolerance:O,width:E}=e.toJSON(),{dynamicLayers:h,layerDefs:N,layerIds:J}=y(e),R=r&&t.isSome(r.geometry)?r.geometry:null,w={geometryPrecision:a,maxAllowableOffset:u,returnFieldName:m,returnGeometry:d,returnUnformattedValues:g,returnZ:x,tolerance:O},I=R&&R.toJSON()||l;if(w.imageDisplay=`${E},${f},${n}`,s&&(w.gdbVersion=s),I&&(delete I.spatialReference,w.geometry=JSON.stringify(I),w.geometryType=i.getJsonType(I)),S?w.sr=S.wkid||JSON.stringify(S):I&&I.spatialReference?w.sr=o(I):c&&c.spatialReference&&(w.sr=o(c)),w.time=b?[b.start,b.end].join(","):null,c){const{xmin:e,ymin:t,xmax:r,ymax:i}=c;w.mapExtent=`${e},${t},${r},${i}`}return N&&(w.layerDefs=N),h&&!N&&(w.dynamicLayers=h),w.layers="popup"===p?"visible":p,J&&!h&&(w.layers+=`:${J.join(",")}`),w}function y(e){const{mapExtent:r,floors:i,width:o,sublayers:a,layerIds:y,layerOption:p,gdbVersion:c}=e,u=a?.find((e=>null!=e.layer))?.layer?.serviceSublayers,m="popup"===p,d={},g={extent:r,width:o,spatialReference:r?.spatialReference},x=n.getScale(g),S=[],b=e=>{const t=0===x,r=0===e.minScale||x<=e.minScale,i=0===e.maxScale||x>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(b);else{if(!1===y?.includes(e.id)||m&&(!e.popupTemplate||!e.popupEnabled))return;S.unshift(e)}};if(a?.forEach(b),a&&!S.length)d.layerIds=[];else{const e=l.isExportDynamic(S,u,c),r=S.map((e=>{const t=s.getLayerFloorFilterClause(i,e);return e.toExportImageJSON(t)}));if(e)d.dynamicLayers=JSON.stringify(r);else{if(a){let e=S.map((({id:e})=>e));y&&(e=e.filter((e=>y.includes(e)))),d.layerIds=e}else y?.length&&(d.layerIds=y);const e=f(i,S);if(t.isSome(e)&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(d.layerDefs=JSON.stringify(t))}}}return d}function f(e,i){const n=!!e?.length,l=i.filter((e=>null!=e.definitionExpression||n&&null!=e.floorInfo));return l.length?l.map((i=>{const n=s.getLayerFloorFilterClause(e,i),l=r.sqlAnd(n,i.definitionExpression);return{id:i.id,definitionExpression:t.unwrapOr(l,void 0)}})):null}e.identifyToIdentifyRESTParameters=a,e.toDynamicLayersJSON=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
