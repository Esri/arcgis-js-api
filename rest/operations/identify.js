/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../core/sql","../../geometry/support/jsonUtils","../../geometry/support/scaleUtils","../../layers/support/floorFilterUtils","../../layers/support/sublayerUtils"],(function(e,t,r,i,n,s,l){"use strict";const o=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function a(e,r){const{dpi:n,gdbVersion:s,geometry:l,geometryPrecision:a,height:f,layerOption:p,mapExtent:c,maxAllowableOffset:u,returnFieldName:m,returnGeometry:d,returnUnformattedValues:g,returnZ:x,spatialReference:S,timeExtent:b,tolerance:E,width:O}=e.toJSON(),{dynamicLayers:h,layerDefs:N,layerIds:J}=y(e),R=r&&t.isSome(r.geometry)?r.geometry:null,I={geometryPrecision:a,maxAllowableOffset:u,returnFieldName:m,returnGeometry:d,returnUnformattedValues:g,returnZ:x,tolerance:E},$=R&&R.toJSON()||l;if(I.imageDisplay=`${O},${f},${n}`,s&&(I.gdbVersion=s),$&&(delete $.spatialReference,I.geometry=JSON.stringify($),I.geometryType=i.getJsonType($)),S?I.sr=S.wkid||JSON.stringify(S):$&&$.spatialReference?I.sr=o($):c&&c.spatialReference&&(I.sr=o(c)),I.time=b?[b.start,b.end].join(","):null,c){const{xmin:e,ymin:t,xmax:r,ymax:i}=c;I.mapExtent=`${e},${t},${r},${i}`}return N&&(I.layerDefs=N),h&&!N&&(I.dynamicLayers=h),I.layers="popup"===p?"visible":p,J&&!h&&(I.layers+=`:${J.join(",")}`),I}function y(e){const{mapExtent:r,floors:i,width:o,sublayers:a,layerIds:y,layerOption:p,gdbVersion:c}=e,u=a?.find((e=>null!=e.layer))?.layer?.serviceSublayers,m="popup"===p,d={},g={extent:r,width:o,spatialReference:r?.spatialReference},x=n.getScale(g),S=[],b=e=>{const t=0===x,r=0===e.minScale||x<=e.minScale,i=0===e.maxScale||x>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(b);else{if(!1===y?.includes(e.id)||m&&(!e.popupTemplate||!e.popupEnabled))return;S.unshift(e)}};if(a?.forEach(b),a&&!S.length)d.layerIds=[];else{const e=l.isExportDynamic(S,u,c),r=S.map((e=>{const t=s.getLayerFloorFilterClause(i,e);return e.toExportImageJSON(t)}));if(e)d.dynamicLayers=JSON.stringify(r);else{if(a){let e=S.map((({id:e})=>e));y&&(e=e.filter((e=>y.includes(e)))),d.layerIds=e}else y?.length&&(d.layerIds=y);const e=f(i,S);if(t.isSome(e)&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(d.layerDefs=JSON.stringify(t))}}}return d}function f(e,t){const i=!!e?.length,n=t.filter((e=>null!=e.definitionExpression||i&&null!=e.floorInfo));return n.length?n.map((t=>{const i=s.getLayerFloorFilterClause(e,t),n=r.sqlAnd(i,t.definitionExpression);return{id:t.id,definitionExpression:n}})):null}e.identifyToIdentifyRESTParameters=a,e.toDynamicLayersJSON=y,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
