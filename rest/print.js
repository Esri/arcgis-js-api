/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../config","../kernel","../request","../core/Error","../core/jsonMap","../core/maybe","../core/screenUtils","../core/urlUtils","../geometry/Polygon","../layers/support/fieldUtils","../renderers/visualVariables/support/visualVariableUtils","./geoprocessor/execute","./geoprocessor/submitJob","./support/fileFormat","./support/layoutTemplate","./support/printTaskUtils","./support/PrintTemplate","../support/apiKeyUtils","../views/support/floorFilterUtils"],(function(e,t,r,i,n,a,l,o,s,u,y,c,p,d,f,m,g,h,b,S,x){"use strict";const w={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},v=new l.JSONMap({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),L=new l.JSONMap({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),T=new Map;function I(e,t,r){return D.apply(this,arguments)}function D(){return(D=t._asyncToGenerator((function*(e,t,r){const i=N(e);let a=T.get(i);return Promise.resolve().then((()=>a?{data:a.gpMetadata}:(a={gpServerUrl:i,is11xService:!1,legendLayerNameMap:{},legendLayers:[]},n(i,{query:{f:"json"}})))).then((e=>(a.gpMetadata=e.data,a.cimVersion=a.gpMetadata.cimVersion,a.is11xService=!!a.cimVersion,T.set(i,a),E(t,a)))).then((i=>{const n=Se(a);let l;const o=e=>"sync"===n?e.results&&e.results[0]&&e.results[0].value:l.fetchResultData("Output_File",null,r).then((e=>e.value));return"async"===n?f.submitJob(e,i,null,r).then((e=>(l=e,e.waitForJobCompletion({interval:t.updateDelay}).then(o)))):d.execute(e,i,null,r).then(o)}))}))).apply(this,arguments)}function M(e){return V.apply(this,arguments)}function V(){return(V=t._asyncToGenerator((function*(e){const t=N(e);return Se(T.get(t))}))).apply(this,arguments)}function E(e,t){return O.apply(this,arguments)}function O(){return(O=t._asyncToGenerator((function*(e,t){t=t||{is11xService:!1,legendLayerNameMap:{},legendLayers:[]};const r=e.template||new b;null==r.showLabels&&(r.showLabels=!0);const i=r.exportOptions;let n;const l=g.toJSON(r.layout);if(i){if(n={dpi:i.dpi},"map_only"===l.toLowerCase()||""===l){const e=i.width,t=i.height;n.outputSize=[e,t]}}const o=r.layoutOptions;let s;if(o){let e,t;"Miles"===o.scalebarUnit||"Kilometers"===o.scalebarUnit?(e="Kilometers",t="Miles"):"Meters"!==o.scalebarUnit&&"Feet"!==o.scalebarUnit||(e="Meters",t="Feet"),s={titleText:o.titleText,authorText:o.authorText,copyrightText:o.copyrightText,customTextElements:o.customTextElements,scaleBarOptions:{metricUnit:v.toJSON(e),metricLabel:w[e],nonMetricUnit:v.toJSON(t),nonMetricLabel:w[t]}}}let u=null;null!=o&&o.legendLayers&&(u=o.legendLayers.map((e=>{t.legendLayerNameMap[e.layerId]=e.title;const r={id:e.layerId};return e.subLayerIds&&(r.subLayerIds=e.subLayerIds),r})));const y=yield P(e,r,t);if(y.operationalLayers){const e=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),r=/[\u0600-\u06FF]/,i=t=>{const i=t.text,n=t.font,a=n&&n.family&&n.family.toLowerCase();i&&n&&("arial"===a||"arial unicode ms"===a)&&(n.family=e.test(i)?"Arial Unicode MS":"Arial","normal"!==n.style&&r.test(i)&&(n.family="Arial Unicode MS"))},n=()=>{throw new a("print-task:cim-symbol-unsupported","CIMSymbol is not supported by a print service published from ArcMap")};y.operationalLayers.forEach((e=>{var r,a,l;null!=(r=e.featureCollection)&&r.layers?e.featureCollection.layers.forEach((e=>{var r,a,l,o;if(null!=(r=e.layerDefinition)&&null!=(a=r.drawingInfo)&&null!=(l=a.renderer)&&l.symbol){const r=e.layerDefinition.drawingInfo.renderer;"esriTS"===r.symbol.type?i(r.symbol):"CIMSymbolReference"!==r.symbol.type||t.is11xService||n()}null!=(o=e.featureSet)&&o.features&&e.featureSet.features.forEach((e=>{e.symbol&&("esriTS"===e.symbol.type?i(e.symbol):"CIMSymbolReference"!==e.symbol.type||t.is11xService||n())}))})):!t.is11xService&&null!=(a=e.layerDefinition)&&null!=(l=a.drawingInfo)&&l.renderer&&JSON.stringify(e.layerDefinition.drawingInfo.renderer).includes('"type":"CIMSymbolReference"')&&n()}))}e.outSpatialReference&&(y.mapOptions.spatialReference=e.outSpatialReference.toJSON()),Object.assign(y,{exportOptions:n,layoutOptions:s||{}}),Object.assign(y.layoutOptions,{legendOptions:{operationalLayers:null!=u?u:t.legendLayers.slice()}}),t.legendLayers.length=0,T.set(t.gpServerUrl,t);const c={Web_Map_as_JSON:JSON.stringify(y),Format:m.toJSON(r.format),Layout_Template:l};return e.extraParameters&&Object.assign(c,e.extraParameters),c}))).apply(this,arguments)}function P(e,t,r){return F.apply(this,arguments)}function F(){return(F=t._asyncToGenerator((function*(e,t,r){const i=e.view;let n=i.spatialReference;const a={operationalLayers:yield J(i,t,r)};let l=r.ssExtent||e.extent||i.extent;if(n&&n.isWrappable&&(l=l.clone()._normalize(!0),n=l.spatialReference),a.mapOptions={extent:l&&l.toJSON(),spatialReference:n&&n.toJSON(),showAttribution:t.attributionVisible},r.ssExtent=null,i.background&&(a.background=i.background.toJSON()),i.rotation&&(a.mapOptions.rotation=-i.rotation),t.scalePreserved&&(a.mapOptions.scale=t.outScale||i.scale),o.isSome(i.timeExtent)){const e=o.isSome(i.timeExtent.start)?i.timeExtent.start.getTime():null,t=o.isSome(i.timeExtent.end)?i.timeExtent.end.getTime():null;a.mapOptions.time=[e,t]}return a}))).apply(this,arguments)}function N(e){let t=e;const r=t.lastIndexOf("/GPServer/");return r>0&&(t=t.slice(0,r+9)),t}function J(e,t,r){return R.apply(this,arguments)}function R(){return(R=t._asyncToGenerator((function*(e,t,r){const i=[],n={layerView:null,printTemplate:t,view:e};let a=0;t.scalePreserved&&(a=t.outScale||e.scale);const l=h.getVisibleLayerViews(e,a);for(const o of l){const e=o.layer;if(!e.loaded||h.isGroupLayer(e))continue;let t;n.layerView=o,t=h.isScreenshotRequired(o)?yield te(e,n,r):h.isBingMapsLayer(e)?_(e):h.isCSVLayer(e)?yield C(e,n,r):h.isFeatureLayer(e)?yield k(e,n,r):h.isGeoJSONLayer(e)?yield K(e,n,r):h.isGraphicsLayer(e)?yield B(e,n,r):h.isImageryLayer(e)?q(e,r):h.isImageryTileLayer(e)?j(e,r):h.isKMLLayer(e)?yield Q(e,n,r):h.isMapImageLayer(e)?X(e,n,r):h.isMapNotesLayer(e)?yield Y(n,r):h.isOpenStreetMapLayer(e)?ee():h.isStreamLayer(e)?yield ie(e,n,r):h.isTileLayer(e)?ae(e):h.isVectorTileLayer(e)?yield le(e,n,r):h.isWebTileLayer(e)?se(e):h.isWMSLayer(e)?ue(e):h.isWMTSLayer(e)?ye(e):yield te(e,n,r),t&&(Array.isArray(t)?i.push(...t):(t.id=e.id,t.title=r.legendLayerNameMap[e.id]||e.title,t.opacity=e.opacity,t.minScale=e.minScale||0,t.maxScale=e.maxScale||0,h.isBlendLayer(e)&&e.blendMode&&"normal"!==e.blendMode&&(t.blendMode=e.blendMode),i.push(t)))}if(a&&i.forEach((e=>{e.minScale=0,e.maxScale=0})),e.graphics&&e.graphics.length){const n=yield G(null,e.graphics,t,r);n&&i.push(n)}return i}))).apply(this,arguments)}function _(e){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}}function C(e,t,r){return U.apply(this,arguments)}function U(){return(U=t._asyncToGenerator((function*(e,t,r){e.legendEnabled&&r.legendLayers.push({id:e.id});const i=t.layerView,n=t.printTemplate;let a;if(!r.is11xService||i.filter){return G(e,yield he(i),n,r)}return a={type:"CSV"},e.write(a,{origin:"web-map"}),delete a.popupInfo,delete a.layerType,a.showLabels=n.showLabels&&e.labelsVisible,a}))).apply(this,arguments)}function G(e,t,r,i){return A.apply(this,arguments)}function A(){return(A=t._asyncToGenerator((function*(e,t,r,i){let n;const a=h.createPolygonLayer(),l=h.createPolylineLayer(),o=h.createPointLayer(),s=h.createMultipointLayer(),u=h.createPointLayer();if(u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,e){if("esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass?a.layerDefinition.name=l.layerDefinition.name=o.layerDefinition.name=s.layerDefinition.name=i.legendLayerNameMap[e.id]||e.get("arcgisProps.title")||e.title:"esri.layers.GraphicsLayer"===e.declaredClass&&(t=e.graphics.items),e.renderer){const t=e.renderer.toJSON();a.layerDefinition.drawingInfo.renderer=t,l.layerDefinition.drawingInfo.renderer=t,o.layerDefinition.drawingInfo.renderer=t,s.layerDefinition.drawingInfo.renderer=t}if(r.showLabels&&e.labelsVisible&&"function"==typeof e.write){var p,d;const t=null==(p=e.write({},{origin:"web-map"}).layerDefinition)||null==(d=p.drawingInfo)?void 0:d.labelingInfo;t&&(n=!0,a.layerDefinition.drawingInfo.labelingInfo=t,l.layerDefinition.drawingInfo.labelingInfo=t,o.layerDefinition.drawingInfo.labelingInfo=t,s.layerDefinition.drawingInfo.labelingInfo=t)}}let f;null!=e&&e.renderer||n||(delete a.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo);const m=null==e?void 0:e.fieldsIndex,g=null==e?void 0:e.renderer;if(m){const t=new Set;n&&(yield c.collectLabelingFields(t,e)),g&&"function"==typeof g.collectRequiredFields&&(yield g.collectRequiredFields(t,m)),f=Array.from(t);const r=m.fields.map((e=>e.toJSON()));a.layerDefinition.fields=r,l.layerDefinition.fields=r,o.layerDefinition.fields=r,s.layerDefinition.fields=r}const b=t&&t.length;let S;for(let c=0;c<b;c++){var x;const n=t[c]||t.getItemAt(c);if(!1===n.visible||!n.geometry)continue;if(S=n.toJSON(),S.hasOwnProperty("popupTemplate")&&delete S.popupTemplate,S.geometry&&S.geometry.z&&delete S.geometry.z,S.symbol&&S.symbol.outline&&"esriCLS"===S.symbol.outline.type&&!i.is11xService)continue;!i.is11xService&&S.symbol&&S.symbol.outline&&S.symbol.outline.color&&S.symbol.outline.color[3]&&(S.symbol.outline.color[3]=255);const p=e&&e.renderer&&("valueExpression"in e.renderer&&e.renderer.valueExpression||"hasVisualVariables"in e.renderer&&e.renderer.hasVisualVariables());if(!S.symbol&&e&&e.renderer&&p&&!i.is11xService){const t=e.renderer,r=yield t.getSymbolAsync(n);if(!r)continue;S.symbol=r.toJSON(),"hasVisualVariables"in t&&t.hasVisualVariables()&&h.applyVisualVariables(S.symbol,{renderer:t,graphic:n,symbol:r})}if(S.symbol&&(S.symbol.angle||delete S.symbol.angle,xe(S.symbol)?S.symbol=yield de(S.symbol,i):S.symbol.text&&delete S.attributes),(!r||!r.forceFeatureAttributes)&&null!=(x=f)&&x.length){const e={};f.forEach((t=>{S.attributes&&S.attributes.hasOwnProperty(t)&&(e[t]=S.attributes[t])})),S.attributes=e}"polygon"===n.geometry.type?a.featureSet.features.push(S):"polyline"===n.geometry.type?l.featureSet.features.push(S):"point"===n.geometry.type?S.symbol&&S.symbol.text?u.featureSet.features.push(S):o.featureSet.features.push(S):"multipoint"===n.geometry.type?s.featureSet.features.push(S):"extent"===n.geometry.type&&(S.geometry=y.fromExtent(n.geometry).toJSON(),a.featureSet.features.push(S))}const w=[a,l,s,o,u].filter((e=>e.featureSet.features.length>0));for(const y of w){const e=y.featureSet.features.every((e=>e.symbol));!e||r&&r.forceFeatureAttributes||y.featureSet.features.forEach((e=>{delete e.attributes})),e&&delete y.layerDefinition.drawingInfo,y.layerDefinition.drawingInfo&&y.layerDefinition.drawingInfo.renderer&&(yield me(y.layerDefinition.drawingInfo.renderer,i))}return w.length?{featureCollection:{layers:w},showLabels:n}:null}))).apply(this,arguments)}function k(e,t,r){return z.apply(this,arguments)}function z(){return(z=t._asyncToGenerator((function*(e,t,r){var i,n;let a;const l=e.renderer,o=parseFloat(r.cimVersion);if(e.featureReduction&&(!r.is11xService||o<2.9)||"dot-density"===(null==l?void 0:l.type)&&(!r.is11xService||o<2.6))return te(e,t,r);e.legendEnabled&&r.legendLayers.push({id:e.id});const s=t.layerView,{printTemplate:u,view:y}=t,c=l&&("valueExpression"in l&&l.valueExpression||"hasVisualVariables"in l&&l.hasVisualVariables()),d="feature-layer"!==(null==(i=e.source)?void 0:i.type)&&"ogc-feature"!==(null==(n=e.source)?void 0:n.type);if(!r.is11xService&&c||s.filter||d||!l||"field"in l&&null!=l.field&&("string"!=typeof l.field||!e.getField(l.field))){const t=yield he(s);a=yield G(e,t,u,r)}else{var f,m;if(a={id:(g=e.write()).id,title:g.title,opacity:g.opacity,minScale:g.minScale,maxScale:g.maxScale,url:g.url,layerType:g.layerType,customParameters:g.customParameters,layerDefinition:g.layerDefinition},a.showLabels=u.showLabels&&e.labelsVisible,ce(a,e),null!=(f=a.layerDefinition)&&null!=(m=f.drawingInfo)&&m.renderer&&(delete a.layerDefinition.minScale,delete a.layerDefinition.maxScale,yield me(a.layerDefinition.drawingInfo.renderer,r),"visualVariables"in l&&l.visualVariables&&l.visualVariables[0])){const e=l.visualVariables[0];if("size"===e.type&&e.maxSize&&"number"!=typeof e.maxSize&&e.minSize&&"number"!=typeof e.minSize){const t=p.getSizeRangeAtScale(e,y.scale);a.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=t.minSize,a.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=t.maxSize}}const t=x.getFloorFilterClause(s);t&&(a.layerDefinition||(a.layerDefinition={}),a.layerDefinition.definitionExpression=a.layerDefinition.definitionExpression?`(${a.layerDefinition.definitionExpression}) AND (${t})`:t)}var g;return a}))).apply(this,arguments)}function K(e,t,r){return $.apply(this,arguments)}function $(){return($=t._asyncToGenerator((function*(e,{layerView:t,printTemplate:r},i){e.legendEnabled&&i.legendLayers.push({id:e.id});return G(e,yield he(t),r,i)}))).apply(this,arguments)}function B(e,t,r){return W.apply(this,arguments)}function W(){return(W=t._asyncToGenerator((function*(e,{printTemplate:t},r){return G(e,null,t,r)}))).apply(this,arguments)}function q(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const r={layerType:(i=e.write()).layerType,customParameters:i.customParameters};var i;if(r.bandIds=e.bandIds,r.compressionQuality=e.compressionQuality,r.format=e.format,r.interpolation=e.interpolation,(e.mosaicRule||e.definitionExpression)&&(r.mosaicRule=e.exportImageServiceParameters.mosaicRule.toJSON()),e.renderingRule||e.renderer)if(t.is11xService)e.renderingRule&&(r.renderingRule=e.renderingRule.toJSON()),e.renderer&&(r.layerDefinition=r.layerDefinition||{},r.layerDefinition.drawingInfo=r.layerDefinition.drawingInfo||{},r.layerDefinition.drawingInfo.renderer=e.renderer.toJSON());else{const t=e.exportImageServiceParameters.combineRendererWithRenderingRule();t&&(r.renderingRule=t.toJSON())}return ce(r,e),r}function j(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const r={bandIds:(i=e.write()||{}).bandIds,customParameters:i.customParameters,interpolation:i.interpolation,layerDefinition:i.layerDefinition};var i;return r.layerType="ArcGISImageServiceLayer",ce(r,e),r}function Q(e,t,r){return H.apply(this,arguments)}function H(){return(H=t._asyncToGenerator((function*(e,t,r){const i=t.printTemplate;if(r.is11xService){const t={type:"kml"};return e.write(t,{origin:"web-map"}),delete t.layerType,t.url=u.normalize(e.url),t}{const n=[],a=t.layerView;a.allVisibleMapImages.forEach(((t,r)=>{const i={id:`${e.id}_image${r}`,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:e.opacity,extent:t.extent};"data:image/png;base64,"===t.href.substr(0,22)?i.imageData=t.href.substr(22):i.url=t.href,n.push(i)}));const l=[...a.allVisiblePoints.items,...a.allVisiblePolylines.items,...a.allVisiblePolygons.items],o={id:e.id,...yield G(null,l,i,r)};return n.push(o),n}}))).apply(this,arguments)}function X(e,{view:t},r){let i;const n={id:e.id,subLayerIds:[]};let a=[];const l=t.scale,o=e=>{const t=0===l,r=0===e.minScale||l<=e.minScale,i=0===e.maxScale||l>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(o);else{const t=e.toExportImageJSON(),r={id:e.id,name:e.title,layerDefinition:{drawingInfo:t.drawingInfo,definitionExpression:t.definitionExpression,source:t.source}};a.unshift(r),n.subLayerIds.push(e.id)}};var s;return e.sublayers&&e.sublayers.forEach(o),a.length&&(a=a.map((({id:e,name:t,layerDefinition:r})=>({id:e,name:t,layerDefinition:r}))),i={layerType:(s=e.write()).layerType,customParameters:s.customParameters},i.layers=a,i.visibleLayers=e.capabilities.exportMap.supportsDynamicLayers?void 0:n.subLayerIds,ce(i,e),e.legendEnabled&&r.legendLayers.push(n)),i}function Y(e,t){return Z.apply(this,arguments)}function Z(){return(Z=t._asyncToGenerator((function*({layerView:e,printTemplate:t},r){const i=[],n=e.layer;if(o.isSome(n.featureCollections))for(const a of n.featureCollections){const e=yield G(a,a.source,t,r);e&&i.push(...e.featureCollection.layers)}else if(o.isSome(n.sublayers))for(const a of n.sublayers){const e=yield G(null,a.graphics,t,r);e&&i.push(...e.featureCollection.layers)}return{featureCollection:{layers:i}}}))).apply(this,arguments)}function ee(){return{type:"OpenStreetMap"}}function te(e,t,r){return re.apply(this,arguments)}function re(){return(re=t._asyncToGenerator((function*(e,{printTemplate:t,view:r},i){const n={type:"image"},a={format:"png",ignoreBackground:!0,layers:[e],rotation:0},l=i.ssExtent||r.extent.clone();let o=96,y=!0,c=!0;if(t.exportOptions){const e=t.exportOptions;e.dpi>0&&(o=e.dpi),e.width>0&&(y=e.width%2==r.width%2),e.height>0&&(c=e.height%2==r.height%2)}if("map-only"===t.layout&&t.scalePreserved&&(!t.outScale||t.outScale===r.scale)&&96===o&&(!y||!c)&&(a.area={x:0,y:0,width:r.width,height:r.height},y||(a.area.width-=1),c||(a.area.height-=1),!i.ssExtent)){const e=r.toMap(s.createScreenPoint(a.area.width,a.area.height));l.ymin=e.y,l.xmax=e.x,i.ssExtent=l}n.extent=l.clone()._normalize(!0).toJSON();const p=yield r.takeScreenshot(a),{data:d}=u.dataComponents(p.dataUrl);return n.imageData=d,n}))).apply(this,arguments)}function ie(e,t,r){return ne.apply(this,arguments)}function ne(){return(ne=t._asyncToGenerator((function*(e,{layerView:t,printTemplate:r},i){e.legendEnabled&&i.legendLayers.push({id:e.id});return G(e,yield he(t),r,i)}))).apply(this,arguments)}function ae(e){const t={layerType:(r=e.write()).layerType,customParameters:r.customParameters};var r;return ce(t,e),t}function le(e,t,r){return oe.apply(this,arguments)}function oe(){return(oe=t._asyncToGenerator((function*(e,t,r){if(r.is11xService&&e.serviceUrl&&e.styleUrl){const t=pe(e.styleUrl,e.apiKey),i=pe(e.serviceUrl,e.apiKey);if(!t&&!i||"2.1.0"!==r.cimVersion){const r={type:"VectorTileLayer"};return r.styleUrl=u.normalize(e.styleUrl),r.token=t,i!==t&&(r.additionalTokens=[{url:e.serviceUrl,token:i}]),r}}return te(e,t,r)}))).apply(this,arguments)}function se(e){const t={type:"WebTiledLayer",urlTemplate:e.urlTemplate.replace(/\${/g,"{"),credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(t.subDomains=e.subDomains),t}function ue(e){let t;const r=[],i=e=>{e.visible&&(e.sublayers?e.sublayers.forEach(i):e.name&&r.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(i),r.length&&(t={type:"wms",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,transparentBackground:e.imageTransparency,visibleLayers:r,url:u.normalize(e.url),version:e.version}),t}function ye(e){const t=e.activeLayer;return{type:"wmts",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,format:t.imageFormat,layer:t.id,style:t.styleId,tileMatrixSet:t.tileMatrixSetId,url:u.normalize(e.url)}}function ce(e,t){t.url&&(e.url=u.normalize(e.url||t.url),e.token=pe(e.url,t.apiKey))}function pe(e,t){var n,a;return S.supportsApiKey(e)&&(t||r.apiKey)?t||r.apiKey:null==(n=i.id)||null==(a=n.findCredential(e))?void 0:a.token}function de(e,t){return fe.apply(this,arguments)}function fe(){return(fe=t._asyncToGenerator((function*(e,t){t.canvas||(t.canvas=document.createElement("canvas"));const r=1024;t.canvas.width=r,t.canvas.height=r;const i=t.canvas.getContext("2d");let a,l;if(e.path){var o;const t=new Path2D(e.path);t.closePath(),i.fillStyle=Array.isArray(e.color)?`rgba(${e.color[0]},${e.color[1]},${e.color[2]},${e.color[3]/255})`:"rgb(0,0,0)",i.fill(t);const n=h.getContextBoundingBox(i);if(!n)return null;i.clearRect(0,0,r,r);const u=s.pt2px(e.size)/Math.max(n.width,n.height);i.scale(u,u);const y=r/u,c=y/2-n.width/2-n.x,p=y/2-n.height/2-n.y;if(i.translate(c,p),Array.isArray(e.color)&&i.fill(t),null!=(o=e.outline)&&o.width&&Array.isArray(e.outline.color)){const r=e.outline;i.lineWidth=s.pt2px(r.width)/u,i.lineJoin="round",i.strokeStyle=`rgba(${r.color[0]},${r.color[1]},${r.color[2]},${r.color[3]/255})`,i.stroke(t),n.width+=i.lineWidth,n.height+=i.lineWidth}n.width*=u,n.height*=u;const d=i.getImageData(r/2-n.width/2,r/2-n.height/2,Math.ceil(n.width),Math.ceil(n.height));a=d.width,l=d.height,i.canvas.width=a,i.canvas.height=l,i.putImageData(d,0,0)}else{const t="image/svg+xml"===e.contentType?"data:image/svg+xml;base64,"+e.imageData:e.url,r=(yield n(t,{responseType:"image"})).data;a=s.pt2px(e.width),l=s.pt2px(e.height),i.canvas.width=a,i.canvas.height=l,i.drawImage(r,0,0,i.canvas.width,i.canvas.height)}return{type:"esriPMS",imageData:i.canvas.toDataURL("image/png").substr(22),angle:e.angle,contentType:"image/png",height:s.px2pt(l),width:s.px2pt(a),xoffset:e.xoffset,yoffset:e.yoffset}}))).apply(this,arguments)}function me(e,t){return ge.apply(this,arguments)}function ge(){return(ge=t._asyncToGenerator((function*(e,t){const r=e.type;if("simple"===r&&xe(e.symbol))e.symbol=yield de(e.symbol,t);else if("uniqueValue"===r||"classBreaks"===r){xe(e.defaultSymbol)&&(e.defaultSymbol=yield de(e.defaultSymbol,t));const i=e["uniqueValue"===r?"uniqueValueInfos":"classBreakInfos"];if(i)for(const e of i)xe(e.symbol)&&(e.symbol=yield de(e.symbol,t))}}))).apply(this,arguments)}function he(e){return be.apply(this,arguments)}function be(){return(be=t._asyncToGenerator((function*(e){return e.queryFeatures(e.createQuery()).then((e=>e.features))}))).apply(this,arguments)}function Se(e){return e.gpMetadata&&e.gpMetadata.executionType?L.fromJSON(e.gpMetadata.executionType):"sync"}function xe(e){return e&&(e.path||"image/svg+xml"===e.contentType||e.url&&e.url.endsWith(".svg"))}e.execute=I,e.getGpPrintParams=E,e.getGpServerUrl=N,e.getMode=M,e.printCacheMap=T,Object.defineProperty(e,"__esModule",{value:!0})}));
