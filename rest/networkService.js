/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../request","../core/Error","../core/maybe","../core/object","../core/urlUtils","./utils","./support/NetworkServiceDescription","./support/RouteResultsContainer"],(function(e,r,t,o,s,a,l,n,i,u){"use strict";function p(e,r,t,o){o[t]=[r.length,r.length+e.length],e.forEach((e=>{r.push(e.geometry)}))}function d(e,r){for(let t=0;t<r.length;t++){const o=e[r[t]];if(o&&o.length)for(const e of o)e.z=void 0}console.log("The remote Network Analysis service is powered by a network dataset which is not Z-aware.\nZ-coordinates of the input geometry are ignored.")}function c(e){const r=[],t=[],{directions:o=[],routes:{features:s=[],spatialReference:a=null}={},stops:{features:l=[],spatialReference:n=null}={},barriers:i,polygonBarriers:p,polylineBarriers:d,messages:c}=e.data,f="esri.tasks.RouteTask.NULL_ROUTE_NAME";let v,h,y=!0;const T=s&&a||l&&n||i&&i.spatialReference||p&&p.spatialReference||d&&d.spatialReference;o.forEach((e=>{r.push(v=e.routeName),t[v]={directions:e}})),s.forEach((e=>{-1===r.indexOf(v=e.attributes.Name)&&(r.push(v),t[v]={}),e.geometry&&(e.geometry.spatialReference=T),t[v].route=e})),l.forEach((e=>{h=e.attributes,-1===r.indexOf(v=h.RouteName||f)&&(r.push(v),t[v]={}),v!==f&&(y=!1),e.geometry&&(e.geometry.spatialReference=T),null==t[v].stops&&(t[v].stops=[]),t[v].stops.push(e)})),l.length>0&&!0===y&&(t[r[0]].stops=t[f].stops,delete t[f],r.splice(r.indexOf(f),1));const g=r.map((e=>(t[e].routeName=e===f?null:e,t[e])));return u.fromJSON({routeResults:g,pointBarriers:i,polygonBarriers:p,polylineBarriers:d,messages:c})}function f(e,r){for(let t=0;t<r.length;t++){const o=e[r[t]];if(o&&o.length)for(const e of o)if(s.isSome(e)&&e.hasZ)return!0}return!1}function v(e,r,t){return h.apply(this,arguments)}function h(){return(h=r._asyncToGenerator((function*(e,r,s){if(!e)throw new o("network-service:missing-url","Url to Network service is missing");const a={f:"json",token:r},l=n.asValidOptions(a,s),{data:u}=yield t(e,l);u.supportedTravelModes||(u.supportedTravelModes=[]);for(let t=0;t<u.supportedTravelModes.length;t++)u.supportedTravelModes[t].id||(u.supportedTravelModes[t].id=u.supportedTravelModes[t].itemId);const p=u.currentVersion>=10.4?g(e,r,s):y(e,s),{defaultTravelMode:d,supportedTravelModes:c}=yield p;return u.defaultTravelMode=d,u.supportedTravelModes=c,i.fromJSON(u)}))).apply(this,arguments)}function y(e,r){return T.apply(this,arguments)}function T(){return(T=r._asyncToGenerator((function*(e,r){var o,s;const i={f:"json"},u=n.asValidOptions(i,r),{data:p}=yield t(e.replace(/\/rest\/.*$/i,"/info"),u);if(!p||!p.owningSystemUrl)return{supportedTravelModes:[],defaultTravelMode:null};const{owningSystemUrl:d}=p,c=l.removeTrailingSlash(d)+"/sharing/rest/portals/self",{data:f}=yield t(c,u),v=a.getDeepValue("helperServices.routingUtilities.url",f);if(!v)return{supportedTravelModes:[],defaultTravelMode:null};const h=n.parseUrl(d),y={f:"json",serviceName:/\/solve$/i.test(h.path)?"Route":/\/solveclosestfacility$/i.test(h.path)?"ClosestFacility":"ServiceAreas"},T=n.asValidOptions(y,r),g=l.removeTrailingSlash(v)+"/GetTravelModes/execute",m=yield t(g,T),M=[];let w=null;if(null!=m&&null!=(o=m.data)&&null!=(s=o.results)&&s.length){const e=m.data.results;for(const r of e){var N;if("supportedTravelModes"===r.paramName){if(null!=(N=r.value)&&N.features)for(const{attributes:e}of r.value.features)if(e){const r=JSON.parse(e.TravelMode);M.push(r)}}else"defaultTravelMode"===r.paramName&&(w=r.value)}}return{supportedTravelModes:M,defaultTravelMode:w}}))).apply(this,arguments)}function g(e,r,t){return m.apply(this,arguments)}function m(){return(m=r._asyncToGenerator((function*(e,r,s){try{const o={f:"json",token:r},a=n.asValidOptions(o,s),i=l.removeTrailingSlash(e)+"/retrieveTravelModes",{data:{supportedTravelModes:u,defaultTravelMode:p}}=yield t(i,a);return{supportedTravelModes:u,defaultTravelMode:p}}catch(a){throw new o("network-service:retrieveTravelModes","Could not get to the NAServer's retrieveTravelModes.",{error:a})}}))).apply(this,arguments)}e.collectGeometries=p,e.dropZValuesOffInputGeometry=d,e.fetchServiceDescription=v,e.handleSolveResponse=c,e.isInputGeometryZAware=f,Object.defineProperty(e,"__esModule",{value:!0})}));
