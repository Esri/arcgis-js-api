/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/has","../../core/maybe","../../core/promiseUtils","../../layers/support/source/DataLayerSource","./executeQueryJSON","./executeQueryPBF","../support/FeatureSet","../support/Query"],(function(e,t,r,o,n,a,i,s,u,c,f,l){"use strict";function p(e,t,r,o){return y.apply(this,arguments)}function y(){return(y=r._asyncToGenerator((function*(e,t,r,o){return m(e,t,r,o).then((e=>b(t,e,r,o)))}))).apply(this,arguments)}function m(e,t,r,o){return d.apply(this,arguments)}function d(){return(d=r._asyncToGenerator((function*(e,t,r,o){const a={...o},i=O(t,r),s=null!=t.outStatistics?.[0],f=n("featurelayer-pbf-statistics"),l=!s||f;let p;if("pbf"===r?.format&&l)try{p=yield c.executeRawQueryPBF(e,i,a)}catch(y){if("query:parsing-pbf"!==y.name)throw y;r.format="json"}return"json"!==r?.format&&l||(p=yield u.executeRawQueryJSON(e,i,a)),S(r?.fieldsIndex,p.fields),p}))).apply(this,arguments)}function S(e,t){if(a.isSome(e)&&a.isSome(t))for(const r of t){const t=e.get(r.name);t&&Object.assign(r,t.toJSON())}}function b(e,t,r,o){return D.apply(this,arguments)}function D(){return(D=r._asyncToGenerator((function*(t,r,o,n){const s=o?.infoFor3D;if(!g(t,s)||a.isNone(s)||!r.assetMaps||!r.features||!r.features.length)return f.fromJSON(r);const{meshFeatureSetFromJSON:u}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../support/meshFeatureSet"],t,r))),n);return u(t,s,r)}))).apply(this,arguments)}function O(e,t){let r=l.from(e);r.sourceSpatialReference=r.sourceSpatialReference??t?.sourceSpatialReference??null,(t?.gdbVersion||t?.dynamicDataSource)&&(r=r===e?r.clone():r,r.gdbVersion=e.gdbVersion||t.gdbVersion,r.dynamicDataSource=e.dynamicDataSource?s.DataLayerSource.from(e.dynamicDataSource):t.dynamicDataSource);const n=t?.infoFor3D;if(a.isSome(n)&&g(e,n)){r=r===e?r.clone():r,r.formatOf3DObjects=null;for(const e of n.queryFormats){if("3D_glb"===e){r.formatOf3DObjects=e;break}"3D_gltf"!==e||r.formatOf3DObjects||(r.formatOf3DObjects=e)}if(!r.formatOf3DObjects)throw new o("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(a.isNone(r.outFields)||!r.outFields.includes("*")){r=r===e?r.clone():r,a.isNone(r.outFields)&&(r.outFields=[]);const{originX:t,originY:o,originZ:i,translationX:s,translationY:u,translationZ:c,scaleX:f,scaleY:l,scaleZ:p,rotationX:y,rotationY:m,rotationZ:d,rotationDeg:S}=n.transformFieldRoles;r.outFields.push(t,o,i,s,u,c,f,l,p,y,m,d,S)}}return r}function g(e,t){return a.isSome(t)&&!0===e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics}t.executeQuery=p,t.executeRawQuery=m,t.normalizeFields=S,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
