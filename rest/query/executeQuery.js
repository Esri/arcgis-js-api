/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/has","../../core/maybe","../../core/promiseUtils","../../layers/support/source/DataLayerSource","./executeQueryJSON","./executeQueryPBF","../support/FeatureSet","../support/Query"],(function(e,t,r,o,n,i,a,s,u,c,f,l){"use strict";function p(e,t,r,o){return y.apply(this,arguments)}function y(){return(y=r._asyncToGenerator((function*(e,t,r,o){return m(e,t,r,o).then((e=>D(t,e,r,o)))}))).apply(this,arguments)}function m(e,t,r,o){return d.apply(this,arguments)}function d(){return(d=r._asyncToGenerator((function*(e,t,r,o){const i={...o},a=F(t,r),s=null!=t.outStatistics?.[0],f=n("featurelayer-pbf-statistics"),l=!s||f;let p;if("pbf"===r.format&&l)try{p=yield c.executeRawQueryPBF(e,a,i)}catch(y){if("query:parsing-pbf"!==y.name)throw y;r.format="json"}return"json"!==r.format&&l||(p=yield u.executeRawQueryJSON(e,a,i)),S(r.fieldsIndex,p.fields),p}))).apply(this,arguments)}function S(e,t){if(i.isSome(e)&&i.isSome(t))for(const r of t){const t=e.get(r.name);t&&Object.assign(r,t.toJSON())}}function D(e,t,r,o){return b.apply(this,arguments)}function b(){return(b=r._asyncToGenerator((function*(t,r,o,n){if(!O(t,o?.infoFor3D)||i.isNone(o.infoFor3D)||!r.assetMaps||!r.features||!r.features.length)return f.fromJSON(r);const{meshFeatureSetFromJSON:s}=yield a.whenOrAbort(new Promise(((t,r)=>e(["../support/meshFeatureSet"],t,r))),n);return s(t,o.infoFor3D,r)}))).apply(this,arguments)}function F(e,t){let r=l.from(e);if(r.sourceSpatialReference=r.sourceSpatialReference||t?.sourceSpatialReference,(t.gdbVersion||t.dynamicDataSource)&&(r=r===e?r.clone():r,r.gdbVersion=e.gdbVersion||t.gdbVersion,r.dynamicDataSource=e.dynamicDataSource?s.DataLayerSource.from(e.dynamicDataSource):t.dynamicDataSource),i.isSome(t.infoFor3D)&&O(e,t?.infoFor3D)){r=r===e?r.clone():r,r.formatOf3DObjects=null;for(const e of t.infoFor3D.queryFormats){if("3D_glb"===e){r.formatOf3DObjects=e;break}"3D_gltf"!==e||r.formatOf3DObjects||(r.formatOf3DObjects=e)}if(!r.formatOf3DObjects)throw new o("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(i.isNone(r.outFields)||!r.outFields.includes("*")){r=r===e?r.clone():r,i.isNone(r.outFields)&&(r.outFields=[]);const{originX:o,originY:n,originZ:a,translationX:s,translationY:u,translationZ:c,scaleX:f,scaleY:l,scaleZ:p,rotationX:y,rotationY:m,rotationZ:d,rotationDeg:S}=t.infoFor3D.transformFieldRoles;r.outFields.push(o,n,a,s,u,c,f,l,p,y,m,d,S)}}return r}function O(e,t){return i.isSome(t)&&e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics}t.executeQuery=p,t.executeRawQuery=m,t.normalizeFields=S,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
