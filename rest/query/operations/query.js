/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../request","../../../core/maybe","../../../core/urlUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../layers/support/arcgisLayerUrl","./pbfQueryUtils","./queryZScale","../../../tasks/operations/urlUtils"],(function(e,t,r,n,i,o,s,u,a,l,y){"use strict";const c="Layer does not support extent calculation.";function m(e,t,r=!1){const i=e.geometry,s=e.toJSON(),u=s,a=e.outSpatialReference;let l,y;if(n.isSome(i)){if(l=i.spatialReference,y=i.spatialReference.wkid||JSON.stringify(i.spatialReference),u.geometryType=o.getJsonType(i),r&&"extent"===i.type)u.geometry=`${i.xmin},${i.ymin},${i.xmax},${i.ymax}`;else if(r&&"point"===i.type)u.geometry=`${i.x},${i.y}`;else{const e=i.toJSON();delete e.spatialReference,u.geometry=JSON.stringify(e)}u.inSR=y}if(l||(l=a),s.groupByFieldsForStatistics&&(u.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds&&(u.objectIds=s.objectIds.join(",")),s.orderByFields&&(u.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(null!=t&&t.returnCountOnly||null!=t&&t.returnExtentOnly||null!=t&&t.returnIdsOnly)?delete u.outFields:-1!==s.outFields.indexOf("*")?u.outFields="*":u.outFields=s.outFields.join(","),s.outSR?u.outSR=s.outSR.wkid||JSON.stringify(s.outSR):i&&(s.returnGeometry||s.returnCentroid)&&(u.outSR=u.inSR),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(u.outStatistics=JSON.stringify(s.outStatistics)),s.pixelSize&&(u.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(r&&n.isSome(l)&&n.isSome(e.quantizationParameters)&&n.isSome(e.quantizationParameters.extent)&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,u.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(u.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(u.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(u.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const e=s.timeExtent,{start:t,end:r}=e;null==t&&null==r||(u.time=t===r?t:`${null==t?"null":t},${null==r?"null":r}`),delete s.timeExtent}return u}function p(e,t,r,n){return d.apply(this,arguments)}function d(){return(d=t._asyncToGenerator((function*(e,t,r,i){const o=n.isSome(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:yield E(e,t,"json",i);return l.applyFeatureSetZUnitScaling(t,r,o.data),o}))).apply(this,arguments)}function f(e,t,r,n){return S.apply(this,arguments)}function S(){return(S=t._asyncToGenerator((function*(e,t,r,i){if(n.isSome(t.timeExtent)&&t.timeExtent.isEmpty)return Promise.resolve({data:r.createFeatureResult()});const o=yield x(e,t,i),s=o;return s.data=a.parsePBFFeatureQuery(o.data,r),s}))).apply(this,arguments)}function x(e,t,r){return E(e,t,"pbf",r)}function g(e,t,r){return n.isSome(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):E(e,t,"json",r,{returnIdsOnly:!0})}function F(e,t,r){return n.isSome(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):E(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}function O(e,t,r){return n.isSome(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):E(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then((e=>{const t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(c);if(t.hasOwnProperty("count"))throw new Error(c);return e}))}function E(e,t,o,a={},l={}){const c="string"==typeof e?i.urlToObject(e):e,p=t.geometry?[t.geometry]:[];return a.responseType="pbf"===o?"array-buffer":"json",s.normalizeCentralMeridian(p,null,a).then((e=>{const s=e&&e[0];n.isSome(s)&&((t=t.clone()).geometry=s);const p=u.isHostedAgolService(c.path),d=y.mapParameters({...c.query,f:o,...l,...m(t,l,p)});return r(i.join(c.path,"query"),{...a,query:{...d,...a.query}})}))}e.executeQuery=p,e.executeQueryForCount=F,e.executeQueryForExtent=O,e.executeQueryForIds=g,e.executeQueryPBF=f,e.executeQueryPBFBuffer=x,e.queryToQueryStringParameters=m,e.runQuery=E,Object.defineProperty(e,"__esModule",{value:!0})}));
