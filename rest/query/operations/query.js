/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/urlUtils","../../../geometry/support/jsonUtils","../../../request","../../../geometry/support/normalizeUtils","./queryZScale","../../../tasks/operations/urlUtils","./pbfQueryUtils"],(function(e,t,r,n,i,o,u,s,a){"use strict";const l="Layer does not support extent calculation.";function y(e,r){const i=e.geometry,o=e.toJSON(),u=o;if(t.isSome(i)&&(u.geometry=JSON.stringify(i),u.geometryType=n.getJsonType(i),u.inSR=i.spatialReference.wkid||JSON.stringify(i.spatialReference)),o.groupByFieldsForStatistics&&(u.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),o.objectIds&&(u.objectIds=o.objectIds.join(",")),o.orderByFields&&(u.orderByFields=o.orderByFields.join(",")),!o.outFields||!o.returnDistinctValues&&(null!=r&&r.returnCountOnly||null!=r&&r.returnExtentOnly||null!=r&&r.returnIdsOnly)?delete u.outFields:-1!==o.outFields.indexOf("*")?u.outFields="*":u.outFields=o.outFields.join(","),o.outSR?u.outSR=o.outSR.wkid||JSON.stringify(o.outSR):i&&(o.returnGeometry||o.returnCentroid)&&(u.outSR=u.inSR),o.returnGeometry&&delete o.returnGeometry,o.outStatistics&&(u.outStatistics=JSON.stringify(o.outStatistics)),o.pixelSize&&(u.pixelSize=JSON.stringify(o.pixelSize)),o.quantizationParameters&&(u.quantizationParameters=JSON.stringify(o.quantizationParameters)),o.parameterValues&&(u.parameterValues=JSON.stringify(o.parameterValues)),o.rangeValues&&(u.rangeValues=JSON.stringify(o.rangeValues)),o.dynamicDataSource&&(u.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o.timeExtent){const e=o.timeExtent,{start:t,end:r}=e;null==t&&null==r||(u.time=t===r?t:`${null==t?"null":t},${null==r?"null":r}`),delete o.timeExtent}return u}async function c(e,r,n,i){const o=t.isSome(r.timeExtent)&&r.timeExtent.isEmpty?{data:{features:[]}}:await x(e,r,"json",i);return u.applyFeatureSetZUnitScaling(r,n,o.data),o}async function m(e,r,n,i){if(t.isSome(r.timeExtent)&&r.timeExtent.isEmpty)return Promise.resolve({data:n.createFeatureResult()});const o=await d(e,r,i),u=o;return u.data=a.parsePBFFeatureQuery(o.data,n),u}function d(e,t,r){return x(e,t,"pbf",r)}function p(e,r,n){return t.isSome(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):x(e,r,"json",n,{returnIdsOnly:!0})}function S(e,r,n){return t.isSome(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):x(e,r,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}function f(e,r,n){return t.isSome(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):x(e,r,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}).then((e=>{const t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(l);if(t.hasOwnProperty("count"))throw new Error(l);return e}))}function x(e,n,u,a={},l={}){const c="string"==typeof e?r.urlToObject(e):e,m=n.geometry?[n.geometry]:[];return a.responseType="pbf"===u?"array-buffer":"json",o.normalizeCentralMeridian(m,null,a).then((e=>{const o=e&&e[0];t.isSome(o)&&((n=n.clone()).geometry=o);const m=s.mapParameters({...c.query,f:u,...l,...y(n,l)});return i(r.join(c.path,"query"),{...a,query:{...m,...a.query}})}))}e.executeQuery=c,e.executeQueryForCount=S,e.executeQueryForExtent=f,e.executeQueryForIds=p,e.executeQueryPBF=m,e.executeQueryPBFBuffer=d,e.queryToQueryStringParameters=y,e.runQuery=x,Object.defineProperty(e,"__esModule",{value:!0})}));
