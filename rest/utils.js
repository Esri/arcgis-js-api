/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../core/maybe","../core/urlUtils","../geometry/support/scaleUtils","../views/support/floorFilterUtils"],(function(e,i,n,t,r){"use strict";function s(e,i){return i?{...i,query:{...e,...i.query}}:{query:e}}function o(e){return"string"==typeof e?n.urlToObject(e):e}function l(e,i,n){const t={};for(const r in e){if("declaredClass"===r)continue;const s=e[r];if(null!=s&&"function"!=typeof s)if(Array.isArray(s)){t[r]=[];for(let e=0;e<s.length;e++)t[r][e]=l(s[e])}else if("object"==typeof s)if(s.toJSON){const e=s.toJSON(n&&n[r]);t[r]=i?e:JSON.stringify(e)}else t[r]=i?s:JSON.stringify(s);else t[r]=s}return t}function a({mapExtent:e,floors:i,width:n,sublayers:s,layerIds:o}){const l={},a={extent:e,width:n,spatialReference:null==e?void 0:e.spatialReference};let c=s;o&&o.length&&s&&(c=s.filter((e=>o.includes(e.id))));const u=t.getScale(a),y=[],d=e=>{const i=0===u,n=0===e.minScale||u<=e.minScale,t=0===e.maxScale||u>=e.maxScale;e.visible&&(i||n&&t)&&(e.sublayers?e.sublayers.forEach(d):y.unshift(e))};if(c&&c.forEach(d),c&&c.length){const e=y.map((e=>{const n=r.getLayerFloorFilterClause(i,e);return e.toExportImageJSON(n)})),n=e.some((e=>"mapLayer"===e.source.type?e.source.mapLayerId!==e.id:"dataLayer"===e.source.type));if(n){let i=JSON.stringify(e);"[]"===i&&(i="[{}]"),l.dynamicLayers=i}else if(!n){if(o&&o.length)l.layerIds=o;else{const e=c.map((({id:e})=>e));e.length&&(l.layerIds=e)}const e=f({floors:i,visibleSublayers:y});if(e&&e.length){const i=e.reduce(((e,i)=>(i.definitionExpression&&(e[i.id]=i.definitionExpression),e)),{});Object.keys(i).length&&(l.layerDefs=JSON.stringify(i))}}}return l}function f({floors:e,visibleSublayers:n}){const t=!(null==e||!e.length),s=n.filter((e=>null!=e.definitionExpression||t&&null!=e.floorInfo));if(!s.length)return null;return s.map((n=>{const t=r.getLayerFloorFilterClause(e,n),s=i.isSome(t)?r.combineFloorsDefinitionExpression(t,n):n.definitionExpression,o={id:n.id,definitionExpression:null};return s&&(o.definitionExpression=s),o}))}e.asValidOptions=s,e.encode=l,e.parseUrl=o,e.toDynamicLayersJSON=a,Object.defineProperty(e,"__esModule",{value:!0})}));
