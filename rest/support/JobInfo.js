/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../request","../../core/has","../../core/jsonMap","../../core/JSONSupport","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","../utils","../geoprocessor/GPOptions","../geoprocessor/utils","./GPMessage"],(function(e,t,r,o,s,n,i,a,c,u,l,p,b,d,h,j,y){"use strict";const f=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var g;const _=n.strict()({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"},{ignoreUnknown:!1});let m=g=function(r){function s(e){var t;return(t=r.call(this,e)||this).jobId=null,t.jobStatus=null,t.messages=null,t.progress=null,t.requestOptions=null,t.sourceUrl=null,t._timer=void 0,t}t._inheritsLoose(s,r);var n=s.prototype;return n.cancelJob=function(){var e=t._asyncToGenerator((function*(e){const{jobId:t,sourceUrl:r}=this,{path:s}=d.parseUrl(r),n={...this.requestOptions,...e,query:{f:"json"}};this._clearTimer();const i=`${s}/jobs/${t}/cancel`,{data:a}=yield o(i,n),{messages:c,jobStatus:u,progress:l}=g.fromJSON(a);return this.set({messages:c,jobStatus:u,progress:l}),this}));function r(t){return e.apply(this,arguments)}return r}(),n.destroy=function(){clearInterval(this._timer)},n.checkJobStatus=function(){var e=t._asyncToGenerator((function*(e){const{path:t}=d.parseUrl(this.sourceUrl),r={...this.requestOptions,...e,query:{f:"json"}},s=`${t}/jobs/${this.jobId}`,{data:n}=yield o(s,r),{messages:i,jobStatus:a,progress:c}=g.fromJSON(n);return this.set({messages:i,jobStatus:a,progress:c}),this}));function r(t){return e.apply(this,arguments)}return r}(),n.fetchResultData=function(){var e=t._asyncToGenerator((function*(e,t,r){t=h.from(t||{});const{returnFeatureCollection:s,returnM:n,returnZ:i,outSpatialReference:a}=t,{path:c}=d.parseUrl(this.sourceUrl),u={returnFeatureCollection:s,returnM:n,returnZ:i,outSR:a,returnType:"data",f:"json"},l=j.gpEncode(u,null),p={...this.requestOptions,...r,query:l},b=`${c}/jobs/${this.jobId}/results/${e}`,{data:y}=yield o(b,p);return j.decode(y)}));function r(t,r,o){return e.apply(this,arguments)}return r}(),n.fetchResultImage=function(){var e=t._asyncToGenerator((function*(e,t,r){const{path:s}=d.parseUrl(this.sourceUrl),n={...t.toJSON(),f:"json"},i=j.gpEncode(n),a={...this.requestOptions,...r,query:i},c=`${s}/jobs/${this.jobId}/results/${e}`,{data:u}=yield o(c,a);return j.decode(u)}));function r(t,r,o){return e.apply(this,arguments)}return r}(),n.fetchResultMapImageLayer=function(){var r=t._asyncToGenerator((function*(){const{path:t}=d.parseUrl(this.sourceUrl),r=t.indexOf("/GPServer/"),o=`${t.substring(0,r)}/MapServer/jobs/${this.jobId}`;return new(0,(yield new Promise(((t,r)=>e(["../../layers/MapImageLayer"],(e=>t(f(e))),r)))).default)({url:o})}));function o(){return r.apply(this,arguments)}return o}(),n.waitForJobCompletion=function(){var e=t._asyncToGenerator((function*(e={}){const{interval:t=1e3,signal:r,statusCallback:o}=e;return new Promise(((e,s)=>{a.onAbort(r,(()=>{this._clearTimer(),s(a.createAbortError())})),this._clearTimer();const n=setInterval((()=>{this._timer||s(a.createAbortError()),this.checkJobStatus(this.requestOptions).then((t=>{const{jobStatus:r}=t;switch(this.jobStatus=r,r){case"job-succeeded":this._clearTimer(),e(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":o&&o(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),s(this)}}))}),t);this._timer=n}))}));function r(){return e.apply(this,arguments)}return r}(),n._clearTimer=function(){clearInterval(this._timer),this._timer=void 0},s}(i.JSONSupport);r.__decorate([c.property()],m.prototype,"jobId",void 0),r.__decorate([p.enumeration(_,{ignoreUnknown:!1})],m.prototype,"jobStatus",void 0),r.__decorate([c.property({type:[y]})],m.prototype,"messages",void 0),r.__decorate([c.property()],m.prototype,"progress",void 0),r.__decorate([c.property()],m.prototype,"requestOptions",void 0),r.__decorate([c.property({json:{write:!0}})],m.prototype,"sourceUrl",void 0),m=g=r.__decorate([b.subclass("esri.rest.support.JobInfo")],m);return m}));
