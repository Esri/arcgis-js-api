/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../geometry","../kernel","../request","../core/Error","../core/Logger","./knowledgeGraph/GraphQueryResult","./knowledgeGraph/GraphQueryStreamingResult","./knowledgeGraph/KnowledgeGraph","./knowledgeGraph/wasmInterface/knowledgeWasmAccess","./knowledgeGraph/wasmInterface/queryToWasmEncodedFactories","./knowledgeGraph/wasmInterface/updateToWasmEncodedFactories","./knowledgeGraph/wasmInterface/wasmToDataModelFactories","./knowledgeGraph/wasmInterface/wasmToQueryResponseObjFactories","./knowledgeGraph/wasmInterface/wasmToUpdateResponseFactories","../geometry/Geometry"],(function(e,t,r,n,a,o,d,i,s,l,p,c,u,y,h,g,f){"use strict";function m(e,t,r){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*(e,t,r){const n=`${e.url}/graph/applyEdits`;yield W(e);const a=yield D(n,r);a.data.body=yield C(t,e);return U(yield fetch(a.data.url,a.data))}))).apply(this,arguments)}function _(e,t,r){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t,r){const n=`${e.url}/graph/query`,d=yield a(n,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...r?.query},signal:r?.signal,timeout:r?.timeout}),s=d.getHeader?.("content-type"),l=d.data;if(s?.includes("application/x-protobuf")){const t=new((yield p.getWasmInterface()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new i({resultRows:H(t,l,e.dataModel)});throw new o("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new o("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:s,data:d.data})}))).apply(this,arguments)}function G(e,t,r){return T.apply(this,arguments)}function T(){return(T=t._asyncToGenerator((function*(e,t,r){const n=`${e.url}/graph/query`;yield W(e);const a=yield D(n,r);a.data.body=yield R(t,e);const d=yield fetch(a.data.url,a.data);if(e.dataModel)return new s({resultRowsStream:yield $(d,e.dataModel)});throw new o("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}))).apply(this,arguments)}function k(e,t,r){return I.apply(this,arguments)}function I(){return(I=t._asyncToGenerator((function*(e,t,r){let n=t.typeCategoryFilter;"entity"===t.typeCategoryFilter?n="entities":"relationship"===t.typeCategoryFilter&&(n="relationships");const d=`${e.url}/graph/search`,s=yield a(d,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:n,...r?.query},signal:r?.signal,timeout:r?.timeout}),l=s.getHeader?.("content-type"),c=s.data;if(l?.includes("application/x-protobuf")){const t=new((yield p.getWasmInterface()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new i({resultRows:H(t,c,e.dataModel)});throw new o("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new o("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:l,data:s.data})}))).apply(this,arguments)}function E(e,t,r){return v.apply(this,arguments)}function v(){return(v=t._asyncToGenerator((function*(e,t,r){const n=`${e.url}/graph/search`;yield W(e);const a=yield D(n,r);a.data.body=yield z(t);const d=yield fetch(a.data.url,a.data);if(e.dataModel)return new s({resultRowsStream:yield $(d,e.dataModel)});throw new o("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}))).apply(this,arguments)}function M(e){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e){const t=new l({url:e});return yield A(t),t}))).apply(this,arguments)}function A(e){return F.apply(this,arguments)}function F(){return(F=t._asyncToGenerator((function*(e){e.dataModel=yield B(e)}))).apply(this,arguments)}function W(e){return Q.apply(this,arguments)}function Q(){return(Q=t._asyncToGenerator((function*(e){const t=n.id?.findCredential(e.url);t||(e.dataModel?yield B(e):yield A(e))}))).apply(this,arguments)}function S(e,t,r){if(0!==e.error_code)throw new o(t,r,{errorCode:e.error_code,errorMessage:e.error_message})}function q(e,t,r,n){null==t?r.set_param_key_value(e,""):"object"!=typeof t||t instanceof Date?r.set_param_key_value(e,t):t instanceof f?r.set_param_key_value(e,c.geometryToWasm(t,n)):t instanceof Array?r.set_param_key_value(e,c.bindParamArrayToWasm(t,n)):r.set_param_key_value(e,c.bindParamObjectToWasm(t,n))}function C(e,t){return P.apply(this,arguments)}function P(){return(P=t._asyncToGenerator((function*(e,t){if(t.dataModel||(yield A(t)),!t.dataModel)throw new o("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const r=yield p.getWasmInterface(),n=!0,a=!!e.options?.cascadeDelete,d=new r.GraphApplyEditsEncoder(n,t.dataModel.objectIdField,t.dataModel.globalIdField,r.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?u.inputQuantizationParemetersToWasmFormat(e.options?.inputQuantizationParameters):r.InputQuantizationUtil.WGS84_lossless());d.deleteLater(),d.cascade_delete=a;try{let n;e.entityAdds?.forEach((e=>{n=d.add_entity(u.namedObjectToWasm(e,r)),S(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipAdds?.forEach((e=>{if(!e.originId||!e.destinationId)throw new o("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination globalid on the appropriate class property");t.dataModel?.originEntityGlobalIdField&&e.properties&&(e.properties[t.dataModel.originEntityGlobalIdField]=e.originId),t.dataModel?.destEntityGlobalIdField&&e.properties&&(e.properties[t.dataModel.destEntityGlobalIdField]=e.destinationId),n=d.add_relationship(u.namedObjectToWasm(e,r)),S(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an relationship failed to be added to the encoder")})),e.entityUpdates?.forEach((e=>{if(!e.id)throw new o("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t.dataModel?.globalIdField&&e.properties&&(e.properties[t.dataModel.globalIdField]=e.id),n=d.update_entity(u.namedObjectToWasm(e,r)),S(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipUpdates?.forEach((e=>{if(!e.id)throw new o("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t.dataModel?.globalIdField&&e.properties&&(e.properties[t.dataModel.globalIdField]=e.id),t.dataModel?.originEntityGlobalIdField&&e.properties&&e.originId&&(e.properties[t.dataModel.originEntityGlobalIdField]=e.originId),t.dataModel?.destEntityGlobalIdField&&e.properties&&e.destinationId&&(e.properties[t.dataModel.destEntityGlobalIdField]=e.destinationId),n=d.update_relationship(u.namedObjectToWasm(e,r)),S(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")})),e.entityDeletes?.forEach((e=>{if(!e.typeName)throw new o("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=d.make_delete_helper(e.typeName,!0);t.deleteLater(),e.ids?.forEach((e=>{if("string"!=typeof e)throw new o("knowledge-graph:id-type-mismatch","All delete Ids must be globalIds for Enterprise 11.0 ArcGIS Knowledge Services");t.delete_by_globalid(e)}))})),e.relationshipDeletes?.forEach((e=>{if(!e.typeName)throw new o("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=d.make_delete_helper(e.typeName,!1);e.ids?.forEach((e=>{if("string"!=typeof e)throw new o("knowledge-graph:id-type-mismatch","All delete Ids must be globalIds for Enterprise 11.0 ArcGIS Knowledge Services");t.delete_by_globalid(e)}))})),d.encode()}catch(s){throw new o("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:s})}const i=d.get_encoding_result();return S(i.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),i.get_byte_buffer()}))).apply(this,arguments)}function R(e,t){return O.apply(this,arguments)}function O(){return(O=t._asyncToGenerator((function*(e,t){const r=yield p.getWasmInterface(),n=new r.GraphQueryRequestEncoder;if(n.deleteLater(),n.output_spatial_reference=r.SpatialReferenceUtil.WGS84(),n.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[o,i]of Object.entries(e.bindParameters))q(o,i,n,r);if(e.bindGeometryQuantizationParameters)c.setInputQuantizationParametersOnEncoder(e.bindGeometryQuantizationParameters,n);else{if(t.dataModel||(yield A(t)),4326!==t.dataModel?.spatialReference?.wkid)throw new o("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");n.input_quantization_parameters=r.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&c.setOutputQuantizationParametersOnEncoder(e.outputQuantizationParameters,n,r);try{n.encode()}catch(d){throw new o("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:d})}const a=n.get_encoding_result();if(0!==a.error.error_code)throw new o("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:a.error.error_code,errorMessage:a.error.error_message});return a.get_byte_buffer()}))).apply(this,arguments)}function z(e){return j.apply(this,arguments)}function j(){return(j=t._asyncToGenerator((function*(e){const t=yield p.getWasmInterface(),r=new t.GraphSearchRequestEncoder;if(r.deleteLater(),r.search_query=e.searchQuery,r.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter.toString()],!0===e.returnSearchContext&&(r.return_search_context=e.returnSearchContext),void 0!==e.start&&e.start>0&&(r.start_index=e.start),void 0!==e.num&&(r.max_num_results=e.num),void 0!==e.globalIdsFilter&&Array.isArray(e.globalIdsFilter)&&e.globalIdsFilter.length>0)try{r.set_globalids_filter(c.bindParamArrayToWasm(e.globalIdsFilter,t))}catch(a){throw new o("knowledge-graph:globalIds-format-error","Attempting to set globalids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:a})}e.namedTypesFilter?.forEach((e=>{r.add_named_type_filter(e)}));try{r.encode()}catch(a){throw new o("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:a})}const n=r.get_encoding_result();if(0!==n.error.error_code)throw new o("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:n.error.error_code,errorMessage:n.error.error_message});return n.get_byte_buffer()}))).apply(this,arguments)}function D(e,t){return L.apply(this,arguments)}function L(){return(L=t._asyncToGenerator((function*(e,t){return a(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t?.signal,timeout:t?.timeout})}))).apply(this,arguments)}function U(e){return K.apply(this,arguments)}function K(){return(K=t._asyncToGenerator((function*(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const t=yield e.arrayBuffer(),r=new((yield p.getWasmInterface()).GraphApplyEditsDecoder);return r.deleteLater(),r.decode(new Uint8Array(t)),g.decoderToApplyEditsResponse(r)}throw new o("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}))).apply(this,arguments)}function H(e,t,r){e.push_buffer(new Uint8Array(t));const n=[];let a=0;for(;e.next_row();){a||(a=e.get_header_keys().size());const t=new Array(a);for(let n=0;n<a;n++){const a=e.get_value(n);t[n]=h.decodedWasmObjToQueryResponseObj(a,r)}n.push(t)}if(e.has_error())throw new o("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return n}function $(e,t){return N.apply(this,arguments)}function N(){return(N=t._asyncToGenerator((function*(e,r){const n=e.headers.get("content-type");if(e.headers.get("content-length")&&d.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),n?.includes("application/x-protobuf")){const n=e.body?.getReader(),a=new((yield p.getWasmInterface()).GraphQueryDecoder);return a.deleteLater(),new ReadableStream({start:e=>t._asyncToGenerator((function*(){try{return t()}catch(d){n?.releaseLock(),e.error(new o("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:d})),e.close()}function t(){return n?.read().then((({done:d,value:i})=>{if(d){let t;if(a.has_error()&&(t=new o("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:a.error.error_code,errorMessage:a.error.error_message})),n.releaseLock(),t)throw e.error(t),t;return void e.close()}const s=H(a,i,r);return s.length>0&&e.enqueue(s),t()}))}}))()})}throw new o("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:e.text()})}))).apply(this,arguments)}function B(e){return Y.apply(this,arguments)}function Y(){return(Y=t._asyncToGenerator((function*(e){const t=`${e.url}/dataModel/queryDataModel`,r=yield a(t,{responseType:"array-buffer",query:{f:"pbf"}}),n=r.getHeader?.("content-type"),d=r.data;if(n?.includes("application/x-protobuf")){const e=(yield p.getWasmInterface()).decode_data_model_from_protocol_buffer(new Uint8Array(d));return y.wasmToDataModel(e)}throw new o("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:r.data})}))).apply(this,arguments)}e.executeApplyEdits=m,e.executeQuery=_,e.executeQueryStreaming=G,e.executeSearch=k,e.executeSearchStreaming=E,e.fetchKnowledgeGraph=M,e.refreshDataModel=A,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
