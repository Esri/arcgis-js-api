// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["../kernel","./_EventedWidget","./_Tooltip","./VisibleScaleRangeSlider/_RecommendedScaleRangeBounds","./VisibleScaleRangeSlider/_SlideEvent","./VisibleScaleRangeSlider/ScaleMenu","./VisibleScaleRangeSlider/ScalePreview","./VisibleScaleRangeSlider/ScaleRanges","dijit/form/DropDownButton","dijit/popup","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/debounce","dojo/Deferred","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/has","dojo/on","dojo/string","dojox/form/HorizontalRangeSlider","dojo/i18n!../nls/jsapi"],function(e,t,a,i,n,s,l,c,r,o,h,d,u,S,m,_,g,p,f,v,R,x,b,M,w){var I=d([t,a],{declaredClass:"esri.dijit.VisibleScaleRangeSlider",baseClass:"esriVisibleScaleRangeSlider",css:{currentScaleIndicator:"esriCurrentScaleIndicator",currentScaleIndicatorContainer:"esriCurrentScaleIndicatorContainer",scaleIndicator:"esriScaleIndicator",scaleIndicatorContainer:"esriScaleIndicatorContainer"},map:null,layer:null,region:"en-US",minScale:0,maxScale:0,intermediateChanges:!1,labels:w.widgets.visibleScaleRangeSlider,_slider:null,_currentScaleIndicator:null,_scalePreview:null,_maxScaleButton:null,_minScaleButton:null,_mapUpdateHandler:null,_scaleRanges:null,_scheduleScaleRangeChangeEmit:null,_getSliderIndexRange:function(e){var t=Math.floor(e),a=t+.99999;return{min:t,max:a}},_setMapAttr:function(e){this._set("map",e),this._mapUpdateHandler&&this._mapUpdateHandler.remove(),this._slider.set("disabled",!0),this._ensureMapIsReady().then(u.hitch(this,function(){var t,a,i=e.getMinScale(),n=e.getMaxScale();this._slider.set("disabled",!1),this._scaleRanges.set("scaleRangeBounds",{minScale:i,maxScale:n}),t=this._getSliderIndexRange(this._scaleRanges.length-1),this._slider.set("maximum",t.max),this.set("minScale",i),this.set("maxScale",n),this._updateCurrentScaleIndicator(),a=e.on("zoom-end",u.hitch(this,function(){this._updateCurrentScaleIndicator()})),this.own(a),this._mapUpdateHandler=a}))},_ensureMapIsReady:function(){return this._ensureLoadedResource(this.map)},_ensureLoadedResource:function(e){var t=new _;return e?e.loaded?t.resolve():e.on("load",function(){t.resolve()}):t.reject(new Error("could not load resource")),t.promise},_updateCurrentScaleIndicator:function(){var e=this._scaleRanges.clampScale(this.map.getScale()),t=this._mapScaleToSlider(e),a=t/this._slider.maximum;this.isLeftToRight()||(a=1-a),v.set(this._currentScaleIndicator,{left:100*a+"%"})},_setLayerAttr:function(e){this._set("layer",e),this._ensureMapIsReady().then(u.hitch(this,this._ensureLayerIsReady)).then(u.hitch(this,function(){this._updateMinMaxScaleFromLayer(e)}))},_ensureLayerIsReady:function(){return this._ensureLoadedResource(this.layer)},_updateMinMaxScaleFromLayer:function(e){this.set("minScale",e.minScale),this.set("maxScale",e.maxScale)},_mapSliderToScale:function(e){var t=this._getSliderIndexRange(e),a=this._scaleRanges.findScaleRangeByIndex(e),i=a.minScale,n=a.maxScale;return this._mapToRange(e,t.min,t.max,i,n)},_mapToRange:function(e,t,a,i,n){return i+(e-t)*(n-i)/(a-t)},_setRegionAttr:function(e){this._set("region",e),this._scalePreview.set("source",c.getScalePreviewSource(e))},_getMinimumAttr:function(){return this._mapSliderToScale(this._slider.minimum)},_getMaximumAttr:function(){return this._mapSliderToScale(this._slider.maximum)},_getMaxScaleAttr:function(){return this.maxScale},_getActualMaxScaleAttr:function(){return this._scaleRanges.clampMaxScale(this.maxScale)},_setMaxScaleAttr:function(e){this._set("maxScale",e),this._ensureMapIsReady().then(u.hitch(this,function(){e=this._scaleRanges.clampMaxScale(e),this._set("maxScale",this._adjustMaxScale(e)),this._updateSliderSilently({value:this._mapScaleToSlider(e),isMaxVal:!0}),this._scheduleScaleRangeChangeEmit()}))},_updateSliderSilently:function(e){var t=e.value,a=e.isMaxVal;this._slider.set("value",t,!1,a)},_mapScaleToSlider:function(e){var t=this._scaleRanges.scaleToRangeIndex(e),a=this._getSliderIndexRange(t),i=this._scaleRanges.findScaleRangeByIndex(t),n=i.minScale,s=i.maxScale;return this._mapToRange(e,n,s,a.min,a.max)},_getMinScaleAttr:function(){return this.minScale},_getActualMinScaleAttr:function(){return this._scaleRanges.clampMinScale(this.minScale)},_setMinScaleAttr:function(e){this._set("minScale",e),this._ensureMapIsReady().then(u.hitch(this,function(){e=this._scaleRanges.clampMinScale(e),this._set("minScale",this._adjustMinScale(e)),this._updateSliderSilently({value:this._mapScaleToSlider(e),isMaxVal:!1}),this._scheduleScaleRangeChangeEmit()}))},_emitScaleRangeChange:function(){this.emit("scale-range-change",{minScale:this.minScale,maxScale:this.maxScale})},_adjustMinScale:function(e){return this._scaleRanges.beyondMinScale(e)?0:e},_adjustMaxScale:function(e){return this._scaleRanges.beyondMaxScale(e)?0:e},constructor:function(){this._scaleRanges=new(d([c,i])),this._scheduleScaleRangeChangeEmit=m(u.hitch(this,this._emitScaleRangeChange),0)},buildRendering:function(){this.inherited(arguments),this._initSlider(),this._initScalePreview(),this._initScaleIndicators(),this._initScaleMenus()},_initSlider:function(){var e=new d([M,n])({baseClass:"esriHorizontalSlider",showButtons:!1,intermediateChanges:this.intermediateChanges,disabled:!0});this._slider=e,e.placeAt(this.domNode),e.startup(),this.own(e.on("slide-onmousemove, slidemax-onmousemove",u.hitch(this,function(e){this._updateScalePreview(e.movable.handle)})),e.on("slide-onmovestop, slidemax-onmovestop",u.hitch(this,function(e){var t=g.contains(e.movable.handle,"dijitSliderThumbHover");t||this._closeScalePreview()})),e.on("change",u.hitch(this,function(){var e=Math.round(this._mapSliderToScale(this._getSliderMin())),t=Math.round(this._mapSliderToScale(this._getSliderMax()));this.set("minScale",e),this.set("maxScale",t)})),S.after(e,"_setValueAttr",u.hitch(this,this._updateLabelMenus)))},_getSliderMin:function(){var e=this._slider.get("value");return this.isLeftToRight()?e[0]:e[1]},_getSliderMax:function(){var e=this._slider.get("value");return this.isLeftToRight()?e[1]:e[0]},_updateLabelMenus:function(){var e=this._minScaleButton,t=this._maxScaleButton;e.set("label",this._scaleRanges.getScaleRangeLabel(this._getSliderMin())),t.set("label",this._scaleRanges.getScaleRangeLabel(this._getSliderMax()))},_initScalePreview:function(){var e=new l;e.startup(),o.moveOffScreen(e),h.forEach([this._slider._movable.handle,this._slider._movableMax.handle],function(e){e.onmouseenter=u.hitch(this,function(){this._updateScalePreview(e)}),e.onmouseleave=u.hitch(this,function(){this._closeScalePreview()})},this),this.own(e),this._scalePreview=e},_closeScalePreview:function(){o.close(this._scalePreview)},_updateScalePreview:function(e){var t,a,i,n=this._slider,s=this._scalePreview,l=e===n.sliderHandle,c=l?this._getSliderMin():this._getSliderMax(),r=f.position(e),h=f.position(s.domNode),d=f.position(n.sliderBarContainer),u=this.isLeftToRight();s.set("backgroundPosition",this._scaleRanges.getScalePreviewSpriteBackgroundPosition(c)),a=r.x-d.x,i=.5*h.w,t=i>a?u?["above","below"]:["above-alt","below-alt"]:a<d.w-i?["above-centered","below-centered"]:u?["above-alt","below-alt"]:["above","below"],o.open({parent:this,popup:s,around:e,orient:t})},_initScaleIndicators:function(){var e=p.create("div",{className:this.css.scaleIndicatorContainer+" "+this.css.currentScaleIndicatorContainer},this._slider.sliderBarContainer),t=p.create("div",{className:this.css.scaleIndicator+" "+this.css.currentScaleIndicator},e);this._currentScaleIndicator=t,this.createTooltip(t);var a=x(t,"mouseover",u.hitch(this,function(){var e=b.substitute(this.labels.currentScaleTooltip,{scaleLabel:this._scaleRanges.getScaleRangeLabel(this._mapScaleToSlider(this.map.getScale()))});this.findTooltip(t).set("label",e)}));this.own(a)},_initScaleMenus:function(){var e,t,a=new s,i=new s;this.own(a.on("scale-selected",u.hitch(this,function(t){e.closeDropDown(),this.set("minScale",t.scale)}))),this.own(i.on("scale-selected",u.hitch(this,function(e){t.closeDropDown(),this.set("maxScale",e.scale)}))),e=new r({baseClass:"esriScaleMenuButton esriMinScaleMenuButton",dropDown:a,dropDownPosition:["below","above"]}),e.toggleDropDown(),e.toggleDropDown(),t=new r({baseClass:"esriScaleMenuButton esriMaxScaleMenuButton",dropDown:i,dropDownPosition:["below","above"]}),t.toggleDropDown(),t.toggleDropDown(),this.own(S.before(e,"openDropDown",u.hitch(this,function(){var t=this._scaleRanges.findScaleRange(this.get("actualMaxScale")).minScale;a.set("currentScale",{label:e.label,scale:{current:this.get("actualMinScale"),map:this.map.getScale(),min:this.get("minimum"),max:t}})}))),this.own(S.before(t,"openDropDown",u.hitch(this,function(){var e=this._scaleRanges.findScaleRange(this.get("actualMinScale")).maxScale;i.set("currentScale",{label:t.label,scale:{current:this.get("actualMaxScale"),map:this.map.getScale(),min:e,max:this.get("maximum")}})}))),e.placeAt(this.domNode),t.placeAt(this.domNode),a.startup(),i.startup(),e.startup(),t.startup(),this._minScaleButton=e,this._maxScaleButton=t},startup:function(){this.inherited(arguments),this.watch("intermediateChanges",function(e,t,a){this._slider.set(e,a)})}});return R("extend-esri")&&u.setObject("dijit.VisibleScaleRangeSlider",I,e),I});