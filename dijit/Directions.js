// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/array","dojo/_base/Color","dojo/_base/config","dijit/a11yclick","dijit/_TemplatedMixin","dijit/form/Select","dojo/store/Memory","dojo/data/ObjectStore","dojo/keys","dojo/has","dojo/on","dojo/mouse","dojo/dom","dojo/dom-geometry","dojo/dom-style","dojo/dom-class","dojo/dom-attr","dojo/query","dojo/number","dojo/i18n!../nls/jsapi","dojo/text!./templates/Directions.html","./Search","dojo/dom-construct","dojo/promise/all","dojo/Deferred","dojo/dnd/Source","../kernel","../graphic","../units","../InfoTemplate","../SpatialReference","../layers/ArcGISDynamicMapServiceLayer","../geometry/Point","../geometry/Extent","../geometry/Polyline","../geometry/mathUtils","../symbols/PictureMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/TextSymbol","../symbols/Font","./_EventedWidget","../tasks/FeatureSet","../tasks/RouteTask","../tasks/RouteParameters","../tasks/GeometryService","../tasks/PrintTask","../tasks/PrintParameters","../tasks/PrintTemplate","../toolbars/edit","../request","../config","../tasks/ProjectParameters","dojo/uacss"],function(t,e,s,i,o,r,n,a,h,c,l,u,d,p,g,_,m,v,f,S,y,w,C,b,T,D,M,L,E,N,O,R,P,k,G,x,I,A,B,U,j,F,W,H,q,K,V,Z,$,Q,z,Y,X,J,te,ee){var se=e("esri.dijit.Directions",[q,h],{templateString:T,mapClickActive:!1,_eventMap:{activate:!0,deactivate:!1,load:!0,"directions-start":!0,"directions-finish":["result"],"directions-clear":!0,"segment-select":["graphic"],"segment-highlight":["graphic"],error:["error"],"stops-update":["stops"]},_emptyStop:{name:""},constructor:function(e,i){this._css={widgetContainerClass:"esriDirectionsContainer",stopsContainerClass:"esriStopsContainer",reverseStopsClass:"esriStopsReverse",addStopsClass:"esriStopsAdd",stopsClass:"esriStops",stopsRemovableClass:"esriStopsRemovable",stopsButtonContainerClass:"esriStopsButtons",stopsOptionsButtonClass:"esriStopsOptionsButton",stopsAddDestinationClass:"esriStopsAddDestination",stopsAddDestinationBtnClass:"esriStopsAddDestinationBtn",stopsGetDirectionsContainerClass:"esriStopsGetDirectionsContainer",stopsGetDirectionsClass:"esriStopsGetDirections",stopsClearDirectionsClass:"esriStopsClearDirections",stopsInnerGeocoderClass:"esriInnerGeocoder",stopsOptionsOptionsEnabledClass:"esriStopsOptionsEnabled",stopsOptionsMenuClass:"esriStopsOptionsMenu",stopsFindOptimalOrderClass:"esriFindOptimalOrderOption",stopsUseTrafficClass:"esriUseTrafficOption",stopsReturnToStartClass:"esriReturnToStartOption",stopsOptionsCheckboxesClass:"esriOptionsCheckboxes",stopsOptionsToggleContainerClass:"esriOptionsToggleContainer",stopsOptionsUnitsContainerClass:"esriOptionsUnitsContainer",stopsOptionsUnitsMiClass:"esriOptionsUnitsMi",stopsOptionsUnitsKmClass:"esriOptionsUnitsKm",stopsOptionsImpedanceContainerClass:"esriOptionsImpedanceContainer",stopsOptionsImpedanceTimeClass:"esriOptionsImpedanceTime",stopsOptionsImpedanceDistanceClass:"esriOptionsImpedanceDistance",stopClass:"esriStop",stopOriginClass:"esriStopOrigin",stopDestinationClass:"esriStopDestination",stopUnreachedFirstOrLastClass:"esriStopUnreachedFirstOrLast",stopUnreachedClass:"esriStopUnreached",esriStopGeocoderColumnClass:"esriStopGeocoderColumn",esriStopReverseColumnClass:"esriStopReverseColumn",stopDnDHandleClass:"esriStopDnDHandle",stopDnDHandleClassHidden:"esriStopDnDHandleHidden",stopIconColumnClass:"esriStopIconColumn",stopIconClass:"esriStopIcon",stopIconRemoveColumnClass:"esriStopIconRemoveColumn",stopIconRemoveClass:"esriStopIconRemove",stopIconRemoveClassHidden:"esriStopIconRemoveHidden",resultsContainerClass:"esriResultsContainer",resultsLoadingClass:"esriResultsLoading",resultsPrintClass:"esriResultsPrint",resultsSummaryClass:"esriResultsSummary",resultsViewFullRouteClass:"esriResultsViewFullRoute",resultsRouteNameClass:"esriResultsRouteName",resultsRouteButtonContainerClass:"esriResultsButtonsContainer",routesContainerClass:"esriRoutesContainer",routesClass:"esriRoutes",routesErrorClass:"esriRoutesError",routeClass:"esriRoute",routeTextColumnClass:"esriRouteTextColumn",routeTextClass:"esriRouteText",routeLengthClass:"esriRouteLength",routeOriginClass:"esriDMTStopOrigin",routeDestinationClass:"esriDMTStopDestination",routeLastClass:"esriDMTStopLast",routeInfoClass:"esriRouteInfo",routeIconColumnClass:"esriRouteIconColumn",routeIconClass:"esriRouteIcon",infoWindowRouteClass:"esriInfoWindowRoute",routeZoomClass:"esriRouteZoom",esriPrintPageClass:"esriPrintPage",esriPrintBarClass:"esriPrintBar",esriPrintButtonClass:"esriPrintButton",esriCloseButtonClass:"esriCloseButton",esriPrintMainClass:"esriPrintMain",esriPrintHeaderClass:"esriPrintHeader",esriPrintLogoClass:"esriPrintLogo",esriPrintMapClass:"esriPrintMap",esriPrintNameClass:"esriPrintName",esriPrintNotesClass:"esriPrintNotes",esriPrintLengthClass:"esriPrintLength",esriPrintDirectionsClass:"esriPrintDirections",esriPrintFooterClass:"esriPrintFooter",esriPrintStopLabelClass:"esriPrintStopLabel",clearClass:"esriClear",dndDragBodyClass:"esriDndDragDirection",stopsButtonClass:"esriDirectionsButton",stopsButtonTabClass:"esriDirectionsTabButton",stopsButtonTabLastClass:"esriDirectionsTabLastButton",stopsPressedButtonClass:"esriDirectionsPressedButton",linkButtonClass:"esriLinkButton",activateButtonClass:"esriActivateButton",travelModesContainerClass:"esriTravelModesContainer"},this.options={map:null,autoSolve:!0,minStops:2,maxStops:20,theme:"simpleDirections",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",directions:null,returnToStart:!1,optimalRoute:!1,routeTaskUrl:location.protocol+"//route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",printTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",geometryTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",routeParams:{},stops:["",""],searchOptions:{},stopsInfoTemplate:new k("Location","${address}${error}"),segmentInfoTemplate:new k("Route",'<div class="${maneuverType}"><div class="'+this._css.routeIconClass+" "+this._css.infoWindowRouteClass+'"><strong>${step}.</strong> ${formattedText}</div></div>'),textSymbolFont:new H("11px",H.STYLE_NORMAL,H.VARIANT_NORMAL,H.WEIGHT_NORMAL,"Arial, Helvetica, sans-serif"),textSymbolColor:new r([255,255,255]),textSymbolOffset:{x:0,y:10.875},fromSymbol:new j({url:t.toUrl("./images/Directions/greenPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),fromSymbolDrag:new j({url:t.toUrl("./images/Directions/greenPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),stopSymbol:new j({url:t.toUrl("./images/Directions/bluePoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),stopSymbolDrag:new j({url:t.toUrl("./images/Directions/bluePointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),toSymbol:new j({url:t.toUrl("./images/Directions/redPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),toSymbolDrag:new j({url:t.toUrl("./images/Directions/redPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),unreachedSymbol:new j({url:t.toUrl("./images/Directions/grayPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),unreachedSymbolDrag:new j({url:t.toUrl("./images/Directions/grayPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),routeSymbol:(new F).setColor(new r([0,69,117,1])).setWidth(4),segmentSymbol:(new F).setColor(new r([0,122,194,1])).setWidth(8),printPage:"",printTemplate:"",autoCenterAtSegmentStart:!0,focusOnNewStop:!0,dragging:!0,canModifyStops:!0,directionsLengthUnits:null,directionsLanguage:null,traffic:!1,trafficLayer:null,showPrintPage:!0,showSegmentPopup:!0,showSegmentHighlight:!0,showReverseStopsButton:!0,showReturnToStartOption:!0,showOptimalRouteOption:!0,showTravelModesOption:!0,showMilesKilometersOption:!0,showClearButton:!1,showActivateButton:!0},this.defaults=s.mixin({},this.options,e),this._sortId="_dndId_"+this.id,this._stopReference="_dndStop_"+this.id,this._i18n=b,this.domNode=i},postCreate:function(){this.inherited(arguments),this.own(g(this._activateButtonNode,a,s.hitch(this,function(){this.mapClickActive?this.deactivate():this.activate()}))),this.own(g(this._addDestinationNode,a,s.hitch(this,this._addStopButton))),this.own(g(this._optionsButtonNode,a,s.hitch(this,this._toggleOptionsMenu))),this.own(g(this._findOptimalOrderNode,a,s.hitch(this,this._toggleCheckbox))),this.own(g(this._returnToStartNode,a,s.hitch(this,this._toggleCheckbox))),this.own(g(this._useTrafficNode,a,s.hitch(this,this._toggleCheckbox))),this.own(g(this._useMilesNode,a,s.hitch(this,this._toggleUnits))),this.own(g(this._useKilometersNode,a,s.hitch(this,this._toggleUnits))),this.own(g(this._getDirectionsButtonNode,a,s.hitch(this,this.getDirections))),this.own(g(this._clearDirectionsButtonNode,a,s.hitch(this,function(){this.clearDirections(),this.onDirectionsClear()}))),this._setWidgetProperties(),this._activate(this.mapClickActive)},startup:function(){return this.inherited(arguments),this._enqueue(this._init)},destroy:function(){this._disconnectEvents(),M.empty(this.domNode),this.inherited(arguments)},activate:function(){return this._enqueue(function(){this.set("mapClickActive",!0)})},deactivate:function(){return this._enqueue(function(){this.set("mapClickActive",!1)})},clearDirections:function(){return this._enqueue(function(){return this.clearErrors(),this._clearDirections()})},reset:function(){return this._enqueue(this._reset)},onActivate:function(){},onDeactivate:function(){},onLoad:function(){},onDirectionsStart:function(){this._clearDisplayBeforeSolve(),this.set("solving",!0),this._showLoadingSpinner(!0)},onDirectionsFinish:function(){this._showLoadingSpinner(!1),this.set("solving",!1)},onDirectionsClear:function(){},onSegmentSelect:function(){},onSegmentHighlight:function(){},onStopsUpdate:function(){},onError:function(){},removeStops:function(){return this.reset()},removeStop:function(t){return this._enqueue(function(){return this.clearErrors(),this._removeStop(t)})},updateStops:function(t){return this._enqueue(function(){return this._updateStops(t)})},addStops:function(t,e){return this._enqueue(function(){return this._addStops(t,e)})},addStop:function(t,e){return this._enqueue(function(){return this._addStop(t,e)})},updateStop:function(t,e){return this._enqueue(function(){return this._updateStop(t,e)})},clearErrors:function(){this.errors=[],this._errorNode&&(this._errorNode.innerHTML="")},getDirections:function(){return this._enqueue(function(){return this._getDirections().then(s.hitch(this,function(){this.zoomToFullRoute()}))})},unhighlightSegment:function(){this.get("map")&&this.get("map").graphics&&this.get("showSegmentHighlight")&&(this.get("map").graphics.remove(this._segmentGraphic),this._segmentGraphic=null)},highlightSegment:function(t){"undefined"==typeof t&&(t=0);var e=this.get("directions").features[t],s=new B(e.geometry),i=s.getPoint(0,0),o=s.getPoint(0,1),r=U.getLength(i,o);r||(s=i),this.unhighlightSegment(),this._segmentGraphic=new R(s,this.get("segmentSymbol"),e.attributes,this.get("segmentInfoTemplate")),this._segmentGraphic&&this.get("map")&&this.get("map").graphics&&this.get("showSegmentHighlight")&&this.get("map").graphics.add(this._segmentGraphic)},zoomToSegment:function(t){if("undefined"==typeof t&&(t=0),this.get("map")){var e=this.get("directions").features[t],i=e.geometry,o=new B(i),r=o.getExtent(),n=this.get("map").setExtent(r,!0);return n.then(s.hitch(this,function(){this._showSegmentPopup(e,t)})),n.promise}return null},centerAtSegmentStart:function(t){if("undefined"==typeof t&&(t=0),this.get("map")){var e=this.get("directions").features[t],i=e.geometry,o=i.getPoint(0,0),r=this.get("map").centerAt(o);r.then(s.hitch(this,function(){this._showSegmentPopup(e,t)}))}},zoomToFullRoute:function(){return this.get("map")&&this.get("directions")?(this._clearInfoWindow(),this.unhighlightSegment(),this.get("map").setExtent(this.get("directions").extent,!0)):null},setListIcons:function(){var t,e=this._dnd.getAllNodes();for(t=0;t<e.length;t++){var s=w("."+this._css.stopIconClass,e[t])[0];s&&(s.innerHTML=this._getLetter(t)),S.remove(e[t],this._css.stopOriginClass+" "+this._css.stopDestinationClass+" "+this._css.stopUnreachedClass+" "+this._css.stopUnreachedFirstOrLastClass);var i=this.stopGraphics&&this.stopGraphics[t]&&this.stopGraphics[t].attributes?this.stopGraphics[t].attributes.Status:void 0,o=i>0&&6>i;0===t?S.add(e[t],o?this._css.stopUnreachedFirstOrLastClass:this._css.stopOriginClass):t!==e.length-1||this._startReturn?o&&S.add(e[t],this._css.stopUnreachedClass):S.add(e[t],o?this._css.stopUnreachedFirstOrLastClass:this._css.stopDestinationClass)}var r=w("[data-reverse-td]",this._dndNode)[0];M.destroy(r),this.get("showReverseStopsButton")&&M.create("td",{"data-reverse-td":"true",rowspan:e.length,className:this._css.esriStopReverseColumnClass,innerHTML:'<div role="button" class="'+this._css.reverseStopsClass+'" data-reverse-stops="true" title="'+b.widgets.directions.reverseDirections+'"></div>',onmouseover:function(t){t.stopPropagation()},onmouseout:function(t){t.stopPropagation()}},e[0])},addRouteSymbols:function(){if(this.stopGraphics.length&&this.get("map")&&this.get("map").graphics)for(var t=0;t<this.stopGraphics.length;t++)if(this.stopGraphics[t]){this.get("map").graphics.add(this.stopGraphics[t]);var e=this.stopGraphics[t].getDojoShape();e&&e.moveToFront(),this.get("map").graphics.add(this.textGraphics[t]);var s=this.textGraphics[t].getDojoShape();s&&s.moveToFront()}},createRouteSymbols:function(){this._clearStopGraphics();for(var t=this.get("stops"),e=0;e<t.length;e++){var s=t[e];if(s&&s.feature){var i=s.feature.attributes?s.feature.attributes.Status:void 0,o=this._setStopSymbol(e,t.length+(this._startReturn?1:0),!1,i),r=this._defaultSR;this.get("map")&&(r=this.get("map").spatialReference);var n=new I(s.feature.geometry.x,s.feature.geometry.y,r),a=this._getLetter(e),h=new W(a,this.get("textSymbolFont"),this.get("textSymbolColor"));this.get("textSymbolOffset")&&h.setOffset(this.get("textSymbolOffset").x,this.get("textSymbolOffset").y);var c=new R(n,h);c._textGraphic=!0,c._index=e;var l=s.feature.attributes,u=new R(n,o,{address:s.name,Status:i,SourceID:l&&l.SourceID?l.SourceID:null,SourceOID:l&&l.SourceOID?l.SourceOID:null,PosAlong:l&&l.PosAlong?l.PosAlong:null,SideOfEdge:l&&l.SideOfEdge?l.SideOfEdge:null},this.get("stopsInfoTemplate"));u._drag=!0,u._index=e,this.stopGraphics[e]=u,this.textGraphics[e]=c}}this.set("stopGraphics",this.stopGraphics),this.set("textGraphics",this.textGraphics),this.addRouteSymbols(),this.setListIcons()},setTravelMode:function(t){return this._enqueue(function(){return this.clearErrors(),this._travelModeSelector.setValue(t),this._setTravelMode(t)})},getSupportedTravelModeNames:function(){var t=[],e=this.serviceDescription;if(e&&e.supportedTravelModes&&e.supportedTravelModes.length)for(var s=e.supportedTravelModes,i=0;i<s.length;i++)t.push(s[i].name);return t},setDirectionsLengthUnits:function(){var t=1===arguments.length?arguments[0]:this.get("directionsLengthUnits");return this._enqueue(function(){return this.clearErrors(),this._setDirectionsLengthUnits(t)})},setDirectionsLanguage:function(){var t=1===arguments.length?arguments[0]:this.get("directionsLanguage");return this._enqueue(function(){return this.clearErrors(),this._setDirectionsLanguage(t)})},useMyCurrentLocation:function(t){return this._enqueue(function(){return this.clearErrors(),this._createLocateButton(this.geocoders[t],!0,!0)})},_reset:function(){return this._setWidgetProperties(),this._init()},_activate:function(){var t=this.get("mapClickActive");this._addStopOnMapClickListener&&this._addStopOnMapClickListener.remove(),t?(this.map&&(this.map.activeDirectionsWidget&&this.map.activeDirectionsWidget!==this&&this.map.activeDirectionsWidget.deactivate(),this.map.activeDirectionsWidget=this,this._addStopOnMapClickListener=g(this.map,"click",s.hitch(this,function(t){this.addStop(new R(t.mapPoint))}))),S.add(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onActivate()):(S.remove(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onDeactivate()),this.emit("map-click-active",{mapClickActive:this.mapClickActive})},_destroyGeocoders:function(){var t=this.get("geocoders");if(t&&t.length)for(var e=0;e<t.length;e++)t[e]&&t[e].destroy();this.set("geocoders",[])},_disconnectEvents:function(){var t,e=this._clearDirections(!0);if(this._watchEvents&&this._watchEvents.length)for(t=0;t<this._watchEvents.length;t++)this._watchEvents[t].unwatch();if(this._onEvents&&this._onEvents.length)for(t=0;t<this._onEvents.length;t++)this._onEvents[t].remove();if(this._geocoderFindEvents&&this._geocoderFindEvents.length)for(t=0;t<this._geocoderFindEvents.length;t++)this._geocoderFindEvents[t].remove();if(this._geocoderWatchEvents&&this._geocoderWatchEvents.length)for(t=0;t<this._geocoderWatchEvents.length;t++)this._geocoderWatchEvents[t].unwatch();if(this._geocoderSelectEvents&&this._geocoderSelectEvents.length)for(t=0;t<this._geocoderSelectEvents.length;t++)this._geocoderSelectEvents[t].remove();return this._onEvents=[],this._watchEvents=[],this._geocoderSelectEvents=[],this._geocoderFindEvents=[],this._geocoderWatchEvents=[],this._disconnectResults(),this._destroyGeocoders(),this._destroyGlobalGeocoder(),this._destroyDnD(),e},_getDirections:function(){this._removeEmptyStops();var t=new E;return this._calculateValidStops()>=this.get("minStops")?(this.onDirectionsStart(),this.clearErrors(),this._dnd.sync(),this._sortGeocoders(),this._getCandidates(this.get("stops")).then(s.hitch(this,function(e){this.stops=e,this._setStops();var i=this._validateStops(e);if(i.error){var o=b.widgets.directions.error.locator,r=this.get("geocoders")[i.index];r&&(o=b.widgets.directions.error.unknownStop.replace("<name>",r.get("value"))),this._resultError(o),this.set("directions",null),this._clearRouteGraphics(),t.reject(o),this.onDirectionsFinish(new Error([o]))}else this._configureRoute().always(s.hitch(this,function(e){t.resolve(e)}))}),s.hitch(this,function(e){this.set("directions",null),this._clearRouteGraphics(),t.reject(e),this.onDirectionsFinish(e)}))):this._clearDirections(!0).always(s.hitch(this,function(){this.createRouteSymbols(),t.reject(b.widgets.directions.error.notEnoughStops)})),t.promise},_clearDirections:function(){var t=new E;return this.get("routeParams")&&this.get("routeParams").stops?this.get("routeParams").stops.features.length?(this.get("routeParams").stops.features=[],t.resolve()):arguments.length?t.resolve():this._reset().then(t.resolve,t.reject):t.resolve(),this.set("directions",null),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this._removeTrafficLayer(),t.promise},_setTravelMode:function(t){var e,s,i,o=new E,r=this.serviceDescription;if(r&&r.supportedTravelModes&&r.supportedTravelModes.length){var n=r.supportedTravelModes,a=!1;for(e=0;e<n.length;e++)if(n[e].name===t){if(a=!0,!this.routeParams.travelMode||this.routeParams.travelMode&&this.routeParams.travelMode.name!==t){for(this.routeParams.travelMode=n[e].impedanceAttributeName?n[e]:n[e].itemId,s=0;s<this.stops.length;s++)this.stops[s].feature&&(i=this.stops[s].feature.attributes,i.SourceID=null,i.SourceOID=null,i.PosAlong=null,i.SideOfEdge=null);this._solveAndZoom().always(function(){o.resolve(t)})}else o.resolve(t);if(this._useTrafficNode){var h="TravelTime"===n[e].impedanceAttributeName||!n[e].impedanceAttributeName&&"Driving Time"===n[e].name;this._useTrafficNode.disabled=!h,!h&&this._useTrafficNode.checked&&this._removeTrafficLayer()}break}a||o.reject(t)}else o.reject(t);return o.promise},_setDirectionsLengthUnits:function(t){var e=new E;return S.remove(this._useMilesNode,this._css.stopsPressedButtonClass),S.remove(this._useKilometersNode,this._css.stopsPressedButtonClass),t===P.KILOMETERS?S.add(this._useKilometersNode,this._css.stopsPressedButtonClass):t===P.MILES&&S.add(this._useMilesNode,this._css.stopsPressedButtonClass),t===P.KILOMETERS||t===P.METERS||t===P.MILES||t===P.FEET||t===P.NAUTICAL_MILES?(this.directionsLengthUnits=t,this.autoSolve?this._getDirections().always(function(){e.resolve(t)}):e.resolve(t)):e.reject(t),e.promise},_setDirectionsLanguage:function(t){var e=new E;return t=this._setDirectionsLanguageByLocale(t),this.autoSolve?this._getDirections().always(function(){e.resolve(t)}):e.resolve(t),e.promise},_showLoadingSpinner:function(t){void 0===t&&(t=this._requestQueueTail&&!this._requestQueueTail.isFulfilled()),t?S.add(this._widgetContainer,this._css.resultsLoadingClass):S.remove(this._widgetContainer,this._css.resultsLoadingClass)},_enqueue:function(t){var e=new E;return this._requestQueueTail||(this._requestQueueTail=new E,this._requestQueueTail.resolve()),this._requestQueueTail.promise.always(s.hitch(this,function(){try{var i=t.call(this);i&&"object"==typeof i&&i.hasOwnProperty("isFulfilled")?i.then(s.hitch(this,function(t){e.resolve(t),this._showLoadingSpinner()}),s.hitch(this,function(t){e.reject(t),this._showLoadingSpinner()})):(e.resolve(i),this._showLoadingSpinner())}catch(o){e.reject(o),this._showLoadingSpinner()}})),this._requestQueueTail=e,this._showLoadingSpinner(),e.promise},_createDnD:function(){this._dnd=new N(this._dndNode,{skipForm:!0,withHandles:!0})},_destroyDnD:function(){M.empty(this._dndNode),this._dnd&&(this._dnd.destroy(),this._dnd=null)},_usingAGOL:function(){return this.get("routeTaskUrl").search(/^(https?:)*\/\/route*[^.]*\.arcgis\.com.*$/i)>-1},_setSearchOptions:function(){var t={maxResults:1},e={map:this.get("map"),autoNavigate:!1,enableInfoWindow:!1,enableHighlight:!1,enableSourcesMenu:!0};this.searchOptions=s.mixin(t,this.defaults.searchOptions,e)},_setDefaultUnits:function(){if(this.get("directionsLengthUnits"))this.setDirectionsLengthUnits(this.directionsLengthUnits);else{var t="EN-US"===i.locale.toUpperCase()?P.MILES:P.KILOMETERS;this.defaults.directionsLengthUnits&&(t=this.defaults.directionsLengthUnits),this.set("directionsLengthUnits",t)}},_setTrafficOptions:function(){this.set("showTrafficOption",(this.defaults.showTrafficOption||!this.defaults.hasOwnProperty("showTrafficOption"))&&"esriNTSHistoricalAndLive"===this.serviceDescription.trafficSupport),this._usingAGOL()&&this.get("showTrafficOption")&&(this.get("trafficLayer")||this.set("trafficLayer",new x(location.protocol+"//traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",{opacity:.4}))),this._optionsMenu()},_updateCanModifyStops:function(){this.get("canModifyStops")?this._showAddDestination():this._hideAddDestination()},_setWidgetProperties:function(){this._disconnectEvents(),this.set("loaded",!1),this.set(this.defaults),this.set("stops",[]),this._defaultSR=new G(4326),this._updateCanModifyStops()},_updateStops:function(t){var e=new E;return t?this.get("loaded")?this._reset().then(s.hitch(this,function(){this._addStops(t).then(e.resolve,e.reject)}),e.reject):this._addStops(t).then(e.resolve,e.reject):e.reject(),e.promise},_removeStop:function(t){var e=new E;if(0>t||t>=this.stops.length)return e.reject(),e.promise;var s;if(this.stops.length>this.get("minStops")){"undefined"==typeof t&&(t=this.stops.length-1),s=this.stops.splice(t,1),this._setStops();var i=this._dnd.getAllNodes(),o=i[t],r=this.get("geocoders");r[t].destroy(),r.splice(t,1),this.set("geocoders",r),this._geocoderSelectEvents[o.id].remove(),this._geocoderWatchEvents[o.id].unwatch(),M.destroy(o),this._dnd.sync(),this._stopsRemovable(),this._optionsMenu(),this._checkMaxStops(),this.setListIcons(),this._sortGeocoders()}else if(t>=0){s=this.stops.splice(t,1);for(var n=t;n<this.get("minStops")-1;n++)this.geocoders[n].set("value",this.geocoders[n+1].get("value"));this.geocoders[n].set("value","")}return this._solveAndZoom().always(function(){e.resolve(s,t)}),e.promise},_removeTrafficLayer:function(){var t=this.get("trafficLayer"),e=this.get("map");t&&e&&e.removeLayer(t),this._trafficLayerAdded=!1},_addStops:function(t,e){var i=new E,o=[];this.autoSolve=!1;for(var r=0;r<Math.min(t.length,this.maxStops-this.stopGraphics.length);r++){var n=new E;this._addStop(t[r],void 0===e?r:e+r).always(n.resolve),o.push(n)}return L(o).always(s.hitch(this,function(){this.autoSolve=!0,this._getDirections().always(function(){i.resolve(t)})})),i.promise},_addStop:function(t,e){var i=new E;return this._checkMaxStops(),this.maxStopsReached?(this._resultError(b.widgets.directions.error.maximumStops),i.reject(b.widgets.directions.error.maximumStops)):this._getCandidate(t).then(s.hitch(this,function(t){this._insertStop(t,e),this.autoSolve&&t!==this._emptyStop?this._getDirections().always(function(){i.resolve(t,e)}):i.resolve(t,e)}),s.hitch(this,function(t){i.reject(t)})),i.promise},_removeEmptyStops:function(){if(this.stops.length>this.get("minStops"))for(var t=this.stops.length-1;this.stops.length>this.get("minStops")&&t>-1;t--){var e=this.stops[t];e&&e.name||this._removeStop(t)}},_setReverseGeocode:function(t,e,s){if(t.feature.geometry&&s>-1){var i={address:t.name};this.stopGraphics[s]&&(this.stopGraphics[s].setAttributes(i),this.stopGraphics[s].setGeometry(e)),this.textGraphics[s]&&(this.textGraphics[s].setAttributes(i),this.textGraphics[s].setGeometry(e)),this.set("stopGraphics",this.stopGraphics),this.set("textGraphics",this.textGraphics),this._moveInProgress||this._unsetDraggableObject(this._dragGraphic),this.get("geocoders")[s]&&this.get("geocoders")[s].set("value",t.name),this.stops[s]=t,this.stops[s].feature.setGeometry(e),this._setStops(),this.autoSolve&&this._getDirections()}},_insertStop:function(t,e){var s,i;if(void 0===e){for(s=0;s<this.geocoders.length;s++)if(!this.geocoders[s].get("value")){i=this.geocoders[s];break}}else s=e,this.geocoders[s]&&!this.geocoders[s].get("value")&&(i=this.geocoders[s]);!i||void 0!==e&&e!==s?(void 0===e&&(e=this.geocoders.length),this._createGeocoder(t,e)):(i.set("value",t.name),this.stops[s]=t,i[this._stopReference]=t)},_createGeocoder:function(t,e){var i=this._dnd.getAllNodes(),r=!1,n=!1,a=i.length;i[e]?(n=i[e],r=!0):(n=!1,r=!1);var h=s.hitch(this,function(t,e){var s=e?this._css.stopDnDHandleClass:this._css.stopDnDHandleClassHidden,i=e?this._css.stopDnDHandleClassHidden:this._css.stopDnDHandleClass;S.replace(t.children[0],s,i),this.geocoders.length>2&&(s=e?this._css.stopIconRemoveClass:this._css.stopIconRemoveClassHidden,i=e?this._css.stopIconRemoveClassHidden:this._css.stopIconRemoveClass,S.replace(t.children[3].children[0],s,i))}),c=M.create("tr",{className:this._css.stopClass,onmouseover:function(){h(this,!0)},onmouseout:function(){h(this,!1)}}),l=(M.create("td",{className:this._css.stopDnDHandleClassHidden+" dojoDndHandle"},c),M.create("td",{className:this._css.stopIconColumnClass},c));M.create("div",{className:this._css.stopIconClass+" dojoDndHandle",innerHTML:this._getLetter(a),"data-center-at":"true"},l);var u=M.create("td",{className:this._css.esriStopGeocoderColumnClass},c),d=M.create("div",{},u);if(this.get("canModifyStops")){var p=M.create("td",{className:this._css.stopIconRemoveColumnClass},c);M.create("div",{className:this._css.stopIconRemoveClassHidden,role:"button","data-remove":"true"},p)}this._dnd.insertNodes(!1,[c],r,n),this.stops.splice(e,0,t);var g=s.mixin({},this.get("searchOptions"),{value:t.name}),_=new D(g,d);_[this._sortId]=c.id,_[this._stopReference]=t;var m=this.get("geocoders");m.splice(e,0,_),_.startup(),this.set("geocoders",m);var v=s.hitch(this,function(t){if(t&&(t.results||t.result)){var e=this._dnd.getAllNodes(),s=o.indexOf(e,c),i=!0;t.results&&t.results.results&&t.results.results.length?(this._setStops(),this.stops[s]=t.results.results[0]):t.result?(this._setStops(),this.stops[s]=t.result):(this._removeStopButton(s),this.set("directions",null),this._resultError(b.widgets.directions.error.unknownStop.replace("<name>",t.target.get("value"))),this._clearRouteGraphics(),i=!1),i&&this._solveAndZoom()}}),f=_.on("select-result",v);this._geocoderSelectEvents[c.id]=f;var y=_.watch("value",s.hitch(this,function(t,e,s){if(s!==e){var i=this._dnd.getAllNodes(),r=o.indexOf(i,c);this.stops[r]&&s!==this.stops[r].name&&(this.stops[r]={name:s},this._setStops())}}));this._geocoderWatchEvents[c.id]=y,this._checkMaxStops(),this.setListIcons(),this.get("focusOnNewStop")&&_.focus(),this._stopsRemovable(),this._optionsMenu(),this._sortGeocoders()},_removeLocateButtonVisibilityEvents:function(){for(var t=0;t<this.geocoders.length;t++){var e=this.geocoders[t];e._onMouseEnter&&e._onMouseEnter.remove(),e._onMouseOut&&e._onMouseOut.remove(),e._onKeyPress&&e._onKeyPress.remove(),e._locateButton&&(e._locateButton._onMouseEnter&&e._locateButton._onMouseEnter.remove(),e._locateButton._onMouseOut&&e._locateButton._onMouseOut.remove())}},_setLocateButtonVisibilityEvents:function(){this._removeLocateButtonVisibilityEvents();for(var t=this,e=0;e<this.geocoders.length;e++){var i=this.geocoders[e];if(i.inputNode._geocoder=i,i._onMouseEnter=g(i.inputNode,_.enter,function(e){e instanceof FocusEvent?this._geocoder._lbShown_f=!0:this._geocoder._lbShown_g=!0,t._createLocateButton(this._geocoder,!0)}),i._onMouseOut=g(i.inputNode,[_.leave,"blur"],function(e){e instanceof FocusEvent?this._geocoder._lbShown_f=!1:this._geocoder._lbShown_g=!1,clearTimeout(this._destroyTimeout),this._destroyTimeout=setTimeout(s.hitch(this,function(){this._geocoder._lbShown_lb||this._geocoder._lbShown_f||t._destroyLocateButton(this._locateButton)}),400)}),i._onKeyPress=g(i.inputNode,"keydown",function(){this._geocoder._lbShown_g=!0,clearTimeout(this._destroyTimeout),this._destroyTimeout=setTimeout(s.hitch(this,function(){""===this.value?t._createLocateButton(this._geocoder,!0):t._destroyLocateButton(this._locateButton)}),400)}),i.inputNode._locateButton){var o=i.inputNode._locateButton;o._onMouseEnter=g(o.domNode,_.enter,function(){this._geocoder._lbShown_lb=!0,clearTimeout(this._geocoder._destroyTimeout)}),o._onMouseOut=g(o.domNode,_.leave,function(){this._geocoder._lbShown_lb=!1,clearTimeout(this._geocoder._destroyTimeout),this._geocoder._destroyTimeout=setTimeout(s.hitch(this,function(){this._geocoder._lbShown_g||this._geocoder._lbShown_f||t._destroyLocateButton(this._geocoder.inputNode._locateButton)}),400)})}}},_createLocateButton:function(e,i,r){var n=new E,h=e;return h.inputNode._locateButton&&h.inputNode._locateButton._locating?n.resolve():t(["./LocateButton"],s.hitch(this,function(t){if(this._destroyLocateButton(h.inputNode._locateButton),h){var e=M.create("div",{},h.domNode);S.add(h.domNode,this._css.stopsInnerGeocoderClass);var c=new t({map:this.map,highlightLocation:!1,centerAt:!1,setScale:!1,useTracking:!1},e);c.startup(),h.inputNode._locateButton=c,c.domNode._geocoder=h,this._setLocateButtonVisibilityEvents();var l=s.hitch(this,function(){c._locating=!0,h.set("value",""),h.inputNode.placeholder=b.widgets.directions.retrievingMyLocation.toUpperCase()});c._onBeforeLocate=g(c._locateNode,a,l),c._onLocate=g(c,"locate",s.hitch(this,function(t){c._locating=!1,t.graphic?(i&&this._destroyLocateButton(h.inputNode._locateButton),this._updateStop(new R(t.graphic.geometry),o.indexOf(this.geocoders,h)).then(s.hitch(this,function(){this.stopGraphics.length>1?this._solveAndZoom().always(function(){n.resolve(t)}):n.resolve(t)}))):(h.set("value",""),h.inputNode.placeholder=b.widgets.directions.myLocationError.toUpperCase(),console.error(t.error),n.reject(t.error))})),r?(l(),c.locate()):n.resolve()}else n.reject()})),n.promise},_destroyLocateButton:function(t){if(t){var e=t.domNode._geocoder;clearTimeout(e._destroyTimeout),t._locating?e._destroyTimeout=setTimeout(s.hitch(this,function(){e._lbShown_lb||e._lbShown_f||this._destroyLocateButton(t)}),100):(t.clear(),t._onBeforeLocate.remove(),t._onLocate.remove(),t._onMouseEnter&&t._onMouseEnter.remove(),t._onMouseOut&&t._onMouseOut.remove(),t.destroy(),e.inputNode&&(e.inputNode._locateButton=null,e._setPlaceholder(e.activeSourceIndex)))}},_validateStops:function(t){if(t)for(var e=0;e<t.length;e++)if(!t[e]||!t[e].feature)return{error:!0,index:e};
return{error:!1}},_sortStops:function(){this.stops.length&&(this.stops.sort(s.hitch(this,function(t,e){for(var s,i,o=0;o<this.get("geocoders").length;o++)this.geocoders[o][this._stopReference]===t?s=o:this.geocoders[o][this._stopReference]===e&&(i=o);return s>i?1:i>s?-1:0})),this._setStops())},_getCandidate:function(t){var e=new E,i=typeof t;if(t)if("object"===i&&t.hasOwnProperty("feature")&&t.hasOwnProperty("name"))t.name=String(t.name),e.resolve(t);else if("object"===i&&t.hasOwnProperty("address")&&t.hasOwnProperty("location")){var o=this._globalGeocoder._hydrateResult(t);e.resolve(o)}else"object"===i&&t.hasOwnProperty("name")&&!t.name?e.resolve(this._emptyStop):("object"===i&&t.hasOwnProperty("name")&&(t=String(t.name)),this._globalGeocoder?this._globalGeocoder.search(t).then(s.hitch(this,function(s){if(s&&(s.results&&s.results[0]&&s.results[0][0]||s[0]&&s[0][0])){var i=s.results?s.results[0][0]:s[0][0];i.name&&(i.name=String(i.name)),!t.geometry||isNaN(t.geometry.x)||isNaN(t.geometry.y)||this.map.spatialReference.wkid!==t.geometry.spatialReference.wkid?!i.feature.geometry||isNaN(i.feature.geometry.x)||isNaN(i.feature.geometry.y)?(this._resultError(b.widgets.directions.error.locator),e.reject(b.widgets.directions.error.locator)):e.resolve(i):(i.feature.geometry=t.geometry,e.resolve(i))}else t instanceof I?t=new R(t):t instanceof Array&&(t=new R(new I(t[0],t[1]))),t instanceof R?this._decorateUngeocodedStop(t).then(e.resolve,e.reject):(this._resultError(b.widgets.directions.error.unknownStop.replace("<name>",t.toString())),e.reject(b.widgets.directions.error.unknownStop.replace("<name>",t.toString())))})):(this._resultError(b.widgets.directions.error.locatorUndefined),e.reject(b.widgets.directions.error.locatorUndefined)));else e.resolve(this._emptyStop);return e.promise},_updateStopInsert:function(t,e){this.get("geocoders")[e]&&(this.get("geocoders")[e].set("value",t.name),this.stops[e]=t,this._setStops())},_updateStop:function(t,e){var i=new E;return this.stops?("undefined"==typeof e&&(e=this.stops.length-1),this._getCandidate(t).then(s.hitch(this,function(t){this._updateStopInsert(t,e),i.resolve(t)}),s.hitch(this,function(t){i.reject(t)}))):i.reject("could not update stop"),i.promise},_renderDirections:function(){var t=this.get("directions"),e="";if(this._resultsNode){if(e+='<div class="'+this._css.resultsRouteNameClass+'">',e+=t.routeName,e+="</div>",e+='<div class="'+this._css.clearClass+'"></div>',t.totalLength||t.totalTime){var i=this._formatDistance(t.totalLength,!0),r=this._formatTime(t.totalTime);e+='<div class="'+this._css.resultsSummaryClass+'">',i&&(e+=i),i&&r&&(e+=" &middot; "),r&&(e+=r),e+="</div>"}e+='<div class="'+this._css.clearClass+'"></div>',e+='<div class="'+this._css.resultsRouteButtonContainerClass+'">',e+='<div tabindex="0" role="button" class="'+this._css.linkButtonClass+" "+this._css.resultsViewFullRouteClass+'" data-full-route="true">'+b.widgets.directions.viewFullRoute+"</div>",this.get("showPrintPage")&&(e+='<div tabindex="0" role="button" title="'+b.widgets.directions.print+'" class="'+this._css.resultsPrintClass+'" data-print-directions="true"></div>'),e+='<div class="'+this._css.clearClass+'"></div>',e+="</div>",e+='<div class="'+this._css.routesClass+'">',e+='<table summary="'+t.routeName+'">',e+='<tbody role="menu">';var n=function(t,e,s){for(var i=0;i<t.length;i++){var o=t[i].feature.attributes;if(o&&o.Sequence===e)return 0===o.Status||6===o.Status?e:n(t,e+1)}return s?1:n(t,1,!0)},a=n(this.stops,1);o.forEach(t.features,s.hitch(this,function(s,i){var o=this._css.routeClass;s.attributes&&(s.attributes.step=i+1),s.attributes.maneuverType&&(o+=" "+s.attributes.maneuverType),0===i&&1===a?o+=" "+this._css.routeOriginClass:i===t.features.length-1&&(o+=" "+this._css.routeDestinationClass),i===t.features.length-1&&(o+=" "+this._css.routeLastClass),e+='<tr tabindex="0" role="menuitem" class="'+o+" "+this._css.routeZoomClass+'" data-segment="'+i+'">',e+='<td class="'+this._css.routeIconColumnClass+'">',e+='<div class="'+this._css.routeIconClass+'">',"esriDMTDepart"===s.attributes.maneuverType?(a=n(this.stops,a),e+=this._getLetter(a-1),a++):"esriDMTStop"===s.attributes.maneuverType&&(a=n(this.stops,a),e+=this._getLetter(a-1)),e+="</div>",e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">',e+='<div class="'+this._css.routeInfoClass+'">',e+='<div class="'+this._css.routeTextClass+'">';var r,h=t.strings[i];if(h){var c=s.attributes.text;for(r=0;r<h.length;r++)c=this._boldText(c,h[r].string);s.attributes.formattedText=c}else s.attributes.formattedText=s.attributes.text;e+="<strong>"+C.format(s.attributes.step)+".</strong> "+s.attributes.formattedText,e+="</div>";var l=this._formatDistance(s.attributes.length,!1),u=this._formatTime(s.attributes.time);l&&(e+='<div class="'+this._css.routeLengthClass+'">',e+=l,u&&(e+=" "+u),e+="</div>"),e+="</div>",e+="</td>",e+="</tr>"})),e+="</tbody>",e+="</table>",e+="</div>",this._resultsNode&&(this._resultsNode.innerHTML=e),this._disconnectResults();var h=w("[data-segment]",this._resultsNode);h&&h.length&&o.forEach(h,s.hitch(this,function(e){var i=g(e,_.enter,s.hitch(this,function(){var s=parseInt(y.get(e,"data-segment"),10);this.highlightSegment(s),this.onSegmentHighlight(t.features[s])}));this._resultEvents.push(i);var o=g(e,"focusin",s.hitch(this,function(){var s=parseInt(y.get(e,"data-segment"),10);this.highlightSegment(s),this.onSegmentHighlight(t.features[s])}));this._resultEvents.push(o);var r=g(e,"focusout",s.hitch(this,function(){this.unhighlightSegment()}));this._resultEvents.push(r);var n=g(e,_.leave,s.hitch(this,function(){this.unhighlightSegment()}));if(this._resultEvents.push(n),this.get("autoCenterAtSegmentStart")){var a=g(e,"click, keydown",s.hitch(this,function(s){if(s&&("click"===s.type||"keydown"===s.type&&s.keyCode===d.ENTER)){var i=parseInt(y.get(e,"data-segment"),10);this.centerAtSegmentStart(i),this.onSegmentSelect(t.features[i])}}));this._resultEvents.push(a)}}))}},_showRoute:function(t){if(!this._moveInProgress){this.editToolbar.deactivate(),this._clearDisplayAfterSolve(),this.set("solveResult",t);var e=t.routeResults[0].directions;this.set("directions",e);var i=t.routeResults[0].stops;if(i&&i.length){var r,n=[],a=i.length;for(this._startReturn&&a--,r=0;a>r;r++){var h=i[r],c={extent:new A({xmin:h.geometry.x-.25,ymin:h.geometry.y-.25,xmax:h.geometry.x+.25,ymax:h.geometry.y+.25,spatialReference:h.geometry.spatialReference}),feature:h,name:h.attributes.Name};n.push(c)}for(this.stops=n,r=0;r<this.stops.length;r++)this._updateStop(this.stops[r],r);this._setStops()}if(this.set("mergedRouteGraphic",new R(e.mergedGeometry,this.get("routeSymbol"))),this.get("map")&&this.get("map").graphics){var l=[];o.forEach(e.features,s.hitch(this,function(t){t.setSymbol(this.get("routeSymbol")),this.get("map").graphics.add(t),l.push(t);var e=t.getDojoShape();e&&e.moveToBack()})),this.set("displayedRouteGraphics",l)}this.createRouteSymbols(),this._renderDirections(),this.onDirectionsFinish(t)}},_setGeocodersStopReference:function(){if(this.geocoders)for(var t=0;t<this.geocoders.length;t++)this.geocoders[t]&&this.stops[t]&&(this.geocoders[t][this._stopReference]=this.stops[t])},_setStops:function(){this._setGeocodersStopReference(),this.createRouteSymbols(),this._set("stops",this.stops),this.onStopsUpdate(this.stops)},_getCandidates:function(t){var e=[];if(t&&t.length){for(var s=0;s<t.length;s++)e.push(this._getCandidate(t[s]));return L(e)}var i=new E;return i.resolve([]),i.promise},_clearResultsHTML:function(){this._resultsNode&&(this._resultsNode.innerHTML="")},_showSegmentPopup:function(t){if(t&&this.get("showSegmentPopup")&&this.get("map")&&this.get("map").infoWindow){var e=t.geometry,s=e.getPoint(0,0),i=new R(s,null,t.attributes,this.get("segmentInfoTemplate"));this.get("map").infoWindow.setFeatures([i]),this.get("map").infoWindow.show(s)}},_removeStopButton:function(t){this.stops.length>this.get("minStops")?this.removeStop(t):(this._setStops(),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve())},_addStopButton:function(){this.addStop(void 0,this.stops.length)},_sortGeocoders:function(){var t=this._dnd.getAllNodes();this.geocoders.sort(s.hitch(this,function(e,s){return this._sortGeocodersToNodes(e,s,t,this._sortId)})),this._sortStops();for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].inputNode.title=b.widgets.directions.stopNoTitle+(e+1);this._setLocateButtonVisibilityEvents()},_disconnectResults:function(){if(this._resultEvents&&this._resultEvents.length)for(var t=0;t<this._resultEvents.length;t++)this._resultEvents[t]&&this._resultEvents[t].remove();this._resultEvents=[]},_formatTime:function(t){var e,s,i="",o=Math.round(t);return e=Math.floor(o/60),s=Math.floor(o%60),e&&(i+=e+" ",i+=e>1?b.widgets.directions.time.hours:b.widgets.directions.time.hour),e&&s&&(i+=" "),s&&(i+=s+" ",i+=s>1?b.widgets.directions.time.minutes:b.widgets.directions.time.minute),i},_formatDistance:function(t,e){var s=this._getUnits(this.get("directionsLengthUnits")),i=b.widgets.directions.units[s];s=i?e?i.name:i.abbr:s.replace("esri","").toLowerCase();var o=Math.round(100*t)/100;return 0===o?"":C.format(o)+" "+s},_setMoveSymbol:function(t){this._moveSymbolSet=!0;var e=this._setStopSymbol(t._index,this.stopGraphics.length,!0,t.attributes.Status);t.setSymbol(e)},_unsetMoveSymbol:function(t){var e=this._setStopSymbol(t._index,this.stopGraphics.length,!1,t.attributes.Status);t.setSymbol(e),this._moveSymbolSet=!1},_removeTextGraphic:function(t){var e=this.textGraphics[t];this.get("map").graphics.remove(e)},_setDraggableObject:function(t){t._drag&&this.get("map")&&this.get("map").graphics&&(this.get("map")._directionsWidgetDragging=!0,this._removeTextGraphic(t._index),this._dragGraphic=t,this._dragGeometry=t.geometry,this.editToolbar.activate(X.MOVE,t))},_setTextGraphic:function(t){if(t._drag&&this.get("map")&&this.get("map").graphics){var e=this.textGraphics[t._index];e.setGeometry(t.geometry),this.get("map").graphics.add(e);var s=e.getDojoShape();s&&s.moveToFront()}},_unsetDraggableObject:function(t){t._drag&&(this.get("map")._directionsWidgetDragging=!1,this._moveSymbolSet&&this._unsetMoveSymbol(t),this._setTextGraphic(t),this.editToolbar.deactivate())},_isMyStopGraphic:function(t){return o.indexOf(this.get("stopGraphics"),t)>-1||o.indexOf(this.get("textGraphics"),t)>-1},_editToolbar:function(){this.get("map")?this.set("editToolbar",new X(this.get("map"))):this.set("editToolbar",null)},_destroyGlobalGeocoder:function(){this._globalGeocoder&&(this._globalGeocoder.destroy(),this._globalGeocoder=null)},_createGlobalGeocoder:function(){var t=new E;return this._globalGeocoder=new D(this.get("searchOptions")),g.once(this._globalGeocoder,"load",s.hitch(this,function(){t.resolve()},function(e){t.reject(e)})),this._globalGeocoder.startup(),t.promise},_init:function(){var t=new E;return this.set("loaded",!1),this.clearErrors(),this.get("map")?this.get("map").loaded?this._configure().always(t.resolve):g.once(this.get("map"),"load",s.hitch(this,function(){this._configure().always(t.resolve)})):this._configure().always(t.resolve),t.promise},_setDefaultStops:function(){var t=new E;return this.defaults.stops&&this.defaults.stops.length?this._updateStops(this.defaults.stops).then(s.hitch(this,function(){this.get("focusOnNewStop")&&this.get("geocoders")&&this.get("geocoders").length&&this.get("geocoders")[0].focus(),this._removeEmptyStops(),t.resolve()}),t.reject):t.resolve(),t.promise},_configure:function(){var t=new E;return this._createDnD(),this._setSearchOptions(),this._createGlobalGeocoder().then(s.hitch(this,function(){this._editToolbar(),this._usingAGOL()||(this.geometryTaskUrl=null,this.printTaskUrl=null),this._createGeometryTask(),this._createPrintTask(),this._showActivateButton(),this._createTravelModesDDL();var e=[this._createRouteTask(),this._setDefaultStops()];L(e).then(s.hitch(this,function(){this._setDefaultUnits(),this._setTrafficOptions(),this._setMenuNodeValues(),this._setupEvents(),this._setDirectionsLanguageByLocale(this.directionsLanguage?this.directionsLanguage:i.locale.toLowerCase()),this._setupTravelModes().then(s.hitch(this,function(){this.set("loaded",!0),this.onLoad(),t.resolve(!0)}),function(e){t.reject(e)})}),function(e){t.reject(e)})}),function(e){t.reject(e)}),t.promise},_setDirectionsLanguageByLocale:function(t){var e=this.serviceDescription.directionsSupportedLanguages,s=function(t){if(e)for(var s=0;s<e.length;s++)if(e[s].toLowerCase().substr(0,2)===t)return e[s];return null},i=s(t);return i||(t=t.substr(0,2),i=s(t)),this.directionsLanguage=i,this.routeParams.directionsLanguage=i,i},_calculateValidStops:function(){for(var t=0,e=this.stops,s=0;s<e.length;s++)e[s]&&e[s].name&&t++;return t},_setStopSymbol:function(t,e,s,i){return this.get(void 0===i||0===i||6===i?0===t?s?"fromSymbolDrag":"fromSymbol":t===e-1?s?"toSymbolDrag":"toSymbol":s?"stopSymbolDrag":"stopSymbol":s?"unreachedSymbolDrag":"unreachedSymbol")},_addTrafficLayer:function(){var t=this.get("trafficLayer"),e=this.get("map");e&&t&&!this._trafficLayerAdded&&(e.addLayer(t),t.show(),this._trafficLayerAdded=!0)},_toggleUnits:function(t){t.target===this._useMilesNode?this.setDirectionsLengthUnits(P.MILES):t.target===this._useKilometersNode&&this.setDirectionsLengthUnits(P.KILOMETERS)},_toggleCheckbox:function(t){var e=y.get(t.target,"checked");t.target===this._findOptimalOrderNode?this.set("optimalRoute",e):t.target===this._useTrafficNode?this.set("traffic",e):t.target===this._returnToStartNode&&this.set("returnToStart",e)},_configureRouteOptions:function(){var t=this.get("routeParams");if(this.get("directionsLengthUnits")?t.directionsLengthUnits=this.get("directionsLengthUnits"):this.set("directionsLengthUnits",t.directionsLengthUnits),t.findBestSequence=this.get("optimalRoute"),t.returnStops=!0,this.get("traffic")?(t.startTime=new Date,t.startTimeIsUTC=!0,this._addTrafficLayer()):(t.startTime=null,t.startTimeIsUTC=null,this._removeTrafficLayer()),this.get("returnToStart")&&this.stopGraphics.length){var e=new R(this.stopGraphics[0].geometry,null,this.stopGraphics[0].attributes),s=this.stopGraphics.slice(0);this._startReturn=e,s.push(e),t.stops.features=s}else this._startReturn=null,t.stops.features=this.stopGraphics;this.set("routeParams",t)},_configureRoute:function(){var t=new E;return this.createRouteSymbols(),this._configureRouteOptions(),this.routeTask.solve(this.routeParams,s.hitch(this,function(e){this._showRoute(e),t.resolve(e)}),s.hitch(this,function(e){for(var i=0;i<this.stops.length;i++)this.stops[i].feature.attributes=s.mixin(this.stops[i].feature.attributes,{Status:5});this.set("directions",null),this._clearDisplayAfterSolve(),this.createRouteSymbols(),this._routeTaskError(e),t.reject(e)})),t.promise},_boldText:function(t,e){return t.replace(new RegExp("(^|\\s)("+e+")(\\s|$)","ig"),"$1<strong>$2</strong>$3")},_clearStopGraphics:function(){if(this.stopGraphics&&this.stopGraphics.length&&this.get("map")&&this.get("map").graphics)for(var t=0;t<this.stopGraphics.length;t++)this.get("map").graphics.remove(this.stopGraphics[t]),this.get("map").graphics.remove(this.textGraphics[t]);this.set("stopGraphics",[]),this.set("textGraphics",[])},_clearRouteGraphics:function(){var t=this.get("displayedRouteGraphics"),e=this.get("map");t&&t.length&&e&&e.graphics&&(o.forEach(t,function(t){e.graphics.remove(t)}),this.set("displayedRouteGraphics",[])),this.unhighlightSegment()},_clearInfoWindow:function(){this.get("map")&&this.get("map").infoWindow&&(this.get("map").infoWindow.hide(),this.get("map").infoWindow.features&&this.get("map").infoWindow.clearFeatures())},_clearDisplayBeforeSolve:function(){this._clearInfoWindow(),this._clearResultsHTML()},_clearDisplayAfterSolve:function(){this._clearStopGraphics(),this._clearRouteGraphics(),this.clearErrors()},_getLetter:function(t){var e=this.get("alphabet"),s="";return e&&e.length&&(t=t||0,t>=e.length&&(s=this._getLetter(Math.floor(t/this.alphabet.length)-1),t%=this.alphabet.length),"string"==typeof e?s+=e.substr(t,1):e instanceof Array&&(s+=e[t])),s},_solveAndZoom:function(){if(this.autoSolve)return this._getDirections().then(s.hitch(this,function(){this.zoomToFullRoute()}));var t=new E;return t.resolve(),t.promise},_setupEvents:function(){var t=g(this._dndNode,"[data-reverse-stops]:click, [data-reverse-stops]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)&&this._reverseStops()}));this._onEvents.push(t);var e=g(this._resultsNode,"[data-print-directions]:click, [data-print-directions]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)&&this._printDirections()}));this._onEvents.push(e);var i=g(this._resultsNode,"[data-full-route]:click, [data-full-route]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)&&this.zoomToFullRoute()}));this._onEvents.push(i);var r=g(this._dndNode,"[data-remove]:click, [data-remove]:keydown",s.hitch(this,function(t){if(t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)){var e=w("[data-remove]",this._dndNode),s=o.indexOf(e,t.target);this._removeStopButton(s)}}));this._onEvents.push(r),this._onEvents.push(g(this._dndNode,"[data-center-at]:click, [data-center-at]:keydown",s.hitch(this,function(t){if(t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)){var e=w("[data-center-at]",this._dndNode),s=o.indexOf(e,t.target);this.stops[s]&&this.stops[s].feature&&this.stops[s].feature.geometry&&this.map.centerAndZoom(this.stops[s].feature.geometry)}})));var n=g(this._dnd,"Drop",s.hitch(this,function(){this._dnd.sync(),this._sortGeocoders(),this.setListIcons(),this._calculateValidStops()===this.get("geocoders").length&&this.get("routeParams").stops.features.length&&this._solveAndZoom()}));this._onEvents.push(n);var a=g(this._dnd,"DndStart",s.hitch(this,function(){var t=w("body")[0];S.add(t,this._css.dndDragBodyClass),this._removeLocateButtonVisibilityEvents()}));this._onEvents.push(a);var h=g(this._dnd,"DndDrop, DndCancel",s.hitch(this,function(){var t=w("body")[0];S.remove(t,this._css.dndDragBodyClass),this._setLocateButtonVisibilityEvents()}));if(this._onEvents.push(h),this.get("map")&&this.get("map").graphics){var c=this.get("map").graphics.on("mouse-over",s.hitch(this,function(t){if(this.get("dragging")&&!this.get("map")._directionsWidgetDragging){var e;this._isMyStopGraphic(t.graphic)&&(t.graphic._drag?(e=this.editToolbar.getCurrentState(),e.graphic||this._setDraggableObject(t.graphic),this._moveSymbolSet||this._setMoveSymbol(t.graphic)):t.graphic._textGraphic&&(e=this.editToolbar.getCurrentState(),this.stopGraphics[t.graphic._index]&&(e.graphic||this._setDraggableObject(this.stopGraphics[t.graphic._index]),this._moveSymbolSet||this._setMoveSymbol(this.stopGraphics[t.graphic._index]))))}}));this._onEvents.push(c);var l=this.get("map").graphics.on("mouse-out",s.hitch(this,function(t){this.get("dragging")&&this._isMyStopGraphic(t.graphic)&&!this._moveInProgress&&t.graphic._drag&&this._unsetDraggableObject(t.graphic)}));this._onEvents.push(l),this._editToolbarEvents()}var u=this.watch("theme",this._updateThemeWatch);this._watchEvents.push(u);var p=this.watch("canModifyStops",this._updateCanModifyStops);this._watchEvents.push(p);var _=this.watch("showReturnToStartOption",this._optionsMenu);this._watchEvents.push(_);var m=this.watch("showOptimalRouteOption",this._optionsMenu);this._watchEvents.push(m);var v=this.watch("returnToStart",this._setMenuNodeValues);this._watchEvents.push(v);var f=this.watch("optimalRoute",this._setMenuNodeValues);this._watchEvents.push(f);var y=this.watch("routeTaskUrl",s.hitch(this,function(){this._createRouteTask(),this._setTrafficOptions()}));this._watchEvents.push(y),this._watchEvents.push(this.watch("printTaskUrl",s.hitch(this,function(){this._createPrintTask()}))),this._watchEvents.push(this.watch("geometryTaskUrl",s.hitch(this,function(){this._createGeometryTask()})));var C=this.watch("routeParams",s.hitch(this,function(){this._createRouteParams(),this._setDefaultUnits()}));this._watchEvents.push(C);var b=this.watch("searchOptions",s.hitch(this,function(){this._setSearchOptions(),this._createGlobalGeocoder();var t=this.get("searchOptions").sources;if(t)for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].set("sources",t)}));this._watchEvents.push(b);var T=this.watch("showReverseStopsButton",this.setListIcons);this._watchEvents.push(T);var D=this.watch("showPrintPage",this._renderDirections);this._watchEvents.push(D);var M=this.watch("trafficLayer",this._trafficLayerUpdate);this._watchEvents.push(M);var L=this.watch("editToolbar",this._editToolbarEvents);this._watchEvents.push(L);var E=this.watch("showTravelModesOption",this._showTravelModesOption);this._watchEvents.push(E);var N=this.watch("showMilesKilometersOption",this._showMilesKilometersOption);this._watchEvents.push(N);var O=this.watch("showClearButton",this._showClearButton);this._watchEvents.push(O);var R=this.watch("directionsLengthUnits",this.setDirectionsLengthUnits);this._watchEvents.push(R),this._watchEvents.push(this.watch("directionsLanguage",this.setDirectionsLanguage)),this._watchEvents.push(this.watch("mapClickActive",this._activate)),this._watchEvents.push(this.watch("showActivateButton",this._showActivateButton))},_editToolbarEvents:function(){var t=g(this.editToolbar,"graphic-click",s.hitch(this,function(t){this.get("map")&&this.get("map").infoWindow&&(this.get("map").infoWindow.setFeatures([t.graphic]),this.get("map").infoWindow.show(t.graphic.geometry))}));this._onEvents.push(t);var e=g(this.editToolbar,"graphic-first-move",s.hitch(this,function(){this._moveInProgress=!0}));this._onEvents.push(e);var i=g(this.editToolbar,"graphic-move-stop",s.hitch(this,function(t){this._moveInProgress=!1,this._unsetDraggableObject(t.graphic),this._dragGeometry!==t.graphic.geometry&&(this._currentEditableGraphic=t.graphic,this.get("autoSolve")&&this.onDirectionsStart(),this._globalGeocoder.search(t.graphic.geometry).always(s.hitch(this,function(e){e&&e.results&&(e=e.results),e&&e[0]&&e[0][0]?this._setReverseGeocode(e[0][0],t.graphic.geometry,o.indexOf(this.stopGraphics,t.graphic)):this._decorateUngeocodedStop(t.graphic).then(s.hitch(this,function(e){this._setReverseGeocode(e,e.feature.geometry,o.indexOf(this.stopGraphics,t.graphic))}))})))}));this._onEvents.push(i)},_decorateUngeocodedStop:function(e){var i=new E,o=function(t,s){i.resolve({name:void 0===t?b.widgets.directions.unlocatedStop:t.toFixed(6)+" "+s.toFixed(6),feature:e})};if(e.geometry)if(e.geometry.spatialReference&&4326!==e.geometry.spatialReference.wkid)if(this.map&&this.map.spatialReference&&this.map.spatialReference.isWebMercator())t(["../geometry/webMercatorUtils"],function(t){var s=t.xyToLngLat(e.geometry.x,e.geometry.y);o(s[0],s[1])});else if(this._geometryService){var r=new ee;r.outSR=new G(4326),r.geometries=[e.geometry],this._geometryService.project(r).then(s.hitch(this,function(t){t&&t.length?o(t[0].x,t[0].y):o(e.geometry.x,e.geometry.y)}),s.hitch(this,function(){o()}))}else o(e.geometry.x,e.geometry.y);else o(e.geometry.x,e.geometry.y);else o();return i.promise},_trafficLayerUpdate:function(){var t=arguments[1],e=arguments[2],s=this.get("map");t&&s&&this._trafficLayerAdded&&(s.removeLayer(t),this._trafficLayerAdded=!1),e&&s&&this.get("traffic")&&!this._trafficLayerAdded&&(s.addLayer(e),e.show(),this._trafficLayerAdded=!0)},_reverseGeocodeError:function(t){this.onDirectionsFinish(t);var e=b.widgets.directions.error.locator;this._resultError(e),this._clearRouteGraphics(),this._currentEditableGraphic.setAttributes({error:e});var s=this._currentEditableGraphic._index;this._updateStop({name:""},s)},_routeTaskError:function(t){var e=b.widgets.directions.error.routeTask,s=t.details;s&&1===s.length&&("The distance between any inputs must be less than 50 miles (80 kilometers) when walking."===s[0]?e=b.widgets.directions.error.maxWalkingDistance:"Driving a truck is currently not supported outside of North America and Central America."===s[0]&&(e=b.widgets.directions.error.nonNAmTruckingMode)),this._resultError(e),this.onDirectionsFinish(t)},_resultError:function(t){var e="";if(this.errors.push(t),e+='<div class="'+this._css.routesErrorClass+'">',this.errors.length){e+="<ul>";for(var s=0;s<this.errors.length;s++)e+="<li>"+this.errors[s]+"</li>";e+="</ul>"}e+="</div>",this._errorNode&&(this._errorNode.innerHTML=e),this.onError(t)},_getUnits:function(t){switch(t){case P.KILOMETERS:return"KILOMETERS";case P.METERS:return"METERS";case P.NAUTICAL_MILES:return"NAUTICAL_MILES";case P.MILES:return"MILES";default:return t}},_createRouteTask:function(){var t=new E;return this.set("routeTask",new V(this.get("routeTaskUrl"))),this._createRouteParams(),this.routeTask.getServiceDescription(this.travelModesServiceUrl,this.doNotFetchTravelModesFromOwningSystem).then(s.hitch(this,function(e){e.networkDataset?(this.set("serviceDescription",e),e.serviceLimits&&e.serviceLimits.Route_MaxStops&&this.set("maxStops",e.serviceLimits.Route_MaxStops),t.resolve()):(this._resultError(b.widgets.directions.error.cantFindRouteServiceDescription),t.reject(b.widgets.directions.error.cantFindRouteServiceDescription))}),s.hitch(this,function(){this._resultError(b.widgets.directions.error.cantFindRouteServiceDescription),t.reject(b.widgets.directions.error.cantFindRouteServiceDescription)})),t.promise},_createTravelModesDDL:function(){this._travelModeSelector||(this._travelModeSelector=new c({className:"esriTravelModesDDL",style:"width:100%;"},this._travelModeSelectorContainer),this._travelModeSelector.startup(),this._travelModeSelector._interractive=!0,this._travelModeSelector.on("change",s.hitch(this,function(t){this._travelModeSelector._interractive&&this._enqueue(function(){return this.clearErrors(),this._setTravelMode(t)})})))},_setupTravelModes:function(){var t=this.get("serviceDescription"),e=t.supportedTravelModes,i=new E;if(e&&e.length&&this._travelModeSelector){for(var o=e[0].name,r=[],n=0;n<e.length;n++){for(var a="AUTOMOBILE"===e[n].type?"Driving":"TRUCK"===e[n].type?"Trucking":"WALK"===e[n].type?"Walking":"Other",h="",c=t.networkDataset.networkAttributes,d=0;d<c.length;d++){var p=c[d];if(p.name===e[n].impedanceAttributeName){"esriNAUCentimeters"===p.units||"esriNAUDecimalDegrees"===p.units||"esriNAUDecimeters"===p.units||"esriNAUFeet"===p.units||"esriNAUInches"===p.units||"esriNAUKilometers"===p.units||"esriNAUMeters"===p.units||"esriNAUMiles"===p.units||"esriNAUMillimeters"===p.units||"esriNAUNauticalMiles"===p.units||"esriNAUYards"===p.units?h="Distance":("esriNAUDays"===p.units||"esriNAUHours"===p.units||"esriNAUMinutes"===p.units||"esriNAUSeconds"===p.units)&&(h="Time");break}}r.push({id:e[n].name,label:'<div class="esriTravelModesDirectionsIcon esriTravelModesType'+a+h+'">&nbsp;</div><div class="esriTravelModesTypeName">'+e[n].name+"</div>"}),!t.defaultTravelMode||e[n].id!==t.defaultTravelMode&&e[n].itemId!==t.defaultTravelMode||(o=e[n].name)}this._showTravelModesOption(),this._travelModeSelector.setStore(new u({objectStore:new l({data:r})})),this._travelModeSelector._interractive=!1,this._travelModeSelector.setValue(o),this._setTravelMode(o).always(s.hitch(this,function(){this._travelModeSelector._interractive=!0,i.resolve()}))}else this.set("showTravelModesOption",!1),i.resolve();return i.promise},_createPrintTask:function(){this.printTaskUrl=this._usingAGOL()?this.printTaskUrl:this.defaults.printTaskUrl,this._printService=this.printTaskUrl?new Q(this.printTaskUrl,{async:!1}):null;var t=new Y;t.exportOptions={width:670,height:750,dpi:96},t.format="PNG32",t.layout="MAP_ONLY",t.preserveScale=!1,t.showAttribution=!1;var e=new z;e.map=this.map,e.outSpatialReference=this.map.spatialReference,e.template=t,this._printParams=e},_createGeometryTask:function(){this._geometryService=null,this._usingAGOL()?this._geometryService=new $(this.geometryTaskUrl):(this._geometryService=this.defaults.geometryTaskUrl?new $(this.defaults.geometryTaskUrl):te.defaults.geometryService,this.geometryTaskUrl=this._geometryService?this._geometryService.url:null)},_showTravelModesOption:function(){var t=this.get("serviceDescription"),e=this.showTravelModesOption&&t&&t.supportedTravelModes&&t.supportedTravelModes.length&&!this.doNotFetchTravelModesFromOwningSystem;f.set(this._travelModeContainerNode,"display",e?"block":"none")},_showMilesKilometersOption:function(){f.set(this._agolDistanceUnitsNode,"display",this.showMilesKilometersOption?"block":"none")},_showClearButton:function(){f.set(this._clearDirectionsButtonNode,"display",this.showClearButton?"inline-block":"none")},_showActivateButton:function(){f.set(this._activateButtonNode,"display",this.showActivateButton?"inline-block":"none"),this.showActivateButton||this.deactivate()},_createRouteParams:function(){var t={returnRoutes:!1,preserveFirstStop:!0,preserveLastStop:!0,ignoreInvalidLocations:!0},e={directionsOutputType:"complete",stops:new K,returnDirections:!0,outputLines:"esriNAOutputLineTrueShape",doNotLocateOnRestrictedElements:!0};e.outSpatialReference=this.get("map")?this.get("map").spatialReference:this._defaultSR,this.get("routeParams")||(this.routeParams={});var i=new Z;this.routeParams=s.mixin(i,t,this.get("routeParams"),e)},_reverseStops:function(){var t=this._dnd.getAllNodes();t.length&&(this._removeLocateButtonVisibilityEvents(),t.reverse(),this._dnd.clearItems(),this._dnd.insertNodes(!1,t),this._dnd.sync(),this._stopsRemovable(),this._optionsMenu(),this._checkMaxStops(),this.setListIcons(),this._sortGeocoders(),this._solveAndZoom())},_sortGeocodersToNodes:function(t,e,s,i){for(var r=t[i],n=e[i],a=m.byId(r),h=m.byId(n),c=o.indexOf(s,a),l=o.indexOf(s,h),u=0;u<s.length;u++){if(u===c)return-1;if(u===l)return 1}},_setMenuNodeValues:function(){var t=this.get("optimalRoute");this._findOptimalOrderNode&&y.set(this._findOptimalOrderNode,"checked",t);var e=this.get("returnToStart");this._returnToStartNode&&y.set(this._returnToStartNode,"checked",e);var s=this.get("traffic");this._useTrafficNode&&y.set(this._useTrafficNode,"checked",s);var i=this.get("directionsLengthUnits");switch(i){case P.KILOMETERS:y.set(this._useKilometersNode,"checked",!0),y.set(this._useMilesNode,"checked",!1);break;case P.MILES:y.set(this._useKilometersNode,"checked",!1),y.set(this._useMilesNode,"checked",!0)}this._showMilesKilometersOption(),this._showClearButton()},_optionsMenu:function(){if(this._useTrafficItemNode&&f.set(this._useTrafficItemNode,"display",this.get("showTrafficOption")?"block":"none"),this._returnToStartItemNode&&f.set(this._returnToStartItemNode,"display",this.get("showReturnToStartOption")?"block":"none"),this._findOptimalOrderItemNode&&f.set(this._findOptimalOrderItemNode,"display",this.get("showOptimalRouteOption")&&this.stops.length>=4?"block":"none"),this.stops.length>=this.get("minStops"))S.add(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass);else{if(S.remove(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass),this._optionsMenuNode){var t=f.get(this._optionsMenuNode,"display");"block"===t&&this._toggleOptionsMenu()}this._configureRouteOptions()}},_stopsRemovable:function(){this.get("geocoders").length>this.get("minStops")?S.add(this._widgetContainer,this._css.stopsRemovableClass):S.remove(this._widgetContainer,this._css.stopsRemovableClass)},_checkMaxStops:function(){this.stops.length<this.get("maxStops")?(this._showAddDestination(),this.set("maxStopsReached",!1)):(this._hideAddDestination(),this.set("maxStopsReached",!0))},_updateThemeWatch:function(){var t=arguments[1],e=arguments[2];S.remove(this.domNode,t),S.add(this.domNode,e)},_toggleOptionsMenu:function(){if(this._optionsMenuNode){var t=f.get(this._optionsMenuNode,"display");"block"===t?(f.set(this._optionsMenuNode,"display","none"),this._optionsButtonNode.innerHTML=b.widgets.directions.showOptions):(f.set(this._optionsMenuNode,"display","block"),this._optionsButtonNode.innerHTML=b.widgets.directions.hideOptions)}},_hideAddDestination:function(){S.remove(this._widgetContainer,this._css.addStopsClass)
},_showAddDestination:function(){S.add(this._widgetContainer,this._css.addStopsClass)},_getAbsoluteUrl:function(e){return e=t.toUrl(e),/^https?\:/i.test(e)?e:/^\/\//i.test(e)?window.location.protocol+e:/^\//i.test(e)?window.location.protocol+"//"+window.location.host+e:e},_getManeuverImage:function(t){if(t){var e="./images/Directions/maneuvers/",s=".png";return"esriDMTStop"===t||"esriDMTDepart"===t?"":this._getAbsoluteUrl(e+t+s)}return""},_loadPrintDirections:function(t){var e=this.get("printTemplate");if(!e){var i,r=this._getAbsoluteUrl("./css/Directions.css"),n=this._getAbsoluteUrl("./css/DirectionsPrint.css"),a=this._getAbsoluteUrl("./images/Directions/print-logo.png");i=v.isBodyLtr()?"ltr":"rtl",e="",e+="<!DOCTYPE HTML>",e+='<html lang="en" class="'+this.get("theme")+'" dir="'+i+'">',e+="<head>",e+='<meta charset="utf-8">',e+='<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">',e+="<title>"+this.get("directions").routeName+"</title>",e+='<link rel="stylesheet" media="screen" type="text/css" href="'+r+'" />',e+='<link rel="stylesheet" media="print" type="text/css" href="'+n+'" />',e+="</head>",e+='<body class="'+this._css.esriPrintPageClass+'">',e+='<div class="'+this._css.esriPrintBarClass+'">',e+='<div class="'+this._css.esriCloseButtonClass+'" title="'+b.common.close+'" onclick="window.close();">'+b.common.close+"</div>",e+='<div id="printButton" class="'+this._css.esriPrintButtonClass+'" title="'+b.widgets.directions.print+'" onclick="window.print();">'+b.widgets.directions.print+"</div>",e+="</div>",e+='<div class="'+this._css.esriPrintMainClass+'">',e+='<div class="'+this._css.esriPrintHeaderClass+'">',e+='<img class="'+this._css.esriPrintLogoClass+'" src="'+a+'" />',e+='<div class="'+this._css.esriPrintNameClass+'">'+this.get("directions").routeName+"</div>",e+='<div class="'+this._css.esriPrintLengthClass+'">'+this._formatDistance(this.get("directions").totalLength,!0)+". "+this._formatTime(this.get("directions").totalTime)+"</div>",t&&(e+='<div id="divMap" class="esriPrintMap esriPrintWait"></div>',e+='<hr class="esriNoPrint"/>'),e+='<div id="print_helper"></div>',e+='<textarea onkeyup="document.getElementById(\'print_helper\').innerHTML=this.value;" id="print_area" class="'+this._css.esriPrintNotesClass+'" placeholder="'+b.widgets.directions.printNotes+'"></textarea>',e+='<div class="'+this._css.clearClass+'"></div>',e+="</div>",e+='<div class="'+this._css.esriPrintDirectionsClass+'">',e+="<table>",e+="<tbody>";var h=0;o.forEach(this.get("directions").features,s.hitch(this,function(t,s){var i,o=this.get("directions").strings[s];if(o){var r=t.attributes.text;for(i=0;i<o.length;i++)r=this._boldText(r,o[i].string);t.attributes.formattedText=r}else t.attributes.formattedText=t.attributes.text;var n="";this.get("directions").features.length===s+1&&(n=this._css.routeLastClass),t.attributes&&(t.attributes.step=s+1),e+='<tr class="'+n+'">',e+='<td class="'+this._css.routeIconColumnClass+'">';var a,c=this._getManeuverImage(t.attributes.maneuverType);0===s?(a=this._getLetter(h),h++):"esriDMTStop"===t.attributes.maneuverType?a=this._getLetter(h):"esriDMTDepart"===t.attributes.maneuverType&&(a=this._getLetter(h),h++),c?e+='<img src="'+c+'" />':a&&(e+='<div class="'+this._css.esriPrintStopLabelClass+'">',e+=a,e+="</div>"),e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">',e+="<div><strong>"+C.format(t.attributes.step)+".</strong> "+t.attributes.formattedText+"</div>",e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">',e+='<div class="'+this._css.routeLengthClass+'">'+this._formatDistance(t.attributes.length,!1)+"</div>",e+="</td>",e+="</tr>"})),e+="</tbody>",e+="</table>",e+="</div>",e+='<div class="'+this._css.esriPrintFooterClass+'">',e+="<p>"+b.widgets.directions.printDisclaimer+"</p>",e+="</div>",e+="</div>",e+="</body>",e+="</html>"}this._printWindow.document.open("text/html","replace"),this._printWindow.document.write(e),this._printWindow.document.close()},_printDirections:function(){var e=screen.width/2,i=screen.height/1.5,o=screen.width/2-e/2,r=screen.height/2-i/2,n="toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=yes, resizable=yes, width="+e+", height="+i+", top="+r+", left="+o;this.get("printPage")?(window.directions=this.get("directions"),window.open(this.get("printPage"),"directions_widget_print",n,!0)):(this._printWindow=window.open("","directions_widget_print",n,!0),this._loadPrintDirections(!!this._printService),this._printService&&t(["dojo/_base/window"],s.hitch(this,function(t){this.zoomToFullRoute().then(s.hitch(this,function(){this._printService.execute(this._printParams,s.hitch(this,function(e){t.withDoc(this._printWindow.document,function(){var t=m.byId("divMap");t&&(S.remove(t,"esriPrintWait"),S.add(t,"esriPageBreak"),M.create("img",{src:e.url,"class":"esriPrintMapImg"},t))})}),s.hitch(this,function(e){t.withDoc(this._printWindow.document,function(){var t=m.byId("divMap");t&&S.remove(t,"esriPrintWait")}),console.log("Error while calling print service:\n "+e)}))}))})))}});return p("extend-esri")&&s.setObject("dijit.Directions",se,O),se});