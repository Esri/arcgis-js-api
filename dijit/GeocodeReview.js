// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

define(["require","dojo/on","dojo/Evented","dojo/has","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/text!./GeocodeReview/templates/Review.html","dojo/i18n!../nls/jsapi","dojo/store/Memory","dojo/string","dojo/dom","dojo/dom-style","dojo/dom-class","dijit/_WidgetBase","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dgrid/OnDemandGrid","dgrid/Selection","dgrid/Keyboard","dgrid/editor","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","../graphic","../geometry/Extent","../geometry/Point","../geometry/webMercatorUtils","../symbols/PictureMarkerSymbol","../tasks/query","../layers/FeatureLayer","../layers/GraphicsLayer","../request","../arcgis/utils","../kernel","dijit/layout/StackController","dijit/layout/StackContainer","dijit/layout/ContentPane","dijit/layout/BorderContainer"],(function(e,t,i,r,a,s,o,d,n,h,c,l,u,f,_,g,w,y,p,m,v,b,L,C,R,M,S,k,G,T,j,A,I,N,U,x){var F=a([g,w,y,p,i],{baseClass:"esriReviewContainer",loaded:!1,templateString:n,widgetsInTemplate:!0,i18n:h,map:null,graphicsLayer:null,suggestionGraphic:null,matchGraphic:null,highlightGraphic:null,_featureLayerCount:null,_tableLayerCount:null,_keywordMap:null,_keywordArray:[],_singleLineInput:!0,_arcgisUrl:s.getObject("esri.arcgis.utils.arcgisUrl"),constructor:function(t,i){a.safeMixin(this,t),this.StandardGrid=a([C,m,v,b,L,R]),this._defineGridStores(),this._defineColumns(),this.stackContainerID=i+"_stackContainerNode",this.headerID=i+"_HeaderNode",this.unmatchedUC=h.widgets.geocodeReview.unmatchedUC,this.matchedUC=h.widgets.geocodeReview.matchedUC,this.reviewedUC=h.widgets.geocodeReview.reviewedUC,this.suggestionGraphic||(this.suggestionGraphic=new T(e.toUrl("./GeocodeReview/images/EsriBluePinCircle26.png"),26,26),this.suggestionGraphic.setOffset(0,12)),this.matchGraphic||(this.matchGraphic=new T(e.toUrl("./GeocodeReview/images/EsriGreenPinCircle26.png"),26,26),this.matchGraphic.setOffset(0,12)),this.highlightGraphic||(this.highlightGraphic=new T(e.toUrl("./GeocodeReview/images/EsriYellowPinCircle26.png"),26,26),this.highlightGraphic.setOffset(0,12)),this._keywordMap={}},postCreate:function(){this.inherited(arguments),this._generateGrids(),this.graphicsLayer=new I,this.map.addLayer(this.graphicsLayer),this._listenerHandles=[t(this.map,"resize",s.hitch(this,(function(){this.resize()}))),t(window,"resize",s.hitch(this,(function(){this.resize()}))),this.stackControllerNode.on("addChild",(function(e){_.add(e.controlButton.domNode,"calcite")})),this.stackControllerNode.on("selectChild",s.hitch(this,(function(e){var t=this.stackControllerNode.getChildren();d.forEach(t,(function(e){e.domNode&&_.remove(e.domNode,"blue")})),_.add(e.controlButton.domNode,"blue"),this.clearGridSelection(),this.stackContainerNode.selectedChildWidget&&(this.currentTab=this.stackContainerNode.selectedChildWidget,this.currentTabId=this.stackContainerNode.selectedChildWidget.id),this.resize(),this.graphicsLayer.clear(),this.emit("tab-change",{}),this.geocodeMatch&&this.geocodeMatch.reset()}))),t(this._gridUnmatchedRef,"dgrid-select",s.hitch(this,(function(e){e.rows[0].data.oid?(this.currentSelectedRow=this._unmatchedStore.get(e.rows[0].data.oid),this._selectGridRowEvent(e.rows[0].data.oid,this.currentSelectedRow)):(this.currentSelectedRow=this._unmatchedStore.get(e.rows[0].data[this._tableLayer.objectIdField]),this._selectGridRowEvent(e.rows[0].data[this._tableLayer.objectIdField],this._unmatchedStore.get(e.rows[0].data[this._tableLayer.objectIdField])))}))),t(this._gridMatchedRef,"dgrid-select",s.hitch(this,(function(e){this.currentSelectedRow=this._matchedStore.get(e.rows[0].data[this._featureLayer.objectIdField]),this._selectGridRowEvent(e.rows[0].data[this._featureLayer.objectIdField],this._matchedStore.get(e.rows[0].data[this._featureLayer.objectIdField]))}))),t(this._gridReviewedRef,"dgrid-select",s.hitch(this,(function(e){this.currentSelectedRow=this._reviewedStore.get(e.rows[0].data.id),this._drawReviewedRow(e.rows[0].data)}))),t(this._gridMatchedRef,"dgrid-datachange",s.hitch(this,(function(e){var t,i=null,r=e.cell.row.data;this._matchedStore.get(e.cell.row.id).updated=!0,this._matchedStore.get(e.cell.row.id)[e.cell.column.field]=e.value,this._matchedStore.get(e.cell.row.id).location&&(i=this._matchedStore.get(e.cell.row.id).location),t=this._singleLineInput?{id:r[this._featureLayer.objectIdField],address:r[this._keywordMap.Address],location:i,featureType:r.featureType,reviewed:r.reviewed,updated:!0,sourceCountry:this._sourceCountry}:{id:r[this._featureLayer.objectIdField],address:this._formatLocatorOptions(r),location:i,featureType:r.featureType,reviewed:r.reviewed,updated:!0,sourceCountry:this._sourceCountry},this.emit("row-datachange",{newAddress:e.value,oldAddress:e.oldValue,location:i,rowData:r,returnData:t}),this.geocodeMatch&&this.geocodeMatch.geocodeAddress(t),this._applyAddressEdits(this._matchedStore.get(e.cell.row.id))}))),t(this._gridUnmatchedRef,"dgrid-datachange",s.hitch(this,(function(e){var t,i=null,r=e.cell.row.data;this._unmatchedStore.get(e.cell.row.id).updated=!0,this._unmatchedStore.get(e.cell.row.id)[e.cell.column.field]=e.value,this._unmatchedStore.get(e.cell.row.id).location&&(i=this._unmatchedStore.get(e.cell.row.id).location),t=this._singleLineInput?{id:r[this._tableLayer.objectIdField],address:r[this._keywordMap.Address],location:i,featureType:r.featureType,reviewed:r.reviewed,updated:!0,sourceCountry:this._sourceCountry}:{id:r[this._tableLayer.objectIdField],address:this._formatLocatorOptions(r),location:i,featureType:r.featureType,reviewed:r.reviewed,updated:!0,sourceCountry:this._sourceCountry},this.emit("row-datachange",{newAddress:e.value,oldAddress:e.oldValue,location:i,rowData:r,returnData:t}),this.geocodeMatch&&this.geocodeMatch.geocodeAddress(t),this._applyAddressEdits(this._unmatchedStore.get(e.cell.row.id))})))],this.geocodeMatch&&this._listenerHandles.push(this._geocodeMatchHandler())},startup:function(){this.inherited(arguments),this.domNode&&this.map&&(this.map.loaded?this._init():t(this.map,"load",s.hitch(this,(function(){this._init()}))))},matchFeature:function(e){var t=this.currentSelectedRow,i=e.locatorAttributes;if(i)for(attributeKey in i)t[attributeKey]=i[attributeKey];t.updated=!0,t.reviewed=!0,t.oid=t[this._unmatchedStore.idProperty],t.location=e.newLocation,this._applyEdits(e.newLocation,t,t.featureType);var r=this._reviewedStore.query({featureID:e.featureID,featureType:e.featureType});r.total>0?r[0].newLocation=e.newLocation:this._reviewedArray.push({id:this._reviewedArray.length,featureID:e.featureID,address:e.address,oldLocation:e.oldLocation,newLocation:e.newLocation,featureType:e.featureType}),this._reviewedStore=new c({data:this._reviewedArray,idProperty:"id"}),this._gridReviewedRef.set("store",this._reviewedStore),this._updateTabText(),this.refreshGrids(),this.emit("match",{id:this._reviewedArray.length,featureID:e.featureID,address:e.address,oldLocation:e.oldLocation,newLocation:e.newLocation,featureType:e.featureType})},clearGridSelection:function(){this._gridUnmatchedRef.clearSelection(),this._gridMatchedRef.clearSelection(),this._gridReviewedRef.clearSelection()},refreshGrids:function(){this._gridUnmatchedRef.refresh(),this._gridMatchedRef.refresh(),this._gridReviewedRef.refresh()},resizeGrids:function(){this._gridUnmatchedRef.resize(),this._gridMatchedRef.resize(),this._gridReviewedRef.resize()},destroy:function(){d.forEach(this._listenerHandles,(function(e){e.remove()})),this.map&&(this.map.infoWindow.clearFeatures(),this.map.infoWindow.hide(),this.map.removeLayer(this.graphicsLayer)),this.graphicsLayer=null,this.map=null,this.inherited(arguments)},_init:function(){this.loaded=!0,this.emit("load",{}),this.resize(),U.arcgisUrl=this._arcgisUrl,U.getItem(this.itemId).then(s.hitch(this,(function(e){var t=e.item.url||e.item.item;-1!==e.item.typeKeywords.indexOf("Hosted Service")&&this._getPublishParams().then(s.hitch(this,(function(){this._getDataFromFeatureService(t)})))})))},_applyEdits:function(e,t,i){var r=new M;r.attributes=t,"unmatched"===i&&this._featureLayer&&this._tableLayer?(this._tableLayer.applyEdits(null,null,[r]),r.geometry=e,this._featureLayer.applyEdits([r],null,null)):"matched"===i&&this._featureLayer&&(r.geometry=e,this._featureLayer.applyEdits(null,[r],null))},resize:function(){var e=f.get(this.domNode,"height"),t=f.get(u.byId(this.headerID),"height");f.set(this.stackContainerNode.domNode,"height",e-t+"px"),this.stackContainerNode.resize(),this.resizeGrids(),this._tab1Node.resize(),this._tab2Node.resize(),this._tab3Node.resize()},_applyAddressEdits:function(e){var t=new M;t.attributes=e,"unmatched"===e.featureType?this._tableLayer.applyEdits(null,[t],null):this._featureLayer.applyEdits(null,[t],null)},_selectGridRowEvent:function(e,t){var i;i=this._singleLineInput?{id:e,address:t[this._keywordMap.Address],location:t.location,featureType:t.featureType,reviewed:t.reviewed,updated:t.updated,sourceCountry:this._sourceCountry}:{id:e,address:this._formatLocatorOptions(t),location:t.location,featureType:t.featureType,reviewed:t.reviewed,updated:t.updated,sourceCountry:this._sourceCountry},this.emit("row-select",i),this.geocodeMatch&&this.geocodeMatch.geocodeAddress(i)},_calcGraphicsExtent:function(e){var t,i,r=e[0].geometry,a=r.getExtent(),s=e.length;for(null===a&&(a=new S(r.x,r.y,r.x,r.y,r.spatialReference)),i=1;i<s;i++)null===(t=(r=e[i].geometry).getExtent())&&(t=new S(r.x,r.y,r.x,r.y,r.spatialReference)),a=a.union(t);return a},_drawReviewedRow:function(e){this.graphicsLayer.clear();var t,i,r,a,o=e.newLocation,d=new M(o,this.matchGraphic);e.oldLocation?(t=e.oldLocation,i=new M(t,this.highlightGraphic),r=[i,d],a=this._calcGraphicsExtent(r),this.map.setExtent(a,!0).then(s.hitch(this,(function(){var e;for(e=0;e<r.length;e++)this.graphicsLayer.add(r[e])})))):this.map.centerAt(o).then(s.hitch(this,(function(){this.graphicsLayer.add(d)})))},_getPublishParams:function(){var e=new o,t=this._arcgisUrl+"/"+this.itemId+"/info/publishParameters.json";return N({url:t,content:{f:"json"},handleAs:"json",callbackParamName:"callback",load:s.hitch(this,(function(t){this._pubParams=t;var i,r,a,s=t.layerInfo.publishFieldMap||!1;if(a=t.layers&&t.layers[0]&&!t.addressFields?t.layers[0].addressFields:t.addressFields,Object.keys||(a,Object.keys=function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(t);return i}),1===Object.keys(a).length){for(i in a)a.hasOwnProperty(i)&&(s&&s.hasOwnProperty(a[i])?(this._keywordMap.Address=s[a[i]],this._keywordArray.push(s[a[i]])):(this._keywordMap.Address=a[i],this._keywordArray.push(a[i])));this._singleLineInput=!0}else for(r in this._singleLineInput=!1,a)a.hasOwnProperty(r)&&(s&&s.hasOwnProperty(a[r])?(this._keywordMap[r]=s[a[r]],this._keywordArray.push(s[a[r]])):(this._keywordMap[r]=a[r],this._keywordArray.push(a[r])));this._sourceCountry=t.sourceCountry&&!this._keywordMap.CountryCode&&"world"!==t.sourceCountry.toLowerCase()&&"wo"!==t.sourceCountry.toLowerCase()?t.sourceCountry:null,t.geocodeServiceUrl?(this._locatorURL=t.geocodeServiceUrl,this.geocodeMatch&&this.geocodeMatch.updateLocatorURL(this._locatorURL)):this.geocoder&&this.geocodeMatch&&this.geocodeMatch.updateLocatorURL(this.geocoder),e.resolve(!0)}))}),e.promise},_formatLocatorOptions:function(e){var t,i=[],r={};for(t in this._keywordMap)this._keywordMap.hasOwnProperty(t)&&("undefined"!==e[this._keywordMap[t]]?(r[t]=e[this._keywordMap[t]],i[t]=e[this._keywordMap[t]]):(r[t]=e[this._keywordMap[t].toLowerCase()],i[t]=e[this._keywordMap[t].toLowerCase()]));return i},_getDataFromFeatureService:function(e){var t=e+"/0",i=e+"/1";N({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback",load:s.hitch(this,(function(e){this._fsData=e,0!==e.layers.length?(this._featureLayer=new A(t,{mode:A.MODE_SELECTION,outFields:["*"]}),this._featureLayer.userIsAdmin=!0,this._listenerHandles.push(this._layerLoad())):this._featureLayer=!1,0!==e.tables.length?(this._tableLayer=new A(i,{mode:A.MODE_SELECTION,outFields:["*"]}),this._tableLayer.userIsAdmin=!0,this._listenerHandles.push(this._tableLoad())):(this._tableLayer=!1,this.stackContainerNode.removeChild(this.stackContainerNode.getChildren()[0]))}))}),this.resize()},_geocodeMatchHandler:function(){return this.geocodeMatch.on("match",s.hitch(this,(function(e){this.matchFeature(e)})))},_layerLoad:function(){return t(this._featureLayer,"load",s.hitch(this,(function(){this._queryFeatureLayer()})))},_tableLoad:function(){return t(this._tableLayer,"load",s.hitch(this,(function(){this._queryTableLayer()})))},_queryFeatureLayer:function(){var e,t,i,r=[],a=new j;a.where="1 = 1",this._featureLayer.queryFeatures(a).then(s.hitch(this,(function(a){for(e=0;e<a.features.length;e++)a.features[e].attributes.updated=!1,a.features[e].attributes.reviewed=!1,a.features[e].attributes.featureType="matched",i=a.features[e].attributes,t=new k(a.features[e].geometry.getLongitude(),a.features[e].geometry.getLatitude()),i.location=t,r.push(i);a.exceededTransferLimit&&this._getFeatureCount(this._featureLayer).then(s.hitch(this,(function(e){this.set("_featureLayerCount",e),this._updateTabText()}))),this._gridMatchedRef.set("columns",this._updateColumns(a)),this._matchedStore=new c({data:r,idProperty:this._featureLayer.objectIdField}),this._gridMatchedRef.set("store",this._matchedStore),this._updateTabText()})))},_queryTableLayer:function(){var e,t,i=[],r=new j;r.where="1 = 1",this._tableLayer.queryFeatures(r).then(s.hitch(this,(function(r){if(0!==r.features.length){for(e=0;e<r.features.length;e++)r.features[e].attributes.updated=!1,r.features[e].attributes.reviewed=!1,r.features[e].attributes.featureType="unmatched",t=r.features[e].attributes,i.push(t);r.exceededTransferLimit&&this._getFeatureCount(this._tableLayer).then(s.hitch(this,(function(e){this.set("_tableLayerCount",e),this._updateTabText()}))),this._gridUnmatchedRef.set("columns",this._updateColumns(r)),this._unmatchedStore=new c({data:i,idProperty:this._tableLayer.objectIdField}),this._gridUnmatchedRef.set("store",this._unmatchedStore),this._updateTabText()}else this._tableLayer=!1,delete this._fsData.tables[0],this.stackContainerNode.removeChild(this.stackContainerNode.getChildren()[0])})))},_getFeatureCount:function(e){var t=new j;t.returnGeometry=!1,t.returnIdsOnly=!1,t.where="1=1";var i=esriConfig.defaults.io.timeout;return esriConfig.defaults.io.timeout=1e4,e.queryCount(t).then((function(e){return esriConfig.defaults.io.timeout=i,e}),(function(){return esriConfig.defaults.io.timeout=i,null}))},_updateTabText:function(){var e=null!==this._tableLayerCount?this._tableLayerCount:this._unmatchedStore.data.length,t=null!==this._featureLayerCount?this._featureLayerCount:this._matchedStore.data.length;this._unmatchedStore.query({reviewed:!1}).total===e?this._tab1Node.set("title",l.substitute(h.widgets.geocodeReview.unmatchedTotal,{count:e})):this._tab1Node.set("title",l.substitute(h.widgets.geocodeReview.unmatchedRemaining,{count1:this._unmatchedStore.query({reviewed:!1}).total,count2:e})),this._tab2Node.set("title",l.substitute(h.widgets.geocodeReview.matchedTotal,{count:t})),this._tab3Node.set("title",l.substitute(h.widgets.geocodeReview.reviewedTotal,{count:this._reviewedStore.data.length}))},_generateGrids:function(){this._generateUnmatchedGrid(),this._generateMatchedGrid(),this._generateReviewedGrid()},_generateUnmatchedGrid:function(){this._gridUnmatchedRef=new this.StandardGrid({store:this._unmatchedStore,columns:this._unmatchedColumns,noDataMessage:h.widgets.geocodeReview.review.noDataMsg1,selectionMode:"extended",allowSelectAll:!1,cellNavigation:!1},this._grid1Node),this._gridUnmatchedRef.startup(),this._gridUnmatchedRef.resize()},_generateMatchedGrid:function(){this._gridMatchedRef=new this.StandardGrid({store:this._matchedStore,columns:this._matchedColumns,noDataMessage:h.widgets.geocodeReview.review.noDataMsg2,selectionMode:"extended",allowSelectAll:!1,cellNavigation:!1},this._grid2Node),this._gridMatchedRef.startup(),this._gridMatchedRef.resize()},_generateReviewedGrid:function(){this._gridReviewedRef=new this.StandardGrid({store:this._reviewedStore,columns:this._reviewedColumns,noDataMessage:h.widgets.geocodeReview.review.noDataMsg3,selectionMode:"extended",allowSelectAll:!1,cellNavigation:!1},this._grid3Node),this._gridReviewedRef.startup(),this._gridReviewedRef.resize()},_defineColumns:function(){this._unmatchedColumns=[],this._matchedColumns=[],this._reviewedColumns=[{label:h.widgets.geocodeReview.idProperty,field:"id",hidden:!0},{label:h.widgets.geocodeReview.review.columnSelectedAddress,field:"address",formatter:s.hitch(this,(function(t){return"<img src='"+e.toUrl("./GeocodeReview/images/EsriGreenPinCircle26.png")+"' />"+t})),get:s.hitch(this,(function(e){var t,i="",r="";if("object"==typeof e.address){for(t in e.address)e.address.hasOwnProperty(t)&&null!==e.address[t]&&"Loc_name"!==t&&(r+=e.address[t]+" ");i=r}else i=e.address;return i}))},{label:h.widgets.geocodeReview.review.columnOriginalLocation,field:"oldLocation",formatter:function(e){return e},get:s.hitch(this,(function(e){var t;return e.oldLocation&&(t=G.webMercatorToGeographic(e.oldLocation)),e.oldLocation?"X: "+t.x+"<br />Y: "+t.y:"None"}))},{label:h.widgets.geocodeReview.review.columnSelectedLocation,field:"newLocation",formatter:function(e){return e},get:s.hitch(this,(function(e){var t=G.webMercatorToGeographic(e.newLocation);return"X: "+t.x+"<br />Y: "+t.y}))},{label:"Type",field:"featureType",hidden:!0}]},_updateColumns:function(t){var i,r,a=[];if(t&&t.fields){for(i=0;i<t.fields.length;i++)r=this._keywordMap.Address&&t.fields[i].name===this._keywordMap.Address||this._keywordMap.Address&&t.fields[i].name===this._keywordMap.Address.toLowerCase()||-1!==d.indexOf(this._keywordArray,t.fields[i].name)?new L({label:t.fields[i].alias||t.fields[i].name,field:t.fields[i].name,editor:"text",editOn:"dblclick",autoSave:!0}):{label:t.fields[i].alias||t.fields[i].name,field:t.fields[i].name,hidden:!0},t.fields[i].name===this._featureLayer.objectIdField?a.splice(0,0,{label:t.fields[i].name,field:t.fields[i].alias,hidden:!0}):a.push(r);a.push({label:h.widgets.geocodeReview.reviewedUC,field:"reviewed",formatter:function(e){return e},get:s.hitch(this,(function(t){return t.reviewed?"<img src='"+e.toUrl("./GeocodeReview/images/save.png")+"' />":""}))})}return a},_defineGridStores:function(){this._unmatchedStore=new c({data:"",idProperty:this._idProperty}),this._matchedStore=new c({data:"",idProperty:this._idProperty}),this._reviewedArray=[],this._reviewedStore=new c({data:this._reviewedArray,idProperty:this._idProperty})}});return r("extend-esri")&&s.setObject("dijit.GeocodeReview",F,x),F}));