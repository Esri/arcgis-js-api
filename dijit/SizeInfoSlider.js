define(["../kernel","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/Tooltip","../dijit/RendererSlider","../Color","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/i18n!../nls/jsapi","dojo/dom-geometry","dojo/dom-style","dojo/Evented","dojo/has","dojo/number","dojo/string","dojo/dom-construct","dojo/dom-class","dojox/gfx","dojo/text!./SizeInfoSlider/templates/SizeInfoSlider.html","require"],function(i,t,e,s,a,o,h,l,r,n,m,u,d,c,p,_,g,f,S,x,b,z){var V=r("esri.dijit.SizeInfoSlider",[s,e,t,c],{baseClass:"esriSizeInfoSlider",templateString:b,domNode:null,containerNode:null,values:null,minValue:null,maxValue:null,minSize:null,maxSize:null,histogram:null,statistics:null,showHistogram:!0,showStatistics:!0,_histogramWidthDefault:100,_rampWidthDefault:25,_symbolWidthDefault:50,showLabels:null,showTicks:null,showHandles:null,_rampNode:null,_sliderHeight:null,_barsGroup:null,_updateTimer:null,zoomOptions:{},constructor:function(i,t){this.inherited(arguments),t&&(this.domNode=t,this.containerNode=this._containerNode,this.symbol=i.symbol,this.statistics=i.statistics||!1,this.histogram=i.histogram||!1,this.zoomOptions=i.zoomOptions||null,this.sizeInfo=i.sizeInfo,this.minSize=this.sizeInfo.minSize,this.maxSize=this.sizeInfo.maxSize,this.histogramWidth=i.histogramWidth||this._histogramWidthDefault,this.symbolWidth=i.symbolWidth||this._symbolWidthDefault,this.rampWidth=i.rampWidth||this._rampWidthDefault,this.showLabels=i.showLabels||!0,this.showTicks=i.showTicks||!0,this.showHandles=i.showHandles||!0,this.statistics?(this.minValue=this.statistics.min,this.maxValue=this.statistics.max):(this.minValue=0,this.maxValue=100),void 0!==i.minValue&&(this.minValue=i.minValue),void 0!==i.maxValue&&(this.maxValue=i.maxValue),null!==this.zoomOptions&&(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue))},postCreate:function(){this.inherited(arguments),null===this.sizeInfo.minDataValue&&null===this.sizeInfo.maxDataValue||0===this.sizeInfo.minDataValue&&0===this.sizeInfo.maxDataValue?null===this.minValue&&null===this.maxValue&&(this.minValue=0,this.maxValue=100,this.values=[20,80]):this.minValue===this.maxValue?0===this.minValue?(this.maxValue=100,this.values=[20,80]):null===this.minValue?(this.minValue=0,this.maxValue=100,this.values=[20,80]):(this.maxValue=2*this.minValue,this.minValue=0,this.values=[this.maxValue/5,this.maxValue/5*4]):this.values=[this.sizeInfo.minDataValue,this.sizeInfo.maxDataValue],null===this.minValue&&(this.minValue=0),null===this.maxValue&&(this.maxValue=100)},startup:function(){this.inherited(arguments),this._slider=new o({type:"SizeInfoSlider",values:this.values,minLabel:this.zoomOptions?this.minValue:null,maxLabel:this.zoomOptions?this.maxValue:null,minimum:this.zoomOptions?this.zoomOptions.minSliderValue:this.minValue,maximum:this.zoomOptions?this.zoomOptions.maxSliderValue:this.maxValue,_isZoomed:this.zoomOptions?!0:!1,showLabels:this.showLabels,showTicks:this.showTicks,showHandles:this.showHandles},this._sliderNode),this._slider.startup(),this._rampNode=this._slider._sliderAreaRight,this._sliderHeight=d.get(this._rampNode,"height")||155,this._createSVGSurfaces(),this._slider.on("slide",n.hitch(this,function(i){this._fillRamp(i.values)})),this._slider.on("change",n.hitch(this,function(i){this.sizeInfo.minDataValue=i.values[0],this.sizeInfo.maxDataValue=i.values[1],this.values=[this.sizeInfo.minDataValue,this.sizeInfo.maxDataValue],this.emit("change",n.clone(this.sizeInfo))})),this._slider.on("handle-value-change",n.hitch(this,function(i){this.values=i.values,this.sizeInfo.minDataValue=i.values[0],this.sizeInfo.maxDataValue=i.values[1],this._updateRendererSlider(),this.emit("handle-value-change",n.clone(this.sizeInfo))})),this._slider.on("data-value-change",n.hitch(this,function(i){this.minValue=i.min,this.maxValue=i.max,this._updateRendererSlider(),this.emit("data-value-change",{minValue:i.min,maxValue:i.max,sizeInfo:n.clone(this.sizeInfo)})})),this._slider.on("stop",n.hitch(this,function(){this.emit("handle-value-change",n.clone(this.sizeInfo))})),this.statistics&&this.showStatistics&&this._generateStatistics(),this.showHistogram&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram(),this.watch("minValue",this._updateTimeout),this.watch("maxValue",this._updateTimeout),this.watch("symbol",this._updateTimeout),this.watch("sizeInfo",this._updateTimeout),this.watch("minSize",this._updateTimeout),this.watch("maxSize",this._updateTimeout),this.watch("statistics",this._updateTimeout),this.watch("histogram",this._updateTimeout),this.watch("showHistogram",this._toggleHistogram),this.watch("zoomOptions",this._updateTimeout)},_showHistogram:function(){this.histogram||this.zoomOptions&&this.zoomOptions.histogram?this._generateHistogram():this._barsGroup&&(this._barsGroup.destroy(),this._barsGroup=null)},_toggleHistogram:function(){this.showHistogram?(d.set(this._barsGroup.rawNode,"display","inline-block"),this._showHistogram()):d.set(this._barsGroup.rawNode,"display","none")},_updateTimeout:function(){var i=this;clearTimeout(this._updateTimer),this._updateTimer=setTimeout(function(){var t=i;i=null,clearTimeout(t._updateTimer),t._updateRendererSlider()},0)},_updateRendererSlider:function(){this.minSize=this.sizeInfo.minSize,this.maxSize=this.sizeInfo.maxSize,this.values=[this.sizeInfo.minDataValue,this.sizeInfo.maxDataValue],null!==this.zoomOptions?(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue,this._slider.set("minimum",this.zoomOptions.minSliderValue),this._slider.set("maximum",this.zoomOptions.maxSliderValue),this._slider.set("_isZoomed",!0),this._slider.set("maxLabel",this.maxValue),this._slider.set("minLabel",this.minValue)):(this._slider.set("minimum",this.minValue),this._slider.set("maximum",this.maxValue),this._slider.set("_isZoomed",!1),this._slider.set("maxLabel",null),this._slider.set("minLabel",null)),this._slider.set("values",this.values),this._slider._reset(),this._slider._updateRoundedLabels(),this._slider._generateMoveables(),this._clearRect(),this._createSVGSurfaces(),this.statistics&&this.showStatistics&&this._generateStatistics(),this.showHistogram&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram()},_getPrecision:function(){return Math.floor(Math.log(this.maxValue)/Math.log(10))<2?2-Math.floor(Math.log(this.maxValue)/Math.log(10)):0},_generateHistogram:function(){var i,t=this.zoomOptions&&this.zoomOptions.histogram?this.zoomOptions.histogram:this.histogram;this._barsGroup=this._histogramSurface.createGroup();var e=l.map(t.bins,function(i){return"object"==typeof i?i.count:i});e.reverse();var s=this._sliderHeight/e.length;l.forEach(e,n.hitch(this,function(t,a){i=t>0?this.histogramWidth*(t/Math.max.apply(Math,e)):0,this._barsGroup.createRect({width:i,height:s}).setStroke("#c0c0c0").setFill("#aaa").setTransform(x.matrix.translate(0,s*a))})),d.set(this._histogramSurface.rawNode,{display:"inline-block",left:this.rampWidth+"px"}),u.isBodyLtr()||this._barsGroup.setTransform({dx:this.histogramWidth,dy:0,xx:-1,xy:0,yx:0,yy:1})},_attachSymbols:function(){this._attachSymbol(this._slider.moveables[0],this.minSize,"min"),this._attachSymbol(this._slider.moveables[1],this.maxSize,"max")},_attachSymbol:function(i,t){i._symbol||(i._symbol=f.create("div",{style:"position: absolute; left: 10px;"},i));var e=d.get(i._handler,"height"),s=i._symbol,a=this.symbol;switch(a||(a={type:"custom"}),a.type){case"simplelinesymbol":t=t===this.minSize?5:13,this._generateLineSymbol(i,t,e);break;case"simplemarkersymbol":default:t=t===this.minSize?12:48,this._generateCircleSymbol(s,t,e)}return s},_generateLineSymbol:function(i,t,e){var s=i._tick;S.add(s,"handlerTickSize");var a=i._symbol;d.set(a,"top",e/2-t+"px"),d.set(a,"height",2*t+"px"),d.set(a,"width",t-4+"px"),a.innerHTML="";var o=x.createSurface(a);return o.rawNode.style.position="absolute",o.rawNode.style.top=1===t?"1px":t/2+"px",u.isBodyLtr()||(o.rawNode.style.left="-45px"),o.setDimensions(this.rampWidth,t),o.createRect({width:this.rampWidth,height:t}).setFill(new h([0,121,193,.8])),o},_generateCircleSymbol:function(i,t,e){var s=t/2,a=1;d.set(i,"top",e/2-(s+a)+"px"),d.set(i,"height",2*(s+a)+"px"),d.set(i,"width",s+"px"),i.innerHTML="";var o=x.createSurface(i);return o.rawNode.style.position="absolute",u.isBodyLtr()||(o.rawNode.style.left="-45px"),o.setDimensions(s+a,2*(s+a)),o.createCircle({cx:0,cy:s+a,r:s}).setFill(new h([0,121,193,.8])).setStroke("#fff"),o},_fillRamp:function(i){var t=this._slider,e=this._sliderHeight,s=i?i[0]:t.values[0],a=i?i[1]:t.values[1],o=Math.round(e-(s-t.minimum)/(t.maximum-t.minimum)*e),h=Math.round(e-(a-t.minimum)/(t.maximum-t.minimum)*e),l=5,r=this.rampWidth;this._proportionalSymbolSurface.clear(),this._proportionalSymbolSurface.createPath().moveTo(r,0).lineTo(r,h).lineTo(l,o).lineTo(l,e).lineTo(0,e).lineTo(0,0).closePath().setFill("#9a9a9a"),d.set(this._proportionalSymbolSurface.rawNode,"overflow","visible"),d.set(this._proportionalSymbolSurface.rawNode,"background-color","#d9d9d9"),null!==this.zoomOptions&&(this.toggleSliderBottom&&this.toggleSliderTop?(this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(x.matrix.translate(0,5)),this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(x.matrix.translate(0,195))):this.toggleSliderBottom?this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(x.matrix.translate(0,195)):this.toggleSliderTop&&this._proportionalSymbolSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(x.matrix.translate(0,5)))},_generateStatistics:function(){var i=this.statistics;if(!(i.count<2)){var t,e,s=this._slider,o=this.zoomOptions||null;i.min===i.max&&i.min===i.avg?(t=0,e=2*i.avg):(t=i.min,e=i.max),(t!==s.minimum||e!==s.maximum)&&(t=s.minimum,e=s.maximum),o&&(t=o.minSliderValue,e=o.maxSliderValue);var h=[{value:i.avg,label:"average"}];h=l.filter(h,function(i){return i.value>=t&&i.value<=e}),l.forEach(h,n.hitch(this,function(s){var o=this._sliderHeight*(e-s.value)/(e-t);this._avgHandleLine=this._histogramSurface.createLine({x1:0,y1:o,x2:this.histogramWidth,y2:o}).setStroke("#c0c0c0").moveToBack(),this._avgHandleImage=this._histogramSurface.createImage({x:u.isBodyLtr()?this.histogramWidth+2:0,y:o-8,width:12,height:14,src:z.toUrl("esri/dijit/SizeInfoSlider/images/xAvg.png")});var h=g.substitute(m.widgets.rendererSlider.statsAvg,{avg:_.format(i.avg,{places:this._getPrecision()})});this._avgHandleTooltip=new a({connectId:[this._avgHandleImage.rawNode],label:h})}))}},_clearRect:function(){this._proportionalSymbolSurface.destroy(),this._histogramSurface.destroy()},_createSVGSurfaces:function(){this._proportionalSymbolSurface=x.createSurface(this._rampNode,this.rampWidth,this._sliderHeight),this._histogramSurface=x.createSurface(this._rampNode,this.histogramWidth,this._sliderHeight),d.set(this._histogramSurface.rawNode,{overflow:"visible",display:"inline-block",left:this.rampWidth+"px"}),this._rect=this._proportionalSymbolSurface.createRect(this._proportionalSymbolSurface.getDimensions()),this._fillRamp(),this._attachSymbols()},destroy:function(){this.inherited(arguments),this._slider.destroy(),this._avgHandleTooltip&&this._avgHandleTooltip.destroy()}});return p("extend-esri")&&n.setObject("dijit.SizeInfoSlider",V,i),V});