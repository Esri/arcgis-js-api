define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","../kernel","../lang","./_EventedWidget","dijit/_Widget","dijit/_TemplatedMixin","dojo/text!./templates/_ObliqueRotationWidget.html","dojo/_base/html","dojo/on","dojox/dgauges/CircularGauge","dojox/dgauges/CircularScale","dojox/dgauges/CircularRangeIndicator","dojox/dgauges/CircularValueIndicator","dojox/dgauges/LinearScaler","dojo/dom-geometry","dojo/dom-construct","dojo/i18n!../nls/jsapi"],function(t,i,a,e,n,s,o,r,h,d,u,c,l,_,g,m,f,v,p,z){var I=t([o,r,h],{baseClass:"esriObliqueRotationWidget",declaredClass:"esri.dijit._ObliqueRotationWidget",templateString:d,azimuthAngle:0,azimuthField:"SensorAzimuth",isNadir:!1,_rangeIndicatorWidth:8,constructor:function(t){i.mixin(this,t),this._i18n=z,this.isNadir=!s.isDefined(this.azimuthAngle)},postCreate:function(){this.inherited(arguments),this._coords=u.coords(this.domNode),this._computeCircleRadius(),this._getCenter(),this.refresh()},startup:function(){this.inherited(arguments),this._setupGauge(),this._addTooltips()},_setupGauge:function(){var t=this;this._gauge=new l({value:0,font:{family:"Helvetica",style:"normal",size:"10pt",color:"black",weight:"bold"},style:"margin: -2px;"},this.gaugeNode),this._addGaugeBackground(),this._addGaugeScale(),this._addGaugeIndicators(),this._gauge.startup(),this.own(c(this._gauge.domNode,"mouseup",function(i){t._getCenter();var a=i.pageX-t._centerLocnInPage[0],e=i.pageY-t._centerLocnInPage[1];Math.abs(a)<=10&&Math.abs(e)<=10?t._switchToNadir():(t.azimuthAngle=t._convertAngleToAzimuthNotation(t._calculateAngleFromXY(a,e)),t._switchToOblique())})),this.own(this._gauge.on("endEditing",i.hitch(this,function(i){t.isNadir||(this.snap&&this._snap(),t.azimuthAngle=this._convertAngleToAzimuthNotation(i.indicator.value),t.emit("azimuth-change",{azimuth:t.azimuthAngle}))})))},_addGaugeBackground:function(){var t="M "+this._center.join(",")+"m "+(0-this._radius)+",0 a "+this._radius+","+this._radius+" 0 1,0 "+2*this._radius+",0 a "+this._radius+","+this._radius+" 0 1,0 "+(0-2*this._radius)+",0";this._gauge.addElement("background",function(i){i.createPath({path:t}).setFill("rgba(255,255,255,0.5)").setStroke("rgba(89, 106, 114, 1)")}),this._addNadirDataIndicator()},_addNadirDataIndicator:function(){var t="M "+this._center.join(",")+"m -7,0 a 7,7 0 1,0 14,0 a 7,7 0 1,0 -14,0";this._gauge.addElement("nadirDataIndicator",function(i){i.createPath({path:t}).setFill("rgba(54, 104, 178, 0.5)").setStroke("rgba(0,0,0, 1)")})},_addGaugeScale:function(){this._scale=new _({originX:this._center[0],originY:this._center[1],radius:this._radius,startAngle:0,endAngle:359.999,orientation:"clockwise",scaler:new f({minimum:0,maximum:360,majorTickInterval:90,minorTickInterval:45}),tickShapeFunc:function(t,i,a){return a.isMinor?void 0:t.createLine({x1:0,y1:0,x2:a.isMinor?15:20,y2:0}).setStroke({color:"black",width:1})},labelGap:5,tickLabelFunc:function(t){var i=["E","S","W","N"];return t.isMinor?" ":t.value%90===0?i[t.value/90]:t.value}}),this._gauge.addElement("scale",this._scale)},_addGaugeIndicators:function(){var t=new g({value:359.9999,radius:this._radius-8,startThickness:6,endThickness:6,fill:"rgba(0,0,0,0.9)"});this._scale.addIndicator("indicatorBg",t),this._azimuthIndicator=this._createObliqueIndicator(),this._nadirIndicator=this._createNadirIndicator(),this.isNadir?this._scale.addIndicator("nadir_indicator",this._nadirIndicator):this._scale.addIndicator("azimuth_indicator",this._azimuthIndicator)},_convertAngleToAzimuthNotation:function(t){return s.isDefined(t)?(t+90)%360:void 0},_convertAngleToGaugeNotation:function(t){return s.isDefined(t)?(t+270)%360:void 0},_computeCircleRadius:function(){var t;return t=Math.min(this._coords.w/2,this._coords.h/2),t=Math.floor(t-2),this._radius=t,t},showAvailableData:function(t){var i=this;if(t=t||this.features){a.forEach(this._availableDataIndicators,function(t){i._scale.removeIndicator(t)}),this._availableDataIndicators=[],this.features=t;var e,n=0;for(n=0;n<t.length;n++)e=new g({start:this._convertAngleToGaugeNotation(t[n].attributes[this.azimuthField]-5),value:this._convertAngleToGaugeNotation(t[n].attributes[this.azimuthField]+5),radius:this._radius-1,startThickness:7,endThickness:7,fill:"#3668B2",stroke:"#3668B2"}),this._scale.addIndicator("indicator_"+n,e),this._availableDataIndicators.push("indicator_"+n)}},refresh:function(t){i.mixin(this,t),this.showAvailableData()},_getCenter:function(){var t,i=[],a=[];return i.push(Math.ceil(this._coords.w/2)),i.push(Math.ceil(this._coords.h/2)),t=v.position(this.gaugeNode),a.push(t.x+i[0]),a.push(t.y+i[1]),this._centerLocnInPage=a,this._center=i,i},_snap:function(){if(this._azimuthIndicator&&this.features&&this.features.length){var t,i,e=this._convertAngleToAzimuthNotation(this._azimuthIndicator.value),n=1e3;a.forEach(this.features,function(a){i=Math.min(Math.abs(a.attributes[this.azimuthField]-e),Math.abs(a.attributes[this.azimuthField]-e-360)),n>=i&&(t=a.attributes[this.azimuthField],n=i)},this),this.azimuthAngle=t,this._azimuthIndicator.set("value",this._convertAngleToGaugeNotation(this.azimuthAngle))}},_switchToNadir:function(){this.isNadir||(this._nadirIndicator=this._createNadirIndicator(),this._scale.removeIndicator("azimuth_indicator"),this._scale.addIndicator("nadir_indicator",this._nadirIndicator),this.emit("azimuth-change",{azimuth:null}),this.isNadir=!0)},_switchToOblique:function(){this.isNadir&&(this._azimuthIndicator=this._createObliqueIndicator(),this._scale.removeIndicator("nadir_indicator"),this._scale.addIndicator("azimuth_indicator",this._azimuthIndicator),this._snap(),this.emit("azimuth-change",{azimuth:this.azimuthAngle}),this.isNadir=!1)},_createNadirIndicator:function(){return new m({title:"Nadir",interactionMode:"none",indicatorShapeFunc:function(t){return t.createPolyline([-7,0,7,0,0,0,0,7,0,-7]).setStroke({color:"#000000",width:1})},value:0})},_createObliqueIndicator:function(){var t=this;return new m({interactionArea:"gauge",title:"Change Azimuth",indicatorShapeFunc:function(i){return i.createPolyline([0,-1,t._radius-1,-10,t._radius-1,10,0,1,0,-1]).setFill("rgba(50, 100, 200, 0.5)").setStroke("rgba(50, 100, 200, 0.5)")},value:this._convertAngleToGaugeNotation(this.azimuthAngle)})},_calculateAngleFromXY:function(t,i){var a,e;return e=Math.atan2(i,t),a=e/Math.PI*180+(e>0?0:360)},_addTooltips:function(){var t,i=5,e=this,n=[{top:0,left:this._radius-i,direction:"north",angle:0},{top:this._radius-i,left:2*(this._radius-i),direction:"east",angle:90},{top:2*(this._radius-i),left:this._radius,direction:"south",angle:180},{top:this._radius-i,left:0,direction:"west",angle:270},{top:this._radius-i,left:this._radius-i,direction:"nadir",angle:null}];a.forEach(n,function(a){t=p.create("div"),t.style.position="absolute",t.style.top=a.top+"px",t.style.left=a.left+"px",t.style.height=2*i+"px",t.style.width=2*i+"px",t.style.cursor="pointer",t.style.zIndex=999,t.id=this.domNode.id+"_tooltip_"+a.direction,p.place(t,this.gaugeNode),t.title=this._i18n.widgets.obliqueViewer[a.direction+"Tooltip"],t.onclick=function(){s.isDefined(a.angle)&&(e.azimuthAngle=a.angle,e._azimuthIndicator.set("value",e._convertAngleToGaugeNotation(a.angle)),e.snap&&e._snap(),e.emit("azimuth-change",{azimuth:e.azimuthAngle}))}},this)},setAzimuth:function(t){s.isDefined(t)&&(this.azimuthAngle=t,this.isNadir?this._switchToOblique():this._azimuthIndicator.set("value",this._convertAngleToGaugeNotation(this.azimuthAngle)))}});return e("extend-esri")&&i.setObject("dijit._ObliqueRotationWidget",I,n),I});