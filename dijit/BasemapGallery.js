define(["require","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/lang","dojo/_base/kernel","dojo/_base/sniff","dojo/has","dojo/query","dojo/DeferredList","dojo/dom","dojo/dom-construct","dojo/dom-class","dijit/_Widget","dijit/_Templated","../kernel","../urlUtils","../request","../geometry/Extent","../virtualearth/VETiledLayer","../layers/OpenStreetMapLayer","../layers/ArcGISTiledMapServiceLayer","../layers/ArcGISDynamicMapServiceLayer","../layers/WebTiledLayer","../layers/TileInfo","../layers/ArcGISImageServiceLayer","../layers/ImageServiceParameters","./Basemap","./_EventedWidget","dojo/text!./templates/BasemapGallery.html"],function(e,a,s,i,t,r,n,o,l,c,h,p,d,m,u,f,y,b,v,g,_,I,G,S,B,L,A,w,E,U){var R=a([E,m,u],{declaredClass:"esri.dijit.BasemapGallery",widgetsInTemplate:!0,templateString:U,loaded:!1,basemaps:[],bingMapsKey:null,flowContainer:null,_hasUI:!1,_selectedBasemap:null,_selectBasemapInProgress:!1,_eventMap:{load:!0,"selection-change":!0,add:["basemap"],remove:["basemap"],error:["message"]},constructor:function(e,a){e=e||{},e.map||console.error("esri.dijit.BasemapGallery: Unable to find the 'map' property in parameters"),this.map=e.map,this._hasUI=a?!0:!1,this.bingMapsKey=e.bingMapsKey&&e.bingMapsKey.length>0?e.bingMapsKey:null,this.showArcGISBasemaps=e.showArcGISBasemaps===!1?!1:!0,this.basemaps=e.basemaps||[],this.basemapIds=e.basemapIds,this.referenceIds=e.referenceIds,this.basemapsGroup=e.basemapsGroup,this.arcgisUrl=f.dijit._arcgisUrl,e.portalUrl&&(this.arcgisUrl=e.portalUrl+"/sharing/rest"),this.arcgisUrl.indexOf("://")<0?this.arcgisUrl=window.location.protocol+"//"+this.arcgisUrl:"https:"===window.location.protocol&&(this.arcgisUrl=this.arcgisUrl.replace("http:","https:")),this.init()},init:function(){this.inherited(arguments),s.forEach(this.basemaps,function(e){e.id&&0!==e.id.length||(e.id=this._getUniqueId()),s.forEach(e.layers,function(e){e.opacity=e.opacity>=0?e.opacity:1,e.visibility=!0},this)},this),this.basemapIds&&this.basemapIds.length>0&&s.forEach(this.basemapIds,function(e){var a=this.map.getLayer(e);a._basemapGalleryLayerType="basemap"},this),this.referenceIds&&this.referenceIds.length>0&&s.forEach(this.referenceIds,function(e){var a=this.map.getLayer(e);a._basemapGalleryLayerType="reference",a.attr("data-reference",!0)},this),this.basemapsGroup&&(this.basemapsGroup.owner&&this.basemapsGroup.title||this.basemapsGroup.id)?this._findCustomBasemapsGroup(t.hitch(this,"_handleArcGISBasemapsResponse")):this.showArcGISBasemaps?this._findArcGISBasemapsGroup(t.hitch(this,"_handleArcGISBasemapsResponse")):this._finishStartup()},startup:function(){this.loaded?this._refreshUI():i.connect(this,"onLoad",t.hitch(this,function(){this._refreshUI()}))},select:function(e){this._select(e)},getSelected:function(){return this._selectedBasemap},get:function(e){var a;for(a=0;a<this.basemaps.length;a++)if(this.basemaps[a].id==e)return this.basemaps[a];return null},add:function(e){return e&&!e.id?(e.id=this._getUniqueId(),this.basemaps.push(e),this._refreshUI(),this.onAdd(e),!0):e&&this._isUniqueId(e.id)?(this.basemaps.push(e),this._refreshUI(),this.onAdd(e),!0):!1},remove:function(e){var a;for(a=0;a<this.basemaps.length;a++){var s=this.basemaps[a];if(s.id===e)return this._selectedBasemap&&this._selectedBasemap.id===s.id&&(this._selectedBasemap=null),this.basemaps.splice(a,1),this._refreshUI(),this.onRemove(s),s}return null},onLoad:function(){},onSelectionChange:function(){},onAdd:function(){},onRemove:function(){},onError:function(){},_defaultBasemapGalleryGroupQuery:'title:"ArcGIS Online Basemaps" AND owner:esri',_basemapGalleryGroupQuery:null,_finishStartup:function(){this.loaded=!0,this.onLoad(),0===this.map.layerIds.length&&this.basemaps.length>0&&!this._selectBasemapInProgress&&this._select(this.basemaps[0].id)},_findCustomBasemapsGroup:function(e){this.basemapsGroup&&this.basemapsGroup.id?this._findArcGISBasemaps(this.basemapsGroup.id,e):(this._basemapGalleryGroupQuery='title:"'+this.basemapsGroup.title+'" AND owner:'+this.basemapsGroup.owner,this._findArcGISBasemapsGroup(e))},_findArcGISBasemapsGroup:function(e){if(this._basemapGalleryGroupQuery)this._findArcGISBasemapsGroupContent(e);else{var a=this.arcgisUrl+"/accounts/self",s={};s.f="json",s.culture=r.locale,b({url:a,content:s,callbackParamName:"callback",load:t.hitch(this,function(a){this._basemapGalleryGroupQuery=a&&a.basemapGalleryGroupQuery?a.basemapGalleryGroupQuery:this._defaultBasemapGalleryGroupQuery,this._findArcGISBasemapsGroupContent(e)}),error:t.hitch(this,function(){this._basemapGalleryGroupQuery=this._defaultBasemapGalleryGroupQuery})})}},_findArcGISBasemapsGroupContent:function(e){var a=t.hitch(this,"_findArcGISBasemaps"),s=this.arcgisUrl+"/community/groups",i={};i.q=this._basemapGalleryGroupQuery,i.f="json",b({url:s,content:i,callbackParamName:"callback",load:t.hitch(this,function(s){if(s.results.length>0)a(s.results[0].id,e);else{var i="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(i)}}),error:t.hitch(this,function(){var e="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(e)})})},_findArcGISBasemaps:function(e,a){var s=this.arcgisUrl+"/search",i={};i.q="group:"+e+' AND type:"web map"',i.sortField="name",i.sortOrder="desc",i.num=50,i.f="json",b({url:s,content:i,callbackParamName:"callback",load:t.hitch(this,function(e){if(e.results.length>0)a(e.results);else{var s="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(s)}}),error:t.hitch(this,function(){var e="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(e)})})},_handleArcGISBasemapsResponse:function(e){e.length>0&&(s.forEach(e,function(e){if(this.bingMapsKey||!this.bingMapsKey&&e.title&&-1==e.title.indexOf("Bing Maps")){var a={};if(a.id=this._getUniqueId(),a.title=e.title,a.thumbnailUrl="",e.thumbnail&&e.thumbnail.length&&(a.thumbnailUrl=this.arcgisUrl+"/content/items/"+e.id+"/info/"+e.thumbnail,f.id)){var s=f.id.findCredential(y.urlToObject(this.arcgisUrl).path);s&&(a.thumbnailUrl+="?token="+s.token)}a.itemId=e.id;var i=new w(a,this);this.basemaps.splice(0,0,i)}},this),this._finishStartup())},_refreshUI:function(){this._hasUI&&(p.empty(this.flowContainer),s.forEach(this.basemaps,function(e,a){e.id||(e.id="basemap_"+a),this.flowContainer.appendChild(this._buildNodeLayout(e))},this),p.create("br",{style:{clear:"both"}},this.flowContainer),this._markSelected(this._selectedBasemap))},_buildNodeLayout:function(a){var s="galleryNode_"+a.id,r=p.create("div",{id:s,"class":"esriBasemapGalleryNode"}),n=p.create("a",{href:"javascript:void(0);"},r);i.connect(n,"onclick",t.hitch(this,"_onNodeClick",a));var o=a.title||"";a.thumbnailUrl?p.create("img",{"class":"esriBasemapGalleryThumbnail",src:a.thumbnailUrl,title:o,alt:o},n):p.create("img",{"class":"esriBasemapGalleryThumbnail",src:e.toUrl("./images/transparent.gif"),title:o,alt:o},n);var l=p.create("div",{"class":"esriBasemapGalleryLabelContainer"},r);return p.create("span",{innerHTML:o,alt:o,title:o},l),r},_onNodeClick:function(e,a){a.preventDefault(),this._markSelected(e),this.select(e.id)},_markSelected:function(e){if(e){s.forEach(r.query(".esriBasemapGallerySelectedNode",this.domNode),function(e){d.remove(e,"esriBasemapGallerySelectedNode")});var a=h.byId("galleryNode_"+e.id);a&&d.add(a,"esriBasemapGallerySelectedNode")}},_select:function(e){this._selectBasemapInProgress=!0;var a=this.get(e);if(a){if(a.layers)this._getServiceInfos(a);else{var s=a.getLayers(this.arcgisUrl);t.isArray(s)?this._getServiceInfos(a):s.addCallback(t.hitch(this,function(){this._getServiceInfos(a)}))}this._markSelected(a)}else this._selectBasemapInProgress=!1},_getServiceInfos:function(e){"https:"==location.protocol&&s.forEach(e.layers,function(e){(this._isAgolService(e.url)||this._isHostedService(e.url))&&(e.url=e.url.replace("http:","https:"))},this),this._selectedBasemap=e;var a=[];if(s.forEach(e.layers,function(e){e.url&&e.url.length>0&&!e.isReference&&!e.type&&(e.deferredsPos=a.length,a.push(this._getServiceInfo(e.url)))},this),a.length>0){var i=new c(a);i.addCallback(t.hitch(this,function(a){var i=null;if(s.forEach(e.layers,function(e){if(0===e.deferredsPos||e.deferredsPos){e.serviceInfoResponse=a[e.deferredsPos][1];var s=e.serviceInfoResponse.fullExtent;s||(s=e.serviceInfoResponse.extent),i=i?i.union(new v(s)):new v(s)}},this),this.map.extent){var t=this._getIntersectionPercent(i,this.map.extent);5>t&&this.map.setExtent(i,!0)}this._switchBasemapLayers(e),this._updateReferenceLayer(e)}))}else this._switchBasemapLayers(e),this._updateReferenceLayer(e)},_switchBasemapLayers:function(e){var a=e.layers;if(this.map.layerIds.length>0&&0===this.map.getNumLevels()&&("OpenStreetMap"===a[0].type||a[0].type&&a[0].type.indexOf("BingMaps")>-1||"WebTiledLayer"===a[0].type)){var i="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.";return void this.onError(i)}s.forEach(a,function(e){if(!e.isReference&&e.type&&e.type.indexOf("BingMaps")>-1&&!this.bingMapsKey){var a="esri.dijit.BasemapGallery: Invalid Bing Maps key.";return void this.onError(a)}},this),this._removeBasemapLayers();var t=0;s.forEach(a,function(e){if(!e.isReference){var a,s;if("OpenStreetMap"===e.type){if(this.map.layerIds.length>0&&0===this.map.getNumLevels())return s="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(s);a=new _({id:"layer_osm",opacity:e.opacity})}else if(e.type&&e.type.indexOf("BingMaps")>-1){if(this.map.layerIds.length>0&&0===this.map.getNumLevels())return s="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(s);var i=g.MAP_STYLE_AERIAL_WITH_LABELS;"BingMapsAerial"==e.type?i=g.MAP_STYLE_AERIAL:"BingMapsRoad"==e.type&&(i=g.MAP_STYLE_ROAD),a=new g({id:"layer_bing",bingMapsKey:this.bingMapsKey,mapStyle:i,opacity:e.opacity})}else if("WebTiledLayer"==e.type){if(this.map.layerIds.length>0&&0===this.map.getNumLevels())return s="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(s);var r=e.initialExtent||e.fullExtent;a=new S(e.templateUrl||e.url,{visible:e.visibility,opacity:e.opacity,copyright:e.copyright,fullExtent:e.fullExtent&&new v(e.fullExtent),initialExtent:r&&new v(r),subDomains:e.subDomains,tileInfo:e.tileInfo?new B(e.tileInfo):null,tileServers:e.tileServers})}else if(e.serviceInfoResponse&&e.serviceInfoResponse.mapName)a=(0===this.map.layerIds.length||this.map.getNumLevels()>0)&&e.serviceInfoResponse.singleFusedMapCache===!0?this._loadAsCached(e):this._loadAsDynamic(e);else if(e.serviceInfoResponse&&e.serviceInfoResponse.pixelSizeX){var n=new A;n.bandIds=e.bandIds,!e.bandIds&&e.serviceInfoResponse.bandCount&&parseInt(e.serviceInfoResponse.bandCount)>3&&(n.bandIds=[0,1,2]),a=new L(e.url,{resourceInfo:e.serviceInfoResponse,opacity:e.opacity,visible:e.visibility,imageServiceParameters:n})}a&&(a._basemapGalleryLayerType="basemap",this.map.addLayer(a,t),t++)}},this),this._selectBasemapInProgress=!1,this.onSelectionChange()},_removeBasemapLayers:function(){var e=this.map.layerIds,a=[];s.forEach(e,function(e){var s=this.map.getLayer(e);"basemap"===s._basemapGalleryLayerType&&a.push(s)},this),0===a.length&&e.length>0&&a.push(this.map.getLayer(e[0])),a.length>0&&s.forEach(a,function(e){this.map.removeLayer(e)},this)},_updateReferenceLayer:function(e){var a;for(this._removeReferenceLayer(),a=0;a<e.layers.length;a++)e.layers[a].isReference===!0&&this._addReferenceLayer(e.layers[a])},_removeReferenceLayer:function(){var e;for(e=this.map.layerIds.length-1;e>=0;e--){var a=this.map.layerIds[e],s=this.map.getLayer(a);"reference"===s._basemapGalleryLayerType&&this.map.removeLayer(s)}},_addReferenceLayer:function(e){this._getServiceInfo(e.url,t.hitch(this,"_handleReferenceServiceInfoResponse",e))},_handleReferenceServiceInfoResponse:function(e,a){var s;if(e.serviceInfoResponse=a,a&&a.mapName)s=a.singleFusedMapCache===!0?this._loadAsCached(e):this._loadAsDynamic(e);else if(a&&a.pixelSizeX){var i=new A;i.bandIds=e.bandIds,!e.bandIds&&a.bandCount&&parseInt(a.bandCount)>3&&(i.bandIds=[0,1,2]),s=new L(e.url,{resourceInfo:a,opacity:e.opacity,visible:e.visibility,imageServiceParameters:i})}s&&(s._basemapGalleryLayerType="reference",s.attr("data-reference",!0),this.map.addLayer(s))},_getServiceInfo:function(e,a){var s={};s.f="json";var i=b({url:e,content:s,callbackParamName:"callback",load:function(e,s){a&&a(e,s)},error:t.hitch(this,function(){var e="esri.dijit.BasemapGallery: service not accessible.";this.onError(e)})});return i},_loadAsCached:function(e){var a=[];e.displayLevels||(a=s.map(e.serviceInfoResponse.tileInfo.lods,function(e){return e.level}));var i=null;e.exclusionAreas&&e.exclusionAreas.length&&(i=[],s.forEach(e.exclusionAreas,function(e){i.push({minZoom:e.minZoom,maxZoom:e.maxZoom,minScale:e.minScale,maxScale:e.maxScale,geometry:new v(e.geometry)})}));var t=new I(e.url,{resourceInfo:e.serviceInfoResponse,opacity:e.opacity,visible:e.visibility,exclusionAreas:i,displayLevels:e.displayLevels||a});return t},_loadAsDynamic:function(e){var a=new G(e.url,{resourceInfo:e.serviceInfoResponse,opacity:e.opacity,visible:e.visibility});return e.visibleLayers&&a.setVisibleLayers(e.visibleLayers),a},_getIntersectionPercent:function(e,a){var s=a.intersects(e);if(s){var i=s.getWidth()*s.getHeight(),t=a.getWidth()*a.getHeight();return i/t*100}return 0},_getIds:function(){var e=[];return s.forEach(this.basemaps,function(a){e.push(a.id)},this),e},_getUniqueId:function(){for(var e=","+this._getIds().toString()+",",a=0;;){if(!(e.indexOf(",basemap_"+a+",")>-1))return"basemap_"+a;a++}},_isUniqueId:function(e){var a=","+this._getIds().toString()+",";return-1===a.indexOf(","+e+",")?!0:!1},_isAgolService:function(e){return e?-1!==e.indexOf("/services.arcgisonline.com/")||-1!==e.indexOf("/server.arcgisonline.com/"):!1},_isHostedService:function(e){return e?-1!==e.indexOf(".arcgis.com/"):!1}});return o("extend-esri")&&t.setObject("dijit.BasemapGallery",R,f),R});