// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/lang","dojo/_base/kernel","dojo/_base/sniff","dojo/has","dojo/query","dojo/Deferred","dojo/DeferredList","dojo/dom","dojo/dom-construct","dojo/dom-class","dijit/_Widget","dijit/_Templated","../kernel","../urlUtils","../request","../geometry/Extent","../virtualearth/VETiledLayer","../layers/OpenStreetMapLayer","../layers/ArcGISTiledMapServiceLayer","../layers/ArcGISDynamicMapServiceLayer","../layers/WebTiledLayer","../layers/VectorTileLayer","../layers/TileInfo","../layers/ArcGISImageServiceLayer","../layers/ImageServiceParameters","./Basemap","./_EventedWidget","dojo/text!./templates/BasemapGallery.html"],function(e,s,a,i,t,r,n,o,l,c,p,h,d,u,m,f,y,b,v,g,_,I,G,L,S,B,w,A,U,E,R,j){var x=s([R,m,f],{declaredClass:"esri.dijit.BasemapGallery",widgetsInTemplate:!0,templateString:j,loaded:!1,basemaps:[],bingMapsKey:null,flowContainer:null,_hasUI:!1,_supportsVTL:null,_selectedBasemap:null,_selectBasemapInProgress:!1,_eventMap:{load:!0,"selection-change":!0,add:["basemap"],remove:["basemap"],error:["message"]},constructor:function(e,s){e=e||{},e.map||console.error("esri.dijit.BasemapGallery: Unable to find the 'map' property in parameters"),this.map=e.map,this._hasUI=s?!0:!1,this.bingMapsKey=e.bingMapsKey&&e.bingMapsKey.length>0?e.bingMapsKey:null,this.showArcGISBasemaps=e.showArcGISBasemaps===!1?!1:!0,this.basemaps=e.basemaps||[],this.basemapIds=e.basemapIds,this.referenceIds=e.referenceIds,this.basemapsGroup=e.basemapsGroup,this.arcgisUrl=y.dijit._arcgisUrl,e.portalUrl&&(this.arcgisUrl=e.portalUrl+"/sharing/rest"),this.arcgisUrl.indexOf("://")<0?this.arcgisUrl=window.location.protocol+"//"+this.arcgisUrl:"https:"===window.location.protocol&&(this.arcgisUrl=this.arcgisUrl.replace("http:","https:")),this.init()},init:function(){this.inherited(arguments),a.forEach(this.basemaps,function(e){e.id&&0!==e.id.length||(e.id=this._getUniqueId()),a.forEach(e.layers,function(e){e.opacity=e.opacity>=0?e.opacity:1,e.visibility=!0},this)},this),this.basemapIds&&this.basemapIds.length>0&&a.forEach(this.basemapIds,function(e){var s=this.map.getLayer(e);s._basemapGalleryLayerType="basemap"},this),this.referenceIds&&this.referenceIds.length>0&&a.forEach(this.referenceIds,function(e){var s=this.map.getLayer(e);s._basemapGalleryLayerType="reference",s.attr("data-reference",!0)},this),this.basemapsGroup&&(this.basemapsGroup.owner&&this.basemapsGroup.title||this.basemapsGroup.id)?this._findCustomBasemapsGroup(t.hitch(this,"_handleArcGISBasemapsResponse")):this.showArcGISBasemaps?this._findArcGISBasemapsGroup(t.hitch(this,"_handleArcGISBasemapsResponse")):this._finishStartup(),this._checkVTLSupport().then(t.hitch(this,function(e){this._supportsVTL=e}))},startup:function(){this.loaded?this._refreshUI():i.connect(this,"onLoad",t.hitch(this,function(){this._refreshUI()}))},select:function(e){this._select(e)},getSelected:function(){return this._selectedBasemap},get:function(e){var s;for(s=0;s<this.basemaps.length;s++)if(this.basemaps[s].id===e)return this.basemaps[s];return null},add:function(e){return e&&!e.id?(e.id=this._getUniqueId(),this.basemaps.push(e),this._refreshUI(),this.onAdd(e),!0):e&&this._isUniqueId(e.id)?(this.basemaps.push(e),this._refreshUI(),this.onAdd(e),!0):!1},remove:function(e){var s;for(s=0;s<this.basemaps.length;s++){var a=this.basemaps[s];if(a.id===e)return this._selectedBasemap&&this._selectedBasemap.id===a.id&&(this._selectedBasemap=null),this.basemaps.splice(s,1),this._refreshUI(),this.onRemove(a),a}return null},onLoad:function(){},onSelectionChange:function(){},onAdd:function(){},onRemove:function(){},onError:function(){},_defaultBasemapGalleryGroupQuery:'title:"ArcGIS Online Basemaps" AND owner:esri',_basemapGalleryGroupQuery:null,_finishStartup:function(){this.loaded=!0,this.onLoad(),0===this.map.layerIds.length&&this.basemaps.length>0&&!this._selectBasemapInProgress&&this._select(this.basemaps[0].id)},_findCustomBasemapsGroup:function(e){this.basemapsGroup&&this.basemapsGroup.id?this._findArcGISBasemaps(this.basemapsGroup.id,e):(this._basemapGalleryGroupQuery='title:"'+this.basemapsGroup.title+'" AND owner:'+this.basemapsGroup.owner,this._findArcGISBasemapsGroup(e))},_findArcGISBasemapsGroup:function(e){if(this._basemapGalleryGroupQuery)this._findArcGISBasemapsGroupContent(e);else{var s=this.arcgisUrl+"/portals/self",a={};a.f="json",a.culture=r.locale,v({url:s,content:a,callbackParamName:"callback",load:t.hitch(this,function(s){this._basemapGalleryGroupQuery=s&&s.basemapGalleryGroupQuery?s.basemapGalleryGroupQuery:this._defaultBasemapGalleryGroupQuery,this._findArcGISBasemapsGroupContent(e)}),error:t.hitch(this,function(){this._basemapGalleryGroupQuery=this._defaultBasemapGalleryGroupQuery})})}},_findArcGISBasemapsGroupContent:function(e){var s=t.hitch(this,"_findArcGISBasemaps"),a=this.arcgisUrl+"/community/groups",i={};i.q=this._basemapGalleryGroupQuery,i.f="json",v({url:a,content:i,callbackParamName:"callback",load:t.hitch(this,function(a){if(a.results.length>0)s(a.results[0].id,e);else{var i="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(i)}}),error:t.hitch(this,function(){var e="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(e)})})},_findArcGISBasemaps:function(e,s){var a=this.arcgisUrl+"/search",i={};i.q="group:"+e+' AND type:"web map"',i.sortField="name",i.sortOrder="desc",i.num=50,i.f="json",v({url:a,content:i,callbackParamName:"callback",load:t.hitch(this,function(e){if(e.results.length>0)s(e.results);else{var a="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(a)}}),error:t.hitch(this,function(){var e="esri.dijit.BasemapGallery: could not find group for basemaps.";this.onError(e)})})},_handleArcGISBasemapsResponse:function(e){e.length>0&&(a.forEach(e,function(e){if(this.bingMapsKey||!this.bingMapsKey&&e.title&&-1===e.title.indexOf("Bing Maps")){var s={};if(s.id=this._getUniqueId(),s.title=e.title,s.thumbnailUrl="",e.thumbnail&&e.thumbnail.length&&(s.thumbnailUrl=this.arcgisUrl+"/content/items/"+e.id+"/info/"+e.thumbnail,y.id)){var a=y.id.findCredential(b.urlToObject(this.arcgisUrl).path);a&&(s.thumbnailUrl+="?token="+a.token)}s.itemId=e.id;var i=new E(s,this);this.basemaps.splice(0,0,i)}},this),this._finishStartup())},_refreshUI:function(){this._hasUI&&(d.empty(this.flowContainer),a.forEach(this.basemaps,function(e,s){e.id||(e.id="basemap_"+s),this.flowContainer.appendChild(this._buildNodeLayout(e))},this),d.create("br",{style:{clear:"both"}},this.flowContainer),this._markSelected(this._selectedBasemap))},_buildNodeLayout:function(s){var a="galleryNode_"+s.id,r=d.create("div",{id:a,"class":"esriBasemapGalleryNode"}),n=d.create("a",{href:"javascript:void(0);"},r);i.connect(n,"onclick",t.hitch(this,"_onNodeClick",s));var o=s.title||"";s.thumbnailUrl?d.create("img",{"class":"esriBasemapGalleryThumbnail",src:s.thumbnailUrl,title:o,alt:o},n):d.create("img",{"class":"esriBasemapGalleryThumbnail",src:e.toUrl("./images/transparent.gif"),title:o,alt:o},n);var l=d.create("div",{"class":"esriBasemapGalleryLabelContainer"},r);return d.create("span",{innerHTML:o,alt:o,title:o},l),r},_onNodeClick:function(e,s){s.preventDefault(),this._markSelected(e),this.select(e.id)},_markSelected:function(e){if(e){a.forEach(r.query(".esriBasemapGallerySelectedNode",this.domNode),function(e){u.remove(e,"esriBasemapGallerySelectedNode")});var s=h.byId("galleryNode_"+e.id);s&&u.add(s,"esriBasemapGallerySelectedNode")}},_select:function(e){this._selectBasemapInProgress=!0;var s=this.get(e);if(s){if(s.layers)this._getServiceInfos(s);else{var a=s.getLayers(this.arcgisUrl);t.isArray(a)?this._getServiceInfos(s):a.addCallback(t.hitch(this,function(){this._getServiceInfos(s)}))}this._markSelected(s)}else this._selectBasemapInProgress=!1},_getServiceInfos:function(e){"https:"===location.protocol&&a.forEach(e.layers,function(e){(this._isAgolService(e.url)||this._isHostedService(e.url))&&(e.url=e.url.replace("http:","https:"))},this),this._selectedBasemap=e;var s=[];if(a.forEach(e.layers,function(e){e.url&&e.url.length>0&&!e.isReference&&!e.type&&(e.deferredsPos=s.length,s.push(this._getServiceInfo(e.url)))},this),s.length>0){var i=new p(s);i.addCallback(t.hitch(this,function(s){var i=null;if(a.forEach(e.layers,function(e){if(0===e.deferredsPos||e.deferredsPos){e.serviceInfoResponse=s[e.deferredsPos][1];var a=e.serviceInfoResponse.fullExtent;a||(a=e.serviceInfoResponse.extent),i=i?i.union(new g(a)):new g(a)}},this),this.map.extent){var t=this._getIntersectionPercent(i,this.map.extent);5>t&&this.map.setExtent(i,!0)}this._switchBasemapLayers(e),this._updateReferenceLayer(e)}))}else this._switchBasemapLayers(e),this._updateReferenceLayer(e)},_checkVTLSupport:function(){var s=new c;return n("ie")?s.resolve(!1):e(["../layers/vector-tile"],function(e){var a=e.supported();s.resolve(a)}),s},_switchBasemapLayers:function(e){var s,i=e.layers,t=!1;if(a.forEach(i,function(e){"VectorTileLayer"===e.type&&(t=!0)}),t&&this._supportsVTL!==!0)return s="esri.dijit.BasemapGallery: Unable to switch basemap because layer type is not supported by your current browser version.",void this.onError(s);if(this.map.layerIds.length>0&&0===this.map.getNumLevels()&&("OpenStreetMap"===i[0].type||i[0].type&&i[0].type.indexOf("BingMaps")>-1||"WebTiledLayer"===i[0].type||"VectorTileLayer"===i[0].type))return s="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(s);a.forEach(i,function(e){if(!e.isReference&&e.type&&e.type.indexOf("BingMaps")>-1&&!this.bingMapsKey){var s="esri.dijit.BasemapGallery: Invalid Bing Maps key.";return void this.onError(s)}},this),this._removeBasemapLayers();var r=0;a.forEach(i,function(e){if(!e.isReference){var s,a;if("OpenStreetMap"===e.type){if(this.map.layerIds.length>0&&0===this.map.getNumLevels())return a="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(a);s=new I({id:"layer_osm",opacity:e.opacity})}else if(e.type&&e.type.indexOf("BingMaps")>-1){if(this.map.layerIds.length>0&&0===this.map.getNumLevels())return a="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(a);var i=_.MAP_STYLE_AERIAL_WITH_LABELS;"BingMapsAerial"===e.type?i=_.MAP_STYLE_AERIAL:"BingMapsRoad"===e.type&&(i=_.MAP_STYLE_ROAD),s=new _({id:"layer_bing",bingMapsKey:this.bingMapsKey,mapStyle:i,opacity:e.opacity})}else if("WebTiledLayer"===e.type){if(this.map.layerIds.length>0&&0===this.map.getNumLevels())return a="esri.dijit.BasemapGallery: Unable to switch basemap because new basemap is a tiled service and cannot be loaded as a dynamic layer.",void this.onError(a);var t=e.initialExtent||e.fullExtent;s=new S(e.templateUrl||e.url,{visible:e.visibility,opacity:e.opacity,copyright:e.copyright,fullExtent:e.fullExtent&&new g(e.fullExtent),initialExtent:t&&new g(t),subDomains:e.subDomains,tileInfo:e.tileInfo?new w(e.tileInfo):null,tileServers:e.tileServers})}else if("VectorTileLayer"===e.type)s=new B(e.styleUrl,{visible:e.visibility,opacity:e.opacity});else if(e.serviceInfoResponse&&e.serviceInfoResponse.mapName)s=(0===this.map.layerIds.length||this.map.getNumLevels()>0)&&e.serviceInfoResponse.singleFusedMapCache===!0?this._loadAsCached(e):this._loadAsDynamic(e);else if(e.serviceInfoResponse&&e.serviceInfoResponse.pixelSizeX){var n=new U;n.bandIds=e.bandIds,!e.bandIds&&e.serviceInfoResponse.bandCount&&parseInt(e.serviceInfoResponse.bandCount,10)>3&&(n.bandIds=[0,1,2]),s=new A(e.url,{resourceInfo:e.serviceInfoResponse,opacity:e.opacity,visible:e.visibility,imageServiceParameters:n})}s&&(s._basemapGalleryLayerType="basemap",this.map.addLayer(s,r),r++)}},this),this._selectBasemapInProgress=!1,this.onSelectionChange()},_removeBasemapLayers:function(){var e=this.map.layerIds,s=[];a.forEach(e,function(e){var a=this.map.getLayer(e);"basemap"===a._basemapGalleryLayerType&&s.push(a)},this),0===s.length&&e.length>0&&s.push(this.map.getLayer(e[0])),s.length>0&&a.forEach(s,function(e){this.map.removeLayer(e)},this)},_updateReferenceLayer:function(e){var s;for(this._removeReferenceLayer(),s=0;s<e.layers.length;s++)e.layers[s].isReference===!0&&this._addReferenceLayer(e.layers[s])},_removeReferenceLayer:function(){var e;for(e=this.map.layerIds.length-1;e>=0;e--){var s=this.map.layerIds[e],a=this.map.getLayer(s);"reference"===a._basemapGalleryLayerType&&this.map.removeLayer(a)}},_addReferenceLayer:function(e){"VectorTileLayer"===e.type?this._handleReferenceServiceInfoResponse(e):this._getServiceInfo(e.url,t.hitch(this,"_handleReferenceServiceInfoResponse",e))},_handleReferenceServiceInfoResponse:function(e,s){var a;if(e.serviceInfoResponse=s,"VectorTileLayer"===e.type)a=new B(e.styleUrl,{visible:e.visibility,opacity:e.opacity});else if(s&&s.mapName)a=s.singleFusedMapCache===!0?this._loadAsCached(e):this._loadAsDynamic(e);else if(s&&s.pixelSizeX){var i=new U;i.bandIds=e.bandIds,!e.bandIds&&s.bandCount&&parseInt(s.bandCount,10)>3&&(i.bandIds=[0,1,2]),a=new A(e.url,{resourceInfo:s,opacity:e.opacity,visible:e.visibility,imageServiceParameters:i})}a&&(a._basemapGalleryLayerType="reference",a.attr("data-reference",!0),this.map.addLayer(a))},_getServiceInfo:function(e,s){var a={};a.f="json";var i=v({url:e,content:a,callbackParamName:"callback",load:function(e,a){s&&s(e,a)},error:t.hitch(this,function(){var e="esri.dijit.BasemapGallery: service not accessible.";this.onError(e)})});return i},_loadAsCached:function(e){var s=[];e.displayLevels||(s=a.map(e.serviceInfoResponse.tileInfo.lods,function(e){return e.level}));var i=null;e.exclusionAreas&&e.exclusionAreas.length&&(i=[],a.forEach(e.exclusionAreas,function(e){i.push({minZoom:e.minZoom,maxZoom:e.maxZoom,minScale:e.minScale,maxScale:e.maxScale,geometry:new g(e.geometry)})}));var t=new G(e.url,{resourceInfo:e.serviceInfoResponse,opacity:e.opacity,visible:e.visibility,exclusionAreas:i,displayLevels:e.displayLevels||s});return t},_loadAsDynamic:function(e){var s=new L(e.url,{resourceInfo:e.serviceInfoResponse,opacity:e.opacity,visible:e.visibility});return e.visibleLayers&&s.setVisibleLayers(e.visibleLayers),s},_getIntersectionPercent:function(e,s){var a=s.intersects(e);if(a){var i=a.getWidth()*a.getHeight(),t=s.getWidth()*s.getHeight();return i/t*100}return 0},_getIds:function(){var e=[];return a.forEach(this.basemaps,function(s){e.push(s.id)},this),e},_getUniqueId:function(){for(var e=","+this._getIds().toString()+",",s=0;;){if(!(e.indexOf(",basemap_"+s+",")>-1))return"basemap_"+s;s++}},_isUniqueId:function(e){var s=","+this._getIds().toString()+",";return-1===s.indexOf(","+e+",")?!0:!1},_isAgolService:function(e){return e?-1!==e.indexOf("/services.arcgisonline.com/")||-1!==e.indexOf("/server.arcgisonline.com/"):!1},_isHostedService:function(e){return e?-1!==e.indexOf(".arcgis.com/"):!1}});return o("extend-esri")&&t.setObject("dijit.BasemapGallery",x,y),x});