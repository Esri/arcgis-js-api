// COPYRIGHT © 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/_base/json","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/i18n!../nls/jsapi","dojo/text!./templates/RenderingRule.html","dojo/store/Memory","dojo/store/Observable","dojo/data/ObjectStore","dojo/has","dojo/on","dojo/io-query","dojo/Deferred","dojo/query","../kernel","../lang","../request","../layers/RasterFunction","../geometry/Extent","../geometry/Point","./ColorRampSelector","../renderers/colorUtils","./ColorPicker","./analysis/mixins/browselayers/BrowseLayerMixin","./RasterFunctionEditor/utils","./analysis/ItemTypes","../tasks/generateRenderer","../tasks/AlgorithmicColorRamp","../tasks/MultipartColorRamp","../symbols/SimpleFillSymbol","../Color","../renderers/StretchRenderer","../renderers/UniqueValueRenderer","../renderers/ClassBreaksRenderer","../renderers/colorRampUtils","../renderers/ShadedReliefRenderer","../renderers/ColormapRenderer","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/popup","dijit/Tooltip","dgrid/OnDemandGrid","dgrid/editor","dgrid/Keyboard","dijit/form/NumberTextBox","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","dijit/form/FilteringSelect","dijit/TooltipDialog"],(function(e,t,i,s,a,n,r,l,o,h,u,d,c,m,y,g,f,_,p,R,b,v,S,C,L,T,V,I,F,B,x,M,w,k,D,N,A,q,G,P,U,H,O,E,z,j,W,J,K,Q,X,Y){var Z=e([H,O,E,I],{declaredClass:"esri.dijit.RenderingRule",templateString:h,widgetsInTemplate:!0,layer:null,map:null,hideApplyButton:!1,_renderingRuleObject:null,_rasterFunctionData:[],_rasterFunctionStore:null,_cachedFunctionList:[],_cachedkeyProperties:{},_cachedHistogramsList:{},_cachedRATList:{},_cachedColormapList:{},_pendingDfds:{},_redBandIdStore:null,_greenBandIdStore:null,_blueBandIdStore:null,_donotSaveChanges:!1,_resetBandCombination:!1,_serviceBandCount:3,_defaultBandCombinationFncName:"User Defined Renderer",_firstFncInRenderingRuleList:null,_gammaSliderTooltip:null,_symbologyTypes:{classify:"classify",stretch:"stretch",uniqueValues:"uniqueValues",shadedRelief:"shadedRelief",colormap:"colormap"},_defaultNClasses:5,_defaultMaxClasses:16,_classifyMethods:{naturalBreaks:"natural-breaks",equalInterval:"equal-interval",quantile:"quantile",definedInterval:"defined-interval",manualInterval:"manual-interval"},_isTileImagery:!1,_customFunctionList:{},isSingleTenant:!0,rasterUtilitiesServer:null,portalUrl:null,canPublishImageCollection:!1,constructor:function(t){e.safeMixin(this,t),this._i18n=o,this._defaultBandCombinationFncName=this._i18n.widgets.renderingRule.userDefinedRendererTitle,this._renderingRuleObject=new v},startup:function(){this.inherited(arguments),i.connect(this.rasterFunctionList,"onChange",t.hitch(this,"_onRasterFunctionChange")),i.connect(this.stretchMethodList,"onChange",t.hitch(this,"_onStretchMethodChange")),i.connect(this.gammaSlider,"onChange",t.hitch(this,"_onGammaChange")),i.connect(this.gammaSlider,"onMouseLeave",t.hitch(this,"_onGammaMouseLeave")),i.connect(this._apply,"onclick",t.hitch(this,"_onClickApplyRenderingRule")),i.subscribe("onRenderingRuleApply",t.hitch(this,"_onClickApplyRenderingRule")),i.subscribe("onRenderingRuleReset",t.hitch(this,"_onClickResetRenderingRule")),i.connect(this.shadedReliefAltitudeSlider,"onChange",t.hitch(this,"_onAltitudeSliderChange")),i.connect(this.shadedReliefAzimuthSlider,"onChange",t.hitch(this,"_onAzimuthSliderChange")),this.own(y(this.vectorWarningIcon,"mouseover",t.hitch(this,this._showVectorWarning))),this._onRasterFunctionChange(this.rasterFunctionList.value),this.hideApplyButton&&(this._apply.style.display="none"),this._setupUniqueValuesGrid(),this._setupClassifyGrid(),this._setupStretchStatsGrid(),this._setupClassifyMethodStore(),this._symbologyBlocks=[this.stretchBlock,this.colorRampBlock,this.classifyBlock,this.classifyGridBlock,this.uniqueValuesBlock,this.uniqueValuesGridBlock,this.shadedReliefBlock],n.set(this.messageBlock,"display","none"),this._startupCalled=!0,this.customRFTTooltip=new j({connectId:["rftAddition"],label:this._i18n.widgets.renderingRule.addCustomRFTToolTip})},_getColorMapFunction:function(e){var t=new v;return this.colorRampSelect.colorRampName?t.functionArguments={colorRamp:this.colorRampSelect.colorRampName}:t.functionArguments={Colormap:this.colorRampSelect.colorMap},t.variableName="Raster",t.functionName="Colormap",t},destroy:function(){this._pendingDfds=null,this._gammaSliderTooltip&&(this._gammaSliderTooltip.destroy(),this._gammaSliderTooltip=null),this.inherited(arguments)},_setLayerAttr:function(e){if(e){e!==this.layer&&(this._vectorWarningShown=!1),this.inherited(arguments),this.layer=e,this._isTileImagery="esri.layers.RasterXLayer"===e.declaredClass,this._isTileImagery&&(this.layer.rasterFunctionInfos=[]),this._isElevationData="esriImageServiceDataTypeElevation"===e.serviceDataType||this._isTileImagery&&e.raster&&"Elevation"===e.raster.rasterInfo.keyProperties.Datatype,this._donotSaveChanges=!0,this._firstFncInRenderingRuleList=null,this._stretchReadFromRenderingRule=!1,this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._uniqueValuesColorRamp=null,this._customColorRamp=null,this._fillStretchMethodList(),this._hideStretch();var s=t.hitch(this,"_setupDefaults");this.layer.loaded?this._setupDefaults():i.connect(this.layer,"onLoad",s),this._donotSaveChanges=!1,this.layer.version>10.61&&this.layer.allowRasterFunction&&this.rasterUtilitiesServer&&this.canPublishImageCollection?n.set(this.addRasterFunction,"display","block"):n.set(this.addRasterFunction,"display","none")}},_setupDefaults:function(){this._setupLayout(),this._setDefaultNoneFunctionName(),this._setupBandIdDefaults(),this._setupStretchDefaults(),this._setupRenderingRuleDefaults(),this._setupCustomRFTOption(),this._setupColorRampDefaults(),this._setupSymbologyDefaults(),this._setupClassifyDefaults(),this._setupUniqueValuesDefaults(),this._setupColormapDefaults()},_setupLayout:function(){this._isTileImagery?(this.rasterFunctionBlock.style.display="none",this.imageEnhancementLabel.style.display="none",this.symbologyTypeLabelRow.style.display="none",l.place(this.symbologyTypeSelectRow,this.rasterFunctionBlock,"after")):(this.rasterFunctionBlock.style.display="",this.imageEnhancementLabel.style.display="",this.symbologyTypeLabelRow.style.display="",l.place(this.symbologyTypeSelectRow,this.symbologyTypeLabelRow,"after"),n.set(this.messageBlock,"display","none"))},_setDefaultNoneFunctionName:function(){var e;this.layer.rasterFunctionInfos.some(t.hitch(this,(function(t){if("none"===t.name.toLowerCase())return e=t.name,!0}))),this._defaultNoneFunctionName=e||"None"},_setLayerBandIds:function(e,t){this.layer&&(null==e||Array.isArray(e)&&0===e.length?this.layer.setBandIds(e,t):Array.isArray(e)&&e.length>0&&e.every((function(e){return"number"==typeof e}))&&(this.layer.bandCount>1||1===e.length&&0===e[0])?this.layer.setBandIds(e,t):t||this.layer.refresh())},_setupRFTDefaults:function(){this._setupColorRampDefaults(),this._setupStretchDefaults(),this._setupSymbologyDefaults(),this._setupClassifyDefaults(),this._setupUniqueValuesDefaults(),this._setupColormapDefaults()},_setupCustomRFTOption:function(){var e=this.layer.renderingRule;e&&this._isRFTJson(e)&&this._addCustomRFTOption(e)},_setupRenderingRuleDefaults:function(){if(this.layer){this._rasterFunctionData=[];var e,t=new f;for(e=0;e<this._cachedFunctionList.length;e++){var i=this._cachedFunctionList[e];if(i&&this.layer===i.layer)return this._rasterFunctionData=i.data,this._setupFunctionStore(),t.resolve(),t}return this._fillRasterFunctionList(this.layer)}},_clearClassifyGrid:function(){this._classifyGrid&&this._classifyGrid.set("store",new c(new u({data:[]})))},_setupColormapDefaults:function(){var e=this.layer,i=this.layer.id,s=this.layer.serviceInfo,a=s?s.hasColormap:this.layer.hasColormap,n=this.rasterFunctionList.value;!a||this._cachedColormapList[i]&&this._cachedColormapList[i][n]||n===this._defaultBandCombinationFncName&&e.getColormap().then(t.hitch(this,(function(e){this._cachedColormapList[i]=this._cachedColormapList[i]||{},this._cachedColormapList[i][n]=e,this._updateColormapGrid()})))},_setupClassifyDefaults:function(){if(this.layer&&this.symbologyTypeSelect.store.get(this._symbologyTypes.classify)){this._showClassifyLoadingMsg(),this._clearClassifyGrid(),this._setupClassifyMethodStore(),this._setupClassifyGridDefaults(),this._setupClassifyFieldStore();var e=this.layer,i=this.layer.id,s=this._rasterFunctionStore.get(this.rasterFunctionList.value),a=s.name,n=s&&s.serviceInfo,r=n?n.hasRasterAttributeTable:this.layer.hasRasterAttributeTable,l=n?n.hasHistograms:this.layer.hasHistograms,o=a===this._defaultBandCombinationFncName?this._defaultNoneFunctionName:a;o=o.indexOf(this._i18n.widgets.renderingRule.custom+": ")>-1?new v(this._customFunctionList[this.layer.id][o]):new v({functionName:o}),this._cachedRATList[i]&&this._cachedRATList[i][a]?this._handleRasterAttributeTableClassify(this._cachedRATList[i][a]):r?this.rasterFunctionList.value===this._defaultBandCombinationFncName?e.getRasterAttributeTable().then(t.hitch(this,this._handleRasterAttributeTableClassify)):e.getRenderingRuleAttributeTable({renderingRule:o}).then(t.hitch(this,this._handleRasterAttributeTableClassify)):this._cachedHistogramsList&&this._cachedHistogramsList[i]&&this._cachedHistogramsList[i][a]?this._handleHistogramsResultClassify(this._cachedHistogramsList[this.layer.id][a]):l&&this.rasterFunctionList.value===this._defaultBandCombinationFncName?this._getHistograms(t.hitch(this,this._handleHistogramsResultClassify)):(e.currentVersion>10.1||this._isSingleBitRaster(e.pixelType))&&!this._isMultidimensionalLayer()&&this._getComputeHistograms(t.hitch(this,this._handleHistogramsResultClassify),{renderingRule:o,pixelSize:this._getOverviewPixelSize()})}},_getComputeHistograms:function(e,t){if(this.layer)return this._computeHistogramsTask&&!this._computeHistogramsTask.isResolved()?this._computeHistogramsTask:(this._computeHistogramsTask=this.layer.computeHistograms(t).then(e),this._computeHistogramsTask)},_getHistograms:function(e){if(this.layer)return this._getHistogramsTask&&!this._getHistogramsTask.isResolved()?this._getHistogramsTask:(this._getHistogramsTask=this.layer.getHistograms().then(e),this._getHistogramsTask)},_getOverviewPixelSize:function(){var e=this.layer.extent,t=this.map.width,i=this.map.height,s=(e.xmax-e.xmin)/t,a=(e.ymax-e.ymin)/i,n=e.spatialReference;return new C(s,a,n)},_addUniqueValuesColorRamp:function(e){var t={},i=e&&e.features;i&&i.length&&this._ratContainsColormap(e)&&(this._uniqueValuesColorRampName=this._i18n.widgets.renderingRule.uniqueValuesDefaultColorRamp,t.id=this._uniqueValuesColorRampName,t.name=this._uniqueValuesColorRampName,t.type="multipart",t.colorRamps=[],s.forEach(i,(function(e){var i=e.attributes,s=this._getFeatureRGBValue(i);t.colorRamps.push({fromColor:s,toColor:s})}),this),this._uniqueValuesColorRamp=t,this._setColorRampSelectValue())},_addCustomColorRamp:function(e){if(e){if(this._customColorRamp)return this.colorRampSelect.setSelected(this._customColorRamp);this._customColorRamp=e.toJson(),this._customColorRampName=this._i18n.widgets.renderingRule.customColorRampName,this._customColorRamp.id=this._customColorRampName,this._customColorRamp.name=this._customColorRampName,this.colorRampSelect.addColorRamp(this._customColorRamp),this.colorRampSelect.setSelected(this._customColorRamp)}},_getFeatureRGBValue:function(e){var t,i,s;if(e)return t=this._getCaseInsensitiveFieldValue("red",e),i=this._getCaseInsensitiveFieldValue("green",e),s=this._getCaseInsensitiveFieldValue("blue",e),[t=t>1?t:Math.round(255*t),i=i>1?i:Math.round(255*i),s=s>1?s:Math.round(255*s)]},_getCaseInsensitiveFieldValue:function(e,t){if(t&&e){var i=e.toLowerCase();for(var s in t)if(t.hasOwnProperty(s)&&s.toLowerCase()===i)return t[s]}},_ratContainsColormap:function(e){return!(!e||!e.fields)&&s.some(e.fields,(function(e){if(e&&e.name){var s=e.name.toLowerCase();"red"===s&&(t=!0),"green"===s&&(i=!0),"blue"===s&&(a=!0)}return t&&i&&a}));var t,i,a},_getRATValueClassNameMap:function(e){if(!e||!e.fields)return null;var t,i,s={};return e.fields.forEach((function(e){"classname"!==e.name.toLowerCase()&&"class_name"!==e.name.toLowerCase()||(t=e.name),"value"===e.name.toLowerCase()&&(i=e.name)})),e.features.forEach((function(e){var a=e.attributes;s[a[i]]=t?a[t]:a[i]})),s},_handleRasterAttributeTableClassify:function(e){if(e&&e.features&&e.features.length){var t=this.rasterFunctionList.value;this._cachedRATList[this.layer.id]=this._cachedRATList[this.layer.id]||{},this._cachedRATList[this.layer.id][t]=e,this._setupClassifyNClassesInput(e.features.length),this._setDefaultIntervalSize(),this._addUniqueValuesColorRamp(e),this._setupClassifyFieldStore(),this._setupUniqueValuesFieldStore(),this.symbologyTypeSelect.set("value",this._getDefaultSymbologyType()),this._isClassBreaksRenderer(this.layer.renderer)||this._updateClassifyGrid(),this._isUniqueValueRenderer(this.layer.renderer)||this._updateUniqueValuesGrid()}},_handleHistogramsResultClassify:function(e){if(e&&e.histograms&&e.histograms.length){var t=e.histograms,i=this.rasterFunctionList.value;this._cachedHistogramsList[this.layer.id]=this._cachedHistogramsList[this.layer.id]||{},this._cachedHistogramsList[this.layer.id][i]=t,this._setupClassifyNClassesInput(t[0].counts&&t[0].counts.length),this._setDefaultIntervalSize(),this._setupUniqueValuesFieldStore(),this._getServiceMinAndMax();var s,a,n,r=0,l=[];if(t&&t.length&&t[0].size){for(s=t[0].counts,a=this.minValues.length?this.minValues[0]:t[0].min,n=this.maxValues.length?this.maxValues[0]:t[0].max,r=0;r<s.length-1;r++)l.push(a+(n-a)*r/s.length);l.push(n),t[0].dataPoints=l}this._isClassBreaksRenderer(this.layer.renderer)||this._updateClassifyGrid(),this._isUniqueValueRenderer(this.layer.renderer)||this._updateUniqueValuesGrid()}},_setDefaultIntervalSize:function(){if(this.layer){var e,t,i,a,n,r,l,o,h,u,d=this.layer,c=d.id,m=d.renderer,y=this.rasterFunctionList.value,g=this.classifyFieldSelect.value;this._getServiceMinAndMax(),this._isSelectedRenderingRule(d.renderingRule)&&this._isClassBreaksRenderer(m)&&m.infos&&m.infos.length&&m.attributeField===g&&(t=m.infos.length,e=m.infos[0],n=(m.infos[t-1].maxValue-e.minValue)/t),n||(this._cachedRATList&&this._cachedRATList[c]&&this._cachedRATList[c][y]?(i=this._cachedRATList[c][y],l=o=i.features[0].attributes[g],u=i.features.length,s.forEach(i.features,(function(e){(h=e.attributes[g])<l&&(l=h),h>o&&(o=h)}))):this._cachedHistogramsList&&this._cachedHistogramsList[c]&&this._cachedHistogramsList[c][y]&&(a=this._cachedHistogramsList[c][y],l=this.minValues.length?this.minValues[0]:a[0].min,o=this.maxValues.length?this.maxValues[0]:a[0].max,u=a[0].counts&&a[0].counts.length),r=this.classifyNClassesInput&&this.classifyNClassesInput.value||this._getDefaultNClasses(u),n=(o-l)/r),this.classifyIntervalInput.attr("value",n,!1)}},_setupUniqueValuesDefaults:function(){this.layer&&this.symbologyTypeSelect.store.get(this._symbologyTypes.uniqueValues)&&(this._showUniqueValuesLoadingMsg(),this._setupUniqueValuesGridDefaults())},_setupSymbologyDefaults:function(){this._setupSymbologyStore(),this._setSymbologySelectVisibility()},_setSymbologySelectVisibility:function(){var e=this._canApplyRenderer();r.toggle(this.symbologyTypeBlock,"esriRenderingRuleHidden",!e),r.toggle(this.symbologyTypeBlock,"esriRenderingRuleVisible",e)},_isSingleBitRaster:function(e){return e.replace(/^\D+/g,"")<=8},_setupSymbologyStore:function(){if(this.layer){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value),t=e&&e.serviceInfo?e.serviceInfo:null,i=this.layer.renderer,a=[],n=this.layer,r=t?t.bandCount:n.bandCount,l=t?t.hasRasterAttributeTable:n.hasRasterAttributeTable,o=t?t.pixelType:n.pixelType,h=t?t.hasColormap:n.hasColormap;this._canApplyRenderer()&&(a.push({name:this._symbologyTypes.stretch}),r&&1===r&&(l?(a.push({name:this._symbologyTypes.uniqueValues}),a.push({name:this._symbologyTypes.classify})):(n.currentVersion>=10.3&&a.push({name:this._symbologyTypes.classify}),this._isSingleBitRaster(o)&&this._hasServiceMinMax(n)&&a.push({name:this._symbologyTypes.uniqueValues})))),this._isSelectedRenderingRule(n.renderingRule)&&(this._isUniqueValueRenderer(i)&&!s.some(a,(function(e){return e.name===this._symbologyTypes.uniqueValues}),this)&&a.push({name:this._symbologyTypes.uniqueValues}),this._isClassBreaksRenderer(i)&&!s.some(a,(function(e){return e.name===this._symbologyTypes.classify}),this)&&a.push({name:this._symbologyTypes.classify})),this.rasterFunctionList.value===this._defaultBandCombinationFncName&&(this._isElevationData&&a.push({name:this._symbologyTypes.shadedRelief}),h&&a.push({name:this._symbologyTypes.colormap})),s.forEach(a,(function(e){e.label=this._i18n.widgets.renderingRule[e.name+"Label"],e.id=e.name}),this),this.symbologyTypeSelect.set("store",new u({data:a})),this.symbologyType=this._getDefaultSymbologyType(),this.symbologyType&&this.symbologyTypeSelect.set("value",this.symbologyType),this._onSymbologyTypeChange(this.symbologyType)}},_canApplyRenderer:function(){if(this.layer){var e=this.layer.currentVersion,t=this.rasterFunctionList.value;return e>=10.3||t===this._defaultBandCombinationFncName}},_getDefaultUniqueValuesField:function(e){var t,i=["classname","class_name","class_names"];return s.some(e,(function(e){var a,n=e&&e.name;if(n){if(a=n.toLowerCase(),s.indexOf(i,a)>-1)return t=n,!0;"value"===a&&(t=n)}})),t},_setupUniqueValuesFieldStore:function(){if(this.layer){var e,t=this._i18n.widgets.renderingRule.valueLabel;(e=this._getRasterAttributeTableFields())||(e=[{name:t,alias:t,id:"Value"}]);var i,s=new u({data:e});s&&this.uniqueValuesFieldSelect&&this.uniqueValuesFieldSelect.set("store",s),i=this._isUniqueValueRenderer(this.layer.renderer)?this.layer.renderer.attributeField:this._getDefaultUniqueValuesField(s.data),this.uniqueValuesFieldSelect.attr("value",i,!1)}},_setupStretchStatsGrid:function(){var i=this._i18n.widgets.renderingRule,s={sortable:!1,editor:Q,editOn:"click",autoSave:!0,renderCell:t.hitch(this,this._stretchStatsRenderCell),canEdit:t.hitch(this,(function(){return"6"!==this.stretchMethodList.value}))};this._stretchStatsGrid=new(e([W,K]))({selectionMode:"single",className:"dgrid-autoheight",columns:[J(t.mixin({field:"esriRenderingRuleStretchMin",label:i.minLabel},s)),J(t.mixin({field:"esriRenderingRuleStretchMax",label:i.maxLabel},s)),J(t.mixin({field:"esriRenderingRuleStretchMean",label:i.meanLabel},s)),J(t.mixin({field:"esriRenderingRuleStretchStdv",label:i.stdDevLabel},s))]},this.stretchStatsGrid),this._stretchStatsGrid.startup()},_stretchStatsRenderCell:function(e,t,i){null==t||isNaN(t)?i.innerHTML="":i.innerHTML=Math.round(1e4*t)/1e4},_setupUniqueValuesGrid:function(){this._uniqueValuesGrid=new(e([W,K]))({selectionMode:"single",columns:[{field:"esriRenderingRuleUniqueValuesSymbol",sortable:!1,renderCell:t.hitch(this,(function(e,i,s){var a=l.toDom('<div class = esriRenderingRuleSymbolCell style = "background: rgba( '+e.esriRenderingRuleUniqueValuesSymbol.r+", "+e.esriRenderingRuleUniqueValuesSymbol.g+", "+e.esriRenderingRuleUniqueValuesSymbol.b+","+255*e.esriRenderingRuleUniqueValuesSymbol.a+') " id = EsriRenderingRuleUniqueValuesGrid'+e.id+"></div>");l.place(a,s),e.isesriRenderingRuleColormapData||(a.onclick=t.hitch(this,(function(e){this._openColorPickerPopup(e)})))})),label:this._i18n.widgets.renderingRule.symbolLabel},{field:"esriRenderingRuleUniqueValuesValue",label:this._i18n.widgets.renderingRule.valueLabel},J({field:"esriRenderingRuleUniqueValuesLabel",sortable:!1,label:this._i18n.widgets.renderingRule.labelLabel,editor:X,editOn:"click",autoSave:!0})]},this.uniqueValuesGrid),this._uniqueValuesGrid.startup()},_setupClassifyGrid:function(){this._classifyGrid=new(e([W,K]))({className:"dgrid-autoheight",columns:[{field:"esriRenderingRuleClassifySymbol",sortable:!1,renderCell:t.hitch(this,(function(e,i,s){var a=l.toDom('<div class = esriRenderingRuleSymbolCell style = "background: rgba( '+e.esriRenderingRuleClassifySymbol.r+", "+e.esriRenderingRuleClassifySymbol.g+", "+e.esriRenderingRuleClassifySymbol.b+","+255*e.esriRenderingRuleClassifySymbol.a+') " id = EsriRenderingRuleEditorClassifyGrid'+e.id+"></div>");l.place(a,s),a.onclick=t.hitch(this,(function(e){this._openColorPickerPopup(e)}))})),label:this._i18n.widgets.renderingRule.symbolLabel},J({field:"esriRenderingRuleClassifyValue",label:this._i18n.widgets.renderingRule.upperValueLabel,sortable:!1,editor:Y,editOn:"click",autoSave:!0,autoSelect:!0,get:function(e){return this.editorInstance.constraints={maxValue:e.serviceMaxValue?e.serviceMaxValue:e.maxValue,minValue:e.minValue},"≤ "+Math.floor(1e3*e.maxValue)/1e3},editorArgs:{required:!0,invalidMessage:this._i18n.widgets.renderingRule.outOfRangeMessage,notANumberMessage:this._i18n.widgets.renderingRule.notANumberMessage,blankMessage:this._i18n.widgets.renderingRule.blankMessage,validator:function(e,t){var i=!0;return null!==(e=e.replace("≤","").trim())&&" "!==e&&""!==e?isNaN(e)?(i=!1,this.promptMessage=this.params.notANumberMessage):(e<=t.minValue||e>=t.maxValue)&&(i=!1,this.promptMessage=this.params.invalidMessage):(i=!1,this.promptMessage=this.params.blankMessage),i}},set:t.hitch(this,this._setManualClassBreak)}),J({field:"esriRenderingRuleClassifyLabel",label:this._i18n.widgets.renderingRule.labelLabel,editor:X,editOn:"click",autoSave:!0,sortable:!1})]},this.classifyGrid),this._classifyGrid.startup()},_setManualClassBreak:function(e){if(e.esriRenderingRuleClassifyValue){this.classifyMethodSelect.set("value",this._classifyMethods.manualInterval);var t=this._getIntegerValue(e.esriRenderingRuleClassifyValue.replace("≤","").trim()),i=e.maxValue;e.maxValue=t,e.esriRenderingRuleClassifyLabel=this._createLabelString(e.minValue,e.maxValue),s.some(this._classifySymbolData,(function(e,s){e.minValue===i&&(e.minValue=t,e.esriRenderingRuleClassifyLabel=this._createLabelString(e.minValue,e.maxValue)),e.serviceMaxValue===i&&s!=this._classifySymbolData.length-1&&(e.serviceMaxValue=t)}),this),this._classifyGrid.refresh()}},_createLabelString:function(e,t){return this._getIntegerValue(e)+" "+this._i18n.widgets.renderingRule.toLabel+" "+this._getIntegerValue(t)},_getIntegerValue:function(e){return Math.floor(1e3*e)/1e3},_setupClassifyGridDefaults:function(){if(this.layer&&this._isClassBreaksRenderer(this.layer.renderer)){var e=[],t=this.layer.renderer.infos;s.forEach(t,(function(t){e.push({minValue:t.minValue,maxValue:t.maxValue,esriRenderingRuleClassifySymbol:t.symbol.color,esriRenderingRuleClassifyLabel:t.label})})),this._updateClassifyGrid(e)}},_setupUniqueValuesGridDefaults:function(){if(this.layer&&this._isUniqueValueRenderer(this.layer.renderer)){var e=[],t=this.layer.renderer.infos;s.forEach(t,(function(t){e.push({esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesSymbol:t.symbol.color,esriRenderingRuleUniqueValuesLabel:t.label||t.value})})),this._updateUniqueValuesGrid(e)}},_setupClassifyNClassesInput:function(e){if(this.layer){var t=this._getDefaultMaxClasses(e),i=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.infos.length:this._getDefaultNClasses(e);this.classifyNClassesInput.attr("value",i,!1),this.classifyNClassesInput.set("constraints",{min:0,max:t})}},_getDefaultNClasses:function(e){return void 0===e?this._defaultNClasses:Math.min(this._defaultNClasses,e)},_getDefaultMaxClasses:function(e){return void 0===e?this._defaultMaxClasses:Math.min(this._defaultMaxClasses,e)},_isSelectedRenderingRule:function(e){var t,i=this._getStretchRenderingRule(e),s=this.rasterFunctionList.value;if(!e||this._isNoneRenderingRule(e)){if(this.rasterFunctionList.value===this._defaultBandCombinationFncName)return!0}else if(i){if((t=i.functionArguments)&&this._isSelectedRenderingRule(t.Raster))return!0}else{if(s&&e.functionName.toLowerCase()===s.toLowerCase())return!0;if(this._isRFTJson(e)&&s.toLowerCase().indexOf(e.functionName.toLowerCase())>-1)return!0}},_isUniqueValueRenderer:function(e){return e&&"esri.renderer.UniqueValueRenderer"===e.declaredClass},_isClassBreaksRenderer:function(e){return e&&"esri.renderer.ClassBreaksRenderer"===e.declaredClass},_isStretchRenderer:function(e){return e&&"esri.renderer.StretchRenderer"===e.declaredClass},_isNoneRenderingRule:function(e){return e&&e.functionName&&"none"===e.functionName.toLowerCase()},_isShadedReliefRenderer:function(e){return e&&"esri.renderer.ShadedReliefRenderer"===e.declaredClass},_isColormapRenderer:function(e){return e&&"esri.renderer.ColormapRenderer"===e.declaredClass},_getStretchRenderingRule:function(e){if(e)return e&&e.functionName&&"stretch"===e.functionName.toLowerCase()?e:e&&e.functionName&&"colormap"===e.functionName.toLowerCase()&&e.functionArguments&&e.functionArguments.Raster&&e.functionArguments.Raster.functionName&&"stretch"===e.functionArguments.Raster.functionName.toLowerCase()?e.functionArguments.Raster:void 0},_setupClassifyMethodStore:function(){if(this.layer){var e=[],t=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.classificationMethod:this._classifyMethods.equalInterval;for(var i in this._classifyMethods)this._classifyMethods.hasOwnProperty(i)&&e.push({label:"<div class= 'esriRenderingRuleFilteringSelectLabel'><h4 style='font-weight:bold;'>"+this._i18n.widgets.renderingRule[i]+"</h4><br/><i>"+this._i18n.widgets.renderingRule[i+"Desc"]+"</i></div>",id:this._classifyMethods[i],name:this._i18n.widgets.renderingRule[i]});this.classifyMethodSelect.set("store",new u({data:e})),this.classifyMethodSelect.set("labelType","html"),this.classifyMethodSelect.set("labelAttr","label"),this.classifyMethodSelect.attr("value",t,!1),this._handleClassifyIntervalVisibility(t)}},_setupClassifyFieldStore:function(){if(this.layer){var e,t=this._i18n.widgets.renderingRule.valueLabel,i=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.attributeField:"Value";e=this.layer&&this.layer.rasterAttributeTable?this._getRasterAttributeTableFields(!0):[{name:t,alias:t,id:"Value"}],this.classifyFieldSelect.set("store",new u({data:e})),this.classifyFieldSelect.attr("value",i,!1)}},_getRasterAttributeTableFields:function(e){if(this.layer){var i=this.layer.id,a=this.rasterFunctionList.value,n=this._cachedRATList[i]&&this._cachedRATList[i][a]||this.layer.rasterAttributeTable;if(n){var r,l=t.clone(n.fields);return r=s.filter(l,(function(t){if("esriFieldTypeOID"!==t.type&&(!e||"esriFieldTypeString"!==t.type))return!0})),r=s.map(r,(function(e){return e.id=e.name,e}))}}},_setupFunctionStore:function(){if(this.layer){this._rasterFunctionStore=new u({data:this._rasterFunctionData,idProperty:"name"}),this.rasterFunctionList.set("store",this._rasterFunctionStore),this.rasterFunctionList.set("labelAttr","label"),this.rasterFunctionList.set("labelType","html");var e=this.layer.rasterFunctionInfos;e&&e.length>0&&e[0].name&&(this._firstFncInRenderingRuleList=e[0].name);var t=this.layer.renderingRule,i="";(i=t&&t.functionName&&!this._isNoneRenderingRule(t)?"stretch"!==t.functionName.toLowerCase()&&"colormap"!==t.functionName.toLowerCase()?this._isRFTJson(t)?this._i18n.widgets.renderingRule.custom+": "+t.functionName:t.functionName:this._getRenderingRuleNameFromStretchFunction(t)||this._defaultBandCombinationFncName:this._firstFncInRenderingRuleList&&"none"!==this._firstFncInRenderingRuleList.toLowerCase()&&!this.layer.bandIds?this._firstFncInRenderingRuleList:this._defaultBandCombinationFncName)&&(this._rasterFunctionStore.get(i)||"Colormap"===i)&&(this.rasterFunctionList.set("value",i),this._onRasterFunctionChange())}else console.log("Could not populate renderers as the layer does not exists")},_getExportImageCall:function(){var e=this.layer;if(null!==e&&null!==e.extent){var t=new S(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax,e.extent.spatialReference),i=t.getWidth(),s=t.getHeight();if(i/s>=2||s/i>=2){var a=Math.min(i,s)/2,n=t.getCenter();t.update(n.x-a,n.y-a,n.x+a,n.y+a,e.extent.spatialReference)}var r=t.xmin+","+t.ymin+","+t.xmax+","+t.ymax,l=e._getToken(),o="";return l&&(o="&token="+l),this.layer.url+"/exportImage?bbox="+r+o+"&imageSize=400,400&f=image"}},_fillRasterFunctionList:function(e){if(this.layer){this._rasterFunctionData=[];var i=this._getExportImageCall(),a=this.layer.bandIds,n=i+"&"+g.objectToQuery({renderingRule:'{"rasterFunction":"none"}'});a&&a.length>=3&&(n=n+"&bandIds="+a[0]+","+a[1]+","+a[2]),this._addFunctionItemToList(this._defaultBandCombinationFncName,this._defaultBandCombinationFncName,this._i18n.widgets.renderingRule.userDefinedRendererDesc,n,""),e.rasterFunctionInfos&&e.rasterFunctionInfos.length>0&&s.forEach(e.rasterFunctionInfos,t.hitch(this,(function(e){if("none"!==e.name.toLowerCase()){if(e.thumbnail&&e.thumbnail.length>0)var t=e.thumbnail;else{var s='{"rasterFunction":"'+e.name+'"}';t=i+"&"+g.objectToQuery({renderingRule:s})}this._addFunctionItemToList(e.name,e.name,e.description,t)}})));var r,l={};l.layer=this.layer,l.data=this._rasterFunctionData,this._cachedFunctionList.push(l),s.forEach(this.layer.rasterFunctionInfos,(function(e){r=new v({rasterFunction:e.name}),this.layer.getRenderingRuleServiceInfo(r).then(t.hitch(this,(function(t){s.some(this._rasterFunctionData,(function(i,s){if(i.name===e.name)return this._rasterFunctionData[s].serviceInfo=t,e.name===this.rasterFunctionList.value&&(this._isVectorData(t)&&this._showVectorWarningIcon(),this._setupRFTDefaults()),!0}),this)})))}),this),this._setupFunctionStore()}},_addFunctionItemToList:function(e,t,i,s,a){var n={};n.name=e,n.id=t;var r=i||"";r&&r.length>200&&(r=r.substring(0,200)+"..."),n.description=r,n.serviceInfo=a,n.label="<html><body><section><h4>"+e+":</h4><table cellspacing='5'><tr><td><img src='"+s+"' height='100' width='100'></td><td><p style='white-space:pre-wrap;width:40ex'><i>"+r+"</i></p></td></tr></table></section></body></html>",this._rasterFunctionData.push(n)},_setupColorRampDefaults:function(){if(this.layer){this.layer.pixelType;var e=this.layer.renderingRule;e&&(e.outputPixelType||this.layer.pixelType,e.functionName),this._setColorRampVisibility()}},_setColorRampVisibility:function(){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value),t=e?e.serviceInfo:null;if(!this._canApplyRenderer())return this._hideColorRampSelector();if(this.symbologyType===this._symbologyTypes.stretch){var i=t&&t.bandCount?t.bandCount:this.layer.bandCount,s=t&&t.pixelType?t.pixelType:this.layer.pixelType,a=this.layer.renderer,n=this.layer.renderingRule,r=this._getStretchRenderingRule(n);if(this._isSelectedRenderingRule(this.layer.renderingRule)){if(this._isStretchRenderer(a)&&a.colorRamp&&a.stretchType==this.stretchMethodList.value)return this._showColorRampSelector();if(n&&n.functionName&&"colormap"===n.functionName.toLowerCase()&&(r&&r.StretchType)===this.stretchMethodList.value)return this._showColorRampSelector()}i>1||this.layer.currentVersion<10.3||"u8"!==s.toLowerCase()&&"0"===this.stretchMethodList.value?this._hideColorRampSelector():this._showColorRampSelector()}else this.symbologyType===this._symbologyTypes.colormap?this._hideColorRampSelector():this._showColorRampSelector()},_setColorRampSelectValue:function(){if(this.layer){var e=this.layer.renderer,i=this.layer.renderingRule&&this.layer.renderingRule.functionName;i="none"===i?this._defaultBandCombinationFncName:i;var s=this.rasterFunctionList.value,a=this._isTileImagery||i===s,n=this.layer.renderingRule;if(this.symbologyType===this._symbologyTypes.stretch)this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._isStretchRenderer(e)&&this._isSelectedRenderingRule(this.layer.renderingRule)?this._setRendererColorRamp(e.colorRamp):n&&n.functionName&&"colormap"===n.functionName.toLowerCase()&&n.functionArguments&&n.functionArguments.colorRamp?this.colorRampSelect.setSelected(n.functionArguments.colorRamp):this._setStretchColorRamp();else{var r=e&&e.authoringInfo&&e.authoringInfo.colorRamp?G.fromJson(t.clone(e.authoringInfo.colorRamp)):null;this.symbologyTypeSelect.value===this._symbologyTypes.uniqueValues?(this._uniqueValuesColorRamp&&this.colorRampSelect.addColorRamp(this._uniqueValuesColorRamp),this._isUniqueValueRenderer(e)&&r&&a?this._setRendererColorRamp(r):this._setUniqueValuesColorRamp()):this.symbologyTypeSelect.value===this._symbologyTypes.classify&&(this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._isClassBreaksRenderer(e)&&r?this._setRendererColorRamp(r):this._setClassifyColorRamp())}}},_setRendererColorRamp:function(e){e&&this.layer?this.colorRampSelect.setSelected(e)||this._addCustomColorRamp(e):this.colorRampSelect.reset()},_hideColorRampSelector:function(){n.set(this.colorRampBlock,"display","none"),n.set(this.colorRampLabelBlock,"display","none"),this._colorRampVisible=!1},_showColorRampSelector:function(){this.layer&&(this._setColorRampSelectValue(),n.set(this.colorRampBlock,"display","table-row"),n.set(this.colorRampLabelBlock,"display","table-row"),this._colorRampVisible=!0)},_getDefaultSymbologyType:function(){if(this.layer){if(this._isSelectedRenderingRule(this.layer.renderingRule)){if(this.layer.renderer&&this.layer.renderer.declaredClass){var e=this.layer.renderer.declaredClass;if("esri.renderer.StretchRenderer"===e)return this._symbologyTypes.stretch;if("esri.renderer.ClassBreaksRenderer"===e)return this._symbologyTypes.classify;if("esri.renderer.UniqueValueRenderer"===e)return this._symbologyTypes.uniqueValues;if("esri.renderer.ShadedReliefRenderer"===e)return this._symbologyTypes.shadedRelief;if("esri.renderer.ColormapRenderer"===e)return this._symbologyTypes.colormap}if(this.layer.renderingRule){var t=this.layer.renderingRule;if(t&&t.functionName&&"stretch"===t.functionName.toLowerCase())return this._symbologyTypes.stretch;if(t&&t.functionName&&"colormap"===t.functionName.toLowerCase()&&t.functionArguments&&t.functionArguments.Raster&&t.functionArguments.Raster.functionName&&"stretch"===t.functionArguments.Raster.functionName.toLowerCase())return this._symbologyTypes.stretch}}if(this.rasterFunctionList.value===this._defaultBandCombinationFncName&&this.layer.hasColormap)return this._symbologyTypes.colormap;if(this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][this.rasterFunctionList.value]){var i=this._cachedRATList[this.layer.id][this.rasterFunctionList.value];if(i.features.length&&this._ratContainsColormap(i))return this._symbologyTypes.uniqueValues}return this._canApplyRenderer()?this._symbologyTypes.stretch:void 0}},_setupBandIdDefaults:function(){if(this.layer){var e;e=this.layer.bandCount;var i=this.layer.id,s=this._cachedkeyProperties[i];if(!s&&e>1){this.msgLabel.style.display="",this.msgLabel.innerHTML="<i>"+this._i18n.widgets.renderingRule.bandNamesRequestMsg+"</i>";var a=this.layer.getKeyProperties();this._pendingDfds[i]=1,a.addBoth(t.partial(this._fillBandIdList,this,this.layer))}else this._fillBandIdList(this,this.layer,s);e<3?this._hideBandIds():this._showBandIds()}},_fillBandIdList:function(e,t,i){if(e.layer&&e.layer===t){var s=e._pendingDfds,a=e.layer.id;s&&s[a]&&delete s[a],e.msgLabel.style.display="none",e.msgLabel.innerHTML="";var n,r;n=e.layer.bandCount,i&&i.BandProperties&&i.BandProperties.length>0&&(r=i.BandProperties);var l=e._getBandIdList(n,r,"");e._redBandIdStore=new u({data:l,idProperty:"name"}),e.bandIdsRedList.set("store",e._redBandIdStore),e.bandIdsRedList.set("labelAttr","label"),e.bandIdsRedList.set("labelType","html");var o=e._getBandIdList(n,r,"");e._greenBandIdStore=new u({data:o,idProperty:"name"}),e.bandIdsGreenList.set("store",e._greenBandIdStore),e.bandIdsGreenList.set("labelAttr","label"),e.bandIdsGreenList.set("labelType","html");var h=e._getBandIdList(n,r,"");e._blueBandIdStore=new u({data:h,idProperty:"name"}),e.bandIdsBlueList.set("store",e._blueBandIdStore),e.bandIdsBlueList.set("labelAttr","label"),e.bandIdsBlueList.set("labelType","html");var d=e.layer.bandIds||e._getDefaultBandCombination(n,r);if(d&&d.length>2)e.bandIdsRedList.attr("value",e._getBandName(e._redBandIdStore,d[0]),!1),e.bandIdsGreenList.attr("value",e._getBandName(e._greenBandIdStore,d[1]),!1),e.bandIdsBlueList.attr("value",e._getBandName(e._blueBandIdStore,d[2]),!1);else if(e._redBandIdStore.data.length>0){var c=e._getRedBandIndex(r),m=e._getGreenBandIndex(r),y=e._getBlueBandIndex(r);e.bandIdsRedList.attr("value",e._redBandIdStore.data[c].name,!1),e._greenBandIdStore.data.length>1?e.bandIdsGreenList.attr("value",e._greenBandIdStore.data[m].name,!1):e.bandIdsGreenList.attr("value",e._greenBandIdStore.data[c].name,!1),e._blueBandIdStore.data.length>2?e.bandIdsBlueList.attr("value",e._blueBandIdStore.data[y].name,!1):e._blueBandIdStore.data.length<2?e.bandIdsBlueList.attr("value",e._blueBandIdStore.data[c].name,!1):e.bandIdsBlueList.attr("value",e._blueBandIdStore.data[m].name,!1)}e._cachedkeyProperties[a]=i,e.rasterFunctionList.get("value")===e._defaultBandCombinationFncName&&e._enableBandIds()}},_getDefaultBandCombination:function(e,t){if(1===e)return null;if(2===e)return[0,0,0];var i=[];if(t&&t.length===e){var s=this._getWellKnownBandIndexes(t);null!=s.red&&null!=s.green&&null!=s.blue?i=[s.red,s.green,s.blue]:null!=s.nir&&null!=s.red&&null!=s.green&&(i=[s.nir,s.red,s.green])}return!i&&e>=3&&(i=[0,1,2]),i},_getWellKnownBandIndexes:function(e){for(var t={},i=0;i<e.length;i++){var s=e[i],a=s.BandName&&s.BandName.toLowerCase();if("red"===a)t.red=i;else if("green"===a)t.green=i;else if("blue"===a)t.blue=i;else if("nearinfrared"===a||"nearinfrared_1"===a||"nir"===a)t.nir=i;else if(s.WavelengthMax&&s.WavelengthMin){var n=s.WavelengthMin,r=s.WavelengthMax;null==t.blue&&n>=410&&n<=480&&r>=480&&r<=540?t.blue=i:null==t.green&&n>=490&&n<=560&&r>=560&&r<=610?t.green=i:null==t.red&&n>=595&&n<=670&&r>=660&&r<=730?t.red=i:null==t.nir&&n>=700&&n<=860&&r>=800&&r<=950&&(t.nir=i)}}return t},_getRedBandIndex:function(e){if(!this.layer||!e)return 0;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"red"===e[t].BandName.toLowerCase())return t;return 0},_getGreenBandIndex:function(e){if(!this.layer||!e)return 1;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"green"===e[t].BandName.toLowerCase())return t;return 1},_getBlueBandIndex:function(e){if(!this.layer||!e)return 2;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"blue"===e[t].BandName.toLowerCase())return t;return 2},_getBandIdList:function(e,t,i){if(this.layer){var s=[];i||(i="Black");var a,n=!1;for(t&&e===t.length&&(n=!0),a=0;a<e;a++){var r=a,l=a;n&&t[a]&&t[a].BandName?r=t[a].BandName:r++;var o={};o.name=r,o.index=l,o.label="<html><body><span value="+l+"><font color="+i+">"+r+"</font></span></body></html>",s.push(o)}return s}},_showVectorWarningIcon:function(){n.set(this.vectorWarningIcon,"display","inline-block"),this._vectorWarningShown||this._showVectorWarning()},_showVectorWarning:function(){this._startupCalled&&(z.open({popup:this._vectorTooltipDlg,around:this.vectorWarningIcon,orient:["below"],onCancel:this._hideVectorWarning}),this._vectorWarningShown=!0)},_hideVectorWarning:function(){z.close(this._vectorTooltipDlg)},_hideVectorWarningIcon:function(){n.set(this.vectorWarningIcon,"display","none"),z.close(this._vectorTooltipDlg)},_showClassifyLoadingMsg:function(){n.set(this.classifyLoadingMsg,"display","block")},_hideClassifyLoadingMsg:function(){n.set(this.classifyLoadingMsg,"display","none")},_showUniqueValuesLoadingMsg:function(){n.set(this.uniqueValuesLoadingMsg,"display","block")},_hideUniqueValuesLoadingMsg:function(){n.set(this.uniqueValuesLoadingMsg,"display","none")},_createVectorLayer:function(){var e;e=this.rasterFunctionList.value.indexOf(this._i18n.widgets.renderingRule.custom+": ")>-1?this._customFunctionList[this.layer.id][this.rasterFunctionList.value]:this.rasterFunctionList.value,this.emit("vector-rft-select",{layer:this.layer,rasterFunctionTemplate:e}),this._hideVectorWarning()},_getBandName:function(e,t){if(e&&e.data){var i;for(i=0;i<e.data.length;i++){var s=e.data[i];if(s.index===t)return s.name}return""}},_setupStretchDefaults:function(){if(this.layer){var e=this.layer.renderingRule,t=this._getStretchRenderingRule(e);this._isTileImagery&&this.layer.renderer?this._loadStretchRenderer(this.layer.renderer):this._isSelectedRenderingRule(this.layer.renderingRule)&&(this._isStretchRenderer(this.layer.renderer)||t)?this._isStretchRenderer(this.layer.renderer)?this._loadStretchRenderer(this.layer.renderer):t&&this._loadStretchFunction(t):(this.stretchMethodList.attr("value","0",!1),this._onStretchMethodChange(),this.numStdDevText.set("value",2),this.minPercentText.set("value",2),this.maxPercentText.set("value",2),this.gammaSlider.setValue(0),this._updateStretchStatsGrid(),this._getServiceMinAndMax(),this.minValues&&this.minValues.length>0&&this.maxValues&&this.maxValues.length>0?this.draCheckbox.checked=!1:this.draCheckbox.checked=!this._isMultidimensionalLayer()),this._gammaSliderTooltip||(this._gammaSliderTooltip=new j({connectId:["gammaSliderID"],position:["below","above"],id:"gammaSliderTooltipID"}))}},_isMultidimensionalLayer:function(){return this.layer.hasMultidimensions&&("esri.layers.RasterXLayer"===this.layer.declaredClass||this.layer.version>=10.81)},_hasServiceMinMax:function(e){return e.minValues&&e.minValues.length>0&&e.maxValues&&e.maxValues.length>0},_getServiceMinAndMax:function(){var e=this._getCurrentServiceInfo();this.minValues=e&&e.minValues,this.maxValues=e&&e.maxValues},_loadStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){this._stretchReadFromRenderingRule=!0;var t=e.functionArguments,i=t.StretchType;if(this.stretchMethodList.attr("value",i.toString(),!1),this._onStretchMethodChange(),t.NumberOfStandardDeviations&&this.numStdDevText.set("value",t.NumberOfStandardDeviations),this.draCheckbox.checked=!!t.DRA,t.UseGamma){var s=t.Gamma;t.Gamma.length>0&&(s=t.Gamma[0]);var a=Math.log(s)/Math.log(10);a&&this.gammaSlider.setValue(a)}else this.gammaSlider.setValue(0);t.MinPercent&&this.minPercentText.set("value",t.MinPercent),t.MaxPercent&&this.maxPercentText.set("value",t.MaxPercent),t.Statistics&&t.Statistics.length&&this._loadStretchStats(t.Statistics)}},_loadStretchRenderer:function(e){if(this._isStretchRenderer(e)){this._stretchReadFromRenderingRule=!1;var t=e._convertStretchTypeEnumToIndex(e.stretchType);if(this.stretchMethodList.set("value",t.toString()),this._onStretchMethodChange(),e.numberOfStandardDeviations&&this.numStdDevText.set("value",e.numberOfStandardDeviations),this.draCheckbox.checked=!!e.dra,e.useGamma){var i=e.gamma;e.gamma.length>0&&(i=e.gamma[0]);var s=Math.log(i)/Math.log(10);s&&this.gammaSlider.setValue(s)}else this.gammaSlider.setValue(0);e.minPercent&&this.minPercentText.set("value",e.minPercent),e.maxPercent&&this.maxPercentText.set("value",e.maxPercent),e.statistics&&e.statistics.length&&this._loadStretchStats(e.statistics)}},_loadStretchStats:function(e){e&&e.length?this._populateStatsGrid(e):this._isMultidimensionalLayer()?this._populateStatsGridForMultiDimensionalLayer():(this._updateStretchStatsGrid(),this._setStretchStatsGridVisibility())},_populateStatsGridForMultiDimensionalLayer:function(){var e=this.layer._getDefaultMultidimensionalDefinition(this.layer._multidimensionalInfo),i=this.layer.mosaicRule&&this.layer.mosaicRule.multidimensionalDefinition?this.layer.mosaicRule.multidimensionalDefinition[0].variableName:e.length?e[0].variableName:"";this.layer.getVariableStats(i).then(t.hitch(this,(function(e){this._populateStatsGrid(e)})),t.hitch(this,(function(e){this.draCheckbox.checked=!0})))},_populateStatsGrid:function(e){if(e){var t=this._getValidBandArray(e.length),i=Math.max.apply(null,t);e.length<=i&&(t=[],e.map((function(e,i){t.push(i)})));var a=[];s.forEach(t,(function(t,i){var s=e[t]||e[t-1];a.push({id:i,esriRenderingRuleStretchMin:null!=s[0]?s[0]:s.min,esriRenderingRuleStretchMax:null!=s[1]?s[1]:s.max,esriRenderingRuleStretchMean:null!=s[2]?s[2]:s.mean,esriRenderingRuleStretchStdv:null!=s[3]?s[3]:s.standardDeviation})})),this._updateStretchStatsGrid(a),this._setStretchStatsGridVisibility()}},_getRenderingRuleNameFromStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){var t=e.functionArguments.Raster;return t&&t.functionName||null}},_fillStretchMethodList:function(){this.stretchMethodList.removeOption(this.stretchMethodList.getOptions()),this.stretchMethodList.addOption([{value:"0",label:this._i18n.widgets.renderingRule.noneStretchAlias},{value:"5",label:this._i18n.widgets.renderingRule.minMaxStretchAlias},{value:"3",label:this._i18n.widgets.renderingRule.stdDevStretchAlias},{value:"6",label:this._i18n.widgets.renderingRule.percentClipStretchAlias}]),this.stretchMethodList.set("value","0"),this._onStretchMethodChange()},_onDRAChange:function(){this.symbologyType===this._symbologyTypes.stretch&&"0"!==this.stretchMethodList.value&&(this._updateStretchStatsGrid(),this._setStretchStatsGridVisibility())},_setStretchStatsGridVisibility:function(){var e=this.stretchMethodList.value,t="0"!==e&&!this.draCheckbox.checked&&this._stretchStatsData&&this._stretchStatsData.length?"":"none";r.toggle(this.stretchStatsBlock,"esriRenderingRuleDisabledGrid","6"===e),this.stretchStatsBlock.style.display=t},_getCurrentServiceInfo:function(){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value);return this.rasterFunctionList.value===this._defaultBandCombinationFncName?this.layer:e&&e.serviceInfo?e.serviceInfo:this.layer},_updateStretchStatsGrid:function(e){if(this._stretchStatsGrid){if(!e||"number"==typeof e||"string"==typeof e){if(this._isMultidimensionalLayer())return void this._populateStatsGridForMultiDimensionalLayer();var t,i=this._getCurrentServiceInfo(),a=i&&i.bandCount,n={};e=[],s.forEach(["minValues","maxValues","meanValues","stdvValues"],(function(e){n[e]=i&&i[e]?i[e]:this.layer[e]?this.layer[e]:new Array(a)}),this),t=this._getValidBandArray(a),s.forEach(t,(function(t,i){e.push({id:i,esriRenderingRuleStretchMin:n.minValues[t],esriRenderingRuleStretchMax:n.maxValues[t],esriRenderingRuleStretchMean:n.meanValues[t],esriRenderingRuleStretchStdv:n.stdvValues[t]})}))}e=this._sanitizeStretchStatsData(e);var r=new c(new u({data:e,idProperty:"id"}));this._stretchStatsGrid.set("store",r),this._stretchStatsData=e}},_getValidBandArray:function(e){var t,i,s,a=0,n=1,r=2;return this.rasterFunctionList.value===this._defaultBandCombinationFncName&&e>1&&(t=this._redBandIdStore&&this._redBandIdStore.get(this.bandIdsRedList.value),i=this._greenBandIdStore&&this._greenBandIdStore.get(this.bandIdsGreenList.value),s=this._blueBandIdStore&&this._blueBandIdStore.get(this.bandIdsBlueList.value),a=t?t.index:a,n=i?i.index:n,r=s?s.index:r),e>1?[a,n,r]:[a]},_onSymbologyTypeChange:function(e){if(this.layer){this.symbologyType=e;var t=this.layer.renderer,i=this.layer.renderingRule,s=this._getStretchRenderingRule(i),a=this._isSelectedRenderingRule(i);this._showBlocks([]),e===this._symbologyTypes.classify?(this._showBlocks([this.classifyBlock,this.classifyGridBlock]),this._isClassBreaksRenderer(t)&&a?this._setupClassifyGridDefaults():this._updateClassifyGrid()):e===this._symbologyTypes.uniqueValues?(this._showBlocks([this.uniqueValuesBlock,this.uniqueValuesGridBlock]),this._isUniqueValueRenderer(t)&&a?this._setupUniqueValuesGridDefaults():this._updateUniqueValuesGrid()):e===this._symbologyTypes.stretch?(a?this._isStretchRenderer(t)?this._loadStretchStats(t.statistics):s&&s.functionArguments?this._loadStretchStats(s.functionArguments.Statistics):this._updateStretchStatsGrid():this._updateStretchStatsGrid(),this._showBlocks([this.stretchBlock])):e===this._symbologyTypes.shadedRelief?(this._isShadedReliefRenderer(t)?this._loadShadedReliefWithRenderer(t):this._loadShadedReliefWithDefaults(),this._showBlocks([this.shadedReliefBlock]),this.layer.currentVersion<=10.8?_(".shadedReliefHillShadeTypeBlock",this.domNode).addClass("esriRenderingRuleHidden"):_(".shadedReliefHillShadeTypeBlock",this.domNode).removeClass("esriRenderingRuleHidden"),this._onHillShadeTypeChange(),this._onScalingChange()):e===this._symbologyTypes.colormap&&(this._showBlocks([this.uniqueValuesGridBlock]),this._updateColormapGrid())}},_updateColormapGrid:function(){var e=this._getColormapGridData();e&&e.length&&this._updateUniqueValuesGrid(e)},_loadShadedReliefWithDefaults:function(){this._traditionalRadio.set("checked",!0),this._noneRadio.set("checked",!0),this.shadedReliefAzimuthSlider.set("value",315),this.shadedReliefAltitudeSlider.set("value",45),this.zFactorInput.set("value",1),this.pixelSizePowerInput.set("value",.664),this.pixelSizeFactorInput.set("value",.024),this.colorRampSelect.reset()},_loadShadedReliefWithRenderer:function(e){this.shadedReliefAzimuthSlider.set("value",e.azimuth),this.shadedReliefAltitudeSlider.set("value",e.altitude),this.zFactorInput.set("value",e.zFactor),this.pixelSizePowerInput.set("value",e.pixelSizePower),this.pixelSizeFactorInput.set("value",e.pixelSizeFactor),("traditional"===e.hillshadeType?this._traditionalRadio:this._multidirectionalRadio).set("checked",!0),("none"===e.scalingType?this._noneRadio:this._adjustedRadio).set("checked",!0),e.colorRamp&&this._setRendererColorRamp(e.colorRamp)},_onClassifyFieldChange:function(){this.classifyMethodSelect.value===this._classifyMethods.definedInterval&&this._setDefaultIntervalSize(),this._updateClassifyGrid()},_onClassifyMethodChange:function(e){this.classifyMethodSelect.value!==this._classifyMethods.manualInterval&&(this.classifyMethodSelect.value===this._classifyMethods.definedInterval&&this._setDefaultIntervalSize(),this._handleClassifyIntervalVisibility(e),this._updateClassifyGrid())},_handleClassifyIntervalVisibility:function(e){e===this._classifyMethods.definedInterval?(n.set(this.classifyIntervalsBlock,"display","table-row"),this.classifyNClassesInput.set("disabled",!0)):(n.set(this.classifyIntervalsBlock,"display","none"),this.classifyNClassesInput.set("disabled",!1))},_showBlocks:function(e){s.forEach(this._symbologyBlocks,(function(t){s.indexOf(e,t)>-1?(r.remove(t,"esriRenderingRuleHidden"),r.add(t,"esriRenderingRuleVisible")):(r.remove(t,"esriRenderingRuleVisible"),r.add(t,"esriRenderingRuleHidden"))})),this._setColorRampVisibility()},_onRasterFunctionChange:function(){var e=this.rasterFunctionList.get("value");if(this._removeCustomItemFromList(e),e){var t=this._rasterFunctionStore.get(e).description,i=this._isVectorData(this._getCurrentServiceInfo());this._setupRFTDefaults(),this.rasterFunctionList.set("title",t),i?this._showVectorWarningIcon():this._hideVectorWarningIcon();var s=this.layer.id;this._setColorRampVisibility(),e===this._defaultBandCombinationFncName?(this.rasterFunctionRow.width="",this.layer.bandCount>1?(this._showBandIds(),this._pendingDfds[s]?this._disableBandIds():this._enableBandIds()):this._hideBandIds()):(this.domNode.clientWidth>0&&(this.rasterFunctionRow.width=this.domNode.clientWidth),this._hideBandIds()),e===this._defaultBandCombinationFncName||this.layer.version>=10.3?(this.imageEnhancementLabel.style.display="",this.stretchMethodLabel.style.display="",this.stretchDescLabel.style.display="",this.stretchMethodList.domNode.style.display="",this._onStretchMethodChange()):this._hideStretch()}},_isVectorData:function(e){var t=e&&e.serviceDataType;return"esriImageServiceDataTypeVector-UV"===t||"esriImageServiceDataTypeVector-MagDir"===t},_setClassifyColorRamp:function(){this.colorRampSelect.setSelected("Yellow to Red")},_setUniqueValuesColorRamp:function(){this._uniqueValuesColorRamp?this.colorRampSelect.setSelected(this._uniqueValuesColorRampName):this.colorRampSelect.setSelected("Aspect")},_setStretchColorRamp:function(){this.colorRampSelect.reset()},_updateUniqueValuesGrid:function(e,t){if(this._uniqueValuesGrid&&(e=e&&e.length&&e[0].esriRenderingRuleUniqueValuesSymbol?e:this._getUniqueValuesGridData(t))&&e.length){void 0===e[0].id&&s.forEach(e,(function(e,t){e.id=t}));var i=new d(new u({data:e,idProperty:"id"}));this._uniqueValuesGrid.set("store",i),this._uniqueValuesSymbolData=e,this._hideUniqueValuesLoadingMsg()}},_updateClassifyGrid:function(e,t){if(this._classifyGrid&&(e=e&&e.length&&e[0].esriRenderingRuleClassifySymbol?e:this._getClassifyGridData(t))&&e.length){var i=e[0]?e[0].maxValue-e[0].minValue:this.classifyIntervalInput.value;void 0===e[0].id&&s.forEach(e,(function(e,t){e.id=t}));var a=new c(new u({data:e,idProperty:"id"}));this._classifyGrid.set("store",a),this._classifySymbolData=e,this.classifyIntervalInput.attr("value",i,!1),this.classifyNClassesInput.attr("value",e.length,!1),this._hideClassifyLoadingMsg()}},_openColorPickerPopup:function(e){if(!this._colorPickerOpen){e.stopPropagation(),this._colorPicker||(this._colorPicker=new V({showTransparencySlider:!1}),this._colorPicker.startup());var i,a,n=e.target;this._colorPicker.set("color",n.style.backgroundColor,!1),z.open({popup:this._colorPicker,around:n,orient:["below","above"]}),this._colorPickerOpen=!0,i=y(document.body,"click",t.hitch(this,(function(e){this._colorPicker.domNode.contains(e.target)||e.target===this._colorPicker.domNode||(a.remove(),i.remove(),z.close(this._colorPicker),this._colorPickerOpen=!1)}))),a=y(this._colorPicker,"color-change",t.hitch(this,(function(e){i.remove(),a.remove();var r=e.color,l=this.symbologyType===this._symbologyTypes.classify?parseInt(n.id.replace("EsriRenderingRuleEditorClassifyGrid",""),10):parseInt(n.id.replace("EsriRenderingRuleUniqueValuesGrid",""),10);z.close(this._colorPicker),this._colorPickerOpen=!1,"no-color"===r?n.style.background="rgba(0,0,0,0)":(r.a=1,n.style.background="rgba("+r.r+", "+r.g+","+r.b+", 255)"),this.symbologyType===this._symbologyTypes.classify?s.some(this._classifySymbolData,t.hitch(this,(function(e){if(e.id===l)return e.esriRenderingRuleClassifySymbol={r:r.r,g:r.g,b:r.b,a:r.a}}))):s.some(this._uniqueValuesSymbolData,t.hitch(this,(function(e){if(e.id===l)return e.esriRenderingRuleUniqueValuesSymbol={r:r.r,g:r.g,b:r.b,a:r.a}})))})))}},_onColorRampChange:function(){return this.symbologyType===this._symbologyTypes.uniqueValues?this._updateUniqueValuesGrid(null,!0):this.symbologyType===this._symbologyTypes.classify?this._updateClassifyGrid(null,!0):void 0},_onStretchMethodChange:function(){if(!(this.stretchMethodList.getOptions.length<1)){var e=this.stretchMethodList.get("value");switch("0"===e?this._hideStretchOptions(!0):this._hideStretchOptions(!1),"6"!==e||this.draCheckbox.checked||this._updateStretchStatsGrid(),this._setColorRampVisibility(),this._setStretchStatsGridVisibility(),e){case"0":this.stretchMethodNoneDescBlock.style.display="";break;case"3":this.numStdDevBlock.style.display="";break;case"5":this.stretchMethodMinMaxDescBlock.style.display="";break;case"6":this.minMaxPercentDescBlock.style.display="",this.minPercentBlock.style.display="",this.maxPercentBlock.style.display=""}}},_onClickApplyRenderingRule:function(){if(n.set(this.messageBlock,"display","none"),this._isTileImagery)return this._onRendererApplyClient();this.rasterFunctionList.get("value")!==this._defaultBandCombinationFncName?this._onRasterFunctionApply():this._onBandIdsApply()},_onClickResetRenderingRule:function(){this.layer&&(this.layer.renderingRule=null,this.layer.bandIds=null,this._isTileImagery?this.layer.setDefaultRenderer():this.layer.renderer=null,this._setupDefaults(),this._onClickApplyRenderingRule())},_onRasterFunctionApply:function(){if(!this._donotSaveChanges&&this.layer){var e;this._setLayerBandIds([],!0);var t,i=this.rasterFunctionList.get("value");i.indexOf(this._i18n.widgets.renderingRule.custom+": ")>-1?t=new v(this._customFunctionList[this.layer.id][i]):(t=new v).functionName=i;var s=this._getStretchFunction();this.layer.version>=10.3?this.symbologyType===this._symbologyTypes.stretch&&this._stretchReadFromRenderingRule?s&&(s.functionArguments.Raster=t,this._colorRampVisible&&"none"!==this.colorRampSelect.value?((e=this._getColorMapFunction()).functionArguments.Raster=s,this.layer.setRenderingRule(e)):this.layer.setRenderingRule(s)):(this._onRendererApply(!0),this.layer.setRenderingRule(t)):(this.layer.setRenderer(null,!0),this.layer.setRenderingRule(t))}},_onBandIdsApply:function(){if(!this._donotSaveChanges&&this.layer){var e=new v({functionName:"none"});if(!this._redBandIdStore||!this.bandIdsGreenList||!this.bandIdsBlueList)return this.layer.setRenderingRule(e,!0),void this._onRendererApply(!1);if(this.layer.setRenderingRule(e,!0),this._onRendererApply(!0),this.layer.bandCount>1){var t=[],i=this._redBandIdStore.get(this.bandIdsRedList.value),s=this._greenBandIdStore.get(this.bandIdsGreenList.value),a=this._blueBandIdStore.get(this.bandIdsBlueList.value);i&&s&&a&&(t.push(i.index),t.push(s.index),t.push(a.index)),this._setLayerBandIds(t)}else this.layer.refresh()}},_onRendererApply:function(e){!this._donotSaveChanges&&this.layer&&(this.symbologyType===this._symbologyTypes.classify?this._onClassifyApply(e):this.symbologyType===this._symbologyTypes.uniqueValues?this._onUniqueValuesApply(e):this.symbologyType===this._symbologyTypes.shadedRelief?this._onShadedReliefApply(e):this.symbologyType===this._symbologyTypes.colormap?this._onColormapApply(e):this._onStretchApply(e))},_onRendererApplyClient:function(){if(!this._donotSaveChanges&&this.layer){if(this.layer.bandCount>1){var e=[],t=this._redBandIdStore.get(this.bandIdsRedList.value),i=this._greenBandIdStore.get(this.bandIdsGreenList.value),s=this._blueBandIdStore.get(this.bandIdsBlueList.value);t&&i&&s&&(e.push(t.index),e.push(i.index),e.push(s.index)),this._bandIds=e}this.symbologyType===this._symbologyTypes.classify?this._onClassifyApply(!1):this.symbologyType===this._symbologyTypes.uniqueValues?this._onUniqueValuesApply(!1):this.symbologyType===this._symbologyTypes.shadedRelief?this._onShadedReliefApply(!1):this.symbologyType===this._symbologyTypes.colormap?this._onColormapApply(!1):this._onStretchApply(!1)}},_onStretchApply:function(e){if(!this._donotSaveChanges&&this.layer)if(this._stretchReadFromRenderingRule){var t,i=this._getStretchFunction();this._colorRampVisible&&"none"!==this.colorRampSelect.value?((t=this._getColorMapFunction()).functionArguments.Raster=i,this.layer.setRenderingRule(t)):this.layer.setRenderingRule(i,e)}else{if(!("0"!==this.stretchMethodList.value||this._colorRampVisible&&"none"!=this.colorRampSelect.value||this._isTileImagery))return this.layer.setRenderer(null,e);var s=new N,a=this.stretchMethodList.get("value");s.stretchType=s._convertStretchTypeIndexToEnum(parseInt(a,10)),s.dra=!!this.draCheckbox.checked;var n=Math.exp(this.gammaSlider.value*Math.log(10));n=parseFloat(parseFloat(n).toFixed(2));var r=[];r.push(n),this.layer.bandCount>1&&(r.push(n),r.push(n)),6==a&&(s.minPercent=this.minPercentText.value,s.maxPercent=this.maxPercentText.value),3==a&&(s.numberOfStandardDeviations=this.numStdDevText.value),s.statistics=this._getStretchStats(),s.gamma=r,s.useGamma=!0,s.outputPixelType="U8",this._colorRampVisible&&"none"!==this.colorRampSelect.value&&(s.colorRamp=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName)),this._isTileImagery?(this._bandIds&&this._bandIds.length>0&&this._setLayerBandIds(this._bandIds,!0),"none"===s.stretchType&&(s.dra=!1,s.useGamma=!1,s.gamma=this.layer.bandCount>1?[1,1,1]:[1]),this.layer.setRenderer(s),this.layer.redraw()):this.layer.setRenderer(s,e)}},_getStretchStats:function(){var e=this._getCurrentServiceInfo().bandCount,t=[],i=this._stretchStatsData;if(e&&!this.draCheckbox.checked&&"6"!==this.stretchMethodList.value&&"0"!==this.stretchMethodList.value&&this._isStretchGridDataValid()){var s;for(s=0;s<Math.min(e,3);s++)t.push([i[s].esriRenderingRuleStretchMin,i[s].esriRenderingRuleStretchMax,i[s].esriRenderingRuleStretchMean,i[s].esriRenderingRuleStretchStdv]);return t}return[]},_onShadedReliefApply:function(e){var t=new P,i=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName);i&&(t.colorRamp=i),t.hillshadeType=this._traditionalRadio.get("checked")?"traditional":"multi-directional",t.azimuth=this.azimuthValueInput.get("value"),t.altitude=this.altitudeValueInput.get("value"),t.zFactor=this.zFactorInput.get("value"),t.pixelSizePower=this.pixelSizePowerInput.get("value"),t.pixelSizeFactor=this.pixelSizeFactorInput.get("value"),t.scalingType=this._noneRadio.get("checked")?"none":"adjusted",this.layer.setRenderer(t,e)},_onColormapApply:function(e){var t=new U,i=[];this._uniqueValuesSymbolData.forEach((function(e){if(e.isesriRenderingRuleColormapData){var t={};t.value=e.esriRenderingRuleUniqueValuesValue,t.color=[e.esriRenderingRuleUniqueValuesSymbol.r,e.esriRenderingRuleUniqueValuesSymbol.g,e.esriRenderingRuleUniqueValuesSymbol.b],t.label=e.esriRenderingRuleUniqueValuesLabel,i.push(t)}})),i.length&&(t.colormapInfos=i,this.layer.setRenderer(t,e))},_onUniqueValuesApply:function(e){var t=new A,i=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName);i&&(t.authoringInfo={},t.authoringInfo.colorRamp=i.toJson()),t.infos=this._getUniqueValueInfos(this._uniqueValuesSymbolData),t.attributeField=this.uniqueValuesFieldSelect.value,this.layer.setRenderer(t,e)},_getUniqueValueInfos:function(e){var t,i=[];return s.forEach(e,(function(e){t=e.esriRenderingRuleUniqueValuesSymbol,(isNaN(t.r)||isNaN(t.g)||isNaN(t.b))&&(t={r:0,g:0,b:0,a:0});var s=new k("solid",null,new D(t));i.push({value:e.esriRenderingRuleUniqueValuesValue,label:e.esriRenderingRuleUniqueValuesLabel.toString(),symbol:s})})),i},_onClassifyApply:function(e){var t,i;i=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName),t=new q({field:this.classifyFieldSelect.value,showInAscendingOrder:!0,classificationMethod:this.classifyMethodSelect.value}),i&&(t.authoringInfo={},t.authoringInfo.colorRamp=i.toJson()),t.infos=this._getClassBreakInfos(),t.minimumBreak=t.infos.minValue,t.attributeField=this.classifyFieldSelect.value,this.layer.setRenderer(t,e)},_getClassBreakInfos:function(){var e,t,i=[];return s.forEach(this._classifySymbolData,(function(s,a){e=s.esriRenderingRuleClassifySymbol,(isNaN(e.r)||isNaN(e.g)||isNaN(e.b))&&(e={r:0,g:0,b:0,a:0}),t=new k("solid",null,new D(e)),i.push({minValue:s.minValue,maxValue:s.maxValue,label:s.esriRenderingRuleClassifyLabel,symbol:t})})),i},_getStretchFunction:function(){var e=null;return"0"!==this.stretchMethodList.get("value")&&((e=new v).functionName="Stretch",this._buildStretchFunction(e)),e},_buildStretchFunction:function(e){e.functionName="Stretch";var t=this.stretchMethodList.get("value"),i={};i.StretchType=parseInt(t,10),i.DRA=!!this.draCheckbox.checked;var s=Math.exp(this.gammaSlider.value*Math.log(10));s=parseFloat(parseFloat(s).toFixed(2));var a=[];a.push(s),this.layer.bandCount>1&&(a.push(s),a.push(s)),i.Gamma=a,i.UseGamma=!0,"3"===t?(i.NumberOfStandardDeviations=this.numStdDevText.value,e.outputPixelType="U8"):"6"===t?(i.MinPercent=parseFloat(this.minPercentText.value),i.MaxPercent=parseFloat(this.maxPercentText.value),e.outputPixelType="U8"):"5"===t&&(e.outputPixelType="U8"),i.Statistics=this._getStretchStats(),e.functionArguments=i},_onGammaChange:function(e){var t=this._gammaSliderTooltip;if(t&&this.symbologyTypeSelect.value===this._symbologyTypes.stretch){var i=Math.exp(e*Math.log(10));t.label=i?parseFloat(i).toFixed(2):e,t.open("gammaSliderID")}},_onGammaMouseLeave:function(){this.gammaTooltipClose()},_onAltitudeChange:function(e){var t=this._altitudeSliderTooltip;t&&this.symbologyTypeSelect.value===this._symbologyTypes.shadedRelief&&(t.label=parseFloat(e).toFixed(2),t.open("altitudeSliderID"))},_onAzimuthChange:function(e){var t=this._azimuthSliderTooltip;t&&this.symbologyTypeSelect.value===this._symbologyTypes.shadedRelief&&(t.label=parseFloat(e).toFixed(2),t.open("azimuthSliderID"))},_disableBandIds:function(){this.bandIdsRedList.set("disabled",!0),this.bandIdsGreenList.set("disabled",!0),this.bandIdsBlueList.set("disabled",!0),this.bandIdsLabel.style.color="Gray"},_enableBandIds:function(){this.bandIdsRedList.set("disabled",!1),this.bandIdsGreenList.set("disabled",!1),this.bandIdsBlueList.set("disabled",!1),""===this.bandIdsRedList.value&&this.bandIdsRedList.attr("value","1",!1),""===this.bandIdsGreenList.value&&this.bandIdsGreenList.attr("value","2",!1),""===this.bandIdsBlueList.value&&this.bandIdsBlueList.attr("value","3",!1),this._isStretchRenderer(this.layer.renderer)||this._getStretchFunction(this.layer.renderingRule)||this._updateStretchStatsGrid(),this.bandIdsLabel.style.color="Black"},_showBandIds:function(){this.bandIdsLabelBlock.style.display="",this.bandIdsBlock.style.display="",this.bandIdsMsgBlock.style.display=""},_hideBandIds:function(){this.bandIdsLabelBlock.style.display="none",this.bandIdsBlock.style.display="none",this.bandIdsMsgBlock.style.display="none"},_hideStretch:function(){this.imageEnhancementLabel.style.display="none",this.stretchDescLabel.style.display="none",this.stretchMethodLabel.style.display="none",this.stretchMethodList.domNode.style.display="none",this._hideStretchOptions(!0)},_hideStretchOptions:function(e){var t="";e&&(t="none"),this.gammaBlock.style.display=t,this.draBlock.style.display=t,this.stretchMethodNoneDescBlock.style.display="none",this.stretchMethodMinMaxDescBlock.style.display="none",this.numStdDevBlock.style.display="none",this.minMaxPercentDescBlock.style.display="none",this.minPercentBlock.style.display="none",this.maxPercentBlock.style.display="none",this.stretchStatsBlock.style.display="none"},_getDefaultRedBandIndex:function(){var e;return this._redBandIdStore&&(e=this._redBandIdStore.get("Red")),e||(e=1),e},_getClassifyGridData:function(e){this.classifyMethod=this.classifyMethodSelect.value===this._classifyMethods.manualInterval?this.classifyMethod:this.classifyMethodSelect.value;var t=Math.min(this.classifyNClassesInput.value,this.classifyNClassesInput.constraints&&this.classifyNClassesInput.constraints.max),i=this.colorRampSelect.colorRamp,a=this.classifyIntervalInput.value,n=this.classifyFieldSelect.value;if(this._classifySymbolData||(e=!1),this.layer&&this.classifyMethod&&t&&i){var r=e?this._classifySymbolData:this._getClassBreaks(this.classifyMethod,t,n,a);if(r){var l,o=G.convertColorRampToColormap(i,r.length),h=e?this._classifySymbolData:[];return t=r.length,s.forEach(r,(function(i,s){l={r:o[s][1],g:o[s][2],b:o[s][3],a:1},e?h[s].esriRenderingRuleClassifySymbol=l:h.push({esriRenderingRuleClassifySymbol:l,minValue:i.minValue,maxValue:i.maxValue,serviceMaxValue:s===t-1?i.maxValue:r[s+1].maxValue,esriRenderingRuleClassifyLabel:this._createLabelString(i.minValue,i.maxValue)})}),this),h}}},_getClassBreaks:function(e,t,i,a){var n,r,l,o=this._cachedHistogramsList&&this._cachedHistogramsList[this.layer.id]?this._cachedHistogramsList[this.layer.id][this.rasterFunctionList.value]:null,h=this._cachedRATList&&this._cachedRATList[this.layer.id]?this._cachedRATList[this.layer.id][this.rasterFunctionList.value]:null;if(this.layer&&(h||o)){if(h){var u=h.features,d=[];return u.sort(this._getSortFeaturesFun(i)),n=r=u[0].attributes[i],s.forEach(u,(function(e){e.attributes.Count&&d.push(e.attributes.Count),(l=e.attributes[i])<n&&(n=l),l>r&&(r=l)})),a&&(r-n)/a>16&&(a=(r-n)/16),x.calculateClassBreaks(u,null,i,null,null,e,t,null,d,a)}return o&&o.length&&o[0].dataPoints&&o[0].counts?(n=o[0].dataPoints[0],r=o[0].dataPoints[o[0].dataPoints.length-1],a&&(r-n)/a>16&&(a=(r-n)/16),x.calculateClassBreaks(null,o[0].dataPoints,null,null,null,e,t,null,o[0].counts,a)):void 0}},_getSortFeaturesFun:function(e){return function(t,i){return(t=t.attributes[e])-(i=i.attributes[e])}},_getUniqueValuesGridData:function(e){var t=this._getCurrentServiceInfo(),i=t&&t.hasRasterAttributeTable?t.hasRasterAttributeTable:this.layer.hasRasterAttributeTable,a=this.layer.rasterAttributeTable,n=this.rasterFunctionList.value,r=this._cachedHistogramsList&&this._cachedHistogramsList[this.layer.id]?this._cachedHistogramsList[this.layer.id][this.rasterFunctionList.value]:null,l=r&&r.length&&r[0].dataPoints;n!==this._defaultBandCombinationFncName&&this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][n]&&(a=this._cachedRATList[this.layer.id][n]);var o,h,u,d,c,m,y=this.colorRampSelect.colorRamp,g=this.uniqueValuesFieldSelect.value,f=y&&y.colorRamps?y.colorRamps.length:1,_=[],p=[],b=0,v=0;if(e?p=o=this._uniqueValuesSymbolData:i?(o=a.features,o=this._sortFeatures(o,g)):l&&(o=r[0].dataPoints),y&&o&&g){for(v=0;v<f;v++)_[v]={},_[v].start=b,_[v].end=b+1/f,b=_[v].end;return s.forEach(o,(function(t,i){if(y&&y.colorRamps&&this._uniqueValuesColorRamp&&this._uniqueValuesColorRamp.colorRamps&&G.colorsEqual(y.colorRamps,this._uniqueValuesColorRamp.colorRamps)){if(t.features&&t.features[0]){var a=this._getFeatureRGBValue(t.features[0].attributes);e?t.esriRenderingRuleUniqueValuesSymbol={r:a[0],g:a[1],b:a[2],a:1}:p.push({esriRenderingRuleUniqueValuesSymbol:{r:a[0],g:a[1],b:a[2],a:1},esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesLabel:R.isDefined(t.value)?t.value.toString():"",features:t.features})}}else c=(i+.5)/o.length,s.forEach(_,(function(s,a){if(c>=s.start&&c<s.end)if(m=(c-s.start)/(s.end-s.start),_.length>1?(h=T.getDojoColor(y.colorRamps[a].fromColor),u=T.getDojoColor(y.colorRamps[a].toColor)):(h=T.getDojoColor(y.fromColor),u=T.getDojoColor(y.toColor)),d=G.interpolateLabColor(h,u,m),e)o[i].esriRenderingRuleUniqueValuesSymbol=T.correctRGBLimits(d);else{var n=l?Math.round(t):t.value;p.push({esriRenderingRuleUniqueValuesSymbol:T.correctRGBLimits(d),esriRenderingRuleUniqueValuesValue:n,esriRenderingRuleUniqueValuesLabel:R.isDefined(n)?n.toString():"",features:l?t:t.features})}}),this)}),this),p.sort((function(e,t){return(e.features[0].attributes.Value||e.features[0].attributes.value||0)-(t.features[0].attributes.Value||t.features[0].attributes.value||0)}))}},_areFieldValuesUnique:function(e,t){var i=[];return!s.some(t,(function(t){if(i.indexOf(t.attributes[e])>-1)return!0;i.push(t.attributes[e])}))},_sortFeatures:function(e,i){if(e&&i){e=t.clone(e);var a=[],n=[];return this._areFieldValuesUnique(i,e)||e.sort(t.hitch(this,(function(e,t){if("string"==typeof e.attributes[i]){var s=e.attributes[i],a=t.attributes[i];return this._isRangeValue(s,a)&&(s=parseFloat(s.split("-")[0]),a=parseFloat(a.split("-")[0])),s<a?-1:1}return e.attributes[i]-t.attributes[i]}))),s.forEach(e,(function(e,t){var s=e.attributes[i];t>0&&n.indexOf(s)>-1?a[n.indexOf(s)].features.push(e):(n.push(s),a.push({value:s,features:[e]}))})),a}},_isRangeValue:function(e,t){return(e&&e.indexOf("-")>=0||t&&t.indexOf("-")>=0)&&!isNaN(parseFloat(e.split("-")[0]))},_getColorRGB:function(e){return{r:e[0],g:e[1],b:e[2]}},_isStretchGridDataValid:function(){var e,t=this._stretchStatsData;return!(!t||!t.length)&&s.some(t,(function(t){for(var i in t)if(e=t[i],t.hasOwnProperty(i)&&"id"!==i&&null!=e&&!isNaN(e))return!0}))},_sanitizeStretchStatsData:function(e){if(e)return s.forEach(e,(function(e){for(var t in e)void 0===e[t]&&(e[t]=null)})),e},_convertColorRamps:function(e,t){if(e){var i=null;if(e.type&&"multipart"==e.type.toLowerCase()){i=new w;var a=[];s.forEach(e.colorRamps,(function(e){var t=new M;t.algorithm="hsv",t.fromColor=new D(e.fromColor),t.toColor=new D(e.toColor),a.push(t)})),i.colorRamps=a}else(i=new M).algorithm="hsv",i.fromColor=new D(e.fromColor),i.toColor=new D(e.toColor);return i.name=t,i}},gammaTooltipClose:function(){this._gammaSliderTooltip&&this._gammaSliderTooltip.close()},_onHillShadeTypeChange:function(){this._traditionalRadio.get("checked")?(_(".shadedReliefAzimuthBlock",this.domNode).removeClass("esriRenderingRuleHidden"),_(".shadedReliefAltitudeBlock",this.domNode).removeClass("esriRenderingRuleHidden")):(_(".shadedReliefAzimuthBlock",this.domNode).addClass("esriRenderingRuleHidden"),_(".shadedReliefAltitudeBlock",this.domNode).addClass("esriRenderingRuleHidden"))},_onScalingChange:function(){this._noneRadio.get("checked")?(_(".shadedReliefPixelSizePowerBlock",this.domNode).addClass("esriRenderingRuleHidden"),_(".shadedReliefPixelSizeFactorBlock",this.domNode).addClass("esriRenderingRuleHidden")):(_(".shadedReliefPixelSizePowerBlock",this.domNode).removeClass("esriRenderingRuleHidden"),_(".shadedReliefPixelSizeFactorBlock",this.domNode).removeClass("esriRenderingRuleHidden"))},_onAzimuthKeyDown:function(e){R.isObject(e)&&13===e.keyCode&&(e=this.azimuthValueInput.get("value"),this._onAzimuthValueChange(e))},_onAltitudeKeyDown:function(e){R.isObject(e)&&13===e.keyCode&&(e=this.altitudeValueInput.get("value"),this._onAltitudeValueChange(e))},_onAzimuthValueChange:function(e){this.shadedReliefAzimuthSlider.set("value",e)},_onAltitudeValueChange:function(e){R.isObject(e)&&13===e.keyCode&&(e=this.altitudeValueInput.get("value")),this.shadedReliefAltitudeSlider.set("value",e)},_onAltitudeSliderChange:function(e){this.altitudeValueInput.set("value",parseFloat(e.toFixed(2)))},_onAzimuthSliderChange:function(e){this.azimuthValueInput.set("value",parseFloat(e.toFixed(2)))},_getColormapGridData:function(){var e=[];if(this._isColormapRenderer(this.layer.renderer)){this.layer.renderer.colormapInfos.forEach((function(t){var i=t.color;e.push({esriRenderingRuleUniqueValuesSymbol:{r:i[0],g:i[1],b:i[2],a:1},esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesLabel:t.label,isesriRenderingRuleColormapData:!0})}))}else{var t=this.rasterFunctionList.value,i=this._cachedColormapList[this.layer.id]&&this._cachedColormapList[this.layer.id][t],s=this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][t],a=this._ratContainsColormap(s);if(a)var n=this._getRATValueClassNameMap(s);i&&i.colormap&&i.colormap.forEach((function(t){e.push({esriRenderingRuleUniqueValuesSymbol:{r:t[1],g:t[2],b:t[3],a:1},esriRenderingRuleUniqueValuesValue:t[0],esriRenderingRuleUniqueValuesLabel:a?n[t[0]]||"":t[0],isesriRenderingRuleColormapData:!0})}))}return e},_addCustomRasterFunction:function(){this.useArcGISComponents=!0;var e=[B.RFT];this.defaultItemTypes=[],this.set("allowedItemTypes",e),this.set("availableItemTypeFilters",["rasterFunctionTemplates"]),this._createBrowseItems({disableLAAL:!0,disableBoundary:!0,title:this._i18n.common.browseRFTs,showRFTSystemSection:!1,showRFTEditCustomAction:!1})},_handleSelectRFTTool:function(e){this._fetchRFT(e)},_fetchRFT:function(e){n.set(this.messageBlock,"display","table-cell");var i=t.hitch(this,(function(e){return e})),s=t.hitch(this,this._handleErrorWithCustomRFT),a=t.hitch(this,this._processRFT);F.fetchRFT(e,i,s,a,this.rasterUtilitiesServer)},_processRFT:function(e){var i=t.hitch(this,this._handleErrorWithCustomRFT,"customTemplateValidateFailure");this.layer.getRenderingRuleServiceInfo(new v(e),i).then(t.hitch(this,(function(t){t?(this._addCustomRFTOption(e,t),n.set(this.messageBlock,"display","none")):this._handleErrorWithCustomRFT("customTemplateValidateFailure")})))},_handleErrorWithCustomRFT:function(e){var t={errorRetrievingRFTItem:this._i18n.applyRFxTemplateTool.errorRetrievingRFTItem,errorUtilitiesServiceNotAvailable:this._i18n.applyRFxTemplateTool.errorUtilitiesServiceNotAvailable,errorFetchingRFT:this._i18n.applyRFxTemplateTool.errorFetchingRFT,customTemplateValidateFailure:this._i18n.widgets.renderingRule.customTemplateValidateFailure};this.customRFTMessage.innerText=e?t[e]||e.message:t.errorFetchingRFT},_addCustomRFTOption:function(e,t){var i={name:this._i18n.widgets.renderingRule.custom+": "+e.name,function:e};this._removeCustomItemFromList(i.name,!0),this._customFunctionList[this.layer.id]={},this._customFunctionList[this.layer.id][i.name]=i.function;var s=e.thumbnailEx||this._getExportImageCall()+"&"+g.objectToQuery({renderingRule:a.toJson(e)});this._addFunctionItemToList(i.name,i.name,e.description,s,t),this._rasterFunctionStore.setData(this._rasterFunctionData),this.rasterFunctionList.set("value",i.name)},_removeCustomItemFromList:function(e,i){this._rasterFunctionStore.query(t.hitch(this,(function(t){return t.name.indexOf(this._i18n.widgets.renderingRule.custom+": ")>-1&&(i?t.name===e:t.name!==e)}))).forEach(t.hitch(this,(function(e){this._rasterFunctionStore.remove(e.name)})))},_isRFTJson:function(e){return e.name&&e.arguments&&e.function&&e.hasOwnProperty("functionType")}});return m("extend-esri")&&t.setObject("dijit.RenderingRule",Z,p),Z}));