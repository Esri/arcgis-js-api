// COPYRIGHT © 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/i18n!../nls/jsapi","dojo/text!./templates/RenderingRule.html","dojo/store/Memory","dojo/store/Observable","dojo/data/ObjectStore","dojo/has","dojo/on","dojo/Deferred","../kernel","../lang","../layers/RasterFunction","../geometry/Extent","../geometry/Point","./ColorRampSelector","../renderers/colorUtils","./ColorPicker","../tasks/generateRenderer","../tasks/AlgorithmicColorRamp","../tasks/MultipartColorRamp","../symbols/SimpleFillSymbol","../Color","../renderers/StretchRenderer","../renderers/UniqueValueRenderer","../renderers/ClassBreaksRenderer","../renderers/colorRampUtils","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/popup","dijit/Tooltip","dgrid/OnDemandGrid","dgrid/editor","dgrid/Keyboard","dijit/form/NumberTextBox","dijit/form/TextBox","dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","dijit/form/FilteringSelect"],function(e,t,i,s,a,r,n,l,o,h,u,d,c,m,y,f,_,g,p,R,b,S,v,C,L,I,B,V,T,F,x,k,w,D,M,N,q,A,G,P,U,O){var j="EsriRenderingRuleUniqueValuesGrid",H="EsriRenderingRuleEditorClassifyGrid",E=e([w,D,M],{declaredClass:"esri.dijit.RenderingRule",templateString:o,widgetsInTemplate:!0,layer:null,map:null,hideApplyButton:!1,_renderingRuleObject:null,_rasterFunctionData:[],_rasterFunctionStore:null,_cachedFunctionList:[],_cachedkeyProperties:{},_cachedHistogramsList:{},_cachedRATList:{},_pendingDfds:{},_redBandIdStore:null,_greenBandIdStore:null,_blueBandIdStore:null,_donotSaveChanges:!1,_resetBandCombination:!1,_serviceBandCount:3,_defaultBandCombinationFncName:"User Defined Renderer",_firstFncInRenderingRuleList:null,_gammaSliderTooltip:null,_symbologyTypes:{classify:"classify",stretch:"stretch",uniqueValues:"uniqueValues"},_classifyMethods:{naturalBreaks:"natural-breaks",equalInterval:"equal-interval",quantile:"quantile",definedInterval:"defined-interval"},constructor:function(t){e.safeMixin(this,t),this._i18n=l,this._defaultBandCombinationFncName=this._i18n.widgets.renderingRule.userDefinedRendererTitle,this._renderingRuleObject=new g},startup:function(){this.inherited(arguments),i.connect(this.rasterFunctionList,"onChange",t.hitch(this,"_onRasterFunctionChange")),i.connect(this.stretchMethodList,"onChange",t.hitch(this,"_onStretchMethodChange")),i.connect(this.gammaSlider,"onChange",t.hitch(this,"_onGammaChange")),i.connect(this.gammaSlider,"onMouseLeave",t.hitch(this,"_onGammaMouseLeave")),i.connect(this._apply,"onclick",t.hitch(this,"_onClickApplyRenderingRule")),i.subscribe("onRenderingRuleApply",t.hitch(this,"_onClickApplyRenderingRule")),i.subscribe("onRenderingRuleReset",t.hitch(this,"_onClickResetRenderingRule")),this.hideApplyButton&&(this._apply.style.display="none"),this._setupUniqueValuesGrid(),this._setupClassifyGrid(),this._setupStretchStatsGrid(),this._setupClassifyMethodStore(),this._symbologyBlocks=[this.stretchBlock,this.colorRampBlock,this.classifyBlock,this.classifyGridBlock,this.uniqueValuesBlock,this.uniqueValuesGridBlock]},_getColorMapFunction:function(e){var t=new g;return this.colorRampSelect.colorRampName?t.functionArguments={colorRamp:this.colorRampSelect.colorRampName}:t.functionArguments={Colormap:this.colorRampSelect.colorMap},t.variableName="Raster",t.functionName="Colormap",t},destroy:function(){this._pendingDfds=null,this._gammaSliderTooltip&&(this._gammaSliderTooltip.destroy(),this._gammaSliderTooltip=null),this.inherited(arguments)},_setLayerAttr:function(e){if(e){this.inherited(arguments),this.layer=e,this._donotSaveChanges=!0,this._firstFncInRenderingRuleList=null,this._stretchReadFromRenderingRule=!1,this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._uniqueValuesColorRamp=null,this._customColorRamp=null,this._fillStretchMethodList(),this._hideStretch();var s=t.hitch(this,"_setupDefaults");this.layer.loaded?this._setupDefaults():i.connect(this.layer,"onLoad",s),this._donotSaveChanges=!1}},_setupDefaults:function(){this._setupBandIdDefaults(),this._setupStretchDefaults(),this._setupRenderingRuleDefaults(),this._setupColorRampDefaults(),this._setupSymbologyDefaults(),this._setupClassifyDefaults(),this._setupUniqueValuesDefaults()},_setupRFTDefaults:function(){this._setupColorRampDefaults(),this._setupStretchDefaults(),this._setupSymbologyDefaults(),this._setupClassifyDefaults(),this._setupUniqueValuesDefaults()},_setupRenderingRuleDefaults:function(){if(this.layer){this._rasterFunctionData=[];var e,t=new y;for(e=0;e<this._cachedFunctionList.length;e++){var i=this._cachedFunctionList[e];if(i&&this.layer===i.layer)return this._rasterFunctionData=i.data,this._setupFunctionStore(),t.resolve(),t}return this._fillRasterFunctionList(this.layer)}},_setupClassifyDefaults:function(){if(this.layer&&this.symbologyTypeSelect.store.get(this._symbologyTypes.classify)){this._setupClassifyMethodStore(),this._setupClassifyNClassesInput(),this._setupClassifyGridDefaults(),this._setupClassifyFieldStore();var e=this.layer,i=this.layer.id,s=this._rasterFunctionStore.get(this.rasterFunctionList.value),a=s.name,r=s&&s.serviceInfo,n=r?r.hasRasterAttributeTable:this.layer.hasRasterAttributeTable,l=r?r.hasHistograms:this.layer.hasHistograms,o=a===this._defaultBandCombinationFncName?null:new g({functionName:a});this._cachedRATList[i]&&this._cachedRATList[i][a]?this._handleRasterAttributeTableClassify(this._cachedRATList[i][a]):n?this.rasterFunctionList.value===this._defaultBandCombinationFncName?e.getRasterAttributeTable().then(t.hitch(this,this._handleRasterAttributeTableClassify)):e.getRenderingRuleAttributeTable({renderingRule:o}).then(t.hitch(this,this._handleRasterAttributeTableClassify)):this._cachedHistogramsList&&this._cachedHistogramsList[i]&&this._cachedHistogramsList[i][a]?this._handleHistogramsResultClassify(this._cachedHistogramsList[this.layer.id][a]):l&&this.rasterFunctionList.value===this._defaultBandCombinationFncName?e.getHistograms().then(t.hitch(this,this._handleHistogramsResultClassify)):e.currentVersion>10.1&&e.computeHistograms({renderingRule:o,pixelSize:this._getOverviewPixelSize()}).then(t.hitch(this,this._handleHistogramsResultClassify))}},_getOverviewPixelSize:function(){var e=this.layer.extent,t=this.map.width,i=this.map.height,s=(e.xmax-e.xmin)/t,a=(e.ymax-e.ymin)/i,r=e.spatialReference;return new R(s,a,r)},_addUniqueValuesColorRamp:function(e){var t={},i=e&&e.features;i&&i.length&&this._ratContainsColormap(e)&&(this._uniqueValuesColorRampName=this._i18n.widgets.renderingRule.uniqueValuesDefaultColorRamp,t.id=this._uniqueValuesColorRampName,t.name=this._uniqueValuesColorRampName,t.type="multipart",t.colorRamps=[],s.forEach(i,function(e){var i=e.attributes,s=this._getFeatureRGBValue(i);t.colorRamps.push({fromColor:s,toColor:s})},this),this._uniqueValuesColorRamp=t,this._setColorRampSelectValue())},_addCustomColorRamp:function(e){if(e){if(this._customColorRamp)return this.colorRampSelect.setSelected(this._customColorRamp);this._customColorRamp=e.toJson(),this._customColorRampName=this._i18n.widgets.renderingRule.customColorRampName,this._customColorRamp.id=this._customColorRampName,this._customColorRamp.name=this._customColorRampName,this.colorRampSelect.addColorRamp(this._customColorRamp),this.colorRampSelect.setSelected(this._customColorRamp)}},_getFeatureRGBValue:function(e){if(e){var t,i,s;return t=this._getCaseInsensitiveFieldValue("red",e),i=this._getCaseInsensitiveFieldValue("green",e),s=this._getCaseInsensitiveFieldValue("blue",e),t=t>1?t:Math.round(255*t),i=i>1?i:Math.round(255*i),s=s>1?s:Math.round(255*s),[t,i,s]}},_getCaseInsensitiveFieldValue:function(e,t){if(t&&e){var i=e.toLowerCase();for(var s in t)if(t.hasOwnProperty(s)&&s.toLowerCase()===i)return t[s]}},_ratContainsColormap:function(e){if(!e||!e.fields)return!1;var t,i,a;return s.some(e.fields,function(e){if(e&&e.name){var s=e.name.toLowerCase();"red"===s&&(t=!0),"green"===s&&(i=!0),"blue"===s&&(a=!0)}return t&&i&&a})},_handleRasterAttributeTableClassify:function(e){if(e&&e.features&&e.features.length){var t=this.rasterFunctionList.value;this._cachedRATList[this.layer.id]=this._cachedRATList[this.layer.id]||{},this._cachedRATList[this.layer.id][t]=e,this._setDefaultIntervalSize(),this._addUniqueValuesColorRamp(e),this._setupClassifyFieldStore(),this._setupUniqueValuesFieldStore(),this.symbologyTypeSelect.set("value",this._getDefaultSymbologyType()),this._isClassBreaksRenderer(this.layer.renderer)||this._updateClassifyGrid(),this._isUniqueValueRenderer(this.layer.renderer)||this._updateUniqueValuesGrid()}},_handleHistogramsResultClassify:function(e){if(e&&e.histograms&&e.histograms.length){var t=e.histograms,i=this.rasterFunctionList.value;this._cachedHistogramsList[this.layer.id]=this._cachedHistogramsList[this.layer.id]||{},this._cachedHistogramsList[this.layer.id][i]=t,this._setDefaultIntervalSize();var s,a,r,n=0,l=[];if(t&&t.length&&t[0].size){for(s=t[0].counts,a=t[0].min,r=t[0].max,n=0;n<s.length;n++)l.push(a+(r-a)*n/s.length);t[0].dataPoints=l}this._isClassBreaksRenderer(this.layer.renderer)||this._updateClassifyGrid()}},_setDefaultIntervalSize:function(){if(this.layer){var e,t,i,a,r,n,l,o,h=this.layer,u=h.id,d=h.renderer,c=this.rasterFunctionList.value,m=this.classifyFieldSelect.value;this._isSelectedRenderingRule(h.renderingRule)&&this._isClassBreaksRenderer(d)&&d.infos&&d.infos.length&&d.attributeField===m&&(e=d.infos[0],a=e.maxValue-e.minValue),a||(this._cachedRATList&&this._cachedRATList[u]&&this._cachedRATList[u][c]?(t=this._cachedRATList[u][c],n=l=t.features[0].attributes[m],s.forEach(t.features,function(e){o=e.attributes[m],n>o&&(n=o),o>l&&(l=o)})):this._cachedHistogramsList&&this._cachedHistogramsList[u]&&this._cachedHistogramsList[u][c]&&(i=this._cachedHistogramsList[u][c],n=i[0].min,l=i[0].max),r=this.classifyNClassesInput&&this.classifyNClassesInput.value||4,a=(l-n)/r),this.classifyIntervalInput.attr("value",a,!1)}},_setupUniqueValuesDefaults:function(){this.layer&&this.symbologyTypeSelect.store.get(this._symbologyTypes.uniqueValues)&&this._setupUniqueValuesGridDefaults()},_setupSymbologyDefaults:function(){this._setupSymbologyStore(),this._setSymbologySelectVisibility()},_setSymbologySelectVisibility:function(){var e=this._canApplyRenderer();r.toggle(this.symbologyTypeBlock,"esriRenderingRuleHidden",!e),r.toggle(this.symbologyTypeBlock,"esriRenderingRuleVisible",e)},_setupSymbologyStore:function(){if(this.layer){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value),t=e&&e.serviceInfo?e.serviceInfo:null,i=this.layer.renderer,a=[],r=this.layer,n=t?t.bandCount:r.bandCount,l=t?t.hasRasterAttributeTable:r.hasRasterAttributeTable;this._canApplyRenderer()&&(a.push({name:this._symbologyTypes.stretch}),n&&1===n&&(l?(a.push({name:this._symbologyTypes.uniqueValues}),a.push({name:this._symbologyTypes.classify})):r.currentVersion>=10.3&&a.push({name:this._symbologyTypes.classify}))),this._isSelectedRenderingRule(r.renderingRule)&&(this._isUniqueValueRenderer(i)&&!s.some(a,function(e){return e.name===this._symbologyTypes.uniqueValues},this)&&a.push({name:this._symbologyTypes.uniqueValues}),this._isClassBreaksRenderer(i)&&!s.some(a,function(e){return e.name===this._symbologyTypes.classify},this)&&a.push({name:this._symbologyTypes.classify})),s.forEach(a,function(e){e.label=this._i18n.widgets.renderingRule[e.name+"Label"],e.id=e.name},this),this.symbologyTypeSelect.set("store",new h({data:a})),this.symbologyType=this._getDefaultSymbologyType(),this.symbologyType&&this.symbologyTypeSelect.set("value",this.symbologyType),this._onSymbologyTypeChange(this.symbologyType)}},_canApplyRenderer:function(){if(this.layer){var e=this.layer.currentVersion,t=this.rasterFunctionList.value;return e>=10.3||t===this._defaultBandCombinationFncName}},_getDefaultUniqueValuesField:function(e){var t,i=["classname","class_name","class_names"];return s.some(e,function(e){var a,r=e&&e.name;if(r){if(a=r.toLowerCase(),s.indexOf(i,a)>-1)return t=r,!0;"value"===a&&(t=r)}}),t},_setupUniqueValuesFieldStore:function(){if(this.layer){var e=new h({data:this._getRasterAttributeTableFields()});e&&this.uniqueValuesFieldSelect&&this.uniqueValuesFieldSelect.set("store",e);var t;t=this._isUniqueValueRenderer(this.layer.renderer)?this.layer.renderer.attributeField:this._getDefaultUniqueValuesField(e.data),this.uniqueValuesFieldSelect.attr("value",t,!1)}},_setupStretchStatsGrid:function(){var i=this._i18n.widgets.renderingRule,s={sortable:!1,editor:U,editOn:"click",autoSave:!0,renderCell:t.hitch(this,this._stretchStatsRenderCell),canEdit:t.hitch(this,function(){return"6"!==this.stretchMethodList.value})};this._stretchStatsGrid=new(e([A,P]))({selectionMode:"single",className:"dgrid-autoheight",columns:[G(t.mixin({field:"esriRenderingRuleStretchMin",label:i.minLabel},s)),G(t.mixin({field:"esriRenderingRuleStretchMax",label:i.maxLabel},s)),G(t.mixin({field:"esriRenderingRuleStretchMean",label:i.meanLabel},s)),G(t.mixin({field:"esriRenderingRuleStretchStdv",label:i.stdDevLabel},s))]},this.stretchStatsGrid),this._stretchStatsGrid.startup()},_stretchStatsRenderCell:function(e,t,i){return null===t||void 0===t||isNaN(t)?void(i.innerHTML=""):void(i.innerHTML=Math.round(1e4*t)/1e4)},_setupUniqueValuesGrid:function(){this._uniqueValuesGrid=new(e([A,P]))({selectionMode:"single",columns:[{field:"esriRenderingRuleUniqueValuesSymbol",sortable:!1,renderCell:t.hitch(this,function(e,i,s){var a=n.toDom('<div class = esriRenderingRuleSymbolCell style = "background: rgba( '+e.esriRenderingRuleUniqueValuesSymbol.r+", "+e.esriRenderingRuleUniqueValuesSymbol.g+", "+e.esriRenderingRuleUniqueValuesSymbol.b+","+255*e.esriRenderingRuleUniqueValuesSymbol.a+') " id = '+j+e.id+"></div>");n.place(a,s),a.onclick=t.hitch(this,function(e){this._openColorPickerPopup(e)})}),label:this._i18n.widgets.renderingRule.symbolLabel},{field:"esriRenderingRuleUniqueValuesValue",label:this._i18n.widgets.renderingRule.valueLabel},G({field:"esriRenderingRuleUniqueValuesLabel",sortable:!1,label:this._i18n.widgets.renderingRule.labelLabel,editor:O,editOn:"click",autoSave:!0})]},this.uniqueValuesGrid),this._uniqueValuesGrid.startup()},_setupClassifyGrid:function(){this._classifyGrid=new(e([A,P]))({className:"dgrid-autoheight",columns:[{field:"esriRenderingRuleClassifySymbol",sortable:!1,renderCell:t.hitch(this,function(e,i,s){var a=n.toDom('<div class = esriRenderingRuleSymbolCell style = "background: rgba( '+e.esriRenderingRuleClassifySymbol.r+", "+e.esriRenderingRuleClassifySymbol.g+", "+e.esriRenderingRuleClassifySymbol.b+","+255*e.esriRenderingRuleClassifySymbol.a+') " id = '+H+e.id+"></div>");n.place(a,s),a.onclick=t.hitch(this,function(e){this._openColorPickerPopup(e)})}),label:this._i18n.widgets.renderingRule.symbolLabel},{field:"esriRenderingRuleClassifyValue",label:this._i18n.widgets.renderingRule.valueLabel,sortable:!1,renderCell:function(e,t,i){i.innerHTML="≤ "+Math.floor(1e3*e.maxValue)/1e3}},G({field:"esriRenderingRuleClassifyLabel",label:this._i18n.widgets.renderingRule.labelLabel,editor:O,editOn:"click",autoSave:!0,sortable:!1})]},this.classifyGrid),this._classifyGrid.startup()},_setupClassifyGridDefaults:function(){if(this.layer&&this._isClassBreaksRenderer(this.layer.renderer)){var e=[],t=this.layer.renderer.infos;s.forEach(t,function(t){e.push({minValue:t.minValue,maxValue:t.maxValue,esriRenderingRuleClassifySymbol:t.symbol.color,esriRenderingRuleClassifyLabel:t.label})}),this._updateClassifyGrid(e)}},_setupUniqueValuesGridDefaults:function(){if(this.layer&&this._isUniqueValueRenderer(this.layer.renderer)){var e=[],t=this.layer.renderer.infos;s.forEach(t,function(t){e.push({esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesSymbol:t.symbol.color,esriRenderingRuleUniqueValuesLabel:t.label||t.value})}),this._updateUniqueValuesGrid(e)}},_setupClassifyNClassesInput:function(){if(this.layer){var e=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.infos.length:5;this.classifyNClassesInput.attr("value",e,!1)}},_isSelectedRenderingRule:function(e){var t,i=this._getStretchRenderingRule(e),s=this.rasterFunctionList.value;if(e){if(i){if(t=i.functionArguments,t&&this._isSelectedRenderingRule(t.Raster))return!0}else if(e.functionName.toLowerCase()===s.toLowerCase())return!0}else if(this.rasterFunctionList.value===this._defaultBandCombinationFncName)return!0},_isUniqueValueRenderer:function(e){return e&&"esri.renderer.UniqueValueRenderer"===e.declaredClass},_isClassBreaksRenderer:function(e){return e&&"esri.renderer.ClassBreaksRenderer"===e.declaredClass},_isStretchRenderer:function(e){return e&&"esri.renderer.StretchRenderer"===e.declaredClass},_getStretchRenderingRule:function(e){var t;if(e)return e&&e.functionName&&"stretch"===e.functionName.toLowerCase()?e:e&&e.functionName&&"colormap"===e.functionName.toLowerCase()&&e.functionArguments&&e.functionArguments.Raster&&e.functionArguments.Raster.functionName&&"stretch"===e.functionArguments.Raster.functionName.toLowerCase()?t=e.functionArguments.Raster:void 0},_setupClassifyMethodStore:function(){if(this.layer){var e=[],t=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.classificationMethod:this._classifyMethods.equalInterval;for(var i in this._classifyMethods)this._classifyMethods.hasOwnProperty(i)&&e.push({label:"<div class= 'esriRenderingRuleFilteringSelectLabel'><h4 style='font-weight:bold;'>"+this._i18n.widgets.renderingRule[i]+"</h4><br/><i>"+this._i18n.widgets.renderingRule[i+"Desc"]+"</i></div>",id:this._classifyMethods[i],name:this._i18n.widgets.renderingRule[i]});this.classifyMethodSelect.set("store",new h({data:e})),this.classifyMethodSelect.set("labelType","html"),this.classifyMethodSelect.set("labelAttr","label"),this.classifyMethodSelect.attr("value",t,!1),this._handleClassifyIntervalVisibility(t)}},_setupClassifyFieldStore:function(){if(this.layer){var e,t=this._i18n.widgets.renderingRule.valueLabel,i=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.attributeField:"Value";e=this.layer&&this.layer.rasterAttributeTable?this._getRasterAttributeTableFields(!0):[{name:t,alias:t,id:"Value"}],this.classifyFieldSelect.set("store",new h({data:e})),this.classifyFieldSelect.attr("value",i,!1)}},_getRasterAttributeTableFields:function(e){if(this.layer){var i=this.layer.id,a=this.rasterFunctionList.value,r=this._cachedRATList[i]&&this._cachedRATList[i][a],n=r||this.layer.rasterAttributeTable;if(n){var l,o=t.clone(n.fields);return l=s.filter(o,function(t){return"esriFieldTypeOID"===t.type||e&&"esriFieldTypeString"===t.type?void 0:!0}),l=s.map(l,function(e){return e.id=e.name,e})}}},_setupFunctionStore:function(){if(!this.layer)return void console.log("Could not populate renderers as the layer does not exists");this._rasterFunctionStore=new h({data:this._rasterFunctionData,idProperty:"name"}),this.rasterFunctionList.set("store",this._rasterFunctionStore),this.rasterFunctionList.set("labelAttr","label"),this.rasterFunctionList.set("labelType","html");var e=this.layer.rasterFunctionInfos;e&&e.length>0&&e[0].name&&(this._firstFncInRenderingRuleList=e[0].name);var t=this.layer.renderingRule,i="";i=t&&t.functionName?"stretch"!==t.functionName.toLowerCase()&&"colormap"!==t.functionName.toLowerCase()?t.functionName:this._getRenderingRuleNameFromStretchFunction(t)||this._defaultBandCombinationFncName:this._firstFncInRenderingRuleList&&"none"!==this._firstFncInRenderingRuleList.toLowerCase()&&!this.layer.bandIds?this._firstFncInRenderingRuleList:this._defaultBandCombinationFncName,i&&(this._rasterFunctionStore.get(i)||"Colormap"===i)&&(this.rasterFunctionList.set("value",i),this._onRasterFunctionChange())},_fillRasterFunctionList:function(e){if(this.layer&&(this._rasterFunctionData=[],null!==e&&null!==e.extent)){var i=new p(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax,e.extent.spatialReference),a=i.getWidth(),r=i.getHeight();if(a/r>=2||r/a>=2){var n=Math.min(a,r)/2,l=i.getCenter();i.update(l.x-n,l.y-n,l.x+n,l.y+n,e.extent.spatialReference)}var o=i.xmin+","+i.ymin+","+i.xmax+","+i.ymax,h=e._getToken(),u="";h&&(u="&token="+h);var d=this.layer.url+"/exportImage?bbox="+o+u+"&imageSize=400,400&f=image&renderingRule=",c=this.layer.bandIds,m=d;c&&c.length>=3&&(m=d+"&bandIds="+c[0]+","+c[1]+","+c[2]),this._addFunctionItemToList(this._defaultBandCombinationFncName,this._defaultBandCombinationFncName,this._i18n.widgets.renderingRule.userDefinedRendererDesc,m,""),e.rasterFunctionInfos&&e.rasterFunctionInfos.length>0&&s.forEach(e.rasterFunctionInfos,t.hitch(this,function(e){if("none"!==e.name.toLowerCase()){var t='{"rasterFunction":"'+e.name+'"}';this._addFunctionItemToList(e.name,e.name,e.description,d,t)}}));var y={};y.layer=this.layer,y.data=this._rasterFunctionData,this._cachedFunctionList.push(y);var f;s.forEach(this.layer.rasterFunctionInfos,function(e){f=new g({rasterFunction:e.name}),this.layer.getRenderingRuleServiceInfo(f).then(t.hitch(this,function(t){s.some(this._rasterFunctionData,function(i,s){return i.name===e.name?(this._rasterFunctionData[s].serviceInfo=t,e.name===this.rasterFunctionList.value&&this._setupRFTDefaults(),!0):void 0},this)}))},this),this._setupFunctionStore()}},_addFunctionItemToList:function(e,t,i,s,a){var r={};r.name=e,r.id=t;var n=i;n.length>200&&(n=n.substring(0,200)+"..."),r.description=n,r.label="<html><body><section><h4>"+e+":</h4><table cellspacing='5'><tr><td><img src='"+s+a+"' height='100' width='100'></td><td><p style='white-space:pre-wrap;width:40ex'><i>"+n+"</i></p></td></tr></table></section></body></html>",this._rasterFunctionData.push(r)},_setupColorRampDefaults:function(){if(this.layer){var e,t=this.layer.pixelType,i=this.layer.renderingRule;i&&(t=i.outputPixelType||this.layer.pixelType,e=i.functionName),this._setColorRampVisibility()}},_setColorRampVisibility:function(){var e;if(this._rasterFunctionStore&&(e=this._rasterFunctionStore.get(this.rasterFunctionList.value).serviceInfo),!this._canApplyRenderer())return this._hideColorRampSelector();if(this.symbologyType===this._symbologyTypes.stretch){var t=e&&e.bandCount?e.bandCount:this.layer.bandCount,i=e&&e.pixelType?e.pixelType:this.layer.pixelType,s=this.layer.renderer,a=this.layer.renderingRule,r=this._getStretchRenderingRule(a);if(this._isSelectedRenderingRule(this.layer.renderingRule)){if(this._isStretchRenderer(s)&&s.colorRamp&&s.stretchType==this.stretchMethodList.value)return this._showColorRampSelector();if(a&&a.functionName&&"colormap"===a.functionName.toLowerCase()&&(r&&r.StretchType)===this.stretchMethodList.value)return this._showColorRampSelector()}t>1||this.layer.currentVersion<10.3||"u8"!==i.toLowerCase()&&"0"===this.stretchMethodList.value?this._hideColorRampSelector():this._showColorRampSelector()}else this._showColorRampSelector()},_setColorRampSelectValue:function(){if(this.layer){var e=this.layer.renderer,i=this.layer.renderingRule;if(this.symbologyType===this._symbologyTypes.stretch)this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._isStretchRenderer(e)&&this._isSelectedRenderingRule(this.layer.renderingRule)?this._setRendererColorRamp(e.colorRamp):i&&i.functionName&&"colormap"===i.functionName.toLowerCase()&&i.functionArguments&&i.functionArguments.colorRamp?this.colorRampSelect.setSelected(i.functionArguments.colorRamp):this._setStretchColorRamp();else{var s=e&&e.authoringInfo&&e.authoringInfo.colorRamp?k.fromJson(t.clone(e.authoringInfo.colorRamp)):null;this.symbologyTypeSelect.value===this._symbologyTypes.uniqueValues?(this._uniqueValuesColorRamp&&this.colorRampSelect.addColorRamp(this._uniqueValuesColorRamp),this._isUniqueValueRenderer(e)&&s?this._setRendererColorRamp(s):this._setUniqueValuesColorRamp()):this.symbologyTypeSelect.value===this._symbologyTypes.classify&&(this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._isClassBreaksRenderer(e)&&s?this._setRendererColorRamp(s):this._setClassifyColorRamp())}}},_setRendererColorRamp:function(e){if(!e||!this.layer)return void this.colorRampSelect.reset();var t=this.colorRampSelect.setSelected(e);t||this._addCustomColorRamp(e)},_hideColorRampSelector:function(){a.set(this.colorRampBlock,"display","none"),a.set(this.colorRampLabelBlock,"display","none"),this._colorRampVisible=!1},_showColorRampSelector:function(){this.layer&&(this._setColorRampSelectValue(),a.set(this.colorRampBlock,"display","table-row"),a.set(this.colorRampLabelBlock,"display","table-row"),this._colorRampVisible=!0)},_getDefaultSymbologyType:function(){if(this.layer){if(this._isSelectedRenderingRule(this.layer.renderingRule)){if(this.layer.renderer&&this.layer.renderer.declaredClass){var e=this.layer.renderer.declaredClass;if("esri.renderer.StretchRenderer"===e)return this._symbologyTypes.stretch;if("esri.renderer.ClassBreaksRenderer"===e)return this._symbologyTypes.classify;if("esri.renderer.UniqueValueRenderer"===e)return this._symbologyTypes.uniqueValues}if(this.layer.renderingRule){var t=this.layer.renderingRule;if(t&&t.functionName&&"stretch"===t.functionName.toLowerCase())return this._symbologyTypes.stretch;if(t&&t.functionName&&"colormap"===t.functionName.toLowerCase()&&t.functionArguments&&t.functionArguments.Raster&&t.functionArguments.Raster.functionName&&"stretch"===t.functionArguments.Raster.functionName.toLowerCase())return this._symbologyTypes.stretch}}if(this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][this.rasterFunctionList.value]){var i=this._cachedRATList[this.layer.id][this.rasterFunctionList.value];if(i.features.length&&this._ratContainsColormap(i))return this._symbologyTypes.uniqueValues}return this._canApplyRenderer()?this._symbologyTypes.stretch:void 0}},_setupBandIdDefaults:function(){if(this.layer){var e=3;e=this.layer.bandCount;var i=this.layer.id,s=this._cachedkeyProperties[i];if(!s&&e>1){this.msgLabel.style.display="",this.msgLabel.innerHTML="<i>"+this._i18n.widgets.renderingRule.bandNamesRequestMsg+"</i>";var a=this.layer.getKeyProperties();this._pendingDfds[i]=1,a.addBoth(t.partial(this._fillBandIdList,this,this.layer))}else this._fillBandIdList(this,this.layer,s);3>e?this._hideBandIds():this._showBandIds()}},_fillBandIdList:function(e,t,i){if(e.layer&&e.layer===t){var s=e._pendingDfds,a=e.layer.id;s&&s[a]&&delete s[a],e.msgLabel.style.display="none",e.msgLabel.innerHTML="";var r=3;r=e.layer.bandCount;var n;i&&i.BandProperties&&i.BandProperties.length>0&&(n=i.BandProperties);var l=e._getBandIdList(r,n,"");e._redBandIdStore=new h({data:l,idProperty:"name"}),e.bandIdsRedList.set("store",e._redBandIdStore),e.bandIdsRedList.set("labelAttr","label"),e.bandIdsRedList.set("labelType","html");var o=e._getBandIdList(r,n,"");e._greenBandIdStore=new h({data:o,idProperty:"name"}),e.bandIdsGreenList.set("store",e._greenBandIdStore),e.bandIdsGreenList.set("labelAttr","label"),e.bandIdsGreenList.set("labelType","html");var u=e._getBandIdList(r,n,"");e._blueBandIdStore=new h({data:u,idProperty:"name"}),e.bandIdsBlueList.set("store",e._blueBandIdStore),e.bandIdsBlueList.set("labelAttr","label"),e.bandIdsBlueList.set("labelType","html");var d=e.layer.bandIds;if(d&&d.length>2)e.bandIdsRedList.attr("value",e._getBandName(e._redBandIdStore,d[0]),!1),e.bandIdsGreenList.attr("value",e._getBandName(e._greenBandIdStore,d[1]),!1),e.bandIdsBlueList.attr("value",e._getBandName(e._blueBandIdStore,d[2]),!1);else if(e._redBandIdStore.data.length>0&&e._greenBandIdStore.data.length>1&&e._blueBandIdStore.data.length>2){var c=e._getRedBandIndex(n),m=e._getGreenBandIndex(n),y=e._getBlueBandIndex(n);e.bandIdsRedList.attr("value",e._redBandIdStore.data[c].name,!1),e.bandIdsGreenList.attr("value",e._greenBandIdStore.data[m].name,!1),e.bandIdsBlueList.attr("value",e._blueBandIdStore.data[y].name,!1)}e._cachedkeyProperties[a]=i;var f=e.rasterFunctionList.get("value");f===e._defaultBandCombinationFncName&&e._enableBandIds()}},_getRedBandIndex:function(e){if(!this.layer||!e)return 0;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"red"===e[t].BandName.toLowerCase())return t;return 0},_getGreenBandIndex:function(e){if(!this.layer||!e)return 1;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"green"===e[t].BandName.toLowerCase())return t;return 1},_getBlueBandIndex:function(e){if(!this.layer||!e)return 2;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"blue"===e[t].BandName.toLowerCase())return t;return 2},_getBandIdList:function(e,t,i){if(this.layer){var s=[];i||(i="Black");var a=!1;t&&e===t.length&&(a=!0);var r;for(r=0;e>r;r++){var n=r,l=r;a&&t[r]&&t[r].BandName?n=t[r].BandName:n++;var o={};o.name=n,o.index=l,o.label="<html><body><span value="+l+"><font color="+i+">"+n+"</font></span></body></html>",s.push(o)}return s}},_getBandName:function(e,t){if(e&&e.data){var i;for(i=0;i<e.data.length;i++){var s=e.data[i];if(s.index===t)return s.name}return""}},_setupStretchDefaults:function(){if(this.layer){var e,t=this.layer.renderingRule,i=this._getStretchRenderingRule(t);if(this._isSelectedRenderingRule(this.layer.renderingRule)&&(this._isStretchRenderer(this.layer.renderer)||i))this._isStretchRenderer(this.layer.renderer)?this._loadStretchRenderer(this.layer.renderer):i&&this._loadStretchFunction(i);else{this.stretchMethodList.attr("value","0",!1),this._onStretchMethodChange(),this.numStdDevText.set("value",2),this.minPercentText.set("value",2),this.maxPercentText.set("value",2),this.gammaSlider.setValue(0),this._updateStretchStatsGrid(),e=this._getCurrentServiceInfo();var s=e&&e.minValues,a=e&&e.maxValues;s&&s.length>0&&a&&a.length>0?this.draCheckbox.checked=!1:this.draCheckbox.checked=!0}this._gammaSliderTooltip||(this._gammaSliderTooltip=new q({connectId:["gammaSliderID"],position:["below","above"],id:"gammaSliderTooltipID"}))}},_loadStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){this._stretchReadFromRenderingRule=!0;var t=e.functionArguments,i=t.StretchType;if(this.stretchMethodList.attr("value",i.toString(),!1),this._onStretchMethodChange(),t.NumberOfStandardDeviations&&this.numStdDevText.set("value",t.NumberOfStandardDeviations),this.draCheckbox.checked=t.DRA?!0:!1,t.UseGamma){var s=t.Gamma;t.Gamma.length>0&&(s=t.Gamma[0]);var a=Math.log(s)/Math.log(10);a&&this.gammaSlider.setValue(a)}t.MinPercent&&this.minPercentText.set("value",t.MinPercent),t.MaxPercent&&this.maxPercentText.set("value",t.MaxPercent),t.Statistics&&t.Statistics.length&&this._loadStretchStats(t.Statistics)}},_loadStretchRenderer:function(e){if(this._isStretchRenderer(e)){this._stretchReadFromRenderingRule=!1;var t=e._convertStretchTypeEnumToIndex(e.stretchType);if(this.stretchMethodList.set("value",t.toString()),this._onStretchMethodChange(),e.numberOfStandardDeviations&&this.numStdDevText.set("value",e.numberOfStandardDeviations),this.draCheckbox.checked=e.dra?!0:!1,e.useGamma){var i=e.gamma;e.gamma.length>0&&(i=e.gamma[0]);var s=Math.log(i)/Math.log(10);s&&this.gammaSlider.setValue(s)}e.minPercent&&this.minPercentText.set("value",e.minPercent),e.maxPercent&&this.maxPercentText.set("value",e.maxPercent),e.statistics&&e.statistics.length&&this._loadStretchStats(e.statistics)}},_loadStretchStats:function(e){if(e&&e.length){var t=[];s.forEach(e,function(e){e&&e.length&&t.push({esriRenderingRuleStretchMin:e[0],esriRenderingRuleStretchMax:e[1],esriRenderingRuleStretchMean:e[2],esriRenderingRuleStretchStdv:e[3]})}),this._updateStretchStatsGrid(t),this._setStretchStatsGridVisibility()}},_getRenderingRuleNameFromStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){var t=e.functionArguments,i=t.Raster;return i&&i.functionName||null}},_fillStretchMethodList:function(){this.stretchMethodList.removeOption(this.stretchMethodList.getOptions()),this.stretchMethodList.addOption([{value:"0",label:this._i18n.widgets.renderingRule.noneStretchAlias},{value:"5",label:this._i18n.widgets.renderingRule.minMaxStretchAlias},{value:"3",label:this._i18n.widgets.renderingRule.stdDevStretchAlias},{value:"6",label:this._i18n.widgets.renderingRule.percentClipStretchAlias
}]),this.stretchMethodList.set("value","0"),this._onStretchMethodChange()},_onDRAChange:function(){this.symbologyType===this._symbologyTypes.stretch&&"0"!==this.stretchMethodList.value&&(this._updateStretchStatsGrid(),this._setStretchStatsGridVisibility())},_setStretchStatsGridVisibility:function(){var e=this.stretchMethodList.value,t="0"!==e&&!this.draCheckbox.checked&&this._stretchStatsData&&this._stretchStatsData.length?"":"none";r.toggle(this.stretchStatsBlock,"esriRenderingRuleDisabledGrid","6"===e),this.stretchStatsBlock.style.display=t},_getCurrentServiceInfo:function(){var e,t=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value);return e=this.rasterFunctionList.value===this._defaultBandCombinationFncName?this.layer:t&&t.serviceInfo?t.serviceInfo:this.layer},_updateStretchStatsGrid:function(e){if(this._stretchStatsGrid){if(!e||"number"==typeof e||"string"==typeof e){var t,i,a,r,n=this._getCurrentServiceInfo(),l=n&&n.bandCount,o={},u=["minValues","maxValues","meanValues","stdvValues"],c=0,m=1,y=2;e=[],s.forEach(u,function(e){o[e]=n&&n[e]?n[e]:this.layer[e]?this.layer[e]:new Array(l)},this),this.rasterFunctionList.value===this._defaultBandCombinationFncName&&l>=3&&(i=this._redBandIdStore&&this._redBandIdStore.get(this.bandIdsRedList.value),a=this._greenBandIdStore&&this._greenBandIdStore.get(this.bandIdsGreenList.value),r=this._blueBandIdStore&&this._blueBandIdStore.get(this.bandIdsBlueList.value),c=i?i.index:c,m=a?a.index:m,y=r?r.index:y),t=l>=3?[c,m,y]:[c],s.forEach(t,function(t,i){e.push({id:i,esriRenderingRuleStretchMin:o.minValues[t],esriRenderingRuleStretchMax:o.maxValues[t],esriRenderingRuleStretchMean:o.meanValues[t],esriRenderingRuleStretchStdv:o.stdvValues[t]})})}e=this._sanitizeStretchStatsData(e);var f=new d(new h({data:e,idProperty:"id"}));this._stretchStatsGrid.set("store",f),this._stretchStatsData=e}},_onSymbologyTypeChange:function(e){if(this.layer){this.symbologyType=e;var t=this.layer.renderer,i=this.layer.renderingRule,s=this._getStretchRenderingRule(i),a=this._isSelectedRenderingRule(i);this._showBlocks([]),e===this._symbologyTypes.classify?(this._showBlocks([this.classifyBlock,this.classifyGridBlock]),this._isClassBreaksRenderer(t)&&a?this._setupClassifyGridDefaults():this._updateClassifyGrid()):e===this._symbologyTypes.uniqueValues?(this._showBlocks([this.uniqueValuesBlock,this.uniqueValuesGridBlock]),this._isUniqueValueRenderer(t)&&a?this._setupUniqueValuesGridDefaults():this._updateUniqueValuesGrid()):e===this._symbologyTypes.stretch&&(a?this._isStretchRenderer(t)?this._loadStretchStats(t.statistics):s&&s.functionArguments?this._loadStretchStats(s.functionArguments.Statistics):this._updateStretchStatsGrid():this._updateStretchStatsGrid(),this._showBlocks([this.stretchBlock]))}},_onClassifyFieldChange:function(){this.classifyMethodSelect.value===this._classifyMethods.definedInterval&&this._setDefaultIntervalSize(),this._updateClassifyGrid()},_onClassifyMethodChange:function(e){this.classifyMethodSelect.value===this._classifyMethods.definedInterval&&this._setDefaultIntervalSize(),this._handleClassifyIntervalVisibility(e),this._updateClassifyGrid()},_handleClassifyIntervalVisibility:function(e){e===this._classifyMethods.definedInterval?(a.set(this.classifyIntervalsBlock,"display","table-row"),this.classifyNClassesInput.set("disabled",!0)):(a.set(this.classifyIntervalsBlock,"display","none"),this.classifyNClassesInput.set("disabled",!1))},_showBlocks:function(e){s.forEach(this._symbologyBlocks,function(t){s.indexOf(e,t)>-1?(r.remove(t,"esriRenderingRuleHidden"),r.add(t,"esriRenderingRuleVisible")):(r.remove(t,"esriRenderingRuleVisible"),r.add(t,"esriRenderingRuleHidden"))}),this._setColorRampVisibility()},_onRasterFunctionChange:function(){var e=this.rasterFunctionList.get("value");if(e){var t=this._rasterFunctionStore.get(e).description;this._setupRFTDefaults(),this.rasterFunctionList.set("title",t);var i=this.layer.id;this._setColorRampVisibility(),e===this._defaultBandCombinationFncName?(this.rasterFunctionRow.width="",this.layer.bandCount>1?(this._showBandIds(),this._pendingDfds[i]?this._disableBandIds():this._enableBandIds()):this._hideBandIds()):(this.domNode.clientWidth>0&&(this.rasterFunctionRow.width=this.domNode.clientWidth),this._hideBandIds()),e===this._defaultBandCombinationFncName||this.layer.version>=10.3?(this.imageEnhancementLabel.style.display="",this.stretchMethodLabel.style.display="",this.stretchDescLabel.style.display="",this.stretchMethodList.domNode.style.display="",this._onStretchMethodChange()):this._hideStretch()}},_setClassifyColorRamp:function(){this.colorRampSelect.setSelected("Yellow to Red")},_setUniqueValuesColorRamp:function(){this._uniqueValuesColorRamp?this.colorRampSelect.setSelected(this._uniqueValuesColorRampName):this.colorRampSelect.setSelected("Aspect")},_setStretchColorRamp:function(){this.colorRampSelect.reset()},_updateUniqueValuesGrid:function(e,t){if(this._uniqueValuesGrid&&(e=e&&e.length&&e[0].esriRenderingRuleUniqueValuesSymbol?e:this._getUniqueValuesGridData(t),e&&e.length)){void 0===e[0].id&&s.forEach(e,function(e,t){e.id=t});var i=new u(new h({data:e,idProperty:"id"}));this._uniqueValuesGrid.set("store",i),this._uniqueValuesSymbolData=e}},_updateClassifyGrid:function(e,t){if(this._classifyGrid&&(e=e&&e.length&&e[0].esriRenderingRuleClassifySymbol?e:this._getClassifyGridData(t),e&&e.length)){var i=e[0]?e[0].maxValue-e[0].minValue:this.classifyIntervalInput.value;void 0===e[0].id&&s.forEach(e,function(e,t){e.id=t});var a=new d(new h({data:e,idProperty:"id"}));this._classifyGrid.set("store",a),this._classifySymbolData=e,this.classifyIntervalInput.attr("value",i,!1),this.classifyNClassesInput.attr("value",e.length,!1)}},_openColorPickerPopup:function(e){if(!this._colorPickerOpen){e.stopPropagation(),this._colorPicker||(this._colorPicker=new v({showTransparencySlider:!1}),this._colorPicker.startup());var i,a,r=e.target;this._colorPicker.set("color",r.style.backgroundColor,!1),N.open({popup:this._colorPicker,around:r,orient:["below","above"]}),this._colorPickerOpen=!0,i=m(document.body,"click",t.hitch(this,function(e){this._colorPicker.domNode.contains(e.target)||e.target===this._colorPicker.domNode||(a.remove(),i.remove(),N.close(this._colorPicker),this._colorPickerOpen=!1)})),a=m(this._colorPicker,"color-change",t.hitch(this,function(e){i.remove(),a.remove();var n=e.color,l=this.symbologyType===this._symbologyTypes.classify?parseInt(r.id.replace(H,""),10):parseInt(r.id.replace(j,""),10);N.close(this._colorPicker),this._colorPickerOpen=!1,"no-color"===n?r.style.background="rgba(0,0,0,0)":(n.a=1,r.style.background="rgba("+n.r+", "+n.g+","+n.b+", 255)"),this.symbologyType===this._symbologyTypes.classify?s.some(this._classifySymbolData,t.hitch(this,function(e){return e.id===l?e.esriRenderingRuleClassifySymbol={r:n.r,g:n.g,b:n.b,a:n.a}:void 0})):s.some(this._uniqueValuesSymbolData,t.hitch(this,function(e){return e.id===l?e.esriRenderingRuleUniqueValuesSymbol={r:n.r,g:n.g,b:n.b,a:n.a}:void 0}))}))}},_onColorRampChange:function(){return this.symbologyType===this._symbologyTypes.uniqueValues?this._updateUniqueValuesGrid(null,!0):this.symbologyType===this._symbologyTypes.classify?this._updateClassifyGrid(null,!0):void 0},_onStretchMethodChange:function(){if(!(this.stretchMethodList.getOptions.length<1)){var e=this.stretchMethodList.get("value");switch("0"===e?this._hideStretchOptions(!0):this._hideStretchOptions(!1),"6"!==e||this.draCheckbox.checked||this._updateStretchStatsGrid(),this._setColorRampVisibility(),this._setStretchStatsGridVisibility(),e){case"0":this.stretchMethodNoneDescBlock.style.display="";break;case"3":this.numStdDevBlock.style.display="";break;case"5":this.stretchMethodMinMaxDescBlock.style.display="";break;case"6":this.minMaxPercentDescBlock.style.display="",this.minPercentBlock.style.display="",this.maxPercentBlock.style.display=""}}},_onClickApplyRenderingRule:function(){var e=this.rasterFunctionList.get("value");e!==this._defaultBandCombinationFncName?this._onRasterFunctionApply():this._onBandIdsApply()},_onClickResetRenderingRule:function(){this.layer&&(this.layer.renderingRule=null,this.layer.bandIds=null,this.layer.renderer=null,this._setupDefaults(),this._onClickApplyRenderingRule())},_onRasterFunctionApply:function(){if(!this._donotSaveChanges&&this.layer){var e,t=[];this.layer.setBandIds(t,!0);var i=new g;i.functionName=this.rasterFunctionList.get("value");var s=this._getStretchFunction();this.layer.version>=10.3?this.symbologyType===this._symbologyTypes.stretch&&this._stretchReadFromRenderingRule?s&&(s.functionArguments.Raster=i,this._colorRampVisible&&"none"!==this.colorRampSelect.value?(e=this._getColorMapFunction(),e.functionArguments.Raster=s,this.layer.setRenderingRule(e)):this.layer.setRenderingRule(s)):(this._onRendererApply(!0),this.layer.setRenderingRule(i)):(this.layer.setRenderer(null,!0),this.layer.setRenderingRule(i))}},_onBandIdsApply:function(){if(!this._donotSaveChanges&&this.layer){if(!this._redBandIdStore||!this.bandIdsGreenList||!this.bandIdsBlueList)return this.layer.setRenderingRule(null,!0),void this._onRendererApply(!1);var e=[],t=this._redBandIdStore.get(this.bandIdsRedList.value),i=this._greenBandIdStore.get(this.bandIdsGreenList.value),s=this._blueBandIdStore.get(this.bandIdsBlueList.value);t&&i&&s&&(e.push(t.index),e.push(i.index),e.push(s.index)),this.layer.setRenderingRule(null,!0),this._onRendererApply(!0),this.layer.setBandIds(e)}},_onRendererApply:function(e){!this._donotSaveChanges&&this.layer&&(this.symbologyType===this._symbologyTypes.classify?this._onClassifyApply(e):this.symbologyType===this._symbologyTypes.uniqueValues?this._onUniqueValuesApply(e):this._onStretchApply(e))},_onStretchApply:function(e){if(!this._donotSaveChanges&&this.layer)if(this._stretchReadFromRenderingRule){var t,i=this._getStretchFunction();this._colorRampVisible&&"none"!==this.colorRampSelect.value?(t=this._getColorMapFunction(),t.functionArguments.Raster=i,this.layer.setRenderingRule(t)):this.layer.setRenderingRule(i,e)}else{if("0"===this.stretchMethodList.value&&(!this._colorRampVisible||"none"==this.colorRampSelect.value))return this.layer.setRenderer(null,e);var s=new T,a=this.stretchMethodList.get("value");s.stretchType=s._convertStretchTypeIndexToEnum(parseInt(a,10)),s.dra=this.draCheckbox.checked?!0:!1;var r=Math.exp(this.gammaSlider.value*Math.log(10));r=parseFloat(parseFloat(r).toFixed(2));var n=[];n.push(r),this.layer.bandCount>1&&(n.push(r),n.push(r)),6==a&&(s.minPercent=this.minPercentText.value,s.maxPercent=this.maxPercentText.value),3==a&&(s.numberOfStandardDeviations=this.numStdDevText.value),s.statistics=this._getStretchStats(),s.gamma=n,s.useGamma=!0,s.outputPixelType="U8",this._colorRampVisible&&"none"!==this.colorRampSelect.value&&(s.colorRamp=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName)),this.layer.setRenderer(s,e)}},_getStretchStats:function(){var e=this._getCurrentServiceInfo().bandCount,t=[],i=this._stretchStatsData;if(e&&!this.draCheckbox.checked&&"6"!==this.stretchMethodList.value&&"0"!==this.stretchMethodList.value&&this._isStretchGridDataValid()){var s;for(s=0;s<Math.min(e,3);s++)t.push([i[s].esriRenderingRuleStretchMin,i[s].esriRenderingRuleStretchMax,i[s].esriRenderingRuleStretchMean,i[s].esriRenderingRuleStretchStdv]);return t}return[]},_onUniqueValuesApply:function(e){var t=new F,i=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName);i&&(t.authoringInfo={},t.authoringInfo.colorRamp=i.toJson()),t.infos=this._getUniqueValueInfos(this._uniqueValuesSymbolData),t.attributeField=this.uniqueValuesFieldSelect.value,this.layer.setRenderer(t,e)},_getUniqueValueInfos:function(e){var t,i=[];return s.forEach(e,function(e){t=e.esriRenderingRuleUniqueValuesSymbol,(isNaN(t.r)||isNaN(t.g)||isNaN(t.b))&&(t={r:0,g:0,b:0,a:0});var s=new B("solid",null,new V(t));i.push({value:e.esriRenderingRuleUniqueValuesValue,label:e.esriRenderingRuleUniqueValuesLabel.toString(),symbol:s})}),i},_onClassifyApply:function(e){var t,i;i=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName),t=new x({field:this.classifyFieldSelect.value,showInAscendingOrder:!0,classificationMethod:this.classifyMethodSelect.value}),i&&(t.authoringInfo={},t.authoringInfo.colorRamp=i.toJson()),t.infos=this._getClassBreakInfos(),t.minimumBreak=t.infos.minValue,t.attributeField=this.classifyFieldSelect.value,this.layer.setRenderer(t,e)},_getClassBreakInfos:function(){var e,t,i=[];return s.forEach(this._classifySymbolData,function(s,a){e=s.esriRenderingRuleClassifySymbol,(isNaN(e.r)||isNaN(e.g)||isNaN(e.b))&&(e={r:0,g:0,b:0,a:0}),t=new B("solid",null,new V(e)),i.push({minValue:s.minValue,maxValue:s.maxValue,label:s.esriRenderingRuleClassifyLabel,symbol:t})}),i},_getStretchFunction:function(){var e=this.stretchMethodList.get("value"),t=null;return"0"!==e&&(t=new g,t.functionName="Stretch",this._buildStretchFunction(t)),t},_buildStretchFunction:function(e){e.functionName="Stretch";var t=this.stretchMethodList.get("value"),i={};i.StretchType=parseInt(t,10),i.DRA=this.draCheckbox.checked?!0:!1;var s=Math.exp(this.gammaSlider.value*Math.log(10));s=parseFloat(parseFloat(s).toFixed(2));var a=[];a.push(s),this.layer.bandCount>1&&(a.push(s),a.push(s)),i.Gamma=a,i.UseGamma=!0,"3"===t?(i.NumberOfStandardDeviations=this.numStdDevText.value,e.outputPixelType="U8"):"6"===t?(i.MinPercent=parseFloat(this.minPercentText.value),i.MaxPercent=parseFloat(this.maxPercentText.value),e.outputPixelType="U8"):"5"===t&&(e.outputPixelType="U8"),i.Statistics=this._getStretchStats(),e.functionArguments=i},_onGammaChange:function(e){var t=this._gammaSliderTooltip;if(t&&this.symbologyTypeSelect.value===this._symbologyTypes.stretch){var i=Math.exp(e*Math.log(10));i?t.label=parseFloat(i).toFixed(2):t.label=e,t.open("gammaSliderID")}},_onGammaMouseLeave:function(){this.gammaTooltipClose()},_disableBandIds:function(){this.bandIdsRedList.set("disabled",!0),this.bandIdsGreenList.set("disabled",!0),this.bandIdsBlueList.set("disabled",!0),this.bandIdsLabel.style.color="Gray"},_enableBandIds:function(){this.bandIdsRedList.set("disabled",!1),this.bandIdsGreenList.set("disabled",!1),this.bandIdsBlueList.set("disabled",!1),""===this.bandIdsRedList.value&&this.bandIdsRedList.attr("value","1",!1),""===this.bandIdsGreenList.value&&this.bandIdsGreenList.attr("value","2",!1),""===this.bandIdsBlueList.value&&this.bandIdsBlueList.attr("value","3",!1),this._isStretchRenderer(this.layer.renderer)||this._getStretchFunction(this.layer.renderingRule)||this._updateStretchStatsGrid(),this.bandIdsLabel.style.color="Black"},_showBandIds:function(){this.bandIdsLabelBlock.style.display="",this.bandIdsBlock.style.display="",this.bandIdsMsgBlock.style.display=""},_hideBandIds:function(){this.bandIdsLabelBlock.style.display="none",this.bandIdsBlock.style.display="none",this.bandIdsMsgBlock.style.display="none"},_hideStretch:function(){this.imageEnhancementLabel.style.display="none",this.stretchDescLabel.style.display="none",this.stretchMethodLabel.style.display="none",this.stretchMethodList.domNode.style.display="none",this._hideStretchOptions(!0)},_hideStretchOptions:function(e){var t="";e&&(t="none"),this.gammaBlock.style.display=t,this.draBlock.style.display=t,this.stretchMethodNoneDescBlock.style.display="none",this.stretchMethodMinMaxDescBlock.style.display="none",this.numStdDevBlock.style.display="none",this.minMaxPercentDescBlock.style.display="none",this.minPercentBlock.style.display="none",this.maxPercentBlock.style.display="none",this.stretchStatsBlock.style.display="none"},_getDefaultRedBandIndex:function(){var e;return this._redBandIdStore&&(e=this._redBandIdStore.get("Red")),e||(e=1),e},_getClassifyGridData:function(e){var t=this.classifyMethodSelect.value,i=Math.min(this.classifyNClassesInput.value,16),a=this.colorRampSelect.colorRamp,r=this.classifyIntervalInput.value,n=this.classifyFieldSelect.value;if(this._classifySymbolData||(e=!1),this.layer&&t&&i&&a){var l=e?this._classifySymbolData:this._getClassBreaks(t,i,n,r);if(l){var o,h=k.convertColorRampToColormap(a,l.length),u=e?this._classifySymbolData:[];return s.forEach(l,function(t,i){o={r:h[i][1],g:h[i][2],b:h[i][3],a:1},e?u[i].esriRenderingRuleClassifySymbol=o:u.push({esriRenderingRuleClassifySymbol:o,minValue:t.minValue,maxValue:t.maxValue,esriRenderingRuleClassifyLabel:"≤ "+Math.floor(1e3*t.maxValue)/1e3})}),u}}},_getClassBreaks:function(e,t,i,a){var r,n,l,o=this._cachedHistogramsList&&this._cachedHistogramsList[this.layer.id]?this._cachedHistogramsList[this.layer.id][this.rasterFunctionList.value]:null,h=this._cachedRATList&&this._cachedRATList[this.layer.id]?this._cachedRATList[this.layer.id][this.rasterFunctionList.value]:null;if(this.layer&&(h||o)){if(h){var u=h.features,d=[];return r=n=u[0].attributes[i],s.forEach(u,function(e){e.attributes.Count&&d.push(e.attributes.Count),l=e.attributes[i],r>l&&(r=l),l>n&&(n=l)}),a&&(n-r)/a>16&&(a=(n-r)/16),C.calculateClassBreaks(u,null,i,null,null,e,t,null,d,a)}return o&&o.length&&o[0].dataPoints&&o[0].counts?(r=o[0].dataPoints[0],n=o[0].dataPoints[o[0].dataPoints.length-1],a&&(n-r)/a>16&&(a=(n-r)/16),C.calculateClassBreaks(null,o[0].dataPoints,null,null,null,e,t,null,o[0].counts,a)):void 0}},_getUniqueValuesGridData:function(e){var t=this._getCurrentServiceInfo(),i=t&&t.hasRasterAttributeTable?t.hasRasterAttributeTable:this.layer.hasRasterAttributeTable,a=this.layer.rasterAttributeTable,r=this.rasterFunctionList.value;if(r!==this._defaultBandCombinationFncName&&this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][r]&&(a=this._cachedRATList[this.layer.id][r]),i&&a){var n,l,o,h,u,d,c=this.colorRampSelect.colorRamp,m=this.uniqueValuesFieldSelect.value,y=c&&c.colorRamps?c.colorRamps.length:1,f=[],g=[],p=0,R=0;if(e?g=n=this._uniqueValuesSymbolData:(n=a.features,n=this._sortFeatures(n,m)),c&&n&&m){for(R=0;y>R;R++)f[R]={},f[R].start=p,f[R].end=p+1/y,p=f[R].end;return s.forEach(n,function(t,i){if(c!==this._uniqueValuesColorRamp)u=(i+.5)/n.length,s.forEach(f,function(s,a){u>=s.start&&u<s.end&&(d=(u-s.start)/(s.end-s.start),f.length>1?(l=S.getDojoColor(c.colorRamps[a].fromColor),o=S.getDojoColor(c.colorRamps[a].toColor)):(l=S.getDojoColor(c.fromColor),o=S.getDojoColor(c.toColor)),h=k.interpolateLabColor(l,o,d),e?n[i].esriRenderingRuleUniqueValuesSymbol=S.correctRGBLimits(h):g.push({esriRenderingRuleUniqueValuesSymbol:S.correctRGBLimits(h),esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesLabel:_.isDefined(t.value)?t.value.toString():"",features:t.features}))},this);else if(t.features&&t.features[0]){var a=this._getFeatureRGBValue(t.features[0].attributes);e?t.esriRenderingRuleUniqueValuesSymbol={r:a[0],g:a[1],b:a[2],a:1}:g.push({esriRenderingRuleUniqueValuesSymbol:{r:a[0],g:a[1],b:a[2],a:1},esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesLabel:_.isDefined(t.value)?t.value.toString():"",features:t.features})}},this),g}}},_areFieldValuesUnique:function(e,t){var i=[];return s.some(t,function(t){return i.indexOf(t.attributes[e])>-1?!0:void i.push(t.attributes[e])})?!1:!0},_sortFeatures:function(e,i){if(e&&i){e=t.clone(e);var a=[],r=[];return this._areFieldValuesUnique(i,e)||e.sort(function(e,t){return"string"==typeof e.attributes[i]?e.attributes[i]<t.attributes[i]?-1:1:e.attributes[i]-t.attributes[i]}),s.forEach(e,function(e,t){var s=e.attributes[i];t>0&&r.indexOf(s)>-1?a[r.indexOf(s)].features.push(e):(r.push(s),a.push({value:s,features:[e]}))}),a}},_getColorRGB:function(e){return{r:e[0],g:e[1],b:e[2]}},_isStretchGridDataValid:function(){var e,t=this._stretchStatsData;return t&&t.length?s.some(t,function(t){for(var i in t)if(e=t[i],t.hasOwnProperty(i)&&"id"!==i&&void 0!==e&&null!==e&&!isNaN(e))return!0}):!1},_sanitizeStretchStatsData:function(e){return e?(s.forEach(e,function(e){for(var t in e)void 0===e[t]&&(e[t]=null)}),e):void 0},_convertColorRamps:function(e,t){if(e){var i=null;if(e.type&&"multipart"==e.type.toLowerCase()){i=new I;var a=[];s.forEach(e.colorRamps,function(e){var t=new L;t.algorithm="hsv",t.fromColor=new V(e.fromColor),t.toColor=new V(e.toColor),a.push(t)}),i.colorRamps=a}else i=new L,i.algorithm="hsv",i.fromColor=new V(e.fromColor),i.toColor=new V(e.toColor);return i.name=t,i}},gammaTooltipClose:function(){this._gammaSliderTooltip&&this._gammaSliderTooltip.close()}});return c("extend-esri")&&t.setObject("dijit.RenderingRule",E,f),E});