// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/kernel","dojo/has","dojo/query","dojo/dom","dojo/dom-attr","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dojo/dom-geometry","dojox/html/entities","../kernel","../lang","../SpatialReference","../geometry/webMercatorUtils","../geometry/Extent"],(function(t,e,i,s,o,n,r,a,d,h,l,c,u,_,m,y,f,p,g){var L=t(null,{declaredClass:"esri.dijit.Attribution",itemDelimiter:" | ",listClass:"esriAttributionList",itemClass:"esriAttributionItem",lastItemClass:"esriAttributionLastItem",delimiterClass:"esriAttributionDelim",constructor:function(t,i){try{e.mixin(this,t),this._attributions={},this._pendingDfds={},this._activeLayers=[],this._sharedLayers=[],this._layerHandles={};var n=this.domNode=a.byId(i),r=this.map,h="<span class='"+this.listClass+"'></span>";if(n&&(d.set(n,"innerHTML",h),this.listNode=o.query(".esriAttributionList",n)[0],this.itemNodes={}),this._eventConnections=[s.connect(r,"onLayerAdd",this,this._onLayerAdd),s.connect(r,"onLayerRemove",this,this._onLayerRemove),s.connect(r,"onLayerSuspend",this,this._onLayerSuspend),s.connect(r,"onLayerResume",this,this._onLayerResume),s.connect(r,"onResize",this,this._adjustFocus),s.connect(r,"onExtentChange",this,this._onExtentChange)],r.loaded){var l,c,u=r.layerIds.concat(r.graphicsLayerIds),_=u.length;for(c=0;c<_;c++)(l=r.getLayer(u[c])).loaded&&this._onLayerAdd(l)}}catch(t){}},startup:function(){},destroy:function(){i.forEach(this._eventConnections,s.disconnect),h.destroy(this.listNode);var t=this._layerHandles;for(var e in t)t[e]&&t[e].remove();this.map=this.domNode=this._eventConnections=this.listNode=this._attributions=this._pendingDfds=this.itemNodes=this._activeLayers=this._lastItem=this._sharedLayers=this._layerHandles=null},_onLayerAdd:function(t){try{var i=this._attributions,s=t.id;if(y.isDefined(i[s])||!t.showAttribution)return;if(t.hasAttributionData){var o=t.getAttributionData();this._pendingDfds[s]=1,i[s]=o,o.addBoth(e.partial(this._onAttributionLoad,this,t))}else i[s]=t.copyright||t.copyrightText||"",i[s]?(t.suspended||this._activeLayers.push(s),this._createNode(s)):this._onLayerRemove(t);t.declaredClass.toLowerCase().indexOf("vetiledlayer")>-1&&(this._layerHandles[s]=t.on("map-style-change",e.hitch(this,(function(){this._onLayerRemove(t),this._onLayerAdd(t)}))))}catch(t){}},_onAttributionLoad:function(t,e,i){var s=t._attributions,o=t._pendingDfds,n=e.id;o&&o[n]&&(delete o[n],(!i||i instanceof Error)&&(i=""),s[n]=i?t._createIndexByLevel(i,-1!==e.declaredClass.toLowerCase().indexOf("vetiledlayer")):e.copyright||e.copyrightText||"",s[n]?(e.suspended||t._activeLayers.push(n),t._createNode(n)):t._onLayerRemove(e))},_onLayerRemove:function(t){try{var e,s=t.id,o=this.itemNodes,n=-1;this._onLayerSuspend(t),this._layerHandles[s]&&this._layerHandles[s].remove(),delete this._attributions[s],delete this._pendingDfds[s],delete this._layerHandles[s],-1!==(e=this._getGroupIndex(s))&&-1!==(n=i.indexOf(this._sharedLayers[e],s))&&(this._sharedLayers[e].splice(n,1),this._sharedLayers[e].length<=1&&this._sharedLayers.splice(e,1)),o[s]&&-1===n&&h.destroy(o[s]),delete o[s],this._updateLastItem()}catch(t){}},_onLayerSuspend:function(t){try{var e=t.id;if(this._attributions[e]){var s=i.indexOf(this._activeLayers,e),o=this.itemNodes[e];-1!==s&&this._activeLayers.splice(s,1),o&&this._toggleItem(o,!1,this._getGroupIndex(e))}}catch(t){}},_adjustFocus:function(){var t=this.domNode.scrollWidth>this.domNode.clientWidth,e=c.contains(this.domNode,"esriAttributionOpen");d.set(this.domNode,"tabIndex",t||e?"0":"")},_onLayerResume:function(t){try{var s=t.id,o=this._attributions[s],n=this.itemNodes[s];if(o&&(-1===i.indexOf(this._activeLayers,s)&&this._activeLayers.push(s),n)){var r=e.isString(o)?o:this._getContributorsList(o,this.map.extent,this.map.getLevel());e.isString(o)||d.set(n,"innerHTML",r?_.encode(r)+this._getDelimiter():""),r&&this._toggleItem(n,!0,this._getGroupIndex(s))}}catch(t){}},_onExtentChange:function(t,i,s,o){try{var n,r,a,h,l=this._activeLayers,c=this._attributions,u=this.itemNodes,m=l.length||0;for(h=0;h<m;h++)if(a=c[r=l[h]],(n=u[r])&&!e.isString(a)){var y=this._getContributorsList(a,t,o?o.level:-1);d.set(n,"innerHTML",y?_.encode(y)+this._getDelimiter():""),this._toggleItem(n,!!y,-1)}}catch(t){}this._adjustCursorStyle()},_createNode:function(t){if(this.domNode){var i,s=this._checkShareInfo(t),o=s&&s.sharedWith,n=o&&this.itemNodes[o],r=this.map,a=this._attributions[t],d=e.isString(a)?a:this._getContributorsList(a,r.extent,r.getLevel()),l=!!d&&!r.getLayer(t).suspended;n?(this.itemNodes[t]=n,this._toggleItem(n,l,s.index)):(i=this.itemNodes[t]=h.create("span",{class:this.itemClass,innerHTML:d?_.encode(d)+this._getDelimiter():"",style:{display:l?"inline":"none"}},this.listNode),l&&this._setLastItem(i)),this._adjustCursorStyle()}},_checkShareInfo:function(t){var s,o,n,r=this._attributions,a=-1,d=r[t];if(d&&e.isString(d)){for(o in r)if(s=r[o],o!==t&&s&&e.isString(s)&&s.length===d.length&&s.toLowerCase()===d.toLowerCase()){n=o;break}var h,l=this._sharedLayers,c=l.length;if(n){for(o=0;o<c;o++)if(h=l[o],-1!==i.indexOf(h,n)){a=o,h.push(t);break}-1===a&&(a=l.push([n,t])-1)}}return a>-1?{index:a,sharedWith:n}:null},_getGroupIndex:function(t){var e,s=this._sharedLayers,o=s.length,n=-1;for(e=0;e<o;e++)if(-1!==i.indexOf(s[e],t)){n=e;break}return n},_getDelimiter:function(){var t=this.itemDelimiter;return t?"<span class='"+this.delimiterClass+"'>"+t+"</span>":""},_toggleItem:function(t,e,s){if(s>-1&&!e){var o,n=this._sharedLayers[s],r=n.length,a=this._activeLayers;for(o=0;o<r;o++)if(-1!==i.indexOf(a,n[o]))return}l.set(t,"display",e?"inline":"none"),this._updateLastItem()},_updateLastItem:function(){var t,e,i=this.listNode.childNodes,s=i.length;if(s)for(t=s-1;t>=0;t--)if(e=i[t],"none"!==l.get(e,"display")){this._setLastItem(e);break}this._adjustCursorStyle()},_setLastItem:function(t){var e=this.itemClass,i=this.lastItemClass;this._lastItem&&c.replace(this._lastItem,e,i),t&&(c.replace(t,i,e),this._lastItem=t)},_createIndexByLevel:function(t,e){var i,s,o,n,r,a,d,h,l,c=t.contributors,u=c?c.length:0,_=new f(4326),m={};for(n=0;n<u;n++)for(a=(s=(i=c[n]).coverageAreas)?s.length:0,r=0;r<a;r++)for(l=(o=s[r]).bbox,d=(h={extent:p.geographicToWebMercator(new g(l[1],l[0],l[3],l[2],_)),attribution:i.attribution||"",zoomMin:o.zoomMin-(e&&o.zoomMin?1:0),zoomMax:o.zoomMax-(e&&o.zoomMax?1:0),score:y.isDefined(o.score)?o.score:100,objectId:n}).zoomMin;d<=h.zoomMax;d++)m[d]=m[d]||[],m[d].push(h);return m},_getContributorsList:function(t,e,i){var s="";if(e&&y.isDefined(i)&&i>-1){var o,n,r=t[i],a=e.getCenter().normalize(),d=r?r.length:0,h=[],l={};for(n=0;n<d;n++)!l[(o=r[n]).objectId]&&o.extent.contains(a)&&(l[o.objectId]=1,h.push(o));for(h.sort((function(t,e){return e.score-t.score||t.objectId-e.objectId})),d=h.length,n=0;n<d;n++)h[n]=h[n].attribution;s=h.join(", ")}return s},_adjustCursorStyle:function(){var t=u.position(this.listNode.parentNode,!0).h;c.contains(this.listNode.parentNode,"esriAttributionOpen")?(c.remove(this.listNode.parentNode,"esriAttributionOpen"),t>u.position(this.listNode.parentNode,!0).h?(l.set(this.listNode.parentNode,"cursor","pointer"),c.add(this.listNode.parentNode,"esriAttributionOpen")):l.set(this.listNode.parentNode,"cursor","default")):(c.add(this.listNode.parentNode,"esriAttributionOpen"),t<u.position(this.listNode.parentNode,!0).h?l.set(this.listNode.parentNode,"cursor","pointer"):l.set(this.listNode.parentNode,"cursor","default"),c.remove(this.listNode.parentNode,"esriAttributionOpen")),this._adjustFocus()}});return n("extend-esri")&&e.setObject("dijit.Attribution",L,m),L}));