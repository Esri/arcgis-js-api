// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/number","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/form/NumberSpinner","dijit/form/NumberTextBox","../../kernel","../../lang","./AnalysisBase","./_AnalysisOptions","./CreditEstimator","./utils","./TrafficTime","dojo/i18n!../../nls/jsapi","dojo/text!./templates/FindNearest.html"],function(e,t,s,i,a,n,r,h,o,l,u,c,d,m,y,f,_,p,g,L,C,b,v,T,S,w,O,j,x,I,N,A,U,M,k,F,D,R,B,E){var W=t([f,_,p,g,L,k,M],{declaredClass:"esri.dijit.analysis.FindNearest",templateString:E,widgetsInTemplate:!0,analysisLayer:null,nearLayers:null,summaryFields:null,outputLayerName:null,nearLayer:null,searchCutoff:100,searchCutoffUnits:"Miles",measurementType:"StraightLine",maxCount:1,returnFeatureCollection:!1,enableTravelModes:!0,i18n:null,toolName:"FindNearest",helpFileName:"FindNearest",resultParameter:["nearestLayer","connectingLinesLayer"],_timeObj:null,constructor:function(e){this._pbConnects=[],this._statsRows=[],this._timeObj={hours:1,minutes:0,seconds:0},e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),i.forEach(this._pbConnects,a.disconnect),delete this._pbConnects,this._driveTimeClickHandles&&this._driveTimeClickHandles.length>0&&(i.forEach(this._driveTimeClickHandles,a.disconnect),this._driveTimeClickHandles=null)},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,B.bufferTool),s.mixin(this.i18n,B.driveTimes),s.mixin(this.i18n,B.FindNearestTool)},postCreate:function(){this.inherited(arguments),m.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this._hoursInput.set("validator",s.hitch(this,this.validateTime,"hours")),this._minutesInput.set("validator",s.hitch(this,this.validateTime,"minutes")),this._secondsInput.set("validator",s.hitch(this,this.validateTime,"seconds")),this._buildUI()},startup:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_handleShowCreditsClick:function(e){if(e.preventDefault(),this._form.validate()){var t,i={};t=this.nearLayers[this._layersSelect.get("value")],i.nearLayer=n.toJson(this.constructAnalysisInputLyrObj(t)),i.measurementType=this.get("measurementType"),i.analysisLayer=n.toJson(this.constructAnalysisInputLyrObj(this.analysisLayer)),this._searchCutoffInput.get("value")===!0?(i.searchCutoff=this.get("searchCutoff"),-1!==this.get("measurementType").indexOf("Time")?i.searchCutoffUnits="Minutes":i.searchCutoffUnits=this.get("searchCutoffUnits")):i.searchCutoff=null,i.maxCount=this.get("maxCount"),this._trafficTimeWidget.get("checked")&&(i.timeOfDay=this._trafficTimeWidget.get("timeOfDay"),"UTC"===this._trafficTimeWidget.get("timeZoneForTimeOfDay")&&(i.timeZoneForTimeOfDay=this._trafficTimeWidget.get("timeZoneForTimeOfDay"))),this.returnFeatureCollection||(i.OutputName=n.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(i.context=n.toJson({extent:this.map.extent._normalize(!0)})),this.getCreditsEstimate(this.toolName,i).then(s.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()}))}},_handleSaveBtnClick:function(){if(this._form.validate()){this._saveBtn.set("disabled",!0);var e,t,s,i,a={},r={};e=this.nearLayers[this._layersSelect.get("value")],a.nearLayer=n.toJson(this.constructAnalysisInputLyrObj(e)),s=this._measureMethodSelect.getOptions(this._measureMethodSelect.get("value")),a.measurementType=s.travelMode?n.toJson(s.travelMode):this._measureMethodSelect.get("value"),a.analysisLayer=n.toJson(this.constructAnalysisInputLyrObj(this.analysisLayer)),this._limitSearchRangeCheck.get("checked")?(a.searchCutoff=this.get("searchCutoff"),-1===this.get("measurementType").indexOf("Time")&&(a.searchCutoffUnits=this.get("searchCutoffUnits"))):a.searchCutoff=null,this._findNearestCheck.get("checked")?a.maxCount=this.get("maxCount"):a.maxCount=null,this._trafficTimeWidget.get("checked")&&(a.timeOfDay=this._trafficTimeWidget.get("timeOfDay"),"UTC"===this._trafficTimeWidget.get("timeZoneForTimeOfDay")&&(a.timeZoneForTimeOfDay=this._trafficTimeWidget.get("timeZoneForTimeOfDay"))),this.returnFeatureCollection||(a.OutputName=n.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(a.context=n.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(t={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.extent=this.map.extent._normalize(!0)),a.context=n.toJson(t)),i={description:o.substitute(this.i18n.itemDescription,{sumNearbyLayerName:this.analysisLayer.name,summaryLayerName:e.name}),tags:o.substitute(this.i18n.itemTags,{sumNearbyLayerName:this.analysisLayer.name,summaryLayerName:e.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(i.folder=this.get("folderId")),"StraightLine"!==a.measurementType&&this.showOutputType&&(a.includeRouteLayers=this._incldRouteLayersChk.get("checked")),r.itemParams=i,r.jobParams=a,this.execute(r)}},_handleLayerChange:function(e){var t;"browse"===e?(this._isAnalysisSelect=!1,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(d=this._browseLyrsdlg.browseItems.get("query"),d.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",d)),this._isAnalysisSelect=!1,this._browseLyrsdlg.show()):(t=this.nearLayers[e],U.isDefined(t)&&this.analysisLayer&&(this.outputLayerName=o.substitute(this.i18n.outputLayerName,{layer:t.name,sumNearbyLayerName:this.analysisLayer.name})),this._outputLayerInput.set("value",this.outputLayerName))},_handleLimitSearchCheckChange:function(e){-1!==this.get("measurementType").indexOf("Time")?(this._hoursInput.set("disabled",!e),this._minutesInput.set("disabled",!e),this._secondsInput.set("disabled",!e)):(this._distanceUnitsSelect.set("disabled",!e),this._searchCutoffInput.set("disabled",!e))},_handleFindNearestCheckChange:function(e){this._maxCountInput.set("disabled",!e)},_handleTimeUnitsChange:function(e){},_handleDistValueChange:function(e){this.set("outputLayerName")},_handleDistUnitsChange:function(e){this.set("outputLayerName"),this.set("searchCutoffUnits",e)},_handleDistanceTypeChange:function(e){var t,s,i;i=this._measureMethodSelect.getOptions(this._measureMethodSelect.get("value")),U.isDefined(i)?(t="Time"===i.units,s="Time"===i.units&&"driving"===i.modei18nKey):(t=-1!==e.indexOf("Time"),s="DrivingTime"===e),this.set("measurementType",e),l.set(this._useTrafficRow,"display",s?"":"none"),l.set(this._distanceLimitRow,"display",s?"none":""),l.set(this._timeLimitRow,"display",s?"":"none"),this._trafficTimeWidget.set("disabled",!s),this._trafficTimeWidget.set("reset",!s),t?(this._distanceUnitsSelect.removeOption(this._distanceUnitsSelect.getOptions()),this._distanceUnitsSelect.addOption([{value:"Seconds",label:this.i18n.seconds},{value:"Minutes",label:this.i18n.minutes,selected:"selected"},{value:"Hours",label:this.i18n.hours}])):(this.get("searchCutoffUnits")&&this.set("searchCutoffUnits",this.get("searchCutoffUnits")),this._distanceUnitsSelect.removeOption(this._distanceUnitsSelect.getOptions()),this._distanceUnitsSelect.addOption([{value:"Miles",label:this.i18n.miles},{value:"Yards",label:this.i18n.yards},{value:"Feet",label:this.i18n.feet},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}]),"StraightLine"===e&&this._distanceUnitsSelect.addOption([{type:"separator"},{value:"NauticalMiles",label:this.i18n.nautMiles}]),this._distanceUnitsSelect.set("value",this.searchCutoffUnits)),this.showOutputType&&("StraightLine"===e&&this._incldRouteLayersChk.set("checked",!1),this._incldRouteLayersChk.set("disabled","StraightLine"===e)),this.set("outputLayerName")},_save:function(){},_buildUI:function(){var e;l.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this.signInPromise.then(s.hitch(this,D.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),D.populateTravelModes({selectWidget:this._measureMethodSelect,addStraightLine:!0,widget:this,enableTravelModes:this.get("enableTravelModes")}),D.initHelpLinks(this.domNode,this.showHelp),this.get("showSelectAnalysisLayer")&&(!this.get("analysisLayer")&&this.get("analysisLayers")&&this.set("analysisLayer",this.analysisLayers[0]),D.populateAnalysisLayers(this,"analysisLayer","analysisLayers")),this.outputLayerName&&(this.outputLayerInput.set("value",this.outputLayerName),e=!1),this.analysisLayer&&this._updateAnalysisLayerUI(e),D.addReadyToUseLayerOption(this,[this._analysisSelect,this._layersSelect]),l.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(e){this.folderStore=e,D.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),l.set(this._chooseExtentDiv,"display",this.showChooseExtent===!0?"inline-block":"none"),this.measurementType&&-1===this.measurementType.indexOf("Time")?(this.searchCutoffUnits&&this._distanceUnitsSelect.set("value",this.searchCutoffUnits),this.searchCutoff&&this._searchCutoffInput.set("value",this.searchCutoff)):this.measurementType&&-1!==this.measurementType.indexOf("Time")&&this._timeObj!==this.searchCutoff&&(this._hoursInput.set("value",parseInt(this.searchCutoff.hours,10)),this._minutesInput.set("value",parseInt(this.searchCutoff.minutes,10)),this._secondsInput.set("value",parseInt(this.searchCutoff.seconds,10)),this._timeObj.hours=parseInt(this.searchCutoff.hours,10),this._timeObj.minutes=parseInt(this.searchCutoff.minutes,10),this._timeObj.seconds=parseInt(this.searchCutoff.seconds,10)),this._handleDistanceTypeChange(this.measurementType),this.maxCount&&this._maxCountInput.set("value",this.maxCount),D.updateDisplay([this._outputTypeRow],this.get("showOutputType"),"table-row"),this._loadConnections()},_updateAnalysisLayerUI:function(e){var t,s;this.analysisLayer&&(u.set(this._aggregateToolDescription,"innerHTML",o.substitute(this.i18n.summarizeDefine,{sumNearbyLayerName:this.analysisLayer.name})),"esriGeometryPoint"!==this.analysisLayer.geometryType&&(this.set("enableTravelModes",!1),this._updateTravelModes(!1))),this.nearLayers&&(t=i.some(this._layersSelect.getOptions(),function(e){return"browse"===e.value},this),s=i.some(this._layersSelect.getOptions(),function(e){return"browselayers"===e.value},this),this._layersSelect.removeOption(this._layersSelect.getOptions()),i.forEach(this.nearLayers,function(t,s){t!==this.analysisLayer&&(this._layersSelect.addOption({value:s,label:t.name}),t.analysisReady&&this.analysisLayer.analysisReady&&t.url===this.analysisLayer.url&&this._layersSelect.removeOption({value:s,label:t.name}),(!this.outputLayerName||e)&&(this.outputLayerName=o.substitute(this.i18n.outputLayerName,{layer:t.name,sumNearbyLayerName:this.analysisLayer.name})))},this),(this.get("showReadyToUseLayers")||this.get("showBrowseLayers")||t||s)&&this._layersSelect.addOption({type:"separator",value:""}),this.get("showReadyToUseLayers")&&t&&this._layersSelect.addOption({value:"browse",label:this.i18n.browseAnalysisTitle}),this.get("showBrowseLayers")&&s&&this._layersSelect.addOption({value:"browselayers",label:this.i18n.browseLayers})),this._outputLayerInput.set("value",this.outputLayerName),this.nearLayer&&this._layersSelect.set("value",this.nearLayer)},_handleAnalysisLayerChange:function(e){"browse"===e?(this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(d=this._browseLyrsdlg.browseItems.get("query"),d.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",d)),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.analysisLayer=this.analysisLayers[e],this._updateAnalysisLayerUI(!0))},_handleBrowseItemsSelect:function(e){e&&e.selection&&D.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.analysisLayers:this.nearLayers,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._layersSelect,browseDialog:e.dialog||this._browsedlg,widget:this}).always(s.hitch(this,function(e){this._isAnalysisSelect&&this._handleAnalysisLayerChange(this._analysisSelect.get("value"))}))},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1)),this._connect(this._measureMethodSelect,"onChange",s.hitch(this,"_handleDistanceTypeChange")),this.watch("enableTravelModes",s.hitch(this,function(e,t,s){this._updateTravelModes(s)}))},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setAnalysisLayerAttr:function(e){this.analysisLayer=e},_getAnalysisLayerAttr:function(e){return this.analysisLayer},_setAnalysisLayersAttr:function(e){this.analysisLayers=e},_setNearLayersAttr:function(e){this.nearLayers=e},_setLayersAttr:function(e){this.nearLayers=[]},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setSearchCutoffUnitsAttr:function(e){this.searchCutoffUnits=e},_getSearchCutoffUnitsAttr:function(){return this.searchCutoffUnits},_setMeasurementTypeAttr:function(e){this.measurementType=e},_getMeasurementTypeAttr:function(){return this.measurementType},_getSearchCutoffAttr:function(){return this.measurementType&&"DrivingTime"===this.measurementType?this._timeObj&&(this.searchCutoff=60*this._timeObj.hours+this._timeObj.minutes+this._timeObj.seconds/60):this.searchCutoff=this._searchCutoffInput.get("value"),this.searchCutoff},_setSearchCutoffAttr:function(e){e&&(this.searchCutoff=e)},_getMaxCountAttr:function(){return this.maxCount=this._maxCountInput.get("value"),this.maxCount},_setMaxCountAttr:function(e){this.maxCount=e},_setEnableTravelModesAttr:function(e){this._set("enableTravelModes",e)},validateTime:function(e,t){var s,i=!0;return s=parseInt(t,10),"hours"===e?this._timeObj.hours=s:"minutes"===e?this._timeObj.minutes=s:"seconds"===e&&(this._timeObj.seconds=s),0===this._timeObj.hours&&0===this._timeObj.minutes&&0===this._timeObj.seconds&&(i=!1),i},_connect:function(e,t,s){this._pbConnects.push(a.connect(e,t,s))},_updateTravelModes:function(e){var t=this._measureMethodSelect.getOptions();i.forEach(t,function(t){"StraightLine"!==t.value&&(t.disabled=!e)}),this._measureMethodSelect.updateOption(t)},validateServiceName:function(e){return D.validateServiceName(e,{textInput:this._outputLayerInput})}});return r("extend-esri")&&s.setObject("dijit.analysis.FindNearest",W,A),W});