// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-attr","dojo/_base/json","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/aspect","dojo/has","dojo/_base/array","dojo/_base/window","dojo/on","dojo/query","dojo/number","./Settings","./SettingsViewModel","./utils","./mixins/browselayers/BrowseLayerMixin","./mixins/FilterAndSelection","dijit/Dialog","dijit/form/NumberTextBox","dojo/i18n!../../nls/jsapi","../../lang","../../kernel"],(function(t,e,s,i,n,o,r,a,h,l,c,u,d,g,y,f,p,m,w,S,_,A,M,C){var L=t([m,w],{declaredClass:"esri.dijit.analysis._AnalysisOptions",showSelectFolder:!1,showChooseExtent:!0,showHelp:!0,showCredits:!0,returnFeatureCollection:!1,showCloseIcon:!0,showSelectAnalysisLayer:!0,map:null,showReadyToUseLayers:!0,showAnalysisBusyIndicator:!0,showGeoAnalyticsParams:!1,showBrowseLayers:!1,showAnalysisModeLabel:!1,distanceDefaultUnits:"Miles",showSettings:!1,showOutputType:!1,context:{},includeRouteLayers:!1,doSaveJobInfo:!1,doSaveInStorage:!1,showCreditCalcBusyIndicator:!0,useArcGISComponents:!1,isServerAdvanceLicensed:!0,constructor:function(t){t.rerun&&this._initRerunProps(t)},isAdmin:function(t){return M.isDefined(t.role)&&("org_admin"===t.role||"account_admin"===t.role)},isOwner:function(t,e){return t.owner?t.owner===e.id:t.userId?t.userId===e.username:!t.credential||t.credential.userId===e.username},_initRerunProps:function(t){t.OutputName&&t.OutputName.serviceProperties?t.outputLayerName=t.OutputName.serviceProperties.name:t.resultName&&(t.outputLayerName=t.resultName),t.timeStepReference&&(t.timeReference=t.timeStepReference),this.set("extentCheck",t.extentCheck),this._numberFormatHandle=a.before(_,"_setValueAttr",(function(t,e,s){return[t=g.format(t),e,s]})),this.on("close",e.hitch(this,(function(){this._numberFormatHandle&&(this._numberFormatHandle.remove(),this._numberFormatHandle=null)})))},_setShowSelectFolderAttr:function(t){!0===t&&t===this.get("returnFeatureCollection")&&(t=!t),this.showSelectFolder=t,this._webMapFolderSelect&&this._webMapFolderSelect.set("required",t),this._chooseFolderRow&&r.set(this._chooseFolderRow,"display",!0===this.showSelectFolder?"block":"none"),t&&this._webMapFolderSelect&&this.getFolderStore().then(e.hitch(this,(function(t){this.folderStore=t,p.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})))},_getShowSelectFolderAttr:function(){return this.showSelectFolder},_setShowChooseExtentAttr:function(t){this.showChooseExtent=t},_getShowChooseExtentAttr:function(){return this.showChooseExtent},_setExtentCheckAttr:function(t){this.extentCheck=t,M.isDefined(this._useExtentCheck)&&M.isDefined(t)&&this._useExtentCheck.set("checked",t)},_setMapAttr:function(t){this.map=t},_getMapAttr:function(){return this.map},_setShowHelpAttr:function(t){this.showHelp=t},_getShowHelpAttr:function(){return this.showHelp},_setReturnFeatureCollectionAttr:function(t){this.returnFeatureCollection=t,this.set("showSelectFolder",!t)},_getReturnFeatureCollectionAttr:function(){return this.returnFeatureCollection},_setShowCreditsAttr:function(t){this.showCredits=t,t&&this._showCreditsLink&&this._usageForm&&(this._onCreditsClickHandle=u.pausable(this._showCreditsLink,"click",e.hitch(this,this._handleShowCreditsClick)))},_getShowCreditsAttr:function(){return this.showCredits},_setShowCloseIconAttr:function(t){this.showCloseIcon=t},_getShowCloseIconAttr:function(){return this.showCloseIcon},_setShowSelectAnalysisLayerAttr:function(t){this.showSelectAnalysisLayer=t,this._analysisSelect&&this._analysisSelect.set("required",t)},_getShowSelectAnalysisLayerAttr:function(){return this.showSelectAnalysisLayer},_setIsSingleTenantAttr:function(t){this.isSingleTenant=t},_getIsSingleTenantAttr:function(){return this.isSingleTenant},_setAllowChooseLabelAttr:function(t){this.allowChooseLabel=t},_getAllowChooseLabelAttr:function(){return this.allowChooseLabel},_setTitleAttr:function(t){this.title=t,this._toolTitle&&s.set(this._toolTitle,"innerHTML",t)},_getTitleAttr:function(){return this.title=s.get(this._toolTitle,"innerHTML"),this.title},_setShowReadyToUseLayersAttr:function(t){this.showReadyToUseLayers=t},_getShowReadyToUseLayersAttr:function(t){return this.showReadyToUseLayers},_setFolderIdAttr:function(t){this.folderId=t},_getFolderIdAttr:function(){return this._webMapFolderSelect&&this.folderStore&&(this.folderId=this._webMapFolderSelect.item?this.folderStore.getValue(this._webMapFolderSelect.item,"id"):""),this.folderId},_setFolderNameAttr:function(t){this.folderName=t},_getFolderNameAttr:function(){return this._webMapFolderSelect&&this.folderStore&&this._webMapFolderSelect.item&&(this.folderName=this.folderStore.getValue(this._webMapFolderSelect.item,"name")),this.folderName},_setHelperServicesAttr:function(t){this.helperServices=t},_getHelperServicesAttr:function(t){return this.helperServices},_getPortalSelfAttr:function(){return this.portalSelf},_setPortalSelfAttr:function(t){this.portalSelf=t},_setShowAnalysisBusyIndicatorAttr:function(t){t&&this.own(this.on("start",e.hitch(this,(function(){this.showLoadingIndicator()}))),this.on("job-fail, job-result, job-cancel",e.hitch(this,(function(){this.hideLoadingIndicator()}))),this.on("job-status",e.hitch(this,(function(t){"esriJobFailed"===t.jobStatus&&this.hideLoadingIndicator()}))))},_setShowGeoAnalyticsParamsAttr:function(t){this.showGeoAnalyticsParams=t},_getShowGeoAnalyticsParamsAttr:function(){return this.showGeoAnalyticsParams},_setShowBrowseLayersAttr:function(t){this.showBrowseLayers=t},_getShowBrowseLayersAttr:function(){return this.showBrowseLayers},showLoadingIndicator:function(){this.get("showAnalysisBusyIndicator")&&(this._saveBtn.set("iconClass","esriLoading"),this.set("disableRunAnalysis",!0))},hideLoadingIndicator:function(){this.get("showAnalysisBusyIndicator")&&(this._saveBtn.set("iconClass",""),this.set("disableRunAnalysis",!1))},_setDistanceDefaultUnitsAttr:function(t){this.distanceDefaultUnits=t},_getDistanceDefaultUnitsAttr:function(){return this.distanceDefaultUnits},_setAnalysisModeAttr:function(t){this.analysisMode=t},_setShowAnalysisModeLabelAttr:function(t){this.showAnalysisModeLabel=t,this._titleLbl&&this._analysisModeLblNode&&(r.set(this._titleLbl,"display",this.showAnalysisModeLabel?"none":"block"),r.set(this._analysisModeLblNode,"display",this.showAnalysisModeLabel?"flex":"none"),this.showAnalysisModeLabel&&("standard"===this.analysisMode?this.analysisModeLabel=this.i18n.standard:"bigdata"===this.analysisMode||this.showGeoAnalyticsParams?this.analysisModeLabel=this.i18n.bigData:"raster"===this.analysisMode&&(this.analysisModeLabel=this.i18n.raster),s.set(this._analysisModeCrumb,"innerHTML",this.analysisModeLabel)))},_getTimeReferenceAttr:function(){if(this._timeRefDay){var t,e,s,i,n="",o="",r="";t=this._timeRefDay.get("value"),e=this._timeRefTime.get("value"),t&&(n=t.toDateString(),r="Date"),e&&(o=e.toTimeString(),r="DateTime"),this.set("timeReferenceType",r),s=o&&-1!==o.indexOf("GMT")?n+" "+o.substring(0,o.indexOf("GMT")+"GMT".length):o?n+" "+o.split(" ")[0]+" GMT":n+" GMT",i=new Date(s),this.timeReference=i.getTime()}return this.timeReference},_setTimeReferenceAttr:function(t){var e=new Date(t),s=new Date(t+60*e.getTimezoneOffset()*1e3);this._timeRefDay&&this._timeRefDay.set("value",s),this._timeRefTime&&"DateTime"===this.timeReferenceType&&this._timeRefTime.set("value",s)},_setTimeReferenceTypeAttr:function(t){this.timeReferenceType=t},_setSLayersAttr:function(t){this.sLayers=t},_setContextAttr:function(t){this.context=t},_setIncludeRouteLayersAttr:function(t){this.includeRouteLayers=t},_getIncludeRouteLayersAttr:function(){return this.includeRouteLayers},_setShowSettingsAttr:function(t){this.showSettings=t;var s=this.analysisMode&&("raster"===this.analysisMode||"bigdata"===this.analysisMode),i=this.analysisMode&&"raster"===this.analysisMode,n=i&&-1!==["ClassifyPixelsUsingDeepLearning","DetectObjectsUsingDeepLearning","ClassifyObjectsUsingDeepLearning","CalculateSlope","DeriveAspect","MonitorVegetation","ApplyRFxTemplate","RemapValues","ExtractRaster","AggregateMultidimensionalRaster","GenerateMultidimensionalAnomaly","GenerateTrendRaster","PredictUsingTrendRaster","FindArgumentStatistics","Sample","ConvertFeatureToRaster"].indexOf(this.toolName)&&this.isSingleTenant,r=i&&-1!==["ClassifyPixelsUsingDeepLearning","DetectObjectsUsingDeepLearning","ClassifyObjectsUsingDeepLearning"].indexOf(this.toolName),a=r&&this.isSingleTenant,h=i&&"Sample"===this.toolName,g=-1!==["DetectObjectsUsingDeepLearning","ClassifyObjectsUsingDeepLearning"].indexOf(this.toolName),m=-1!==["SummarizeRasterWithin","ZonalStatisticsAsTable","CalculateDensityRaster","InterpolatePointsEBK","CreateViewshedRaster","Watershed","ConvertRasterToFeature","Sample"].indexOf(this.toolName),w=-1!==["CalculateDistance","DetermineOptimumTravelCostNetwork","DetermineTravelCostPathAsPolyline","OptimalPathAsLine","OptimalPathAsRaster","DistanceAllocation","DistanceAccumulation","OptimalRegionConnections"].indexOf(this.toolName),_=-1!==["DetectObjectsUsingDeepLearning","Sample","SummarizeRasterWithin","ZonalStatisticsAsTable","CalculateDensityRaster","InterpolatePointsEBK","CreateViewshedRaster","Watershed","CalculateDistance","DetermineOptimumTravelCostNetwork","DetermineTravelCostPathAsPolyline","DistanceAllocation","DistanceAccumulation","OptimalRegionConnections"].indexOf(this.toolName),C=i&&!g&&!h,L=i&&_,b=i&&!h,x=i&&!m&&!r&&!w,R=i&&!this.isSingleTenant;if(t){if(!p.settingsDlg){var v=c.doc.createDocumentFragment(),D=o.create("div",{style:"width:200px;height:200px;"},v),T=l.filter(this.sLayers,(function(t){return!t.type||"Table"!==t.type}));p.settingsVM=new f({showHelp:!0,showCloseIcon:!1,showOverwriteResultOption:!1,showCloseAnalysisOption:!0,showStoreAnalysisOption:!0,showCoordinateSystems:this.analysisMode&&("raster"===this.analysisMode&&!g||"bigdata"===this.analysisMode),showProcessSR:this.analysisMode&&"bigdata"===this.analysisMode,showOutSR:C,showExtent:!0,showRasterSettings:i,showGeoAnalyticsSettings:this.analysisMode&&"bigdata"===this.analysisMode,showRasterPPFSettings:n,showRasterPTSettings:a,showRasterSnapSettings:C,showRasterMaskSettings:L,showCellsizeSettings:b,showResamplingSettings:x,showCreditWarningSettings:R,showHeader:!1,layers:T,showJobsHistory:!1,jobsHistoryItem:null}),this.signInPromise.then(e.hitch(this,(function(){p.settingsVM.set("portalUrl",this.portalUrl)}))),p.settings=new y({viewModel:p.settingsVM},D),this.i18n||(this.i18n={},e.mixin(this.i18n,A.common),e.mixin(this.i18n,A.analysisTools),e.mixin(this.i18n,A.analysisMsgCodes),e.mixin(this.i18n,A.analysisSettings)),p.settingsDlg=new S({title:this.i18n.analysisEnv,content:p.settings,style:"width:400px;"}),p.settingsDlg.own(p.settings.on("ok-settings",e.hitch(this,(function(){p.settingsDlg.hide()}))),p.settings.on("cancel-settings",e.hitch(this,(function(){p.settingsDlg.hide()}))))}if(p.settingsDlg&&(p.settingsVM.set("showRasterSettings",i),p.settingsVM.set("showGeoAnalyticsSettings",this.analysisMode&&"bigdata"===this.analysisMode),p.settingsVM.set("showCoordinateSystems",this.analysisMode&&("raster"===this.analysisMode&&!g||"bigdata"===this.analysisMode)),p.settingsVM.set("showProcessSR",this.analysisMode&&"bigdata"===this.analysisMode),p.settingsVM.set("showOutSR",C),p.settingsVM.set("showRasterPPFSettings",n),p.settingsVM.set("showRasterPTSettings",a),p.settingsVM.set("showRasterSnapSettings",C),p.settingsVM.set("showCellsizeSettings",b),p.settingsVM.set("showResamplingSettings",x),p.settingsVM.set("showCreditWarningSettings",R),p.settingsVM.set("showRasterMaskSettings",L),this.domNode&&d("[esriHelpTopic='toolDescription']",this.domNode).forEach(e.hitch(this,(function(t){t&&(this._settingsLink=o.create("a",{href:"#",class:"esriAnalysisSettingsIcon"},t,"before"),u(this._settingsLink,"click",e.hitch(this,this._handleSettingsLinkClick)))}))),!this._settingWatchers)){this._settingWatchers=!0;var k=this.get("context");p.settingsVM.extent&&(k.extent=p.settingsVM.extent,this._useExtentCheck&&this._useExtentCheck.set("checked",!1)),p.settingsVM.outSR&&(k.outSR=p.settingsVM.outSR),p.settingsVM.processSR&&(k.processSR=p.settingsVM.processSR),p.settingsVM.extent&&(k.extent=p.settingsVM.extent,this._useExtentCheck&&this._useExtentCheck.set("checked",!1)),p.settingsVM.cellSize&&(k.cellSize=p.settingsVM.cellSize),p.settingsVM.mask&&(k.mask=p.settingsVM.mask),p.settingsVM.snapRaster&&(k.snapRaster=p.settingsVM.snapRaster),p.settingsVM.processorType&&(k.processorType=p.settingsVM.processorType),p.settingsVM.parallelProcessingFactor&&(k.parallelProcessingFactor=p.settingsVM.parallelProcessingFactor),p.settingsVM.recycleProcessingWorkers&&(k.recycleProcessingWorkers=p.settingsVM.recycleProcessingWorkers),p.settingsVM.retryOnFailures&&(k.retryOnFailures=p.settingsVM.retryOnFailures),p.settingsVM.resamplingMethod&&(k.resamplingMethod=p.settingsVM.resamplingMethod),this.set("returnFeatureCollection",!s&&p.settingsVM.returnFeatureCollection),this._updateContextDatastore(k,p.settingsVM.datastore),this.set("context",k),p.settingsVM.watch("outSR",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.outSR=s,this.set("context",i))}))),p.settingsVM.watch("processSR",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.processSR=s,this.set("context",i))}))),p.settingsVM.watch("extent",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.extent=s,this.set("context",i)),this._useExtentCheck&&this._useExtentCheck.set("checked",!M.isDefined(s))}))),p.settingsVM.watch("cellSize",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.cellSize=s,this.set("context",i))}))),p.settingsVM.watch("mask",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.mask=s,this.set("context",i))}))),p.settingsVM.watch("snapRaster",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.snapRaster=s,this.set("context",i))}))),p.settingsVM.watch("returnFeatureCollection",e.hitch(this,(function(t,e,s){var i=this.analysisMode&&("raster"===this.analysisMode||"bigdata"===this.analysisMode);this.set("returnFeatureCollection",!i&&s)}))),p.settingsVM.watch("datastore",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(this._updateContextDatastore(i,s),this.set("context",i))}))),p.settingsVM.watch("processorType",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.processorType=s,this.set("context",i))}))),p.settingsVM.watch("parallelProcessingFactor",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.parallelProcessingFactor=s,this.set("context",i))}))),p.settingsVM.watch("recycleProcessingWorkers",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.recycleProcessingWorkers=s,this.set("context",i))}))),p.settingsVM.watch("retryOnFailures",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.retryOnFailures=s,this.set("context",i))}))),p.settingsVM.watch("resamplingMethod",e.hitch(this,(function(t,e,s){var i=this.get("context");i&&(i.resamplingMethod=s,this.set("context",i))})))}}},_updateContextDatastore:function(t,s){t&&s&&(s&&-1===["BDS","GDB"].indexOf(s)?t.dataStore=s:t.dataStore=null,setTimeout(e.hitch(this,(function(){this.set("showSelectFolder",this.showGeoAnalyticsParams?!t.dataStore:this.showSelectFolder)})),0))},_setShowOutputTypeAttr:function(t){this.showOutputType=t},_setDoSaveJobInfoAttr:function(t){this.doSaveJobInfo=t},_setDoSaveInStorageAttr:function(t){this.doSaveInStorage=t},_getResultNameAttr:function(t){return this.resultName="",this.outputLayerInput?this.resultName=this.outputLayerInput.get("value"):this._outputLayerInput&&(this.resultName=this._outputLayerInput.get("value")),this.resultName},_setArcadeEditorAttr:function(t){this.arcadeEditor=t},_setShowCreditCalcBusyIndicatorAttr:function(t){var s=[];this.showCredits&&this._showCreditsLink&&this._usageForm&&(t?(s.push(a.before(this,"_handleShowCreditsClick",e.hitch(this,(function(){var t=this._form&&this._form.validate();"DeriveNewLocations"===this.toolName||"FindExistingLocations"===this.toolName?t=t&&this.expressionGrid.validate():"EnrichLayer"==this.toolName&&(t=t&&this.validateSelectedGrid()),t?this._pauseCreditLinkClick(this._onCreditsClickHandle,!0):this._pauseCreditLinkClick(this._onCreditsClickHandle,!1)})))),s.push(a.after(this._usageForm,"_setContentAttr",e.hitch(this,(function(){this._pauseCreditLinkClick(this._onCreditsClickHandle,!1)})))),s.push(a.after(this._usageForm,"_setErrorContentAttr",e.hitch(this,(function(){this._pauseCreditLinkClick(this._onCreditsClickHandle,!1)}))))):s.forEach((function(t){t.remove(),t=null})))},_setuseArcGISComponentsAttr:function(t){this.useArcGISComponents=t},_getuseArcGISComponentsAttr:function(t){return this.useArcGISComponents},_setIsServerAdvanceLicensedAttr:function(t){this.isServerAdvanceLicensed=t},_getIsServerAdvanceLicensedAttr:function(){return this.isServerAdvanceLicensed},_handleSettingsLinkClick:function(){this.showSettingsDlg()},showSettingsDlg:function(t){t&&t.preventDefault(),this._hasPCSWarnShown&&this.showGeoAnalyticsParams&&this._errorMessagePane&&p.hideMessages(this._errorMessagePane),p.settingsDlg.show()},_handleModeCrumbClick:function(t){t.preventDefault(),this._onClose(!1)},_onFocus:function(){this.map&&"function"==typeof this.map.disableKeyboardNavigation&&this.map.disableKeyboardNavigation(),this.emit("focus"),this.inherited(arguments)},_onBlur:function(){this.map&&"function"==typeof this.map.enableKeyboardNavigation&&this.map.enableKeyboardNavigation(),this.emit("blur"),this.inherited(arguments)},_handleAtrrValueUpdate:function(t,e,s){var i,n;"0"!==s&&(i=this.get("statisticSelect"),(n=this.getOptions(s))&&n.type&&p.addStatisticsOptions({selectWidget:i,type:n.type,showGeoAnalyticsParams:this.showGeoAnalyticsParams}))},_pauseCreditLinkClick:function(t,e){e?(t.pause(),r.set(this._showCreditsLink,{color:"grey",cursor:"none"}),n.add(this._showCreditsLink,"esriAnalysisTextDisabled esriLoadingBar2")):(t.resume(),r.set(this._showCreditsLink,{color:"#21759B",cursor:"pointer"}),n.remove(this._showCreditsLink,"esriAnalysisTextDisabled esriLoadingBar2"))},constructAnalysisInputLyrObj:function(t,e){return e=M.isDefined(e)?e:this.isSingleTenant,p.constructAnalysisInputLyrObj(t,e,!this.showGeoAnalyticsParams)},_addBarrierstoJobParams:function(t,e){return t instanceof Object&&(e.pointBarrierLayer&&(t.pointBarrierLayer=i.toJson(this.constructAnalysisInputLyrObj(e.pointBarrierLayer))),e.lineBarrierLayer&&(t.lineBarrierLayer=i.toJson(this.constructAnalysisInputLyrObj(e.lineBarrierLayer))),e.polygonBarrierLayer&&(t.polygonBarrierLayer=i.toJson(this.constructAnalysisInputLyrObj(e.polygonBarrierLayer)))),t}});return h("extend-esri")&&e.setObject("dijit.analysis._AnalysisOptions",L,C),L}));