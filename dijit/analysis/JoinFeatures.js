// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["esri/layers/FeatureLayer","require","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/on","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/store/Memory","dojo/_base/fx","dojo/fx/easing","dojo/Deferred","dojo/promise/all","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/layout/AccordionContainer","dijit/TitlePane","dijit/form/FilteringSelect","dijit/form/Select","dijit/form/TextBox","dijit/Dialog","../../kernel","../../lang","./utils","./AnalysisBase","./CreditEstimator","./_AnalysisOptions","../CalculateField","../../geometry/Point","../../geometry/Polyline","../../geometry/Polygon","../../SpatialReference","./AnalysisRegistry","./ItemTypes","./ViewJsonTypes","./components/AddSummaryFields","dojo/i18n!../../nls/jsapi","dojo/text!./templates/JoinFeatures.html"],(function(e,t,i,s,a,n,r,o,l,h,d,c,u,p,y,m,_,g,f,b,L,v,w,j,T,O,S,R,F,J,A,C,x,D,I,P,E,N,k,G,U,M,B,V,q,W,H,K,Y,z,$){var Q=s([w,j,T,O,S,G,N],{declaredClass:"esri.dijit.analysis.JoinFeatures",templateString:$,widgetsInTemplate:!0,showGeoAnalyticsParams:!0,showTemporalJoin:!0,showAttributeJoin:!0,showSpatialJoin:!0,showJoinCondition:!0,allowAllAttributesTypes:!0,showRecordToKeepOption:!0,i18n:null,toolName:"JoinFeatures",helpFileName:"JoinFeatures",resultParameter:"output",removeJobParamKeys:["polyExpressionObject"],_spatialDistanceOperators:["Near","NearGeodesic","withindistance"],_temporalDistanceOperators:["Near","NearAfter","NearBefore"],constructor:function(e,t){this.targetLayers=[],this.joinLayers=[],this._pbConnects=[],this._attrJoinRows=[],e.containerNode&&(this.container=e.containerNode)},postCreate:function(){this.inherited(arguments),this.filterObjects=[{layer:"targetLayer",layers:this.targetLayers,select:this._targetLayerSelect,expressionObj:"attributeExprObj"},{layer:"joinLayer",layers:this.joinLayers,select:this._joinLayerSelect,expressionObj:"polyExpressionObject"}],this._buildUI()},postMixInProperties:function(){this.inherited(arguments),a.mixin(this.i18n,z.expressionForm),a.mixin(this.i18n,z.joinFeaturesTool),this.joinOperation||(this.joinOperation="JoinOneToOne"),this.joinOperationTypes=[{value:"JoinOneToOne",label:this.i18n.oneToOneLabel},{value:"JoinOneToMany",label:this.i18n.oneToManyLabel}],this.spatialDistance=this.spatialRelationshipDistance||this.spatialNearDistance||0,this.spatialUnit=this.spatialRelationshipDistanceUnits||this.spatialNearDistanceUnit||this.i18n.feet,this.spatialUnitTypes=[{value:"Miles",label:this.i18n.miles},{value:"Yards",label:this.i18n.yards},{value:"Feet",label:this.i18n.feet},{value:"NauticalMiles",label:this.i18n.nautMiles},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}],this.temporalDistance=0,this.temporalUnit=this.i18n.years,this.temporalUnitTypes=[{value:"Years",label:this.i18n.years},{value:"Months",label:this.i18n.months},{value:"Weeks",label:this.i18n.weeks},{value:"Days",label:this.i18n.days},{value:"Hours",label:this.i18n.hours},{value:"Minutes",label:this.i18n.minutes},{value:"Seconds",label:this.i18n.seconds},{value:"Milliseconds",label:this.i18n.milliseconds}],this.attributeType=[{value:"Equal",label:this.i18n.equalSign}]},startup:function(){},_buildUI:function(){var e,t,i,s,r,o,l=!0,h=!0;if(this._outputName.set("validator",a.hitch(this,this.validateServiceName)),this.signInPromise.then(a.hitch(this,E.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),E.updateDisplay([this._temporalJoinNode],this.showTemporalJoin,"table"),E.updateDisplay([this._spatialJoinNode],this.showSpatialJoin,"table"),E.updateDisplay([this._attributeJoinNode],this.showAttributeJoin,"table"),E.updateDisplay([this._joinConditionNode],this.showJoinCondition,"table"),E.updateDisplay([this._outputTypeRow],this.get("showOutputType")&&!this.showGeoAnalyticsParams,"block"),E.updateDisplay([this._joinOneOneOptionRow,this._joinRecordRow],this.showRecordToKeepOption&&!this.showGeoAnalyticsParams,"table-row"),this.allowAllAttributesTypes=!this.showGeoAnalyticsParams&&this.allowAllAttributesTypes,this.showJoinCondition||p.set(this._resultStepLabel,"innerHTML",this.i18n.fiveLabel),this.showGeoAnalyticsParams||(p.set(this._joinOptionsLabel,"innerHTML",this.i18n.joinOptionsStdLabel),p.set(this._joinOptionsHelpNode,"esriHelpTopic","joinType")),n.forEach(this.joinOperationTypes,(function(e,t){this._joinOperation.addOption({value:e.value,label:e.label})}),this),this.joinOperation&&(this._joinOperation.set("value",this.joinOperation),"JoinOneToMany"===this.joinOperation&&E.updateDisplay([this._joinOperationLabelRow,this._joinRecordRow,this._joinOneOneOptionRow].concat(this._summaryWidget.rows),"JoinOneToOne"===this.joinOperation,"table-row")),n.forEach(this.spatialUnitTypes,(function(e,t){this._spatialUnitSelect.addOption({value:e.value,label:e.label})}),this),this.spatialUnit&&this._spatialUnitSelect.set("value",this.spatialUnit),n.forEach(this.temporalUnitTypes,(function(e,t){this._temporalUnitSelect.addOption({value:e.value,label:e.label})}),this),this.temporalUnit&&this._temporalUnitSelect.set("value",this.temporalUnit),P.isDefined(this.targetLayer)&&(-1===(e=n.indexOf(this.targetLayers,this.targetLayer))&&n.forEach(this.targetLayers,(function(t,i){t&&(t.url&&this.targetLayer.url&&t.url===this.targetLayer.url||t.name===this.targetLayer.name)&&(e=i)}),this),-1===e&&this.targetLayers.push(this.targetLayer)),P.isDefined(this.joinLayer)&&(-1===(e=n.indexOf(this.joinLayers,this.joinLayer))&&n.forEach(this.joinLayers,(function(t,i){t&&(t.url&&this.joinLayer.url&&t.url===this.joinLayer.url||t.name===this.joinLayer.name)&&(e=i)}),this),-1===e&&this.joinLayers.push(this.joinLayer)),P.isDefined(this.targetLayers)&&this.targetLayers.length>0){var d=[];this.rerun&&!this.targetLayer&&E.addBlankOption(this._targetLayerSelect,d),n.forEach(this.targetLayers,(function(e,t){d.push({value:this._toString(t),label:e.name,selected:e.url&&this.targetLayer&&this.targetLayer.url&&e.url===this.targetLayer.url||e&&this.targetLayer&&!e.url&&!this.targetLayer.url&&e.name===this.targetLayer.name})}),this),this._targetLayerSelect.addOption(d),P.isDefined(this.targetLayer)||this.rerun||this.set("targetLayer",this.targetLayers[this._targetLayerSelect.get("value")])}if(P.isDefined(this.joinLayers)&&this.joinLayers.length>0){var c=[];this.rerun&&!this.joinLayer&&E.addBlankOption(this._joinLayerSelect,c),n.forEach(this.joinLayers,(function(e,t){c.push({value:this._toString(t),label:e.name,selected:e.url&&this.joinLayer&&this.joinLayer.url&&e.url===this.joinLayer.url||e&&this.joinLayer&&!e.url&&!this.joinLayer.url&&e.name===this.joinLayer.name})}),this),this._joinLayerSelect.addOption(c),P.isDefined(this.joinLayer)||this.rerun||this.set("joinLayer",this.joinLayers[this._joinLayerSelect.get("value")])}E.addReadyToUseLayerOption(this,[this._targetLayerSelect,this._joinLayerSelect]),u.set(this._chooseFolderRow,"display",!0===this.showSelectFolder?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(a.hitch(this,(function(e){this.folderStore=e,E.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})}))),u.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this._loadConnections(),this.outputLayerName&&(this._outputName.set("value",this.outputLayerName),l=!1),l=!(this.outputLayerName||this.spatialRelationship||this.temporalRelationship||this.attributeRelationship),this.joinCondition&&this._bufFieldOutput.set("value",this.joinCondition),P.isDefined(this.joinType)&&this._keepTargetFeaturesCheck.set("checked","left"===this.joinType),this._checkCreateView.set("checked",this.outputType===H.FLAYERVIEW),this._updateAnalysisLayerUI(l),this.showRecordToKeepOption&&!this.showGeoAnalyticsParams&&(E.updateDisplay([this._joinOperationLabelRow],!1),this._joinOptionSelect.set("value",this.summaryFields&&this.summaryFields.length>0?"STATS":"RECORD"),this._handleJoinOneToOneOptionChange(this._joinOptionSelect.get("value")),this._buildOrderByField(this.joinLayer,{priorityChange:!1}),this.recordsToMatch&&this.recordsToMatch.orderByFields&&this.joinLayer&&this.joinLayer.fields&&(h=(t=(s=this.recordsToMatch.orderByFields.split(" "))[0])===this.joinLayer.objectIdField,i=s[1]),this._exprRadioBtn.set("checked",!h),this._handleExprRadioChange(this._exprRadioBtn.get("checked")),!h&&t&&this._expFieldsSelect.set("value",t,!1),this._handleExpFieldChange(this._expFieldsSelect.get("value")),!h&&t&&("number"===(r=this._expFieldsSelect.getOptions(t)).type?o="ASC"===i?"Smallest":"Largest":"date"===r.type&&(o="ASC"===i?"Oldest":"Newest"),this._expFilterSelect.set("value",o))),P.isDefined(this.temporalNearDistance)&&this._temporalDistanceInput.set("value",this.temporalNearDistance),P.isDefined(this.temporalNearDistanceUnit)&&this._temporalUnitSelect.set("value",this.temporalNearDistanceUnit),this._createFilterAndSelections()},_handleTargetLayerChange:function(e){this._isAnalysisSelect=!0,"browse"===e||"browselayers"===e?this._createBrowseItems({browseValue:e,disabledSubResources:[this.targetLayer,this.joinLayer]},{layerTypes:[]},this._targetLayerSelect):(this.set("targetLayer",this.targetLayers[e]),this._updateAnalysisLayerUI(!0))},_toString:function(e){return""+e},_handleJoinLayerChange:function(e){this._isAnalysisSelect=!1,"browse"===e||"browselayers"===e?this._createBrowseItems({browseValue:e,disabledSubResources:[this.joinLayer]},{layerTypes:[]},this._joinLayerSelect):(this.set("joinLayer",this.joinLayers[e]),this._updateAnalysisLayerUI(!0),this.showRecordToKeepOption&&this._buildOrderByField(this.joinLayer))},_buildOrderByField:function(e,t){var i={selectWidget:this._expFieldsSelect,layer:e,allowStringType:!1,allowDateType:!this.showGeoAnalyticsParams};P.isDefined(t)&&P.isDefined(t.priorityChange)&&(i.priorityChange=t.priorityChange),E.addAttributeOptions(i)},_handleJoinOperationChange:function(e){if(e!==this.joinOperation){this._summaryWidget.set("required",!1),this._summaryWidget.hide();var t=[this._joinRecordRow,this._joinOneOneOptionRow];this.showRecordToKeepOption&&!this.showGeoAnalyticsParams&&E.updateDisplay(t,"JoinOneToOne"===e,"table-row"),"JoinOneToOne"!==e||this.showRecordToKeepOption&&!this.showGeoAnalyticsParams&&"STATS"!==this._joinOptionSelect.get("value")||("STATS"===this._joinOptionSelect.get("value")&&this._summaryWidget.set("required",!0),this._summaryWidget.show(),E.updateDisplay([this._joinRecordRow],!0,"none")),this.showGeoAnalyticsParams&&E.updateDisplay([this._joinOperationLabelRow],"JoinOneToOne"===e,"table-row"),this.joinOperation=e,this._updateCreateViewUI()}},_handleSpatialCheckChange:function(e,t){_.toggle(this._spatialJoin,"selected"),this.spatialJoin=_.contains(this._spatialJoin,"selected"),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&this._repopulateSpatialTypes(this.targetLayer.geometryType,this.joinLayer.geometryType,t),this.spatialJoin||_.add(this._spatialDistanceRow,"hide"),_.toggle(this._spatialRelationshipRow,"hide"),_.contains(this._spatialRelationshipRow,"hide")&&this._spatialDistanceInput.set("required",!1),this._updateCreateViewUI(),this._firstRecRadioBtn.set("checked",!0),this._exprRadioBtn.set("disabled",this.spatialJoin),this._firstRecRadioBtn.set("disabled",this.spatialJoin)},_handleSpatialRelationshipChange:function(e){this.spatialRelationship=e,-1!==this._spatialDistanceOperators.indexOf(e)?(this._spatialDistanceInput.set("required",!0),_.remove(this._spatialDistanceRow,"hide")):(_.add(this._spatialDistanceRow,"hide"),this._spatialDistanceInput.set("required",!1)),this._updateCreateViewUI()},_handleSpatialDistanceChange:function(e){this.spatialDistance=e},_handleSpatialUnitChange:function(e){this.spatialUnit=e},_handleExpBtnClick:function(){this._calcField.set("expression",this._bufFieldOutput.get("value")),this._calcField.reset(),this._exprDialog.show()},_repopulateSpatialTypes:function(e,t,i){this._spatialRelationshipSelect.removeOption(this._spatialRelationshipSelect.getOptions());var s,a={value:this.showGeoAnalyticsParams?"Equals":"identicalto",label:this.showGeoAnalyticsParams?this.i18n.equalsLabel:this.i18n.identical},r={value:this.showGeoAnalyticsParams?"Intersects":"intersects",label:this.i18n.intersectsLabel},o={value:this.showGeoAnalyticsParams?"Contains":"completelycontains",label:this.showGeoAnalyticsParams?this.i18n.containsLabel:this.i18n.completelyContains},l={value:this.showGeoAnalyticsParams?"Within":"completelywithin",label:this.showGeoAnalyticsParams?this.i18n.withinLabel:this.i18n.completelyWithin},h={value:"Crosses",label:this.i18n.crossesLabel},d={value:"Touches",label:this.i18n.touchesLabel},c={value:"Overlaps",label:this.i18n.overlapsLabel},u={value:this.showGeoAnalyticsParams?"Near":"withindistance",label:this.showGeoAnalyticsParams?this.i18n.nearPlanar:this.i18n.withinDistance},p={value:"NearGeodesic",label:this.i18n.nearGeodesic};s={esriGeometryPoint:{esriGeometryPoint:this.showGeoAnalyticsParams?[a,r,o,l,u,p]:[a,r,o,l,u],esriGeometryPolyline:this.showGeoAnalyticsParams?[r,l,d,u,p]:[r,l,u],esriGeometryPolygon:this.showGeoAnalyticsParams?[r,l,d,u,p]:[r,l,u]},esriGeometryPolyline:{esriGeometryPoint:this.showGeoAnalyticsParams?[r,o,d,u,p]:[r,o,u],esriGeometryPolyline:this.showGeoAnalyticsParams?[a,r,o,l,h,d,c,u,p]:[a,r,o,l,u],esriGeometryPolygon:this.showGeoAnalyticsParams?[r,l,h,d,u,p]:[r,l,u]},esriGeometryPolygon:{esriGeometryPoint:this.showGeoAnalyticsParams?[r,o,d,u,p]:[r,o,u],esriGeometryPolyline:this.showGeoAnalyticsParams?[r,o,h,d,u,p]:[r,o,u],esriGeometryPolygon:this.showGeoAnalyticsParams?[a,r,o,l,d,c,u,p]:[a,r,o,l,u]}},i||(this.spatialRelationship=s[e][t][0].value),n.forEach(s[e][t],(function(e,t){this._spatialRelationshipSelect.addOption({value:e.value,label:e.label})}),this),this._spatialRelationshipSelect.set("value",this.spatialRelationship)},_handleTemporalCheckChange:function(e,t){var i,s;(_.toggle(this._temporalJoin,"selected"),this.temporalJoin=_.contains(this._temporalJoin,"selected"),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer))&&(i=E.isTimeInstantLayer(this.targetLayer)?"TimeInstant":"TimeInterval",s=E.isTimeInstantLayer(this.joinLayer)?"TimeInstant":"TimeInterval",this._repopulateTemporalTypes(i,s,t));e||_.add(this._temporalDistanceRow,"hide"),_.toggle(this._temporalRelationshipRow,"hide"),_.contains(this._temporalRelationshipRow,"hide")&&this._temporalDistanceInput.set("required",!1)},_handleTemporalRelationshipChange:function(e){this.temporalRelationship=e,-1!==this._temporalDistanceOperators.indexOf(e)?(this._temporalDistanceInput.set("required",!0),_.remove(this._temporalDistanceRow,"hide")):(_.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1))},_handleTemporalDistanceChange:function(e){this.temporalDistance=e},_handleTemporalUnitChange:function(e){this.temporalUnit=e},_repopulateTemporalTypes:function(e,t,i){this._temporalRelationshipSelect.removeOption(this._temporalRelationshipSelect.getOptions());var s,a={value:"Equals",label:this.i18n.equalsLabel},r={value:"Intersects",label:this.i18n.intersectsLabel},o={value:"During",label:this.i18n.duringLabel},l={value:"Contains",label:this.i18n.containsLabel},h={value:"Finishes",label:this.i18n.finishesLabel},d={value:"Finished By",label:this.i18n.finishedByLabel},c={value:"Meets",label:this.i18n.meetsLabel},u={value:"Met By",label:this.i18n.metByLabel},p={value:"Near",label:this.i18n.near},y={value:"NearAfter",label:this.i18n.nearAfter},m={value:"NearBefore",label:this.i18n.nearBefore},_={value:"Overlaps",label:this.i18n.overlapsLabel},g={value:"Overlapped By",label:this.i18n.overlappedByLabel},f={value:"Starts",label:this.i18n.startsLabel},b={value:"Started By",label:this.i18n.startedByLabel};e&&t&&(s={TimeInstant:{TimeInstant:[a,r,p,y,m],TimeInterval:[r,o,h,f,p,y,m]},TimeInterval:{TimeInstant:[r,l,d,b,p,y,m],TimeInterval:[a,r,o,l,h,d,c,u,_,g,f,b,p,y,m]}}),i||(this.temporalRelationship=s[e][t][0].value),n.forEach(s[e][t],(function(e,t){this._temporalRelationshipSelect.addOption({value:e.value,label:e.label})}),this)},_handleAttributeCheckChange:function(e,t){_.toggle(this._attributeJoin,"selected"),this.attributeJoin=_.contains(this._attributeJoin,"selected"),_.toggle(this._attributeRelationshipRow,"hide"),t||(!0===this.attributeJoin?this._createAttrJoinRow():this._removeAttrJoinRows())},_createAttrJoinRow:function(e){var i,s,n,o,l,h,d,c,p;return i=y.create("tr",{style:{height:"40px"}},this._attributeRelationshipRow,"before"),n=y.create("td",{style:{width:"39%"}},i),o=y.create("td",{style:{width:"8%"}},i),s=y.create("td",{style:{width:"39%"}},i),(l=new C({maxHeight:200,class:"esriLeadingMargin1 esriTrailingMargin1 mediumInput esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,n))).addOption({value:"",label:this.i18n.selectTargetField}),this.targetLayer.fields.forEach((function(e,t){e.type!==W.FieldTypes.ObjectId&&l.addOption({value:this._toString(t+1),label:e.name})}),this),l.set("targetLayer",this.targetLayer),l.set("joinLayer",this.joinLayer),o.innerHTML="=",u.set(o,"text-align","center"),(h=new C({class:"mediumInput esriLeadingMargin05 esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,s))).addOption({value:"",label:this.i18n.selectJoinField}),l.set("statisticSelect",h),r.connect(l,"onChange",this._handleAttrTargetChange),c=y.create("td",{class:"shortTextInput removeTd",style:{display:"none",width:"10%",paddingTop:"1em"}},i),d=y.create("a",{title:this.i18n.remove,class:"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},c),r.connect(d,"onclick",a.hitch(this,this._removeAttrJoinRow,i)),this._attrJoinRows.push(i),1===this._attrJoinRows.length&&(l.set("required","true"),h.set("required","true")),p=y.create("td",{style:{width:"10%",display:"block"}},i),h.set("attributeSelect",l),h.set("removeTd",c),h.set("stylingTd",p),h.set("isnewRowAdded",!1),h.set("referenceWidget",this),l.set("referenceWidget",this),h._watchHandle=h.watch("value",this._handleAttrJoinUpdate),this._currentJoinSelect=h,this._currentTargetSelect=l,!0},_removeAttrJoinRow:function(e){n.forEach(R.findWidgets(e),(function(e){e.destroyRecursive()})),y.destroy(e)},_removeAttrJoinRows:function(){n.forEach(this._attrJoinRows,this._removeAttrJoinRow,this),this._attrJoinRows=[]},_handleAttrTargetChange:function(e,t,i){var s,r,o,l,h,d,c=[];s=this.get("statisticSelect"),e!==this._curTargetAttrValue&&(t&&i||n.forEach(s.getOptions(),(function(e){""!==e.value&&s.removeOption(e)}),this),""!==e&&(t&&i&&(s.removeOption(s.getOptions()),c.push({value:"",label:this.referenceWidget.i18n.selectJoinField,selected:!1})),l=this.get("targetLayer").fields[e-1]&&this.get("targetLayer").fields[e-1].type,this.get("joinLayer").fields.forEach((function(e,s){e.type!==W.FieldTypes.ObjectId&&(this.referenceWidget.showGeoAnalyticsParams&&e.type===l||this.referenceWidget.allowAllAttributesTypes)&&(t&&i&&i.joinField===e.name&&(d=s+1+""),c.push({value:s+1+"",label:e.name,selected:t&&i&&i.joinField===e.name}))}),this),s._watchHandle&&t&&i&&s._watchHandle.unwatch(),s.addOption(c),s.set("value",d),""!==s.get("value")&&(s.get("isnewRowAdded")||(r=s.get("removeTd"),h=s.get("stylingTd"),u.set(r,"display","block"),u.set(h,"display","none"),o=s.get("referenceWidget"),a.hitch(o,o._createAttrJoinRow)(),s.set("isnewRowAdded",!0)))),this._curTargetAttrValue=e)},_handleAttrJoinUpdate:function(e,t,i){var s,n;this.get("attributeSelect")&&""!==this.get("attributeSelect").get("value")&&""!==i&&(this.get("isnewRowAdded")||(s=this.get("removeTd"),u.set(s,"display","block"),n=this.get("referenceWidget"),a.hitch(n,n._createAttrJoinRow)(),this.set("isnewRowAdded",!0)))},addExpOperators:function(e){var t=e.selectWidget,i=[{value:"Largest",label:this.i18n.largest},{value:"Smallest",label:this.i18n.smallest}],s=[{value:"Newest",label:this.i18n.newest},{value:"Oldest",label:this.i18n.oldest}],a=P.isDefined(e.emptyValue)?e.emptyValue:"";t.removeOption(t.getOptions()),t.addOption([{value:a,label:this.i18n.sortBy}]),e.type&&"number"===e.type?t.addOption(i):e.type&&"date"===e.type&&t.addOption(s),t.set("value",a)},_handleShowCreditsClick:function(e){var t;e.preventDefault(),this._form.validate()&&(t=this._buildJobParams(),this.getCreditsEstimate(this.toolName,t).then(a.hitch(this,(function(e){t.outputType===H.FLAYERVIEW&&(e.cost=0,e.infoMessage=this.i18n.zeroCreditsViewResult),this._usageForm.set("content",e),this._usageDialog.show()}))))},_canCreateView:function(e){return!!e&&!!this.joinLayer&&!!this.targetLayer&&this._isOwner(this.joinLayer,e)&&this._isOwner(this.targetLayer,e)&&!this._isMultiServiceViewLayer(this.targetLayer)&&!this._isMultiServiceViewLayer(this.joinLayer)&&!this.spatialJoin},_isMultiServiceViewLayer:function(e){var t=!1;return e._json&&(t=o.fromJson(e._json).isMultiServicesView),t},_isOwner:function(e,t){return this.isOwner(e,t)&&(!e.url||-1!==e.url.indexOf(t.orgId))},_enableCreateViewUI:function(e){!e&&this._checkCreateView.get("checked")&&this._checkCreateView.set("checked",e),this._checkCreateView.set("disabled",!e)},_handleCreateViewChange:function(e){this._useExtentCheck.get("checked")&&e&&this._useExtentCheck.set("checked",!e)},_handleExtentChange:function(e){this._checkCreateView.get("checked")&&e&&this._checkCreateView.set("checked",!e)},_handleJoinOneToOneOptionChange:function(e){E.updateDisplay([this._joinRecordRow],"RECORD"===e),E.updateDisplay([this._joinOneOneOptionsHelpTd],"STATS"===e,"table-cell"),this._summaryWidget.set("required",!1),this._summaryWidget.hide(),"STATS"===e&&(this._summaryWidget.set("required",!0),this._summaryWidget.show()),this._handleExprRadioChange(this._exprRadioBtn.get("checked"))},_handleExprRadioChange:function(e){this._expFieldsSelect.set("disabled",!e),this._expFilterSelect.set("disabled",!e),this._expFieldsSelect.set("required","RECORD"===this._joinOptionSelect.get("value")&&e),this._expFilterSelect.set("required","RECORD"===this._joinOptionSelect.get("value")&&e)},_handleExpFieldChange:function(e){var t=this._expFieldsSelect.getOptions(e);this.addExpOperators({selectWidget:this._expFilterSelect,type:t&&t.type,showGeoAnalyticsParams:this.showGeoAnalyticsParams})},_getSourceLayerFields:function(e){return e=n.filter(e,(function(e){return e.type!==W.FieldTypes.ObjectId})),n.map(e,(function(e){var t={name:e.name,alias:e.alias,source:e.source?e.source:e.name};return e.statisticType&&(t.statisticType=e.statisticType,"MEAN"===t.statisticType&&(t.statisticType="AVG")),t}))},_getSourceServiceName:function(e){return e.substring(e.indexOf("/services/")+"/services/".length,e.indexOf("/FeatureServer/"))},_getLogicalTableName:function(e){return e+"_"+(new Date).getTime()},_arrIntersections:function(e,t,i){return n.filter(e,(function(e){if(i){var s=t.map((function(e){return e[i]}));return-1!==n.indexOf(s,e[i])}return-1!==n.indexOf(t,e)}))},_updateSameFieldsInRelTable:function(e,t){var i=this._arrIntersections(e,t,"name"),s=n.map(i,(function(e){return e.name}));i.length>0&&n.forEach(t,(function(e){-1!==n.indexOf(s,e.name)&&(e.name=this._getLogicalTableName(e.name))}),this)},_createIntermediateTableView:function(e){var t,i,s,r,l,h=new L,d={layers:[{name:"",description:"tablestatsjoin",adminLayerInfo:{viewLayerDefinition:{table:{materialized:!1}}}}]},c=e.jobParams,u=e.resultService,p=this._getSourceServiceName(this.joinLayer.url),y=[],m=[];return(s=d.layers[0].adminLayerInfo.viewLayerDefinition.table).name=this._getLogicalTableName(p)+"_StatsTable",d.layers[0].name=p+"_StatsTable",l=o.fromJson(c.joinLayer),s.sourceServiceName=p,s.sourceLayerId=this.joinLayer.layerId,l.filter&&(s.filter={sqlExpression:l.filter}),t=c.attributeRelationship,n.forEach(t,(function(e){e=o.fromJson(e),y.push(e.targetField),m.push(e.joinField)}),this),i=n.filter(this.joinLayer.fields,(function(e){return-1!==n.indexOf(m,e.name)})),c.summaryFields&&(r=!1,n.forEach(c.summaryFields,(function(e){var t=o.fromJson(e),s=this.joinLayer.fields.findIndex(a.hitch(this,(function(e){return e.name===t.onStatisticField}))),n=a.mixin({},this.joinLayer.fields[s],{statisticType:t.statisticType});r||(i.push({name:"Join_Count",alias:"Join_Count",statisticType:"Count",source:"esriFieldTypeDate"===n.type?m[0]+"":n.name+""}),r=!0),n.source=n.name+"",n.name=n.name+"_"+n.statisticType,n.alias=n.alias+"_"+n.statisticType,i.push(n)}),this)),s.sourceLayerFields=this._getSourceLayerFields(i),s.groupBy=m.join(),this._addToDefinition(u.url,d).then(a.hitch(this,(function(e){h.resolve({interTableViewParams:d,response:e})})),a.hitch(this,(function(e){h.reject(e)}))),h.promise},getViewParams:function(e){var t,i=new L,s=e.jobParams,r=e.resultService;return v([this._getAdminLayerInfo(this.targetLayer.url),this._getAdminLayerInfo(this.joinLayer.url)]).then(a.hitch(this,(function(e){var l,h,d,c,u=a.clone(K.joinFeatures),p=[],y=[],m=e[0].adminLayerInfo,_=e[1].adminLayerInfo,g=this._getSourceServiceName(this.targetLayer.url),f=this._getSourceServiceName(this.joinLayer.url);(t=o.fromJson(s[this.outputName]),d=o.fromJson(s.targetLayer),c=o.fromJson(s.joinLayer),u.layers[0].name=t.serviceProperties?t.serviceProperties.name:this._outputName.get("value"),(l=u.layers[0].adminLayerInfo.viewLayerDefinition.table).name=this._getLogicalTableName(g)+"_target",l.sourceServiceName=g,l.sourceLayerId=this.targetLayer.layerId,l.sourceLayerFields=this._getSourceLayerFields(this.targetLayer.fields),d.filter&&(l.filter={sqlExpression:d.filter}),m.geometryField&&m.geometryField.name?u.layers[0].adminLayerInfo.geometryField.name=l.name+"."+m.geometryField.name:u.layers[0].adminLayerInfo.geometryField=null,l.relatedTables[0].type=(s.joinOperation,"INNER"),"left"===s.joinType&&(l.relatedTables[0].type="LEFT"),"JoinOneToOne"===s.joinOperation&&s.summaryFields&&s.summaryFields.length>0)?this._createIntermediateTableView({viewParams:u,targetALinfo:m,joinALinfo:_,jobParams:s,resultService:r}).then(a.hitch(this,(function(e){var t,a=e.interTableViewParams.layers[0];l.relatedTables[0].name=a.name,l.relatedTables[0].sourceServiceName=u.layers[0].name,l.relatedTables[0].sourceLayerId=0,l.relatedTables[0].sourceLayerFields=n.map(a.adminLayerInfo.viewLayerDefinition.table.sourceLayerFields,(function(e){return{name:e.name,alias:e.alias,source:e.name}})),t=s.attributeRelationship,n.forEach(t,(function(e){e=o.fromJson(e),p.push(e.targetField),y.push(e.joinField)}),this),l.relatedTables[0].parentKeyFields=p,l.relatedTables[0].keyFields=y,i.resolve(u)})),a.hitch(this,(function(){i.reject()}))):(l.relatedTables[0].name=this._getLogicalTableName(f)+"_join",l.relatedTables[0].sourceServiceName=f,l.relatedTables[0].sourceLayerId=this.joinLayer.layerId,c.filter&&(l.relatedTables[0].filter={sqlExpression:c.filter}),("JoinOneToMany"===s.joinOperation||"JoinOneToOne"===s.joinOperation&&!s.summaryFields)&&(l.relatedTables[0].sourceLayerFields=this._getSourceLayerFields(this.joinLayer.fields),this._updateSameFieldsInRelTable(l.sourceLayerFields,l.relatedTables[0].sourceLayerFields)),s.spatialRelationship?(l.relatedTables[0].parentKeyFields=[m.geometryField.name],l.relatedTables[0].keyFields=[_.geometryField.name],l.relatedTables[0].operator="completelycontains"===s.spatialRelationship?"esriSpatialRelContains":"intersects"===s.spatialRelationship?"esriSpatialRelIntersects":"esriSpatialRelWithin"):(h=s.attributeRelationship,n.forEach(h,(function(e){e=o.fromJson(e),p.push(e.targetField),y.push(e.joinField)}),this),l.relatedTables[0].parentKeyFields=p,l.relatedTables[0].keyFields=y,"JoinOneToOne"===s.joinOperation&&this.showRecordToKeepOption&&!s.summaryFields&&(l.relatedTables[0].topFilter=this._getTopFilter(y))),i.resolve(u))})),a.hitch(this,(function(e){i.reject(e)}))),i.promise},_getTopFilter:function(e){return e||(e=[]),this._exprRadioBtn.get("checked")?{groupByFields:e.join(","),orderByFields:this._getOrderByFields(),topCount:1}:{groupByFields:e.join(","),orderByFields:this.joinLayer.objectIdField+" ASC",topCount:1}},_getOrderByFields:function(){var e="",t=this._expFilterSelect.get("value");return this._exprRadioBtn.get("checked")&&(e=this._expFieldsSelect.get("value"),e+="Largest"===t||"Newest"===t?" DESC":" ASC"),e},_buildJobParams:function(){var e,t={};if(t.targetLayer=this.constructAnalysisInputLyrObj(this.targetLayer),this.doRefreshItem="table"!==this.targetLayer.type.toLowerCase(),t.joinLayer=this.constructAnalysisInputLyrObj(this.joinLayer),this.showGeoAnalyticsParams||(t.targetLayer=o.toJson(t.targetLayer),t.joinLayer=o.toJson(t.joinLayer)),t.joinOperation=this.get("joinOperation"),this._bufFieldOutput.get("value")&&(t.joinCondition=this._bufFieldOutput.get("value")),this.spatialJoin&&(t.spatialRelationship=this._spatialRelationshipSelect.get("value"),-1!==this._spatialDistanceOperators.indexOf(t.spatialRelationship)&&(this.showGeoAnalyticsParams?(t.spatialNearDistance=parseFloat(this.get("spatialDistance")),t.spatialNearDistanceUnit=this._spatialUnitSelect.get("value")):(t.spatialRelationshipDistance=parseFloat(this.get("spatialDistance")),t.spatialRelationshipDistanceUnits=this._spatialUnitSelect.get("value")))),this.temporalJoin&&(t.temporalRelationship=this._temporalRelationshipSelect.get("value"),-1!==this._temporalDistanceOperators.indexOf(t.temporalRelationship)&&(t.temporalNearDistance=parseFloat(this.get("temporalDistance")),t.temporalNearDistanceUnit=this._temporalUnitSelect.get("value"))),this.attributeJoin){var i=[],s=0;n.forEach(this._attrJoinRows,(function(e,t,a){var r=e.children,l="",h={},d=0,c="";n.forEach(r,(function(e,t){if(t<3){if(1!==t)var i=R.byNode(e.children[0]).get("value");0===t&&""!==i&&(d++,l+='target["'+e.textContent+'"]',c=this.targetLayer.fields[parseInt(i,10)-1].type,h.targetField=e.textContent),1===t&&(d++,l+=" "+e.textContent+" ",h.operator="="===e.textContent?this._getEqualParamValue(c):e.textContent),2===t&&""!==i&&(d++,l+='join["'+e.textContent+'"]',h.joinField=e.textContent)}}),this),3===d&&(0!==s&&" and ",l,i.push(this.showGeoAnalyticsParams?h:o.toJson(h)),s++)}),this),t.attributeRelationship=this.showGeoAnalyticsParams?o.toJson(i):i}return"JoinOneToOne"===this._joinOperation.get("value")&&((e=this._summaryWidget.get("summaryFields")).length>0?t.summaryFields=this.showGeoAnalyticsParams?o.toJson(e):e:this.showRecordToKeepOption&&!this.spatialJoin&&"RECORD"===this._joinOptionSelect.get("value")&&(t.recordsToMatch=o.toJson(this._getTopFilter()))),t.joinType=this._keepTargetFeaturesCheck.get("checked")?"left":"inner",this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=o.toJson({extent:this.map.extent._normalize(!0)})),t.OutputName=o.toJson({serviceProperties:{name:this._outputName.get("value")}}),!this.showGeoAnalyticsParams&&this._checkCreateView.get("checked")&&(t.outputType=H.FLAYERVIEW),this._updateJobFilterAndSelection(t)},_getEqualParamValue:function(e){return this.showGeoAnalyticsParams&&e===W.FieldTypes.String?"equalIgnoreCaseTrimWhitespace":"equal"},_handleSaveBtnClick:function(){var e,t={};if(this._summaryWidget.updateRequiredAttributes(),this._form.validate())if("_NOVALUE_"!==this._joinLayerSelect.get("value"))if("_NOVALUE_"!==this._joinOperation.get("value"))if(this.attributeJoin||this.temporalJoin||this.spatialJoin){if(this._handleCloseMsg(),this._saveBtn.set("disabled",!0),e=this._buildJobParams(),t.jobParams=e,t.itemParams={description:this.i18n.itemDescription,tags:this.i18n.itemTags,snippet:this.i18n.itemSnippet},this.showSelectFolder&&(t.itemParams.folder=this.get("folderId")),this.showGeoAnalyticsParams){if(!E.checkPCSforAnalysis({widget:this,jobParams:e}))return;t.isSpatioTemporalDataStore=!0}this.resultParameter=this.showGeoAnalyticsParams?"output":"outputLayer",this.execute(t)}else this._showMessages(this.i18n.joinTypesErrorMsg);else this._showMessages(this.i18n.joinOpErrorMsg);else this._showMessages(this.i18n.joinLayerErrorMsg)},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setTargetLayerAttr:function(e){this._set("targetLayer",e||null)},_setTargetLayersAttr:function(e){this._set("targetLayers",e||[])},_setJoinLayerAttr:function(e){this._set("joinLayer",e||null)},_setShowSpatialJoinAttr:function(e){this._set("showSpatialJoin",e)},_setShowAttributeJoinAttr:function(e){this._set("showAttributeJoin",e)},_setShowTemporalJoinAttr:function(e){this._set("showTemporalJoin",e)},_setShowJoinConditionAttr:function(e){this._set("showJoinCondition",e)},_setJoinLayersAttr:function(e){this._set("joinLayers",e||[])},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&E.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.targetLayers:this.joinLayers,layersSelect:this._isAnalysisSelect?this._targetLayerSelect:this._joinLayerSelect,posIncrement:(this._isAnalysisSelect,0),browseDialog:e.dialog||this._browsedlg,widget:this},t)},_save:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_loadConnections:function(){this.on("start",a.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",a.hitch(this,"_onClose",!1)),this._spatialJoinHandle=h.pausable(this._spatialJoinCtr,"click",a.hitch(this,this._handleSpatialCheckChange)),this._temporalJoinHandle=h.pausable(this._temporalJoinCtr,"click",a.hitch(this,this._handleTemporalCheckChange)),this._attributeJoinHandle=h.pausable(this._attributeJoinCtr,"click",a.hitch(this,this._handleAttributeCheckChange)),this.own(this._spatialJoinHandle,this._temporalJoinHandle,this._attributeJoinHandle)},_connect:function(e,t,i){this._pbConnects.push(r.connect(e,t,i))},_updateAnalysisLayerUI:function(e){if(this._expBtn.set("disabled",!this.targetLayer),this._bufFieldOutput.set("disabled",!this.targetLayer),this.targetLayer){var t,s,r,o=this._joinLayerSelect.getOptions();e&&(this.outputLayerName=c.substitute(this.i18n.outputLayerName,{targetLayerName:this.targetLayer.name}),this._outputName.set("value",this.outputLayerName)),this._isAnalysisSelect&&(n.some(o,(function(e,t){return e.label===this.targetLayer.title}),this)||(s=this.showBrowseLayers&&this.showReadyToUseLayers?3:!this.showBrowseLayers&&this.showReadyToUseLayers?2:this.showBrowseLayers&&!this.showReadyToUseLayers?2:0,t=o.splice(o.length-s,s),n.some(this.joinLayers,(function(e){return e&&e.analysisReady&&this.targetLayer.analysisReady&&e.itemId===this.targetLayer.itemId}),this)||(this.joinLayers.push(this.targetLayer),1===this.joinLayers.length&&this._handleJoinLayerChange(0)),t.unshift({value:this.joinLayers.length-1,label:this.targetLayer.title}),this._joinLayerSelect.addOption(t),1===this.joinLayers.length&&this._joinLayerSelect.set("value",0)));var l,h,d={};if(h=n.map(this.targetLayer.fields,(function(e){var t=a.clone(e);return a.mixin(t,{name:'target["'+e.name+'"]',alias:'target["'+e.alias+'"]'}),t}),this),l=n.map(this.joinLayer.fields,(function(e){var t=a.clone(e);return a.mixin(t,{name:'join["'+e.name+'"]',alias:'join["'+e.alias+'"]'}),t}),this),d.fields=[].concat(l,h),this.showJoinCondition){var p=[];if(p.push(this.makeArcadeProfile(this.joinLayer,"$join")),p.push(this.makeArcadeProfile(this.targetLayer,"$target")),this._calcField)this._calcField&&this._calcField.layer!==this.inputLayer&&(this._bufFieldOutput.set("value",""),this._calcField.reset(),this._calcField.set("arcadeProfile",p),this._calcField.set("layer",d));else{var y=E.getExprFunctions();y=n.filter(y,(function(e){return e&&e.name&&-1===e.name.indexOf("as_")})),this._calcField=new U({expressionMode:U.MODE_ARCADE,arcadeEditor:this.arcadeEditor,map:this.map,layer:d,field:this.i18n.bufField,baseClass:"esriBufFieldExp",helperMethods:y,showHelp:!0,helpUrl:E.getHelpUrl({widget:this,topic:"BufferExpression"}),css:{base:"esriBufFieldExp",addButton:"btn calcite primary",closeButton:"btn calcite cancel"},helperType:"numeric",showHeader:!1,arcadeProfile:p,calculateLabel:this.i18n.add,expression:this._bufFieldOutput.get("value")},this._expressionCtr),this._calcField.startup(),this._calcField.expressionMode===U.MODE_SQL?(u.set(this._calcField._validateBtn.domNode,"display","none"),this._calcField._handleHelperTypeChange("value",null,{functionType:"NumType"}),this._aspectHandle=i.around(this._calcField,"_handleAddButtonClick",a.hitch(this,(function(e){return a.hitch(this,(function(e,t){var i=this._calcField.get("expression")[0];this._bufFieldOutput.set("value",i.sqlExpression),this._exprDialog.hide()}))})))):this._calcField.expressionMode===U.MODE_ARCADE&&this._calcField.on("expression-add",a.hitch(this,(function(e){this._bufFieldOutput.set("value",e.expression)}))),this._calcField.on("close",a.hitch(this,(function(){this._exprDialog.hide()})))}}}P.isDefined(this.joinLayer)&&this._summaryWidget.set("layer",this.joinLayer),e?(this.spatialJoin=!1,this.attributeJoin=!1,this.temporalJoin=!1,this._summaryWidget.hide(),this._removeAttrJoinRows(),_.contains(this._spatialJoin,"selected")&&(_.remove(this._spatialJoin,"selected"),_.add(this._spatialDistanceRow,"hide"),_.add(this._spatialRelationshipRow,"hide"),this._spatialRelationshipSelect.reset(),this._spatialDistanceInput.set("required",!1)),_.contains(this._temporalJoin,"selected")&&(_.remove(this._temporalJoin,"selected"),_.add(this._temporalRelationshipRow,"hide"),_.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1)),_.contains(this._attributeJoin,"selected")&&(_.remove(this._attributeJoin,"selected"),_.add(this._attributeRelationshipRow,"hide")),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")?("JoinOneToOne"!==this._joinOperation.get("value")||this.showRecordToKeepOption&&!this.showGeoAnalyticsParams&&"STATS"!==this._joinOptionSelect.get("value")||this._summaryWidget.show(),_.remove(this._spatialJoin,"disabled"),_.remove(this._attributeJoin,"disabled"),_.remove(this._spatialJoinLabel,"esriAnalysisTextDisabled"),_.remove(this._attrJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.resume()):(_.add(this._spatialJoin,"disabled"),_.add(this._attributeJoin,"disabled"),_.add(this._temporalJoin,"disabled"),_.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),_.add(this._attrJoinLabel,"esriAnalysisTextDisabled"),_.add(this._temporalJoinLabel,"esriAnalysisTextDisabled"),this._attributeJoinHandle.pause(),this._spatialJoinHandle.pause(),this._temporalJoinHandle.pause())):(this.spatialRelationship&&(this.spatialJoin=!0,this._spatialRelationshipSelect.set("value",this.spatialRelationship),this._handleSpatialCheckChange(this.spatialJoin,!e),this.spatialDistance&&this._spatialDistanceInput.set("value",this.spatialDistance)),this.attributeRelationship&&(this.attributeJoin=!0,this._handleAttributeCheckChange(this.attributeJoin,!e),this.attributeRelationship&&this.targetLayer&&this.joinLayer&&(this._isAttrAdded=!1,this._createAttrJoinRow(this.attributeRelationship),this.attributeRelationship&&!this.attributeRelationship.length&&(this.attributeRelationship=[this.attributeRelationship]),n.forEach(this.attributeRelationship,(function(t){var i=n.map(this.targetLayer.fields,(function(e){return e.name})),s=n.indexOf(i,t.targetField);this._currentTargetSelect.set("value",s+1+""),a.hitch(this._currentTargetSelect,this._handleAttrTargetChange,this._currentTargetSelect.get("value"),!e,t)()}),this),this._isAttrAdded=!0)),this.temporalRelationship&&(this.temporalJoin=!0,this._handleTemporalCheckChange(this.temporalJoin,!e),this._temporalRelationshipSelect.set("value",this.temporalRelationship)),this.summaryFields&&this._summaryWidget.set("summaryFields",this.summaryFields)),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&(r=!(E.isTimeEnabled(this.joinLayer)&&E.isTimeEnabled(this.targetLayer)),_.toggle(this._temporalJoin,"disabled",r),_.toggle(this._temporalJoinLabel,"esriAnalysisTextDisabled",r),this._attributeJoinHandle.resume(),r?this._temporalJoinHandle.pause():this._temporalJoinHandle.resume()),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&(this.targetLayer.type&&"table"===this.targetLayer.type.toLowerCase()||this.joinLayer.type&&"table"===this.joinLayer.type.toLowerCase())&&(_.add(this._spatialJoin,"disabled"),_.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.pause()),this._updateCreateViewUI()},_updateCreateViewUI:function(){this.getUserProfile().then(a.hitch(this,(function(e){this.spatialRelationship=this._spatialRelationshipSelect.get("value"),this._enableCreateViewUI(this._canCreateView(e))})))},_setAttributeRelationshipAttr:function(e){var t,i=[];e&&"string"==typeof e&&(t=e.split(" and "),n.forEach(t,(function(e){var t=e.split(" = ");i.push({targetField:-1!==t[0].indexOf('["')?t[0].substring(t[0].indexOf('["')+2,t[0].indexOf('"]')):t[0],operator:"equal",joinField:-1!==t[1].indexOf('["')?t[1].substring(t[1].indexOf('["')+2,t[1].indexOf('"]')):t[1]})})),e=i),n.forEach(e,(function(t,i){"string"==typeof t&&-1!==t.indexOf("{")&&(e[i]=E.tryParseJSON(t))}),this),this.attributeRelationship=e},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},validateServiceName:function(e){return E.validateServiceName(e,{textInput:this._outputName})},_showMessages:function(e){p.set(this._bodyNode,"innerHTML",e),f.fadeIn({node:this._errorMessagePane,easing:b.quadIn,onEnd:a.hitch(this,(function(){u.set(this._errorMessagePane,{display:""})}))}).play()},_handleCloseMsg:function(e){e&&e.preventDefault(),f.fadeOut({node:this._errorMessagePane,easing:b.quadOut,onEnd:a.hitch(this,(function(){u.set(this._errorMessagePane,{display:"none"})}))}).play()},makeArcadeProfile:function(e,t){if(e){var i,s,r,o=e.fields,l={layer:e,popupInfo:e.infoTemplate?e.infoTemplate.toJson():null};return i={type:"Feature",value:{attributes:null,geometry:null,layer:{fields:n.map(o,(function(e){return e.domain&&n.indexOf(["range","codedValue"],e.domain.type)>-1&&((e=a.clone(e)).domain=e.domain.toJson?e.domain.toJson():e.domain),e})),objectIdField:e.objectIdField,typeIdField:e.typeIdField,types:e.types?n.map(e.types,(function(e){return e.toJson?e.toJson():e})):null,templates:e.templates}},id:P.isDefined(t)?t:"$feature"},l._queryResponse&&l._queryResponse.features&&l._queryResponse.features.length?(i.value.attributes=a.clone(l._queryResponse.features[0].attributes),i.value.geometry=l._queryResponse.features[0].geometry):l._queryResponse&&l._queryResponse[e.url]&&l._queryResponse[e.url].features&&l._queryResponse[e.url].features.length?(i.value.attributes=a.clone(l._queryResponse[e.url].features[0].attributes),i.value.geometry=l._queryResponse[e.url].features[0].geometry):e.graphics&&e.graphics.length&&e.geometryType?(i.value.attributes=a.clone(e.graphics[0].attributes),i.value.geometry=e.graphics[0].geometry.toJson()):(s={},n.forEach(o,(function(e){n.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGlobalID"],e.type)>-1&&!1===e.nullable?e.defaultValue?s[e.name]=e.defaultValue:n.indexOf(["esriFieldTypeString"],e.type)>-1?s[e.name]="":s[e.name]=0:s[e.name]=null})),i.value.attributes=s,r=this.map.extent,"esriGeometryPolygon"==e.geometryType||e.getCustomRasterFields?(i.value.geometry=new V(new q(this.map.spatialReference.toJson())),i.value.geometry.addRing([[r.xmin,r.ymin],[r.xmax,r.ymin],[r.xmax,r.ymax],[r.xmin,r.ymax],[r.xmin,r.ymin]])):"esriGeometryPoint"==e.geometryType||e.geometryType==W.GeometryTypes.MultiPoint?i.value.geometry=new M(r.getCenter().toJson()):"esriGeometryPolyline"==e.geometryType&&(i.value.geometry=new B(new q(this.map.spatialReference.toJson())),i.value.geometry.addPath([[r.xmin,r.ymin],[r.xmax,r.ymax]]))),i}}});return l("extend-esri")&&a.setObject("dijit.analysis.JoinFeatures",Q,I),Q}));