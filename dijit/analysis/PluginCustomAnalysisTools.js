// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/dom-class","dojo/dom-construct","dojo/query","dojo/Deferred","dojo/store/Memory","dojo/Evented","dojo/has","../../request","../../kernel","dgrid/OnDemandList","dgrid/Selection","dojo/i18n!../../nls/jsapi","./utils"],(function(t,e,i,s,n,o,a,r,l,c,p,d,h,m,u,f){var g=t([l],{infoPanelTemplateRFT:"<div><div class=\"template-info-showing\"><div><img width='16px' height='16px' alt='' src='${item.iconUrl}'></div><h4>${item.title}</h4><div class='analysis-tool-item-type'>${item.type}</div><div class=\"rft-info-panel-description\"></div><div></div><div class=\"panel-actions\">"+'<button class="btn blue btn-main" id="edit-raster-function-template">${i18n.common.editTemplate}</button><button class="btn blue btn-main" id="select-raster-function-template">${i18n.common.selectTemplate}</button><button class="btn btn-cancel" id="close-panel">${i18n.common.close}</button></div><div>',infoPanelTemplateWebTool:'<div class="web-tool-info-template"><div class="template-info-showing"><div><img width=\'16px\' height=\'16px\' alt=\'\' src=\'${item.iconUrl}\'></div><h4>${item.title}</h4><div class=\'analysis-tool-item-type\'>${item.type}</div><div class="web-tool-info-panel-description"><p style="height:10em;">${item.snippet}</p></div><div class="custom-web-tools-container"></div><div class="panel-actions"><button class="btn blue btn-main disabled" id="select-custom-web-tool">${i18n.common.add}</button><button class="btn btn-cancel" id="close-panel">${i18n.common.close}</button></div><div>',galleryTemplate:"<div class='listServiceTitle'><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%'><td nowrap='nowrap'><div style='overflow:hidden;'><a style=\"height:20px; font-size: medium;\">${item.title}</a></div></td></tr></table><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%' class='bottomRowTable'><td width='20'>  <span class='esriAlignLeading'>${item:formatThumbnail}</span></td><td nowrap='nowrap'>  <span class='esriAlignLeading' style='color:#656565; margin-left: .3em;'>${item.owner}</span></td></tr></table></div>",groups:{},constructor:function(t){e.mixin(this,t),this.i18n=e.mixin({},u.browseLayersDlg),e.mixin(this.i18n,u.browseItems),e.mixin(this.i18n,u.common),this.parent&&this.parent._portal&&this.parent._portal.loaded?this._onPortalLoad():this.parent&&this.parent.on("portal-load",this._onPortalLoad.bind(this))},getSelectedTool:function(){if(this._taskList){var t=this._taskList.selection;for(var e in t)if(t.hasOwnProperty(e))break;return e}},_onPortalLoad:function(){this._fetchGroupForRFT(this.parent._portal).then(function(){this._setFilters(),this._setFilterStrings(),this._attachEventHandlers(),this.parent._createFilters()}.bind(this))},_attachEventHandlers:function(){this.parent&&this.parent.own(this.parent.on("grid-row-click",e.hitch(this,this._handleGridRowClick)),this.parent.on("show-info-panel",e.hitch(this,this._handleShowInfoPanel)))},_handleGridRowClick:function(){var t=this.parent&&this.parent.get("selection");t&&(t.type&&"raster function template"===t.type.toLowerCase()?this.parent.infoPanelTemplate=this.infoPanelTemplateRFT:this.parent.infoPanelTemplate=this.infoPanelTemplateWebTool)},_handleShowInfoPanel:function(){var t=this.parent&&this.parent.get("selection");if(t){var e=t.type&&t.type.toLowerCase();"geoprocessing service"===e?this._populateCustomWebTools(t):"raster function template"===e&&this._populateRFTDesc(t)}},_populateRFTDesc:function(t){var e=o(".rft-info-panel-description",this.parent.domNode)[0];e&&t&&(t.description?e.innerHTML=t.description:e.innerHTML=this.i18n.genericRasterFxTemplateDesc1+"<br><br>"+this.i18n.genericRasterFxTemplateDesc2)},_populateCustomWebTools:function(i){var a=o(".custom-web-tools-container",this.parent.domNode)[0];a&&i&&this._getGeoprocessingServiceTasks(i).then(e.hitch(this,(function(i){var l=t([h,m]);this._taskList=new l({store:new r({data:i}),selectionMode:"single",class:"esriAnalysisLayersGrid quiet-scroll",renderRow:function(t){return n.toDom("<div>"+t.id+"</div>")}},a),this._taskList.startup(),this._taskList.on("dgrid-select,dgrid-deselect",e.hitch(this,(function(t){o(".panel-actions .btn-main",this.parent.infoPanel).forEach((function(t){s.toggle(t,"disabled",!this._taskList.selection)}),this)})))})))},_getGeoprocessingServiceTasks:function(t){return p({url:t.url,handleAs:"json",content:{f:"json"},callbackParamName:"callback",load:function(t){return i.map(t.tasks,(function(t){return{id:t}}))}})},_setFilters:function(){var t=this.self&&this.self.user?this.self.user:null;this.filters={all:{}},t&&(t.orgId&&(this.filters.myorganization={orgids:[t.orgId]}),this.filters.mycontent={owners:[t.username]},t.favGroupId&&(this.filters.myfavorites={owners:[t.username],groups:[t.favGroupId]})),this._systemRFTsGroup&&(this.filters.system={groups:[this._systemRFTsGroup.id]})},_setFilterStrings:function(){this.filterStrings={all:{title:this.self&&this.self.isPortal?this.i18n.items.portalOrg:this.i18n.items.onlineLabel},myorganization:{title:this.i18n.items.organizationLabel},mycontent:{title:this.i18n.items.contentLabel},myfavorites:{title:this.i18n.items.favoritesLabel},system:{title:this.i18n.items.systemLabel}}},_fetchGroupForRFT:function(t){var e=new a;return this._systemRFTsGroup&&e.resolve(this._systemRFTsGroup),f.fetchGroupForRFT(t).then(function(t){this._systemRFTsGroup=t,e.resolve(t)}.bind(this)),e},fetchData:function(){return this._portal=this.parent._portal,this._user=this._portal.getPortalUser(),this._fetchItems()},_fetchItems:function(t){var e=this.parent&&this.parent.canPerformRasterAnalysis,i=this.parent&&this.parent.canPerformSpatialAnalysis,s="";e&&i?s='((typekeywords:"Web Tool" AND type: "Geoprocessing Service") OR type:"Raster Function Template")  -type:"Attachment" -tags:"mature support"':i?s='(typekeywords:"Web Tool" AND type: "Geoprocessing Service")  -type:"Attachment" -tags:"mature support"':e&&(s='type:"Raster Function Template"  -type:"Attachment" -tags:"mature support"'),this.parent._fetchItems({query:s})}});return e.mixin(g,{add:function(t,e){if(!t.plugIn){var i=e||{};i.parent=t,i.self=t.self,i.type=t.type,t.plugIn=new g(i)}},remove:function(t){t.plugIn&&(t.plugIn.destroy(),delete t.plugIn)}}),c("extend-esri")&&e.setObject("dijit.analysis.PluginCustomAnalysisTools",g,d),g}));