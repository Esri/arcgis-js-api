// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.38/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/dom-class","dojo/dom-style","dojo/string","dojo/json","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","../../kernel","../../lang","./utils","./ItemTypes","./RasterAnalysisMixin","./AnalysisRegistry","dojo/i18n!../../nls/jsapi","dojo/text!./templates/CalculateDensityRaster.html"],(function(e,t,i,s,n,a,r,l,c,o,u,h,y,d,p,_,S,g,m,U,L,f,b,v){var F=t([h,y,d,p,_,L],{declaredClass:"esri.dijit.analysis.CalculateDensityRaster",templateString:v,widgetsInTemplate:!0,browseType:[U.IS,U.FS],checkGeometries:[f.GeometryTypes.Point,f.GeometryTypes.Line,f.GeometryTypes.MultiPoint],tags:["point","line"],inputLayer:null,countField:null,searchDistance:null,searchDistUnit:null,inBarriers:null,cellSize:null,areaUnit:null,cellUnit:null,_NOVALUE_:"NOVALUE",toolName:"CalculateDensityRaster",helpFileName:"CalculateDensityRaster",toolNlsName:b.calculateDensityRasterTool,rasterGPToolName:"CalculateDensity",resultParameter:"outputRaster",constructor:function(e,t){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode),e.rerun&&(e.inputLayer=e.inputPointOrLineFeatures,e.barrierLayer=e.inBarriers,e.areaUnit=e.outputAreaUnits,e.searchDistUnit=e.searchDistance&&e.searchDistance.units,e.searchDistance=e.searchDistance&&e.searchDistance.distance,e.cellSize=e.outputCellSize&&e.outputCellSize.distance,e.cellUnit=e.outputCellSize&&e.outputCellSize.units)},_getJobParameters:function(){var e,t=a.toJson(m.constructAnalysisInputLyrObj(this.get("inputLayer"))),i=this.get("countField"),s=this.get("searchDistance"),n={distance:s,units:this.get("searchUnit")},r=this.get("areaUnit"),l=this.get("cellSize"),c={distance:l,units:this.get("cellSizeUnit")};return this.get("inBarriers")&&(e=a.toJson(m.constructAnalysisInputLyrObj(this.get("inBarriers")))),{inputPointOrLineFeatures:t,countField:i,searchDistance:s?u.stringify(n):null,outputAreaUnits:r,outputCellSize:l?u.stringify(c):null,inBarriers:e}},_setDefaultInputs:function(){this.inBarriers&&this.inBarrierLayers&&!m.isLayerInLayers(this.inBarriers,this.inBarrierLayers)&&this.inBarrierLayers.push(this.inBarriers),this._addInBarrierLayerOptions(),this.set("countFields",this.countField),this._searchDistanceUnitsSelect.addOption([{value:"Miles",label:this.i18n.miles},{value:"Feet",label:this.i18n.feet},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}]),this._areaUnitsSelect.addOption([{value:"SquareMiles",label:this.i18n.sqMiles},{value:"SquareFeet",label:this.i18n.sqFeet},{type:"separator"},{value:"SquareMeters",label:this.i18n.sqMeters},{value:"SquareKilometers",label:this.i18n.sqKm}]),this._cellSizeUnitsSelect.addOption([{value:"Miles",label:this.i18n.miles},{value:"Feet",label:this.i18n.feet},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}]),this.countField&&this._countFieldSelect.set("value",this.countField),this.searchDistance&&this._searchDistanceInput.set("value",this.searchDistance),this.searchDistUnit&&this._searchDistanceUnitsSelect.set("value",this.searchDistUnit),this.cellSize&&this._outputCellSizeInput.set("value",this.cellSize),this.areaUnit&&this._areaUnitsSelect.set("value",this.areaUnit),this.cellUnit&&this._cellSizeUnitsSelect.set("value",this.cellUnit)},_handleBarrierLayerChange:function(e){"browselayers"===e||"browse"===e?(this._isAnalysisSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",[U.FS]),this._createBrowseItems({browseValue:e,disableLAAL:!0,disabledSubResources:[this.inBarriers]},{geometryTypes:[f.GeometryTypes.Line,f.GeometryTypes.Polygon],tags:["polygon","line"]},this._barrierSelect)):e>=0&&this.set("inBarriers",this.inBarrierLayers[e])},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&m.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.inBarrierLayers,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._barrierSelect,browseDialog:this._browseLyrsdlg||this._browsedlg,widget:this},t).always(i.hitch(this,(function(){this._isAnalysisSelect?this._handleAnalysisLayerChange(this._analysisSelect.get("value")):this._handleBarrierLayerChange(this._barrierSelect.get("value"))})))},_resetUI:function(){this.set("countFields",this.countField)},_addInBarrierLayerOptions:function(){var e=[{label:" ",value:""}];this._barrierSelect.removeOption(this._barrierSelect.getOptions());var t=!1;n.forEach(this.inBarrierLayers,i.hitch(this,(function(i,s){var n=this._isSelected(i,this.inBarriers);t=t||n,e.push({label:i.name,value:s.toString(),selected:n})}))),this._barrierSelect.addOption(e),this.addBrowseOption(),t||this._handleBarrierLayerChange(0)},_isSelected:function(e,t){return t&&e&&t.url===e.url},addBrowseOption:function(){m.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._barrierSelect}])},_setInputLayersAttr:function(e){this.inputLayers=n.filter(e,(function(e){return e.geometryType===f.GeometryTypes.Point||e.geometryType===f.GeometryTypes.Polygon||e.geometryType===f.GeometryTypes.Line||e.geometryType===f.GeometryTypes.MultiPoint||this.isImageServiceLayer(e)}),this),this.set("inBarrierLayers",e)},_getInputLayersAttr:function(e){return this.inputLayers},_setInBarrierLayersAttr:function(e){this.inBarrierLayers=n.filter(e,(function(e){return e.geometryType===f.GeometryTypes.Polygon||e.geometryType===f.GeometryTypes.Line}),this)},_getInBarrierLayersAttr:function(e){return this.inBarrierLayers},_setSearchDistanceAttr:function(e){this.searchDistance=e},_getSearchDistanceAttr:function(){return this._searchDistanceInput&&this._searchDistanceInput.get("value")&&(this.searchDistance=this._searchDistanceInput.get("value")),this.searchDistance},_setCountFieldsAttr:function(e){if(this.inputLayer){var t=this.inputLayer.fields;this._countFieldSelect&&this._countFieldSelect.removeOption(this._countFieldSelect.getOptions()),this._countFieldSelect.addOption({value:this._NOVALUE_,label:this.i18n.chooseCountField}),n.forEach(t,(function(e){-1!==n.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],e.type)&&e.name!==this.inputLayer.objectIdField&&this._countFieldSelect.addOption({value:e.name,label:g.isDefined(e.alias)&&""!==e.alias?e.alias:e.name})}),this),e&&this._countFieldSelect.set("value",e)}},_setCountFieldAttr:function(e){this.countField=e},_getCountFieldAttr:function(){return this._countFieldSelect&&this._countFieldSelect.get("value")&&(this.countField=this._countFieldSelect.get("value")!==this._NOVALUE_?this._countFieldSelect.get("value"):null),this.countField},_getCellSizeAttr:function(){return this._outputCellSizeInput&&this._outputCellSizeInput.get("value")&&(this.cellSize=this._outputCellSizeInput.get("value")),this.cellSize},_setCellSizeAttr:function(e){this.cellSize=e},_getAreaUnitAttr:function(){return this._areaUnitsSelect&&this._areaUnitsSelect.get("value")&&(this.areaUnit=this._areaUnitsSelect.get("value")),this.areaUnit},_setAreaUnitAttr:function(e){this.areaUnit=e},_getCellSizeUnitAttr:function(){return this._cellSizeUnitsSelect&&this._cellSizeUnitsSelect.get("value")&&(this.cellUnit=this._cellSizeUnitsSelect.get("value")),this.cellUnit},_setCellSizeUnitAttr:function(e){this.cellUnit=e},_getSearchUnitAttr:function(){return this._searchDistanceUnitsSelect&&this._searchDistanceUnitsSelect.get("value")&&(this.searchUnit=this._searchDistanceUnitsSelect.get("value")),this.searchUnit},_setSearchSizeUnitAttr:function(e){this.searchUnit=e},_setMapAttr:function(e){this.map=e},_getMapAttr:function(){return this.map}});return s("extend-esri")&&i.setObject("dijit.analysis.CalculateDensityRaster",F,S),F}));