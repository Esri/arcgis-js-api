define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/Color","dojo/_base/connect","dojo/_base/json","dojo/_base/fx","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/fx/easing","dojo/dom-class","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ToggleButton","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/form/NumberSpinner","dijit/Dialog","dojox/form/CheckedMultiSelect","../../kernel","../../lang","../../layers/FeatureLayer","./AnalysisBase","./_AnalysisOptions","./utils","./CreditEstimator","./ExpressionForm","../../geometry/Extent","../../geometry/ScreenPoint","../../symbols/CartographicLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleFillSymbol","../../tasks/query","../../renderers/jsonUtils","dojo/i18n!../../nls/jsapi","dojo/text!./templates/FindSimilarLocations.html"],function(e,t,s,i,n,a,r,o,l,h,u,c,d,y,p,m,_,L,f,g,S,b,x,F,I,C,A,v,w,j,O,R,M,E,k,T,N,D,P,B,Q,q,H,U,G,J,Y,z,V,W,K,X,Z){var $=t([L,f,g,S,b,B,P],{declaredClass:"esri.dijit.analysis.FindSimilarLocations",templateString:Z,widgetsInTemplate:!0,i18n:null,returnProcessInfo:!0,toolName:"FindSimilarLocations",helpFileName:"FindSimilarLocations",resultParameter:"similarResultLayer",primaryActionButttonClass:"esriAnalysisSubmitButton",inputLayer:null,searchLayer:null,inputQuery:null,searchLayers:[],analysisFields:[],numberOfResults:0,enableInputSelection:!0,selectionLayer:null,_isAttrFlag:!1,constructor:function(e){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode),this._expression=null},destroy:function(){this.inherited(arguments),i.forEach(this._pbConnects,a.disconnect),delete this._pbConnects,delete this._mapClickHandle},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,X.findSimilarLocations),s.mixin(this.i18n,X.expressionGrid)},postCreate:function(){this.inherited(arguments),_.add(this._form.domNode,"esriSimpleForm"),c.set(this._attrSelect.selectNode,"width","80%"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e}),this.selectionLayer&&(this.selectionLayer.clearSelection(),this.map.removeLayer(this.selectionLayer),this.selectionLayer=null),this._mapClickHandle&&delete this._mapClickHandle},clear:function(){this.selectionLayer&&(this.selectionLayer.clearSelection(),this.map.removeLayer(this.selectionLayer),this.selectionLayer=null),this._mapClickHandle&&delete this._mapClickHandle},_handleSaveBtnClick:function(){if(this._form.validate()){this._saveBtn.set("disabled",!0);var e,t,s={},i={};s.inputLayer=r.toJson(Q.constructAnalysisInputLyrObj(this.inputLayer)),this.get("InputQuery")&&(s.inputQuery=this.inputQuery),s.searchLayer=r.toJson(Q.constructAnalysisInputLyrObj(this.get("searchLayer"))),s.analysisFields=this.get("analysisFields"),s.numberOfResults=this.get("numberOfResults"),this.returnFeatureCollection||(s.OutputName=r.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(s.context=r.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(e={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.extent=this.map.extent._normalize(!0)),s.context=r.toJson(e)),i.jobParams=s,i.itemParams={description:t,tags:u.substitute(this.i18n.itemTags,{analysisLayerName:this.inputLayer.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(i.itemParams.folder=this.get("folderId")),s.returnProcessInfo=this.returnProcessInfo,this.execute(i)}},_handleShowCreditsClick:function(e){e.preventDefault();var t,i={};this._form.validate()&&(i.inputLayer=r.toJson(Q.constructAnalysisInputLyrObj(this.inputLayer)),this.get("InputQuery")&&(i.inputQuery=this.inputQuery),i.searchLayer=r.toJson(Q.constructAnalysisInputLyrObj(this.get("searchLayer"))),i.analysisFields=this.get("analysisFields"),i.numberOfResults=this.get("numberOfResults"),this.returnFeatureCollection||(i.OutputName=r.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(i.context=r.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(t={outSR:this.map.spatialReference},this.showChooseExtent&&(t.extent=this.map.extent._normalize(!0)),i.context=r.toJson(t)),this.getCreditsEstimate(this.toolName,i).then(s.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()})))},_save:function(){},_buildUI:function(){var e=!0;this._loadConnections(),this.signInPromise.then(s.hitch(this,Q.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),this.get("showSelectAnalysisLayer")&&(!this.get("inputLayer")&&this.get("inputLayers")&&this.set("inputLayer",this.inputLayers[0]),Q.populateAnalysisLayers(this,"inputLayer","inputLayers")),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),e=!1),c.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(e){this.folderStore=e,Q.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),c.set(this._chooseExtentDiv,"display",this.showChooseExtent===!0?"inline-block":"none"),c.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this.searchLayers&&i.forEach(this.searchLayers,function(e,t){this._candidateSelect.addOption({value:t+1,label:e.name})},this),Q.addReadyToUseLayerOption(this,[this._analysisSelect,this._candidateSelect]),this._selectBtn.set("disabled",!this.enableInputSelection),this._queryBtn.set("disabled",!this.enableInputSelection),this.inputLayer&&this._updateAnalysisLayerUI(e),this._expressionForm.on("add-expression",s.hitch(this,this._handleExpressionFormAdd)),this._expressionForm.on("cancel-expression",s.hitch(this,this._handleExpressionFormCancel))},_updateAnalysisLayerUI:function(e){if(this.inputLayer){d.set(this._toolDescription,"innerHTML",u.substitute(this.i18n.toolDefine,{layername:this.inputLayer.name}));var t,s=this._candidateSelect.getOptions(),n=!1,a=!1;this._isAnalysisSelect&&(n=i.some(s,function(e){return e.label===this.inputLayer.title},this),n||(t=s.splice(s.length-2,2),a=i.some(this.searchLayers,function(e){return e&&e.analysisReady&&this.inputLayer.analysisReady&&e.itemId===this.inputLayer.itemId},this),a||this.searchLayers.push(this.inputLayer),t.unshift({value:this.searchLayers.length,label:this.inputLayer.title}),this._candidateSelect.addOption(t))),this.set("selectionLayer"),this.set("analysisFields"),e&&(this.outputLayerName=u.substitute(this.i18n.outputLayerName,{analysisLayerName:this.inputLayer.name})),this._outputLayerInput.set("value",this.outputLayerName),this._expressionForm.set("showFirstRow",!1),this._expressionForm.set("firstOperands",[this.inputLayer]),this._expressionForm.set("inputOperands",[this.inputLayer]),this._expressionForm.set("selectedFirstOperand",this.inputLayer),this._expressionForm.init()}},_handleAnalysisLayerChange:function(e){"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!0,this._browsedlg.show()):(this.inputLayer=this.inputLayers[e],this.selectionLayer&&(this.clear(),this.set("inputQuery",null),this._expression=null,d.set(this._filterLabel,"innerHTML","")),this._updateAnalysisLayerUI(!0))},_handleBrowseItemsSelect:function(e){e&&e.selection&&Q.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.searchLayers,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._candidateSelect,posIncrement:this._isAnalysisSelect?0:1,browseDialog:this._browsedlg,widget:this}).always(s.hitch(this,function(){this._isAnalysisSelect&&(this._handleAnalysisLayerChange(this._analysisSelect.get("value")),this._isAnalysisSelect=!1)}))},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1))},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setSearchLayersAttr:function(e){this.searchLayers=e},_getSearchLayersAttr:function(){return this.searchLayers},_setSearchLayerAttr:function(e){this.searchLayer=e},_getSearchLayerAttr:function(){var e=this._candidateSelect.get("value");return this._candidateSelect&&"search"!==e?this.searchLayer=this.searchLayers[this._candidateSelect.get("value")-1]:("search"===e||"browse"===e)&&(this.searchLayer=null),this.searchLayer},_setInputLayerAttr:function(e){this.inputLayer=e},_getInputLayerAttr:function(){return this.inputLayer},_setInputLayersAttr:function(e){this.inputLayers=e},_setEnableInputSelectionAttr:function(e){this.enableInputSelection=e},_getEnableInputSelectionAttr:function(){return this.enableInputSelection},_setAnalysisFieldsAttr:function(){var e,t;this.get("inputLayer")&&this.get("searchLayer")&&0!==this.inputLayer.fields.length&&0!==this.searchLayer.fields.length&&(t=this.inputLayer.fields,e=i.map(this.searchLayer.fields,function(e){return e.name}),t=i.filter(t,function(t){return-1===i.indexOf(e,t.name)||-1===i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],t.type)||t.name===this.inputLayer.objectIdField&&t.name===this.searchLayer.objectIdField?void 0:!0},this),t=i.map(t,function(e){return{value:e.name,label:N.isDefined(e.alias)&&""!==e.alias?e.alias:e.name}}),this._attrSelect&&(this._attrSelect.removeOption(this._attrSelect.get("options")),this._attrSelect.addOption(t)),this.analysisFields=t)},_getAnalysisFieldsAttr:function(){return this._attrSelect&&(this.analysisFields=this._attrSelect.get("value")),this.analysisFields},_setInputQueryAttr:function(e){this.inputQuery=e},_getInputQueryAttr:function(){return this.inputQuery},_setNumberOfResultsAttr:function(e){this.numberOfResults=e},_getNumberOfResultsAttr:function(){return this.numberOfResults},_getInputQueryObjAttr:function(){var e=null;return this.get("InputQuery")&&(e={},e.operator="",e.layer=0,e.where=this.inputQuery),this.inputQueryObj=e,this.inputQueryObj},_setSelectionLayerAttr:function(){this.get("inputLayer")&&(this.selectionLayer=new D(this.inputLayer.url&&!this.inputLayer._collection?this.inputLayer.url:this.inputLayer.toJson(),{outFields:["*"],mode:this.inputLayer.url&&!this.inputLayer._collection?D.MODE_SELECTION:D.MODE_SNAPSHOT}),this.selectionLayer.setRenderer(null),this.selectionLayer.on("selection-complete",s.hitch(this,this._handleInputLayerSelectionComplete)),this.selectionLayer.loaded?this._onSelectionLayerLoad(this.inputLayer,this.selectionLayer):this.selectionLayer.on("load",s.hitch(this,this._onSelectionLayerLoad,this.inputLayer,this.selectionLayer)))},_onSelectionLayerLoad:function(e,t){var i;e.renderer&&(t.setRenderer(K.fromJson(e.renderer.toJson())),N.isDefined(e.renderer.isMaxInclusive)&&(t.renderer.isMaxInclusive=e.renderer.isMaxInclusive)),t.setScaleRange(e.minScale,e.maxScale),this._connect(e,"onScaleRangeChange",s.hitch(this,function(e,t){e.setScaleRange(t.minScale,t.maxScale)},t,e)),this.map.addLayer(t),"esriGeometryPoint"===t.geometryType||"esriGeometryMultPoint"===t.geometryType?(i=new Y,i.setStyle(Y.STYLE_TARGET),i._setDim(16,16,0),i.setOutline(new J(z.STYLE_SOLID,new n([0,255,255]),2,J.CAP_ROUND,J.JOIN_ROUND)),i.setColor(new n([0,0,0,0])),t.setSelectionSymbol(i)):"esriGeometryPolyline"===t.geometryType?t.setSelectionSymbol(new z(z.STYLE_SOLID,new n([0,255,255]),2)):"esriGeometryPolygon"===t.geometryType&&t.setSelectionSymbol(new V(V.STYLE_NULL,new z(z.STYLE_SOLID,new n([0,255,255]),2),new n([0,0,0,0])))},validateServiceName:function(e){return Q.validateServiceName(e,{textInput:this._outputLayerInput})},_setPrimaryActionButttonClassAttr:function(e){this.primaryActionButttonClass=e},_getPrimaryActionButttonClassAttr:function(){return this.primaryActionButttonClass},_connect:function(e,t,s){this._pbConnects.push(a.connect(e,t,s))},validate:function(){this.get("searchLayer")&&this.get("inputLayer")&&this.get("inputLayer").id===this.get("searchLayer").id&&!this.get("inputQuery")?(this._showMessages(this.i18n.reqSelectionMsg),this.set("disableRunAnalysis",!0)):this.get("searchLayer")&&0===this._attrSelect.getOptions().length?(this._showMessages(this.i18n.noFieldMatchMsg),this.set("disableRunAnalysis",!0)):(this._handleCloseMsg(),this.set("disableRunAnalysis",!1))},_handleCandidateChange:function(e){"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!1,this._browsedlg.show()):"search"===e?(this._attrSelect&&this._attrSelect.removeOption(this._attrSelect.get("options")),this.analysisFields=[]):(this.set("analysisFields"),this.validate())},_handleQueryButtonClick:function(){this._expDialog.set("title",this.i18n.query),this._selectBtn.set("checked",!1),this._isAttrFlag=!0,this._expression?(this._expressionForm.set("action","edit"),this._expressionForm.set("expression",this._expression.expression)):this._expressionForm.set("action","add"),this._expDialog.show()},_handleExpressionFormAdd:function(e){if(this.selectionLayer&&this.selectionLayer.clearSelection(),"add"===e.action||"edit"===e.action){d.set(this._filterLabel,"innerHTML",u.trim(e.expression._attributeText)),this._expression=e;var t;t=new W,t.returnGeometry=!0,t.where=e.expression.where,this.selectionLayer.selectFeatures(t,D.SELECTION_ADD)}this._expDialog.hide(),this.set("inputQuery",e.expression.where),this.validate()},_handleExpressionFormCancel:function(){this._expDialog.hide()},_handleTopRankRadioChange:function(e){this._ranksInput.set("disabled",!e),e&&this.set("numberOfResults",this._ranksInput.get("value"))},_handleAllRankRadioChange:function(e){e&&this.set("numberOfResults",0)},_handleTopRankInputChange:function(e){this.set("numberOfResults",e)},_handleSelectionButtonClick:function(e){e&&!this._mapClickHandle?(this._mapClickHandle=this.map.on("click",s.hitch(this,this._handleMapClick)),this.emit("selecttool-activate",{}),this._isAttrFlag=!1):(this._mapClickHandle.remove(),this._mapClickHandle=null,this.emit("selecttool-deactivate",{}))},_handleMapClick:function(e){var t,n,a,r,o,l,h,u;!this._isAttrFlag&&this._expression&&this.selectionLayer.clearSelection(),n=6,h=this.inputLayer.renderer,h&&"esri.renderer.SimpleRenderer"===h.declaredClass?(u=h.symbol,u.xoffset&&(n=Math.max(n,Math.abs(u.xoffset))),u.yoffset&&(n=Math.max(n,Math.abs(u.yoffset)))):!h||"esri.renderer.UniqueValueRenderer"!==h.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==h.declaredClass||i.forEach(h.infos,function(e){u=e.symbol,u.xoffset&&(n=Math.max(n,Math.abs(u.xoffset))),u.yoffset&&(n=Math.max(n,Math.abs(u.yoffset)))}),t=e.screenPoint,a=this.map.toMap(new G(t.x-n,t.y+n)),r=this.map.toMap(new G(t.x+n,t.y-n)),o=new U(a.x,a.y,r.x,r.y,this.map.spatialReference),l=new W,l.returnGeometry=!0,l.geometry=o,l.where=this.inputLayer.getDefinitionExpression(),this.inputLayer.queryFeatures(l).then(s.hitch(this,function(e){if(e){var t,s,n,a;a=[],t=[],this.selectionLayer.getSelectedFeatures().length>0&&(n=i.map(this.selectionLayer.getSelectedFeatures(),function(e){return e.attributes[this.selectionLayer.objectIdField]},this)),i.forEach(e.features,function(e){n?n&&-1===i.indexOf(n,e.attributes[this.selectionLayer.objectIdField])?t.push(e.attributes[this.selectionLayer.objectIdField]):a.push(e.attributes[this.selectionLayer.objectIdField]):t.push(e.attributes[this.selectionLayer.objectIdField])},this),t.length>0&&(s=new W,s.returnGeometry=!0,s.objectIds=t,this.selectionLayer.selectFeatures(s,D.SELECTION_ADD)),a.length>0&&(s=new W,s.returnGeometry=!0,s.objectIds=a,this.selectionLayer.selectFeatures(s,D.SELECTION_SUBTRACT))}}))},_showMessages:function(e){d.set(this._bodyNode,"innerHTML",e),o.fadeIn({node:this._errorMessagePane,easing:m.quadIn,onEnd:s.hitch(this,function(){c.set(this._errorMessagePane,{display:""})})}).play()},_handleCloseMsg:function(e){e&&e.preventDefault(),o.fadeOut({node:this._errorMessagePane,easing:m.quadOut,onEnd:s.hitch(this,function(){c.set(this._errorMessagePane,{display:"none"})})}).play()},_handleInputLayerSelectionComplete:function(){var e,t,s=this.selectionLayer.getSelectedFeatures();!this._isAttrFlag&&s.length>0&&(t="",e=i.map(s,function(e){return t+=this.selectionLayer.objectIdField+" = "+e.attributes[this.selectionLayer.objectIdField]+" OR ",e.attributes[this.selectionLayer.objectIdField]},this),t=t.substring(0,t.lastIndexOf(" OR ")),d.set(this._filterLabel,"innerHTML",u.substitute(this.i18n.selectedFeaturesLabel,{total:s.length})),this.set("inputQuery",t),this._expression=null,this.validate()),this._isAttrFlag||0!==s.length||(d.set(this._filterLabel,"innerHTML",""),this.set("inputQuery",null),this._expression=null,this.validate())}});return l("extend-esri")&&s.setObject("dijit.analysis.FindSimilarLocations",$,T),$});