// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.38/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/has","dojo/dom-class","dojo/dom-style","dojo/string","dojo/dom-construct","dojo/query","dojo/dom-attr","dojo/store/Memory","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/CheckBox","dijit/form/Select","dijit/form/ComboBox","../../kernel","../../lang","./RasterAnalysisMixin","./utils","./AnalysisRegistry","./ItemTypes","../RasterFunctionEditor/utils","dojo/i18n!../../nls/jsapi","dojo/i18n!./nls/Sample","dojo/text!./templates/Sample.html"],(function(e,t,i,s,a,n,l,r,o,h,u,d,c,_,y,f,m,p,v,g,L,b,D,F,V,O,T,A,S,I,R,E,w){var N=e([y,f,m,p,v,O],{declaredClass:"esri.dijit.analysis.Sample",templateString:w,widgetsInTemplate:!0,inputLayer:null,locationLayer:null,uniqueIdField:null,acquisitionDefinition:null,bufferDistance:null,statisticsType:"MEAN",percentileValue:null,resamplingType:"NEAREST",layout:"ROW_WISE",generateFeatureClass:!1,outputTableName:null,_emptyValue:"NONE",toolName:"Sample",helpFileName:"Sample",toolNlsName:R.sampleTool,rasterGPToolName:"Sample",resultParameter:"outSample",analysisType:"feature",outputName:"outputName",browseType:[S.IS],constructor:function(e,t){this._pbConnects=[],this._rasterRows=[],e.containerNode&&(this.container=e.containerNode),e.rerun&&(this.locationLayer=e.inLocationData,this.inRasters=e.inRasters)},postMixInProperties:function(){this.inherited(arguments),i.mixin(this.i18n,E)},_getJobParameters:function(){var e={inRasters:a.toJson(this.get("inRasters")),inLocationData:a.toJson(this.get("locationData")),uniqueIdField:this.get("uniqueIdField"),resamplingType:this.get("resamplingType"),generateFeatureClass:this.get("generateFeatureClass"),acquisitionDefinition:a.toJson(this.get("acquisitionDefinition")),statisticsType:this.get("statisticsType"),layout:this.get("layout"),bufferDistance:this.get("bufferDistance"),percentileValue:this.get("percentileValue")};return this._variableList&&this._variableList.length>0&&i.mixin(e,{processAsMultidimensional:!0}),e},_setDefaultInputs:function(){var e=0;if(this.locationLayers&&s.forEach(this.locationLayers,(function(t,i){this._layersSelect.addOption({value:i,label:t.name}),0!==i||this.rerun?!this.locationLayer||t.name!==this.locationLayer.name||t.url!==this.locationLayer.url&&0!==this.locationLayer.url.indexOf(t.url+"?token=")||(e=i):this.set("locationLayer",t)}),this),this.rerun&&this.inRasters&&this.inRasters.urls.length>0){var t=this.inRasters.urls.map((function(e){return e}));this._removeRasterRows(),t.shift(),t.forEach(i.hitch(this,(function(e){var t=e.split("?")[0],i=this.inputLayers.map((function(e){return e.url})).indexOf(t);i>-1&&this._createInRasterRow(i)}))),this._createInRasterRow()}this.locationLayer&&e>0&&this._layersSelect.set("value",e),this.statisticsType&&this._loadStatisticsType(!0),this.resamplingType&&this._loadResamplingType(!0),this.uniqueIdField&&this._uniqueIdField.set("value",this.uniqueIdField),this.percentileValue&&this._percentileValue.set("value",this.percentileValue),this.dimensionField&&this._dimensionField.set("value",this.dimensionField),this.dimensionFieldOrValue&&this._dimensionFieldOrValue.set("value",this.dimensionFieldOrValue),this.relativeValueOrDaysBefore&&this._relativeValueOrDaysBefore.set("value",this.relativeValueOrDaysBefore),this.relativeValueOrDaysAfter&&this._relativeValueOrDaysAfter.set("value",this.relativeValueOrDaysAfter),this.bufferDistance&&this._bufferDistance.set("value",this.bufferDistance),this.startFieldOrValue&&this._startFieldOrValue.set("value",this.startFieldOrValue),this.endFieldOrValue&&this._endFieldOrValue.set("value",this.endFieldOrValue),this._updateDimensionSection()},_resetUI:function(){if(this.set("uniqueIdField",this.uniqueIdField),this.inputLayer){this.outputLayerName=h.substitute(this.i18n.outputLayerName,{layername:this.inputLayer.name}),this._outputLayerInput.set("value",this.outputLayerName);var e=new t;this._variableList=null,this.isMultidimensionalLayer(this.inputLayer)?e=this.inputLayer.getMultidimensionalInfo():e.resolve(),e.then(i.hitch(this,(function(e){if(e&&(this._variableList=e.variables),this._updateDimensionSection(),this._updateStatsVisibility(),!this.rerun){var t=!0;d(".rasterSelect",this.domNode).forEach((function(e){e.value===this._emptyValue&&(t=!1)})),t&&(this._removeRasterRows(),this._createInRasterRow())}})))}},addBrowseOption:function(){T.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._layersSelect}])},_loadStatisticsType:function(e){this._statisticsType.removeOption(this._statisticsType.getOptions());var t=e&&this.statisticsType;this._statisticsType.addOption([{value:"MEAN",label:this.i18n.mean,selected:"MEAN"===t},{value:"MAJORITY",label:this.i18n.majority,selected:"MAJORITY"===t},{value:"MAXIMUM",label:this.i18n.maximum,selected:"MAXIMUM"===t},{value:"MEDIAN",label:this.i18n.median,selected:"MEDIAN"===t},{value:"MINIMUM",label:this.i18n.minimum,selected:"MINIMUM"===t},{value:"MINORITY",label:this.i18n.minority,selected:"MINORITY"===t},{value:"STD",label:this.i18n.standardDeviation,selected:"STD"===t},{value:"SUM",label:this.i18n.sum,selected:"SUM"===t},{value:"PERCENTILE",label:this.i18n.percentile,selected:"PERCENTILE"===t}])},_loadResamplingType:function(e){this._resamplingType.removeOption(this._resamplingType.getOptions());var t=e&&this.resamplingType;this._resamplingType.addOption([{value:"NEAREST",label:this.i18n.nearest,selected:"NEAREST"===t},{value:"BILINEAR",label:this.i18n.bilinear,selected:"BILINEAR"===t},{value:"CUBIC",label:this.i18n.cubic,selected:"CUBIC"===t}])},isMultidimensionalLayer:function(e){return e.hasMultidimensions},_showDiv:function(e,t){r.toggle(e,"show",t),r.toggle(e,"hide",!t)},_handleLocationLayerChange:function(e){"browselayers"===e||"browse"===e?(this._isAnalysisSelect=!1,this._isMoreAnalysisSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",[S.IS,S.FS]),this._createBrowseItems({browseValue:e,disableLAAL:!0,disableBoundary:!0},{},this._layersSelect)):this.set("locationLayer",this.locationLayers[e]),this.set("uniqueIdField",null)},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&T.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.locationLayers,layersSelect:this._isAnalysisSelect?this._isMoreAnalysisSelect?this._currentLayersSelect:this._analysisSelect:this._layersSelect,browseDialog:this._browseLyrsdlg||this._browsedlg,widget:this},t).always(i.hitch(this,(function(){this._isAnalysisSelect?this._isMoreAnalysisSelect?this._handleInRasterLayerChange(this._currentLayersSelect.get("value")):this._handleAnalysisLayerChange(this._analysisSelect.get("value")):this._handleLocationLayerChange(this._layersSelect.get("value"))}))),this._isMoreAnalysisSelect=!1},_handleFormatRadioChange:function(e){this._updateFormatSelection()},_handleFormatRadioChangeZ:function(e){this._updateFormatSelection(!0)},_handleOptionsBtnClick:function(){r.contains(this._optionsDiv,"disabled")||(r.toggle(this._optionsDiv,"optionsOpen",r.contains(this._optionsDiv,"optionsClose")),r.toggle(this._optionsDiv,"optionsClose",!r.contains(this._optionsDiv,"optionsClose")))},_handleOptionsBtnClickZ:function(){r.contains(this._optionsDivZ,"disabled")||(r.toggle(this._optionsDivZ,"optionsOpen",r.contains(this._optionsDivZ,"optionsClose")),r.toggle(this._optionsDivZ,"optionsClose",!r.contains(this._optionsDivZ,"optionsClose")))},_handleDimensionClicked:function(e,t){r.toggle(e,"disabled",!t),r.toggle(e,"optionsClose",!t),r.toggle(e,"optionsOpen",t)},_handleTimeDimensionClicked:function(e){this._handleFormatRadioChange(),this._handleDimensionClicked(this._optionsDiv,e)},_handleZDimensionClicked:function(e){this._handleFormatRadioChangeZ(),this._handleDimensionClicked(this._optionsDivZ,e)},_handleStatisticsTypeChange:function(){var e="PERCENTILE"===this._statisticsType.get("value");d(".percentile",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_handleBufferChange:function(){var e=this.get("bufferDistance");d(".statisticsType",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_refreshFields:function(e,t,i){if(t)s.forEach(e,(function(e){e.reset()}));else{var a=new _({data:i,idProperty:"value"});s.forEach(e,(function(e){e.set("store",a)}))}},_handleInRasterSelectChange:function(e,t,s){var a,n=this.get("referenceWidget");"browselayers"===s||"browse"===s?(n._isAnalysisSelect=!0,n._isMoreAnalysisSelect=!0,n._currentLayersSelect=this,n.defaultItemTypes=[],n.set("allowedItemTypes",[S.IS,S.FS]),n._createBrowseItems({browseValue:s,disableLAAL:!0,disableBoundary:!0},{},this)):s&&"NONE"!=s&&(this.get("isnewRowAdded")||(a=this.get("removeTd"),o.set(a,"display","block"),i.hitch(n,n._createInRasterRow()),this.set("isnewRowAdded",!0)),this.set("value",s)),n._updateDimensionSection()},_handleInRasterLayerChange:function(e){},_createInRasterRow:function(e){var t,a,l,r,o,h,d=[];return t=u.create("tr",null,this._inRastersDiv,"before"),a=u.create("td",{style:{width:"100%"}},t),l=new b({class:"longInput rasterSelect esriLeadingMargin1 esriLongLabel",style:{tableLayout:"fixed",overflowX:"hidden"}},u.create("select",null,a)),h={value:this._emptyValue,label:""},d.push(h),this.inputLayers&&(s.forEach(this.inputLayers,(function(t,i){(h={value:i+1,label:t.name}).selected=i===e,d.push(h)}),this),l.addOption(d)),o=u.create("td",{class:"shortTextInput removeTd",style:{display:V.isDefined(e)?"block":"none",maxWidth:"12px"}},t),r=u.create("a",{title:this.i18n.removeLayer,class:"closeIcon rasterRemove",innerHTML:"<img src='"+require.toUrl("./images/close.gif")+"' border='0''/>"},o),n.connect(r,"onclick",i.hitch(this,this._removeRasterRow,t)),this._rasterRows.push(t),l.set("removeTd",o),l.set("isnewRowAdded",!!V.isDefined(e)),l.set("referenceWidget",this),l.watch("value",this._handleInRasterSelectChange),this._currentRasterSelect=l,!0},_removeRasterRow:function(e){s.forEach(g.findWidgets(e),(function(e){e.destroyRecursive()})),u.destroy(e),this._updateDimensionSection()},_removeRasterRows:function(){s.forEach(this._rasterRows,this._removeRasterRow,this),this._rasterRows=[]},_updateDimDiv:function(e){d(".dimensionsDiv",this.domNode).forEach((function(t){this._showDiv(t,e)}),this),d(".layout",this.domNode).forEach((function(t){this._showDiv(t,e)}),this),d(".stdTimeDiv",this.domNode).forEach((function(t){this._showDiv(t,e)}),this),d(".stdZDiv",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_updateDimensionSection:function(){var e=d(".rasterSelect",this.domNode).length-1;this._variableList&&e<=0?this.set("variables",this._variableList):(c.set(this._resampleNumberLabel,"innerHTML",this.i18n.threeLabel),c.set(this._outputTypeNumberLabel,"innerHTML",this.i18n.fourLabel),c.set(this._outputLayerNumberLabel,"innerHTML",this.i18n.fiveLabel),this._updateDimDiv(!1))},_updateFormatSelection:function(e){var t=e?"formatZ":"format";this._aggregateTable.querySelectorAll("[name="+t+"]").forEach((function(e){e.checked?d("."+e.value,this[t]).forEach((function(e){this._showDiv(e,!0)}),this):d("."+e.value,this[t]).forEach((function(e){this._showDiv(e,!1)}),this)}),this),this._updateStatsVisibility()},_getIsValidFomat:function(){var e=!1;return r.contains(this._optionsDiv,"disabled")||this._aggregateTable.querySelectorAll("[name='format']").forEach((function(t){t.checked&&(e=t.value.startsWith("relativeValue")||t.value.startsWith("startEndValue"))})),e||r.contains(this._optionsDivZ,"disabled")||this._aggregateTable.querySelectorAll("[name='formatZ']").forEach((function(t){t.checked&&(e=t.value.startsWith("relativeValue")||t.value.startsWith("startEndValue"))})),e},_updateStatsVisibility:function(){var e=!1;this._variableList&&this._variableList.length>0&&(e=this._isPolyLayer||this.get("bufferDistance")||this._getIsValidFomat()),d(".statisticsType",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_setInputLayersAttr:function(e){this.inputLayers=e},_getInputLayersAttr:function(){return this.inputLayers},_getInRastersAttr:function(){var e=[this.inputLayer],t=this.inputLayers,i=this._emptyValue;return d(".rasterSelect",this.domNode).forEach((function(s){var a=g.byNode(s).get("value");a!=i&&e.push(t[a-1])})),{urls:e.map((function(e){return I.getRasterJsonFromLayer(e).url}))}},_getLocatonLayerAttr:function(){return this.locationLayer=this.locationLayers[this._layersSelect.get("value")],this.locationLayer},_setLocationLayerAttr:function(e){this.locationLayer!==e&&(this.locationLayer=e,e&&(this._isPolyLayer=e.geometryType===A.GeometryTypes.Polygon||e.geometryType===A.GeometryTypes.Line),this.set("uniqueIdField",null),this._updateStatsVisibility())},_setLocationLayersAttr:function(e){this.locationLayers=e,this.set("locationLayer",this.locationLayers[0])},_getLocationLayersAttr:function(){return this.locationLayers},_getLocationDataAttr:function(){var e=this.get("locationLayer");return"Image Service"===e.type?I.getRasterJsonFromLayer(e):T.constructAnalysisInputLyrObj(e)},_setVariablesAttr:function(e){var t,i,a=!1,n=e.length;c.set(this._resampleNumberLabel,"innerHTML",this.i18n.fourLabel),c.set(this._outputTypeNumberLabel,"innerHTML",this.i18n.fiveLabel),c.set(this._outputLayerNumberLabel,"innerHTML",this.i18n.sixLabel),s.forEach(e,(function(e){var i=e.dimensions;a||(t=i),a&&JSON.stringify(t)!=JSON.stringify(i)&&(t=null),a=!0}),this);var l=d(".stdTimeDiv",this.domNode),r=d(".stdZDiv",this.domNode);d(".dimensionsDiv",this.domNode).forEach((function(e){this._showDiv(e,!0)}),this),d(".buffer",this.domNode).forEach((function(e){this._showDiv(e,!1)}),this),l.forEach((function(e){this._showDiv(e,!1)}),this),r.forEach((function(e){this._showDiv(e,!1)}),this),d(".layoutDiv",this.domNode).forEach((function(e){this._showDiv(e,!1)}),this),this._showDiv(this._dimensionError,!1),t?(t&&t.length>0&&(d(".buffer",this.domNode).forEach((function(e){this._showDiv(e,!0)}),this),s.forEach(t,(function(e){"StdTime"===e.name?i=l:"StdZ"===e.name&&(i=r),i.forEach((function(e){this._showDiv(e,!0)}),this)}),this)),this._handleFormatRadioChange(),this._handleFormatRadioChangeZ(),1===n&&1===t.length&&(d(".layoutDiv",this.domNode).forEach((function(e){this._showDiv(e,!0)}),this),c.set(this._outputTypeNumberLabel,"innerHTML",this.i18n.sixLabel),c.set(this._outputLayerNumberLabel,"innerHTML",this.i18n.sevenLabel))):this._showDiv(this._dimensionError,!0)},_setDimensionFieldOrValueAttr:function(e){this.dimensionFieldOrValue=e},_getDimensionFieldOrValueAttr:function(){return this._dimensionFieldOrValue&&(this.dimensionFieldOrValue=this._dimensionFieldOrValue.get("value")),this.dimensionFieldOrValue},_setDimensionFieldAttr:function(e){this.dimensionField=e},_getDimensionFieldAttr:function(){return this._dimensionField&&(this.dimensionField=this._dimensionField.get("value")),this.dimensionField},_setStartFieldOrValueAttr:function(e){this.startFieldOrValue=e},_getStartFieldOrValueAttr:function(){return this._startFieldOrValue&&(this.startFieldOrValue=this._startFieldOrValue.get("value")),this.startFieldOrValue},_setEndFieldOrValueAttr:function(e){this.endFieldOrValue=e},_getEndFieldOrValueAttr:function(){return this._endFieldOrValue&&(this.endFieldOrValue=this._endFieldOrValue.get("value")),this.endFieldOrValue},_setRelativeValueOrDaysBeforeAttr:function(e){this.relativeValueOrDaysBefore=e,this._relativeValueOrDaysBefore.set("value",e)},_getRelativeValueOrDaysBeforeAttr:function(){return this._relativeValueOrDaysBefore&&(this.relativeValueOrDaysBefore=this._relativeValueOrDaysBefore.get("value")),this.relativeValueOrDaysBefore},_setRelativeValueOrDaysAfterAttr:function(e){this.relativeValueOrDaysAfter=e,this._relativeValueOrDaysAfter.set("value",e)},_getRelativeValueOrDaysAfterAttr:function(){return this._relativeValueOrDaysAfter&&(this.relativeValueOrDaysAfter=this._relativeValueOrDays.get("value")),this.relativeValueOrDaysAfter},_setBufferDistanceAttr:function(e){this.bufferDistance=e},_getBufferDistanceAttr:function(){return this._bufferDistance&&(this.bufferDistance=this._bufferDistance.get("value")),this.bufferDistance},_setStatisticsTypeAttr:function(e){this.statisticsType=e},_getStatisticsTypeAttr:function(){return this._statisticsType&&(this.statisticsType=this._statisticsType.get("value")),this.statisticsType},_setPercentileValueAttr:function(e){this.percentileValue=e},_getPercentileValueAttr:function(){return this._percentileValue&&(this.percentileValue=this._percentileValue.get("value")),this.percentileValue},_setUniqueIdFieldAttr:function(e){var t=[this._dimensionFieldZ,this._dimensionFieldOrValueZ,this._startFieldOrValueZ,this._endFieldOrValueZ,this._bufferDistance],i=[this._uniqueIdField],a=[this._dimensionField,this._dimensionFieldOrValue,this._startFieldOrValue,this._endFieldOrValue];if(this._refreshFields(t.concat(a),!0),this.locationLayer){var n,l=[],r=[],o=[];if("esri.layers.ArcGISImageServiceLayer"===this.locationLayer.declaredClass)this.locationLayer.hasRasterAttributeTable?n=this.locationLayer._rasterAttributeTableFields:l.push({value:"VALUE",name:"VALUE"});else if(!(n=this.locationLayer.fields))return;n&&s.forEach(n,(function(e){e.type!==A.FieldTypes.ObjectId&&e.type!==A.FieldTypes.Integer||o.push({value:e.name,name:V.isDefined(e.alias)&&""!==e.alias?e.alias:e.name}),e.type===A.FieldTypes.Integer||e.type===A.FieldTypes.Short||e.type===A.FieldTypes.Double||e.type===A.FieldTypes.long?l.push({value:e.name,name:V.isDefined(e.alias)&&""!==e.alias?e.alias:e.name}):e.type===A.FieldTypes.Date&&r.push({value:e.name,name:V.isDefined(e.alias)&&""!==e.alias?e.alias:e.name})})),o.length>0&&this._refreshFields(i,!1,o),l.length>0&&this._refreshFields(t,!1,l),r.length>0&&this._refreshFields(a,!1,r)}},_getUniqueIdFieldAttr:function(){return this._uniqueIdField&&(this.uniqueIdField=this._uniqueIdField.get("value")),this.uniqueIdField},_getResamplingTypeAttr:function(){return this._resamplingType&&(this.resamplingType=this._resamplingType.get("value")),this.resamplingType},_getGenerateFeatureClassAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='outputType']");return e&&e.length>0&&(this.generateFeatureClass=e[1].checked),this.generateFeatureClass},_setGenerateFeatureClassAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='outputType']");e&&e.length>0&&(e[1].checked=this.generateFeatureClass)},_getLayoutAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='layout']");return e&&e.length>0&&(this.layout=e[0].checked?"ROW_WISE":"COLUMN_WISE"),this.layout},_setLayoutAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='layout']");e&&e.length>0&&e[0].checked},_getAcquisitionDefinitionAttr:function(){var e,t,s=this._aggregateTable.querySelectorAll("[name='stdTime']"),a=this._aggregateTable.querySelectorAll("[name='stdZ']"),n=[];return s[0].checked&&(e={dimension:"StdTime"},"singleFieldOrValue"===(t=d("input:checked",this._optionsRow)[0].value)?i.mixin(e,{startFieldOrVal:this._dimensionFieldOrValue.get("value")}):"relativeValue"===t?(i.mixin(e,{startFieldOrVal:this._dimensionField.get("value")}),i.mixin(e,{relValOrDaysBefore:this._daysBefore.get("value")}),i.mixin(e,{relValOrDaysAfter:this._daysAfter.get("value")})):"startEndValue"===t&&(i.mixin(e,{startFieldOrVal:this._startFieldOrValue.get("value")}),i.mixin(e,{endFieldOrVal:this._endFieldOrValue.get("value")})),n.push(e)),a[0].checked&&(e={dimension:"StdZ"},"singleFieldOrValueZ"===(t=d("input:checked",this._optionsRowZ)[0].value)?i.mixin(e,{startFieldOrVal:this._dimensionFieldOrValueZ.get("value")}):"relativeValueZ"===t?(i.mixin(e,{startFieldOrVal:this._dimensionFieldZ.get("value")}),i.mixin(e,{relValOrDaysBefore:this._daysBeforeZ.get("value")}),i.mixin(e,{relValOrDaysAfter:this._daysAfterZ.get("value")})):"startEndValueZ"===t&&(i.mixin(e,{startFieldOrVal:this._startFieldOrValueZ.get("value")}),i.mixin(e,{endFieldOrVal:this._endFieldOrValueZ.get("value")})),n.push(e)),n}});return l("extend-esri")&&i.setObject("dijit.analysis.Sample",N,F),N}));