// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/store/Memory","dojo/promise/all","dojo/when","dojo/string","dojo/has","dojo/number","dojo/dom-class","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dijit/Tooltip","dijit/Dialog","dijit/form/Button","esri/layers/ArcGISImageServiceLayer","../../kernel","../../lang","../../request","../../symbols/SimpleFillSymbol","../../Color","../../renderers/ClassBreaksRenderer","../../renderers/StretchRenderer","../../renderers/colorRampUtils","../../tasks/AlgorithmicColorRamp","../../tasks/MultipartColorRamp","../RasterFunctionEditor/utils","./AnalysisBase","./_AnalysisOptions","./utils","./ItemTypes","./mixins/browselayers/BrowseLayerMixin","../../layers/RasterFunction","../../layers/ArcGISRenderingImageServiceLayer"],(function(e,t,i,s,n,r,a,o,l,h,u,c,d,p,y,m,g,f,_,v,L,w,b,R,A,T,S,I,F,C,P,N,D,x,O,M,k,j,E){var B=e([x,D,k],{declaredClass:"esri.dijit.analysis.RasterAnalysisMixin",map:null,outputLayerName:null,resultParameter:"outputRaster",rasterGPToolName:"GenerateRaster",analysisType:"raster",i18n:null,returnProcessInfo:null,isPPTTool:!1,isDLTool:!1,isRaster:!0,unsupportedServiceNameCharacters:/[\s~`!#$%\^&*+=\-\[\]\\';,\/{}|\\":<>\?\.]/g,binFunctions:["Boolean Or","Boolean And","Boolean Xor","Boolean Not"," Equal To","Greater Than","Greater Than Equal","IsNull","Less Than","Less Than Equal","Not Equal"],globalFunctions:["Kernel Density","Boundary Clean","Expand","Nibble","Region Group","Shrink","Corridor","Distance Accumulation","Distance Allocation","Optimal Path As Raster","Fill","Flow Accumulation","Flow Direction","Flow Distance","Flow Length","Sink","Snap Pour Point","Stream Link","Stream Order","Watershed","Zonal Statistics","Viewshed"],_geometryService:null,_findDeepestArgsForRerun:!1,constructor:function(e,t){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),s.forEach(this._pbConnects,n.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),i.mixin(this.i18n,this.toolNlsName)},postCreate:function(){this.inherited(arguments),d.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",i.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},validateServiceName:function(e){return O.validateServiceName(e,{textInput:this._outputLayerInput})},_getJobParameters:function(){},_getRasterFunction:function(){},_getRasterArguments:function(){},_getRasterObject:function(e){var t=e||this.get("inputLayer");return N.getRasterJsonFromLayer(t)},_getOutputRasterLayerName:function(){},_getOutputItemProperties:function(){},_setDefaultInputs:function(){},_resetUI:function(){},_getDefaultOutputItemProperties:function(e,t,i){var s=t?this._getDefaultColorrampRender(t):this._getDefaultRenderer(),n={visibility:!0,opacity:e||1,interpolation:i||"RSP_NearestNeighbor",popupInfo:this._getDefaultPopupInfo()};return s&&(n.layerDefinition={},n.layerDefinition.drawingInfo={},n.layerDefinition.drawingInfo.renderer=s.toJson()),n},_getDefaultRenderingRule:function(e){var t=new j;t.functionName="Stretch";var i={StretchType:5,DRA:!1,UseGamma:!1};t.functionArguments=i,t.outputPixelType="U8";var s=new j;return s.functionName="Colormap",s.functionArguments={colorRamp:e||"Aspect",Raster:t},s},_getDefaultColorrampRender:function(e){var t=F.getColorRampId(e),i=F.predefinedColorRamps.find((function(e){return e.id===t.id}));return new I({colorRamp:i,stretchType:"minMax",dra:!1,useGamma:!1})},_getDefaultRenderer:function(){if(this.colorValues&&this.colorValues.length&&this.classMaxValues&&this.classMaxValues.length&&this.labels&&this.labels.length){var e=this.colorValues.length;if(e===this.classMaxValues.length&&e===this.labels.length){var t,i,s,n,r=new S({field:"Value",showInAscendingOrder:!0,classificationMethod:"natural-breaks"}),a=new P;for(a.colorRamps=[],s=0;s<e;s++)n=this.colorValues[s],t&&((i=new C).algorithm="hsv",i.fromColor=new T(t),i.toColor=new T(n),a.colorRamps.push(i)),t=n;a&&(r.authoringInfo={},r.authoringInfo.colorRamp=a.toJson());var o,l,h=[],u=-1;for(s=0;s<e;s++)l=this.colorValues[s],o=new A("solid",null,new T({r:l[0],g:l[1],b:l[2],a:l[3]})),h.push({minValue:u,maxValue:this.classMaxValues[s],label:this.labels[s],symbol:o}),u=this.classMaxValues[s];return r.infos=h,r.attributeField="Value",r}}},_getDefaultPopupInfo:function(){return{title:this.get("outputLayerName"),description:null,fieldInfos:[{fieldName:"Raster.ServicePixelValue",label:"Service Pixel Value",isEditable:!1,isEditableOnLayer:!1,visible:!1,format:{places:2,digitSeparator:!0}}],showAttachments:!1,layerOptions:{showNoDataRecords:!0,returnTopmostRaster:!0},mediaInfos:[]}},_getReRunRFxArgs:function(e,t){var i={};return this._findFunction(e,t,i),i&&i.rasterFunctionArguments},_findFunction:function(e,t,i){var s=e&&e.rasterFunction,n=this._getRasterFunction();s&&i&&"object"==typeof i&&(s!==n||(i.rasterFunction=e.rasterFunction,i.rasterFunctionArguments=e.rasterFunctionArguments,t))&&this._findFunction(e.rasterFunctionArguments&&(e.rasterFunctionArguments.Raster||e.rasterFunctionArguments.raster),t,i)},_getSelectedLayerIndexFromUI:function(e,t){if(!e||!t)return-1;var i=-1;return s.forEach(e,(function(e,s){e&&e.label.toLowerCase()===t.toLowerCase()&&(i=s)})),i},_getRenderingService:function(){return this.isSingleTenant?this.analysisGpServer:this.analysisGpServer.replace("rasteranalysis","rasterutils")},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.rasterGPToolName))},_setInputLayersAttr:function(e){this.inputLayers=e},_setInputLayerAttr:function(e){this.inputLayer=e},_getInputLayerAttr:function(){return this.inputLayer},_getOutputLayerNameAttr:function(){return this._outputLayerInput&&(this.outputLayerName=this._outputLayerInput.get("value")),this.outputLayerName},_setOutputLayerNameAttr:function(e){this.outputLayerName=e},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setDisableExtentAttr:function(e){this._useExtentCheck.set("checked",!e),this._useExtentCheck.set("disabled",e)},_getDisableExtentAttr:function(){this._useExtentCheck.get("disabled")},_setMapAttr:function(e){this.map=e},_getMapAttr:function(){return this.map},_setModelsAttr:function(e){this.models=e},_handleModeCrumbClick:function(e){e.preventDefault(),this._onClose(!0)},_onClose:function(e){this._removePointLayer(),e&&(this._save(),this.emit("save",{save:!0})),this.removePreviewLayerFromMap(),this.emit("close",{save:!e})},_removePointLayer:function(){this.drawnPointLayer&&(this._removeLayer(this.drawnPointLayer,this.inputLayers,this._analysisSelect),this._sourceDrawBtn.deactivate())},_removeLayer:function(e,t,i){this.map.removeLayer(e),s.forEach(t,(function(s,n){if(s===e)return i.removeOption({value:n,label:e.name}),void t.splice(n,1)}),this)},_save:function(){},_handleShowCreditsClick:function(e){e.preventDefault();var t=this._getJobParameters(),s=this.rasterGPToolName||this.toolName;if(this._form.validate()){if(b.isDefined(t))t.inputLayer=r.toJson(O.constructAnalysisInputLyrObj(this.get("inputLayer")));else{(t={}).rasterFunction=this._getRenderingRule();var n=this._getRasterObject();n&&!this._useRFT&&(t.functionArguments={raster:n}),s="GenerateRaster"}t[this.outputName]={serviceProperties:{name:this.get("outputLayerName").replace(/[\s]|\-|\./g,"_"),capabilities:this._outputLayerTCapabilities()}},this.secondaryOutputNames&&i.mixin(t,this.updateSecondaryOutputNames());var a=Object.assign({},this.context);this.showChooseExtent&&!this.get("disableExtent")&&this._useExtentCheck.get("checked")&&(a.extent=this.map.extent._normalize(!0)),t.context=a,this.getCreditsEstimate(s,t,!0).then(i.hitch(this,(function(e){e&&e.cost>=0?this._usageForm.set("content",e):this._usageForm.set("ErrorContent",this.i18n.creditErrorMsg),this._usageDialog.show()})))}},updateSecondaryOutputNames:function(){var e={},t=this._outputLayerTCapabilities();return s.forEach(this.secondaryOutputNames,i.hitch(this,(function(i){this.get(i)&&(e[i]=r.toJson({serviceProperties:{name:this.get(i).replace(this.unsupportedServiceNameCharacters,"_"),capabilities:t}}))}))),e},_validateRFT:function(e){if(e){var t=!1,s=this._getRenderingService().replace("RasterAnalysisTools/GPServer","RasterRendering/ImageServer/validate"),n={renderingRule:e,f:"json"};return this._previewBtnTooltip||(this._previewBtnTooltip=new f({connectId:[this.esriAnalysisPreviewError,this.esriAnalysisPreviewWarning],label:this.i18n.previewError})),R({url:s,content:n,load:i.hitch(this,(function(e){return e&&e.renderingRule&&e.renderingRule.isValid&&(t=!0),this._isValidateRfx=t,t}))})}},onValidRFT:function(){this._previewBtnTooltip.label="",this.removePreviewErrors()},onInvalidRFT:function(){this._previewBtnTooltip.label="<div class='esriAnalysisPreviewErrorToolTip'>"+this.i18n.previewError+"</div>",this.esriAnalysisPreviewWarning.style.display="none",this.esriAnalysisPreviewError.style.display="block",this.onPreviewLoad()},handleExportImageFailure:function(){this._previewBtnTooltip.label="<div class='esriAnalysisPreviewErrorToolTip'>"+this.i18n.previewWarning+"</div>",this.esriAnalysisPreviewError.style.display="none",this.esriAnalysisPreviewWarning.style.display="block",this.onPreviewLoad()},onPreviewLoad:function(){this.esriAnalysisPreviewLoading.style.display="none"},removePreviewErrors:function(){this.esriAnalysisPreviewError.style.display="none",this.esriAnalysisPreviewWarning.style.display="none"},_handlePreviewBtnClick:function(e){if(this._form.validate())if(this._preview=!this._preview,this._preview){this.removePreviewErrors(),this.esriAnalysisPreviewLoading.style.display="block";var t=this._getRenderingRule();JSON.stringify(t)===JSON.stringify(this.rfxTemplate)?this._isValidateRfx?(this.onValidRFT(),this._showPreview()):this.onInvalidRFT():(this.rfxTemplate=t,this._validateRFT(t).then(i.hitch(this,(function(e){e?(this.onValidRFT(),this._preview&&this._showPreview()):this.onInvalidRFT()})),i.hitch(this,(function(e){this.onInvalidRFT()}))))}else this.onPreviewLoad(),this.removePreviewErrors(),this.removePreviewLayerFromMap()},updatePreview:function(){this._preview&&(this.removePreviewErrors(),this._showPreview())},_showPreview:function(){var e=this._getRenderingRule();this.esriAnalysisPreviewLoading.style.display="block",this._addPreviewLayerToMap(e)},_addPreviewLayerToMap:function(e){this.previewLayer&&this.removePreviewLayerFromMap();var t=this._getRenderingService().replace("RasterAnalysisTools/GPServer","RasterRendering/ImageServer"),s=new E(t,{raster:e,type:"rft"}),n=JSON.parse(e);if(n.function&&"LocalFunction"===n.function.type&&this.binFunctions.indexOf(n.function.name)>-1){var r=new I({stretchType:"minMax",dra:!0,useGamma:!1});s.setRenderer(r)}var a=i.hitch(this,(function(e){this._preview&&(this.previewLayer=e,this.map.addLayer(this.previewLayer),this.onValidRFT())}));s.loaded?a(s):(s.on("load",(function(){a(s)})),s.on("error",i.hitch(this,(function(e){this.previewLayer?(!this.previewLayer.updating||e.error&&"Timeout exceeded"===e.error.message)&&this.handleExportImageFailure():this.onInvalidRFT()}))),s.on("update-end",i.hitch(this,(function(){this.onValidRFT(),this.onPreviewLoad()}))),s.on("update-start",i.hitch(this,(function(){this.onValidRFT(),this.esriAnalysisPreviewLoading.style.display="block"}))))},removePreviewLayerFromMap:function(){this.previewLayer&&(this.previewLayer.suspended=!0,this.previewLayer.opacity=0,this.map.removeLayer(this.previewLayer),this.previewLayer=void 0)},_getRenderingRule:function(){var e={};return this._useRFT?e=this._getRasterFunction():(e.rasterFunction=this._getRasterFunction(),e.rasterFunctionArguments=this._getRasterArguments()),r.toJson(e)},_runAnalysis:function(){var e;this._creditWarningDlg&&this._creditWarningDlg.hide(),e=this.secondaryOutputNames?this._validateSecondaryOutputNames():"done",l(e,i.hitch(this,(function(){this._saveBtn.set("disabled",!0),this._hideCreditRunning();var e=this._webLayerTypeSelect&&this._webLayerTypeSelect.get("value"),t=this._getJobParameters();if(!b.isDefined(t)){(t={}).rasterFunction=this._getRenderingRule();var s=this._getRasterObject();s&&!this._useRFT&&(t.functionArguments=r.toJson({raster:s}))}t[this.outputName]=r.toJson({serviceProperties:{name:this.get("outputLayerName").replace(/[\s]|\-|\./g,"_"),capabilities:this._outputLayerTCapabilities()}}),this.secondaryOutputNames&&i.mixin(t,this.updateSecondaryOutputNames()),t.returnProcessInfo=this.returnProcessInfo;var n=Object.assign({},this.context);"Sample"===this.toolName&&t.processAsMultidimensional&&(delete t.processAsMultidimensional,n={processAsMultidimensional:!0}),this.showChooseExtent&&!this.get("disableExtent")&&this._useExtentCheck.get("checked")&&(n.extent=this.map.extent._normalize(!0)),t.context=r.toJson(n),e&&(t.outputType=e);var a={};a.jobParams=t,a.itemParams={description:this.i18n.itemDescription,tags:h.substitute(this.i18n.itemTags,{layername:this.inputLayer&&this.inputLayer.name,fieldname:t.field||"",valuelayername:t.valuelayername||""}),snippet:this.i18n.itemSnippet};var o=this._getOutputItemProperties();o&&(a.itemParams.text=o),this.showSelectFolder&&(a.itemParams.folder=this.get("folderId")),a.analysisType=this.analysisType,this.execute(a)})))},_handleSaveBtnClick:function(e){if(this._form.validate()){this.estimatedCost=null;var t=O.settingsVM.showCreditWarningSettings&&O.settingsVM.creditWarning;this._creditRunning&&(p.set(this._creditRunning,"display","block"),p.set(this._saveBtn.domNode.firstElementChild,"display","none")),this.getUserProfile().then(i.hitch(this,(function(e){var s=this.get("outputLayerName").replace(/[\s]|\-|\./g,"_");this._checkServiceNameOnly(e.orgId,s).then(i.hitch(this,(function(e){if(e){if(!t)return void this._runAnalysis();var n=this._getJobParameters(),a=this.rasterGPToolName||this.toolName;if(b.isDefined(n))n.inputLayer=r.toJson(O.constructAnalysisInputLyrObj(this.get("inputLayer")));else{(n={}).rasterFunction=this._getRenderingRule();var o=this._getRasterObject();o&&!this._useRFT&&(n.functionArguments={raster:o}),a="GenerateRaster"}n[this.outputName]={serviceProperties:{name:s,capabilities:this._outputLayerTCapabilities()}},this.secondaryOutputNames&&i.mixin(n,this.updateSecondaryOutputNames());var l=Object.assign({},this.context);this.showChooseExtent&&!this.get("disableExtent")&&this._useExtentCheck.get("checked")&&(l.extent=this.map.extent._normalize(!0)),n.context=l,this.getCreditsEstimate(a,n,!0).then(i.hitch(this,(function(e){var t=e&&e.cost>=0;p.set(this._creditWarningBtns,"display",t?"block":"none"),t?(this.estimatedCost=e.cost,e.cost>50?(y.set(this._creditWarningMsg,"innerHTML",h.substitute(this.i18n.creditWarningMsg,{toolname:this._titleLbl.innerText||this.toolName,credit:c.format(e.cost,{locale:w.locale})})),this._creditWarningDlg.show()):this._runAnalysis()):(y.set(this._creditWarningMsg,"innerHTML",this.i18n.creditErrorMsg),this._creditWarningDlg.show()),this._hideCreditRunning()})))}else this._hideCreditRunning()})))})))}},_hideCreditRunning:function(){this._creditRunning&&(p.set(this._creditRunning,"display","none"),p.set(this._saveBtn.domNode.firstElementChild,"display","block"))},_handleSaveDynamicLayer:function(e){var t=this.get("inputLayer"),i=this._getRenderingService().replace("RasterAnalysisTools/GPServer","RasterRendering/ImageServer?viewId="),s={createItemThumbnail:!1};s.url=i+t.url,s.outputLayerName=r.fromJson(e[this.outputName]).serviceProperties.name,s.analysisInfo={toolName:this.toolName,jobParams:e};var n=new j;n.functionName=this._getRasterFunction(),n.functionArguments=this._getRasterArguments(),s.renderingRule=n,s.mosaicRule=t.mosaicRule},_handleAnalysisLayerChange:function(e){if("browselayers"===e||"browse"===e){this._isAnalysisSelect=!0,this.browseType&&(this.defaultItemTypes=[],this.set("allowedItemTypes",this.browseType));var t={geometryTypes:this.checkGeometries,tags:this.tags,customCheck:this.hasCustomCheck?{customCheckHandler:i.hitch(this,this.isValidInputLayer),customCheckFailureMessage:this.customCheckFailureMessage}:void 0};this._createBrowseItems(this.getOptionsForRasterBrowseItems(e),t,this._analysisSelect)}else this.inputLayer=this.inputLayers[e],this._updateAnalysisLayerUI(!0)},addPointAnalysisLayer:function(){this._sourceDrawBtn&&(this._sourceDrawBtn.set("map",this.map),this._sourceDrawBtn.on("change",i.hitch(this,this._handleAnalysisPointSelectLayer)))},_handleAnalysisPointSelectLayer:function(e){this.inputLayers&&0!==this.inputLayers.length&&-1!==this.inputLayers.indexOf(e)||(this.drawnPointLayer=e,this.inputLayers.push(e),this.inputLayer=e,this._analysisSelect.removeOption(this._analysisSelect.getOptions()),O.populateAnalysisLayers(this,"inputLayer","inputLayers"),this._updateAnalysisLayerUI(!0))},_handleAggregationFunctionChange:function(e){"browserfts"===e&&(this._isAnalysisSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",M.RFT),this._createBrowseItems({browseValue:e,disableLAAL:!0,disableBoundary:!0},{},this._aggregationFunctionSelect))},_handleSelectRFTTool:function(e){if(this._aggregationFunctionSelect){if(this.aggregationFunctions||(this.aggregationFunctions=[]),this.aggregationFunction=this.aggregationFunctions.find((function(t){return t.value.itemId===e.id})),!this.aggregationFunction){this.aggregationFunction={value:{itemId:e.id},label:e.title},this.aggregationFunctions.splice(0,0,this.aggregationFunction);var t=this._aggregationFunctionSelect.getOptions();this._aggregationFunctionSelect.removeOption(t),t.splice(0,0,this.aggregationFunction),this._aggregationFunctionSelect.addOption(t)}this._aggregationFunctionSelect.set("value",this.aggregationFunction)}},_updateAnalysisLayerUI:function(e){if("ApplyRFxTemplate"===this.toolName&&(e&&(this.outputLayerName=this._getOutputRasterLayerName()),this._outputLayerInput.set("value",this.outputLayerName)),this.inputLayer){if(this.hasCustomCheck&&!this.isValidInputLayer(this.inputLayer))return this._layerCheckDlg?this._layerCheckDlg.content=this.customCheckFailureMessage:(this._layerCheckDlg=new _({content:this.customCheckFailureMessage,title:this.i18n.raster,style:"width:40em"}),m.place(this._layerCheckDlg,this._usageDialog,"after")),this._layerCheckDlg.show(),this._removeLayer(this.inputLayer,this.inputLayers,this._analysisSelect),this.inputLayer=null,void(this.inputLayers.length>0&&(this.inputLayer=this.inputLayers[0],this._resetUI()));this._interpolateToolDescription&&y.set(this._interpolateToolDescription,"innerHTML",h.substitute(this.i18n.toolDefine,{layername:this.inputLayer.name})),e&&this.i18n.outputLayerName&&(this.outputLayerName=this._getOutputRasterLayerName()||h.substitute(this.i18n.outputLayerName,{layername:this.inputLayer.name})),this._outputLayerInput.set("value",this.outputLayerName)}this._resetUI()},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&O.addAnalysisReadyLayer({item:e.selection,layers:this.inputLayers,layersSelect:this._analysisSelect,browseDialog:this._browseLyrsdlg||this._browsedlg,widget:this},t).always(i.hitch(this,this._updateAnalysisLayerUI,!0))},_handleSelectDLPKTool:function(e){if(this._modelSelect){if(this.models||(this.models=[]),this.model=this.models.find((function(t){return t.value===e.id})),!this.model){this.model={value:e.id,label:e.title,item:e},this.models.splice(0,0,this.model);var t=this._modelSelect.getOptions();this._modelSelect.removeOption(t),t.splice(0,0,this.model),this._modelSelect.addOption(t),this._queryModelArguments(e)}this._modelSelect.set("value",this.model)}},_handleModelChange:function(e){"browsedlpks"===e?(this._isAnalysisSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",M.DLPK),this._createBrowseItems({browseValue:e,disableLAAL:!0,disableBoundary:!0,title:this.i18n.browseDLPKs},{},this._modelSelect)):this.model.value!==e&&(this.model=this.models.find((function(t){return t.value===e})),this._queryModelArguments(this.model.item))},_queryModelArguments:function(e){if(this._modelArguments.innerHTML="",e.properties&&e.properties.modelInfo&&e.properties.modelInfo.ParameterInfo)this._loadModelArguments(e.properties.modelInfo.ParameterInfo);else{var t=e.id,s=this._toolServiceUrl,n={model:r.toJson({url:this.portalUrl+"/sharing/content/items/"+t}),context:{f:"json"}};p.set(this._queryModelArgsMsg,"display","table-row"),this._queryModelArgsMsg.innerHTML=this.i18n.queryModelArgsMsg,this.set("toolServiceUrl",this.analysisGpServer+"/QueryDeepLearningModelInfo"),this.set("disableRunAnalysis",!0),this.gp.submitJob(n,i.hitch(this,(function(e){"esriJobSucceeded"===e.jobStatus?(this.gp.getResultData(e.jobId,"outModelInfo",i.hitch(this,(function(e){if(this.set("toolServiceUrl",s),p.set(this._queryModelArgsMsg,"display","none"),e&&e.value&&e.value.modelInfo){var t="object"==typeof e.value.modelInfo?e.value.modelInfo.ParameterInfo:r.fromJson(e.value.modelInfo).ParameterInfo;t&&t.length>0&&this._loadModelArguments(t)}}))),this.set("disableRunAnalysis",!1)):(this.set("toolServiceUrl",s),this._queryModelArgsMsg.innerHTML=this.i18n.queryModelArgsErrMsg)})))}},_loadModelArguments:function(e){var t=[],n=m.toDom("<tr><td colspan='2' style='width:50%'><label>"+this.i18n.nameLabel+"</label></td><td style='width:50%'><label>"+this.i18n.valueLabel+"</td></tr>");m.place(n,this._modelArguments),s.forEach(e,i.hitch(this,(function(e){var i=e.name;if(["raster","rasters","model","device"].indexOf(i.toLowerCase())<0){var s=e.value,n=m.toDom("<tr><td colspan='2' style='width:50%'><label>"+i+"</label></td><td style='width:50%'><div><input type='text' data-dojo-type='dijit/form/NumberTextBox' data-dojo-props='intermediateChanges:true' style='width:100%;text-align:right' value='"+s+"'></div></td></tr>");m.place(n,this._modelArguments),t.push(n)}}))),this.modelArgumentRows=t},_updateModelArguments:function(e){var t=[],i=m.toDom("<tr><td colspan='2' style='width:50%'><label>"+this.i18n.nameLabel+"</label></td><td style='width:50%'><label>"+this.i18n.valueLabel+"</td></tr>");for(var s in m.place(i,this._modelArguments),e){var n=m.toDom("<tr><td colspan='2' style='width:50%'><label>"+s+"</label></td><td style='width:50%'><div><input type='text' data-dojo-type='dijit/form/NumberTextBox' data-dojo-props='intermediateChanges:true' style='width:100%;text-align:right' value='"+e[s]+"'></div></td></tr>");m.place(n,this._modelArguments),t.push(n)}this.modelArgumentRows=t},_validateSecondaryOutputNames:function(e){var n=new t;return this.getUserProfile().then(i.hitch(this,(function(e){var t=[],r=!0,a=this.portalUrl+"/sharing/rest/portals/"+e.orgId+"/isServiceNameAvailable";s.forEach(this.secondaryOutputNames,i.hitch(this,(function(e){if(this.get(e)){var i={name:this.get(e).replace(this.unsupportedServiceNameCharacters,"_"),type:"Image Service",f:"json"};t.push(R({url:a,content:i}))}}))),o(t).then(i.hitch(this,(function(e){s.forEach(e,i.hitch(this,(function(e,t){e.available||(r=!1,this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002"}),n.reject())}))),r&&n.resolve()})))}))),n.promise},_buildUI:function(){var e=!0;this._loadConnections();var t;if(this.isPPFTool=-1!==["ClassifyPixelsUsingDeepLearning","DetectObjectsUsingDeepLearning","ClassifyObjectsUsingDeepLearning","CalculateSlope","DeriveAspect","MonitorVegetation","ApplyRFxTemplate","RemapValues","ExtractRaster","AggregateMultidimensionalRaster","GenerateMultidimensionalAnomaly","PredictUsingTrendRaster","FindArgumentStatistics","Sample","ConvertFeatureToRaster"].indexOf(this.toolName),this.isDLTool=-1!==["ClassifyPixelsUsingDeepLearning","DetectObjectsUsingDeepLearning","ClassifyObjectsUsingDeepLearning"].indexOf(this.toolName),this.isDetectObjectTool=-1!==["DetectObjectsUsingDeepLearning","ClassifyObjectsUsingDeepLearning"].indexOf(this.toolName),this.needRFTs="AggregateMultidimensionalRaster"==this.toolName,this.isMdTool=-1!==["AggregateMultidimensionalRaster","GenerateMultidimensionalAnomaly","GenerateTrendRaster","PredictUsingTrendRaster","FindArgumentStatistics"].indexOf(this.toolName),this.isProximityTool=-1!==["CalculateDistance","DetermineOptimumTravelCostNetwork","DetermineTravelCostPathAsPolyline","OptimalPathAsLine","OptimalPathAsRaster","DistanceAllocation","DistanceAccumulation","OptimalRegionConnections"].indexOf(this.toolName),this.isOutputFeatureTool=-1!==["SummarizeRasterWithin","ZonalStatisticsAsTable","CalculateDensityRaster","InterpolatePointsEBK","CreateViewshedRaster","Watershed","ConvertRasterToFeature","Sample"].indexOf(this.toolName),this.signInPromise.then(i.hitch(this,(function(){O.initHelpLinks(this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer,analysisMode:"raster"})}))),this.rasterFunction){var s=this._getReRunRFxArgs(this.rasterFunction,this._findDeepestArgsForRerun);s&&i.mixin(this,s)}if(this.functionArguments&&(this.functionArguments.Raster||this.functionArguments.raster)&&this.set("inputLayer",this.functionArguments.Raster||this.functionArguments.raster),this.get("showSelectAnalysisLayer")){if("Sample"===this.toolName&&this.rerun){if(this.outputName="outputName",this.inRasters&&this.inRasters.urls.length>0){var n=this.inRasters.urls[0].split("?")[0];if(this.inputLayers){var r=this.inputLayers.filter((function(e){return e.url===n}));r&&r.length>0&&(this.inputLayer=r[0])}this.inputLayer||(this.inputLayers.push(new L(n)),this.inputLayer=this.inputLayers[0])}}else this.inputLayers&&this.inputLayer&&!O.isLayerInLayers(this.inputLayer,this.inputLayers)&&this.inputLayers.push(this.inputLayer);this.get("inputLayer")||!this.get("inputLayers")||this.rerun||this.set("inputLayer",this.inputLayers[0]),O.populateAnalysisLayers(this,"inputLayer","inputLayers")}(this.addAnalysisBrowseOption(),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),e=!1),(this.inputLayer||"ApplyRFxTemplate"===this.toolName)&&this._updateAnalysisLayerUI(e),p.set(this._chooseFolderRow,"display",!0===this.showSelectFolder?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(i.hitch(this,(function(e){this.folderStore=e,O.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})}))),this._chooseLayerTypeRow)&&(p.set(this._chooseLayerTypeRow,"display",!0===this.showSelectLayerType?"block":"none"),this.showDynamicLayerType&&this.showTiledLayerType?(t=new a({data:[{name:this.i18n.tiledLayer,id:"tiledLayer"},{name:this.i18n.permanentLayer.replace("Imagery layer","Dynamic imagery layer"),id:"dynamicLayer"}]}),this._webLayerTypeSelect.set("store",t),this._webLayerTypeSelect.set("value",this.outputType||"tiledLayer")):this.showDynamicLayerType?(t=new a({data:[{name:this.i18n.permanentLayer.replace("Imagery layer","Dynamic imagery layer"),id:"dynamicLayer"}]}),this._webLayerTypeSelect.set("store",t),this._webLayerTypeSelect.set("value",this.outputType||"dynamicLayer")):(t=new a({data:[{name:this.i18n.tiledLayer,id:"tiledLayer"}]}),this._webLayerTypeSelect.set("store",t),this._webLayerTypeSelect.set("value",this.outputType||"tiledLayer")));p.set(this._chooseExtentDiv,"display",!0===this.showChooseExtent?"inline-block":"none"),p.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this.inputLayer&&this.inputLayer.drawnLayer&&this._sourceDrawBtn&&this._sourceDrawBtn.set("pointFeatureLayer",this.inputLayer),this.isSingleTenant||(this._creditRunning=m.create("div",{class:"esriLoadingBar2"},this._saveBtn.domNode),y.set(this._creditRunning,"innerHTML",this.i18n.runAnalysis),p.set(this._creditRunning,{cursor:"none",backgroundColor:"#5daddd",marginLeft:"15%",margin:".5em 1em",display:"none"}),this._creditWarningContent=m.create("div"),this._creditWarningDlg=new _({content:this._creditWarningContent,title:this.i18n.raster,style:"width:40em",onHide:i.hitch(this,this._hideCreditRunning)}),this._creditWarningMsg=m.create("div",{},this._creditWarningContent),this._creditWarningBtns=m.create("div",{class:"esriFloatTrailing"},this._creditWarningMsg,"after"),this._yesBtn=m.create("div",{type:"Button",innerHTML:this.i18n.yesLabel,class:"btn calcite blue",onclick:i.hitch(this,this._runAnalysis)},this._creditWarningBtns),this._noBtn=m.create("div",{type:"Button",innerHTML:this.i18n.noLabel,class:"btn calcite",onclick:i.hitch(this,(function(){this._creditWarningDlg.hide()}))},this._creditWarningBtns),m.place(this._creditWarningDlg,this._usageDialog,"after")),this._setDefaultInputs()},addAnalysisBrowseOption:function(){if(this.browseType&&1===this.browseType.length&&this.browseType.indexOf(M.IS)>-1?O.addReadyToUseLayerOption(this,[{select:this._analysisSelect,disableLAAL:!0}]):O.addReadyToUseLayerOption(this,[this._analysisSelect]),this._aggregationFunctionSelect){var e=[];e.push({type:"separator",value:""}),e.push({value:"browserfts",label:this.i18n.browseRFTs}),this._aggregationFunctionSelect.addOption(e)}if(this._modelSelect){var t=[];t.push({type:"separator",value:""}),t.push({value:"browsedlpks",label:this.i18n.browseDLPKs}),this._modelSelect.addOption(t)}this.addBrowseOption()},getOptionsForRasterBrowseItems:function(e){return this.browseType.indexOf(M.FS)>-1?{browseValue:e}:{browseValue:e,disableLAAL:!0,disableBoundary:!0}},addBrowseOption:function(){},isImageServiceLayer:function(e){return e&&(e instanceof L||"esri.layers.ArcGISImageServiceLayer"===e.declaredClass||"esri.layers.RasterXLayer"===e.declaredClass)},validateTrendInputLayers:function(e){var t=this._validateTrendRasterLayers(e);l(t,(function(e){this.inputLayers=e}))},_validateTrendRasterLayers:function(e){var n,r=[],a=new t,l=0;return s.filter(e,i.hitch(this,(function(e){n=R({url:e.url+"/keyProperties",content:{f:"json"}}),r.push(n)}))),o(r).then(i.hitch(this,(function(t){s.forEach(t,i.hitch(this,(function(t,i){t&&t.TrendParameters&&t.TrendParameters.DimensionName||(e.splice(i-l,1),this._analysisSelect.removeOption(i-l),l++)}))),a.resolve(e)}))),a.promise},_loadConnections:function(){this.on("start",i.hitch(this,"_onClose",!1)),this._connect(this._closeBtn,"onclick",i.hitch(this,"_onClose",!0))},_connect:function(e,t,i){this._pbConnects.push(n.connect(e,t,i))},_isInputLayerImageServiceLayer:function(){return"esri.layers.ArcGISImageServiceLayer"===this.inputLayer.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===this.inputLayer.declaredClass||"esri.layers.RasterXLayer"===this.inputLayer.declaredClass},_outputLayerTCapabilities:function(){return this.showSelectLayerType&&this._webLayerTypeSelect&&"tiledLayer"===this._webLayerTypeSelect.get("value")?"Image, TilesOnly":!this.showDynamicLayerType&&this.showTiledLayerType?"Image, TilesOnly":"Image"}});return u("extend-esri")&&i.setObject("dijit.analysis.RasterAnalysisMixin",B,w),B}));