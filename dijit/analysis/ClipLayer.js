// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/fx","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","../../kernel","./AnalysisBase","./_AnalysisOptions","./CreditEstimator","./AnalysisToggleButton","./GroupToggleButton","./utils","./AnalysisRegistry","dojo/i18n!../../nls/jsapi","dojo/i18n!./nls/ClipLayer","dojo/text!./templates/ClipLayer.html"],(function(e,t,i,s,a,n,r,o,l,h,c,p,u,y,d,L,m,_,f,S,b,g,j,C,v,x,N,A,I,O,w,T,P,B,F,k,E,G,U,R,M){var J=t([m,_,f,S,b,P,T],{declaredClass:"esri.dijit.analysis.ClipLayer",templateString:M,widgetsInTemplate:!0,inputLayer:null,inputLayers:[],clipLayer:null,clipLayers:[],outputLayerName:null,i18n:null,toolName:"ClipLayer",helpFileName:"ClipLayer",resultParameter:"output",removeJobParamKeys:["clipExpressionObject"],constructor:function(e){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),s.forEach(this._pbConnects,a.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),i.mixin(this.i18n,U.common),i.mixin(this.i18n,U.analysisTools),i.mixin(this.i18n,R)},postCreate:function(){this.inherited(arguments),d.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",i.hitch(this,this.validateServiceName)),this.filterObjects=[{layer:"inputLayer",select:this._analysisSelect,expressionObj:"attributeExprObj"},{layer:"clipLayer",select:this._clipLayersSelect,expressionObj:"clipExpressionObject"}],this._buildUI()},startup:function(){},_loadConnections:function(){this.on("start",i.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",i.hitch(this,"_onClose",!1))},_connect:function(e,t,i){this._pbConnects.push(a.connect(e,t,i))},_buildUI:function(){this._loadConnections(),E.initHelpLinks(this.domNode,this.showHelp),this.get("showSelectAnalysisLayer")&&this._harmonizeLayerSelection(),this.rerun&&(this.outputLayerName=this.OutputName.serviceProperties.name,this._outputLayerInput.set("value",this.outputLayerName)),E.populateAnalysisLayers(this,"inputLayer","inputLayers"),this._populateClipLayersSelect("clipLayer","clipLayers"),E.addReadyToUseLayerOption(this,[this._analysisSelect,this._clipLayersSelect]),this.showSelectFolder&&this.getFolderStore().then(i.hitch(this,(function(e){this.folderStore=e,E.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})}))),c.set(this._chooseExtentDiv,"display",!0===this.showChooseExtent?"inline-block":"none"),c.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this._createFilterAndSelections()},_harmonizeLayerSelection:function(){var e,t=this.get("inputLayer"),i=this.get("inputLayers"),s=this.get("clipLayer"),a=this.get("clipLayers");if(t&&i&&!E.isLayerInLayers(t,i)&&i.push(t),s&&a&&!E.isLayerInLayers(s,a)&&a.push(s),!t&&i&&this.set("inputLayer",i[0]),!s&&a)for(e=0;e<a.length;e++)if(!E.isSameLayer(this.get("inputLayer"),a[e])){this.set("clipLayer",a[e]);break}},_populateClipLayersSelect:function(e,t){var i=[],a=this.get(e);this.get(t).length>0&&(s.forEach(this.clipLayers,(function(e,t){var s=!!E.isSameLayer(e,a);E.isSameLayer(e,this.get("inputLayer"))||i.push({value:t+"",label:e.name,selected:s})}),this),this._clipLayersSelect.addOption(i))},_updateClipLayersSelect:function(){var e;this._clipLayersSelect.removeOption(this._clipLayersSelect.getOptions()),this._populateClipLayersSelect("clipLayer","clipLayers"),E.addReadyToUseLayerOption(this,[this._clipLayersSelect]),(e=this._clipLayersSelect.get("value"))&&this.set("clipLayer",this.clipLayers[e])},_updateOutputLayerName:function(){this.inputLayer&&this.clipLayer?this.outputLayerName=h.substitute(this.i18n.outputLayerName,{inputLayerName:this.inputLayer.name,clipLayerName:this.clipLayer.name}):this.outputLayerName="",this._outputLayerInput.set("value",this.outputLayerName)},_updateAnalysisLayerUI:function(){this._analysisSelect&&this._updateClipLayersSelect()},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setClipLayerAttr:function(e){E.isSameLayer(this.inputLayer,e)||(this.clipLayer=e,this._updateOutputLayerName())},_setInputLayerAttr:function(e){this.inputLayer=e,this._updateOutputLayerName()},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_handleAnalysisLayerChange:function(e){this._isAnalysisSelect=!0,"browse"===e||"browselayers"===e?this._createBrowseItems({browseValue:e,disabledSubResources:[this.inputLayer]},{geometryTypes:[G.GeometryTypes.Point,G.GeometryTypes.Line,G.GeometryTypes.Polygon]},this._analysisSelect):""!==e&&(this.set("inputLayer",this.inputLayers[e]),this._updateAnalysisLayerUI())},_handleLayerChange:function(e){this._isAnalysisSelect=!1,"browse"===e||"browselayers"===e?this._createBrowseItems({browseValue:e,disabledSubResources:[this.clipLayer,this.inputLayer]},{tags:["polygon"],geometryTypes:[G.GeometryTypes.Polygon]},this._clipLayersSelect):""!==e&&(this.set("clipLayer",this.clipLayers[e]),this._updateAnalysisLayerUI())},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&E.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.clipLayers,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._clipLayersSelect,browseDialog:e.dialog||this._browsedlg,widget:this},t).then(i.hitch(this,(function(e){this._isAnalysisSelect&&this._isPolygon(e)&&this.clipLayers.push(e)})))},_buildJobParams:function(){var e={},t={};return e={inputLayer:n.toJson(this.constructAnalysisInputLyrObj(this.inputLayer)),clipLayer:n.toJson(this.constructAnalysisInputLyrObj(this.clipLayer))},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.extent=this.map.extent._normalize(!0)),this.returnFeatureCollection?t.outSR=this.map.spatialReference:e.OutputName=n.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}}),e.context=n.toJson(t),this._updateJobFilterAndSelection(e)},_buildExecuteObj:function(){var e={};return e.jobParams=this._buildJobParams(),e.itemParams={description:h.substitute(this.i18n.itemDescription,{inputLayerName:this.inputLayer.name,clipLayerName:this.clipLayer.name}),tags:h.substitute(this.i18n.itemTags,{inputLayerName:this.inputLayer.name,clipLayerName:this.clipLayer.name,outputLayerGeometry:this.inputLayer.geometryType}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(e.itemParams.folder=this.get("folderId")),this.showGeoAnalyticsParams&&(e.isSpatioTemporalDataStore=!0),e},_handleShowCreditsClick:function(e){},_handleSaveBtnClick:function(){var e;this._form.validate()&&(this.set("disableRunAnalysis",!0),e=this._buildExecuteObj(),this.execute(e))},_handleCloseMsg:function(e){e&&e.preventDefault(),r.fadeOut({node:this._errorMessagePane,easing:L.quadOut,onEnd:i.hitch(this,(function(){c.set(this._errorMessagePane,{display:"none"})}))}).play()},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_save:function(){},validateServiceName:function(e){return E.validateServiceName(e,{textInput:this._outputLayerInput,isItem:!this.returnFeatureCollection})},_isPolygon:function(e){return e.geometryType===G.GeometryTypes.Polygon}});return o("extend-esri")&&i.setObject("dijit.analysis.ClipLayer",J,w),J}));