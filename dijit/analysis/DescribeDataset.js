// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["../../kernel","./_AnalysisOptions","./AnalysisBase","./ItemTypes","./utils","./components/ToggleIconButtons","dijit/_FocusMixin","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/form/NumberSpinner","dijit/layout/ContentPane","dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/fx","dojo/_base/json","dojo/_base/lang","dojo/dom-attr","dojo/dom-style","dojo/dom-class","dojo/fx/easing","dojo/has","dojo/string","dojo/i18n!./nls/DescribeDataset","dojo/text!./templates/DescribeDataset.html"],(function(e,t,s,i,n,a,o,r,h,l,u,c,p,d,m,y,_,L,f,b,S,v,g,x,C,j,I,w,A,k,N,D){var O=S([l,h,u,r,o,t,s],{declaredClass:"esri.dijit.analysis.DescribeDataset",templateString:D,widgetsInTemplate:!0,inputLayer:void 0,inputLayers:[],extentOutput:!1,sampleSize:void 0,primaryActionButttonClass:"btn calcite primary",toolName:"DescribeDataset",helpFileName:"DescribeDataset",resultName:"",resultParameter:"output",returnProcessInfo:!0,constructor:function(e,t){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),f.forEach(this._pbConnects,b.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),x.mixin(this.i18n,N)},postCreate:function(){this.inherited(arguments),this._outputLayerInput.set("validator",x.hitch(this,this.validateServiceName)),this.filterObjects=[{layer:"inputLayer",select:this._inputLayerSelect,expressionObj:"attributeExprObj"}],this._buildUI()},startup:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_buildJobParams:function(){var e={};if(e.inputLayer=g.toJson(this.constructAnalysisInputLyrObj(this.inputLayer,this.showGeoAnalyticsParams)),this.get("extentOutput")&&(e.extentOutput=this.get("extentOutput")),this._sampleLayerCheck.get("value")&&(e.sampleSize=this.get("sampleSize")),e.returnProcessInfo=this.returnProcessInfo,this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.context=g.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection){var t={outSR:this.map.spatialReference};this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.extent=this.map.extent._normalize(!0)),e.context=g.toJson(t)}else e.OutputName=g.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}});return this._updateJobFilterAndSelection(e)},_handleSaveBtnClick:function(e){if(this._form.validate()){var t={};this._saveBtn.set("disabled",!0),t.jobParams=this._buildJobParams(),this.showGeoAnalyticsParams&&(t.isSpatioTemporalDataStore=!0);var s={description:k.substitute(this.i18n.itemDescription,{layerName:this.inputLayer.name||this.inputLayer.title}),tags:k.substitute(this.i18n.itemTags,{layerName:this.inputLayer.name||this.inputLayer.title}),snippet:this.i18n.itemSnippet};this.showSelectFolder&&(s.folder=this.get("folderId")),t.itemParams=s,this.execute(t)}},_handleShowCreditsClick:function(e){e.preventDefault(),this._form.validate()&&this.getCreditsEstimate(this.toolName,this._buildJobParams()).then(x.hitch(this,(function(e){this._usageForm.set("content",e),this._usageDialog.show()})))},_save:function(){},_buildUI:function(){this.signInPromise.then(x.hitch(this,n.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),this.get("showSelectAnalysisLayer")&&(this.inputLayer=this.setDefaultLayer(this.inputLayer,this.inputLayers),n.populateAnalysisLayers(this,"inputLayer","inputLayers",{layerSelect:this._inputLayerSelect})),n.addReadyToUseLayerOption(this,[this._inputLayerSelect]),j.set(this._chooseExtentDiv,"display",!0===this.showChooseExtent?"inline-block":"none"),j.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this._loadConnections(),this.sampleSize>0&&this._sampleLayerCheck.set("value",!0),this._extentLayerCheck.set("value",this.extentOutput),this._updateOutputLayerName(this.rerun),this._createFilterAndSelections()},_updateOutputLayerName:function(e){if(e)this._outputLayerInput.set("value",this.OutputName.serviceProperties.name);else if(this.inputLayer){var t=k.substitute(this.i18n.resultName,{layerName:this.inputLayer.name||this.inputLayer.title});this._outputLayerInput.set("value",t)}},_handleInputLayerChange:function(e){this.isAppendToLayerSelected=!0,this._checkBrowseLayer(e,!0)||(this.inputLayer=this.inputLayers[e]),this._updateOutputLayerName()},_handleSampleCheckChanged:function(e){e?(j.set(this._selectNoofSamplesRow,"display",""),this._sampleSizeInput.set("required",!0),I.add(this._sampleLayerLabel,"selected"),this._sampleSizeInput.set("constraints",{min:1,places:0}),this._handleNumberOfSamplesChange(this._sampleSizeInput.get("value"))):(this._sampleSizeInput.set("required",!1),j.set(this._selectNoofSamplesRow,"display","none"),I.remove(this._sampleLayerLabel,"selected"),this._sampleSizeInput.set("constraints",{}))},_handleExtentCheckChanged:function(e){e?I.add(this._extentLayerLabel,"selected"):I.remove(this._extentLayerLabel,"selected")},_handleNumberOfSamplesChange:function(e){void 0!==e&&this.set("sampleSize",e)},_checkBrowseLayer:function(e){return("browse"===e||"browselayers"===e)&&(this._createBrowseItems({browseValue:e,disabledSubResources:[this.inputLayer]},{layerTypes:[i.TABLE,i.BTABLE,i.FLAYER,i.BDATAFEATURE]},this._inputLayerSelect),!0)},setDefaultLayer:function(e,t){return e&&t&&!n.isLayerInLayers(e,t)&&t.push(e),e||!t||this.rerun?e:t[0]},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&n.addAnalysisReadyLayer({item:e.selection,layers:this.inputLayers,layersSelect:this._inputLayerSelect,browseDialog:e.dialog||this._browsedlg,posIncrement:0,widget:this},t)},_loadConnections:function(){this.on("start",x.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",x.hitch(this,"_onClose",!1))},_showMessages:function(e){C.set(this._bodyNode,"innerHTML",e),v.fadeIn({node:this._errorMessagePane,easing:w.quadIn,onEnd:x.hitch(this,(function(){j.set(this._errorMessagePane,{display:""})}))}).play(),window.setTimeout(x.hitch(this,this._handleCloseMsg),3e3)},_handleCloseMsg:function(e){e&&e.preventDefault(),v.fadeOut({node:this._errorMessagePane,easing:w.quadOut,onEnd:x.hitch(this,(function(){j.set(this._errorMessagePane,{display:"none"})}))}).play()},validateServiceName:function(e){return n.validateServiceName(e,{textInput:this._outputLayerInput})},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setInputLayerAttr:function(e){this.inputLayer=e},_setInputLayersAttr:function(e){this.inputLayers=e},_setExtentOutputAttr:function(e){this._extentLayerCheck.set("checked",!!e)},_getExtentOutputAttr:function(){return this._extentLayerCheck.get("checked")},_setSampleSizeAttr:function(e){void 0===e?this._sampleLayerCheck.set("value",!1):(this._sampleLayerCheck.set("value",!0),this._sampleSizeInput.set("value",e)),this.sampleSize=e},_getSampleSizeAttr:function(){return this.sampleSize},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_connect:function(e,t,s){this._pbConnects.push(b.connect(e,t,s))}});return A("extend-esri")&&x.setObject("dijit.analysis.DescribeDataset",O,e),O}));