// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.40/esri/copyright.txt for details.

define(["../../kernel","./AnalysisRegistry","./RasterAnalysisMixin","./utils","./ItemTypes","dijit/_FocusMixin","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/layout/ContentPane","dijit/form/Form","dijit/form/Select","esri/dijit/analysis/components/AddPointFeatures/AddPointFeatures","dijit/form/ValidationTextBox","dijit/form/FilteringSelect","dijit/form/CheckBox","dijit/form/Button","dijit/Dialog","esri/dijit/analysis/CreditEstimator","dojo/_base/array","dojo/_base/declare","dojo/_base/json","dojo/_base/lang","dojo/has","dojo/i18n!./nls/OptimalPathAsRaster","dojo/text!./templates/OptimalPathAsRaster.html"],(function(t,e,i,s,n,a,r,o,c,u,l,h,d,p,y,_,m,L,R,S,D,g,f,A,I,B,O){var F=g([c,o,u,r,a,i],{declaredClass:"esri.dijit.analysis.OptimalPathAsRaster",templateString:O,widgetsInTemplate:!0,browseType:[n.IS,n.FS],checkGeometries:[e.GeometryTypes.Point,e.GeometryTypes.Polygon,e.GeometryTypes.MultiPoint,e.GeometryTypes.Line],tags:["point","line","polygon"],map:null,drawSourcePointLayerName:"",toolName:"OptimalPathAsRaster",helpFileName:"OptimalPathAsRaster",toolNlsName:B,rasterGPToolName:"OptimalPathAsRaster",outputName:"outputRasterName",resultParameter:"outputRaster",constructor:function(t,e){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode)},_removePointLayer:function(){this.sourcePointLayer&&this._removeLayer(this.sourcePointLayer,this.inputLayers,this._analysisSelect),this._sourceDrawBtn.deactivate()},_getJobParameters:function(){var t=s.constructAnalysisInputLyrObj(this.get("inputLayer"));this.inputLayer.drawnLayer&&(t.drawnLayer=this.inputLayer.drawnLayer);var e=f.toJson(s.constructAnalysisInputLyrObj(this.get("inputBackDirectionRaster"))),i=s.constructAnalysisInputLyrObj(this.get("inputDistanceAccumulationRaster"));return this.get("inputDistanceAccumulationRaster").drawnLayer&&(i.drawnLayer=this.get("inputDistanceAccumulationRaster").drawnLayer),{inputDestinationRasterOrFeatures:f.toJson(t),inputBackDirectionRaster:e,inputDistanceAccumulationRaster:f.toJson(i),destinationField:this.destinationField,pathType:this._pathTypeSelect.get("value")}},_setDefaultInputs:function(){this.inputBackDirectionRaster&&this.inputBackDirectionRasters&&!s.isLayerInLayers(this.inputBackDirectionRaster,this.inputBackDirectionRasters)&&this.inputBackDirectionRasters.push(this.inputBackDirectionRaster),this._addInputCostRasterLayerOptions(),this._setDefaultInputCostRaster(),this._addDestinationLayerOptions(),this._addDestinationFields(),this._pathTypeSelect.set("value",this.pathType),this._outputLayerInput.set("value",this.outputRasterName&&this.outputRasterName.serviceProperties.name),this.drawSourcePointLayerName||(this.drawSourcePointLayerName=this.i18n.drawSourcePointLayerName),this.inputLayer&&this.inputLayer.drawnLayer&&(this._sourceDrawBtn.set("pointFeatureLayer",this.inputLayer),this.sourcePointLayer=this.inputLayer),this._sourceDrawBtn.set("map",this.map),this._sourceDrawBtn.on("change",A.hitch(this,this._handleSourceDrawLayer)),this._destinationSelect.set("isValid",A.hitch(this,this._isValid))},_setDefaultInputCostRaster:function(){this.inputBackDirectionRaster||(this.inputBackDirectionRaster=this.inputBackDirectionRasters[0])},_handleSourceDrawLayer:function(t){this._clearSelectedPointSelectLayer(!0),this.inputLayers&&0!==this.inputLayers.length&&-1!==this.inputLayers.indexOf(t)||(this.sourcePointLayer=t,this.inputLayers.push(t),this.inputLayer=t,this._analysisSelect.removeOption(this._analysisSelect.getOptions()),s.populateAnalysisLayers(this,"inputLayer","inputLayers"),this._addDestinationLayerOptions())},_clearSelectedPointSelectLayer:function(t){!t&&this.sourcePointLayer&&this._sourceDrawBtn.reset()},_isValid:function(){return"placeholder"===this._destinationSelect.value?(this._destinationSelect._missingMsg=this.toolNlsName.missingMessage,!1):(this._destinationSelect._missingMsg=this.toolNlsName.noValueMessage,!this._destinationSelect.required||0===this._destinationSelect.value||!/^\s*$/.test(this._destinationSelect.value||""))},_updateSelectOptionsForDrawLayer:function(t,e){var i=this.inputLayers.length,s=this._destinationSelect.getOptions();return this._destinationSelect.removeOption(s),(s=D.map(s,(function(t){return t.selected=!1,t}))).push({value:i.toString(),label:e.name,selected:!0}),this.inputLayers.push(e),this._destinationSelect.addOption(s),i},_addInputCostRasterLayerOptions:function(){var t=[];this._inputBackDirectionRasterSelect.removeOption(this._inputBackDirectionRasterSelect.getOptions()),D.forEach(this.inputBackDirectionRasters,A.hitch(this,(function(e,i){this._isSelected(this.inputBackDirectionRaster,this.inputLayer)||t.push({label:e.name,value:i.toString(),selected:this._isSelected(e,this.inputBackDirectionRaster)})}))),this._inputBackDirectionRasterSelect.addOption(t),this.addBrowseOption(),this._handleInputCostRasterChange(this._inputBackDirectionRasterSelect.get("value"))},_addDestinationLayerOptions:function(){this.inputDistanceAccumulationRaster&&this.destinationRasters&&!s.isLayerInLayers(this.inputDistanceAccumulationRaster,this.destinationRasters)&&this.destinationRasters.push(this.inputDistanceAccumulationRaster),this._destinationSelect.removeOption(this._destinationSelect.getOptions()),this._destinationSelect.addOption(this._getDestinationLayerOptions()),this.addBrowseOption(),this._handleDestinationAnalysisLayerChange(this._destinationSelect.get("value"))},_addDestinationFields:function(){if(this._destinationFieldSelect.removeOption(this._destinationFieldSelect.getOptions()),this._destinationFieldSelect._setDisplay(""),this.inputLayer){var t=this.destinationField?[{alias:this.destinationField,name:this.destinationField,type:e.FieldTypes.Integer}]:[];if(this._isInputLayerImageServiceLayer())this.inputLayer.hasRasterAttributeTable?(t=this.inputLayer._rasterAttributeTableFields)&&0!==t.length||(t=[{alias:"VALUE",name:"VALUE",type:e.FieldTypes.Integer}]):t="VALUE"===this.destinationField?[{alias:"VALUE",name:"VALUE",type:e.FieldTypes.Integer}]:t;else if(!(t=this.inputLayer.fields))return;var i=[];D.forEach(t,(function(t){if(t.type===e.FieldTypes.Integer||t.type===e.FieldTypes.Short||t.type===e.FieldTypes.ObjectId){var s=void 0!==this.destinationField?t.type===e.FieldTypes.ObjectId:t.name===this.destinationField;i.push({value:t.name,label:t.alias||t.name,selected:s})}}),this),this._destinationFieldSelect.addOption(i),this.destinationField=this._destinationFieldSelect.get("value")}},_getDestinationLayerOptions:function(){var t=[];return D.forEach(this.destinationRasters,A.hitch(this,(function(e,i){this._isSelected(e,this.inputLayer)||this._isSelected(e,this.inputDistanceAccumulationRaster)?this._isSelected(e,this.inputDistanceAccumulationRaster)&&(this._isSelected(e,this.inputLayer)?t.push({label:this.toolNlsName.placeHolder,value:"placeholder",selected:!0,disabled:!0}):t.push({label:e.name,value:i.toString(),selected:!0})):t.push({label:e.name,value:i.toString(),selected:!1})}))),t},_handleInputCostRasterChange:function(t){"browselayers"===t||"browse"===t?(this._isAnalysisSelect=!1,this._isCostRasterSelect=!0,this.defaultItemTypes=[],this.set("allowedItemTypes",[n.IS]),this._createBrowseItems({browseValue:t,disableLAAL:!0,disableBoundary:!0,disabledSubResources:[this.inputBackDirectionRaster]},{},this._inputBackDirectionRasterSelect)):t>=0&&this.set("inputBackDirectionRaster",this.inputBackDirectionRasters[t])},_handleDestinationAnalysisLayerChange:function(t){"browselayers"===t||"browse"===t?(this._isAnalysisSelect=!1,this._isCostRasterSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",[n.IS]),this._createBrowseItems({browseValue:t,disabledSubResources:[this.inputLayer,this.inputDistanceAccumulationRaster]},{customCheck:{customCheckHandler:A.hitch(this,(function(t){return!s.isSameLayer(t,this.inputLayer)}))}},this._destinationSelect)):"placeholder"===t?(this.set("inputDistanceAccumulationRaster",void 0),this._destinationSelect.validate(!0)):t>=0&&this.set("inputDistanceAccumulationRaster",this.destinationRasters[t]),this._addDestinationFields()},_handleDestinationFieldChange:function(t){this.set("destinationField",t)},_handleBrowseItemsSelect:function(t,e){t&&t.selection&&s.addAnalysisReadyLayer({item:t.selection,layers:this._isAnalysisSelect?this.inputLayers:this._isCostRasterSelect?this.inputBackDirectionRasters:this.destinationRasters,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._isCostRasterSelect?this._inputBackDirectionRasterSelect:this._destinationSelect,browseDialog:this._browseLyrsdlg||this._browsedlg,widget:this},e).always(A.hitch(this,(function(){this._isAnalysisSelect?this._handleAnalysisLayerChange(this._analysisSelect.get("value")):this._isCostRasterSelect?this._handleInputCostRasterChange(this._inputBackDirectionRasterSelect.get("value")):this._handleDestinationAnalysisLayerChange(this._destinationSelect.get("value"))})))},_resetUI:function(){this._addDestinationLayerOptions(),this._addDestinationFields()},addBrowseOption:function(){s.addReadyToUseLayerOption(this,[{select:this._inputBackDirectionRasterSelect},{select:this._destinationSelect}])},isFloat:function(t){return t.pixelType&&["F32","F64"].indexOf(t.pixelType)>=0},isIntegerRaster:function(t){return this.isPixelTypeDefined(t)&&!1===this.isFloat(t)},_isSelected:function(t,e){return e&&t&&e.url===t.url&&t.name===e.name},isPixelTypeDefined:function(t){return t.pixelType&&"UNKNOWN"!==t.pixelType},_setInputLayerAttr:function(t){this.inputLayer=t},_getInputLayerAttr:function(){return this.inputLayer},_setInputDistanceAccumulationRasterAttr:function(t){this.inputDistanceAccumulationRaster=t,this._isSelected(t,this.inputLayer)&&this._resetUI()},_getInputDistanceAccumulationRasterAttr:function(){return this.inputDistanceAccumulationRaster},_setInputLayersAttr:function(t){this.inputLayers=D.filter(t,(function(t){return t.geometryType===e.GeometryTypes.Point||t.geometryType===e.GeometryTypes.Line||t.geometryType===e.GeometryTypes.Polygon||this.isIntegerRaster(t)}),this),this.set("inputBackDirectionRasters",t),this.set("destinationRasters",t)},_getInputLayersAttr:function(t){return this.inputLayers},_getInputBackDirectionRasterAttr:function(){return this.inputBackDirectionRaster},_setInputBackDirectionRasterAttr:function(t){this.isImageServiceLayer(t)&&(this.inputBackDirectionRaster=t)},_getInputBackDirectionRastersAttr:function(){return this.inputBackDirectionRasters},_setInputBackDirectionRastersAttr:function(t){this.inputBackDirectionRasters=D.filter(t,(function(t){return this.isImageServiceLayer(t)}),this)},_getInputDistanceAccumulationRastersAttr:function(){return this.destinationRasters},_setInputDistanceAccumulationRastersAttr:function(t){this.destinationRasters=D.filter(t,(function(t){return this.isImageServiceLayer(t)}),this)},_setOutputPolylineNameAttr:function(t){this.outputPolylineName=t},_getOutputPolylineNameAttr:function(){return this._outputLayerInput.get("value")},_setPathTypeAttr:function(t){this.pathType=t},_getPathTypeAttr:function(){return this.pathType},_setDrawSourcePointLayerNameAttr:function(t){this.drawSourcePointLayerName=t},_getDrawSourcePointLayerNameAttr:function(){return this.drawSourcePointLayerName},_setDestinationFieldAttr:function(t){this.destinationField=t},_getDestinationFieldAttr:function(t){return this.destinationField}});return I("extend-esri")&&A.setObject("dijit.analysis.OptimalPathAsRaster",F,t),F}));