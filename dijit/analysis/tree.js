define(["dojo/_base/declare","dojo/_base/array","dojo/_base/Deferred","dojo/_base/lang","dojo/query","dojo/on","dojo/has","dojo/aspect","dgrid/util/has-css3","dgrid/Grid","dojo/has!touch?dgrid/util/touch","put-selector/put","../../kernel"],function(e,n,d,r,t,i,o,a,l,s,c,u,h){function p(e,n,d){var r,t=this.grid.isRTL?"right":"left",i=".dgrid-expando-icon";return n&&(i+=".ui-icon.ui-icon-triangle-1-"+(d?"se":"e")),r=u("div"+i+"[style=margin-"+t+": "+e*(this.indentWidth||9)+"px; float: "+t+"]"),r.innerHTML="&nbsp;",r}function g(e){var n=this,d=this.style.height;d&&(this.style.display="0px"==d?"none":"block"),e&&(u(this,".dgrid-tree-resetting"),setTimeout(function(){u(n,"!dgrid-tree-resetting")})),this.style.height=""}function f(e){var r,o,h=e.renderCell||s.defaultRenderCell;return e||(e={}),e.shouldExpand=e.shouldExpand||function(e,n,d){return d},a.after(e,"init",function(){var s=e.grid,h=".dgrid-content .dgrid-column-"+e.id,f=[];if(s.cleanEmptyObservers=!1,!s.store)throw new Error("dgrid tree column plugin requires a store to operate.");e.renderExpando||(e.renderExpando=p),f.push(s.on(e.expandOn||".dgrid-expando-icon:click,"+h+":dblclick,"+h+":keydown",function(e){var n=s.row(e);s.store.mayHaveChildren&&!s.store.mayHaveChildren(n.data)||"keydown"==e.type&&32!=e.keyCode||"dblclick"==e.type&&o&&o.count>1&&n.id==o.id&&e.target.className.indexOf("dgrid-expando-icon")>-1||s.expand(n),e.target.className.indexOf("dgrid-expando-icon")>-1&&(o&&o.id==s.row(e).id?o.count++:o={id:s.row(e).id,count:1})})),l("touch")&&f.push(s.on(c.selector(h,c.dbltap),function(){s.expand(this)})),s._expanded||(s._expanded={}),f.push(a.after(s,"insertRow",function(n){var d=this.row(n),t=e.shouldExpand(d,r,this._expanded[d.id]);return t&&this.expand(n,!0,!0),n})),f.push(a.before(s,"removeRow",function(e,n){var d=e.connected;d&&(t(">.dgrid-row",d).forEach(function(e){s.removeRow(e,!0)}),n||u(d,"!"))})),e.collapseOnRefresh&&f.push(a.after(s,"cleanup",function(){this._expanded={}})),s._calcRowHeight=function(e){var n=e.connected;return e.offsetHeight+(n?n.offsetHeight:0)},s.expand=function(n,r,o){var a=n.element?n:s.row(n),c=l("transitionend");if(n=a.element,n=n.className.indexOf("dgrid-expando-icon")>-1?n:t(".dgrid-expando-icon",n)[0],n&&n.mayHaveChildren&&(o||r!==!!this._expanded[a.id])){var h=void 0===r?!this._expanded[a.id]:r;u(n,".ui-icon-triangle-1-"+(h?"se":"e")+"!ui-icon-triangle-1-"+(h?"e":"se"));var p,f,x,v=n.preloadNode,y=a.element,m={originalQuery:this.query};if(!v){p=y.connected=u("div.dgrid-tree-container"),v=n.preloadNode=u(y,"+",p,"div.dgrid-preload");var w=function(e){return s.store.getChildren(a.data,e)};e.allowDuplicates&&(m.parentId=a.id),"level"in n&&(w.level=n.level),d.when(s.renderQuery?s._trackError(function(){return s.renderQuery(w,v,m)}):s.renderArray(w(m),v,"level"in w?{queryLevel:w.level}:{}),function(){if(s._expanded[a.id]&&c){var e=p.scrollHeight;p.style.height=e?e+"px":"auto"}}),c?i(p,c,g):g.call(p)}p=y.connected,p.hidden=!h,f=p.style,!c||o?(f.display=h?"block":"none",f.height=""):(h?(f.display="block",x=p.scrollHeight,f.height="0px"):(u(p,".dgrid-tree-resetting"),f.height=p.scrollHeight+"px"),setTimeout(function(){u(p,"!dgrid-tree-resetting"),f.height=h?x?x+"px":"auto":"0px"})),h?this._expanded[a.id]=!0:delete this._expanded[a.id]}},a.after(e,"destroy",function(){n.forEach(f,function(e){e.remove()}),delete s.expand,delete s._calcRowHeight})}),e.renderCell=function(n,d,t,i){var o,a,l=e.grid,s=Number(i&&i.queryLevel)+1,c=!l.store.mayHaveChildren||l.store.mayHaveChildren(n),u=i.parentId;s=r=isNaN(s)?0:s,o=e.renderExpando(s,c,l._expanded[(u?u+"-":"")+l.store.getIdentity(n)],n),o.level=s,o.mayHaveChildren=c,i.level=s,a=h.call(e,n,d,t,i),t.insertBefore(o,t.firstChild)},e}return f.defaultRenderExpando=p,o("extend-esri")&&r.setObject("dijit.analysis.tree",f,h),f});