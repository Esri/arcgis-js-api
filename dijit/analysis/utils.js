// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/fx","dojo/_base/json","dojo/_base/kernel","dojo/dom-attr","dojo/has","dojo/i18n","dojo/io-query","dojo/i18n!../../nls/jsapi","dojo/json","dojo/string","dojo/query","dojo/date/locale","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/promise/all","dojo/fx/easing","dojo/number","dojo/_base/window","dojo/when","dojo/dom","dojo/on","dojo/data/ItemFileWriteStore","dojo/topic","dojo/store/Memory","dojox/mvc/equals","dijit/registry","dijit/Dialog","dijit/form/CheckBox","../../kernel","../../lang","../../units","../../request","./HelpWindow","../../tasks/query","../../dijit/BrowseItems","../../layers/FeatureLayer","./PluginAnalysisLayers","../../tasks/Geoprocessor","../../dijit/SingleFilter","./FeatureRecordSetLayer","./PluginLayers","./PCSList","./ItemTypes","../../layers/ArcGISImageServiceLayer","../../layers/RasterXLayer","../../layers/RasterFunction","./AnalysisRegistry","../RasterFunctionEditor/utils"],(function(e,i,t,s,n,a,r,o,l,d,u,c,m,y,p,h,g,f,b,v,T,w,S,L,I,E,D,M,x,F,_,A,N,R,k,P,O,C,U,B,j,G,V,W,H,Q,q,K,Y,J,z,X,$,Z,ee){var ie={},te=0,se=1,ne=2;return i.mixin(ie,{_helpDialog:null,systemRFTGroupName:"Raster Function Templates",i18n:null,UNITSMAP:{Feet:"esriFeet",Yards:"esriYards",Miles:"esriMiles",Meters:"esriMeters",Kilometers:"esriKilometers",NauticalMiles:"esriNauticalMiles"},initHelpLinks:function(e,t,s){if(e){var a=N.byNode(e),r=a?a.get("helpFileName"):s&&s.helpFileName?s.helpFileName:null,o=a?a.get("isSingleTenant"):!(!s||!s.isSingleTenant)&&s.isSingleTenant,d=Z.Modes.standard,u=a&&a.portalSelf?a.portalSelf.helpBase:s&&s.helpBase?s.helpBase:null,c=a&&a.portalSelf;this._helpDialog||(this._helpDialog=new B({isPortal:o,portalSelf:c})),a&&(a.showGeoAnalyticsParams||a.showBigData)||s&&s.analysisMode&&s.analysisMode===Z.Modes.Bigdata?(r+="_bd",d=Z.Modes.Bigdata):s&&s.analysisMode&&"raster"===s.analysisMode&&(r+="_ra",d=Z.Modes.Raster),h("[esriHelpTopic]",e).forEach((function(c,m,y){c&&(f.set(c,"display",O.isDefined(t)&&!0!==t?"none":""),O.isDefined(c._helpClickHandler)&&(c._helpClickHandler.remove(),c._helpClickHandler=null),c._helpClickHandler=M(c,"click",i.hitch(this,(function(i){n.stop(i),s&&s.showHelpFromUrl&&s.helpUrl?this._helpDialog.show(i,{showHelpFromUrl:s.showHelpFromUrl,helpUrl:s.helpUrl}):this._helpDialog.show(i,{helpId:l.get(c,"esriHelpTopic"),helpFileName:r,analysisGpServer:s&&s.analysisGpServer?s.analysisGpServer:null,helpParentNode:e,isPortal:o,analysisMode:d,helpBase:u,portalSelf:a&&a.portalSelf})}))))}),this)}},constructAnalysisFeatColl:function(e){var t,s={};for(t in s.featureCollection=e.layerDefinition,s.featureCollection)s.featureCollection.hasOwnProperty(t)&&"objectIdField"===t&&(s.featureCollection.objectIdFieldName=i.clone(s.featureCollection.objectIdField),delete s.featureCollection.objectIdField);return s.featureCollection.features=e.featureSet.features,s},constructAnalysisInputLyrObj:function(e,t,s){if(e instanceof z||"Image Service"===e.type||"esri.layers.RasterXLayer"===e.declaredClass)return ee.getRasterJsonFromLayer(e);var n,a,r,o={},l="";if(O.isDefined(s)||(s=!0),e.getMap?r=e.getMap():e._map&&(r=e._map),e.url&&!e._collection)o={url:e.url},this.isHostedService(e.url),e.version>=10.2&&e._useStandardizedQueries,e.getDefinitionExpression&&e.getDefinitionExpression()?o.filter=e.getDefinitionExpression():O.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&(o.filter=e.definitionExpression),e.useMapTime&&e.timeInfo&&r&&r.timeExtent&&s&&(r.timeExtent.startTime?(l+=r.timeExtent.startTime.getTime(),r.timeExtent.endTime&&(l+=","+r.timeExtent.endTime.getTime())):r.timeExtent.endTime&&(l+=r.timeExtent.endTime.getTime()),l&&(o.time=l)),e.credential&&(o.serviceToken=e.credential.token),-1!==o.url.indexOf("?")&&(n=o.url.substring(o.url.indexOf("?")+1,o.url.length),a=c.queryToObject(n),i.mixin(o,a),o.url=o.url.substring(0,o.url.indexOf("?")));else if(!e.url||e._collection)try{o=e.toJson()}catch(i){e._json=y.parse(e._json),o=e.toJson()}return o.name=e.name,t&&(o=new q(o)),o},formatDate:function(e){return g.format(e,{datePattern:"yyyy-MM-dd",selector:"date"})+" "+g.format(e,{selector:"time",timePattern:"HH:mm:ss"})},isHostedService:function(e){if(!e)return!1;var i=-1!==e.indexOf(".arcgis.com/"),t=-1!==e.indexOf("/services")||-1!==e.indexOf("//tiles")||-1!==e.indexOf("//features");return i&&t},isPortalHostedService:function(e){if(!e)return!1;return-1!==e.toLowerCase().indexOf("/hosted/")},isTimeEnabled:function(e){var i=e.version>=10.2&&e._useStandardizedQueries;return e.useMapTime&&e.timeInfo&&(i||e.version>=10.2)||O.isDefined(e.time)},isTimeInstantLayer:function(e){return O.isDefined(e.timeInfo)&&O.isDefined(e.timeInfo.startTimeField)&&!O.isDefined(e.timeInfo.endTimeField)||O.isDefined(e.time)&&O.isDefined(e.time.timeType)&&"instant"===e.time.timeType},buildReport:function(e,s){var n="";return s||(s={},i.mixin(s,m.analysisMsgCodes)),t.forEach(e,(function(e,a){var r,o,l;"string"==typeof e.message?(r=O.isDefined(s[e.messageCode])?s[e.messageCode]:e.message,n+=e.style.substring(0,e.style.indexOf("</"))+(this._isEmptyObject(e.params)?r:p.substitute(r,e.params))+e.style.substring(e.style.indexOf("</"))):i.isArray(e.message)&&(l=[],o=i.clone(e.style),t.forEach(e.message,(function(i,t){o=o.replace(/<\//,"${"+t+"}"),r=O.isDefined(s[e.messageCode+"_"+t])?s[e.messageCode+"_"+t]:i,"string"==typeof(r=this._isEmptyObject(e.params)?r:p.substitute(r,e.params))&&(r=this.safetagsReplace(r)),l.push(r+"</")}),this),o=p.substitute(o,l),n+=o)}),this),n},getLayerFeatureCount:function(e,i){var t=new j,s=new T;return i||(i={}),t.geometry=i.geometry,t.geometryType=i.geometryType||"esriGeometryEnvelope",e.url||t.geometry?(e.url&&(t.where=i.where||"1=1",e.getDefinitionExpression&&e.getDefinitionExpression()&&!i.where?t.where=e.getDefinitionExpression():O.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&!i.where&&(t.where=e.definitionExpression)),s=e.queryCount(t)):s.resolve(e.graphics.length),s.promise},createPolygonFeatureCollection:function(e){var i;return(i={layerDefinition:null,featureSet:{features:[],geometryType:Z.GeometryTypes.Polygon}}).layerDefinition={currentVersion:10.2,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:Z.GeometryTypes.Polygon,minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},i},createPointFeatureCollection:function(e){var i;return(i={layerDefinition:null,featureSet:{features:[],geometryType:Z.GeometryTypes.Point}}).layerDefinition={objectIdField:"OBJECTID",templates:[],type:"Feature Layer",drawingInfo:{renderer:{field1:"TYPEID",type:"simple",symbol:{height:24,xoffset:0,yoffset:12,width:24,contentType:"image/png",type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/GreenStickpin.png"},description:"",value:"0",label:"Stickpin"}},displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",types:[],geometryType:Z.GeometryTypes.Point,fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},i},createFolderStore:function(e,i){var s=new x({data:{identifier:"id",label:"name",items:[]}});return s.newItem({name:i,id:""}),t.forEach(e,(function(e){s.newItem({name:e.title,id:e.id})})),s},setupFoldersUI:function(e){e.folderSelect.set("store",e.folderStore),e.folderSelect.set("required",!0),e.folderSelect.set("searchAttr","name"),O.isDefined(e.folderId)?e.folderStore.get(e.folderId).then(i.hitch(this,(function(i){O.isDefined(i)?e.folderSelect.set("item",i):e.folderStore.get("").then((function(i){e.folderSelect.set("item",i)}),this)}))):e.folderName?e.folderStore.fetch({query:{name:e.folderName},onComplete:i.hitch(this,(function(i){O.isDefined(i)&&i.length>0?e.folderSelect.set("item",i[0]):e.folderStore.get("").then((function(i){e.folderSelect.set("item",i)}),this)}))}):e.username?e.folderSelect.set("displayedValue",e.username):e.folderStore.get("").then((function(i){e.folderSelect.set("item",i)}),this)},_isEmptyObject:function(e){var i;for(i in e)if(e.hasOwnProperty(i))return!1;return!0},validateServiceName:function(e,i){var t,s,n,a=/(:|&|<|>|%|#|\?|\\|\"|\/|\+|=|\*|@|\'|;|\||,)/g.test(e),r=!0,o=!0;if(O.isDefined(i)&&i.textInput&&(s=i.textInput),O.isDefined(i)&&O.isDefined(i.isItem)&&(o=i.isItem),this.initI18n(),0===e.length||0===p.trim(e).length)t=this.i18n.requiredValue,r=!1;else if(a)t=this.i18n.invalidServiceName,r=!1;else if(o&&e.length>98)t=this.i18n.invalidServiceNameLength,r=!1;else if(o&&encodeURIComponent(e).length>170){for(n=e+"";encodeURIComponent(n).length>170;)n=n.substring(0,n.length-1);t=p.substitute(this.i18n.suggestedServiceNameLength,{count:n.length}),r=!1}return s&&!r&&s.set("invalidMessage",t),r},getStepNumber:function(e){h(".esriAnalysisNumberLabel",e).forEach((function(e,i){var t=this._getNumberLabel(i);l.set(e,"innerHTML",t)}),this)},_getNumberLabel:function(e){var i="";switch(this.initI18n(),e){case 0:i=this.i18n.oneLabel;break;case 1:i=this.i18n.twoLabel;break;case 2:i=this.i18n.threeLabel;break;case 3:i=this.i18n.fourLabel;break;case 4:i=this.i18n.fiveLabel;break;case 5:i=this.i18n.sixLabel;break;case 6:i=this.i18n.sevenLabel;break;case 7:i=this.i18n.eightLabel;break;case 8:i=this.i18n.nineLabel;break;case 9:i=this.i18n.tenLabel;break;case 10:i=this.i18n.elevenLabel;break;case 11:i=this.i18n.twelveLabel;break;case 12:i=this.i18n.thirteenLabel}return i},populateAnalysisLayers:function(e,s,n,a){if(e){var r=[],o=e.get(s),l=a&&a.layerSelect?a.layerSelect:e._analysisSelect;e.rerun&&!o&&(a||(a={}),a.chooseBlank=!0),e._titleRow&&f.set(e._titleRow,"display","none"),e._analysisLabelRow&&f.set(e._analysisLabelRow,"display","table-row"),e._selectAnalysisRow&&(f.set(e._selectAnalysisRow,"display","table-row"),f.set(e._analysisSelect.domNode.parentNode,"padding-bottom","1em")),e.domNode&&this.getStepNumber(e.domNode),O.isDefined(a)&&a.chooseLabel&&r.push({value:-1,label:this.i18n.chooseLabel}),O.isDefined(a)&&a.chooseBlank&&r.push({value:"  ",label:""}),O.isDefined(a)&&O.isDefined(a.posIncrement)||(O.isDefined(a)||(a={}),a.posIncrement=0),e.get(n)||e.set(n,[]),t.forEach(e.get(n),(function(e,i){i+=a.posIncrement;var t={value:O.isDefined(a)&&a.chooseLabel?""+i+1:""+i,label:e.name};o&&(e.name===o.name||e.url&&o.url&&e.url===o.url)&&(t.selected=!0),r.push(t)}),this),l.addOption(r),l.set("required",!0),a.chooseBlank&&"  "===l.get("value")&&setTimeout(i.hitch(this,this._validateSelectUI,l),100)}},isValidAnalysisLayer:function(e){var i,s,n,a,r,o,l,d,u,c,m,y,h,g="",f=!0,b={isValid:f,validationMessage:g},v=0,T=0,w=0,S=!0;return O.isDefined(e)&&O.isDefined(e.toolName)?(this.initI18n(),i=e.toolName,s=e.layers,n=e.analysisLayer,a=i.charAt(0).toLowerCase()+i.substring(1),l=this.i18n,c=e.showReadyToUseLayers||!1,t.forEach(s,(function(e){S=!1,(e instanceof z||"esri.layers.RasterXLayer"===e.declaredClass)&&(m=!0),m&&e.bandCount>1&&(y=!0),m&&1===e.bandCount&&(h=!0),e.geometryType===Z.GeometryTypes.Point&&(o=!0,v++),e.geometryType!==Z.GeometryTypes.Point&&e.geometryType!==Z.GeometryTypes.MultiPoint||(d=!0),e.geometryType===Z.GeometryTypes.Line&&(u=!0,w++),e.geometryType===Z.GeometryTypes.Polygon&&(r=!0,T++)}),this),-1!==t.indexOf(["CreateDriveTimeAreas","PlanRoutes","ConnectOriginsToDestinations"],i)&&(!o||n&&n.geometryType!==Z.GeometryTypes.Point)?(g=p.substitute(this.i18n.selectPointLayer,{toolName:l[a]}),f=!1):"AggregatePoints"!==i&&"InterpolatePoints"!==i||(!n||n.geometryType===Z.GeometryTypes.Point||n.geometryType===Z.GeometryTypes.MultiPoint)&&d?"CalculateDensity"===i&&(!d&&!u||n&&n.geometryType!==Z.GeometryTypes.Point&&n.geometryType!==Z.GeometryTypes.MultiPoint&&n.geometryType!==Z.GeometryTypes.Line)?(g=p.substitute(this.i18n.areaFeatureInvalidMsg,{toolName:l[a]}),f=!1):"FindHotSpots"!==i&&"FindOutliers"!==i||c||!(!d&&!r||n&&n.geometryType!==Z.GeometryTypes.Point&&n.geometryType!==Z.GeometryTypes.MultiPoint&&n.geometryType!==Z.GeometryTypes.Polygon)?"OverlayLayers"!==i&&"AggregatePoints"!==i&&"SummarizeWithin"!==i&&"SummarizeNearby"!==i&&"FindNearest"!==i&&"MergeLayers"!==i||c||0!==s.length&&(1!==s.length||s[0]!==n&&O.isDefined(n))?"ConnectOriginsToDestinations"===i&&!c&&(S||v<2)?(g=p.substitute(this.i18n.odPointMsg,{toolName:l[a]}),f=!1):this.isFindCentroids(i)&&this.isPointLayer(n)?(g=p.substitute(this.i18n.selectNoPointLayer,{toolName:l[a]}),f=!1):"AggregatePoints"===i&&!c&&s.length>1?(r=t.some(s,(function(e){return e.geometryType===Z.GeometryTypes.Polygon})))||(g=p.substitute(this.i18n.aggregatePolyMsg,{toolName:l[a]}),f=!1):"MergeLayers"===i&&!c&&s.length>1?v>1||w>1||T>1||(g=this.i18n.mergeValidationMsg,f=!1):"SummarizeWithin"!==i&&"DissolveBoundaries"!==i||(!n||n.geometryType===Z.GeometryTypes.Polygon)&&r||c?"ExtractData"===i?(f=t.some(s,(function(e){return-1!==e.capabilities.indexOf("Extract")})))||(g=p.substitute(this.i18n.extractValidationMsg)):("ConnectOriginsToDestinations"===i||i===Z.Tools.ChooseBestFacilities)&&s.length>1?(o=t.some(s,(function(e){var i=O.isDefined(n)&&n.id===e.id;return e.geometryType===Z.GeometryTypes.Point&&!i})))||(g=p.substitute(i===Z.Tools.ChooseBestFacilities?this.i18n.selectPointLayer:this.i18n.odPointMsg,{toolName:l[a]}),f=!1):"CalculateSlope"===i||"DeriveAspect"===i||"RemapValues"===i?m?h||(f=!1,g=p.substitute(this.i18n.noSingleBandISMsg,{toolName:l[a]})):(f=!1,g=p.substitute(this.i18n.noImageServiceMsg,{toolName:l[a]})):"ExtractRaster"===i?m||(f=!1,g=p.substitute(this.i18n.noImageServiceMsg,{toolName:l[a]})):"MonitorVegetation"===i&&(m?y||(f=!1,g=p.substitute(this.i18n.noMultiBandISMsg,{toolName:l[a]})):(f=!1,g=p.substitute(this.i18n.noImageServiceMsg,{toolName:l[a]}))):(g=p.substitute(this.i18n.selectPolyLayer,{toolName:l[a]}),f=!1):(g=p.substitute(this.i18n.overlayValidationMsg,{toolName:l[a]}),f=!1):(g=p.substitute(this.i18n.hotspotsLineFeatureMsg,{toolName:l[a]}),f=!1):(g=p.substitute(this.i18n.selectPointLayer,{toolName:l[a]}),f=!1),b={isValid:f,validationMessage:g}):b},isFindCentroids:function(e){return e===Z.Tools.FindCentroids},isPointLayer:function(e){return e&&e.geometryType===Z.GeometryTypes.Point},initI18n:function(){this.i18n||(this.i18n={},i.mixin(this.i18n,m.common),i.mixin(this.i18n,m.analysisTools),i.mixin(this.i18n,m.analysisMsgCodes),i.mixin(this.i18n,m.browseLayersDlg),i.mixin(this.i18n,m.driveTimes),i.mixin(this.i18n,m.calculateFields))},addBrowseAnalysisDialog:function(e){if(e&&e.widget){this.i18n||this.initI18n();var t,s,n,a,r,o,l,d,u="esri/dijit/analysis/PluginAnalysisLayers",c=I.doc.createDocumentFragment(),m=v.create("div",{style:"width:100%;height:100%;"},c),y=v.create("div",{style:"width:100%;height:10%;",class:""}),p=v.create("div",{style:"width:100%"},m),h=this._isCustomAnalysisQuery(e.widget);1===e.browseType?(u="esri/dijit/analysis/PluginLayers",o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:u,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),itemsPerPage:100,demandList:!0,extent:e.widget.get("map").extent,useExtent:!1,fetchTimeout:600,galleryTemplate:"<div class='listServiceTitle'><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%'><td nowrap='nowrap'>  <div  style=\"position:absolute;left:80px; top:10px; width:1px; height:1px; background: transparent;\"></div><div style='overflow:hidden;'><a style=\"height:16px;\">${item.title}</a></div></td></tr></table><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%' class='bottomRowTable'><td width='20'>  <span class='esriAlignLeading'>${item:_formatThumbnail}</span></td><td nowrap='nowrap'>  <span class='esriAlignLeading' style='color:#656565;'>${item.owner}</span></td><td style='padding-right:5px;padding-left:3px;'></td></tr></table></div>",showInfoPanel:!0,isAutoClose:!1,checkIsButtonEnabled:!0,formatThumbnail:function(e){return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+e.iconUrl+"'/>"},formatInfoPanelImage:function(e){return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+e.iconUrl+"'/>"},class:"esriAnalysisLayersItems"}):o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:u,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),pagingLinks:1,rowsPerPage:6,class:"esriBrowseAnalysisLayers itemsGallery esriFloatLeading",extent:e.widget.get("map").extent,useExtent:!h,fetchTimeout:600,galleryTemplate:"<div style='opacity:1;' class='grid-item gallery-view galleryNode'>${item:_formatItemTitle}${item:_formatThumbnail}"+'<div class="linksDiv" style=\'display:none;\'><div class="esriItemLinks"><div class="esriFloatLeading"><a style="text-decoration: none;"><span>Add layer to analysis</span><div class="dijitReset dijitInline esriArrows"></div></a></div></div></div>',formatItemTitle:function(e){return'<div class="galleryLabelContainer"><span alt=\''+(e.title||e.name||"<No Title>")+"'>"+(e.title.replace(/_/g," ")||e.name.replace(/_/g," ")||"<No Title>")+"</span></div>"},showInfoPanel:!1,showTooltip:!0,formatThumbnail:function(e){return"<img class='grid-item galleryThumbnail' width='120px' height='80px' alt='' src='"+(e.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png")+"'>"},style:"width:48em;height:100%;clear:both;"},r=v.toDom('<div class="esriBrowseOptions">'),v.place(r,y),d=v.create("div",{class:"esriBrowseOption"},r),e.browseType&&1===e.browseType||(l=v.create("div",{class:"esriBrowseOption"},r),s=new k({name:"addlayer",id:e.widget.id+(e.browseType?e.browseType:"")+"_addlayercheck",class:"",value:!1,checked:!1},v.create("input",{},l)),v.create("label",{for:e.widget.id+"_addlayercheck",class:"esriBrowseOption_label",innerHTML:this.i18n.addLayer},l));var g=!0;return e.browseType&&1===e.browseType?g=!1:h&&(g=!1),a=new k({name:"extentcheck",id:e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck",class:"",value:g,checked:g},v.create("input",{},d)),v.create("label",{for:e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck",class:"esriBrowseOption_label",innerHTML:this.i18n.withinMapArea},d),o.messageRight=y,t=new G(o,p),a.on("change",i.hitch(this,(function(e){t.set("useExtent",e)}))),n=new R({title:1===e.browseType?this.i18n.browseLayers:h?this.i18n.browseAnalysisLayers:this.i18n.browseAnalysisTitle,content:m,browseItems:t,addlayerCheckBox:s,style:e.browseType&&1===e.browseType?"":"padding:.75em 0;background-color: #fff;width:50em;"}),e.widget.own(n.on("hide",i.hitch(n,(function(e){n.browseItems.reset()})))),n}},addAnalysisReadyLayer:function(e,s){if(O.isDefined(e)&&O.isDefined(e.item)&&O.isDefined(e.layersSelect)&&O.isDefined(e.layers)&&O.isDefined(e.browseDialog)){var n,a,r,o,l,d,u,c;e.browseDialog.hide&&e.browseDialog.hide(),(n=!e.item.selectedLayer&&e.item.url?e.item.type===J.IS?e.item.url:e.item.url+"/0":e.item.selectedLayer.url)&&-1!==window.location.protocol.indexOf("https:")&&(n=n.replace("http:","https:")),a={url:n,itemId:e.item.id,title:e.item.title,type:e.item.type,analysisReady:!0},o=t.some(e.layers,(function(i,t){var s=i.analysisReady&&a.analysisReady&&i.itemId===a.itemId;return e.item.selectedLayer&&e.item.selectedLayer.url&&(s=i.itemId&&a.itemId?i.itemId===a.itemId&&i.url===a.url:i.url===a.url),s&&(r=t),s})),e.browseDialog.browseItems&&h(".js-add-layer-checkbox",e.browseDialog.browseItems.infoPanel).forEach((function(e){c=e.checked}));var m=-1!==e.layersSelect.baseClass.indexOf("dijitComboBox");return l=new T,u="sync",o?(e.posIncrement&&(r+=e.posIncrement),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||c||s)&&(e.posIncrement||(e.posIncrement=0),d=e.layers[r-e.posIncrement],e.widget.map.getLayer(d.lyr.id)||(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",i.hitch(this,(function(i){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:i.layer,layerInfo:d.linfo,item:d})}))),e.widget.map.addLayer(d.lyr))),m?e.layersSelect.set("value",e.layers[r-1].name):e.layersSelect.set("value",""+r),e.browseDialog.browseItems&&e.browseDialog.browseItems.clear(),l.resolve()):e.item.selectedLayer?(a.url=e.item.selectedLayer.url,l.then(i.hitch(this,y)),setTimeout((function(){l.resolve(e.item.selectedLayer)}),500)):(u=e.item.itemDataUrl?U({url:e.item.itemDataUrl,content:{f:"json"}}):"sync",E(u,i.hitch(this,(function(e){e&&e.layers&&e.layers[0].id&&(a.url=a.url.substring(0,a.url.lastIndexOf("/0"))+"/"+e.layers[0].id),U({url:a.url,content:{f:"json"}}).then(i.hitch(this,(function(e){y(e),l.resolve()})))})))),l.promise}function y(t){var n,r,o,l;if("Feature Service"===a.type&&(l=new V(a.url,{outFields:["*"]}),i.mixin(a,l)),"Image Service"===a.type&&(l=t.capabilities.indexOf("TilesOnly")>-1?new X(a.url,{outFields:["*"]}):new z(a.url,{outFields:["*"]}),i.mixin(a,l)),i.mixin(a,t),a.id=a.title+"_"+t.id,e.item.selectedLayer?a.title=a.title+"-"+t.name:a.title=a.title.replace(/_/g," "),a.name=a.title,a.version=a.currentVersion,m&&e.widget.showBrowseLayers){var d=e.layersSelect.get("store");p=2,n=(o=d&&d.data).splice(o.length-p,p);var u={id:o.length,label:a.title,name:a.title,url:a.url};o.push(u),o=o.concat(n);var y=new _({data:o,idProperty:"id"});e.layersSelect.set("store",y),e.layersSelect.set("value",u.name)}else{var p;o=e.layersSelect.getOptions(),e.widget.useArcGISComponents&&(e.widget.showBrowseLayers||e.widget.showReadyToUseLayers)?p=2:e.widget.showBrowseLayers&&e.widget.showReadyToUseLayers?p=3:(e.widget.showBrowseLayers||e.widget.showReadyToUseLayers)&&(p=2),n=o.splice(o.length-p,p),e.layersSelect.removeOption(n),r=e.layers.length,e.posIncrement&&(r+=e.posIncrement),r=""+r,n.unshift({value:r,label:a.title,selected:!0}),e.layersSelect.addOption(n),e.layersSelect.set("value",r)}l&&(a.lyr=l,l.name=a.name),a.linfo=t,e.layers.push(a),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||c||s)&&(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",i.hitch(this,(function(i){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:i.layer,layerInfo:t,item:a})}))),e.widget.map.addLayer(l)),e.browseDialog.browseItems&&e.browseDialog.browseItems.clear()}},addReadyToUseLayerOption:function(e,s){e&&(e.showReadyToUseLayers||e.showBrowseLayers)&&(s||(s=[]),e.signInPromise||(e.signInPromise=new T,setTimeout(i.hitch(this,(function(){e.signInPromise.resolve()})),100)),e.i18n||(this.initI18n(),e.i18n=this.i18n),e.signInPromise.then(i.hitch(this,(function(){t.forEach(s,(function(i){var s=i.select||i;if(-1!==s.baseClass.indexOf("dijitComboBox")&&e.showBrowseLayers){var n=s.get("store");n&&(n.put({id:"separator",name:"separator",label:"<hr>"}),n.put({id:"browselayers",name:"browselayers",label:e.i18n.browseLayers}))}else{var a=s.getOptions();t.some(a,(function(e){return"separator"===e.type}),this)||!e.showReadyToUseLayers&&!e.showBrowseLayers||s.addOption({type:"separator",value:""}),this.addBrowseOptionForTool({select:s,disableLAAL:i.disableLAAL},e)}}),this),e.showReadyToUseLayers&&!O.isDefined(e._browsedlg)&&(e._browsedlg=this.addBrowseAnalysisDialog({widget:e}),e.own(e._browsedlg.browseItems.on("select-change",i.hitch(e,e._handleBrowseItemsSelect)),e._browsedlg.on("hide",i.hitch(e,(function(){t.forEach(s,(function(e){"browse"===e.get("value")&&e.reset()})),e.layersSelect&&e.layersSelect.reset()}))))),e.showBrowseLayers&&!O.isDefined(e._browseLyrsdlg)&&(e._browseLyrsdlg=this.addBrowseAnalysisDialog({widget:e,browseType:1}),e.own(e._browseLyrsdlg.on("browseitems-close",i.hitch(this,(function(i){"add-layer"===i.action&&(e._browseLyrsdlg.browseItems.plugIn._grid&&(i.selection.selectedLayer=e._browseLyrsdlg.browseItems.plugIn._selectedLayer,e._handleBrowseItemsSelect({dialog:e._browseLyrsdlg,selection:i.selection})),e._browseLyrsdlg.browseItems.closeInfoPanel())}))),e._browseLyrsdlg.on("hide",i.hitch(e,(function(){t.forEach(s,(function(e){"browselayers"===e.get("value")&&e.reset()}))})))))}))))},addBrowseOptionForTool:function(e,i){var s=e.select,n=e.disableLAAL||!1,a=s.getOptions(),r=[],o=!1;if(!t.some(a,(function(e){return"browselayers"===e.value||"browse"===e.value}),this)){if((a.length>0&&"separator"!==a[a.length-1].type||0===a.length)&&(r.push({type:"separator"}),o=!0),i.useArcGISComponents&&(i.showBrowseLayers||i.showReadyToUseLayers))r.push({value:"browselayers",label:i.i18n.browseAnalysisLayers});else{if(!n&&i.showReadyToUseLayers){var l=i.i18n.browseAnalysisTitle;this._isCustomAnalysisQuery(i)&&(l=i.i18n.browseAnalysisLayers),r.push({value:"browse",label:l})}i.showBrowseLayers&&r.push({value:"browselayers",label:i.i18n.browseLayers})}(!0===o&&r.length>1||!1===o&&r.length>0)&&s.addOption(r)}},_isCustomAnalysisQuery:function(e){var i='title:"Living Atlas Analysis Layers" AND owner:esri',t=!1;return e&&e.isSingleTenant&&(i='title:"Living Atlas Analysis Layers" AND owner:esri_livingatlas'),e.portalSelf&&e.portalSelf.analysisLayersGroupQuery&&e.portalSelf.analysisLayersGroupQuery!==i?t=!0:e._portal&&e._portal.analysisLayersGroupQuery&&e._portal.analysisLayersGroupQuery!==i&&(t=!0),t},getMaxInputByMode:function(e){if(e&&e.units&&e.type&&e.limits&&e.travelMode){var i,t,s,n,a=e.limits.maximumBreakDistanceValue,r=e.limits.maximumBreakDistanceValueUnits,o=e.limits.maximumBreakTimeValue,l=e.limits.maximumBreakTimeValueUnits,d=this.isWalkingTravelMode(e.travelMode.travelMode);return d&&(a=e.limits.maximumBreakWalkingDistanceValue,r=e.limits.maximumBreakWalkingDistanceValueUnits,o=e.limits.maximumBreakWalkingTimeValue,l=e.limits.maximumBreakWalkingTimeValueUnits),"reachableStreets"===e.alternateLimits&&(a=(n=this.generateLimitsForReachableStreets({limits:e.limits,isWalking:d})).driveDistanceLimit,r=n.driveDistanceUnit,o=n.driveTimeLimit,l=n.driveTimeUnit),"unreachableAreas"===e.alternateLimits&&(a=(n=this.generateLimitsForUnreachableAreas({limits:e.limits,isWalking:d})).driveDistanceLimit,r=n.driveDistanceUnit,o=n.driveTimeLimit,l=n.driveTimeUnit),t=o*this.perMinute(l),s=a*this.perMile(r),"StraightLine"===e.type?"Miles"===e.units?i=1e3:"Yards"===e.units?i=176e4:"Kilometers"===e.units?i=L.format(1609.344,{places:2}):"Meters"===e.units?i=L.format(1609344,{places:2}):"Feet"===e.units&&(i=528e4):this.isDistanceMode(e.travelMode)?"Miles"===e.units?i=s:"Yards"===e.units?i=1760*s:"Kilometers"===e.units?i=L.format(1.609344*s,{places:2}):"Meters"===e.units?i=L.format(1.609344*s*1e3,{places:2}):"Feet"===e.units&&(i=5280*s):this.isTimeMode(e.travelMode)&&("Minutes"===e.units?i=t:"Seconds"===e.units?i=60*t:"Hours"===e.units&&(i=t/60)),"string"==typeof i?L.parse(i):parseFloat(i)}},isWalkingTravelMode:function(e){if(e&&e.restrictionAttributeNames)return e.restrictionAttributeNames.some((function(e){return"walking"===e.toLowerCase()}))},isDistanceMode:function(e){return"Distance"===e.units},isTimeMode:function(e){return"Time"===e.units},generateLimitsForUnreachableAreas:function(e){var i={driveDistanceLimit:null,driveDistanceUnit:null,driveTimeLimit:null,driveTimeUnit:null};return e.isWalking?(i.driveDistanceLimit=e.limits.maximumBreakWalkingDistanceValueDetailedPolygons,i.driveDistanceUnit=e.limits.maximumBreakWalkingDistanceValueUnitsDetailedPolygons,i.driveTimeLimit=e.limits.maximumBreakWalkingTimeValueDetailedPolygons,i.driveTimeUnit=e.limits.maximumBreakWalkingTimeValueUnitsDetailedPolygons):(i.driveDistanceLimit=e.limits.maximumBreakDistanceValueDetailedPolygons,i.driveDistanceUnit=e.limits.maximumBreakDistanceValueUnitsDetailedPolygons,i.driveTimeLimit=e.limits.maximumBreakTimeValueDetailedPolygons,i.driveTimeUnit=e.limits.maximumBreakTimeValueUnitsDetailedPolygons),i},generateLimitsForReachableStreets:function(e){var i={driveDistanceLimit:null,driveDistanceUnit:null,driveTimeLimit:null,driveTimeUnit:null};return e.isWalking?(i.driveDistanceLimit=e.limits.maximumBreakWalkingDistanceValueServiceAreaLines,i.driveDistanceUnit=e.limits.maximumBreakWalkingDistanceValueUnitsServiceAreaLines,i.driveTimeLimit=e.limits.maximumBreakWalkingTimeValueServiceAreaLines,i.driveTimeUnit=e.limits.maximumBreakWalkingTimeValueUnitsServiceAreaLines):(i.driveDistanceLimit=e.limits.maximumBreakDistanceValueServiceAreaLines,i.driveDistanceUnit=e.limits.maximumBreakDistanceValueUnitsServiceAreaLines,i.driveTimeLimit=e.limits.maximumBreakTimeValueServiceAreaLines,i.driveTimeUnit=e.limits.maximumBreakTimeValueUnitsServiceAreaLines),i},updateModeConstraints:function(e){var i;e&&e.validateWidget&&e.units&&e.type&&e.travelMode&&((i=e.validateWidget.get("constraints")).max=this.getMaxInputByMode(e),e.validateWidget.set(i))},getTravelModes:function(e){var s,n,a,o=new T;return O.isDefined(this.travelModes)&&this.travelModes.length>0?o.resolve(this.travelModes):e&&e.widget?e.widget.signInPromise.then(i.hitch(this,(function(l){(a=e.widget.get("helperServices"))&&a.routingUtilities?(n=a.routingUtilities.url,s="sync"):s=e.widget._getSelf(e.widget.portalUrl),E(s,i.hitch(this,(function(e){e&&e.helperServices&&e.helperServices.routingUtilities&&(n=e.helperServices.routingUtilities.url),O.isDefined(n)?new H(n+"/GetTravelModes").execute({}).then(i.hitch(this,(function(e){var i=e[0].value&&e[0].value.features;this.travelModes=t.map(i,(function(e){return r.fromJson(e.attributes.TravelMode)})),e[1]&&e[1].paramName&&"defaultTravelMode"===e[1].paramName&&(this.defaultTravelModeId=e[1].value),o.resolve(this.travelModes)})),i.hitch(this,(function(e){o.reject(e)}))):o.reject(new Error("Missing Routing Utility Service to get Travel Modes"))})),(function(e){o.reject(e)}))}))):o.reject(new Error("Missing parameter: params.widget required parameter")),o.promise},populateTravelModes:function(e){if(e&&e.selectWidget&&e.widget){var s=[],n=e.allowmode||"all",a=!1;this.initI18n(),e.addStraightLine&&s.push({value:"StraightLine",label:'<div class="esriFloatLeading bufferIcon esriStraightLineDistanceIcon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+this.i18n.straightLineDistance+"</div>",selected:e.value&&"StraightLine"===e.value}),this.getTravelModes({widget:e.widget}).then(i.hitch(this,(function(i){var r=O.isDefined(e.enableTravelModes)&&!e.enableTravelModes;t.forEach(i,(function(i,t){var o=this.createOptionForTravelMode(i,{name:i.name,disabled:r,separator:e.separator});this.isTravelModeAllowed(n,o.units)&&("all"!==n&&(o.value=o.value.replace(o.units,"")),e.value&&e.value.id===i.id?A(e.value,i)&&(o.selected=!o.disabled,a=!0):!e.value&&e.selectDefaultMode&&this.defaultTravelModeId&&this.defaultTravelModeId===i.id&&(o.selected=!0),s.push(o))}),this),!a&&this.isRequiredToAddTravelMode(e)&&this.isTravelModeAllowed(n,this.getTravelModeUnits(e.value))&&s.push(this.getOptionForCustomTravelMode(e,r)),e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.widget.emit("travelmodes-added",{travelOptions:s})})),i.hitch(this,(function(i){s&&s.length>0&&(e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.widget.emit("travelmodes-added",{travelOptions:s}))})))}},getTravelModeLabel:function(e,i){var t=i||e.name;return'<div class="esriFloatLeading bufferIcon esri'+this.getTravelModei18nKey(e.type)+this.getTravelModeUnits(e)+'Icon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;" title="'+e.description+'">'+t+"</div>"},getTravelModeUnits:function(e){e.units||name.split(/\s/)[1];return e.impedanceAttributeName===e.timeAttributeName?"Time":e.impedanceAttributeName===e.distanceAttributeName?"Distance":"Other"},getTravelModeValue:function(e,i){return i=i||"",e.replace(/\s/g,i)},getTravelModei18nKey:function(e){return"AUTOMOBILE"===e?"Driving":"TRUCK"===e?"Trucking":"WALK"===e?"Walking":"Other"},isTravelModeAllowed:function(e,i){return"all"===e||e.toLowerCase()===i.toLowerCase()},isRequiredToAddTravelMode:function(e){return e.widget.rerun&&"StraightLine"!==e.value},isTrafficBasedTravelMode:function(e){var i=this.getTravelModei18nKey(e.type).toLowerCase();return"time"===this.getTravelModeUnits(e).toLowerCase()&&("driving"===i||"trucking"===i)},getOptionForCustomTravelMode:function(e,i){var t="&lt"+e.value.name+"&gt",s=this.createOptionForTravelMode(e.value,{name:t,disabled:i,separator:e.separator});return s.selected=!0,s},createOptionForTravelMode:function(e,i){return{label:this.getTravelModeLabel(e,i.name),value:this.getTravelModeValue(i.name,i.separator),travelMode:e,disabled:i.disabled,modei18nKey:this.getTravelModei18nKey(e.type).toLowerCase(),units:this.getTravelModeUnits(e)}},updateDisplay:function(e,i,t){new h.NodeList(e).style("display",i?t||"block":"none")},isGreaterThanZero:function(){return this.get("value")>0},getExprFunctions:function(){return this.i18n||this.initI18n(),this.exprFunctions||(this.exprFunctions=[{type:"NumType",label:p.substitute(this.i18n.asMetersFunc,{functionName:"as_meters(<i>number</i>)",num:"<i>number</i>"}),name:"as_meters()"},{type:"NumType",label:p.substitute(this.i18n.asKilometersFunc,{functionName:"as_kilometers(<i>number</i>)",num:"<i>number</i>"}),name:"as_kilometers()"},{type:"NumType",label:p.substitute(this.i18n.asFeetFunc,{functionName:"as_feet(<i>number</i>)",num:"<i>number</i>"}),name:"as_feet()"},{type:"NumType",label:p.substitute(this.i18n.asYardsFunc,{functionName:"as_yards(<i>number</i>)",num:"<i>number</i>"}),name:"as_yards()"},{type:"NumType",label:p.substitute(this.i18n.asMilesFunc,{functionName:"as_miles(<i>number</i>)",num:"<i>number</i>"}),name:"as_miles()"},{type:"NumType",label:p.substitute(this.i18n.asNuaticalMilesFunc,{functionName:"as_nautical_miles(<i>number</i>)",num:"<i>number</i>"}),name:"as_nautical_miles()"},{type:"NumType",label:p.substitute(this.i18n.absFunc,{functionName:"abs(<i>number</i>)",num:"<i>number</i>"}),name:"abs()"},{type:"NumType",label:p.substitute(this.i18n.logFunc,{functionName:"log(<i>number</i>)",num:"<i>number</i>"}),name:"log()"},{type:"NumType",label:p.substitute(this.i18n.sinFunc,{functionName:"sin(<i>number</i>)",num:"<i>number</i>"}),name:"sin()"},{type:"NumType",label:p.substitute(this.i18n.cosFunc,{functionName:"cos(<i>number</i>)",num:"<i>number</i>"}),name:"cos()"},{type:"NumType",label:p.substitute(this.i18n.tanFunc,{functionName:"tan(<i>number</i>)",num:"<i>number</i>"}),name:"tan()"},{type:"NumType",label:p.substitute(this.i18n.squareRootFunc,{functionName:"sqrt(<i>number</i>)",num:"<i>number</i>"}),name:"sqrt()"},{type:"NumType",label:p.substitute(this.i18n.minFunc,{functionName:"min(<i>number</i>)",num:"<i>number</i>"}),name:"min()"},{type:"NumType",label:p.substitute(this.i18n.maxFunc,{functionName:"max(<i>number</i>)",num:"<i>number</i>"}),name:"max()"},{type:"NumType",label:p.substitute(this.i18n.constrainFunc,{functionName:"constrain(<i>number</i>, <i>low</i>, <i>high</i>",num:"<i>number</i>",low:"<i>low</i>",high:"<i>high</i>"}),name:"constrain(,,)"},{type:"NumType",label:p.substitute(this.i18n.iffFunc,{functionName:"iif(<i>condition</i>,<i>value if TRUE</i>,<i>value if FALSE</i>)",num:"<i>number</i>"}),name:"iif(,,)"},{type:"NumType",label:p.substitute(this.i18n.whenFunc,{functionName:"when(<i>number</i>)",num:"<i>number</i>"}),name:"when(,)"},{type:"NumType",label:p.substitute(this.i18n.decodeFunc,{functionName:"decode(<i>expression</i>, <i>case1,return1,..caseN,returnN</i>, <i>default</i>)",num:"<i>number</i>"}),name:"decode(,,,)"}]),this.exprFunctions},addAttributeOptions:function(e){this.initI18n(),O.isDefined(e.allowSelectLabel)||(e.allowSelectLabel=!0);var i,s,n,a=[],r=O.isDefined(e.emptyValue)?e.emptyValue:"";(e.allowNumericType||void 0===e.allowNumericType)&&(a=[Z.FieldTypes.Short,Z.FieldTypes.Integer,Z.FieldTypes.Float,Z.FieldTypes.Double]),i=e.layer,s=e.selectWidget,n=i?i.fields:[],s.removeOption(s.getOptions()),e.allowSelectLabel&&s.addOption({value:r,label:this.i18n.attribute}),e.allowStringType&&a.push(Z.FieldTypes.String),e.allowDateType&&a.push(Z.FieldTypes.Date);var o=[];return t.forEach(n,(function(e){-1!==t.indexOf(a,e.type)&&e.name!==i.objectIdField&&o.push({value:e.name,label:O.isDefined(e.alias)&&""!==e.alias?e.alias:e.name,type:e.type===Z.FieldTypes.String?Z.PseudoFieldTypes.String:e.type===Z.FieldTypes.Date?Z.PseudoFieldTypes.Date:Z.PseudoFieldTypes.Number})}),this),0!==o.length&&(s.addOption(o),O.isDefined(e.priorityChange)?s.set("value",r,e.priorityChange):s.set("value",r),s.set("disabled",!i||0===i.fields.length),!0)},addStatisticsOptions:function(e){this.initI18n();var i=e.selectWidget,t=[{value:"SUM",label:this.i18n.sum},{value:"MIN",label:this.i18n.minimum},{value:"MAX",label:this.i18n.maximum},{value:"MEAN",label:e.showGeoAnalyticsParams?this.i18n.mean:this.i18n.average},{value:"STDDEV",label:this.i18n.standardDev}],s=[{value:"MIN",label:this.i18n.minimum},{value:"MAX",label:this.i18n.maximum}],n=[{value:"First",label:this.i18n.first},{value:"Last",label:this.i18n.last}],a=O.isDefined(e.emptyValue)?e.emptyValue:"";i.removeOption(i.getOptions()),i.addOption([{value:a,label:this.i18n.statistic}]),e.showGeoAnalyticsParams&&(i.addOption({value:"COUNT",label:this.i18n.count}),t.push({value:"VARIANCE",label:this.i18n.variance}),t.splice(4,0,{value:"RANGE",label:this.i18n.range})),e.showFirstLastStats&&i.addOption(n),e.type&&"number"!==e.type?e.type&&"string"===e.type?(i.addOption({value:"ANY",label:this.i18n.any}),e.selectWidget.optionsType="string"):e.type&&"date"===e.type&&(i.addOption(s),e.selectWidget.optionsType="date"):(i.addOption(t),e.selectWidget.optionsType="number"),i.set("value",a)},addFillOptions:function(e){var i=e.selectWidget,t=[{value:"ZEROES",label:this.i18n.zeroes},{value:"SPATIAL_NEIGHBORS",label:this.i18n.spatialneighbhors},{value:"SPACE_TIME_NEIGHBORS",label:this.i18n.spacetimeneighbors},{value:"TEMPORAL_TREND",label:this.i18n.temporaltrend}];i.removeOption(i.getOptions()),i.addOption([{value:"0",label:this.i18n.fill}]),e.type&&"number"!==e.type||i.addOption(t)},perMeter:function(e){var i=1;switch(e){case C.MILLIMETERS:i=1e3;break;case C.CENTIMETERS:i=100;break;case C.DECIMETERS:i=10;break;case C.METERS:i=1;break;case C.KILOMETERS:i=.001;break;case C.INCHES:i=39.370079;break;case C.FEET:i=3.2808399;break;case C.YARDS:i=1.0936133;break;case C.MILES:i=.00062137119;break;case C.NAUTICAL_MILES:i=.0005399568;break;case C.ACRES:i=.00024710538;break;case C.ARES:i=.01;break;case C.HECTARES:i=1e-4;break;case C.SQUARE_INCHES:i=1550.0031;break;case C.SQUARE_FEET:i=10.7639104;break;case C.SQUARE_YARDS:i=1.19599005;break;case C.SQUARE_MILES:i=3.86102159e-7;break;case C.SQUARE_NAUTICAL_MILES:i=2.9155335e-7;break;case C.SQUARE_MILLIMETERS:i=1e6;break;case C.SQUARE_CENTIMETERS:i=1e4;break;case C.SQUARE_DECIMETERS:i=100;break;case C.SQUARE_METERS:i=1;break;case C.SQUARE_KILOMETERS:i=1e-6}return i},perMile:function(e){var i=1;switch(e){case"Feet":i=189394e-9;break;case"Yards":i=568182e-9;break;case"Meters":i=621371e-9;break;case"Kilometers":i=.621371}return i},perMinute:function(e){var i=1;switch(e){case"Seconds":i=.0166667;break;case"Hours":i=60}return i},getType:function(e){var i=null;switch(e){case C.ACRES:case C.ARES:i=ne;break;case C.CENTIMETERS:case C.DECIMETERS:case C.FEET:i=se;break;case C.HECTARES:i=ne;break;case C.INCHES:case C.KILOMETERS:case C.METERS:case C.MILES:case C.MILLIMETERS:case C.NAUTICAL_MILES:i=se;break;case C.SQUARE_CENTIMETERS:case C.SQUARE_DECIMETERS:case C.SQUARE_FEET:case C.SQUARE_INCHES:case C.SQUARE_KILOMETERS:case C.SQUARE_METERS:case C.SQUARE_MILES:case C.SQUARE_MILLIMETERS:case C.SQUARE_NAUTICAL_MILES:case C.SQUARE_YARDS:i=ne;break;case C.YARDS:i=se;break;default:i=te}return i},unitConversion:function(e,i,t){var s=!0;O.isDefined(e)||(this.emitError("The 'From' Value must be a valid numeric value: "+e),s=!1),O.isDefined(i)||(this.emitError("The 'From' Units must be defined: "+i),s=!1),O.isDefined(t)||(this.emitError("The 'To' Units must be defined: "+t),s=!1),e instanceof Array&&(this.emitError("Only single 'From' Value supported: "+e),s=!1),i instanceof Array&&(this.emitError("Only single 'From' Units supported: "+i),s=!1),t instanceof Array&&(this.emitError("Only single 'To' Units supported: "+t),s=!1);var n=this.getType(i),a=this.getType(t);return n===te&&(this.emitError("Unsupported 'From' Units: "+i),s=!1),a===te&&(this.emitError("Unsupported 'To' Units: "+t),s=!1),n!==a&&(this.emitError("Incompatible 'From' and 'To' Units: "+i+" and "+t),s=!1),s?i===t?+e:+e/this.perMeter(i)*this.perMeter(t):Number.NaN},emitError:function(e){console.log("error",new Error(e))},isEmpty:function(e){for(var i in e)if(e.hasOwnProperty(i))return!1;return y.stringify(e)===y.stringify({})},getRoutingUtilities:function(e){var s,n,a,r=new T,o={};return e||r.reject(new Error("Missing parameter: widget required parameter")),-1!==t.indexOf(["CreateDriveTimeAreas","EnrichLayer","SummarizeNearby"],e.toolName)?i.mixin(o,{toolName:"GenerateServiceAreas",serviceName:"asyncServiceArea"}):e.toolName===Z.Tools.ChooseBestFacilities?i.mixin(o,{toolName:"SolveLocationAllocation",serviceName:"asyncLocationAllocation"}):"PlanRoutes"===e.toolName?i.mixin(o,{toolName:"SolveVehicleRoutingProblem",serviceName:"asyncVRP"}):"FindNearest"===e.toolName?i.mixin(o,{toolName:"FindClosestFacilities",serviceName:"asyncClosestFacility"}):"ConnectOriginsToDestinations"===e.toolName&&i.mixin(o,{toolName:"FindRoutes",serviceName:"asyncRoute"}),this.routingUtilities||(this.routingUtilities={}),this.routingUtilities&&this.routingUtilities[e.toolName]?r.resolve(this.routingUtilities[e.toolName]):e.signInPromise.then(i.hitch(this,(function(t){(a=e.get("helperServices"))&&a.routingUtilities?(n=a.routingUtilities.url,s="sync"):s=e._getSelf(e.portalUrl),E(s,i.hitch(this,(function(t){t&&t.helperServices&&t.helperServices.routingUtilities&&(n=t.helperServices.routingUtilities.url),O.isDefined(n)||r.reject(new Error("Missing Routing Utility Service to get Network Analysis Service Limits.")),new H(n+"/GetToolInfo").execute(o).then(i.hitch(this,(function(i){i&&i.length>0&&i[0].value?(this.routingUtilities[e.toolName]=i[0].value,r.resolve(i[0].value)):r.reject("Routing Utility Service 'GetToolInfo' job did not return service limits.")})),(function(e){r.reject(e)}))})))})),(function(e){r.reject(e)})),r.promise},getNetworkAnalysisLimits:function(e){var t=new T;return e||t.reject(new Error("Missing parameter: widget required parameter")),this.getRoutingUtilities(e).then(i.hitch(this,(function(e){e.serviceLimits?t.resolve(e.serviceLimits):t.reject()})),(function(e){t.reject(e)})),t.promise},isEsriWorldGeocoder:function(e){var i=this.isAgoWorldGeocodeServer(e),t=this.isAgoWorldGeocodeServerProxy(e);return i||t},isAgoWorldGeocodeServer:function(e){return e&&!!e.match(/(arcgis.com\/arcgis\/rest\/services\/world\/geocodeserver).*/gi)},isCustomGeoEnrichmentServer:function(e,i){var t=(e||"").toLowerCase(),s=t.indexOf("/geoenrichmentserver")>-1&&t.indexOf("/servers/")>-1&&t.indexOf("/rest/services/")>-1,n=!i&&t.indexOf("utility")&&t.indexOf(".arcgis.com")>-1;return s&&n},isAgoWorldGeocodeServerProxy:function(e){return e&&!!e.match(/(\/servers\/[\da-z\.-]+\/rest\/services\/world\/geocodeserver).*/gi)},isWorldGeoLocator:function(e){return e&&!!e.match(/(\/rest\/services\/world\/geocodeserver).*/gi)},showMessages:function(e,t,s){l.set(t,"innerHTML",e),a.fadeIn({node:s,easing:S.quadIn,onEnd:i.hitch(this,(function(){f.set(s,{display:""})}))}).play()},hideMessages:function(e){a.fadeOut({node:e,easing:S.quadOut,onEnd:function(){f.set(e,{display:"none"})}}).play()},getHelpUrl:function(e){var i;if(e.topic&&e.widget)return e.widget.portalSelf&&e.widget.portalSelf.helpBase?i=e.widget.portalSelf.helpBase+"index.html#":!e.widget.isSingleTenant||e.widget.portalSelf&&e.widget.portalSelf.helpBase||(i="http://server.arcgis.com/en/portal/latest/use/"),"BufferExpression"===e.topic&&(i+="Use_expressions_with_GeoAnalytics_Tools/019300000183000000/"),i},isPCS:function(e){return!!e&&!!Y&&-1!==t.indexOf(Y,e)},isPCSByLayerType:function(e){var i=!!e&&!!e.fullExtent&&this.isPCS(e.fullExtent.spatialReference.wkid);return!i&&e.extent&&(i=!!e&&!!e.extent&&this.isPCS(e.extent.spatialReference.wkid)),!i&&e.spatialReference&&(i=!!e&&!!e.spatialReference&&this.isPCS(e.spatialReference.wkid)),i},checkPCSforAnalysis:function(e){var s,n,a=e.widget&&e.widget.toolName,r=!!e.widget&&!!e.widget.context&&!!e.widget.context.processSR&&this.isPCS(e.widget.context.processSR.wkid),o=!0,l=e.jobParams||e.widget.jobParams,d=!!(e.widget&&e.widget.context&&e.widget.context.processSR&&e.widget.context.processSR.wkid);return!!(a&&l&&e.widget.showGeoAnalyticsParams)&&(n="<a  href='#' id='"+e.widget.id+"_warn_settings_link'>"+e.widget.i18n.analysisSettings+"</a><div class='esriAnalysisSettingsIcon'></div>",s=p.substitute(e.widget.i18n.PCSReqMsg,{defaultSpatialRef:e.widget.i18n.worldCylindrical,settingsIcon:n}),"FindHotSpots"!==a&&"FindPointClusters"!==a||r?"CalculateDensity"!==a&&"FindPointClusters"!==a&&"GeographicallyWeightedRegression"!==a||r?"AggregatePoints"!==a||-1===t.indexOf(["HEXAGON","SQUARE"],l.binType)||r?"SummarizeWithin"===a&&l.summaryPolygons&&!r?o=this.isPCSByLayerType(e.widget.sumWithinLayer):"SummarizeWithin"!==a||-1===t.indexOf(["HEXAGON","SQUARE"],l.binType)||r?"JoinFeatures"===a&&l.spatialNearDistance&&"Near"===l.spatialRelationship&&!r?(o=this.isPCSByLayerType(e.widget.targetLayer))||(s=p.substitute(e.widget.i18n.JFPCSReqMsg,{settingsIcon:n})):"BuildMultiVariableGrid"!==a||r?"CalculateMotionStatistics"===a&&"Planar"===l.distanceMethod&&(l.motionStatistics.split(",").length>1||1===l.motionStatistics.split(",").length&&-1===l.motionStatistics.indexOf("Duration"))&&!r?(o=this.isPCSByLayerType(e.widget.inputLayer))||(s=p.substitute(e.widget.i18n.CMSPCSReqMsg,{settingsIcon:n})):"TraceProximityEvents"!==a||"Planar"!==l.distanceMethod||r||(o=this.isPCSByLayerType(e.widget.inputLayer))||(s=p.substitute(e.widget.i18n.TPEPCSReqMsg,{settingsIcon:n})):o=t.every(e.inputLayers,(function(e){return this.isPCSByLayerType(e)}),this):o=this.isPCSByLayerType(e.widget.summaryLayer):o=this.isPCSByLayerType(e.widget.pointLayer):(o=this.isPCSByLayerType(e.widget.inputLayer),"GeographicallyWeightedRegression"!==a||o||(s=p.substitute(e.widget.i18n.GWRPCSReqMsg,{settingsIcon:n}))):(o=this.isPCSByLayerType(e.widget.analysisLayer),"FindPointClusters"!==a||o||(s=p.substitute(e.widget.i18n.FPCSReqMsg,{settingsIcon:n}))),o||e.hasPCSWarnShown||(e.widget.set("disableRunAnalysis",o),this.settingsVM&&this.settingsDlg&&e.widget._bodyNode&&e.widget._errorMessagePane&&(this.showMessages(s,e.widget._bodyNode,e.widget._errorMessagePane),D.byId(e.widget.id+"_warn_settings_link")&&M(D.byId(e.widget.id+"_warn_settings_link"),"click",i.hitch(e.widget,e.widget.showSettingsDlg)))),!o&&e.hasPCSWarnShown&&d&&(o=!0),o)},tryParseJSON:function(e){try{var i=y.parse(e);if(i&&"object"==typeof i&&null!==i)return i}catch(e){}return!1},decodeTag:function(e){return{"&lt;":"<","&gt;":">"}[e]||e},stringDecode:function(e){return e.replace(/(&lt;|&gt;)/g,this.decodeTag)},jobParamsToWidgetProps:function(e){if(e&&e.jobParams){var s=e.jobParams,n=new T,a=[],r=[];for(var o in s){var l;s.hasOwnProperty(o)&&("string"==typeof s[o]&&-1!==s[o].search(/(&lt;|&gt;)/g)&&(s[o]=this.stringDecode(s[o])),(l="string"==typeof s[o]?this.tryParseJSON(s[o]):s[o])&&(-1!==o.toLowerCase().indexOf("layer")&&"object"==typeof l?r.push({key:o,obj:l}):l&&(l.Raster||l.url)&&r.push({key:o,obj:l}),s[o]=l))}for(var d=0;d<r.length;d++){var u=r[d].obj,c=r[d].key;"object"==typeof u&&u.length?(s[c]=[],t.forEach(u,(function(e,i){this._getFlayers(e,c,s,a,!0,i)}),this)):"object"==typeof u&&u.Raster?(u.url=u.Raster.url,this._getFlayers(u,c,s,a,!0,"Raster")):this._getFlayers(u,c,s,a)}return w(a).then(i.hitch(this,(function(){n.resolve(e)})),i.hitch(this,(function(){n.resolve(e)}))),n.promise}},_getLayerType:function(e){return e?-1!==e.indexOf("BigDataCatalogServer")?J.BIGDATA:-1!==e.indexOf("ImageServer")?J.IS:J.FS:null},_getFlayers:function(e,t,s,n,a,r){var o,l;if(e.url)o=U({url:e.url,content:{f:"json"}}),l=new T,n.push(l),o.then(i.hitch(this,(function(e,t,n,r,o){var l,d=this._getLayerType(e.url);if(d===J.FS)l=new V(e.url,{mode:V.MODE_ONDEMAND,outFields:["*"],resourceInfo:o}),e.filter&&l.setDefinitionExpression(e.filter),l.filter=e.filter;else if(d===J.BIGDATA)l=o,i.mixin(l,e);else if(d===J.IS){var u=e.Raster||e;l=new z(u.url),u.renderingRule&&l.setRenderingRule(new $(u.renderingRule)),u.name&&(l.name=u.name),e.Raster&&e.Raster.url===e.url&&delete e.url}e.name&&(l.name=e.name),a?s[t][r]=l:a&&d===J.IS?i.mixin(s[t][r],l):s[t]=l,n.resolve()}),e,t,l,r),i.hitch(this,(function(e,i,t,n,r){var o={name:e.name,empty:!0};a?s[i][n]=o:s[i]=o,t.resolve()}),e,t,l,r));else{var d=new V(e,{outFields:["*"]});e.name&&(d.name=e.name),a?s[t][r]=d:s[t]=d}},isLayerInLayers:function(e,i){return t.some(i,(function(i){return this.isSameLayer(e,i)}),this)},addBlankOption:function(e,t){t&&t.length?t.push({value:"  ",label:""}):e.addOption({value:"  ",label:""}),setTimeout(i.hitch(this,this._validateSelectUI,e),100)},_validateSelectUI:function(e){e._hasBeenBlurred=!0,e.set("focused",!0),e.validate(),e.set("focused",!1),e._hasBeenBlurred=!1,setTimeout(i.hitch(this,(function(){e.reset()})),1e3)},updateExpressions:function(e){e&&e.selectedInputLayers&&e.inputLayers&&e.data&&e.expressions&&(t.forEach(e.selectedInputLayers,(function(i,s){t.forEach(e.inputLayers,(function(e,t){e&&i&&(!i.url&&!e.url&&i.name===e.name||i.url&&e.url&&i.url===e.url)&&(i._oldIndex=s,i._newIndex=t)}))})),t.forEach(e.data,(function(i,t){var s;t>0&&i&&(s=e.expressions[t-1],O.isDefined(i.layer)&&(i.layer=s&&s.layer),O.isDefined(i.selectingLayer)&&(i.selectingLayer=s&&s.selectingLayer))})),t.forEach(e.data,(function(i){var s=!1,n=!1;t.forEach(e.selectedInputLayers,(function(e){O.isDefined(i.layer)&&i.layer===e._oldIndex&&!s&&(i.layer=e._newIndex,s=!0),O.isDefined(i.selectingLayer)&&i.selectingLayer===e._oldIndex&&!n&&(i.selectingLayer=e._newIndex,n=!0)}),this)}),this))},isBigDataTypeTobeAdded:function(e){return-1==t.indexOf(e,'type:"Big Data File Share"')},removeDuplicates:function(e,i){for(var t=[],s={},n=0;n<e.length;n++)s[e[n]]?s[e[n]]=s[e[n]]+1:(t.push(e[n]),s[e[n]]=1);return i?s:t},isPoint:function(e){return e&&e.geometryType===Z.GeometryTypes.Point},isLine:function(e){return e&&e.geometryType===Z.GeometryTypes.Line},isPolygon:function(e){return e&&e.geometryType===Z.GeometryTypes.Polygon},isSameLayer:function(e,i){return e&&i&&(e.name&&i.name&&e.name===i.name||e.url&&i.url&&e.url===i.url)},getTimeType:function(e){return!!e&&(O.isDefined(e.timeInfo)&&O.isDefined(e.timeInfo.startTimeField)&&!O.isDefined(e.timeInfo.endTimeField)?Z.TimeTypes.Instant:O.isDefined(e.timeInfo)&&O.isDefined(e.timeInfo.startTimeField)&&O.isDefined(e.timeInfo.endTimeField)?Z.TimeTypes.Interval:!(!O.isDefined(e.time)||!O.isDefined(e.time.timeType))&&e.time.timeType)},fetchGroupForRFT:function(e){var i=new T,t=o.locale,s=t?t.substring(0,2):"en",n="en"===s?["esri_en"]:["esri_en","esri_"+s],a=this.systemRFTGroupName+" owner: ("+n.join(" OR ")+")";return e.queryGroups({q:a},!0).then(function(e){if(e.total>0&&e.results){var t=e.results,n=this.findRFTLocaleGroup(t,s)||this.findRFTLocaleGroup(t,"en");i.resolve(n)}else i.resolve(null)}.bind(this)),i},findRFTLocaleGroup:function(e,i){var t;return e.some((function(e){var s=e.owner;if(s&&s.substring(s.length-2)===i)return t=e,!0})),t},updateOptions:function(e,i){if(e){for(;e.getOptions().length>0;)e.removeOption(e.getOptions());e._setDisplay(""),i&&i.length>0&&e.addOption(i)}},addOptionsFromLayers:function(e){e.select&&e.layers&&(e.customOptions=e.customOptions||[],e.forbiddenLayers=e.forbiddenLayers||[],e.layers.forEach((function(i,t){this.isLayerInLayers(i,e.forbiddenLayers)||e.customOptions.push({value:t.toString(),label:i.name,selected:e.selectedOption&&this.isSameLayer(e.selectedOption,i)})}),this),this.updateOptions(e.select,e.customOptions),this.addBrowseOptionForTool({select:e.select,disableLAAL:!0},e.widget))},replaceTag:function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;"}[e]||e},safetagsReplace:function(e){return e.replace(/[<>]/g,this.replaceTag)}}),d("extend-esri")&&i.setObject("dijit.analysis.utils",ie,P),ie}));