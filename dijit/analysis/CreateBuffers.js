// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/number","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/Dialog","../../kernel","../../lang","./AnalysisBase","./_AnalysisOptions","./utils","./CreditEstimator","dojo/i18n!../../nls/jsapi","dojo/text!./templates/CreateBuffers.html"],function(e,t,i,s,n,o,h,a,l,r,p,d,y,u,c,_,f,g,m,T,b,v,D,L,C,k,S,j,R,x,A,I,F,w,N,E,O,P){var U=t([_,f,g,m,T,F,w],{declaredClass:"esri.dijit.analysis.CreateBuffers",templateString:P,widgetsInTemplate:!0,inputLayer:null,inputType:null,outputLayerName:null,bufferDistance:null,units:null,i18n:null,toolName:"CreateBuffers",helpFileName:"CreateBuffers",resultParameter:"BufferLayer",constructor:function(e){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),s.forEach(this._pbConnects,n.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),i.mixin(this.i18n,O.bufferTool)},postCreate:function(){this.inherited(arguments),u.add(this._form,"esriSimpleForm"),this.outputLayerInput.set("validator",i.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_toUpperFirstLetter:function(e){return e.slice(0,1).toUpperCase()+e.slice(1)},_handleSaveBtnClick:function(){var e,t={},i={};this._form.validate()&&(this._saveBtn.set("disabled",!0),t.InputLayer=o.toJson(N.constructAnalysisInputLyrObj(this.inputLayer)),t.DissolveType=this._DissolveType&&"dissolve"===this._DissolveType?"Dissolve":"None","attribute"===this.bufferDistType?t.Field=this._bufferDistAttribute.get("value"):t.Distances=this.bufferDistance,t.Units=this._bufferUnits.get("value"),this.bufferDistance.length&&(this._RingType||(this._RingType="rings"),t.RingType="rings"===this._RingType?"Rings":"Disks"),("esriGeometryPolyline"===this.inputLayer.geometryType||"esriGeometryPolygon"===this.inputLayer.geometryType)&&(t.SideType="esriGeometryPolyline"===this.inputLayer.geometryType?this._SideType&&"left"===this._SideType?"Left":this._SideType&&"right"===this._SideType?"Right":"Full":this._SideType&&"outside"===this._SideType?"Outside":"Full",t.EndType=this._EndType&&"flat"===this._EndType?"Flat":"Round"),this.returnFeatureCollection||(t.OutputName=o.toJson({serviceProperties:{name:this.outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=o.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(e={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.extent=this.map.extent._normalize(!0)),t.context=o.toJson(e)),i.jobParams=t,i.itemParams={description:l.substitute(this.i18n.itemDescription,{layername:this.inputLayer.name,distance_field:t.Distances||t.Field,units:t.Units}),tags:l.substitute(this.i18n.itemTags,{layername:this.inputLayer.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(i.itemParams.folder=this.get("folderId")),this.execute(i))},_handleLayerChange:function(){},_handleRadiusTypeChange:function(e){this.bufferDistType=e,u.remove(this._Distance,"selected"),u.remove(this._Attribute,"selected");var t=this._bufferDist.get("value").split(" ");"attribute"===e?(r.set(this._bufferDistAttribute.domNode,"display","block"),r.set(this._bufferDist.domNode,"display","none"),r.set(this._sizeHelpRow,"display","none"),r.set(this.ringTypes,"display","none"),"polygon"===this.inputType?(r.set(this.polygonTypes,"display","block"),r.set(this.sideTypes,"display","none"),r.set(this.endTypes,"display","none")):"line"===this.inputType&&(r.set(this.sideTypes,"display","block"),r.set(this.endTypes,"display","block"),r.set(this.polygonTypes,"display","none")),u.add(this._Attribute,"selected")):"distance"===e&&(r.set(this._bufferDistAttribute.domNode,"display","none"),r.set(this._bufferDist.domNode,"display","block"),r.set(this._sizeHelpRow,"display","table-row"),u.add(this._Distance,"selected"),t.length>1?(r.set(this.ringTypes,"display","block"),r.set(this.sideTypes,"display","none"),r.set(this.endTypes,"display","none"),r.set(this.polygonTypes,"display","none")):"polygon"===this.inputType?(r.set(this.ringTypes,"display","none"),r.set(this.sideTypes,"display","none"),r.set(this.endTypes,"display","none"),r.set(this.polygonTypes,"display","block")):"line"===this.inputType&&(r.set(this.ringTypes,"display","none"),r.set(this.sideTypes,"display","block"),r.set(this.endTypes,"display","block"),r.set(this.polygonTypes,"display","none")))},_handleDissolveTypeChange:function(e){this._DissolveType=e,u.remove(this._Overlap,"selected"),u.remove(this._Dissolve,"selected"),u.add("none"===e?this._Overlap:this._Dissolve,"selected")},_handleRingTypeChange:function(e){this._RingType=e,u.remove(this._Rings,"selected"),u.remove(this._Disks,"selected"),u.add("rings"===e?this._Rings:this._Disks,"selected")},_handlePolygonTypeChange:function(e){this._SideType=e,u.remove(this._Include,"selected"),u.remove(this._Exclude,"selected"),u.add("full"===e?this._Include:this._Exclude,"selected")},_handleSideTypeChange:function(e,t){this._SideType=t,u.remove(this._Around,"selected"),u.remove(this._Left,"selected"),u.remove(this._Right,"selected"),u.add(e,"selected")},_handleEndTypeChange:function(e){this._EndType=e,u.remove(this._Round,"selected"),u.remove(this._Flat,"selected"),u.add("round"===e?this._Round:this._Flat,"selected")},_handleOptionsBtnClick:function(){u.contains(this._optionsDiv,"disabled")||(u.contains(this._optionsDiv,"optionsClose")?(u.remove(this._optionsDiv,"optionsClose"),u.add(this._optionsDiv,"optionsOpen")):u.contains(this._optionsDiv,"optionsOpen")&&(u.remove(this._optionsDiv,"optionsOpen"),u.add(this._optionsDiv,"optionsClose")))},_handleDistanceChange:function(){var e=i.trim(this._bufferDist.get("value")).split(" "),t=[];e.length>1?(r.set(this.ringTypes,"display","block"),r.set(this.sideTypes,"display","none"),r.set(this.endTypes,"display","none"),r.set(this.polygonTypes,"display","none")):("line"===this.inputType?(r.set(this.sideTypes,"display","block"),r.set(this.endTypes,"display","block")):"polygon"===this.inputType&&r.set(this.polygonTypes,"display","block"),r.set(this.ringTypes,"display","none")),s.forEach(e,function(e){t.push(c.parse(e))}),this.bufferDistance=t},_handleShowCreditsClick:function(e){e.preventDefault();var t={};this._form.validate()&&(t.InputLayer=o.toJson(N.constructAnalysisInputLyrObj(this.inputLayer)),t.DissolveType=this._DissolveType&&"dissolve"===this._DissolveType?"Dissolve":"None","attribute"===this.bufferDistType?t.Field=this._bufferDistAttribute.get("value"):t.Distances=o.toJson(this.bufferDistance),t.Units=this._bufferUnits.get("value"),this.bufferDistance.length&&(this._RingType||(this._RingType="rings"),t.RingType="rings"===this._RingType?"Rings":"Disks"),("esriGeometryPolyline"===this.inputLayer.geometryType||"esriGeometryPolygon"===this.inputLayer.geometryType)&&(t.SideType="esriGeometryPolyline"===this.inputLayer.geometryType?this._SideType&&"left"===this._SideType?"Left":this._SideType&&"right"===this._SideType?"Right":"Full":this._SideType&&"outside"===this._SideType?"Outside":"Full",t.EndType=this._EndType&&"flat"===this._EndType?"Flat":"Round"),this.returnFeatureCollection||(t.OutputName=o.toJson({serviceProperties:{name:this.outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=o.toJson({extent:this.map.extent._normalize(!0)})),console.log(t),this.getCreditsEstimate(this.toolName,t).then(i.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()})))},_save:function(){},_buildUI:function(){var e=!0;N.initHelpLinks(this.domNode,this.showHelp),this.get("showSelectAnalysisLayer")&&(!this.get("inputLayer")&&this.get("inputLayers")&&this.set("inputLayer",this.inputLayers[0]),N.populateAnalysisLayers(this,"inputLayer","inputLayers")),N.addReadyToUseLayerOption(this,[this._analysisSelect]),this.outputLayerName&&(this.outputLayerInput.set("value",this.outputLayerName),e=!1),this.inputLayer&&this._updateAnalysisLayerUI(e),this._bufferDist.set("validator",i.hitch(this,this.validateDistance)),r.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(i.hitch(this,function(e){this.folderStore=e,N.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),r.set(this._chooseExtentDiv,"display",this.showChooseExtent===!0?"inline-block":"none"),r.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._loadConnections()},_updateAnalysisLayerUI:function(e){if(this.inputLayer){p.set(this._bufferToolDescription,"innerHTML",l.substitute(this.i18n.bufferDefine,{layername:this.inputLayer.name})),e&&(this.outputLayerName=l.substitute(this.i18n.outputLayerName,{layername:this.inputLayer.name})),this._bufferDistAttribute.removeOption(this._bufferDistAttribute.getOptions());var t=[];s.forEach(this.inputLayer.fields,function(e){("esriFieldTypeDouble"===e.type||"esriFieldTypeInteger"===e.type||"esriFieldTypeSmallInteger"===e.type||"esriFieldTypeSingle"===e.type)&&t.push({value:e.name,label:I.isDefined(e.alias)&&""!==e.alias?e.alias:e.name})},this),this._bufferDistAttribute.addOption(t),p.set(this._bufferOptionsHelpLink,"esriHelpTopic","polygon"===this.inputType?"OptionPoly":"line"===this.inputType?"OptionLine":"OptionPoint"),"line"===this.inputType?(r.set(this.sideTypes,"display","block"),r.set(this.endTypes,"display","block")):"polygon"===this.inputType&&r.set(this.polygonTypes,"display","block")}this.outputLayerName&&this.outputLayerInput.set("value",this.outputLayerName),!this.bufferDistance||e?(this.bufferDistance=[],this.bufferDistance.push(this._bufferDist.get("value"))):this._bufferDist.set("value",this.bufferDistance.toString().replace(/,/g," ")),this.units&&this._bufferUnits.set("value",this.units)},_handleAnalysisLayerChange:function(e){"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._browsedlg.show()):(this.inputLayer=this.inputLayers[e],this._updateAnalysisLayerUI(!0))},validateDistance:function(){var e,t,n,o=this,h=[];return this._handleDistanceChange(),e=i.trim(this._bufferDist.get("value")).split(" "),0===e.length?!1:(s.forEach(e,function(e){return e=c.parse(e),isNaN(e)?(h.push(0),!1):(t=c.format(e,{locale:"root"}),I.isDefined(t)?I.isDefined(t)||(t=c.format(e,{locale:"en-us"})):t=c.format(e,{locale:"en"}),I.isDefined(t)&&(n=i.trim(t).match(/\D/g)),void(n&&s.forEach(n,function(e){h.push("."===e||","===e?1:"-"===e&&"polygon"===o.inputType?1:0)})))}),-1!==s.indexOf(h,0)?!1:!0)},_loadConnections:function(){this.on("start",i.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",i.hitch(this,"_onClose",!1)),n.connect(this._Distance,"onclick",i.hitch(this,"_handleRadiusTypeChange","distance")),n.connect(this._Attribute,"onclick",i.hitch(this,"_handleRadiusTypeChange","attribute")),n.connect(this._Overlap,"onclick",i.hitch(this,"_handleDissolveTypeChange","none")),n.connect(this._Dissolve,"onclick",i.hitch(this,"_handleDissolveTypeChange","dissolve")),n.connect(this._Include,"onclick",i.hitch(this,"_handlePolygonTypeChange","full")),n.connect(this._Exclude,"onclick",i.hitch(this,"_handlePolygonTypeChange","outside")),n.connect(this._Rings,"onclick",i.hitch(this,"_handleRingTypeChange","rings")),n.connect(this._Disks,"onclick",i.hitch(this,"_handleRingTypeChange","disks")),n.connect(this._Around,"onclick",i.hitch(this,"_handleSideTypeChange",this._Around,"full")),n.connect(this._Left,"onclick",i.hitch(this,"_handleSideTypeChange",this._Left,"left")),n.connect(this._Right,"onclick",i.hitch(this,"_handleSideTypeChange",this._Right,"right")),n.connect(this._Round,"onclick",i.hitch(this,"_handleEndTypeChange","round")),n.connect(this._Flat,"onclick",i.hitch(this,"_handleEndTypeChange","flat"))},_handleBrowseItemsSelect:function(e){e&&e.selection&&N.addAnalysisReadyLayer({item:e.selection,layers:this.inputLayers,layersSelect:this._analysisSelect,browseDialog:this._browsedlg,widget:this}).always(i.hitch(this,this._updateAnalysisLayerUI,!0))},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setInputLayerAttr:function(e){I.isDefined(e)&&("esriGeometryPolygon"===e.geometryType?(this.inputLayer=e,this.inputType="polygon"):"esriGeometryPolyline"===e.geometryType?(this.inputLayer=e,this.inputType="line"):"esriGeometryPoint"===e.geometryType&&(this.inputLayer=e,this.inputType="point"))},_setInputLayersAttr:function(e){this.inputLayers=e},_setLayerAttr:function(e){"esriGeometryPolygon"===e.geometryType?this.inputType="polygon":"esriGeometryPolyline"===e.geometryType?this.inputType="line":"esriGeometryPoint"===e.geometryType&&(this.inputType="point"),this.inputLayer=e},_setLayersAttr:function(e){this._setLayerAttr(e)},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},validateServiceName:function(e){return N.validateServiceName(e,{textInput:this.outputLayerInput})},_setUnitsAttr:function(e){this.units=e},_getUnitsAttr:function(){return this.units=this._bufferUnits.get("value"),this.units},_connect:function(e,t,i){this._pbConnects.push(n.connect(e,t,i))}});return h("extend-esri")&&i.setObject("dijit.analysis.CreateBuffers",U,A),U});