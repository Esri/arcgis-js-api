// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/has","dojo/dom-class","dojo/dom-style","dojo/string","dojo/dom-construct","dojo/query","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/CheckBox","dijit/form/TextBox","../../kernel","../../lang","./RasterAnalysisMixin","./utils","./AnalysisRegistry","./ItemTypes","dojo/i18n!../../nls/jsapi","dojo/i18n!./nls/PredictUsingTrendRaster","dojo/text!./templates/PredictUsingTrendRaster.html"],(function(e,t,i,n,s,a,l,o,r,h,u,d,c,v,_,m,f,g,V,b,D,p,L,U,y,R,A,j){var S=e([d,c,v,_,m,p],{declaredClass:"esri.dijit.analysis.PredictUsingTrendRaster",templateString:j,widgetsInTemplate:!0,inputLayers:null,inputLayer:null,variables:null,variableList:null,dimensionDefinition:"BY_VALUE",dimensionValues:null,start:null,end:null,intervalValue:1,intervalUnit:"DAYS",toolName:"PredictUsingTrendRaster",helpFileName:"PredictUsingTrendRaster",toolNlsName:R.predictUsingTrendRasterTool,rasterGPToolName:"PredictUsingTrendRaster",resultParameter:"outputMultidimensionalRaster",browseType:[y.IS],hasCustomCheck:!0,customCheckFailureMessage:R.customCheckFailureMessage.trendService,constructor:function(e,t){this._pbConnects=[],this._valueRows=[],e.containerNode&&(this.container=e.containerNode)},postMixInProperties:function(){this.inherited(arguments),t.mixin(this.i18n,A)},_getJobParameters:function(){var e=n.toJson(L.constructAnalysisInputLyrObj(this.get("inputLayer"))),i=this.get("variables"),s=this._getDimensionValuesParam();return t.mixin({inputMultidimensionalRaster:e,variables:i},s)},_setDefaultInputs:function(){this.dimensionDefinition&&this._loadDimensionDefinition(!0),this.dimensionValues?"BY_VALUE"===this.dimensionDefinition&&this.dimensionValues.forEach(t.hitch(this,(function(e){this._createValueRow(e)}))):this._createValueRow(),this.start&&this._startValue.set("value",this.start),this.end&&this._endValue.set("value",this.end),this.intervalValue&&this._intervalValue.set("value",this.intervalValue),this.intervalUnit&&this._loadIntervalUnit()},_resetUI:function(){this.inputLayer&&this.inputLayer.getMultidimensionalInfo().then(t.hitch(this,(function(e){this.variableList=e.variables,this.set("variableList",this.variableList),this._handleDimensionDefinitionChange(this.dimensionDefinition)})))},_loadDimensionDefinition:function(e){this._dimensionDefinitionSelect.removeOption(this._dimensionDefinitionSelect.getOptions());var t=e&&this.dimensionDefinition;this._dimensionDefinitionSelect.addOption([{value:"BY_VALUE",label:this.i18n.byValueLabel,selected:"BY_VALUE"===t},{value:"BY_INTERVAL",label:this.i18n.byIntervalLabel,selected:"BY_INTERVAL"===t}]),this._handleDimensionDefinitionChange(t)},_loadIntervalUnit:function(e){this._intervalUnitSelect.removeOption(this._intervalUnitSelect.getOptions());var t=e&&this.intervalUnit;this._intervalUnitSelect.addOption([{value:"HOURS",label:this.i18n.hours,selected:"HOURS"===t},{value:"DAYS",label:this.i18n.days,selected:"DAYS"===t},{value:"WEEKS",label:this.i18n.weeks,selected:"WEEKS"===t},{value:"MONTHS",label:this.i18n.months,selected:"MONTHS"===t},{value:"YEARS",label:this.i18n.years,selected:"YEARS"===t}])},_handleDimensionDefinitionChange:function(e){if(this.dimensionDefinition!==e){this.set("dimensionDefinition",e);var i="BY_VALUE"===e;!i||this._valueTextBox&&""===this._valueTextBox.get("value")||this._createValueRow(),u(".interval",this.domNode).forEach(t.hitch(this,(function(e){this._showDiv(e,!i)}))),u(".dimValue",this.domNode).forEach(t.hitch(this,(function(e){this._showDiv(e,i)}))),i||u(".unit",this.domNode).forEach(t.hitch(this,(function(e){this._showDiv(e,this._enableUnit)})))}},_showDiv:function(e,t){o.set(e,"display",t?"block":"none")},_getDimensionValuesParam:function(){var e=this.get("dimensionDefinition");if("BY_VALUE"===e)return{dimensionDefinition:e,dimensionValues:this.get("dimensionDefValues")};var i={dimensionDefinition:e,start:this.get("start"),end:this.get("end"),intervalValue:this.get("intervalValue")};return this._enableUnit?t.mixin(i,{intervalUnit:this.get("intervalUnit")}):i},_createValueRow:function(e){var i,n,a,l,o;return i=h.create("tr",null,this._dimensionIntervalLabelRow,"before"),n=h.create("td",null,i),a=new V({maxHeight:200,class:"longInput esriLeadingMargin1 dimValue dimDefValue"},h.create("TextBox",null,n)),s.connect(a,"onChange",this._handleDimensionValueChange),o=h.create("td",{class:"shortTextInput removeTd",style:{display:"none",maxWidth:"12px"}},i),l=h.create("a",{title:this.i18n.removeAttrStats,class:"closeIcon statsRemove",innerHTML:"<img src='"+require.toUrl("./images/close.gif")+"' border='0''/>"},o),s.connect(l,"onclick",t.hitch(this,this._removeValueRow,i)),this._valueRows.push(i),a.set("removeTd",o),a.set("isnewRowAdded",!1),a.set("referenceWidget",this),e&&a.set("value",e),this._valueTextBox=a,!0},_removeValueRow:function(e){i.forEach(f.findWidgets(e),(function(e){e.destroyRecursive()})),h.destroy(e)},_removeValueRows:function(){i.forEach(this._valueRows,this._removeValueRow,this),this._valueRows=[]},_handleDimensionValueChange:function(e){var i,n;e.length>0&&(this.get("isnewRowAdded")||(i=this.get("removeTd"),o.set(i,"display","block"),n=this.get("referenceWidget"),t.hitch(n,n._createValueRow()),this.set("isnewRowAdded",!0)))},_setInputLayersAttr:function(e){this.validateTrendInputLayers(e)},isMultidimensionalLayer:function(e){return e.hasMultidimensions},isValidInputLayer:function(e){return this.isMultidimensionalLayer(e)&&e.bandCount&&e.bandCount>1},_getInputLayersAttr:function(){return this.inputLayers},_setVariableListAttr:function(e){var t=" checked";this._variablesList.innerHTML="",this._enableUnit=!1,i.forEach(e,(function(e){var n,s,a,l="",o=e.dimensions,r=!1;o&&o.length>0&&(n=null,i.forEach(o,(function(e){n=e.name+"="+e.values.length+",",l+=n,"StdTime"!==e.name||1!==e.values.length||r||(r=!0)})),l=l.slice(0,-1),s=e.name+" ["+l+"] ("+e.description+")",a=h.toDom("<tr><td colspan='3'><label class='esriLeadingMargin1 esriSelectLabel'><input type='checkbox' data-dojo-type='dijit/form/CheckBox' value='"+e.name+"'"+t+">"+s+"</label></td></tr>"),h.place(a,this._variablesList),t=""),this._enableUnit=r}),this),this._showDiv(this._variablesListLabel,this.variableList.length>0)},_getVariablesAttr:function(){var e=this._variablesList.querySelectorAll("input:checked");if(e&&e.length>0){var t=[];return e.forEach((function(e){t.push(e.value)})),t.join(",")}return""},_setDimensionDefinitionAttr:function(e){this.dimensionDefinition=e},_getDimensionDefinitionAttr:function(){return this._dimensionDefinitionSelect&&this._dimensionDefinitionSelect.get("value")&&(this.dimensionDefinition=this._dimensionDefinitionSelect.get("value")),this.dimensionDefinition},_getDimensionDefValuesAttr:function(){var e=[];return u(".dimDefValue",this.domNode).forEach((function(t){var i=f.byNode(t).get("value");i.length>0&&e.push(i)})),e},_setStartAttr:function(e){this.start=e,this._startValue.set("value",e)},_getStartAttr:function(){return this._startValue&&this._startValue.get("value")&&(this.start=this._startValue.get("value")),this.start},_setEndAttr:function(e){this.end=e,this._endValue.set("value",e)},_getEndAttr:function(){return this._endValue&&this._endValue.get("value")&&(this.end=this._endValue.get("value")),this.end},_setIntervalValueAttr:function(e){this.intervalValue=e,this._intervalValue.set("value",e)},_getIntervalValueAttr:function(){return this._intervalValue&&this._intervalValue.get("value")&&(this.intervalValue=this._intervalValue.get("value")),this.intervalValue},_setIntervalUnitAttr:function(e){this.intervalUnit=e},_getIntervalUnitAttr:function(){return this._intervalUnitSelect&&this._intervalUnitSelect.get("value")&&(this.intervalUnit=this._intervalUnitSelect.get("value")),this.intervalUnit},_setIntervalRangesAttr:function(e){this.intervalRanges=e}});return a("extend-esri")&&t.setObject("dijit.analysis.PredictUsingTrendRaster",S,b),S}));