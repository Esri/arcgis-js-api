// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/Color","dojo/_base/connect","dojo/_base/json","dojo/_base/fx","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/number","dojo/date/locale","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ToggleButton","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/form/RadioButton","dijit/Dialog","dojox/form/CheckedMultiSelect","../../kernel","../../lang","./AnalysisBase","./_AnalysisOptions","./CreditEstimator","../../geometry/jsonUtils","../../toolbars/draw","../../graphic","../../layers/FeatureLayer","./utils","../../geometry/Point","../../geometry/Polyline","../../geometry/Polygon","../../geometry/Multipoint","../../geometry/Extent","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../SpatialReference","dojo/i18n!../../nls/jsapi","dojo/text!./templates/ExtractData.html"],function(t,e,i,s,a,n,r,o,l,h,u,d,c,p,y,m,_,f,x,g,L,S,b,v,I,j,F,E,C,A,D,w,T,P,N,O,M,B,k,J,R,V,G,U,Y,q,z,H,Q,W,Z,K,X,$,tt,et,it){var st=e([g,L,S,b,v,J,R],{declaredClass:"esri.dijit.analysis.ExtractData",templateString:it,widgetsInTemplate:!0,clip:!1,dataFormat:"CSV",inputLayers:null,featureLayers:null,outputLayerName:null,i18n:null,toolName:"ExtractData",helpFileName:"ExtractData",resultParameter:"contentID",constructor:function(t,e){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode)},destroy:function(){this.inherited(arguments),s.forEach(this._pbConnects,n.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),this.i18n={},i.mixin(this.i18n,et.common),i.mixin(this.i18n,et.analysisTools),i.mixin(this.i18n,et.extractDataTool)},postCreate:function(){this.inherited(arguments),m.add(this._form.domNode,"esriSimpleForm"),d.set(this._inputLayersSelect.selectNode,"width","90%"),this._outputLayerInput.set("validator",i.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},_onClose:function(t){t&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:t})},clear:function(){this._extentArea&&(this.map.graphics.remove(this._extentArea),this._extentArea=null),this._featureLayer&&(this.map.removeLayer(this._featureLayer),this._featureLayer=null),this._toolbar.deactivate()},_buildJobParams:function(){var t,e,i={},n=[];if(e=s.map(this._inputLayersSelect.get("value"),function(t){return this.featureLayers[parseInt(t,10)]},this),t=[],t=s.map(e,function(t){return r.toJson(this.constructAnalysisInputLyrObj(t))},this),i.InputLayers=t,i.Clip=this.get("clip"),i.DataFormat=this._dataFormatSelect.get("value"),"-1"!==this._extentSelect.get("value")||this._extentArea)this._extentArea?(this._featureLayer||(this._featureLayer=this._createBoundingPolyFeatColl(),this.map.addLayer(this._featureLayer)),n.push(this._extentArea),this._featureLayer.applyEdits(n,null,null),i.Extent=r.toJson(this.constructAnalysisInputLyrObj(this._featureLayer))):i.Extent=r.toJson(this.constructAnalysisInputLyrObj(this.featureLayers[parseInt(this._extentSelect.get("value"),10)-1])),i.context=r.toJson({extent:this.get("extent")});else{var o=new X(X.STYLE_NULL,new $($.STYLE_SOLID,new a([0,0,0]),4)),l=this._createBoundingPolyFeatColl(),h=this.map.extent._normalize(!0),u=new W(h.spatialReference);u.addRing([[h.xmin,h.ymin],[h.xmin,h.ymax],[h.xmax,h.ymax],[h.xmax,h.ymin],[h.xmin,h.ymin]]),l.add(new Y(u,o)),i.Extent=r.toJson(this.constructAnalysisInputLyrObj(l)),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(i.context=r.toJson({extent:this.map.extent._normalize(!0)}))}return i.OutputName=r.toJson({itemProperties:{title:this._outputLayerInput.get("value"),description:this.i18n.itemDescription,tags:this.i18n.itemTags,snippet:this.i18n.itemSnippet,folderId:this._webMapFolderSelect.item?this.folderStore.getValue(this._webMapFolderSelect.item,"id"):""}}),i},_handleShowCreditsClick:function(t){var e={};t.preventDefault(),this._form.validate()&&(e=this._buildJobParams(),e.InputLayers=r.toJson(e.InputLayers),this.getCreditsEstimate(this.toolName,e).then(i.hitch(this,function(t){this._usageForm.set("content",t),this._usageDialog.show()})))},_handleSaveBtnClick:function(t){var e={},i={};this._form.validate()&&(this._saveBtn.set("disabled",!0),e=this._buildJobParams(),i.jobParams=e,this._featureLayer&&(this.map.removeLayer(this._featureLayer),this._featureLayer=null),this._extentArea&&(this.map.graphics.remove(this._extentArea),this._extentArea=null),this.execute(i))},_save:function(){},_buildUI:function(){var t;this._loadConnections(),d.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this.signInPromise.then(i.hitch(this,z.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),t=f.format(new Date,{datePattern:"MMMM d yyyy",timePattern:"h.m.s a"}),this._outputLayerInput.set("value",u.substitute(this.i18n.outputfileName,{datetime:t})),this.outputLayerName&&this._outputLayerInput.set("value",this.outputLayerName),this.featureLayers&&(this._extentSelect.addOption({value:"-1",label:this.i18n.sameAsDisplay}),s.forEach(this.featureLayers,function(t,e){this._inputLayersSelect.addOption({value:e,label:t.name,selected:this.featureLayers&&-1!==s.indexOf(this.inputLayers,t)}),this._extentSelect.addOption({value:e+1,label:u.substitute(this.i18n.sameAsLayer,{layername:t.name})})},this)),this.outputLayerName&&this._outputLayerInput.set("value",this.outputLayerName),d.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(i.hitch(this,function(t){this.folderStore=t,z.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),d.set(this._chooseExtentDiv,"display",this.showChooseExtent===!0?"inline-block":"none"),this.clip&&this._clipRadioBtn.set("value",this.clip),this.dataFormat&&this._dataFormatSelect.set("value",this.dataFormat)},_loadConnections:function(){this.on("start",i.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",i.hitch(this,"_onClose",!1))},_handleDataFormatSelectChange:function(){var t,e,i;e=!1,i=this._dataFormatSelect.get("value"),"CSV"===i?(e=s.some(this._inputLayersSelect.get("value"),function(e){return t=this.featureLayers[parseInt(e,10)],"esriGeometryPolyline"===t.geometryType||"esriGeometryPolygon"===t.geometryType},this),e?(this._showMessages(this.i18n.linesCSVValidationMsg),this.set("disableRunAnalysis",!0)):(this._handleCloseMsg(),this.set("disableRunAnalysis",!1))):(this._handleCloseMsg(),this.set("disableRunAnalysis",!1))},_handleExtentSelectChange:function(t){var e,i;this._drawExtentBtn.set("disabled","-1"!==this._extentSelect.get("value")),this._extentArea&&(this.map.graphics.remove(this._extentArea),this._extentArea=null,this._extentSelect.updateOption({value:"-1",label:this.i18n.sameAsDisplay})),"-1"!==t?(e=this.featureLayers[parseInt(t-1,10)].toJson(),i=this.featureLayers[parseInt(t-1,10)],this.set("extent",k.isDefined(e.layerDefinition.extent)?e.layerDefinition.extent:this._getLayerFullExtent(i))):this.set("extent",this.map.extent._normalize(!0))},_getLayerFullExtent:function(t){var e=null;return s.forEach(t.graphics,function(t,i){var s=this._getExtent(t.geometry);s&&(e=e?e.union(s):s)},this),e},_getExtent:function(t){if(!t)return null;var e=null;return"esri.geometry.Extent"===t.declaredClass?e=t:"esri.geometry.Point"===t.declaredClass?e=new K(t.x-1e-4,t.y-1e-4,t.x+1e-4,t.y+1e-4,t.spatialReference):(e=t.getExtent(),e&&(e.spatialReference=new tt(t.spatialReference.toJson()))),e},_handleExtentBtnClick:function(t){t.preventDefault(),this.emit("drawtool-activate",{}),this._toolbar.activate(U.POLYGON),this._featureLayer&&(this.map.removeLayer(this._featureLayer),this._featureLayer=null),this._extentArea&&(this.map.graphics.remove(this._extentArea),this._extentArea=null)},_addFeatures:function(t){this.emit("drawtool-deactivate",{}),this._toolbar.deactivate();var e,i,s;e=[],i={},s=new X(X.STYLE_NULL,new $($.STYLE_SOLID,new a([0,0,0]),4)),this.set("extent",t.getExtent()),this._extentArea=new Y(t,s),this.map.graphics.add(this._extentArea),this._extentSelect.updateOption({value:"-1",label:this.i18n.drawnBoundary})},_setExtentAttr:function(t){this.extent=t},_getExtentAttr:function(){return this.extent},_setAnalysisGpServerAttr:function(t){t&&(this.analysisGpServer=t,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setFeatureLayersAttr:function(t){this.featureLayers=s.filter(t,function(t){return-1!==t.capabilities.indexOf("Extract")})},_getFeatureLayersAttr:function(){return this.featureLayers},_setInputLayersAttr:function(t){this.inputLayers=t},_getInputLayersAttr:function(){return this.inputLayers=s.map(this._inputLayersSelect.get("value"),function(t){return this.featureLayers[parseInt(t,10)]},this),this.inputLayers},_setClipAttr:function(t){this.clip=t},_getClipAttr:function(){return this.clip=this._clipRadioBtn.get("checked"),this.clip},_setDataFormatAttr:function(t){this.dataFormat=t},_getDataFormatAttr:function(){return this._dataFormatSelect.get("value")},_setDisableRunAnalysisAttr:function(t){this._saveBtn.set("disabled",t)},_setMapAttr:function(t){this.map=t,this._toolbar=new U(this.map),this.set("extent",this.map.extent._normalize(!0)),n.connect(this._toolbar,"onDrawEnd",i.hitch(this,this._addFeatures))},validateServiceName:function(t){return z.validateServiceName(t,{textInput:this._outputLayerInput})},_connect:function(t,e,i){this._pbConnects.push(n.connect(t,e,i))},_showMessages:function(t){c.set(this._bodyNode,"innerHTML",t),o.fadeIn({node:this._errorMessagePane,easing:x.quadIn,onEnd:i.hitch(this,function(){d.set(this._errorMessagePane,{display:""})})}).play()},_handleCloseMsg:function(t){t&&t.preventDefault(),o.fadeOut({node:this._errorMessagePane,easing:x.quadOut,onEnd:i.hitch(this,function(){d.set(this._errorMessagePane,{display:"none"})})}).play()},_createBoundingPolyFeatColl:function(){var t,e;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolygon"}},t.layerDefinition={currentVersion:10.11,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:"Boundary",hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},e=new q(t,{id:"boundary"})}});return l("extend-esri")&&i.setObject("dijit.analysis.ExtractData",st,B),st});