// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["../../kernel","./AnalysisRegistry","./RasterAnalysisMixin","./utils","./ItemTypes","dijit/_FocusMixin","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/layout/ContentPane","dijit/form/Form","dijit/form/Select","esri/dijit/analysis/components/AddPointFeatures/AddPointFeatures","dijit/form/ValidationTextBox","dijit/form/FilteringSelect","dijit/form/CheckBox","dijit/form/Button","dijit/Dialog","esri/dijit/analysis/CreditEstimator","dojo/_base/array","dojo/_base/declare","dojo/_base/json","dojo/_base/lang","dojo/has","dojo/i18n!./nls/OptimalRegionConnections","dojo/text!./templates/OptimalRegionConnections.html"],(function(t,e,s,i,r,n,a,o,u,h,c,p,l,y,d,_,m,R,g,L,C,S,f,O,B,A,I){var b=S([u,o,h,a,n,s],{declaredClass:"esri.dijit.analysis.OptimalRegionConnections",templateString:I,widgetsInTemplate:!0,analysisType:"feature",browseType:[r.IS,r.FS],checkGeometries:[e.GeometryTypes.Point,e.GeometryTypes.MultiPoint,e.GeometryTypes.Line],tags:["point","line"],map:null,drawSourcePointLayerName:"",toolName:"OptimalRegionConnections",helpFileName:"OptimalRegionConnections",toolNlsName:A,rasterGPToolName:"OptimalRegionConnections",outputName:"outputOptimalLinesName",resultParameter:["outputOptimalLinesFeatures","outputNeighborConnectionsFeatures"],secondaryOutputs:["outputNeighborConnectionsFeatures"],secondaryOutputNames:["outputNeighborConnectionsName"],constructor:function(t,e){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode)},_removePointLayer:function(){this.sourcePointLayer&&this._removeLayer(this.sourcePointLayer,this.inputLayers,this._analysisSelect),this._sourceDrawBtn.deactivate()},_getJobParameters:function(){var t=i.constructAnalysisInputLyrObj(this.get("inputLayer"));this.inputLayer.drawnLayer&&(t.drawnLayer=this.inputLayer.drawnLayer);var e={inputRegionRasterOrFeatures:f.toJson(t),distanceMethod:this.get("distanceMethod"),connectionsWithinRegions:this.get("connectionsWithinRegions")};if(this.get("inputBarrierRasterOrFeatures")){var s=f.toJson(i.constructAnalysisInputLyrObj(this.get("inputBarrierRasterOrFeatures")));e.inputBarrierRasterOrFeatures=s}if(this.get("inputCostRaster")){var r=f.toJson(i.constructAnalysisInputLyrObj(this.get("inputCostRaster")));e.inputCostRaster=r}return e},_setDefaultInputs:function(){this.inputCostRaster&&this.inputCostRasters&&!i.isLayerInLayers(this.inputCostRaster,this.inputCostRasters)&&this.inputCostRasters.push(this.inputCostRaster),this.inputBarrierRasterOrFeatures&&this.inputBarriers&&!i.isLayerInLayers(this.inputBarrierRasterOrFeatures,this.inputBarriers)&&this.inputBarriers.push(this.inputBarrierRasterOrFeatures),this._addBarrierLayerOptions(),this._addInputCostRasterLayerOptions(),this._outputLayerInput.set("value",this.outputOptimalLinesName&&this.outputOptimalLinesName.serviceProperties.name),this.set("distanceMethod",this.distanceMethod),this.set("connectionsWithinRegions",this.connectionsWithinRegions),this.drawSourcePointLayerName||(this.drawSourcePointLayerName=this.i18n.drawSourcePointLayerName),this.inputLayer&&this.inputLayer.drawnLayer&&(this._sourceDrawBtn.set("pointFeatureLayer",this.inputLayer),this.sourcePointLayer=this.inputLayer),this._sourceDrawBtn.set("map",this.map),this._sourceDrawBtn.on("change",O.hitch(this,this._handleSourceDrawLayer))},_setDefaultInputCostRaster:function(){this.inputCostRaster||(this.inputCostRaster=this.inputCostRasters[0])},_handleSourceDrawLayer:function(t){this._clearSelectedPointSelectLayer(!0),this.inputLayers&&0!==this.inputLayers.length&&-1!==this.inputLayers.indexOf(t)||(this.sourcePointLayer=t,this.inputLayers.push(t),this.inputLayer=t,this._analysisSelect.removeOption(this._analysisSelect.getOptions()),i.populateAnalysisLayers(this,"inputLayer","inputLayers"),i.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._analysisSelect}]))},_clearSelectedPointSelectLayer:function(t){!t&&this.sourcePointLayer&&this._sourceDrawBtn.reset()},_addInputCostRasterLayerOptions:function(){var t=[{label:" ",value:""}];this._inputCostRasterSelect.removeOption(this._inputCostRasterSelect.getOptions()),C.forEach(this.inputCostRasters,O.hitch(this,(function(e,s){this._isSelected(this.inputCostRaster,this.inputLayer)||t.push({label:e.name,value:s.toString(),selected:this._isSelected(e,this.inputCostRaster)})}))),this._inputCostRasterSelect.addOption(t),i.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._inputCostRasterSelect}]),this._handleInputCostRasterChange(this._inputCostRasterSelect.get("value"))},_handleInputCostRasterChange:function(t){"browselayers"===t||"browse"===t?(this._isAnalysisSelect=!1,this._isCostRasterSelect=!0,this.defaultItemTypes=[],this.set("allowedItemTypes",[r.IS]),this._createBrowseItems({browseValue:t,disableLAAL:!0,disableBoundary:!0,disabledSubResources:[this.inputCostRaster]},{},this._inputCostRasterSelect)):t>=0&&this.set("inputCostRaster",this.inputCostRasters[t])},_handleInputBarrierRasterOrFeaturesChange:function(t){"browselayers"===t||"browse"===t?(this._isAnalysisSelect=!1,this._isCostRasterSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",this.browseType),this._createBrowseItems({browseValue:t,disableLAAL:!0,disableBoundary:!0,disabledSubResources:[this.inputLayer,this.inputBarrierRasterOrFeatures]},{geometryTypes:this.checkGeometries,tags:this.tags},this._inputBarrierRasterOrFeaturesSelect)):t>=0&&this.set("inputBarrierRasterOrFeatures",this.inputBarriers[t])},_handleBrowseItemsSelect:function(t,e){t&&t.selection&&i.addAnalysisReadyLayer({item:t.selection,layers:this._isAnalysisSelect?this.inputLayers:this._isCostRasterSelect?this.inputCostRasters:this.inputBarriers,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._isCostRasterSelect?this._inputCostRasterSelect:this._inputBarrierRasterOrFeaturesSelect,browseDialog:this._browseLyrsdlg||this._browsedlg,widget:this},e).always(O.hitch(this,(function(){this._isAnalysisSelect?this._handleAnalysisLayerChange(this._analysisSelect.get("value")):this._isCostRasterSelect?this._handleInputCostRasterChange(this._inputCostRasterSelect.get("value")):this._handleInputBarrierRasterOrFeaturesChange(this._inputBarrierRasterOrFeaturesSelect.get("value"))})))},addBrowseOption:function(){i.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._inputCostRasterSelect},this._inputBarrierRasterOrFeaturesSelect])},_isSelected:function(t,e){return e&&t&&e.url===t.url&&t.name===e.name},_addBarrierLayerOptions:function(){var t=[{label:" ",value:""}];this._inputBarrierRasterOrFeaturesSelect.removeOption(this._inputBarrierRasterOrFeaturesSelect.getOptions()),C.forEach(this.inputBarriers,O.hitch(this,(function(e,s){t.push({label:e.name,value:s.toString(),selected:this._isSelected(e,this.inputBarrierRasterOrFeatures)})}))),this._inputBarrierRasterOrFeaturesSelect.addOption(t),i.addReadyToUseLayerOption(this,[{select:this._inputBarrierRasterOrFeaturesSelect}])},_handleDistanceMethodChange:function(t){this.distanceMethod=t},_setInputLayerAttr:function(t){this.inputLayer=t},_getInputLayerAttr:function(){return this.inputLayer},_setInputBarrierRasterOrFeaturesAttr:function(t){t&&(t.geometryType===e.GeometryTypes.Point||t.geometryType===e.GeometryTypes.Line||t.geometryType===e.GeometryTypes.Polygon||this.isImageServiceLayer(t))&&(this.inputBarrierRasterOrFeatures=t)},_getInputBarrierRasterOrFeaturesAttr:function(){return this.inputBarrierRasterOrFeatures},_setInputLayersAttr:function(t){this.inputLayers=C.filter(t,(function(t){return t.geometryType===e.GeometryTypes.Point||t.geometryType===e.GeometryTypes.Line||t.geometryType===e.GeometryTypes.Polygon||this.isImageServiceLayer(t)}),this),this.set("inputCostRasters",t),this.set("inputBarriers",t)},_getInputLayersAttr:function(t){return this.inputLayers},_setInputCostRasterAttr:function(t){this.isImageServiceLayer(t)&&(this.inputCostRaster=t)},_getInputCostRasterAttr:function(){return this.inputCostRaster},setInputBarriersAttr:function(t){this.inputBarriers=C.filter(t,(function(t){return t&&(t.geometryType===e.GeometryTypes.Point||t.geometryType===e.GeometryTypes.Line||t.geometryType===e.GeometryTypes.Polygon||this.isImageServiceLayer(t))}),this)},_getInputBarriersAttr:function(t){return this.inputBarriers},_getInputCostRastersAttr:function(){return this.inputCostRasters},_setInputCostRastersAttr:function(t){this.inputCostRasters=C.filter(t,(function(t){return this.isImageServiceLayer(t)}),this)},_setOutputNeighborConnectionsNameAttr:function(t){this.outputNeighborConnectionsName=t},_getOutputNeighborConnectionsNameAttr:function(){return this._outputNeighborConnectionsNameInput.get("value")},_setDrawSourcePointLayerNameAttr:function(t){this.drawSourcePointLayerName=t},_getDrawSourcePointLayerNameAttr:function(){return this.drawSourcePointLayerName},_getDistanceMethodAttr:function(){return this._distanceMethodSelect.get("value")},_setDistanceMethodAttr:function(t){this.distanceMethod=t,this._distanceMethodSelect&&this._distanceMethodSelect.set("value",t)},_getConnectionsWithinRegionsAttr:function(){return this._connectionsWithinRegionsSelect.get("value")},_setConnectionsWithinRegionsAttr:function(t){this.connectionsWithinRegions=t,this._connectionsWithinRegionsSelect&&this._connectionsWithinRegionsSelect.set("value",t)}});return B("extend-esri")&&O.setObject("dijit.analysis.OptimalRegionConnections",b,t),b}));