define(["../kernel","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/Tooltip","../dijit/RendererSlider","../Color","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/i18n!../nls/jsapi","dojo/dom-geometry","dojo/dom-style","dojo/Evented","dojo/has","dojo/number","dojo/string","dojox/gfx","dojo/text!./OpacitySlider/templates/OpacitySlider.html","require"],function(t,i,s,e,a,o,h,r,l,n,m,u,d,c,g,p,_,f,v,x){var w=l("esri.dijit.OpacitySlider",[e,s,i,c],{baseClass:"esriOpacitySlider",templateString:v,domNode:null,containerNode:null,opacityInfo:null,minValue:null,maxValue:null,histogram:null,statistics:null,handles:null,_histogramWidthDefault:100,_rampWidthDefault:25,showLabels:null,showTicks:null,showHandles:null,showHistogram:!0,showStatistics:!0,_rampNode:null,_sliderHeight:null,_updateTimer:null,showTransparentBackground:!0,_transparentBackgroundNode:null,zoomOptions:{},constructor:function(t,i){this.inherited(arguments),i&&(this.domNode=i,this.containerNode=this._containerNode,this.statistics=t.statistics||!1,this.histogram=t.histogram||!1,this.histogramWidth=t.histogramWidth||this._histogramWidthDefault,this.rampWidth=t.rampWidth||this._rampWidthDefault,this.zoomOptions=t.zoomOptions||null,this.opacityInfo=t.opacityInfo,this.handles=t.handles||[0,1],this.showLabels=t.showLabels||!0,this.showTicks=t.showTicks||!0,this.showHandles=t.showHandles||!0,this.statistics?(this.minValue=this.statistics.min,this.maxValue=this.statistics.max):(this.minValue=0,this.maxValue=100),void 0!==t.minValue&&(this.minValue=t.minValue),void 0!==t.maxValue&&(this.maxValue=t.maxValue),this.showTransparentBackground=t.showTransparentBackground||!0)},postCreate:function(){this.inherited(arguments),this.minValue===this.maxValue&&(0===this.minValue?this.maxValue=100:null===this.minValue?(this.minValue=0,this.maxValue=100):(this.maxValue=2*this.minValue,this.minValue=0)),null===this.minValue&&(this.minValue=0),null===this.maxValue&&(this.maxValue=100),null!==this.zoomOptions&&(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue),this.values=this._getHandleInfo(n.clone(this.opacityInfo.stops))},startup:function(){this.inherited(arguments),this._slider=new o({type:"OpacitySlider",values:this.values,minLabel:this.zoomOptions?this.minValue:null,maxLabel:this.zoomOptions?this.maxValue:null,minimum:this.zoomOptions?this.zoomOptions.minSliderValue:this.minValue,maximum:this.zoomOptions?this.zoomOptions.maxSliderValue:this.maxValue,_isZoomed:this.zoomOptions?!0:!1,showLabels:this.showLabels,showTicks:this.showTicks,showHandles:this.showHandles},this._sliderNode),this._slider.startup(),this._rampNode=this._slider._sliderAreaRight,this._sliderHeight=d.get(this._rampNode,"height")||155,this._valuesAutoAdjust(),this._createSVGSurfaces(),this._slider.on("slide",n.hitch(this,function(){this._valuesAutoAdjust(),this._fillRamp()})),this._slider.on("change",n.hitch(this,function(t){this.values=t.values,this._updateOpacityInfo(t.values),this.emit("change",n.clone(this.opacityInfo))})),this._slider.on("handle-value-change",n.hitch(this,function(t){this.values=t.values,this._updateOpacityInfo(t.values),this._valuesAutoAdjust(),this._fillRamp(),this.emit("handle-value-change",n.clone(this.opacityInfo))})),this._slider.on("data-value-change",n.hitch(this,function(t){this.minValue=t.min,this.maxValue=t.max,this._updateRendererSlider(),this.emit("data-value-change",{minValue:this.minValue,maxValue:this.maxValue,opacityInfo:n.clone(this.opacityInfo)})})),this._slider.on("stop",n.hitch(this,function(){this.emit("handle-value-change",n.clone(this.opacityInfo))})),this.showHistogram&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram(),this.statistics&&this.showStatistics&&this._generateStatistics(),this.watch("minValue",this._updateTimeout),this.watch("maxValue",this._updateTimeout),this.watch("opacityInfo",this._updateTimeout),this.watch("statistics",this._updateTimeout),this.watch("histogram",this._updateTimeout),this.watch("zoomOptions",this._updateTimeout),this.watch("showHandles",this._updateTimeout),this.watch("showLabels",this._updateTimeout),this.watch("showTicks",this._updateTimeout),this.watch("showHistogram",this._toggleHistogram),this.watch("showTransparentBackground",this._toggleTransparentBackground)},_updateOpacityInfo:function(t){r.forEach(this.opacityInfo.stops,n.hitch(this,function(i,s){i.value=t[s].value,i.opacity=t[s].opacity}))},_generateStatistics:function(){var t=this.statistics;if(!(t.count<2)){var i,s,e=this._slider,o=this.zoomOptions||null;t.min===t.max&&t.min===t.avg?(i=0,s=2*t.avg):(i=t.min,s=t.max),(i!==e.minimum||s!==e.maximum)&&(i=e.minimum,s=e.maximum),o&&(i=o.minSliderValue,s=o.maxSliderValue);var h=[{value:t.avg,label:"average"}];h=r.filter(h,function(t){return t.value>=i&&t.value<=s}),r.forEach(h,n.hitch(this,function(e){var o=this._sliderHeight*(s-e.value)/(s-i);this._avgHandleLine=this._histogramSurface.createLine({x1:0,y1:o,x2:this.histogramWidth,y2:o}).setStroke("#c0c0c0").moveToBack(),this._avgHandleImage=this._histogramSurface.createImage({x:u.isBodyLtr()?this.histogramWidth+2:0,y:o-8,width:12,height:14,src:x.toUrl("./images/xAvg.png")});var h=_.substitute(m.widgets.rendererSlider.statsAvg,{avg:p.format(t.avg,{places:this._getPrecision()})});this._avgHandleTooltip=new a({connectId:[this._avgHandleImage.rawNode],label:h})}))}},_valuesAutoAdjust:function(){var t,i,s,e,a,o,h,l=this._slider.values,n=[];for(r.forEach(l,function(t,i){t.hidden||n.push(i)}),o=0;o<n.length-1;o++)for(t=n[o],i=n[o+1],s=i-t,e=l[t].value,a=l[i].value,h=t+1;i>h;h++)l[h].value=e*(i-h)/s+a*(h-t)/s},_createSVGSurfaces:function(){this._colorRampSurface=f.createSurface(this._rampNode,this.rampWidth,this._sliderHeight),this._histogramSurface=f.createSurface(this._rampNode,this.histogramWidth,this._sliderHeight),d.set(this._histogramSurface.rawNode,{overflow:"visible",display:"inline-block",left:this.rampWidth+"px"}),this._transparentBackgroundNode=this._generateTransparentBackground(),this._rect=this._colorRampSurface.createRect(this._colorRampSurface.getDimensions()),d.set(this._colorRampSurface.rawNode,"border","1px solid #888"),this._fillRamp(),null!==this.zoomOptions&&(this.toggleSliderBottom&&this.toggleSliderTop?(this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(f.matrix.translate(0,5)),this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(f.matrix.translate(0,195))):this.toggleSliderBottom?this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(f.matrix.translate(0,195)):this.toggleSliderTop&&this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(f.matrix.translate(0,5)))},_fillRamp:function(){var t=this._slider.values,i=this._slider.minimum,s=this._slider.maximum,e=t.slice(0);r.forEach(e,function(t){t.offset=(s-t.value)/(s-i)}),e.reverse(),null!==this.zoomOptions?this.toggleSliderBottom&&this.toggleSliderTop?this._rect.setFill({type:"linear",x1:0,y1:10,x2:0,y2:190,colors:e}):this.toggleSliderBottom?this._rect.setFill({type:"linear",x1:0,y1:0,x2:0,y2:180,colors:e}):this.toggleSliderTop&&this._rect.setFill({type:"linear",x1:0,y1:20,x2:0,y2:200,colors:e}):this._rect.setFill({type:"linear",x1:0,y1:0,x2:0,y2:200,colors:e})},_getHandleInfo:function(t){var i=r.map(t,n.hitch(this,function(i,s){var e={color:new h([0,121,193,i.opacity]),value:t[s].value,opacity:t[s].opacity};return e}));return i},_showHistogram:function(){this.histogram||this.zoomOptions&&this.zoomOptions.histogram?this._generateHistogram():this._barsGroup&&(this._barsGroup.destroy(),this._barsGroup=null)},_toggleHistogram:function(){this.showHistogram?(d.set(this._barsGroup.rawNode,"display","inline-block"),this._showHistogram()):d.set(this._barsGroup.rawNode,"display","none")},_generateTransparentBackground:function(){var t=this._colorRampSurface.createRect({width:this.rampWidth,height:this._sliderHeight}).setFill(this.showTransparentBackground?this._getTransparentFill():null);return t.moveToBack(),t},_toggleTransparentBackground:function(){this._transparentBackgroundNode.setFill(this.showTransparentBackground?this._getTransparentFill():null)},_getTransparentFill:function(){return{type:"pattern",x:0,y:0,width:16,height:16,src:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgaGVpZ2h0PSIxNiIgd2lkdGg9IjE2Ij48cGF0aCBkPSJNMCAwIEw4IDAgTDggOCBMMCA4IFoiIGZpbGw9IiNjY2MiIC8+PHBhdGggZD0iTTAgMCBMOCAwIEw4IDggTDAgOCBaIiBmaWxsPSIjZmZmIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLDgpIiAvPjxwYXRoIGQ9Ik0wIDAgTDggMCBMOCA4IEwwIDggWiIgZmlsbD0iI2NjYyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCw4KSIgLz48cGF0aCBkPSJNMCAwIEw4IDAgTDggOCBMMCA4IFoiIGZpbGw9IiNmZmYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgsMCkiIC8+PC9zdmc+"}},_updateTimeout:function(){var t=this;clearTimeout(this._updateTimer),this._updateTimer=setTimeout(function(){var i=t;t=null,clearTimeout(i._updateTimer),i._updateRendererSlider()},0)},_updateRendererSlider:function(){null!==this.zoomOptions?(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue,this._slider.set("minimum",this.zoomOptions.minSliderValue),this._slider.set("maximum",this.zoomOptions.maxSliderValue),this._slider.set("_isZoomed",!0),this._slider.set("minLabel",this.minValue),this._slider.set("maxLabel",this.maxValue)):(this._slider.set("minimum",this.minValue),this._slider.set("maximum",this.maxValue),this._slider.set("_isZoomed",!1),this._slider.set("minLabel",null),this._slider.set("maxLabel",null)),this.values=this._getHandleInfo(this.opacityInfo.stops),this._slider.set("values",this.values),this._slider._reset(),this._slider._updateRoundedLabels(),this._slider._generateMoveables(),this._clearRect(),this._createSVGSurfaces(),this.statistics&&this.showStatistics&&this._generateStatistics(),this.showHistogram&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram()},_clearRect:function(){this._colorRampSurface.destroy(),this._histogramSurface.destroy()},_getPrecision:function(){return Math.floor(Math.log(this.maxValue)/Math.log(10))<2?2-Math.floor(Math.log(this.maxValue)/Math.log(10)):0},_generateHistogram:function(){var t,i=this.zoomOptions&&this.zoomOptions.histogram?this.zoomOptions.histogram:this.histogram;this._barsGroup=this._histogramSurface.createGroup();var s=r.map(i.bins,function(t){return"object"==typeof t?t.count:t});s.reverse();var e=this._sliderHeight/s.length;r.forEach(s,n.hitch(this,function(i,a){t=i>0?this.histogramWidth*(i/Math.max.apply(Math,s)):0,this._barsGroup.createRect({width:t,height:e}).setStroke("#c0c0c0").setFill("#aaa").setTransform(f.matrix.translate(0,e*a))})),d.set(this._histogramSurface.rawNode,{display:"inline-block",left:this.rampWidth+"px"}),u.isBodyLtr()||this._barsGroup.setTransform({dx:this.histogramWidth,dy:0,xx:-1,xy:0,yx:0,yy:1})},destroy:function(){this.inherited(arguments),this._slider.destroy(),this._avgHandleTooltip&&this._avgHandleTooltip.destroy()}});return g("extend-esri")&&n.setObject("dijit.OpacitySlider",w,t),w});