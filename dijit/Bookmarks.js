define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/kernel","dojo/has","dojo/keys","dojo/query","dojo/dom","dojo/dom-construct","dojo/dom-class","dojo/dom-geometry","dojo/window","dijit/a11yclick","dojo/i18n!../nls/jsapi","../kernel","../domUtils","../geometry/Extent","./BookmarkItem","../Evented"],function(e,o,t,i,a,r,n,s,d,k,m,h,l,c,u,p,b,_,v,f){var B=e(f,{declaredClass:"esri.dijit.Bookmarks",_eventMap:{click:!0,edit:!0,remove:!0},constructor:function(e,o){this.map=e.map,this.editable=e.editable,this.initBookmarks=e.bookmarks,this._clickHandlers=this._mouseOverHandlers=this._mouseOutHandlers=this._removeHandlers=this._editHandlers=[],this.bookmarkDomNode=k.create("div"),m.add(this.bookmarkDomNode,"esriBookmarkList"),this.bookmarkTable=k.create("table"),m.add(this.bookmarkTable,"esriBookmarkTable"),this.bookmarkDomNode.appendChild(this.bookmarkTable),o=d.byId(o),o.appendChild(this.bookmarkDomNode),this.scrNodeRef=o,m.add(this.scrNodeRef,"esriBookmarks"),this._addInitialBookmarks()},onClick:function(){},onEdit:function(){},onRemove:function(){},addBookmark:function(e){var i;if("esri.dijit.BookmarkItem"==e.declaredClass)i=e,this.bookmarks.push(i);else{var r=new _(e.extent);i=new v({name:e.name,extent:r}),this.bookmarks.push(i)}var n;if(this.editable){var s=u.widgets.bookmarks,d=s.NLS_bookmark_edit,h=s.NLS_bookmark_remove;n=k.create("div",{innerHTML:'<div tabindex="0" role="button" class=\'esriBookmarkLabel\'>'+e.name+'</div><div tabindex="0" role="button" title=\''+h+"' class='esriBookmarkRemoveImage'><br/></div><div tabindex=\"0\" role=\"button\" title='"+d+"' class='esriBookmarkEditImage'><br/></div>"});var p=a.query(".esriBookmarkEditImage",n)[0],b=a.query(".esriBookmarkRemoveImage",n)[0];this._removeHandlers.push(o.connect(b,c,this,"_removeBookmark")),this._editHandlers.push(o.connect(p,c,this,"_editBookmarkLabel"))}else n=k.create("div",{innerHTML:"<div tabindex=\"0\" class='esriBookmarkLabel' style='width: 210px;'>"+e.name+"</div>"});m.add(n,"esriBookmarkItem");var f;f="esri.geometry.Extent"==e.extent.declaredClass?e.extent:new _(e.extent);var B=a.query(".esriBookmarkLabel",n)[0];this._clickHandlers.push(o.connect(B,c,t.hitch(this,"_onClickHandler",e))),this._mouseOverHandlers.push(o.connect(n,"onmouseover",function(){m.add(this,"esriBookmarkHighlight")})),this._mouseOutHandlers.push(o.connect(n,"onmouseout",function(){m.remove(this,"esriBookmarkHighlight")}));var x,N=this.bookmarkTable;x=this.editable?N.rows.length:N.rows.length;var y=N.insertRow(x),g=y.insertCell(0);g.appendChild(n),l.scrollIntoView(n)},removeBookmark:function(e){var o,t=a.query(".esriBookmarkLabel",this.bookmarkDomNode),r=i.filter(t,function(o){return o.innerHTML==e});for(i.forEach(r,function(e){e.parentNode.parentNode.parentNode.parentNode.removeChild(e.parentNode.parentNode.parentNode)}),o=this.bookmarks.length-1;o>=0;o--)this.bookmarks[o].name==e&&this.bookmarks.splice(o,1);this.onRemove()},hide:function(){b.hide(this.bookmarkDomNode)},show:function(){b.show(this.bookmarkDomNode)},destroy:function(){this.map=null,i.forEach(this._clickHandlers,function(e){o.disconnect(e)}),i.forEach(this._mouseOverHandlers,function(e){o.disconnect(e)}),i.forEach(this._mouseOutHandlers,function(e){o.disconnect(e)}),i.forEach(this._removeHandlers,function(e){o.disconnect(e)}),i.forEach(this._editHandlers,function(e){o.disconnect(e)}),k.destroy(this.bookmarkDomNode)},toJson:function(){var e=[];return i.forEach(this.bookmarks,function(o){e.push(o.toJson())}),e},_addInitialBookmarks:function(){if(this.editable){var e=u.widgets.bookmarks,t=e.NLS_add_bookmark,a=k.create("div",{tabIndex:0,role:"button",innerHTML:"<div>"+t+"</div>"});m.add(a,"esriBookmarkItem"),m.add(a,"esriAddBookmark"),this._clickHandlers.push(o.connect(a,c,this,this._newBookmark)),this._mouseOverHandlers.push(o.connect(a,"onmouseover",function(){m.add(this,"esriBookmarkHighlight")})),this._mouseOutHandlers.push(o.connect(a,"onmouseout",function(){m.remove(this,"esriBookmarkHighlight")})),this.scrNodeRef.appendChild(a)}this.bookmarks=[],i.forEach(this.initBookmarks,function(e){this.addBookmark(e)},this)},_removeBookmark:function(e){this.bookmarks.splice(e.target.parentNode.parentNode.parentNode.rowIndex,1),e.target.parentNode.parentNode.parentNode.parentNode.removeChild(e.target.parentNode.parentNode.parentNode),this.onRemove()},_editBookmarkLabel:function(e){var t=e.target.parentNode,i=h.position(t,!0),r=i.y,s=k.create("div",{innerHTML:"<input type='text' class='esriBookmarkEditBox' style='left:"+i.x+"px; top:"+r+"px;'/>"});this._inputBox=a.query("input",s)[0],this._label=a.query(".esriBookmarkLabel",t)[0];var d=u.widgets.bookmarks,m=d.NLS_new_bookmark;this._inputBox.value=this._label.innerHTML==m?"":this._label.innerHTML,o.connect(this._inputBox,"onkeyup",this,function(e){switch(e.keyCode){case n.ENTER:this._finishEdit()}}),o.connect(this._inputBox,"onblur",this,"_finishEdit"),t.appendChild(s),this._inputBox.focus(),i=h.position(t,!0),this._inputBox.style.left=i.x+"px",this._inputBox.style.top=i.y+"px"},_finishEdit:function(){try{this._inputBox.parentNode.parentNode.removeChild(this._inputBox.parentNode)}catch(e){}var o=u.widgets.bookmarks,t=o.NLS_new_bookmark;this._label.innerHTML=""==this._inputBox.value?t:this._inputBox.value;var r=a.query(".esriBookmarkLabel",this.bookmarkDomNode);i.forEach(this.bookmarks,function(e,o){e.name=r[o].innerHTML}),this.onEdit()},_newBookmark:function(){var e,o=this.map,t=u.widgets.bookmarks,i=t.NLS_new_bookmark,r=o.extent;if(o.spatialReference._isWrappable()){var n=_.prototype._normalizeX(r.xmin,o.spatialReference._getInfo()).x,s=_.prototype._normalizeX(r.xmax,o.spatialReference._getInfo()).x;if(n>s){var d,k,m=o.spatialReference.isWebMercator(),h=m?20037508.342788905:180,l=m?-20037508.342788905:-180;Math.abs(n-h)>Math.abs(s-l)?(d=n,k=h):(d=l,k=s),e=new _(d,r.ymin,k,r.ymax,o.spatialReference)}else e=new _(n,r.ymin,s,r.ymax,o.spatialReference)}else e=r;var c=new v({name:i,extent:e});this.addBookmark(c);var p=a.query(".esriBookmarkItem",this.bookmarkDomNode),b=p[p.length-1],f={target:{parentNode:null}};f.target.parentNode=b,this._editBookmarkLabel(f)},_onClickHandler:function(e){var o=e.extent;e.extent.declaredClass||(o=new _(e.extent)),this.map.setExtent(o),this.onClick()}});return r("extend-esri")&&t.setObject("dijit.Bookmarks",B,p),B});