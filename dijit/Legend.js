// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/Color","dojo/debounce","dojo/has","dojo/sniff","dojo/Deferred","dojo/DeferredList","dojo/json","dojo/dom","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dijit/_Widget","dojox/gfx","dojox/gfx/matrix","dojox/html/entities","../kernel","../config","../request","../lang","../numberUtils","../renderers/utils","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/ClassBreaksRenderer","../renderers/ScaleDependentRenderer","../renderers/DotDensityRenderer","../renderers/TemporalRenderer","../renderers/VectorFieldRenderer","../renderers/HeatmapRenderer","../symbols/PictureFillSymbol","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/utils","../symbols/jsonUtils","../renderers/jsonUtils","./_EventedWidget","dojo/i18n!../nls/jsapi"],(function(e,t,r,i,a,s,n,l,o,d,c,h,u,g,y,f,p,m,L,_,b,v,S,R,I,w,C,x,T,F,D,M,A,H,k,O,E,V,z,G,N,j,P,U){var W="http://www.w3.org/2000/svg",B=C.getClassValuesForRelationship(),q={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},X={HH:315,HL:45,LL:135,LH:225},J=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Y=t([P,m],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new n([64,64,64]),defaultText:"Aa",sizeRampLightColor:new n([255,255,255]),sizeRampDarkColor:new n([128,128,128]),gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"<",gt:">"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_preserveCacheOnDestroy:!1,_layerConnects:null,_mapConnects:null,constructor:function(e,t){r.mixin(this,U.widgets.legend),this._i18n=U.widgets.legend,(e=e||{}).map?t?(this.map=e.map,this.layerInfos=e.layerInfos,this._respectCurrentMapScale=!1!==e.respectCurrentMapScale,this._respectVisibility=!1!==e.respectVisibility,this._preserveCacheOnDestroy=!!e.preserveCacheOnDestroy,this.arrangement=e.arrangement===Y.ALIGN_RIGHT?Y.ALIGN_RIGHT:Y.ALIGN_LEFT,this.arrangement===Y.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1!==e.autoUpdate,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=l(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var t,r,i=["ar","he"];for(t=0;t<i.length;t+=1)r=i[t],e.locale&&-1!==e.locale.indexOf(r)&&(-1!==e.locale.indexOf("-")?-1!==e.locale.indexOf(r+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments),this._surfaceItems=[],this._initialize(),o("ie")<9&&(this._repaintItems=r.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate(),this._removeCachedLegendResponses(),this._removeHoverHandlers(),this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||i.forEach(this.layers,(function(e){delete e.legendResponse}))},refresh:function(e){var t;if(this.domNode){for(e?(this.layerInfos=e,this.layers=[],i.forEach(this.layerInfos,(function(e){this._isSupportedLayerType(e.layer)&&(e.title&&(e.layer._titleForLegend=e.title),e.layer._hideDefaultSymbol=!1===e.defaultSymbol,e.hideLayers?(this.hideLayersInLegend[e.layer.id]=e.hideLayers,this._addSubLayersToHide(e)):this.hideLayersInLegend[e.layer.id]=[],e.hoverLabel&&(e.layer._hoverLabel=e.hoverLabel),e.hoverLabels&&(e.layer._hoverLabels=e.hoverLabels),this.layers.push(e.layer))}),this)):this.useAllMapLayers&&(this.layerInfos=null,this.layers=null),t=this.domNode.children.length-1;t>=0;t--)y.destroy(this.domNode.children[t]);this._removeHoverHandlers(),this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos&&(this.layers=[],i.forEach(this.layerInfos,(function(e){this._isSupportedLayerType(e.layer)&&(e.title&&(e.layer._titleForLegend=e.title),e.layer._hideDefaultSymbol=!1===e.defaultSymbol,e.hideLayers?(this.hideLayersInLegend[e.layer.id]=e.hideLayers,this._addSubLayersToHide(e)):this.hideLayersInLegend[e.layer.id]=[],e.hoverLabel&&(e.layer._hoverLabel=e.hoverLabel),e.hoverLabels&&(e.layer._hoverLabels=e.hoverLabels),this.layers.push(e.layer))}),this)),this.useAllMapLayers=!1,!this.layers){this.useAllMapLayers=!0,this.layers=[];var e=[],t=[];i.forEach(this.map.layerIds,(function(r){var a,s=this.map.getLayer(r);this._isSupportedLayerType(s)&&(s.arcgisProps&&s.arcgisProps.title&&(s._titleForLegend=s.arcgisProps.title),this.layers.push(s)),"esri.layers.KMLLayer"===s.declaredClass&&(a=s.getLayers(),i.forEach(a,(function(t){e.push(t.id)}),this)),"esri.layers.GeoRSSLayer"===s.declaredClass&&(a=s.getFeatureLayers(),i.forEach(a,(function(e){t.push(e.id)}),this))}),this),i.forEach(this.map.graphicsLayerIds,(function(r){var a=this.map.getLayer(r);-1===i.indexOf(e,r)&&-1===i.indexOf(t,r)&&this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&(a.arcgisProps&&a.arcgisProps.title&&(a._titleForLegend=a.arcgisProps.title),this.layers.push(a))}),this)}this._createLegend()},_isLayerDrawingEnabled:function(e){return e&&(e._params&&e._params.drawMode||e.isFeatureReductionActive&&e.isFeatureReductionActive())},_activate:function(){if(this._deactivate(),this.autoUpdate){this._mapConnects=[],this._layerConnects={};var e=this._mapConnects;this._respectCurrentMapScale&&e.push(a.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(e.push(a.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers")),e.push(a.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers")),e.push(a.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers"))),i.forEach(this.layers,(function(e){var t=[a.connect(e,"onFeatureReductionRendererChange",this,"_refreshLayers"),a.connect(e,"onFeatureReductionChange",this,"_refreshLayers"),a.connect(e,"onVisibilityChange",this,"_refreshLayers"),a.connect(e,"onOpacityChange",this,"_refreshLayers"),a.connect(e,"onScaleRangeChange",this,"_refreshLayers")];"esri.layers.ArcGISDynamicMapServiceLayer"===e.declaredClass&&e.supportsDynamicLayers&&t.push(a.connect(e,"_onDynamicLayersChange",r.hitch(this,"_updateDynamicLayers",e))),"esri.layers.ArcGISImageServiceLayer"!==e.declaredClass&&"esri.layers.RasterXLayer"!==e.declaredClass||(t.push(a.connect(e,"onRenderingChange",r.partial(this._updateImageServiceLayers,this,e))),t.push(a.connect(e,"onRendererChange",r.partial(this._updateImageServiceLayers,this,e)))),("esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass||e.setWebGLEnabled)&&t.push(a.connect(e,"onRendererChange",r.hitch(this,"_refreshLayers"))),this._layerConnects[e.id]=t}),this)}},_deactivate:function(){i.forEach(this._mapConnects,(function(e){a.disconnect(e)})),i.forEach(this.layers,(function(e){var t=this._layerConnects;t&&i.forEach(t[e.id],(function(e){a.disconnect(e)}))}),this),this._mapConnects=this._layerConnects=null},_updateDynamicLayers:function(e){delete e.legendResponse,this._refreshLayers()},_updateImageServiceLayers:function(e,t){delete t.legendResponse,e._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[],i.forEach(this.map.layerIds,(function(e){var t=this.map.getLayer(e);this._isSupportedLayerType(t)&&this.layers.push(t)}),this),i.forEach(this.map.graphicsLayerIds,(function(e){var t=this.map.getLayer(e);this._isSupportedLayerType(t)&&this._isLayerDrawingEnabled(t)&&this.layers.push(t)}),this),this.refresh()},_createLegend:function(){var e=!1,t=!1;f.set(this.domNode,"position","relative"),y.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var s=[];i.forEach(this.layers,(function(n){var l;if("esri.layers.KMLLayer"===n.declaredClass||"esri.layers.GeoRSSLayer"===n.declaredClass)n.loaded?("esri.layers.KMLLayer"===n.declaredClass?l=n.getLayers():"esri.layers.GeoRSSLayer"===n.declaredClass&&(l=n.getFeatureLayers(),this.hideLayersInLegend[n.id]&&(l=i.filter(l,(function(e){return-1===i.indexOf(this.hideLayersInLegend[n.id],e.id)}),this))),i.forEach(l,(function(e){"esri.layers.FeatureLayer"===e.declaredClass&&n._titleForLegend&&(e._titleForLegend=n._titleForLegend+" - ","esriGeometryPoint"===e.geometryType?e._titleForLegend+=this.NLS_points:"esriGeometryPolyline"===e.geometryType?e._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"===e.geometryType&&(e._titleForLegend+=this.NLS_areas),s.push(e))}),this)):a.connect(n,"onLoad",r.hitch(this,(function(){this.refresh(this.layerInfos)})));else if("esri.layers.WMSLayer"===n.declaredClass)if(n.loaded){if((!this._respectVisibility||this._respectVisibility&&n.visible)&&n.layerInfos.length>0&&i.some(n.layerInfos,(function(e){return e.legendURL}))){var o=!1;i.forEach(n.layerInfos,(function(t){if(t.legendURL&&i.indexOf(n.visibleLayers,t.name)>-1){if(!o){var a=n._titleForLegend||n.name||n.id;y.create("div",{innerHTML:"<span class='esriLegendServiceLabel'>"+a+"</span>"},this.domNode),o=!0}var s,l=t.legendURL;if(n.customParameters||n.customLayerParameters){var d=r.clone(n.customParameters||{});for(s in r.mixin(d,n.customLayerParameters||{}),d)l+=(-1===l.indexOf("?")?"?":"&")+s+"="+d[s]}y.create("div",{innerHTML:"<img src='"+l+"'/>"},this.domNode),e=!0}}),this)}}else a.connect(n,"onLoad",r.hitch(this,(function(){this.refresh(this.layerInfos)})));else if("esri.layers.WFSLayer"!==n.declaredClass||n.renderer)s.push(n);else{var d=y.create("div",{id:this.id+"_"+n.id,class:"esriLegendService"});y.create("span",{innerHTML:this._getServiceTitle(n),class:"esriLegendServiceLabel"},y.create("td",{align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%"},d))))),y.place(d,this.id,"first");var c=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},d),h=y.create("tbody",{},c);"esriGeometryComplex"===n.geometryType?(this._buildRow_Renderer(n,n._pointSymbol,null,this.NLS_points,null,h),this._buildRow_Renderer(n,n._lineSymbol,null,this.NLS_lines,null,h),this._buildRow_Renderer(n,n._polygonSymbol,null,this.NLS_areas,null,h)):"esriGeometryPoint"===n.geometryType?this._buildRow_Renderer(n,n._pointSymbol,null,"",null,h):"esriGeometryPolyline"===n.geometryType?this._buildRow_Renderer(n,n._lineSymbol,null,"",null,h):"esriGeometryPolygon"===n.geometryType&&this._buildRow_Renderer(n,n._polygonSymbol,null,"",null,h),t=!0}}),this);var n=[];(i.forEach(s,(function(e){if(e.loaded){if((!this._respectVisibility||this._respectVisibility&&e.visible)&&(e.layerInfos||e.renderer||"esri.layers.ArcGISImageServiceLayer"===e.declaredClass||"esri.layers.RasterXLayer"===e.declaredClass)){var t=y.create("div",{id:this.id+"_"+e.id,style:{display:"none"},class:"esriLegendService"});if(y.create("span",{innerHTML:this._getServiceTitle(e),class:"esriLegendServiceLabel"},y.create("td",{align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%"},t))))),y.place(t,this.id,"first"),e.legendResponse||e.renderer&&"esri.renderer.StretchRenderer"!==e.renderer.declaredClass||e.renderer&&"esri.renderer.StretchRenderer"===e.renderer.declaredClass&&1===e.bandCount)this._createLegendForLayer(e);else{if(this.isHostedTileService(e))return void this._getLayerInfos(e).then(r.hitch(this,(function(e){this._createLegendForLayer(e)})),r.hitch(this,(function(e){n.push(this._legendRequest(e))})));"esri.layers.RasterXLayer"===e.declaredClass&&e.capabilities.toLowerCase().indexOf("tilesonly")>-1?this._createLegendForTileOnlyService(e):n.push(this._legendRequest(e))}}}else var i=a.connect(e,"onLoad",this,(function(e){a.disconnect(i),i=null,this.refresh()}))}),this),0!==n.length||e||t)?new h(n).addCallback(r.hitch(this,(function(r){g.byId(this.id+"_msg").innerHTML=e||t?"":this.NLS_noLegend,this._activate()}))):(g.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForTileOnlyService:function(e){var t=y.create("div",{id:this.id+"_"+e.id+"_clientLegend",class:"esriLegendServiceLabel"},g.byId(this.id+"_"+e.id));y.create("td",{align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%",class:"esriLegendLayerLabel"},t))));var i=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},t),a=y.create("tbody",{},i),s=e.bandCount;function l(t,r){var i=r&&r.length>=s?o(r):o(),l=["red","green","blue"],d=[[255,0,0],[0,255,0],[0,0,255]];i.forEach((function(r,i){var s=new E(E.STYLE_SQUARE,20,new V(V.STYLE_SOLID,new n([0,0,0]),1),new n(d[i]));t._buildRow_Renderer(e,s,null,l[i]+": "+r,null,a)}),t)}function o(t){var r=(e.bandIds&&e.bandIds.length?e.bandIds:[0,1,2]).map((function(e){return t&&t[e]&&t[e].BandName||"Band_"+(e+1)}));return r.length<3?r.push(r[1]):r.length>3&&r.splice(3),r}if(s>1&&(!e.bandIds||0===e.bandIds.length||e.bandIds.length>1))e.getKeyProperties().then(r.hitch(this,(function(e){l(this,e.BandProperties)})),r.hitch(this,(function(e){l(this)})));else{var d,c,h=e.renderer;h&&h.statistics&&h.statistics.length?(d=null!=h.statistics[0].min?h.statistics[0].min:h.statistics[0][0],c=null!=h.statistics[0].max?h.statistics[0].max:h.statistics[0][1]):(d=e.serviceInfo.minValues.length?e.serviceInfo.minValues[0]:0,c=e.serviceInfo.maxValues.length?e.serviceInfo.maxValues[0]:255),this._createStretchLegend(a,h||{colorRamp:{type:"algorithmic",fromColor:[0,0,0],toColor:[255,255,255]}},d,c)}f.set(g.byId(this.id+"_"+e.id),"display","block"),f.set(g.byId(this.id+"_msg"),"display","none")},_createLegendForLayer:function(e){if(e.legendResponse||e.renderer||this.isHostedTileService(e)){var t=!1;if(e.legendResponse||this.isHostedTileService(e)){var r=e.dynamicLayerInfos||e.layerInfos;r&&r.length?i.forEach(r,(function(r,a){if(!this.hideLayersInLegend[e.id]||-1===i.indexOf(this.hideLayersInLegend[e.id],r.id)){var s=this._buildLegendItems(e,r,a);t=t||s}}),this):"esri.layers.ArcGISImageServiceLayer"!==e.declaredClass&&"esri.layers.RasterXLayer"!==e.declaredClass||(t=this._buildLegendItems(e,{id:0,name:null,title:e.name,subLayerIds:null,parentLayerId:-1},0))}else if(e.renderer){var a;a=e.url?e.url.substring(e.url.lastIndexOf("/")+1,e.url.length):"fc_"+e.id,t=this._buildLegendItems(e,{id:a,name:null,subLayerIds:null,parentLayerId:-1},0)}t&&(f.set(g.byId(this.id+"_"+e.id),"display","block"),f.set(g.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(e){if(e.loaded)return e.version>=10.01?this._legendRequestServer(e):this._legendRequestTools(e);a.connect(e,"onLoad",r.hitch(this,"_legendRequest"))},_legendRequestServer:function(e){var t=e.url,a=t.indexOf("?");a>-1?t=t.substring(0,a)+"/legend"+t.substring(a):t+="/legend";var s=e._getToken();s&&(t+="?token="+s);var n=r.hitch(this,"_processLegendResponse"),l={f:"json"};e._params.dynamicLayers&&(l.dynamicLayers=u.stringify(this._createDynamicLayers(e)),"[{}]"===l.dynamicLayers&&(l.dynamicLayers="[]")),e._params.bandIds&&(l.bandIds=e._params.bandIds),e._params.renderingRule?l.renderingRule=e._params.renderingRule:e.rasterFunctionInfos&&e.rasterFunctionInfos.length>0&&i.forEach(e.rasterFunctionInfos,(function(e){e&&e.name&&"none"===e.name.toLowerCase()&&(l.renderingRule=u.stringify({rasterFunction:e.name}))}));var o=e._params.mosaicRule&&JSON.parse(e._params.mosaicRule);return o&&o.multidimensionalDefinition&&o.multidimensionalDefinition.length&&(l.variable=o.multidimensionalDefinition[0].variableName),R({url:t,content:l,callbackParamName:"callback",load:function(t,r){n(e,t,r)},error:S.defaults.io.errorHandler})},_legendRequestTools:function(e){var t=e.url.toLowerCase().indexOf("/rest/"),i=e.url.substring(0,t)+e.url.substring(t+5,e.url.length),a=this._legendUrl+"?soapUrl="+window.escape(i);(!o("ie")||o("ie")>8)&&(a+="&returnbytes=true");var s=r.hitch(this,"_processLegendResponse"),n={f:"json"};return R({url:a,content:n,callbackParamName:"callback",load:function(t,r){s(e,t,r)},error:S.defaults.io.errorHandler})},_processLegendResponse:function(e,t){t&&t.layers?(e.legendResponse=t,g.byId(this.id+"_"+e.id)&&y.empty(g.byId(this.id+"_"+e.id)),y.create("span",{innerHTML:this._getServiceTitle(e),class:"esriLegendServiceLabel"},y.create("td",{align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%"},g.byId(this.id+"_"+e.id)))))),this._createLegendForLayer(e)):console.log("Legend could not get generated for "+e.url+": "+s.toJson(t))},_buildLegendItems:function(e,t,r){var a=!1,s=g.byId(this.id+"_"+e.id),n=t.subLayerIds,l=t.parentLayerId;if(n){var o=y.create("div",{id:this.id+"_"+e.id+"_"+t.id+"_group",style:{display:"none"},class:-1==l?r>0?"esriLegendGroupLayer":"":this._legendAlign},-1==l?s:g.byId(this.id+"_"+e.id+"_"+l+"_group"));y.create("td",{innerHTML:b.encode(t.name),align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%",class:"esriLegendLayerLabel"},o))))}else{if(this._respectVisibility&&e.visibleLayers)if(h=e.dynamicLayerInfos||e.layerInfos)if(e._params&&e._params.layers){if(-1===i.indexOf(e.visibleLayers,t.id))return a}else{var d=this._getReallyVisibleLayers(h,e.visibleLayers);if(-1===i.indexOf(d,t.id))return a}else if(-1===i.indexOf(e.visibleLayers,t.id))return a;var c=y.create("div",{id:this.id+"_"+e.id+"_"+t.id,style:{display:"none"},class:l>-1?this._legendAlign:""},-1==l?s:g.byId(this.id+"_"+e.id+"_"+l+"_group"));y.create("td",{innerHTML:b.encode(t.name)||"",align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%",class:"esriLegendLayerLabel"},c))));var h,u=!1;(h=e.dynamicLayerInfos||e.layerInfos)&&h.length&&(u=i.some(h,(function(e){return!!e.drawingInfo}))),e.legendResponse?a=a||this._buildLegendItems_Tools(e,t,c):(e.renderer||u)&&(a=a||this._buildLegendItems_Renderer(e,t,c))}return a},_getReallyVisibleLayers:function(e,t){if(!e||!t||!t.length)return[];var r,a=[],s=[];for(r=0;r<e.length;r++)e[r].subLayerIds?(-1===i.indexOf(t,e[r].id)||i.indexOf(s,e[r].id)>-1)&&(s=s.concat(e[r].subLayerIds)):i.indexOf(t,e[r].id)>-1&&-1===i.indexOf(s,e[r].id)&&a.push(e[r].id);return a},_buildLegendItems_Tools:function(e,t,r){var a=t.parentLayerId,s=this.map.getScale(),n=!1;if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(e,t,s)){var l=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===e.declaredClass||"esri.layers.ArcGISMapServiceLayer"===e.declaredClass)){var o=this._getEffectiveScale(e,t);(o.minScale&&o.minScale<s||o.maxScale&&o.maxScale>s)&&(l=!1)}if(l){var d=function(e,t){var r,i;for(r=0;r<e.length;r++)if(t.dynamicLayerInfos){for(i=0;i<t.dynamicLayerInfos[i].length;i++)if(t.dynamicLayerInfos[i].mapLayerId==e[r].layerId)return e[r]}else if(t.id==e[r].layerId)return e[r];return{}}(e.legendResponse.layers,t),c=d.legendType,h=d.legend,u=d.legendGroups;if(h){"esri.layers.ArcGISImageServiceLayer"===e.declaredClass&&"esri.layers.RasterXLayer"===e.declaredClass||this._sanitizeLegendResponse(e,d,t);var p=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},r),m=y.create("tbody",{},p),L={};u&&u.length>0&&(p.setAttribute("cellspacing","10"),u.forEach((function(e){var t,r;e.heading&&(t=y.create("tr",{},m),r=y.create("td",{},t),y.create("div",{innerHTML:b.encode(e.heading)},r)),t=y.create("tr",{},m),r=y.create("td",{},t);var i=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},r),a=y.create("tbody",{},i);L[e.id]=a}))),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(p,e,t);var _=[];i.forEach(h,(function(r){if(e.version>=10.1&&!r.values&&h.length>1&&(e._hideDefaultSymbol||"<all other values>"===r.label));else{var a=r.label;if((r.url&&0===r.url.indexOf("http")||r.imageData&&r.imageData.length>0)&&(n=!0,!a||-1===i.indexOf(_,a))){_.push(a);var s=L[r.groupId]||m;this._buildRow_Tools(r,s,e,t.id,c)}}}),this)}else;}}return n&&(f.set(g.byId(this.id+"_"+e.id+"_"+t.id),"display","block"),a>-1&&(f.set(g.byId(this.id+"_"+e.id+"_"+a+"_group"),"display","block"),this._findParentGroup(e.id,e,a))),n},_getLayerInfos:function(e){var t=new c,r=e.dynamicLayerInfos||e.layerInfos;if(r&&r.length)if(i.some(r,(function(e){return!!e.drawingInfo})))t.resolve(e);else{var a=e.url,s=a.indexOf("?");-1===s?a+="/layers":a=a.substring(0,s)+"/layers"+a.substring(s,a.length),R({url:a,content:{f:"json"},callbackParamName:"callback",load:function(a,s){a.layers?(i.forEach(r,(function(e){var t=i.filter(a.layers,(function(t){return e.source?t.id===e.source.mapLayerId:t.id===e.id}));t&&t[0]&&t[0].drawingInfo&&(e.drawingInfo=t[0].drawingInfo,e.fields=t[0].fields)})),t.resolve(e)):t.reject(e)},error:function(r){t.reject(e)}})}return t},_sanitizeLegendResponse:function(e,t,a){var s=t.legend;if(e.version>=10.1&&s.length>1&&!t._sanitized){var n,l,o=r.getObject("layerDefinition.drawingInfo.renderer",!1,a);o||(o=r.getObject("drawingInfo.renderer",!1,a)),i.some(s,(function(e){if(e.values)return!0}))&&i.some(s,(function(e,t){return e.values||(l=t,n=e),!!n})),o?"uniqueValue"===o.type?n&&(s.splice(l,1),s.push(n)):"classBreaks"===o.type&&(n&&s.splice(l,1),s.reverse(),n&&s.push(n)):n&&(s.splice(l,1),s.push(n)),t._sanitized=!0}},_buildRow_Tools:function(e,t,r,i,a){var s,n,l=y.create("tr",{},t);this.alignRight?(s=y.create("td",{align:this._isRightToLeft?"left":"right"},l),n=y.create("td",{align:this._isRightToLeft?"left":"right",width:35},l)):(n=y.create("td",{width:35,align:"center"},l),s=y.create("td",{},l));var d=e.url;if((!o("ie")||o("ie")>=9||o("ie")<9&&("esri.layers.ArcGISImageServiceLayer"===r.declaredClass||"esri.layers.RasterXLayer"===r.declaredClass))&&e.imageData&&e.imageData.length>0)d="data:image/png;base64,"+e.imageData;else if(0!==e.url.indexOf("http")){d=r.url+"/"+i+"/images/"+e.url;var c=r._getToken();c&&(d+="?token="+c)}var h=y.create("img",{src:d,border:0,style:"opacity:"+r.opacity},n),u=y.create("td",{innerHTML:b.encode(e.label),align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%",dir:"ltr"},s))));a&&"Stretched"===a&&r.version>=10.3&&("esri.layers.ArcGISImageServiceLayer"===r.declaredClass||"esri.layers.RasterXLayer"===r.declaredClass)&&(u.style.verticalAlign="top",u.style.lineHeight="1",h.style.marginBottom="-1px",h.style.display="block",s.style.verticalAlign="top"),o("ie")<9&&(h.style.filter="alpha(opacity="+100*r.opacity+")")},_getVariable:function(e,t,r){var i,a;return e&&(a=(i=e.getVisualVariablesForType(t,r))&&i[0]),a},_getVariables:function(e,t,r){var a=[this._getVariable(e,"colorInfo",!1),this._getVariable(e,"opacityInfo",!1),this._getVariable(e,"sizeInfo",!1)];return t?i.filter(a,(function(e){return!(!e||e.field!==t||e.normalizationField!=r)})):a},_getFieldAlias:function(e,t,i){var a=t.infoTemplate||(t.infoTemplates&&i&&t.infoTemplates[i.id]?t.infoTemplates[i.id].infoTemplate:null),s=a&&a.getFieldInfo&&a.getFieldInfo(e),n=r.isFunction(e)?null:this.getField(t,e,i),l=s||n,o="";return l&&(o=s&&s.label||n&&n.alias||l.name||l.fieldName),o},_getDomainName:function(e,t,i,a){var s;if(e&&!r.isFunction(e)){var n=this.getField(i,e,a),l=n&&i.getDomain?i.getDomain(n.name):null;s=l&&l.codedValues?l.getName(t):null}return s},_getRampTitle:function(e,t,i){var a,s,n=e.field,l=e.normalizationField,o=!1,d=!1,c=!1;if(n=r.isFunction(n)?null:n,l=r.isFunction(l)?null:l,e.legendOptions&&e.legendOptions.title)a=e.legendOptions.title;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if(t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){var h=t.renderer.authoringInfo.visualVariables;for(s=0;s<h.length;s++){var u=h[s];if("colorInfo"===u.type&&"ratio"===u.style){o=!0;break}if("colorInfo"===u.type&&"percent"===u.style){d=!0;break}if("colorInfo"===u.type&&"percentTotal"===u.style){c=!0;break}}}var g=(c?"showRatioPercentTotal":d&&"showRatioPercent")||o&&"showRatio"||l&&"showNormField"||n&&"showField"||null;g&&(a=I.substitute({field:n&&this._getFieldAlias(n,t,i),normField:l&&this._getFieldAlias(l,t,i)},"showField"===g?"${field}":this._i18n[g]))}return a},_getRendererTitle:function(e,t,i){var a,s,n,l,o;e&&("esri.renderer.ClassBreaksRenderer"===e.declaredClass&&(s=e.attributeField,n=e.normalizationField,l="percent-of-total"===e.normalizationType),s=r.isFunction(s)?null:s,n=r.isFunction(n)?null:n,e.legendOptions&&e.legendOptions.title?a=e.legendOptions.title:e.valueExpressionTitle?a=e.valueExpressionTitle:(o=(n?"showNormField":l?"showNormPct":null)||s&&"showField"||null)&&(a=I.substitute({field:s&&this._getFieldAlias(s,t,i),normField:n&&this._getFieldAlias(n,t,i)},"showField"===o?"${field}":this._i18n[o])));return a},_buildLegendItems_Renderer:function(e,t,a){var s,l=t.parentLayerId,o=this.map,d=o.getScale(),c=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(e,t,d)){var h,u,p,m,L,_,v,S,R,w;if("esri.renderer.ScaleDependentRenderer"===(p="esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass?e.renderer.renderer:t&&t.drawingInfo?j.fromJson(r.clone(t.drawingInfo.renderer)):e.isFeatureReductionActive&&e.isFeatureReductionActive()?e.getFeatureReductionRenderer():e.renderer).declaredClass&&(m="zoom"===p.rangeType?p.getRendererInfoByZoom(o.getZoom()):p.getRendererInfoByScale(d),!(p=m&&m.renderer)))return!1;var C,x=p&&p.authoringInfo&&"relationship"===p.authoringInfo.type;if("esri.renderer.StretchRenderer"!==p.declaredClass&&"esri.renderer.ShadedReliefRenderer"!==p.declaredClass){var T,F,D,M,A,k=this._getVariables(p),O=i.filter(k,(function(e){return!!e})).length,E=k[0],V=k[1],G=k[2],N=!1;E&&(L=this._getMedianColor(p,E),E.field&&(v=r.isFunction(E.field)?null:this.getField(e,E.field,t)),T=!(E.legendOptions&&!1===E.legendOptions.showLegend)),V&&(V.field&&(R=r.isFunction(V.field)?null:this.getField(e,V.field,t)),F=!(V.legendOptions&&!1===V.legendOptions.showLegend)),G&&(G.field&&(S=r.isFunction(G.field)?null:this.getField(e,G.field,t)),D=!(G.legendOptions&&!1===G.legendOptions.showLegend),N=D&&J.test(G.valueExpression))}if("esri.renderer.HeatmapRenderer"===p.declaredClass)s=c=!0,this._showHeatRamp(e,t,p,a);else if("esri.renderer.DotDensityRenderer"===p.declaredClass)s=c=!0,this._showDotDensityLegend(e,t,p,a);else if("esri.renderer.TemporalRenderer"===p.declaredClass)s=c=!0,u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(u,e,t),p.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===p.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(e,p.latestObservationRenderer.symbol,L,b.encode(p.latestObservationRenderer.label)||this.NLS_currentObservations,null,h),p.observationRenderer&&"esri.renderer.SimpleRenderer"===p.observationRenderer.declaredClass&&this._buildRow_Renderer(e,p.observationRenderer.symbol,L,b.encode(p.observationRenderer.label)||this.NLS_previousObservations,null,h);else if("esri.renderer.UniqueValueRenderer"===p.declaredClass){if(p.infos&&p.infos.length>0){if(s=c=!0,p.legendOptions&&p.legendOptions.title||p.valueExpressionTitle){u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u);var P=p.legendOptions&&p.legendOptions.title?p.legendOptions.title:p.valueExpressionTitle;this._buildRow_Renderer(e,null,L,b.encode(P),null,h)}if(u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(u,e,t),p.attributeField&&G&&this._addSubHeader(h,this._getFieldAlias(p.attributeField,e,t)),x){var U=p.authoringInfo,W=U.focus,B=U.numClasses,X=U.field1.field,Y=U.field2.field;if(B&&X&&Y){var Z=U.field1.normalizationField,$=U.field2.normalizationField,K=Z&&this._i18n.showNormField||X&&"${field}",Q=$&&this._i18n.showNormField||Y&&"${field}",ee=I.substitute({field:this._getFieldAlias(X,e,t),normField:Z&&this._getFieldAlias(Z,e,t)},K),te=I.substitute({field:this._getFieldAlias(Y,e,t),normField:$&&this._getFieldAlias($,e,t)},Q),re={shapeDescriptor:q,rotation:this._getRotationAngleForFocus(W)||0};this._buildRow_Renderer(e,null,null,b.encode(ee),null,h,null,re),re.rotation+=90,this._buildRow_Renderer(e,null,null,b.encode(te),null,h,null,re),this._drawRelationshipLegend(a,{numClasses:B,focus:W,uvInfos:p.infos})}}else{var ie=[];i.forEach(p.infos,(function(r){var a=null;this._isLayerEditable(e)&&e.types&&(a=this._getTemplateFromTypes(e.types,r.value));var s=r.label;if(null==s&&(s=this._getDomainName(p.attributeField,r.value,e,t)||r.value),-1===i.indexOf(ie,s)){ie.push(s);var n=r.symbol;n=this._applyScaleDrivenSymbolSize(n,p,G,N),this._buildRow_Renderer(e,n,L,b.encode(s),a,h)}}),this)}}A=!x&&this._displayDefaultSymbol(e,p,a,G,N)}else if("esri.renderer.ClassBreaksRenderer"===p.declaredClass){if(p.infos&&p.infos.length>0||"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass){if(s=c=!0,M=this._isUnclassedRenderer(p),!E&&1===p.infos.length){var ae=p.infos[0];_=ae&&ae.symbol}if(!M){u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u);P=this._getRendererTitle(p,e,t);this._buildRow_Renderer(e,null,L,b.encode(P),null,h)}if(u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(u,e,t),!M||!G||!D||N){var se=p.infos.slice(0).reverse();i.forEach(se,(function(t){var r=t.label;null!=r||M||(r=t.minValue+" - "+t.maxValue);var i=t.symbol;i=this._applyScaleDrivenSymbolSize(i,p,G,N),this._buildRow_Renderer(e,i,L,b.encode(r),null,h)}),this)}"esri.layers.ArcGISImageServiceVectorLayer"!==e.declaredClass||e.renderer.style!==H.STYLE_SCALAR&&e.renderer.style!==H.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(e,p.defaultSymbol,null,"",null,h),e._hideDefaultSymbol=!0)}M||(A=this._displayDefaultSymbol(e,p,a,G,N))}else if("esri.renderer.StretchRenderer"===p.declaredClass){s=c=!0,u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u);var ne,le,oe,de=this,ce=function(){p.statistics.length?(le=p.statistics[0][1],oe=p.statistics[0][0]):(oe=ne?ne.minValues[0]:e.minValues[0],le=ne?ne.maxValues[0]:e.maxValues[0]),"esri.layers.RasterXLayer"===e.declaredClass&&e.hasStdTime()&&(oe=e.getStdTimeValue(oe),le=e.getStdTimeValue(le)),de._createStretchLegend(h,p,oe,le)};if(e.renderingRule)e.getRenderingRuleServiceInfo(e.renderingRule).then((function(t){var r=t&&t.minValues&&t.minValues.length>0&&t.maxValues&&t.maxValues.length>0;t&&t.bandCount>1||!r?de._legendRequest(e).then((function(t){de._processLegendResponse(e,t)})):ce()}));else{if(ne=e.serviceInfo,"esri.layers.RasterXLayer"===e.declaredClass&&(ne=e.raster.serviceInfo,e.hasMultidimensions&&(!p.statistics||!p.statistics.length))){var he=e.mosaicRule&&e.mosaicRule.multidimensionalDefinition,ue=he&&he.length?he[0].variableName:e._defaultMultidimensionalDefinition[0].variableName;return e.getStatistics(ue).then(r.hitch(this,(function(e){this._createStretchLegend(h,p,e[0][0],e[0][1]),pe()}))),c}ce()}}else if("esri.renderer.ShadedReliefRenderer"===p.declaredClass)s=c=!0,u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u),this._createStretchLegend(h,p,0,255);else if("esri.renderer.SimpleRenderer"===p.declaredClass){s=c=!0,u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(u,e,t);var ge=null;this._isLayerEditable(e)&&e.templates&&e.templates.length>0&&(ge=e.templates[0]),w=O>1?null:v&&T||R&&F||S&&D;var ye=O>1?null:E||V||G;this._buildRow_Renderer(e,p.symbol,L,b.encode(w?this._getRampTitle(ye,e,t):p.label),ge,h),_=E?null:p.symbol,w&&(v=R=S=null)}else"esri.renderer.ColormapRenderer"===p.declaredClass&&(p.colormapInfos&&p.colormapInfos.length&&(s=c=!0),u=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},a),h=y.create("tbody",{},u),p.colormapInfos.forEach((function(t){var r=new z(z.STYLE_SOLID,null,new n(t.color));this._buildRow_Renderer(e,r,null,t.label,null,h)}),this),e._hideDefaultSymbol=!0);if(s)if(E&&T&&(E.field||E.valueExpression)&&(C=!(!G||!D),this._showGradientRamp(e,t,p,null,a,E,v,null,C)),G&&D&&(G.field||G.valueExpression&&!N)&&(C=!(E&&T||"esri.renderer.UniqueValueRenderer"===p.declaredClass),this._showSizeLegend(e,t,p,G,L,a,S,null,C)),V&&F&&(V.field||V.valueExpression)){var fe=_&&!_.url&&_.color?_.color:this.transparencyRampColor;C=!1,this._showGradientRamp(e,t,p,fe,a,V,R,null,C)}A||M&&!T&&!D&&!F||(A=this._displayDefaultSymbol(e,p,a,G,N)),c=c||A}de=this;function pe(){f.set(g.byId(de.id+"_"+e.id+"_"+t.id),"display","block"),l>-1&&(f.set(g.byId(de.id+"_"+e.id+"_"+l+"_group"),"display","block"),this._findParentGroup(e.id,l))}return c&&pe(),c},_createStretchLegend:function(e,t,r,i){var a,s=y.create("tr",{},e);a=y.create("td",{rowspan:2,class:"esriStretchLegend"},s);var n=y.toDom(this._addColorRamp(t.colorRamp));y.place(n,a),y.create("td",{},s).innerHTML=this._i18n.high+": "+("string"==typeof i?i:Math.round(i*Math.pow(10,3))/Math.pow(10,3));var l=y.create("tr",{},e);y.create("td",{},l).innerHTML=this._i18n.low+": "+("string"==typeof r?r:Math.round(r*Math.pow(10,3))/Math.pow(10,3))},_addColorRamp:function(e){e||(e={algorithm:"hsv",fromColor:[0,0,0,1],toColor:[255,255,255,1]});var t=this._generateColorRampDivs(e);return e.label="<div class='esriStretchLegendGradientLabel'>"+t+"</div>",e.label},_generateColorRampDivs:function(e){if(e){var t,r="";if("multipart"===e.type){t=100/e.colorRamps.length;var i=e.colorRamps;Object.keys(i).reverse().forEach((function(e){r+=this._generateSingleGradientDiv(i[e].fromColor,i[e].toColor,t)}),this)}else r=this._generateSingleGradientDiv(e.fromColor,e.toColor,100);return r}},_generateSingleGradientDiv:function(e,t,r){if(e&&t){var a,s="";return e=e.toRgb?e.toRgb():e,t=t.toRgb?t.toRgb():t,a="(0deg, rgb("+e.slice(0,3).join()+"), rgb("+t.slice(0,3).join()+"));",i.forEach(["-webkit-linear-gradient","-o-linear-gradient","-moz-linear-gradient","linear-gradient"],(function(e){s+="background: "+e+a})),"<div class='esriStretchLegendSingleGradient' style='height:"+r+"%;"+s+"'></div>"}},_isLayerEditable:function(e){return"function"==typeof e.isEditable&&e.isEditable()},_isUnclassedRenderer:function(e,t){var r,i=e.infos,a=i?i.length:0;if("esri.renderer.ClassBreaksRenderer"===e.declaredClass&&1===a){var s=e.attributeField,n=e.normalizationField;r=t?s===t:!!this._getVariables(e,s,n).length}else{var l=e.authoringInfo&&e.authoringInfo.type;r=2===a&&"univariateColorSize"===l}return r},_displayDefaultSymbol:function(e,t,r,i,a){var s,n=t.defaultSymbol;if(!e._hideDefaultSymbol&&n){s=!0;var l=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},r),o=y.create("tbody",{},l);n=this._applyScaleDrivenSymbolSize(n,t,i,a),this._buildRow_Renderer(e,n,null,b.encode(t.defaultLabel)||"others",null,o)}return s},_applyScaleDrivenSymbolSize:function(e,t,r,i){return i&&(e=N.fromJson(e.toJson()),this._applySize(e,t,r,null)),e},_showGradientRamp:function(e,t,i,a,s,n,l,o,d){var c,h,u;c=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"+(d?"":" esriLegendSubFragment")},s),h=y.create("tbody",{},c),(e._hoverLabel||e._hoverLabels||o)&&this._createHoverAction(c,e,t,o),(l||n.valueExpression||n.legendOptions&&n.legendOptions.title)&&this._addSubHeader(h,this._getRampTitle(n,e,t));var g,f=n.field;f&&(g=r.isFunction(f)?null:this.getField(e,f,t));var p=g&&"esriFieldTypeDate"===g.type,m=(u=this._getRampStops(i,n,a,p))?u.length:0;if(m){var L=m>10;this._drawGradientRamp(h,u,!L,e,this._getRampBorderColor(i),!!a,L)}},_getMedianColor:function(e,t){var r,i;t.colors?(r=t.minDataValue,i=t.maxDataValue):t.stops&&(r=t.stops[0].value,i=t.stops[t.stops.length-1].value);var a=r+(i-r)/2;return e.getColor(a,{colorInfo:t})},_getRampStops:function(e,t,r,a){var s,l,o,d,c=!1;if(t.colors||t.opacityValues)l=t.maxDataValue-t.minDataValue,s=i.map([0,.25,.5,.75,1],(function(e){return o=t.minDataValue+e*l,Number(o.toFixed(6))})),this._checkPrecision(0,4,s);else if(t.stops){if(s=i.map(t.stops,(function(e){return e.value})),!a)i.some(s,(function(e){return w.getDigits(e).fractional>2}))&&(s=w.round(s));(c=i.some(t.stops,(function(e){return!!e.label})))&&(d=i.map(t.stops,(function(e){return e.label})))}var h,u,g=s[0],y=s[s.length-1];return l=y-g,i.map(s,(function(i,o){r?(h=new n(r.toRgba()),null!=(u=e.getOpacity(i,{opacityInfo:t}))&&(h.a=u)):h=e.getColor(i,{colorInfo:t});var y="";if(c)y=d[o];else{var f=a?C.formatDate(i,C.timelineDateFormatOptions):w.format(i),p="";0===o?p=this._specialChars.lt+" ":o===s.length-1&&(p=this._specialChars.gt+" "),y=p+f}return{value:i,color:h,offset:1-(i-g)/l,label:y}}),this).reverse()},_checkPrecision:function(e,t,r){var i=e+(t-e)/2,a=r[e],s=r[i],n=r[t],l=Math.floor(a),o=Math.floor(s),d=Math.floor(n);l===a&&d===n&&o!==s&&l!==o&&d!==o&&(r[i]=o),e+1!==i&&this._checkPrecision(e,i,r),i+1!==t&&this._checkPrecision(i,t,r)},_getRampBorderColor:function(e){var t,r;return"esri.renderer.SimpleRenderer"===e.declaredClass?t=e.symbol:"esri.renderer.UniqueValueRenderer"!==e.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==e.declaredClass||(t=e.infos[0].symbol),(r=t&&-1===t.type.indexOf("linesymbol")?t.getStroke():null)&&r.color},_drawGradientRamp:function(e,t,r,a,s,l,d){var c,h,u,g,p,m,_,v,S,R,I=y.create("tr",{},e),w=t.length-1,C=0;this.alignRight?(c=y.create("td",{align:this._isRightToLeft?"left":"right"},I),h=y.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},I)):(h=y.create("td",{width:this.gradientWidth,align:"center"},I),c=y.create("td",{},I));var x=s&&s.a>0&&!(s.r>=240&&s.g>=240&&s.b>=240);u=y.create("div",{class:x?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},h),g=y.create("div",{class:"esriLegendColorRamp"+(l?" esriLegendTransparencyRamp":"")},u),v=f.get(g,"width"),x&&(s=o("ie")<9?s.toHex():"rgba("+s.toRgba().join(",")+")",f.set(g,"border",this.colorRampBorder+" "+s)),r?(S=this.gradientHeight*w,f.set(g,"height",S+"px")):S=f.get(g,"height"),f.set(u,"height",S+"px"),m=L.createSurface(g,v,S),o("ie")<9&&(_=m.getEventSource(),f.set(_,"position","relative"),f.set(_.parentNode,"position","relative"),C=1);try{r&&i.forEach(t,(function(e,t){e.offset=t/w})),m.createRect({x:-C,y:-C,width:v+C,height:S+C}).setFill({type:"linear",x1:0,y1:0,x2:0,y2:S,colors:t}).setStroke(null),m.createRect({width:v,height:S}).setFill(new n([255,255,255,1-a.opacity])).setStroke(null),this._surfaceItems.push(m)}catch(e){m.clear(),m.destroy()}i.forEach(t,(function(e,r){if(e.label){R="top:"+100*e.offset+"%;";var i="";0===r&&(i+=" esriLegendColorRampTickFirst"),r===t.length-1&&(i+=" esriLegendColorRampTickLast"),y.create("div",{class:"esriLegendColorRampTick"+i,innerHTML:"&nbsp;",style:R},u)}})),p=y.create("div",{class:"esriLegendColorRampLabels",style:{height:S+this.gradientHeight+"px"}},c),r?i.forEach(t,(function(e){y.create("div",{class:"esriLegendColorRampLabel",innerHTML:b.encode(e.label)||"&nbsp;"},p)})):(y.create("div",{class:"esriLegendColorRampLabel",innerHTML:d?b.encode(t[0].label)||"&nbsp;":this._i18n.high},p),y.create("div",{class:"esriLegendColorRampLabel",innerHTML:d?b.encode(t[t.length-1].label)||"&nbsp;":this._i18n.low,style:"top: "+(S+this.gradientHeight-2*this.gradientHeight)+"px;"},p))},_showHeatRamp:function(e,t,r,i,a){var s,n,l,o=r.field;s=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},i),n=y.create("tbody",{},s),(e._hoverLabel||e._hoverLabels||a)&&this._createHoverAction(s,e,t,a),(o=o&&this.getField(e,o,t))&&this._addSubHeader(n,this._getFieldAlias(o.name,e,t)),(l=this._getHeatmapStops(r)).length&&this._drawGradientRamp(n,l,!1,e)},_getHeatmapStops:function(e){var t,r,a,s,n=e.colorStops,l=e.colors;if(n&&n[0])if(t=n.length-1,n[0]&&null!=n[0].ratio){var o=n[t];o&&1!==o.ratio&&((n=n.slice(0)).push({ratio:1,color:o.color}),t++)}else r=n[0].value,a=n[t].value-r,n=i.map(n,(function(e){return{color:e.color,ratio:(e.value-r)/a}}));else l&&l[0]&&(t=l.length-1,s=1/(l.length-1),n=i.map(l,(function(e,t){return{color:e,ratio:t*s}})));return(n=i.map(n,(function(e,r){var i="";return 0===r?i="Low":r===t&&(i="High"),{color:e.color,label:i,offset:1-e.ratio}}))).reverse()},_showDotDensityLegend:function(e,t,a,s){var n,l,o,d,c,h,u,g,f=a.legendOptions,p=this.dotDensitySwatchSize,m=Math.round(p/2);f&&(l=f.backgroundColor,o=f.outline,d=f.valueUnit,c=f.dotCoverage),c=(c||this.dotCoverage)/100,g=Math.round(p*p/Math.pow(a.dotSize,2)*c),h=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"},s),u=y.create("tbody",{},h),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(h,e,t),this._addSubHeader(u,I.substitute({value:a.dotValue,unit:d||""},this.NLS_dotValue)),i.forEach(a.fields,(function(i){(i=r.mixin({},i)).numPoints=g,n=new O(a._generateImageSrc(p,p,[i],{x:0,y:0},{x:p,y:p},l),o||a.outline,p,p),i=this.getField(e,i.name,t)||i,this._buildRow_Renderer(e,n,null,b.encode(this._getFieldAlias(i.name,e,t)),null,u,{type:"path",path:"M "+-m+","+-m+" L "+m+","+-m+" L "+m+","+m+" L "+-m+","+m+" L "+-m+","+-m+" E"})}),this)},_showSizeLegend:function(e,t,i,a,s,n,l,o,d){var c,h,u,g=a.legendOptions,f=g&&g.customValues,p=this._getSizeSymbol(i,s);if((!a.valueUnit||"unknown"===a.valueUnit)&&p&&(f||null!=a.minSize&&null!=a.maxSize&&null!=a.minDataValue&&null!=a.maxDataValue||a.stops&&!(a.stops.length<=1))){c=y.create("table",{cellpadding:0,cellspacing:0,width:"95%",class:"esriLegendLayer"+(d?"":" esriLegendSubFragment")},n),h=y.create("tbody",{},c),(e._hoverLabel||e._hoverLabels||o)&&this._createHoverAction(c,e,t,o),(l||a.valueExpression||a.legendOptions&&a.legendOptions.title)&&this._addSubHeader(h,this._getRampTitle(a,e,t));var m,L,_,v=a.field,S=v&&!r.isFunction(v),R=S&&"cluster_count"===v.toLowerCase(),I=S?e.isFeatureReductionActive&&e.isFeatureReductionActive()?e.getFeatureReductionField(v):this.getField(e,v,t):null,x=I&&"esriFieldTypeDate"===I.type,T=(u=f||this._getDataValues(i,p,a,x,R)).length-1;for(m=T;m>=0;m--)L=u[m],p=N.fromJson(p.toJson()),this._applySize(p,i,a,L),L=x?C.formatDate(L,C.timelineDateFormatOptions):w.format(L),_="",m===T?_=this._specialChars.gt+" ":0===m&&(_=R&&1===u[m]?"":this._specialChars.lt+" "),_="<span class='esriLegendSizeRampLabel'>"+b.encode(_+L)+"</span>",this._buildRow_Renderer(e,p,null,_,null,h)}},_getSizeSymbol:function(e,t){var r,i;if("esri.renderer.SimpleRenderer"===e.declaredClass?r=e.symbol:"esri.renderer.VectorFieldRenderer"===e.declaredClass?r=e.defaultSymbol:"esri.renderer.UniqueValueRenderer"!==e.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==e.declaredClass||(r=e.infos[0].symbol,i=e.infos.length>1),(r=r&&-1!==r.type.indexOf("fillsymbol")?null:r)&&(r=N.fromJson(r.toJson()),t||i))if(-1!==r.type.indexOf("linesymbol"))r.setColor(new n(this.sizeRampDarkColor));else if(r.setColor(new n(this.sizeRampLightColor)),r.setOutline){var a=new V;a.setColor(new n(this.sizeRampDarkColor)),a.setWidth(1.5),r.setOutline(a)}return r},_getDataValues:function(e,t,r,a,s){var n;if(s)return i.some([5,3,2],(function(i){var s=this._getDataValuesByCount(e,t,r,a,i);return this._hasFractionalValues(s)||(n=s),!!n}),this),n;var l=e.authoringInfo;return l&&"univariateColorSize"===l.type&&"above-and-below"===l.univariateTheme&&r.stops?this._getDataValuesFromStops(r,a):this._getDataValuesByCount(e,t,r,a,5)},_getDataValuesFromStops:function(e,t){var r=i.map(e.stops,(function(e){return e.value}));return t?r:w.round(r)},_getDataValuesByCount:function(e,t,r,a,s,n){s=null==s?5:s,n=null==n?20:n;var l,o,d=e.getSizeRangeAtScale(r,this.map.getScale()),c=this._interpolateSizeRange(d,s),h=this._getDataRange(r),u=i.map(c,(function(e){return this._getDataValueFromSize(e,h,d)}),this);if(!a)for(u=w.round(u),l=1;l<u.length-1;l++)(o=this._roundDataValue(e,t,r,u[l],u[l-1],n))&&(u[l]=o[0],c[l]=o[1]);return u},_hasFractionalValues:function(e){return i.some(e,(function(e){return e!==Math.floor(e)}))},_getDataRange:function(e){var t=e.stops;return t?{min:t[0].value,max:t[t.length-1].value}:{min:e.minDataValue,max:e.maxDataValue}},_interpolateSizeRange:function(e,t){var r,i=e.minSize,a=(e.maxSize-i)/(t-1),s=[];for(r=0;r<t;r++)s.push(i+a*r);return s},_getDataValueFromSize:function(e,t,r){var i=r.minSize,a=r.maxSize,s=t.min,n=t.max;return e<=i?s:e>=a?n:(e-i)/(a-i)*(n-s)+s},_roundDataValue:function(e,t,r,i,a,s){var n,l,o,d,c,h,u,g,y,f,p,m,L,_,b,v=this._getSize(t,e,r,i),S=this._getSize(t,e,r,a),R=w.getDigits(i),I=R.integer,C=R.fractional;for(i>0&&i<1&&(i*=n=Math.pow(10,C),I=w.getDigits(i).integer),l=I-1;l>=0&&(o=Math.pow(10,l),d=Math.floor(i/o)*o,c=Math.ceil(i/o)*o,null!=n&&(d/=n,c/=n),h=(d+c)/2,h=w.round([d,h,c],{indexes:[1]})[1],u=this._getSize(t,e,r,d),g=this._getSize(t,e,r,c),y=this._getSize(t,e,r,h),f=w.getPctChange(v,u,S,null),p=w.getPctChange(v,g,S,null),m=w.getPctChange(v,y,S,null),L=f.prev<=s,_=p.prev<=s,L&&_&&(f.prev<=p.prev?(L=!0,_=!1):(_=!0,L=!1)),L?b=[d,u]:_?b=[c,g]:m.prev<=s&&(b=[h,y]),!b);l--);return b},_applySize:function(e,t,r,i){var a,s,n=e.type,l=this._getSize(e,t,r,i);switch(n){case"simplemarkersymbol":e.setSize(l);break;case"picturemarkersymbol":a=e.width,s=e.height,e.setHeight(l),e.setWidth(l*(a/s));break;case"simplelinesymbol":case"cartographiclinesymbol":e.setWidth(l);break;case"textsymbol":e.font&&e.font.setSize(l)}},_getSize:function(e,t,r,i){return t.getSize(i,{sizeInfo:r,scale:this.map.getScale(),shape:-1!==e.type.indexOf("markersymbol")?e.style:null})},_buildRow_Renderer:function(e,t,r,i,a,s,n,l){var o,d,c=!!l,h=y.create("tr",{},s);this.alignRight?(o=y.create("td",{align:this._isRightToLeft?"left":"right"},h),(t||c)&&(d=y.create("td",{align:this._isRightToLeft?"left":"right",width:35},h))):((t||c)&&(d=y.create("td",{width:35,align:"center"},h)),o=y.create("td",{},h));var u,g=30,f=30;if(t)if("simplemarkersymbol"===t.type)g=Math.min(Math.max(g,t.size+12),125),f=Math.min(Math.max(f,t.size+12),125);else if("picturemarkersymbol"===t.type)g=Math.min(Math.max(g,t.width),125),f=Math.min(t.height||f,125);else if("textsymbol"===t.type){var p,m;t.text||(p=t.text,m=!0,t.setText(this.defaultText)),g=Math.min(Math.max(g,t.getWidth()+12),125),f=Math.min(Math.max(f,t.getHeight()+12),125),m&&t.setText(p)}if((t||c)&&(u=y.create("div",{style:"width:"+g+"px;height:"+f+"px;"},d)),I.isDefined(i)&&"number"==typeof i&&(i=""+i),y.create("td",{innerHTML:i||"",align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%"},o)))),t||c){var L=this._drawSymbol(u,t,r,g,f,a,e,n,l);this._surfaceItems.push(L)}},_addSubHeader:function(e,t){var r=y.create("tr",{},e),i=y.create("td",{align:this._align,colspan:2},r);y.create("td",{innerHTML:b.encode(t)||"",align:this._align},y.create("tr",{},y.create("tbody",{},y.create("table",{width:"95%"},i))))},_drawSymbol:function(e,t,i,a,s,l,d,c,h){var u,g=t&&N.fromJson(t.toJson()),y=d.opacity,p=!!h;if(g)if(i&&g.setColor(new n(i.toRgba())),"simplelinesymbol"===g.type||"cartographiclinesymbol"===g.type||"textsymbol"===g.type){if(!g.color)return;(u=g.color.toRgba())[3]=u[3]*y,g.color.setColor(u)}else"simplemarkersymbol"===g.type||"simplefillsymbol"===g.type?(g.color&&((u=g.color.toRgba())[3]=u[3]*y,g.color.setColor(u)),g.outline&&g.outline.color&&((u=g.outline.color.toRgba())[3]=u[3]*y,g.outline.color.setColor(u))):"picturemarkersymbol"===g.type&&(e.style.opacity=y,e.style.filter="alpha(opacity=("+100*y+"))");var m,b=L.createSurface(e,a,s);o("ie")<9&&(m=b.getEventSource(),f.set(m,"position","relative"),f.set(m.parentNode,"position","relative"));var v,S=p?h.shapeDescriptor:this._getDrawingToolShape(g,l)||N.getShapeDescriptors(g),R=S.defaultShape,I=R&&"text"===R.type;try{I&&!R.text&&(R.text=this.defaultText),v=b.createShape(c||R).setFill(S.fill).setStroke(S.stroke),I&&v.setFont(S.font)}catch(e){return b.clear(),void b.destroy()}var w,C=v.getBoundingBox(),x=C.width,T=C.height,F=-(C.x+x/2),D=-(C.y+T/2),M=b.getDimensions(),A={dx:F+M.width/2,dy:D+M.height/2};if(g&&"simplemarkersymbol"===g.type&&"path"===g.style)w=d._getScaleMatrix(C,g.size),v.applyTransform(_.scaleAt(w.xx,w.yy,{x:M.width/2,y:M.height/2}));else if(x>a||T>s){var H=x/a>T/s,k=((H?a:s)-5)/(H?x:T);r.mixin(A,{xx:k,yy:k})}return v.applyTransform(A),p&&v.applyTransform(_.rotategAt(h.rotation,x/2,T/2)),b},_getDrawingToolShape:function(e,t){var r;switch(t&&t.drawingTool||null){case"esriFeatureEditToolArrow":r={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case"esriFeatureEditToolTriangle":r={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case"esriFeatureEditToolRectangle":r={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case"esriFeatureEditToolCircle":r={type:"circle",cx:0,cy:0,r:10};break;case"esriFeatureEditToolEllipse":r={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:r,fill:e.getFill(),stroke:e.getStroke()}},_drawRelationshipLegend:function(e,t){var r=t.focus,i=t.uvInfos,a=t.numClasses,s=B[a],n=!!r,l=Math.sqrt(Math.pow(75,2)+Math.pow(75,2)),o={};i.forEach((function(e){o[e.value]={label:e.label,fill:this._getSymbolColor(e.symbol)}}),this);for(var d=[],c=0;c<a;c++){for(var h=[],u=0;u<a;u++){var g=o[s[c][u]];h.push(g.fill)}d.push(h)}var y=this._getRelationshipCornerLabels(r,o),f=this._drawRampLayout(e,y,l,n),p=L.createSurface(f,l,l);n||(p.rawNode.style.margin="-15px -15px -18px -15px");var m=G.create2DColorRamp({surface:p,colors:d,numClasses:a,size:75}),b=(l-75)/2,v=(l-75)/2;m.applyTransform(_.translate(b,v));n&&m.applyTransform(_.rotategAt(this._getRotationAngleForFocus(r),37.5,37.5));var S=p.createGroup(),R={width:1,color:"#555555"},I=p.defNode;this._createArrowMarker(I,"start"),this._createArrowMarker(I,"end");var w=S.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(R),C=S.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(R);this._setLineArrow(w.rawNode,"left",r),this._setLineArrow(C.rawNode,"right",r),S.applyTransform(_.translate(b,v)),n&&S.applyTransform(_.rotategAt(-45,37.5,37.5)),this._surfaceItems.push(p)},_drawRampLayout:function(e,t,r,i){var a=y.create("div",{style:{padding:"10px"}},e),s=r+"px",n=r+"px",l="rtl"===document.dir;if(i){var o=y.create("div",{style:{display:"flex"}},a),d=(y.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:s,textAlign:"right"},innerHTML:l?t.right:t.left},o),y.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},o)),c=(y.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:s},innerHTML:l?t.left:t.right},o),y.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:s},innerHTML:t.top},d)),h=y.create("div",{style:{height:n,width:n}},d),u=y.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:s},innerHTML:t.bottom},d);return h}var g=y.create("div",{style:{display:"table",color:"#555555"}},a),f=(c=y.create("div",{style:{display:"table-row"}},g),y.create("div",{style:{display:"table-row"}},g));u=y.create("div",{style:{display:"table-row"}},g),y.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:s,textAlign:"right",verticalAlign:"bottom"},innerHTML:l?t.top:t.left},c),y.create("div",{style:{display:"table-cell"}},c),y.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:s,textAlign:"left",verticalAlign:"bottom"},innerHTML:l?t.left:t.top},c),y.create("div",{style:{display:"table-cell"}},f),h=y.create("div",{style:{display:"table-cell"}},f),y.create("div",{style:{display:"table-cell"}},f),y.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:s,textAlign:"right",verticalAlign:"top"},innerHTML:l?t.right:t.bottom},u),y.create("div",{style:{display:"table-cell"}},u),y.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:s,textAlign:"left",verticalAlign:"top"},innerHTML:l?t.bottom:t.right},u);return h},_getSymbolColor:function(e){if(e){if("simplelinesymbol"===e.type||"simplemarkersymbol"===e.type&&(e.style===E.STYLE_X||e.style===E.STYLE_CROSS)){var t=e.getStroke();return t&&t.color}return e.getFill()}},_getRotationAngleForFocus:function(e){var t=X[e];return e&&null==t&&(t=X.HH),t},_setLineArrow:function(e,t,r){var i=this.id+"_arrowStart",a=this.id+"_arrowEnd",s="left"===t;switch(r){case"HL":var n=s?"marker-start":"marker-end",l=s?a:i;e.setAttribute(n,"url(#"+l+")");break;case"LL":e.setAttribute("marker-start","url(#"+a+")");break;case"LH":n=s?"marker-end":"marker-start",l=s?i:a;e.setAttribute(n,"url(#"+l+")");break;default:e.setAttribute("marker-end","url(#"+i+")")}},_createArrowMarker:function(e,t){var r="start"===t,i=this.id+(r?"_arrowStart":"_arrowEnd"),a=r?"0,0 5,5 0,10":"5,0 0,5 5,10",s=r?5:0,n=document.createElementNS(W,"marker");n.setAttribute("id",i),n.setAttribute("markerWidth","10"),n.setAttribute("markerHeight","10"),n.setAttribute("refX",s),n.setAttribute("refY","5"),n.setAttribute("markerUnits","strokeWidth"),n.setAttribute("orient","auto");var l=document.createElementNS(W,"polyline");l.setAttribute("points",a),l.setAttribute("fill","none"),l.setAttribute("stroke","#555555"),l.setAttribute("stroke-width","1"),n.appendChild(l),e.appendChild(n)},_getRelationshipCornerLabels:function(e,t){var r=t.HH.label,i=t.LL.label,a=t.HL.label,s=t.LH.label;switch(e){case"HH":return{top:r,bottom:i,left:a,right:s};case"HL":return{top:a,bottom:s,left:i,right:r};case"LL":return{top:i,bottom:r,left:s,right:a};case"LH":return{top:s,bottom:a,left:r,right:i};default:return{top:r,bottom:i,left:a,right:s}}},_repaintItems:function(){i.forEach(this._surfaceItems,(function(e){this._repaint(e)}),this)},_repaint:function(e){if(e){e.getStroke&&e.setStroke&&e.setStroke(e.getStroke());try{e.getFill&&e.setFill&&e.setFill(e.getFill())}catch(e){}e.children&&r.isArray(e.children)&&i.forEach(e.children,this._repaint,this)}},_createHoverAction:function(e,t,i,s){var n=t._hoverLabel||t._hoverLabels&&t._hoverLabels[i.id]||s;n&&(n=b.encode(n),t.mouseMoveHandler=t.mouseMoveHandler||{},t.mouseMoveHandler[i.id]=a.connect(e,"onmousemove",r.hitch(this,(function(e,t){this.mouseX=t.clientX,this.mouseY=t.clientY,this.hoverLabelShowing&&(this.hoverLabelShowing=!1,f.set(g.byId(this.id+"_hoverLabel"),"display","none")),setTimeout(r.hitch(this,(function(e,t,r){if(e==this.mouseX&&t==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,g.byId(this.id+"_hoverLabel")){var i=g.byId(this.id+"_hoverLabel");i.innerHTML="<span>"+r+"</span>",f.set(i,"top",t+"px"),f.set(i,"left",e+15+"px"),f.set(i,"display","")}else y.create("div",{innerHTML:"<span>"+r+"</span>",id:this.id+"_hoverLabel",class:"esriLegendHoverLabel",style:{top:t+"px",left:e+15+"px"}},document.body)}),t.clientX,t.clientY,e),500)}),n)),t.mouseOutHandler=t.mouseOutHandler||{},t.mouseOutHandler[i.id]=a.connect(e,"onmouseout",r.hitch(this,(function(e){this.mouseX=-1,this.mouseY=-1,this.hoverLabelShowing&&(this.hoverLabelShowing=!1,f.set(g.byId(this.id+"_hoverLabel"),"display","none"))}))))},_removeHoverHandlers:function(){var e;i.forEach(this.layers,(function(t){if(t.mouseMoveHandler)for(e in t.mouseMoveHandler)a.disconnect(t.mouseMoveHandler[e]);if(t.mouseOutHandler)for(e in t.mouseOutHandler)a.disconnect(t.mouseOutHandler[e])}))},_createDynamicLayers:function(e){var t,r=[],a=e.dynamicLayerInfos||e.layerInfos;return i.forEach(a,(function(i){var a,s;(t={id:i.id}).source=i.source&&i.source.toJson(),e.layerDefinitions&&e.layerDefinitions[i.id]&&(a=e.layerDefinitions[i.id]),a&&(t.definitionExpression=a),e.layerDrawingOptions&&e.layerDrawingOptions[i.id]&&(s=e.layerDrawingOptions[i.id]),s&&(t.drawingInfo=s.toJson()),t.minScale=i.minScale||0,t.maxScale=i.maxScale||0,r.push(t)})),r},_getTemplateFromTypes:function(e,t){var r;for(r=0;r<e.length;r++)if(e[r].id==t&&e[r].templates&&e[r].templates.length>0)return e[r].templates[0];return null},_findParentGroup:function(e,t,r){var i,a=t.dynamicLayerInfos||t.layerInfos;for(i=0;i<a.length;i++)if(r==a[i].id){a[i].parentLayerId>-1&&(f.set(g.byId(this.id+"_"+e+"_"+a[i].parentLayerId+"_group"),"display","block"),this._findParentGroup(e,t,a[i].parentLayerId));break}},_addSubLayersToHide:function(e){e.layer.layerInfos&&i.forEach(this.hideLayersInLegend[e.layer.id],(function(t){!function t(r,a){var s,n,l=e.layer.dynamicLayerInfos||e.layer.layerInfos;for(s=0;s<l.length;s++)if(l[s].id===r&&l[s].subLayerIds)for(n=0;n<l[s].subLayerIds.length;n++){var o=l[s].subLayerIds[n];-1===i.indexOf(a,o)&&(a.push(o),t(o,a))}}(t,this.hideLayersInLegend[e.layer.id])}),this)},_isLayerInScale:function(e,t,r){var i,a=!0;if(e.legendResponse&&e.legendResponse.layers)for(i=0;i<e.legendResponse.layers.length;i++){var s=e.legendResponse.layers[i];if(t.id==s.layerId){var n,l;!e.minScale&&0!==e.minScale||!e.maxScale&&0!==e.maxScale?(0==s.minScale&&e.tileInfo&&(n=e.tileInfo.lods[0].scale),0==s.maxScale&&e.tileInfo&&(l=e.tileInfo.lods[e.tileInfo.lods.length-1].scale)):(n=Math.min(e.minScale,s.minScale)||e.minScale||s.minScale,l=Math.max(e.maxScale,s.maxScale)),(n>0&&n<r||l>r)&&(a=!1);break}}else(e.minScale||e.maxScale)&&(e.minScale&&e.minScale<r||e.maxScale&&e.maxScale>r)&&(a=!1);return a},_getServiceTitle:function(e){var t=e._titleForLegend;if(t||(t=e.url,e.url?e.url.indexOf("/MapServer")>-1?t=(t=e.url.substring(0,e.url.indexOf("/MapServer"))).substring(t.lastIndexOf("/")+1,t.length):e.url.indexOf("/ImageServer")>-1?t=(t=e.url.substring(0,e.url.indexOf("/ImageServer"))).substring(t.lastIndexOf("/")+1,t.length):e.url.indexOf("/FeatureServer")>-1&&(t=(t=e.url.substring(0,e.url.indexOf("/FeatureServer"))).substring(t.lastIndexOf("/")+1,t.length)):t="",e.name&&(t.length>0?t+=" - "+e.name:t=e.name)),"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass&&e.vectorFieldPixelFilter){var r=e.vectorFieldPixelFilter.outputUnit?this["NLS_"+e.vectorFieldPixelFilter.outputUnit]:this["NLS_"+e.vectorFieldPixelFilter.inputUnit];I.isDefined(r)&&(t+=" ("+r+")")}return b.encode(t)},_getEffectiveScale:function(e,t){var r=t.minScale,i=t.maxScale;if(I.isDefined(t.parentLayerId)){var a,s=e.layerInfos,n=t.parentLayerId;for(a=s.length-1;a>=0;a--)if(s[a].id==n){if(0==r&&s[a].minScale>0?r=s[a].minScale:r>0&&0==s[a].minScale?r=r:r>0&&s[a].minScale>0&&(r=Math.min(r,s[a].minScale)),i=Math.max(i||0,s[a].maxScale||0),!(s[a].parentLayerId>-1))break;n=s[a].parentLayerId}}return{minScale:r,maxScale:i}},_isSupportedLayerType:function(e){return!(!e||!("esri.layers.ArcGISDynamicMapServiceLayer"===e.declaredClass||"esri.layers.ArcGISImageServiceLayer"===e.declaredClass&&e.version>=10.2||"esri.layers.RasterXLayer"===e.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===e.declaredClass||"esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass||"esri.layers.KMLLayer"===e.declaredClass||"esri.layers.GeoRSSLayer"===e.declaredClass||"esri.layers.WMSLayer"===e.declaredClass||"esri.layers.WFSLayer"===e.declaredClass||"esri.layers.CSVLayer"===e.declaredClass))},isHostedTileService:function(e){return!("esri.layers.ArcGISTiledMapServiceLayer"!==e.declaredClass||!/(https?:)?\/\/services.*\.arcgis\.com/i.test(e.url))},getField:function(e,t,r){return e.getField?e.getField(t):r&&r.fields?(i.forEach(r.fields,(function(e){e.name===t&&(a=e)})),a):null;var a}});return r.mixin(Y,{ALIGN_LEFT:0,ALIGN_RIGHT:1}),o("extend-esri")&&r.setObject("dijit.Legend",Y,v),Y}));