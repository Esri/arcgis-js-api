define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/Color","dojo/has","dojo/sniff","dojo/DeferredList","dojo/json","dojo/dom","dojo/dom-construct","dojo/dom-style","dijit/_Widget","dojox/gfx","dojox/gfx/matrix","dojox/html/entities","../kernel","../config","../request","../lang","../numberUtils","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/ClassBreaksRenderer","../renderers/ScaleDependentRenderer","../renderers/DotDensityRenderer","../renderers/TemporalRenderer","../renderers/VectorFieldRenderer","../renderers/HeatmapRenderer","../symbols/PictureFillSymbol","../symbols/jsonUtils","./_EventedWidget","dojo/i18n!../nls/jsapi"],function(e,t,i,r,a,s,n,l,o,d,c,h,g,u,y,f,p,m,_,L,v,b,S,I,R,x,C,w,F,T,M,H,A,D,k){var z=t([D,y],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,defaultText:"Aa",gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"<",gt:">"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(e,t){return i.mixin(this,k.widgets.legend),this._i18n=k.widgets.legend,e=e||{},e.map?t?(this.map=e.map,this.layerInfos=e.layerInfos,this._respectCurrentMapScale=e.respectCurrentMapScale===!1?!1:!0,this._respectVisibility=e.respectVisibility===!1?!1:!0,this.arrangement=e.arrangement===z.ALIGN_RIGHT?z.ALIGN_RIGHT:z.ALIGN_LEFT,this.arrangement===z.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=e.autoUpdate===!1?!1:!0,this._surfaceItems=[],void(this.hideLayersInLegend={})):void console.error("esri.dijit.Legend: must specify a container for the legend"):void console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var t,i,r=["ar","he"];for(t=0;t<r.length;t+=1)i=r[t],e.locale&&-1!==e.locale.indexOf(i)&&(-1!==e.locale.indexOf("-")?-1!==e.locale.indexOf(i+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments),this._initialize(),l("ie")<9&&(this._repaintItems=i.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate(),this._removeHoverHandlers(),this.inherited(arguments)},refresh:function(e){var t;if(this.domNode){for(e?(this.layerInfos=e,this.layers=[],r.forEach(this.layerInfos,function(e){this._isSupportedLayerType(e.layer)&&(e.title&&(e.layer._titleForLegend=e.title),e.layer._hideDefaultSymbol=e.defaultSymbol===!1?!0:!1,e.hideLayers?(this.hideLayersInLegend[e.layer.id]=e.hideLayers,this._addSubLayersToHide(e)):this.hideLayersInLegend[e.layer.id]=[],e.hoverLabel&&(e.layer._hoverLabel=e.hoverLabel),e.hoverLabels&&(e.layer._hoverLabels=e.hoverLabels),this.layers.push(e.layer))},this)):this.useAllMapLayers&&(this.layerInfos=null,this.layers=null),t=this.domNode.children.length-1;t>=0;t--)g.destroy(this.domNode.children[t]);this._removeHoverHandlers(),this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos&&(this.layers=[],r.forEach(this.layerInfos,function(e){this._isSupportedLayerType(e.layer)&&(e.title&&(e.layer._titleForLegend=e.title),e.layer._hideDefaultSymbol=e.defaultSymbol===!1?!0:!1,e.hideLayers?(this.hideLayersInLegend[e.layer.id]=e.hideLayers,this._addSubLayersToHide(e)):this.hideLayersInLegend[e.layer.id]=[],e.hoverLabel&&(e.layer._hoverLabel=e.hoverLabel),e.hoverLabels&&(e.layer._hoverLabels=e.hoverLabels),this.layers.push(e.layer))},this)),this.useAllMapLayers=!1,!this.layers){this.useAllMapLayers=!0,this.layers=[];var e=[],t=[];r.forEach(this.map.layerIds,function(i){var a,s=this.map.getLayer(i);this._isSupportedLayerType(s)&&(s.arcgisProps&&s.arcgisProps.title&&(s._titleForLegend=s.arcgisProps.title),this.layers.push(s)),"esri.layers.KMLLayer"==s.declaredClass&&(a=s.getLayers(),r.forEach(a,function(t){e.push(t.id)},this)),"esri.layers.GeoRSSLayer"==s.declaredClass&&(a=s.getFeatureLayers(),r.forEach(a,function(e){t.push(e.id)},this))},this),r.forEach(this.map.graphicsLayerIds,function(i){var a=this.map.getLayer(i);-1==r.indexOf(e,i)&&-1==r.indexOf(t,i)&&this._isSupportedLayerType(a)&&a._params&&a._params.drawMode&&(a.arcgisProps&&a.arcgisProps.title&&(a._titleForLegend=a.arcgisProps.title),this.layers.push(a))},this)}this._createLegend()},_activate:function(){this._deactivate(),this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=a.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=a.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=a.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=a.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),r.forEach(this.layers,function(e){e.ovcConnect=a.connect(e,"onVisibilityChange",this,"_refreshLayers"),e.oscConnect=a.connect(e,"onScaleRangeChange",this,"_refreshLayers"),"esri.layers.ArcGISDynamicMapServiceLayer"===e.declaredClass&&e.supportsDynamicLayers&&(e.odcConnect=a.connect(e,"_onDynamicLayersChange",i.hitch(this,"_updateDynamicLayers",e))),"esri.layers.ArcGISImageServiceLayer"===e.declaredClass&&(e.oirConnect=a.connect(e,"onRenderingChange",i.partial(this._updateImageServiceLayers,this,e))),"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass&&(e.oivrConnect=a.connect(e,"onRendererChange",i.hitch(this,"_refreshLayers")))},this))},_deactivate:function(){this._ozeConnect&&a.disconnect(this._ozeConnect),this._olaConnect&&a.disconnect(this._olaConnect),this._olroConnect&&a.disconnect(this._olroConnect),this._olrConnect&&a.disconnect(this._olrConnect),r.forEach(this.layers,function(e){e.ovcConnect&&a.disconnect(e.ovcConnect),e.oscConnect&&a.disconnect(e.oscConnect),e.odcConnect&&a.disconnect(e.odcConnect),e.oirConnect&&a.disconnect(e.oirConnect),e.oivrConnect&&a.disconnect(e.oivrConnect)},this)},_updateDynamicLayers:function(e){delete e.legendResponse,this._refreshLayers()},_updateImageServiceLayers:function(e,t){delete t.legendResponse,e._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[],r.forEach(this.map.layerIds,function(e){var t=this.map.getLayer(e);this._isSupportedLayerType(t)&&this.layers.push(t)},this),r.forEach(this.map.graphicsLayerIds,function(e){var t=this.map.getLayer(e);this._isSupportedLayerType(t)&&t._params&&t._params.drawMode&&this.layers.push(t)},this),this.refresh()},_createLegend:function(){var e=!1;u.set(this.domNode,"position","relative"),g.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var t=[];r.forEach(this.layers,function(s){if("esri.layers.KMLLayer"==s.declaredClass||"esri.layers.GeoRSSLayer"==s.declaredClass){var n;s.loaded?("esri.layers.KMLLayer"==s.declaredClass?n=s.getLayers():"esri.layers.GeoRSSLayer"==s.declaredClass&&(n=s.getFeatureLayers(),this.hideLayersInLegend[s.id]&&(n=r.filter(n,function(e){return-1==r.indexOf(this.hideLayersInLegend[s.id],e.id)},this))),r.forEach(n,function(e){"esri.layers.FeatureLayer"==e.declaredClass&&s._titleForLegend&&(e._titleForLegend=s._titleForLegend+" - ","esriGeometryPoint"==e.geometryType?e._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==e.geometryType?e._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==e.geometryType&&(e._titleForLegend+=this.NLS_polygons),t.push(e))},this)):a.connect(s,"onLoad",i.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===s.declaredClass)if(s.loaded){if((!this._respectVisibility||this._respectVisibility&&s.visible)&&s.layerInfos.length>0&&r.some(s.layerInfos,function(e){return e.legendURL})){var l=!1;r.forEach(s.layerInfos,function(t){if(t.legendURL&&r.indexOf(s.visibleLayers,t.name)>-1){if(!l){var i=s._titleForLegend||s.name||s.id;g.create("div",{innerHTML:"<span class='esriLegendServiceLabel'>"+i+"</span>"},this.domNode),l=!0}g.create("div",{innerHTML:"<img src='"+t.legendURL+"'/>"},this.domNode),e=!0}},this)}}else a.connect(s,"onLoad",i.hitch(this,function(){this.refresh(this.layerInfos)}));else t.push(s)},this);var s=[];if(r.forEach(t,function(e){if(e.loaded){if((!this._respectVisibility||this._respectVisibility&&e.visible)&&(e.layerInfos||e.renderer||"esri.layers.ArcGISImageServiceLayer"==e.declaredClass)){var t=g.create("div",{id:this.id+"_"+e.id,style:{display:"none"},"class":"esriLegendService"});g.create("span",{innerHTML:this._getServiceTitle(e),"class":"esriLegendServiceLabel"},g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},t))))),g.place(t,this.id,"first"),e.legendResponse||e.renderer?this._createLegendForLayer(e):s.push(this._legendRequest(e))}}else var i=a.connect(e,"onLoad",this,function(){a.disconnect(i),i=null,this.refresh()})},this),0!==s.length||e){var n=new d(s);n.addCallback(i.hitch(this,function(){h.byId(this.id+"_msg").innerHTML=e?"":this.NLS_noLegend,this._activate()}))}else h.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()},_createLegendForLayer:function(e){if(e.legendResponse||e.renderer){var t=!1;if(e.legendResponse){var i=e.dynamicLayerInfos||e.layerInfos;i&&i.length?r.forEach(i,function(i,a){if(!this.hideLayersInLegend[e.id]||-1==r.indexOf(this.hideLayersInLegend[e.id],i.id)){var s=this._buildLegendItems(e,i,a);t=t||s}},this):"esri.layers.ArcGISImageServiceLayer"==e.declaredClass&&(t=this._buildLegendItems(e,{id:0,name:null,title:e.name,subLayerIds:null,parentLayerId:-1},0))}else if(e.renderer){var a;a=e.url?e.url.substring(e.url.lastIndexOf("/")+1,e.url.length):"fc_"+e.id,t=this._buildLegendItems(e,{id:a,name:null,subLayerIds:null,parentLayerId:-1},0)}t&&(u.set(h.byId(this.id+"_"+e.id),"display","block"),u.set(h.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(e){return e.loaded?e.version>=10.01?this._legendRequestServer(e):this._legendRequestTools(e):void a.connect(e,"onLoad",i.hitch(this,"_legendRequest"))},_legendRequestServer:function(e){var t=e.url,r=t.indexOf("?");r>-1?t=t.substring(0,r)+"/legend"+t.substring(r):t+="/legend";var a=e._getToken();a&&(t+="?token="+a);var s=i.hitch(this,"_processLegendResponse"),n={};n.f="json",e._params.dynamicLayers&&(n.dynamicLayers=c.stringify(this._createDynamicLayers(e)),"[{}]"===n.dynamicLayers&&(n.dynamicLayers="[]")),e._params.bandIds&&(n.bandIds=e._params.bandIds),e._params.renderingRule&&(n.renderingRule=e._params.renderingRule);var l=v({url:t,content:n,callbackParamName:"callback",load:function(t,i){s(e,t,i)},error:L.defaults.io.errorHandler});return l},_legendRequestTools:function(e){var t=e.url.toLowerCase().indexOf("/rest/"),r=e.url.substring(0,t)+e.url.substring(t+5,e.url.length),a=this._legendUrl+"?soapUrl="+window.escape(r);(!l("ie")||l("ie")>8)&&(a+="&returnbytes=true");var s=i.hitch(this,"_processLegendResponse"),n={};n.f="json";var o=v({url:a,content:n,callbackParamName:"callback",load:function(t,i){s(e,t,i)},error:L.defaults.io.errorHandler});return o},_processLegendResponse:function(e,t){t&&t.layers?(e.legendResponse=t,h.byId(this.id+"_"+e.id)&&g.empty(h.byId(this.id+"_"+e.id)),g.create("span",{innerHTML:this._getServiceTitle(e),"class":"esriLegendServiceLabel"},g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},h.byId(this.id+"_"+e.id)))))),this._createLegendForLayer(e)):console.log("Legend could not get generated for "+e.url+": "+s.toJson(t))},_buildLegendItems:function(e,t,i){var r=!1,a=h.byId(this.id+"_"+e.id),s=t.subLayerIds,n=t.parentLayerId;if(s){var l=g.create("div",{id:this.id+"_"+e.id+"_"+t.id+"_group",style:{display:"none"},"class":-1==n?i>0?"esriLegendGroupLayer":"":this._legendAlign},-1==n?a:h.byId(this.id+"_"+e.id+"_"+n+"_group"));g.create("td",{innerHTML:m.encode(t.name),align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%","class":"esriLegendLayerLabel"},l))))}else{if(this._respectVisibility&&e.visibleLayers&&-1==(","+e.visibleLayers+",").indexOf(","+t.id+","))return r;var o=g.create("div",{id:this.id+"_"+e.id+"_"+t.id,style:{display:"none"},"class":n>-1?this._legendAlign:""},-1==n?a:h.byId(this.id+"_"+e.id+"_"+n+"_group"));g.create("td",{innerHTML:m.encode(t.name)||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%","class":"esriLegendLayerLabel"},o)))),e.legendResponse?r=r||this._buildLegendItems_Tools(e,t,o):e.renderer&&(r=r||this._buildLegendItems_Renderer(e,t,o))}return r},_buildLegendItems_Tools:function(e,t,i){var a=t.parentLayerId,s=this.map.getScale(),n=!1,l=function(e,t){var i,r;for(i=0;i<e.length;i++)if(t.dynamicLayerInfos){for(r=0;r<t.dynamicLayerInfos[r].length;r++)if(t.dynamicLayerInfos[r].mapLayerId==e[i].layerId)return e[i]}else if(t.id==e[i].layerId)return e[i];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(e,t,s)){var o=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===e.declaredClass||"esri.layers.ArcGISMapServiceLayer"===e.declaredClass)){var d=this._getEffectiveScale(e,t);(d.minScale&&d.minScale<s||d.maxScale&&d.maxScale>s)&&(o=!1)}if(o){var c=l(e.legendResponse.layers,t),y=c.legendType,f=c.legend;if(f){"esri.layers.ArcGISImageServiceLayer"!==e.declaredClass&&this._sanitizeLegendResponse(e,c,t);var p=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},i),m=g.create("tbody",{},p);(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(p,e,t),r.forEach(f,function(i){e.version>=10.1&&!i.values&&f.length>1&&(e._hideDefaultSymbol||"<all other values>"===i.label||!i.label&&!("esri.layers.ArcGISImageServiceLayer"===e.declaredClass&&e.version>=10.3))||(i.url&&0===i.url.indexOf("http")||i.imageData&&i.imageData.length>0)&&(n=!0,this._buildRow_Tools(i,m,e,t.id,y))},this)}else;}}return n&&(u.set(h.byId(this.id+"_"+e.id+"_"+t.id),"display","block"),a>-1&&(u.set(h.byId(this.id+"_"+e.id+"_"+a+"_group"),"display","block"),this._findParentGroup(e.id,e,a))),n},_sanitizeLegendResponse:function(e,t,a){var s=t.legend;if(e.version>=10.1&&s.length>1&&!t._sanitized){var n,l,o=i.getObject("layerDefinition.drawingInfo.renderer",!1,a);o||(o=i.getObject("drawingInfo.renderer",!1,a));var d=r.some(s,function(e){return e.values?!0:void 0});d&&r.some(s,function(e,t){return e.values||(l=t,n=e),!!n}),o?"uniqueValue"===o.type?n&&(s.splice(l,1),s.push(n)):"classBreaks"===o.type&&(n&&s.splice(l,1),s.reverse(),n&&s.push(n)):n&&(s.splice(l,1),s.push(n)),t._sanitized=!0}},_buildRow_Tools:function(e,t,i,r,a){var s,n,o=g.create("tr",{},t);this.alignRight?(s=g.create("td",{align:this._isRightToLeft?"left":"right"},o),n=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},o)):(n=g.create("td",{width:35,align:"center"},o),s=g.create("td",{},o));var d=e.url;if((!l("ie")||l("ie")>=9||l("ie")<9&&"esri.layers.ArcGISImageServiceLayer"===i.declaredClass)&&e.imageData&&e.imageData.length>0)d="data:image/png;base64,"+e.imageData;else if(0!==e.url.indexOf("http")){d=i.url+"/"+r+"/images/"+e.url;var c=i._getToken();c&&(d+="?token="+c)}var h=g.create("img",{src:d,border:0,style:"opacity:"+i.opacity},n),u=g.create("td",{innerHTML:m.encode(e.label),align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%",dir:"ltr"},s))));a&&"Stretched"===a&&i.version>=10.3&&"esri.layers.ArcGISImageServiceLayer"===i.declaredClass&&(u.style.verticalAlign="top",u.style.lineHeight="1",h.style.marginBottom="-1px",h.style.display="block",s.style.verticalAlign="top"),l("ie")<9&&(h.style.filter="alpha(opacity="+100*i.opacity+")")},_getVariable:function(e,t,i){var r,a;return e&&(r=e.getVisualVariablesForType(t,i),a=r&&r[0]),a},_getFieldAlias:function(e,t){var r=t.infoTemplate,a=r&&r.getFieldInfo&&r.getFieldInfo(e),s=i.isFunction(e)?null:t.getField(e),n=a||s,l="";return n&&(l=a&&a.label||s&&s.alias||n.name||n.fieldName),l},_getDefaultHoverLabel:function(e,t){var i;if(e){var r,a,s,n,l,o,d=this._getVariable(e,"colorInfo",!1),c=this._getVariable(e,"opacityInfo",!1),h=this._getVariable(e,"sizeInfo",!1),g=d||h||c;e instanceof M?r=e.field:e instanceof R&&!e.attributeField2&&!e.attributeField3?(r=e.attributeField,g&&(s=g.field,n=g.normalizationField)):e instanceof x?g?(r=g.field,a=g.normalizationField):(r=e.attributeField,a=e.normalizationField,l="percent-of-total"===e.normalizationType):e instanceof I&&g&&(r=g.field,a=g.normalizationField),o=n&&"showOpNormField"||s&&"showOpField"||a&&"showNormField"||(l?"showNormPct":null)||r&&"showField"||null,o&&(i=b.substitute({field:r&&this._getFieldAlias(r,t),normField:a&&this._getFieldAlias(a,t),opField:s&&this._getFieldAlias(s,t),opNormField:n&&this._getFieldAlias(n,t)},this._i18n[o]))}return i},_buildLegendItems_Renderer:function(e,t,a){var s=t.parentLayerId,n=this.map,l=n.getScale(),o=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(e,t,l)){var d,c,y,f,p,_,L,v,b,S,H="esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass?e.renderer.renderer:e.renderer;if(H instanceof C&&(y="zoom"===H.rangeType?H.getRendererInfoByZoom(n.getZoom()):H.getRendererInfoByScale(l),H=y&&y.renderer,!H))return!1;var A=this._getVariable(H,"colorInfo",!1),D=this._getVariable(H,"opacityInfo",!1),k=this._getVariable(H,"sizeInfo",!1),z=this._getDefaultHoverLabel(H,e);if(A?(f=this._getMedianColor(H,A),A.field&&(_=i.isFunction(A.field)?null:e.getField(A.field))):D&&(v=i.isFunction(D.field)?null:e.getField(D.field),b=D.normalizationField),k&&k.field&&(L=i.isFunction(k.field)?null:e.getField(k.field)),H instanceof M)o=!0,this._showHeatRamp(e,t,H,a,z);else if(H instanceof w)o=!0,this._showDotDensityLegend(e,t,H,a);else if(H instanceof F)o=!0,c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},c),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(c,e,t),H.latestObservationRenderer&&H.latestObservationRenderer instanceof I&&this._buildRow_Renderer(e,H.latestObservationRenderer.symbol,f,m.encode(H.latestObservationRenderer.label)||this.NLS_currentObservations,null,d),H.observationRenderer&&H.observationRenderer instanceof I&&this._buildRow_Renderer(e,H.observationRenderer.symbol,f,m.encode(H.observationRenderer.label)||this.NLS_previousObservations,null,d);else if(H instanceof R){if(H.infos&&H.infos.length>0){o=!0,c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},c),(e._hoverLabel||e._hoverLabels||z)&&this._createHoverAction(c,e,t,z);var O=[];r.forEach(H.infos,function(t){var i=null;e._editable&&e.types&&(i=this._getTemplateFromTypes(e.types,t.value));var a=t.label;null==a&&(a=t.value),-1===r.indexOf(O,a)&&(O.push(a),this._buildRow_Renderer(e,t.symbol,f,m.encode(a),i,d))},this)}}else if(H instanceof x){if(H.infos&&H.infos.length>0||"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass){o=!0;var E=_||L||v;if(!E||!this._isSmartRenderer(H,E.name)){c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},c);var V=(H.normalizationField||"percent-of-total"===H.normalizationType)&&z?z:this._getFieldAlias(H.attributeField,e);this._buildRow_Renderer(e,null,f,m.encode(V),null,d)}c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},c),(e._hoverLabel||e._hoverLabels||z)&&this._createHoverAction(c,e,t,z);var G=H.infos.slice(0).reverse();r.forEach(G,function(t){var i=t.label;if(null==i){var r=_||L||v;i=r&&this._isSmartRenderer(H,r.name)?H.normalizationField&&z?z:this._getFieldAlias(r.name,e):t.minValue+" - "+t.maxValue}this._buildRow_Renderer(e,t.symbol,f,m.encode(i),null,d)},this),"esri.layers.ArcGISImageServiceVectorLayer"!==e.declaredClass||e.renderer.style!==T.STYLE_SCALAR&&e.renderer.style!==T.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(e,H.defaultSymbol,null,"",null,d),e._hideDefaultSymbol=!0)}}else if(H instanceof I){o=!0,c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},c),(e._hoverLabel||e._hoverLabels||z)&&this._createHoverAction(c,e,t,z);var N=null;e._editable&&e.templates&&e.templates.length>0&&(N=e.templates[0]),S=(_||v)&&L?null:_||v||L,this._buildRow_Renderer(e,H.symbol,f,m.encode(b&&z?z:S?this._getFieldAlias(S.name,e):H.label),N,d),p=H.symbol&&H.symbol.color,S&&(_=v=L=null)}o&&(A&&A.field?(_&&this._isSmartRenderer(H,_.name)&&(_=null),this._showColorRamp(e,t,H,null,a,A,_,z)):D&&p&&this._showColorRamp(e,t,H,p,a,D,v,z),k&&k.field&&(L&&this._isSmartRenderer(H,L.name)&&(L=null),this._showSizeLegend(e,t,H,k,f,a,L,z))),!e._hideDefaultSymbol&&H.defaultSymbol&&(o=!0,c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},c),this._buildRow_Renderer(e,H.defaultSymbol,null,m.encode(H.defaultLabel)||"others",null,d))}return o&&(u.set(h.byId(this.id+"_"+e.id+"_"+t.id),"display","block"),s>-1&&(u.set(h.byId(this.id+"_"+e.id+"_"+s+"_group"),"display","block"),this._findParentGroup(e.id,s))),o},_isSmartRenderer:function(e,t){return e instanceof x&&e.infos&&1===e.infos.length&&e.attributeField===t},_showColorRamp:function(e,t,i,r,a,s,n,l){var o,d,c;o=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},a),d=g.create("tbody",{},o),(e._hoverLabel||e._hoverLabels||l)&&this._createHoverAction(o,e,t,l),n&&this._addSubHeader(d,this._getFieldAlias(n.name,e)),c=this._getRampStops(i,s,r),c.length&&this._drawColorRamp(d,c,!0,e,this._getRampBorderColor(i))},_getMedianColor:function(e,t){var i,r;t.colors?(i=t.minDataValue,r=t.maxDataValue):t.stops&&(i=t.stops[0].value,r=t.stops[t.stops.length-1].value);var a=i+(r-i)/2;return e.getColor(a,{colorInfo:t})},_getRampStops:function(e,t,i){var a,s,l,o,d,c=!1;t.colors||t.opacityValues?(l=t.maxDataValue-t.minDataValue,a=r.map([0,.25,.5,.75,1],function(e){return o=t.minDataValue+e*l,Number(o.toFixed(6))}),this._checkPrecision(0,4,a)):t.stops&&(a=r.map(t.stops,function(e){return e.value}),c=r.some(t.stops,function(e){return!!e.label}),c&&(d=r.map(t.stops,function(e){return e.label})));var h,g,u,y=a[0],f=a[a.length-1];return l=f-y,s=r.map(a,function(r,s){return i?(h=new n(i.toRgba()),g=e.getOpacity(r,{opacityInfo:t}),null!=g&&(h.a=g)):h=e.getColor(r,{colorInfo:t}),u="",0===s?u=this._specialChars.lt+" ":s===a.length-1&&(u=this._specialChars.gt+" "),{value:r,color:h,offset:1-(r-y)/l,label:c?d[s]:u+S.format(r)}},this),s.reverse()},_checkPrecision:function(e,t,i){var r=e+(t-e)/2,a=i[e],s=i[r],n=i[t],l=Math.floor(a),o=Math.floor(s),d=Math.floor(n);l===a&&d===n&&o!==s&&l!==o&&d!==o&&(i[r]=o),e+1!==r&&this._checkPrecision(e,r,i),r+1!==t&&this._checkPrecision(r,t,i)},_getRampBorderColor:function(e){var t,i,r;return e instanceof I?t=e.symbol:(e instanceof R||e instanceof x)&&(t=e.infos[0].symbol),i=t&&-1===t.type.indexOf("linesymbol")?t.getStroke():null,r=i&&i.color},_drawColorRamp:function(e,t,i,a,s){var o,d,c,h,y,p,_,L,v,b,S,I=g.create("tr",{},e),R=t.length-1,x=0;this.alignRight?(o=g.create("td",{align:this._isRightToLeft?"left":"right"},I),d=g.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},I)):(d=g.create("td",{width:this.gradientWidth,align:"center"},I),o=g.create("td",{},I));var C=s&&s.a>0&&!(s.r>=240&&s.g>=240&&s.b>=240);c=g.create("div",{"class":C?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},d),h=g.create("div",{"class":"esriLegendColorRamp"},c),v=u.get(h,"width"),C&&(s=l("ie")<9?s.toHex():"rgba("+s.toRgba().join(",")+")",u.set(h,"border",this.colorRampBorder+" "+s)),i?(b=this.gradientHeight*R,u.set(h,"height",b+"px")):b=u.get(h,"height"),u.set(c,"height",b+"px"),p=f.createSurface(h,v,b),l("ie")<9&&(_=p.getEventSource(),u.set(_,"position","relative"),u.set(_.parentNode,"position","relative"),x=1);try{i&&r.forEach(t,function(e,t){e.offset=t/R}),L=p.createRect({x:-x,y:-x,width:v+x,height:b+x}),L.setFill({type:"linear",x1:0,y1:0,x2:0,y2:b,colors:t}).setStroke(null),p.createRect({width:v,height:b}).setFill(new n([255,255,255,1-a.opacity])).setStroke(null),this._surfaceItems.push(p)}catch(w){p.clear(),p.destroy()}r.forEach(t,function(e,i){if(e.label){S="top:"+100*e.offset+"%;";var r="";0===i&&(r+=" esriLegendColorRampTickFirst"),i===t.length-1&&(r+=" esriLegendColorRampTickLast"),g.create("div",{"class":"esriLegendColorRampTick"+r,innerHTML:"&nbsp;",style:S},c)}}),y=g.create("div",{"class":"esriLegendColorRampLabels",style:{height:b+this.gradientHeight+"px"}},o),i?r.forEach(t,function(e){g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:m.encode(e.label)||"&nbsp;"},y)}):(g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},y),g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(b+this.gradientHeight-2*this.gradientHeight)+"px;"},y))},_showHeatRamp:function(e,t,i,r,a){var s,n,l,o=i.field;s=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},r),n=g.create("tbody",{},s),(e._hoverLabel||e._hoverLabels||a)&&this._createHoverAction(s,e,t,a),o=o&&e.getField(o),o&&this._addSubHeader(n,this._getFieldAlias(o.name,e)),l=this._getHeatmapStops(i),l.length&&this._drawColorRamp(n,l,!1,e)},_getHeatmapStops:function(e){var t,i,a,s,n,l=e.colorStops,o=e.colors;if(l&&l[0])if(i=l.length-1,t=l[0]&&null!=l[0].ratio){var d=l[i];d&&1!==d.ratio&&(l=l.slice(0),l.push({ratio:1,color:d.color}),i++)}else a=l[0].value,s=l[i].value-a,l=r.map(l,function(e){return{color:e.color,ratio:(e.value-a)/s}});else o&&o[0]&&(i=o.length-1,n=1/(o.length-1),l=r.map(o,function(e,t){return{color:e,ratio:t*n}}));return l=r.map(l,function(e,t){var r="";return 0===t?r="Low":t===i&&(r="High"),{color:e.color,label:r,offset:1-e.ratio}}),l.reverse()},_showDotDensityLegend:function(e,t,a,s){var n,l,o,d,c,h,u,y,f=a.legendOptions,p=this.dotDensitySwatchSize,_=Math.round(p/2);f&&(l=f.backgroundColor,o=f.outline,d=f.valueUnit,c=f.dotCoverage),c=(c||this.dotCoverage)/100,y=Math.round(p*p/Math.pow(a.dotSize,2)*c),h=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},s),u=g.create("tbody",{},h),(e._hoverLabel||e._hoverLabels)&&this._createHoverAction(h,e,t),this._addSubHeader(u,b.substitute({value:a.dotValue,unit:d||""},this.NLS_dotValue)),r.forEach(a.fields,function(t){t=i.mixin({},t),t.numPoints=y,n=new H(a._generateImageSrc(p,p,[t],{x:0,y:0},{x:p,y:p},l),o||a.outline,p,p),t=e.getField(t.name)||t,this._buildRow_Renderer(e,n,null,m.encode(this._getFieldAlias(t.name,e)),null,u,{type:"path",path:"M "+-_+","+-_+" L "+_+","+-_+" L "+_+","+_+" L "+-_+","+_+" L "+-_+","+-_+" E"})},this)},_showSizeLegend:function(e,t,i,a,s,n,l,o){var d,c,h,u=a.legendOptions,y=u&&u.customValues,f=this._getSizeSymbol(i,s);"unknown"===a.valueUnit&&f&&(y||null!=a.minSize&&null!=a.maxSize)&&(d=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},n),c=g.create("tbody",{},d),(e._hoverLabel||e._hoverLabels||o)&&this._createHoverAction(d,e,t,o),l&&this._addSubHeader(c,this._getFieldAlias(l.name,e)),h=y||this._getDataValues(i,f,a),h.reverse(),r.forEach(h,function(t,r){f=A.fromJson(f.toJson()),this._applySize(f,i,a,t),t=S.format(t);var s="";0===r?s=this._specialChars.gt+" ":r===h.length-1&&(s=this._specialChars.lt+" "),s="<span class='esriLegendSizeRampLabel'>"+m.encode(s+t)+"</span>",this._buildRow_Renderer(e,f,null,s,null,c)},this))},_getSizeSymbol:function(e,t){var i;return e instanceof I?i=e.symbol:e instanceof T?i=e.defaultSymbol:(e instanceof R||e instanceof x)&&(i=e.infos[0].symbol),i=-1!==i.type.indexOf("fillsymbol")?null:i,i&&(i=A.fromJson(i.toJson()),t&&i.setColor(new n(t.toRgba()))),i},_getDataValues:function(e,t,i,a,s){a=null==a?5:a,s=null==s?20:s;var n,l,o=e.getSizeRangeAtScale(i,this.map.getScale()),d=this._interpolateSizeRange(o,a),c=r.map(d,function(e){return this._getDataValueFromSize(e,i,o)},this);for(c=S.round(c),n=1;n<c.length-1;n++)l=this._roundDataValue(e,t,i,c[n],c[n-1],s),l&&(c[n]=l[0],d[n]=l[1]);return c},_interpolateSizeRange:function(e,t){var i,r=e.minSize,a=e.maxSize,s=(a-r)/(t-1),n=[];for(i=0;t>i;i++)n.push(r+s*i);return n},_getDataValueFromSize:function(e,t,i){var r,a,s=i.minSize,n=i.maxSize,l=t.minDataValue,o=t.maxDataValue;return s>=e?a=l:e>=n?a=o:(r=(e-s)/(n-s),a=r*(o-l)+l),a},_roundDataValue:function(e,t,i,r,a,s){var n,l,o,d,c,h,g,u,y,f,p,m,_,L,v,b=this._getSize(t,e,i,r),I=this._getSize(t,e,i,a),R=S.getDigits(r),x=R.integer,C=R.fractional;for(r>0&&1>r&&(n=Math.pow(10,C),r*=n,x=S.getDigits(r).integer),l=x-1;l>=0&&(o=Math.pow(10,l),d=Math.floor(r/o)*o,c=Math.ceil(r/o)*o,null!=n&&(d/=n,c/=n),h=(d+c)/2,h=S.round([d,h,c],{indexes:[1]})[1],g=this._getSize(t,e,i,d),u=this._getSize(t,e,i,c),y=this._getSize(t,e,i,h),f=S.getPctChange(b,g,I,null),p=S.getPctChange(b,u,I,null),m=S.getPctChange(b,y,I,null),_=f.prev<=s,L=p.prev<=s,_&&L&&(f.prev<=p.prev?(_=!0,L=!1):(L=!0,_=!1)),_?v=[d,g]:L?v=[c,u]:m.prev<=s&&(v=[h,y]),!v);l--);return v},_applySize:function(e,t,i,r){var a,s,n=e.type,l=this._getSize(e,t,i,r);switch(n){case"simplemarkersymbol":e.setSize(l);break;case"picturemarkersymbol":a=e.width,s=e.height,e.setHeight(l),e.setWidth(l*(a/s));break;case"simplelinesymbol":case"cartographiclinesymbol":e.setWidth(l);break;case"textsymbol":e.font&&e.font.setSize(l)}},_getSize:function(e,t,i,r){return t.getSize(r,{sizeInfo:i,scale:this.map.getScale(),shape:-1!==e.type.indexOf("markersymbol")?e.style:null})},_buildRow_Renderer:function(e,t,i,r,a,s,n){var l,o,d=g.create("tr",{},s);this.alignRight?(l=g.create("td",{align:this._isRightToLeft?"left":"right"},d),t&&(o=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},d))):(t&&(o=g.create("td",{width:35,align:"center"},d)),l=g.create("td",{},d));var c=30,h=30;if(t){if("simplemarkersymbol"==t.type)c=Math.min(Math.max(c,t.size+12),125),h=Math.min(Math.max(h,t.size+12),125);else if("picturemarkersymbol"==t.type)c=Math.min(Math.max(c,t.width),125),h=Math.min(t.height||h,125);else if("textsymbol"==t.type){var u,y;t.text||(u=t.text,y=!0,t.setText(this.defaultText)),c=Math.min(Math.max(c,t.getWidth()+12),125),h=Math.min(Math.max(h,t.getHeight()+12),125),y&&t.setText(u)}var f=g.create("div",{style:"width:"+c+"px;height:"+h+"px;"},o)}if(b.isDefined(r)&&"number"==typeof r&&(r=""+r),g.create("td",{innerHTML:r||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},l)))),t){var p=this._drawSymbol(f,t,i,c,h,a,e,n);this._surfaceItems.push(p)}},_addSubHeader:function(e,t){var i=g.create("tr",{},e),r=g.create("td",{align:this._align,colspan:2},i);g.create("td",{innerHTML:m.encode(t)||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},r))))},_drawSymbol:function(e,t,r,a,s,o,d,c){var h,g=A.fromJson(t.toJson()),y=d.opacity;if(r&&g.setColor(new n(r.toRgba())),"simplelinesymbol"===g.type||"cartographiclinesymbol"===g.type||"textsymbol"===g.type){if(!g.color)return;h=g.color.toRgba(),h[3]=h[3]*y,g.color.setColor(h)}else"simplemarkersymbol"===g.type||"simplefillsymbol"===g.type?(g.color&&(h=g.color.toRgba(),h[3]=h[3]*y,g.color.setColor(h)),g.outline&&g.outline.color&&(h=g.outline.color.toRgba(),h[3]=h[3]*y,g.outline.color.setColor(h))):"picturemarkersymbol"===g.type&&(e.style.opacity=y,e.style.filter="alpha(opacity=("+100*y+"))");var m,_=f.createSurface(e,a,s);l("ie")<9&&(m=_.getEventSource(),u.set(m,"position","relative"),u.set(m.parentNode,"position","relative"));var L,v=this._getDrawingToolShape(g,o)||A.getShapeDescriptors(g),b=v.defaultShape,S=b&&"text"===b.type;try{S&&!b.text&&(b.text=this.defaultText),L=_.createShape(c||b).setFill(v.fill).setStroke(v.stroke),S&&L.setFont(v.font)}catch(I){return _.clear(),void _.destroy()
}var R,x=L.getBoundingBox(),C=x.width,w=x.height,F=-(x.x+C/2),T=-(x.y+w/2),M=_.getDimensions(),H={dx:F+M.width/2,dy:T+M.height/2};if("simplemarkersymbol"===g.type&&"path"===g.style)R=d._getScaleMatrix(x,g.size),L.applyTransform(p.scaleAt(R.xx,R.yy,{x:M.width/2,y:M.height/2}));else if(C>a||w>s){var D=C/a>w/s,k=D?C:w,z=D?a:s,O=(z-5)/k;i.mixin(H,{xx:O,yy:O})}return L.applyTransform(H),_},_getDrawingToolShape:function(e,t){var i,r=t?t.drawingTool||null:null;switch(r){case"esriFeatureEditToolArrow":i={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case"esriFeatureEditToolTriangle":i={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case"esriFeatureEditToolRectangle":i={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case"esriFeatureEditToolCircle":i={type:"circle",cx:0,cy:0,r:10};break;case"esriFeatureEditToolEllipse":i={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:i,fill:e.getFill(),stroke:e.getStroke()}},_repaintItems:function(){r.forEach(this._surfaceItems,function(e){this._repaint(e)},this)},_repaint:function(e){if(e){e.getStroke&&e.setStroke&&e.setStroke(e.getStroke());try{e.getFill&&e.setFill&&e.setFill(e.getFill())}catch(t){}e.children&&i.isArray(e.children)&&r.forEach(e.children,this._repaint,this)}},_createHoverAction:function(e,t,r,s){var n=t._hoverLabel||t._hoverLabels&&t._hoverLabels[r.id]||s;n&&(n=m.encode(n),t.mouseMoveHandler=t.mouseMoveHandler||{},t.mouseMoveHandler[r.id]=a.connect(e,"onmousemove",i.hitch(this,function(e,t){this.mouseX=t.clientX,this.mouseY=t.clientY,this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(h.byId(this.id+"_hoverLabel"),"display","none")),setTimeout(i.hitch(this,function(e,t,i){if(e==this.mouseX&&t==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,h.byId(this.id+"_hoverLabel")){var r=h.byId(this.id+"_hoverLabel");r.innerHTML="<span>"+i+"</span>",u.set(r,"top",t+"px"),u.set(r,"left",e+15+"px"),u.set(r,"display","")}else g.create("div",{innerHTML:"<span>"+i+"</span>",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:t+"px",left:e+15+"px"}},document.body)},t.clientX,t.clientY,e),500)},n)),t.mouseOutHandler=t.mouseOutHandler||{},t.mouseOutHandler[r.id]=a.connect(e,"onmouseout",i.hitch(this,function(){this.mouseX=-1,this.mouseY=-1,this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(h.byId(this.id+"_hoverLabel"),"display","none"))})))},_removeHoverHandlers:function(){var e;r.forEach(this.layers,function(t){if(t.mouseMoveHandler)for(e in t.mouseMoveHandler)a.disconnect(t.mouseMoveHandler[e]);if(t.mouseOutHandler)for(e in t.mouseOutHandler)a.disconnect(t.mouseOutHandler[e])})},_createDynamicLayers:function(e){var t,i=[],a=e.dynamicLayerInfos||e.layerInfos;return r.forEach(a,function(r){t={id:r.id},t.source=r.source&&r.source.toJson();var a;e.layerDefinitions&&e.layerDefinitions[r.id]&&(a=e.layerDefinitions[r.id]),a&&(t.definitionExpression=a);var s;e.layerDrawingOptions&&e.layerDrawingOptions[r.id]&&(s=e.layerDrawingOptions[r.id]),s&&(t.drawingInfo=s.toJson()),t.minScale=r.minScale||0,t.maxScale=r.maxScale||0,i.push(t)}),i},_getTemplateFromTypes:function(e,t){var i;for(i=0;i<e.length;i++)if(e[i].id==t&&e[i].templates&&e[i].templates.length>0)return e[i].templates[0];return null},_findParentGroup:function(e,t,i){var r,a=t.dynamicLayerInfos||t.layerInfos;for(r=0;r<a.length;r++)if(i==a[r].id){a[r].parentLayerId>-1&&(u.set(h.byId(this.id+"_"+e+"_"+a[r].parentLayerId+"_group"),"display","block"),this._findParentGroup(e,t,a[r].parentLayerId));break}},_addSubLayersToHide:function(e){function t(i,a){var s,n,l=e.layer.dynamicLayerInfos||e.layer.layerInfos;for(s=0;s<l.length;s++)if(l[s].id===i&&l[s].subLayerIds)for(n=0;n<l[s].subLayerIds.length;n++){var o=l[s].subLayerIds[n];-1===r.indexOf(a,o)&&(a.push(o),t(o,a))}}e.layer.layerInfos&&r.forEach(this.hideLayersInLegend[e.layer.id],function(i){t(i,this.hideLayersInLegend[e.layer.id])},this)},_isLayerInScale:function(e,t,i){var r,a=!0;if(e.legendResponse&&e.legendResponse.layers)for(r=0;r<e.legendResponse.layers.length;r++){var s=e.legendResponse.layers[r];if(t.id==s.layerId){var n,l;!e.minScale&&0!==e.minScale||!e.maxScale&&0!==e.maxScale?(0==s.minScale&&e.tileInfo&&(n=e.tileInfo.lods[0].scale),0==s.maxScale&&e.tileInfo&&(l=e.tileInfo.lods[e.tileInfo.lods.length-1].scale)):(n=Math.min(e.minScale,s.minScale)||e.minScale||s.minScale,l=Math.max(e.maxScale,s.maxScale)),(n>0&&i>n||l>i)&&(a=!1);break}}else(e.minScale||e.maxScale)&&(e.minScale&&e.minScale<i||e.maxScale&&e.maxScale>i)&&(a=!1);return a},_getServiceTitle:function(e){var t=e._titleForLegend;if(t||(t=e.url,e.url?e.url.indexOf("/MapServer")>-1?(t=e.url.substring(0,e.url.indexOf("/MapServer")),t=t.substring(t.lastIndexOf("/")+1,t.length)):e.url.indexOf("/ImageServer")>-1?(t=e.url.substring(0,e.url.indexOf("/ImageServer")),t=t.substring(t.lastIndexOf("/")+1,t.length)):e.url.indexOf("/FeatureServer")>-1&&(t=e.url.substring(0,e.url.indexOf("/FeatureServer")),t=t.substring(t.lastIndexOf("/")+1,t.length)):t="",e.name&&(t.length>0?t+=" - "+e.name:t=e.name)),"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass&&e.vectorFieldPixelFilter){var i=e.vectorFieldPixelFilter.outputUnit?this["NLS_"+e.vectorFieldPixelFilter.outputUnit]:this["NLS_"+e.vectorFieldPixelFilter.inputUnit];b.isDefined(i)&&(t+=" ("+i+")")}return m.encode(t)},_getEffectiveScale:function(e,t){var i=t.minScale,r=t.maxScale;if(b.isDefined(t.parentLayerId)){var a,s=e.layerInfos,n=t.parentLayerId;for(a=s.length-1;a>=0;a--)if(s[a].id==n){if(0==i&&s[a].minScale>0?i=s[a].minScale:i>0&&0==s[a].minScale?i=i:i>0&&s[a].minScale>0&&(i=Math.min(i,s[a].minScale)),r=Math.max(r||0,s[a].maxScale||0),!(s[a].parentLayerId>-1))break;n=s[a].parentLayerId}}return{minScale:i,maxScale:r}},_isSupportedLayerType:function(e){return e&&("esri.layers.ArcGISDynamicMapServiceLayer"===e.declaredClass||"esri.layers.ArcGISImageServiceLayer"===e.declaredClass&&e.version>=10.2||"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===e.declaredClass||"esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass||"esri.layers.KMLLayer"===e.declaredClass||"esri.layers.GeoRSSLayer"===e.declaredClass||"esri.layers.WMSLayer"===e.declaredClass||"esri.layers.CSVLayer"===e.declaredClass)?!0:!1}});return i.mixin(z,{ALIGN_LEFT:0,ALIGN_RIGHT:1}),l("extend-esri")&&i.setObject("dijit.Legend",z,_),z});