define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/on","dojo/json","dijit/form/VerticalSlider","dojox/form/VerticalRangeSlider","dijit/form/VerticalRule","dijit/form/VerticalRuleLabels","dijit/form/HorizontalSlider","dojox/form/HorizontalRangeSlider","dijit/form/HorizontalRule","dijit/form/HorizontalRuleLabels","dijit/_Widget","dijit/_Templated","dojox/timing/_base","dojo/_base/array","dojo/Deferred","dojo/DeferredList","../layers/MosaicRule","../layers/DimensionalDefinition","../kernel","../lang","./_EventedWidget","dojo/text!./templates/MultidimensionalSlider_vertical.html","dojo/text!./templates/MultidimensionalSlider_horizontal.html","dojo/i18n!../nls/jsapi","dojo/dom-class","dojo/dom-style","dojo/dom-geometry"],function(e,i,t,s,n,l,a,o,h,r,u,d,m,c,f,_,p,g,v,y,V,b,S,R,D,L,C,I,N,x){var M={LAYOUT_VERTICAL:"vertical",LAYOUT_HORIZONTAL:"horizontal"},T=e([R,c,f],{declaredClass:"esri.dijit.MultidimensionalSlider",widgetsInTemplate:!0,templateString:D,nLabels:10,thumbCount:1,loop:!0,useLayersDimSlices:!0,prefetch:!0,prefetchedValues:{},showPlayButton:!0,prefetchFactor:3,_hasUnitConflict:!1,unitSymbols:{meter:"m",pascal:"Pa"},_eventMap:{"dimension-value-change":!0,play:!0,pause:!0,next:!0,previous:!0,change:!0,"dimension-array-create":!0},onChange:function(){},onPlay:function(){},onPause:function(){},onDimensionValueChange:function(){},_onPlay:function(){this.playing=!this.playing,this._updateUI(),this.playing?(this._timer.start(),this.onPlay()):(this._timer.stop(),this.onPause())},constructor:function(i){e.safeMixin(this,i),this.playing=!1,this._iconClass="mdsButton mdsPlayButton",this.map&&this._getImageLayers(),this.layout===M.LAYOUT_HORIZONTAL&&(this.templateString=L),this.thumbMovingRate=this.thumbMovingRate||3e3,this.prefetchImgNode=new Image,this._i18n=C},postCreate:function(){this.inherited(arguments)},startup:function(){this.inherited(arguments);var e=this;this._getAllLayersMDInfo().then(function(){e._sortDimensionValues(),e.dimensionValues=e.dimensionValues&&e.dimensionValues.length&&!e.useLayersDimValues?e.dimensionValues:e._mapSortedDimensionValues,e.getUnit(),e._setupSlider(!0)}),this.showPlayButton?N.set(this.playPauseBtn.domNode,"display","block"):(N.set(this.playPauseBtn.domNode,"display","none"),this.playPauseBtnRow&&N.set(this.playPauseBtnRow,"display","none")),this._timer=new _.Timer,this._timer.setInterval(this.thumbMovingRate),this._timer.onTick=i.hitch(this,"_bumpSlider",1),this.layout===M.LAYOUT_VERTICAL&&(this.computeSliderStyle(),this.on("resize",i.hitch(this,"computeSliderStyle")))},testLog:function(){},_setDimensionAttr:function(e){this._slider&&(e.dimension&&(this.dimension=e.dimension),this.dimensionValues=e.dimensionValues&&e.dimensionValues.length?e.dimensionValues:[],this.update(!1))},update:function(e){var i=this;this._mapSortedDimensionValues=[],this._getImageLayers(),this.value=e?this.dimensionValues[this._slider.value]:null,this._getAllLayersMDInfo().then(function(){i._sortDimensionValues(),i.getUnit(),i.dimensionValues&&i.dimensionValues.length&&!i.useLayersDimSlices||(i.dimensionValues=i._mapSortedDimensionValues),i._setupSlider(e)})},pause:function(){this.playing=!1,this._updateUI(),this._timer.stop()},play:function(){this.playing!==!0&&(this.playing=!1,this._onPlay())},_setupSlider:function(e){this._destroySlider(),this.dimensionValues&&this.dimensionValues.length&&(this.sliderNode=document.createElement("div"),this._getDimensionAlias(),this._layers&&this._layers.length&&1===this._layers.length&&e&&this._readMosaicRule(),this._createRule(),this._createLabels(),this._createSlider(),this._slider.onChange(this._slider.value))},_createLabels:function(){this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalLabels():this._createVerticalLabels()},_createRule:function(){this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalRule():this._createVerticalRule()},_createVerticalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new h({labels:this._filterLabels(),labelStyle:"font-size: 75%; padding-left: 5px;"},this.labelsNode)},_createVerticalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new o({count:this.dimensionValues.length-1,style:"width:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new m({labels:this._filterLabels(),labelStyle:"font-size: 75%"},this.labelsNode)},_createHorizontalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new d({count:this.dimensionValues.length-1,style:"height:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalSingleSlider:function(e){var t=this;this._slider=new r({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width: 100%;",increment:i.hitch(this,"_bumpSlider",1),decrement:i.hitch(this,"_bumpSlider",-1),value:e||0,onChange:function(e){var i=t.dimensionValues[e];t.setDimensionInfoText(i),p.forEach(t._layers,function(s){t._updateMosaicRule(s,i),t.prefetch&&t.playing&&t._prefetchData(e,s)}),t.onChange(i)}},t.sliderNode),this._slider.startup()},_createHorizontalRangeSlider:function(e){var t=this;this._slider=new u({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width:100%;",increment:i.hitch(this,"_bumpSlider",1),decrement:i.hitch(this,"_bumpSlider",-1),value:e||[0,1],onChange:function(e){var i=[t.dimensionValues[e[1]],t.dimensionValues[e[0]]];t.setDimensionInfoText(i),p.forEach(t._layers,function(s){t._updateMosaicRule(s,i),t.prefetch&&t.playing&&t._prefetchData(e,s),t.onChange(i)})}},t.sliderNode),this._slider.startup(),s(this._slider.incrementButton,"click",this._slider.increment),s(this._slider.decrementButton,"click",this._slider.decrement),this._slider._typematicCallback=function(){}},_createVerticalSingleSlider:function(e){var t=this;this._slider=new l({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:i.hitch(this,"_bumpSlider",1),decrement:i.hitch(this,"_bumpSlider",-1),value:e||0,onChange:function(e){var i=t.dimensionValues[e];t.setDimensionInfoText(i),p.forEach(t._layers,function(s){t._updateMosaicRule(s,i),t.prefetch&&t.playing&&t._prefetchData(e,s)}),t.onChange(i)}},t.sliderNode),this._slider.startup()},_createVerticalRangeSlider:function(e){var t=this;this._slider=new a({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:i.hitch(this,"_bumpSlider",1),decrement:i.hitch(this,"_bumpSlider",-1),value:e||[0,1],onChange:function(e){var i=[t.dimensionValues[e[1]],t.dimensionValues[e[0]]];i.sort(),t.setDimensionInfoText(i),p.forEach(t._layers,function(s){t._updateMosaicRule(s,i),t.prefetch&&t.playing&&t._prefetchData(e,s)}),t.onChange(i)}},t.sliderNode),this._slider.startup(),this._slider._typematicCallback=function(){}},_destroySlider:function(){this._slider&&(this._slider.destroy(),this._slider=null)},_createSlider:function(){var e;this.mdSliderCell.appendChild(this.sliderNode),this.value&&this.value.length?e=p.indexOf(this.dimensionValues,this.value[0])>=0&&p.indexOf(this.dimensionValues,this.value[1])>=0?[p.indexOf(this.dimensionValues,this.value[0]),p.indexOf(this.dimensionValues,this.value[1])]:[0,1]:this.value&&(e=p.indexOf(this.dimensionValues,this.value)>=0?p.indexOf(this.dimensionValues,this.value):0),2===this.thumbCount?this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalRangeSlider(e):this._createVerticalRangeSlider(e):this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalSingleSlider(e):this._createVerticalSingleSlider(e)},_getMultidimensionalInfo:function(e){function i(){e.getMultidimensionalInfo().then(function(i){e.multidimensionalInfo=i,t.resolve(e)},function(e){t.reject(e)})}var t=new g;return e.multidimensionalInfo?t.resolve(e):e.loaded?i():e.on("load",function(){i()}),t},_getAllLayersMDInfo:function(){var e=[],i=this;p.forEach(this._layers,function(t){e.push(i._getMultidimensionalInfo(t))});var t=new v(e);return t},_getImageLayers:function(){var e,i=this.map.layerIds.concat(this.map.graphicsLayerIds),t=this;this._layers=[],p.forEach(i,function(i){e=t.map.getLayer(i),("esri.layers.ArcGISImageServiceLayer"===e.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass)&&t._layers.push(e)})},_sortDimensionValues:function(){function e(e,i){for(var t=[],s=0,n=0;s<e.length&&n<i.length;)e[s]<i[n]?t.push(e[s++]):e[s]>i[n]?t.push(i[n++]):(t.push(i[n++]),s++);return t.concat(e.slice(s)).concat(i.slice(n))}var i=this,t=0,s=[];if(this._layers=this._filterLayers(),p.forEach(this._layers,function(e){e.multidimensionalInfo&&p.some(e.multidimensionalInfo.variables,function(e){p.some(e.dimensions,function(e){e.name!==i.dimension||e.hasRanges||s.push(e)})})}),1===s.length)this._mapSortedDimensionValues=s[0].values;else if(s.length>1)for(this._mapSortedDimensionValues=s[0].values,t=1;t<s.length;t++)this._mapSortedDimensionValues=e(this._mapSortedDimensionValues,s[t].values)},_createDimensionalDefinition:function(e,i){var t=[e],s=new V({variableName:i,dimensionName:this.dimension,values:t,isSlice:1===t.length});return s},_updateMosaicRule:function(e,i){var t=this,s=!1,n=e.mosaicRule||e.defaultMosaicRule||new y({multidimensionalDefinition:[]}),l=n.multidimensionalDefinition||[];i.length&&i.sort(function(e,i){return e-i}),p.forEach(l,function(e){e.dimensionName===t.dimension&&(e.values=[i],e.isSlice=!S.isDefined(i.length),s=!0)}),s||p.some(e.multidimensionalInfo.variables,function(e){return p.some(e.dimensions,function(e){return e.name===t.dimension?!0:void 0})?!0:void 0})&&(l.push(t._createDimensionalDefinition(i,"")),s=!0),s&&(n.multidimensionalDefinition=l,e.setMosaicRule(n))},_prefetchData:function(e,t){if(t&&t.mosaicRule){var s,l,a,o=this,h=!1;for(this.prefetchedValues[t.id]||(this.prefetchedValues[t.id]=[]),l=i.clone(t._params),a=i.clone(t.mosaicRule),s=1;s<=this.prefetchFactor;s++)h=!1,p.forEach(a.multidimensionalDefinition,function(i){i.dimensionName===this.dimension&&(e.length?(i.values=[this.dimensionValues[(e[0]+s)%this.dimensionValues.length],this.dimensionValues[(e[1]+s)%this.dimensionValues.length]],i.values.sort(function(e,i){return e-i})):i.values=[this.dimensionValues[(e+s)%this.dimensionValues.length]],p.some(this.prefetchedValues[t.id],function(e){return n.stringify(e)===n.stringify(i.values)?!0:void 0})||(h=!0,this.prefetchedValues[t.id].push(i.values)))},this),h&&(l.mosaicRule=n.stringify(a.toJson()),t.getImageUrl(this.map.extent,this.map.width,this.map.height,function(e){o.prefetchImgNode.src=e},l))}},setDimensionInfoText:function(e){if(S.isDefined(e)){var i=this.unitSymbol||this.unit;if("number"!=typeof e){var t=e.sort();(t[0]%1!==0||t[1]%1!==0)&&(t[0]=parseFloat(t[0].toFixed(2)),t[1]=parseFloat(t[1].toFixed(2))),e="["+t[0]+", "+t[1]+"]"}else e%1!==0&&(e=e.toFixed(2));this.dimensionInfo.innerHTML=this.unitSymbol?"<label style='font-weight:700;'>"+this.dimensionAlias+" ("+i+")</label>":"<label style='font-weight:700;'>"+this.dimensionAlias+"</label>",this.dimensionInfo.innerHTML+=this.layout===M.LAYOUT_HORIZONTAL?": "+e:"<br/> "+e}},setLabels:function(){},_filterLabels:function(){if(this.nLabels&&this.dimensionValues&&this.dimensionValues.length){var e=Math.ceil(this.dimensionValues.length/this.nLabels),i=p.map(this.dimensionValues,function(i,t){return t%e===0||t===this.dimensionValues.length-1?(i%1!=0&&(i=parseFloat(i.toFixed(2))),i):""},this);return i}},_filterLayers:function(){var e=this;return p.filter(this._layers,function(i){return i.multidimensionalInfo&&i.visible&&i.useMapDimensionValue&&p.some(i.multidimensionalInfo.variables,function(i){return p.some(i.dimensions,function(i){return i.name!=e.dimension||i.hasRanges?void 0:!0})?!0:void 0})?!0:void 0})},_updateUI:function(){I.remove(this.playPauseBtn.iconNode,this._iconClass),this._iconClass=this.playing?"mdsButton mdsPauseButton":"mdsButton mdsPlayButton",I.add(this.playPauseBtn.iconNode,this._iconClass)},_bumpSlider:function(e){var i=this._slider.value;e>0?0>i||i>=this.dimensionValues.length-1||i[0]>=this.dimensionValues.length-1||i[1]>=this.dimensionValues.length-1?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},2===this.thumbCount?this._slider.set("value",[0,Math.abs(i[0]-i[1])]):this._slider.set("value",0),this._timer.start(),this.playing=!0):this.pause()):2===this.thumbCount&&i[0]<this.dimensionValues.length-1&&i[1]<this.dimensionValues.length-1?this._slider.set("value",[i[0]+1,i[1]+1]):1===this.thumbCount&&i<this.dimensionValues.length-1&&this._slider.set("value",i+1):0>e&&(i>=0||i[1]>=0)&&(2===this.thumbCount&&i[1]>0&&i[0]>0?this._slider.set("value",[i[0]-1,i[1]-1]):1===this.thumbCount&&i>0&&this._slider.set("value",i-1))},setThumbMovingRate:function(e){this.thumbMovingRate=e,this._timer&&this._timer.setInterval(this.thumbMovingRate)},getFullDimensionRange:function(){return this._mapSortedDimensionValues&&this._mapSortedDimensionValues.length?[this._mapSortedDimensionValues[0],this._mapSortedDimensionValues[this._mapSortedDimensionValues.length-1]]:void 0},setThumbCount:function(e){this.thumbCount=2==e?2:1,this.value=this.dimensionValues[this._slider.value],this._setupSlider()},clearDimensionalDefinition:function(e){var i,t,s=[];e&&e.mosaicRule&&e.mosaicRule.multidimensionalDefinition&&(t=e.mosaicRule,i=t.multidimensionalDefinition,p.forEach(i,function(e){e.dimensionName!==this.dimension&&s.push(e)},this),t.multidimensionalDefinition=s,e.setMosaicRule(t))},getUnit:function(){var e=null,i=!1;return this.unit=null,p.forEach(this._layers,function(t){t.multidimensionalInfo&&p.forEach(t.multidimensionalInfo.variables,function(t){p.forEach(t.dimensions,function(t){if(t.name===this.dimension&&t.unit)if(null!=e||i){if(S.isDefined(t.unit)&&t.unit.replace("esri","").toLowerCase()!=e.toLowerCase())return e=null,void(i=!0)}else e=t.unit.replace("esri","")},this)},this)},this),e&&(e=e.replace("esri","")),this.unit=e,this.unitSymbol=this.getUnitSymbol(),this._hasUnitConflict=i,e},_getDimensionAlias:function(){this.dimensionAlias=this.dimension,p.some(this._layers,function(e){return e.fields&&e.fields.length&&p.some(e.fields,function(e){return e.name&&e.name===this.dimension&&e.alias?(this.dimensionAlias=e.alias,!0):void 0},this)?!0:void 0},this)},_readMosaicRule:function(){var e;p.forEach(this._layers,function(i){i.mosaicRule&&i.mosaicRule.multidimensionalDefinition&&p.forEach(i.mosaicRule.multidimensionalDefinition,function(i){i&&i.dimensionName===this.dimension&&i.values&&(e=i.values.length&&i.values[0]&&i.values[0].length?i.values[0]:i.values)},this)},this),e&&(1===e.length?(this.thumbCount=1,this.value=e[0]):(this.thumbCount=2,this.value=e))},hasUnitConflict:function(){return this.getUnit(),this._hasUnitConflict},computeSliderStyle:function(){var e,i;return e=x.getContentBox(this.mdSliderTable).h-x.getContentBox(this.dimensionInfo).h,t("ie")<=10&&(e-=53),this.showPlayButton&&(e-=35),i="height: "+e+"px;",this._slider&&this._slider.domNode&&N.set(this._slider.domNode,"height",e+"px"),i},getUnitSymbol:function(){if(!S.isDefined(this.unit))return null;var e=this.unit.toLowerCase();return"meters"===e||"meter"===e?this.unitSymbols.meter:"pascal"===e||"pascals"===e?this.unitSymbols.pascal:void 0}});return i.mixin(T,M),t("extend-esri")&&i.setObject("dijit.MultidimensionalSlider",T,b),T});