// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.38/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/on","dojo/json","dijit/form/VerticalSlider","dojox/form/VerticalRangeSlider","dijit/form/VerticalRule","dijit/form/VerticalRuleLabels","dijit/form/HorizontalSlider","dojox/form/HorizontalRangeSlider","dijit/form/HorizontalRule","dijit/form/HorizontalRuleLabels","dijit/_Widget","dijit/_Templated","dojox/timing/_base","dojo/_base/array","dojo/Deferred","dojo/DeferredList","../layers/MosaicRule","../layers/DimensionalDefinition","../kernel","../lang","./_EventedWidget","dojo/text!./templates/MultidimensionalSlider_vertical.html","dojo/text!./templates/MultidimensionalSlider_horizontal.html","dojo/i18n!../nls/jsapi","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/touch","dojo/query","dojo/dom-construct","dojo/_base/sniff"],(function(e,i,s,t,n,a,l,h,o,r,u,d,m,c,_,f,g,p,v,V,y,b,S,R,L,C,D,N,I,x,j,M,O){var A={LAYOUT_VERTICAL:"vertical",LAYOUT_HORIZONTAL:"horizontal"},H=e([R,c,_],{declaredClass:"esri.dijit.MultidimensionalSlider",widgetsInTemplate:!0,templateString:L,nLabels:10,_thumbCount:1,useRanges:void 0,loop:!0,useLayersDimSlices:!0,prefetch:!0,prefetchedValues:{},showPlayButton:!0,prefetchFactor:2,_hasUnitConflict:!1,_update:!0,useDefaults:!1,playDirectionAscending:!0,unitSymbols:{meter:"m",pascal:"Pa"},_eventMap:{"dimension-value-change":!0,play:!0,pause:!0,next:!0,previous:!0,change:!0,"dimension-array-create":!0},onChange:function(){},onPlay:function(){},onPause:function(){},onDimensionValueChange:function(){},_onPlay:function(){this.playing=!this.playing,this._updateUI(),this.playing?(this._timer.start(),this.onPlay()):(this._timer.stop(),this.onPause())},constructor:function(i,s){e.safeMixin(this,i),this.playing=!1,this._iconClass="mdsButton mdsPlayButton",this.map&&this._getImageLayers(),this.layout===A.LAYOUT_HORIZONTAL&&(this.templateString=C),this.thumbMovingRate=this.thumbMovingRate||3e3,this._i18n=D,this.prefetchImgNodes={}},postCreate:function(){this.inherited(arguments)},startup:function(){this.inherited(arguments);var e=this;this._getAllLayersMDInfo().then((function(){e._sortDimensionValues(),e.dimensionValues=e.dimensionValues&&e.dimensionValues.length&&!e.useLayersDimSlices?e.dimensionValues:e._mapSortedDimensionValues,e.getUnit(),e._setupSlider()})),this._timer=new f.Timer,this._timer.setInterval(this.thumbMovingRate),this._timer.onTick=i.hitch(this,(function(){this.playDirectionAscending?this._bumpSlider(1):this._bumpSlider(-1)})),this.layout===A.LAYOUT_VERTICAL&&(this.computeSliderStyle(),this.on("resize",i.hitch(this,"computeSliderStyle"))),this._setupHandles()},_insertPassiveLabels:function(){var e=M(".dijitSliderMoveable.dijitSliderMoveableV",this.domNode);this._passiveLbl1=O.create("div"),N.add(this._passiveLbl1,"esriMdSliderPassiveLbl"),O.place(this._passiveLbl1,e[0]),2===this._thumbCount&&(this._passiveLbl2=O.create("div"),N.add(this._passiveLbl2,"esriMdSliderPassiveLbl"),O.place(this._passiveLbl2,e[1]))},_setupHandles:function(){this._eventHandles=[],this._eventHandles.push(t(this.domNode,"mouseover",i.hitch(this,"activateSlider"))),this._eventHandles.push(t(this.domNode,"mouseleave",i.hitch(this,"deactivateSlider"))),this._eventHandles.push(t(this.domNode,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(t(this.domNode,j.release,i.hitch(this,"deactivateSlider"))),this._eventHandles.push(t(this.prevBtn.domNode,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(t(this.playPauseBtn.domNode,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(t(this.nextBtn.domNode,j.press,i.hitch(this,"activateSlider")));var e=M(".dijitSliderImageHandle.dijitSliderImageHandleV",this.domNode);g.forEach(e,(function(e){this._eventHandles.push(t(e,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(t(e,j.release,i.hitch(this,"deactivateSlider")))}),this)},_removeHandles:function(){g.forEach(this._eventHandles,(function(e){e&&e.remove()}))},activateSlider:function(){s("ie")<9&&I.set(this.domNode,"background","#fff"),this.sliderActive=!0,this.deactivateTimer&&clearTimeout(this.deactivateTimer),N.remove(this.domNode,"esriMdSliderPassive"),N.add(this.domNode,"esriMdSliderActive"),I.set(this._passiveLbl1,"display","none"),this._passiveLbl2&&I.set(this._passiveLbl2,"display","none")},deactivateSlider:function(){if(!(s("ie")<10)){var e=this;this.deactivateTimer=setTimeout((function(){e.sliderActive=!1,e.updatePassiveLabels(),N.remove(e.domNode,"esriMdSliderActive"),N.add(e.domNode,"esriMdSliderPassive"),e._showPassiveLabels()}),2500)}},updatePassiveLabels:function(){this._slider&&S.isDefined(this._slider.value)&&(this._passiveLbl1.innerHTML=this.value.length?this.value[0]:this.value,this._slider.value.length&&(this._passiveLbl2.innerHTML=this.value[1]),this.sliderActive||this._showPassiveLabels())},_showPassiveLabels:function(){S.isDefined(this.value)&&(I.set(this._passiveLbl1,"display","inline-block"),this.value.length?I.set(this._passiveLbl2,"display","inline-block"):this._passiveLbl2&&I.set(this._passiveLbl2,"display","none"))},increment:function(){var e=1;!this.playDirectionAscending&&this.playing&&(e=-1),this._bumpSlider(e)},decrement:function(){var e=-1;!this.playDirectionAscending&&this.playing&&(e=1),this._bumpSlider(e)},_setDimensionAttr:function(e){this._slider&&(e.dimension&&(this.dimension=e.dimension),e.dimensionValues&&e.dimensionValues.length?this.dimensionValues=e.dimensionValues:this.dimensionValues=[],this.update())},update:function(){var e=this;this._mapSortedDimensionValues=[],this._getImageLayers(),this.value=this.dimensionValues[this._slider.value],this._getAllLayersMDInfo().then((function(){e._sortDimensionValues(),e.getUnit(),e.dimensionValues&&e.dimensionValues.length&&!e.useLayersDimSlices||(e.dimensionValues=e._mapSortedDimensionValues),e._setupSlider()}))},pause:function(){this.playing=!1,this._updateUI(),this._timer.stop()},play:function(e){!0!==this.playing&&(e=!!e,this.playing=!1,this._onPlay())},_setupSlider:function(){this._destroySlider(),this.dimensionValues&&this.dimensionValues.length&&(this.sliderNode=document.createElement("div"),this._getDimensionAlias(),this._layers&&this._layers.length&&1===this._layers.length&&this._readMosaicRule(),this._createRule(),this._createLabels(),this._createSlider(),this._insertPassiveLabels(),this._slider.onChange(this._slider.value))},_createLabels:function(){this.layout===A.LAYOUT_HORIZONTAL?this._createHorizontalLabels():this._createVerticalLabels()},_createRule:function(){this.layout===A.LAYOUT_HORIZONTAL?this._createHorizontalRule():this._createVerticalRule()},_createVerticalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new o({labels:this._filterLabels(),labelStyle:"font-size: 83%; padding-left: 5px;"},this.labelsNode)},_createVerticalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new h({count:this.dimensionValues.length,style:"width:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new m({labels:this._filterLabels(),labelStyle:"font-size: 83%"},this.labelsNode)},_createHorizontalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new d({count:this.dimensionValues.length,style:"height:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalSingleSlider:function(e){e=e||(this.playDirectionAscending?0:this.dimensionValues.length-1),this._slider=new r({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width: 100%;",increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||0,onChange:i.hitch(this,this._onSingleSliderChange),showButtons:!1},this.sliderNode),this._slider.startup()},_createHorizontalRangeSlider:function(e){e=e||(this.playDirectionAscending?[0,1]:[this.dimensionValues.length-2,this.dimensionValues.length-1]),this._slider=new u({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width:100%;",increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||[0,1],onChange:i.hitch(this,this._onRangeSliderChange),showButtons:!1},this.sliderNode),this._slider.startup(),t(this._slider.incrementButton,"click",this._slider.increment),t(this._slider.decrementButton,"click",this._slider.decrement),this._slider._typematicCallback=function(){}},_createVerticalSingleSlider:function(e){e=S.isDefined(e)?e:this.playDirectionAscending?0:this.dimensionValues.length-1,this._slider=new a({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||0,onChange:i.hitch(this,this._onSingleSliderChange),showButtons:!1},this.sliderNode),this._slider.startup()},_createVerticalRangeSlider:function(e){e=e||(this.playDirectionAscending?[0,1]:[this.dimensionValues.length-2,this.dimensionValues.length-1]),this._slider=new l({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||[0,1],onChange:i.hitch(this,this._onRangeSliderChange),showButtons:!1},this.sliderNode),this._slider.startup(),this._slider._typematicCallback=function(){}},_onSingleSliderChange:function(e){var i=this.dimensionValues[e];this.setDimensionInfoText(i),g.forEach(this._layers,(function(s){this._updateMosaicRule(s,i),this.prefetch&&this.playing&&"esri.layers.RasterXLayer"!==s.declaredClass&&this._prefetchData(e,s)}),this),this._oldValue=e,this.value=i,this.updatePassiveLabels(),this.onChange(i)},_onRangeSliderChange:function(e){if(this._update){this._snap&&(e=this._snapToNearestRange(e));var s=[this.dimensionValues[e[1]],this.dimensionValues[e[0]]];s.sort(this._sortCompareFunction),this.value=s,this.setDimensionInfoText(s),this.updatePassiveLabels(),g.forEach(this._layers,(function(i){this._updateMosaicRule(i,s),this.prefetch&&this.playing&&this._prefetchData(e,i)}),this),this._update=!0,this._oldValue=i.clone(e),this.onChange(s)}},destroy:function(){this.inherited(arguments),this._timer.stop(),this._destroySlider(),this._removeHandles()},_destroySlider:function(){if(this._slider)try{this._slider.destroy()}catch(e){this._slider.domNode&&O.destroy(this._slider.domNode)}finally{this._slider=null}},_createSlider:function(){var e,i;this.mdSliderCell.appendChild(this.sliderNode),this.value&&this.value.length&&g.indexOf(this.dimensionValues,this.value[0])>=0&&g.indexOf(this.dimensionValues,this.value[1])>=0?e=[g.indexOf(this.dimensionValues,this.value[0]),g.indexOf(this.dimensionValues,this.value[1])]:S.isDefined(this.value)&&(i=g.indexOf(this.dimensionValues,this.value))>=0&&(e=i),S.isDefined(e)||(e=this._getDefaultSliderValue()),this.useDefaults&&S.isDefined(e)&&(e===this.dimensionValues.length-1||e.length&&g.indexOf(e,this.dimensionValues.length-1)>=0)&&(this.playDirectionAscending=!1),2===this._thumbCount?this.layout===A.LAYOUT_HORIZONTAL?this._createHorizontalRangeSlider(e):this._createVerticalRangeSlider(e):this.layout===A.LAYOUT_HORIZONTAL?this._createHorizontalSingleSlider(e):this._createVerticalSingleSlider(e)},_getDefaultSliderValue:function(){if(this.dimensionValues&&this.dimensionValues.length){var e,i,s,t,n,a=1/0,l=1;if(this.dimension&&"stdz"===this.dimension.toLowerCase())for(t=0;t<this.dimensionValues.length&&(n=this.dimensionValues[t],(i=Math.abs(n-0))<a&&(a=i,e=n),0!==i);t++);else e=this.dimensionValues[0];return s=(s=g.indexOf(this.dimensionValues,e))<0?0:s,2===this._thumbCount&&(s===this.dimensionValues.length-1&&(l=-1),s=[s,s+l]),s}},_getMultidimensionalInfo:function(e){var i=new p;function s(){e.getMultidimensionalInfo().then((function(s){e.multidimensionalInfo=s,i.resolve(e)}),(function(e){i.reject(e)}))}return e.multidimensionalInfo?i.resolve(e):e.loaded?s():e.on("load",(function(){s()})),i},_getAllLayersMDInfo:function(){var e=[];return g.forEach(this._layers,(function(i){e.push(this._getMultidimensionalInfo(i))}),this),new v(e)},_getImageLayers:function(){var e,i=this.map.layerIds.concat(this.map.graphicsLayerIds);return this._layers=[],g.forEach(i,(function(i){"esri.layers.ArcGISImageServiceLayer"!==(e=this.map.getLayer(i)).declaredClass&&"esri.layers.ArcGISImageServiceVectorLayer"!==e.declaredClass&&"esri.layers.RasterLayer"!==e.declaredClass&&"esri.layers.WCSLayer"!==e.declaredClass&&"esri.layers.RasterXLayer"!==e.declaredClass||this._layers.push(e)}),this),this._layers},_sortCompareFunction:function(e,i){return!(!S.isDefined(e)||!S.isDefined(i))&&e-i},_getDimensionObjects:function(){var e=this._merge,s=this;this._allRangeValues=!0,this._thumbCount=1,this._snap=!1,this._dimensionObjects=[],this._layers=this._filterLayers(),g.forEach(this._layers,(function(e){e.multidimensionalInfo&&g.some(e.multidimensionalInfo.variables,(function(e){g.some(e.dimensions,(function(e){e.name!==this.dimension||e.hasRanges||(this._allRangeValues=!1)}),this)}),this)}),this),this.useRanges?(this._thumbCount=2,this._snap=!1):this._allRangeValues&&this.useLayersDimSlices?(this._thumbCount=2,this._snap=!0):this._snap=!1,g.forEach(this._layers,(function(t){t.multidimensionalInfo&&g.some(t.multidimensionalInfo.variables,(function(t){g.some(t.dimensions,(function(t){t.name===this.dimension&&(this._allRangeValues&&t.hasRanges||this.useRanges?this._dimensionObjects.push(function(i){if(i&&i.values&&i.hasRanges){var t=[];g.forEach(i.values,(function(i){i.length?t=e(t,i):t.push.apply(e(t.sort(this._sortCompareFunction),[i]))}),this),t=t.sort(s._sortCompareFunction),i.decodedValues=t}return i}(i.clone(t))):this._dimensionObjects.push(i.clone(t)))}),this)}),this)}),this)},_merge:function(e,i){for(var s=[],t=0,n=0;t<e.length&&n<i.length;)e[t]<i[n]?s.push(e[t++]):e[t]>i[n]?s.push(i[n++]):(s.push(i[n++]),t++);return s=s.concat(e.slice(t)).concat(i.slice(n)),s=g.filter(s,(function(e,i,s){return s.indexOf(e)===i}))},_mergeRangeArrays:function(e,i){for(var s=[],t=0,n=0;t<e.length&&n<i.length;)e[t][0]<i[n][0]||e[t][0]===i[n][0]&&e[t][1]<i[n][1]?s.push(e[t++]):e[t][0]>i[n][0]||e[t][0]===i[n][0]&&e[t][1]>i[n][1]?s.push(i[n++]):(s.push(i[n++]),t++);return s=s.concat(e.slice(t)).concat(i.slice(n)),s=g.filter(s,(function(e,i,s){return s.indexOf(e)===i}),this)},_sortDimensionValues:function(){var e=0,i=this._merge,s=this._mergeRangeArrays;if(this._getDimensionObjects(),this._dimensionObjects.length>=1&&(this._mapSortedDimensionValues=this._dimensionObjects[0].decodedValues||this._dimensionObjects[0].values,this._allRangeValues&&(this._dimensionRangeValues=this._dimensionObjects[0].values)),this._dimensionObjects.length>1)for(e=1;e<this._dimensionObjects.length;e++)this._mapSortedDimensionValues=i(this._mapSortedDimensionValues,this._dimensionObjects[e].decodedValues||this._dimensionObjects[e].values),this._allRangeValues&&(this._dimensionRangeValues=s(this._dimensionRangeValues,this._dimensionObjects[e].values))},_createDimensionalDefinition:function(e,i){var s=[e];return new y({variableName:i,dimensionName:this.dimension,values:s,isSlice:1===s.length})},_updateMosaicRule:function(e,i){var s=!1,t=e.mosaicRule||e.defaultMosaicRule||new V({multidimensionalDefinition:[]}),n="esri.layers.WCSLayer"===e.declaredClass,a="esri.layers.RasterXLayer"===e.declaredClass,l=(n?e.multidimensionalDefinition:t.multidimensionalDefinition)||[];if(i.length&&i.sort(this._sortCompareFunction),g.forEach(l,(function(e){e.dimensionName===this.dimension&&(e.values=[i],e.isSlice=!this.useRanges,s=!0)}),this),!s){var h="",o=g.filter(e.multidimensionalInfo.variables,(function(e){return g.some(l,(function(i){return i.variableName&&i.variableName.toLowerCase()===e.name.toLowerCase()}),this)}),this);0===o.length&&(o=e.multidimensionalInfo.variables),g.some(o,(function(e){if(g.some(e.dimensions,(function(i){if(i.name===this.dimension)return(n||a)&&(h=e.name),!0}),this))return!0}),this)&&(l.push(this._createDimensionalDefinition(i,h)),s=!0)}s&&(n&&e.setMultidimensionalDefinition(l),a?e.setMultiDimensionalDefinition(t):(t.multidimensionalDefinition=l,e.setMosaicRule(t)))},_prefetchData:function(e,s){if(s&&(s.mosaicRule||s.multidimensionalDefinition)){var t,a,l,h,o,r,u=!1,d=this;for(this.prefetchedValues[s.id]||(this.prefetchedValues[s.id]=[]),this.prefetchImgNodes[s.id]=[],a=i.clone(s._params),h=(l=i.clone(s.mosaicRule))&&l.multidimensionalDefinition||i.clone(s.multidimensionalDefinition),t=1;t<=this.prefetchFactor;t++)u=!1,g.forEach(h,(function(i){i.dimensionName===this.dimension&&(this.playDirectionAscending?e.length?(this.snap?(o=this._getNextRangeIndex(e)||e,i.values=[this.dimensionValues[o[0]],this.dimensionValues[o[1]]]):i.values=[this.dimensionValues[(e[0]+t)%this.dimensionValues.length],this.dimensionValues[(e[1]+t)%this.dimensionValues.length]],i.values.sort(this._sortCompareFunction)):i.values=[this.dimensionValues[(e+t)%this.dimensionValues.length]]:e.length?(this.snap?(o=this._getNextRangeIndex(e,-1)||e,i.values=[this.dimensionValues[o[0]],this.dimensionValues[o[1]]]):i.values=[this.dimensionValues[(this.dimensionValues.length+e[0]-t)%this.dimensionValues.length],this.dimensionValues[(this.dimensionValues.length+e[1]-t)%this.dimensionValues.length]],i.values.sort(this._sortCompareFunction)):i.values=[this.dimensionValues[(this.dimensionValues.length+e-t)%this.dimensionValues.length]],g.some(this.prefetchedValues[s.id],(function(e){if(n.stringify(e)===n.stringify(i.values))return!0}))||(u=!0,this.prefetchedValues[s.id].push(i.values)))}),this),u&&"esri.layers.WCSLayer"!==s.declaredClass&&(a.mosaicRule=n.stringify(l.toJson()),s.getImageUrl(this.map.extent,this.map.width,this.map.height,(function(e){r=new Image,d.prefetchImgNodes[s.id].push(r),r.src=e}),a))}},setDimensionInfoText:function(e){if(S.isDefined(e)){var s=this.unitSymbol||this.unit;if("number"!=typeof e){var t=i.clone(e.sort(this._sortCompareFunction));t[0]%1==0&&t[1]%1==0||(t[0]=parseFloat(t[0].toFixed(2)),t[1]=parseFloat(t[1].toFixed(2))),e="["+t[0]+", "+t[1]+"]"}else e%1!=0&&(e=e.toFixed(2));this.unitSymbol?this.dimensionInfo.innerHTML="<label style='font-weight:700;'>"+this.dimensionAlias+" ("+s+")</label>":this.dimensionInfo.innerHTML="<label style='font-weight:700;'>"+this.dimensionAlias+"</label>",this.layout===A.LAYOUT_HORIZONTAL?this.dimensionInfo.innerHTML+=": "+e:this.dimensionInfo.innerHTML+="<br/> "+e}},setLabels:function(e){},_filterLabels:function(){if(this.nLabels&&this.dimensionValues&&this.dimensionValues.length){var e=Math.ceil(this.dimensionValues.length/this.nLabels);return g.map(this.dimensionValues,(function(i,s){return s%e==0||s===this.dimensionValues.length-1?(i%1!=0&&(i=parseFloat(i.toFixed(2))),i):""}),this)}},_filterLayers:function(){return g.filter(this._layers,(function(e){if(e.multidimensionalInfo&&e.visible&&e.useMapDimensionValue&&g.some(e.multidimensionalInfo.variables,(function(e){if(g.some(e.dimensions,(function(e){if(e.name===this.dimension)return!0}),this))return!0}),this))return!0}),this)},_updateUI:function(){N.remove(this.playPauseBtn.iconNode,this._iconClass),this._iconClass=this.playing?"mdsButton mdsPauseButton":"mdsButton mdsPlayButton",N.add(this.playPauseBtn.iconNode,this._iconClass)},_bumpSlider:function(e){var i=this._slider.value;e>=0?!this._snap&&(i<0||i>=this.dimensionValues.length-1||i[0]>=this.dimensionValues.length-1||i[1]>=this.dimensionValues.length-1)?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},this.prefetchImgNodes={},2===this._thumbCount?this._snap?this._slider.set("value",this._getNextRangeIndex(i)):this._slider.set("value",[0,Math.abs(i[0]-i[1])]):this._slider.set("value",0),this._timer.start(),this.playing=!0):this.pause()):2===this._thumbCount&&!this._snap&&i[0]<this.dimensionValues.length-1&&i[1]<this.dimensionValues.length-1?this._slider.set("value",[i[0]+1,i[1]+1]):1===this._thumbCount&&i<this.dimensionValues.length-1?this._slider.set("value",i+1):this._snap&&this._slider.set("value",this._getNextRangeIndex(i)):i<=0||i[0]<=0||i[1]<=0?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},2===this._thumbCount?this._snap?this._slider.set("value",this._getNextRangeIndex(i,-1)):this._slider.set("value",[this.dimensionValues.length-1,this.dimensionValues.length-1-Math.abs(i[0]-i[1])]):this._slider.set("value",this.dimensionValues.length-1),this._timer.start(),this.playing=!0):this.pause()):(i>=0||i[1]>=0)&&(2===this._thumbCount&&i[1]>0&&i[0]>0?this._snap?this._slider.set("value",this._getNextRangeIndex(i,-1)):this._slider.set("value",[i[0]-1,i[1]-1]):1===this._thumbCount&&i>0&&this._slider.set("value",i-1))},setThumbMovingRate:function(e){this.thumbMovingRate=e,this._timer&&this._timer.setInterval(this.thumbMovingRate)},getFullDimensionRange:function(e){var i,s;return e=e||this.dimension,g.forEach(this._layers,(function(t){t.multidimensionalInfo&&t.multidimensionalInfo.variables&&g.forEach(t.multidimensionalInfo.variables,(function(t){g.forEach(t.dimensions,(function(t){t.name===e&&t.extent&&t.extent.length&&t.extent.length>1&&((!S.isDefined(i)||t.extent[0]<i)&&(i=t.extent[0]),(!S.isDefined(s)||t.extent[1]>s)&&(s=t.extent[1]))}),this)}),this)}),this),[i,s]},setThumbCount:function(e){this._thumbCount=2==e?2:1,this.value=this.dimensionValues[this._slider.value],this._setupSlider()},clearDimensionalDefinition:function(e){var i,s,t=[];e&&e.mosaicRule&&e.mosaicRule.multidimensionalDefinition&&(i=(s=e.mosaicRule).multidimensionalDefinition,g.forEach(i,(function(e){e.dimensionName!==this.dimension&&t.push(e)}),this),s.multidimensionalDefinition=t,e.setMosaicRule(s))},getUnit:function(){var e=null,i=!1;return this.unit=null,g.forEach(this._layers,(function(s){s.multidimensionalInfo&&g.forEach(s.multidimensionalInfo.variables,(function(s){g.forEach(s.dimensions,(function(s){if(s.name===this.dimension&&s.unit)if(null!=e||i){if(S.isDefined(s.unit)&&s.unit.replace("esri","").toLowerCase()!==e.toLowerCase())return e=null,void(i=!0)}else e=s.unit.replace("esri","")}),this)}),this)}),this),e&&(e=e.replace("esri","")),this.unit=e,this.unitSymbol=this.getUnitSymbol(),this._hasUnitConflict=i,e},_getDimensionAlias:function(){this.dimensionAlias=this.dimension,g.some(this._layers,(function(e){if(e.fields&&e.fields.length&&g.some(e.fields,(function(e){if(e.name&&e.name===this.dimension&&e.alias)return this.dimensionAlias=e.alias,!0}),this))return!0}),this)},_readMosaicRule:function(){var e;g.forEach(this._layers,(function(i){var s=i.mosaicRule&&i.mosaicRule.multidimensionalDefinition||i.multidimensionalDefinition;s&&g.forEach(s,(function(i){i&&i.dimensionName===this.dimension&&i.values&&(e=i.values.length&&i.values[0]&&i.values[0].length?i.values[0]:i.values)}),this)}),this),this.useRanges=S.isDefined(this.useRanges)?this.useRanges:!(!e||1===e.length),e&&(this.useRanges?(this._thumbCount=2,1===e.length?this.value=[e[0],this.dimensionValues[this.dimensionValues.length-1]]:this.value=e):e.length>1&&this._snap?(this._thumbCount=2,this.value=e):(this._thumbCount=1,this.useRanges=!1,this.value=e[0]))},hasUnitConflict:function(){return this.getUnit(),this._hasUnitConflict},resizeSlider:function(e,i){I.set(this.domNode,{height:e+"px",width:i+"px"}),I.set(this.mdSliderTable,{height:e+"px",width:i+"px"}),this.computeSliderStyle()},computeSliderStyle:function(){var e,i;return e=x.getContentBox(this.domNode).h-x.getContentBox(this.dimensionInfo).h-(x.getContentBox(this.playPauseBtnRow).h+20),s("ie")<=10&&(e-=53),i="height: "+e+"px;",this._slider&&this._slider.domNode&&I.set(this._slider.domNode,"height",e+"px"),i},getUnitSymbol:function(){if(!S.isDefined(this.unit))return null;var e=this.unit.toLowerCase();return"meters"===e||"meter"===e?this.unitSymbols.meter:"pascal"===e||"pascals"===e?this.unitSymbols.pascal:void 0},_snapToNearestRange:function(e){if(e&&e.length&&this._snap){var s,t,n,a,l,h,o,r,u=this;return(a=[this.dimensionValues[e[1]],this.dimensionValues[e[0]]]).sort(this._sortCompareFunction),g.some(this._dimensionObjects,(function(e){if(g.some(e.values,(function(e){if(e&&e.length&&e[0]===a[0]&&e[1]===a[1])return!0})))return!0}),this)?e:(g.some(this._dimensionObjects,(function(e){if(g.some(e.values,(function(e){if(e&&e.length&&e[0]===a[0])return s=i.clone(e.sort(this._sortCompareFunction)),!0}),this))return!0}),this)&&(g.some(this.dimensionValues,(function(e,i){e===s[0]&&(t=i),e===s[1]&&(n=i)})),o=Math.abs(e[0]-t),l=[t,n]),g.some(this._dimensionObjects,(function(e){if(g.some(e.values,(function(e){if(e&&e.length&&e[1]===a[1])return s=i.clone(e.sort(this._sortCompareFunction)),!0}),this))return!0}),this)&&(g.some(this.dimensionValues,(function(e,i){e===s[1]&&(n=i),e===s[0]&&(t=i)})),r=Math.abs(e[1]-n),h=[t,n]),e=o&&r?this._oldValue&&this._oldValue.length&&this._arraysEqual(this._oldValue,l)?h:this._oldValue&&this._oldValue.length&&this._arraysEqual(this._oldValue,h)?l:o<=r?l:h:l||h||e,this._update=!1,setTimeout((function(){u._slider.set("value",e)}),100),e)}},_arraysEqual:function(e,i){var s;if(!S.isDefined(e)||!S.isDefined(i))return!1;if(e===i)return!0;if(e.length!==i.length)return!1;for(e.sort(this._sortCompareFunction),i.sort(this._sortCompareFunction),s=0;s<e.length;++s)if(e[s]!==i[s])return!1;return!0},_getNextRangeIndex:function(e,i){return this._dimensionRangeValues&&this._dimensionRangeValues.length?(i=S.isDefined(i)?i:1,g.some(this._dimensionRangeValues,(function(i,t){if(this._arraysEqual(i,[this.dimensionValues[e[0]],this.dimensionValues[e[1]]]))return s=t,!0}),this),t=i>0?(s+1)%this._dimensionRangeValues.length:(this._dimensionRangeValues.length+s-1)%this._dimensionRangeValues.length,n=this._dimensionRangeValues[t],g.some(this.dimensionValues,(function(e,i){if(e===n[0]&&(a=i),e===n[1]&&(l=i),a&&l)return!0}),this),[a,l]):null;var s,t,n,a,l}});return i.mixin(H,A),s("extend-esri")&&i.setObject("dijit.MultidimensionalSlider",H,b),H}));