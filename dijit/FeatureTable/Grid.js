// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["../../kernel","../../arcadeProfiles/popupProfile","./dataUtils","./dialogUtils","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/has","dojo/keys","dojo/on","dojo/string","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojox/html/entities","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_WidgetBase","dijit/a11yclick","dijit/focus","dijit/Menu","dijit/MenuItem","dijit/Tooltip","dijit/form/Button","dijit/form/DateTextBox","dijit/form/DropDownButton","dijit/form/NumberTextBox","dijit/form/Select","dijit/form/SimpleTextarea","dijit/form/TimeTextBox","dijit/form/ValidationTextBox","dijit/layout/BorderContainer","dijit/layout/ContentPane","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/editor","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","dojo/i18n!../../nls/jsapi","dojo/text!./templates/Grid.html"],(function(e,t,i,n,s,l,o,r,a,d,h,c,u,f,p,m,y,g,C,_,I,w,b,v,F,T,E,S,N,R,L,H,k,M,O,D,x,V,U,G,P,A,j,B,z){var q=s([C,y,g],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table-grid",templateString:z,map:null,layer:null,layerInfo:null,idProperty:"id",sort:null,defaultSort:null,filterIds:null,where:null,batchCount:50,editable:!1,editOn:"dblclick, keypress",css:null,showAttachments:!1,showRelatedRecords:!1,showCyclicalRelationships:!1,showStatistics:!1,showFieldDetails:!1,showGridHeader:!0,showGridMenu:!0,showFilterMenuItems:!0,showDefaultSortMenuItem:!0,showFeatureCount:!0,showDataTypes:!1,showColumnHeaderTooltips:!1,showColumnHeaderTooltipsWithDescription:!1,showColumnHider:!1,syncSelection:!1,menuFunctions:null,columnMenuFunctions:null,gridOptions:null,dateOptions:null,visibleLayerIds:null,showExpressionFields:!1,loaded:!1,store:null,columns:null,fieldInfos:null,customFieldInfos:null,expressionInfos:null,expressionCache:{},noDataMessage:"",featureCount:0,selectedFeatureCount:0,selectedRows:null,selectedRowIds:null,optionsMenu:null,optionsMenuAnchor:null,columnMenu:null,rollbackInfos:null,attachmentInfos:null,relatedRecordInfos:null,relatedRecordCounts:null,_i18nStrings:B.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger","number"],_unsupportedFieldTypes:["esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_activeEditors:[],_relationshipColumnLimit:5,_nullConstant:"ft_null",_watchers:null,_tableTitle:null,_previousSelectedRowIds:null,_loading:0,_lastClickedCell:null,postMixInProperties:function(){this.inherited(arguments),this.set({sort:{},columns:[],fieldInfos:[],selectedRows:[],selectedRowIds:[],rollbackInfos:{},attachmentInfos:{},relatedRecordInfos:{},relatedRecordCounts:{},_watchers:[],_previousSelectedRowIds:[]})},startup:function(){this.inherited(arguments),this.showExpressionFields&&this.expressionInfos&&(this.expressionCache=i.compileExpressions(this.expressionInfos)),this.dGrid=this._generateBaseGrid(),this._cleanUpGrid(),this.dGrid.startup(),this.dGrid.resize(),this.updateHeaderText(),this._generateOptionsMenu(),this.showGridHeader||this.hideHeader(),this.showGridMenu||this.hideOptionsMenu(),this._addGridListeners()},destroy:function(){this.inherited(arguments),this.optionsMenu&&this.optionsMenu.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),o.forEach(this._watchers,(function(e){e.remove()}))},resize:function(){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize(),this._gridHeaderNode&&this._gridHeaderNode.resize(),this._gridContentPaneNode&&this._gridContentPaneNode.resize(),this.dGrid&&this.dGrid.resize()},setHeaderTitle:function(e){i.sanitizer&&(e=i.sanitizer.sanitize(e)),this._gridTitleNode&&(this._gridTitleNode.innerHTML=e)},showHeader:function(){u.remove(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},hideHeader:function(){u.add(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},showLoadingIndicator:function(){this._gridLoadingIndicatorNode&&0===this._loading&&u.remove(this._gridLoadingIndicatorNode,this.css.hidden),this._loading++},hideLoadingIndicator:function(){this._loading--,this._gridLoadingIndicatorNode&&!this._loading&&u.add(this._gridLoadingIndicatorNode,this.css.hidden)},showOptionsMenu:function(){this._menuNode&&u.remove(this._menuNode,this.css.hidden)},hideOptionsMenu:function(){this._menuNode&&u.add(this._menuNode,this.css.hidden)},updateNoDataMessage:function(e){this.dGrid.set("noDataMessage",e)},showColumnHiderMenu:function(){this.gridOptions.columnHider&&this.dGrid._toggleColumnHiderMenu()},refresh:function(){this.dGrid&&this.dGrid.refresh(),0===this.featureCount&&this.hideLoadingIndicator(),this._updateSelection().then(l.hitch(this,this.updateHeaderText))},getRowById:function(e){return this.dGrid.row(e)||{}},getRowDataById:function(e){var t=this.getRowById(e);return t&&t.data?t.data:{}},emptyStore:function(){this.updateNoDataMessage(""),this.updateStore(null)},updateStore:function(e){this.set("store",e),this.dGrid.set("store",e)},updateSort:function(e){this.set("sort",e[0]),this.dGrid.set("sort",e)},updateSelectionMode:function(e){this.dGrid.set("selectionMode",e)},getColumns:function(){return this.dGrid.columns},styleColumn:function(e,t){return this.dGrid.styleColumn(e,t)},clearSelection:function(){this.dGrid.clearSelection(),this._updateSelection().then(l.hitch(this,this.updateHeaderText)),this.emit("clear-selection")},centerOnSelection:function(){var e=this.map,t=this.layer,n=this.selectedRowIds;if(e&&n&&0!==n.length)return i.queryLayerForFeatures({layer:t,ids:n}).then(l.hitch((function(t){var n=t.features;n&&n.length>0&&e.setExtent(i.calculateExtentFromFeatures(n))})))},selectRows:function(e,t,i){var n,s=this.dGrid,r=[];this._closeCellEditors(),this.clearSelection(),e instanceof Array?(o.forEach(e,(function(e){s._select(e),r.push(this.getRowById(e))}),this),n=e[0]):(s._select(e),n=e,r=[this.getRowById(e)]),this._updateSelection().then(l.hitch(this,(function(){this.updateHeaderText(),i||this.emit("row-select",{rows:r,grid:this.dGrid}),t&&this._scrollToRow(n)})))},_generateBaseGrid:function(){var e=this.gridOptions||{},t=[P,O,D,U,x,V];return e.pagination&&t.push(G),e.columnHider&&t.push(A),e.columnResizer&&t.push(j),new(s(t))({columns:this.columns,sort:[this.defaultSort],noDataMessage:this.noDataMessage,selectionMode:e.selectionMode,allowSelectAll:e.allowSelectAll,allowTextSelection:e.allowTextSelection,cellNavigation:e.cellNavigation,keepScrollPosition:e.keepScrollPosition,pageSizeOptions:e.pageSizeOptions,queryRowsOverlap:e.queryRowsOverlap,minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,pagingDelay:this.pagingDelay,query:l.hitch(this,this._getQueryForGrid)},this._gridNode)},_getQueryForGrid:function(e){return!this.filterIds||-1!==o.indexOf(this.filterIds,e[this.idProperty])},_cleanUpGrid:function(){var e=this.dGrid,t=r.before(e,"removeRow",l.hitch(this,(function(t){o.forEach(this.columns.length,(function(i,n){var s=e.cell(t,n).element,l=s.contents||s;l&&l.widget&&l.widget.destroyRecursive()}))}))),i=r.after(e,"renderHeader",(function(){e._sortListener.remove()}));this._watchers.push(t,i)},_setUpColumns:function(e){var t=this._generateFieldInfos(e),i=this._generateColumns(t);return this.set({columns:i,fieldInfos:t}),this.dGrid.set("columns",i),{fieldInfos:t,columns:i}},_generateFieldInfos:function(e){if(e&&0!==e.length&&this.layerInfo){var n=this._orderFieldsForDisplay(e),s=this.layer,l=this.layerInfo,r=[],a=this.customFieldInfos;if(o.forEach(n,(function(e){var n=e.name,d=e.length||null,h=i.findFirst(s.fields,"name",n)||{},c=i.findFirst(a,"name",n)||i.findFirst(a,"fieldName",n);if(i.isExpressionField(n)){var u=i.getExpressionInfo(this.expressionInfos,n),f=this.expressionCache[u.name],p=t.isAsync(f);r.push({name:u.name,expression:!0,hasFeatureSetOperations:p,length:d,hidden:!c.visible,alias:e.alias,type:e.type,editable:e.editable,nullable:e.nullable,domain:!1,typeId:!1,subtypeField:!1,subtypeDomain:!1,format:c.format||null,dateOptions:null,description:e.description})}else{var m,y,g,C,_,I,w,b,v,F,T,E,S,N=this.idProperty,R=this.outFields,L=this.hiddenFields;g=c&&(c.label||c.alias)||h.alias,C=!(!s.getDomain||!s.getDomain(n))&&s.getDomain(n),_=!(!l.typeIdField||n!==l.typeIdField),I=!(!l.subtypeField||n!==l.subtypeField),w=l.types&&o.some(l.types,(function(e){if(e.domains&&e.domains[n]&&e.domains[n].name)return!0})),b=!this._getFieldVisibility({field:e,hiddenFields:L,customFieldInfo:c,outFields:R}),m=l.editable&&l.editCapabilities.canUpdate,y=c&&(void 0!==c.editable&&!1!==h.editable||void 0!==c.isEditable&&!1!==h.isEditable),v=!(!m||n===N||!h||"undefined"===h.editable)&&(y?!!c.editable||!!c.isEditable:!!h.editable),F=c&&c.format?c.format:null,T=!!h.nullable,E=c&&(c.dateOptions||c.format&&c.format.dateFormat)||null,S=c&&c.stringOptions?c.stringOptions:null,r.push({name:n,alias:g,length:d,type:e.type,hidden:b,editable:v,nullable:T,domain:C,typeId:_,subtypeField:I,subtypeDomain:w,format:F,dateOptions:E,stringOptions:S,description:e.description})}}),this),o.every(r,(function(e){return e.hidden})))i.findFirst(r,"name",this.idProperty).hidden=!1;if(this.showRelatedRecords){var d=this._generateRelatedRecordFieldInfos({relationships:s.relationships});r=r.concat(d)}return this.showAttachments&&r.push({alias:this._i18nStrings.photosAndFiles,name:"esriAttachments",type:"esriAttachments",editable:l.editable}),r}},_destroyColumns:function(){this.dGrid&&this.dGrid._destroyColumns()},_getFieldVisibility:function(e){var t,i,n,s,l=e.field,r=e.hiddenFields,a=e.outFields,d=e.customFieldInfo;return t=-1!==o.indexOf(r,l.name),n=!(!d||!1!==d.visible),s="*"!==a[0]&&-1===o.indexOf(a,l.name),i="esriFieldTypeOID"===l.type||"esriFieldTypeGlobalID"===l.type,!(t||i&&(n||s)||n||s)},_applyEdits:function(e){var t=e.row,n=e.rollbackInfo;return this.showLoadingIndicator(),n&&this._updateRollbackInfos(n),this.emit("data-change",{row:t,rollbackInfo:n}),i.applyEditsFromRow({layer:this.layer,idProperty:this.idProperty,row:t}).then(l.hitch(this,(function(e){var i=e.updates||[];i&&i.length&&o.forEach(i,(function(e){e.success||(e.error?this.emit("error",{message:e.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),n?((t=this.getRowDataById(n.rowId))[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback}))}),this),this.hideLoadingIndicator(),this.emit("edits-complete",e)}))).otherwise(l.hitch(this,(function(){n&&((t=this.getRowDataById(n.rowId))[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()),this.hideLoadingIndicator(),this.emit("error",{message:this._i18nStrings.errorUpdateFailed})})))},_updateRollbackInfos:function(e){if(e){var t=e.rowId;this.rollbackInfos[t]||(this.rollbackInfos[t]=[]),this.rollbackInfos[t].push(e)}},_updateSelection:function(){var e,t,i,n,s=this.dGrid.selection,l=new p,o=[],r=[];for(t in s)s.hasOwnProperty(t)&&(i=parseInt(t,10),r.push(i),(e=this.dGrid.row(i).data)&&o.push(e));return n={selectedRows:o,selectedRowIds:r,selectedFeatureCount:r.length},this.set(n),l.resolve(n),l},_scrollToRow:function(e){var t,i,n,s=this.store,l=this.dGrid,r=l.row(e),a=this.sort;r&&s&&(r.element?r.element.scrollIntoView():(t=s.data[e]||r.data)&&(i=a&&a.attribute===this.idProperty&&a.descending?s.data.length-o.indexOf(s.data,t):o.indexOf(s.data,t),n=l.rowHeight*i-l.rowHeight,l.scrollTo({x:0,y:n}),r.element?r.element.scrollIntoView():setTimeout((function(){r.element&&r.element.scrollIntoView()}),200)))},_generateColumns:function(e){var t=l.clone(e)||[],i=[];return o.forEach(t,(function(e){e.expression?i.push(this._generateExpressionColumn(e)):"esriAttachments"===e.type?i.push(this._generateAttachmentsColumn(e)):"esriRelatedRecords"===e.type?i.push(this._generateRelatedRecordsColumn(e)):"esriFieldTypeDate"===e.type?this.dateOptions.timeEnabled||e.dateOptions&&e.dateOptions.timeEnabled?i.push(this._generateDateTimeColumn(e)):i.push(this._generateDateColumn(e)):!e.subtypeDomain||e.typeId||e.subtypeField?e.domain?i.push(this._generateDomainColumn(e)):e.typeId?i.push(this._generateTypeColumn(e,"types","id")):e.subtypeField?i.push(this._generateTypeColumn(e,"subtypes","code")):o.indexOf(this._numericFieldTypes,e.type)>-1?i.push(this._generateNumberColumn(e)):-1===o.indexOf(this._unsupportedFieldTypes,e.type)&&i.push(this._generateStringColumn(e)):i.push(this._generateSubtypeDomainColumn(e))}),this),i},_orderFieldsForDisplay:function(e){var t=this.outFields,n=this.idProperty,s=[];if(t&&"*"===t[0])s=l.clone(e);else{if(!i.isValueEmpty(n)&&-1===o.indexOf(t,n)){var r=i.findFirst(e,"name",n);r&&s.push(r)}o.forEach(t,(function(t){var l=i.findFirst(e,"name",t);l&&t!==n&&-1===o.indexOf(s,l)&&s.push(l)}),this),o.forEach(e,(function(e){-1===o.indexOf(s,e)&&s.push(l.clone(e))}))}return s},_generateDateColumn:function(e){var t=e.dateOptions||this.dateOptions;return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,className:this.css.dateValue,get:l.hitch(this,(function(n){return i.isValueEmpty(n[e.name])?null:i.formatDateForLocale({dateOptions:t,timestamp:new Date(n[e.name]),fieldInfo:e})})),renderCell:l.hitch(this,(function(t,n,s){var l=f.create("div",{innerHTML:i.isValueEmpty(n)?"":n},s);this._setUpDateCell({row:t,cellNode:s,fieldInfo:e,container:l})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})}))}},_generateDateTimeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,className:this.css.dateValue,get:l.hitch(this,(function(t){return i.isValueEmpty(t[e.name])?null:i.formatDateForLocale({dateOptions:e.dateOptions||this.dateOptions,timestamp:new Date(t[e.name]),fieldInfo:e})})),renderCell:l.hitch(this,(function(t,n,s){var l=f.create("div",{innerHTML:i.isValueEmpty(n)?"":n},s);this._setUpDateTimeCell({row:t,cellNode:s,fieldInfo:e,container:l})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})}))}},_generateDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:function(t){return i.getDomainValueFromRow({fieldInfo:e,row:t})},renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})})),renderCell:l.hitch(this,(function(t,i,n){var s,l=f.create("div");if(e.domain.codedValues)s=this._formatStringCellContent({fieldInfo:e,value:i}),s=String(s),s=m.encode(s),this._setUpCodedValueDomainCell({row:t,cellNode:n,fieldInfo:e,container:l});else{if("range"!==e.domain.type)return void this.emit("error",{message:this._i18nStrings.errorDomainType});s=this._formatNumberCellContent({fieldInfo:e,value:i}),this._setUpRangeDomainCell({row:t,cellNode:n,fieldInfo:e,container:l})}l.innerHTML=s,f.place(l,n)}))}},_generateTypeColumn:function(e,t,n){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:l.hitch(this,(function(s){var l=i.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:e,row:s,typesProperty:t,typeIdProperty:n});return i.isValueEmpty(l)?s[e.name]:l})),renderCell:l.hitch(this,(function(i,s,l){var o=this._formatStringCellContent({fieldInfo:e,value:s}),r=f.create("div",{innerHTML:o},l);this._setUpTypeCell({row:i,cellNode:l,fieldInfo:e,container:r,typesProperty:t,typeIdProperty:n})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})}))}},_generateSubtypeDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editOn:this.editOn,editor:"text",get:l.hitch(this,(function(t){return i.getSubtypeDomainValue({layerInfo:this.layerInfo,fieldInfo:e,row:t})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})})),renderCell:l.hitch(this,(function(t,i,n){var s=this._formatStringCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpSubtypeDomainCell({row:t,cellNode:n,fieldInfo:e,container:l})}))}},_generateNumberColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})})),renderCell:l.hitch(this,(function(t,i,n){var s=this._formatNumberCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpNumberCell({row:t,cellNode:n,fieldInfo:e,container:l})}))}},_generateStringColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e})})),renderCell:l.hitch(this,(function(t,i,n){var s=this._formatStringCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpStringCell({row:t,cellNode:n,fieldInfo:e,container:l})}))}},_generateAttachmentsColumn:function(e){var t=this.layerInfo||{};return{label:e.alias,field:e.name,type:"esriAttachments",sortable:!1,get:l.hitch(this,(function(e){var i,n=e[this.idProperty],s=this.attachmentInfos[n];return i=t.queryAttachmentsSupported?0:null,s&&s.attachments?s.attachments.length:i})),renderCell:l.hitch(this,(function(t,i,n){this._generateAttachmentsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.attachmentsTitle})}))}},_generateRelatedRecordsColumn:function(e){return{label:e.alias,field:e.name,type:"esriRelatedRecords",hidden:e.hidden,sortable:!1,get:l.hitch(this,(function(t){return this._getRelatedRecordsCount({featureId:t[this.idProperty],relationshipId:e.relationship.id})})),renderCell:l.hitch(this,(function(t,i,n){this._generateRelatedRecordsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.relatedRecordsTitle})}))}},_generateExpressionColumn:function(e){return{label:e.alias,field:e.name,type:"esriExpressions",sortable:!1,get:l.hitch(this,(function(t){return e.hasFeatureSetOperations?null:this._getExpressionValueForField(e.name,t)})),renderCell:l.hitch(this,(function(t,i,n){this._generateExpressionCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})})),renderHeaderCell:l.hitch(this,(function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.expressionsTitle})}))}},_closeCellEditors:function(){var e=this._activeEditors;o.forEach(e,(function(e){e.widget.onBlur()})),this.set("_activeEditors",[])},_getColumnHeaderCellContent:function(e){var t,i,n,s,l=e.fieldInfo,o=e.cssClass||null,r=this.css;if(s=f.create("div",{className:r.columnHeader}),n=o?r.columnHeaderTitle+" "+o:r.columnHeaderTitle,!l.editable&&this.editable&&this.layerInfo.editable&&f.create("span",{className:r.lockedIconContainer+" "+r.lockedIcon},s),i=m.encode(l.alias||l.name),f.create("div",{innerHTML:i,className:n},s),f.create("div",{className:r.columnHeaderClear},s),this.showColumnHeaderTooltips||this.showColumnHeaderTooltipsWithDescription){var a=i;this.showColumnHeaderTooltipsWithDescription&&this.layer.supportsFieldDescription&&l.description&&l.description.value&&(a+=" - "+m.encode(l.description.value)),this.own(new v({connectId:[s],label:"<div class="+r.columnHeaderTooltip+">"+a+"</div>"}))}return t="esriExpressions"===l.type||"esriRelatedRecords"===l.type||"esriAttachments"===l.type,this.showDataTypes&&!t&&(f.create("div",{innerHTML:l.type.replace("esriFieldType",""),className:r.columnHeaderType},s),f.create("div",{className:r.columnHeaderClear},s)),s},_setUpNumberCell:function(e){var t,n,s=e.row,o=e.cellNode,r=e.fieldInfo,a=e.container,c=this.idProperty,u=i.isIntegerFieldType(r.type)?0:"0,20";this.editOn===_&&h(o,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(o,this.editOn,l.hitch(this,(function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:s});this.editable&&r.editable&&!1!==e&&(i.findFirst(this._activeEditors,"cellNode",o)||(this._lastClickedCell!==o&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===o?(a.innerHTML="",(t=new S({value:s[r.name],required:!r.nullable,constraints:{places:u}})).placeAt(a),t.focus(),t.textbox.select(),this.emit("editor-show",{cell:o,editor:t,grid:this}),t.on("blur",l.hitch(this,(function(){a.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:s[r.name]}),o.focus(),this.emit("editor-hide",{cell:o,editor:t,grid:this}),this._activeEditors.pop()}))),t.on("keydown",(function(e){e.keyCode===d.ENTER&&t.isValid()&&t.focusNode.blur()})),t.on("change",l.hitch(this,(function(e){n={fieldName:r.name,oldValue:s[r.name],rowId:s[c],row:s},(""===e||isNaN(e))&&(e=null),t.isValid()?(s[r.name]=e,a.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:e}),this._applyEdits({row:s,rollbackInfo:n})):a.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:s[r.name]}),t.destroy()}))),this._activeEditors.push({cellNode:o,id:s[c],widget:t})):this._lastClickedCell=o))})))},_setUpDateCell:function(e){var t,n,s=e.row,o=e.cellNode,r=e.fieldInfo,a=e.container,c=this.idProperty;this.editOn===_&&h(o,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(o,this.editOn,l.hitch(this,(function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:s});if(this.editable&&r.editable&&!1!==e)if(this._lastClickedCell!==o&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===o){a.innerHTML="",n=r.dateOptions&&r.dateOptions.datePattern?r.dateOptions.datePattern:this.dateOptions.datePattern,t=i.isValueEmpty(s[r.name])?null:new Date(s[r.name]);var h=new T({value:t,constraints:{datePattern:n}});h.placeAt(a),h.focus(),h.textbox.select(),this.emit("editor-show",{cell:o,editor:h,grid:this}),h.on("blur",l.hitch(this,(function(){a.innerHTML=i.isValueEmpty(s[r.name])?null:i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:s[r.name],fieldInfo:r}),o.focus(),this.emit("editor-hide",{cell:o,editor:h,grid:this}),this._activeEditors.pop()}))),h.on("keydown",(function(e){e.keyCode===d.ENTER&&h.isValid()&&h.focusNode.blur()})),h.on("change",l.hitch(this,(function(e){if(h.isValid()){var t={fieldName:r.name,oldValue:s[r.name],rowId:s[c],row:s};s[r.name]=i.isValueEmpty(e)?null:e.getTime(),a.innerHTML=i.isValueEmpty(s[r.name])?null:i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:s[r.name],fieldInfo:r}),this._applyEdits({row:s,rollbackInfo:t})}else a.innerHTML=i.isValueEmpty(s[r.name])?null:i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:s[r.name],fieldInfo:r})}))),this._activeEditors.push({cellNode:o,id:s[c],widget:h})}else this._lastClickedCell=o})))},_setUpDateTimeCell:function(e){var t,n,s,r=e.row,a=e.cellNode,d=e.fieldInfo,c=e.container,u=this.idProperty;h(a,this.editOn,l.hitch(this,(function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:r});if(this.editable&&d.editable&&!1!==e)if(this._lastClickedCell!==a&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===a){this._closeCellEditors(),c.innerHTML="",n=d.dateOptions&&d.dateOptions.datePattern?d.dateOptions.datePattern:this.dateOptions.datePattern,s=d.dateOptions&&d.dateOptions.timePattern?d.dateOptions.timePattern:this.dateOptions.timePattern,t=i.isValueEmpty(r[d.name])?null:new Date(r[d.name]);var h=new T({value:t,constraints:{datePattern:n}}),f=new L({value:t,constraints:{timePattern:s}});h.placeAt(c),f.placeAt(c),h.focus(),h.textbox.select(),this.emit("editor-show",{cell:a,editor:[h,f],grid:this}),h.on("change",l.hitch(this,(function(e){if(h.isValid())if(null!==e&&""!==e){var t=f.getValue();null===t&&(t=new Date(0,0),f.setValue(t))}else f.setValue(null)}))),f.on("change",l.hitch(this,(function(e){if(f.isValid())if(null!==e&&""!==e){var t=h.getValue();null===t&&(t=new Date(0,0),h.setValue(t))}else h.setValue(null)})));var p=I.watch("activeStack",l.hitch(this,(function(e,t,n){var s=-1!==o.indexOf(t,h.id)||-1!==o.indexOf(t,f.id),l=-1===o.indexOf(n,h.id)&&-1===o.indexOf(n,f.id);if(s&&l){p.remove(),this.emit("editor-hide",{cell:a,editor:[h,f],grid:this});var m,y=h.getValue(),g=f.getValue(),C=r[d.name];if(f.isValid()&&h.isValid()){if(y&&g?(m=i.getCombinedDateTime(y,g).getTime(),c.innerHTML=i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:new Date(m),fieldInfo:d})):(m=null,c.innerHTML=""),r[d.name]===m)return;r[d.name]=m,this._applyEdits({row:r,rollbackInfo:{fieldName:d.name,oldValue:C,rowId:r[u],row:r}})}else c.innerHTML=null===C?"":i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:r[d.name],fieldInfo:d});h.destroy(),f.destroy()}})))}else this._lastClickedCell=a})))},_setUpCodedValueDomainCell:function(e){var t=e.row,n=e.cellNode,s=e.fieldInfo;this.editOn===_&&h(n,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(n,this.editOn,l.hitch(this,(function(){var r=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:t});if(this.editable&&s.editable&&!1!==r&&!i.findFirst(this._activeEditors,"cellNode",n))if(this._lastClickedCell!==n&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===n){var a=s.name,h=s.domain.codedValues,c=e.container,u=t[this.idProperty],f=[];c.innerHTML="",o.forEach(h,(function(e){var i=String(e.name);f.push({label:m.encode(i),value:String(e.code),selected:t[a]===e.code})})),i.isValueEmpty(t[a])?f.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!s.nullable}):s.nullable&&f.push({label:this._i18nStrings.empty,value:this._nullConstant});var p=new N({options:f,class:this.css.select,style:{width:"100%"}});p.placeAt(c),p.focus(),this.emit("editor-show",{cell:n,editor:p,grid:this}),p.on("blur",l.hitch(this,(function(){var e=i.getDomainValueFromRow({fieldInfo:s,row:t}),l=this._formatStringCellContent({fieldInfo:s,value:e});l=String(l),c.innerHTML=m.encode(l),this.emit("editor-hide",{cell:n,editor:p,grid:this}),this._activeEditors.pop()}))),p.on("keydown",(function(e){e.keyCode===d.ENTER&&p.focusNode.blur()})),p.on("change",l.hitch(this,(function(e){var n={fieldName:a,oldValue:t[a],rowId:u,row:t};e===this._nullConstant?e=null:i.isNumericFieldType(s.type)&&(e=Number(e)),t[a]=e,p.onBlur(),this._applyEdits({row:t,rollbackInfo:n}),p.destroy(),p=null}))),this._activeEditors.push({cellNode:n,id:u,widget:p})}else this._lastClickedCell=n})))},_setUpRangeDomainCell:function(e){var t,n=e.row,s=e.cellNode,o=e.fieldInfo,r=e.container,a=o.domain.minValue,c=o.domain.maxValue,u=this.idProperty,f=i.isIntegerFieldType(o.type)?0:"0,20";this.editOn===_&&h(s,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(s,this.editOn,l.hitch(this,(function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&o.editable&&!1!==e&&!i.findFirst(this._activeEditors,"cellNode",s))if(this._lastClickedCell!==s&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===s){r.innerHTML="";var h=new S({value:n[o.name],required:!o.nullable,constraints:{min:a,max:c,places:f}});h.placeAt(r),h.focus(),h.textbox.select(),this.emit("editor-show",{cell:s,editor:h,grid:this}),h.on("blur",l.hitch(this,(function(){r.innerHTML=this._formatNumberCellContent({fieldInfo:o,value:n[o.name]}),this.emit("editor-hide",{cell:s,editor:h,grid:this}),this._activeEditors.pop()}))),h.on("keydown",(function(e){e.keyCode===d.ENTER&&h.isValid()&&h.focusNode.blur()})),h.on("change",l.hitch(this,(function(e){t={fieldName:o.name,oldValue:n[o.name],rowId:n[u],row:n},h.isValid()&&(n[o.name]=e,this._applyEdits({row:n,rollbackInfo:t})),h.onBlur(),h.destroy(),h=null}))),this._activeEditors.push({cellNode:s,id:n[u],widget:h})}else this._lastClickedCell=s})))},_setUpTypeCell:function(e){var t,n=e.row,s=e.cellNode,r=e.fieldInfo,a=e.container,c=e.typesProperty,u=e.typeIdProperty,f=this.idProperty,p=this.layerInfo,m=p[c];this.editOn===_&&h(s,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(s,this.editOn,l.hitch(this,(function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&r.editable&&!1!==e&&!i.findFirst(this._activeEditors,"cellNode",s))if(this._lastClickedCell!==s&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===s){a.innerHTML="";var h=i.isValueEmpty(i.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:r,row:n,typesProperty:c,typeIdProperty:u})),y=r.name,g=n[y],C=[];o.forEach(m,(function(e){C.push({label:e.name,value:String(e[u]),selected:g===e[u]})})),i.isValueEmpty(g)?C.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):h&&C.push({label:String(g),value:String(g),selected:!0,disabled:!0});var I=new N({options:C,class:this.css.select,style:{width:"100%"}});I.placeAt(a),I.focus(),this.emit("editor-show",{cell:s,editor:I,grid:this}),I.on("blur",l.hitch(this,(function(){var e=i.getTypeValueFromRow({layerInfo:p,fieldInfo:r,row:n,typesProperty:c,typeIdProperty:u});a.innerHTML=this._formatStringCellContent({fieldInfo:r,value:e||g}),this.emit("editor-hide",{cell:s,editor:I,grid:this.grid}),this._activeEditors.pop()}))),I.on("keydown",(function(e){e.keyCode===d.ENTER&&I.focusNode.blur()})),I.on("change",l.hitch(this,(function(e){t={fieldName:y,oldValue:g,rowId:n[f],row:n},e===this._nullConstant?e=null:i.isNumericFieldType(r.type)&&(e=Number(e)),n[y]=e,I.onBlur(),this._applyEdits({row:n,rollbackInfo:t}),I.destroy(),I=null}))),this._activeEditors.push({cellNode:s,id:n[f],widget:I})}else this._lastClickedCell=s})))},_setUpSubtypeDomainCell:function(e){var t=e.cellNode;this.editOn===_&&h(t,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(t,this.editOn,l.hitch(this,(function(){var n=this.layerInfo,s=e.fieldInfo,r=e.row,a=i.isFeatureEditable({layer:this.layer,layerInfo:n,attributes:r});if(this.editable&&s.editable&&!1!==a&&!i.findFirst(this._activeEditors,"cellNode",t))if(this._lastClickedCell!==t&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===t){var h,c=r[this.idProperty],u=s.name,f=n.types,p=i.findFirst(f,"id",r[n.typeIdField]),m=e.container,y={};if(m.innerHTML="",p&&p.domains&&(h=p.domains[u]),(h&&"inherited"===h.type||!h&&s.domain)&&(h=s.domain),h&&h.codedValues){var g=h.codedValues,C=i.findFirst(g,"code",r[u]),I=!1,w=[];if(o.forEach(g,(function(e){w.push({label:e.name,value:String(e.code),selected:r[u]===e.code}),e.code===C&&(I=!0)})),i.isValueEmpty(r[u])&&s.nullable?w.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):i.isValueEmpty(r[u])&&!s.nullable?w.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):s.nullable&&w.push({label:this._i18nStrings.empty,value:this._nullConstant}),!I&&!C&&null!==r[u]){var b=r[u];w.push({label:b.toString(),value:"N/A",selected:!0,disabled:!0})}var v=new N({options:w,class:this.css.select,style:{width:"100%"}});v.placeAt(m),v.focus(),this.emit("editor-show",{cell:t,editor:v,grid:this}),v.on("blur",l.hitch(this,(function(){var e=i.findFirst(g,"code",r[u]);m.innerHTML=e?this._formatStringCellContent({fieldInfo:s,value:e.name}):this._formatStringCellContent({fieldInfo:s,value:r[u]}),this.emit("editor-hide",{cell:t,editor:v,grid:this}),this._activeEditors.pop()}))),v.on("keydown",(function(e){e.keyCode===d.ENTER&&v.focusNode.blur()})),v.on("change",l.hitch(this,(function(e){y={fieldName:u,oldValue:r[u],rowId:c,row:r},e===this._nullConstant?e=null:i.isNumericFieldType(s.type)&&(e=Number(e)),r[u]=e,v.onBlur(),this._applyEdits({row:r,rollbackInfo:y}),v.destroy(),v=null}))),this._activeEditors.push({cellNode:t,id:c,widget:v})}else{var F=new S({value:r[u],required:!s.nullable});h&&"range"===h.type&&(F.constraints={min:h.minValue,max:h.maxValue,places:i.isIntegerFieldType(s.type)?0:"0,20"}),F.placeAt(m),F.focus(),F.textbox.select(),this.emit("editor-show",{cell:t,editor:F,grid:this}),F.on("blur",l.hitch(this,(function(){m.innerHTML=r[u],this.emit("editor-hide",{cell:t,editor:F,grid:this}),this._activeEditors.pop()}))),F.on("keydown",(function(e){e.keyCode===d.ENTER&&F.isValid()&&F.focusNode.blur()})),F.on("change",l.hitch(this,(function(e){y={fieldName:u,oldValue:r[u],rowId:c,row:r},(""===e||isNaN(e))&&(e=null),F.isValid()&&(r[u]=e,this._applyEdits({row:r,rollbackInfo:y})),F.onBlur(),F.destroy(),F=null}))),this._activeEditors.push({cellNode:t,id:c,widget:F})}}else this._lastClickedCell=t})))},_setUpStringCell:function(e){var t=e.row,n=e.cellNode,s=e.fieldInfo,o=e.container,r=this.idProperty;this.editOn===_&&h(n,"pointerdown",l.hitch(this,(function(e){e.preventDefault()}))),h(n,this.editOn,l.hitch(this,(function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:t});if(this.editable&&s.editable&&!1!==e&&!i.findFirst(this._activeEditors,"cellNode",n))if(this._lastClickedCell!==n&&this._closeCellEditors(),this.editOn!==_||this._lastClickedCell===n){o.innerHTML="";var a,h=s.stringOptions;(a=h&&h.input&&"textarea"===h.input?new R({value:t[s.name],required:!s.nullable,maxLength:s.length?s.length:null,trim:!0}):new H({value:t[s.name],required:!s.nullable,maxLength:s.length?s.length:null})).placeAt(o),a.focus(),a.textbox.select(),this.emit("editor-show",{cell:n,editor:a,grid:this}),a.on("blur",l.hitch(this,(function(){o.innerHTML=this._formatStringCellContent({fieldInfo:s,value:t[s.name]}),n.focus(),this.emit("editor-hide",{cell:n,editor:a,grid:this}),this._activeEditors.pop()}))),a.on("keydown",(function(e){e.keyCode===d.ENTER&&a instanceof H&&a.isValid()&&a.focusNode.blur()})),a.on("change",l.hitch(this,(function(e){var n={fieldName:s.name,oldValue:t[s.name],rowId:t[r],row:t};""===e&&(e=null),a instanceof H&&a.isValid()?(t[s.name]=e,this._applyEdits({row:t,rollbackInfo:n})):a instanceof R&&(!i.isValueEmpty(e)||i.isValueEmpty(e)&&s.nullable)&&(t[s.name]=e,this._applyEdits({row:t,rollbackInfo:n})),o.innerHTML=this._formatStringCellContent({fieldInfo:s,value:t[s.name]}),a.destroy(),a=null}))),this._activeEditors.push({cellNode:n,id:t[r],widget:a})}else this._lastClickedCell=n})))},_formatStringCellContent:function(e){var t=e.value,n=e.fieldInfo?e.fieldInfo.format:null;return i.isValueEmpty(t)?"":n?n.embeddedHTML||!1===n.link?t:n.template?c.substitute(n.template,{value:t}):t:i.generateLinkFromString(t)},_formatNumberCellContent:function(e){var t=e.fieldInfo?e.fieldInfo.format:null,n=e.value;if(i.isValueEmpty(n))return"";var s=i.formatNumberForLocale(n,t);return t&&t.template&&(s=c.substitute(t.template,{value:s})),this.isLeftToRight()||(s='<span dir="ltr">'+s+"</span>"),s},_generateAttachmentsCell:function(e){if(this.layerInfo){var t,n,s,o=e.row,r=e.cellValue,a=e.cellNode,d=e.fieldInfo,u=this.layerInfo,p=this.css,m=this._i18nStrings;s=i.isValueEmpty(r)?"":c.substitute(m.parenValue,{value:r}),t=f.create("div",{innerHTML:s,className:p.attachmentsCell},a),n=r>0||!u.queryAttachmentsSupported?" "+m.show:this.editable&&u.editable?" "+m.add:"",f.create("span",{innerHTML:n,className:p.attachmentsLink},t),h(t,_,l.hitch(this,(function(){this._showAttachmentsHandler({row:o,fieldInfo:d,cellValue:r,cellNode:a,textContainer:t})})))}},_generateRelatedRecordsCell:function(e){var t,n,s=e.row,o=e.cellValue,r=e.cellNode,a=e.fieldInfo,d=this.css,u=this._i18nStrings;n=i.isValueEmpty(o)?"":c.substitute(u.parenValue,{value:o})+" ",t=f.create("div",{innerHTML:n,className:d.relatedRecordsCell},r),f.create("span",{innerHTML:o>0?u.show:"",className:d.relatedRecordsLink},t),h(r,_,l.hitch(this,(function(e){if(o>0){var t=this.dGrid.cell(e).column;this._showRelatedRecordsHandler({row:s,fieldInfo:a,column:t,count:o})}})))},_generateExpressionCell:function(e){var t=e.row,i=e.cellValue,n=e.cellNode,s=e.fieldInfo,o=f.create("div",{className:this.css.expressionsCell},n);if(s.hasFeatureSetOperations)var r=f.create("span",{innerHTML:this._i18nStrings.show,className:this.css.expressionsLink},o),a=h(o,_,l.hitch(this,(function(){var e=f.create("div",{className:this.css.cellLoadingIndicator});f.place(e,r,"replace");var i=this._getExpressionValueForField(s.name,t);i&&i.then?i.then(l.hitch(this,(function(e){o.innerHTML=this._formatExpressionCellContent(s,e)}))).otherwise(l.hitch(this,(function(e){o.innerHTML=this._i18nStrings.dataError}))):o.innerHTML="",a.remove()})));else o.innerHTML=this._formatExpressionCellContent(s,i)},updateHeaderText:function(e){var t=e?e.count:null,n=e?e.selectedCount:null,s=e?e.title:null,l=!e||e.showFilterCount;s=i.isValueEmpty(s)?this._tableTitle||this.layer.name||this._i18nStrings.untitled:s,t=i.isValueEmpty(t)?this.featureCount:t,n=i.isValueEmpty(n)?this.selectedFeatureCount:n,this.filterIds&&this.filterIds.length>0&&l&&(t=this.filterIds.length),this.showFeatureCount?this.setHeaderTitle(c.substitute(this._i18nStrings.gridHeader,{gridTitle:s,featureCount:t,featureSelectedCount:n})):this.setHeaderTitle(s)},_generateOptionsMenu:function(){var e=this.css,t=this._i18nStrings,i=e.menuItem+" "+e.button+" "+e.menuIcon,n=f.create("div",{className:i,title:t.options,"aria-label":t.options,tabIndex:0},this._gridMenuNode);h(n,[_,"keydown"],l.hitch(this,(function(e){"Tab"!==e.key&&this._showOptionsMenu(e)}))),this.optionsMenuAnchor=n},_showOptionsMenu:function(e){var t,i,n,s,r,a=this.optionsMenuAnchor,d=this.css;this.optionsMenu&&(this.optionsMenu.destroy(),this.optionsMenu=null),s=(n=a.getBoundingClientRect()).top+n.height,r=this.isLeftToRight()?n.left+n.width:n.right-n.width,t=new w({className:d.optionsMenu}),i=this._generateOptionsMenuItems(),o.forEach(i,(function(e){var i=new b({label:e.label,baseClass:d.menuItem,onClick:l.hitch(this,e.callback)});t.addChild(i)}),this),t._openMyself({target:e.target,delegatedTarget:a,iframe:null,coords:{x:r,y:s}}),this.optionsMenu=t},_generateOptionsMenuItems:function(){var e=[];return this.showDefaultSortMenuItem&&e.push({label:this._i18nStrings.defaultSort,callback:this._sortFieldDefaultCallback}),this.showFilterMenuItems?e.push({label:this._i18nStrings.showSelected,callback:this._showSelectedRecordsCallback},{label:this._i18nStrings.clearSelection,callback:this._clearFilterCallback}):e.push({label:this._i18nStrings.clearSelection,callback:this.clearSelection}),this.gridOptions.columnHider&&e.push({label:this._i18nStrings.toggleColumns,callback:this.showColumnToggleMenu}),this.map&&this.syncSelection&&e.push({label:this._i18nStrings.centerOnSelection,callback:this.centerOnSelection}),this.menuFunctions&&this.menuFunctions.length>0&&o.forEach(this.menuFunctions,(function(t){e.push({label:t.label,callback:t.callback})}),this),e},_sortFieldDefaultCallback:function(){var e=this.defaultSort.attribute,t=this.defaultSort.descending;this.set("sort",{field:e,descending:t}),this.emit("sort",{field:e,descending:t,orderByFields:[i.getOrderByString(e,t)]})},_showSelectedRecordsCallback:function(){0!==this.selectedRowIds.length&&this.emit("show-selected-records",{ids:this.selectedRowIds})},_clearFilterCallback:function(){this.emit("clear-selection"),this.emit("clear-filter")},showColumnToggleMenu:function(){this.dGrid._toggleColumnHiderMenu()},_generateColumnMenu:function(e){var t=this.dGrid.cell(e),n=t?t.column:null;if(n){var s,r=this.dGrid.columns,a=this.fieldInfos,d=this.columnMenu,h=this.css,c=this.columnMenuFunctions,u=d,f=n.id,p=r[f],m=i.findFirst(a,"name",p.field);d&&this.set("columnMenu",null),!1!==p.sortable&&(s=new w({className:h.columnMenu}),this._generateSortMenuItems({menu:s,columnId:f}),this._generateStatisticsMenuItem({menu:s,fieldInfo:m,columnId:f}),this._generateFieldDetailsMenuItem({menu:s,fieldInfo:m,column:p}),c&&c.length>0&&o.forEach(c,(function(e){s.addChild(new b({label:e.label,iconClass:e.iconClass||"",baseClass:e.baseClass||"",onClick:l.hitch(this,e.callback,m)}))})),s.startup(),this._showColumnMenu({menu:s,cell:t,evt:e,fieldInfo:m,previousMenu:u}),this.set("columnMenu",s))}},_showColumnMenu:function(e){var t,i,n,s=e.menu,l=e.cell,o=e.evt,r=e.previousMenu;n=(t=l.element.getBoundingClientRect()).top+t.height,i=this.isLeftToRight()?t.right-t.width:t.right,s._openMyself({target:o.target,delegatedTarget:l,iframe:null,coords:{x:i,y:n}}),h(s,"close",(function(){r&&(r.destroyRecursive(),r=null)}))},_generateSortMenuItems:function(e){var t=e.menu,i=e.columnId,n=this.css;t.addChild(new b({label:this._i18nStrings.sortAsc,iconClass:n.sortAscendingIcon,baseClass:n.menuItem,onClick:l.hitch(this,this._sortFieldAscendingHandler,i)})),t.addChild(new b({label:this._i18nStrings.sortDesc,iconClass:n.sortDescendingIcon,baseClass:n.menuItem,onClick:l.hitch(this,this._sortFieldDescendingHandler,i)}))},_sortFieldAscendingHandler:function(e){var t=this.dGrid.columns[e];this.emit("sort",{column:t,id:e,field:t.field,descending:!1,orderByFields:[i.getOrderByString(t.field,!1)]})},_sortFieldDescendingHandler:function(e){var t=this.dGrid.columns[e];this.emit("sort",{column:t,id:e,field:t.field,descending:!0,orderByFields:[i.getOrderByString(t.field,!0)]})},_generateStatisticsMenuItem:function(e){var t=e.menu,n=e.fieldInfo,s=this.css,o=this.layer,r=!!this.layerInfo.isFeatureCollection,a=o.advancedQueryCapabilities.supportsStatistics||o.supportsStatistics;!this.showStatistics||!a||!n||n.domain&&n.domain.codedValues||n.subtypeDomain||n.typeId||n.subtypeField||r||i.isNumericFieldType(n.type)&&t.addChild(new b({label:this._i18nStrings.statistics,iconClass:s.statisticsIcon,baseClass:s.menuItem,onClick:l.hitch(this,this._showStatisticsHandler,e)}))},_generateFieldDetailsMenuItem:function(e){if(this.showFieldDetails){var t=e.menu,i=e.fieldInfo,n=e.column,s=parseInt(n.id,10),r=this.css;"esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&-1===o.indexOf(this._unsupportedFieldTypes,i.type)&&t.addChild(new b({label:this._i18nStrings.showDetailedView,iconClass:r.propertiesIcon,baseClass:r.menuItem,onClick:l.hitch(this,(function(){this.emit("show-detailed-field-view",{columnId:s,fieldInfo:i})}))}))}},_fetchAttachments:function(e){return i.queryLayerForAttachments({layer:this.layer,ids:e||null})},_showAttachmentsHandler:function(e){var t,i,s,o,r=e.row,a=e.fieldInfo,d=e.cellValue,h=e.cellNode,c=this.layerInfo,u=this.idProperty,f=r[u];(0!==d||c.editCapabilities.canCreate)&&(t=this.attachmentInfos[f]?this.attachmentInfos[f].attachments:[],s=(o=(i=n.generateAttachmentsDialog({layer:this.layer,featureId:f,attachments:t,editable:this.editable&&c.editable,css:this.css})).featureAttachments).attachments,this.own(o.on("add-complete",l.hitch(this,(function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={attachments:[]}),this.attachmentInfos[f].attachments=e.attachments,c.queryAttachmentsSupported&&(d+=1),h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h}),this.emit("add-attachment-complete",e)}))),o.on("delete-complete",l.hitch(this,(function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={attachments:[]}),this.attachmentInfos[f].attachments=e.attachments,c.queryAttachmentsSupported&&(d-=1),h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h}),this.emit("delete-attachment-complete",e)})))),this.emit("show-attachments",{featureId:f,attachments:s,dialog:i.dialog}))},_updateAttachmentInfos:function(e){return l.mixin(this.attachmentInfos,e)},_fetchRelatedRecords:function(e){var t=e.ids||null,n=e.relationship,s=e.outFields||["*"];return i.queryLayerForRelatedRecords({layer:this.layer,ids:t,relationship:n,outFields:s})},_showRelatedRecordsHandler:function(e){var t,n,s,l=e.row,r=this.idProperty,a=l[r],d=e.fieldInfo.relationship,h=e.count,c=this.columns,u=this.layer,f=u.getField(d.keyField),p=f?f.name:null,m=p?l[p]:null;n=o.filter(c,(function(e){return!e.hidden})),t=[i.findFirst(n,"field",u.displayField),i.findFirst(n,"field",p),i.findFirst(n,"type","esriFieldTypeString"),i.findFirstNumberColumn(c,r),i.findFirst(n,"type","esriFieldTypeDate")],o.some(t,(function(e){if(this._validateRelatedColumnDisplay(e))return s=o.indexOf(c,e),!0}),this),i.isValueEmpty(s)&&(s=0),this.emit("show-related-records",{row:l,featureId:a,keyField:p,keyFieldValue:m,columnId:s,relationship:d,count:h})},_setUpRelatedRecordInfos:function(e){var t=e.relationships,i=e.records,n=this.relatedRecordInfos;return o.forEach(t,(function(e,t){n[e.id]=i[t]})),n},_updateRelatedRecordInfos:function(e){var t=this.relatedRecordInfos;this.relatedRecordInfos=i.mergeDictionaries(t,e)},_updateRelatedRecordCounts:function(e){var t=this.relatedRecordCounts,n={};o.forEach(this.layer.relationships,(function(t){var i=e[t.id];if(i){var s=i.relatedRecordGroups,l=t.id;n[l]={},o.forEach(s,(function(e){n[l][e.objectId]={count:e.count}}))}})),this.relatedRecordCounts=i.mergeDictionaries(t,n)},_getRelatedRecordsById:function(e){var t=e.featureId,i=e.relationshipId;return this.relatedRecordInfos[i]?this.relatedRecordInfos[i][t]:[]},_getRelatedRecordsCount:function(e){var t,i=e.featureId,n=e.relationshipId;return this.layerInfo.supportsAdvancedQueryRelated?(t=this.relatedRecordCounts[n]?this.relatedRecordCounts[n][i]:{})?t.count:0:(t=this._getRelatedRecordsById({featureId:i,relationshipId:n}))&&t.features?t.features.length:0},_generateRelatedRecordFieldInfos:function(e){var t,n=[],s=e.relationships,l=this.visibleLayerIds,r=!1;return o.some(s,(function(e,s){s===this._relationshipColumnLimit&&(r=!0),t=i.isCyclicalRelationship(e),!!l&&l[l.length-1]===e.relatedTableId&&t&&!this.showCyclicalRelationships||n.push({alias:e.name,name:e.name,type:"esriRelatedRecords",hidden:r,relatedIndex:s,relationship:e})}),this),n},_validateRelatedColumnDisplay:function(e){return!(!e||e.hidden||-1===o.indexOf(this.columns,e)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type)},_getExpressionValueForField:function(e,t){var n=t[this.idProperty],s=this.expressionCache[e],l=this.layerInfo.isFeatureCollection?i.findFirst(this.layer.graphics,"attributes",t):this.store.data[n];return i.getExpressionValue(l,s)},_formatExpressionCellContent:function(e,t){return i.isValueEmpty(t)?"":("number"==e.type?t=this._formatNumberCellContent({fieldInfo:e,value:t}):(t=String(t),t=m.encode(t),t=(t=this._formatStringCellContent({fieldInfo:e,value:t})).replace(/(\n)/gi,"<span class='charNewLine'>$1</span>")),t)},_showStatisticsHandler:function(e){var t,s,o=e.columnId,r=e.fieldInfo;t=this.where||this.layer.getDefinitionExpression?this.layer.getDefinitionExpression():"1=1",i.getFieldStatistics({grid:this.dGrid,layer:this.layer,fieldInfo:r,idProperty:this.idProperty,filterIds:this.filterIds,where:t,columnId:o}).then(l.hitch(this,(function(e){s=n.generateStatisticsDialog({data:e,fieldInfo:r,css:this.css}),this.emit("show-statistics",s)})))},_addGridListeners:function(){this._setUpRowSelectListener(),this._setUpRowDeselectListener(),this._setUpDataChangeListener(),this._setUpRefreshListener(),this._setUpColumnClickListener(),this._setUpColumnStateChangeListener(),this._setUpColumnResizeListener(),this._setUpErrorListener(),this._setUpSortListener(),this._setUpFilterListener(),this._setUpEditorShowListener(),this._setUpEditorHideListener(),this.own(this._setUpStoreLoadListener(),this._setUpLayerClickListener(),this._setUpLayerSelectionCompleteListener(),this._setUpLayerSelectionClearListener(),this._setUpLayerUpdateEndListener(),this._setUpLayerRefreshTickListener(),this._setUpLayerFeaturesUpdatesListener())},_setUpStoreLoadListener:function(){var e=this.watch("store",l.hitch(this,(function(t,i,n){null===i&&n&&(this.set("loaded",!0),this.emit("load",{loaded:!0}),e.remove())})));return e},_setUpRowSelectListener:function(){return this.dGrid.on("dgrid-select",l.hitch(this,(function(e){this._updateSelection().then(l.hitch(this,(function(){this.updateHeaderText(),this.emit("row-select",e)})))})))},_setUpRowDeselectListener:function(){return this.dGrid.on("dgrid-deselect",l.hitch(this,(function(e){this._previousSelectedRowIds=this.selectedRowIds,this._updateSelection().then(l.hitch(this,(function(){this.updateHeaderText(),this.emit("row-deselect",e)})))})))},_setUpDataChangeListener:function(){return this.dGrid.on("dgrid-datachange",l.hitch(this,(function(e){var t=this.fieldInfos,n=e.cell.column.field,s=i.findFirst(t,"name",n),o=e.cell.row.data,r=o[this.idProperty],a=e.value,d=e.oldValue,h=i.isIntegerFieldType(s.type),c=i.isFloatFieldType(s.type),u={oldValue:d,fieldName:n,rowId:r,row:o};""===a&&(a=null),h&&null!==a&&(a=parseInt(a,10)),c&&null!==a&&(a=parseFloat(a)),a&&a.getTime&&a.getTime()?o[n]=a.getTime():o[n]=a,this.showLoadingIndicator(),this._updateSelection().then(l.hitch(this,(function(){this.updateHeaderText(),this._applyEdits({row:o,rollbackInfo:u})}))),this.emit("data-change",{row:o,rollbackInfo:u})})))},_setUpRefreshListener:function(){return this.dGrid.on("dgrid-refresh-complete",l.hitch(this,(function(e){this._lastClickedCell=null,this.dGrid.columns[0]&&this.emit("refresh",e)})))},_setUpColumnClickListener:function(){return this.dGrid.on(".dgrid-header .dgrid-cell:click",l.hitch(this,this._generateColumnMenu))},_setUpColumnStateChangeListener:function(){return this.dGrid.on("dgrid-columnstatechange",l.hitch(this,(function(e){this.emit("column-state-change",e)})))},_setUpColumnResizeListener:function(){return this.dGrid.on("dgrid-columnresize",l.hitch(this,(function(e){this.emit("column-resize",e)})))},_setUpErrorListener:function(){return this.dGrid.on("dgrid-error",l.hitch(this,(function(e){this.emit("error",e)})))},_setUpSortListener:function(){return this.dGrid.on("dgrid-sort",l.hitch(this,(function(e){this.emit("sort",e)})))},_setUpFilterListener:function(){return this.dGrid.on("dgrid-filter",l.hitch(this,(function(e){this.emit("filter",e)})))},_setUpEditorShowListener:function(){return this.dGrid.on("dgrid-editor-show",l.hitch(this,(function(e){this.emit("editor-show",e)})))},_setUpEditorHideListener:function(){return this.dGrid.on("dgrid-editor-hide",l.hitch(this,(function(e){this.emit("editor-hide",e)})))},_setUpLayerClickListener:function(){return h(this.layer,"click",l.hitch(this,(function(e){this.emit("layer-click",e)})))},_setUpLayerSelectionCompleteListener:function(){return h(this.layer,"selection-complete",l.hitch(this,(function(e){this.emit("layer-selection-complete",e)})))},_setUpLayerSelectionClearListener:function(){return h(this.layer,"selection-clear",l.hitch(this,(function(e){this.emit("layer-selection-clear",e)})))},_setUpLayerUpdateEndListener:function(){return h(this.layer,"update-end",l.hitch(this,(function(e){this.emit("layer-update-end",e)})))},_setUpLayerRefreshTickListener:function(){return h(this.layer,"refresh-tick",l.hitch(this,(function(e){this.layer.isFeatureUpdatesCheckActive()||this.emit("layer-refresh-tick",e)})))},_setUpLayerFeaturesUpdatesListener:function(){return h(this.layer,"feature-updates-result",l.hitch(this,(function(e){(e.hasUpdates||this.layer.hasDefinitionExpressionWithCurrentTimestamp())&&this.emit("layer-refresh-tick",e)})))}});return a("extend-esri")&&l.setObject("dijit.Grid",q,e),q}));