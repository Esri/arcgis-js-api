// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["../../kernel","../../arcadeProfiles/popupProfile","./dataUtils","./dialogUtils","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/has","dojo/keys","dojo/on","dojo/string","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojox/html/entities","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_WidgetBase","dijit/a11yclick","dijit/focus","dijit/Menu","dijit/MenuItem","dijit/Tooltip","dijit/form/Button","dijit/form/DateTextBox","dijit/form/DropDownButton","dijit/form/NumberTextBox","dijit/form/Select","dijit/form/SimpleTextarea","dijit/form/TimeTextBox","dijit/form/ValidationTextBox","dijit/layout/BorderContainer","dijit/layout/ContentPane","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/editor","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","dojo/i18n!../../nls/jsapi","dojo/text!./templates/Grid.html"],function(e,t,i,n,s,l,o,r,a,d,h,c,u,f,m,p,g,y,I,_,C,w,b,v,F,T,R,S,E,L,N,H,M,x,V,O,D,k,G,U,A,P,j,B,z){var q=s([I,g,y],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table-grid",templateString:z,map:null,layer:null,layerInfo:null,idProperty:"id",sort:null,defaultSort:null,filterIds:null,where:null,batchCount:50,editable:!1,editOn:"dblclick, keypress",css:null,showAttachments:!1,showRelatedRecords:!1,showCyclicalRelationships:!1,showStatistics:!1,showFieldDetails:!1,showGridHeader:!0,showGridMenu:!0,showFilterMenuItems:!0,showDefaultSortMenuItem:!0,showFeatureCount:!0,showDataTypes:!1,showColumnHeaderTooltips:!1,showColumnHeaderTooltipsWithDescription:!1,showColumnHider:!1,syncSelection:!1,menuFunctions:null,columnMenuFunctions:null,gridOptions:null,dateOptions:null,visibleLayerIds:null,showExpressionFields:!1,loaded:!1,store:null,columns:null,fieldInfos:null,customFieldInfos:null,expressionInfos:null,expressionCache:{},noDataMessage:"",featureCount:0,selectedFeatureCount:0,selectedRows:null,selectedRowIds:null,optionsMenu:null,optionsMenuAnchor:null,columnMenu:null,rollbackInfos:null,attachmentInfos:null,relatedRecordInfos:null,relatedRecordCounts:null,_i18nStrings:B.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger","number"],_unsupportedFieldTypes:["esriFieldTypeGUID","esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_activeEditors:[],_relationshipColumnLimit:5,_nullConstant:"ft_null",_watchers:null,_tableTitle:null,_previousSelectedRowIds:null,_loading:0,postMixInProperties:function(){this.inherited(arguments),this.set({sort:{},columns:[],fieldInfos:[],selectedRows:[],selectedRowIds:[],rollbackInfos:{},attachmentInfos:{},relatedRecordInfos:{},relatedRecordCounts:{},_watchers:[],_previousSelectedRowIds:[]})},startup:function(){this.inherited(arguments),this.showExpressionFields&&this.expressionInfos&&(this.expressionCache=i.compileExpressions(this.expressionInfos)),this.dGrid=this._generateBaseGrid(),this._cleanUpGrid(),this.dGrid.startup(),this.dGrid.resize(),this.updateHeaderText(),this._generateOptionsMenu(),this.showGridHeader||this.hideHeader(),this.showGridMenu||this.hideOptionsMenu(),this._addGridListeners()},destroy:function(){this.inherited(arguments),this.optionsMenu&&this.optionsMenu.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),o.forEach(this._watchers,function(e){e.remove()})},resize:function(){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize(),this._gridHeaderNode&&this._gridHeaderNode.resize(),this._gridContentPaneNode&&this._gridContentPaneNode.resize(),this.dGrid&&this.dGrid.resize()},setHeaderTitle:function(e){this._gridTitleNode&&(this._gridTitleNode.innerHTML=e)},showHeader:function(){u.remove(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},hideHeader:function(){u.add(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},showLoadingIndicator:function(){this._gridLoadingIndicatorNode&&0===this._loading&&u.remove(this._gridLoadingIndicatorNode,this.css.hidden),this._loading++},hideLoadingIndicator:function(){this._loading--,this._gridLoadingIndicatorNode&&!this._loading&&u.add(this._gridLoadingIndicatorNode,this.css.hidden)},showOptionsMenu:function(){this._menuNode&&u.remove(this._menuNode,this.css.hidden)},hideOptionsMenu:function(){this._menuNode&&u.add(this._menuNode,this.css.hidden)},updateNoDataMessage:function(e){this.dGrid.set("noDataMessage",e)},showColumnHiderMenu:function(){this.gridOptions.columnHider&&this.dGrid._toggleColumnHiderMenu()},refresh:function(){this.dGrid&&this.dGrid.refresh(),0===this.featureCount&&this.hideLoadingIndicator(),this._updateSelection().then(l.hitch(this,this.updateHeaderText))},getRowById:function(e){return this.dGrid.row(e)||{}},getRowDataById:function(e){var t=this.getRowById(e);return t&&t.data?t.data:{}},emptyStore:function(){this.updateNoDataMessage(""),this.updateStore(null)},updateStore:function(e){this.set("store",e),this.dGrid.set("store",e)},updateSort:function(e){this.set("sort",e[0]),this.dGrid.set("sort",e)},updateSelectionMode:function(e){this.dGrid.set("selectionMode",e)},getColumns:function(){return this.dGrid.columns},styleColumn:function(e,t){return this.dGrid.styleColumn(e,t)},clearSelection:function(){this.dGrid.clearSelection(),this._updateSelection().then(l.hitch(this,this.updateHeaderText)),this.emit("clear-selection")},centerOnSelection:function(){var e=this.map,t=this.layer,n=this.selectedRowIds;if(e&&n&&0!==n.length)return i.queryLayerForFeatures({layer:t,ids:n}).then(l.hitch(function(t){var n=t.features;n&&n.length>0&&e.setExtent(i.calculateExtentFromFeatures(n))}))},selectRows:function(e,t,i){var n,s=this.dGrid,r=[];this._closeCellEditors(),this.clearSelection(),e instanceof Array?(o.forEach(e,function(e){s._select(e),r.push(this.getRowById(e))},this),n=e[0]):(s._select(e),n=e,r=[this.getRowById(e)]),this._updateSelection().then(l.hitch(this,function(){this.updateHeaderText(),i||this.emit("row-select",{rows:r,grid:this.dGrid}),t&&this._scrollToRow(n)}))},_generateBaseGrid:function(){var e=this.gridOptions||{},t=[A,V,O,G,D,k];return e.pagination&&t.push(U),e.columnHider&&t.push(P),e.columnResizer&&t.push(j),new(s(t))({columns:this.columns,sort:[this.defaultSort],noDataMessage:this.noDataMessage,selectionMode:e.selectionMode,allowSelectAll:e.allowSelectAll,allowTextSelection:e.allowTextSelection,cellNavigation:e.cellNavigation,keepScrollPosition:e.keepScrollPosition,pageSizeOptions:e.pageSizeOptions,queryRowsOverlap:e.queryRowsOverlap,minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,pagingDelay:this.pagingDelay,query:l.hitch(this,this._getQueryForGrid)},this._gridNode)},_getQueryForGrid:function(e){return!this.filterIds||-1!==o.indexOf(this.filterIds,e[this.idProperty])},_cleanUpGrid:function(){var e=this.dGrid,t=r.before(e,"removeRow",l.hitch(this,function(t){o.forEach(this.columns.length,function(i,n){var s=e.cell(t,n).element,l=s.contents||s;l&&l.widget&&l.widget.destroyRecursive()})})),i=r.after(e,"renderHeader",function(){e._sortListener.remove()});this._watchers.push(t,i)},_setUpColumns:function(e){var t=this._generateFieldInfos(e),i=this._generateColumns(t);return this.set({columns:i,fieldInfos:t}),this.dGrid.set("columns",i),{fieldInfos:t,columns:i}},_generateFieldInfos:function(e){if(e&&0!==e.length&&this.layerInfo){var n=this._orderFieldsForDisplay(e),s=this.layer,l=this.layerInfo,r=[],a=this.customFieldInfos;o.forEach(n,function(e){var n=e.name,d=e.length||null,h=i.findFirst(s.fields,"name",n)||{},c=i.findFirst(a,"name",n)||i.findFirst(a,"fieldName",n);if(i.isExpressionField(n)){var u=i.getExpressionInfo(this.expressionInfos,n),f=this.expressionCache[u.name],m=t.isAsync(f);r.push({name:u.name,expression:!0,hasFeatureSetOperations:m,length:d,hidden:!c.visible,alias:e.alias,type:e.type,editable:e.editable,nullable:e.nullable,domain:!1,typeId:!1,subtypeDomain:!1,format:c.format||null,dateOptions:null,description:e.description})}else{var p,g,y,I,_,C,w,b,v,F,T,R,S=this.idProperty,E=this.outFields,L=this.hiddenFields;y=c&&(c.label||c.alias)||h.alias,I=!(!s.getDomain||!s.getDomain(n))&&s.getDomain(n),_=!(!l.typeIdField||n!==l.typeIdField),C=l.types&&o.some(l.types,function(e){if(e.domains&&e.domains[n]&&e.domains[n].name)return!0}),w=!this._getFieldVisibility({field:e,hiddenFields:L,customFieldInfo:c,outFields:E}),p=l.editable&&l.editCapabilities.canUpdate,g=c&&(void 0!==c.editable&&!1!==h.editable||void 0!==c.isEditable&&!1!==h.isEditable),b=!!(p&&n!==S&&h&&"undefined"!==h.editable&&(g?c.editable||c.isEditable:h.editable)),v=c&&c.format?c.format:null,F=!!h.nullable,T=c&&(c.dateOptions||c.format&&c.format.dateFormat)||null,R=c&&c.stringOptions?c.stringOptions:null,r.push({name:n,alias:y,length:d,type:e.type,hidden:w,editable:b,nullable:F,domain:I,typeId:_,subtypeDomain:C,format:v,dateOptions:T,stringOptions:R,description:e.description})}},this);if(o.every(r,function(e){return e.hidden})){i.findFirst(r,"name",this.idProperty).hidden=!1}if(this.showRelatedRecords){var d=this._generateRelatedRecordFieldInfos({relationships:s.relationships});r=r.concat(d)}return this.showAttachments&&r.push({alias:this._i18nStrings.photosAndFiles,name:"esriAttachments",type:"esriAttachments",editable:l.editable}),r}},_destroyColumns:function(){this.dGrid&&this.dGrid._destroyColumns()},_getFieldVisibility:function(e){var t,i,n,s,l,r=e.field,a=e.hiddenFields,d=e.outFields,h=e.customFieldInfo;return t=-1!==o.indexOf(a,r.name),s=!(!h||!1!==h.visible),l="*"!==d[0]&&-1===o.indexOf(d,r.name),i="esriFieldTypeOID"===r.type||"esriFieldTypeGlobalID"===r.type,n=i&&(s||l),!(t||n||s||l)},_applyEdits:function(e){var t=e.row,n=e.rollbackInfo;return this.showLoadingIndicator(),n&&this._updateRollbackInfos(n),this.emit("data-change",{row:t,rollbackInfo:n}),i.applyEditsFromRow({layer:this.layer,idProperty:this.idProperty,row:t}).then(l.hitch(this,function(e){var i=e.updates||[];i&&i.length&&o.forEach(i,function(e){e.success||(e.error?this.emit("error",{message:e.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),n?(t=this.getRowDataById(n.rowId),t[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback}))},this),this.hideLoadingIndicator(),this.emit("edits-complete",e)})).otherwise(l.hitch(this,function(){n&&(t=this.getRowDataById(n.rowId),t[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()),this.hideLoadingIndicator(),this.emit("error",{message:this._i18nStrings.errorUpdateFailed})}))},_updateRollbackInfos:function(e){if(e){var t=e.rowId;this.rollbackInfos[t]||(this.rollbackInfos[t]=[]),this.rollbackInfos[t].push(e)}},_updateSelection:function(){var e,t,i,n,s,l=this.dGrid.selection,o=new m,r=[],a=[];for(i in l)l.hasOwnProperty(i)&&(n=parseInt(i,10),a.push(n),e=this.dGrid.row(n),(t=e.data)&&r.push(t));return s={selectedRows:r,selectedRowIds:a,selectedFeatureCount:a.length},this.set(s),o.resolve(s),o},_scrollToRow:function(e){var t,i,n,s=this.store,l=this.dGrid,r=l.row(e),a=this.sort;if(r&&s){if(r.element)return void r.element.scrollIntoView();t=s.data[e]||r.data,t&&(i=a&&a.attribute===this.idProperty&&a.descending?s.data.length-o.indexOf(s.data,t):o.indexOf(s.data,t),n=l.rowHeight*i-l.rowHeight,l.scrollTo({x:0,y:n}),r.element?r.element.scrollIntoView():setTimeout(function(){r.element&&r.element.scrollIntoView()},200))}},_generateColumns:function(e){var t=l.clone(e)||[],i=[];return o.forEach(t,function(e){e.expression?i.push(this._generateExpressionColumn(e)):"esriAttachments"===e.type?i.push(this._generateAttachmentsColumn(e)):"esriRelatedRecords"===e.type?i.push(this._generateRelatedRecordsColumn(e)):"esriFieldTypeDate"===e.type?this.dateOptions.timeEnabled||e.dateOptions&&e.dateOptions.timeEnabled?i.push(this._generateDateTimeColumn(e)):i.push(this._generateDateColumn(e)):e.subtypeDomain&&!e.typeId?i.push(this._generateSubtypeDomainColumn(e)):e.domain?i.push(this._generateDomainColumn(e)):e.typeId?i.push(this._generateTypeColumn(e)):o.indexOf(this._numericFieldTypes,e.type)>-1?i.push(this._generateNumberColumn(e)):-1===o.indexOf(this._unsupportedFieldTypes,e.type)&&i.push(this._generateStringColumn(e))},this),i},_orderFieldsForDisplay:function(e){var t=this.outFields,n=this.idProperty,s=[];if(t&&"*"===t[0])s=l.clone(e);else{if(!i.isValueEmpty(n)&&-1===o.indexOf(t,n)){var r=i.findFirst(e,"name",n);r&&s.push(r)}o.forEach(t,function(t){var l=i.findFirst(e,"name",t);l&&t!==n&&-1===o.indexOf(s,l)&&s.push(l)},this),o.forEach(e,function(e){-1===o.indexOf(s,e)&&s.push(l.clone(e))})}return s},_generateDateColumn:function(e){var t=e.dateOptions||this.dateOptions;return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,className:this.css.dateValue,get:l.hitch(this,function(n){return i.isValueEmpty(n[e.name])?null:i.formatDateForLocale({dateOptions:t,timestamp:new Date(n[e.name]),fieldInfo:e})}),renderCell:l.hitch(this,function(t,n,s){var l=f.create("div",{innerHTML:i.isValueEmpty(n)?"":n},s);this._setUpDateCell({row:t,cellNode:s,fieldInfo:e,container:l})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateDateTimeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,className:this.css.dateValue,get:l.hitch(this,function(t){return i.isValueEmpty(t[e.name])?null:i.formatDateForLocale({dateOptions:e.dateOptions||this.dateOptions,timestamp:new Date(t[e.name]),fieldInfo:e})}),renderCell:l.hitch(this,function(t,n,s){var l=f.create("div",{innerHTML:i.isValueEmpty(n)?"":n},s);this._setUpDateTimeCell({row:t,cellNode:s,fieldInfo:e,container:l})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:function(t){return i.getDomainValueFromRow({fieldInfo:e,row:t})},renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:l.hitch(this,function(t,i,n){var s,l=f.create("div");if(e.domain.codedValues)s=this._formatStringCellContent({fieldInfo:e,value:i}),s=String(s),s=p.encode(s),this._setUpCodedValueDomainCell({row:t,cellNode:n,fieldInfo:e,container:l});else{if("range"!==e.domain.type)return void this.emit("error",{message:this._i18nStrings.errorDomainType});s=this._formatNumberCellContent({fieldInfo:e,value:i}),this._setUpRangeDomainCell({row:t,cellNode:n,fieldInfo:e,container:l})}l.innerHTML=s,f.place(l,n)})}},_generateTypeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:l.hitch(this,function(t){var n=i.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:e,row:t});return i.isValueEmpty(n)?t[e.name]:n}),renderCell:l.hitch(this,function(t,i,n){var s=this._formatStringCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpTypeCell({row:t,cellNode:n,fieldInfo:e,container:l})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateSubtypeDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editOn:this.editOn,editor:"text",get:l.hitch(this,function(t){return i.getSubtypeDomainValue({layerInfo:this.layerInfo,fieldInfo:e,row:t})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:l.hitch(this,function(t,i,n){var s=this._formatStringCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpSubtypeDomainCell({row:t,cellNode:n,fieldInfo:e,container:l})})}},_generateNumberColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:l.hitch(this,function(t,i,n){var s=this._formatNumberCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpNumberCell({row:t,cellNode:n,fieldInfo:e,container:l})})}},_generateStringColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:l.hitch(this,function(t,i,n){var s=this._formatStringCellContent({fieldInfo:e,value:i}),l=f.create("div",{innerHTML:s},n);this._setUpStringCell({row:t,cellNode:n,fieldInfo:e,container:l})})}},_generateAttachmentsColumn:function(e){var t=this.layerInfo||{};return{label:e.alias,field:e.name,type:"esriAttachments",sortable:!1,get:l.hitch(this,function(e){var i,n=e[this.idProperty],s=this.attachmentInfos[n];return i=t.queryAttachmentsSupported?0:null,s&&s.attachments?s.attachments.length:i}),renderCell:l.hitch(this,function(t,i,n){this._generateAttachmentsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.attachmentsTitle})})}},_generateRelatedRecordsColumn:function(e){return{label:e.alias,field:e.name,type:"esriRelatedRecords",hidden:e.hidden,sortable:!1,get:l.hitch(this,function(t){return this._getRelatedRecordsCount({featureId:t[this.idProperty],relationshipId:e.relationship.id})}),renderCell:l.hitch(this,function(t,i,n){this._generateRelatedRecordsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.relatedRecordsTitle})})}},_generateExpressionColumn:function(e){return{label:e.alias,field:e.name,type:"esriExpressions",sortable:!1,get:l.hitch(this,function(t){return e.hasFeatureSetOperations?null:this._getExpressionValueForField(e.name,t)}),renderCell:l.hitch(this,function(t,i,n){this._generateExpressionCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:l.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.expressionsTitle})})}},_closeCellEditors:function(){var e=this._activeEditors;o.forEach(e,function(e){e.widget.onBlur()}),this.set("_activeEditors",[])},_getColumnHeaderCellContent:function(e){var t,i,n,s,l=e.fieldInfo,o=e.cssClass||null,r=this.css;if(s=f.create("div",{className:r.columnHeader}),n=o?r.columnHeaderTitle+" "+o:r.columnHeaderTitle,!l.editable&&this.editable&&this.layerInfo.editable&&f.create("span",{className:r.lockedIconContainer+" "+r.lockedIcon},s),i=p.encode(l.alias||l.name),f.create("div",{innerHTML:i,className:n},s),f.create("div",{className:r.columnHeaderClear},s),this.showColumnHeaderTooltips||this.showColumnHeaderTooltipsWithDescription){var a=i;this.showColumnHeaderTooltipsWithDescription&&this.layer.supportsFieldDescription&&l.description&&l.description.value&&(a+=" - "+p.encode(l.description.value)),this.own(new v({connectId:[s],label:"<div class="+r.columnHeaderTooltip+">"+a+"</div>"}))}return t="esriExpressions"===l.type||"esriRelatedRecords"===l.type||"esriAttachments"===l.type,this.showDataTypes&&!t&&(f.create("div",{innerHTML:l.type.replace("esriFieldType",""),className:r.columnHeaderType},s),f.create("div",{className:r.columnHeaderClear},s)),s},_setUpNumberCell:function(e){var t,n,s=e.row,o=e.cellNode,r=e.fieldInfo,a=e.container,c=this.idProperty,u=i.isIntegerFieldType(r.type)?0:"0,20";h(o,this.editOn,l.hitch(this,function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:s});if(this.editable&&r.editable&&!1!==e){var h=i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);(this.editOn!=_||h)&&(t&&t.destroy(),this._closeCellEditors(),a.innerHTML="",t=new S({value:s[r.name],required:!r.nullable,constraints:{places:u}}),t.placeAt(a),t.focus(),t.textbox.select(),this.emit("editor-show",{cell:o,editor:t,grid:this}),t.on("blur",l.hitch(this,function(){a.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:s[r.name]}),o.focus(),this.emit("editor-hide",{cell:o,editor:t,grid:this})})),t.on("keydown",function(e){e.keyCode===d.ENTER&&t.isValid()&&t.focusNode.blur()}),t.on("change",l.hitch(this,function(e){n={fieldName:r.name,oldValue:s[r.name],rowId:s[c],row:s},(""===e||isNaN(e))&&(e=null),t.isValid()?(s[r.name]=e,a.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:e}),this._applyEdits({row:s,rollbackInfo:n})):a.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:s[r.name]}),t.destroy()})),this._activeEditors.push({id:s[c],widget:t}))}}))},_setUpDateCell:function(e){var t,n,s=e.row,o=e.cellNode,r=e.fieldInfo,a=e.container,c=this.idProperty;h(o,this.editOn,l.hitch(this,function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:s});if(this.editable&&r.editable&&!1!==e){var h=i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=_||h){this._closeCellEditors(),a.innerHTML="",n=r.dateOptions&&r.dateOptions.datePattern?r.dateOptions.datePattern:this.dateOptions.datePattern,t=i.isValueEmpty(s[r.name])?null:new Date(s[r.name]);var u=new T({value:t,constraints:{datePattern:n}});u.placeAt(a),u.focus(),u.textbox.select(),this.emit("editor-show",{cell:o,editor:u,grid:this}),u.on("blur",l.hitch(this,function(){a.innerHTML=i.isValueEmpty(s[r.name])?null:i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:s[r.name],fieldInfo:r}),o.focus(),this.emit("editor-hide",{cell:o,editor:u,grid:this})})),u.on("keydown",function(e){e.keyCode===d.ENTER&&u.isValid()&&u.focusNode.blur()}),u.on("change",l.hitch(this,function(e){if(u.isValid()){var t={fieldName:r.name,oldValue:s[r.name],rowId:s[c],row:s};s[r.name]=i.isValueEmpty(e)?null:e.getTime(),a.innerHTML=i.isValueEmpty(s[r.name])?null:i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:s[r.name],fieldInfo:r}),this._applyEdits({row:s,rollbackInfo:t})}else a.innerHTML=i.isValueEmpty(s[r.name])?null:i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:s[r.name],fieldInfo:r})}))}}}))},_setUpDateTimeCell:function(e){var t,n,s,r=e.row,a=e.cellNode,d=e.fieldInfo,c=e.container,u=this.idProperty;h(a,this.editOn,l.hitch(this,function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:r});if(this.editable&&d.editable&&!1!==e){var h=i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=_||h){this._closeCellEditors(),c.innerHTML="",n=d.dateOptions&&d.dateOptions.datePattern?d.dateOptions.datePattern:this.dateOptions.datePattern,s=d.dateOptions&&d.dateOptions.timePattern?d.dateOptions.timePattern:this.dateOptions.timePattern,t=i.isValueEmpty(r[d.name])?null:new Date(r[d.name]);var f=new T({value:t,constraints:{datePattern:n}}),m=new N({value:t,constraints:{timePattern:s}});f.placeAt(c),m.placeAt(c),f.focus(),f.textbox.select(),this.emit("editor-show",{cell:a,editor:[f,m],grid:this}),f.on("change",l.hitch(this,function(e){if(f.isValid()){if(null===e||""===e)return void m.setValue(null);var t=m.getValue();null===t&&(t=new Date(0,0),m.setValue(t))}})),m.on("change",l.hitch(this,function(e){if(m.isValid()){if(null===e||""===e)return void f.setValue(null);var t=f.getValue();null===t&&(t=new Date(0,0),f.setValue(t))}}));var p=C.watch("activeStack",l.hitch(this,function(e,t,n){var s=-1!==o.indexOf(t,f.id)||-1!==o.indexOf(t,m.id),l=-1===o.indexOf(n,f.id)&&-1===o.indexOf(n,m.id);if(s&&l){p.remove(),this.emit("editor-hide",{cell:a,editor:[f,m],grid:this});var h,g=f.getValue(),y=m.getValue(),I=r[d.name];if(m.isValid()&&f.isValid()){if(g&&y?(h=i.getCombinedDateTime(g,y).getTime(),c.innerHTML=i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:new Date(h),fieldInfo:d})):(h=null,c.innerHTML=""),r[d.name]===h)return;r[d.name]=h,this._applyEdits({row:r,rollbackInfo:{fieldName:d.name,oldValue:I,rowId:r[u],row:r}})}else c.innerHTML=null===I?"":i.formatDateForLocale({dateOptions:this.dateOptions,timestamp:r[d.name],fieldInfo:d});f.destroy(),m.destroy()}}))}}}))},_setUpCodedValueDomainCell:function(e){var t=e.row,n=e.cellNode,s=e.fieldInfo;h(n,this.editOn,l.hitch(this,function(){var r=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:t});if(this.editable&&s.editable&&!1!==r&&(this.editOn!=_||i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds))){var a=s.name,h=s.domain.codedValues,c=e.container,u=t[this.idProperty],f=[];this._closeCellEditors(),c.innerHTML="",o.forEach(h,function(e){var i=String(e.name);f.push({label:p.encode(i),value:String(e.code),selected:t[a]===e.code})}),i.isValueEmpty(t[a])?f.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!s.nullable}):s.nullable&&f.push({label:this._i18nStrings.empty,value:this._nullConstant});var m=new E({options:f,class:this.css.select,style:{width:"100%"}});m.placeAt(c),m.focus(),this.emit("editor-show",{cell:n,editor:m,grid:this}),m.on("blur",l.hitch(this,function(){var e=i.getDomainValueFromRow({fieldInfo:s,row:t}),l=this._formatStringCellContent({fieldInfo:s,value:e});l=String(l),c.innerHTML=p.encode(l),this.emit("editor-hide",{cell:n,editor:m,grid:this}),this._activeEditors.pop()})),m.on("keydown",function(e){e.keyCode===d.ENTER&&m.focusNode.blur()}),m.on("change",l.hitch(this,function(e){var n={fieldName:a,oldValue:t[a],rowId:u,row:t};e===this._nullConstant?e=null:i.isNumericFieldType(s.type)&&(e=Number(e)),t[a]=e,m.onBlur(),this._applyEdits({row:t,rollbackInfo:n}),m.destroy(),m=null})),this._activeEditors.push({id:u,widget:m})}}))},_setUpRangeDomainCell:function(e){var t,n=e.row,s=e.cellNode,o=e.fieldInfo,r=e.container,a=o.domain.minValue,c=o.domain.maxValue,u=this.idProperty,f=i.isIntegerFieldType(o.type)?0:"0,20";h(s,this.editOn,l.hitch(this,function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&o.editable&&!1!==e){var h=i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=_||h){this._closeCellEditors(),r.innerHTML="";var m=new S({value:n[o.name],required:!o.nullable,constraints:{min:a,max:c,places:f}});m.placeAt(r),m.focus(),m.textbox.select(),this.emit("editor-show",{cell:s,editor:m,grid:this}),m.on("blur",l.hitch(this,function(){r.innerHTML=this._formatNumberCellContent({fieldInfo:o,value:n[o.name]}),this.emit("editor-hide",{cell:s,editor:m,grid:this}),this._activeEditors.pop()})),m.on("keydown",function(e){e.keyCode===d.ENTER&&m.isValid()&&m.focusNode.blur()}),m.on("change",l.hitch(this,function(e){t={fieldName:o.name,oldValue:n[o.name],rowId:n[u],row:n},m.isValid()&&(n[o.name]=e,this._applyEdits({row:n,rollbackInfo:t})),m.onBlur(),m.destroy(),m=null})),this._activeEditors.push({id:n[u],widget:m})}}}))},_setUpTypeCell:function(e){var t,n=e.row,s=e.cellNode,r=e.fieldInfo,a=e.container,c=this.idProperty,u=this.layerInfo,f=u.types;h(s,this.editOn,l.hitch(this,function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&r.editable&&!1!==e&&(this.editOn!=_||i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds))){this._closeCellEditors(),a.innerHTML="";var h=i.isValueEmpty(i.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:r,row:n})),m=r.name,p=n[m],g=[];o.forEach(f,function(e){g.push({label:e.name,value:String(e.id),selected:p===e.id})}),i.isValueEmpty(p)?g.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):h&&g.push({label:p,value:p,selected:!0,disabled:!0});var y=new E({options:g,class:this.css.select,style:{width:"100%"}});y.placeAt(a),y.focus(),this.emit("editor-show",{cell:s,editor:y,grid:this}),y.on("blur",l.hitch(this,function(){var e=i.getTypeValueFromRow({layerInfo:u,fieldInfo:r,row:n});a.innerHTML=this._formatStringCellContent({fieldInfo:r,value:e||p}),this.emit("editor-hide",{cell:s,editor:y,grid:this.grid}),this._activeEditors.pop()})),y.on("keydown",function(e){e.keyCode===d.ENTER&&y.focusNode.blur()}),y.on("change",l.hitch(this,function(e){t={fieldName:m,oldValue:p,rowId:n[c],row:n},e===this._nullConstant?e=null:i.isNumericFieldType(r.type)&&(e=Number(e)),n[m]=e,y.onBlur(),this._applyEdits({row:n,rollbackInfo:t}),y.destroy(),y=null})),this._activeEditors.push({id:n[c],widget:y})}}))},_setUpSubtypeDomainCell:function(e){var t=e.cellNode;h(t,this.editOn,l.hitch(this,function(){var n=this.layerInfo,s=e.fieldInfo,r=e.row,a=i.isFeatureEditable({layer:this.layer,layerInfo:n,attributes:r});if(this.editable&&s.editable&&!1!==a&&(this.editOn!=_||i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds))){this._closeCellEditors();var h,c=r[this.idProperty],u=s.name,f=n.types,m=i.findFirst(f,"id",r[n.typeIdField]),p=e.container,g={};if(p.innerHTML="",m&&m.domains&&(h=m.domains[u]),(h&&"inherited"===h.type||!h&&s.domain)&&(h=s.domain),h&&h.codedValues){var y=h.codedValues,I=i.findFirst(y,"code",r[u]),C=!1,w=[];if(o.forEach(y,function(e){w.push({label:e.name,value:String(e.code),selected:r[u]===e.code}),e.code===I&&(C=!0)}),i.isValueEmpty(r[u])&&s.nullable?w.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):i.isValueEmpty(r[u])&&!s.nullable?w.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):s.nullable&&w.push({label:this._i18nStrings.empty,value:this._nullConstant}),!C&&!I&&null!==r[u]){var b=r[u];w.push({label:b.toString(),value:"N/A",selected:!0,disabled:!0})}var v=new E({options:w,class:this.css.select,style:{width:"100%"}});v.placeAt(p),v.focus(),this.emit("editor-show",{cell:t,editor:v,grid:this}),v.on("blur",l.hitch(this,function(){var e=i.findFirst(y,"code",r[u]);p.innerHTML=e?this._formatStringCellContent({fieldInfo:s,value:e.name}):this._formatStringCellContent({fieldInfo:s,value:r[u]}),this.emit("editor-hide",{cell:t,editor:v,grid:this}),this._activeEditors.pop()})),v.on("keydown",function(e){e.keyCode===d.ENTER&&v.focusNode.blur()}),v.on("change",l.hitch(this,function(e){g={fieldName:u,oldValue:r[u],rowId:c,row:r},e===this._nullConstant?e=null:i.isNumericFieldType(s.type)&&(e=Number(e)),r[u]=e,v.onBlur(),this._applyEdits({row:r,rollbackInfo:g}),v.destroy(),v=null})),this._activeEditors.push({id:c,widget:v})}else{var F=new S({value:r[u],required:!s.nullable});h&&"range"===h.type&&(F.constraints={min:h.minValue,max:h.maxValue,places:i.isIntegerFieldType(s.type)?0:"0,20"}),F.placeAt(p),F.focus(),F.textbox.select(),this.emit("editor-show",{cell:t,editor:F,grid:this}),F.on("blur",l.hitch(this,function(){p.innerHTML=r[u],this.emit("editor-hide",{cell:t,editor:F,grid:this}),this._activeEditors.pop()})),F.on("keydown",function(e){e.keyCode===d.ENTER&&F.isValid()&&F.focusNode.blur()}),F.on("change",l.hitch(this,function(e){g={fieldName:u,oldValue:r[u],rowId:c,row:r},(""===e||isNaN(e))&&(e=null),F.isValid()&&(r[u]=e,this._applyEdits({row:r,rollbackInfo:g})),F.onBlur(),F.destroy(),F=null})),this._activeEditors.push({id:c,widget:F})}}}))},_setUpStringCell:function(e){var t=e.row,n=e.cellNode,s=e.fieldInfo,o=e.container,r=this.idProperty;h(n,this.editOn,l.hitch(this,function(){var e=i.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:t});if(this.editable&&s.editable&&!1!==e){var a=i.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=_||a){this._closeCellEditors(),o.innerHTML="";var h,c=s.stringOptions;h=c&&c.input&&"textarea"===c.input?new L({value:t[s.name],required:!s.nullable,maxLength:s.length?s.length:null,trim:!0}):new H({value:t[s.name],required:!s.nullable,maxLength:s.length?s.length:null}),h.placeAt(o),h.focus(),h.textbox.select(),this.emit("editor-show",{cell:n,editor:h,grid:this}),h.on("blur",l.hitch(this,function(){o.innerHTML=this._formatStringCellContent({fieldInfo:s,value:t[s.name]}),n.focus(),this.emit("editor-hide",{cell:n,editor:h,grid:this}),this._activeEditors.pop()})),h.on("keydown",function(e){e.keyCode===d.ENTER&&h instanceof H&&h.isValid()&&h.focusNode.blur()}),h.on("change",l.hitch(this,function(e){var n={fieldName:s.name,oldValue:t[s.name],rowId:t[r],row:t};""===e&&(e=null),
h instanceof H&&h.isValid()?(t[s.name]=e,this._applyEdits({row:t,rollbackInfo:n})):h instanceof L&&(!i.isValueEmpty(e)||i.isValueEmpty(e)&&s.nullable)&&(t[s.name]=e,this._applyEdits({row:t,rollbackInfo:n})),o.innerHTML=this._formatStringCellContent({fieldInfo:s,value:t[s.name]}),h.destroy(),h=null})),this._activeEditors.push({id:t[r],widget:h})}}}))},_formatStringCellContent:function(e){var t=e.value,n=e.fieldInfo?e.fieldInfo.format:null;return i.isValueEmpty(t)?"":n?n.embeddedHTML||!1===n.link?t:n.template?c.substitute(n.template,{value:t}):t:i.generateLinkFromString(t)},_formatNumberCellContent:function(e){var t=e.fieldInfo?e.fieldInfo.format:null,n=e.value;if(i.isValueEmpty(n))return"";var s=i.formatNumberForLocale(n,t);return t&&t.template&&(s=c.substitute(t.template,{value:s})),this.isLeftToRight()||(s='<span dir="ltr">'+s+"</span>"),s},_generateAttachmentsCell:function(e){if(this.layerInfo){var t,n,s,o=e.row,r=e.cellValue,a=e.cellNode,d=e.fieldInfo,u=this.layerInfo,m=this.css,p=this._i18nStrings;s=i.isValueEmpty(r)?"":c.substitute(p.parenValue,{value:r}),t=f.create("div",{innerHTML:s,className:m.attachmentsCell},a),n=r>0||!u.queryAttachmentsSupported?" "+p.show:this.editable&&u.editable?" "+p.add:"",f.create("span",{innerHTML:n,className:m.attachmentsLink},t),h(t,_,l.hitch(this,function(){this._showAttachmentsHandler({row:o,fieldInfo:d,cellValue:r,cellNode:a,textContainer:t})}))}},_generateRelatedRecordsCell:function(e){var t,n,s=e.row,o=e.cellValue,r=e.cellNode,a=e.fieldInfo,d=this.css,u=this._i18nStrings;n=i.isValueEmpty(o)?"":c.substitute(u.parenValue,{value:o})+" ",t=f.create("div",{innerHTML:n,className:d.relatedRecordsCell},r),f.create("span",{innerHTML:o>0?u.show:"",className:d.relatedRecordsLink},t),h(r,_,l.hitch(this,function(e){if(o>0){var t=this.dGrid.cell(e).column;this._showRelatedRecordsHandler({row:s,fieldInfo:a,column:t,count:o})}}))},_generateExpressionCell:function(e){var t=e.row,i=e.cellValue,n=e.cellNode,s=e.fieldInfo,o=f.create("div",{className:this.css.expressionsCell},n);if(s.hasFeatureSetOperations)var r=f.create("span",{innerHTML:this._i18nStrings.show,className:this.css.expressionsLink},o),a=h(o,_,l.hitch(this,function(){var e=f.create("div",{className:this.css.cellLoadingIndicator});f.place(e,r,"replace");var i=this._getExpressionValueForField(s.name,t);i&&i.then?i.then(l.hitch(this,function(e){o.innerHTML=this._formatExpressionCellContent(s,e)})).otherwise(l.hitch(this,function(e){o.innerHTML=this._i18nStrings.dataError})):o.innerHTML="",a.remove()}));else o.innerHTML=this._formatExpressionCellContent(s,i)},updateHeaderText:function(e){var t=e?e.count:null,n=e?e.selectedCount:null,s=e?e.title:null,l=!e||e.showFilterCount;s=i.isValueEmpty(s)?this._tableTitle||this.layer.name||this._i18nStrings.untitled:s,t=i.isValueEmpty(t)?this.featureCount:t,n=i.isValueEmpty(n)?this.selectedFeatureCount:n,this.filterIds&&this.filterIds.length>0&&l&&(t=this.filterIds.length),this.showFeatureCount?this.setHeaderTitle(c.substitute(this._i18nStrings.gridHeader,{gridTitle:s,featureCount:t,featureSelectedCount:n})):this.setHeaderTitle(s)},_generateOptionsMenu:function(){var e=this.css,t=this._i18nStrings,i=e.menuItem+" "+e.button+" "+e.menuIcon,n=f.create("div",{className:i,title:t.options,"aria-label":t.options,tabIndex:0},this._gridMenuNode);h(n,[_,"keydown"],l.hitch(this,function(e){"Tab"!==e.key&&this._showOptionsMenu(e)})),this.optionsMenuAnchor=n},_showOptionsMenu:function(e){var t,i,n,s,r,a=this.optionsMenuAnchor,d=this.css;this.optionsMenu&&(this.optionsMenu.destroy(),this.optionsMenu=null),n=a.getBoundingClientRect(),s=n.top+n.height,r=this.isLeftToRight()?n.left+n.width:n.right-n.width,t=new w({className:d.optionsMenu}),i=this._generateOptionsMenuItems(),o.forEach(i,function(e){var i=new b({label:e.label,baseClass:d.menuItem,onClick:l.hitch(this,e.callback)});t.addChild(i)},this),t._openMyself({target:e.target,delegatedTarget:a,iframe:null,coords:{x:r,y:s}}),this.optionsMenu=t},_generateOptionsMenuItems:function(){var e=[];return this.showDefaultSortMenuItem&&e.push({label:this._i18nStrings.defaultSort,callback:this._sortFieldDefaultCallback}),this.showFilterMenuItems?e.push({label:this._i18nStrings.showSelected,callback:this._showSelectedRecordsCallback},{label:this._i18nStrings.clearSelection,callback:this._clearFilterCallback}):e.push({label:this._i18nStrings.clearSelection,callback:this.clearSelection}),this.gridOptions.columnHider&&e.push({label:this._i18nStrings.toggleColumns,callback:this.showColumnToggleMenu}),this.map&&this.syncSelection&&e.push({label:this._i18nStrings.centerOnSelection,callback:this.centerOnSelection}),this.menuFunctions&&this.menuFunctions.length>0&&o.forEach(this.menuFunctions,function(t){e.push({label:t.label,callback:t.callback})},this),e},_sortFieldDefaultCallback:function(){var e=this.defaultSort.attribute,t=this.defaultSort.descending;this.set("sort",{field:e,descending:t}),this.emit("sort",{field:e,descending:t,orderByFields:[i.getOrderByString(e,t)]})},_showSelectedRecordsCallback:function(){0!==this.selectedRowIds.length&&this.emit("show-selected-records",{ids:this.selectedRowIds})},_clearFilterCallback:function(){this.emit("clear-selection"),this.emit("clear-filter")},showColumnToggleMenu:function(){this.dGrid._toggleColumnHiderMenu()},_generateColumnMenu:function(e){var t=this.dGrid.cell(e),n=t?t.column:null;if(n){var s,r=this.dGrid,a=r.columns,d=this.fieldInfos,h=this.columnMenu,c=this.css,u=this.columnMenuFunctions,f=h,m=n.id,p=a[m],g=i.findFirst(d,"name",p.field);h&&this.set("columnMenu",null),!1!==p.sortable&&(s=new w({className:c.columnMenu}),this._generateSortMenuItems({menu:s,columnId:m}),this._generateStatisticsMenuItem({menu:s,fieldInfo:g,columnId:m}),this._generateFieldDetailsMenuItem({menu:s,fieldInfo:g,column:p}),u&&u.length>0&&o.forEach(u,function(e){s.addChild(new b({label:e.label,iconClass:e.iconClass||"",baseClass:e.baseClass||"",onClick:l.hitch(this,e.callback,g)}))}),s.startup(),this._showColumnMenu({menu:s,cell:t,evt:e,fieldInfo:g,previousMenu:f}),this.set("columnMenu",s))}},_showColumnMenu:function(e){var t,i,n,s=e.menu,l=e.cell,o=e.evt,r=e.previousMenu;t=l.element.getBoundingClientRect(),n=t.top+t.height,i=this.isLeftToRight()?t.right-t.width:t.right,s._openMyself({target:o.target,delegatedTarget:l,iframe:null,coords:{x:i,y:n}}),h(s,"close",function(){r&&(r.destroyRecursive(),r=null)})},_generateSortMenuItems:function(e){var t=e.menu,i=e.columnId,n=this.css;t.addChild(new b({label:this._i18nStrings.sortAsc,iconClass:n.sortAscendingIcon,baseClass:n.menuItem,onClick:l.hitch(this,this._sortFieldAscendingHandler,i)})),t.addChild(new b({label:this._i18nStrings.sortDesc,iconClass:n.sortDescendingIcon,baseClass:n.menuItem,onClick:l.hitch(this,this._sortFieldDescendingHandler,i)}))},_sortFieldAscendingHandler:function(e){var t=this.dGrid.columns[e];this.emit("sort",{column:t,id:e,field:t.field,descending:!1,orderByFields:[i.getOrderByString(t.field,!1)]})},_sortFieldDescendingHandler:function(e){var t=this.dGrid.columns[e];this.emit("sort",{column:t,id:e,field:t.field,descending:!0,orderByFields:[i.getOrderByString(t.field,!0)]})},_generateStatisticsMenuItem:function(e){var t=e.menu,n=e.fieldInfo,s=this.css,o=this.layer,r=this.layerInfo,a=!!r.isFeatureCollection,d=o.advancedQueryCapabilities.supportsStatistics||o.supportsStatistics;!this.showStatistics||!d||!n||n.domain&&n.domain.codedValues||n.subtypeDomain||n.typeId||a||i.isNumericFieldType(n.type)&&t.addChild(new b({label:this._i18nStrings.statistics,iconClass:s.statisticsIcon,baseClass:s.menuItem,onClick:l.hitch(this,this._showStatisticsHandler,e)}))},_generateFieldDetailsMenuItem:function(e){if(this.showFieldDetails){var t=e.menu,i=e.fieldInfo,n=e.column,s=parseInt(n.id,10),r=this.css;"esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&-1===o.indexOf(this._unsupportedFieldTypes,i.type)&&t.addChild(new b({label:this._i18nStrings.showDetailedView,iconClass:r.propertiesIcon,baseClass:r.menuItem,onClick:l.hitch(this,function(){this.emit("show-detailed-field-view",{columnId:s,fieldInfo:i})})}))}},_fetchAttachments:function(e){return i.queryLayerForAttachments({layer:this.layer,ids:e||null})},_showAttachmentsHandler:function(e){var t,i,s,o,r=e.row,a=e.fieldInfo,d=e.cellValue,h=e.cellNode,c=this.layerInfo,u=this.idProperty,f=r[u];(0!==d||c.editCapabilities.canCreate)&&(t=this.attachmentInfos[f]?this.attachmentInfos[f].attachments:[],i=n.generateAttachmentsDialog({layer:this.layer,featureId:f,attachments:t,editable:this.editable&&c.editable,css:this.css}),o=i.featureAttachments,s=o.attachments,this.own(o.on("add-complete",l.hitch(this,function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={attachments:[]}),this.attachmentInfos[f].attachments=e.attachments,c.queryAttachmentsSupported&&(d+=1),h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h}),this.emit("add-attachment-complete",e)})),o.on("delete-complete",l.hitch(this,function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={attachments:[]}),this.attachmentInfos[f].attachments=e.attachments,c.queryAttachmentsSupported&&(d-=1),h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h}),this.emit("delete-attachment-complete",e)}))),this.emit("show-attachments",{featureId:f,attachments:s,dialog:i.dialog}))},_updateAttachmentInfos:function(e){return l.mixin(this.attachmentInfos,e)},_fetchRelatedRecords:function(e){var t=e.ids||null,n=e.relationship,s=e.outFields||["*"];return i.queryLayerForRelatedRecords({layer:this.layer,ids:t,relationship:n,outFields:s})},_showRelatedRecordsHandler:function(e){var t,n,s,l=e.row,r=this.idProperty,a=l[r],d=e.fieldInfo,h=d.relationship,c=e.count,u=this.columns,f=this.layer,m=f.getField(h.keyField),p=m?m.name:null,g=p?l[p]:null;n=o.filter(u,function(e){return!e.hidden}),t=[i.findFirst(n,"field",f.displayField),i.findFirst(n,"field",p),i.findFirst(n,"type","esriFieldTypeString"),i.findFirstNumberColumn(u,r),i.findFirst(n,"type","esriFieldTypeDate")],o.some(t,function(e){if(this._validateRelatedColumnDisplay(e))return s=o.indexOf(u,e),!0},this),i.isValueEmpty(s)&&(s=0),this.emit("show-related-records",{row:l,featureId:a,keyField:p,keyFieldValue:g,columnId:s,relationship:h,count:c})},_setUpRelatedRecordInfos:function(e){var t=e.relationships,i=e.records,n=this.relatedRecordInfos;return o.forEach(t,function(e,t){n[e.id]=i[t]}),n},_updateRelatedRecordInfos:function(e){var t=this.relatedRecordInfos;this.relatedRecordInfos=i.mergeDictionaries(t,e)},_updateRelatedRecordCounts:function(e){var t=this.relatedRecordCounts,n={};o.forEach(this.layer.relationships,function(t){var i=e[t.id];if(i){var s=i.relatedRecordGroups,l=t.id;n[l]={},o.forEach(s,function(e){n[l][e.objectId]={count:e.count}})}}),this.relatedRecordCounts=i.mergeDictionaries(t,n)},_getRelatedRecordsById:function(e){var t=e.featureId,i=e.relationshipId;return this.relatedRecordInfos[i]?this.relatedRecordInfos[i][t]:[]},_getRelatedRecordsCount:function(e){var t,i=e.featureId,n=e.relationshipId;return this.layerInfo.supportsAdvancedQueryRelated?(t=this.relatedRecordCounts[n]?this.relatedRecordCounts[n][i]:{},t?t.count:0):(t=this._getRelatedRecordsById({featureId:i,relationshipId:n}),t&&t.features?t.features.length:0)},_generateRelatedRecordFieldInfos:function(e){var t,n,s=[],l=e.relationships,r=this.visibleLayerIds,a=!1;return o.some(l,function(e,l){l===this._relationshipColumnLimit&&(a=!0),n=i.isCyclicalRelationship(e),(t=!!r&&r[r.length-1]===e.relatedTableId)&&n&&!this.showCyclicalRelationships||s.push({alias:e.name,name:e.name,type:"esriRelatedRecords",hidden:a,relatedIndex:l,relationship:e})},this),s},_validateRelatedColumnDisplay:function(e){return!(!e||e.hidden||-1===o.indexOf(this.columns,e)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type)},_getExpressionValueForField:function(e,t){var n=t[this.idProperty],s=this.expressionCache[e],l=this.layerInfo.isFeatureCollection?i.findFirst(this.layer.graphics,"attributes",t):this.store.data[n];return i.getExpressionValue(l,s)},_formatExpressionCellContent:function(e,t){return i.isValueEmpty(t)?"":("number"==e.type?t=this._formatNumberCellContent({fieldInfo:e,value:t}):(t=String(t),t=p.encode(t),t=this._formatStringCellContent({fieldInfo:e,value:t}),t=t.replace(/(\n)/gi,"<span class='charNewLine'>$1</span>")),t)},_showStatisticsHandler:function(e){var t,s,o=e.columnId,r=e.fieldInfo;t=this.where||this.layer.getDefinitionExpression?this.layer.getDefinitionExpression():"1=1",i.getFieldStatistics({grid:this.dGrid,layer:this.layer,fieldInfo:r,idProperty:this.idProperty,filterIds:this.filterIds,where:t,columnId:o}).then(l.hitch(this,function(e){s=n.generateStatisticsDialog({data:e,fieldInfo:r,css:this.css}),this.emit("show-statistics",s)}))},_addGridListeners:function(){this._setUpRowSelectListener(),this._setUpRowDeselectListener(),this._setUpDataChangeListener(),this._setUpRefreshListener(),this._setUpColumnClickListener(),this._setUpColumnStateChangeListener(),this._setUpColumnResizeListener(),this._setUpErrorListener(),this._setUpSortListener(),this._setUpFilterListener(),this._setUpEditorShowListener(),this._setUpEditorHideListener(),this.own(this._setUpStoreLoadListener(),this._setUpLayerClickListener(),this._setUpLayerSelectionCompleteListener(),this._setUpLayerSelectionClearListener(),this._setUpLayerUpdateEndListener(),this._setUpLayerRefreshTickListener())},_setUpStoreLoadListener:function(){var e=this.watch("store",l.hitch(this,function(t,i,n){null===i&&n&&(this.set("loaded",!0),this.emit("load",{loaded:!0}),e.remove())}));return e},_setUpRowSelectListener:function(){return this.dGrid.on("dgrid-select",l.hitch(this,function(e){this._updateSelection().then(l.hitch(this,function(){this.updateHeaderText(),this.emit("row-select",e)}))}))},_setUpRowDeselectListener:function(){return this.dGrid.on("dgrid-deselect",l.hitch(this,function(e){this._previousSelectedRowIds=this.selectedRowIds,this._updateSelection().then(l.hitch(this,function(){this.updateHeaderText(),this.emit("row-deselect",e)}))}))},_setUpDataChangeListener:function(){return this.dGrid.on("dgrid-datachange",l.hitch(this,function(e){var t=this.fieldInfos,n=e.cell.column.field,s=i.findFirst(t,"name",n),o=e.cell.row.data,r=o[this.idProperty],a=e.value,d=e.oldValue,h=i.isIntegerFieldType(s.type),c=i.isFloatFieldType(s.type),u={oldValue:d,fieldName:n,rowId:r,row:o};""===a&&(a=null),h&&null!==a&&(a=parseInt(a,10)),c&&null!==a&&(a=parseFloat(a)),a&&a.getTime&&a.getTime()?o[n]=a.getTime():o[n]=a,this.showLoadingIndicator(),this._updateSelection().then(l.hitch(this,function(){this.updateHeaderText(),this._applyEdits({row:o,rollbackInfo:u})})),this.emit("data-change",{row:o,rollbackInfo:u})}))},_setUpRefreshListener:function(){return this.dGrid.on("dgrid-refresh-complete",l.hitch(this,function(e){this.dGrid.columns[0]&&this.emit("refresh",e)}))},_setUpColumnClickListener:function(){return this.dGrid.on(".dgrid-header .dgrid-cell:click",l.hitch(this,this._generateColumnMenu))},_setUpColumnStateChangeListener:function(){return this.dGrid.on("dgrid-columnstatechange",l.hitch(this,function(e){this.emit("column-state-change",e)}))},_setUpColumnResizeListener:function(){return this.dGrid.on("dgrid-columnresize",l.hitch(this,function(e){this.emit("column-resize",e)}))},_setUpErrorListener:function(){return this.dGrid.on("dgrid-error",l.hitch(this,function(e){this.emit("error",e)}))},_setUpSortListener:function(){return this.dGrid.on("dgrid-sort",l.hitch(this,function(e){this.emit("sort",e)}))},_setUpFilterListener:function(){return this.dGrid.on("dgrid-filter",l.hitch(this,function(e){this.emit("filter",e)}))},_setUpEditorShowListener:function(){return this.dGrid.on("dgrid-editor-show",l.hitch(this,function(e){this.emit("editor-show",e)}))},_setUpEditorHideListener:function(){return this.dGrid.on("dgrid-editor-hide",l.hitch(this,function(e){this.emit("editor-hide",e)}))},_setUpLayerClickListener:function(){return h(this.layer,"click",l.hitch(this,function(e){this.emit("layer-click",e)}))},_setUpLayerSelectionCompleteListener:function(){return h(this.layer,"selection-complete",l.hitch(this,function(e){this.emit("layer-selection-complete",e)}))},_setUpLayerSelectionClearListener:function(){return h(this.layer,"selection-clear",l.hitch(this,function(e){this.emit("layer-selection-clear",e)}))},_setUpLayerUpdateEndListener:function(){return h(this.layer,"update-end",l.hitch(this,function(e){this.emit("layer-update-end",e)}))},_setUpLayerRefreshTickListener:function(){return h(this.layer,"refresh-tick",l.hitch(this,function(e){this.emit("layer-refresh-tick",e)}))}});return a("extend-esri")&&l.setObject("dijit.Grid",q,e),q});