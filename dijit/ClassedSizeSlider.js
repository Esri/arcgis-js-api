define(["../kernel","../renderers/utils","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/Tooltip","dojo/number","dojo/string","../dijit/RendererSlider","../Color","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/i18n!../nls/jsapi","dojo/dom-geometry","dojo/dom-style","dojo/Evented","dojo/has","dojox/gfx","dojo/text!./ClassedSizeSlider/templates/ClassedSizeSlider.html"],function(t,i,s,e,a,h,o,r,n,l,u,d,m,c,f,_,g,p,b,k){var v=d("esri.dijit.ClassedSizeSlider",[a,e,s,g],{baseClass:"esriClassedSizeSlider",templateString:k,domNode:null,containerNode:null,breakInfos:null,histogram:null,showHistogram:!0,showStatistics:!0,handles:null,_histogramWidthDefault:100,_rampWidthDefault:25,showLabels:null,showTicks:null,showHandles:null,_rampNode:null,_sliderHeight:null,_colorRampSurface:null,_histogramSurface:null,_rect:null,_barsGroup:null,_updateTimer:null,classificationMethod:null,normalizationType:null,constructor:function(t,i){this.inherited(arguments),i&&(this.domNode=i,this.containerNode=this._containerNode,this.histogram=t.histogram||!1,this.statistics=t.statistics||!1,this.histogramWidth=t.histogramWidth||this._histogramWidthDefault,this.rampWidth=t.rampWidth||this._rampWidthDefault,this.handles=t.handles||[],this.showLabels=t.showLabels||!0,this.showTicks=t.showTicks||!0,this.showHandles=t.showHandles||!0,this.symbol=t.symbol,this.breakInfos=m.clone(t.breakInfos),this.values=this._getHandleInfo(this.breakInfos),this.classificationMethod=t.classificationMethod||null,this.normalizationType=t.normalizationType||null)},postCreate:function(){this.inherited(arguments),null!==this.breakInfos&&this.breakInfos.length>1?(this.minValue=this.breakInfos[0].minValue,this.maxValue=this.breakInfos[this.breakInfos.length-1].maxValue):null!==this.breakInfos&&1===this.breakInfos.length?(this.minValue=this.breakInfos[0].minValue,this.maxValue=this.breakInfos[0].maxValue):(this.minValue=0,this.maxValue=100,this.breakInfos=[{minValue:0,maxValue:20},{minValue:20,maxValue:80},{minValue:80,maxValue:100}],this.values=this._getHandleInfo(this.breakInfos),this._updateBreakInfoLabels())},startup:function(){this.inherited(arguments),this._slider=new n({type:"ClassedSizeSlider",values:this.values,minimum:this.minValue,maximum:this.maxValue,showLabels:this.showLabels,showTicks:this.showTicks,showHandles:this.showHandles,classificationMethod:this.classificationMethod,normalizationType:this.normalizationType},this._sliderNode),this._slider.startup(),this._rampNode=this._slider._sliderAreaRight,this._sliderHeight=_.get(this._rampNode,"height")||155,this._createSVGSurfaces(),this._slider.on("slide",m.hitch(this,function(t){this._updateBreakInfos(t.values),this._updateBreakInfoLabels(),this._fillRamp()})),this._slider.on("change",m.hitch(this,function(t){this.values=t.values,this._updateBreakInfos(t.values),this._updateBreakInfoLabels(),this.emit("change",m.clone(this.breakInfos))})),this._slider.on("handle-value-change",m.hitch(this,function(t){this._updateBreakInfos(t.values),this._updateBreakInfoLabels(),this._fillRamp(),this.emit("handle-value-change",m.clone(this.breakInfos))})),this._slider.on("data-value-change",m.hitch(this,function(t){this.breakInfos[0].minValue=this.minValue=t.min,this.breakInfos[this.breakInfos.length-1].maxValue=this.maxValue=t.max,this._updateBreakInfoLabels(),this._updateRendererSlider(),this.emit("data-value-change",{minValue:this.minValue,maxValue:this.maxValue,breakInfos:m.clone(this.breakInfos)})})),this._slider.on("stop",m.hitch(this,function(){this.emit("handle-value-change",m.clone(this.breakInfos))})),this.showHistogram&&this.histogram&&this._generateHistogram(),this.statistics&&this.showStatistics&&this._generateStatistics(),this.watch("breakInfos",this._updateTimeout),this.watch("handles",this._updateTimeout),this.watch("statistics",this._updateTimeout),this.watch("histogram",this._showHistogram),this.watch("showHandles",this._updateTimeout),this.watch("showLabels",this._updateTimeout),this.watch("showTicks",this._updateTimeout),this.watch("showHistogram",this._toggleHistogram)},_createSVGSurfaces:function(){this._colorRampSurface=b.createSurface(this._rampNode,this.rampWidth,this._sliderHeight),this._histogramSurface=b.createSurface(this._rampNode,this.histogramWidth,this._sliderHeight),_.set(this._histogramSurface.rawNode,{overflow:"visible",display:"inline-block",left:this.rampWidth+"px"}),this._rect=this._colorRampSurface.createRect(this._colorRampSurface.getDimensions()),this._fillRamp()},_clearRect:function(){this._colorRampSurface.destroy(),this._histogramSurface.destroy()},_updateTimeout:function(){var t=this;clearTimeout(this._updateTimer),this._updateTimer=setTimeout(function(){var i=t;t=null,clearTimeout(i._updateTimer),i._updateRendererSlider()},0)},_updateRendererSlider:function(){this.minValue=this.breakInfos[0].minValue,this.maxValue=this.breakInfos[this.breakInfos.length-1].maxValue,this._slider.set("values",this._getHandleInfo(this.breakInfos)),this._slider.set("handles",this.handles),this._slider._reset(),this._slider._updateRoundedLabels(),this._slider._generateMoveables(),this._clearRect(),this._createSVGSurfaces(),this.showHistogram&&this.histogram&&this._generateHistogram(),this.statistics&&this.showStatistics&&this._generateStatistics()},_generateStatistics:function(){var t=this.statistics;if(!(t.count<2)){var i,s,e=this._slider;t.min===t.max&&t.min===t.avg?(i=0,s=2*t.avg):(i=t.min,s=t.max),(i!==e.minimum||s!==e.maximum)&&(i=e.minimum,s=e.maximum);var a=[{value:t.avg,label:"average"}];a=u.filter(a,function(t){return t.value>=i&&t.value<=s}),u.forEach(a,m.hitch(this,function(e){var a=this._sliderHeight*(s-e.value)/(s-i);this._avgHandleLine=this._histogramSurface.createLine({x1:0,y1:a,x2:this.histogramWidth,y2:a}).setStroke("#c0c0c0").moveToBack(),this._avgHandleImage=this._histogramSurface.createImage({x:f.isBodyLtr()?this.histogramWidth+2:0,y:a-8,width:12,height:14,src:require.toUrl("esri/dijit/ClassedSizeSlider/images/xAvg.png")});var n=r.substitute(c.widgets.rendererSlider.statsAvg,{avg:o.format(t.avg,{places:this._getPrecision()})});this._avgHandleTooltip=new h({connectId:[this._avgHandleImage.rawNode],label:n})}))}},_getPrecision:function(){return Math.floor(Math.log(this.maxValue)/Math.log(10))<2?2-Math.floor(Math.log(this.maxValue)/Math.log(10)):0},_generateHistogram:function(){var t;this._barsGroup=this._histogramSurface.createGroup();var i=u.map(this.histogram.bins,function(t){return"object"==typeof t?t.count:t});i.reverse();var s=this._sliderHeight/i.length;u.forEach(i,m.hitch(this,function(e,a){t=e>0?this.histogramWidth*(e/Math.max.apply(Math,i)):0,this._barsGroup.createRect({width:t,height:s}).setStroke("#c0c0c0").setFill("#aaa").setTransform(b.matrix.translate(0,s*a))})),_.set(this._histogramSurface.rawNode,{display:"inline-block",left:this.rampWidth+"px"}),f.isBodyLtr()||this._barsGroup.setTransform({dx:this.histogramWidth,dy:0,xx:-1,xy:0,yx:0,yy:1})},_showHistogram:function(){this.histogram?this._generateHistogram():this._barsGroup&&(this._barsGroup.destroy(),this._barsGroup=null)},_toggleHistogram:function(){this.showHistogram?(_.set(this._barsGroup.rawNode,"display","inline-block"),this._showHistogram()):_.set(this._barsGroup.rawNode,"display","none")},_getHandleInfo:function(t){var i,s=[];for(i=0;i<t.length-1;i++)s.push(t[i].maxValue);return s},_updateBreakInfos:function(t){var s,e=this.breakInfos;for(i.updateClassBreak({classBreaks:e,normalizationType:this.normalizationType,classificationMethod:this.classificationMethod,change:t}),s=0;s<t.length;s++)e[s].maxValue=t[s],e[s+1]&&(e[s+1].minValue=t[s])},_updateBreakInfoLabels:function(){var t=this.breakInfos,s=this.classificationMethod,e=this.normalizationType;i.setLabelsForClassBreaks({classBreaks:t,normalizationType:e,classificationMethod:s,round:!0})},_fillRamp:function(){var t=this.breakInfos,i=this._slider,s=this._sliderHeight,e=[];u.forEach(t,function(t){e.push([s-Math.round((t.minValue-i.minimum)/(i.maximum-i.minimum)*s),s-Math.round((t.maxValue-i.minimum)/(i.maximum-i.minimum)*s)])}),e.reverse(),this._colorRampSurface.clear();var a=this.rampWidth/t.length,h=this.rampWidth,o=this._colorRampSurface.createPath().moveTo(h,0);u.forEach(e,m.hitch(this,function(t,i){o.lineTo(h,t[0]),h=this.rampWidth-a*(i+1),o.lineTo(h,t[0])})),o.lineTo(1,s).lineTo(0,s).lineTo(0,0).closePath().setFill(new l([0,121,193,.8]))},destroy:function(){this.inherited(arguments),this._slider.destroy(),this._avgHandleTooltip&&this._avgHandleTooltip.destroy()}});return p("extend-esri")&&m.setObject("dijit.ClassedSizeSlider",v,t),v});