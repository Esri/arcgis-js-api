// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/i18n!../nls/jsapi","dojo/text!./templates/VectorFieldRenderer.html","dojo/store/Memory","dojo/data/ObjectStore","dojo/has","dojo/query","dojo/dom-style","dojo/dom-construct","../kernel","../renderers/VectorFieldRenderer","../Color","../lang","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","dojox/form/HorizontalRangeSlider","dojox/gfx","require","dijit/form/FilteringSelect","dijit/form/RadioButton","dijit/form/Select","./ColorPicker","dijit/form/DropDownButton","dijit/TitlePane","dijit/form/NumberTextBox","dijit/form/Button"],(function(e,t,i,r,s,l,n,a,o,d,u,h,c,p,y,S,_,m,T,v,b,f,g,R){var F=e([_,m,T],{templateString:l,declaredClass:"esri.dijit.VectorFieldRenderer",widgetsInTemplate:!0,layer:null,map:null,_rendererTypes:["simpleScalar","singleArrow","windBarbs","beaufort","oceanCurrentKnots","oceanCurrentMps","classifiedArrow"],_rendererTypeData:[],_vfrObject:null,_defaultVFRName:"classifiedArrow",propertiesChanged:!0,resetAvailable:!0,constructor:function(t){e.safeMixin(this,t),this._i18n=s,this._setupDefaults()},startup:function(e){this.inherited(arguments);var r=this;this._arrowSymbolButtonNode=d(".dijitButtonNode",d(".esriVFRColorButton")[0])[0],this.symbolColorPicker.onColorChange=function(e){r._updateArrowSymbolButton(),r.propertiesChanged=!0},i.subscribe("onVectorFieldRendererApply",t.hitch(this,"_onClickApplyVectorFieldRenderer")),i.subscribe("onVectorFieldRendererReset",t.hitch(this,"_onClickResetVectorFieldRenderer")),this.startupCalled=!0},postCreate:function(e){this.inherited(arguments);var t=this;this.advancedSettingsPane.set("title",this._i18n.widgets.vectorFieldRenderer.advancedOptionsTitle),this.minMagnitudeInput.set("invalidMessage",this._i18n.widgets.vectorFieldRenderer.invalidNumberMessage),this.maxMagnitudeInput.set("invalidMessage",this._i18n.widgets.vectorFieldRenderer.invalidNumberMessage),u.set(this.symbolColorPicker.dap_transparencySection,"display","none"),this._popuplateRendererList(),this._createTileSizeSlider(),this._createSymbolSizeSlider(),this.hideApplyButton&&u.set(this.applyButton.domNode,"display","none"),this.layer.loaded?this._loadVFRArguments():this.layer.on("load",(function(){t._loadVFRArguments()}))},_setLayerAttr:function(e){if(e&&this.startupCalled){var t=this;this.layer=e,this.inherited(arguments),this.advancedSettingsPane.set("open",!1),this.layer.loaded?this._loadVFRArguments():this.layer.on("load",(function(){t._loadVFRArguments()}))}},_addRendererTypeToList:function(e,t,i,r){var s={};s.label="<html><body><section><table><tr><td colspan='2'><b>"+e+"<b></td></tr><tr><td><img src='"+r+"' height='90' width='90'></td><td><p style='white-space:pre-wrap;width:35ex;'><i>"+t+"</i></p><td></tr></table></section></body></html>",s.name=e,s.desc=t,s.id=i,this._rendererTypeData.push(s)},_popuplateRendererList:function(){var e=this;r.forEach(this._rendererTypes,(function(t){var i=e._i18n.widgets.vectorFieldRenderer[t+"LabelTitle"],r=e._i18n.widgets.vectorFieldRenderer[t+"Desc"],s=R.toUrl("./images/vfr_"+t+".png");e._addRendererTypeToList(i,r,t,s)})),this._rendererTypeStore=new n({data:this._rendererTypeData}),this.rendererTypeSelect.set("store",this._rendererTypeStore),this.rendererTypeSelect.set("labelAttr","label"),this.rendererTypeSelect.set("labelType","html")},_createTileSizeSlider:function(){var e,t=this,i=[],r=h.create("div");for(this.symbolDensitySliderDiv.appendChild(r),e=0;e<80;e++)0===e?i.push(this._i18n.widgets.vectorFieldRenderer.sparseTileSizeAlias):79===e?i.push(this._i18n.widgets.vectorFieldRenderer.denseTileSizeAlias):i.push("");new b({labels:i,labelStyle:"font-size: 75%"},r);this._symbolDensitySlider=new v({value:.02,minimum:.01,maximum:.05,intermediateChanges:!1,discreteValues:81,style:"width: 100%",onChange:function(e){t._setPropertiesChanged()}},this.symbolDensitySliderDiv)},_createSymbolSizeSlider:function(){var e,t=this,i=[],r=h.create("div");for(this.symbolSizeSliderDiv.appendChild(r),e=0;e<100;e++)0===e?i.push(this._i18n.widgets.vectorFieldRenderer.minSymbolSizeAlias):99===e?i.push(this._i18n.widgets.vectorFieldRenderer.maxSymbolSizeAlias):i.push("");new b({labels:i,labelStyle:"font-size: 75%"},r);this._symbolSizeSlider=new f({value:[20,80],minimum:0,maximum:100,discreteValues:101,intermediateChanges:!1,style:"width: 100%",onChange:function(e){t._setPropertiesChanged()}},this.symbolSizeSliderDiv)},_selectRendererStyle:function(e){"singleArrow"===e?this._showColorPickerButton():this._hideColorPickerButton(),this._refreshOutputUnitSelect(),this.layer.getFlowRepresentation()||("beaufort"===e||"windBarbs"===e?this.flowAngleSelect.set("value","FLOW_FROM"):"oceanCurrent"===e&&this.flowAngleSelect.set("value","FLOW_TO")),this.propertiesChanged=!0},_showColorPickerButton:function(){var e=this.singleArrowDefaultColor;this.layer.renderer&&this.layer.renderer.renderer&&this.layer.renderer.renderer.defaultSymbol&&this.layer.rendererStyle==p.STYLE_SINGLE_ARROW&&this.layer.renderer.renderer.defaultSymbol.color,this.symbolColorPicker.set("color",e),u.set(this.colorPickerButton.domNode,"display","block")},_hideColorPickerButton:function(){u.set(this.colorPickerButton.domNode,"display","none")},_setupDefaults:function(){this.singleArrowDefaultColor=new y([0,92,230])},_loadVFRArguments:function(){if(!this.layer||!this.layer.renderer)return console.log("Layer not present");this._loadVFRStyle(),this._loadSymbolSizeValues(),this._loadTileSizeValue(),this._loadMinMaxValues(),this._loadAngleDirection(),this._loadColor(),this._loadUnits()},_loadVFRStyle:function(){switch(this.layer.renderer.style){case p.STYLE_SCALAR:this.rendererTypeSelect.set("value",this._rendererTypes[0]);break;case p.STYLE_SINGLE_ARROW:this.rendererTypeSelect.set("value",this._rendererTypes[1]),this._loadColor();break;case p.STYLE_BEAUFORT_KN:case p.STYLE_BEAUFORT_METER:case p.STYLE_BEAUFORT_MILE:case p.STYLE_BEAUFORT_FEET:case p.STYLE_BEAUFORT_KM:this.rendererTypeSelect.set("value",this._rendererTypes[3]);break;case p.STYLE_OCEAN_CURRENT_M:this.rendererTypeSelect.set("value",this._rendererTypes[5]);break;case p.STYLE_OCEAN_CURRENT_KN:this.rendererTypeSelect.set("value",this._rendererTypes[4]);break;case p.STYLE_CLASSIFIED_ARROW:this.rendererTypeSelect.set("value",this._rendererTypes[6]);break;case p.STYLE_WIND_BARBS:this.rendererTypeSelect.set("value",this._rendererTypes[2]);break;default:this.rendererTypeSelect.set("value",this._rendererTypes[1])}},_loadSymbolSizeValues:function(){var e,t=20,i=80,s=this.layer.renderer.visualVariables;if(r.forEach(s,(function(t){"sizeInfo"===t.type&&(e=t)})),e&&e.minSize&&e.maxSize&&this.layer.graphics.length){var l=this._getLayerSymbolTileSize();t=e.minSize/l*100,i=e.maxSize/l*100}this._symbolSizeSlider.set("value",[t,i])},_getLayerSymbolTileSize:function(){return this.layer.renderer&&this.layer.renderer.symbolTileSize||this.layer.symbolTileSize||50},_loadTileSizeValue:function(){this._symbolDensitySlider.set("value",1/this._getLayerSymbolTileSize())},_loadMinMaxValues:function(){var e,t=this.layer.renderer.visualVariables;r.forEach(t,(function(t){"sizeInfo"===t.type&&(e=t)})),this.minMagnitudeInput.set("value",e&&S.isDefined(e.minDataValue)?e.minDataValue:""),this.maxMagnitudeInput.set("value",e&&S.isDefined(e.maxDataValue)?e.maxDataValue:"")},_loadAngleDirection:function(){var e=this.layer.getFlowRepresentation(),t="FLOW_FROM";t=!!e?e==p.FLOW_TO?"FLOW_TO":"FLOW_FROM":this.layer.renderer.flowRepresentation==p.FLOW_TO?"FLOW_TO":"FLOW_FROM",this.flowAngleSelect.set("value",t)},_loadColor:function(){this.layer.renderer&&this.layer.renderer.renderer&&this.layer.renderer.renderer.defaultSymbol&&this.startupCalled&&(this.symbolColorPicker.set("color",this.layer.renderer.renderer.defaultSymbol.color),this._updateArrowSymbolButton())},_loadUnits:function(){this.layer.vectorFieldPixelFilter&&(this.layer.vectorFieldPixelFilter.inputUnit?this.inputDataUnitSelect.set("value",this.layer.vectorFieldPixelFilter.inputUnit):this.inputDataUnitSelect.set("value","NO_UNIT"),this.layer.vectorFieldPixelFilter.outputUnit&&this.outputDataUnitSelect.set("value",this.layer.vectorFieldPixelFilter.outputUnit))},_onOutputUnitChange:function(e){this.dataValueRangeUnit.innerHTML=e&&"NO_UNIT"!=e?" in <strong>"+this._i18n.widgets.vectorFieldRenderer[e]+"</strong>.":".",this.propertiesChanged=!0},_onClickApplyVectorFieldRenderer:function(){if(this.propertiesChanged){var e,t,i,r,s,l,n,a=p.STYLE_SINGLE_ARROW;i=Math.floor(1/this._symbolDensitySlider.value),e=g.px2pt(this._symbolSizeSlider.value[0]/100*i),t=g.px2pt(this._symbolSizeSlider.value[1]/100*i),r=isNaN(this.minMagnitudeInput.value)?null:this.minMagnitudeInput.value,s=isNaN(this.maxMagnitudeInput.value)?null:this.maxMagnitudeInput.value,l=p[this.flowAngleSelect.value],"singleArrow"==this.rendererTypeSelect.value?(a=p.STYLE_SINGLE_ARROW,this.symbolColorPicker.color):"simpleScalar"==this.rendererTypeSelect.value?a=p.STYLE_SCALAR:"beaufort"==this.rendererTypeSelect.value?"esriKnots"==this.outputDataUnitSelect.value?a=p.STYLE_BEAUFORT_KN:"esriMetersPerSecond"==this.outputDataUnitSelect.value?a=p.STYLE_BEAUFORT_METER:"esriMilesPerHour"==this.outputDataUnitSelect.value?a=p.STYLE_BEAUFORT_MILE:"esriKilometersPerHour"==this.outputDataUnitSelect.value?a=p.STYLE_BEAUFORT_KM:"esriFeetPerSecond"==this.outputDataUnitSelect.value&&(a=p.STYLE_BEAUFORT_FEET):"oceanCurrentKnots"==this.rendererTypeSelect?a=p.STYLE_OCEAN_CURRENT_KN:"oceanCurrentMps"==this.rendererTypeSelect?a=p.STYLE_OCEAN_CURRENT_M:"classifiedArrow"==this.rendererTypeSelect?a=p.STYLE_CLASSIFIED_ARROW:"windBarbs"==this.rendererTypeSelect&&(a=p.STYLE_WIND_BARBS),this.symbolColorPicker&&this.symbolColorPicker.color&&(n=this.layer.renderer._getDefaultSymbol(new y(this.symbolColorPicker.color)));var o="NO_UNIT"!==this.inputDataUnitSelect.value?this.inputDataUnitSelect.value:"",d="NO_UNIT"!==this.outputDataUnitSelect.value?this.outputDataUnitSelect.value:"";this.layer.vectorFieldPixelFilter.setUnits(o,d),this.layer.rendererStyle=a;var u={type:"sizeInfo",minSize:e,maxSize:t,minDataValue:r,maxDataValue:s},h=[];h.push(u);var c=new p({style:a,visualVariables:h,flowRepresentation:l,symbolTileSize:i,singleArrowSymbol:n||null,outputUnit:d,inputUnit:o});this.layer.setRenderer(c),this.layer.symbolTileSize!==i?(this.layer.symbolTileSize=i,this.layer.refresh()):this.layer.redraw(),this._loadVFRStyle(),this.propertiesChanged=!1,this.resetAvailable=!0}},_onClickResetVectorFieldRenderer:function(){if(this.layer&&(this.propertiesChanged||this.resetAvailable)){var e=this;this.layer.symbolTileSize=50,this.layer.renderer&&(this.layer.renderer.symbolTileSize=50),this.layer.setVectorRendererStyle(p.STYLE_SINGLE_ARROW);var t=Math.floor(1/this._symbolDensitySlider.value);this.layer.vectorFieldPixelFilter&&this.layer.vectorFieldPixelFilter.setUnits(null,null),this.layer.symbolTileSize!==t?this.layer.refresh():this.layer.redraw(),this._loadVFRArguments(),this.propertiesChanged=!1,this.resetAvailable=!1,setTimeout((function(){e.propertiesChanged=!1}),500)}},_updateArrowSymbolButton:function(e){this._arrowSymbolButtonNode.innerHTML="";var i=g.createSurface(this._arrowSymbolButtonNode,24,24),r=i.createShape({type:"path",path:"M14,32 14,18 9,23 16,3 22,23 17,18 17,32 z"}).setFill(e||this.symbolColorPicker.color),s=(i.getDimensions(),{dx:0,dy:0}),l=r.getBoundingBox(),n=l.width,a=l.height;if(n<24||a<24){var o=(n+5)/24;t.mixin(s,{xx:o,yy:o})}return r.applyTransform(s),i},_onInputUnitChange:function(e){"NO_UNIT"!=e||"beaufort"==this.rendererTypeSelect.value||"oceanCurrent"==this.rendererTypeSelect.value?this.outputDataUnitSelect.set("disabled",!1):(this.outputDataUnitSelect.set("value","NO_UNIT"),this.outputDataUnitSelect.set("disabled",!0)),this.propertiesChanged=!0},_refreshOutputUnitSelect:function(){this._outputUnits=[],this._outputUnits.push({id:"esriFeetPerSecond",label:this._i18n.widgets.vectorFieldRenderer.esriFeetPerSecond}),"oceanCurrentMps"!=this.rendererTypeSelect.value&&this._outputUnits.push({id:"esriKnots",label:this._i18n.widgets.vectorFieldRenderer.esriKnots}),"oceanCurrentKnots"!=this.rendererTypeSelect.value&&(this._outputUnits.push({id:"esriMetersPerSecond",label:this._i18n.widgets.vectorFieldRenderer.esriMetersPerSecond}),"oceanCurrentMps"!=this.rendererTypeSelect.value&&(this._outputUnits.push({id:"esriKilometersPerHour",label:this._i18n.widgets.vectorFieldRenderer.esriKilometersPerHour}),this._outputUnits.push({id:"esriMilesPerHour",label:this._i18n.widgets.vectorFieldRenderer.esriMilesPerHour}),"beaufort"!=this.rendererTypeSelect.value&&this._outputUnits.push({id:"NO_UNIT",label:" ",selected:!0}))),"windBarbs"===this.rendererTypeSelect.value&&(this._outputUnits=[{id:"esriKnots",label:this._i18n.widgets.vectorFieldRenderer.esriKnots}]);var e=new n({data:this._outputUnits}),t=new a({objectStore:e});this.outputDataUnitSelect.set("store",t),this.layer&&this.layer.vectorFieldPixelFilter&&this.layer.vectorFieldPixelFilter.outputUnit?this.outputDataUnitSelect.set("value",this.layer.vectorFieldPixelFilter.outputUnit):"oceanCurrentKnots"===this.rendererTypeSelect.value||"beaufort"===this.rendererTypeSelect.value?this.outputDataUnitSelect.set("value","esriKnots"):"oceanCurrentMps"===this.rendererTypeSelect.value&&this.outputDataUnitSelect.set("value","esriMetersPerSecond")},_setPropertiesChanged:function(){this.propertiesChanged=!0}});return o("extend-esri")&&t.setObject("dijit.VectorFieldRenderer",F,c),F}));