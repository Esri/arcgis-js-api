define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/kernel","dojo/_base/fx","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/_base/event","dojo/Evented","dojo/fx/easing","dojo/store/Memory","dojo/mouse","dojo/on","dojo/_base/window","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/MultiSelect","dijit/form/TextBox","dijit/form/SimpleTextarea","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/ComboBox","dijit/Dialog","dijit/Tooltip","dgrid/OnDemandList","dgrid/Selection","dgrid/Keyboard","dgrid/extensions/DijitRegistry","dgrid/util/mouse","put-selector/put","../kernel","../lang","../request","./SingleFilter","dojo/i18n!../nls/jsapi","dojo/text!./templates/CalculateField.html"],function(e,t,i,s,n,r,a,l,o,h,d,u,c,p,_,f,m,b,g,y,x,T,F,v,C,S,L,N,R,B,w,E,M,O,j,I,A,P,D,k,H,U,q,G,W,V,Q,J,K,z,X,Y){var Z=e([H,q,U,G]),$=e([F,v,C,S,L,m],{declaredClass:"esri.dijit.CalculateField",templateString:Y,widgetsInTemplate:!0,showSelectField:!1,showHeader:!0,closeOnAdd:!0,addButtonClass:"",closeButtonClass:"",_showMsgTimerInterval:3e3,constructor:function(e){e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments)},postMixInProperties:function(){this.inherited(arguments),this.i18n={},t.mixin(this.i18n,X.common),t.mixin(this.i18n,X.calculateFields)},postCreate:function(){this.inherited(arguments),this._buildUI(),this._loadEvents();var e,t,i=["ar","he"];for(this.onlineHelpMap={},e=0;e<i.length;e+=1)t=i[e],r.locale&&-1!==r.locale.indexOf(t)&&(-1!==r.locale.indexOf("-")?-1!==r.locale.indexOf(t+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this.validate()},_buildUI:function(){var e,s,n,r=[];if(d.set(this._header,"display",this.showHeader?"block":"none"),d.set(this._selCalcFieldDiv,"display",this.showSelectField?"block":"none"),this.field&&(s=i.filter(this.layer.fields,function(e){return e.name===this.field},this),n=s[0],this._calcField=n,u.set(this._calcFieldLabel,"innerHTML",h.substitute(this.i18n.exprLabel,{fieldName:n.name}))),!this.helperMethods||this.helperMethods&&0===this.helperMethods.length){var a=[{type:"NumType",label:h.substitute(this.i18n.absFunc,{functionName:"ABS(<i>number</i>)",num:"<i>number</i>"}),name:"ABS()"},{type:"NumType",label:h.substitute(this.i18n.castFunc,{functionName:"CAST(<i>number</i>",num:"<i>number</i>"}),name:"CAST()"},{type:"NumType",label:h.substitute(this.i18n.ceilingFunc,{functionName:"CEILING(<i>number</i>)",num:"<i>number</i>"}),name:"CEILING()"},{type:"NumType",label:h.substitute(this.i18n.cosFunc,{functionName:"COS(<i>number</i>)",num:"<i>number</i>"}),name:"COS()"},{type:"NumType",label:h.substitute(this.i18n.floorFunc,{functionName:"FLOOR(<i>number</i>)",num:"<i>number</i>"}),name:"FLOOR()"},{type:"NumType",label:h.substitute(this.i18n.logFunc,{functionName:"LOG(<i>number</i>)",num:"<i>number</i>"}),name:"LOG()"},{type:"NumType",label:h.substitute(this.i18n.log10Func,{functionName:"LOG10(<i>number</i>)",num:"<i>number</i>"}),name:"LOG10()"},{type:"NumType",label:h.substitute(this.i18n.modFunc,{functionName:"MOD(<i>number</i>, <i>n</i>)",num:"<i>number</i>",n:"<i>n</i>"}),name:"MOD(,)"},{type:"NumType",label:h.substitute(this.i18n.powerFunc,{functionName:"POWER(<i>number</i>, <i>y</i>)",num:"<i>number</i>",y:"<i>y</i>"}),name:"POWER(,)"},{type:"NumType",label:h.substitute(this.i18n.roundFunc,{functionName:"ROUND(<i>number</i>, <i>length</i>)",num:"<i>number</i>",length:"<i>length</i>"}),name:"ROUND(,)"},{type:"NumType",label:h.substitute(this.i18n.sinFunc,{functionName:"SIN(<i>number</i>)",num:"<i>number</i>"}),name:"SIN()"},{type:"NumType",label:h.substitute(this.i18n.tanFunc,{functionName:"TAN(<i>number</i>)",num:"<i>number</i>"}),name:"TAN()"},{type:"NumType",label:h.substitute(this.i18n.truncateFunc,{functionName:"TRUNCATE(<i>number</i>, <i>decimal_place</i>)",num:"<i>number</i>",decimal_place:"<i>decimal_place</i>"}),name:"TRUNCATE(,)"},{type:"NumType",label:h.substitute(this.i18n.nullifFunc,{functionName:"NULLIF(<i>number</i>,<i>value</i>)",num:"<i>number</i>",value:"<i>value</i>"}),name:"NULLIF(,)"},{type:"StrType",label:h.substitute(this.i18n.char_lengthFunc,{functionName:"CHAR_LENGTH(<i>string</i>)",str:"<i>string</i>"}),name:"CHAR_LENGTH()"},{type:"StrType",label:h.substitute(this.i18n.concatFunc,{functionName:"CONCAT(<i>string1</i>, <i>string2</i>)"}),name:"CONCAT(,)"},{type:"StrType",label:h.substitute(this.i18n.positionFunc,{functionName:"POSITION(<i>substring</i>, <i>string</i>)",str:"<i>string</i>"}),name:"POSITION(,)"},{type:"StrType",label:h.substitute(this.i18n.lowerFunc,{functionName:"LOWER(<i>string</i>)",str:"<i>string</i>"}),name:"LOWER()"},{type:"StrType",label:h.substitute(this.i18n.substringFunc,{functionName:"SUBSTRING(<i>string</i>, <i>start</i>, <i>length</i>)",start:"<i>start</i>",length:"<i>length</i>",str:"<i>string</i>"}),name:"SUBSTRING(,,)"},{type:"StrType",label:h.substitute(this.i18n.trimFunc,{functionName:"TRIM(BOTH|LEADING|TRAILING] ‘ ‘ FROM expression)",str:"<i>string</i>"}),name:"TRIM()"},{type:"StrType",label:h.substitute(this.i18n.upperFunc,{functionName:"UPPER(<i>string</i>)",str:"<i>string</i>"}),name:"UPPER()"},{type:"DateType",label:h.substitute(this.i18n.current_dateFunc,{functionName:"CURRENT_DATE()"}),name:"CURRENT_DATE()"},{type:"DateType",label:h.substitute(this.i18n.current_timeFunc,{functionName:"CURRENT_TIME()"}),name:"CURRENT_TIME()"},{type:"DateType",label:h.substitute(this.i18n.current_timestampFunc,{functionName:"CURRENT_TIMESTAMP()"}),name:"CURRENT_TIMESTAMP()"}];i.forEach(a,function(e){e.label="<b>"+e.label.substring(0,e.label.lastIndexOf(":")+1)+"</b><br/> "+e.label.substring(e.label.lastIndexOf(":")+1)},this),this.set("helperMethods",a)}if((!this.operators||this.operators&&0===this.operators.length)&&this.set("operators",["+","-","/","*","(",")"]),this._operatorBtns=[],i.forEach(this.operators,function(e){this._operatorBtns.push(new R({value:e,label:e,style:{width:"4em"},onClick:t.hitch(this,this._updateExpression,{value:e,type:"operator"})},c.create("div",null,this._operatorCtr)))},this),this.layer&&this.layer.fields&&this.layer.fields.length>0){r=this._createIds(this.layer.fields);var l=i.map(this.layer.fields,function(e){return{label:e.name,value:e.name}});this._selCalcField.addOption(l),this._selCalcField.set("value",this.field)}this.fieldsStore=new g({data:r}),this.attributeList=new Z({renderRow:t.hitch(this,this._renderAttributesRow),selectionMode:"single",store:this.fieldsStore},this._attributeListCtr),e=this._createIds(this.get("helperMethods")),this.operatorStore=new g({data:e}),this.helpersList=new Z({renderRow:t.hitch(this,this._renderOperatorRow),selectionMode:"single",store:this.operatorStore},this._helpersListCtr)},_loadEvents:function(){this.watch("fields",t.hitch(this,this._handleFieldsChange)),this.watch("field",t.hitch(this,this._handleFieldChange)),this.showSelectField&&this._selCalcField.on("change",t.hitch(this,this._handleSelcCalFieldChange)),this._expressionForm.watch("value",t.hitch(this,this._handleHelperTypeChange)),this._expressionForm.on("focus",t.hitch(this,this._setfocus)),this._exprBox.watch("value",t.hitch(this,this._handleExpChange)),this.attributeList.on("dgrid-select",t.hitch(this,function(e){var t=e.rows;this._updateExpression({value:t[0].data,type:"field"})})),this.helpersList.on("dgrid-select",t.hitch(this,function(e){var t=e.rows;this._updateExpression({value:t[0].data,type:"helper"})})),this.attributeList.on(W.enterRow,t.hitch(this,function(e){var t,i,s,n=this.attributeList.row(e);i=n.data.alias||n.data.name,s="",s=this._getTypeLabel(n.data.type),t="<b>"+i+"</b>: "+s,this._showTooltip(n.element,t)})),this.attributeList.on(W.leaveRow,t.hitch(this,function(e){var t=this.attributeList.row(e);this._hideTooltip(t.element)})),this.helpersList.on(W.enterRow,t.hitch(this,function(e){var t=this.helpersList.row(e);this._showTooltip(t.element,t.data.label)})),this.helpersList.on(W.leaveRow,t.hitch(this,function(e){var t=this.helpersList.row(e);this._hideTooltip(t.element)})),this.attributeList.on("dgrid-refresh-complete",t.hitch(this,this._setfocus)),this.helpersList.on("dgrid-refresh-complete",t.hitch(this,this._setfocus)),this._exprBox.on("blur",t.hitch(this,function(){this._exprBox.textbox.setSelectionRange&&"number"==typeof this._exprBox.textbox.selectionStart?this._exprBox.set("cursorPosition",[this._exprBox.textbox.selectionStart,this._exprBox.textbox.selectionEnd]):this._exprBox.set("cursorPosition",this._getCursorRange(this._exprBox.textbox))})),this._exprBox.on("focus",t.hitch(this,function(){var e=this._exprBox.get("cursorPosition");e&&(this._exprBox.textbox.setSelectionRange&&"number"==typeof this._exprBox.textbox.selectionStart?this._exprBox.textbox.setSelectionRange(e[1],e[1]):this._setCaretPosition(this._exprBox.textbox,e[1],e[1]))})),x(this._calcFieldLabel,y.enter,t.hitch(this,function(){var e="";e=this._getTypeLabel(this._calcField.type),this._showTooltip(this._calcFieldLabel,"<b>"+this._calcField.alias+"</b>: "+e)})),x(this._calcFieldLabel,y.leave,t.hitch(this,function(){this._hideTooltip(this._calcFieldLabel)}))},startup:function(){this.inherited(arguments),this.attributeList.startup(),this.helpersList.startup(),this._setHelperType()},reset:function(){Q.show(this.domNode),this._expressionForm.reset(),this._handleCloseMsg(),this._setHelperType()},_close:function(){this.emit("close",{}),Q.hide(this.domNode)},_createIds:function(e){var s=[];return e&&e.length>0&&(s=i.map(e,function(e,i){return t.mixin(e,{id:i})})),s},_renderAttributesRow:function(e){var t=c.create("div",{"class":"esriCalExpRowOuter"}),i=c.create("div",{"class":"esriCalcExpLabelRow"},t);return c.create("div",{"class":"esriCalcFieldTextTrimWithEllipses",innerHTML:e.name},i),t},_renderOperatorRow:function(e){var t=c.create("div",{"class":"esriCalExpRowOuter"}),i=c.create("div",{"class":"esriCalcExpLabelRow"},t);return c.create("div",{"class":"esriCalcFieldTextTrimWithEllipses",innerHTML:e.name},i),t},_handleFieldsChange:function(){var e=[];if(this.layer&&this.layer.fields&&this.layer.fields.length>0){this._selCalcField.getOptions().length>0&&this._selCalcField.removeOption(this._selCalcField.getOptions()),e=this._createIds(this.layer.fields);var t=i.map(this.layer.fields,function(e){return{label:e.name,value:e.name}});this._selCalcField.addOption(t),this._selCalcField.set("value",this.field)}this.fieldsStore=new g({data:e}),this.attributeList.set("store",this.fieldsStore)},_handleFieldChange:function(e,t,i){u.set(this._calcFieldLabel,"innerHTML",h.substitute(this.i18n.exprLabel,{fieldName:i})),this._setHelperType(),this._setfocus()},_setHelperType:function(){var e,t;if(this.field){if(e=i.filter(this.layer.fields,function(e){return e.name===this.field},this),t=e[0],!J.isDefined(t))return void this._strRadioBtn.set("checked",!0);this._calcField=t,"esriFieldTypeDate"===t.type?this._dateRadioBtn.set("checked",!0):"esriFieldTypeString"===t.type?this._strRadioBtn.set("checked",!0):-1!==i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],t.type)&&this._numRadioBtn.set("checked",!0)}else this._strRadioBtn.set("checked",!0)},_handleHelperTypeChange:function(e,t,s){this.helpersList.set("query",{type:s.functionType}),"DateType"===s.functionType?this.attributeList.set("query",{type:"esriFieldTypeDate"}):"StrType"===s.functionType?this.attributeList.set("query",{type:"esriFieldTypeString"}):"NumType"===s.functionType&&this.attributeList.set("query",function(e){return-1!==i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],e.type)}),this.helpersList.refresh(),this.attributeList.refresh()},_handleSelcCalFieldChange:function(e){this.set("field",e)},_handleRemoveBtnClick:function(){this._exprBox.set("value",""),this._setfocus()},_handleAddButtonClick:function(e){f.stop(e);var i,s=this._exprBox.get("value"),r={f:"json"};return s?(this._handleCloseMsg(),r.calcExpression=n.toJson(this.get("expression")),r.sqlFormat="standard",this.layer.getDefinitionExpression&&this.layer.getDefinitionExpression()?r.where=this.layer.getDefinitionExpression():J.isDefined(this.layer.definitionExpression)&&""!==this.layer.definitionExpression&&(r.where=this.layer.definitionExpression),void Q.id.getCredential(this.layer.url+"/calculate").then(t.hitch(this,function(e){r.token=e.token,i=K({url:this.layer.url+"/calculate",content:r},{usePost:!0}),this.emit("calculate-start",{calcPromise:i.promise}),this._addBtn.set("disabled",!0),this._showLoading(),i.then(t.hitch(this,function(e){this._addBtn.set("disabled",!1),this._hideLoading();var i={};t.mixin(i,{calcExpression:n.fromJson(r.calcExpression)[0].sqlExpression,where:r.where,sqlFormat:r.sqlFormat},e),this.emit("calculate-success",i),this.layer.refresh(),this._showMessages(h.substitute(this.i18n.successMsg,{count:e.updatedFeatureCount}),!0),this.closeOnAdd&&this._close()}),t.hitch(this,this._handleErrorResponse))}),t.hitch(this,this._handleErrorResponse))):void this._addBtn.set("disabled",!0)},_handleErrorResponse:function(e){this._addBtn.set("disabled",!1),this._hideLoading(),this.emit("calculate-error",e),this._showMessages(h.substitute(this.i18n.exprFailedMsg,{expr:this._exprBox.get("value")})+"<br/>"+e.details.toString())},_handleCloseButtonClick:function(e){f.stop(e),this._close()},_showTooltip:function(e,t){var i=c.create("label",{innerHTML:t,className:"esriSmallFont"});this._isRightToLeft?k.show(i.outerHTML,e,["after"],!0):k.show(i.outerHTML,e,["after"])},_hideTooltip:function(e){k.hide(e)},_setfocus:function(){this._exprBox.focus()},_showMessages:function(e,i){u.set(this._bodyNode,"innerHTML",e),a.fadeIn({node:this._errorMessagePane,easing:b.quadIn,onEnd:t.hitch(this,function(){d.set(this._errorMessagePane,{display:""})})}).play(),i&&window.setTimeout(t.hitch(this,this._handleCloseMsg),this._showMsgTimerInterval)},_handleCloseMsg:function(e){e&&e.preventDefault(),"none"!==d.get(this._errorMessagePane,"display")&&a.fadeOut({node:this._errorMessagePane,easing:b.quadOut,onEnd:t.hitch(this,function(){d.set(this._errorMessagePane,{display:"none"})})}).play()},validate:function(){var e=!0,t="";return this.layer?this.field?this.layer.supportsCalculate?this.layer.userIsAdmin||this.layer.getEditCapabilities().canUpdate||(t=h.substitute(this.i18n.lyrUpdateCapMsg,{layername:this.layer.name}),e=!1):(t=h.substitute(this.i18n.lyrSupportCalMsg,{layername:this.layer.name}),e=!1):(t=this.i18n.fieldReqMsg,e=!1):(t=this.i18n.layerReqMsg,e=!1),this._addBtn.set("disabled",!e),e},_validateExpObj:function(e){var t,i=!0;return e||(i=!1),i?this._handleCloseMsg():this._showMessages(t),i},_updateExpression:function(e){var t,s,n=this._exprBox.get("cursorPosition"),r=this._exprBox.get("value"),a="",l=0;if(this._validateExpObj(e)){if(this._exprStack||(this._exprStack=[]),this._exprStack.length>0&&(s=this._exprStack[this._exprStack.length-1]),n&&r||(n=[0,0]),"operator"===e.type)t=" "+e.value+" ",l=t.length;else if("helper"===e.type)t=e.value.name,l=-1!==e.value.name.indexOf(",")?e.value.name.indexOf(","):e.value.name.length-1;else if("field"===e.type){var o=J.isDefined(s)&&"helper"===s.type&&-1!==s.value.name.indexOf("MOD")&&-1!==i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],e.value.type),h=J.isDefined(s)&&"helper"===s.type&&-1!==s.value.name.indexOf("MOD")&&"esriFieldTypeDouble"===e.value.type;t="esriFieldTypeDouble"!==this._calcField.type||o||-1===i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],e.value.type)?-1!==i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],this._calcField.type)&&h?"CAST("+e.value.name+" AS INT)":e.value.name:"CAST("+e.value.name+" AS FLOAT)",l=t.length+1}a=r.substring(0,n[0])+t+r.substring(n[1]),this._exprBox.set("value",a),this._exprBox.focus(),this._exprBox.textbox.setSelectionRange&&"number"==typeof this._exprBox.textbox.selectionStart?(this._exprBox.textbox.setSelectionRange(n[0]+l,n[0]+l),this._exprBox.set("cursorPosition",[n[0]+l,n[0]+l])):(this._setCaretPosition(this._exprBox.textbox,n[0]+l,n[0]+l),this._exprBox.set("cursorPosition",this._getCursorRange(this._exprBox.textbox))),this._setfocus(),this._exprStack.push(e)}},_setCaretPosition:function(e,t,i){if(e.setSelectionRange&&"number"==typeof e.selectionStart)e.setSelectionRange(t,i);else if("undefined"!=typeof e.createTextRange){var s=e.createTextRange();s.collapse(!0),s.moveEnd("character",i),s.moveStart("character",t),s.select()}},_getCaretPosition:function(e){var t=0;if(T.doc.selection){e.focus();var i=T.doc.selection.createRange();i.moveStart("character",-e.value.length),t=i.text.length}else(e.selectionStart||"number"==typeof e.selectionStart)&&(t=e.selectionStart);return t},_getCursorRange:function(e){var t,i;return e.setSelectionRange&&"number"==typeof e.selectionStart?(t=e.selectionStart,i=e.selectionEnd):"undefined"!=typeof e.createTextRange&&(t=this._getCaretPosition(e),i=this._getCaretPosition(e)),[t,i]},_handleExpChange:function(e,t,i){this._addBtn.set("disabled",!i),this._validateBtn.set("disabled",!i),this._removeBtn.set("disabled",!i)},_handleValidationBtnClick:function(){var e,s={sql:this.field+" = "+this._exprBox.get("value"),sqlType:"where",f:"json"};e=K({url:this.layer.url+"/validateSQL",content:s},{usePost:!0}),this._addBtn.set("disabled",!0),this._validateBtn.set("disabled",!0),this._showLoading(),e.then(t.hitch(this,function(e){var t;this._hideLoading(),this._validateBtn.set("disabled",!1),this._addBtn.set("disabled",!e.isValidSQL),e.isValidSQL?(_.toggle(this._errorMessagePane,"esriFormSuccess",!0),this._handleCloseMsg(),this._showMessages(X.calculateFields.validExpression)):(e.validationErrors&&e.validationErrors.length>0?(t="",i.forEach(e.validationErrors,function(e){if(e.params&&X.calculateFields.errorCodes[e.errorCode]){var i={};for(var s in e.params)e.params.hasOwnProperty(s)&&(i[s]=e.params[s]);t+=h.substitute(X.calculateFields.errorCodes[e.errorCode],i)+"<br/>"}else t+=(X.calculateFields.errorCodes[e.errorCode]||e.description)+"<br/>"},this),this._showMessages(t,!1)):this._showMessages(X.calculateFields.invalidExpression),_.toggle(this._errorMessagePane,"esriFormSuccess",!1))}),t.hitch(this,function(){this._hideLoading(),this._validateBtn.set("disabled",!1),this._addBtn.set("disabled",!1)}))},_showLoading:function(){d.set(this._underlay,"display","block")},_hideLoading:function(){d.set(this._underlay,"display","none")},_getTypeLabel:function(e){var t;return-1!==i.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],e)?t=this.i18n.integerLabel:"esriFieldTypeDouble"===e?t=this.i18n.doubleLabel:"esriFieldTypeDate"===e?t=this.i18n.dateLabel:"esriFieldTypeString"===e&&(t=this.i18n.stringLabel),t},_setLayerAttr:function(e){this._set("layer",e),this._set("fields",e.fields)},_setFieldsAttr:function(e){this._set("fields",e)},_setFieldAttr:function(e){this._set("field",e)},_setHelperMethodsAttr:function(e){this._set("helperMethods",e)},_setOperatorsAttr:function(e){this._set("operators",e)},_setShowSelectFieldAttr:function(e){this._set("showSelectField",e)},_setShowHeaderAttr:function(e){this._set("showHeader",e)},_setCloseOnAddAttr:function(e){this._set("closeOnAdd",e)},_getExpressionAttr:function(){var e,t,i,s=this._exprBox.get("value");return s?(e=s.split(" "),i=[],t={field:this.field},t.sqlExpression=s,i.push(t),i):void this._addBtn.set("disabled",!0)},_setAddButtonClassAttr:function(e){this._set("addButtonClass",e)},_setCloseButtonClassAttr:function(e){this._set("closeButtonClass",e)}});return l("extend-esri")&&t.setObject("dijit.CalculateField",$,Q),$});