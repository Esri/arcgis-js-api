define(["require","module","../../declare","dojo/_base/lang","dojo/dom-construct","dojo/Deferred","../_EventedWidget","./DataProvider","./Geoenrichment","./config","dojo/on","../../tasks/geoenrichment/GeoenrichmentTask","../../tasks/geoenrichment/RingBuffer","dojo/dom-class","./_Invoke","./utils"],function(t,e,i,s,o,n,r,a,h,d,u,l,_,c,g,p){function f(t,e){var i=new n,s=new l(d.server);s.token=d.token;var o=e[0].split(".");return s.getDataCollections(null,o[0]).then(function(e){if("OneVar"==t)if("*"==o[1])i.resolve(e[0].variables[0].alias);else{for(var s=e[0].variables,n=0;n<s.length;n++)if(s[n].id==o[1])return void i.resolve(s[n].alias);i.reject(new Error("Variable was not found within the data collection: "+s[0]))}else i.resolve(e[0].metadata.title)},function(t){i.reject(t)}),i.promise}var v=i([a],{_data:null,constructor:function(t,e){this._data=t,s.mixin(this.metadata,e)},getData:function(){return this._data}}),y=i("esri.dijit.geoenrichment.Infographic",[r,g],{countryID:null,levels:d.levels,highestLevel:d.highestLevel,title:null,subtitle:"<div>${address}</div><div>${name}</div>",type:null,variables:null,studyArea:null,studyAreaOptions:null,outSR:null,expanded:!0,returnGeometry:!1,dataProvider:null,_data:null,_ge:null,_autoTitle:null,_autoTitlePromise:null,_eventMap:{resize:["size"],"data-request":!0,"data-ready":["provider"],"data-load":!0,"data-error":["error"]},constructor:function(){this.studyAreaOptions=new _},postMixInProperties:function(){this._ge=new h,this._ge.on("start",s.hitch(this,this._onDataRequest)),this._ge.on("data",s.hitch(this,this._onDataReady)),this._ge.on("end",s.hitch(this,this._onDataLoad)),this._ge.on("error",s.hitch(this,this._onDataError)),this.dataProvider=this._ge,this.type&&(this.invoke("_updateAutoTitle"),this._updateReport())},buildRendering:function(){this.inherited(arguments),this.domNode=o.create("div"),this.expanded||c.add(this.domNode,"Collapsed")},destroy:function(){this._destroyReportWidget(),this._ge.stop(),this.inherited(arguments)},_setReturnGeometryAttr:function(t){this._set("returnGeometry",t),this._ge.returnGeometry=t},_setTitleAttr:function(t){this._set("title",t),this._widget&&(this._widget.title=t)},_setSubtitleAttr:function(t){this._set("subtitle",t),this._ge.setReturnAddress(/\$\{address\}/.test(t)),this._widget&&(this._widget.subtitle=t)},_setTypeAttr:function(t){this.type!=t&&(this._set("type",t),this._widget&&this._widget.setDataProvider(null),this.invoke("_updateAutoTitle"),this._updateReport())},_updateReport:function(){this._updateLevels(),this.invoke("_requireReport")},_getAbsMid:function(i){return t.toAbsMid?t.toAbsMid(i):e.id.replace(/\/[^\/]*$/gi,"/")+i},_requireReport:function(){this.type&&t([this._getAbsMid("./"+this.type)],s.hitch(this,this._createReportWidget,this.type))},_updateAutoTitle:function(){if(!s.isString(this.title)&&this.type&&this.variables){var t=this;this._autoTitlePromise=f(this.type,this.variables),this._autoTitlePromise.then(function(e){t._autoTitle=e},function(e){t._onDataError(e)}),this._autoTitlePromise.always(function(){t._autoTitlePromise=null})}},_setCountryIDAttr:function(t){this._set("countryID",t),this._ge.country=t},_setVariablesAttr:function(t){var e=!0;if(s.isArray(t)){for(var i=0;i<t.length;i++)if(t[i].indexOf(".")<=0){e=!1;break}}else null!=t&&(e=!1);if(!e)throw new Error("Invalid value for variables");this._set("variables",t),this._ge.setVariables(t),this.invoke("_updateAutoTitle")},_setStudyAreaAttr:function(t){this._set("studyArea",t),this._ge.setStudyArea(t)},_setSpatialReference:function(t){this._set("outSR",t),this._ge.setOutSR(t)},_setStudyAreaOptionsAttr:function(t){this._set("studyAreaOptions",t),this._ge.setBuffer(t)},_setExpandedAttr:function(t){this.expanded!=t&&(this._destroyReportWidget(),this._set("expanded",t),t?c.remove(this.domNode,"Collapsed"):c.add(this.domNode,"Collapsed"),this._updateReport())},_setCacheLimitAttr:function(t){this._ge.setCacheLimit(t)},setData:function(t,e){this.set("dataProvider",new v(t,e))},_setDataProviderAttr:function(t){this.dataProvider!==t&&(this._set("dataProvider",t),this._ge&&(this._ge.stop(),this._ge=null),this._widget&&this._widget.setDataProvider(t))},_updateLevels:function(){var t=p.supportsComparison(this.type,this.expanded);t?this._ge.setGeoLevels(this.levels,this.highestLevel):this._ge.setGeoLevels(null,null)},_widget:null,_createReportWidget:function(t,e){if(!this._destroyed&&this.type==t){if(this._ge&&this._ge.isBusy())return void u.once(this._ge,"end",s.hitch(this,this._createReportWidget,this.type,e));if(this._autoTitlePromise)return void this._autoTitlePromise.then(s.hitch(this,this._createReportWidget,this.type,e));var i=this._widget?this._widget.getState("selectedComparison"):0/0;if(this._destroyReportWidget(),this.type){var o=this._widget=new e(this.domNode);o.title=s.isString(this.title)?this.title:this._autoTitle,o.subtitle=this.subtitle,o.expanded=this.expanded,o.on("resize",s.hitch(this,this._onResize)),isNaN(i)||o.setState({selectedComparison:i}),o.setDataProvider(this.dataProvider)}}},resize:function(){this._widget&&this._widget.resize()},_destroyReportWidget:function(){this._widget&&(this._widget.destroy(),this._widget=null)},_onResize:function(t){this.onResize(t)},onResize:function(){},_onDataRequest:function(){this.onDataRequest()},onDataRequest:function(){},_onDataReady:function(){this.onDataReady(this._ge)},onDataReady:function(){},_onDataLoad:function(){this.onDataLoad()},onDataLoad:function(){},_onDataError:function(t){this.onDataError(t)},onDataError:function(){}});return y});