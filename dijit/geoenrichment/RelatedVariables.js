// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["../../declare","./BaseSelectComparison","./dom","dojo/dom-construct","dojo/dom-attr","./lang","dojo/i18n!../../nls/jsapi","dojo/dom-class","dojo/query","dojo/string","dojo/number","./formatVariable"],function(e,a,l,s,t,i,r,n,o,d,c,h){r=r.geoenrichment.dijit.RelatedVariables;var b=e("esri.dijit.geoenrichment.RelatedVariables",a,{baseClass:"Infographics_RelatedVariables",_calculate:function(){for(var e,a,l=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,o=[],d=this.getDataFields(),h=0;h<d.length;h++){var b,u=this.getFieldByIndex(d[h]),m=this.getValueByName(0,u.name);b=this._state.selectedComparison>=0?c.round(m-this.getValueByName(this._getComparisonRow(),u.name),u.decimals||0):Number.NaN,b>t&&(t=b),i>b&&(i=b);var g=[];g.push(h),g.push(u.alias),g.push(m),g.push(b),o.push(g),m>l&&(l=m,e=d[h]),s>m&&(s=m,a=d[h]),m>r&&(r=m),n>m&&(n=m)}return this._sortRows(o),{rows:o,indexes:d,minDif:i,maxDif:t,minPct:n,maxPct:r,highCol:e,lowCol:a,lowValue:s,highValue:l}},updateUIExpanded:function(){this.inherited(arguments);var e,a,s=this._calculate(),o=Math.max(Math.abs(s.minDif),Math.abs(s.maxDif)),c=1;for(a=this.table.rows.length;a<s.indexes.length+c;a++){e=this.table.insertRow(-1),a>0&&a%2===0&&(e.className="AlternatingRow"),t.set(e.insertCell(-1),"class","RelatedVariables_TextColumn"),t.set(e.insertCell(-1),"class","RelatedVariables_ValueColumn"),e.insertCell(-1);var b;b=e.insertCell(-1),t.set(b,"class","RelatedVariables_ChartNegative"),t.set(b,"style","padding: 0;"),b=e.insertCell(-1),t.set(b,"class","RelatedVariables_ChartPositive"),t.set(b,"style","padding: 0;")}for(;this.table.rows.length>s.indexes.length+c;)this.table.deleteRow(-1);var u,m;for(a=0;a<s.rows.length;a++){m=this.getFieldByIndex(s.indexes[s.rows[a][0]]),e=this.table.rows[a+c],e.cells[0].innerHTML=s.rows[a][1],e.cells[1].innerHTML=h(m,s.rows[a][2]);var g=s.rows[a][3];if(i.isNumber(g)){var _;_=g>0?"+"+h(m,g):0>g?"-"+h(m,-g):"0",e.cells[2].innerHTML=_,e.cells[2].className="RelatedVariables_DifferenceColumn",g>0?(n.add(e.cells[2],"RelatedVariables_DifferenceColumn_Positive"),u=l.pct(g/o),e.cells[3].innerHTML="",e.cells[4].innerHTML="<div class='RelatedVariables_PositiveBar' style='width:"+u+"' />"):0>g?(n.add(e.cells[2],"RelatedVariables_DifferenceColumn_Negative"),u=l.pct(-g/o),e.cells[3].innerHTML="<div class='RelatedVariables_NegativeBar' style='width:"+u+"' />",e.cells[4].innerHTML=""):(e.cells[3].innerHTML="",e.cells[4].innerHTML="")}else e.cells[2].innerHTML="",e.cells[3].innerHTML="",e.cells[4].innerHTML=""}m=this.getFieldByIndex(s.highCol),this.highLabel.innerHTML=d.substitute(r.highLabel2,{alias:m.alias})+" ("+h(m,s.highValue)+")",m=this.getFieldByIndex(s.lowCol),this.lowLabel.innerHTML=d.substitute(r.lowLabel2,{alias:m.alias})+" ("+h(m,s.lowValue)+")"},updateUICollapsed:function(){this.inherited(arguments);var e,a,l=this._calculate(),s=1;for(a=this.table.rows.length;a<l.indexes.length+s;a++)e=this.table.insertRow(-1),a>0&&a%2===0&&(e.className="AlternatingRow"),t.set(e.insertCell(-1),"class","RelatedVariables_TextColumn"),t.set(e.insertCell(-1),"class","RelatedVariables_ValueColumn");for(;this.table.rows.length>l.indexes.length+s;)this.table.deleteRow(-1);for(a=0;a<l.rows.length;a++){var i=this.getFieldByIndex(l.indexes[l.rows[a][0]]);e=this.table.rows[a+s],e.cells[0].innerHTML=l.rows[a][1],e.cells[1].innerHTML=h(i,l.rows[a][2]),n.remove(e.cells[1],"MaxPct"),n.remove(e.cells[1],"MinPct"),l.rows[a][2]==l.maxPct&&n.add(e.cells[1],"MaxPct"),l.rows[a][2]==l.minPct&&n.add(e.cells[1],"MinPct")}},createUIExpanded:function(e){this.inherited(arguments);var a=e.addHeader("div",{"class":"RelatedVariables_Labels"});this.highLabel=s.create("div",{"class":"RelatedVariables_HighLabel"},a),this.lowLabel=s.create("div",{"class":"RelatedVariables_LowLabel"},a),this.table=e.addContent("table",{"class":"RelatedVariables_Table",cellpadding:"2",cellspacing:"0"}),l.createCols(this.table,[.35,.15,.15,.175,.175]);var t=this.table.insertRow(0);this._appendSortHeader(t,r.indicatorCol,0,{"class":"RelatedVariables_ColumnHeader"}),this._appendSortHeader(t,r.valueCol,2,{"class":"RelatedVariables_ColumnHeader"}),this._appendSortHeader(t,r.difCol,3,{"class":"RelatedVariables_ColumnHeader",colspan:"3"});var i=e.addFooter("div",{"class":"RelatedVariables_ComparisonDiv"});s.create("div",{"class":"RelatedVariables_ComparisonLabel",innerHTML:r.chartLabel},i),this._createComboBox(i)},createUICollapsed:function(e){this.inherited(arguments),this.table=e.addContent("table",{"class":"RelatedVariables_Table",cellpadding:"2",cellspacing:"0"}),l.createCols(this.table,[.7,.3]);var a=this.table.insertRow(0);this._appendSortHeader(a,r.indicatorCol,0,{"class":"RelatedVariables_ColumnHeader"}),this._appendSortHeader(a,r.valueCol,2,{"class":"RelatedVariables_ColumnHeader"})}});return b});