// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.

define(["../../declare","require","dojo/_base/lang","./BaseSelectComparison","dojo/dom-construct","dojo/number","dojo/dom-class","./utils","./theme","dojox/charting/Chart","dojox/charting/axis2d/Default","dojox/charting/plot2d/Bars","dojox/charting/plot2d/Lines","dojox/charting/action2d/Tooltip","dojox/charting/action2d/Highlight","dojox/charting/SimpleTheme","dojo/i18n!../../nls/jsapi"],function(e,t,i,a,s,n,r,h,l,d,m,o,c,g,u,_,p){p=p.geoenrichment.dijit.AgePyramid;var x="lines",I="bars",f=e("esri.dijit.geoenrichment.AgePyramid",a,{baseClass:"Infographics_AgePyramid",chart:null,_currentTheme:null,_themeChangeHandle:null,updateUI:function(){this.inherited(arguments),this._themeChangeHandle||(this._themeChangeHandle=l.on("change",i.hitch(this,this._onThemeChange))),this._currentTheme?this._doUpdateUI():l.load("AgePyramid").then(i.hitch(this,this._onThemeLoad))},_onThemeChange:function(){this._currentTheme=null,this._destroyChart(),this.updateUI()},_onThemeLoad:function(e){this._currentTheme=e,this._currentTheme.theme=new _(e.theme),this._doUpdateUI()},_doUpdateUI:function(){this.ensureChart();var e=this.getDataFields();this.maleIndices=[],this.femaleIndices=[];for(var t,a,s=e.length/2,n=Number.NEGATIVE_INFINITY,l=Number.POSITIVE_INFINITY,d=!0,o=!0,c=0;c<e.length;c++){var g=s>c;g?this.maleIndices.push(e[c]):this.femaleIndices.push(e[c]);var u=this.getValueByIndex(0,e[c]);u>n?(n=u,t=this.getFieldByIndex(e[c]).alias,d=g):l>u&&(l=u,a=this.getFieldByIndex(e[c]).alias,o=g)}var _,p,x=this.setSeriesData(this.chart.getSeries("male_bars"),0,this.maleIndices,-1),I=this.setSeriesData(this.chart.getSeries("female_bars"),0,this.femaleIndices,1);if(this.expanded){var f=this._getComparisonRow();_=this.setSeriesData(this.chart.getSeries("male_lines"),f,this.maleIndices,-1),p=this.setSeriesData(this.chart.getSeries("female_lines"),f,this.femaleIndices,1)}else this.chart.getSeries("male_lines").update([]),this.chart.getSeries("female_lines").update([]),_=Number.NEGATIVE_INFINITY,p=Number.NEGATIVE_INFINITY;this.extreme=h.getCeiling(Math.max(x,I,_,p),!0),this.chart.removeAxis("y"),this.chart.addAxis("y",{type:m,min:-this.extreme,max:this.extreme,minorTicks:!1,labelFunc:i.hitch(this,this.getAxisLabel)}),this.chart.render(),this.expanded&&(d?r.replace(this.max,"AgePyramid_TextMale","AgePyramid_TextFemale"):r.replace(this.max,"AgePyramid_TextFemale","AgePyramid_TextMale"),o?r.replace(this.min,"AgePyramid_TextMale","AgePyramid_TextFemale"):r.replace(this.min,"AgePyramid_TextFemale","AgePyramid_TextMale"),this.max.innerHTML=t,this.min.innerHTML=a)},getAxisLabel:function(e,t,i){return t=Math.abs(t),t!=this.extreme?n.format(t,{places:0}):n.format(t/100,{places:0,type:"percent"})},resize:function(){this.inherited(arguments),this.chart&&this.chart.resize()},ensureChart:function(){if(!this.chart){var e=this._currentTheme,t=this.chart=new d(this.chartDiv);t.setTheme(e.theme),t.addPlot(x,{type:c,markers:!0}),t.addPlot(I,{type:o,gap:this.expanded?1.5:1}),t.addSeries("male_bars",[],i.mixin({plot:I},e.male)),t.addSeries("female_bars",[],i.mixin({plot:I},e.female)),t.addSeries("male_lines",[],i.mixin({plot:x},e.line)),t.addSeries("female_lines",[],i.mixin({plot:x},e.line));var a={text:i.hitch(this,this.getTooltip)};new g(t,I,a),new g(t,x,a),new u(t,I,{duration:1}),new u(t,x,{duration:1,highlight:e.highlight})}},getTooltip:function(e){var t,i,a=this._currentTheme;switch(e.run.name){case"male_bars":t=this.maleIndices[e.index],i=0;break;case"female_bars":t=this.femaleIndices[e.index],i=0;break;case"male_lines":t=this.maleIndices[e.index],i=this._getComparisonRow();break;case"female_lines":t=this.femaleIndices[e.index],i=this._getComparisonRow();break;default:return""}var s=this.getFeatureTitle(i),r=this.getFieldByIndex(t).alias,h=n.format(this.getValueByIndex(i,t),{places:0}),l=e.plot.name===x?e.x:e.y,d=n.format(Math.abs(l)/100,{places:1,type:"percent"});return"<div class='AgePyramid_Tooltip_Content'><span style='font:"+a.font+"; color:"+a.color+";'><b>"+s+"</b > <br / > "+r+"<br/>"+h+" ("+d+")</span></div>"},setSeriesData:function(e,t,i,a){var s,n,r=[],h=0;for(s=0;s<i.length;s++)n=this.getValueByIndex(t,i[s]),r.push(n),h+=n;var l=Number.NEGATIVE_INFINITY;for(s=0;s<i.length;s++)n=r[s]/h*100,r[s]=n*a,n>l&&(l=n);if(e.plot===x)for(s=0;s<r.length;s++)r[s]={x:r[s],y:s+1};return e.update(r),l},createUI:function(e){this.inherited(arguments),e.contentClass.push("AgePyramid_ContentPane"),this.chartDiv=e.addContent("div",{"class":"AgePyramid_Chart"})},createUIExpanded:function(e){this.inherited(arguments);var t=e.addContent("div",{"class":"AgePyramid_MinMax"});s.create("div",{innerHTML:p.maxLabel},t),this.max=s.create("div",{"class":"AgePyramid_Text"},t),s.create("div",{"class":"AgePyramid_MinLabel",innerHTML:p.minLabel},t),this.min=s.create("div",{"class":"AgePyramid_Text"},t);var i=e.addContent("div",{"class":"AgePyramid_Comparison"});s.create("div",{"class":"AgePyramid_ComparisonLabel",innerHTML:p.compLabel},i),this._createComboBox(i)},createUICollapsed:function(e){this.inherited(arguments),s.create("div",{"class":"MenLabel",innerHTML:p.menLabel},this.chartDiv),s.create("div",{"class":"WomenLabel",innerHTML:p.womenLabel},this.chartDiv)},destroy:function(){this._destroyChart(),this._themeChangeHandle&&(this._themeChangeHandle.remove(),this._themeChangeHandle=null),this.inherited(arguments)},_destroyChart:function(){this.chart&&(this.chart.destroy(),this.chart=null)}});return f});