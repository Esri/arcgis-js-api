// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.40/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/Deferred","dojo/request/xhr","dojo/io-query","dojo/sniff","esri/dijit/geoenrichment/when","esri/kernel","esri/config","esri/lang","esri/urlUtils","../UrlUtil","./BinaryData","./FileContent","./MultipartDataBuilder","./ErrorUtil"],(function(e,t,n,r,o,i,s,l,a,u,d,h,f,p,c){var m=0,v=o("safari");function y(e,t){if(t)this.reject(t);else{var n=e.xhr,r=n.getResponseHeader&&n.getResponseHeader("Content-Type");e.status=n.status,e.data=new h(n.response||n.responseBody||n.responseText,r),this.resolve(e)}}var g=function(t){"string"==typeof t?this.url=t:"object"==typeof t&&e.mixin(this,t)};g.prototype={url:null,preventCache:null,usePost:!1,timeout:0,multipartThreshold:0,useCommonAuth:!1,useProxy:!1,allowSSL:null,send:function(e,t){return this.sendUrlRequest(this.prepareUrlRequest(e,t),"UniversalClient.send")},prepareUrlRequest:function(t,n){"string"==typeof t?t={urlSuffix:t}:t||(t={}),n||(n={});var o=t.url||this.url,i=t.urlSuffix;if(o||(o=i,i=null),!o)throw new Error("URL is missing.");var s=u.urlToObject(o);o=d.combine(s.path,i);var h=s.query||{};"object"==typeof n.content&&(h=e.mixin(h,n.content));var c=n.requireSSL;!0!==c&&!1===this.allowSSL&&(c=!1),!1!==c&&!0===this.allowSSL&&/^https/i.test(window.location.protocol)&&(c=!0);var y=this.getCredential(o,!0);y&&(h.token||!1===h.token||(h.token=y.token),y.ssl&&!1!==c&&(c=!0)),!0===c&&(o=d.toHttpsUrl(o)),!1===h.token&&delete h.token;var g=n.handleAs||"json";"json"===g&&(h.f="json");var w=(n.sendAs||(n.usePost||this.usePost||h.token?"post":"get")).toLowerCase(),C="multipart"==w||!n.sendAs&&!n.sizeLimit&&null,j=0,x=n.multipartThreshold||this.multipartThreshold;for(var k in h){var T=h[k];if(T instanceof f)C=!0;else{var E=0,L=k.length;"object"==typeof T?n.allowMultipleValues&&Array.isArray(T)?h[k]=T.map((function(e){var t="object"==typeof e?JSON.stringify(e):e;return E+=L+t+2,t})):(h[k]=JSON.stringify(T),E+=L+h[k].length+2):E=L+(T?T.length:0)+2,!C&&x>0&&(j+=E)}}if(!1!==C&&x>0&&j>x&&(C=!0),n.useProxy||!u.hasSameOrigin(o,window.location.href)&&this.useProxy&&!n.hasOwnProperty("useProxy")){var S=d.getProxyUrl();S&&(o=S+"?"+o)}else u.getProxyRule(o)&&(o=u.getProxyRule(o).proxyUrl+"?"+o);var U=n.hasOwnProperty("preventCache")?n.preventCache:this.preventCache;U=U||null===U&&S||v?"_ts="+(new Date).getTime()+m++:"";var A={handleAs:g},b=Number(a.isDefined(n.timeout)?n.timeout:this.timeout);b&&(A.timeout=b);var P="get"!==w||C,R=C?null:r.objectToQuery(h);if(P||(P=R.length+o.length+U.length+1>=l.defaults.io.postLength),A.method=P?"POST":"GET",A.headers={"X-Requested-With":null},A.headers["Content-Type"]=void 0!==n.contentType?n.contentType:"application/x-www-form-urlencoded; charset=utf-8",C){var q=new p;q.addVariables(h),q.build(A)}else P?A.data=R:R&&(o+="?"+R,U&&(o+="&"+U),U=null);return!R&&U&&(o+="?"+U),{url:o,options:A,sizeLimit:n.sizeLimit}},getCredential:function(e,t){if(s.id){var n=s.id.findCredential(e);if(!n&&this.useCommonAuth&&(n="string"==typeof this.useCommonAuth?s.id.findCredential(this.useCommonAuth):s.id.credentials[0]),n){var r={token:n.token};return t?r.ssl=n.ssl:r.url=n.ssl?d.toHttpsUrl(e):e,r}}},sendUrlRequest:function(e,r){var o="string"==typeof e.options.data?e.options.data.length:null;if(e.sizeLimit&&o&&("function"==typeof e.sizeLimit?e.sizeLimit(o):o>e.sizeLimit))return(new t).reject(new Error("SIZE_LIMIT_EXCEEDED"));r=r||"UniversalClient.sendUrlRequest";var s=e.deferred||new t,l="bin"===e.options.handleAs;l&&(e.options.handleAs="blob");var a=n(e.url,e.options,!0);l&&(a.handleResponse=y);var u=this;return a.then((function(t){var n;(t="json"===e.options.handleAs&&t&&c.parseError(t)||t)instanceof Error?(!0===u.useCommonAuth&&498===t.code&&(n=g.handleInvalidTokenError(t)),i(n).finally((function(){s.reject(t)}))):s.resolve(u._makeResponse(r,t))}),(function(e){s.reject(c.makeError(e))})),s.promise},requestToUrl:function(e){if(e.options.headers&&e.options.headers["Content-Type"]&&0==e.options.headers["Content-Type"].indexOf("multipart/form-data"))return null;var t=e.url,n=e.options.data;if(n){if(t.length+n.length>=l.defaults.io.postLength)return null;t+="?"+n}return t},_makeResponse:function(e,t){return t}},g.makeError=c.makeError,g.handleInvalidTokenError=function(e){};var w=new g({useCommonAuth:!0,allowSSL:!0});return g.request=function(n,r){return w.send(n,r).otherwise((function(o){var i=r&&r.content&&r.content.token;return 498!==o.code||null!=i?(new t).reject(o):((r=e.mixin({},r)).content=e.mixin({},r.content),r.content.token=!1,w.send(n,r))}))},g.requestPublicFirst=function(n,r,o){var i=e.mixin({},r);return i.content=e.mixin({},r.content),i.content.token=!1,w.send(n,i).otherwise((function(e){return o&&o.retryOnAnyError||499===e.code||403===e.code?w.send(n,r):(new t).reject(e)}))},g}));