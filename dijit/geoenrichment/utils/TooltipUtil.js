// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/on","dojo/mouse","dojo/sniff","dijit/Tooltip","dijit/place","dojox/gfx","./DeviceUtil","./DnDUtil","./DomUtil","./MouseUtil","esri/dijit/geoenrichment/ReportPlayer/config","dojo/domReady!"],(function(o,e,t,i,s,n,l,r,a,d,c,u,h,p,T,y,f){var v={};function m(){}var N,_,M=o(d._MasterTooltip,{_customClasses:null,_customStyle:null,_orientKey:null,addCustomClasses:function(o){o&&(t.add(this.domNode,o),this._customClasses=o)},setCustomStyle:function(o){this._customStyle=o},show:function(o,t,s,n,l,r,a){if(!this.aroundNode||this.aroundNode!==t||this.containerNode.innerHTML!=o)if("playing"!=this.fadeOut.status()){"string"==typeof o?this.containerNode.innerHTML=o:(this.containerNode.innerHTML="",i.place(o.domNode||o,this.containerNode)),l&&this.set("textDir",l),this.containerNode.align=n?"right":"left";var u=c.around(this.domNode,t,s&&s.length?s:d.defaultPosition,!n,e.hitch(this,"orient")),h=u.aroundNodePos;"M"==u.corner.charAt(0)&&"M"==u.aroundCorner.charAt(0)?(this.connectorNode.style.top=h.y+(h.h-this.connectorNode.offsetHeight>>1)-u.y+"px",this.connectorNode.style.left=""):"M"==u.corner.charAt(1)&&"M"==u.aroundCorner.charAt(1)?this.connectorNode.style.left=h.x+(h.w-this.connectorNode.offsetWidth>>1)-u.x+"px":(this.connectorNode.style.left="",this.connectorNode.style.top=""),this._drawBackground(),this.domNode.style.opacity="0",this.fadeIn.play(),this.isShowingNow=!0,this.aroundNode=t,this.onMouseEnter=r||m,this.onMouseLeave=a||m}else this._onDeck=arguments},orient:function(o,e,t,i,n){this.connectorNode.style.top="";var l=i.h,r=i.w;o.className="dijitTooltip "+{"MR-ML":"dijitTooltipRight","ML-MR":"dijitTooltipLeft","TM-BM":"dijitTooltipAbove","BM-TM":"dijitTooltipBelow","BL-TL":"dijitTooltipBelow dijitTooltipABLeft","TL-BL":"dijitTooltipAbove dijitTooltipABLeft","BR-TR":"dijitTooltipBelow dijitTooltipABRight","TR-BR":"dijitTooltipAbove dijitTooltipABRight","BR-BL":"dijitTooltipRight","BL-BR":"dijitTooltipLeft"}[this._orientKey=e+"-"+t],this.addCustomClasses(this._customClasses),this.domNode.style.width="auto";var d=s.position(this.domNode);d.w=Math.ceil(d.w),(a("ie")||a("trident"))&&(d.w+=2);var c=Math.min(Math.max(r,1),d.w);if(s.setMarginBox(this.domNode,{w:c}),"B"==t.charAt(0)&&"B"==e.charAt(0)){var u=s.position(o),h=this.connectorNode.offsetHeight;if(u.h>l){var p=l-(n.h+h>>1);this.connectorNode.style.top=p+"px",this.connectorNode.style.bottom=""}else this.connectorNode.style.bottom=Math.min(Math.max(n.h/2-h/2,0),u.h-h)+"px",this.connectorNode.style.top=""}else this.connectorNode.style.top="",this.connectorNode.style.bottom="";return this._drawBackground(),Math.max(0,d.w-r)},_surface:null,_surfaceContainer:null,_drawBackground:function(){if(this._orientKey){var o=this.domNode.clientWidth,e=this.domNode.clientHeight,t=s.position(this.domNode),n=s.position(this.connectorNode),l=s.position(this.containerNode);n.x-=t.x,n.y-=t.y,l.x-=t.x,l.y-=t.y,l.x+=1,l.y+=1,l.w-=2,l.h-=2,this._surface&&this._surface.destroy(),this._surfaceContainer&&i.destroy(this._surfaceContainer);var r=this._surfaceContainer=i.create("div",{class:"esriGEAbsoluteStretched"},this.domNode,"first");r.style.pointerEvents="none";var a=this._surface=u.createSurface(r,o,e),d=[{x:l.x,y:l.y},{x:l.x+l.w,y:l.y},{x:l.x+l.w,y:l.y+l.h},{x:l.x,y:l.y+l.h},{x:l.x,y:l.y}],c=n.x+n.w/2,h=n.y+n.h/2;switch(this._orientKey){case"BL-TL":case"BM-TM":case"BR-TR":var p=[{x:c-5,y:l.y},{x:c,y:h},{x:c+5,y:l.y}];d.splice.apply(d,[1,0].concat(p));break;case"ML-MR":case"BL-BR":p=[{x:l.x+l.w,y:h-5},{x:c,y:h},{x:l.x+l.w,y:h+5}];d.splice.apply(d,[2,0].concat(p));break;case"TM-BM":case"TL-BL":case"TR-BR":p=[{x:c+5,y:l.y+l.h},{x:c,y:h},{x:c-5,y:l.y+l.h}];d.splice.apply(d,[3,0].concat(p));break;case"MR-ML":case"BR-BL":p=[{x:l.x,y:h+5},{x:c,y:h},{x:l.x,y:h-5}];d.splice.apply(d,[4,0].concat(p))}var T=a.createPolyline(d),y="function"==typeof this._customStyle?this._customStyle():this._customStyle,f=y&&y.backgroundColor||"white";T.setFill(f).setStroke({color:"#d3d3d3",width:1,join:"round"}),y&&y.color&&(this.containerNode.style.color=y.color)}}}),x=function(o,e,t,i,s){"string"==typeof t&&(t=[t]),t=t&&t.map((function(o){return{after:"after-centered",before:"before-centered"}[o]||o}));var n=new M;return s&&n.setCustomStyle(s),n.addCustomClasses(i),n.show(o,e,t),n};return v.setTooltipToNode=function(o,e,t){if(t=t||{},o&&!f.isPlayerOnServer&&(v.hideTooltipForNode(o),o.__setTooltipToNodeMouseEnterHandle&&o.__setTooltipToNodeMouseEnterHandle.remove(),e)){var i=!1;return h.isMobileDevice()?o.__setTooltipToNodeMouseEnterHandle=p.addNoDragClickHandler(o,s):o.__setTooltipToNodeMouseEnterHandle=l(o,r.enter,s),t.showTooltip&&s(),{remove:function(){e=null,v.hideTooltipForNode(o)},suspend:function(){v.hideTooltipForNode(o),i=!0},resume:function(){i=!1},refresh:function(){o._shownTooltip&&s()}}}function s(){!i&&v.showTooltipForNode(o,e,t)}},v.showTooltipForNode=function(o,e,i){if(i=i||{},o&&!f.isPlayerOnServer){v.hideTooltipForNode(o);var s="function"==typeof e?e():e;if(s){var n;i.textAlign&&(s="<div class='"+("start"===i.textAlign?"esriGEStart":"end"===i.textAlign?"esriGEEnd":"")+"'>"+s+"</div>"),t.add(o,"esriGESimpleTextTooltip"),d();var a=v.hideTooltipForNode.bind(v,o);return h.isMobileDevice()?o.__setTooltipToNodeMouseLeaveHandle=l(document.body,"touchstart",(function(e){y.isMouseOver(o,{event:e})||a()})):o.__setTooltipToNodeMouseLeaveHandle=l.once(o,r.leave,(function(){!i.stayOnHover&&a()})),i.ignoreNodeRemoval||(o.__setTooltipToNodeInLayoutHandle=setInterval((function(){!T.isNodeInLayout(o)&&a()}),300)),h.isMobileDevice()||(o.__setTooltipToNodeMouseOverHandle=setInterval((function(){(!i.stayOnHover||!y.isMouseOver(n.domNode))&&!y.isMouseOver(o)&&a()}),300),o.__setTooltipToNodeClickHandle=l(o,"click",(function(e){i.hideOnClick?a():!o._shownTooltip&&d()})),i.stayOnHover&&(o.__setTooltipToNodeMouseLeaveMasterHandle=l(n.domNode,r.leave,a))),o._shownTooltip}}function d(){v.hideTooltipForNode(o);var e=Array.isArray(i.classes)?i.classes.join(" "):i.classes;e=(e||"")+" esriGETooltip",i.notRestricted&&(e+=" notRestricted"),o._shownTooltip=n=x(s,o,i.position||["after","before"],e,i.style)}},v.isShown=function(o){return!(!o||!o._shownTooltip)},v.hideTooltipForNode=function(o){o&&(o.title="",t.remove(o,"esriGESimpleTextTooltip"),o._shownTooltip&&o._shownTooltip.destroy(),delete o._shownTooltip,o.__setTooltipToNodeMouseLeaveHandle&&o.__setTooltipToNodeMouseLeaveHandle.remove(),clearInterval(o.__setTooltipToNodeInLayoutHandle),clearInterval(o.__setTooltipToNodeMouseOverHandle),o.__setTooltipToNodeClickHandle&&o.__setTooltipToNodeClickHandle.remove(),o.__setTooltipToNodeMouseLeaveMasterHandle&&o.__setTooltipToNodeMouseLeaveMasterHandle.remove())},v.autoTooltip=function(o){f.isPlayerOnServer||l(o,".TrimWithEllipses:mouseover",(function(){if(this!==N&&this.offsetWidth<this.scrollWidth){var o=function(){N=null,_&&(_.tooltip.destroy(),_.mouseOutH.remove(),_.mouseMoveH.remove(),_=null)};o(),_={tooltip:x((N=this).textContent,N,["above","below"]),mouseOutH:l.once(N,"mouseout, mousedown, touchstart",o),mouseMoveH:l(document.body,"mousemove",(function(){y.isMouseOver(N)||o()}))}}}))},v.showClosableTooltip=function(o){var e=v._createClosableTooltip(o.message,o.tooltipClass,o.position);return v._placeClosableTooltip(e,o.node,o.timeout,o.position,o.onClosed)},v.removeClosableTooltip=function(o){o&&o._removeFunc&&o._removeFunc()},v._createClosableTooltip=function(o,e,s){var n,l,r=i.create("div",{class:"esriGEClosableTooltip esriGENonSelectable "+(e||"")},document.body);function a(){var o=i.create("div",{class:"esriGEClosableTooltipTip"},r);t.add(o,"right"===s?"esriGEClosableTooltipTipRight":"esriGEClosableTooltipTipLeft")}function d(){n=i.create("div",{class:"esriGEClosableTooltipBody"},r),i.create("div",{innerHTML:o,class:"esriGEClosableTooltipLabel"},n),l=i.create("div",{class:"esriGEClosableTooltipCloseButton"},n)}return"right"!==s?(d(),a()):(a(),d()),r.style.position="fixed",{tooltip:r,body:n,closeButton:l}},v._placeClosableTooltip=function(o,e,t,i,r){var a,d,c,u,h,p,y="rtl"===document.dir&&"right"!==i||"rtl"!==document.dir&&"right"===i;function f(){var t=s.position(e),i=t.x+";"+t.y+";"+t.w+";"+t.h;if(i!==a){a=i;var l=s.getMarginBox(o.tooltip);n.set(o.tooltip,{left:(y?t.x+t.w:t.x-l.w)+"px",top:t.y+t.h/2-l.h/2+"px"})}}f();var v=function(){d&&clearTimeout(d),c&&clearInterval(c),u&&clearInterval(u),h&&h.remove(),o.tooltip.parentNode&&o.tooltip.parentNode.removeChild(o.tooltip)};return c=setInterval((function(){T.isNodeInLayout(e)&&e.parentNode||(p=!1,v()),T.isNodeVisible(e)&&T.isNodeOnscreen(e)?(p=!0,T.show(o.tooltip)):(p=!1,T.hide(o.tooltip))}),0),u=setInterval((function(){p&&f()}),0),t&&(d=setTimeout(v,t)),h=l(o.closeButton,"click",(function(){v(),r&&r()})),o.tooltip._removeFunc=v,o.tooltip},v.showTooltipForNode(document.body,"Normal <b>Bold</b> <i>Italic</i>",{}),v.hideTooltipForNode(document.body),v}));