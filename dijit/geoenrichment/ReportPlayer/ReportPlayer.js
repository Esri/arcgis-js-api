// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/on","dojo/keys","dojo/dom-class","dijit/_WidgetBase","dijit/_TemplatedMixin","./config","./playerSupports/_CommandSupport","./playerSupports/_LogoSupport","./playerSupports/_MapSupport","./playerSupports/_PageNavigationSupport","./playerSupports/_PrintSupport","./playerSupports/_ReportContainersSwitcher","./playerSupports/_SmartLayoutSupport","./playerSupports/_ZoomSupport","./playerSupports/_WaitingSupport","./supportClasses/PlayerConfigurator","./supportClasses/PlayerToFullScreenAnimator","./printing/PageOptionsDialog/PageOptionsDialog","./PlayerToolbar","./ReportPlayerViewModel","./PlayerResizeModes","./PlayerThemes","./ReportPlayerState","./DataProviderGE","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/async/AsyncQueue","dojo/text!./templates/ReportPlayer.html","dojo/i18n!esri/nls/jsapi","./_devConfig"],function(e,t,i,r,o,n,a,s,l,h,d,p,u,_,g,c,f,D,m,y,C,w,v,P,A,S,R,T,b,M,I,E,F,L,z){return L=L.geoenrichment.dijit.ReportPlayer.ReportPlayer,e([s,l,d,p,u,g,c,f,D,_,m],{templateString:F,nls:L,dataProvider:null,exportCommands:null,config:null,theme:void 0,viewMode:void 0,enableDataDrilling:void 0,showDataDrillingInsidePanel:void 0,showToolbarInPopup:void 0,showAreaTitle:void 0,scaleSlidesToFitWindow:void 0,showCloseButton:!1,showToFullScreenAnimation:!1,allowAutoOrientation:!0,mobileLandscapeViewMode:void 0,resizeMode:void 0,renderMapsFromCalculators:!1,printConfig:{subtitle:L.preparedByEsri,printDialogClass:w},showProgressBar:!0,defaultZoomBehavior:void 0,isDataDrillingPlayer:!1,_viewModel:null,_reportData:null,_analysisAreaIndex:0,playerToolbar:null,postCreate:function(){this.config=t.mixin(h,this.config),this._viewModel=new(this._getViewModelClass()),this._setUpDataProvider(),y.configurePlayer(this),this._initToolbar(),this._initContainerSwither(),this._initSmartLayout(),this._initCommands(),this._initPageNavigationControls(),this._initZoomControls(),this._applyTheme(),this._showError(!1),this._initProgressController(),M.isMobileDevice()&&(a.add(this.domNode,"esriGEReportPlayerMobile"),this._setUpMobileOrientationHandling())},_setUpDataProvider:function(){this.dataProvider=this.dataProvider||new T,this.exportCommands&&this.exportCommands.forEach(function(e){this.dataProvider.registerCommand(e)},this)},_orientationDfd:null,_setUpMobileOrientationHandling:function(){var e=this;this.allowAutoOrientation&&this.own(o(window,"orientationchange",function(){e._orientationDfd&&e._orientationDfd.resolve("cancel");var t=e._orientationDfd=new i;e._showWaiting(t.promise),t.promise.then(function(t){"cancel"!==t&&(y.configurePlayer(e),e._refreshZoomControls(),e.refresh({rerenderContent:!0}))}),r(e.isContentLoading(),function(){b.delay(500).then(t.resolve,t.resolve)})}))},_getViewModelClass:function(){return P},_initToolbar:function(){var e=this;this.playerToolbar=new v({popupButtonDiv:this.playerAfterToolbarDiv,showToolbarInPopup:this.showToolbarInPopup,showAreaTitle:this.showAreaTitle,stretchToolbarNode:!this.showToolbarInPopup&&(this.resizeMode===A.FIT_WINDOW?document.body:this.domNode),showCloseButton:this.showCloseButton,isMobileDevice:M.isMobileDevice(),isScrollShown:function(){var t=e.getCurrentReportContainer();return t&&t.isScrollShown&&t.isScrollShown()},onClose:function(){e._onClose()}}).placeAt(this.playerToolbarDiv),this.own(this.playerToolbar),this.playerToolbar.onShowAnalysisAreaAt=function(t){e.showAnalysisAreaAt(t)},this.showCloseButton&&this.own(o(window,"keyup",function(e){this.getWaitingPromise()||R.isViewingDataDrillingZoom||e.keyCode===n.ESCAPE&&this._onClose()}.bind(this))),I.hide(this.playerToolbarDiv)},_applyTheme:function(){a.remove(this.domNode,"playerThemeDark playerThemeLight"),a.add(this.domNode,this.theme===S.DARK?"playerThemeDark":"playerThemeLight"),this.playerToolbar.setTheme(this.theme)},playReport:function(e,t){if(this.isContentLoading())return this.isContentLoading();I.show(this.playerToolbarDiv),this.playerToolbar.closePopup();var i=this;return this._showError(!1),this._progressController&&this._progressController.reset(),this.showToFullScreenAnimation&&this.resizeMode===A.FIT_WINDOW&&C.animateTo(this),this.dataProvider._onCreateReportStarted=function(){i._viewModel.preInitialize()},r(this._showWaiting(this.dataProvider.getReportData(e,function(e){i._progressController&&i._progressController.setLoadDataProgress(e)})),function(e){return i.setReportData(e,t)},function(e){i._showError(e)})},_isDataBeingSetFlag:!1,setReportData:function(e,t){if(this.isContentLoading())return this.isContentLoading();var r=this;if(t=t||{},this._reportData=e,!e)return void this._showError(!0);this._isDataBeingSetFlag=!0,R.isAnimationSuspended=!0,this.onSetReportDataStart();var o=new i;this._viewModel.animationAllowed=!t.disableAnimation,this._configureViewModel(e),b.delay(0).then(function(){function i(){if(n<0)return void o.resolve();r._applyReportData({analysisAreaIndex:n--,rerenderContent:!1}).then(function(){setTimeout(i,100)},o.reject)}if(1===e.analysisAreas.length||e.isMultiFeature)this._destroyAllContainers(),this._resetMapBuilder(),this._applyReportData({analysisAreaIndex:0,rerenderContent:!0}).then(o.resolve,o.reject);else{!1!==t._resetLoadedContents&&(this._destroyAllContainers(),this._resetMapBuilder());var n=e.analysisAreas.length-1;i()}}.bind(this)),this._progressController&&this._progressController.setNumAreas(e.analysisAreas.length),this._progressController&&this._progressController.setLoadDataProgress(1);var n=o.promise.then(function(){return r._progressController&&r._progressController.finalize()}).otherwise(function(e){r._showError(e)});return this._showWaiting(n),n.always(function(){var e=r.getCurrentReportContainer();if(e&&e.domNode)return a.add(e.domNode,"esriGEReportPlayer_fadeIn1000"),b.delay(1e3).then(function(){e.domNode&&a.remove(e.domNode,"esriGEReportPlayer_fadeIn1000")}),b.delay(300).then(function(){if(r._isDataBeingSetFlag=!1,R.isAnimationSuspended=!1,r.onSetReportDataEnd(),r._emitPendingResizedEvent(),e.notifyShown(),r._progressController&&r._progressController.reset(),t.waitUntilAllContentIsReady)return r.isContentLoading()})})},refresh:function(e){return this.isContentLoading()?this.isContentLoading():this._reportData&&r(this.setReportData(this._reportData,{waitUntilAllContentIsReady:!(!e||!e.waitUntilAllContentIsReady),_resetLoadedContents:!(!e||!e.rerenderContent)}),function(){return this.showPageAt(0),this.resize()}.bind(this))},showAnalysisAreaAt:function(e,t){if(this.isContentLoading())return this.isContentLoading();var i=this._applyReportData({analysisAreaIndex:e,rerenderContent:!(!t||!t.rerenderContent)});return t&&t.waitUntilAllContentIsReady?this.isContentLoading():i},_applyReportData:function(e){var t=this;e=e||{};var i=this._reportData&&this._reportData.isMultiFeature?0:e.analysisAreaIndex||0,o=!1!==e.rerenderContent;if(this._analysisAreaIndex=i,this._showError(!this._reportData),this._reportData)return r(this._viewModel.initialize(this._reportData.isClassic,this.viewMode),function(){return t.playerToolbar.updateAreaSelect(t._reportData.analysisAreas,t._reportData.combinedAreasInfo,t.getCurrentAnalysisAreaIndex(),t._reportData.isMultiFeature),r(t._setReportContainer(o),function(e){return e&&t._doApplyTemplateJson({analysisAreaIndex:i})})})},_doApplyTemplateJson:function(e){var t=this,i=this.getCurrentReportContainer(),o=i.fromJson(this._reportData.templateJson,{waitUntilAllContentIsReady:!0,progressCallback:function(i){t._progressController&&t._progressController.setProgressForAreaAt(i,e.analysisAreaIndex)}}),n=i.getPagePromise?i.getPagePromise():o,a=i.getContentPromise?i.getContentPromise():o;return this._registerContainerLoadPromise(a),r(n,function(){return this._setCurrentContainerLoaded(),this.showPageAt(this._currentPageIndex),this.resize()}.bind(this))},_loadQueue:null,isContentLoading:function(){return this._loadQueue&&this._loadQueue.getPromise()},_registerContainerLoadPromise:function(e){this._loadQueue=this._loadQueue||new E,this._loadQueue.add(e),this.playerToolbar.setContentLoadPromise(this.isContentLoading())},getReportData:function(){return this._reportData},reportDataToJson:function(e){return this.dataProvider.reportDataToJson(this.getReportData(),e)},reportDataFromJson:function(e,t){return r(this.dataProvider.reportDataFromJson(e),function(e){return this.setReportData(e,t)}.bind(this))},updateTemplateJson:function(e){this._reportData&&e&&(this._reportData.templateJson=e)},getReportTitle:function(){return this._reportData&&this._reportData.reportTitle||""},getCurrentAnalysisAreaIndex:function(){return this._analysisAreaIndex},getCurrentAnalysisArea:function(){return this._reportData&&this._reportData.analysisAreas[this._analysisAreaIndex]},getAnalysisAreas:function(){return this._reportData&&this._reportData.analysisAreas},_configureViewModel:function(e){var i=this;this._viewModel.setTheme(this._reportData.templateJson.theme),this._viewModel.enableDataDrilling=this.enableDataDrilling,this._viewModel.showDataDrillingInsidePanel=this.showDataDrillingInsidePanel,this._viewModel.setDynamicReportInfo({fieldData:this._reportData.fieldData,analysisAreas:this._reportData.analysisAreas,combinedAreasInfo:this._reportData.combinedAreasInfo,infographicOptions:this._reportData.infographicOptions,attachmentsStore:this._reportData.attachmentsStore,createMapFunc:t.hitch(this,this._createMap),reportType:this._reportData.reportType,isClassic:this._reportData.isClassic,isMultiFeature:this._reportData.isMultiFeature,isFixedDataMode:!this._reportData.config.geoenrichmentUrl,geClient:this._reportData.geClient,templateVariableProvider:this._reportData.templateVariableProvider,countryID:this._reportData.config.countryID,hierarchy:this._reportData.config.hierarchy}),this._viewModel.getDynamicImageFunc=t.hitch(this,this._getReportLogo),this._viewModel.enrichFieldData=function(e){return i.dataProvider.enrichFieldData(e,t.mixin({analysisAreas:i._reportData.analysisAreas,fieldData:i._reportData.fieldData},i._reportData.config))}},getNumberOfPages:function(){return this.getCurrentReportContainer().getNumberOfPages()},notifyShown:function(){this._isDataBeingSetFlag||this.getCurrentReportContainer()&&this.getCurrentReportContainer().notifyShown()},_isErrorShown:!1,_showError:function(e){z.emulateErrors.playerError&&(e=!0),I[e?"hide":"show"](this.printableDivContainer),I[e?"show":"hide"](this.errorViewDiv),a[e?"add":"remove"](this.domNode,"esriGEReportPlayerError"),this._isErrorShown=!!e,e&&I.hide(this.sidePageNavigator),this.playerToolbar.setErrorShown(!!e),e&&(this._progressController&&this._progressController.reset(),console.log(e),this.onError(e))},isErrorShown:function(){return this._isErrorShown},setPrintMode:function(e){a[e?"add":"remove"](this.domNode,"esriGEReportPlayerInPrinting")},resize:function(e,t){return r(this._resize({width:e,height:t}),function(){this._updatePageNavigator(),this._updateZoomControls(),this.playerToolbar.update()}.bind(this))},_pendingResizeEvent:null,_emitResizedEvent:function(e){this._pendingResizeEvent={isPaginating:!!e},this._isDataBeingSetFlag||this._emitPendingResizedEvent()},_emitPendingResizedEvent:function(){this._pendingResizeEvent&&(this.onResized(this._pendingResizeEvent.isPaginating),this._pendingResizeEvent=null)},_onClose:function(){var e;this.showToFullScreenAnimation&&this.resizeMode===A.FIT_WINDOW&&(e=C.animateFrom(this)),r(e,function(){this.onClose()}.bind(this))},onSetReportDataStart:function(){},onSetReportDataEnd:function(){},onResized:function(e){},onClose:function(){},onError:function(e){}})});