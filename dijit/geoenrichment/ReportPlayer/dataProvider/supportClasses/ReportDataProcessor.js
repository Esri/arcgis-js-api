// COPYRIGHT © 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.40/esri/copyright.txt for details.

define(["esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","./tasks/EnrichAreasTask","./tasks/RunReportTask","./data/AreaCalculatorsUtil","./data/VariablesUtil","./CustomReportsManager","./stdGeographies/StdGeographiesModel","esri/dijit/geoenrichment/utils/DateUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldLibrary","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil","../../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","../../core/supportClasses/templateJsonUtils/TemplateJsonAnalyzer","../../core/infographics/utils/InfographicJsonUtil","../../config","../../countryConfig"],(function(e,t,a,r,o,i,s,n,l,u,c,p,d,f,m,D,h){return{runReportAndGetData:function(e,r){return t([n.getCustomReportByID(e),r]).then((function(t){var r=t[0],i=t[1];return(new o).execute({portalUrl:e.portalUrl,analysisAreas:e.analysisAreas,countryID:e.countryID,hierarchy:e.hierarchy,report:{reportID:r.reportID,portalUrl:r.templateData.getPortalUrl(!0),modified:r.modified,isMultiFeature:r.isMultiFeature},attachmentsStore:i,cacheResult:D.runReportTask.cacheResult}).then((function(e){return{taskIDs:e.taskIDs,areaData:e.areaData,reportInfo:e.reportInfo}}),(function(t){return e.fieldData.errors.push(t),(new a).reject(t)}))}))},runReportFromVariables:function(e){var t={};return e.variables.fullNames.forEach((function(e){var a=p.createFieldNameFromSource(e);t[e.substr(e.indexOf(".")+1)]=a})),(new r).enrichAreas({portalUrl:e.portalUrl,analysisAreas:e.analysisAreas,countryID:e.countryID,hierarchy:e.hierarchy,fields:s.convertForEnrich(e.variables),comparisonLevels:e.comparisonLevels||m.getDefaultLevels()}).then((function(a){var r=e.analysisAreas.map((function(){return{}}));return i.addEnrichFeatures(a,t,p.DATA_COLLECTIONS_CALCULATOR_NAME,r),{areaData:r}}),(function(t){return e.fieldData.errors.push(t),(new a).reject(t)}))},applyRunReportAndGetDataResults:function(e,t){if(e&&e.areaData){var a=t.templateJson;return t.fieldData.specialTradeAreaCalculatorName=a.metadata&&a.metadata.specialTradeAreaCalculatorName,delete a.metadata,t.fieldData.runReportTaskIDs=e.taskIDs,t.fieldData.areaData=e.areaData,t.fieldData.reportInfo=e.reportInfo,e.reportInfo&&this._populateReportDataFromReportInfo(e.reportInfo,t),this._reportDataFromAreas(t.analysisAreas,t.fieldData.areaData),this._reportDataFromReport(t.reportObject,t.fieldData,t.combinedAreasInfo),this._populateReportDataFromAttachmentsStore(t)}},_populateReportDataFromReportInfo:function(e,t){if(t.reportTitle=t.reportObject.title=t.reportTitle||e.Title||e.Name||"",t.fieldData.metadata.Name=e.Name||t.reportTitle,e.country&&!h.getCurrentCountry()&&(h.setCountry(e.country),h.setHierarchyID(null)),e.stdLevels&&!h.getGeographiesModel()&&h.setGeographiesModel(new l({levels:e.stdLevels})),D.updateVariableInfoFromDataXml||D.isPlayerOnServer){var a=e.variables;d.processTemplateFieldInfos(t.templateJson,(function(e){if(e.hasVariable&&e.variableID&&e.templateName){var r=e.templateName.indexOf("."),o=e.templateName.substr(0,r),i=e.templateName.substr(r+1),s=a[o]&&a[o][i];if(s&&s.alias){e.alias=s.alias;var n=t.templateVariableProvider.get(e.templateName);n&&(n.alias=s.alias,s.vintage&&(n.vintage=s.vintage),s.source&&(n.source=s.source))}}}))}var r=f.collectVariablesStats(t.templateJson),o=t.templateVariableProvider.getVariablesDataVintageAndSources({usedVariablesCache:r});t.reportObject.dataVintageDescription=o.dataVintageDescription||t.reportObject.dataVintageDescription,t.reportObject.dataSources=o.dataSources||t.reportObject.dataSources,t.reportObject.dataVintage=o.dataVintage||t.reportObject.dataVintage},_populateReportDataFromAttachmentsStore:function(a){var r=a.attachmentsStore,o=[];return a.analysisAreas.forEach((function(t,s){r.supportsMultipleAreas&&r.setCurrentAnalysisAreaIndex(s),o.push(e(r.getNotes(),(function(e){if(e&&e.length){var t={attributes:{}};t.attributes[c.SITENOTES_FIELD_NAME]=e.map((function(e){return e.text})).join("<br/><br/>"),e.forEach((function(e,a){t.attributes[c.getSiteNoteFieldNameAt(a+1)]=e.text}));var r=a.fieldData.areaData[s];r&&i.addFeatureAttributesCalculator(t,r)}}))),o.push(e(r.getAttributes(),(function(e){if(!e||!e.length)return null;var t={attributes:{}};e.forEach((function(e){t.attributes[e.name]=e}));var r=a.fieldData.areaData[s];r&&i.addFeatureAttributesCalculator(t,r)})))})),t(o)},_reportDataFromAreas:function(e,t){e.forEach((function(e,a){var r=e.feature,o=t[a];o&&(i.addFeatureAttributesCalculator(r,o),i.addAreaInfoCalculator(e,o))}))},_reportDataFromReport:function(e,t,a){var r=t.metadata;e&&!r.Title&&(r.Title=e.title),r.Subtitle=t.reportInfo&&t.reportInfo.Subtitle||"",r.Source=r.Source||e.dataVintageDescription||"Esri",r.DataSources=r.DataSources||e.dataSources||"Esri",r.DataVintage=r.DataVintage||e.dataVintage||"",r.Date=u.getReportFooterDate(),r.Copyright="© "+u.getFullYear()+" Esri",r.ProductLabel="",r.ProductUrl="",r.PhoneNumber="",r.TrialUrlText="",e.isMultiFeature&&(r.SITE_NAME=a.locationName||a.name,r.STORE_NAME=a.locationName||a.name,r.AREA_DESC2=a.description||a.name,r.STORE_ADDR=a.address)}}}));