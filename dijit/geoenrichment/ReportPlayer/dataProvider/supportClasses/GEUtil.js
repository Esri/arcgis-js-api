// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","dojox/uuid/generateRandomUuid","esri/kernel","esri/request","esri/urlUtils","esri/dijit/geoenrichment/utils/requests/FileContent","esri/dijit/geoenrichment/utils/requests/UniversalClient","esri/dijit/geoenrichment/utils/UrlUtil","./stdGeographies/StdGeographiesModel"],function(t,e,n,r,i,s,o,a,u,c,l,h,f){function d(t){if(_)return _;var e=t&&o.id.findCredential(t)||o.id.credentials[0];return e&&e.token}function p(t,n){var r=u.urlToObject(t);n=e.mixin({f:"json",token:d(t),langCode:dojo.locale},r.query||{},n);for(var i in n){var s=n[i];s instanceof c||s&&"object"==typeof s&&(n[i]=JSON.stringify("function"==typeof s.toJson?s.toJson():s))}return{url:r.path,taskParams:n}}function m(t){return k||(k=new y(g)),!t||k.initialized?k:k.initialize()}var g,_,y=t(null,{url:null,_geInfo:null,_capabilities:null,_supportedOperations:null,constructor:function(t){this.url=t},_initDfd:null,initialized:!1,initialize:function(){var t=this;return this._initDfd?this._initDfd.promise:(this._initDfd=new n,l.requestPublicFirst(p(this.url).url+"/Geoenrichment",{content:{f:"json"},handleAs:"json"}).then(function(e){t.initWithJson(e)}),this._initDfd.promise)},initWithJson:function(t){this._geInfo=t,this._capabilities={},this._supportedOperations={},t.capabilities&&t.capabilities.forEach(function(t){this._capabilities[t.toLowerCase()]=!0},this),t.supportedOperations&&t.supportedOperations.forEach(function(t){this._supportedOperations[t.toLowerCase()]=!0},this),this._initDfd=this._initDfd||new n,this._initDfd.resolve(),this.initialized=!0},hasCapability:function(t){return this._capabilities[t.toLowerCase()]},supportsOperation:function(t){return this._supportedOperations[t.toLowerCase()]},enrich:function(t){var e=p(this.url,t);return e.taskParams.AddDerivativeVariables="all",a({url:e.url+"/Geoenrichment/Enrich",content:e.taskParams,handleAs:"json"}).then(function(t){return t.results[0].value.FeatureSet||[]})},stdGeographyQuery:function(t){var e=p(this.url,t);return a({url:e.url+"/StandardGeographyQuery/execute",content:e.taskParams,handleAs:"json"}).then(function(t){return t.results[0].value.features||[]})},getDataCollections:function(t,e,n){var r=p(this.url,n);return a({url:r.url+"/Geoenrichment/DataCollections/"+t+(e?"/"+e:""),content:r.taskParams,handleAs:"json"}).then(function(t){return t.DataCollections})},_contriesCache:{},getCountries:function(){var t=p(this.url);return a({url:t.url+"/Geoenrichment/Countries",content:t.taskParams,handleAs:"json"}).then(function(t){return t.countries})},getCountryInfo:function(t){var e=this;if(!this._contriesCache[t]){var n=p(this.url);this._contriesCache[t]=a({url:n.url+"/Geoenrichment/Countries/"+t,content:n.taskParams,handleAs:"json"}).then(function(n){var s=n.countries[0],o={};return i(s.hierarchies.map(function(n){return r(e._getStdGeographyModel(t,n.ID),function(t){o[n.ID]=t})})).then(function(){return{country:s,geographiesModels:o}})})}return this._contriesCache[t]},_stdModelCache:null,_getStdGeographyModel:function(t,e){e=e||"census",this._stdModelCache=this._stdModelCache||{};var n=t+e;if(!this._stdModelCache[n]){var r=p(this.url);this._stdModelCache[n]=a({url:r.url+"/Geoenrichment/StandardGeographyLevels/"+t+"/"+e,content:r.taskParams,handleAs:"json"}).then(function(n){return new f({countryID:t,hierarchyID:e,levels:n.geographyLevels[0].hierarchies[0].levels})})}return this._stdModelCache[n]},formatReport:function(t){var e=p(this.url,t);return l.request({url:e.url,urlSuffix:"Geoenrichment/FormatReport"},{handleAs:"bin",content:e.taskParams}).then(function(t){return t&&t.data&&"text/plain"===t.data.type?null:t})},getReports:function(t){var e=p(this.url);return a({url:e.url+"/Geoenrichment/reports/"+t,content:e.taskParams,handleAs:"json"}).then(function(t){return t.reports})},_tasksHash:{},createReport:function(t){var n=p(this.url,t),r=s();return this._tasksHash[r]={taskName:"createReport",taskParams:e.clone(t)},l.request({url:n.url,urlSuffix:"Geoenrichment/createReport"},{handleAs:"xml"===t.format?"text":"bin",content:n.taskParams}).then(function(t){return{taskID:r,result:t}})},consumeCredits:function(t){var n=this._tasksHash[t];if(n)return n=e.clone(n),delete n.taskParams.forStorage,this[n.taskName](n.taskParams)},_dataLayersCache:{},getLayerInfos:function(t){return this._dataLayersCache[t]||(this._dataLayersCache[t]=this._getLayerInfos(t)),this._dataLayersCache[t]},_getLayerInfos:function(t){var e=p(this.url);return a({url:e.url+"/Geoenrichment/DataLayers/"+t,content:e.taskParams,handleAs:"json"}).then(function(t){return t&&t.layers||[]}).otherwise(function(t){return console.log(t),[]})},getLayerInfo:function(t,e){var n=t+"_"+e;return this._dataLayersCache[n]||(this._dataLayersCache[n]=this._getLayerInfo(t,e)),this._dataLayersCache[n]},_getLayerInfo:function(t,e){var n=p(this.url);return a({url:n.url+"/Geoenrichment/DataLayers/"+t+"/"+e,content:n.taskParams,handleAs:"json"}).then(function(t){return t&&t.layer}).otherwise(function(t){return console.log(t),null})}}),C={},v=new n;C.setGeoenrichmentUrl=function(t,e){g=t||g,g&&h.registerCORS(g),_=e||_,!v.promise.isFulfilled()&&v.resolve()},C.canMakeRequests=function(){return!!g},C.getInitPromise=function(){return v.promise},C.GEClient=y;var k;return C.getClient=function(){return m()},C.initialize=function(){return m(!0)},C.initWithJson=function(t,e){C.setGeoenrichmentUrl(t),m().initWithJson(e)},C.enrich=function(t){return m().enrich(t)},C.stdGeographyQuery=function(t){return m().stdGeographyQuery(t)},C.getDataCollections=function(t,e,n){return m().getDataCollections(t,e,n)},C.formatReport=function(t){return m().formatReport(t)},C.createReport=function(t){return m().createReport(t)},C.consumeCredits=function(t){return m().consumeCredits(t)},C.getLayerInfos=function(t){return m().getLayerInfos(t)},C.hasCapability=function(t){return r(m(!0),function(){return k&&k.hasCapability(t)})},C.supportsOperation=function(t){return r(m(!0),function(){return k&&k.supportsOperation(t)})},C.getCountryInfo=function(t){return m().getCountryInfo(t)},C});