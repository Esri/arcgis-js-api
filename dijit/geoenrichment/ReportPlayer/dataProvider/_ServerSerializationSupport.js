// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/utils/ImageUtil","./supportClasses/ReportDataProcessor","./supportClasses/tasks/parsers/DataXMLParser","./supportClasses/areas/AnalysisAreaUtil","./supportClasses/areas/AnalysisAreaJsonUtil","./supportClasses/areas/AreasPreprocessor","./supportClasses/GEUtil","../core/supportClasses/ReportTemplateTypes","../core/conversion/PortalToEditorConverter","../core/supportClasses/map/WebMapJsonUtil","../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","./supportClasses/attachments/AttachmentsStoreSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","../core/conversion/portalToEditorUtils/metadata/MetadataFromDataBuilder","../countryConfig"],(function(e,a,t,r,s,n,o,i,l,u,p,c,m,d,f,h,A,E){return e(null,{reportDataToServerData:function(e){return null},reportDataFromServerData:function(e,g){E.reset();var v,D=e.reportItem.resources;if(!Array.isArray(D)){var b=D;for(var R in D=[],b)D.push({name:R,data:b[R]})}D.forEach((function(e){"theme.css"===e.name&&(e.name="theme.css.txt")}));var T,I=D.filter((function(e){return"report.xml"===e.name}))[0],S=D.filter((function(e){return"data.xml"===e.name}))[0];!function(){var a=/.*\.(png|jpg|jpeg)$/i,r=/(.*\.(json)$)|(^maps\/.*\.(png)$)/i,n={},o={};D.forEach((function(e){a.test(e.name)&&(n[e.name]=e.data,"logo.png"===e.name&&(v=t.base64DataToDataURL(e.data,"image/png"))),r.test(e.name)&&(-1!==e.data.indexOf("operationalLayers")?o[e.name]=c.processWebMapJson(e.name,e.data):o[e.name]=e.data)}));var i={},l=I.data.match(/<section[^<>]*query=("|').+?("|').*?>/g);l&&l.forEach((function(e){var a=e.replace(/.*?query=("|')/,"");a=a.replace(/("|').*/,""),i[a]=1}));var u={};T=s.parse(S.data,(function(e,a,t){var r=o[a];return r?(u[t]=r,r):n[a]||a})),function(e){if(D.some((function(e){return"metadata.xml"===e.name})))return;D.push({name:"metadata.xml",data:A.recoverMetadataFromAreaData(T.areaData,e)})}({map:u,locator:i}),function(a){e.sites=[];var r={},s=1;T.areaData.forEach((function(a){var t=a.headers&&a.headers.data||{},n=t.SITE_NAME||t.STORE_NAME,o=t.STORE_ID||"unclassified."+s++;"number"!=typeof r[o]&&(r[o]=e.sites.length,e.sites.push({locationName:n,name:null,shortName:null,description:null,address:t.STORE_ADDR,latitude:t.STORE_LAT,longitude:t.STORE_LONG,areas:[]})),e.sites[r[o]].areas.push({locationName:n,name:t.AREA_DESC?n+" ("+t.AREA_DESC+")":n,shortName:t.AREA_DESC,description:t.AREA_DESC2,address:t.STORE_ADDR,latitude:t.STORE_LAT,longitude:t.STORE_LONG,feature:{attributes:{STORE_ID:t.STORE_ID,AREA_ID:t.AREA_ID}}})})),e.sites.forEach((function(e){var a=!1;e.shortName=e.areas.map((function(e){return a=!!e.shortName,e.shortName})).join(", "),a&&(e.name=e.locationName+" ("+e.shortName+")");var t=e.areas.map((function(e){return e.description}));e.description=t.length>1?t[0]===t[1]?t[0]:t.join(", "):t[0]||""})),T.reportInfo.areaIdToAttachmentsInfo&&e.sites.forEach((function(e){e.areas.forEach((function(r){var s=T.reportInfo.areaIdToAttachmentsInfo[r.feature.attributes.AREA_ID];s&&(e.attributes=e.attributes&&e.attributes.length?e.attributes:s.attributes,e.notes=e.notes&&e.notes.length?e.notes:s.notes,e.images&&e.images.length||!s.images||(e.images=s.images,e.images.forEach((function(e){function r(e){var r=a[e];return r&&t.base64DataToDataURL(r,"image/png")}e.url=r(e.url),e.thumbnail=r(e.thumbnail)}))))}))}))}(n)}();var y=new h;return a(function(e){var t=I.data.indexOf("<section"),r={isGraphicReport:I.data.indexOf("<table")<t,isMultiFeature:!1,type:u.STANDARD,portalJson:{files:D}};return a(p.provideEditorJson(r,{variableProvider:e}),(function(){return r.templateJson=f.deserialize(r.templateJson),r.isMultiFeature=m.hasMultiFeatureSections(r.templateJson),delete r.portalJson,r}))}(y),(function(t){n.parseSites(e);var s=o.areasFromJson(e.analysisAreas),u=e.combinedAreasInfo&&o.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},p=e.attachmentsProvider&&d.getAttachmentsStoreFromJson(e.attachmentsProvider),c={isMultiFeature:t.isMultiFeature&&s.length>1,reportTitle:null,templateJson:t.templateJson,reportObject:t,fieldData:{specialTradeAreaCalculatorName:null,runReportTaskIDs:null,metadata:{},areaData:[],errors:[],reportInfo:null},analysisAreas:s,combinedAreasInfo:u,reverseAnalysisAreasOnMap:!0,attachmentsStore:p,templateVariableProvider:y,customLogo:v,config:{}};return n.populateCombinedAreasInfo(c.combinedAreasInfo,c.analysisAreas),i.provideAreasIndexes(c),l.setGeoenrichmentUrl(null),g&&g.forEach((function(e){switch(e){case"Maps":l.addCapability("FormatInfographicsMaps");break;case"ImageUrls":l.addCapability("FormatInfographicsImageUrls")}})),a(r.applyRunReportAndGetDataResults(T,c)).then((function(){return c}))}))}})}));