// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.36/esri/copyright.txt for details.

define(["dojo/_base/declare","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/utils/ImageUtil","./supportClasses/ReportDataProcessor","./supportClasses/tasks/parsers/DataXMLParser","./supportClasses/areas/AnalysisAreaUtil","./supportClasses/areas/AnalysisAreaJsonUtil","./supportClasses/areas/AreasPreprocessor","./supportClasses/GEUtil","../core/supportClasses/ReportTemplateTypes","../core/conversion/PortalToEditorConverter","../core/supportClasses/map/WebMapJsonUtil","../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","./supportClasses/attachments/AttachmentsStoreSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","../core/conversion/portalToEditorUtils/metadata/MetadataFromDataBuilder","../countryConfig"],(function(e,a,t,r,s,n,o,i,l,u,p,m,c,d,f,h,A,E){return e(null,{reportDataToServerData:function(e){return null},reportDataFromServerData:function(e,v){E.reset();var D,g=e.reportItem.resources;if(!Array.isArray(g)){var R=g;for(var T in g=[],R)g.push({name:T,data:R[T]})}g.forEach((function(e){"theme.css"===e.name&&(e.name="theme.css.txt")}));var b,S=g.filter((function(e){return"report.xml"===e.name}))[0],I=g.filter((function(e){return"data.xml"===e.name}))[0];!function(){var a=/.*\.(png|jpg|jpeg)$/i,r=/(.*\.(json)$)|(^maps\/.*\.(png)$)/i,n={},o={};g.forEach((function(e){a.test(e.name)&&(n[e.name]=e.data,"logo.png"===e.name&&(D=t.base64DataToDataURL(e.data,"image/png"))),r.test(e.name)&&(-1!==e.data.indexOf("operationalLayers")?o[e.name]=m.processWebMapJson(e.name,e.data):o[e.name]=e.data)}));var i={},l=S.data.match(/<section[^<>]*query=("|').+?("|').*?>/g);l&&l.forEach((function(e){var a=e.replace(/.*?query=("|')/,"");a=a.replace(/("|').*/,""),i[a]=1}));var u={};b=s.parse(I.data,(function(e,a,t){var r=o[a];return r?(u[t]=r,r):n[a]||a})),function(e){if(g.some((function(e){return"metadata.xml"===e.name})))return;g.push({name:"metadata.xml",data:A.recoverMetadataFromAreaData(b.areaData,e)})}({map:u,locator:i}),function(a){e.sites=[];var r={},s=1;b.areaData.forEach((function(a){var t=a.headers&&a.headers.data||{},n=t.SITE_NAME||t.STORE_NAME,o=t.STORE_ID||"unclassified."+s++;"number"!=typeof r[o]&&(r[o]=e.sites.length,e.sites.push({locationName:n,name:null,shortName:null,description:null,address:t.STORE_ADDR,latitude:t.STORE_LAT,longitude:t.STORE_LONG,areas:[]})),e.sites[r[o]].areas.push({locationName:n,name:t.AREA_DESC?n+" ("+t.AREA_DESC+")":n,shortName:t.AREA_DESC,description:t.AREA_DESC2,address:t.STORE_ADDR,latitude:t.STORE_LAT,longitude:t.STORE_LONG,feature:{attributes:{STORE_ID:t.STORE_ID,AREA_ID:t.AREA_ID}}})})),e.sites.forEach((function(e){var a=!1;e.shortName=e.areas.map((function(e){return a=!!e.shortName,e.shortName})).join(", "),a&&(e.name=e.locationName+" ("+e.shortName+")");var t=e.areas.map((function(e){return e.description}));e.description=t.length>1?t[0]===t[1]?t[0]:t.join(", "):t[0]||""})),b.reportInfo.sites&&b.reportInfo.sites.forEach((function(r,s){var n=e.sites[s];n&&(n.attributes=r.attributes,n.notes=r.notes,n.images=r.images,n.images&&n.images.forEach((function(e){function r(e){var r=a[e];return r&&t.base64DataToDataURL(r,"image/png")}e.url=r(e.url),e.thumbnail=r(e.thumbnail)})))}))}(n)}();var C=new h;return a(function(e){var t=S.data.indexOf("<section"),r={isGraphicReport:S.data.indexOf("<table")<t,isMultiFeature:!1,defaultComparisonZoom:null,type:u.STANDARD,portalJson:{files:g}};return a(p.provideEditorJson(r,{variableProvider:e}),(function(){return r.templateJson=f.deserialize(r.templateJson),r.isMultiFeature=c.hasMultiFeatureSections(r.templateJson),delete r.portalJson,r}))}(C),(function(t){n.parseSites(e);var s=o.areasFromJson(e.analysisAreas),u=e.combinedAreasInfo&&o.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},p=e.attachmentsProvider&&d.getAttachmentsStoreFromJson(e.attachmentsProvider),m={isMultiFeature:t.isMultiFeature&&s.length>1,reportTitle:null,templateJson:t.templateJson,reportObject:t,fieldData:{specialTradeAreaCalculatorName:null,runReportTaskIDs:null,metadata:{},areaData:[],errors:[],reportInfo:null},analysisAreas:s,combinedAreasInfo:u,reverseAnalysisAreasOnMap:!0,attachmentsStore:p,templateVariableProvider:C,customLogo:D,config:{}};return n.populateCombinedAreasInfo(m.combinedAreasInfo,m.analysisAreas),i.provideAreasIndexes(m),l.setGeoenrichmentUrl(null),v&&v.forEach((function(e){switch(e){case"Maps":l.addCapability("FormatInfographicsMaps");break;case"ImageUrls":l.addCapability("FormatInfographicsImageUrls")}})),a(r.applyRunReportAndGetDataResults(b,m)).then((function(){return m}))}))}})}));