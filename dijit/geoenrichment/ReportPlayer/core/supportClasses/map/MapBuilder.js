// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","dojo/dom-construct","dojo/dom-geometry","esri/graphic","esri/graphicsUtils","esri/dijit/HomeButton","./layers/MapContentBuilder","./legend/LegendBuilder","./MapLoadTracker","./StaticMap","./WebMapsUtil","./Popup","./Projector","./mobile/MobilePanUtil","../../../dataProvider/supportClasses/data/AreaDataUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/ReportPlayer/_devConfig"],(function(e,t,a,r,n,o,i,s,l,c,u,d,f,p,m,h,I,g,y,v,x){var _=e(null,{_mapInfos:null,_mapDivId:0,_mapImageInfos:null,constructor:function(e){t.mixin(this,e),this.reset()},reset:function(){this._mapInfos={},this._mapImageInfos=null},collectAreaMaps:function(e){var t=[];e=e||0;var a=this._mapInfos[e];for(var r in a){var n=a[r],o=n.node;if(o.parentNode){var s=i.position(o);t.push({areaIndex:e,node:o,x:s.x,y:s.y,position:-1,map:n.map,legend:n.legend,itemId:n.itemId})}}return t.sort((function(e,t){return e.x-t.x})),t.sort((function(e,t){return e.y-t.y})),t.forEach((function(e,t){e.position=t})),t},collectAllAreasMaps:function(){var e=[];for(var t in this._mapInfos)e=e.concat(this.collectAreaMaps(t));return e},setFallbackMapImageInfos:function(e){e?(this._mapImageInfos={},e.forEach((function(e){var t=e.areaIndex||0;(this._mapImageInfos[t]=this._mapImageInfos[t]||{})[e.itemId]=e}),this)):this._mapImageInfos=null},createMap:function(e,t){return t.areaIndex=t.areaIndex||0,m.setLoadedItemsCache(t.reportData.loadedMapPortalItems),n(this._doCreateMap(e,t),(function(e){return t.waitForLoad?e&&n(f.waitForLoad(e.map),(function(){return e})):e}))},_doCreateMap:function(e,a){var o,i,s=this;if(a.webMapId)o=m.getItem(a.webMapId);else if(a.calculatorFieldName){var l=y.getAreaDataValue({fieldName:a.calculatorFieldName,fieldData:a.fieldData,featureIndex:a.areaIndex}),c=l&&l.webMapJson;c&&(c=t.mixin({},c),i=[],a.additionalLayerInfos=[],c.operationalLayers=c.operationalLayers.filter((function(e){if(e.isSiteLayer)return i.push(e),!1;if(e.isLocatorLayer)return!1;if(e.isComparisonLayer){var r=a.stdPolygonsControllers&&a.stdPolygonsControllers.filter((function(t){return t.getCalculatorName()===e.calculatorName}));if(r&&r.length){var n=e.featureCollection.layers[0].featureSet,o=r[0].buildGeometryFieldName(n.spatialReference.wkid);n.features.forEach((function(e){e.geometry.spatialReference=t.mixin({},n.spatialReference),e.attributes[o]=JSON.stringify(e.geometry)})),r.forEach((function(e){n.features.forEach((function(t){e.saveGeometryInCalculatorData(t.attributes,o)}))}))}return!1}return!0})),o={item:{type:"Web Map"},itemData:c})}return n(o,(function(t){if(!t||x.emulateErrors.getMapItemError)return(new r).reject(new Error("Can't load an item or the item is incorrect."));var n=new r;try{s._prepareFeaturesToShow(a,i),s._createMapFromItem(t,e,a).then(n.resolve,n.reject)}catch(e){n.reject(e),console.log(e)}return n.promise})).otherwise(this._createFallbackStaticMap.bind(this,a,e))},_prepareFeaturesToShow:function(e,a){var r,n={},o=e.areaIndex,i=e.reportData,l=i.analysisAreas;if(a){var c={},u={};a.forEach((function(e){var t=e.featureCollection.layers[0],a=t.featureSet.features[0],r=a.attributes;a.geometry.spatialReference=t.featureSet.spatialReference;var n=new s({geometry:a.geometry,attributes:r,symbol:t.layerDefinition.drawingInfo.renderer.symbol});"esriGeometryPoint"===t.featureSet.geometryType?u[r.STORE_ID]=n:c[r.AREA_ID]=n})),(l=l.map((function(e){return t.mixin({},e)}))).forEach((function(e){var a=e.feature.attributes;e.feature=c[a.AREA_ID],e.feature&&t.mixin(e.feature.attributes,a);var r=e.location&&e.location.attributes;e.location=u[a.STORE_ID],e.location&&t.mixin(e.location.attributes,r)}))}if(i.isMultiFeature){r=[];var d=i.reverseAnalysisAreasOnMap?l.slice().reverse():l;d.forEach((function(e,t){var a=i.reverseAnalysisAreasOnMap?d.length-t-1:t;n[r.length]=a,r.push(e.feature);var o=i.combinedAreasInfo.groups;o&&o.length&&o.some((function(e){return-1!==e.indexes.indexOf(a)}))||(e.location&&(n[r.length]=a,r.push(e.location)),e.additionalFeatures&&e.additionalFeatures.forEach((function(e){n[r.length]=a,r.push(e)})))})),i.combinedAreasInfo.groups&&i.combinedAreasInfo.groups.forEach((function(e){var t=l[e.indexes[0]],a=e.location||t&&t.location;a&&(n[r.length]=e.indexes[0],r.push(a),a.locationName=e.locationName||t&&t.locationName),e.additionalFeatures&&e.additionalFeatures.forEach((function(t){n[r.length]=e.indexes[0],r.push(t)}))}))}else{var f=l[o];r=[f.feature],f.location&&r.push(f.location),f.additionalFeatures&&(r=r.concat(f.additionalFeatures)),r.forEach((function(e,t){n[t]=o}))}e.features=r,e.featureIndexToAreaIndexMap=n},_createMapFromItem:function(e,t,a){var i=this,s=v.isMobileDevice();return m.createMap(e,t,{defaultBasemapId:a.defaultBasemapId,additionalLayerInfos:a.additionalLayerInfos,mapOptions:{extent:a.extent||a.features.length&&l.graphicsExtent(a.features).expand(a.expandFactor||1.5),sliderPosition:!1===a.sliderPosition?"none":a.sliderPosition||"top-right",infoWindow:new h({getPlayerZoomScale:function(){return i.getPlayerZoomScale(t)}},o.create("div")),isMapNavigation:!s}}).then((function(e){var o=e&&e.map;return o?n(i._setInitialExtent(o,a),(function(){return n(u.addLayersToMap(o,{features:a.features,featureIndexToAreaIndexMap:a.featureIndexToAreaIndexMap,analysisAreas:a.reportData.analysisAreas,locatorPointsControllers:a.locatorPointsControllers,stdPolygonsControllers:a.stdPolygonsControllers,thisAreasHighlightController:a.thisAreasHighlightController,geClient:a.geClient,countryID:a.countryID,hierarchy:a.hierarchy,additionalLayerInfos:a.additionalLayerInfos,calculatorFieldName:a.calculatorFieldName,pinSymbolJson:a.pinSymbolJson,areaSymbolJsons:a.areaSymbolJsons,areaSymbolRamp:a.areaSymbolRamp,attachmentsStore:a.attachmentsStore}),(function(){s&&g.setUpMapPan(o,a.onPanContainer),void 0===t.__mapDivId&&(t.__mapDivId=i._mapDivId++);var e={node:t,map:o,itemId:a.webMapId,legend:null};d.createLegend(o,t,a.legendController,{onCreated:function(t){e.legend=t},onDestroyed:function(){delete e.legend}});var r=new c({map:o}).placeAt(t);return r.startup(),r.own(o.on("before-unload",(function(){r.destroy()}))),(i._mapInfos[a.areaIndex]=i._mapInfos[a.areaIndex]||{})[t.__mapDivId]=e,e}))})):(new r).reject(new Error("Can't create a map."))}))},_setInitialExtent:function(e,t){if(t.features.length)return n(t.extent||a(t.features.map((function(t){return I.needProject(t.geometry,e)?n(I.projectGeometries(t.geometry,e),(function(e){return new s(e)})):t}))).then((function(e){return l.graphicsExtent(e).expand(t.expandFactor||1.5)})),(function(t){return I.needProject(t,e)?n(I.projectGeometries(t,e),(function(t){return e.setExtent(t)})):e.setExtent(t)}))},_createFallbackStaticMap:function(e,t){var a=this._mapImageInfos&&this._mapImageInfos[e.areaIndex]&&this._mapImageInfos[e.areaIndex][e.webMapId];return this._createStaticMap(a,t,e)},_createStaticMap:function(e,t,a){var r=e&&new p(e,t);return r&&r.load().then((function(){return r.loaded?{node:t,map:r,itemId:a.webMapId,legend:null}:null}))},getPlayerZoomScale:function(e){}});return _.EXPAND_FACTOR=1.5,_}));