// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/Deferred","esri/dijit/geoenrichment/when","esri/kernel","esri/arcgis/utils","esri/geometry/Extent","esri/request","esri/dijit/geoenrichment/utils/UrlUtil"],function(e,i,t,r,a,n,u,l){var s={};l.isPageRunOnWebService()||(r.id.getCredential=function(){var e=new i;return e.reject(new Error("Can't get credentials")),e});var o="http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",c={_itemsCache:{},_siCache:{},loadItem:function(i){return this._itemsCache[i]||(this._itemsCache[i]=a.getItem(i)),t(this._itemsCache[i],function(i){return i&&e.clone(i)})},loadServiceInfo:function(e,i){return this._siCache[e]||(this._siCache[e]=i({url:e,content:{f:"json"}})),this._siCache[e]}};return s.getItem=function(e){return c.loadItem(e)},s.isWebMapType=function(e){return e&&"Web Map"===e.type},s.createMap=function(e,i,r){if(r=r||{},e&&e.item)return s.isWebMapType(e.item)&&r.additionalLayerInfos&&s._addAdditionalLayerInfosToOperationalLayers(e.itemData.operationalLayers,r.additionalLayerInfos),t(!s.isWebMapType(e.item)&&s.createItemDataForNonWebMapItem(e,{defaultBasemapId:r.defaultBasemapId,additionalLayerInfos:r.additionalLayerInfos}),function(){return a.createMap(e,i,{usePopupManager:!0,mapOptions:r.mapOptions||{}})})},s.createItemDataForNonWebMapItem=function(i,r){function a(){d.url=function(e){return["FeatureServer","MapServer","ImageServer"].some(function(i){if(-1!==e.indexOf(i))return e=e.substr(0,e.lastIndexOf(i)+i.length),!0}),e}(d.url);var e=r.requestFunc||u;return l.registerCORS(d.url),c.loadServiceInfo(d.url,e).then(function(e){return t(function(e,i){if(!e.extent){var t=i.initialExtent||i.fullExtent||i.extent;!t||t instanceof n||(t=new n(t)),e.extent=t}}(d,e),function(){return e})})}function o(e){return i.itemData={baseMap:null,operationalLayers:e},r.additionalLayerInfos&&s._addAdditionalLayerInfosToOperationalLayers(e,r.additionalLayerInfos),t(!1!==r.defaultBasemapId&&s.provideDefaultBaseMapForItemData(i.itemData,r),function(){return i})}function f(e,i){return-1!==e.indexOf(i)?e.substr(e.lastIndexOf(i)+i.length,e.length):null}function p(e,i){var t=e.id;return{url:l.combine(d.url,t),capabilities:i.capabilities||"Query",id:i.idPrefix+t,visibility:i.visibility||e.defaultVisibility,mode:1,title:e.title,description:e.description}}r=r||{};var d=i.item,y=i.itemData;if("Feature Service"===d.type){var m=f(d.url,"FeatureServer/");return a().then(function(e){var i=[];if(m&&e.layers[m])i.push(p(e.layers[m],{capabilities:e.capabilities,idPrefix:"featureServiceLayer_",visibility:!0}));else for(var t=0;t<e.layers.length;t++)i.unshift(p(e.layers[t],{capabilities:e.capabilities,idPrefix:"featureServiceLayer_"}));return o(i)})}if("Map Service"===d.type){var m=f(d.url,"MapServer/");return a().then(function(i){var t=m&&i.layers[m]?p(i.layers[m],{capabilities:i.capabilities,idPrefix:"mapServiceLayer_",visibility:!0}):{url:d.url,id:"mapServiceLayer01",visibility:!0,title:i.title};return o([e.mixin(t,{opacity:1},y)])})}if("Image Service"===d.type)return a().then(function(i){return o([e.mixin({url:d.url,id:"imageServiceLayer01",visibility:!0,opacity:1,title:i.title},y)])});if("Vector Tile Service"===d.type)return a().then(function(i){return o([e.mixin({url:d.url,id:"vectorTileServiceLayer01",visibility:!0,opacity:1,title:i.title},y)])});if("WMSServer"===d.type)return a().then(function(i){return o([e.mixin({url:d.url,id:"wmsLayer01",visibility:!0,opacity:1,title:i.title},y)])});if("WMTS"===d.type)return a().then(function(i){return o([e.mixin({url:d.url,id:"wmtsLayer01",visibility:!0,opacity:1,title:i.title},y)])});if("WFS"===d.type)return a().then(function(i){return o([e.mixin({url:d.url,id:"wfsLayer01",visibility:!0,opacity:1,title:i.title},y)])});if("KML"===d.type){l.registerCORS(d.url);return o([e.mixin({url:d.url,id:"kmlLayer01",visibility:!0,opacity:1,title:"KML Layer",type:"KML"},y)])}},s.provideDefaultBaseMapForItemData=function(e,i){if(i=i||{},!e.baseMap)return t(function(){var e={title:"My basemap",baseMapLayers:[{id:"basemapLayer01",opacity:i.hideBasemap?0:1,visibility:!i.hideBasemap,url:o}]};return i.defaultBasemapId?s.getItem(i.defaultBasemapId).then(function(i){return i&&i.itemData&&i.itemData.baseMap||e}):e}(),function(i){return e.baseMap=i,e})},s._addAdditionalLayerInfosToOperationalLayers=function(e,i){i.forEach(function(i,t){e.push({url:i.url,id:"additionalLayer"+t,visibility:!0,opacity:1})})},s});