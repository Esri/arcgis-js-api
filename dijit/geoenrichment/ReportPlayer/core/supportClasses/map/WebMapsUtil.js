// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/Deferred","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/when","esri/kernel","esri/arcgis/utils","esri/geometry/Extent","esri/request","esri/dijit/geoenrichment/utils/CacheUtil","esri/dijit/geoenrichment/utils/UrlUtil","./UrlToItemUtil"],(function(e,t,i,r,a,n,l,u,s,o,c){var f={};o.isPageRunOnWebService()||(a.id.getCredential=function(){var e=new t;return e.reject(new Error("Can't get credentials")),e});var p=function(t){var i=s.get("WebMapsUtil.itemsCache");return i[t]||(i[t]=n.getItem(t)),r(i[t],(function(r){return i[t]=r,r&&e.clone(r)}))},d=function(e,t){var i=s.get("WebMapsUtil.siCache");return i[e]||(i[e]=t({url:e,content:{f:"json"}})),i[e]};return f.loadItems=function(e){var t={};return e.forEach((function(e){t[e]=p(e)})),i(t)},f.setLoadedItemsCache=function(t){s.set("WebMapsUtil.itemsCache",e.mixin(s.get("WebMapsUtil.itemsCache"),t))},f.getItem=function(e){return p(e)},f.isWebMapType=function(e){return e&&"Web Map"===e.type},f.createMap=function(e,t,i){if(i=i||{},e&&e.item)return r(f.isWebMapType(e.item)&&i.additionalLayerInfos&&f._addAdditionalLayerInfosToOperationalLayers(e.itemData.operationalLayers,i.additionalLayerInfos,i.requestFunc),(function(){return r(!f.isWebMapType(e.item)&&f.createItemDataForNonWebMapItem(e,{defaultBasemapId:i.defaultBasemapId,additionalLayerInfos:i.additionalLayerInfos}),(function(){return!e.itemData.baseMap.baseMapLayers.length&&e.itemData.operationalLayers.length&&e.itemData.baseMap.baseMapLayers.push(e.itemData.operationalLayers.shift()),e.itemData.operationalLayers.forEach((function(e){e.featureCollection&&e.featureCollection.layers.forEach((function(e){e.featureSet&&e.layerDefinition&&(e.layerDefinition.fields=e.layerDefinition.fields||e.featureSet.fields&&e.featureSet.fields.slice())}))})),n.createMap(e,t,{usePopupManager:!0,mapOptions:i.mapOptions||{}})}))}))},f.createItemDataForNonWebMapItem=function(t,i){i=i||{};var a=t.item,n=t.itemData;function l(){return f.executeItemUrl(a,i.requestFunc)}function u(e){return t.itemData={baseMap:null,operationalLayers:e},r(i.additionalLayerInfos&&f._addAdditionalLayerInfosToOperationalLayers(e,i.additionalLayerInfos,i.requestFunc),(function(){return r(!1!==i.defaultBasemapId&&f.provideDefaultBaseMapForItemData(t.itemData,i),(function(){return t}))}))}function s(e,t){return-1!==e.indexOf(t)?e.substr(e.lastIndexOf(t)+t.length,e.length):null}function c(t,i,r){var n=t.id;return e.mixin({url:o.combine(a.url,n),capabilities:i.capabilities||"Query",visibility:i.visibility||t.defaultVisibility,mode:1,title:t.title||t.name,description:t.description},r,{id:i.idPrefix+n})}if("Feature Service"===a.type){var p=s(a.url,"FeatureServer/"),d=n&&n.layers?n.layers.reduce((function(e,t){return e[t.id]=t,e}),{}):{};return l().then((function(e){var t=[],i=p&&function(e,t){var i;return e.layers.some((function(e){return t==e.id&&(i=e),!!i})),i}(e,p);if(i)t.push(c(i,{capabilities:e.capabilities,idPrefix:"featureServiceLayer_",visibility:!0},d[p]));else for(var r=0;r<e.layers.length;r++)t.unshift(c(e.layers[r],{capabilities:e.capabilities,idPrefix:"featureServiceLayer_"},d[e.layers[r].id]));return u(t)}))}if("Map Service"===a.type){p=s(a.url,"MapServer/");return l().then((function(t){var i=p&&t.layers[p]?c(t.layers[p],{capabilities:t.capabilities,idPrefix:"mapServiceLayer_",visibility:!0}):{url:a.url,id:"mapServiceLayer01",visibility:!0,title:t.title||t.name};return u([e.mixin(i,n)])}))}return"Image Service"===a.type?l().then((function(t){return u([e.mixin({url:a.url,id:"imageServiceLayer01",visibility:!0,title:t.title||t.name},n)])})):"Vector Tile Service"===a.type?l().then((function(t){return u([e.mixin({url:a.url,id:"vectorTileServiceLayer01",visibility:!0,title:t.title||t.name,styleUrl:o.combineMulti([a.url,t.defaultStyles,"root.json"]),type:"VectorTileLayer",layerType:"VectorTileLayer"},n)])})):"WMSServer"===a.type?l().then((function(t){return u([e.mixin({url:a.url,id:"wmsLayer01",visibility:!0,title:t.title||t.name},n)])})):"WMTS"===a.type?l().then((function(t){return u([e.mixin({url:a.url,id:"wmtsLayer01",visibility:!0,title:t.title||t.name},n)])})):"WFS"===a.type?l().then((function(t){return u([e.mixin({url:a.url,id:"wfsLayer01",visibility:!0,title:t.title||t.name},n)])})):"KML"===a.type?(o.registerCORS(a.url),u([e.mixin({url:a.url,id:"kmlLayer01",visibility:!0,title:"KML Layer",type:"KML"},n)])):void 0},f.executeItemUrl=function(e,t){var i;return e.url=(i=e.url,["FeatureServer","MapServer","ImageServer"].some((function(e){if(-1!==i.indexOf(e))return i=i.substr(0,i.lastIndexOf(e)+e.length),!0})),i),t=t||u,o.registerCORS(e.url),d(e.url,t).then((function(t){return r(function(e,t){if(!e.extent){var i=t.initialExtent||t.fullExtent||t.extent;!i||i instanceof l||(i=new l(i)),e.extent=i}}(e,t),(function(){return t}))}))},f.provideDefaultBaseMapForItemData=function(e,t){var i;if(t=t||{},!e.baseMap)return r((i={title:"My basemap",baseMapLayers:[{id:"basemapLayer01",opacity:t.hideBasemap?0:1,visibility:!t.hideBasemap,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]},t.defaultBasemapId?f.getItem(t.defaultBasemapId).then((function(e){return e&&e.itemData&&e.itemData.baseMap||i})):i),(function(t){return e.baseMap=t,e}))},f._addAdditionalLayerInfosToOperationalLayers=function(e,t,r){return i(t.map((function(e,t){return/Server$/.test(e.url)?f.createItemDataForNonWebMapItem({item:c.tryCreateItemFromServerUrl(e.url)},{requestFunc:r}).then((function(e){return e.itemData.operationalLayers})):[{url:e.url,id:"additionalLayer"+t,visibility:!0}]}))).then((function(t){t.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}))},f}));