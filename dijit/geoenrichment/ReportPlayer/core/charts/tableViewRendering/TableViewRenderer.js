// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dijit/Destroyable","esri/dijit/geoenrichment/ReportPlayer/config","../../supportClasses/tableJson/TableJsonUtil","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","../../sections/sectionUtils/SectionJsonUtil","../utils/builder/utils/ChartDataUtil","../utils/ChartTypes","../../grid/coreUtils/GridDataUtil","dojo/i18n!esri/nls/jsapi"],(function(t,e,a,i,n,o,r,l,s,u,c){c=c.geoenrichment.dijit.ReportPlayer.ChartContainer;var d=/_P$/i,h=function(t,a,o,h,f,m,b,g){if(o=o.map((function(t){return(t=e.mixin({},t)).data=t.data.slice(),t.data.sort((function(t,e){return t.unsortedIndex-e.unsortedIndex})),t})),a&&s.isColumnBarLike(t)){var v=[];o[0].data.forEach((function(t,a){v.push({name:t.name,data:o.map((function(t){var i=t.data[a];return e.mixin({},i,{name:t.name})}))})})),o=v}var w=-1,S=-1,_=-1,p=-1,y=o[0].data.length+1,A=y;g.showTotalsBelow&&(w=y++),g.showAvgBelow&&(S=y++);var C=o.length+1,V=C;g.showTotalsAfter&&(_=C++),g.showAvgAfter&&(p=C++);var T=b/y-2,M=n.createTable({numColumns:C,numRows:y,width:m,height:b,processTableCell:function(t,e,a,i,n){t.style.fields[e].verticalAlign="middle",t.style.fields[e].horizontalPadding=5,t.style.fields[e].fontSize=Math.round(Math.min(T,15-4*y/50))}});var B=o[0]&&o[0].data[0];function F(t,e,a){var n,r,s=o[t-1]&&o[t-1].data[e-1],u=s||B,f=u&&u.point.fieldInfo&&d.test(u.point.fieldInfo.name);(s&&s.isUnavailableData&&(n=0,r=i.tables.showUnavailableData?c.unavailableDataShort:""),n=void 0!==a?a:s&&s.originalValue,r=void 0!==r?r:void 0!==n?l.formatNumber(n,h,f):"",s&&r&&s.isBenchmarked&&!s.isUnavailableData)&&(r=l.formatNumber(s.unbenchmarkedValue,h,f)+" ("+(n>0?"+":"")+r+")");return{value:n||0,formattedValue:r||""}}var x={cache:{},totalsBelow:{},avgsBelow:{},totalsAfter:{},avgsAfter:{}};function D(t,e){return e+";"+t}M.data.data.forEach((function(t,e){M.data.columns.forEach((function(t,a){x.cache[D(a,e)]=F(a,e)}))}));for(var j=0;j<A;j++){x.totalsAfter[j]=0;for(var U=0;U<V;U++)x.totalsAfter[j]+=x.cache[D(U,j)].value;x.avgsAfter[j]=x.totalsAfter[j]/(V-1)}for(U=0;U<V;U++){x.totalsBelow[U]=0;for(j=0;j<A;j++)x.totalsBelow[U]+=x.cache[D(U,j)].value;x.avgsBelow[U]=x.totalsBelow[U]/(A-1)}return M.data.data.forEach((function(t,e){M.data.columns.forEach((function(i,n){var r;0!==e?0!==n?(r=n===_?F(n,e,x.totalsAfter[e]):n===p?F(n,e,x.avgsAfter[e]):e===w?F(n,e,x.totalsBelow[n]):e===S?F(n,e,x.avgsBelow[n]):x.cache[D(n,e)],u.setNumericDataValue(r.value,t,i.field),t[i.field]=r.formattedValue):t[i.field]=function(t){if(0!==t)return t===w?c.total:t===S?c.average:o[0].data[t-1].name||""}(e):t[i.field]=function(t){if(0===t)return h.xAxis&&h.xAxis.title||"";function e(){return o[t-1].name||""}return 1===t?f?a||o.length>2?e():c.thisArea:o.length>1?e():h.yAxis&&h.yAxis.title||"":t===_?c.total:t===p?c.average:e()}(n)}))})),{sectionJson:r.wrapInDetailsSectionJson(M),numberFormatFunction:function(t,e){return F(e.column.index,e.gridData.index,t).formattedValue}}};return t(a,{_tableSection:null,_sorting:null,renderTableForChart:function(t){var e=this;if(this._destroyTable(),t.chartSeries&&t.chartSeries.length){var a={class:"chartContainer_tableSection"};a.initialWidth=t.width,a.initialHeight=t.height;var i=h(t.chartType,t.isMultiFeatureChart,t.chartSeries,t.visualProperties,t.hasComparison,t.width,t.height,t.tableViewInfo);a.json=i.sectionJson;var n=t.viewModel.getDocumentDefaultStyles(t.theme);n.backgroundImage&&n.backgroundImage.data&&(a.json.style={backgroundColor:n.backgroundColor}),t.showAnimation||(i.numberFormatFunction=null),a.viewModel=t.viewModel,a.theme=t.theme,a.tableClass="chartContainerChartTable",a.parentWidget=t.parentWidget,a.initialViewMode=this._viewMode||o.PREVIEW_VALUES,a.tableParams={enableNumberAnimation:t.showAnimation,_postCreateFieldCell:function(t){if(i.numberFormatFunction){var e=i.numberFormatFunction;t.setNumberValue(u.getNumericCellValue(t),(function(a){return e(a,t)}),!0),setTimeout((function(){i.numberFormatFunction=null}))}},onSortingChanged:function(t){e._sorting=t}},this._tableSection=t.viewModel.layoutBuilder.createElement("section",a,t.tableNode),this._tableSection.getTables()[0].setSorting(this._sorting)}},_viewMode:null,setViewMode:function(t){this._viewMode!==t&&(this._viewMode=t,this._tableSection&&this._tableSection.setViewMode(t))},getVisualState:function(){return{type:"tableViewRenderer",tableSection:this._tableSection&&this._tableSection.getVisualState()}},setVisualState:function(t){return t&&t.tableSection&&this._tableSection&&this._tableSection.setVisualState(t.tableSection)},destroyTable:function(){this._destroyTable()},_destroyTable:function(){this._tableSection&&this._tableSection.destroy(),this._tableSection=null},destroy:function(){this._destroyTable(),this.inherited(arguments)}})}));