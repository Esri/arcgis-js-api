// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/dom-geometry","./GridDataUtil","esri/dijit/geoenrichment/utils/ArrayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/MouseUtil"],(function(n,e,i,l,o){var r={querySingleCell:function(n,e){var i;if(e.fieldCell&&(e={rowId:e.fieldCell.rowId,columnId:e.fieldCell.columnId}),n.getFieldCells().some((function(n){if(n.parentGrid&&n.column&&n.gridData)return n.columnId!==e.columnId&&n.column.index!==e.columnIndex&&n.column.field!==e.columnField||n.rowId!==e.rowId&&n.gridData.index!==e.rowIndex?void 0:(i=n,!0)})),i)return i;if(e.considerSpans){var l=r.queryColumn(n,e),o=r.queryData(n,e);if(!l||!o)return null;var d=l.index,u=o.index;n.store.data.some((function(e){return n.columns.some((function(l){var o=l.index,t=l.index+(e.columnSpans&&e.columnSpans[l.field]||0),c=e.index,a=e.index+(e.rowSpans&&e.rowSpans[l.field]||0);if(o<=d&&t>=d&&c<=u&&a>=u)return i=r.querySingleCell(n,{columnIndex:o,rowIndex:c}),!0}))}))}return i},queryColumn:function(n,e){var i;return n.columns.some((function(n){if(n.id===e.columnId||n.index===e.columnIndex||n.field===e.columnField)return i=n,!0})),i},queryData:function(n,e){var i;return n.store.data.some((function(n){if(n.id===e.rowId||n.index===e.rowIndex)return i=n,!0})),i},queryCells:function(n,e){if(e.fieldCell){var i=[],l=e.rowSpan||1,o=e.columnSpan||1,d=r.querySingleCell(n,e);if(d)for(var u=d.gridData.index;u<d.gridData.index+l;u++)for(var t=d.column.index;t<d.column.index+o;t++){var c=r.querySingleCell(n,{rowIndex:u,columnIndex:t});c&&i.push(c)}return i}return this.queryCellsInArray(n.getFieldCells(),e)},queryCellsInArray:function(n,e){var i=[];return Object.keys(e).length?(n.forEach((function(n,l){void 0!==e.cellIndex&&l!==e.cellIndex||void 0!==e.cellIndexes&&-1===e.cellIndexes.indexOf(l)||void 0!==e.columnId&&n.columnId!==e.columnId||void 0!==e.columnIds&&-1===e.columnIds.indexOf(n.columnId)||void 0!==e.columnIndex&&n.column.index!==e.columnIndex||void 0!==e.columnIndexes&&-1===e.columnIndexes.indexOf(n.column.index)||void 0!==e.columnField&&n.column.field!==e.columnField||void 0!==e.columnFields&&-1===e.columnFields.indexOf(n.column.field)||void 0!==e.rowId&&n.rowId!==e.rowId||void 0!==e.rowIds&&-1===e.rowIds.indexOf(n.rowId)||void 0!==e.rowIndex&&n.gridData.index!==e.rowIndex||void 0!==e.rowIndexes&&-1===e.rowIndexes.indexOf(n.gridData.index)||i.push(n)})),i):i},getTitleCell:function(n){var i=r.querySingleCell(n,{rowIndex:0,columnIndex:0});if(i&&!e.getFieldInfo(i)&&(1===n.columns.length||e.getColumnSpan(i)===n.columns.length))return i},isDynamicFieldCell:function(n,e){return n._dynamicBindings&&n._dynamicBindings[e.column.field]},getDynamicallyBoundColumns:function(n,e){return n._dynamicBindings&&n._dynamicBindings[e.field]},getDynamicallyBoundFieldCells:function(n,e){if(e.column){var i=n._dynamicBindings&&n._dynamicBindings[e.column.field];if(!i)return null;var l=[];return i.forEach((function(i){var o=i&&r.querySingleCell(n,{columnId:i.id,rowId:e.rowId});o&&l.push(o)})),l}},getAllBoundCells:function(n,e,l){var o=[],d={};return e&&e.forEach((function(e){if((!l||l(e))&&!d[e.uniqueId]){d[e.uniqueId]=!0;var i=r.getDynamicallyBoundFieldCells(n,e);i?i.forEach((function(n){o.push(n),d[n.uniqueId]=!0})):o.push(e)}})),i.removeDuplicates(o,"uniqueId")},trimDynamicBindings:function(n,e){var i=[],l={};return e&&e.forEach((function(e){var o=r.getDynamicallyBoundFieldCells(n,e);o&&o.length?(l[o[0].uniqueId]||i.push(o[0]),o.forEach((function(n){l[n.uniqueId]=!0}))):i.push(e)})),i},collectFieldInfos:function(n,i){var l=[],o=(i=i||{}).fieldCells||n.getFieldCells();return i.trimDynamicBinding&&o&&(o=r.trimDynamicBindings(n,o)),o&&o.forEach((function(n){var i=e.getFieldInfo(n);i&&l.push(i)})),l},cellHasFloatingTableParent:function(n){if(!n||!n.parentGrid)return!1;return function n(e){return(!e.isSection||!e.isDataDrillingView)&&(!!e.isFloatingTable||!!e.parentWidget&&n(e.parentWidget))}(n.parentGrid)},isMouseOver:function(n){return o.isMouseOverBox(r.getBBox(n))},getOverFieldCell:function(n,e){var i,l=(e=e||{}).cellFilter||function(){return!0};return n.getForegroundFloatingCells({topFirst:!0}).some((function(n){if(l(n)&&n.isMouseOver())return i=n,!0})),i||n.getFieldCells().some((function(n){if(l(n)&&n.isMouseOver())return i=n,!0})),i||n.getBackgroundFloatingCells({topFirst:!0}).some((function(n){if(l(n)&&n.isMouseOver())return i=n,!0})),i},getBBox:function(e,i){var o=e.isSingleCelledTable()&&e.getFirstCell().getAngle();return"number"==typeof o&&0!==o?e.getFirstCell().getBBox(i):i&&i.noTransformation?l.noTransformPosition(e.domNode):n.position(e.domNode)}};return r}));