// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.38/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","esri/dijit/geoenrichment/ReportPlayer/config","esri/dijit/geoenrichment/utils/ObjectUtil","esri/dijit/geoenrichment/utils/WaitingUtil","./GridDataUtil","./GridStyleUtil","./GridCellContentScaler","./GridCellContentSynchronizer","../../supportClasses/conditionalStyling/ConditionalStyleUtil","../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoRenderer","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ElementUsageTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/SpecificViewModes","./GridQueryUtil","./tooltip/GridCellTooltipBuilder","../../../_devConfig"],(function(e,t,n,r,i,a,o,l,d,s,u,c,h,g,m,f,p,C,v){var F={color:"#FF0000"},y={color:"#AAAAAA",fontStyle:"italic",fontSize:13,horizontalAlign:"center",verticalAlign:"middle"};function w(e){var t=e.parentGrid;return e[t.hasRealBorders||t.isMultiDataTable()?"getContentWidth":"getWidth"]()}function I(e){var t=e.parentGrid;return e[t.hasRealBorders||t.isMultiDataTable()?"getContentHeight":"getHeight"]()}var S=e(null,{_parentState:null,constructor:function(e,t,r){var i=this;d.fitContentInsideCell(e),this._setParentState(e),r.forEach((function(r){var a=r[0],o=r[1];t.own(n.after(e,a,(function(){i._checkParentChanged(o,e)&&(d.fitContentInsideCell(e,{sync:!0}),s.syncParentFieldInfoWithElementState(e,t))})))}))},_setParentState:function(e){var t=e.getFullStyle();this._parentState={width:w(e),height:I(e),horizontalAlign:t.horizontalAlign,verticalAlign:t.verticalAlign}},_checkParentChanged:function(e,t){var n;switch(e){case"width":var r=w(t);this._parentState.width!==r&&(this._parentState.width=r,n=!0);break;case"height":var i=I(t);this._parentState.height!==i&&(this._parentState.height=i,n=!0);break;case"horizontalAlign":case"verticalAlign":var a=t.getFullStyle();this._parentState.horizontalAlign===a.horizontalAlign&&this._parentState.verticalAlign===a.verticalAlign||(this._parentState.horizontalAlign=a.horizontalAlign,this._parentState.verticalAlign=a.verticalAlign,n=!0)}return n}});return e(null,{renderCells:function(e,t){var n=this,r=e[0]&&e[0].parentGrid,i=r&&r.getViewMode()!==m.EDIT&&r.viewModel.dynamicReportInfo&&r.viewModel.dynamicReportInfo.fieldData,a={},l=[];e.forEach((function(e){t.cellPreRenderer&&t.cellPreRenderer(e);var r=i&&o.getConditionalFormatting(e);r&&r.groupId?(a[r.groupId]=a[r.groupId]||[]).push({cell:e,content:o.isImageCell(e)?n._getImageCellConditionalValueFromData(e):n._getRenderedContent(e)}):l.push(e)})),l.forEach((function(e){var r=n.renderCellContent(e);r&&r.then&&t.addToQueue(r),t.cellPostRenderer&&t.cellPostRenderer(e)}));var d=function(e,r){if(o.isImageCell(e)){var i=n._placeImageInCell(e.parentGrid,e,r);i&&i.then&&t.addToQueue(i)}else n._applyRenderedContent(e,r);t.cellPostRenderer&&t.cellPostRenderer(e)};for(var s in a){var c=a[s].filter((function(e){return"number"==typeof e.content.value||(d(e.cell,e.content),!1)}));if(c.length){var h=u.getConditionalStylesOrFileNamesForGroup(o.getConditionalFormatting(c[0].cell),c.map((function(e){return e.content.value})),o.isImageCell(c[0].cell));h.styles.forEach((function(e,t){var n=c[t];"string"==typeof e?n.content.conditionalStyle.fileName=e:n.content.conditionalStyle.style=e,n.content.conditionalStyle.stats=h.stats,d(n.cell,n.content)}))}}},renderCellContent:function(e){var t=e.parentGrid,n=o.getFieldInfo(e);if(v.emulateErrors.reportContainerRenderError)throw new Error("Error test: something crashed when building the UI layout!");try{if(n){if(n.isReportSection)return this._placeReportSectionInCell(t,e);if(n.isInfographic)return this._placeInfographicInCell(t,e);if(n.isChart)return this._placeChartInCell(t,e);if(n.isMap)return this._placeMapInCell(t,e);if(n.isImage)return this._placeImageInCell(t,e);if(n.isShape)return this._placeShapeInCell(t,e);n.isMissing&&e.setStyle(F),n.isUnsupportedContent&&e.setStyle(y)}this._applyRenderedContent(e,this._getRenderedContent(e)),e.setContent(null)}catch(e){if(console.log(e),!r.tables.leaveEmptyCellsUponError)throw e}},_renderCellTooltip:function(e){if(e.viewModel.dynamicReportInfo&&!r.isPlayerOnServer){var t=e.viewModel.dynamicReportInfo.templateVariableProvider;C.setDynamicTooltipToCell(e,t)}},updateViewMode:function(e,t){if(e.__viewMode!==t){var n=o.getFieldInfo(e);n&&(n.hasVariable||n.script||n.alias||n.isRichText)&&this._applyRenderedContent(e,this._getRenderedContent(e))}},getRenderedContent:function(e){return this._getRenderedContent(e)},_getRenderedContent:function(e,n){var r,i=o.getFieldInfo(e);if(i){var a=this._prepareRenderContextForFieldCell(e);return t.mixin(a,n),i.isImage&&i.triggerJson&&i.triggerJson.fieldInfo&&(i=i.triggerJson.fieldInfo),c.renderFieldInfoInTableCell(i,a)}return{formattedValue:null==(r=e.row[e.column.field])||"number"==typeof r&&isNaN(r)?"":r,value:r,formatFunction:null,isUnavailableData:!1,conditionalStyle:null}},_prepareRenderContextForFieldCell:function(e){var t=e.parentGrid,n=t.getViewMode()===m.EDIT,r=this._getCellBenchmarkInfoBuilder(e);return{previewValues:this._isPreviewValues(e),previewConditionalStyle:!n,getPreviewValueFunction:t.getPreviewValueFunction,fieldData:t.viewModel.dynamicReportInfo&&t.viewModel.dynamicReportInfo.fieldData,currentFeatureIndex:t.getFeatureIndexForCell(e),currentFeatureAttributes:t.currentFeatureAttributes,cell:e,rowIndex:e.row&&e.row.index,columnIndex:e.column&&e.column.index,columnField:e.column&&e.column.field,numRows:t.rows.length,isGraphicReport:t.viewModel.isGraphicStyle(),isMultiFeature:t.viewModel.dynamicReportInfo&&t.viewModel.dynamicReportInfo.isMultiFeature,presetFilter:!n&&t.presetFilter,presetSorting:!n&&t.presetSorting,isBenchmarked:!!r,getBenchmarkInfo:r&&r.getBenchmarkInfo}},_isPreviewValues:function(e){var t=e.parentGrid,n=o.getFieldInfo(e),r=t.getSpecificViewMode(),i=t.getViewMode()===m.PREVIEW_VALUES;return n&&n.name&&0===n.name.indexOf("SiteNote")&&(i=!0),r&&n&&(r[f.RICH_TEXT]===m.PREVIEW_VALUES&&n.isRichText?i=!0:r[f.VARIABLE]===m.PREVIEW_VALUES&&o.isVariableLikeFieldCell(n)?i=!0:r[f.SPECIAL]===m.PREVIEW_VALUES&&o.isSpecialFieldCell(n)?i=!0:r[f.INFOGRAPHIC]===m.PREVIEW_VALUES&&n.isInfographic&&(i=!0)),i},_applyRenderedContent:function(e,t){t&&(e.__viewMode=e.parentGrid.getViewMode(),this._setCellFormattedValue(e,t),t.isUnavailableData||("number"!=typeof t.value||isNaN(t.value)||(o.setNumericCellValue(e,t.value),e.setNumberValue(t.value,t.formatFunction,e.parentGrid.enableNumberAnimation)),t.conditionalStyle?(o.setCellGroupStyleStats(e,t.conditionalStyle.stats),e.setStyle(t.conditionalStyle.style),"string"==typeof t.conditionalStyle.formattedValue&&this._setCellFormattedValue(e,t.conditionalStyle),e.appliedConditionalStyle=t.conditionalStyle.style):!1===t.conditionalStyle||e.appliedConditionalStyle?(e.appliedConditionalStyle=void 0,e.setStyle(l.combineCellStyle(e.parentGrid,e.row,e.column))):t.modifiedValue&&"string"==typeof t.modifiedValue.formattedValue&&this._setCellFormattedValue(e,t.modifiedValue)),e.parentGrid&&e.parentGrid.viewModel.dynamicReportInfo&&e.setUrl(o.getFieldCellUrl(e)),this._renderCellTooltip(e))},_setCellFormattedValue:function(e,t){if("number"==typeof t.value&&!isNaN(t.value)){var n=this._getCellBenchmarkInfoBuilder(e);n&&e.setBenchmarkInfo(n.getBenchmarkInfo(t.value))}o.setFieldCellContent(e,t.formattedValue)},_getCellBenchmarkInfoBuilder:function(e){var t=this,n=e.parentGrid;return n.viewModel.isBenchmarkedArea&&n.viewModel.isBenchmarkedArea(n.getFeatureIndexForCell(e))&&{isBenchmarked:!0,getBenchmarkInfo:function(r,a){var o=e;a&&((o={row:{fieldInfos:{}},column:e.column,parentGrid:n}).row.fieldInfos[o.column.field]=a);var l=t._getRenderedContent(o,{currentFeatureIndex:n.viewModel.getBenchmarkController().getAreaIndex()}),d=r-l.value;return{ownValue:r,isGreater:d>=0,value:Math.abs(d),formattedValue:l.formatFunction?l.formatFunction(Math.abs(d)):i.formatNumber(Math.abs(d)),noTextLimit:n.viewModel.getBenchmarkController().hasNoTextLimit()}}}},_placeReportSectionInCell:function(e,t){var n=this,r={};function i(){if(t.domNode)return n._createReportSectionFromParams(e,t,r)}r.class="adjustableGrid_inCellSection",r.json=o.getFieldInfo(t).sectionJson,r.viewModel=e.viewModel,r.theme=e.theme,r.viewPortContainer=e.viewPortContainer,r.parentWidget=t,r.currentFeatureIndex=e.getFeatureIndexForCell(t),r.currentFeatureAttributes=e.currentFeatureAttributes,r.initialWidth=w(t),r.initialHeight=I(t),r.noContentOffset=p.cellHasFloatingTableParent(t),r.initialViewMode=e.getViewMode(),r.parentGridCell=t,r.elementUsageType=(e.isReportContainerPageGrid||e.parentGrid&&e.parentGrid.isReportContainerPageGrid)&&g.PAGE_PANEL_SECTION;var l=e.viewModel.layoutBuilder.getClass("section");return l.isAsync?a.showProgressPromise(t.domNode,l.loadModules()).then(i):i()},_createReportSectionFromParams:function(e,t,n){var r;return r=!n.json||!n.json.stack||n.json.type===h.EMPTY?e.viewModel.layoutBuilder.createElement("emptySection",n,t.getContentContainerNode()):e.viewModel.layoutBuilder.createElement("section",n,t.getContentContainerNode()),t.setContent(r),new S(t,r,[["onWidthChanged","width"],["onHeightChanged","height"]]),r},_placeInfographicInCell:function(e,t){var n=this,r={json:o.getFieldInfo(t).infographicJson,viewModel:e.viewModel,theme:e.theme,parentWidget:t,currentFeatureIndex:e.getFeatureIndexForCell(t),currentFeatureAttributes:e.currentFeatureAttributes,getPreviewValueFunction:e.getPreviewValueFunction,width:w(t),height:I(t),adjustElementsWhenResized:p.cellHasFloatingTableParent(t)};function i(){if(t.domNode)return n._createInfographicFromParams(e,t,r)}var l=e.viewModel.layoutBuilder.getClass("infographic");return l.isAsync?a.showProgressPromise(t.domNode,l.loadModules()).then(i):i()},_createInfographicFromParams:function(e,t,n){var r=e.viewModel.layoutBuilder.createElement("infographic",{node:t.getContentContainerNode(),placeFunc:function(e){t.setContent(e)},creationParams:n});return r.setViewMode&&r.setViewMode(e.getViewMode()),new S(t,r,[["onWidthChanged","width"],["onHeightChanged","height"]]),r},_placeChartInCell:function(e,t){var n=this,r=o.getFieldInfo(t).chartJson;r.visualProperties.width=t.getWidth(),r.visualProperties.height=t.getHeight();var i={json:r,viewModel:e.viewModel,theme:e.theme,currentFeatureIndex:e.getFeatureIndexForCell(t),currentFeatureAttributes:e.currentFeatureAttributes,parentWidget:t};function l(){if(t.domNode)return n._createChartPageFromParams(e,t,i)}var d=e.viewModel.layoutBuilder.getClass("chart");return d.isAsync?a.showProgressPromise(t.domNode,d.loadModules()).then(l):l()},_createChartPageFromParams:function(e,t,n){var r=e.viewModel.layoutBuilder.createElement("chart",{node:t.getContentContainerNode(),placeFunc:function(e){t.setContent(e)},creationParams:n});return new S(t,r,[["onWidthChanged","width"],["onHeightChanged","height"]]),r},_placeMapInCell:function(e,t){var n=this,r={json:o.getFieldInfo(t).mapJson,viewModel:e.viewModel,theme:e.theme,parentWidget:t,currentFeatureIndex:e.getFeatureIndexForCell(t),currentFeatureAttributes:e.currentFeatureAttributes};function i(){if(t.domNode)return n._createMapFromParams(e,t,r)}var l=e.viewModel.layoutBuilder.getClass("map");return l.isAsync?a.showProgressPromise(t.domNode,l.loadModules()).then(i):i()},_createMapFromParams:function(e,t,n){var r=e.viewModel.layoutBuilder.createElement("map",{node:t.getContentContainerNode(),placeFunc:function(e){t.setContent(e)},creationParams:n});return new S(t,r,[["onWidthChanged","width"],["onHeightChanged","height"],["setStyle","horizontalAlign"]]),r},_placeImageInCell:function(e,t,n){var r,i=this,a=o.getFieldInfo(t),l=a.imageJson,d=w(t),s=I(t);if(a.triggerJson)if(e.viewModel.dynamicReportInfo)n=n||this._getImageCellConditionalValueFromData(t),l.fileName=n.conditionalStyle.fileName||l.fileName,n.isUnavailableData||"number"!=typeof n.value||isNaN(n.value)||(o.setNumericCellValue(t,n.value),o.setCellGroupStyleStats(t,n.conditionalStyle.stats),t.setNumberValue(n.value,n.formatFunction,!1));else{var h=c.getConditionalStylePreview(a,t);if(h){var g="number"==typeof h.value&&!isNaN(h.value);l.fileName=h.fileName||u.getConditionalFileName(g?h.value:"first-non-default",a.triggerJson)||l.fileName,g&&o.setNumericCellValue(t,h.value),o.setCellGroupStyleStats(t,h.stats)}}l.style.width&&l.style.height&&!1!==l.ownSizeInsideParent&&Math.round(l.style.width)!==Math.round(d)&&Math.round(l.style.height)!==Math.round(s)?l.ownSizeInsideParent=!0:(l.ownSizeInsideParent=!1,l.style.width=d,l.style.height=s);var m={json:l,viewModel:e.viewModel,theme:e.theme,parentWidget:t,currentFeatureIndex:e.getFeatureIndexForCell(t),currentFeatureAttributes:e.currentFeatureAttributes,alignParams:t.getFullStyle(),imageTriggerJson:a.triggerJson};function f(){if(t.domNode)return r=i._createImageFromParams(e,t,m),i._renderCellTooltip(t),r.getRenderPromise().then((function(){t.domNode&&r.resize({w:w(t),h:I(t)},t.getFullStyle())})),r}var p=e.viewModel.layoutBuilder.getClass("image");return p.isAsync?p.loadModules().then(f):f()},_getImageCellConditionalValueFromData:function(e){var t=e.parentGrid,n=o.getFieldInfo(e),r=c.getValueFromFieldData(n.triggerJson.fieldInfo,{fieldData:t.viewModel.dynamicReportInfo.fieldData,currentFeatureIndex:t.getFeatureIndexForCell(e),currentFeatureAttributes:t.currentFeatureAttributes});return r.conditionalStyle={fileName:u.getConditionalFileName(r.value,n.triggerJson)},r},_createImageFromParams:function(e,t,n){var r=e.viewModel.layoutBuilder.createElement("image",{node:t.getContentContainerNode(),placeFunc:function(e){t.setContent(e)},creationParams:n});return new S(t,r,[["onWidthChanged","width"],["onHeightChanged","height"],["setStyle","horizontalAlign"]]),r},_placeShapeInCell:function(e,t){var n=this,r=o.getFieldInfo(t).shapeJson,i=w(t),a=I(t);r.style.width=i,r.style.height=a;var l={json:r,viewModel:e.viewModel,theme:e.theme,parentWidget:t,currentFeatureIndex:e.getFeatureIndexForCell(t),currentFeatureAttributes:e.currentFeatureAttributes,alignParams:t.getFullStyle(),getPreviewValueFunction:e.getPreviewValueFunction,applyThemeStyle:e.applyThemeStyle};function d(){if(t.domNode)return n._createShapeFromParams(e,t,l)}var s=e.viewModel.layoutBuilder.getClass("shape");return s.isAsync?s.loadModules().then(d):d()},_createShapeFromParams:function(e,t,n){var r=e.viewModel.layoutBuilder.createElement("shape",{node:t.getContentContainerNode(),placeFunc:function(e){t.setContent(e)},creationParams:n});return new S(t,r,[["onWidthChanged","width"],["onHeightChanged","height"],["setStyle","horizontalAlign"]]),r}})}));