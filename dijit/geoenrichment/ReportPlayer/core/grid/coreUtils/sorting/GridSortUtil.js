// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/dom-class","dojo/dom-construct","esri/dijit/geoenrichment/ReportPlayer/config","./GridRowStyler","../GridDataUtil","../GridQueryUtil","../gridLayoutCalcUtils/GridLayoutCalculatorQueryUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],(function(r,e,o,t,n,l,i,a,d,u,c){c=c.geoenrichment.dijit.ReportPlayer.Grid;var s={ORDER_ASC:"asc",ORDER_DES:"desc",isGridSortable:function(r){return!(!r.allowSorting||!(r.viewModel.dynamicReportInfo||r.presetSorting&&!r.ignorePresetSorting)||!s.isGridSortableInStructure(r))},isGridSortableInStructure:function(r){return!(r.isEmptyTable()||r.rows.length<3||!s.collectHeaderRowInfoFromData(r))},getSorting:function(r){var e=r._sortInfo||r.presetSorting;return e&&{field:e.field,order:e.order}},applySortingToStoreData:function(r){s.isGridSortable(r)&&s._applySortingToStoreData(r)},setSorting:function(r,e,o){if(s.isGridSortable(r)&&e){if(r.presetSorting=null,r._sortInfo={field:e.field,order:e.order},!o||!o.doNotRefresh)return r.refresh();s._makeSortable(r)}},buildSortControls:function(r){s.isGridSortable(r)&&s._makeSortable(r)},getSortRowIndexMapping:function(r){var e=s.getSorting(r);if(!e||!e.order)return null;var o={},t={};return r._getOriginalData().forEach((function(r,e){t[r.id]=e})),r.rows.forEach((function(r,e){o[e]=t[r.id]})),o},getSortableDataInfo:function(e){function o(o){var t=[],n=s.collectHeaderRowInfoFromData(e,o);if(!n)return null;for(var l=o?e._getOriginalData().slice():r.clone(e.rows),i=0;i<n.headerRowIndex+1;i++)t.push(l.shift());return{topData:t,sortableData:l}}var t=o();return t&&(t.styleInfo=n.getStyleInfo(o(!0).sortableData,e.columns)),t},_applySortingToStoreData:function(r){var e=s.getSorting(r);if(e&&e.order){r._saveOriginalData();var o=s.getSortableDataInfo(r),t=e.field,i=r.columns.filter((function(r){return r.field===t}))[0];i&&o.sortableData.sort((function(o,t){function n(e){var o=l.getRenderedValue(r,e,i);return"number"==typeof o.numericValue?o.numericValue:o.formattedValue}var a,d=n(o),u=n(t),c=e.order===s.ORDER_DES;return"number"==typeof d||"number"==typeof u?(a=(d=Number(d))>(u=Number(u))?1:d<u?-1:0,c?-a:a):(d=String(d),u=String(u),a=d.localeCompare(u),c?-a:a)})),o.styleInfo&&n.setAlternatingColors(o.sortableData,r.columns,o.styleInfo),r.rows=o.topData.concat(o.sortableData)}}};return s.collectHeaderRowInfoFromData=function(r,e){var o=e?r._getOriginalData():r.rows;function t(e){return function(e){for(var t=o[e],n=0,l=0;l<r.columns.length;l++){var i=a.getColumnSpannedFields(r,t,r.columns[l].field);l+=i&&i.length?i.length-1:0,n++}return n}(e)===r.columns.length}for(var n,l=o.length-2,i=0;i<l;i++)if(t(i)){n=i;break}if(!(n>=0))return null;for(i=n+1;i<o.length;i++)if(!t(i))return null;return{headerRowIndex:n}},s._makeSortable=function(r){if(!t.isPlayerOnServer){var n=s._collectHeaderRowInfoWithCells(r);n&&(n.cells.forEach((function(t){if(!t._sortArrow){var n=o.create("div",{class:"sortArrow sortArrowHoverIndicator"},t.domNode),l=t.getFullStyle();n.style[l&&"left"===l.horizontalAlign?"right":"left"]="5px",t._sortArrow=n,r.viewModel.dynamicReportInfo&&(e.add(t.domNode,"esriGEClickable"),d.addNoDragClickHandler(t.contentBlock,(function(e){r&&r.canSortCellFunc&&!r.canSortCellFunc(t)||s._checkCanSortOnHeaderClick(e)&&s._toggleSortForCell(t)})),d.addNoDragClickHandler(n,(function(r){s._toggleSortForCell(t)})))}})),s._updateArrows(r,n))}},s._collectHeaderRowInfoWithCells=function(r){function e(e){return e&&e.length===r.columns.length}for(var o,t,n=r.rows.length-2,l=0;l<n;l++){var a=i.queryCells(r,{rowIndex:l});if(e(a)){o=a,t=l;break}}if(!o)return null;for(l=t+1;l<r.rows.length;l++)if(!e(a=i.queryCells(r,{rowIndex:l})))return null;return{cells:o,headerRowIndex:t}},s._toggleSortForCell=function(r){var e=r.parentGrid,o=s.getSorting(e),t=o&&o.field===r.column.field?o.order:null;e.presetSorting=null,e._sortInfo={field:r.column.field,order:null},t?t===s.ORDER_DES?e._sortInfo.order=s.ORDER_ASC:t===s.ORDER_ASC&&(e._sortInfo.order=null):e._sortInfo.order=s.ORDER_DES,e.refresh(),e.onSortingChanged(s.getSorting(e))},s._checkCanSortOnHeaderClick=function(r){if(r&&r.path){if(r.path.some((function(r){return"A"===r.nodeName})))return!1}else if(r&&r.srcElement&&r.srcElement.parentNode&&"A"===r.srcElement.parentNode.nodeName)return!1;return!0},s._updateArrows=function(r,o){o.cells.forEach((function(o){var t=o._sortArrow;if(t){e.remove(t,"sortArrowHoverIndicator sortArrowUp sortArrowDown"),u.setTooltipToNode(t,null);var n=s.getSorting(r);n&&n.field===o.column.field?n.order===s.ORDER_ASC?e.add(t,"sortArrowUp"):n.order===s.ORDER_DES?e.add(t,"sortArrowDown"):(u.setTooltipToNode(t,c.sortTable),e.add(t,"sortArrowHoverIndicator")):(u.setTooltipToNode(t,c.sortTable),e.add(t,"sortArrowHoverIndicator")),setTimeout((function(){t.style.top=(o.getHeight()-t.clientHeight)/2+"px"}),100)}}))},s}));