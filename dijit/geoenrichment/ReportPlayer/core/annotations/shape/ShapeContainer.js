// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/sniff","dojo/dom-class","dojo/dom-construct","../../grid/valueField/ValueField","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/utils/ObjectUtil","../utils/AnnotationsUtil","./ShapeThemeUtil","./_ShapeElementRenderer","dojo/i18n!esri/nls/jsapi"],(function(e,t,i,s,n,h,o,a,l,r,_,c){c=c.geoenrichment.dijit.ReportPlayer.ReportPlayer;var g=/(M\s?0 32\s?h\s?64)|(M\s?0 32\s?L\s?64 32)/,d=/M0 0\s?v\s?64\s?h\s?64\s?V0\s?H\s?0\s?z/;return e(h,{isShape:!0,viewModel:null,theme:null,currentFeatureIndex:null,json:null,alignParams:null,applyThemeStyle:!0,getPreviewValueFunction:null,parentWidget:null,_g:!1,_viewBox:!1,_shapeStyle:null,_preserveAspectRatio:void 0,_isPlaceholder:!1,_angle:0,_shapeThemeStyle:null,_needSaveShapeThemeStyle:!0,_backgroundThemeStyle:null,_needSaveBackgroundThemeStyle:!0,_showAsBar:!1,_bar_singleIcon:!1,_bar_wholeIcons:!1,_bar_flowDirection:null,_bar_spaceBetween:null,_scaleByValue:!1,_scale_minScale:null,_scale_anchorPosition:null,_useRange:!1,_rangeMin:null,_rangeMax:null,_showBackground:!1,_backgroundStyle:null,_supportNonScalingStroke:!1,_displayViewBox:null,_displayG:null,postCreate:function(){var e=n.create("div",{class:"shapeContainer_content"});this.content=e,this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.json.style.width,this.fieldStyle.height=this.json.style.height,this._g=this.json.g,this._viewBox=this.json.viewBox,this._shapeStyle=this.json.style||{},this._preserveAspectRatio=this.json.preserveAspectRatio,this._isPlaceholder=this.json.isPlaceholder,this._angle=this.json.style.angle||0,this._processThemeStyle(),this._showAsBar=this.json.showAsBar,this._bar_singleIcon=this.json.bar_singleIcon,this._bar_wholeIcons=this.json.bar_wholeIcons,this._bar_flowDirection=this.json.bar_flowDirection,this._bar_spaceBetween=this.json.bar_spaceBetween,this._scaleByValue=this.json.scaleByValue,this._scale_minScale=this.json.scale_minScale,this._scale_anchorPosition=this.json.scale_anchorPosition,this._useRange=this.json.useRange,this._rangeMin=this.json.rangeMin,this._rangeMax=this.json.rangeMax,this._backgroundStyle=this.json.backgroundStyle||{},this._showBackground=this.json.showBackground,(this._showAsBar||this._scaleByValue)&&this._processBackgroundThemeStyle(),this.inherited(arguments),s.add(this.domNode,"esriGEShapeContainer"),this.setPosition(this.json.style.left||0,this.json.style.top||0),this._applyRotation(),this._lastAlignParams={horizontalAlign:this.alignParams&&this.alignParams.horizontalAlign||this.json.style.horizontalAlign||"center",verticalAlign:this.alignParams&&this.alignParams.verticalAlign||this.json.style.verticalAlign||"middle"}},_processThemeStyle:function(){this.applyThemeStyle&&(this._shapeThemeStyle=r.getThemeStylesFromShapeJson(this.json,this.parentWidget.parentGrid),this._needSaveShapeThemeStyle=!!this.json.themeStyle)},_processBackgroundThemeStyle:function(){this.applyThemeStyle&&(this._backgroundThemeStyle=r.getBackgroundThemeStylesFromShapeJson(this.json,this.parentWidget.parentGrid),this._needSaveBackgroundThemeStyle=!!this.json.backgroundThemeStyle)},getShapeStyle:function(){return this._getShapeStyle()},_getShapeStyle:function(e,t){var i={};return a.copyOwnJsonProperties(this._shapeThemeStyle,i),e&&e.color&&a.copyOwnJsonProperties({fillColor:e.color,borderColor:e.color},i),a.copyOwnJsonProperties(this._getOwnShapeStyleForRendering(t),i),i},getBackgroundStyle:function(){var e={};return a.copyOwnJsonProperties(this._backgroundThemeStyle,e),a.copyOwnJsonProperties(this._getOwnBackgroundStyleForRendering(),e),e},setAngle:function(e){this._angle=o.angleTo180_180Range(Number(e)||0),this._applyRotation()},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var e=i("webkit")?"webkitTransform":"transform";this.content.style[e]=0!==this._angle?"rotate("+this._angle+"deg)":""},_lastAlignParams:null,resize:function(e,t){e&&(this.setWidth(e.w),this.setHeight(e.h)),this._updateShapeNode(),this._lastAlignParams=t||this._lastAlignParams,l.alignAnnotationContainer(this,this._lastAlignParams,this._calcGeometry().content)},_left:0,_top:0,getLeft:function(){return this._left},getTop:function(){return this._top},setPosition:function(e,t){void 0!==e&&(this._left=e||0,this.domNode.style.left=this._left+"px"),void 0!==t&&(this._top=t||0,this.domNode.style.top=this._top+"px")},_svgNode:null,getSvgNode:function(){return this._svgNode},_updateShapeNode:function(){var e,i=this;if(this._displayG=null,this._displayViewBox=null,"none"===this._preserveAspectRatio){var s=1===(e=this._g).length&&d.test(e[0].d),h=!s&&function(e){return 1===e.length&&g.test(e[0].d)}(this._g);if(s||h){var o=(r=this.getWidth())/64,a=(c=this.getHeight())/64;this._displayG=[t.mixin({},this._g[0])],this._displayG[0].d=s?"M0 0v"+c+"h"+r+"V0H0z":"M0 "+c/2+"h"+r,this._displayViewBox=t.mixin({},this._viewBox),this._displayViewBox.xmin*=o,this._displayViewBox.ymin*=a,this._displayViewBox.width*=o,this._displayViewBox.height*=a}}var l=this._displayViewBox||this._viewBox,r=this.getWidth(),c=this.getHeight(),p=this._calcGeometry();if(this.content.innerHTML="",this.content.style.width=p.content.w+"px",this.content.style.height=p.content.h+"px",this._isPlaceholder)n.create("div",{class:"shapeContainer_svgPlaceholder"},this.content);else{var u=this.getPreviewValueFunction&&this.getPreviewValueFunction(),y={content:this.content,preserveAspectRatio:this._preserveAspectRatio,supportNonScalingStroke:this._supportNonScalingStroke,viewBox:l,width:r,height:c,shapeW:p.shape.w,shapeH:p.shape.h,borderWidth:this._getMaxBorderWidth(),g:this._displayG||this._g,value:u?u.normalizedValue:.6,shapeStyle:this._getShapeStyle(u&&u.conditionalStyling),shapeStyleBuilder:function(e){return i._getShapeStyle(u&&u.conditionalStyling,e)},bgStyle:this._showBackground&&this.getBackgroundStyle(),bar:this._showAsBar&&{singleIcon:this._bar_singleIcon,wholeIcons:this._bar_wholeIcons,flowDirection:this._bar_flowDirection,spaceBetween:this._bar_spaceBetween,showBackground:this._showBackground},scale:this._scaleByValue&&{minScale:this._scale_minScale,anchorPosition:this._scale_anchorPosition,showBackground:this._showBackground}};_.renderElements(y),this._svgNode=y._svgNode}},_calcGeometry:function(){var e,t,i=this._displayViewBox||this._viewBox,s=this.getWidth(),n=this.getHeight(),h=i.width/i.height,o=Math.min(s,n*h);"none"===this._preserveAspectRatio?(e=s,t=n):(e=o,t=o/h);var a=this._showAsBar&&!this._bar_singleIcon;return{shape:{w:e,h:t},content:{w:a?s:e,h:a?n:t}}},_getOwnShapeStyleForRendering:function(e){return this._fixBorderStyle(this._shapeStyle,e)},_getOwnBackgroundStyleForRendering:function(){return this._fixBorderStyle(this._backgroundStyle)},_fixBorderStyle:function(e,i){var s=this._getBorderStrokeMultiplier(e,i);return 1!==s?t.mixin({},e,{borderWidth:e.borderWidth*s}):e},_getBorderStrokeMultiplier:function(e,t){if(e.borderWidth>0&&e.borderAlpha>0&&!this._supportNonScalingStroke){var i=this._displayViewBox||this._viewBox,s=t||this._calcGeometry().shape,n=s.w,h=s.h,o=function(e,t){var i=e/t;return i<1?1/i:i};return o(n,i.width)>o(h,i.height)?i.width/n:i.height/h}return 1},_getMaxBorderWidth:function(){return Math.max(this._shapeStyle.borderAlpha>0&&this._shapeStyle.borderWidth||0,this._backgroundStyle.borderAlpha>0&&this._backgroundStyle.borderWidth||0)},toJson:function(){var e={id:"shape",g:this._g,viewBox:this._viewBox,preserveAspectRatio:this._preserveAspectRatio,isPlaceholder:this._isPlaceholder,style:t.mixin({},this._shapeStyle,{left:this._left,top:this._top,width:this.getWidth(),height:this.getHeight(),angle:this._angle}),themeStyle:this._needSaveShapeThemeStyle?this._shapeThemeStyle:void 0,showAsBar:this._showAsBar,bar_singleIcon:this._bar_singleIcon,bar_wholeIcons:this._bar_wholeIcons,bar_flowDirection:this._bar_flowDirection,bar_spaceBetween:this._bar_spaceBetween,scaleByValue:this._scaleByValue,scale_minScale:this._scale_minScale,scale_anchorPosition:this._scale_anchorPosition,useRange:this._useRange,rangeMin:this._rangeMin,rangeMax:this._rangeMax,showBackground:this._showBackground,backgroundStyle:this._backgroundStyle,backgroundThemeStyle:this._needSaveBackgroundThemeStyle?this._backgroundThemeStyle:void 0};return t.clone(e)}})}));