// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.36/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/sniff","dojo/dom-class","dojo/dom-construct","../../grid/valueField/ValueField","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/utils/ObjectUtil","../utils/AnnotationsUtil","./ShapeThemeUtil","./_ShapeElementRenderer","dojo/i18n!esri/nls/jsapi"],(function(e,t,s,i,h,n,o,a,l,r,_,c){c=c.geoenrichment.dijit.ReportPlayer.ReportPlayer;var p=/(M\s?0 32\s?h\s?64)|(M\s?0 32\s?L\s?64 32)/,d=/M0 0\s?v\s?64\s?h\s?64\s?V0\s?H\s?0\s?z/;return e(n,{isShape:!0,viewModel:null,theme:null,currentFeatureIndex:null,shapeJson:null,alignParams:null,applyThemeStyle:!0,getPreviewValueFunction:null,parentWidget:null,_g:!1,_viewBox:!1,_shapeStyle:null,_preserveAspectRatio:void 0,_isPlaceholder:!1,_angle:0,_shapeThemeStyle:null,_needSaveShapeThemeStyle:!0,_backgroundThemeStyle:null,_needSaveBackgroundThemeStyle:!0,_showAsBar:!1,_bar_singleIcon:!1,_bar_wholeIcons:!1,_bar_flowDirection:null,_bar_spaceBetween:null,_scaleByValue:!1,_scale_minScale:null,_scale_anchorPosition:null,_useRange:!1,_rangeMin:null,_rangeMax:null,_showBackground:!1,_backgroundStyle:null,_supportNonScalingStroke:!1,_displayViewBox:null,_displayG:null,postCreate:function(){var e=h.create("div",{class:"shapeContainer_content"});this.content=e,this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.shapeJson.style.width,this.fieldStyle.height=this.shapeJson.style.height,this._g=this.shapeJson.g,this._viewBox=this.shapeJson.viewBox,this._shapeStyle=this.shapeJson.style||{},this._preserveAspectRatio=this.shapeJson.preserveAspectRatio,this._isPlaceholder=this.shapeJson.isPlaceholder,this._angle=this.shapeJson.style.angle||0,this._processThemeStyle(),this._showAsBar=this.shapeJson.showAsBar,this._bar_singleIcon=this.shapeJson.bar_singleIcon,this._bar_wholeIcons=this.shapeJson.bar_wholeIcons,this._bar_flowDirection=this.shapeJson.bar_flowDirection,this._bar_spaceBetween=this.shapeJson.bar_spaceBetween,this._scaleByValue=this.shapeJson.scaleByValue,this._scale_minScale=this.shapeJson.scale_minScale,this._scale_anchorPosition=this.shapeJson.scale_anchorPosition,this._useRange=this.shapeJson.useRange,this._rangeMin=this.shapeJson.rangeMin,this._rangeMax=this.shapeJson.rangeMax,this._backgroundStyle=this.shapeJson.backgroundStyle||{},this._showBackground=this.shapeJson.showBackground,(this._showAsBar||this._scaleByValue)&&this._processBackgroundThemeStyle(),this.inherited(arguments),i.add(this.domNode,"esriGEShapeContainer"),this.setPosition(this.shapeJson.style.left||0,this.shapeJson.style.top||0),this._applyRotation(),this._lastAlignParams=this.alignParams},_processThemeStyle:function(){this.applyThemeStyle&&(this._shapeThemeStyle=r.getThemeStylesFromShapeJson(this.shapeJson,this.parentWidget.parentGrid),this._needSaveShapeThemeStyle=!!this.shapeJson.themeStyle)},_processBackgroundThemeStyle:function(){this.applyThemeStyle&&(this._backgroundThemeStyle=r.getBackgroundThemeStylesFromShapeJson(this.shapeJson,this.parentWidget.parentGrid),this._needSaveBackgroundThemeStyle=!!this.shapeJson.backgroundThemeStyle)},getShapeStyle:function(){return this._getShapeStyle()},_getShapeStyle:function(e,t){var s={};return a.copyOwnJsonProperties(this._shapeThemeStyle,s),e&&e.color&&a.copyOwnJsonProperties({fillColor:e.color,borderColor:e.color},s),a.copyOwnJsonProperties(this._getOwnShapeStyleForRendering(t),s),s},getBackgroundStyle:function(){var e={};return a.copyOwnJsonProperties(this._backgroundThemeStyle,e),a.copyOwnJsonProperties(this._getOwnBackgroundStyleForRendering(),e),e},setAngle:function(e){this._angle=o.angleTo180_180Range(Number(e)||0),this._applyRotation()},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var e=s("webkit")?"webkitTransform":"transform";this.content.style[e]=0!==this._angle?"rotate("+this._angle+"deg)":""},_lastAlignParams:null,resize:function(e,t){e&&(this.setWidth(e.w),this.setHeight(e.h)),this._updateShapeNode(),this._lastAlignParams=t||this._lastAlignParams,l.alignAnnotationContainer(this,this._lastAlignParams,this._calcGeometry().content)},scaleProportionallyWithinParent:function(e){this.resize({w:this.getWidth()*e.xScale,h:this.getHeight()*e.yScale}),this.setPosition(this._left*e.xScale,this._top*e.yScale)},getShapeBox:function(){return{w:this.getWidth(),h:this.getHeight(),l:this._left,t:this._top}},_left:0,_top:0,getLeft:function(){return this._left},getTop:function(){return this._top},setPosition:function(e,t){void 0!==e&&(this._left=e||0,this.domNode.style.left=this._left+"px"),void 0!==t&&(this._top=t||0,this.domNode.style.top=this._top+"px")},_svgNode:null,getSvgNode:function(){return this._svgNode},_updateShapeNode:function(){var e,s=this;if(this._displayG=null,this._displayViewBox=null,"none"===this._preserveAspectRatio){var i=1===(e=this._g).length&&d.test(e[0].d),n=!i&&function(e){return 1===e.length&&p.test(e[0].d)}(this._g);if(i||n){var o=(r=this.getWidth())/64,a=(c=this.getHeight())/64;this._displayG=[t.mixin({},this._g[0])],this._displayG[0].d=i?"M0 0v"+c+"h"+r+"V0H0z":"M0 "+c/2+"h"+r,this._displayViewBox=t.mixin({},this._viewBox),this._displayViewBox.xmin*=o,this._displayViewBox.ymin*=a,this._displayViewBox.width*=o,this._displayViewBox.height*=a}}var l=this._displayViewBox||this._viewBox,r=this.getWidth(),c=this.getHeight(),g=this._calcGeometry();if(this.content.innerHTML="",this.content.style.width=g.content.w+"px",this.content.style.height=g.content.h+"px",this._isPlaceholder)h.create("div",{class:"shapeContainer_svgPlaceholder"},this.content);else{var u=this.getPreviewValueFunction&&this.getPreviewValueFunction(),y={content:this.content,preserveAspectRatio:this._preserveAspectRatio,supportNonScalingStroke:this._supportNonScalingStroke,viewBox:l,width:r,height:c,shapeW:g.shape.w,shapeH:g.shape.h,borderWidth:this._getMaxBorderWidth(),g:this._displayG||this._g,value:u?u.normalizedValue:.6,shapeStyle:this._getShapeStyle(u&&u.conditionalStyling),shapeStyleBuilder:function(e){return s._getShapeStyle(u&&u.conditionalStyling,e)},bgStyle:this._showBackground&&this.getBackgroundStyle(),bar:this._showAsBar&&{singleIcon:this._bar_singleIcon,wholeIcons:this._bar_wholeIcons,flowDirection:this._bar_flowDirection,spaceBetween:this._bar_spaceBetween,showBackground:this._showBackground},scale:this._scaleByValue&&{minScale:this._scale_minScale,anchorPosition:this._scale_anchorPosition,showBackground:this._showBackground}};_.renderElements(y),this._svgNode=y._svgNode}},_calcGeometry:function(){var e,t,s=this._displayViewBox||this._viewBox,i=this.getWidth(),h=this.getHeight(),n=s.width/s.height,o=Math.min(i,h*n);"none"===this._preserveAspectRatio?(e=i,t=h):(e=o,t=o/n);var a=this._showAsBar&&!this._bar_singleIcon;return{shape:{w:e,h:t},content:{w:a?i:e,h:a?h:t}}},_getOwnShapeStyleForRendering:function(e){return this._fixBorderStyle(this._shapeStyle,e)},_getOwnBackgroundStyleForRendering:function(){return this._fixBorderStyle(this._backgroundStyle)},_fixBorderStyle:function(e,s){var i=this._getBorderStrokeMultiplier(e,s);return 1!==i?t.mixin({},e,{borderWidth:e.borderWidth*i}):e},_getBorderStrokeMultiplier:function(e,t){if(e.borderWidth>0&&e.borderAlpha>0&&!this._supportNonScalingStroke){var s=this._displayViewBox||this._viewBox,i=t||this._calcGeometry().shape,h=i.w,n=i.h,o=function(e,t){var s=e/t;return s<1?1/s:s};return o(h,s.width)>o(n,s.height)?s.width/h:s.height/n}return 1},_getMaxBorderWidth:function(){return Math.max(this._shapeStyle.borderAlpha>0&&this._shapeStyle.borderWidth||0,this._backgroundStyle.borderAlpha>0&&this._backgroundStyle.borderWidth||0)},toJson:function(){var e={id:"shape",g:this._g,viewBox:this._viewBox,preserveAspectRatio:this._preserveAspectRatio,isPlaceholder:this._isPlaceholder,style:t.mixin({},this._shapeStyle,{left:this._left,top:this._top,width:this.getWidth(),height:this.getHeight(),angle:this._angle}),themeStyle:this._needSaveShapeThemeStyle?this._shapeThemeStyle:void 0,showAsBar:this._showAsBar,bar_singleIcon:this._bar_singleIcon,bar_wholeIcons:this._bar_wholeIcons,bar_flowDirection:this._bar_flowDirection,bar_spaceBetween:this._bar_spaceBetween,scaleByValue:this._scaleByValue,scale_minScale:this._scale_minScale,scale_anchorPosition:this._scale_anchorPosition,useRange:this._useRange,rangeMin:this._rangeMin,rangeMax:this._rangeMax,showBackground:this._showBackground,backgroundStyle:this._backgroundStyle,backgroundThemeStyle:this._needSaveBackgroundThemeStyle?this._backgroundThemeStyle:void 0};return t.clone(e)}})}));