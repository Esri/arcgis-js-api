// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/JsonXmlConverter","../annotations/shape/ShapeBarFlowDirections","../annotations/shape/ShapeScaleAnchorPositions"],(function(e,r,o,a){var i={},t=/path|ellipse|circle|polygon|rect|line/,n=["fill","fill-opacity","stroke","stroke-opacity"],s=["display"];function l(e){return Number("string"==typeof e?e.replace("px",""):e)}function c(e){return e?l(e):void 0}function u(e){return"number"==typeof e?e:void 0}i.svgJsonToShapeObject=function(i,u){if((u=u||{}).ignoreHiddenElements){(function r(o,a){a=e.mixin({},a),o.attributes=o.attributes||{},n.forEach((function(e){var r=o.attributes[e];void 0===r&&(r=o.attributes[e]=a[e]),a[e]=r})),s.forEach((function(e){var r=a[e]||o.attributes[e];o.attributes[e]=r,a[e]=r})),o.tags&&o.tags.forEach((function(e){r(e,a)}))})(i=e.clone(i))}var d={name:u.name||"",g:[],style:{},backgroundStyle:{}},g=i.attributes;if(g.viewBox){var h=g.viewBox.split(" ");d.viewBox={xmin:l(h[0])||0,ymin:l(h[1])||0,width:l(h[2]),height:l(h[3])}}else{if(!g.width||!g.height)return d;d.viewBox={xmin:0,ymin:0,width:l(g.width),height:l(g.height)}}return g.width&&(d.style.width=l(g.width)),g.height&&(d.style.height=l(g.height)),g.zoom&&(d.style.zoom=l(g.zoom)),d.preserveAspectRatio=g.preserveAspectRatio,d.showAsBar=g.showAsBar,d.showAsBar&&(d.useRange=g.useRange,d.rangeMin=c(g.rangeMin),d.rangeMax=c(g.rangeMax),d.bar_singleIcon=g.barSingleIcon,d.bar_wholeIcons=g.barWholeIcons,d.bar_flowDirection=g.barFlowDirection&&o.toSupportedValue(g.barFlowDirection),d.bar_spaceBetween=c(g.barSpaceBetween)),d.scaleByValue=g.scaleByValue,d.scaleByValue&&(d.useRange=g.useRange,d.rangeMin=c(g.rangeMin),d.rangeMax=c(g.rangeMax),d.scale_minScale=c(g.minScale),d.scale_anchorPosition=g.scaleAnchorPosition&&a.toSupportedValue(g.scaleAnchorPosition)),g.showBackground&&(d.showBackground=!0,d.backgroundStyle.fillColor=g.backgroundFill,d.backgroundStyle.fillAlpha=c(g.backgroundFillOpacity),d.backgroundStyle.borderColor=g.backgroundStroke,d.backgroundStyle.borderWidth=c(g.backgroundStrokeWidth),d.backgroundStyle.borderAlpha=c(g.backgroundStrokeOpacity),d.backgroundStyle.borderDashArray=g.backgroundStrokeDashArray),r.queryJson(i,t).forEach((function(e){var r=e.attributes;if(function(e){if(!e)return!1;if(!u.ignoreHiddenElements)return!0;if("none"===e.display)return!1;var r=e.fill&&"none"!==e.fill&&(void 0===e["fill-opacity"]||0!==e["fill-opacity"]),o=e.stroke&&"none"!==e.stroke&&(void 0===e["stroke-opacity"]||0!==e["stroke-opacity"]);return void 0===r&&void 0===o||(r||o)}(r)){var o;switch(e.name){case"path":o={d:r.d};break;case"ellipse":o={cx:l(r.cx),cy:l(r.cy),rx:l(r.rx),ry:l(r.ry)};break;case"circle":o={cx:l(r.cx),cy:l(r.cy),r:l(r.r)};break;case"polygon":o={points:r.points};break;case"rect":o={x:l(r.x),y:l(r.y),width:l(r.width),height:l(r.height)};break;case"line":o={x1:l(r.x1),y1:l(r.y1),x2:l(r.x2),y2:l(r.y2)}}o&&(o.name=e.name,r["fill-opacity"]&&(o["fill-opacity"]=l(r["fill-opacity"])),d.g.push(o))}})),d},i.shapeJsonToSvgJson=function(r){var o,a,i;return r.showAsBar&&(o={showAsBar:!0,useRange:r.useRange||void 0,rangeMin:u(r.rangeMin),rangeMax:u(r.rangeMax),barSingleIcon:r.bar_singleIcon||void 0,barWholeIcons:r.bar_wholeIcons||void 0,barFlowDirection:r.bar_flowDirection||void 0,barSpaceBetween:u(r.bar_spaceBetween)}),r.scaleByValue&&(a={scaleByValue:!0,useRange:r.useRange||void 0,rangeMin:u(r.rangeMin),rangeMax:u(r.rangeMax),minScale:u(r.scale_minScale),scaleAnchorPosition:r.scale_anchorPosition||void 0}),r.showBackground&&(i={showBackground:!0,backgroundFill:r.backgroundStyle.fillColor||void 0,backgroundFillOpacity:u(r.backgroundStyle.fillAlpha),backgroundStroke:r.backgroundStyle.borderColor||void 0,backgroundStrokeWidth:u(r.backgroundStyle.borderWidth),backgroundStrokeOpacity:u(r.backgroundStyle.borderAlpha),backgroundStrokeDashArray:r.backgroundStyle.borderDashArray||void 0}),{name:"svg",attributes:e.mixin({width:r.style.width||void 0,height:r.style.height||void 0,viewBox:r.viewBox.xmin+" "+r.viewBox.ymin+" "+r.viewBox.width+" "+r.viewBox.height,preserveAspectRatio:r.preserveAspectRatio,zoom:r.style.zoom||void 0},o,a,i),tags:[{name:"g",tags:r.g.map((function(r){var o=e.mixin({},r);return delete o.name,{name:r.name,attributes:o}}))}]}};var d={borderColor:"stroke",fillColor:"fill",borderAlpha:"stroke-opacity",fillAlpha:"fill-opacity",borderWidth:"stroke-width",borderDashArray:"stroke-dasharray",strokeMiterLimit:"stroke-miterlimit"},g={"stroke-opacity":1,"fill-opacity":1,"stroke-width":1},h={};for(var b in d)h[d[b]]=b;return i.applyStylesToSvgJson=function(e,o){r.queryJson(e,t).forEach((function(e){for(var r in e.attributes=e.attributes||{},o){var a=d[r];a&&(e.attributes[a]=o[r])}}))},i.getStylesFromSvgJson=function(e){var o={},a=r.queryJson(e,t)[0];if(!a||!a.attributes)return o;for(var i in h){var n=a.attributes[i];void 0!==n&&(o[h[i]]=g[i]?Number(n):n)}return o},i}));