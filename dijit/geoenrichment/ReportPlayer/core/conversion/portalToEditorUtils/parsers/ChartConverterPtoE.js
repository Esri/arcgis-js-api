// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/ColorUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/JsonXmlConverter","../../ConversionUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartJsonUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendSymbols","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartDataLabelsTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartBarThickness","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartSorting","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartLineStyles","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartLineMarkers","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/GaugeLabelPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleLabelPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleDirections","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleFlowStyles","./_FieldInfoBuilder","dojo/i18n!esri/nls/jsapi"],(function(e,t,i,a,l,r,o,n,s,u,c,p,g,d,f,b,y,h,S,m,L){L=L.geoenrichment.dijit.ReportPlayer.ReportPlayer;var v={};function C(e,t){var i=Number(e);return isNaN(i)?void 0:t?t(i):i}function w(e,t){return C(e,t.revisionVersion>=1.7?l.ptToPx:null)}function P(e){return l.ptToPxObj(l.parseStyleString(e))}function k(t,i,a){var l={gridLines:t.gridlines,gridLinesCentered:t.gridlinesCentered,gridLinesOpacity:C(t.gridlinesOpacity),gridLinesColor:A(t.gridlinesColor),gridLinesThickness:w(t.gridlinesThickness,a),gridLinesStyle:d.isSupported(t.gridlinesStyle)?t.gridlinesStyle:void 0,gridStripes:t.gridStripes,gridStripesColor:A(t.gridStripesColor),gridStripesColorAlt:A(t.gridStripesColorAlt)};return i&&e.mixin(l,{hideBaseLine:void 0!==t.baseLine?!t.baseLine:t.hideBaseLine,baseLineColor:A(t.baseLineColor),baseLineOpacity:C(t.baseLineOpacity),baseLineThickness:w(t.baseLineThickness,a),baseLineStyle:d.isSupported(t.baseLineStyle)?t.baseLineStyle:void 0,baseLineValue:C(t.baseLineValue)}),l}function T(e,t){var i=a.queryTopJson(e,"templateValueFields")[0];if(!i)return null;var l=a.queryTopJson(i,"d");if(!l||!l.length)return null;var r={};return l.forEach((function(e){var i=m.getCalculatorOrScriptFieldInfo(e.attributes.f,t);(r[e.attributes.templateField]=r[e.attributes.templateField]||{})[e.attributes.pointField]=i})),r}function O(e){return"string"!=typeof e?0:"0"===(e=e.replace("%",""))?0:e.replace("0.","").length}function A(e){return e&&"string"==typeof e&&(e=6===e.length&&-1===e.indexOf("#")?"#"+e:t.toCSSColor(e)),e}return v.portalToEditor=function(t,v,x){if(!o.isSupported(t.attributes.type))throw new Error("Chart type is not supported.");var M=function(e,t){return a.queryTopJson(e,"series")[0].tags.map((function(i){if(!i.tags)return null;i.attributes=i.attributes||{};var n={_originalAttrs:i.attributes,label:i.attributes.Text||"",color:A(i.attributes.color),points:i.tags.map((function(l,n){l.attributes=l.attributes||{};var s=(e.attributes.type===o.GAUGE||e.attributes.type===o.WAFFLE)&&n===i.tags.length-1,u=l.tags&&l.tags[0],c=u&&u.attributes&&u.attributes.f,p=c&&m.getCalculatorOrScriptFieldInfo(c,t);if(p||s){if(s&&(p=null),p&&p.isMissing){var g=l.attributes.Text;if(!g&&t.variableProvider.isPlayerOnly){var d=t.variableProvider.toCalculator(p.templateName);g=d&&d.variable.alias}p.alias=g?g+" ("+L.missingVariable+")":L.missingVariable}var f=l.attributes.CaptionField,b=f&&m.getCalculatorOrScriptFieldInfo(f,t),y=a.queryJson(l,"pointIcon")[0],h=y&&t.parsers.getParser("field").parseField(y.tags[0],y,t);return r.createChartPoint(p,l.attributes.Text||"",A(l.attributes.color),h,b)}})).filter((function(e){return!!e}))};if(o.isLineLike(e.attributes.type)){n.lineStyle=d.isSupported(i.attributes.lineStyle)?i.attributes.lineStyle:void 0,n.lineMarker=f.isSupported(i.attributes.lineMarker)?i.attributes.lineMarker:void 0,n.lineMarkerColor=A(i.attributes.lineMarkerColor),n.lineMarkerSize=C(i.attributes.lineMarkerSize,l.ptToPx),n.lineMarkerFillColor=A(i.attributes.lineMarkerFillColor),n.fillColor=A(i.attributes.fillColor);var s=a.queryJson(i,"multiFeatureLineStyles")[0];s&&(n.multiFeatureLineStyles=[],s.tags.forEach((function(e){var t={};e.attributes&&(t.color=A(e.attributes.color),t.lineStyle=d.isSupported(e.attributes.lineStyle)?e.attributes.lineStyle:void 0,t.lineMarker=f.isSupported(e.attributes.lineMarker)?e.attributes.lineMarker:void 0,t.lineMarkerColor=A(e.attributes.lineMarkerColor),t.lineMarkerSize=C(e.attributes.lineMarkerSize,l.ptToPx),t.lineMarkerFillColor=A(e.attributes.lineMarkerFillColor),t.lineThickness=C(e.attributes.lineThickness,l.ptToPx),t.fillColor=A(e.attributes.fillColor)),n.multiFeatureLineStyles.push(t)})))}return n})).filter((function(e){return e&&e.points&&!!e.points.length}))}(t,x);if(!M.length)return null;var I=t.attributes,F=a.queryTopJson(t,"chartTitle")[0],B=a.queryTopJson(t,"legend")[0],V=a.queryTopJson(t,"xAxis")[0],R=a.queryTopJson(t,"yAxis")[0],J=a.queryTopJson(t,"chartIcons")[0],j=a.queryTopJson(t,"floatingIcons")[0],q=a.queryTopJson(t,"floatingTexts")[0],D=a.queryTopJson(t,"trigger")[0],W=a.queryTopJson(t,"filter")[0],G=a.queryTopJson(t,"tooltip")[0],N=a.queryTopJson(t,"comparisonInfo")[0],E=a.queryTopJson(t,"dataDrillingPanels")[0];F.attributes=F.attributes||{};var H=V&&V.attributes,U=R&&R.attributes,_=H,z=U;x.report.isGraphicReport&&x.revisionVersion<1.3&&(_=U,z=H);var X,Z=V&&V.tags&&V.tags[0].attributes&&V.tags[0].attributes,K=R&&R.tags&&R.tags[0].attributes&&R.tags[0].attributes,Q=function(e){var t=a.queryTopJson(e,"BackImage")[0];return t&&t.tags&&t.tags[0].text?i.base64DataToDataURL(t.tags[0].text):null}(t),Y={isChart:!0,type:I._type||I.type,isMultiFeatureChart:!!I.isMultiFeatureChart,seriesItems:M,visualProperties:e.mixin({width:l.ptToPx(I.width),height:l.ptToPx(I.height),marginTop:C(I.marginTop,l.ptToPx),marginRight:C(I.marginRight,l.ptToPx),marginBottom:C(I.marginBottom,l.ptToPx),marginLeft:C(I.marginLeft,l.ptToPx),backgroundColor:A(I.backColor),backgroundColorOpacity:C(I.backgroundColorOpacity),plotAreaOutlineColor:A(I.plotAreaOutlineColor),plotAreaOutlineOpacity:C(I.plotAreaOutlineOpacity),plotAreaOutlineThickness:C(I.plotAreaOutlineThickness,l.ptToPx),plotAreaOutlineStyle:d.isSupported(I.plotAreaOutlineStyle)?I.plotAreaOutlineStyle:void 0,panelBackgroundColor:A(I.panelBackgroundColor),backgroundImageData:Q,noTableView:!!I.noTableView,title:{text:F.attributes.text,align:F.attributes.align&&F.attributes.align.toLowerCase(),style:P(F.attributes.style),verticalShift:C(F.attributes.verticalShift,l.ptToPx)},xAxis:H&&e.mixin({show:"None"!==H.placement,hideLine:void 0!==H.line?!H.line:H.hideLine,showTicks:H.ticks,ticksInside:H.ticksInside||void 0,hideLabels:H.hideLabels||void 0,placement:"OtherSide"===H.placement?"OtherSide":void 0,title:Z&&Z.text,titleStyle:Z&&P(Z.style),style:P(H.style),labelsAngle:C(H.labelsAngle),lineColor:A(H.lineColor)},k(_,!1,x)),yAxis:U&&e.mixin({show:"None"!==U.placement,hideLine:void 0!==U.line?!U.line:U.hideLine,showTicks:U.ticks,ticksInside:U.ticksInside,hideLabels:U.hideLabels||void 0,placement:"OtherSide"===U.placement?"OtherSide":void 0,title:K&&K.text,titleStyle:K&&P(K.style),style:P(U.style),labelsAngle:C(U.labelsAngle),lineColor:A(U.lineColor),showPercentSymbol:U.showPercentSymbol,showCurrencySymbol:U.showCurrencySymbol,showSymbolForAllLabels:U.showSymbolForAllLabels,showValuesAsWeightsInSeries:U.showValuesAsWeightsInSeries,nonZeroInclusive:U.nonZeroInclusive},k(z,!0,x)),isStacked:I.isStacked,showValuesAsWeightInStack:I.showValuesAsWeightInStack,columnBarGap:C(I.columnBarGap,l.ptToPx),columnBarOpacity:C(I.columnBarOpacity),renderColumnBarsInOppositeDirections:I.renderColumnBarsInOppositeDirections,showColumnBarBackground:I.showColumnBarBackground,columnBarBackgroundColor:A(I.columnBarBackgroundColor),columnBarBackgroundOpacity:C(I.columnBarBackgroundOpacity),fillOpacity:C(I.fillOpacity),outlineOpacity:C(void 0!==I.columnBarLineOpacity?I.columnBarLineOpacity:I.outlineOpacity),outlineColor:A(void 0!==I.columnBarLineColor?I.columnBarLineColor:I.outlineColor),outlineThickness:C(void 0!==I.columnBarLineThickness?I.columnBarLineThickness:I.outlineThickness,l.ptToPx),outlineStyle:void 0!==I.columnBarLineStyle?d.isSupported(I.columnBarLineStyle)?I.columnBarLineStyle:void 0:d.isSupported(I.outlineStyle)?I.outlineStyle:void 0,lineOpacity:C(void 0!==I.lineOpacity?I.lineOpacity:I.lineAreaOpacity),fillLineMarkers:void 0!==I.fillLineMarkers?I.fillLineMarkers:I.fillLineArea,lineMarkersFillOpacity:C(void 0!==I.lineMarkersFillOpacity?I.lineMarkersFillOpacity:I.lineAreaOpacity),fillLineArea:I.fillLineArea,lineAreaOpacity:C(I.lineAreaOpacity),donutHolePercent:C(I.donutHolePercent),donutGap:C(I.donutGap),donutArcPercent:C(I.donutArcPercent),gaugeHolePercent:C(I.gaugeHolePercent),gaugeRangeMin:C(I.gaugeRangeMin),gaugeRangeMax:C(I.gaugeRangeMax),gaugeGap:C(I.gaugeGap),gaugeStartAngle:C(I.gaugeStartAngle),gaugeArcPercent:C(I.gaugeArcPercent),gaugeLabelStyle:P(I.gaugeLabelStyle),gaugeLabelPlacement:I.gaugeLabelPlacement?b.toSupportedValue(I.gaugeLabelPlacement):void 0,gaugeShowArrow:I.gaugeShowArrow||void 0,gaugeArrowLineColor:A(I.gaugeArrowLineColor),gaugeArrowFillColor:A(I.gaugeArrowFillColor),gaugeConditionalStylingOthers:void 0!==I.gaugeConditionalStylingIgnoreOthers?I.gaugeConditionalStylingIgnoreOthers:I.gaugeConditionalStylingOthers||void 0,gaugeConditionalStylingLabel:I.gaugeConditionalStylingLabel||void 0,gaugeShowFromToLabels:I.gaugeShowFromToLabels||void 0,gaugeFromLabelStyle:P(I.gaugeFromLabelStyle),gaugeToLabelStyle:P(I.gaugeToLabelStyle),waffleDirection:I.waffleDirection?h.toSupportedValue(I.waffleDirection):void 0,waffleFlowStyle:S.isSupported(I.waffleFlowStyle)?I.waffleFlowStyle:void 0,waffleShowWholePictures:I.waffleShowWholePictures||void 0,waffleStretchIconsToFill:I.waffleStretchIconsToFill||void 0,waffleRangeMin:C(I.waffleRangeMin),waffleRangeMax:C(I.waffleRangeMax),waffleLabelPlacement:I.waffleLabelPlacement?y.toSupportedValue(I.waffleLabelPlacement):void 0,waffleLabelOffset:C(I.waffleLabelOffset,l.ptToPx),waffleHideValue:I.waffleHideValue||void 0,waffleHideLabel:I.waffleHideLabel||void 0,waffleShowLabelAbove:I.waffleShowLabelAbove||void 0,waffleValueStyle:P(I.waffleValueStyle),waffleLabelStyle:P(I.waffleLabelStyle),waffleColumnSpace:C(I.waffleColumnSpace,l.ptToPx),waffleRowSpace:C(I.waffleRowSpace,l.ptToPx),waffleConditionalStylingOthers:void 0!==I.waffleConditionalStylingIgnoreOthers?I.waffleConditionalStylingIgnoreOthers:I.waffleConditionalStylingOthers||void 0,waffleConditionalStylingValue:I.waffleConditionalStylingValue||void 0,waffleConditionalStylingLabel:I.waffleConditionalStylingLabel||void 0,waffleNumIcons:C(I.waffleNumIcons),waffleNumRows:C(I.waffleNumRows),waffleNumColumns:C(I.waffleNumColumns),ringBackgroundColor:A(I.ringBackgroundColor),ringBackgroundOpacity:C(I.ringBackgroundOpacity),columnBarShowWholePictures:void 0!==I.showWholePictures?I.showWholePictures:I.columnBarShowWholePictures,showAxisIcons:I.showAxisIcons,showChartIcons:I.showChartIcons,sorting:g.isSupported(I.sorting)?I.sorting:void 0},(X=I,{dataLabels:c.toSupportedValue(X.dataLabels),dataLabelsShowLabelUnder:X.dataLabelsShowLabelUnder,dataLabelsDecimals:O(X.CustomPercentFormat||X.CustomValueFormat),dataLabelsStyle:P(X.dataLabelsStyle),dataLabelsLabelStyle:X.dataLabelsLabelStyle?P(X.dataLabelsLabelStyle):P(X.dataLabelsStyle),dataLabelsAltColor:A(X.dataLabelsAltColor),dataLabelsEnableAltColor:X.dataLabelsEnableAltColor,dataLabelsInside:X.dataLabelsInside,dataLabelsStackedInColumns:X.dataLabelsStackedInColumns,dataLabelsHorizontalAlign:X.dataLabelsHorizontalAlign,dataLabelsVerticalAlign:X.dataLabelsVerticalAlign,dataLabelsShowValuePercentSymbol:X.dataLabelsShowValuePercentSymbol,dataLabelsShowValueCurrencySymbol:X.dataLabelsShowValueCurrencySymbol,dataLabelsAngle:C(X.dataLabelsAngle),dataLabelsMaxWidth:C(X.dataLabelsMaxWidth,l.ptToPx)}))},$=C(M[0]._originalAttrs.thickness);if(o.isColumnBarLike(I.type)?Y.visualProperties.columnThickness=$>1?p.LARGE:$<1?p.SMALL:p.MEDIUM:o.isLineLike(I.type)&&(Y.visualProperties.lineThickness=w($,x),M.forEach((function(e){e._originalAttrs.thickness!==$&&(e.lineThickness=C(e._originalAttrs.thickness,l.ptToPx))}))),M.forEach((function(e){delete e._originalAttrs})),B){var ee=B&&B.attributes||{};Y.visualProperties.legend={type:n.toSupportedValue(ee.type)},Y.visualProperties.legend.type===n.MIN_MAX?e.mixin(Y.visualProperties.legend,{minMax:{placement:s.toSupportedValue(ee.placement),placementOffset:C(ee.placementOffset),titleStyle:P(ee.titleStyle),minVariableLabelStyle:P(ee.minVariableLabelStyle),maxVariableLabelStyle:P(ee.maxVariableLabelStyle)}}):e.mixin(Y.visualProperties.legend,{series:{placement:s.toSupportedValue(ee.placement),placementOffset:C(ee.placementOffset),hasBorder:ee.hasBorder,labelParts:ee.labelParts,style:P(ee.style),symbol:u.isSupported(ee.symbol)?ee.symbol:void 0,hideOthers:ee.hideOthers||void 0,showComparison:ee.showComparison||void 0}})}x.revisionVersion<1.2&&(void 0!==Y.visualProperties.donutGap&&(Y.visualProperties.donutGap/=2*Math.PI),void 0!==Y.visualProperties.gaugeGap&&(Y.visualProperties.gaugeGap/=2*Math.PI));var te=J&&J.tags;te&&te.length&&(Y.visualProperties.chartIcons=te.map((function(e){return e.tags&&e.tags[0]?x.parsers.getParser("field").parseField(e.tags[0],e,x):null})));var ie=j&&j.tags;ie&&ie.length&&(Y.visualProperties.floatingIcons=ie.map((function(e){return x.parsers.getParser("section").parseTable(e.tags[0],x)})));var ae=q&&q.tags;if(ae&&ae.length&&(Y.visualProperties.floatingTexts=ae.map((function(e){return x.parsers.getParser("section").parseTable(e.tags[0],x)}))),D&&(Y.visualProperties.conditionalStyling=x.parsers.getParser("field").parseFieldTrigger(D)),W&&(Y.visualProperties.filter=x.parsers.getParser("filter").getFilter(W)),G){var le=G.attributes||{};Y.visualProperties.tooltip={title:!!le.title,value:!!le.value,weight:!!le.weight,min:!!le.min,max:!!le.max,avg:!!le.avg,conditional:!!le.conditional,fieldInfo:null,style:P(le.style),linkStyle:P(le.linkStyle)};var re=a.queryTopJson(G,"template")[0];Y.visualProperties.tooltip.fieldInfo=re&&x.parsers.getParser("field").parseRichTextTag(re,x),Y.visualProperties.tooltip.templateValues=T(G,x)}if(E){var oe=a.queryTopJson(E,"dataDrillingPanel")[0],ne=oe&&a.queryTopJson(oe,"section")[0];ne&&(Y.dataDrillingPanelInfo={sectionJson:x.parsers.getParser("section").parseSection(ne,x),templateValues:T(oe,x),showOnClick:oe.attributes&&oe.attributes.showOnClick})}if(N){var se=N.attributes,ue=se.name,ce=x.templateJson.metadata.comparisonCalculatorsHash[ue];ce&&(Y.comparisonInfo={calculatorName:ue,chartType:se.chartType,color:A(se.color),lineThickness:w(se.lineThickness,x),lineStyle:d.isSupported(se.lineStyle)?se.lineStyle:void 0,lineMarker:f.isSupported(se.lineMarker)?se.lineMarker:void 0,lineMarkerColor:A(se.lineMarkerColor),lineMarkerSize:C(se.lineMarkerSize,l.ptToPx),lineMarkerFillColor:A(se.lineMarkerFillColor),levels:ce.levels,defaultLevel:se.defaultLevel})}var pe={};return v.attributes&&v.attributes.style&&e.mixin(pe,l.parseStyleString(v.attributes.style)),l.ptToPxObj(pe),r.provideDefaultValueForMissing(Y,{font:pe}),x.postProcessChartJson(t,Y),Y},v}));