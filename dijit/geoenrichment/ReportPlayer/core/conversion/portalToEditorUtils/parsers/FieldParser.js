// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

define(["esri/dijit/geoenrichment/utils/JsonXmlConverter","../../../supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil","../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder","../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoFormatUtil","../../../supportClasses/conditionalStyling/ConditionalStyleUtil","../../ConversionUtil","../../ShapeConverter","../../../annotations/shape/ShapeJsonUtil","./_FieldInfoBuilder","./ImageParser","./MapParser","./AlignParser","../../../../_devConfig"],(function(e,r,t,a,n,i,o,s,l,u,f,p,g){var c={};function d(e){var r=e.attributes||{};return a.processFieldInfoTagAttributes(r),r}var m={parseImageTrigger:function(e,r){var t=l.getCalculatorOrScriptFieldInfo(e.attributes.field,r);if(!t)return console.log("Parse template error => can't build fieldInfo for field "+e.attributes.field),console.log(e),null;var a={fieldInfo:t,cases:[]},n=this;return e.tags.forEach((function(e){var t="case"===e.name?e.attributes&&e.attributes.key:"default",i=e.tags[0],o=r.processFileName(i.attributes.value);a.cases.push({isDefault:"default"===t,compareInfos:"default"!==t&&t?n._getCompareInfosFromTriggerKey(t):null,setters:[{property:i.attributes.property,value:o}]}),o&&r.putImageData(o)})),n._parseCalcMethod(e,a)?a:null},parseFieldTrigger:function(e,r,t){var a=r.triggerJson={fieldInfo:t&&l.getCalculatorOrScriptFieldInfo(e.attributes.field,t),cases:[]},n=this;e.tags.forEach((function(e){var r="case"===e.name?e.attributes&&e.attributes.key:"default",t={isDefault:"default"===r,compareInfos:"default"!==r&&r?n._getCompareInfosFromTriggerKey(r):null,setters:[]};a.cases.push(t),e.tags.forEach((function(e){t.setters.push({property:e.attributes.property,value:e.attributes.value})}))})),n._parseCalcMethod(e,a)||(r.triggerJson=null)},_getCompareInfosFromTriggerKey:function(e){return e.split(i.KEY_INTERVAL_SEPARATOR).map((function(e){var r=i.ONE_FIELD_KEY_TEST.test(e)?e.replace(i.KEY_OPERATOR_RE,""):e;return{value:r,operator:e.substr(0,e.length-r.length)||"="}}))},_parseCalcMethod:function(e,r){var t=e.attributes&&e.attributes.calcMethod;if(t&&e.attributes.groupId){if(!n.isSupportedStyleCalcMethod(t))return!1;r.calcMethod=t,r.groupId=e.attributes.groupId}return!0}},I=function(e,r,a){var n=a.parsers.getParser("chart").portalToEditor(e,r,a);return n&&t.createFieldInfoFromChart(n)},h=function(e,r,a){var n=a.parsers.getParser("infographic").portalToEditor(e,r,a);return n&&t.createFieldInfoFromInfographic(n)},F=function(r,a,n){var i,o=u.getElement(r,n),s=e.queryTopJson(r,"trigger")[0]||e.queryTopJson(r,"trigger2")[0];if(s&&(i=m.parseImageTrigger(s,n))){var l=e.queryTopJson(r,"dataDrillingPanels")[0],f=l&&e.queryTopJson(l,"dataDrillingPanel")[0];f&&S(i.fieldInfo,f,n);var p=e.queryTopJson(r,"tooltip")[0];p&&J(i.fieldInfo,p,n)}return t.createFieldInfoFromImage(o,i)},v=function(e,r,a){var n=f.getElement(e,a);return t.createFieldInfoFromMap(n)},b=function(e,r,a){var n=o.svgJsonToShapeObject(e),i=o.getStylesFromSvgJson(e),l=s.createShapeJsonFromShapeObj(n,i),u=e.attributes;if(l.style.angle=Number(u.angle)||0,p.parseAlign(u,l.style),a.revisionVersion<2){var f=Math.max(l.style.borderAlpha>0&&l.style.borderWidth||0,l.backgroundStyle.borderAlpha>0&&l.backgroundStyle.borderWidth||0);if(f>0){var g=f,c=l.viewBox;c.xmin=c.xmin||0,c.ymin=c.ymin||0,c.xmin-=g/4,c.ymin-=g/4,c.width+=g/2,c.height+=g/2}}return t.createFieldInfoFromShape(l)},T=function(e,r,a){var n=a.parsers.getParser("section").parseSection(e,a);return t.createFieldInfoFromSection(n)},y=function(e,r,a,n,i,o,s){var u=d(e);if(s=s||u.f,a.templateJson.metadata.mapImageInfosHash[s]){var p=f.parseMapImageDField(s,a);return t.createFieldInfoFromMap(p)}var g,c=t.createFieldInfoFromSpecialFieldName(s,u.mObj);c||(2===r.tags.length&&r.tags[1].text&&(g=r.tags[1].text),c=l.getCalculatorOrScriptFieldInfo(s,a,{format:u.mObj,additionalText:g,summaryType:u.summary}));return c&&n&&(m.parseFieldTrigger(n,c,a),c.triggerJson&&!c.triggerJson.fieldInfo&&(c.triggerJson.fieldInfo=null,console.log("Parse template error => can't build fieldInfo for field "+n.attributes.field),console.log(n))),c&&i&&S(c,i,a),c&&o&&J(c,o,a),c};function S(r,t,a){var n=e.queryTopJson(t,"section")[0];n&&(r.dataDrillingPanelInfo={sectionJson:a.parsers.getParser("section").parseSection(n,a)})}function J(r,t,a){var n,o=t.attributes||{};r.tooltipInfo={value:!!o.value,alias:!!o.alias,expression:!!o.expression,conditional:!!o.conditional,fieldInfo:null,style:(n=o.style,i.ptToPxObj(i.parseStyleString(n)))};var s=e.queryTopJson(t,"textContent")[0];r.tooltipInfo.fieldInfo=s&&a.parsers.getParser("field").parseRichTextTag(s,a,!0)}function E(r){return e.queryJson(r,/^d$|^text$|^reportName$|^reportTitle2/)}return c.parseField=function(e,r,a,n,i,o){var s;if(g.emulateErrors.layoutParseError)throw g.emulateErrors.layoutParseError--,new Error("Error test: something crashed during the parsing of the layout!");if(e){if("chart"===e.name)return I(e,r,a);if("infographic"===e.name)return h(e,r,a)||!1;if("img"===e.name&&e.attributes)return F(e,r,a);if("mapImage"===e.name&&e.attributes)return v(e,r,a);if("svg"===e.name)return b(e,r,a);if("section"===e.name)return T(e,r,a);if("d"===e.name)s=y(e,r,a,n,i,o);else if("a"===e.name&&e.tags&&"d"===e.tags[0].name){var l=e.tags[0];(s=y(l,r,a,n,i,o))&&e.attributes&&e.attributes.hreff&&(s.linkFieldInfo=y(l,r,a,n,i,o,e.attributes.hreff))}else s="text"===e.name?t.createFieldInfoFromSpecialFieldName(d(e).name):t.createFieldInfoFromSpecialFieldName(e.name,d(e).mObj)}if(!s){var u=E(r);if(1===u.length&&u[0].attributes&&"TrialUrlText"===u[0].attributes.name)return t.createFieldInfoFromSpecialFieldName(u[0].attributes.name);s=c.parseRichTextTag(r,a)}return s},c.parseRichTextTag=function(a,n,i){var o,s=/^img$|^script/;e.queryJson(a,s).length&&(a.innerHTML=null,a.tags=a.tags.filter((function(e){return!s.test(e.name)})));var l=E(a);if(l.length||i){var u=[],f=!0;l.some((function(e){var r=e.attributes?e.attributes.name:e.name,i="d"===e.name?y(e,a,n):r&&t.createFieldInfoFromSpecialFieldName(r);if(!i)return f=!1,!0;u.push(i)})),f&&(o=r.createFieldInfoFromRichText(e.getInnerHTML(a),u))}return o},c.parseFieldTrigger=function(e,r,t){return r=r||{},m.parseFieldTrigger(e,r,t),r.triggerJson},c}));