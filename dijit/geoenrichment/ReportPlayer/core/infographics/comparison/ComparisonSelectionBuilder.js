// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/on","esri/dijit/geoenrichment/when","dojo/dom-class","dojo/dom-construct","../../comparison/ComparisonSelect","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(e,t,i,o,n,l,r,s,a,d,u,h){return h=h.geoenrichment.dijit.ReportPlayer.ComparisonTableInfographic,e(null,{grid:null,groups:null,fields:null,selectedLevelsCache:null,additionalColumnsCache:null,variablesInColumns:!1,isEditMode:!1,simplifySelectionForSingleGeography:!0,numThisAreas:1,constructor:function(e){t.mixin(this,e),this.grid.own(i.after(this.grid,"refresh",this._initDropDowns.bind(this))),this.grid.canSortCellFunc=function(e){return!d.isMouseOver(e.__geographySelect&&e.__geographySelect.domNode)&&!d.isMouseOver(e.__removeAdditionalColumnOrRowButton)},this._initDropDowns()},_initDropDowns:function(){var e;n(this.grid.getRenderPromise(),function(){if(this.variablesInColumns){var t=this.grid.getSortRowIndexMapping();e=this.grid.queryCells({columnIndex:0}),t&&(_fieldCells=[],e.forEach(function(e,i){_fieldCells[t[i]]=e}),e=_fieldCells)}else e=this.grid.queryCells({rowIndex:0});e.shift();for(var i=0;i<this.numThisAreas;i++)e.shift();this._addDropDownsToCells(e)}.bind(this))},_addDropDownsToCells:function(e){e.forEach(function(e,t){var i=this.groups[t];this._addDropDownToCell(e,i)},this)},_addDropDownToCell:function(e,t){function n(){var t=e.getFullStyle();c.style.paddingLeft=c.style.paddingRight=t.horizontalPadding+"px";var i=e.getContentWidth()-2+"px";p.style.maxWidth=c.style.width=i,f?f.domNode.style.maxWidth=i:g.style.maxWidth=i,c.style.textAlign=t.horizontalAlign,p.style.height=p.style.lineHeight=e.getContentHeight()/2+"px",g.style.height=g.style.lineHeight=e.getContentHeight()/2+"px",C&&(C.style.top=(g.clientHeight-C.clientHeight)/2+"px")}var d=this;if(e.__addDropDownCleanUp&&e.__addDropDownCleanUp(),t.features.length){var c=r.create("div",{class:"esriGEComparisonSelectionBuilder_root"}),p=r.create("div",{innerHTML:t.label,class:"esriGEComparisonSelectionBuilder_title TrimWithEllipses"},c),g=r.create("div",{class:"esriGEComparisonSelectionBuilder_select"},c);if(t.features.length>1||!this.simplifySelectionForSingleGeography){var f=new s({class:"esriGEOnDemandSelectNoBackground",fields:this.fields,canAddFeatures:!0,addFeatureMessage:this.variablesInColumns?h.showInSeparateRow:h.showInSeparateColumn,featureIsAlreadyAddedMessage:h.alreadyAdded,onFeatureSelected:function(e,t){d.onFeatureSelected(e,t)},isFeatureAdded:function(e,i){if((d.selectedLevelsCache[t.levelId]||t.features[0].attributes.StdGeographyID)===i)return!0;var o=d.additionalColumnsCache[t.levelId];return o&&-1!==o.indexOf(i)},onAddFeature:function(e,t){d.onAddFeature(e,t)}}).placeAt(g);e.own(f),f.setGroups([t]),f.setValue(t.levelId,this.selectedLevelsCache[t.levelId]||t.features[0].attributes.StdGeographyID);var m=e.getFullStyle().color;f.selectedLabel.style.color=m,f.arrow.style.borderTopColor=m}else if(g.innerHTML=t.features[0].attributes.StdGeographyName,l.add(g,"TrimWithEllipses"),t.isRemovable){g.style.position="relative";var C=r.create("div",{class:"esriGEComparisonTableInfographic_removeButton"},g);u.setTooltipToNode(C,this.variablesInColumns?h.removeRow:h.removeColumn),o(C,"click",function(e){e.stopPropagation(),d.onRemoveAdditionalFeature(t.levelId,t.additionalFeatureId)}),e.__removeAdditionalColumnOrRowButton=C}var v=[];v.push(i.after(e,"setWidth",n)),v.push(i.after(e,"setHeight",n)),v.push(i.after(this.grid,"renderCell",function(i){i===e&&d._addDropDownToCell(e,t)},!0)),v.forEach(function(t){e.own(t)}),a.enableContentAbsolute(g,!this.isEditMode,{isTransparent:!0}),e.setContent(c),e.set("value",""),n(),e.__addDropDownCleanUp=function(){v.forEach(function(e){e.remove()}),f&&f.destroy(),delete e.__addDropDownCleanUp},e.__geographySelect=f,u.autoTooltip(c)}},onFeatureSelected:function(e,t){},onAddFeature:function(e,t){},onRemoveAdditionalFeature:function(e,t){}})});