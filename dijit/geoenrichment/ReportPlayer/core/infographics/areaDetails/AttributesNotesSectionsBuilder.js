// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/when","../../supportClasses/tableJson/TableJsonUtil","../../supportClasses/tableJson/TableJsonResizeUtil","./AreaDetailsLayouts","../../../dataProvider/supportClasses/attachments/AttributesUtil","../../sections/SectionTypes","esri/dijit/geoenrichment/utils/FieldUtil","dojo/i18n!esri/nls/jsapi"],(function(t,e,n,o,r,i,s,l,a,u){u=u.geoenrichment.dijit.ReportPlayer.AreaDetailsInfographic;var c={buildDataInfo:function(t){return n(c._calcBuildInfo(t),(function(e){if(!e)return null;var n,o=c._createAttributesSectionJsons(e.attributes,t.infographicJson,t.defaultCellStyle),i=c._createNotesSectionJsons(e.notes,t.infographicJson,t.defaultCellStyle);if(e.canFitOnSinglePage)if(o.length)if(i.length){var s=o[0],l=i[0].stack[0];l.style.top=e.attributes.totalHeight,s.stack.push(l),n=[s]}else n=o;else n=i;else(n=(n=(n=[]).concat(o)).concat(i)).forEach((function(n){r.resizeTableJsonToFitWidth(n.stack[0],t.width),t.scaleToFitHeight&&r.resizeTableJsonToFitHeight(n.stack[0],e.contentHeight-t.footerHeight)}));return n.length?{sectionJsons:n,stats:{numAttributesTotal:e.attributes.numTotal,numAttributesShown:e.attributes.numShown,numNotesTotal:e.notes.numTotal,numNotesShown:e.notes.numShown}}:null}))},_calcBuildInfo:function(t){var e=t.infographicJson,r=t.titleHeight,s=t.minRowHeight,l=t.scaleToFitHeight,a=t.footerHeight,u=t.searchTextRe,h=t.forceSinglePage,m=t.width,f=t.height;return n(c._getData(t),(function(t){var n=t.attrs||[],g=t.benchmarkAttrs,w=t.notes||[];if(e.attributesSectionJson||(n=[]),e.notesSectionJson||(w=[]),!n.length&&!w.length)return null;var d,S,b=n.length,T=w.length;u&&(n=n.filter((function(t){return u.test(t.alias)})),w=w.filter((function(t){return u.test(t.text)}))),d=n.length,S=w.length;var y=n.length,A=w.length,p=e.attributesLayout===i.ATTRS_2COLUMNS;function v(t){return(p?Math.round(t.length/2):t.length)+(e.showAttributesTitle?1:0)}var _,J=p?Math.round(n.length/2):n.length,C=v(n),H=w.length,R=H+(e.showNotesTitle?1:0),k=C+R,x=f-r,N=Math.max(s||o.DEFAULT_ROW_HEIGHT,x/k),I=y&&e.showAttributesTitle?N:0,F=y?N:0,P=A&&e.showNotesTitle?N:0,E=A?N:0;l||(y&&(e.showAttributesTitle&&(_=e.attributesSectionJson.stack[0].rows[0])&&(I=_.style.height),(_=e.attributesSectionJson.stack[0].rows[e.showAttributesTitle?1:0])&&(F=_.style.height)),A&&(e.showNotesTitle&&(_=e.notesSectionJson.stack[0].rows[0])&&(P=_.style.height),(_=e.notesSectionJson.stack[0].rows[e.showNotesTitle?1:0])&&(E=_.style.height)));var D,O,U=h||I+F*J+P+E*H<=x+1;return U?(D=[{attrs:n,numRows:C}],O=[{notes:w,numRows:R}]):(D=c._splitByPages(n,I,F*(p?.5:1),x,a).map((function(t){return{attrs:t,numRows:v(t)}})),O=c._splitByPages(w,P,E,x,a).map((function(t){return{notes:t,numRows:t.length+(e.showNotesTitle?1:0)}}))),{canFitOnSinglePage:U,contentHeight:x,attributes:{attrGroups:D,numColumns:p?4:2,titleRowH:I,dataRowH:F,width:m,numTotal:b,numShown:d,totalHeight:I+F*J,benchmarkAttrs:g},notes:{noteGroups:O,numColumns:1,titleRowH:P,dataRowH:E,width:m,numTotal:T,numShown:S,totalHeight:P+E*H}}}))},_getData:function(t){var o=t.attachmentsStore;return o?(o.supportsMultipleAreas&&o.setCurrentAnalysisAreaIndex(t.currentFeatureIndex),e([o.getAttributes(),o.getNotes()]).then((function(e){var r={attrs:e[0]||[],notes:e[1]||[]};return t.benchmarkController&&t.benchmarkController.getAreaIndex()>=0&&t.benchmarkController.getAreaIndex()!==t.currentFeatureIndex&&o.supportsMultipleAreas?(o.setCurrentAnalysisAreaIndex(t.benchmarkController.getAreaIndex()),n(o.getAttributes(),(function(t){return t&&(r.benchmarkAttrs={},t.forEach((function(t){r.benchmarkAttrs[t.name]=t}))),r}))):r}))):{}},_splitByPages:function(t,e,n,o,r){var i,s=o-r,l=[],a=0;return t.forEach((function(t){i||(i=[],l.push(i),a+=e),i.push(t),(a+=n)+n>s&&(i=null,a=0)})),l},_createAttributesSectionJsons:function(e,n,r){var h=c._getSourceSectionStyle(n.attributesSectionJson,n.showAttributesTitle);return e.attrGroups.map((function(m){var f=m.attrs,g=m.numRows;if(!f.length)return null;var w=o.createTable({numColumns:e.numColumns,numRows:g,style:{width:e.width},useDefaultHeaderTheme:!1}),d=0;function S(t,e,n){return c._getCellStyle(t,e,n,h,r)}var b=n.attributesLayout===i.ATTRS_2COLUMNS;function T(n,r,i){r=r||0,o.modifyTableJson(w,d,0+r,{text:n?n.alias:"",cellStyle:S(!1,0+r,i),height:e.dataRowH});var l=s.formatAttributeValue(n),u=e.benchmarkAttrs&&e.benchmarkAttrs[n.name];if(u&&a.isNumericField(n)){var c=n.value-u.value;l+=" ("+(c>0?"+":"")+s.formatAttributeValue(t.mixin({},n,{value:c,domain:null}))+")"}o.modifyTableJson(w,d,1+r,{text:l,cellStyle:S(!1,1+r,i)})}n.showAttributesTitle&&(o.modifyTableJson(w,d,0,{text:h.title||u.attributes,columnSpan:e.numColumns,cellStyle:S(!0,0,-1),height:e.titleRowH}),d++);for(var y=0,A=0;A<f.length;A++){var p=f[A];T(p,0,y),b&&T(p=f[++A],e.numColumns/2,y),d++,y++}return{type:l.INFOGRAPHIC_ATTRIBUTES,stack:[w]}})).filter((function(t){return!!t}))},_createNotesSectionJsons:function(t,e,n){var r=c._getSourceSectionStyle(e.notesSectionJson,e.showNotesTitle);return t.noteGroups.map((function(i){var s=i.notes,a=i.numRows;if(!s.length)return null;var h=o.createTable({numColumns:t.numColumns,numRows:a,style:{width:t.width},useDefaultHeaderTheme:!1}),m=0;function f(t,e){return c._getCellStyle(t,0,e,r,n)}e.showNotesTitle&&(o.modifyTableJson(h,m,0,{text:r.title||u.notes,cellStyle:f(!0,-1),height:t.titleRowH}),m++);var g=0;return s.forEach((function(e){o.modifyTableJson(h,m,0,{text:e.text,cellStyle:f(!1,g),height:t.dataRowH}),m++,g++})),{type:l.INFOGRAPHIC_NOTES,stack:[h]}})).filter((function(t){return!!t}))},_getSourceSectionStyle:function(t,e){var n={titleStyle:null,title:null};if(t){var o=t.stack[0],r=o.columns[0].field,i=0;if(e){var s=o.rows[i++];s&&(n.titleStyle=s.style.fields[r],n.title=s[r])}for(var l=0;o.rows[i];){var a=o.rows[i++];o.columns.forEach((function(t,e){n["row"+l+"_column"+e]=a.style.fields[t.field]})),l++}}return n},_getCellStyle:function(e,n,o,r,i){var s,l=o%2!=0,a=n%2!=0;e?s=r.titleStyle:(s=r["row"+o+"_column"+n])||(s=l?r["row1_column"+n]||(a?r.row1_column1:r.row1_column0)||r.row1_column0:r["row0_column"+n]||(a?r.row0_column1:r.row0_column0)||r.row0_column0);var u=t.mixin({verticalAlign:"middle",horizontalAlign:a?"right":void 0,horizontalPadding:e||n>0?5:20},i);return e&&(u.fontSize*=1.2),t.mixin(u,s),u}};return c}));