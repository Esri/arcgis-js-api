// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/promise/all","dojo/when","../../supportClasses/tableJson/TableJsonUtil","../../supportClasses/tableJson/TableJsonResizeUtil","./AreaDetailsLayouts","../../../dataProvider/supportClasses/attachments/AttributesUtil","../../sections/SectionTypes","dojo/i18n!esri/nls/jsapi"],function(t,e,n,o,i,l,a,s,r){r=r.geoenrichment.dijit.ReportPlayer.AreaDetailsInfographic;var u={buildDataInfo:function(t){return n(u._calcBuildInfo(t),function(e){if(!e)return null;var n,o=u._createAttributesSectionJsons(e.attributes,t.infographicJson,t.defaultCellStyle),l=u._createNotesSectionJsons(e.notes,t.infographicJson,t.defaultCellStyle);if(e.canFitOnSinglePage)if(o.length)if(l.length){var a=o[0],s=l[0].stack[0];s.style.spaceBefore=e.attributes.totalHeight,a.stack.push(s),n=[a]}else n=o;else n=l;else{var n=[];n=n.concat(o),n=n.concat(l),n.forEach(function(n){i.resizeTableJsonToFitWidth(n.stack[0],t.width),t.scaleToFitHeight&&i.resizeTableJsonToFitHeight(n.stack[0],e.contentHeight-t.footerHeight)})}return n.length?{sectionJsons:n,stats:{numAttributesTotal:e.attributes.numTotal,numAttributesShown:e.attributes.numShown,numNotesTotal:e.notes.numTotal,numNotesShown:e.notes.numShown}}:null})},_calcBuildInfo:function(t){var n=t.attachmentsStore,i=t.infographicJson,a=t.currentFeatureIndex,s=t.titleHeight,r=t.minRowHeight,c=t.scaleToFitHeight,h=t.footerHeight,f=t.searchTextRe,m=t.forceSinglePage,g=t.width,d=t.height;return n?(n.setCurrentAnalysisAreaIndex&&n.setCurrentAnalysisAreaIndex(a),e([n.getAttributes(),n.getNotes()]).then(function(t){function e(t){return(_?Math.round(t.length/2):t.length)+(i.showAttributesTitle?1:0)}var n=t[0]||[],a=t[1]||[];if(i.attributesSectionJson||(n=[]),i.notesSectionJson||(a=[]),!n.length&&!a.length)return null;var w=n.length,S=0,T=a.length,y=0;f&&(n=n.filter(function(t){return f.test(t.alias)}),a=a.filter(function(t){return f.test(t.text)})),S=n.length,y=a.length;var b=n.length,p=a.length,_=i.attributesLayout===l.ATTRS_2COLUMNS,v=_?Math.round(n.length/2):n.length,A=e(n),J=a.length,H=J+(i.showNotesTitle?1:0),R=A+H,C=d-s,N=Math.max(r||o.DEFAULT_ROW_HEIGHT,C/R),x=b&&i.showAttributesTitle?N:0,I=b?N:0,k=p&&i.showNotesTitle?N:0,P=p?N:0;if(!c){var F;b&&(i.showAttributesTitle&&(F=i.attributesSectionJson.stack[0].data.data[0])&&(x=F.style.height),(F=i.attributesSectionJson.stack[0].data.data[i.showAttributesTitle?1:0])&&(I=F.style.height)),p&&(i.showNotesTitle&&(F=i.notesSectionJson.stack[0].data.data[0])&&(k=F.style.height),(F=i.notesSectionJson.stack[0].data.data[i.showNotesTitle?1:0])&&(P=F.style.height))}var E,O,B=x+I*v+k+P*J,G=m||B<=C+1;return G?(E=[{attrs:n,numRows:A}],O=[{notes:a,numRows:H}]):(E=u._splitByPages(n,x,I*(_?.5:1),C,h).map(function(t){return{attrs:t,numRows:e(t)}}),O=u._splitByPages(a,k,P,C,h).map(function(t){return{notes:t,numRows:t.length+(i.showNotesTitle?1:0)}})),{canFitOnSinglePage:G,contentHeight:C,attributes:{attrGroups:E,numColumns:_?4:2,titleRowH:x,dataRowH:I,width:g,numTotal:w,numShown:S,totalHeight:x+I*v},notes:{noteGroups:O,numColumns:1,titleRowH:k,dataRowH:P,width:g,numTotal:T,numShown:y,totalHeight:k+P*J}}})):null},_splitByPages:function(t,e,n,o,i){var l,a=o-i,s=[],r=0;return t.forEach(function(t){l||(l=[],s.push(l),r+=e),l.push(t),(r+=n)+n>a&&(l=null,r=0)}),s},_createAttributesSectionJsons:function(t,e,n){var i=u._getSourceSectionStyle(e.attributesSectionJson,e.showAttributesTitle);return t.attrGroups.map(function(c){function h(t,e,o){return u._getCellStyle(t,e,o,i,n)}function f(e,n,i){n=n||0,o.modifyTableJson(d,w,0+n,{text:e?e.alias:"",cellStyle:h(!1,0+n,i),height:t.dataRowH}),o.modifyTableJson(d,w,1+n,{text:a.formatAttributeValue(e),cellStyle:h(!1,1+n,i)})}var m=c.attrs,g=c.numRows;if(!m.length)return null;var d=o.createTable({numColumns:t.numColumns,numRows:g,style:{width:t.width},useDefaultHeaderTheme:!1}),w=0,S=e.attributesLayout===l.ATTRS_2COLUMNS;e.showAttributesTitle&&(o.modifyTableJson(d,w,0,{text:i.title||r.attributes,columnSpan:t.numColumns,cellStyle:h(!0,0,-1),height:t.titleRowH}),w++);for(var T=0,y=0;y<m.length;y++){var b=m[y];f(b,0,T),S&&(b=m[++y],f(b,t.numColumns/2,T)),w++,T++}return{type:s.INFOGRAPHIC_ATTRIBUTES,stack:[d]}}).filter(function(t){return!!t})},_createNotesSectionJsons:function(t,e,n){var i=u._getSourceSectionStyle(e.notesSectionJson,e.showNotesTitle);return t.noteGroups.map(function(l){function a(t,e){return u._getCellStyle(t,0,e,i,n)}var c=l.notes,h=l.numRows;if(!c.length)return null;var f=o.createTable({numColumns:t.numColumns,numRows:h,style:{width:t.width},useDefaultHeaderTheme:!1}),m=0;e.showNotesTitle&&(o.modifyTableJson(f,m,0,{text:i.title||r.notes,cellStyle:a(!0,-1),height:t.titleRowH}),m++);var g=0;return c.forEach(function(e){o.modifyTableJson(f,m,0,{text:e.text,cellStyle:a(!1,g),height:t.dataRowH}),m++,g++}),{type:s.INFOGRAPHIC_NOTES,stack:[f]}}).filter(function(t){return!!t})},_getSourceSectionStyle:function(t,e){var n={titleStyle:null,title:null};if(t){var o=t.stack[0],i=o.data.columns[0].field,l=0;if(e){var a=o.data.data[l++];a&&(n.titleStyle=a.style.fields[i],n.title=a[i])}for(var s=0;o.data.data[l];){var r=o.data.data[l++];o.data.columns.forEach(function(t,e){n["row"+s+"_column"+e]=r.style.fields[t.field]}),s++}}return n},_getCellStyle:function(e,n,o,i,l){var a,s=o%2!=0,r=n%2!=0;e?a=i.titleStyle:(a=i["row"+o+"_column"+n])||(a=s?i["row1_column"+n]||(r?i.row1_column1:i.row1_column0)||i.row1_column0:i["row0_column"+n]||(r?i.row0_column1:i.row0_column0)||i.row0_column0);var u=t.mixin({verticalAlign:"middle",horizontalAlign:r?"right":void 0,horizontalPadding:e||n>0?5:20},l);return e&&(u.fontSize*=1.2),t.mixin(u,a),u}};return u});