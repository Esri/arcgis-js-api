// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/dom-geometry","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","../grid/valueField/ValueField","./utils/QueryUtil","./utils/SerializationManager","../supportClasses/DocumentOptions","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","dojo/text!../templates/ReportContainer.html"],(function(t,e,i,n,o,s,r,l,a,h,c,d,m,u,p,g){return t([r,l],{templateString:g,isReportContainer:!0,viewModel:null,theme:null,parentWidget:null,currentFeatureIndex:null,documentOptions:null,_sampleWatermarkDiv:null,queryUtil:h,serializationManager:null,postCreate:function(){this.inherited(arguments),this.serializationManager=(new this._getSerializationManagerClass)(this),this.updateLayout(),this.setViewMode(p.PREVIEW_VALUES)},_getSerializationManagerClass:function(){return c},_sectionWidth:0,setDocumentOptions:function(t){this.documentOptions&&e.mixin(this.documentOptions,t),this.updateLayout()},updateLayout:function(){if(this.documentOptions){this._sectionWidth=d.getPageBox(this.documentOptions).contentW,this._updateContainerSize(),s.set(this.stackContainer,{paddingLeft:(this.documentOptions.left||0)+"px",paddingRight:(this.documentOptions.right||0)+"px",paddingTop:(this.documentOptions.top||0)+"px",paddingBottom:(this.documentOptions.bottom||0)+"px"});var t=this;this.getReportElements("setWidth").forEach((function(e){t.getElementSection(e).setWidth(t._getSectionWidth(),{resizeContentToFit:!0,preserveRightOffset:!0}),t.updateReportElement(e)}))}},resizeReportElementContentToFitPageWidth:function(t){var e=t&&this.getElementSection(t);e&&e.setWidth(this._getSectionWidth(),{resizeContentToFit:!0,forceResize:!0}),this.updateReportElement(t)},getCurrentPageDim:function(){return d.getPageBox(this.documentOptions)},_updateContainerSize:function(){s.set(this.stackContainer,"width",this._sectionWidth+(this._viewMode===p.EDIT?145:0)+"px"),s.set(this.mainContainer,"height",s.get(this.domNode,"height")+(this._viewMode===p.EDIT?-17:0)+"px")},_getSectionWidth:function(){return this._sectionWidth},resize:function(t,e){void 0!==t&&s.set(this.domNode,{width:t+"px",height:e+"px"}),this._updateContainerSize()},getCanvasOffsets:function(){var t=s.get(this.domNode,"width"),e=s.get(this.stackContainer,"width")+o.getPadBorderExtents(this.stackContainer).w;return{l:Math.max(15,this.stackContainer.offsetLeft),r:Math.max(10,t-(this.stackContainer.offsetLeft+e))}},getFullWidth:function(){return Math.max(this.stackContainer.scrollWidth,s.get(this.stackContainer,"width"))},getFullHeight:function(){return Math.max(this.stackContainer.scrollHeight,s.get(this.stackContainer,"height"))},addSection:function(t,e,i,n,o){var s=this._createSectionCell(t);this._createSection(t,e,s);var r=this._createReportElement(t,s,i,n,e&&e.json,o);return this.updateReportElement(r),r},_createSection:function(t,e,i){var n;if((e=e||{}).class="reportContainer_Section",e.initialWidth=this._getSectionWidth(),e.initialHeight="empty"===t?e.isSmallSize?100:200:void 0,e.viewModel=this.viewModel,e.theme=this.theme,e.parentWidget=this,e.hasFixedLayout=!0,e.viewPortContainer=this.getScrollableContainer(),e.currentFeatureIndex=this.currentFeatureIndex,e.initialViewMode=this._viewMode,"empty"===t)n=this.viewModel.layoutBuilder.createElement("emptySection",e,i.getContentContainerNode());else{n=this.viewModel.layoutBuilder.createElement("section",e,i.getContentContainerNode());var o=this.documentOptions.backgroundColor||this.viewModel.getDocumentDefaultStyles(this.theme).backgroundColor;o&&s.set(n.domNode,"backgroundColor",o)}return i.setContent(n),n},_getSectionCellClass:function(){return a},_getSectionCellParams:function(){return null},_createSectionCell:function(t){return(new this._getSectionCellClass)(e.mixin({sectionId:t,class:"reportContainerCell"},this._getSectionCellParams()))},_createReportElement:function(t,e,n,o,s,r){var l=i.create("div",{class:"reportElement"}),a=this._getCellSection(e),h=l._fcPar={isReportElement:!0,sectionId:t,isEmpty:"empty"===t,cell:e,section:a,coverElement:null,reportElementContent:i.create("div",{class:"reportElementContent"},l)};return i.place(l,n||this.stackContainer,n?o:void 0),this._createAdditionalElementsForReportElement(l),i.place(e.domNode,h.reportElementContent),this.isEmptyElement(n)&&!1!==r&&(this._removeSection(n),this._tryProvidingSmallEmpty(l)),a.notifyShown&&a.notifyShown(),l},_createAdditionalElementsForReportElement:function(t){},updateReportElement:function(t){var e=this.getElementParams(t);this._sectionToSectionCell(e.cell),this._sectionCellToSection(e.cell),this._updateChildrenViewMode(t)},_sectionCellToSection:function(t){this._getCellSection(t).setHeight(t.getHeight())},_sectionToSectionCell:function(t){var e=this._getCellSection(t);t.setWidth(e.getWidth()),t.setMinHeight(e.hasTablesThatFitHeight()?20:e.getHeight()),t.setHeight(e.getResizedHeight())},_tryProvidingSmallEmpty:function(t){var e=this;this.getReportElements().filter((function(t){return e.isEmptyElement(t)})).length||this.addSection(u.EMPTY,{isSmallSize:!0},t,"after")},getElementHeight:function(t){return this.getElementCell(t).getHeight()},setElementHeight:function(t,e){var i=this.getElementCell(t);i.setHeight(e),this._sectionCellToSection(i),this.updateReportElement(t)},getElementParams:function(t,e){var i=t&&t._fcPar;return e?i&&i[e]:i},getElementSection:function(t){return this.getElementParams(t,"section")},getElementSectionAt:function(t){var e=this.getReportElements()[t];return e&&this.getElementSection(e)},getSectionPositionInfo:function(t){return this.queryUtil.getSectionPositionInfo(this,t)},getElementCell:function(t){return this.getElementParams(t,"cell")},isEmptyElement:function(t){return!!this.getElementParams(t,"isEmpty")},isReportElement:function(t){return this.getElementParams(t)},_getCellSection:function(t){return t.content},scrollToElement:function(t){if(t)return this._animateScrolling(t.offsetTop-this.domNode.clientHeight/5)},_animateScrolling:function(t){this.getScrollableContainer().scrollTop=t},getScrollableContainer:function(){return this.mainContainer},getReportElements:function(t){return this.queryUtil.getReportElements(this,t)},clear:function(t){var e=this;this.getReportElements().forEach((function(i){e._removeSection(i,!0===t)}))},_removeSection:function(t,e){var n=this.getElementSection(t),o=this.getElementCell(t);t&&o&&(n&&n.destroy(),o.destroy(),delete t._fcPar,i.destroy(t),0===this.getReportElements().length&&!1!==e&&this.addSection(u.EMPTY))},removeSection:function(t){this._removeSection(t)},removeSectionAtIndex:function(t){this._removeSection(this.getReportElements()[t])},moveSection:function(t,e,n){var o=this.getReportElements()[t];if(o&&o.parentNode){o.parentNode.removeChild(o);var s=this.getReportElements();s.length===e?i.place(o,s[s.length-1],"after"):i.place(o,this.getReportElements()[e],n)}},setHeight:function(t){s.set(this.mainContainer,"height",t+"px")},_viewMode:null,getViewMode:function(){return this._viewMode},setViewMode:function(t){if(this._viewMode!==t){this._viewMode=t,this._memoInViewElementsInfo(),t===p.EDIT?(n.add(this.domNode,"reportContainerEditMode"),n.remove(this.domNode,"reportContainerPreviewMode")):(n.remove(this.domNode,"reportContainerEditMode"),n.add(this.domNode,"reportContainerPreviewMode")),t!==p.PREVIEW_VALUES||this.viewModel.dynamicReportInfo?m.hide(this._sampleWatermarkDiv):(this._sampleWatermarkDiv||(this._sampleWatermarkDiv=i.create("div",{class:"sampleValuesWatermark"},this.stackContainer,"first")),m.show(this._sampleWatermarkDiv)),this._updateContainerSize(),this._updateChildrenViewMode(),this._adjustScrollForNewViewMode()}},_updateChildrenViewMode:function(t){},_inViewElementsInfo:null,_memoInViewElementsInfo:function(){var t;(this._inViewElementsInfo=null,this.mainContainer.scrollTop<1e3)||(this.getReportElements().some((function(e){if(e.offsetTop>this.mainContainer.scrollTop)return t=e,!0}),this),t&&(this._inViewElementsInfo={scrollTop:this.mainContainer.scrollTop,offsetTop:t.offsetTop,elementInView:t}))},_adjustScrollForNewViewMode:function(){if(this._inViewElementsInfo){var t=this._inViewElementsInfo.offsetTop-this._inViewElementsInfo.scrollTop,e=this._inViewElementsInfo.elementInView.offsetTop-this.mainContainer.scrollTop;this.mainContainer.scrollTop+=e-t}},notifyShown:function(){this.serializationManager.notifyShown()},fromJson:function(t){this.serializationManager.fromJson(t)},toJson:function(t){return this.serializationManager.toJson(t)},onPendingDataApplied:function(){},destroy:function(){this.clear(),this.viewModel=null,this.theme=null,this.parentWidget=null,this.documentOptions=null,this.queryUtil=null,this.serializationManager=null,this.inherited(arguments)}})}));