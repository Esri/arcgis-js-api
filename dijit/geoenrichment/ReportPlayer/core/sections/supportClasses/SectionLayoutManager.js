// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.38/esri/copyright.txt for details.

define(["dojo/_base/declare","./SectionContentFitModes","../../grid/coreUtils/GridDataUtil","../../infographics/InfographicTypes","esri/dijit/geoenrichment/utils/FitUtil"],(function(t,e,i,s,n){var a=t(null,{section:null,_width:0,_height:0,constructor:function(t){this.section=t},getWidth:function(){return this._width},setWidth:function(t,e){e=e||{},t=Math.max(0,t);var i=this._width;this._width=t,this.section.domNode.style.width=t+"px",this.section.hasFixedLayout?this.section.getTrueTables().forEach((function(i){(i.getMaxWidth()!==t||e.forceResize)&&i.setMaxWidth(t,{resizeToFitAllowedWidth:e.resizeContentToFit,preserveRightOffset:e.preserveRightOffset})})):e.resizeContentProportionally&&i&&t&&i!==t&&this.scaleFloatingContentProportionally({xScale:t/i,yScale:1})},getHeight:function(t){if(!this.section.hasFixedLayout)return this._height;var e=0,i=this;return this.section._stackElements.forEach((function(s){switch(s.stackId){case"table":if(i.section.isImageTable(s))break;e+=s.getHeight(t),s.isLocatorTable&&s.isLocatorTable()&&(e+=s.getLocatorTablePreviewExtraHeight());break;case"hr":case"pageBreak":e+=s.clientHeight}})),e},getResizedHeight:function(){return this.section.hasFixedLayout?this.getHeight(!0):this._height},setHeight:function(t,e){if(this._setHeight(t,e),this.section.hasFixedLayout){var i=this;this.section.getTrueTables().forEach((function(t){t.needScaleToFitHeight()&&i._scaleFixedTableToFitHeight(t)}))}},updateHeightAfterContentChange:function(){this.section.hasFixedLayout&&this._setHeight(this.getResizedHeight())},_setHeight:function(t,e){if(t=Math.max(0,t),this.section.hasFixedLayout){var i=this.section.getLastTrueTable();i&&i.setSpaceAfter(t-this.getHeight())}var s=this._height;this._height=t,this.section.domNode.style.height=t+"px",!this.section.hasFixedLayout&&e&&e.resizeContentProportionally&&s&&t&&s!==t&&this.scaleFloatingContentProportionally({xScale:1,yScale:t/s})},scaleFloatingContentProportionally:function(t){this.section.hasFixedLayout||1===t.xScale&&1===t.yScale||this.section._stackElements.length>1||this.section._stackElements.forEach((function(e){switch(e.stackId){case"table":e.scaleProportionallyWithinParent(t)}}))},getFloatingContentBox:function(){var t={minX:1/0,minY:1/0,maxX:0,maxY:0};return this.section._stackElements.forEach((function(e){switch(e.stackId){case"table":i=e.getTableBox(),t.minX=Math.min(t.minX,i.l),t.minY=Math.min(t.minY,i.t),t.maxX=Math.max(t.maxX,i.l+i.w),t.maxY=Math.max(t.maxY,i.t+i.h)}var i})),{l:t.minX,t:t.minY,w:t.maxX-t.minX,h:t.maxY-t.minY}},fitContentNicely:function(t,e){t=t||{},this.section.hasFixedLayout?this._fitFixedTablesNicely(t,e):this._fitFloatingContentNicely(t,e)},_fitFixedTablesNicely:function(t,i){if(t.fitMode!==e.NONE){t.fitMode===e.ALL&&delete t.fitMode;var s=this;(i=i||this.section.getTrueTables()).forEach((function(i){"table"===i.stackId&&(t.fitMode!==e.WIDTH&&t.fitMode||i.resizeToFitAllowedWidth(),t.fitMode!==e.HEIGHT&&t.fitMode||s._scaleFixedTableToFitHeight(i))})),this.section._notifyContentChanged()}},_scaleFixedTableToFitHeight:function(t){t.resizeToFitHeight(this.section.getResizedHeight()),t.setSpaceAfter(0)},_fitFloatingContentNicely:function(t,i){var s,n=t.fitMode;n!==e.NONE&&((i=i||this.section._stackElements).length&&(this.section._stackElements.length>1||(1===i.length&&(s=this._getTransformParamsForSpecificSingleElement(i)),s=s||this._getTransformParamsForOtherElement(i,n),i.forEach((function(t){switch(t.stackId){case"table":t.scaleProportionallyWithinParent(s.scaleParams),t.setPosition(s.deltaLeft+t.getLeft(),s.deltaTop+t.getTop())}})))))},_getTransformParamsForSpecificSingleElement:function(t){var e,s,a,o=this.section.getTables()[0],h=o&&o.isSingleCelledTable()&&i.getFieldInfo(o.getFirstCell());if(h&&h.isImage||h&&h.isShape){var c=this.getFloatingContentBox(),l=n.fitBox(c,{w:this._width,h:this._height},{hAlign:"center",vAlign:"middle"});e={xScale:l.ratio,yScale:l.ratio},s=l.x-c.l*e.xScale,a=l.y-c.t*e.yScale}return e&&{scaleParams:e,deltaLeft:s,deltaTop:a}},_getTransformParamsForOtherElement:function(t,i){var s,n=this.getFloatingContentBox();i===e.SINGLE_ALL_COMPLEX_WIDTH&&(i=t.length>1?e.WIDTH:e.ALL);var a=this._getContentFitOffset(t),o=this.section.getWidth()-2*a,h=this._height-2*a;return t.length>1&&n.h>h&&(i=e.ALL),{scaleParams:s={xScale:i===e.HEIGHT?1:o/n.w,yScale:i===e.WIDTH?1:h/n.h},deltaLeft:a-n.l*s.xScale,deltaTop:a-n.t*s.yScale}},_getContentFitOffset:function(t){var e=this.section.getTables()[0],n=e&&e.isSingleCelledTable()&&i.getFieldInfo(e.getFirstCell()),a=n&&n.isInfographic&&n.infographicJson.style&&n.infographicJson.style.padding;return this.section.noContentOffset?0:t.length>1?5:this.section.hasMapImages()?0:this.section.hasChart()?0:this.section.hasInfographic(s.ATTACHMENTS)?a||0:s.isTableLike(this.section.getInfographicType())?"number"==typeof a?a:this.section.viewModel.getTheme(this.section.theme).table.dataTablePadding||0:this.section.hasInfographic()?"number"==typeof a?a:this.section.viewModel.getStaticInfographicDefaultStyles(this.section.theme).padding||0:e&&(this.section.isImageTable(e)||n&&n.isShape)?0:this.section.viewModel.getTheme(this.section.theme).table.dataTablePadding||0},getPreferredHeight:function(){var t=this.section.getInfographicWithTable();if(!t||!t.infographic.getPreferredHeight)return 0;var e=t.table.getTableBox();return e.t+(this.getResizedHeight()-e.t-e.h)+(t.infographic.getPreferredHeight()||0)}});return a.IMAGE_FIT_PRETTY_OFFSET=0,a}));