// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/string","esri/dijit/geoenrichment/when","dojo/dom-class","dojo/dom-construct","dijit/_WidgetBase","dijit/_TemplatedMixin","../PlayerCommands","../PlayerThemes","./Select","./AreasSelect","./ZoomSelect","./ToolbarArranger","./ZoomUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/InvokeUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/PopupUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/text!../templates/PlayerToolbarHolder.html","dojo/i18n!esri/nls/jsapi"],(function(e,o,t,i,n,a,r,s,l,h,c,u,d,p,m,S,f,g,T,A,b,v,C){var P=e([r,s],{templateString:v,nls:C=C.geoenrichment.dijit.ReportPlayer.PlayerToolbar,player:null,areaTitleFormatter:null,areaTitleMultiFormatter:null,showAreaTitle:!1,stretchToolbarNode:null,canAddMoreAreas:!1,areasSelectButtons:null,areasSelect:null,pageSelect:null,zoomSelect:null,_toolbarArranger:null,_infographicSelect:null,postCreate:function(){f.hide(this.commandButtonsContainer),this._toolbarArranger=new p({showAreaTitle:this.showAreaTitle,stretchToolbarNode:this.stretchToolbarNode,domNode:this.domNode,infographicsSelectDiv:this.infographicsSelectDiv,areaTitleDiv:this.areaTitleDiv,areaTitleInnerDiv:this.areaTitleInnerDiv,rightSideControlsBlock:this.rightSideControlsBlock,areasSelectDiv:this.areasSelectDiv,zoomSelectDiv:this.zoomSelectDiv,pageSelectDiv:this.pageSelectDiv,commandButtonsContainer:this.commandButtonsContainer}),this._initAreaSelect(),this._initPageSelect(),this._initZoomSelect(),b.autoTooltip(this.domNode)},_initAreaSelect:function(){var e=this;this.areasSelect=new u({player:this.player,canAddMoreAreas:this.canAddMoreAreas,areasSelectButtons:this.areasSelectButtons,onChange:function(o){e.onShowAnalysisAreaAt(o.value),e.onClosePopup()},onAddMoreAreas:function(){e.onAddMoreAreas(),e.onClosePopup()},onRemoveAreas:function(o,t){e.onRemoveAreas(o),t&&e.onClosePopup()},onCompareAreasSideBySide:function(){e.onCompareAreasSideBySide(),e.onClosePopup()},onStopComparison:function(o){e.onShowAnalysisAreaAt(o),e.onClosePopup()}}).placeAt(this.areasSelectDiv),this.own(this.areasSelect)},updateAreaSelect:function(e){var o=e.analysisAreas,t=e.combinedAreasInfo,i=e.currentAreaIndex,n=e.isMultiFeature;this.areasSelect.buildAreaOptions(e),this.areasSelect.set("value",i);var a=this.areasSelect.get("options").length>1&&!n;if(f[a?"show":"hide"](this.areasSelectDiv),this._toolbarArranger.syncRightSideVisibility(),this.player.showReportTitle)document.body.clientWidth>500||!a?(this.infographicsSelectDiv.innerHTML="<div class='TrimWithEllipses' style='max-width:"+.4*document.body.clientWidth+"px;'>"+this.player.getReportTitle()+"</div>",this._toolbarArranger.showAreaTitle=!0):(this.infographicsSelectDiv.innerHTML="",this._toolbarArranger.showAreaTitle=!1);else if(n)this.areaTitleMultiFormatter?this.areaTitleMultiFormatter(this.areaTitleInnerDiv,t):this._formatAreaTitleMulti(t);else{var r=o["all"===i?0:i];this.areaTitleFormatter?this.areaTitleFormatter(this.areaTitleInnerDiv,r):this._formatAreaTitle(r,i)}},_formatAreaTitle:function(e,o){this.areaTitleInnerDiv.innerHTML="all"===o?C.allAreas:e.locationName||e.name},_formatAreaTitleMulti:function(e){this.areaTitleInnerDiv.innerHTML=e.locationName||e.name||e.shortName||""},_pageControlsVisible:!0,_initPageSelect:function(){var e=this;this.pageSelect=new c({onChange:function(o){e.onShowPageAt(o.value),e.onClosePopup()}}).placeAt(this.pageSelectDiv),this.own(this.pageSelect)},setPageControlsVisible:function(e){this._pageControlsVisible=e,f[e?"show":"hide"](this.pageSelectDiv)},updatePageSelect:function(e,o){for(var i=[],n=0;n<e;n++)i.push({label:t.substitute(C.pageIndex,{index:n+1}),value:n});this.pageSelect.set("options",i),this.pageSelect.set("value",o),f[this._pageControlsVisible&&e>1&&document.body.clientWidth>500?"show":"hide"](this.pageSelectDiv)},_initZoomSelect:function(){var e=this;this.zoomSelect=new d({onChange:function(o){o.value===m.FIT_PAGE?e.onZoomToFitPage():o.value===m.FIT_PAGE_WIDTH?e.onZoomToFitPageWidth():o.value===m.FIT_PAGE_HEIGHT?e.onZoomToFitPageHeight():e.onSetZoomPercent(o.value),e.onClosePopup()}}).placeAt(this.zoomSelectDiv),this.own(this.zoomSelect)},setZoomSupportsInfo:function(e){f[e.supported?"show":"hide"](this.zoomSelectDiv),this._toolbarArranger.syncRightSideVisibility(),this.zoomSelect.options.forEach((function(o){o.hidden=!1,(o.value!==m.FIT_PAGE||e.canFitPage)&&(o.value!==m.FIT_PAGE_WIDTH||e.canFitPageWidth)&&(o.value!==m.FIT_PAGE_HEIGHT||e.canFitPageHeight)||(o.hidden=!0)}))},setZoomInfo:function(e){var o=e.isFitPageScale?m.FIT_PAGE:e.isFitPageWidthScale?m.FIT_PAGE_WIDTH:e.isFitPageHeightScale?m.FIT_PAGE_HEIGHT:m.getClosestZoomAndUpdateOptions(100*e.scale,this.zoomSelect.get("options"));o!==this.zoomSelect.get("value")&&this.zoomSelect.set("value",o)},createCommandButton:function(e,o){return this.createCustomCommandButton({callback:o,buttonClass:e.id===l.PRINT?"playerPrintButton":"playerExportButton",tooltip:e.id===l.PRINT?C.printInfographic:C.exportInfographic,visibleOnError:!1})},createCustomCommandButton:function(e){f.show(this.commandButtonsContainer);var t=a.create("div",{class:"playerToolbar_commandButtonContainer dijitInline"},this.commandButtonsContainer,e.addFirst?"first":"last");t.__visibleOnError=e.visibleOnError;var i=a.create("div",{class:"playerToolbar_commandButton"},t);return e.buttonClass&&n.add(i,e.buttonClass),e.tooltip&&b.setTooltipToNode(i,e.tooltip),o(i,"click",e.callback),i},setTheme:function(e){n.remove(this.domNode,"playerThemeDark playerThemeLight"),n.add(this.domNode,e===h.DARK?"playerThemeDark":"playerThemeLight"),this.areasSelect.setTheme(e),this.pageSelect.setTheme(e),this.zoomSelect.setTheme(e)},setErrorShown:function(e){if(e){f.hide([this.areaTitleDiv,this.areasSelectDiv,this.pageSelectDiv,this.zoomSelectDiv]);for(var o=0;o<this.commandButtonsContainer.children.length;o++){var t=this.commandButtonsContainer.children[o];f[t.__visibleOnError?"show":"hide"](t)}}},arrangeControls:function(){this._toolbarArranger.arrangeControls()},hasVisibleControls:function(){return this._toolbarArranger.hasVisibleControls()},addInfographicsSelect:function(e){this._infographicSelect=e,e.placeAt(this.infographicsSelectDiv)},isMouseOver:function(){return T.isMouseOver(this.domNode)||this.areasSelect&&this.areasSelect.isMouseOver()||this.pageSelect&&this.pageSelect.isMouseOver()||this.zoomSelect&&this.zoomSelect.isMouseOver()||this._infographicSelect&&this._infographicSelect.isMouseOver&&this._infographicSelect.isMouseOver()},setContentLoadPromise:function(e){f.enableContentAbsolute(this.commandButtonsContainer,!1),f.enableContentAbsolute(this.infographicsSelectDiv,!1),i(e,function(){f.enableContentAbsolute(this.commandButtonsContainer,!0),f.enableContentAbsolute(this.infographicsSelectDiv,!0)}.bind(this))},onShowPageAt:function(e){},onShowAnalysisAreaAt:function(e){},onCompareAreasSideBySide:function(){},onZoomToFitPage:function(){},onZoomToFitPageWidth:function(){},onZoomToFitPageHeight:function(){},onSetZoomPercent:function(e){},onClosePopup:function(){},onAddMoreAreas:function(){},onRemoveAreas:function(e){}});return e([r,s],{templateString:"<div class='esriGEPlayerToolbarOuter'></div>",player:null,popupButtonDiv:null,areaTitleFormatter:null,areaTitleMultiFormatter:null,showToolbarInPopup:!1,showAreaTitle:!1,stretchToolbarNode:null,showCloseButton:!1,canAddMoreAreas:!1,areasSelectButtons:null,toolbarHolder:null,postCreate:function(){var e=this;this.inherited(arguments),this.toolbarHolder=new P({player:this.player,showAreaTitle:this.showAreaTitle,stretchToolbarNode:this.stretchToolbarNode,canAddMoreAreas:this.canAddMoreAreas,areasSelectButtons:this.areasSelectButtons,onShowPageAt:function(o){e.onShowPageAt(o)},onShowAnalysisAreaAt:function(o){e.onShowAnalysisAreaAt(o)},onCompareAreasSideBySide:function(){e.onCompareAreasSideBySide()},onZoomToFitPage:function(){e.onZoomToFitPage()},onZoomToFitPageWidth:function(){e.onZoomToFitPageWidth()},onZoomToFitPageHeight:function(){e.onZoomToFitPageHeight()},onSetZoomPercent:function(o){e.onSetZoomPercent(o)},onClosePopup:function(){e.closePopup()},onAddMoreAreas:function(){e.onAddMoreAreas()},onRemoveAreas:function(o){e.onRemoveAreas(o)}}).placeAt(this.domNode),this.own(this.toolbarHolder)},updateAreaSelect:function(e){this.toolbarHolder.areaTitleFormatter=this.areaTitleFormatter,this.toolbarHolder.areaTitleMultiFormatter=this.areaTitleMultiFormatter,this.toolbarHolder.updateAreaSelect(e)},setPageControlsVisible:function(e){this.toolbarHolder.setPageControlsVisible(e)},updatePageSelect:function(e,o){this.toolbarHolder.updatePageSelect(e,o)},setZoomSupportsInfo:function(e){this.toolbarHolder.setZoomSupportsInfo(e)},setZoomInfo:function(e){this.toolbarHolder.setZoomInfo(e)},createCommandButton:function(e,o){return this.toolbarHolder.createCommandButton(e,o)},setTheme:function(e){this.toolbarHolder.setTheme(e)},setErrorShown:function(e){this.toolbarHolder.setErrorShown(e),this._arrangeControls()},_arrangeControls:function(){f.show(this.domNode),this.toolbarHolder.arrangeControls(),f[this.toolbarHolder.hasVisibleControls()?"show":"hide"]([this._popupButton,this.domNode])},_popupHandle:null,_popupButton:null,update:function(){g.invoke(this,"_doUpdateToolbar")},_doUpdateToolbar:function(){n[this.isScrollShown()?"add":"remove"](this.popupButtonDiv,"playerToolbar_parentHasScroll"),n[S.isMobileDevice()?"add":"remove"](this.popupButtonDiv,"isMobileDevice"),n[S.isMobileDevice()?"add":"remove"](this.toolbarHolder.domNode,"isMobileDevice"),this._resetToolbarNode();var e=A.isOpen(this.toolbarHolder);this._popupHandle&&this._popupHandle.remove(),this._popupHandle=null,this.showToolbarInPopup?(this._popupButton=a.create("div",{class:"dijitInline playerToolbar_outerButton playerToolbar_settingsButton"},this.popupButtonDiv,"first"),this._popupHandle=A.makePopup(this.toolbarHolder,this,this._popupButton,{orient:["before","below"],openPopup:e})):a.place(this.toolbarHolder.domNode,this.domNode),this._arrangeControls()},_resetToolbarNode:function(){this.toolbarHolder.domNode.parentNode&&this.toolbarHolder.domNode.parentNode.removeChild(this.toolbarHolder.domNode),this.domNode.innerHTML="",this._popupButton&&a.destroy(this._popupButton),this._popupButton=null},closePopup:function(){this.showToolbarInPopup&&A.close(this.toolbarHolder)},isScrollShown:function(){return!1},createCustomCommandButton:function(e){return this.toolbarHolder.createCustomCommandButton(e)},notifyCommandButtonsAdded:function(){if(this.showCloseButton)if(this.showToolbarInPopup){var e=a.create("div",{class:"dijitInline playerToolbar_outerButton playerToolbar_closeButtonOuter"},this.popupButtonDiv);b.setTooltipToNode(e,C.close),o(e,"click",function(){this.onClose()}.bind(this))}else this.createCustomCommandButton({buttonClass:"playerToolbar_closeButton",tooltip:C.close,callback:function(){this.closePopup(),this.onClose()}.bind(this),visibleOnError:!0})},addInfographicsSelect:function(e){this.toolbarHolder.addInfographicsSelect(e)},isMouseOver:function(){return T.isMouseOver(this.domNode)||this.toolbarHolder.isMouseOver()},setContentLoadPromise:function(e){this.toolbarHolder.setContentLoadPromise(e)},onShowPageAt:function(e){},onShowAnalysisAreaAt:function(e){},onCompareAreasSideBySide:function(){},onZoomToFitPage:function(){},onZoomToFitPageWidth:function(){},onZoomToFitPageHeight:function(){},onSetZoomPercent:function(e){},onClose:function(){},onAddMoreAreas:function(){},onRemoveAreas:function(e){}})}));