// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.29/esri/copyright.txt for details.

define(["esri/declare","dojo/_base/lang","dojo/_base/array","dojox/mvc/Templated","dojo/dom-class","dojo/dom-geometry","dojo/dom-construct","dojo/dom-style","dojo/on","dojo/sniff","dijit/layout/_LayoutWidget","./utils/animation/AnimationHelper","dojo/text!./templates/Pagination.html"],function(t,i,e,n,a,o,s,r,h,d,l,c,g){return t("esri.dijit.geoenrichment.Pagination",[n,l],{templateString:g,autoCenter:!1,scrollAnimation:!0,cyclicPagination:!1,alwaysShowArrows:!1,detachChildrenUponHiding:!1,items:null,currentPage:0,_pageCount:0,_pageSize:0,_animation:null,_itemMargins:null,clickEventType:null,constructor:function(){var t=this;this._animation=new c,this._animation.onNodePreDestroy=function(i){t._onNodePreDestroy(i),t.onNodePreDestroy(i)},this.clickEventType=d("touch")?"touchstart, click":"click"},createItemContainer:function(){},updateItemContainer:function(t,i){},onNodePreDestroy:function(t){},onNodePlaced:function(t,i){},onSelect:function(t){},onPageChanged:function(){},layout:function(){function t(){return n.scrollHeight-2>n.clientHeight}this._animation.finish();var e=this.items;if(!e||!e.length)return void this.set("items",[]);var n=this.itemsNode.parentNode;if(n&&n.clientHeight){var d=this._parseAutoCenterOption(this.autoCenter);d.type&&r.set(n,"padding","0px");var l=this.itemsNode.firstChild;l||(l=s.create("div",null,this.itemsNode),a.add(l,"PaginationItemsNodeChildDiv")),"stretch"==d.type&&(this._itemMargins={},this._emptyNode(l));for(var c=l.children;!t()&&(d.type||c.length<e.length);){var g=this.createItemContainer();h(g,this.clickEventType,i.hitch(this,this._onItemClick,g)),l.appendChild(g)}for(;t()&&c.length>1;)this._destroyNode(l.lastChild);var u=c.length;if(d.type){g=l.firstChild;var m=r.getComputedStyle(g),f=o.getMarginBox(g,m);if("stretch"==d.type)var p=o.getMarginExtents(g,m);var _=Math.max(1,Math.floor(l.clientHeight/f.h)),y=l.clientHeight/_;_=Math.max(Math.floor(n.clientHeight/y),_);var v=Math.max(1,u/_);d.heightLimit&&_>d.heightLimit&&(_=d.heightLimit),d.widthLimit&&v>d.widthLimit&&(v=d.widthLimit),u=_*v,y=f.h;var C=Math.max(n.clientWidth-v*f.w,0),P=Math.max(n.clientHeight-_*f.h,0)}var N=this._pageSize=Math.min(u,e.length),w=this._pageCount=Math.ceil(this.items.length/N);if(d.type&&d.height){if("stretch"==d.type){var M=Math.floor(P/_);P-=M*_,this._itemMargins.marginTop=(Math.floor(M/2)+p.t).toString()+"px",this._itemMargins.marginBottom=(Math.ceil(M/2)+p.b).toString()+"px",y+=M}if(1===w&&d.allowVerticallyCenter){var b=Math.floor((N-1)/v)+1;b<_&&(P+=y*(_-b))}r.set(n,{paddingTop:Math.floor(P/2).toString()+"px",paddingBottom:"0"})}this.currentPage=this._coerceCurrentPage(this.currentPage);for(var A=0,x=N*this.currentPage;A<N&&x<e.length;){g=c[A++];var S=e[x++];this._onNodePreDestroy(g),this.updateItemContainer(g,S),this.onNodePlaced(g,S)}for(;A<c.length;)this._destroyNode(l.lastChild);for(d.type&&d.width&&("stretch"==d.type?(M=Math.floor(C/v),C-=M*v,this._itemMargins.marginLeft=(Math.floor(M/2)+p.l).toString()+"px",this._itemMargins.marginRight=(Math.ceil(M/2)+p.r-1).toString()+"px"):M=0,1===w&&N<v&&!d.preventSingleRowCenter&&(C=Math.max(n.clientWidth-(f.w+M)*N,0)),C=Math.floor(C/2).toString()+"px",r.set(n,{paddingLeft:C,paddingRight:C})),A=this._itemMargins?0:c.length;A<c.length;)r.set(c[A++],this._itemMargins);if(this.bulletsNode&&(this.bulletsNode.innerHTML="",w>1))for(var k=0;k<w;k++){var I=s.create("span",{class:"Pagination_Bullet",innerHTML:"&nbsp;"},this.bulletsNode);h(I,this.clickEventType,i.hitch(this,function(t){this._started=!0,this.set("currentPage",t),this.emit("page-is-changed-manually")},k))}this._updateNavigationControls()}},_parseAutoCenterOption:function(t){if(!t)return{};var i={type:"center"};"string"!=typeof t&&(t="");for(var n=!0;n;){switch(t.charAt(0)){case"$":i.preventSingleRowCenter=!0;break;case"@":i.allowVerticallyCenter=!0;break;default:n=!1}n&&(t=t.substr(1))}switch(t){case"width":return i.width=!0,i;case"height":return i.height=!0,i;default:if(0!=t.indexOf("stretch"))return i.width=i.height=!0,i}i.type="stretch",t=t.substr(7);var a=t.indexOf(":"),o=a<0?t:t.substr(0,a);switch(t=a<0?"":t.substr(a+1),o){case"-width":i.width=!0;break;case"-height":i.height=!0;break;default:i.width=i.height=!0}return t?(t=t.split(","),a=0,e.forEach(["width","height"],function(e){if(i[e]){var n=Number(t[a++]);!isNaN(n)&&n>0&&(i[e+"Limit"]=n)}}),i):i},_onItemClick:function(t){this.onSelect(t)},_coerceCurrentPage:function(t){return t>=this._pageCount&&(t=this._pageCount-1),t<0&&(t=0),t},_updateNavigationControls:function(){var t=this.currentPage,i=this._pageCount<=1,e=i&&!this.alwaysShowArrows?"none":"",n=["Pagination_TriangleDisabled","Pagination_TriangleEnabled"];if(this.backNode){var o=i||0==t&&!this.cyclicPagination?0:1;a.replace(this.backNode,n[o],n[1-o]),this.backNode.style.display=e}if(this.forwardNode&&(o=i||t==this._pageCount-1&&!this.cyclicPagination?0:1,a.replace(this.forwardNode,n[o],n[1-o]),this.forwardNode.style.display=e),this.bulletsNode)for(var s=this.bulletsNode.children,r=0;r<s.length;r++)r==t?a.add(s[r],"Pagination_BulletCurrent"):a.remove(s[r],"Pagination_BulletCurrent")},_setItemsAttr:function(t){this.items=t,this._emptyNode(this.itemsNode),this.bulletsNode&&(this.bulletsNode.innerHTML=""),this.currentPage=0,this._pageCount=0,this._updateNavigationControls()},selectPageByItemIndex:function(t,i){t<0||!this.items||t>=this.items.length||this._pageCount<=1||this.set("currentPage",Math.floor(t/this._pageSize),i)},selectItem:function(t){var i=e.indexOf(this.items,t);if(-1!=i&&!(i<0||!this.items||i>=this.items.length||this._pageCount<=1)){var n=this.items.length%this._pageSize,a=this.itemsNode.firstChild.children[n];a&&this.onSelect(a)}},navigateToItem:function(t){var i=e.indexOf(this.items,t);this.selectPageByItemIndex(i,!0)},_setCurrentPageAttr:function(t,e){this._animation.finish();var n;if("next"==t?(n="forward",t=this.currentPage+1,this.cyclicPagination&&t==this._pageCount&&(t=0)):"prev"==t?(n="backward",t=this.currentPage-1,this.cyclicPagination&&-1==t&&(t=this._pageCount-1)):n=!0===this.scrollAnimation?"fade1":this.scrollAnimation,!0===e&&(n=""),t=this._coerceCurrentPage(t),this.currentPage!=t){var o=this.items||[],d=this.itemsNode,l=0,c=this._pageSize*t,g=this.itemsNode.firstChild,u=s.create("div");a.add(u,"PaginationItemsNodeChildDiv");for(var m=[];l++<this._pageSize&&c<o.length;){var f=this.createItemContainer();h(f,this.clickEventType,i.hitch(this,this._onItemClick,f)),this._itemMargins&&r.set(f,this._itemMargins),u.appendChild(f);var p=o[c++];this._onNodePreDestroy(f),this.updateItemContainer(f,p),m.push({node:f,item:p})}switch(n){case"forward":this._slideAnimation(d,g,u,!0,m);break;case"backward":this._slideAnimation(d,g,u,!1,m);break;default:if(n&&(n=n?"_"+n+"Animation":null,"function"==typeof this[n])){this[n](d,g,u,t>this.currentPage,m);break}this._emptyNode(d),d.appendChild(u),this._notifyNodesPlaced(m)}this.currentPage=t,this._updateNavigationControls(),this.onPageChanged()}},_notifyNodesPlaced:function(t){e.forEach(t,function(t){this.onNodePlaced(t.node,t.item)},this)},_slideAnimation:function(t,i,e,n,a){n?t.appendChild(e):t.insertBefore(e,t.firstChild),this._notifyNodesPlaced(a),this.isLeftToRight()||(n=!n),t.parentNode.style.overflow="hidden",this._animation.start([{node:t,classes:["Pagination_SlideAnim",n?"Anim_SlideLeft":"Anim_SlideRight"]}],i).then(function(){t.parentNode.style.overflow=""})},_fade1Animation:function(t,i,e,n,a){t.appendChild(e),this._notifyNodesPlaced(a),this._animation.start([{node:i,classes:["Pagination_FadeAnim","Anim_FadeOut"]},{node:e,classes:["Pagination_FadeAnim","Anim_FadeIn"]}],i)},_fade2Animation:function(t,i,e,n,a){var o=this,s=this._animation;s.start([{node:i,classes:["Pagination_FadeAnim","Anim_FadeOut"]}],i).then(function(){t.appendChild(e),o._notifyNodesPlaced(a),s.start([{node:e,classes:["Pagination_FadeAnim","Anim_FadeIn"]}],i)})},_backward:function(){this.set("currentPage","prev")},_forward:function(){this.set("currentPage","next")},_onNodePreDestroy:function(t){if(this.detachChildrenUponHiding&&t&&t.children)for(;t.children.length;)t.removeChild(t.children[0])},_destroyNode:function(t){t&&t.parentNode&&t.parentNode.removeChild(t)},_emptyNode:function(t){t&&(this._onNodePreDestroy(t),t.innerHTML="")}})});