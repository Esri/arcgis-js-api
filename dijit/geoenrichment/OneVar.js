// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["../../declare","./BaseWidget","./dom","dojo/dom-class","dojo/dom-construct","dojo/dom-attr","dojo/query","dojo/string","./lang","dojo/i18n!../../nls/jsapi","./utils","./formatVariable"],function(e,t,a,s,r,l,n,i,o,u,d,h){u=u.geoenrichment.dijit.OneVar;var C=e("esri.dijit.geoenrichment.OneVar",[t],{baseClass:"Infographics_OneVar",constructor:function(){this._state={sortBy:1,sortDesc:!0}},_calculate:function(){var e=this.getDataFields(),t=this.getFieldByIndex(e[0]);return this.primary.innerHTML=this.formatByIndex(0,e[0])+" ",{firstCol:t}},updateUIExpanded:function(){this.inherited(arguments);var e,t=this._calculate(),n=t.firstCol,C=null;if(n){var m=[],c=this.data.features.length;for(e=0;c>e;e++){var p=[];C||(C=p),p.push(this.getFeatureTitle(e)),p.push(this.getValueByName(e,n.name)),m.push(p)}this.site.innerHTML=u.subtitleSite2,this._sortRows(m);var _=this.getValueByName(0,n.name),V=o.isNumber(_);if(V){var M=this.getValueByName(c-1,n.name),g=this.getFeatureTitle(c-1),w=1-M/_;Math.abs(w)<.005&&(w=0);var O;O=0>w?u.lessThan:w>0?u.moreThan:u.same,this.comp.innerHTML=i.substitute(O,{site:g})}else this.comp.innerHTML="";for(var v=this.table,f=m.length+1;v.rows.length>1;)v.deleteRow(-1);var H=v.rows[0];if(V)for(;H.cells.length<4;)H.insertCell(-1);else for(;H.cells.length>2;)r.destroy(H.cells[H.cells.length-1]);for(e=1;f>e;e++){var y=v.insertRow(-1);if(e%2===0&&e>0&&(y.className="AlternatingRow"),l.set(y.insertCell(-1),"class","OneVarMultiComparison_TextColumn"),l.set(y.insertCell(-1),"class","OneVarMultiComparison_ValueColumn"),V){var T=l.set(y.insertCell(-1),"class","OneVarMultiComparison_ChartColumn");l.set(T,"colspan","2")}}var b=Number.NEGATIVE_INFINITY;if(V){for(e=0;e<m.length;e++)m[e][1]>b&&(b=m[e][1]);b=d.getCeiling(b),v.rows[0].cells[2].innerHTML=h(n,0),v.rows[0].cells[3].innerHTML=h(n,b)}for(e=0;e<m.length;e++)if(H=v.rows[e+1],H.cells[0].innerHTML=m[e][0],H.cells[1].innerHTML=h(n,m[e][1]),V){var R;m[e]===C?(s.remove(H,"OneVarMultiComparison_Row"),s.add(H,"OneVarMultiComparison_CurrentRow"),R="OneVarMultiComparison_Expanded_CurrentBar"):(s.remove(H,"OneVarMultiComparison_CurrentRow"),s.add(H,"OneVarMultiComparison_Row"),R="OneVarMultiComparison_Expanded_Bar");var x=a.pct(m[e][1]/b);H.cells[2].innerHTML="<div class='"+R+"' style='width:"+x+"' />",l.set(H.cells[0],"style","width:50%"),l.set(H.cells[1],"style","width:20%")}else l.set(H.cells[0],"style","width:50%"),l.set(H.cells[1],"style","width:50%")}},updateUICollapsed:function(){this.inherited(arguments);var e,t=this._calculate(),a=t.firstCol,r=null;if(a){var i=[],u=this.data.features.length;for(e=0;u>e;e++){var d=[];r||(r=d),d.push(this.getFeatureTitle(e)),d.push(this.getValueByName(e,a.name)),i.push(d)}this._sortRows(i);var C=this.getValueByName(0,a.name),m=this.table,c=i.length+1;for(e=m.rows.length;c>e;e++){var p=m.insertRow(-1);e%2===0&&(p.className="AlternatingRow"),l.set(p.insertCell(-1),"class","OneVarMultiComparison_TextColumn"),l.set(p.insertCell(-1),"class","OneVarMultiComparison_ValueColumn")}for(;m.rows.length>c;)m.deleteRow(-1);var _=o.isNumber(C),V=n("col",this.table);for(_?(l.set(V[0],"style","width:70%"),l.set(V[1],"style","width:30%")):(l.set(V[0],"style","width:50%"),l.set(V[1],"style","width:50%")),e=0;e<i.length;e++){var M=m.rows[e+1];M.cells[0].innerHTML=i[e][0],M.cells[1].innerHTML=h(a,i[e][1]),i[e]===r?(s.remove(M,"OneVarMultiComparison_Row"),s.add(M,"OneVarMultiComparison_CurrentRow")):(s.remove(M,"OneVarMultiComparison_CurrentRow"),s.add(M,"OneVarMultiComparison_Row"))}}},createUIExpanded:function(e){this.inherited(arguments);var t=e.addHeader("div",{"class":"OneVarMultiComparison_Value"}),s=r.create("table",{cellpadding:"0",cellspacing:"0"},t),n=s.insertRow(0),i=n.insertCell(-1);this.site=r.create("span",{"class":"OneVarMultiComparison_Expanded_Value_Site"},i),n=s.insertRow(-1),i=n.insertCell(-1),this.primary=r.create("span",{"class":"OneVarMultiComparison_Expanded_Value_Primary"},i),this.comp=r.create("span",{"class":"OneVarMultiComparison_Comparison"},i),this.table=e.addContent("table",{"class":"OneVarMultiComparison_Table"}),a.createCols(this.table,[.5,.2,.15,.15]),n=this.table.insertRow(-1),this._appendSortHeader(n,u.areaCol,0,{"class":"OneVarMultiComparison_TextColumnHeader"}),this._appendSortHeader(n,u.valueCol,1,{"class":"OneVarMultiComparison_ValueColumnHeader"}),l.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Lower"),l.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Upper"),this.autoHeight&&e.contentClass.push("OneVarMultiComparison_Expanded_ContentPane"),e.addFooter("div")},createUICollapsed:function(e){this.inherited(arguments);var t=e.addHeader("div",{"class":"OneVarMultiComparison_Value"}),s=r.create("table",{cellpadding:"0",cellspacing:"0"},t),n=s.insertRow(0),i=n.insertCell(-1);this.site=r.create("span",{"class":"OneVarMultiComparison_Expanded_Value_Site"},i),n=s.insertRow(-1),i=n.insertCell(-1),this.primary=r.create("span",{"class":"OneVarMultiComparison_Expanded_Value_Primary"},i),this.table=e.addContent("table",{"class":"OneVarMultiComparison_Table"}),a.createCols(this.table,[.7,.3]),n=this.table.insertRow(-1),this._appendSortHeader(n,u.areaCol,0,{"class":"OneVarMultiComparison_TextColumnHeader"}),this._appendSortHeader(n,u.valueCol,1,{"class":"OneVarMultiComparison_ValueColumnHeader"}),l.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Lower"),l.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Upper"),this.autoHeight&&e.contentClass.push("OneVarMultiComparison_Expanded_ContentPane"),e.addFooter("div")}});return C});