// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["../../../declare","dojo/string","dojo/_base/lang","dojo/aspect","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/on","dojo/has","dojo/i18n!../../../nls/jsapi","dojo/text!./templates/DataCategoriesPage.html","../../../tasks/geoenrichment/GeoenrichmentTask","../config","../_WizardPage","../Pagination","../AnimationHelper","dojo/store/Memory","dijit/layout/ContentPane","dijit/form/FilteringSelect","./SearchTextBox"],function(t,e,a,i,s,o,n,r,l,c,h,d,u,g,f,C,m){c=c.geoenrichment.dijit.DataCategoriesPage;var p="_";return t([g],{templateString:h,nls:c,baseClass:"DataCategoriesPage",items:null,countryID:null,countryBox:!0,dataCollections:{},rowsPerPage:8,_task:null,_list:null,_pageCount:0,_pageSize:0,currentPage:0,shoppingCart:null,selection:null,flyAnim:null,scrollAnim:null,constructor:function(){this._task=new d(u.server),this._task.token=u.token,this.scrollAnim=new C,this._ltr=n.isBodyLtr()},buildRendering:function(){this.inherited(arguments),this.pagination.createItemContainer=this._createItemContainer,this.pagination.updateItemContainer=this._updateItemContainer,i.after(this.layoutGrid,"resize",a.hitch(this.pagination,this.pagination.resize))},startup:function(){this.inherited(arguments),this.countryBox?(this.countrySelect.set("labelAttr","label"),this.countrySelect.set("searchAttr","label"),this.countrySelect.store.idProperty="value",this.countrySelect.set("item",{value:p,label:c.loading},null,c.loading),this.countrySelect.set("disabled",!0),this.showProgress(this._task.getAvailableCountries(),"_onCountriesResponse")):(o.destroy(this.countryDiv),this._loadDataCollections())},_createItemContainer:function(){var t=o.create("div",{"class":"DataCategoriesPage_Item"});return o.create("span",null,t),t},_updateItemContainer:function(t,e){t.childNodes[0].innerHTML=e.name,t.className="DataCategoriesPage_Item DataBrowser_Clickable DataCategoriesPage_Item_"+e.id.replace(/ /g,"_"),t.data=e},_onItemClick:function(t){if(this.flyAnim){if(!this._ltr){var e=n.position(t),a=window.innerWidth-e.x-e.w;t.style.right=""+a+"px"}var i=this.flyAnim.fly(t,"Breadcrumb_SelectCategory");i.innerHTML="",s.remove(i,"DataBrowser_Clickable"),this._ltr||(t.style.right="auto")}this.onSelect(t.data)},_coerceCurrentPage:function(t){return 0>t?t=0:t>=this._pageCount&&(t=this._pageCount-1),t},_back:function(){this.set("currentPage",this.currentPage-1)},_forward:function(){this.set("currentPage",this.currentPage+1)},_onCountriesResponse:function(t){this.countrySelect.set("disabled",!1);for(var e=[{value:p,label:c.global}],a=0;a<t.length;a++)e.push({value:t[a].id,label:t[a].name});var i=new m({data:e,idProperty:"value"});this.countrySelect.set("store",i),this.countrySelect.set("value",this.countryID||p)},_onCountryChanged:function(){var t=this.countrySelect.get("value");t==p&&(t=null),this._set("countryID",t),this._loadDataCollections()},_setCountryIDAttr:function(t){this.countryID!=t&&(this._set("countryID",t),this._started&&this._loadDataCollections())},_loadDataCollections:function(){this.cancelProgress("_onDataCollectionsResponse"),this.showProgress(this._task.getDataCollections(this.countryID,null,["id","alias","type","description","popularity","fieldCategory","vintage","filteringTags"]),"_onDataCollectionsResponse")},_onDataCollectionsResponse:function(t){this.dataCollections||(this.dataCollections={}),this.dataCollections[this.countryID]=t?t:{};for(var e,a={},i=[],s=this.selection,o=0;o<t.length;o++){var n=t[o];if(n.fieldCategories={},n.metadata.filters)for(e=0;e<n.metadata.filters.length;e++)n.metadata.filters[e].id=n.metadata.filters[e].id.replace("Diposable","Disposable");if(n.metadata.categories){if(n.variables)for(var r=0;r<n.variables.length;r++){for(n.variables[r].id2=n.id+"."+n.variables[r].id,n.variables[r].hidden=0,n.variables[r].idDesc=n.variables[r].id+"."+n.variables[r].description,e=0;e<n.variables[r].filteringTags;e++)n.variables[r].filteringTags[e].value=n.variables[r].filteringTags[e].value.replase("$","");if(s&&s.length)for(e=0;e<s.length;e++)if(s[e]===n.variables[r].id2){i.push(n.variables[r]);break}}for(var l=0;l<n.metadata.categories.length;l++){var c=n.metadata.categories[l],h=c.id.toLowerCase();a[h]?a[h].dataCollections.push(n):a[h]={id:h,name:c.alias,dataCollections:[n],displayOrder:c.displayOrder}}}}this.shoppingCart.setVariables(i);var d=[];for(c in a)a.hasOwnProperty(c)&&(a[c].dataCollections.sort(function(t,e){return e.metadata.title<t.metadata.title?1:-1}),d.push(a[c]));d.sort(function(t,e){return e.displayOrder-t.displayOrder}),this.set("items",d)},_setItemsAttr:function(t){this._set("items",t),this.pagination.set("items",t),this._started&&this.resize()},onSelect:function(){},_search:function(){if(this.txbSearch.get("value")){for(var t,a,i=this.txbSearch.get("value"),s=this.get("items"),o=[],n=0;n<s.length;n++)for(var r=0;r<s[n].dataCollections.length;r++){a=s[n].dataCollections[r],t={id:a.id,metadata:a.metadata,keywords:a.keywords,variables:[]};for(var l=0;l<a.variables.length;l++)this._match(a.variables[l],i)&&t.variables.push(a.variables[l]);t.variables.length>0&&o.push(t)}if(o.length>0)this._set("selectedCollections",o),this.onSearch("'"+i+"'");else{var h={seachKey:i};this.txbSearch.showTooltip(e.substitute(c.noResults,h))}}},_match:function(t,e){return t.alias&&-1!==t.alias.toLowerCase().indexOf(e.toLowerCase())||t.description&&-1!==t.description.toLowerCase().indexOf(e.toLowerCase())||t.fieldCategory&&-1!==t.fieldCategory.toLowerCase().indexOf(e.toLowerCase())},onSearch:function(){}})});