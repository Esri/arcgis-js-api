// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/sniff","dojo/_base/kernel","dojo/has","dojo/dom-style","dojo/dom-construct","../kernel","../lang","../domUtils","../layers/InheritedDomain","../layers/FeatureLayer","dojo/i18n!../nls/jsapi","dojo/fx","dojox/gfx","dijit/_Widget","dijit/_Templated","dijit/Editor","dijit/_editor/plugins/LinkDialog","dijit/_editor/plugins/TextColor","./_EventedWidget","./editing/AttachmentEditor","./editing/Util","../tasks/query","dijit/form/DateTextBox","dijit/form/TextBox","dijit/form/NumberTextBox","dijit/form/FilteringSelect","dijit/form/NumberSpinner","dijit/form/Button","dijit/form/SimpleTextarea","dijit/form/ValidationTextBox","dijit/form/TimeTextBox","dijit/Tooltip","dojo/data/ItemFileReadStore","dojox/date/islamic","dojox/date/islamic/Date","dojox/date/islamic/locale","dojo/text!./templates/AttributeInspector.html"],function(e,t,i,n,a,s,r,o,l,d,u,c,h,f,_,m,F,I,p,y,g,v,b,T,L,E,x,j,N,D,C,S,V,w,A,O,k,P,R,B,U){var M=e([b,I,p],{declaredClass:"esri.dijit.AttributeInspector",widgetsInTemplate:!0,templateString:U,onUpdate:function(){},onDelete:function(){},onAttributeChange:function(){},onNext:function(){},onReset:function(){},onCancel:function(){},_navMessage:"( ${idx} ${of} ${numFeatures} )",_currentAttributeFieldName:null,_aiConnects:[],_selection:[],_toolTips:[],_numFeatures:0,_featureIdx:0,_currentLInfo:null,_currentFeature:null,_rollbackInfo:null,_eventMap:{update:!0,"delete":["feature"],"attribute-change":["feature","fieldName","fieldValue"],next:["feature"],reset:!0,cancel:!0},constructor:function(e){t.mixin(this,_.widgets.attributeInspector),e=e||{},e.featureLayer||e.layerInfos||console.error("esri.AttributeInspector: please provide correct parameter in the constructor"),this._datePackage=this._getDatePackage(e),this._layerInfos=e.layerInfos||[{featureLayer:e.featureLayer,options:e.options||[]}],this._layerInfos=i.filter(this._layerInfos,function(e){return!e.disableAttributeUpdate}),this._hideNavButtons=e.hideNavButtons||!1},postCreate:function(){if(i.every(this._layerInfos,function(e){return e.featureLayer.loaded}))this._initLayerInfos(),this._createAttachmentEditor(),this.onFirstFeature();else{var e=this._layerInfos.length;i.forEach(this._layerInfos,function(t){var i=t.featureLayer;if(i.loaded)e--;else var a=n.connect(i,"onLoad",this,function(){n.disconnect(a),a=null,e--,e||(this._initLayerInfos(),this._createAttachmentEditor(),this.onFirstFeature())})},this)}},destroy:function(){this._destroyAttributeTable(),i.forEach(this._aiConnects,n.disconnect),delete this._aiConnects,this._attachmentEditor&&(this._attachmentEditor.destroy(),delete this._attachmentEditor),delete this._layerInfos,this._selection=this._currentFeature=this._currentLInfo=this._attributes=this._layerInfos=null,this.inherited(arguments)},refresh:function(){this._updateSelection()},first:function(){this.onFirstFeature()},last:function(){this.onLastFeature()},next:function(){this.onNextFeature()},previous:function(){this.onPreviousFeature()},showFeature:function(e,t){t&&(this._createOnlyFirstTime=!0),this._updateSelection([e],t),this._updateUI()},onLayerSelectionChange:function(e,t,i){this._createOnlyFirstTime=!1,this._featureIdx=i===f.SELECTION_NEW?0:this._featureIdx,this._updateSelection(),this._updateUI()},onLayerSelectionClear:function(){!this._selection||this._selection.length<=0||(this._numFeatures=0,this._featureIdx=0,this._selection=[],this._currentFeature=null,this._currentLInfo=null,this._updateUI())},onLayerUpdateEnd:function(){},onLayerError:function(){},onLayerEditsError:function(){},onLayerEditsComplete:function(e,n,a,s){if(s=s||[],s.length){var r=this._selection,o=e.featureLayer.objectIdField;i.forEach(s,t.hitch(this,function(e){i.some(r,t.hitch(this,function(t,i){return t.attributes[o]!==e.objectId?!1:(this._selection.splice(i,1),!0)}))}))}n=n||[],n.length&&(this._selection=L.findFeatures(n,e.featureLayer),this._featureIdx=0);var l=this._numFeatures=this._selection?this._selection.length:0;if(n.length){var d=l?this._selection[this._featureIdx]:null;if(d){var u=d.getLayer(),c=u.getEditCapabilities();(!c.canCreate||c.canUpdate)&&this._showFeature(d)}this._updateUI()}if(a=a||[],a.length){var h=this._rollbackInfo;i.forEach(a,function(t){var n=L.findFeatures(a,e.featureLayer)[0];if(!t.success&&n.attributes[e.featureLayer.objectIdField]===t.objectId&&h){var s=h.graphic.attributes[h.field.name],r=i.filter(this._currentLInfo.fieldInfos,function(e){return e.fieldName===h.field.name},this)[0].dijit;n.attributes[h.field.name]=s,this._setValue(r,s)}},this)}this._rollbackInfo=null},onFieldValueChange:function(e,t){var n=e.field,a=e.dijit,s=this._currentFeature,r=this._currentLInfo,o=n.name;if(""!==a.displayedValue&&"undefined"==typeof t&&!a.isValid())return void this._setValue(a,s.attributes[n.name]);if(""!==a.displayedValue&&a.displayedValue!==t&&a.isValid&&!a.isValid())return void this._setValue(a,s.attributes[n.name]);if(t="undefined"==typeof t?null:t,"esriFieldTypeDate"===n.type){if(a instanceof Array){var l=a[0].getValue(),d=a[1].getValue();t=l&&d?new Date(l.getFullYear(),l.getMonth(),l.getDate(),d.getHours(),d.getMinutes(),d.getSeconds(),d.getMilliseconds()):l||d||null}else t=a.getValue();t=t&&t.getTime?t.getTime():t&&t.toGregorian?t.toGregorian().getTime():t}if(this._currentFeature.attributes[n.name]!==t){if(o===r.typeIdField){var u=this._findFirst(r.types,"id",t),c=r.fieldInfos;i.forEach(c,function(e){if(n=e.field,n&&n.name!==r.typeIdField){var t=e.dijit,i=this._setFieldDomain(t,u,n);i&&t&&(this._setValue(t,s.attributes[n.name]+""),t.isValid()===!1&&this._setValue(t,null))}},this)}this.onAttributeChange(s,o,t)}},onDeleteBtn:function(){this._deleteFeature()},onNextFeature:function(){this._onNextFeature(1)},onPreviousFeature:function(){this._onNextFeature(-1)},onFirstFeature:function(){this._onNextFeature(-1*this._featureIdx)},onLastFeature:function(){this._onNextFeature(this._numFeatures-1-this._featureIdx)},_initLayerInfos:function(){var e=this._layerInfos;this._editorTrackingInfos={},i.forEach(e,this._initLayerInfo,this)},_initLayerInfo:function(e){var n,a,s=e.featureLayer;this._userIds={};var r=s.id;s.credential&&(this._userIds[r]=s.credential.userId),e.userId&&(this._userIds[r]=e.userId),this._connect(s,"onSelectionComplete",t.hitch(this,"onLayerSelectionChange",e)),this._connect(s,"onSelectionClear",t.hitch(this,"onLayerSelectionClear",e)),this._connect(s,"onEditsComplete",t.hitch(this,"onLayerEditsComplete",e)),this._connect(s,"error",t.hitch(this,"onLayerError",e)),this._connect(s,"onUpdateEnd",t.hitch(this,"onLayerUpdateEnd",e)),e.showAttachments=s.hasAttachments?u.isDefined(e.showAttachments)?e.showAttachments:!0:!1,e.hideFields=e.hideFields||[],e.htmlFields=e.htmlFields||[],e.isEditable=s.isEditable()?u.isDefined(e.isEditable)?e.isEditable:!0:!1,e.typeIdField=s.typeIdField,e.layerId=s.id,e.types=s.types,s.globalIdField&&(n=this._findFirst(e.fieldInfos,"fieldName",s.globalIdField),n||e.showGlobalID||e.hideFields.push(s.globalIdField)),a=this._findFirst(e.fieldInfos,"fieldName",s.objectIdField),a||e.showObjectID||e.hideFields.push(s.objectIdField);var o=this._getFields(e.featureLayer);if(o){var l=e.fieldInfos||[];l=i.map(l,function(e){return t.mixin({},e)}),l.length?e.fieldInfos=i.filter(i.map(l,t.hitch(this,function(i){var n=i.stringFieldOption||(this._isInFields(i.fieldName,e.htmlFields)?M.STRING_FIELD_OPTION_RICHTEXT:M.STRING_FIELD_OPTION_TEXTBOX);return t.mixin(i,{field:this._findFirst(o,"name",i.fieldName),stringFieldOption:n})})),"return item.field;"):(o=i.filter(o,t.hitch(this,function(t){return!this._isInFields(t.name,e.hideFields)})),e.fieldInfos=i.map(o,t.hitch(this,function(t){var i=this._isInFields(t.name,e.htmlFields)?M.STRING_FIELD_OPTION_RICHTEXT:M.STRING_FIELD_OPTION_TEXTBOX;return{fieldName:t.name,field:t,stringFieldOption:i}}))),e.showGlobalID&&!n&&l.push(this._findFirst(o,"name",s.globalIdField)),e.showObjectID&&!a&&l.push(this._findFirst(o,"name",s.objectIdField));var d=[];s.editFieldsInfo&&(s.editFieldsInfo.creatorField&&d.push(s.editFieldsInfo.creatorField),s.editFieldsInfo.creationDateField&&d.push(s.editFieldsInfo.creationDateField),s.editFieldsInfo.editorField&&d.push(s.editFieldsInfo.editorField),s.editFieldsInfo.editDateField&&d.push(s.editFieldsInfo.editDateField)),this._editorTrackingInfos[s.id]=d}},_createAttachmentEditor:function(){this._attachmentEditor=null;var e=this._layerInfos,t=i.filter(e,function(e){return e.showAttachments});t&&t.length&&(this._attachmentEditor=new T({"class":"atiAttachmentEditor"},this.attachmentEditor),this._attachmentEditor.startup())},_setCurrentLInfo:function(e){var t=this._currentLInfo?this._currentLInfo.featureLayer:null,i=e.featureLayer;if(t&&t.id===i.id&&!t.ownershipBasedAccessControlForFeatures){var n=i.getEditCapabilities();if(!n.canCreate||n.canUpdate)return}this._currentLInfo=e,this._createTable()},_updateSelection:function(e,t){this._selection=e||[];var n=this._layerInfos;i.forEach(n,this._getSelection,this);var a=this._selection.length;this._numFeatures=this._selection.length;var s=a?this._selection[this._featureIdx]:null;this._showFeature(s,t)},_getSelection:function(e){var t=e.featureLayer.getSelectedFeatures();this._selection=this._selection.concat(t)},_updateUI:function(){var e=this._numFeatures,t=this._currentLInfo;this.layerName.innerHTML=t&&0!==e?t.featureLayer?t.featureLayer.name:"":this.NLS_noFeaturesSelected,o.set(this.attributeTable,"display",e?"":"none"),o.set(this.editButtons,"display",e?"":"none"),o.set(this.navButtons,"display",!this._hideNavButtons&&e>1?"":"none"),this.navMessage.innerHTML=u.substitute({idx:this._featureIdx+1,of:this.NLS_of,numFeatures:this._numFeatures},this._navMessage),this._attachmentEditor&&o.set(this._attachmentEditor.domNode,"display",t&&t.showAttachments&&e?"":"none");var i=t&&t.showDeleteButton===!1||!this._canDelete?!1:!0;o.set(this.deleteBtn.domNode,"display",i?"":"none"),this.domNode.parentNode&&this.domNode.parentNode.scrollTop>0&&(this.domNode.parentNode.scrollTop=0)},_onNextFeature:function(e){this._featureIdx+=e,this._featureIdx<0?this._featureIdx=this._numFeatures-1:this._featureIdx>=this._numFeatures&&(this._featureIdx=0);var t=this._selection.length?this._selection[this._featureIdx]:null;this._showFeature(t),this._updateUI(),this.onNext(t)},_deleteFeature:function(){this.onDelete(this._currentFeature)},_showFeature:function(e,n){if(e){this._currentFeature=e;var a=n?n:e.getLayer(),s=a.getEditCapabilities({feature:e,userId:this._userIds[a.id]});this._canUpdate=s.canUpdate,this._canDelete=s.canDelete;var r=this._getLInfoFromFeatureLayer(a);if(r){this._setCurrentLInfo(r);var o=e.attributes,l=this._findFirst(r.types,"id",o[r.typeIdField]),d=null,h=r.fieldInfos;i.forEach(h,function(e){d=e.field;var n=[];e.dijit&&e.dijit.length>1?i.forEach(e.dijit,function(e){n.push(e)}):n.push(e.dijit),i.forEach(n,t.hitch(this,function(e){if(e){var t=this._setFieldDomain(e,l,d),i=o[d.name];i=i&&t&&t.codedValues&&t.codedValues.length&&t.codedValues[i]?t.codedValues[i].name:i,u.isDefined(i)||(i=""),"dijit.form.DateTextBox"===e.declaredClass||"dijit.form.TimeTextBox"===e.declaredClass?i=""===i?null:new Date(i):"dijit.form.FilteringSelect"===e.declaredClass&&(e._lastValueReported=null,i=o[d.name]+"");try{this._setValue(e,i),"dijit.form.FilteringSelect"===e.declaredClass&&e.isValid()===!1&&this._setValue(e,null)}catch(n){e.set("displayedValue",this.NLS_errorInvalid,!1)}}}))},this),this._attachmentEditor&&r.showAttachments&&this._attachmentEditor.showAttachments(this._currentFeature,a);var f=a.getEditSummary(e);f?(this.editorTrackingInfoDiv.innerHTML=f,c.show(this.editorTrackingInfoDiv)):c.hide(this.editorTrackingInfoDiv)}}},_setFieldDomain:function(e,t,n){if(!e)return null;var a=n.domain;return t&&t.domains&&t.domains[n.name]&&t.domains[n.name]instanceof h==!1&&(a=t.domains[n.name]),a?(a.codedValues&&a.codedValues.length>0?(e.set("store",this._toStore(i.map(a.codedValues,function(e){return{id:e.code+="",name:e.name}}))),this._setValue(e,a.codedValues[0].code)):(e.constraints={min:u.isDefined(a.minValue)?a.minValue:Number.MIN_VALUE,max:u.isDefined(a.maxValue)?a.maxValue:Number.MAX_VALUE},this._setValue(e,e.constraints.min)),a):null},_setValue:function(e,t){e.set&&(e._onChangeActive=!1,e.set("value",t,!0),e._onChangeActive=!0)},_getFields:function(e){var n=e._getOutFields();if(!n)return null;var a=e.fields;return"*"==n?a:i.filter(i.map(n,t.hitch(this,"_findFirst",a,"name")),u.isDefined)},_isInFields:function(e,t){return e&&(t||t.length)?i.some(t,function(t){return t.toLowerCase()===e.toLowerCase()}):!1},_findFirst:function(e,t,n){var a=i.filter(e,function(e){return e.hasOwnProperty(t)&&e[t]===n});return a&&a.length?a[0]:null},_getLInfoFromFeatureLayer:function(e){var t=e?e.id:null;return this._findFirst(this._layerInfos,"layerId",t)},_createTable:function(){this._destroyAttributeTable(),this.attributeTable.innerHTML="",this._attributes=l.create("table",{cellspacing:"0",cellpadding:"0"},this.attributeTable);var e=l.create("tbody",null,this._attributes),n=this._currentFeature,a=this._currentLInfo,s=this._findFirst(a.types,"id",n.attributes[a.typeIdField]),r=a.fieldInfos;i.forEach(r,t.hitch(this,"_createField",s,e),this),this._createOnlyFirstTime=!1},_createField:function(e,i,n){var a=this._currentLInfo,s=n.field;if(!this._isInFields(s.name,a.hideFields)&&!this._isInFields(s.name,this._editorTrackingInfos[a.featureLayer.id])){var r=l.create("tr",null,i),o=l.create("td",{innerHTML:n.label||s.alias||s.name,"class":"atiLabel"},r);o=l.create("td",null,r);var d,u=null,c=!1;if(n.customField?(l.place(n.customField.domNode||n.customField,l.create("div",null,o),"first"),d=n.customField):(a.isEditable===!1||s.editable===!1||n.isEditable===!1||"esriFieldTypeOID"===s.type||"esriFieldTypeGlobalID"===s.type||!this._canUpdate&&!this._createOnlyFirstTime)&&(c=!0),!d&&a.typeIdField&&s.name.toLowerCase()==a.typeIdField.toLowerCase()?d=this._createTypeField(s,n,o):d||(d=this._createDomainField(s,n,e,o)),!d)switch(s.type){case"esriFieldTypeString":d=this._createStringField(s,n,o);break;case"esriFieldTypeDate":d=this._createDateField(s,n,o),n.format&&n.format.time&&(u=this._createTimeField(s,n,o));break;case"esriFieldTypeInteger":case"esriFieldTypeSmallInteger":d=this._createIntField(s,n,o);break;case"esriFieldTypeSingle":case"esriFieldTypeDouble":d=this._createFltField(s,n,o);break;default:d=this._createStringField(s,n,o)}n.tooltip&&n.tooltip.length&&this._toolTips.push(new O({connectId:[d.id],label:n.tooltip})),d.onChange=t.hitch(this,"onFieldValueChange",n),d.set("disabled",c),u?(n.dijit=[d,u],u.onChange=t.hitch(this,"onFieldValueChange",n),u.set("disabled",c)):n.dijit=d}},_createTypeField:function(e,t,n){var a=e.domain;return a&&"range"===a.type&&a.minValue===a.maxValue?new j({"class":"atiField"},l.create("div",null,n)):new D({"class":"atiField",name:e.alias||e.name,required:!e.nullable||!1,store:this._toStore(i.map(this._currentLInfo.types,function(e){return{id:e.id,name:e.name}})),searchAttr:"name"},l.create("div",null,n))},_createDomainField:function(e,t,i,n){var a=e.domain;return i&&i.domains&&i.domains[e.name]&&i.domains[e.name]instanceof h==!1&&(a=i.domains[e.name]),a?a.codedValues?new D({"class":"atiField",name:e.alias||e.name,searchAttr:"name",required:!e.nullable||!1},l.create("div",null,n)):new C({"class":"atiField"},l.create("div",null,n)):null},_createStringField:function(e,t,i){var n={"class":"atiField",trim:!0,maxLength:e.length};if(t.stringFieldOption===M.STRING_FIELD_OPTION_TEXTAREA)return n["class"]+=" atiTextAreaField",new V(n,l.create("div",null,i));if(t.stringFieldOption===M.STRING_FIELD_OPTION_RICHTEXT){n["class"]+=" atiRichTextField",n.height="100%",n.width="100%",n.plugins=t.richTextPlugins||["bold","italic","underline","foreColor","hiliteColor","|","justifyLeft","justifyCenter","justifyRight","justifyFull","|","insertOrderedList","insertUnorderedList","indent","outdent","|","createLink"];var a=new y(n,l.create("div",null,i));return a.startup(),a}return e.nullable&&t.field&&t.field.nullable?new j(n,l.create("div",null,i)):new w({required:!0},l.create("div",null,i))},_createTimeField:function(e,t,i){var n={"class":"atiField",trim:!0,constraints:{formatLength:"medium"}};return this._datePackage&&(n.datePackage=this._datePackage),new A(n,l.create("div",null,i))},_createDateField:function(e,t,i){var n={"class":"atiField",trim:!0};return this._datePackage&&(n.datePackage=this._datePackage),new x(n,l.create("div",null,i))},_createIntField:function(e,t,i){var n="esriFieldTypeSmallInteger"===e.type?{min:-32768,max:32767,places:0}:{places:0};return new N({"class":"atiField",constraints:n,invalidMessage:this.NLS_validationInt,trim:!0},l.create("div",null,i))},_createFltField:function(e,t,i){var n=/\de[-+]?\d/i,a=/[0-9]\d{0,2}(\.\d{3})*(,\d+)?$/i;return new w({validator:function(e,t){return this._maskValidSubsetError=!1,this._hasBeenBlurred=!0,""===e||null===e?!0:n.test(e)?!0:a.test(e)&&("min"in t?this.compare(e,t.min)>=0:!0)&&("max"in t?this.compare(e,t.max)<=0:!0)?!0:!1},"class":"atiField",trim:!0,constraints:{places:"0,40",min:-1/0,max:1/0,exponent:!0},invalidMessage:this.NLS_validationFlt},l.create("div",null,i))},_toStore:function(e){return new k({data:{identifier:"id",label:"name",items:e}})},_connect:function(e,t,i){this._aiConnects.push(n.connect(e,t,i))},_getDatePackage:function(e){return null===e.datePackage?null:e.datePackage?e.datePackage:"ar"===s.locale?"dojox.date.islamic":null},_destroyAttributeTable:function(){var e=this._layerInfos;i.forEach(e,function(e){var n=e.fieldInfos;i.forEach(n,function(e){var n=e.dijit;if(n){if(n._onChangeHandle=null,e.customField)return;n instanceof Array?i.forEach(n,t.hitch(this,function(e){e.destroyRecursive?e.destroyRecursive():e.destroy&&e.destroy(),e._onChangeHandle=null})):n.destroyRecursive?n.destroyRecursive():n.destroy&&n.destroy()}e.dijit=null},this)},this);var n=this._toolTips;i.forEach(n,function(e){e.destroy()}),this._toolTips=[],this._attributes&&l.destroy(this._attributes)}});return t.mixin(M,{STRING_FIELD_OPTION_RICHTEXT:"richtext",STRING_FIELD_OPTION_TEXTAREA:"textarea",STRING_FIELD_OPTION_TEXTBOX:"textbox"}),r("extend-esri")&&t.setObject("dijit.AttributeInspector",M,d),M});