define(["dojo/_base/declare","dojo/_base/lang","dojo/i18n!../nls/jsapi","dojo/text!./templates/ImageServiceMeasure.html","dojo/has","../kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","../toolbars/ImageServiceMeasureTool","dijit/form/DropDownButton","dijit/DropDownMenu","dijit/MenuItem","dijit/MenuSeparator","dijit/PopupMenuItem","dijit/RadioMenuItem","dijit/CheckedMenuItem","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../graphic","../geometry/Point","dojo/_base/Color","dojo/dom-class","dojo/dom","dojo/_base/array"],function(e,t,i,n,r,s,a,o,h,u,l,c,d,_,p,m,O,w,b,I,M,S,g,T,f,D){var A=e([a,o,h],{declaredClass:"esri.dijit.ImageServiceMeasure",templateString:n,widgetsInTemplate:!0,layer:null,map:null,_supportedMeasureOperations:[],_supportedUnits:{},markerSymbol:null,lineSymbol:null,fillSymbol:null,_currentGraphic:null,_currentUnits:{angularUnit:"esriDUDecimalDegrees",linearUnit:"esriMeters",areaUnit:"esriSquareMeters"},_desiredDropDownOrder:["OPERATION_POINT","OPERATION_DISTANCE_ANGLE","OPERATION_AREA_PERIMETER","OPERATION_CENTROID","OPERATION_BASE_TOP","OPERATION_TOP_TOP_SHADOW","OPERATION_BASE_TOP_SHADOW"],_map3DOperations:{OPERATION_POINT:"OPERATION_POINT_3D",OPERATION_DISTANCE_ANGLE:"OPERATION_DISTANCE_ANGLE_3D",OPERATION_AREA_PERIMETER:"OPERATION_AREA_PERIMETER_3D",OPERATION_CENTROID:"OPERATION_CENTROID_3D",OPERATION_BASE_TOP:"OPERATION_BASE_TOP",OPERATION_TOP_TOP_SHADOW:"OPERATION_TOP_TOP_SHADOW",OPERATION_BASE_TOP_SHADOW:"OPERATION_BASE_TOP_SHADOW"},_menu:null,_button:null,_currentOperation:null,_activeMeasureOpMenuItem:null,_has3DOperations:!1,_enabled3DCheckbox:!1,constructor:function(t){e.safeMixin(this,t),this._setDefaultSymbols(),this._i18n=i},startup:function(){this.inherited(arguments)},postCreate:function(){this.map&&this.layer&&(this.measureToolbar=new u({map:this.map,layer:this.layer}),this.measureToolbar.on("draw-end",t.hitch(this,this._addGraphic)),this.measureToolbar.on("draw-start",t.hitch(this,this._onDrawStart)),this.measureToolbar.on("measure-end",t.hitch(this,this._addInfoWindow)),this.measureToolbar.on("unit-change",t.hitch(this,this._onUnitChange)),this._supportedMeasureOperations=this.measureToolbar.getSupportedMeasureOperations(),this._has3DOperations=this._check3DSupported(),this._reorderMeasureOperations(),this._supportedUnits=this.measureToolbar.getSupportedUnits()),this._populateMeasureDropdown()},_check3DSupported:function(){return this._supportedMeasureOperations.indexOf("OPERATION_POINT_3D")>-1},_reorderMeasureOperations:function(){var e=[];D.forEach(this._desiredDropDownOrder,function(t){this._supportedMeasureOperations.indexOf(t)>-1&&e.push(t)},this),this._supportedMeasureOperations=e},_setDefaultSymbols:function(){this.markerSymbol||(this.markerSymbol=new w,this.markerSymbol.setPath("M16,4.938c-7.732,0-14,4.701-14,10.5c0,1.981,0.741,3.833,2.016,5.414L2,25.272l5.613-1.44c2.339,1.316,5.237,2.106,8.387,2.106c7.732,0,14-4.701,14-10.5S23.732,4.938,16,4.938zM16.868,21.375h-1.969v-1.889h1.969V21.375zM16.772,18.094h-1.777l-0.176-8.083h2.113L16.772,18.094z"),this.markerSymbol.setColor(new g("#00FFFF"))),this.lineSymbol||(this.lineSymbol=new b(b.STYLE_SOLID,new g([255,0,0]),1.5)),this.fillSymbol||(this.fillSymbol=new I(I.STYLE_SOLID,new b(b.STYLE_DASHDOT,new g([255,0,0]),2),new g([255,255,0,.25])))},_populateMeasureDropdown:function(){var e,i,n,r,s,a,o,h,u;this._menu=new c({style:"display: none;"}),D.forEach(this._supportedMeasureOperations,function(i){e=new d({label:this._i18n.widgets.imageServiceMeasure.operationLabel[i],iconClass:"esri"+i}),e.on("click",t.hitch(this,this._onMenuItemClick,i,e)),this._menu.addChild(e)},this),i=new _,this._menu.addChild(i),this._has3DOperations&&(h=new O({label:this._i18n.widgets.imageServiceMeasure.measure3DLabel,checked:!1}),h.on("change",t.hitch(this,this._on3DCheckBoxChange)),this._menu.addChild(h),n=new _,this._menu.addChild(n)),s=new c({style:"display: none;"}),D.forEach(this._supportedUnits.angularUnits,function(i){u=this._isCurrentAngularUnit(i),e=new m({group:"angularUnit",checked:u,label:this._i18n.widgets.imageServiceMeasure.unitLabel[i],"class":u?"esriSelectedOption":""}),u&&(this._currentAngularUnitMenuItem=e),e.on("click",t.hitch(this,this._onAngularUnitClick,i,e)),s.addChild(e)},this),r=new p({label:this._i18n.widgets.imageServiceMeasure.angularUnits,popup:s}),this._menu.addChild(r),a=new c({style:"display: none;"}),D.forEach(this._supportedUnits.linearUnits,function(i){u=this._isCurrentLinearUnit(i),e=new m({group:"linearUnit",checked:u,label:this._i18n.widgets.imageServiceMeasure.unitLabel[i],"class":u?"esriSelectedOption":""}),u&&(this._currentLinearUnitMenuItem=e),e.on("click",t.hitch(this,this._onLinearUnitClick,i,e)),a.addChild(e)},this),r=new p({label:this._i18n.widgets.imageServiceMeasure.linearUnits,popup:a}),this._menu.addChild(r),o=new c({style:"display: none;"}),D.forEach(this._supportedUnits.areaUnits,function(i){u=this._isCurrentAreaUnit(i),e=new m({group:"areaUnit",checked:u,label:this._i18n.widgets.imageServiceMeasure.unitLabel[i],"class":u?"esriSelectedOption":""}),u&&(this._currentAreaUnitMenuItem=e),e.on("click",t.hitch(this,this._onAreaUnitClick,i,e)),o.addChild(e)},this),r=new p({label:this._i18n.widgets.imageServiceMeasure.areaUnits,popup:o}),this._menu.addChild(r),this._button=new l({label:this._i18n.widgets.imageServiceMeasure.measureBtnText,dropDown:this._menu,iconClass:"esriMeasureIcon"},this.measureDropDownContainer),this._button.startup()},_on3DCheckBoxChange:function(e){this._enabled3DCheckbox=e,this._button.openDropDown(),this._currentOperation&&(this._activeMeasureOpMenuItem=null,this._onMenuItemClick(this._currentOperation.replace("_3D","")))},_onMenuItemClick:function(e,t){this._enabled3DCheckbox&&(e=this._map3DOperations[e]);var i=t.domNode;this.map.disableMapNavigation(),this._currentGraphic&&(this.map.graphics.remove(this._currentGraphic),this._currentGraphic=null),this._currentInfowindow&&(this.map.infoWindow.hide(this._currentInfowindow),this._currentInfowindow=null),this._activeMeasureOpMenuItem?this._currentOperation===e||this._currentOperation===e.replace("_3D","")?(T.remove(this._activeMeasureOpMenuItem.domNode,"esriSelectedOption"),this._currentOperation=null,this._activeMeasureOpMenuItem=null,this.measureToolbar.deactivate(),this._button.set({label:this._i18n.widgets.imageServiceMeasure.measureBtnText,iconClass:"esriMeasureIcon"}),T.remove(this._button._buttonNode,"esriCheckedMeasureButton"),this.map.enableMapNavigation()):(T.remove(this._activeMeasureOpMenuItem.domNode,"esriSelectedOption"),T.add(i,"esriSelectedOption"),this._activeMeasureOpMenuItem=t,this._currentOperation=e,this._button.set({label:this._i18n.widgets.imageServiceMeasure.operationLabel[e],iconClass:"esri"+e.replace("_3D","")}),this.measureToolbar.activate(e),this.measureToolbar.showDrawTooltip()):(this._activeMeasureOpMenuItem=t,T.add(i,"esriSelectedOption"),this._currentOperation=e,this._button.set({label:this._i18n.widgets.imageServiceMeasure.operationLabel[e],iconClass:"esri"+e.replace("_3D","")}),T.add(this._button._buttonNode,"esriCheckedMeasureButton"),this.measureToolbar.activate(e),this.measureToolbar.showDrawTooltip())},_isCurrentAngularUnit:function(e){return e==this._currentUnits.angularUnit?!0:!1},_isCurrentLinearUnit:function(e){return e==this._currentUnits.linearUnit?!0:!1},_isCurrentAreaUnit:function(e){return e==this._currentUnits.areaUnit?!0:!1},_onLinearUnitClick:function(e,t){T.remove(this._currentLinearUnitMenuItem.domNode,"esriSelectedOption"),T.add(t.domNode,"esriSelectedOption"),this._currentLinearUnitMenuItem=t,this._currentUnits.linearUnit=e,this.measureToolbar.setLinearUnit(e),this._button.openDropDown()},_onAngularUnitClick:function(e,t){T.remove(this._currentAngularUnitMenuItem.domNode,"esriSelectedOption"),T.add(t.domNode,"esriSelectedOption"),this._currentAngularUnitMenuItem=t,this._currentUnits.angularUnit=e,this.measureToolbar.setAngularUnit(e),this._button.openDropDown()},_onAreaUnitClick:function(e,t){T.remove(this._currentAreaUnitMenuItem.domNode,"esriSelectedOption"),T.add(t.domNode,"esriSelectedOption"),this._currentAreaUnitMenuItem=t,this._currentUnits.areaUnit=e,this.measureToolbar.setAreaUnit(e),this._button.openDropDown()},_onDrawStart:function(){this._currentGraphic&&(this.map.graphics.remove(this._currentGraphic),this._currentGraphic=null),this._currentInfowindow&&(this.map.infoWindow.hide(this._currentInfowindow),this._currentInfowindow=null)},_addGraphic:function(e){var t,i,n=e.geometry;this.measureToolbar.hideDrawTooltip(),t="point"===n.type?this.markerSymbol:"line"===n.type||"polyline"===n.type?this.lineSymbol:this.fillSymbol,this._currentGraphic&&(this.map.graphics.remove(this._currentGraphic),this._currentGraphic=null),this._currentInfowindow&&(this.map.infoWindow.hide(this._currentInfowindow),this._currentInfowindow=null),i=new M(n,t),this._currentGraphic=i,this.map.graphics.add(i)},_addInfoWindow:function(e){var t,i,n,r,s,a,o,h,u="";if(e.measureResult){t=e.measureResult;for(h in t)t.hasOwnProperty(h)&&t[h]&&"name"!==h&&"sensorName"!==h&&("point"!=h?(s=h.charAt(0).toUpperCase()+h.slice(1),i=this._i18n.widgets.imageServiceMeasure.unitLabel[t[h].unit],r=Math.abs(t[h].uncertainty).toFixed(2),n=Math.abs(t[h].value).toFixed(2),u+="<strong>"+s+"</strong>: "+n+" (&plusmn"+r+") "+i+"<br/>"):(s=h.charAt(0).toUpperCase()+h.slice(1),a=t[h].value.x.toFixed(2),o=t[h].value.y.toFixed(2),u+="<strong>"+s+"</strong><br/>X : "+a+"<br/>Y : "+o+"<br/>"))}else u=e.error.message;this._displayMeasureResult(u)},_displayMeasureResult:function(e){if(this._currentGraphic){var i,n,r=this._currentGraphic.geometry;"point"===r.type?this._currentInfowindow=r:"polyline"===r.type?(i=(r.paths[0][0][0]+r.paths[0][1][0])/2,n=(r.paths[0][0][1]+r.paths[0][1][1])/2,this._currentInfowindow=new S(i,n,this.map.spatialReference)):"polygon"===r.type&&(this._currentInfowindow=r.getCentroid()),this.map.infoWindow.setTitle(this._i18n.widgets.imageServiceMeasure.infoWindowTitle),this.map.infoWindow.setContent(e),this.map.infoWindow.on("hide",t.hitch(this,this._removeAssociatedGeometry)),this.map.infoWindow.show(this._currentInfowindow)}},_removeAssociatedGeometry:function(){this._currentGraphic&&(this.map.graphics.remove(this._currentGraphic),this._currentGraphic=null)},_onUnitChange:function(e){this._addInfoWindow(e)},destroy:function(){this.inherited(arguments)}});return r("extend-esri")&&t.setObject("dijit.ImageServiceMeasure",A,s),A});