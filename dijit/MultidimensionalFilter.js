// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/i18n!../nls/jsapi","dojo/text!./templates/MultidimensionalFilter.html","dojo/text!./templates/NumericDimensionItem.html","dojo/text!./templates/TimeDimensionItem.html","dojo/text!./templates/PagedDateTimeWidget.html","dojo/text!./templates/PagedNumberWidget.html","dojo/store/Memory","dojo/has","../kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/form/DateTextBox","dijit/registry","dojo/date/locale","dojo/dom-style","dojo/dom-class","dojo/query","../layers/DimensionalDefinition","../layers/MosaicRule","dojo/html","dojo/dom","dijit/form/FilteringSelect","dijit/form/ComboBox","dojox/widget/YearlyCalendar","dojox/widget/MonthlyCalendar","dojox/widget/Calendar3Pane","dojo/_base/array","dijit/Tooltip","dijit/form/CheckBox","dijit/form/Button"],function(e,i,t,s,n,a,o,l,h,r,d,u,m,c,f,_,p,v,x,y,g,b,D,S,w,T,C,V,M,I,R){var B=e("PagedDateTimeWidget",[m,c,f],{pageCount:100,dimension:"",start:"",_currentIndex:"",displayDate:"",store:"",prefix:"",values:"",dateValue:"",changeTimeVal:"",intervalInfo:{},templateString:l,constructor:function(i){e.safeMixin(this,i),this._i18n=s},_setValuesAttr:function(e){if(this._set("values",e),this._currentIndex=this.displayDate?R.indexOf(this.values,this.displayDate):0,this._checkButtons(),this.dateSelect){var i,t=[];R.forEach(this.values,function(e){t.push({id:e,label:e})},this),i=new r({data:t}),this.dateSelect.set({store:i,value:this.displayDate||this.values[0]}),this.dateSelect.startup()}else this._populateValues()},_setDateValueAttr:function(e){e&&(this._currentIndex=R.indexOf(this.values,e),-1!=this._currentIndex?this.dateValue=e:(this.dateValue=this._snapToClosest(e),this._currentIndex=R.indexOf(this.values,this.dateValue)),this._updateValues())},_checkButtons:function(){1==this.values.length?this._setButtonProperties(!0,"default",!0,"default",!0,"default",!0,"default"):0==this._currentIndex?this._setButtonProperties(!0,"default",!0,"default",!1,"pointer",!1,"pointer"):this._currentIndex==this.values.length-1?this._setButtonProperties(!1,"pointer",!1,"pointer",!0,"default",!0,"default"):this._setButtonProperties(!1,"pointer",!1,"pointer",!1,"pointer",!1,"pointer")},_setButtonProperties:function(e,i,t,s,n,a,o,l){this.StartBtn.set("disabled",e),x.set(this.StartBtn.iconNode,"cursor",i),this.PreviousBtn.set("disabled",t),x.set(this.PreviousBtn.iconNode,"cursor",s),this.NextBtn.set("disabled",n),x.set(this.NextBtn.iconNode,"cursor",a),this.EndBtn.set("disabled",o),x.set(this.EndBtn.iconNode,"cursor",l)},_getTimeArray:function(){var e,i,t,s,n=[];for(t=this.values[this._currentIndex]-Math.abs(this.values[this._currentIndex]%864e5),s=t+864e5,e=0;e<this.values.length;e++)if(this.values[e]>=t&&this.values[e]<s)i=v.format(this._getUTCTime(new Date(this.values[e])),{timePattern:"hh:mm a",selector:"time"}),n.push({id:this.values[e],label:i});else if(0!=n.length)break;return n},_updateTimeDropDown:function(){var e,i=[];i=this._getTimeArray(),this.timeSelect.reset(),e=new r({data:i}),this.timeSelect.set({store:e,value:this.values[this._currentIndex]})},_populateValues:function(){var e,t,s,n,a,o=[];a=v.format(this._getUTCTime(new Date(this.values[this._currentIndex])),{datePattern:"yyyy-MM-dd",selector:"date"}),o=this._getTimeArray(),s=v.format(this._getUTCTime(new Date(this.values[0])),{datePattern:"yyyy-MM-dd",selector:"date"}),n=v.format(this._getUTCTime(new Date(this.values[this.values.length-1])),{datePattern:"yyyy-MM-dd",selector:"date"}),this.dateSelect=new _({value:a,id:this.prefix+this.dimension+"Date",constraints:{min:s,max:n},popupClass:I,style:"width:95px;","class":"dijitSelect esriMultidimensionalFilterVariableList"},this.DateSelector),this.dateSelect.startup(),this.dateSelect.on("change",i.hitch(this,this._dateBoxChange)),e=new r({data:o}),t=this.prefix+this.dimension+"Time",this.timeSelect=new T({store:e,id:t,value:this.displayDate,labelAttr:"label",labelType:"text",searchAttr:"label",style:"width:85px;","class":"dijitSelect esriMultidimensionalFilterVariableList",maxHeight:-1},this.TimeSelector),this.timeSelect.startup(),this.timeSelect.on("change",i.hitch(this,this._timeValueChange)),this._checkCalendarControlView()},_checkCalendarControlView:function(){var e,i,t,s,n,a=[],o=[],l=[];if(this.intervalInfo.intervalUnit)"years"==this.intervalInfo.intervalUnit.toLowerCase()?(this.dateSelect.set("popupClass",V),x.set(this.timeSelect.domNode,"display","none")):"months"==this.intervalInfo.intervalUnit.toLowerCase()?(this.dateSelect.set("popupClass",M),x.set(this.timeSelect.domNode,"display","none")):"days"==this.intervalInfo.intervalUnit.toLowerCase()?(this.dateSelect.set("popupClass",I),x.set(this.timeSelect.domNode,"display","none")):this.dateSelect.set("popupClass",I);else{for(n=this.values.length<12?this.values.length:12,s=0;n>s;s++)e=v.format(this._getUTCTime(new Date(this.values[s])),{datePattern:"yyyy",selector:"date"}),i=v.format(this._getUTCTime(new Date(this.values[s])),{datePattern:"yyyyMM",selector:"date"}),t=v.format(this._getUTCTime(new Date(this.values[s])),{timePattern:"HH:mm",selector:"time"}),-1==R.indexOf(o,e)&&o.push(e),-1==R.indexOf(l,i)&&l.push(i),-1==R.indexOf(a,t)&&a.push(t);o.length==n?(this.dateSelect.set("popupClass",V),x.set(this.timeSelect.domNode,"display","none")):l.length==n?(this.dateSelect.set("popupClass",M),x.set(this.timeSelect.domNode,"display","none")):(this.dateSelect.set("popupClass",I),1==a.length&&x.set(this.timeSelect.domNode,"display","none"))}},_timeValueChange:function(e){e&&(this._currentIndex=R.indexOf(this.values,e),this._checkButtons())},_updateValues:function(){var e;e=v.format(this._getUTCTime(new Date(this.values[this._currentIndex])),{datePattern:"yyyy-MM-dd",selector:"date"}),this.dateSelect.set("_onChangeActive",!1),this.dateSelect.set("value",e,!1),this.dateSelect.set("_onChangeActive",!0),this._updateTimeDropDown(),this._checkButtons()},_getUTCTime:function(e){return e&&e.setTime(e.getTime()+60*e.getTimezoneOffset()*1e3),e},_onStartBtnClick:function(){this._currentIndex=0,this._updateValues()},_onPreviousBtnClick:function(){this._currentIndex--,this._updateValues()},_onNextBtnClick:function(){this._currentIndex++,this._updateValues()},_onEndBtnClick:function(){this._currentIndex=this.values.length-1,this._updateValues()},_snapToClosest:function(e){var i,t,s,n,a,o=0,l=0;for(e=new Date(e),e=e.getTime()-60*e.getTimezoneOffset()*1e3,i=Math.abs(e-this.values[0]),t=Math.abs(e-this.values[0]),n=this.values[0],a=1;a<this.values.length;a++)s=this.values[a]-e,0>s?Math.abs(s)<t&&(t=Math.abs(s),o=a):i>s&&(i=s,l=a);return 86399999>i||t>i?(n=this.values[l],this._currentIndex=l):(n=this.values[o],this._currentIndex=o),n},_dateBoxChange:function(e){var i,t,s,n=[];e&&(i=new Date(e).getTime(),t=this._snapToClosest(parseInt(i,10)),this.dateSelect.set("_onChangeActive",!1),this.dateSelect.set("value",v.format(this._getUTCTime(new Date(t)),{datePattern:"yyyy-MM-dd",selector:"date"})),this.dateSelect.set("_onChangeActive",!0),v.format(this._getUTCTime(new Date(t)),{datePattern:"yyyy-MM-dd",selector:"date"})!=v.format(new Date(i),{datePattern:"yyyy-MM-dd",selector:"date"})&&(this.dateSelect.focus(),this.dateSelect.set("message",this._i18n.widgets.multidimensionalFilter.dateSnapText)),n=this._getTimeArray(),this.timeSelect.reset(),s=new r({data:n}),this.timeSelect.set({store:s,value:n[0].id}),this._checkButtons())}}),N=e("PagedNumberWidget",[m,c,f],{pageCount:100,dimension:"",start:"",displayNum:"",store:"",prefix:"",values:"",numValue:"",intervalInfo:{},templateString:h,constructor:function(i){e.safeMixin(this,i),this._i18n=s},_setValuesAttr:function(e){if(this._set("values",e),this._currentIndex=this.displayNum||0===this.displayNum?R.indexOf(this.values,this.displayNum):0,this._checkButtons(),this.numSelect){var i,t=[];R.forEach(this.values,function(e){t.push({id:e,label:e})},this),i=new r({data:t}),this._currentIndex=this.displayNum?R.indexOf(this.values,this.displayNum):0,this.numSelect.set({store:i,value:this.displayNum?this.displayNum:this.values[0]}),this.numSelect.startup()}else this._populateValues()},_setNumValueAttr:function(e){(e||0==e)&&(this._currentIndex=R.indexOf(this.values,e),-1!=this._currentIndex?this.numValue=e:(this.numValue=this._snapToClosest(e),this._currentIndex=R.indexOf(this.values,this.numValue)),this._updateValues())},_checkButtons:function(){1==this.values.length?this._setButtonProperties(!0,"default",!0,"default",!0,"default",!0,"default"):0==this._currentIndex?this._setButtonProperties(!0,"default",!0,"default",!1,"pointer",!1,"pointer"):this._currentIndex==this.values.length-1?this._setButtonProperties(!1,"pointer",!1,"pointer",!0,"default",!0,"default"):this._setButtonProperties(!1,"pointer",!1,"pointer",!1,"pointer",!1,"pointer")},_setButtonProperties:function(e,i,t,s,n,a,o,l){this.StartBtn.set("disabled",e),x.set(this.StartBtn.iconNode,"cursor",i),this.PreviousBtn.set("disabled",t),x.set(this.PreviousBtn.iconNode,"cursor",s),this.NextBtn.set("disabled",n),x.set(this.NextBtn.iconNode,"cursor",a),this.EndBtn.set("disabled",o),x.set(this.EndBtn.iconNode,"cursor",l)},_populateValues:function(){var e,t=[];R.forEach(this.values,function(e){t.push({id:e,label:e})},this),e=new r({data:t}),this.numSelect=new C({store:e,id:this.prefix+this.dimension+"Value",value:this.displayNum,labelAttr:"label",labelType:"text",searchAttr:"label",pageSize:this.pageCount,scrollOnFocus:!0,style:"width:95px;","class":"dijitSelect esriMultidimensionalFilterVariableList",maxHeight:-1},this.NumberSelector),this.numSelect.startup(),this.numSelect.on("change",i.hitch(this,this._numValueChange))},_snapToClosest:function(e){var i,t,s,n;for(i=Math.abs(e-this.values[0]),s=this.values[0],n=1;n<this.values.length;n++)t=Math.abs(e-this.values[n]),i>t&&(i=t,s=this.values[n],this._currentIndex=n);return s},_numValueChange:function(e){var i;e&&(i=this._snapToClosest(e),this.numSelect.set("_onChangeActive",!1),this.numSelect.set("value",i),this.numSelect.set("_onChangeActive",!0),e!=i&&(this.numSelect.focus(),this.numSelect.set("message",this._i18n.widgets.multidimensionalFilter.numSnapText)),this._currentIndex=R.indexOf(this.values,i),this._checkButtons())},_updateValues:function(){this.numSelect.set("value",this.values[this._currentIndex]),this._checkButtons()},_onStartBtnClick:function(){this._currentIndex=0,this._updateValues()},_onPreviousBtnClick:function(){this._currentIndex--,this._updateValues()},_onNextBtnClick:function(){this._currentIndex++,this._updateValues()},_onEndBtnClick:function(){this._currentIndex=this.values.length-1,this._updateValues()}}),A=e("DateItem",[m,c,f],{dimension:"",fromText:"",toText:"",fromDateValue:"",toDateValue:"",valueCount:"",values:[],dimensionAlias:"",unit:"",dateStore:{},disabled:!1,intervalInfo:{},templateString:o,constructor:function(i){e.safeMixin(this,i),this._i18n=s,this.fromText=this._i18n.widgets.multidimensionalFilter.fromTimeText,this.toText=this._i18n.widgets.multidimensionalFilter.toTimeText},_onRangeCheckboxChange:function(e){if(this.hasRanges)if(e)y.remove(this.minBox.hasRangesSliceConnector,"esriConnectorLine"),y.remove(this.hasRangesInfo,"esriMultidimensionalFilterInfoVisible"),y.add(this.hasRangesInfo,"esriMultidimensionalFilterInfoHidden"),this.minBox.set({displayDate:i,values:this._distinctRangeValues}),this.maxBox.set({displayDate:this._distinctRangeValues[this._distinctRangeValues.length-1],values:this._distinctRangeValues});else{var i=this.minBox.dateSelect.value;y.add(this.minBox.hasRangesSliceConnector,"esriConnectorLine"),y.remove(this.hasRangesInfo,"esriMultidimensionalFilterInfoHidden"),y.add(this.hasRangesInfo,"esriMultidimensionalFilterInfoVisible"),R.indexOf(this._rangeStartArray,i)>-1&&(this.minBox.set({displayDate:i,values:this._rangeStartArray}),this.maxBox.set({displayDate:this._rangeEndArrayMap[i][0],values:this._rangeEndArrayMap[i]}))}else e?(x.set(this[this.dimension+"MaxRow"],"display","table-row"),S.set(w.byId("min"+this.dimension+"DateText"),this._i18n.widgets.multidimensionalFilter.fromTimeText)):(x.set(this[this.dimension+"MaxRow"],"display","none"),S.set(w.byId("min"+this.dimension+"DateText"),this._i18n.widgets.multidimensionalFilter.sliceTimeText))},_onDimensionCheckboxChange:function(e){this.hasRanges?e?(x.set(this[this.dimension+"MaxRow"],"display","table-row"),x.set(this[this.dimension+"MinRow"],"display","table-row"),x.set(this[this.dimension+"RangeSpan"],"display","inline")):(x.set(this[this.dimension+"MaxRow"],"display","none"),x.set(this[this.dimension+"MinRow"],"display","none"),x.set(this[this.dimension+"RangeSpan"],"display","none")):e?(p.byId(this.dimension+"RangeCheckbox").get("checked")?x.set(this[this.dimension+"MaxRow"],"display","table-row"):x.set(this[this.dimension+"MaxRow"],"display","none"),x.set(this[this.dimension+"MinRow"],"display","table-row"),x.set(this[this.dimension+"RangeSpan"],"display","inline")):(x.set(this[this.dimension+"MaxRow"],"display","none"),x.set(this[this.dimension+"MinRow"],"display","none"),x.set(this[this.dimension+"RangeSpan"],"display","none"))},_setUnitAttr:function(e){e&&(e.indexOf("ISO8601")>-1&&(this.unit=e.replace("ISO8601","UTC")),S.set(this.dimensionUnit,"("+this.unit+")"),S.set(this.tooltipUnit,"<br/>   <span class='tooltipLeftText'>Unit:</span> "+this.unit))},_setDisabledAttr:function(e){var i="#969696",t="#000000";e?(p.byId(this.dimension).set("checked",!1),p.byId(this.dimension).set("disabled",!0),x.set(this.dimensionAlias,"color",i),x.set(this.dimensionUnit,"color",i),S.set(this.disabledDimText,"<br/>"+this._i18n.widgets.multidimensionalFilter.disabledTimeDimensionText)):(p.byId(this.dimension).set("checked",!0),p.byId(this.dimension).set("disabled",!1),x.set(this.dimensionAlias,"color",t),x.set(this.dimensionUnit,"color",t),S.set(this.disabledDimText,""))},_updateTooltip:function(){var e="MM/dd/yyyy",i="hh:mm:ss a";this.hasRanges?(this.fromValue=v.format(this._getUTCTime(new Date(this._distinctRangeValues[0])),{datePattern:e,timePattern:i}),this.toValue=v.format(this._getUTCTime(new Date(this._distinctRangeValues[this._distinctRangeValues.length-1])),{datePattern:e,timePattern:i}),this.valueCount=this.values.length):(this.fromValue=v.format(this._getUTCTime(new Date(this.values[0])),{datePattern:e,timePattern:i}),this.toValue=v.format(this._getUTCTime(new Date(this.values[this.values.length-1])),{datePattern:e,timePattern:i}),this.valueCount=this.values.length),S.set(this.tooltipFromValue,this.fromValue.toString()),S.set(this.tooltipToValue,this.toValue.toString()),S.set(this.tooltipValueCount,this.valueCount.toString())},_createNewValues:function(){var e=[],i=[],t={};R.forEach(this.values,function(s){-1===R.indexOf(e,s[0])&&e.push(s[0]),-1===R.indexOf(e,s[1])&&e.push(s[1]),-1===R.indexOf(i,s[0])?(i.push(s[0]),t[s[0]]=[],t[s[0]].push(s[1])):t[s[0]].push(s[1])},this),e.sort(function(e,i){return e-i}),this._distinctRangeValues=e,this._rangeStartArray=i,this._rangeEndArrayMap=t},_refreshMaxBox:function(e){p.byId(this.dimension+"RangeCheckbox").get("checked")||this.maxBox.set({displayDate:this._rangeEndArrayMap[e][0],values:this._rangeEndArrayMap[e]})},_setValuesAttr:function(e){this._set("values",e),this.hasRanges?(this._createNewValues(),e=this._distinctRangeValues,this._updateTooltip(),this.values=this._distinctRangeValues,this.minBox=new B({values:this._rangeStartArray,id:"min"+this.dimension+"DateTimeBox",dimension:this.dimension,prefix:"min",displayDate:this._rangeStartArray[0],intervalInfo:this.intervalInfo},this.minDateSelector),this.minBox.startup(),this.minBox.dateSelect.on("change",i.hitch(this,this._refreshMaxBox)),this.maxBox=new B({values:this._rangeEndArrayMap[this._rangeStartArray[0]],id:"max"+this.dimension+"DateTimeBox",dimension:this.dimension,prefix:"max",displayDate:this._rangeEndArrayMap[this._rangeStartArray[0]][this._rangeEndArrayMap[this._rangeStartArray[0]].length-1],intervalInfo:this.intervalInfo},this.maxDateSelector),this.maxBox.startup(),S.set(this["min"+this.dimension+"DateText"],this._i18n.widgets.multidimensionalFilter.fromTimeText),x.set(this[this.dimension+"MaxRow"],"display","table-row"),y.add(this.minBox.hasRangesSliceConnector,"esriConnectorLine"),x.set(this.hasRangesInfo,"visibility","visible")):(this._updateTooltip(),this.minBox=new B({values:e,id:"min"+this.dimension+"DateTimeBox",dimension:this.dimension,prefix:"min",displayDate:e[0],intervalInfo:this.intervalInfo},this.minDateSelector),this.minBox.startup(),this.maxBox=new B({values:e,id:"max"+this.dimension+"DateTimeBox",dimension:this.dimension,prefix:"max",displayDate:e[e.length-1],intervalInfo:this.intervalInfo},this.maxDateSelector),this.maxBox.startup())},_getUTCTime:function(e){return e&&e.setTime(e.getTime()+60*e.getTimezoneOffset()*1e3),e}}),O=e("NumericItem",[m,c,f],{dimension:"",fromText:"",toText:"",valueCount:"",values:[],dimensionAlias:"",unit:"",disabled:!1,intervalInfo:{},templateString:a,constructor:function(i){e.safeMixin(this,i),this._i18n=s,this.fromText=this._i18n.widgets.multidimensionalFilter.fromNumericText,this.toText=this._i18n.widgets.multidimensionalFilter.toNumericText},_onRangeCheckboxChange:function(e){if(this.hasRanges){var i=this.minBox.numSelect.value;e?(y.remove(this.minBox.hasRangesSliceConnector,"esriConnectorLine"),x.set(this.hasRangesInfo,"visibility","hidden"),this.minBox.set({displayNum:i,values:this._distinctRangeValues}),this.maxBox.set({displayNum:this._distinctRangeValues[this._distinctRangeValues.length-1],values:this._distinctRangeValues})):(y.add(this.minBox.hasRangesSliceConnector,"esriConnectorLine"),x.set(this.hasRangesInfo,"visibility","visible"),R.indexOf(this._rangeStartArray,i)>-1&&(this.minBox.set({displayNum:i,values:this._rangeStartArray}),this.maxBox.set({displayNum:this._rangeEndArrayMap[i][0],values:this._rangeEndArrayMap[i]})))}else e?(x.set(this[this.dimension+"MaxRow"],"display","table-row"),S.set(w.byId("min"+this.dimension+"ValueText"),this._i18n.widgets.multidimensionalFilter.fromNumericText)):(x.set(this[this.dimension+"MaxRow"],"display","none"),S.set(w.byId("min"+this.dimension+"ValueText"),this._i18n.widgets.multidimensionalFilter.sliceNumberText))},_onDimensionCheckboxChange:function(e){this.hasRanges?e?(x.set(this[this.dimension+"MaxRow"],"display","table-row"),x.set(this[this.dimension+"MinRow"],"display","table-row"),x.set(this[this.dimension+"RangeSpan"],"display","inline")):(x.set(this[this.dimension+"MaxRow"],"display","none"),x.set(this[this.dimension+"MinRow"],"display","none"),x.set(this[this.dimension+"RangeSpan"],"display","none")):e?(p.byId(this.dimension+"RangeCheckbox").get("checked")?x.set(this[this.dimension+"MaxRow"],"display","table-row"):x.set(this[this.dimension+"MaxRow"],"display","none"),x.set(this[this.dimension+"MinRow"],"display","table-row"),x.set(this[this.dimension+"RangeSpan"],"display","inline")):(x.set(this[this.dimension+"MaxRow"],"display","none"),x.set(this[this.dimension+"MinRow"],"display","none"),x.set(this[this.dimension+"RangeSpan"],"display","none"))},_updateTooltip:function(){this.hasRanges?(this.fromValue=this._distinctRangeValues[0],this.toValue=this._distinctRangeValues[this._distinctRangeValues.length-1],this.valueCount=this.values.length):(this.fromValue=this.values[0],this.toValue=this.values[this.values.length-1],this.valueCount=this.values.length),S.set(this.tooltipFromValue,this.fromValue.toString()),S.set(this.tooltipToValue,this.toValue.toString()),S.set(this.tooltipValueCount,this.valueCount.toString())},_setDisabledAttr:function(e){e?(p.byId(this.dimension).set("checked",!1),p.byId(this.dimension).set("disabled",!0),x.set(this.dimensionAlias,"color","#969696"),x.set(this.dimensionUnit,"color","#969696"),S.set(this.disabledDimText,"<br/>"+this._i18n.widgets.multidimensionalFilter.disabledNumericDimensionText)):(p.byId(this.dimension).set("checked",!0),p.byId(this.dimension).set("disabled",!1),x.set(this.dimensionAlias,"color","#000000"),x.set(this.dimensionUnit,"color","#000000"),S.set(this.disabledDimText,""))},_createNewValues:function(){var e,i=[],t=[],s={};for(e in this.values)-1==R.indexOf(i,this.values[e][0])&&i.push(this.values[e][0]),-1==R.indexOf(i,this.values[e][1])&&i.push(this.values[e][1]),-1==R.indexOf(t,this.values[e][0])?(t.push(this.values[e][0]),s[this.values[e][0]]=[],s[this.values[e][0]].push(this.values[e][1])):s[this.values[e][0]].push(this.values[e][1]);i.sort(function(e,i){return e-i}),this._distinctRangeValues=i,this._rangeStartArray=t,this._rangeEndArrayMap=s},_refreshMaxBox:function(e){p.byId(this.dimension+"RangeCheckbox").get("checked")||this.maxBox.set({displayNum:this._rangeEndArrayMap[e][0],values:this._rangeEndArrayMap[e]})},_setValuesAttr:function(e){this._set("values",e),this.hasRanges?(this._createNewValues(),e=this._distinctRangeValues,this._updateTooltip(),this.values=this._distinctRangeValues,this.minBox=new N({values:this._rangeStartArray,id:"min"+this.dimension+"NumberBox",dimension:this.dimension,prefix:"min",displayNum:this._rangeStartArray[0],intervalInfo:this.intervalInfo},this.minNumberSelector),this.minBox.startup(),this.minBox.numSelect.on("change",i.hitch(this,this._refreshMaxBox)),this.maxBox=new N({values:this._rangeEndArrayMap[this._rangeStartArray[0]],id:"max"+this.dimension+"NumberBox",dimension:this.dimension,prefix:"max",displayNum:this._rangeEndArrayMap[this._rangeStartArray[0]][this._rangeEndArrayMap[this._rangeStartArray[0]].length-1],intervalInfo:this.intervalInfo},this.maxNumberSelector),this.maxBox.startup(),S.set(this["min"+this.dimension+"ValueText"],this._i18n.widgets.multidimensionalFilter.fromNumericText),x.set(this[this.dimension+"MaxRow"],"display","table-row"),y.add(this.minBox.hasRangesSliceConnector,"esriConnectorLine"),x.set(this.hasRangesInfo,"visibility","visible")):(this._updateTooltip(),this.minBox=new N({values:e,id:"min"+this.dimension+"NumberBox",dimension:this.dimension,prefix:"min",displayNum:e[0],intervalInfo:this.intervalInfo},this.minNumberSelector),this.minBox.startup(),this.maxBox=new N({values:e,id:"max"+this.dimension+"NumberBox",dimension:this.dimension,prefix:"max",displayNum:e[e.length-1],intervalInfo:this.intervalInfo},this.maxNumberSelector),this.maxBox.startup())},_setUnitAttr:function(e){e&&(e.indexOf("esri")>-1&&(this.unit=e.replace("esri","")),S.set(this.dimensionUnit,"("+this.unit+")"),S.set(this.tooltipUnit,"<br/>   <span class='tooltipLeftText'>Unit:</span> "+this.unit))}}),P=e([m,c,f],{declaredClass:"esri.dijit.MultidimensionalFilter",templateString:n,widgetsInTemplate:!0,layer:null,map:null,hideApplyButton:!1,_multidimensionalInfo:null,_variableStore:null,_variableData:[],_dimensionStore:null,_savedMultidimensionalDefinition:null,_dimensionWithRanges:[],reset:0,constructor:function(i){e.safeMixin(this,i),this._i18n=s},startup:function(){this.inherited(arguments),t.subscribe("onMultidimensionalFilterApply",i.hitch(this,"_onClickApplyMultidimensionalFilter")),t.subscribe("onMultidimensionalFilterReset",i.hitch(this,"_onClickResetMultidimensionalFilter"))},postCreate:function(){t.connect(this.variableList,"onChange",i.hitch(this,"_onVariableListChange")),this.hideApplyButton&&x.set(this.applyButton.domNode,"display","none")},destroy:function(){this.inherited(arguments)},_setLayerAttr:function(e){if(e){this.inherited(arguments),this._cachedDimensions=null,this._dimensionStore=null,this.layer=e;var s=i.hitch(this,"_setupDefaults");this.layer.loaded?this._setupDefaults():t.connect(this.layer,"onLoad",s)}},_setupDefaults:function(){this.layer.getMultidimensionalInfo().then(i.hitch(this,function(e){this._multidimensionalInfo=e,this._setupVariableFilterDefaults()}),function(){}),this.layer.getDefaultMultidimensionalDefinition().then(i.hitch(this,function(e){this.defaultMultidimensionalDefinition=e}),function(e){console.log(e)})},_computeDimensionUnion:function(e){var i,t,s,n,a,o,l,h,r,d=[],u=[],m=[];if(e){for(i in e)if(e.hasOwnProperty(i)){a=e[i].dimensions;for(t in a)if(a.hasOwnProperty(t)){o=a[t],l=0;for(s in d)if(d.hasOwnProperty(s)&&o.name==d[s].name){if(h=d[s].values,r=o.values,o.hasRanges){for(n in h)h.hasOwnProperty(n)&&(u.push(h[n][0]),m.push(h[n][1]));for(n in r)r.hasOwnProperty(n)&&(-1==R.indexOf(u,r[n][0])||-1==R.indexOf(m,r[n][1]))&&h.push(r[n])}else for(n in r)r.hasOwnProperty(n)&&-1==R.indexOf(h,r[n])&&h.push(r[n]);l=1}l||d.push(o),o.hasRanges&&-1==R.indexOf(this._dimensionWithRanges,o.name)&&this._dimensionWithRanges.push(o.name)}}return d=this._sortDimensionValues(d)}},_sortDimensionValues:function(e){return R.forEach(e,function(e){e&&e.values&&(e.values=e.hasRanges?this._sortRangeDimensionValues(e.values):this._sortNoRangeDimensionValues(e.values))},this),e},_sortRangeDimensionValues:function(e){var i,t=[],s=[],n={},a={},o=[];return R.forEach(e,function(e){-1==R.indexOf(t,e[0])?(t.push(e[0]),n[e[0]]=[],n[e[0]].push(e)):n[e[0]].push(e)},this),t=t.sort(function(e,i){return e-i}),R.forEach(t,function(e){if(1==n[e].length)o.push(n[e][0]);else{for(s=[],a={},i=0;i<n[e].length;i++)s.push(n[e][i][1]),a[n[e][i][1]]=n[e][i];for(s=s.sort(function(e,i){return e-i}),i=0;i<s.length;i++)o.push(a[s[i]])}}),o},_sortNoRangeDimensionValues:function(e){return e.sort(function(e,i){return e-i})},_setupVariableFilterDefaults:function(){if(this.layer&&this._multidimensionalInfo&&this._multidimensionalInfo.variables){var e,i=this._multidimensionalInfo.variables;this._variableData=[],this._variableData.push({name:this._i18n.widgets.multidimensionalFilter.defaultVariableText,label:"<html><body><section><table><tr><td><b>"+this._i18n.widgets.multidimensionalFilter.defaultVariableText+"</b></td></tr><tr><td><p style='white-space:pre-wrap;width:50ex'><i>No user-defined restriction on Variable.</i></p></td></tr></table></section></body></html",dimensions:this._computeDimensionUnion(i)}),R.forEach(i,function(t,s){e=t.unit?t.name+" ("+t.unit+")":t.name,this._variableData.push({name:t.name,dimensions:t.dimensions,description:t.description,label:"<html><body><section><table><tr><td><b>"+e+"</b></td></tr><tr><td><p style='white-space:pre-wrap;width:50ex'><i>"+i[s].description+"</i></p></td></tr></table></section></body></html>"})},this),this._variableStore=new r({data:this._variableData,idProperty:"name"}),this.variableList.reset(),this.variableList.set({store:this._variableStore,labelAttr:"label",labelType:"html",value:this._variableData[0].name}),this._savedMultidimensionalDefinition=null,this.layer.mosaicRule&&this.layer.mosaicRule.multidimensionalDefinition&&this.layer.mosaicRule.multidimensionalDefinition.length>0&&(this._savedMultidimensionalDefinition=this.layer.mosaicRule.multidimensionalDefinition,this._setVariableValueDefault())}},_setVariableValueDefault:function(){if(this._savedMultidimensionalDefinition[0].variableName){var e=""==this._savedMultidimensionalDefinition[0].variableName?this._i18n.widgets.multidimensionalFilter.defaultVariableText:this._savedMultidimensionalDefinition[0].variableName;this.variableList&&this.reset&&1==this.reset?e!=this.variableList.get("value")?this.variableList.set("value",e):this._onVariableListChange():this.variableList.set("value",e)}},_setCachedDimensionProperties:function(){var e,i;for(e in this._cachedDimensions)this._cachedDimensions.hasOwnProperty(e)&&(i=e,p.byId(i)&&(this._cachedDimensions[e].selected=p.byId(i).get("checked"),this._cachedDimensions[e].isSlice=!p.byId(i+"RangeCheckbox").get("checked"),this._cachedDimensions[e].values=i.toLowerCase().indexOf("time")>-1?[Number(p.byId("min"+i+"Time").get("value")),Number(p.byId("max"+i+"Time").get("value"))]:[Number(p.byId("min"+i+"Value").get("value")),Number(p.byId("max"+i+"Value").get("value"))]))},_onVariableListChange:function(){var e,i,t=this.variableList.get("value"),s=this._variableStore.query({name:t})[0],n=s.dimensions;if(!this._cachedDimensions&&this._dimensionStore){this._cachedDimensions={};for(e in this._variableData[0].dimensions)this._variableData[0].dimensions.hasOwnProperty(e)&&(this._cachedDimensions[this._variableData[0].dimensions[e].field]={})}this._cachedDimensions&&this._setCachedDimensionProperties(),this._dimensionStore=null,this._dimensionStore=new r({data:n,idProperty:"name"}),this._createDimensionWidgets(),this._cachedDimensions?this._displayCachedProperties():this._savedMultidimensionalDefinition&&this._savedMultidimensionalDefinition.length>0&&(i=""==this._savedMultidimensionalDefinition[0].variableName?this._i18n.widgets.multidimensionalFilter.defaultVariableText:this._savedMultidimensionalDefinition[0].variableName,t==i&&this._setDimensionDefaults())},_createDimensionWidgets:function(){var e,i,t,s,n,a,o;this._destroyDimensionWidgets();for(e in this._dimensionStore.data)this._dimensionStore.data.hasOwnProperty(e)&&(i=this._dimensionStore.data[e].field,n={hasRegularIntervals:this._dimensionStore.data[e].hasRegularIntervals,interval:this._dimensionStore.data[e].interval,intervalUnit:this._dimensionStore.data[e].intervalUnit},o=this._dimensionStore.data[e].hasRanges&&1==this._dimensionStore.data[e].hasRanges?!0:!1,"StdTime"==i?(t=new A({dimension:this._dimensionStore.data[e].name,hasRanges:o,dimensionAlias:this._returnFieldAlias(this._dimensionStore.data[e].name),unit:this._dimensionStore.data[e].unit,disabled:this.layer.useMapTime,intervalInfo:n,values:this._dimensionStore.data[e].values}),t.placeAt(this.dimensionFilterGrid)):"StdTime"!=i&&(a=this._isActiveDimension(this._dimensionStore.data[e].name),s=new O({dimension:this._dimensionStore.data[e].name,hasRanges:o,dimensionAlias:this._returnFieldAlias(this._dimensionStore.data[e].name),unit:this._dimensionStore.data[e].unit,disabled:a,intervalInfo:n,values:this._dimensionStore.data[e].values}),s.placeAt(this.dimensionFilterGrid)))},_getUTCTime:function(e){return e&&e.setTime(e.getTime()+60*e.getTimezoneOffset()*1e3),e},_destroyDimensionWidgets:function(){var e,i=p.findWidgets(this.dimensionFilterGrid);for(e in i)i.hasOwnProperty(e)&&i[e].destroyRecursive()},_displayCachedProperties:function(){var e,i,t,s,n,a,o,l=this._cachedDimensions;for(e in this._dimensionStore.data)if(this._dimensionStore.data.hasOwnProperty(e)){i=0;for(t in l)if(l.hasOwnProperty(t)&&t==this._dimensionStore.data[e].name&&l[t].values){i=1,s=t,n=l[t].isSlice,a=l[t].values,o=l[t].selected;break}i?s.toLowerCase().indexOf("time")>-1&&!this.layer.useMapTime?this._updateTimeDimensionValues(s,o,n,a[0],a[1]):-1!=s.toLowerCase().indexOf("time")||this._isActiveDimension(s)||this._updateNumericDimensionValues(s,o,n,a[0],a[1]):(s=this._dimensionStore.data[e].name,(-1==s.toLowerCase().indexOf("time")&&!this._isActiveDimension(s)||s.toLowerCase().indexOf("time")>-1&&!this.layer.useMapTime)&&(s.toLowerCase().indexOf("time")>-1?this._updateTimeDimensionValues(s,!1,!0,this._dimensionStore.data[e].extent[0],this._dimensionStore.data[e].extent[1]):this._updateNumericDimensionValues(s,!1,!0,this._dimensionStore.data[e].extent[0],this._dimensionStore.data[e].extent[1])))}},_isActiveDimension:function(e){return this.layer.activeMapDimensions&&this.layer.activeMapDimensions.length>0&&R.indexOf(this.layer.activeMapDimensions,e)>-1},_setDimensionDefaults:function(){var e,i,t,s,n,a,o,l=this._savedMultidimensionalDefinition,h=0;for(e in this._dimensionStore.data)if(this._dimensionStore.data.hasOwnProperty(e)){i=0,o=this._dimensionStore.data[e].values;for(t in l)if(l.hasOwnProperty(t)&&l[t].dimensionName==this._dimensionStore.data[e].name){i=1,s=l[t].dimensionName,n=l[t].isSlice,a=l[t].values[1]?l[t].values:l[t].values[0],a.length||(a=[a]),(-1==R.indexOf(o,a[0])||2==a.length&&-1==R.indexOf(o,a[1]))&&(h=1);break}i?s.toLowerCase().indexOf("time")>-1&&!this.layer.useMapTime?n?this._updateTimeDimensionValues(s,!0,n,a[0],this._dimensionStore.data[e].extent[1]):this._updateTimeDimensionValues(s,!0,n,a[0],a[1]):-1!=s.toLowerCase().indexOf("time")||this._isActiveDimension(s)||(n?this._updateNumericDimensionValues(s,!0,n,a[0],this._dimensionStore.data[e].extent[1]):this._updateNumericDimensionValues(s,!0,n,a[0],a[1])):(s=this._dimensionStore.data[e].name,(-1==s.toLowerCase().indexOf("time")&&!this._isActiveDimension(s)||s.toLowerCase().indexOf("time")>-1&&!this.layer.useMapTime)&&(s.toLowerCase().indexOf("time")>-1?this._updateTimeDimensionValues(s,!1,!0,this._dimensionStore.data[e].extent[0],this._dimensionStore.data[e].extent[1]):this._updateNumericDimensionValues(s,!1,!0,this._dimensionStore.data[e].extent[0],this._dimensionStore.data[e].extent[1])))
}h&&this._onClickApplyMultidimensionalFilter(),this.reset=0},_updateTimeDimensionValues:function(e,i,t,s,n){p.byId("min"+e+"DateTimeBox").set("dateValue",s),p.byId("max"+e+"DateTimeBox").set("dateValue",n),p.byId(e+"RangeCheckbox").set("value",!t),p.byId(e).set("checked",i)},_updateNumericDimensionValues:function(e,i,t,s,n){p.byId("min"+e+"NumberBox").set("numValue",s),p.byId("max"+e+"NumberBox").set("numValue",n),p.byId(e+"RangeCheckbox").set("value",!t),p.byId(e).set("checked",i)},_returnFieldAlias:function(e){var i,t=this.layer.fields;for(i in t)if(t.hasOwnProperty(i)&&t[i].name.toLowerCase()==e.toLowerCase())return t[i].alias},_onClickApplyMultidimensionalFilter:function(){var e,i,t,s,n,a,o,l,h,r,d=g("input[name=dimensionCheckbox]:checked"),u=[];for(e=0;e<d.length;e++)u.push(d[e].id);i=[],t=p.byId("variableList").get("value")==this._i18n.widgets.multidimensionalFilter.defaultVariableText?"":p.byId("variableList").get("value");for(s in u)u.hasOwnProperty(s)&&(n=u[s],p.byId(n+"RangeCheckbox").get("value")?n.toLowerCase().indexOf("time")>-1?(a=p.byId("min"+n+"Time").get("value"),o=p.byId("max"+n+"Time").get("value"),l=[[Number(a),Number(o)]]):l=[[Number(p.byId("min"+n+"Value").get("value")),Number(p.byId("max"+n+"Value").get("value"))]]:R.indexOf(this._dimensionWithRanges,n)>-1?n.toLowerCase().indexOf("time")>-1?(a=p.byId("min"+n+"Time").get("value"),o=p.byId("max"+n+"Time").get("value"),l=[[Number(a),Number(o)]]):l=[[Number(p.byId("min"+n+"Value").get("value")),Number(p.byId("max"+n+"Value").get("value"))]]:n.toLowerCase().indexOf("time")>-1?(h=p.byId("min"+n+"Time").get("value"),l=[Number(h)]):l=[Number(p.byId("min"+n+"Value").get("value"))],(-1==n.toLowerCase().indexOf("time")&&!this._isActiveDimension(n)||n.toLowerCase().indexOf("time")>-1&&!this.layer.useMapTime)&&i.push(new b({variableName:t,dimensionName:n,isSlice:!p.byId(n+"RangeCheckbox").get("value"),values:l})));if(this.layer.mosaicRule&&this.layer.mosaicRule.multidimensionalDefinition)for(s in this.layer.mosaicRule.multidimensionalDefinition)this.layer.mosaicRule.multidimensionalDefinition.hasOwnProperty(s)&&(n=this.layer.mosaicRule.multidimensionalDefinition[s].dimensionName,-1==n.toLowerCase().indexOf("time")&&this._isActiveDimension(n)&&i.push(this.layer.mosaicRule.multidimensionalDefinition[s]));this.layer.mosaicRule?(r=this.layer.mosaicRule,r.multidimensionalDefinition=i):this.layer.defaultMosaicRule?(r=this.layer.defaultMosaicRule,r.multidimensionalDefinition=i):r=new D({multidimensionalDefinition:[]}),this.layer.setMosaicRule(r)},_onClickResetMultidimensionalFilter:function(){var e,i,t,s=[];if(this.defaultMultidimensionalDefinition&&0==this.reset){this.reset=1,this._cachedDimensions=null;for(e in this.defaultMultidimensionalDefinition)this.defaultMultidimensionalDefinition.hasOwnProperty(e)&&(i=this.defaultMultidimensionalDefinition[e].dimensionName,(-1==i.toLowerCase().indexOf("time")&&!this._isActiveDimension(i)||i.toLowerCase().indexOf("time")>-1&&!this.layer.useMapTime)&&s.push(this.defaultMultidimensionalDefinition[e]));if(this.layer.mosaicRule&&this.layer.mosaicRule.multidimensionalDefinition)for(e in this.layer.mosaicRule.multidimensionalDefinition)this.layer.mosaicRule.multidimensionalDefinition.hasOwnProperty(e)&&(i=this.layer.mosaicRule.multidimensionalDefinition[e].dimensionName,-1==i.toLowerCase().indexOf("time")&&this._isActiveDimension(i)&&s.push(this.layer.mosaicRule.multidimensionalDefinition[e]));0==s.length&&(s=this.defaultMultidimensionalDefinition),this.layer.mosaicRule?(t=this.layer.mosaicRule,t.multidimensionalDefinition=s):this.layer.defaultMosaicRule?(t=this.layer.defaultMosaicRule,t.multidimensionalDefinition=s):t=new D({multidimensionalDefinition:[]}),this.layer.setMosaicRule(t),this._savedMultidimensionalDefinition=s,this._savedMultidimensionalDefinition&&(this._dimensionStore=null,this._setVariableValueDefault())}}});return d("extend-esri")&&i.setObject("dijit.MultidimensionalFilter",P,u),P});