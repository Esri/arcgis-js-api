// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/kernel","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/html","dojo/Evented","dojo/string","dojo/dom","dojo/has","dojo/topic","dojo/query","dojo/aspect","dojo/_base/json","dojo/Deferred","dojo/dom-class","dojo/dom-style","dijit/registry","dijit/TooltipDialog","dijit/Tooltip","dojo/store/Memory","../layers/ArcGISImageServiceLayer","../layers/ArcGISImageServiceVectorLayer","../layers/ArcGISDynamicMapServiceLayer","../layers/ArcGISTiledMapServiceLayer","../support/expressionUtils","../lang","../symbols/jsonUtils","../geometry/Point","../geometry/Polyline","../geometry/Polygon","../SpatialReference","../tasks/QueryTask","../tasks/query","dojo/i18n!../nls/jsapi","dijit/_Widget","dijit/_Templated","dojo/text!./templates/ExpressionEditor.html"],(function(e,i,t,s,r,a,n,o,l,p,u,h,y,d,c,m,f,g,x,v,T,b,E,L,I,R,F,_,k,j,w,S,O,C,V,q,D,P){var M=e([q,D],{declaredClass:"esri.dijit.ExpressionEditor",basePath:require.toUrl("."),baseClass:"esriAGOExpressionEditor",widgetsInTemplate:!0,templateString:P,i18n:null,constructor:function(e,i){e&&(t.mixin(this,e),this.defaultExpressionScript=this.defaultExpressionScript||"")},destroy:function(){clearInterval(this.editorFrameListener),window.removeEventListener("message",this.receiveMessageHitch),this.inherited(arguments)},postMixInProperties:function(){this.inherited(arguments),this.i18n=t.clone(V.common),t.mixin(this.i18n,V.rendererCommon)},postCreate:function(){},_onClose:function(e){e.preventDefault(),r.publish("expression-cancel")},startup:function(){this.inherited(arguments),this._init()},_init:function(){var e=0;this.editorFrameLoaded=!1,this.editorUrl=this.arcadeEditor+"?locale="+i.locale,this._expressionEditor.onload=t.hitch(this,(function(){f.set(this._expressionEditorLoading,"display","none"),f.set(this._expressionEditor,"visibility","visible")})),this._expressionEditor.src=this.editorUrl,this.receiveMessageHitch=t.hitch(this,"receiveMessage"),window.addEventListener("message",this.receiveMessageHitch,!1),this.editorFrameListener=setInterval(t.hitch(this,(function(){this.editorFrameLoaded?(clearInterval(this.editorFrameListener),this.editorFrameListener=null):this.sendPostMessage({type:"isLoaded"}),++e>60&&r.publish("expression-cancel")})),500)},sendPostMessage:function(e){this._expressionEditor&&this._expressionEditor.contentWindow&&this._expressionEditor.contentWindow.postMessage(d.toJson(e),this.editorUrl)},receiveMessage:function(e){if(-1!==this.editorUrl.indexOf(e.origin)){var t="string"==typeof e.data?d.fromJson(e.data):e.data;switch(t.type){case"loaded":if(this.editorFrameLoaded=t.value,this.editorFrameLoaded){var s=this.layer instanceof b,a=this.layer instanceof E,n=this.mapLayer.layer instanceof L,o="esri.layers.ArcGISTiledMapServiceLayer"===this.mapLayer.layer.declaredClass;if(s||a){if(!this.mapLayer._queryResponse){var l=new O(this.layer.url),p=new C;return p.where="1=1",p.num=1,p.outFields=["*"],p.outSpatialReference=this.map.spatialReference,void l.execute(p,i.hitch(this,(function(i){this.mapLayer._queryResponse=i,this.receiveMessage(e)})),i.hitch(this,(function(){this.mapLayer._queryResponse={},this.receiveMessage(e)})))}}else if((n||o)&&this.layer.url&&(this.mapLayer._queryResponse=this.mapLayer._queryResponse||[],!this.mapLayer._queryResponse[this.layer.url]))return l=new O(this.layer.url),(p=new C).where="1=1",p.num=1,p.outFields=["*"],p.outSpatialReference=this.map.spatialReference,void l.execute(p,i.hitch(this,(function(i){this.mapLayer._queryResponse[this.layer.url]=i,this.receiveMessage(e)})),i.hitch(this,(function(){this.mapLayer._queryResponse[this.layer.url]={},this.receiveMessage(e)})));var u={type:"initializeDialog",title:this.expressionTitle?this.expressionTitle:this.i18n.custom,captureTitle:!F.isDefined(this.captureTitle)||this.captureTitle,predictOutputType:!0,script:this.expression?this.expression:this.defaultExpressionScript,profile:this.arcadeProfile?this.arcadeProfile:this.makeCurrentProfile(),existing:this.makeExistingList(),spatialReference:this.map.spatialReference.toJson(),includeGeometryWarning:!1};this.arcadeProfileType?(u.profileName=this.arcadeProfileType,"geoanalyticstrack"===this.arcadeProfileType&&u.profile[0].value&&(u.trackData={layer:u.profile[0].value.layer,track:[{attributes:u.profile[0].value.attributes&&u.profile[0].value.attributes,geometry:u.profile[0].value.geometry&&u.profile[0].value.geometry}],trackstarttime:(new Date).getTime(),trackindex:1,trackduration:10,trackcurrenttime:(new Date).getTime()})):this.arcadeProfileType&&"geoanalyticstrack"===this.arcadeProfileType||(u.bannedFunctions=["TrackCurrentTime","TrackDuration","TrackFieldWindow","TrackGeometryWindow","TrackIndex","TrackStartTime","TrackWindow"]),this.sendPostMessage(u)}case"initFinished":this.editorFrameLoaded?console.log("editor app loaded"):console.log("editor app not loaded yet");break;case"scriptSaveAndClose":if(!t.script||t.script===this.defaultExpressionScript){r.publish("expression-cancel");break}var h=function(e){r.publish("expression-commit",[{expression:e.script,returnType:"Number"===e.predictOutputType?"esriFieldTypeDouble":"String"===e.predictOutputType?"esriFieldTypeString":"esriFieldTypeUnknown",title:e.title}])};R.hasGeometryOperations(t.script)?R.enableGeometryOperations().then((function(){h(t)})):h(t);break;case"scriptClose":r.publish("expression-cancel")}}},makeCurrentProfile:function(){var e=this.layer.fields,i=[{type:"Feature",value:{attributes:null,geometry:null,layer:{fields:s.map(e,(function(e){return e})),objectIdField:this.layer.objectIdField,typeIdField:this.layer.typeIdField,types:this.layer.types?s.map(this.layer.types,(function(e){return e.toJson?e.toJson():e})):null,templates:this.layer.templates}},id:F.isDefined(this.fieldId)?this.fieldId:"$feature"}];if(this.showViewScale&&i.push({type:"Dictionary",value:{attributes:{scale:this.map.getScale()},layer:{fields:[{name:"scale",alias:this.i18n.currentMapScale,type:"Number"}]}},id:"$view"}),this.mapLayer._queryResponse&&this.mapLayer._queryResponse.features&&this.mapLayer._queryResponse.features.length)i[0].value.attributes=t.clone(this.mapLayer._queryResponse.features[0].attributes),i[0].value.geometry=this.mapLayer._queryResponse.features[0].geometry;else if(this.mapLayer._queryResponse&&this.mapLayer._queryResponse[this.layer.url]&&this.mapLayer._queryResponse[this.layer.url].features&&this.mapLayer._queryResponse[this.layer.url].features.length)i[0].value.attributes=t.clone(this.mapLayer._queryResponse[this.layer.url].features[0].attributes),i[0].value.geometry=this.mapLayer._queryResponse[this.layer.url].features[0].geometry;else if(this.layer.graphics&&this.layer.graphics.length)i[0].value.attributes=t.clone(this.layer.graphics[0].attributes),i[0].value.geometry=this.layer.graphics[0].geometry.toJson();else{var r={};s.forEach(e,(function(e){s.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGlobalID"],e.type)>-1&&!1===e.nullable?e.defaultValue?r[e.name]=e.defaultValue:s.indexOf(["esriFieldTypeString"],e.type)>-1?r[e.name]="":r[e.name]=0:r[e.name]=null})),i[0].value.attributes=r;var a=this.map.extent;"esriGeometryPolygon"==this.layer.geometryType||this.layer.getCustomRasterFields?(i[0].value.geometry=new w(new S(this.map.spatialReference.toJson())),i[0].value.geometry.addRing([[a.xmin,a.ymin],[a.xmax,a.ymin],[a.xmax,a.ymax],[a.xmin,a.ymax],[a.xmin,a.ymin]])):"esriGeometryPoint"==this.layer.geometryType||"esriGeometryMultipoint"==this.layer.geometryType?i[0].value.geometry=new k(a.getCenter().toJson()):"esriGeometryPolyline"==this.layer.geometryType&&(i[0].value.geometry=new j(new S(this.map.spatialReference.toJson())),i[0].value.geometry.addPath([[a.xmin,a.ymin],[a.xmax,a.ymax]]))}return i},makeExistingList:function(){var e=i.hitch(this,(function(e,i,t){if(e&&(e.shortTitle!==this.expressionTitle||e.valueExpression!==this.expression)){var s={shortTitle:e.shortTitle||this.i18n.untitled,script:e.valueExpression,returnType:e.returnType};switch(t){case"color":s.title=o.substitute(this.i18n.expressionOriginColor,{title:s.shortTitle});break;case"size":s.title=o.substitute(this.i18n.expressionOriginSize,{title:s.shortTitle});break;case"type":s.title=o.substitute(this.i18n.expressionOriginColor,{title:s.shortTitle});break;case"transparency":s.title=o.substitute(this.i18n.expressionOriginTransparency,{title:s.shortTitle});break;case"rotation":s.title=o.substitute(this.i18n.expressionOriginRotation,{title:s.shortTitle});break;default:s.title=s.shortTitle}i.push(s)}})),t=[],r=this.getRendererCustomExpression(this.layer.renderer,"color");if(e(r,t,"color"),e(r=this.getRendererCustomExpression(this.layer.renderer,"size"),t,"size"),e(r=this.getRendererCustomExpression(this.layer.renderer,"type"),t,"type"),e(r=this.getRendererCustomExpression(this.layer.renderer,"transparency"),t,"transparency"),e(r=this.getRendererCustomExpression(this.layer.renderer,"rotation"),t,"rotation"),this.layer.labelingInfo||this.layer.drawingInfo&&this.layer.drawingInfo.labelingInfo){var a=this.layer.drawingInfo?this.layer.drawingInfo.labelingInfo[0]:this.layer.labelingInfo[0];a.labelExpressionInfo&&a.labelExpressionInfo.expression&&a.name&&(a.name!==this.expressionTitle||a.labelExpressionInfo.expression!==this.expression)&&t.push({shortTitle:a.name||this.i18n.untitled,title:o.substitute(this.i18n.expressionOriginLabels,{title:a.name||this.i18n.untitled}),script:a.labelExpressionInfo.expression})}var n=this.latestPopupInfo||this.mapLayer.popupInfo;if(!n&&this.mapLayer.itemLayers)for(var l=0;l<this.mapLayer.itemLayers.length;l++)if(this.mapLayer.itemLayers[l].id===this.layer.id){n=this.mapLayer.itemLayers[l].popupInfo;break}return n&&n.expressionInfos&&s.forEach(n.expressionInfos,(function(e){!e||e.title===this.expressionTitle&&e.expression===this.expression||t.push({shortTitle:e.title||this.i18n.untitled,title:o.substitute(this.i18n.expressionOriginPopup,{title:e.title||this.i18n.untitled}),script:e.expression})}),this),t},getRendererCustomExpression:function(e,i){if(!e)return null;if(e.valueExpression&&("esri.renderer.UniqueValueRenderer"==e.declaredClass||"esri.renderer.ClassBreaksRenderer"==e.declaredClass&&!this.getVisualVariableByType("colorInfo",null,e.visualVariables)&&!this.getVisualVariableByType("sizeInfo",null,e.visualVariables))&&"type"===i){var t="esriFieldTypeDouble";return"esri.renderer.UniqueValueRenderer"==e.declaredClass&&e.infos&&e.infos[0]&&"string"==typeof e.infos[0].value&&(t="esriFieldTypeString"),{valueExpression:e.valueExpression,returnType:t,shortTitle:e.valueExpressionTitle||e.legendOptions&&e.legendOptions.title}}if(e.visualVariables){var s=this.getVisualVariableByType("colorInfo",null,e.visualVariables);if(s&&s.valueExpression&&"color"===i)return{valueExpression:s.valueExpression,returnType:"esriFieldTypeDouble",shortTitle:s.valueExpressionTitle||s.legendOptions&&s.legendOptions.title};var r=this.getVisualVariableByType("sizeInfo",null,e.visualVariables);if(r&&r.valueExpression&&"size"===i)return{valueExpression:r.valueExpression,returnType:"esriFieldTypeDouble",shortTitle:r.valueExpressionTitle||r.legendOptions&&r.legendOptions.title};var a=this.getVisualVariableByType("opacityInfo",null,e.visualVariables);if(a&&a.valueExpression&&"transparency"===i)return{valueExpression:a.valueExpression,returnType:"esriFieldTypeDouble",shortTitle:a.valueExpressionTitle||a.legendOptions&&a.legendOptions.title};var n=this.getVisualVariableByType("rotationInfo",null,e.visualVariables);if(n&&n.valueExpression&&"rotation"===i)return{valueExpression:n.valueExpression,returnType:"esriFieldTypeDouble",shortTitle:n.valueExpressionTitle||n.legendOptions&&n.legendOptions.title}}return e.observationRenderer?this.getRendererCustomExpression(e.observationRenderer):e.latestObservationRenderer?this.getRendererCustomExpression(e.latestObservationRenderer):null},getVisualVariableByType:function(e,i,r){if(r){var a=s.filter(r,(function(t){return F.isDefined(i)?t.type===e&&t.target===i:t.type===e&&!t.target}));return a.length?t.clone(a[0]):null}return null}});return p("extend-esri")&&t.setObject("esri.dijit.ExpressionEditor",M),M}));