// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/kernel","dojo/sniff","dojo/query","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojox/html/entities","dijit/_Widget","dijit/_Templated","../kernel","../lang","../urlUtils","./_EventedWidget","dojo/i18n!../nls/jsapi","dojo/NodeList-dom"],(function(e,t,i,a,d,s,n,o,r,h,c,l,m,_,u,v,p,f,g,y,L){var S=0,j=L.widgets.popup,P=L.widgets.templatePicker,T=t([y,u,v],{declaredClass:"esri.dijit._PopupRenderer",constructor:function(){this._nls=a.mixin({},j)},templateString:"<div class='esriViewPopup'><div class='statusSection hidden' dojoAttachPoint='_status'></div><div class='mainSection'><div class='header' dojoAttachPoint='_title'></div><div class='hzLine'></div><div dojoAttachPoint='_description'></div><div class='break'></div></div><div class='attachmentsSection hidden'><div>${_nls.NLS_attach}:</div><ul dojoAttachPoint='_attachmentsList'></ul><div class='break'></div></div><div class='mediaSection hidden'><div class='header' dojoAttachPoint='_mediaTitle'></div><div class='hzLine'></div><div class='caption' dojoAttachPoint='_mediaCaption'></div><div class='gallery' dojoAttachPoint='_gallery'><div class='mediaHandle prev' dojoAttachPoint='_prevMedia' dojoAttachEvent='onclick: _goToPrevMedia'></div><div class='mediaHandle next' dojoAttachPoint='_nextMedia' dojoAttachEvent='onclick: _goToNextMedia'></div><ul class='summary'><li class='image mediaCount hidden' dojoAttachPoint='_imageCount'>0</li><li class='image mediaIcon hidden'></li><li class='chart mediaCount hidden' dojoAttachPoint='_chartCount'>0</li><li class='chart mediaIcon hidden'></li></ul><div class='frame' dojoAttachPoint='_mediaFrame'></div></div></div><div class='editSummarySection hidden' dojoAttachPoint='_editSummarySection'><div class='break'></div><div class='break hidden' dojoAttachPoint='_mediaBreak'></div><div class='editSummary' dojoAttachPoint='_editSummary'></div></div></div>",showTitle:!0,startup:function(){this.inherited(arguments),this._showStatus(P.loading),this._contentDfd=this.template.getComponents(this.graphic).then(a.hitch(this,this._handleComponentsSuccess)).otherwise(a.hitch(this,this._handleComponentsError))},destroy:function(){this._contentDfd&&this._contentDfd.cancel(),this._attachmentsDfd&&this._attachmentsDfd.cancel(),this._destroyFrame(),this.template=this.graphic=this._nls=this._mediaInfos=this._mediaPtr=this._contentDfd=this._attachmentsDfd=null,this.inherited(arguments)},_goToPrevMedia:function(){this._mediaPtr-1<0||(this._mediaPtr--,this._updateUI(),this._displayMedia())},_goToNextMedia:function(){this._mediaPtr+1!==this._mediaInfos.length&&(this._mediaPtr++,this._updateUI(),this._displayMedia())},_updateUI:function(){var e=this._mediaInfos,t=e.length,i=this.domNode,a=this._prevMedia,n=this._nextMedia;if(t>1){var o=0,r=0;d.forEach(e,(function(e){"image"===e.type?o++:-1!==e.type.indexOf("chart")&&r++})),o&&(h.set(this._imageCount,"innerHTML",o),s.query(".summary .image",i).removeClass("hidden")),r&&(h.set(this._chartCount,"innerHTML",r),s.query(".summary .chart",i).removeClass("hidden"))}else s.query(".summary",i).addClass("hidden"),c.add(a,"hidden"),c.add(n,"hidden");var l=this._mediaPtr;0===l?c.add(a,"hidden"):c.remove(a,"hidden"),l===t-1?c.add(n,"hidden"):c.remove(n,"hidden"),this._destroyFrame()},_displayMedia:function(){var t=this._mediaInfos[this._mediaPtr],i=t.title,d=t.caption,n=s.query(".mediaSection .hzLine",this.domNode)[0];if(h.set(this._mediaTitle,"innerHTML",i),c[i?"remove":"add"](this._mediaTitle,"hidden"),h.set(this._mediaCaption,"innerHTML",d),c[d?"remove":"add"](this._mediaCaption,"hidden"),c[i&&d?"remove":"add"](n,"hidden"),this._rid=null,"image"===t.type)this._showImage(t);else{var o=this,r=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],l=t.value.theme||this.chartTheme;a.isString(l)&&-1===(l=l.replace(/\./gi,"/")).indexOf("/")&&(l="dojox/charting/themes/"+l),l||(l="./Rainbow"),r.push(l);try{var m=this._rid=S++;e(r,(function(e,i,a){m===o._rid&&(o._rid=null,o._showChart(t.type,t.value,e,i,a))}))}catch(e){console.log("PopupRenderer: error loading modules")}}},_preventNewTab:function(e){return(e=e&&a.trim(e).toLowerCase())&&(0===e.indexOf("mailto:")||0===e.indexOf("tel:"))},_showImage:function(e){c.add(this._mediaFrame,"image");var t,a=m.get(this._gallery,"height"),d=e.value,n=_.decode(d.linkURL),o=_.decode(d.sourceURL);n&&(t=l.create("a",{href:n,target:this._preventNewTab(n)?"":"_blank"},this._mediaFrame));var r=e.refreshInterval?this._addURLParameter(o,"timestamp",Date.now()):o;l.create("img",{className:"esriPopupMediaImage",src:r},t||this._mediaFrame);var h=s.query(".esriPopupMediaImage",this._mediaFrame)[0];this._imageLoadHandle=i.connect(h,"onload",this,(function(){this._clearImageHandles(),this._imageLoaded(h,a),this._initImageRefresh(e)}))},_addURLParameter:function(e,t,i){var a=-1===e.indexOf("?")?"?":"&";return e+a+t+"="+i},_initImageRefresh:function(e){if(e.refreshInterval){var t=60*e.refreshInterval*1e3;this._imageRefreshHandle=setTimeout(a.hitch(this,(function(){this._destroyFrame(),this._showImage(e)})),t)}},_clearImageHandles:function(){i.disconnect(this._imageLoadHandle),this._imageLoadHandle=null,clearTimeout(this._imageRefreshHandle),this._imageRefreshHandle=null},_showChart:function(e,t,i,a,s){c.remove(this._mediaFrame,"image");var n=this._chart=new i(l.create("div",{class:"chart"},this._mediaFrame),{margins:{l:4,t:4,r:4,b:4}});switch(s&&n.setTheme(s),e){case"piechart":n.addPlot("default",{type:"Pie",labels:!1}),n.addSeries("Series A",t.fields);break;case"linechart":n.addPlot("default",{type:"Markers"}),n.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),n.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),d.forEach(t.fields,(function(e,t){e.x=t+1})),n.addSeries("Series A",t.fields);break;case"columnchart":n.addPlot("default",{type:"Columns",gap:3}),n.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),n.addSeries("Series A",t.fields);break;case"barchart":n.addPlot("default",{type:"Bars",gap:3}),n.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),n.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),n.addSeries("Series A",t.fields)}this._action=new a(n),n.render()},_destroyFrame:function(){this._rid=null,this._clearImageHandles(),this._chart&&(this._chart.destroy(),this._chart=null),this._action&&(this._action.destroy(),this._action=null),h.set(this._mediaFrame,"innerHTML","")},_imageLoaded:function(e,t){var i=e.height;if(i<t){var a=Math.round((t-i)/2);m.set(e,"marginTop",a+"px")}},_attListHandler:function(e,t){if(e===this._attachmentsDfd){this._attachmentsDfd=null;var i="";t instanceof Error||!t||!t.length||d.forEach(t,(function(e){i+="<li>",i+="<a href='"+g.addProxy(e.url)+"' target='_blank'>"+(e.name||"[No name]")+"</a>",i+="</li>"})),h.set(this._attachmentsList,"innerHTML",i||"<li>"+this._nls.NLS_noAttach+"</li>")}},_createLinkIfURI:function(e,t){var i=g.getURIInfo(e);if(i){var a=e.match(i.pattern),d=a&&a[2],s=_.decode(a[1]);l.create("a",{target:"_blank",href:s,title:s,innerHTML:f.substitute({appName:i.appName,hierPart:d},i.label)},t)}else h.set(t,"innerHTML",e)},_showStatus:function(e){h.set(this._status,"innerHTML",e),c.remove(this._status,"hidden"),s.query(".mainSection",this.domNode).addClass("hidden")},_hideStatus:function(){h.set(this._status,"innerHTML",""),c.add(this._status,"hidden"),s.query(".mainSection",this.domNode).removeClass("hidden")},_handleComponentsSuccess:function(e){if(e){this._hideStatus();var t,i=this.showTitle?e.title:"",n=e.description,o=e.fields,m=e.mediaInfos,u=this.domNode,v=this._nls,p=this,f=this.template,g=this.graphic;if(this._prevMedia.title=v.NLS_prevMedia,this._nextMedia.title=v.NLS_nextMedia,h.set(this._title,"innerHTML",i),i||c.add(this._title,"hidden"),!e.hasDescription&&o){n="";var y=d.map(o,(function(e){var t=l.create("tr",{vAlign:"top"});l.create("td",{className:"attrName",innerHTML:_.encode(e[0])},t);var i=l.create("td",{className:"attrValue"},t);return this._createLinkIfURI(e[1],i),t}),this);y.length&&(t=l.create("table",{className:"attrTable",cellPadding:"0px",cellSpacing:"0px"}),d.forEach(y,(function(e){t.appendChild(e)})))}t?(this._description.appendChild(t),n=!0):h.set(this._description,"innerHTML",n),n||c.add(this._description,"hidden"),s.query("a",this._description).forEach((function(e){p._preventNewTab(e.href)?"_blank"===e.target&&h.remove(e,"target"):h.set(e,"target","_blank")})),i&&n?s.query(".mainSection .hzLine",u).removeClass("hidden"):i||n?s.query(".mainSection .hzLine",u).addClass("hidden"):s.query(".mainSection",u).addClass("hidden");var L=this._attachmentsDfd=f.getAttachments(g);L&&(L.addBoth(a.hitch(this,this._attListHandler,L)),h.set(this._attachmentsList,"innerHTML","<li>"+v.NLS_searching+"...</li>"),s.query(".attachmentsSection",u).removeClass("hidden")),m&&m.length&&(s.query(".mediaSection",u).removeClass("hidden"),r.setSelectable(this._mediaFrame,!1),this._mediaInfos=m,this._mediaPtr=0,this._updateUI(),this._displayMedia()),e.editSummary&&(h.set(this._editSummary,"innerHTML",e.editSummary),m&&m.length&&c.remove(this._mediaBreak,"hidden"),c.remove(this._editSummarySection,"hidden")),this.emit("content-update")}else this._showStatus(j.NLS_noInfo)},_handleComponentsError:function(e){e&&"cancel"===e.dojoType||(console.log("PopupRenderer: error loading template",e),this._showStatus(j.NLS_noInfo))}});return n("extend-esri")&&a.setObject("dijit._PopupRenderer",T,p),T}));