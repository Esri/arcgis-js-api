// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/kernel","dojo/sniff","dojo/query","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojox/html/entities","dijit/_Widget","dijit/_Templated","../kernel","../lang","../urlUtils","./_EventedWidget","dojo/i18n!../nls/jsapi","dojo/NodeList-dom"],function(e,t,i,a,s,n,d,r,o,h,l,c,m,p,_,u,f,v,g,L,S){var y=0,b=S.widgets.popup,I=S.widgets.templatePicker,N=t([L,_,u],{declaredClass:"esri.dijit._PopupRenderer",constructor:function(){this._nls=a.mixin({},b)},templateString:"<div class='esriViewPopup'><div class='statusSection hidden' dojoAttachPoint='_status'></div><div class='mainSection'><div class='header' dojoAttachPoint='_title'></div><div class='hzLine'></div><div dojoAttachPoint='_description'></div><div class='break'></div></div><div class='attachmentsSection hidden'><div>${_nls.NLS_attach}:</div><ul dojoAttachPoint='_attachmentsList'></ul><div class='break'></div></div><div class='mediaSection hidden'><div class='header' dojoAttachPoint='_mediaTitle'></div><div class='hzLine'></div><div class='caption' dojoAttachPoint='_mediaCaption'></div><div class='gallery' dojoAttachPoint='_gallery'><div class='mediaHandle prev' dojoAttachPoint='_prevMedia' dojoAttachEvent='onclick: _goToPrevMedia'></div><div class='mediaHandle next' dojoAttachPoint='_nextMedia' dojoAttachEvent='onclick: _goToNextMedia'></div><ul class='summary'><li class='image mediaCount hidden' dojoAttachPoint='_imageCount'>0</li><li class='image mediaIcon hidden'></li><li class='chart mediaCount hidden' dojoAttachPoint='_chartCount'>0</li><li class='chart mediaIcon hidden'></li></ul><div class='frame' dojoAttachPoint='_mediaFrame'></div></div></div><div class='editSummarySection hidden' dojoAttachPoint='_editSummarySection'><div class='break'></div><div class='break hidden' dojoAttachPoint='_mediaBreak'></div><div class='editSummary' dojoAttachPoint='_editSummary'></div></div></div>",showTitle:!0,startup:function(){this.inherited(arguments),this._showStatus(I.loading),this._contentDfd=this.template.getComponents(this.graphic).then(a.hitch(this,this._handleComponentsSuccess)).otherwise(a.hitch(this,this._handleComponentsError))},destroy:function(){this._contentDfd&&this._contentDfd.cancel(),this._attachmentsDfd&&this._attachmentsDfd.cancel(),this._destroyFrame(),this.template=this.graphic=this._nls=this._mediaInfos=this._mediaPtr=this._contentDfd=this._attachmentsDfd=null,this.inherited(arguments)},_goToPrevMedia:function(){var e=this._mediaPtr-1;0>e||(this._mediaPtr--,this._updateUI(),this._displayMedia())},_goToNextMedia:function(){var e=this._mediaPtr+1;e!==this._mediaInfos.length&&(this._mediaPtr++,this._updateUI(),this._displayMedia())},_updateUI:function(){var e=this._mediaInfos,t=e.length,i=this.domNode,a=this._prevMedia,d=this._nextMedia;if(t>1){var r=0,o=0;s.forEach(e,function(e){"image"===e.type?r++:-1!==e.type.indexOf("chart")&&o++}),r&&(h.set(this._imageCount,"innerHTML",r),n.query(".summary .image",i).removeClass("hidden")),o&&(h.set(this._chartCount,"innerHTML",o),n.query(".summary .chart",i).removeClass("hidden"))}else n.query(".summary",i).addClass("hidden"),l.add(a,"hidden"),l.add(d,"hidden");var c=this._mediaPtr;0===c?l.add(a,"hidden"):l.remove(a,"hidden"),c===t-1?l.add(d,"hidden"):l.remove(d,"hidden"),this._destroyFrame()},_displayMedia:function(){var t=this._mediaInfos[this._mediaPtr],i=t.title,s=t.caption,d=n.query(".mediaSection .hzLine",this.domNode)[0];if(h.set(this._mediaTitle,"innerHTML",i),l[i?"remove":"add"](this._mediaTitle,"hidden"),h.set(this._mediaCaption,"innerHTML",s),l[s?"remove":"add"](this._mediaCaption,"hidden"),l[i&&s?"remove":"add"](d,"hidden"),this._rid=null,"image"===t.type)this._showImage(t);else{var r=this,o=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],c=t.value.theme||this.chartTheme;a.isString(c)&&(c=c.replace(/\./gi,"/"),-1===c.indexOf("/")&&(c="dojox/charting/themes/"+c)),c||(c="./Rainbow"),o.push(c);try{var m=this._rid=y++;e(o,function(e,i,a){m===r._rid&&(r._rid=null,r._showChart(t.type,t.value,e,i,a))})}catch(p){console.log("PopupRenderer: error loading modules")}}},_preventNewTab:function(e){return e=e&&a.trim(e).toLowerCase(),e&&(0===e.indexOf("mailto:")||0===e.indexOf("tel:"))},_showImage:function(e){l.add(this._mediaFrame,"image");var t,a=m.get(this._gallery,"height"),s=e.value;s.linkURL&&(t=c.create("a",{href:s.linkURL,target:this._preventNewTab(s.linkURL)?"":"_blank"},this._mediaFrame));var d=e.refreshInterval?this._addURLParameter(s.sourceURL,"timestamp",Date.now()):s.sourceURL;c.create("img",{className:"esriPopupMediaImage",src:d},t||this._mediaFrame);var r=n.query(".esriPopupMediaImage",this._mediaFrame)[0];this._imageLoadHandle=i.connect(r,"onload",this,function(){this._clearImageHandles(),this._imageLoaded(r,a),this._initImageRefresh(e)})},_addURLParameter:function(e,t,i){var a=-1===e.indexOf("?")?"?":"&";return e+a+t+"="+i},_initImageRefresh:function(e){if(e.refreshInterval){var t=60*e.refreshInterval*1e3;this._imageRefreshHandle=setTimeout(a.hitch(this,function(){this._destroyFrame(),this._showImage(e)}),t)}},_clearImageHandles:function(){i.disconnect(this._imageLoadHandle),this._imageLoadHandle=null,clearTimeout(this._imageRefreshHandle),this._imageRefreshHandle=null},_showChart:function(e,t,i,a,n){l.remove(this._mediaFrame,"image");var d=this._chart=new i(c.create("div",{"class":"chart"},this._mediaFrame),{margins:{l:4,t:4,r:4,b:4}});switch(n&&d.setTheme(n),e){case"piechart":d.addPlot("default",{type:"Pie",labels:!1}),d.addSeries("Series A",t.fields);break;case"linechart":d.addPlot("default",{type:"Markers"}),d.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),d.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),s.forEach(t.fields,function(e,t){e.x=t+1}),d.addSeries("Series A",t.fields);break;case"columnchart":d.addPlot("default",{type:"Columns",gap:3}),d.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),d.addSeries("Series A",t.fields);break;case"barchart":d.addPlot("default",{type:"Bars",gap:3}),d.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),d.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),d.addSeries("Series A",t.fields)}this._action=new a(d),d.render()},_destroyFrame:function(){this._rid=null,this._clearImageHandles(),this._chart&&(this._chart.destroy(),this._chart=null),this._action&&(this._action.destroy(),this._action=null),h.set(this._mediaFrame,"innerHTML","")},_imageLoaded:function(e,t){var i=e.height;if(t>i){var a=Math.round((t-i)/2);m.set(e,"marginTop",a+"px")}},_attListHandler:function(e,t){if(e===this._attachmentsDfd){this._attachmentsDfd=null;var i="";t instanceof Error||!t||!t.length||s.forEach(t,function(e){i+="<li>",i+="<a href='"+g.addProxy(e.url)+"' target='_blank'>"+(e.name||"[No name]")+"</a>",i+="</li>"}),h.set(this._attachmentsList,"innerHTML",i||"<li>"+this._nls.NLS_noAttach+"</li>")}},_supportedURIInfos:[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,label:b.NLS_moreInfo},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"${hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"${hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,appName:"App Studio Player",label:b.NLS_openLinkInApp},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,appName:"Collector",label:b.NLS_openLinkInApp},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,appName:"Explorer",label:b.NLS_openLinkInApp},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,appName:"Navigator",label:b.NLS_openLinkInApp},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,appName:"Survey123",label:b.NLS_openLinkInApp},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,appName:"Trek2There",label:b.NLS_openLinkInApp},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,appName:"Workforce",label:b.NLS_openLinkInApp},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,appName:"iForm",label:b.NLS_openLinkInApp},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,appName:"FlowFinity",label:b.NLS_openLinkInApp},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,appName:"Laserfische",label:b.NLS_openLinkInApp},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,appName:"Microsoft Power BI",label:b.NLS_openLinkInApp}],_findURIInfo:function(e){var t;return s.some(this._supportedURIInfos,function(i){return i.pattern.test(e)&&(t=i),!!t}),t},_createLinkIfURI:function(e){var t=this._findURIInfo(e);if(t){var i=e.match(t.pattern),a=i&&i[2];return e.replace(t.pattern,"<a target='_blank' href='$1' title='$1'>"+v.substitute({appName:t.appName,hierPart:a},t.label)+"</a>")}return e},_showStatus:function(e){h.set(this._status,"innerHTML",e),l.remove(this._status,"hidden"),n.query(".mainSection",this.domNode).addClass("hidden")},_hideStatus:function(){h.set(this._status,"innerHTML",""),l.add(this._status,"hidden"),n.query(".mainSection",this.domNode).removeClass("hidden")},_handleComponentsSuccess:function(e){if(e){this._hideStatus();var t=this.showTitle?e.title:"",i=e.description,d=e.fields,r=e.mediaInfos,c=this.domNode,m=this._nls,_=this,u=this.template,f=this.graphic;this._prevMedia.title=m.NLS_prevMedia,this._nextMedia.title=m.NLS_nextMedia,h.set(this._title,"innerHTML",t),t||l.add(this._title,"hidden"),!e.hasDescription&&d&&(i="",s.forEach(d,function(e){i+="<tr valign='top'>",i+="<td class='attrName'>"+p.encode(e[0])+"</td>",i+="<td class='attrValue'>"+this._createLinkIfURI(e[1])+"</td>",i+="</tr>"},this),i&&(i="<table class='attrTable' cellpadding='0px' cellspacing='0px'>"+i+"</table>")),h.set(this._description,"innerHTML",i),i||l.add(this._description,"hidden"),n.query("a",this._description).forEach(function(e){_._preventNewTab(e.href)?"_blank"===e.target&&h.remove(e,"target"):h.set(e,"target","_blank")}),t&&i?n.query(".mainSection .hzLine",c).removeClass("hidden"):t||i?n.query(".mainSection .hzLine",c).addClass("hidden"):n.query(".mainSection",c).addClass("hidden");var v=this._attachmentsDfd=u.getAttachments(f);v&&(v.addBoth(a.hitch(this,this._attListHandler,v)),h.set(this._attachmentsList,"innerHTML","<li>"+m.NLS_searching+"...</li>"),n.query(".attachmentsSection",c).removeClass("hidden")),r&&r.length&&(n.query(".mediaSection",c).removeClass("hidden"),o.setSelectable(this._mediaFrame,!1),this._mediaInfos=r,this._mediaPtr=0,this._updateUI(),this._displayMedia()),e.editSummary&&(h.set(this._editSummary,"innerHTML",e.editSummary),r&&r.length&&l.remove(this._mediaBreak,"hidden"),l.remove(this._editSummarySection,"hidden")),this.emit("content-update")}else this._showStatus(b.NLS_noInfo)},_handleComponentsError:function(e){e&&"cancel"===e.dojoType||(console.log("PopupRenderer: error loading template",e),this._showStatus(b.NLS_noInfo))}});return d("extend-esri")&&a.setObject("dijit._PopupRenderer",N,f),N});