// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/string","dojo/i18n!../../nls/jsapi","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/store/Memory","dojo/data/ObjectStore","dojo/json","dojo/query","../../lang","../../kernel","../../layers/RasterFunction","dojo/text!../../layers/support/rasterFunctionSchema.json","dojo/text!../../layers/support/rasterFunctionResources.json","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/form/TextBox","dijit/form/CheckBox","dijit/form/NumberTextBox","dijit/form/Select","dijit/TitlePane","dijit/Tooltip","./EditableGridMixin","./RFxAggregationDefinitionEditor","./RFxArgSlider","./RFxAttributeTable","./RFxBandArithmeticBandIndexesEditor","./RFxBandCombinationEditor","./RFxBandIndexPicker","./RFxRasterInfo","./RFxBandMatrix","./RFxBandNamePicker","./RFxCellSizeInput","./RFxClippingGeometry","./RFxColorInput","./RFxConversionGrid","./RFxDetectChangeTypePicker","./RFxFactorFunctionEditor","./RFxDimensionlessEditor","./RFxFeatureSelect","./RFxFieldNumberSwitchable","./RFxFieldSelect","./RFxGammaEditor","./RFxGridBase","./RFxJsonFileUploader","./RFxKernelSelector","./RFxLinearUnit","./RFxMultidimensionalDefinitionEditor","./RFxNamedRasterEditor","./RFxNeighborhoodValues","./RFxPansharpenSensorPicker","./RFxPropertySet","./RFxRangedValueEditor","./RFxRasterArrayEditor","./RFxRasterDimensionSelect","./RFxRasterInfoCellSizeEditor","./RFxRasterInput","./RFxRasterInputArray","./RFxRasterVariableGrid","./RFxRemapGrid","./RFxScaleSelect","./RFxScalesInput","./RFxSRPicker","./RFxStatisticsGrid","./RFxFilteredArgumentEditor","./RFxTemplateInput","./RFxTransposeBit","./RFxUnitPicker","./RFxWeightedOverlayTableEditor","./RFxWeightedSumTableEditor","./SimpleMatrixCreator","./srUtils","./utils","../analysis/RemapGrid","../ColorPicker","../ColorRampSelector","../../renderers/colorRampUtils"],(function(e,t,r,i,a,n,s,o,u,l,c,d,g,h,f,p,m,v,y,_,R,A,x,F,b,w,S,T,C,E,O,I,k,N,j,V,D,L,U,W,P,B,M,G,z,q,H,J,K,$,Q,X,Y,Z,ee,te,re,ie,ae,ne,se,oe,ue,le,ce,de,ge,he,fe,pe,me,ve,ye,_e,Re,Ae,xe,Fe,be,we,Se){var Te,Ce,Ee,Oe,Ie,ke="esriRFxArgsEditor__table",Ne="esriRFxArgsEditor__tr",je="esriRFxArgsEditor__tr--arg-name",Ve="esriRFxArgsEditor__tr--arg-widget",De="esriRFxArgsEditor__label--fx-desc",Le="esriRFxArgsEditor__icon--warning",Ue="esriRFxArgsEditor__titlePane",We="RasterFunctionTemplate",Pe="RasterFunctionVariable",Be={name:"Elevation #1",type:"multipart",colorRamps:[{fromColor:[175,240,233],toColor:[255,255,179]},{fromColor:[255,255,179],toColor:[0,128,64]},{fromColor:[0,128,64],toColor:[252,186,3]},{fromColor:[252,186,3],toColor:[128,0,0]},{fromColor:[120,0,0],toColor:[105,48,13]},{fromColor:[105,48,13],toColor:[171,171,171]},{fromColor:[171,171,171],toColor:[255,252,255]}]},Me=e([y,_],{declaredClass:"esri.dijit.RasterFunctionEditor.RFxArgsEditor",widgetsInTemplate:!0,templateString:"<div class='esriRFxArgsEditor'><div data-dojo-attach-point='_argsContainterNode'></div></div>",showVariableNames:!0,_inputWidgets:[],_supportedDataTypes:["raster","long","double","string","longarray","stringarray","doublearray","rasterarray","colorramp","boolean","rasterstatisticsarray","arrayofrasterstatistics","cellsize","featureclass","rasterinfo","table","propertyset","spatialReference","rfxtemplate","file"],constructor:function(r){r=r||{},e.safeMixin(this,r),this._i18n=n.widgets.rasterFunctionEditor.rfxArgsEditor,this._rfxTemplate=t.clone(this.rfxTemplate),Te=d.parse(a.substitute(m,n,t.hitch(this,this._substituteString))),Ce=d.parse(a.substitute(v,n,t.hitch(this,this._substituteString))),Ee=Ce&&Ce.enums,Oe=Ce&&Ce.dataTypes,Ie=Ce&&Ce.domainTypes,this._portalMode=r.portalSelf&&r.portalSelf.portalMode},startup:function(e){this.inherited(arguments)},postCreate:function(e){this.inherited(arguments),this.rfxTemplate&&(this._honorIsPublic=this._getHonorIsPublic(this.rfxTemplate),this._populateUI())},destroy:function(){this._destroyInputWidgets(),this.inherited(arguments)},reset:function(){},getName:function(){return this._rfxTemplate&&this._rfxTemplate.name},getUpdatedRFTWithValues:function(){var e=this._getUpdatedRFTWithValues(this._rfxTemplate);return this._cloneRFT(e,["input","uxBlocks","overrideWidget"])},_getUpdatedRFTWithValues:function(e){if(e){var t=e.arguments,r=this._getFunctionSchema(e);return t&&(this._isRFxArg(t)?e.arguments=this._getUpdatedRFxArg(t,"Raster",r):Object.keys(t).forEach((function(e){if("type"!==e){var i=t[e];i&&(t[e]=this._getUpdatedRFxArg(i,e,r))}}),this)),e}},_getRFT:function(e){if(e){var t=e.arguments,r=this._getFunctionSchema(e);return t&&(this._isRFxArg(t)?e.arguments=this._getUpdatedRFxArg(t,"Raster",r):Object.keys(t).forEach((function(e){if("type"!==e){var i=t[e];i&&(t[e]=this._getUpdatedRFxArg(i,e,r))}}),this)),e}},_isRFxArg:function(e){if(e){var t=e.type;return[We,Pe].indexOf(t)>=0||this._isColorRamp(e)||this._isRecordSet(e)}},_getUpdatedRFxArg:function(e,t,i){if(!e||!this._isRFxArg(e))return e;var a=xe.getArgRFT(e),n=i&&i.rasterFunctionArguments,s=this._getCaseInsensitiveArg(t,n);if(s&&(s.key=t),a)return e.type===Pe?(e.value=this._getUpdatedRFTWithValues(a),e):this._getUpdatedRFTWithValues(a);if(this._hasRFTElements(e)){var o=e.value&&e.value.elements?e.value.elements:e.value;return r.forEach(o,(function(e,t){e&&(xe.isReferencedObject(e)||((a=xe.getArgRFT(e))?o[t]=this._getUpdatedRFTWithValues(a):e.type===Pe?e.value=this._getArgumentValue(e,s):o[t]=this._getArgumentValue(e,s)))}),this),e}return s&&s.dataType===Oe.rfxtemplate?e=this._getArgumentValue(e,s):e.type===Pe?(e.value=this._getArgumentValue(e,s),e):this._isRecordSet(e)?e:void 0},_substituteString:function(e,t){if(void 0===e)throw new Error(" RFxArgsEditor: "+t);return null===e?"":this._escapeValue(String(e))},_getHonorIsPublic:function(e){var i=e&&e.arguments;if(!e||!i)return!1;if(e.aliases)return!0;var a=t.hitch(this,(function(e){if(!e)return!1;if(e.isPublic)return!0;if(this._hasRasterElements(e)){var t=e.value&&e.value.elements?e.value.elements:e.value;return r.some(t,(function(e){return a(e)}),this)}return this._getHonorIsPublic(xe.getArgRFT(e))}));return this._isRFxArg(i)?a(i):r.some(Object.keys(i),(function(e){var t=i[e];if(this._isRFxArg(t))return a(t)}),this)},_hasRFTElements:function(e){if(!e||!e.value)return!1;var t=e.value.elements?e.value.elements:e.value;return Array.isArray(t)?t.some((function(e){return e&&e.type===We})):void 0},_hasRasterElements:function(e){if(!e||!e.value)return!1;var t=e.value.elements?e.value.elements:e.value;return!!Array.isArray(t)&&t.some((function(e){return e&&(e.isDataset||e.type===We)}))},_isRecordSet:function(e){return e.type&&e.type.toLowerCase().indexOf("recordset")>=0},_isColorRamp:function(e){return!!e&&(!!(e.type&&e.type.toLowerCase().indexOf("colorramp")>=0)||(!!(e.value&&e.value.type&&e.value.type.toLowerCase().indexOf("colorramp")>=0)||void 0))},_cloneRFT:function(e,i){var a={};if("object"==typeof e&&null!==e&&!Array.isArray(e)){for(var n in e)e.hasOwnProperty(n)&&r.indexOf(i,n)<0&&(a[n]=this._cloneRFT(e[n],i));return a}return Array.isArray(e)?e.map(t.hitch(this,(function(e){return this._cloneRFT(e,i)}))):t.clone(e)},_populateUI:function(){this._destroyInputWidgets(),u.empty(this._argsContainterNode),xe.createObjectMap(this._rfxTemplate),this._buildRFxTemplateUI(this._rfxTemplate)},_buildRFxTemplateUI:function(e,t){var r,i=e.arguments;if(e.function&&e.name&&i&&(r=this._buildRFxUI(e,t)),i)if(this._isRFxArg(i))this._buildArgRFTUI(i);else{var a,n=this._getFunctionSchema(e),s={};n&&Object.keys(n.rasterFunctionArguments).forEach((function(e){var t=this._getCaseInsensitiveArg(e,i),r=n.rasterFunctionArguments[e];a=this._buildArgRFTUI(t,a,r)||a,s[e.toLowerCase()]=!0}),this),Object.keys(i).forEach((function(e){if(!s[e.toLowerCase()]&&"type"!==e){var t=i[e];a=this._buildArgRFTUI(t,a)||a}}),this)}return r},_buildArgRFTUI:function(e,t,i){if(this._isRFxArg(e)){var a=xe.getArgRFT(e);if(a)return this._buildRFxTemplateUI(a,t);if(this._hasRasterElements(e)){var n=e&&e.value.elements?e.value.elements:e.value,s=t;return r.forEach(n,(function(e){(a=xe.getArgRFT(e))&&(s=this._buildRFxTemplateUI(a,s)||s)}),this),s}}},_getFunctionSchema:function(e){if(e&&e.function&&e.function.type){var t=e.function.type,r=e&&e.arguments&&e.arguments,i=xe.getFunctionName(r);return i&&i!==Pe||(i=t),this._getCaseInsensitiveArg(i,Te)}},_getSchemaArgKey:function(e,t){if(e){var i,a=Object.keys(e);return void 0===t&&1===a.length?a[0]:(r.some(a,(function(e){e.toLowerCase()===(t&&t.toLowerCase())&&(i=e)})),i)}},_buildRFxArgUI:function(e){var t,i,a=[],n=(e=e||{}).rfxArg,s=e.rfxArgName,o=e.functionSchemaArgs,u=e.schemaEditorOverrides,l=e.rfxArgs,c=e.container,d=e.overriddenArgNames,g=e.triggerArgs;if(n)return o&&(t=this._getSchemaArgKey(o,s),(i=o[t])&&(i.key=t)),i&&i.categoryRefId&&this._isShown(n,i)&&(c=this._createCategoryDiv(c,i.categoryRefId)),u&&r.some(u,(function(e){r.indexOf(e.argumentNames,t)>=0&&this._isOverrideWidgetShown(e.argumentNames,l)&&r.indexOf(d,t)<0&&(d=d.concat(e.argumentNames),this._buildOverrideWidgetLayout(e,l,c,o))}),this),r.indexOf(d,t)<0&&(i&&"rfxtemplate"===i.dataType||n.type&&n.type!==We)&&this._isShown(n,i)&&(i&&r.indexOf(this._supportedDataTypes,i.dataType)<0?a.push(n.name||i.displayName):this._buildRFxArgLayout(n,c,i,l)),i&&i.editorStateTrigger&&i.editorStateTrigger.active&&g.push({rfxArg:n,schemaArgDef:i}),{overriddenArgNames:d,unsupportedDataTypeArgs:a}},_createCategoryDiv:function(e,t){if(s=g("."+t+"-table-body",e)[0])return s;var r=u.create("tr",{class:Ue+" "+t+"-category"},e),i=u.create("td",null,r),a=u.create("div",{class:t},i),n=u.create("table",{class:t+"-table"}),s=u.create("tbody",{class:t+"-table-body"},n),o=Ce.categoryReference&&Ce.categoryReference[t];new b({title:o.title,content:n,open:o.visible},a);return s},_buildRFxUI:function(e,i){i=i||this._argsContainterNode;var a=e.arguments,n=[],s=[],o=[],l=this._getFunctionSchema(e),c=l&&l.rasterFunctionArguments,d=l&&l.editorArgumentOverride&&l.editorArgumentOverride.active?l.editorArgumentOverride.overrides:null,g=u.create("table",{class:ke}),h=u.create("tbody",null,g),f=i===this._argsContainterNode?"first":"after",p=u.create("div",null,i,f),m={functionSchema:l,functionSchemaArgs:c,schemaEditorOverrides:d,rfxArgs:a,container:h,triggerArgs:o,overriddenArgNames:n};function v(e){if(e){var t=e.overriddenArgNames,r=e.unsupportedDataTypeArgs;t&&(n=n.concat(t),m.overriddenArgNames=n),r&&(s=s.concat(r),m.unsupportedDataTypeArgs=s)}}function y(e){Object.keys(e).forEach((function(e){var r=this._getCaseInsensitiveArg(e,a);r&&this._isRFxArg(r)&&!r.uxBlocks&&v(this._buildRFxArgUI(t.mixin({rfxArg:r,rfxArgName:e},m)))}),this)}if(a&&(this._isRFxArg(a)?v(this._buildRFxArgUI(t.mixin({rfxArg:a},m))):(c&&t.hitch(this,y)(c),t.hitch(this,y)(a)),Object.keys(a).forEach((function(e){var t=a[e];t&&t.input&&t.input.declaredClass.indexOf("RFxFieldSelect")>0&&t.input.setFieldOptions(),t&&t.input&&t.input.declaredClass.indexOf("RFxRangedValueEditor")>=0&&t.input.setInputConstraints(),t&&t.overrideWidget&&t.overrideWidget.declaredClass.indexOf("RFxFilteredArgumentEditor")>-1&&t.overrideWidget._attachTriggerArgsChangeListener()})),r.forEach(o,(function(e){var t=e.rfxArg,r=t&&t.value;this._handleEditorStateTriggers(a,r,e.schemaArgDef,h)}),this),Object.keys(a).forEach((function(e){var t=a[e];t&&t.input&&t.input.declaredClass&&t.input.declaredClass.indexOf("RFxDetectChangeTypePicker")>=0&&t.input.onEditorStateTriggerExecuted()}))),h.childNodes&&h.childNodes.length)return this._buildTitlePane(g,p,e.function,s)},_isOverrideWidgetShown:function(e,t){var i;return r.some(e,(function(e){if(i=this._getCaseInsensitiveArg(e,t),this._isShown(i))return!0}),this)},_hasVisibleElements:function(e){if(e&&!xe.isReferencedObject(e)){var t=e.value&&e.value.elements;return t&&r.some(t,(function(e){return this._isShown(e)}),this)}},_isShown:function(e,t){return!!e&&(this._honorIsPublic?!!e.isPublic||!!this._hasVisibleElements(e):!t||!t.hidden)},_buildTitlePane:function(e,r,i,a){if(i.customFunction){var n=u.create("div",null,r);return u.place(e,n),n}var s=new b({title:i&&i.name,content:e},r);s.startup();var o=t.hitch(this,(function(e,t){this.own(new w({connectId:[e],label:"<div class='"+De+"'>"+t+"</div>"})),e.onclick=function(e){e.stopPropagation()}}));s.titleNode&&(o(u.create("a",{class:"esriFloatTrailing helpIcon",style:"float: right; margin-right: -6px;"},s.titleNode),i&&i.description),a&&a.length&&o(u.create("a",{class:Le},s.titleNode),this._i18n.unsupportedDataTypeWarning+"<br><br><strong>"+a.join(", ")+"</strong>"));return s.domNode},_buildRFxArgLayout:function(e,t,r,i){var a,n,s,o;if(!(i&&"RenderedRasterFunctionArguments"===i.type&&e&&e.value&&e.value.type&&e.value.type.indexOf("Renderer")>-1))return n=(r&&r.dataType)===Oe.boolean,s=this._useRFxArgWidget(r),o=r&&r.domain,(s||n)&&(a=u.create("tr",{class:Ne},t),e.uxBlocks=[a]),s?this._buildRFxWidgetLayout(a,e,r,i):n&&!o?this._buildBooleanLayout(a,e,r,i):this._buildStdTwoRowLayout(t,e,r,i)},_useRFxArgWidget:function(e){return e&&(e.domain&&e.domain.type===Ie.range||e.elementInfos&&e.dataType===Oe.rasterArray||e.dataType===Oe.table)},_createInputWidget:function(e,t,r,i){var a=this._getWidget(e,t,r,i);a&&(a.startup(),e.input=a,this._inputWidgets.push(a))},_createOverrideWidget:function(e,i,a){var n=new e(i,a),s=i&&i.inputArgs;n.startup(),this._inputWidgets.push(n);var o=i.overrideWidgetPath.indexOf("RFxFilteredArgumentEditor")>=0;if(i.overrideWidgetPath.indexOf("RFxRangedValueEditor")>=0||o){var u=i.rfxArgs,l=Object.keys(i.inputArgs)[0],c=this._getCaseInsensitiveArg(l,u),d=xe.getFunctionName(u),g=i.rasterFunctions[d],h=g&&g.rasterFunctionArguments&&g.rasterFunctionArguments[l];n.on("change",function(e){e.value&&this._onArgumentValueChange(c,h,u,e.value)}.bind(this))}else n.on("change",t.partial(t.hitch(this,this._onArgumentValueChange),c,h,u));n.on("drawtool-activate",t.hitch(this,(function(e){this.emit("drawtool-activate",e)}))),n.on("drawtool-deactivate",t.hitch(this,(function(e){this.emit("drawtool-deactivate",e)}))),n.on("add-layer",t.hitch(this,(function(e){this.emit("add-ready-to-use-layer",e)}))),n.on("zoom-to-extent",t.hitch(this,(function(e){this.emit("zoom-to-extent",e)}))),n.domNode&&s&&r.forEach(Object.keys(s),(function(e){var t=s[e];t&&(t.uxBlocks=[n.domNode],t.overrideWidget=n)}))},_buildOverrideWidgetLayout:function(e,i,a,n){if(e){var s,o,l={},c={},d={},g="";e.triggerAttributes&&(g=e.triggerAttributes),r.forEach(e.argumentNames,(function(e){s=this._getCaseInsensitiveArg(e,i);var t=n[e];t&&(t.key=e),s&&(s.displayName=this._getArgDisplayName(s.name,t),(!h.isDefined(s.value)||Array.isArray(s.value)&&0===s.value.length)&&t.defaultValue&&(s.value=t.defaultValue),c[e]=s)}),this),r.forEach(e.triggerArguments,(function(e){s=this._getCaseInsensitiveArg(e,i);var t=n[e];t&&(t.key=e),s&&(s.displayName=this._getArgDisplayName(s.name,t),d[e]=s)}),this),r.forEach(Object.keys(n),(function(e){(o=n[e]).dataType===Oe.raster&&(s=this._getCaseInsensitiveArg(e,i))&&(l[e]=s)}),this);try{require([e.widget.path],t.hitch(this,(function(r){var n,s,o=u.create("tr",{class:Ne},a);n=u.create("td",null,o),s=u.create("div",null,n),this._createOverrideWidget(r,{rasterFunctionEnums:Ee,rasterFunctions:Te,rasterArgs:l,rfxArgs:i,inputArgs:c,triggerArgs:d,triggerAttributes:g,overrideWidgetPath:e.widget.path,inputLayers:this.inputLayers,featureLayers:this.featureLayers,getRFT:t.hitch(this,this._getUpdatedRFTWithValues),browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf},allowScalar:!1,isShownFx:t.hitch(this,this._isShown)},s)})))}catch(e){console.error(e),r.forEach(Object.keys(c),(function(e){s=c[e],o=this._getCaseInsensitiveArg(e,n),this._buildRFxArgLayout(s,a,o,i)}),this)}}},_buildBooleanLayout:function(e,t,r,i){var a,n;a=u.create("td",{innerHTML:this._getArgDisplayName(t.name,r)},e),n=u.create("div",null,a,"first"),this._createInputWidget(t,n,r,i)},_buildStdTwoRowLayout:function(e,t,r,i){var a,n,s,o;a=u.create("tr",{class:je},e),u.create("td",{innerHTML:this._getArgDisplayName(t.name,r)},a),n=u.create("tr",{class:Ve},e),o=u.create("td",null,n),s=u.create("div",null,o),t.uxBlocks=[a,n,s],this._createInputWidget(t,s,r,i)},_getArgDisplayName:function(e,t){if(!t||!t.displayName)return e;if(this.showVariableNames){var r=t.key;return h.isDefined(e)&&""!==e&&e.toLowerCase()!==r.toLowerCase()?e:t.displayName}return t.displayName},_buildRFxWidgetLayout:function(e,t,r,i){var a,n;a=u.create("td",null,e),n=u.create("div",null,a),this._createInputWidget(t,n,r,i)},_getDatasetOptions:function(){if(this.inputLayers)return this._inputLayerStore=new c(new l({data:this.inputLayers})),this._inputLayerStore},_destroyInputWidgets:function(){var e=this._inputWidgets;r.forEach(e,(function(e){if(e&&e.destroy)try{e.destroy()}catch(e){console.log(e)}})),this._inputWidgets=[]},_getWidget:function(e,r,i,a){if(e){var n,s=i&&i.dataType,o=h.isDefined(e.value)?e.value:i&&i.defaultValue,u=i&&i.domain,l=i&&i.dataTypeAttributes;return"RasterInfo"!==e.name||h.isDefined(o)||(o=""),e.isDataset&&!n&&(n=new se({inputLayers:this.inputLayers,value:o,allowScalar:!i||i.allowScalar,required:!!i&&i.required,selectDefault:i&&i.required,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},r)),n||(n=u?this._getDomainBasedWidget(u,e,a,r,o):this._getDataTypeBasedWidget(s,l,e,a,r,i)),n&&(n.on("change",t.partial(t.hitch(this,this._onArgumentValueChange),e,i,a)),n.on("add-layer",t.hitch(this,(function(e){this.emit("add-ready-to-use-layer",e)}))),n.on("zoom-to-extent",t.hitch(this,(function(e){this.emit("zoom-to-extent",e)})))),n}},_getDataTypeBasedWidget:function(e,r,i,a,n,s){var o,u=i.value,l=null==u?s&&s.defaultValue:u;if(r&&"bandmatrix"===r.type)return this._getDataTypeAttributeBasedWidget(e,r,i,a,n);switch(e){case Oe.raster:i.isDataset||(o=new x({value:u&&u.length?u[0]:u&&"Scalar"===u.type?u.value:void 0},n));break;case Oe.rasterArray:var c;s&&s.elementInfos&&(c=this._getRasterArrayInputArgs(s,a)),o=c?new oe({inputLayers:this.inputLayers,value:u,getRFT:t.hitch(this,this._getUpdatedRFTWithValues),allowScalar:s.allowScalar,schemaElementInfos:c,isShown:t.hitch(this,this._isShown),browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n):new ie({inputLayers:this.inputLayers,value:u,getRFT:t.hitch(this,this._getUpdatedRFTWithValues),allowScalar:s.allowScalar,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n);break;case Oe.string:o=new R({value:u},n);break;case Oe.double:o=new x({value:l},n);break;case Oe.long:o=new x({constraints:{places:0},value:l},n);break;case Oe.colorRamp:var g=xe.getColorRampFromArg(i);i&&!g&&"ShadedReliefFunctionArguments"===a.type&&(g=Be),o=new we({style:"text-indent: 0; height: 2.2em;",maxHeight:200,includeDefault:!1,colorRamp:g},n);break;case Oe.boolean:o=new A({checked:s&&s.reverseDisplayValue?!u:u},n);break;case Oe.stringArray:case Oe.doubleArray:case Oe.longArray:u&&u.length&&(u=u.join(",")),o=new R({value:u},n);break;case Oe.rasterStatisticsArray:case Oe.arrayOfRasterStatistics:var h=this._getCaseInsensitiveArg("Raster",a);o=new he({layerArg:h,value:u},n);break;case Oe.cellSize:o=new D({value:u},n);break;case void 0:o=new R({},n);try{"string"==typeof u?o.set("value",u):o.set("value",d.stringify(u))}catch(e){o.set("value",u)}break;case Oe.featureClass:o=new G({inputLayers:this.featureLayers,value:u,geometryType:r?r.type:null,isRequired:s&&s.required,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n);break;case Oe.propertySet:o=new te({value:u},n);break;case Oe.spatialReference:o=new ge({value:u,category:1},n);break;case Oe.rfxtemplate:o=new pe({inputLayers:this.inputLayers,value:i,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n);break;case Oe.rasterInfo:o=new N({inputLayers:this.inputLayers,value:u,getRFT:t.hitch(this,this._getUpdatedRFTWithValues),allowScalar:s.allowScalar,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n);break;case Oe.file:o=new K({value:u,fileExtSupported:s.fileExtSupported},n);break;default:o=new R({value:String(u)},n)}return o},_getDomainBasedWidget:function(e,t,r,i,a){if(e&&t){var n,s=e&&e.type;if(s===Ie.numList){var o=new c(new l({idProperty:"key",data:this._getNumListData(e)}));n=new F({store:o,labelAttr:"key"},i),h.isDefined(a)&&n.set("value",a.toString())}else if(s===Ie.list){var u=xe.getEnumData(Ee[e.enum],e.enum,this._portalMode),d=new c(new l({idProperty:"key",data:u}));n=new F({store:d,labelAttr:"label",maxHeight:200},i),h.isDefined(a)&&n.set("value",a.toString())}else if(s===Ie.range)n=new C({min:e.min,max:e.max,label:t.name,value:a},i);else if(s===Ie.bandIndex){var g=this._getCaseInsensitiveArg(e.argumentName,r);n=new k({nBandsArg:g,value:a},i)}else if(s===Ie.bandName){var f=this._getCaseInsensitiveArg(e.argumentName,r);n=new V({nBandsArg:f,value:a},i)}else if(s===Ie.fields){var p=this._getCaseInsensitiveArg(e.argumentName,r);xe.isReferencedObject(p)&&(p=xe.getReferencedObject(p._object_ref_id)),n=new q({layerArg:p,otherOptions:e.otherOptions,defaultValue:a},i)}else if(s===Ie.switchable){p=this._getCaseInsensitiveArg(e.argumentName,r);var m=this._parseSwitchableDomainArguments(e.attributes,r);n=new z({attributes:m,value:a},i)}else if(s===Ie.linearUnit)u=xe.getEnumData(Ee[e.enum]),d=new c(new l({idProperty:"key",data:u})),n=new Q({enumStore:d,value:a},i);else if(s===Ie.rasterDimensions){p=this._getCaseInsensitiveArg(e.argumentName,r);xe.isReferencedObject(p)&&(p=xe.getReferencedObject(p._object_ref_id)),n=new ae({layerArg:p,otherOptions:e.otherOptions,defaultValue:a},i)}else if(s===Ie.rasterVariables){p=this._getCaseInsensitiveArg(e.argumentName,r);xe.isReferencedObject(p)&&(p=xe.getReferencedObject(p._object_ref_id)),n=new ue({layerArg:p,otherOptions:e.otherOptions,defaultValue:a},i)}else if(s===Ie.mdimdef){p=this._getCaseInsensitiveArg(e.argumentName,r);xe.isReferencedObject(p)&&(p=xe.getReferencedObject(p._object_ref_id)),n=new X({layerArg:p,otherOptions:e.otherOptions,attributes:e.attributes,defaultValue:a},i)}else if(s===Ie.aggregationdef){p=this._getCaseInsensitiveArg(e.argumentName,r),xe.isReferencedObject(p)&&(p=xe.getReferencedObject(p._object_ref_id));var v=p.function&&p.function.customFunction,y=p.type&&"RasterFunctionTemplate"===p.type,_=p.function&&"MultidimensionalFilterFunction"===p.function.type,R=null;y&&_&&(R=p.arguments.Filter,p.customFunction=v),t.uxBlocks&&t.uxBlocks[0]&&(t.uxBlocks[0].style.display="none"),n=new T(v?{layerArg:p,filterArg:R,otherOptions:e.otherOptions,defaultValue:a}:{layerArg:p,otherOptions:e.otherOptions,defaultValue:a},i)}return n}},_parseSwitchableDomainArguments:function(e,t){return e.forEach((function(e){if("field"===e.type)e.argumentName=this._getCaseInsensitiveArg(e.argumentName,t);else if(e.type===Ie.list||e.type===Ie.linearUnit){var r=xe.getEnumData(Ee[e.enum]);e.enumStore=new c(new l({idProperty:"key",data:r}))}}),this),e},_getDataTypeAttributeBasedWidget:function(e,t,r,i,a){var n=this._getCaseInsensitiveArg(t.nBands,i),s=void 0===t.hasIdColumn||t.hasIdColumn,o=void 0===t.isExtensible||t.isExtensible;return new j({nBandsArg:n,nCols:t.cols,hasIdColumn:s,isExtensible:o,displayNames:t.displayNames,value:r.value},a)},_getFormattedValueFromVariable:function(e){if(e){var t=xe.getArgRFT(e);return t?"<"+(t.function&&t.function.name)+"."+this._i18n.outputRaster+">":"<"+n.widgets.rasterFunctionEditor.rfxRasterInput.rfxVariable+": "+e.name+">"}},_getRasterArrayInputArgs:function(e,t){var i,a=this._getCaseInsensitiveArg(e.nElementsArgument,t),n=a&&a.value,s=e.elementInfos;return void 0!==a&&void 0!==n||1!==s.length?(r.some(s,(function(e){var t=e.values;if(r.indexOf(t,n)>-1)return i=e.inputArgs,!0}),this),i):s[0].inputArgs},_getNumListData:function(e){if(e){for(var t=[],r=e.start,i=0;i<e.count;r+=e.inc,i++)t.push({key:r.toString()});return t}},_onArgumentValueChange:function(e,r,i,a){var n=e&&e.input;n instanceof F&&r&&r.dataType===Oe.long&&(a=parseInt(a,10)),n instanceof F&&r&&r.dataType===Oe.boolean&&(a="true"===a),n&&n.declaredClass.indexOf("RFxRasterInput")>=0&&this._handleRasterValueChange(e,i,a),n&&n.declaredClass.indexOf("RFxFeatureSelect")>=0&&this._handleFeatureValueChange(e,i),n&&n.declaredClass.indexOf("RFxJsonFileUploader")>=0&&this._handleFileInputChange(e,i,a),this._handleEditorStateTriggers(i,a,r),this._handleEditorValueTriggers(i,a,r),setTimeout(t.hitch(this,(function(){this._started=!0,this.emit("update-preview")})),1e3)},_handleRasterValueChange:function(e,t,r){var i=["RFxAggregationDefinitionEditor","RFxMultidimensionalDefinitionEditor","RFxRasterVariableGrid","RFxRasterDimensionSelect","RFxFieldSelect","RFxFieldNumberSwitchable","RFxStatisticsGrid"];Object.keys(t).forEach((function(a){var n,s=t[a]&&t[a].input;if(s&&(n=s,i.some((function(e){return n.declaredClass.indexOf(e)>-1})))&&s.layerArg&&s.layerArg.name===e.name){var o=r&&r.detail.widget.value;s.onRasterChange(o)}}))},_handleFeatureValueChange:function(e,t){Object.keys(t).forEach((function(r){var i=t[r]&&t[r].input;i&&i.layerArg&&i.layerArg.name===e.name&&i.onFeatureChange()}))},_handleFileInputChange:function(e,t,r){var i=r&&r.value;if(i){var a;try{a=JSON.parse(i)}catch(e){console.log(e)}"ClassifyFunctionArguments"===t.type&&"ClassifierDefinitionFile"===e.name&&a&&(t.ClassifierDefinition=a),"PredictUsingRegressionFunctionArguments"===t.type&&"RegressionDefinitionFile"===e.name&&a&&(t.RegressionDefinition=a)}},_getRFxNameAndCategoryRefIdRelation:function(e){var t=xe.getFunctionName(e),r={};return Object.keys(e).forEach((function(e){var i=Te[t],a=i&&i.rasterFunctionArguments&&i.rasterFunctionArguments[e],n=a&&a.categoryRefId;void 0!==n&&(r[n]?r[n].push(e):r[n]=[e])}),this),r},_handleCategoryVisibility:function(e,t,i){Object.keys(e).forEach((function(a){var n=e[a],o=r.every(n,(function(e){return r.some(t,(function(t){return t.rfxArgName===e&&"inactive"===t.state}),this)}),this),u=g("."+a+"-category"),l="block";o?(u||(u=g("."+a+"-category",i)),l="none"):l="block",u&&r.forEach(u,(function(e){s.set(e,"display",l)}),this)}),this)},_getActiveStateTriggers:function(e,t,i){var a=xe.getFunctionName(e),n=[];return r.forEach(Object.keys(e),(function(s){var o=Te[a],u=o&&o.rasterFunctionArguments&&o.rasterFunctionArguments[s],l=e[s].input;e[s].value||l&&l.value;u&&"boolean"===u.dataType&&l&&"checkbox"===l.type&&(u.reverseDisplayValue?l.checked:l.checked),u&&u.domain&&"long"===u.dataType&&l&&"text"===l.type&&(l&&l.value);var c=this._getArgumentValue(e[s],u);("boolean"==typeof c||isNaN(c)||(c=Number(c)),u&&"raster"===u.dataType&&i.key===s&&t&&"change"===t.type&&(c=t&&t.detail.widget.value),u&&u.editorStateTrigger&&u.editorStateTrigger.active&&e)&&(Array.isArray(u.editorStateTrigger.triggers)&&r.forEach(u.editorStateTrigger.triggers,(function(t){var i,o,u,l,d,g,h,f=t.autoRevert||!1;((o=t.checkValuePresent?!!c:Array.isArray(t.values)&&r.indexOf(t.values,c)>=0)||f)&&r.forEach(Object.keys(e),(function(r){if(r!==s){var c=Te[a],p=c&&c.rasterFunctionArguments&&c.rasterFunctionArguments[r],m=p&&p.categoryRefId;i=e[r],d=i.uxBlocks,i.input,d&&Array.isArray(d)&&(u=this._containsArgName(t.active,r),l=this._containsArgName(t.inactive,r),g=l&&o||u&&!o&&f,(u&&o||l&&!o&&f)&&(h=d&&d[0]&&"TR"===d[0].tagName?"table-row":"block",n.push({state:"active",rfxArgName:r,display:h,category:m})),g&&(h="none",n.push({state:"inactive",rfxArgName:r,display:h,category:m})))}}),this)}),this))}),this),n},_handleEditorStateTriggers:function(e,t,i,a){if(i&&i.editorStateTrigger&&i.editorStateTrigger.active&&e){var n,o,u,l,c=this._getActiveStateTriggers(e,t,i);c=r.filter(c,(function(e,t,i){return!r.some(i,(function(r,i){return i>t&&r.rfxArgName===e.rfxArgName&&r.state===e.state}))&&(!r.some(i,(function(r,i){return i!==t&&r.rfxArgName===e.rfxArgName&&r.state!==e.state}))||"active"!==e.state)}),this),r.forEach(c,(function(t){n=t.rfxArgName,o=e[n],u=o.uxBlocks,l=o.input,"active"===t.state&&l&&l.onChange&&i.key&&i.key.toLowerCase()!==n.toLowerCase()&&l.onChange(l.value),r.forEach(u,(function(e){e&&t.display&&s.set(e,"display",t.display)}),this)}),this);var d=this._getRFxNameAndCategoryRefIdRelation(e);this._handleCategoryVisibility(d,c,a)}},_handleEditorValueTriggers:function(e,t,i){i&&i.editorValueTrigger&&i.editorValueTrigger.active&&e&&r.forEach(i.editorValueTrigger.triggers,(function(i){var a,n,s;r.indexOf(i.values,t)>=0&&Object.keys(e).forEach((function(t){a=e[t],(n=a.input)&&(s=this._getTriggerArgValue(i.changedArgs,t),h.isDefined(s)&&(n.set("value",s),"PansharpeningFunctionArguments"===e.type&&n.refreshGrid&&n.refreshGrid()))}),this)}),this)},_getTriggerArgValue:function(e,t){var i;return r.some(e,(function(e){for(var r in e)if(e.hasOwnProperty(r)&&r.toLowerCase()===t.toLowerCase())return i=e[r],!0})),i},_containsArgName:function(e,t){if(!e||!t)return!1;var i=t.toLowerCase();return r.some(e,(function(e){return e.toLowerCase()===i}))},_getArgumentValue:function(e,i){if(e){var a,n,s,o=[],u=e.input,l=i&&i.dataType;if(!u){if(l===Oe.rasterArray&&e.value){var c=e.value.elements;r.forEach(c,(function(e,r){t.mixin(c[r].value,xe.getRasterJsonFromLayer(e.value))}))}return e.value}var g=[x,F,R],h=[A],f=[C,j,ie,he,se,k,V,G,oe,D,de,z,q,ae,ue,X,T,Q,te,ge,pe,N,K];if(p([we]))return xe.getRFxArgColorRampValue(u.colorRamp);if(p(f))return u.get("value");if(p(g))switch(a=u.value,l&&l.indexOf("array")>=0&&a&&"string"==typeof a&&(a=a.trim(),o=a.indexOf(",")>=0?a.split(","):a.split(" ")),l&&l===Oe.boolean&&"string"==typeof a&&(a="true"===u.value),l){case Oe.raster:if(!e.isDataset)return{value:a,type:"Scalar"};break;case Oe.longArray:return r.forEach(o,(function(e,t){o[t]=parseInt(e,10)})),o;case Oe.doubleArray:return r.forEach(o,(function(e,t){o[t]=parseFloat(e)})),o;case Oe.stringArray:case Oe.rasterArray:return r.forEach(o,(function(e,t){o[t]=e.trim()})),o;case Oe.long:return parseInt(a,10);case Oe.cellSize:try{return d.parse(a)}catch(e){return a}return a;case void 0:return a=a&&a.trim(),n=/^[+-]?(\d+)?(\.\d+)?$/.test(a),s=r.indexOf(["true","false"],a)>=0,n?parseFloat(a):s?"true"===a:a;default:return a}else if(p(h))return i&&i.reverseDisplayValue?!u.checked:u.checked}function p(e){return r.some(e,(function(e){if(u instanceof e)return!0}))}},_getCaseInsensitiveArg:function(e,t){if(e&&t)return r.some(Object.keys(t),(function(t){if(t.toLowerCase()===e.toLowerCase())return e=t,!0})),t[e]},_selectInputDataset:function(e,t){if(e&&e.options.length&&t){var i=t,a=null;"object"==typeof t&&(i=t.url,a=t.name);var n=h.isDefined(a);r.forEach(e.options,(function(e){e.selected=e.item.url===i&&(!n||n&&a===e.item.name)}),this)}}});return i("extend-esri")&&t.setObject("dijit.RasterFunctionEditor.RFxArgsEditor",Me,f),Me}));