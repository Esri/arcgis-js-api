// COPYRIGHT © 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/url","dojo/has","dojo/on","dojo/Deferred","dojo/_base/array","dojo/i18n!../../nls/jsapi","../../kernel","../../request","../../lang","../../config","../../layers/ArcGISImageServiceLayer","../../layers/ImageServiceParameters","../../layers/MosaicRule","../../layers/RasterFunction","../../tasks/Geoprocessor","../../tasks/GeometryService","../../tasks/JobInfo","../../renderers/colorUtils","../../renderers/colorRampUtils","../../layers/ArcGISRenderingImageServiceLayer"],(function(e,r,n,t,i,a,o,s,l,u,c,f,m,v,d,g,h,p,b,R,y){var S,A,C,j={},x={local:"LocalFunction",gpAdapter:"GPAdapterFunction",pythonAdapter:"PythonAdapterFunction"},w={name:"Raster",isDataset:!0,isPublic:!1,type:"RasterFunctionVariable"},F=new Map,T=[38,39,40,41,42,43,47,54,55,58,66,67,68,69,70,71,72,73,74,75,93,94];function M(e){if(e){var r=a.map([e.FromColor,e.ToColor],(function(e){var r=b.toRGB({h:e.Hue,s:e.Saturation,v:e.Value});return[r.r,r.g,r.b]}));return{fromColor:r[0],toColor:r[1],type:"algorithmic",algorithm:e.Algorithm}}}function E(e){if(e){var r=b.toHSV(b.getDojoColor(e));return{type:"HsvColor",Hue:r.h,Saturation:r.s,Value:r.v,AlphaValue:255}}}function N(e){if(e){var r=e.toJson?e.toJson():void 0;return{Algorithm:r&&r.Algorithm||"esriHSVAlgorithm",type:"AlgorithmicColorRamp",FromColor:E(e.fromColor),ToColor:E(e.toColor)}}}function D(e,r,n){var t=o.rasterFunctions.enumLabels,i={1:t.esriMonthJanuary,2:t.esriMonthFebruary,3:t.esriMonthMarch,4:t.esriMonthApril,5:t.esriMonthMay,6:t.esriMonthJune,7:t.esriMonthJuly,8:t.esriMonthAugust,9:t.esriMonthSeptember,10:t.esriMonthOctober,11:t.esriMonthNovember,12:t.esriMonthDecember};function a(e){return i[e]}function s(r,n){return e+" ("+a(r)+" - "+a(n)+")"}if(n&&""===n)return e.toString();var l="Months"===n,u="Quarters"===n;if(!l&&!u)return e.toString();if(1==r&&l)return e+" ("+a(+e)+")";switch(+e){case 1:return s(1,3);case 2:return s(4,6);case 3:case 7:return s(7,9);case 4:return u?s(10,12):s(4,6);case 10:return s(10,12)}return e.toString()}function I(e){return new Date(Number(e)).toISOString().replace("Z","")}function O(e){return new Date(e+"Z").getTime()}var L=this&&this.__spreadArrays||function(){for(var e=0,r=0,n=arguments.length;r<n;r++)e+=arguments[r].length;var t=Array(e),i=0;for(r=0;r<n;r++)for(var a=arguments[r],o=0,s=a.length;o<s;o++,i++)t[i]=a[o];return t};function _(e){if(e&&e.type){var r,n=x,t=e.type.replace("Arguments","");if(t.toLowerCase()===n.local.toLowerCase()){var i=e.Operation,a=i&&i.value;T.indexOf(a)>=0&&(r="CellStatisticsFunction")}if(t.toLowerCase()===n.gpAdapter.toLowerCase()){var o=e.ToolName;r=o&&o.value&&o.value.replace("_sa","")}if(t.toLowerCase()===n.pythonAdapter.toLowerCase()){var s=e.ClassName;r="object"==typeof s?s.value:s}return r||t}}function k(e,r){Array.isArray(e)?e.forEach(function(n,t){r(e,t)}.bind(this)):V(e)&&Object.keys(e).forEach(function(n){r(e,n)}.bind(this))}function V(e){return null!==e&&"object"==typeof e}var G=[.299,.587,.114];function J(e){if(e<=0||e>=255)return 1;var r=0;150!==e&&(r=e<=150?45*Math.cos(.01047*e):17*Math.sin(.021*e));var n=e+r,t=Math.log(e/255),i=Math.log(n/255);if(0===i)return 1;var a=t/i;return isNaN(a)?1:Math.min(9.9,Math.max(.01,a))}return e.mixin(j,{fetchRFT:function(e,r,n,t,a){var o,s,u=new i,c=e.name;if(o=(s=c&&c.slice(-8))&&".rft.xml"===s.toLowerCase(),!e||!e.itemDataUrl)return n("errorRetrievingRFTItem"),u.reject(new Error("errorRetrievingRFTItem")),u.promise;if(o){if(!a)return n("errorUtilitiesServiceNotAvailable"),u.reject(new Error("errorUtilitiesServiceNotAvailable")),u.promise;var f={url:a+"/ConvertRasterFunctionTemplate",rft:{itemId:e.id},format:"json"};return this.convertRFT(f,r,t,n)}return l({url:e.itemDataUrl,callbackParamName:"callback",content:{f:"json"},handleAs:"json",load:r,error:n}).then(t)},convertRFT:function(e,n,i,a){var o=e.url,s=function(){C&&(C.remove(),C=null),A&&(A.remove(),A=null)};S||(S=new g(o),t(S,"error",s)),A=t(S,"job-complete",(function(e){if(A&&(A.remove(),A=null),e.jobInfo.jobStatus!==p.STATUS_SUCCEEDED)return s(),void a(e);S.getResultData(e.jobInfo.jobId,"outputRasterFunction")})),C=t(S,"get-result-data-complete",(function(e){C&&(C.remove(),C=null);var n=e&&e.result&&e.result.value;if(n&&n.url){var t={url:n.url,handleAs:"json",load:i,error:a},o=new r(n.url).authority;return-1===c.defaults.io.corsEnabledServers.indexOf(o)&&c.defaults.io.corsEnabledServers.push(o),void l(t)}}));var u={inputRasterFunction:JSON.stringify(e.rft),format:e.format};return S.submitJob(u,n,null,a)},getRasterJsonFromLayer:function(e){if(!e)return null;var r=e.url;r&&r.indexOf("?token=")>0&&(r=r.slice(0,r.indexOf("?token=")));var n=e.credential||r&&s.id.findCredential(r);u.isDefined(n)&&(r=r+"?token="+n.token,n.referer&&(r+=n.referer));var t={url:r,name:e.name};return e.renderingRule&&(t.renderingRule=e.renderingRule.toJson?e.renderingRule.toJson():e.renderingRule),e.mosaicRule&&(t.mosaicRule=e.mosaicRule.toJson?e.mosaicRule.toJson():e.mosaicRule),t},getLayerIdfromRasterValue:function(e,r){var n;if(e&&r)return a.some(r,(function(r){if(r&&r.url===e.url&&r.name===e.name&&e.name)return n=r.id,!0})),n},getColorRampFromArg:function(e){var r,n,t;if(e&&(e.type&&e.type.toLowerCase().indexOf("colorramp")>-1?r=e:e.value&&e.value.type.toLowerCase().indexOf("colorramp")>-1&&(r=e.value),r))return(n=r.type.toLowerCase())==="MultiPartColorRamp".toLowerCase()?t=R.fromJson({type:"multipart",colorRamps:a.map(r.ArrayOfColorRamp,(function(e){return M(e)}))}):n==="AlgorithmicColorRamp".toLowerCase()&&(t=R.fromJson(M(r))),t.id=t.name=r.Name,t},getRFxArgColorRampValue:function(r){if(r){if(r.fromColor&&r.toColor)return e.mixin(N(r),{Name:r.name});if(r.colorRamps){var n=a.map(r.colorRamps,N);return{type:"MultiPartColorRamp",NumColorRamps:n.length,ArrayOfColorRamp:n,Name:r.name}}}},RFX_VARIABLE_TYPE:"RasterFunctionVariable",RFX_TEMPLATE_TYPE:"RasterFunctionTemplate",ARGUMENT_ARRAY_TYPE:"ArgumentArray",getArgRFT:function(e){if(e)return"RasterFunctionTemplate"===e.type?e:e.value&&"RasterFunctionTemplate"===e.value.type?e.value:void 0},getEnumData:function(e,r,n){if(Array.isArray(e))return e.forEach((function(e){e.key=e.key.toString()})),e},getImageServiceTitle:function(e){var r=e.split("/");return r[r.length-2]},isReferencedObject:function(e){if(e)return!!u.isDefined(e._object_ref_id)||void 0},functionTypes:x,defaultRasterNodeProps:w,getArcGISImageServiceLayerItem:function(r){if(r){var n=e.clone(r);n.name||(n.name=this.getImageServiceTitle(n.url));var t=new m;n.mosaicRule&&(t.mosaicRule=new v(n.mosaicRule)),n.renderingRule&&(t.renderingRule=new d(n.renderingRule));var i=new f(n.url,{id:n.name+(new Date).toString(),imageServiceParameters:t});return i.name=n.name,i}},filterMDInfoIfMosiacRuleIsSet:function(r){var n=e.clone(r.multidimensionalInfo),t=[],i=r.mosaicRule&&r.mosaicRule.multidimensionalDefinition;if(i&&i.length>0){var a=n.variables.filter(function(e){return i[0].variableName===e.name}.bind(this));if(!a||0===a.length)return n;a=a[0],(t=e.clone(a)).dimensions=[],i.forEach(function(r){var n=a.dimensions.filter(function(e){return r.dimensionName===e.name}.bind(this));if(n&&0!==n.length){var i=(n=n[0])&&n.values,o=0,s=1,l=r.values&&r.values[0].length,u=r.values&&r.values.length;switch(l||u){case 1:s=(o=i.indexOf(r.values[0]))+1;break;case 2:o=i.indexOf(r.values[0][0]),s=i.indexOf(r.values[0][1])+1}var c=i.slice(o,s);n.values=c,t.dimensions.push(n)}else t.dimensions=e.clone(a.dimensions)}.bind(this)),n.variables=[t]}return n},getRecurrentIntervalName:D,getCorrespondingDimensionRange:function(e,r){var n="StdTime"===e.name,t=n&&"string"==typeof r?O(r):r,i=e.values.filter((function(e){return e[0]===t}))[0];return"object"==typeof i&&n?i.map((function(e){return I(e)})):i},getFormattedDateString:I,parseFormattedDateString:O,getVariables:function(e){var r=e.multiDimensionalData,n=e.selectedVariables,t=void 0===n?[]:n;return r.variables.filter(function(e){var r=t.some(function(r){return"string"==typeof r?r===e.name:r.value===e.name}.bind(this));return!t.length||r}.bind(this))},getDimensions:function(e){var r=e.variables,n=void 0===r?[]:r,t=e.selectedDimension,i=void 0===t?"":t;return n.reduce(function(e,r){var n=r.dimensions.filter(function(e){return!i||e.name===i}.bind(this));return n.length?L(e,n):e}.bind(this),[])},getFormattedDimensionValues:function(r){var n=[];return r.forEach(function(r){var t,i=r.hasRanges,a=r.recurring;r.values.forEach(function(o){var s=e.clone(o);i||(s=[s]),"StdTime"===r.name&&(s=s.map(function(e){return a?D(e,r.interval,r.intervalUnit):I(Number(e))}.bind(this)));var l=i?s.join(" — "):s.join("");t={label:l,value:a?i?o.join(" — "):o.toString():l,selected:!1,disabled:!1},function(e,r){return e.some(function(e){return e.label===r.label}.bind(this))}(n,t)||n.push(t)}.bind(this))}.bind(this)),n},dimensionHasRanges:function(e){var r=!1;return e.length>0&&(r=e[0].hasRanges),r},getFormattedDimensionRanges:function(e){var r=[],n=[];return e.forEach((function(e){var t=e.label.split(" — ");r.push({label:t[0],value:t[0],selected:!1,disabled:!1}),n.push({label:t[1],value:t[1],selected:!1,disabled:!1})})),{min:r,max:n}},applyMultidimensionalDefinitionFilter:function(r,n){var t="BY_VALUES",i="BY_RANGES",a=n&&n.dimensions&&n.dimensions.length>0;if(n&&n.definitionType===i?a=a&&n.minValues&&n.minValues.length>0&&n.maxValues&&n.maxValues.length>0:n&&n.definitionType===t&&(a=a&&n.values&&n.values.length>0),!a)return r;var o=e.clone(r);return o.forEach(function(r){var a=r.hasRanges,o=[],s=n.dimensions.indexOf(r.name)>=0;s||(o=r.values),s&&n.dimensions.forEach(function(e,s){if(e===r.name)switch(n.definitionType){case i:var l=n.minValues[s],u=n.maxValues[s];"StdTime"===r.name&&(l=O(l),u=O(u)),"boolean"==typeof l||isNaN(l)||(l=Number(l)),"boolean"==typeof u||isNaN(u)||(u=Number(u));var c=-1,f=-1;if(a)for(var m=0;m<r.values.length&&(r.values[m][0]===l&&(c=m),r.values[m][1]===u&&(f=m+1),!(c>=0&&f>=1));m++);else c=r.values.indexOf(l),f=r.values.indexOf(u)+1;o=L(o,r.values.slice(c,f));break;case t:var v;v=a?n.values[s].split(" — "):[n.values[s]],"StdTime"===r.name&&(v=v.map(function(e){return O(e)}.bind(this)));var d=r.values.filter(function(e){return"boolean"==typeof e||isNaN(e)||(e=Number(e)),a?e.includes(v[0])&&e.includes(v[1]):v[0]==e}.bind(this));o=L(o,d)}}.bind(this)),r.values=e.clone(o)}.bind(this)),o},mapObjectByProperty:function(e,r){return e.map(function(e){return e[r]}.bind(this))},removeDuplicatesFromArray:function(e){return e.filter(function(e,r,n){return n.indexOf(e)===r}.bind(this))},UIModifier:{show:function(e){e.classList.remove("hidden")},hide:function(e){e.classList.add("hidden")}},isArrayEqual:function(e,r){return!(!e||!r)&&(e.length===r.length&&e.every(function(e){return r.indexOf(e)>=0}.bind(this)))},makeComboboxSelection:function(e,r){var n=!1;if(e.forEach((function(e){e.value[0]===r?(e.selected=!0,n=!0):e.selected=!1})),!n){var t={label:r,value:r,selected:!0,disabled:!0};e.unshift(t)}},processRFTAsLayerInput:function(e){var r,n,t=(r=esri.isDefined(esriGeowConfig.isMultiTenant)&&!1===esriGeowConfig.isMultiTenant,n=esriGeowConfig.self.helperServices.analysis&&esriGeowConfig.self.helperServices.analysis.url?esriGeowConfig.self.helperServices.analysis.url:"",r?n:n.replace("rasteranalysis","rasterutils")).replace("SpatialAnalysisTools/GPServer","RasterRendering/ImageServer");return new y(t,{raster:JSON.stringify(e),type:"rft"})},getFunctionName:_,coerceEnumDataForCurrentEnv:function(e,r,n){if(!n)return r;var t={};t={};var i=_(e);for(var a in t)if(a===i){var o=t[a];for(var s in o){var l=e[s],u=o[s];l&&(r=r.filter(function(e){return!(u.indexOf(e.key)>=0)}.bind(this)))}}return r},createObjectMap:function(e){var r=function(e,n){var t=e[n];V(t)&&(void 0!==t._object_id&&F.set(t._object_id,t),k(t,r))};k(e,r)},processAllComponents:k,isDefinedObject:V,getReferencedObject:function(e){return F.has(e)?F.get(e):null},projectGeometrySpatialReference:function(e,r){return new h(c.defaults.geometryService.url).project(e,r)},getRasterInfoExtent:function(e){var r=e&&(e.extent||e.fullExtent);return r&&{xmax:r.xmax,xmin:r.xmin,ymax:r.ymax,ymin:r.ymin,spatialReference:{latestWkid:r.spatialReference.latestWkid,wkid:r.spatialReference.wkid}}||void 0},computeGamma:function(e){var r=e.bands,n=e.pixelType;if(r&&0!==r.length&&n)return function(e,r,n){for(var t=[],i=0;i<r.length;i++){var a=0,o=0,s=0;"min"in r[i]?(a=r[i].min,o=r[i].max,avg=r[i].avg):(a=r[i][0],o=r[i][1],avg=r[i][2]),"u8"!==e&&(s=255*(s-a)/(o-a)),n&&(s*=G[i]),t.push(J(s))}return t}(n,r)}}),n("extend-esri")&&e.setObject("dijit.RasterFunctionEditor.utils",j,s),j}));