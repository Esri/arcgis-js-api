// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/has","../../kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojo/_base/lang","dojo/_base/Color","dojo/dom-construct","dojo/_base/array","dojo/dom-class","dojo/dom-style","dojo/store/Memory","dojo/data/ObjectStore","dojo/text!./templates/RFxClippingGeometry.html","dojo/i18n!../../nls/jsapi","dijit/form/Select","dijit/form/ToggleButton","./utils","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../toolbars/draw","../../graphic"],(function(e,t,i,s,r,n,a,p,l,o,h,g,c,u,y,d,m,_,v,f,G,b,C){var R=e("esriRFxClippingGeometry",[s,r,n],{declaredClass:"esri.dijit.RasterFunctionEditor.RFxClippingGeometry",templateString:y,clippingTypes:{clippingRaster:"clippingRaster",clippingGeometry:"clippingGeometry",currentExtent:"currentExtent"},useInputFeatureGeometryListenerSet:!1,clippingType:void 0,useInputFeatureGeometry:!1,inputArgs:{},rasterArgs:{},inputLayers:[],map:null,constructor:function(){this.inherited(arguments),this._i18n=d.widgets.rasterFunctionEditor},postCreate:function(){this.inherited(arguments),this.map=this.browseProperties.map,this._setClippingLayerMode(),this._populateRasterSelect(),this._populateFeatureSelect(),this._createDrawToolbar(),this.onClippingLayerModeChange()},startup:function(){this.inherited(arguments),this._attachChangeListener()},destroy:function(){this._clearGeometry(),this._toolbar&&(this._toolbar.deactivate(),this.emit("drawtool-deactivate",{})),this.inherited(arguments)},_attachChangeListener:function(){var e=this.triggerArgs&&this.triggerArgs.Raster;e&&e.input&&e.input.on("change",this._handleRasterChange.bind(this));var t=this.triggerArgs&&this.triggerArgs.ClippingType;t&&t.input&&t.input.on("change",this._handleClippingTypeArgChange.bind(this)),setTimeout(function(){var e=this.triggerArgs&&this.triggerArgs.UseInputFeatureGeometry;e&&e.input&&(this.useInputFeatureGeometry=!!e.input.checked,e.input.on("change",this._handleuseInputFeatureGeometryChange.bind(this)))}.bind(this),0)},_handleRasterChange:function(e){var t=e.name,i=e.detail.widget.getSelectedLayer(t);i&&"2"===this.clippingType&&this._setExtentValue(i)},_handleuseInputFeatureGeometryChange:function(){var e=this.triggerArgs&&this.triggerArgs.UseInputFeatureGeometry;this.useInputFeatureGeometry=e.input.checked,this._setClippingFeatureGeometryArgValue()},_handleClippingTypeArgChange:function(){var e=this.triggerArgs&&this.triggerArgs.ClippingType,t=e.input&&e.input.value;this.clippingType=t;({1:function(){switch(this.clippingLayerMode.value){case this.clippingTypes.clippingRaster:this._setClippingRasterArgValue();break;case this.clippingTypes.clippingGeometry:this._setClippingFeatureGeometryArgValue()}},2:function(){var e=this.triggerArgs&&this.triggerArgs.Raster,t=e&&e.input;if(t&&t.value){var i=t.getSelectedLayer(t.get("value").name);this._setExtentValue(i)}}})[t].bind(this)()},_setClippingLayerMode:function(){var e=this.inputArgs;e&&e.ClippingRaster&&e.ClippingRaster.value?this.clippingLayerMode.set("value",this.clippingTypes.ClippingRaster):this.clippingLayerMode.set("value",this.clippingTypes.ClippingGeometry)},_populateRasterSelect:function(){this.clippingRasterSelect.set("browseProperties",this.browseProperties),this.clippingRasterSelect.set("selectDefault",!1),this.clippingRasterSelect.set("allowScalar",this.allowScalar),this.clippingRasterSelect.set("inputLayers",this.inputLayers),this.own(this.clippingRasterSelect.on("change",a.hitch(this,this._setClippingRasterArgValue)))},_populateFeatureSelect:function(){this.clippingGeometrySelect.set("browseProperties",this.browseProperties),this.clippingGeometrySelect.set("geometryType","polygon"),this.clippingGeometrySelect.set("inputLayers",this.featureLayers),this.clippingGeometrySelect._populateLayerSelect(),this.own(this.clippingGeometrySelect.on("change",a.hitch(this,this._setClippingFeatureGeometryArgValue)))},_createDrawToolbar:function(){this._toolbar=new b(this.map),this.own(this._toolbar.on("draw-end",a.hitch(this,this._addGeometry)))},_addGeometry:function(e){var t=e&&e.geometry;if(t){this._toolbar&&(this._toolbar.deactivate(),this.emit("drawtool-deactivate",{})),this._clearGeometry();var i=new f(f.STYLE_NULL,new G(G.STYLE_SOLID,new p([0,0,0]),4)),s=new C(t,i);this.map.graphics.add(s),this.graphic=s,this.map.setExtent(t.getExtent(),!0),this.geometry=t,this._setClippingGeometryArgValue()}},_clearGeometry:function(){this.graphic&&this.map.graphics.remove(this.graphic)},onClippingLayerModeChange:function(){switch(this.clippingLayerMode.value){case this.clippingTypes.clippingRaster:this._setRasterSelectVisibility(!0),this._setDrawToolVisibility(!1),this._setUseInputFeatureGeometryVisibility(!1),this._setClippingRasterArgValue();break;case this.clippingTypes.clippingGeometry:this._setRasterSelectVisibility(!1),this._setDrawToolVisibility(!0),this._setUseInputFeatureGeometryVisibility(!0),this._setClippingFeatureGeometryArgValue()}},_setRasterSelectVisibility:function(e){var t=e?"table-row":"none";g.set(this.clippingRasterWidgetRow,"display",t)},_setDrawToolVisibility:function(e){var t=e?"table-cell":"none";g.set(this.polyDrawBtnTd,"display",t),g.set(this.clippingGeometryWidgetRow,"display",t),!e&&this._toolbar&&(this._toolbar.deactivate(),this.emit("drawtool-deactivate",{}),this._clearGeometry())},_setUseInputFeatureGeometryVisibility:function(e){var t=e?"table-cell":"none",i=this.triggerArgs.UseInputFeatureGeometry,s=i.uxBlocks&&i.uxBlocks[0];s&&g.set(s,"display",t)},_handlePolyBtnChange:function(e){e?(this.emit("drawtool-activate",{}),this._toolbar.activate(b.POLYGON),this._clearGeometry()):(this._toolbar.deactivate(),this.emit("drawtool-deactivate",{}))},_clearGeometryArgValues:function(){o.forEach(["Extent","ClippingGeometry","ClippingRaster"],(function(e){var t=this.inputArgs&&this.inputArgs[e];t&&(t.value=null)}),this)},_setCurrentExtentArgValue:function(){var e=this.map.extent;if(this.clippingLayerMode.value===this.clippingTypes.currentExtent){var t=this.inputArgs&&this.inputArgs.Extent;t&&(t.value=e.toJson())}},_setClippingGeometryArgValue:function(){var e=this.geometry;if(this.clippingLayerMode.value===this.clippingTypes.clippingGeometry){var t=this.inputArgs&&this.inputArgs.ClippingGeometry;t&&(t.value=e.toJson())}},_setClippingRasterArgValue:function(){if(this.clippingLayerMode.value===this.clippingTypes.clippingRaster){var e=this.clippingRasterSelect.getSelectedLayer(),t=this.inputArgs&&this.inputArgs.ClippingRaster;t&&(t.value=v.getRasterJsonFromLayer(e)),"1"===this.clippingType&&this._setExtentValue(e)}},_setClippingFeatureGeometryArgValue:function(){var e=this.clippingGeometrySelect._getSelectedLayer(),t=this.inputArgs&&this.inputArgs.ClippingGeometry,i=v.getRasterInfoExtent(e);this.useInputFeatureGeometry?this.clippingGeometrySelect.getGeometry().then(function(e){v.projectGeometrySpatialReference(e,a.mixin(e[0].spatialReference,i.spatialReference)).then(function(e){t.value={rings:o.map(e,function(e){return e.rings[0]}.bind(this)),spatialReference:a.mixin(e[0].spatialReference,this.map.spatialReference)}}.bind(this))}.bind(this)):t.value=i,"1"===this.clippingType&&this._setExtentValue(e)},_setExtentValue:function(e){var t=this.inputArgs&&this.inputArgs.Extent;if(t){var i=v.getRasterInfoExtent(e);this.customExtentInput.updateExtent(i),t.value=i}}});return t("extend-esri")&&a.setObject("dijit.RasterFunctionEditor.RFxClippingGeometry",R,i),R}));