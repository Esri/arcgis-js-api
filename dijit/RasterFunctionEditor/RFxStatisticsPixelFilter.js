// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.36/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojox/lang/functional/object","dojo/store/Memory","dojo/data/ObjectStore","dojo/i18n!../../nls/jsapi","dojo/text!./templates/RFxStatisticsPixelFilter.html","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","../../kernel"],(function(t,i,e,s,r,a,n,o,c,h,l,u,g){var S=t("RFxStatisticsPixelFilter",[h,l,u],{widgetsInTemplate:!0,templateString:c,declaredClass:"dijit.RasterFunctionEditor.RFxStatisticsPixelFilter",initialStatisticsStore:[],alteredStatisticsStore:[],storeType:"string",constructor:function(){this.inherited(arguments),this._i18n=o.rasterFunctionEditor},postCreate:function(){this.inherited(arguments),this._setLabels(),this._setInitialStatisticsState(),this._attachTriggerArgsChangeListener(),this._attachStatisticsChangeListener()},_getPersistedValue:function(){var t;return r.keys(this.inputArgs).forEach(function(i){t=this.inputArgs[i].value}.bind(this)),t},_setInputArgValue:function(t){r.keys(this.inputArgs).forEach(function(i){this.inputArgs[i].value="number"===this.storeType?Number(t):t}.bind(this)),this.emit("change",{value:t})},_getFunctionName:function(t){return t.ToolName?t.ToolName.value.replace("_sa",""):t.type.replace("Arguments","")},_isRasterTypeFloat:function(t){return t&&t.toLocaleLowerCase().indexOf("f")>=0},_setStatisticsStore:function(t){var i=this._createObjectStore(t,"key");this._templateStatisticsNode.set("store",i);var s=t[0]&&t[0].key,r=this._getPersistedValue();("number"===this.storeType&&(r=r.toString()),r)&&(e.some(t,(function(t){return t.key===r}))&&(s=r));this._templateStatisticsNode.set("value",s),this._setInputArgValue(s)},_createObjectStore:function(t,i){return new n(new a({data:t,idProperty:i}))},_setLabels:function(){this.inputArgs&&e.forEach(r.keys(this.inputArgs),function(t){var i=this.inputArgs[t];this.fieldLabel.innerHTML=i.displayName,i.input=this._templateStatisticsNode}.bind(this))},_setInitialStatisticsState:function(){var t=this._getFunctionName(this.rfxArgs),s=this.rasterFunctions[t],a=s&&s.rasterFunctionArguments;e.forEach(r.keys(this.inputArgs),(function(t){var e=a[t].domain;e&&"list"===e.type&&(this.initialStatisticsStore=i.clone(this.rasterFunctionEnums[e.enum]))}),this),this.storeType=typeof this.initialStatisticsStore[0].key,e.forEach(this.initialStatisticsStore,(function(t){t.key=t.key.toString()})),this.initialStatisticsStore||console.error("Domain list Enum not set! Check Schema"),e.forEach(Object.keys(this.triggerArgs),function(t){var i=this.triggerAttributes[t].split("|"),s=e.filter(this.initialStatisticsStore,(function(t){return e.some(i,(function(i){return t.key===i}))}));this.alteredStatisticsStore[t]=s}.bind(this)),this._populateStatistics()},_attachStatisticsChangeListener:function(){this._templateStatisticsNode.on("change",this._handleStatisticsChange.bind(this))},_handleStatisticsChange:function(t){this._setInputArgValue(t)},_attachTriggerArgsChangeListener:function(){e.forEach(r.keys(this.triggerArgs),(function(t){this.triggerArgs[t].input.on("change",this._populateStatistics.bind(this))}),this)},_populateStatistics:function(){e.some(Object.keys(this.triggerArgs),function(t){var i=this.triggerArgs[t].input.value;if("NeighborhoodType"===t&&6===parseInt(i,10))return this._setStatisticsStore(this.alteredStatisticsStore[t]),!0}.bind(this))||e.forEach(Object.keys(this.triggerArgs),(function(t){var i=this.triggerArgs[t].input;if(i.declaredClass.indexOf("RFxRasterInput")>-1){var e=i.value;if(e){var s=e.name,r=i.getSelectedLayer(s);if(r&&r.loaded){var a=r.pixelType,n=this._isRasterTypeFloat(a)?this.alteredStatisticsStore[t]:this.initialStatisticsStore;this._setStatisticsStore(n)}else r&&r.on("load",function(i){var e=(r=i.layer?i.layer:i).pixelType,s=this._isRasterTypeFloat(e)?this.alteredStatisticsStore[t]:this.initialStatisticsStore;this._setStatisticsStore(s)}.bind(this))}else this._setStatisticsStore(this.initialStatisticsStore)}}),this)}});return s("extend-esri")&&i.setObject("dijit.RasterFunctionEditor.RFxStatisticsPixelFilter",S,g),S}));