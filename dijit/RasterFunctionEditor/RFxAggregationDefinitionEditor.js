// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/i18n!../../nls/jsapi","dojo/text!./templates/RFxAggregationDefinitionEditor.html","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/Evented","../../kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","./utils","./EditableGridMixin","./RFxGridBase","dijit/form/Select","dijit/form/NumberTextBox","./RFxRasterDimensionSelect"],(function(e,i,t,n,a,r,s,l,o,d,h,u,g,m,c,v,f,_){var D=e("RFxAggregationDefinitionEditor",[o,d,h,u,m],{declaredClass:"esri.dijit.RasterFunctionEditor.RFxAggregationDefinitionEditor",templateString:t,widgetsInTemplate:!0,multidimensionalInfo:null,filterArgListenerAttached:!1,rasterDimensionSelect:null,intervalRangesGrid:null,_intervalKeywordFormTimeUnits:null,_intervalValueFormTimeUnits:null,_dimensionDefinitionSelect:null,_valueIntervalTextbox:null,_intervalKeywordFormTimeUnitsContainer:null,_intervalRangesGridDivContainer:null,_intervalValueDivContainer:null,_intervalValueFormTimeUnitsContainer:null,definitionType:"",selectedDimension:"",widgetState:null,aggregationDefinitionEnum:{ALL:"ALL",INTERVAL_KEYWORD:"INTERVAL_KEYWORD",INTERVAL_VALUE:"INTERVAL_VALUE",INTERVAL_RANGES:"INTERVAL_RANGES"},aggregationDefinition:{ALL:"aggDefTypeAll",INTERVAL_VALUE:"aggDefTypeIntervalValue",INTERVAL_RANGES:"aggDefTypeIntervalRanges"},esriTimeIntervalKeywords:{HOURLY:"esriTimeIntervalKeywordHourly",DAILY:"esriTimeIntervalKeywordDaily",WEEKLY:"esriTimeIntervalKeywordWeekly",DEKADLY:"esriTimeIntervalKeywordDekadly",PENTADLY:"esriTimeIntervalKeywordPentadly",MONTHLY:"esriTimeIntervalKeywordMonthly",QUARTERLY:"esriTimeIntervalKeywordQuarterly",YEARLY:"esriTimeIntervalKeywordYearly",RECURRING_DAILY:"esriTimeIntervalKeywordRecurringDaily",RECURRING_WEEKLY:"esriTimeIntervalKeywordRecurringWeekly",RECURRING_MONTHLY:"esriTimeIntervalKeywordRecurringMonthly",RECURRING_QUARTERLY:"esriTimeIntervalKeywordRecurringQuarterly"},esriTimeUnits:{HOURS:"esriTimeUnitsHours",DAYS:"esriTimeUnitsDays",WEEKS:"esriTimeUnitsWeeks",MONTHS:"esriTimeUnitsMonths",YEARS:"esriTimeUnitsYears"},mdimFilterSetting:void 0,constructor:function(){this.inherited(arguments),this.widgetState={},this._i18n=i.rasterFunctions.enumLabels,this._i18n=n.mixin(this._i18n,i.rasterFunctions.rfxArgs)},postCreate:function(){this.inherited(arguments),this._generateLabelNode(this._i18n.dimensionName,this.aggregationdefBase,!0),this._generateLabelNode(this._i18n.rasterTypeName,this.aggregationdefBase),this._addBreakLine(this.aggregationdefBase);var e=this._generateDropdownOptions(this.aggregationDefinition);this._dimensionDefinitionSelect=this._generateDropdownNode(e,this.aggregationdefBase),this._intervalKeywordFormTimeUnitsContainer=document.createElement("div"),this._intervalKeywordFormTimeUnitsContainer.classList.add("hidden"),this.aggregationdefBase.appendChild(this._intervalKeywordFormTimeUnitsContainer),this._generateLabelNode(this._i18n.dimensionUnit,this._intervalKeywordFormTimeUnitsContainer),this._addBreakLine(this._intervalKeywordFormTimeUnitsContainer);var i=this._generateDropdownOptions(this.esriTimeIntervalKeywords);this._intervalKeywordFormTimeUnits=this._generateDropdownNode(i,this._intervalKeywordFormTimeUnitsContainer),this._intervalValueDivContainer=document.createElement("div"),this._intervalValueDivContainer.classList.add("hidden","esri-rfx-aggregationdef-intervalValue-div"),this.aggregationdefBase.appendChild(this._intervalValueDivContainer),this._generateLabelNode(this._i18n.predictDimensionInterval,this._intervalValueDivContainer),this._valueIntervalTextbox=this._generateTextBoxNode(this._intervalValueDivContainer),this._intervalValueFormTimeUnitsContainer=document.createElement("div"),this._intervalValueFormTimeUnitsContainer.classList.add("hidden"),this._intervalValueDivContainer.appendChild(this._intervalValueFormTimeUnitsContainer),this._generateLabelNode(this._i18n.dimensionUnit,this._intervalValueFormTimeUnitsContainer),this._addBreakLine(this._intervalValueFormTimeUnitsContainer);var t=this._generateDropdownOptions(this.esriTimeUnits);this._intervalValueFormTimeUnits=this._generateDropdownNode(t,this._intervalValueFormTimeUnitsContainer),this._intervalRangesGridDivContainer=document.createElement("div"),this._intervalRangesGridDivContainer.classList.add("hidden","esri-rfx-aggregationdef-intervalRanges-grid"),this.aggregationdefBase.appendChild(this._intervalRangesGridDivContainer),this._generateLabelNode(this._i18n.rangesName,this._intervalRangesGridDivContainer);var a=this.layerArg&&"RasterFunctionTemplate"===this.layerArg.type;if(a||this.layerArg&&this.layerArg.input){this.defaultValue&&"string"==typeof this.defaultValue&&(this.defaultValue=JSON.parse(this.defaultValue));var r,s=this.layerArg.input;this.set("labelAttr","alias"),(a||s.declaredClass.indexOf("RFxRasterInput")>0&&s.value)&&(r=a?g.processRFTAsLayerInput(this.layerArg):s.getSelectedLayer(s.get("value").name)).getMultidimensionalInfo().then(n.hitch(this,(function(e){if(r.multidimensionalInfo=e,this.multidimensionalInfo=g.filterMDInfoIfMosiacRuleIsSet(r),this.defaultValue&&this.defaultValue.dimension&&(this.selectedDimension=this.defaultValue.dimension),this.defaultValue&&this.defaultValue.definitionType){this.definitionType=this.defaultValue&&this.defaultValue.definitionType;var i=this._dimensionDefinitionSelect.getOptions("INTERVAL_KEYWORD");"INTERVAL_KEYWORD"!==this.definitionType||i||this._dimensionDefinitionSelect.addOption({value:"INTERVAL_KEYWORD",label:this._i18n.aggDefTypeIntervalKeyword}),this._dimensionDefinitionSelect.set("value",this.definitionType),this.widgetState[this.definitionType]=this._cloneData(this.defaultValue)}else this.definitionType=this._dimensionDefinitionSelect.value}))).catch(n.hitch(this,(function(e){console.error("Error: Layer does not support multidimensional info")}))),this._dimensionDefinitionSelect.on("change",this._handleDimensionDefinitionSelectChange.bind(this)),this.rasterDimensionSelect=new _({layerArg:this.layerArg,defaultValue:this.defaultValue&&this.defaultValue.dimension},this._rasterDimensionSelectDiv),this.rasterDimensionSelect.on("change",function(e){this._handleDimensionSelectChange(e)}.bind(this)),this.rasterDimensionSelect.on("raster-dimension-select-update",function(e){var i=this.rasterDimensionSelect.value;i||(i=e[0]&&e[0].name),this._handleDimensionSelectChange(i)}.bind(this)),this.rasterDimensionSelect.startup(),!a&&this.layerArg.customFunction&&s.on("change",this.onRasterChange.bind(this)),this.filterArg&&this._attachFilterArgChangeListener()}},onRasterChange:function(){if(this.layerArg&&this.layerArg.input){var e,i=this.layerArg.input;i.declaredClass.indexOf("RFxRasterInput")>0&&i.value&&(e=i.getSelectedLayer(i.get("value").name))&&e.getMultidimensionalInfo().then(n.hitch(this,(function(i){e.multidimensionalInfo=i,this.multidimensionalInfo=g.filterMDInfoIfMosiacRuleIsSet(e),this.rasterDimensionSelect.onRasterChange(),this.widgetState={}}))).catch(n.hitch(this,(function(e){console.error("Error: Layer does not support multidimensional info")}))),e&&i.value||(this.multidimensionalInfo=void 0,this.rasterDimensionSelect.onRasterChange(),this.widgetState={})}},_attachFilterArgChangeListener:function(){this.filterArg.input&&(this.filterArgListenerAttached=!0);var e=this.filterArg.input&&this.filterArg.input.selectedVariables.map(function(e){return"string"==typeof e?e:e.value}.bind(this))||this.filterArg.value&&JSON.parse(this.filterArg.value).variables||[];this.rasterDimensionSelect.setAllowedVariables(e),this.filterArg.input&&this.filterArg.input.on("change",function(e){this.mdimFilterSetting=e,this.rasterDimensionSelect.setAllowedVariables(e.variables)}.bind(this))},_handleDimensionDefinitionSelectChange:function(e){switch(this.definitionType=e,this.defaultValue=this._cloneData(this.widgetState[e]),this.definitionType){case this.aggregationDefinitionEnum.ALL:this._intervalKeywordFormTimeUnitsContainer.classList.add("hidden"),this._intervalValueDivContainer.classList.add("hidden"),this._intervalRangesGridDivContainer.classList.add("hidden");break;case"INTERVAL_KEYWORD":this._updateIntervalKeywordSelect(),this._intervalKeywordFormTimeUnitsContainer.classList.remove("hidden"),this._intervalValueDivContainer.classList.add("hidden"),this._intervalRangesGridDivContainer.classList.add("hidden");break;case this.aggregationDefinitionEnum.INTERVAL_VALUE:this._updateIntervalValueForm(),this._intervalKeywordFormTimeUnitsContainer.classList.add("hidden"),this._intervalValueDivContainer.classList.remove("hidden"),this._intervalRangesGridDivContainer.classList.add("hidden");break;case this.aggregationDefinitionEnum.INTERVAL_RANGES:this._createIntervalRangesGrid(),this._intervalKeywordFormTimeUnitsContainer.classList.add("hidden"),this._intervalValueDivContainer.classList.add("hidden"),this._intervalRangesGridDivContainer.classList.remove("hidden")}},_handleDimensionSelectChange:function(e){this.selectedDimension=e,!this.filterArgListenerAttached&&this.filterArg&&this._attachFilterArgChangeListener();var i="StdTime"!==this.selectedDimension;"StdTime"===e?this._dimensionDefinitionSelect.getOptions("INTERVAL_KEYWORD")||this._dimensionDefinitionSelect.addOption({value:"INTERVAL_KEYWORD",label:this._i18n.aggDefTypeIntervalKeyword}):this._dimensionDefinitionSelect.removeOption("INTERVAL_KEYWORD");switch(this.definitionType){case"INTERVAL_KEYWORD":if(i)return this._dimensionDefinitionSelect.reset(),void this._handleDimensionDefinitionSelectChange("ALL");break;case this.aggregationDefinitionEnum.INTERVAL_VALUE:this._updateIntervalValueForm();break;case this.aggregationDefinitionEnum.INTERVAL_RANGES:this._createIntervalRangesGrid()}},_createIntervalRangesGrid:function(){var e=[this._i18n.minValue,this._i18n.maxValue],i=this._getGridSchema(["MinValue","MaxValue"],["dropdown","dropdown"],e),t=this._getGridData(),n=this._getDefaultValueObject(t[0]);this.intervalRangesGrid&&this.intervalRangesGrid.destroy(),this._intervalRangesGridDiv=document.createElement("div"),this._intervalRangesGridDivContainer.appendChild(this._intervalRangesGridDiv),this.intervalRangesGrid=new c({isForMultidimensional:!0,schema:i,data:t,hasIdColumn:!0,isExtensible:!0,defaultBlankObject:n},this._intervalRangesGridDiv),this.intervalRangesGrid.keepScrollPosition=!0,this.intervalRangesGrid.on("grid-data-change",this._handleIntervalRangesGridChange.bind(this))},_handleIntervalRangesGridChange:function(){this.defaultValue=this._getValueAttr(!0),this.emit("change")},_updateIntervalKeywordSelect:function(){var e=this.defaultValue&&this.defaultValue.intervalKeyword;e&&this._intervalKeywordFormTimeUnits.set("value",e)},_updateIntervalValueForm:function(){var e=this.defaultValue&&this.defaultValue.intervalValue||3,i=this.defaultValue&&this.defaultValue.units||"HOURS";this._valueIntervalTextbox.set("value",e),"StdTime"===this.selectedDimension?(this._intervalValueFormTimeUnitsContainer.classList.remove("hidden"),this._intervalValueFormTimeUnits.set("value",i)):this._intervalValueFormTimeUnitsContainer.classList.add("hidden")},_getGridSchema:function(e,i,t){return e.map((function(e,n){return{label:t[n],name:e,dataType:i[n]}}))},_getGridData:function(){var e=[{MinValue:[],MaxValue:[]}],i=this.layerArg&&"RasterFunctionTemplate"===this.layerArg.type;if(!(i||this.layerArg&&this.layerArg.input))return e;var t=this.layerArg.input;return this.set("labelAttr","alias"),i||t.declaredClass.indexOf("RFxRasterInput")>0&&t.value?this._createIntervalRangesDataObject():e},_getDefaultValueObject:function(e){var i=this._cloneData(e),t={label:" ",value:"",selected:!0,disabled:!0};return Object.keys(i).forEach((function(e,n){i[e].unshift(t)}),this),i},_createIntervalRangesDataObject:function(){var e=[],i=[],t=[],n=[{MinValue:[],MaxValue:[]}];if(!this.multidimensionalInfo)return n;var a=this.multidimensionalInfo,r=a&&a.variables,s=this.filterArg&&this.filterArg.input&&this.filterArg.input.selectedVariables||this.filterArg&&this.filterArg.value&&JSON.parse(this.filterArg.value).variables||[],l=this.selectedDimension;if(!r)return n;if(this.defaultValue&&"string"==typeof this.defaultValue&&(this.defaultValue=JSON.parse(this.defaultValue)),this.defaultValue&&this.defaultValue.dimension&&this.defaultValue.minValues.length>0&&this.defaultValue.maxValues.length>0)var o=this.defaultValue.minValues,d=this.defaultValue.maxValues;else o=[l];return o.forEach((function(n,r){var h=this._getDimensionValues(a,s,l);i=this._cloneData(h.startValueOptions),t=this._cloneData(h.endValueOptions);var u=o&&o[r],g=d&&d[r];this._makeDropdownSelection(i,u),this._makeDropdownSelection(t,g),e.push(this._cloneData({MinValue:i,MaxValue:t}))}),this),e},_parseIntervalRangesGridData:function(e,i){var t=[],n=[];return e.forEach((function(e){if("*"!==e.idNum){var a=e.MinValue.filter((function(e){return e.selected})),r=e.MaxValue.filter((function(e){return e.selected}));if(1===a.length&&1===r.length){var s=a[0].value,l=r[0].value;(i||""!==s&&""!==l)&&(t.push(s),n.push(l))}}})),{MinValue:t,MaxValue:n}},_getDimensionValues:function(e,i,t){var n=g.getVariables({multiDimensionalData:e,selectedVariables:i}),a=g.getDimensions({variables:n,selectedDimension:t});a=g.applyMultidimensionalDefinitionFilter(a,this.mdimFilterSetting);var r,s,l=g.getFormattedDimensionValues(a);if(g.dimensionHasRanges(a)){var o=g.getFormattedDimensionRanges(l);r=o.min,s=o.max}else r=this._cloneData(l),s=this._cloneData(l);return{startValueOptions:r,endValueOptions:s}},_getDateInMilliseconds:function(e){return new Date(e+"Z").getTime()},_removeDuplicatesFromArray:function(e){return a.filter(e,(function(e,i,t){return a.indexOf(t,e)===i}))},_cloneData:function(e){return n.clone(e)},_itemInArray:function(e,i){return e.some((function(e){return e.label===i.label}))},_makeDropdownSelection:function(e,i){var t=!1;if(e.forEach((function(e){e.value===i?(e.selected=!0,t=!0):e.selected=!1})),!t){e.unshift({label:" ",value:"",selected:!0,disabled:!0})}},_addBreakLine:function(e){var i=document.createElement("br");e.appendChild(i)},_generateLabelNode:function(e,i,t){var n=document.createElement("label");n.innerHTML=e,n.classList.add("esri-rfx-args-editor__tr--arg-name","esri-paddingTop-5"),t?i.prepend(n):i.appendChild(n)},_generateDropdownNode:function(e,i){var t=document.createElement("div");return i.appendChild(t),new v({options:e},t)},_generateTextBoxNode:function(e){var i=document.createElement("div");return e.appendChild(i),new f(null,i)},_generateDropdownOptions:function(e){return Object.keys(e).map(function(i){return{value:i,label:this._i18n[e[i]]}}.bind(this))},_getWidgetState:function(e){e||(e=!1);var i,t=this._dimensionDefinitionSelect.value,n={definitionType:t,dimension:this.rasterDimensionSelect.get("value")};switch(t){case"INTERVAL_KEYWORD":n.intervalKeyword=this._intervalKeywordFormTimeUnits.get("value");break;case this.aggregationDefinitionEnum.INTERVAL_VALUE:n.intervalValue=this._valueIntervalTextbox.get("value"),"StdTime"===n.dimension&&(n.units=this._intervalValueFormTimeUnits.get("value"));break;case this.aggregationDefinitionEnum.INTERVAL_RANGES:var a=this.intervalRangesGrid.getStoreValue();i=this._parseIntervalRangesGridData(a,e),n.minValues=i.MinValue,n.maxValues=i.MaxValue}return this.widgetState[t]=this._cloneData(n),n},_getValueAttr:function(){return JSON.stringify(this._getWidgetState(!1))}});return r("extend-esri")&&n.setObject("dijit.RasterFunctionEditor.RFxAggregationDefinitionEditor",D,l),D}));