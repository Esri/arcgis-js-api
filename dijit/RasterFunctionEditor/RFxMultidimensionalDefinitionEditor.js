// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/i18n!../../nls/jsapi","dojo/text!./templates/RFxMultidimensionalDefinitionEditor.html","dojo/has","dojo/Evented","../../kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","./EditableGridMixin","./RFxGridBase","dijit/form/Select","dijit/form/NumberTextBox","./RFxRasterVariableGrid"],(function(e,i,t,n,a,s,r,o,l,d,u,h,m,f,c,_,g){var D=e("RFxMultidimensionalDefinitionEditor",[l,d,u,h,m],{declaredClass:"esri.dijit.RasterFunctionEditor.RFxMultidimensionalDefinitionEditor",templateString:a,widgetsInTemplate:!0,rasterVariableGrid:null,byValuesGrid:null,byRangesGrid:null,_dimensionDefinitionSelect:null,_iterationFormDimensionSelect:null,_iterationFormStartOfFirstIterationSelect:null,_iterationFormEndOfFirstIterationSelect:null,_iterationFormTimeUnitsContainer:null,_iterationFormStepTextbox:null,_iterationFormTimeUnits:null,selectedVariables:[],definitionType:"",widgetState:{},dimensionDefinition:{ALL:"ALL",BY_VALUES:"BY_VALUES",BY_RANGES:"BY_RANGES",BY_ITERATION:"BY_ITERATION"},dimensionDefinitionLabels:{ALL:"mdimDefTypeAll",BY_VALUES:"mdimDefTypeByValues",BY_RANGES:"mdimDefTypeByRanges",BY_ITERATION:"mdimDefTypeByIteration"},esriTimeUnitLabels:{HOURS:"esriTimeUnitsHours",DAYS:"esriTimeUnitsDays",WEEKS:"esriTimeUnitsWeeks",MONTHS:"esriTimeUnitsMonths",YEARS:"esriTimeUnitsYears"},stdTimeDimension:"StdTime",defaultWidgetDataByValuesGrid:[{Dimension:[],Value:[]}],defaultWidgetDataByIterationForm:{dimension:[],startValue:[],endValue:[],stepValue:3,units:"HOURS"},defaultWidgetDataByRangedGrid:[{Dimension:[],MinValue:[],MaxValue:[]}],constructor:function(){this.inherited(arguments),this.widgetState={},this._i18n=n.rasterFunctions.enumLabels,this._i18n=i.mixin(this._i18n,n.rasterFunctions.rfxArgs)},postCreate:function(){this.inherited(arguments),this._generateLabelNode(this._i18n.mdimDefinition,this._dimensionDefinitionDivContainer);var e=this._generateDropdownOptions(this.dimensionDefinitionLabels);this._dimensionDefinitionSelect=this._generateDropdownNode(e,this._dimensionDefinitionDivContainer),this._generateLabelNode(this._i18n.predictDimensionValues,this._byValuesGridDivContainer),this._generateLabelNode(this._i18n.rangesName,this._byRangesGridDivContainer),this._generateLabelNode(this._i18n.dimensionName,this._byIterationFormDiv),this._iterationFormDimensionSelect=this._generateDropdownNode([],this._byIterationFormDiv),this._addBreakLine(this._byIterationFormDiv),this._generateLabelNode(this._i18n.iterationStart,this._byIterationFormDiv),this._iterationFormStartOfFirstIterationSelect=this._generateDropdownNode([],this._byIterationFormDiv),this._addBreakLine(this._byIterationFormDiv),this._generateLabelNode(this._i18n.iterationEnd,this._byIterationFormDiv),this._iterationFormEndOfFirstIterationSelect=this._generateDropdownNode([],this._byIterationFormDiv),this._addBreakLine(this._byIterationFormDiv),this._generateLabelNode(this._i18n.stepName,this._byIterationFormDiv),this._addBreakLine(this._byIterationFormDiv),this._iterationFormStepTextbox=this._generateTextBoxNode(this._byIterationFormDiv),this._iterationFormTimeUnitsContainer=document.createElement("div"),this._iterationFormTimeUnitsContainer.classList.add("hidden"),this._byIterationFormDiv.appendChild(this._iterationFormTimeUnitsContainer),this._generateLabelNode(this._i18n.dimensionUnit,this._iterationFormTimeUnitsContainer),this._addBreakLine(this._iterationFormTimeUnitsContainer);var t=this._generateDropdownOptions(this.esriTimeUnitLabels);if(this._iterationFormTimeUnits=this._generateDropdownNode(t,this._iterationFormTimeUnitsContainer),this.layerArg&&this.layerArg.input){var n,a=this.layerArg.input;this.set("labelAttr","alias"),a.declaredClass.indexOf("RFxRasterInput")>0&&a.value&&(n=a.getSelectedLayer(a.get("value").name)).on("load",i.hitch(this,(function(){n.getMultidimensionalInfo().then(i.hitch(this,(function(e){n.multidimensionalInfo=e,this.defaultValue&&"string"==typeof this.defaultValue&&(this.defaultValue=JSON.parse(this.defaultValue)),this.selectedVariables=this.defaultValue&&this.defaultValue.variables,this.defaultValue&&this.defaultValue.definitionType?(this.definitionType=this.defaultValue&&this.defaultValue.definitionType,this._dimensionDefinitionSelect.set("value",this.definitionType),this.widgetState[this.definitionType]=this.defaultValue):this.definitionType=this._dimensionDefinitionSelect.value})))}))),this._dimensionDefinitionSelect.on("change",this._handleDimensionDefinitionSelectChange.bind(this)),this.rasterVariableGrid=new g({layerArg:this.layerArg,defaultValue:this.defaultValue&&this.defaultValue.variables},this._rasterVariableDiv),this.rasterVariableGrid.startup(),this.rasterVariableGrid.on("variable-grid-update",function(e){this._handleRasterVariableGridChange(e)}.bind(this))}},onRasterChange:function(){if(this.layerArg&&this.layerArg.input){var e,t=this.layerArg.input;t.declaredClass.indexOf("RFxRasterInput")>0&&t.value&&(e=t.getSelectedLayer(t.get("value").name)).on("load",i.hitch(this,(function(){e.getMultidimensionalInfo().then(i.hitch(this,(function(i){e.multidimensionalInfo=i,this.rasterVariableGrid.onRasterChange(),this.widgetState={}})))})))}},_handleDimensionDefinitionSelectChange:function(e){switch(this.definitionType=e,this.defaultValue=this.widgetState[e],this.definitionType){case this.dimensionDefinition.BY_VALUES:this._createByValuesGrid(),this._byValuesGridDivContainer.classList.remove("hidden"),this._byRangesGridDivContainer.classList.add("hidden"),this._byIterationDivContainer.classList.add("hidden");break;case this.dimensionDefinition.BY_RANGES:this._createByRangesGrid(),this._byValuesGridDivContainer.classList.add("hidden"),this._byRangesGridDivContainer.classList.remove("hidden"),this._byIterationDivContainer.classList.add("hidden");break;case this.dimensionDefinition.BY_ITERATION:this._configureByIterationForm(),this._byValuesGridDivContainer.classList.add("hidden"),this._byRangesGridDivContainer.classList.add("hidden"),this._byIterationDivContainer.classList.remove("hidden");break;default:this._byValuesGridDivContainer.classList.add("hidden"),this._byRangesGridDivContainer.classList.add("hidden"),this._byIterationDivContainer.classList.add("hidden")}},_handleRasterVariableGridChange:function(e){var i=e.filter((function(e){return e.Select}));switch(this.selectedVariables=i,this.definitionType){case this.dimensionDefinition.BY_VALUES:this._createByValuesGrid();break;case this.dimensionDefinition.BY_RANGES:this._createByRangesGrid();break;case this.dimensionDefinition.BY_ITERATION:this._configureByIterationForm()}},_getDimensionNameOfVariables:function(e,i){var t=(e&&e.variables).filter((function(e){return i.some((function(i){return i===e.name||i.value===e.name}))})),n=[];return t.forEach(function(e){e.dimensions.forEach(function(e){var i={label:e.name+"",value:e.name+"",selected:!1,disabled:!1};this._itemInArray(n,i)||n.push(i)}.bind(this))}.bind(this)),n},_getDimensionValues:function(e,i){var t=[];return e.variables.forEach(function(e){e.dimensions.forEach(function(e){e.name===i&&e.values.forEach(function(i){var n={label:i+"",value:i+"",selected:!1,disabled:!1};if(e.name===this.stdTimeDimension){var a=new Date(Number(n.value)).toISOString().slice(0,22);n.label=a,n.value=a}this._itemInArray(t,n)||t.push(n)}.bind(this))}.bind(this))}.bind(this)),t},_createByValuesGrid:function(){var e=[this._i18n.dimensionName,this._i18n.valueName],i=this._getGridSchema(["Dimension","Value"],["dropdown","dropdown","dropdown"],e),t=this._getGridStoreData(),n=this._getDefaultValueObject(t[0]);this.byValuesGrid&&this.byValuesGrid.destroy(),this._byValuesGridDiv=document.createElement("div"),this._byValuesGridDivContainer.appendChild(this._byValuesGridDiv),this.byValuesGrid=new f({schema:i,data:t,hasIdColumn:!0,isExtensible:!0,defaultBlankObject:n},this._byValuesGridDiv),this.byValuesGrid.keepScrollPosition=!0,this.byValuesGrid.on("grid-data-change",this._handleByValuesGridChange.bind(this))},_handleByValuesGridChange:function(){this.defaultValue=this._getWidgetState(!0);var e=this._getGridStoreData();this.byValuesGrid.updateStoreValue(e),this.defaultValue=this._getWidgetState(!0)},_createByRangesGrid:function(){var e=[this._i18n.dimensionName,this._i18n.minValue,this._i18n.maxValue],i=this._getGridSchema(["Dimension","MinValue","MaxValue"],["dropdown","dropdown","dropdown"],e),t=this._getGridStoreData(),n=this._getDefaultValueObject(t[0]);this.byRangesGrid&&this.byRangesGrid.destroy(),this._byRangesGridDiv=document.createElement("div"),this._byRangesGridDivContainer.appendChild(this._byRangesGridDiv),this.byRangesGrid=new f({schema:i,data:t,hasIdColumn:!0,isExtensible:!0,defaultBlankObject:n},this._byRangesGridDiv),this.byRangesGrid.keepScrollPosition=!0,this.byRangesGrid.on("grid-data-change",this._handlByRangesGridChange.bind(this))},_handlByRangesGridChange:function(){this.defaultValue=this._getWidgetState(!0);var e=this._getGridStoreData();this.byRangesGrid.updateStoreValue(e),this.defaultValue=this._getWidgetState(!0)},_configureByIterationForm:function(){var e=this._getGridStoreData();this._iterationFormDimensionSelect.set("options",e.dimension),this._iterationFormStartOfFirstIterationSelect.set("options",e.startValue),this._iterationFormEndOfFirstIterationSelect.set("options",e.endValue),this._iterationFormStepTextbox.set("value",e.stepValue),this._iterationFormTimeUnits.set("value",e.units);var i=e.dimension.filter((function(e){return e.selected}))[0],t=e.startValue.filter((function(e){return e.selected}))[0],n=e.endValue.filter((function(e){return e.selected}))[0];this._iterationFormDimensionSelect.set("value",i&&i.value),this._iterationFormStartOfFirstIterationSelect.set("value",t&&t.value),this._iterationFormEndOfFirstIterationSelect.set("value",n&&n.value),i&&i.value===this.stdTimeDimension?this._iterationFormTimeUnitsContainer.classList.remove("hidden"):this._iterationFormTimeUnitsContainer.classList.add("hidden"),this._iterationFormDimensionSelect.on("change",this._handleByIterationDimensionChange.bind(this))},_handleByIterationDimensionChange:function(){this.defaultValue=this._getWidgetState(!1),this._configureByIterationForm(),this.defaultValue=this._getWidgetState(!1)},_getGridStoreData:function(){var e=this._getGridStoreDataSwitch();if(!e)switch(this.definitionType){case this.dimensionDefinition.BY_VALUES:return this.defaultWidgetDataByValuesGrid;case this.dimensionDefinition.BY_RANGES:return this.defaultWidgetDataByRangedGrid;case this.dimensionDefinition.BY_ITERATION:return this.defaultWidgetDataByIterationForm}return e},_getGridStoreDataSwitch:function(){if(this.layerArg&&this.layerArg.input){var e,i,t=this.layerArg.input;if(t.declaredClass.indexOf("RFxRasterInput")>0&&t.value){var n,a=t.get("value");switch(i=a&&(a.name||a.datasetName.name),e=t.getSelectedLayer(i),this.definitionType){case this.dimensionDefinition.BY_VALUES:n=this._createByValuesDataObject(e);break;case this.dimensionDefinition.BY_RANGES:n=this._createByRangesDataObject(e);break;case this.dimensionDefinition.BY_ITERATION:n=this._createByIterationFormObject(e)}return n}}},_createByValuesDataObject:function(e){var i=[],t=[],n=[];if(!e||!e.loaded)return this.defaultWidgetDataByValuesGrid;var a=e.multidimensionalInfo;if(!(a&&a.variables))return this.defaultWidgetDataByValuesGrid;if(this.defaultValue&&this.defaultValue.dimensions){var s=this.selectedVariables,r=this.defaultValue.dimensions,o=this.defaultValue&&this.defaultValue.values;t=this._getDimensionNameOfVariables(a,s),r.forEach((function(e,s){this._isItemInDropdown(t,e)||(e=t[0].value),n=this._getDimensionValues(a,e),this._makeDropdownSelection(t,e),this._makeDropdownSelection(n,o[s]),i.push(this._cloneData({Dimension:t,Value:n}))}),this)}else{var l=(t=this._getDimensionNameOfVariables(a,this.selectedVariables))[0]?t[0].value:"";n=this._getDimensionValues(a,l),i.push({Dimension:t,Value:n})}return i},_createByRangesDataObject:function(e){var i=[],t=[],n=[],a=[];if(!e||!e.loaded)return this.defaultWidgetDataByRangedGrid;var s=e.multidimensionalInfo;if(!(s&&s.variables))return this.defaultWidgetDataByRangedGrid;if(this.defaultValue&&this.defaultValue.dimensions){var r=this.selectedVariables,o=this.defaultValue.dimensions,l=this.defaultValue&&this.defaultValue.minValues,d=this.defaultValue&&this.defaultValue.maxValues;t=this._getDimensionNameOfVariables(s,r),o.forEach((function(e,r){this._isItemInDropdown(t,e)||(e=t[0].value),n=this._getDimensionValues(s,e),a=this._getDimensionValues(s,e),this._makeDropdownSelection(t,e),this._makeDropdownSelection(n,l[r]),this._makeDropdownSelection(a,d[r]),i.push(this._cloneData({Dimension:t,MinValue:n,MaxValue:a}))}),this)}else{var u=(t=this._getDimensionNameOfVariables(s,this.selectedVariables))[0]?t[0].value:"";n=this._getDimensionValues(s,u),a=this._getDimensionValues(s,u),i.push({Dimension:t,MinValue:n,MaxValue:a})}return i},_createByIterationFormObject:function(e){var i,t,n,a;if(!e||!e.loaded)return this.defaultWidgetDataByIterationForm;var s=e.multidimensionalInfo;if(!(s&&s.variables))return this.defaultWidgetDataByIterationForm;if(this.defaultValue&&this.defaultValue.dimension){var r=this.selectedVariables,o=this.defaultValue.dimension,l=this.defaultValue.startValue,d=this.defaultValue.endValue,u=this.defaultValue.stepValue,h=this.defaultValue.units;t=this._getDimensionNameOfVariables(s,r),n=this._getDimensionValues(s,o),a=this._getDimensionValues(s,o),this._makeDropdownSelection(t,o),this._makeDropdownSelection(n,l),this._makeDropdownSelection(a,d),i={dimension:t,startValue:n,endValue:a,stepValue:u,units:h}}else{var m=(t=this._getDimensionNameOfVariables(s,this.selectedVariables))[0]?t[0].value:"";n=this._getDimensionValues(s,m),a=this._getDimensionValues(s,m);var f=e.timeInfo&&e.timeInfo.interval;this._makeDropdownSelection(t,m),i={dimension:t,startValue:n,endValue:a,stepValue:f&&f.value,units:f&&f.unit&&f.unit.toUpperCase()}}return i},_getGridSchema:function(e,i,t){return e.map((function(e,n){return{label:t[n],name:e,dataType:i[n]}}))},_getDefaultValueObject:function(e){var i=this._cloneData(e),t={label:" ",value:"",selected:!0,disabled:!0};return Object.keys(i).forEach((function(e,n){0!==n&&(i[e]=[]),i[e].unshift(t)}),this),i},_cloneData:function(e){return i.clone(e)},_itemInArray:function(e,i){return e.some((function(e){return e.label===i.label}))},_makeDropdownSelection:function(e,i){var t=!1;if(e.forEach((function(e){e.value===i?(e.selected=!0,t=!0):e.selected=!1})),!t){e.unshift({label:" ",value:"",selected:!0,disabled:!0})}},_isItemInDropdown:function(e,i){return e.some((function(e){if(e.value===i)return!0}))},_generateLabelNode:function(e,i){var t=document.createElement("label");t.innerHTML=e,t.classList.add("esri-rfx-args-editor__tr--arg-name","esri-paddingTop-5"),i.appendChild(t)},_generateDropdownNode:function(e,i){var t=document.createElement("div");return i.appendChild(t),new c({options:e},t)},_generateTextBoxNode:function(e){var i=document.createElement("div");return e.appendChild(i),new _(null,i)},_generateDropdownOptions:function(e){return Object.keys(e).map(function(i){return{value:i,label:this._i18n[e[i]]}}.bind(this))},_parseByValuesGridData:function(e,i){var t=[],n=[];return e.forEach((function(e){if("*"!==e.idNum){var a=e.Dimension.filter((function(e){return e.selected})),s=e.Value.filter((function(e){return e.selected}));if(1===a.length&&1===s.length){var r=a[0].value,o=s[0].value;(i||""!==r&&""!==o)&&(t.push(r),n.push(o))}}})),{dimensions:t,values:n}},_parseByRangesGridData:function(e,i){var t=[],n=[],a=[];return e.forEach((function(e){if("*"!==e.idNum){var s=e.Dimension.filter((function(e){return e.selected})),r=e.MinValue.filter((function(e){return e.selected})),o=e.MaxValue.filter((function(e){return e.selected}));if(1===s.length&&1===r.length&&1===o.length){var l=s[0].value,d=r[0].value,u=o[0].value;(i||""!==l&&""!==d&&""!==u)&&(t.push(l),n.push(d),a.push(u))}}})),{Dimension:t,MinValue:n,MaxValue:a}},_addBreakLine:function(e){var i=document.createElement("br");e.appendChild(i)},_getWidgetState:function(e){e||(e=!1);var i,t=this._dimensionDefinitionSelect.value,n={definitionType:t,variables:this.rasterVariableGrid.get("value")};switch(t){case this.dimensionDefinition.BY_VALUES:var a=this.byValuesGrid.getStoreValue();i=this._parseByValuesGridData(a,e),n.dimensions=i.dimensions,n.values=i.values;break;case this.dimensionDefinition.BY_RANGES:var s=this.byRangesGrid.getStoreValue();i=this._parseByRangesGridData(s,e),n.dimensions=i.Dimension,n.minValues=i.MinValue,n.maxValues=i.MaxValue;break;case this.dimensionDefinition.BY_ITERATION:n.dimension=this._iterationFormDimensionSelect.get("value"),n.startValue=this._iterationFormStartOfFirstIterationSelect.get("value"),n.endValue=this._iterationFormEndOfFirstIterationSelect.get("value"),n.stepValue=this._iterationFormStepTextbox.get("value"),n.dimension===this.stdTimeDimension&&(n.units=this._iterationFormTimeUnits.get("value"))}return this.widgetState[t]=n,n},_getValueAttr:function(){return this._getWidgetState(!1)}});return s("extend-esri")&&i.setObject("dijit.RasterFunctionEditor.RFxMultidimensionalDefinitionEditor",D,o),D}));