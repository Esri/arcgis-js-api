// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/store/Memory","dojo/keys","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","esri/domUtils","../../kernel","./utils","../analysis/utils","../analysis/mixins/browselayers/BrowseLayerMixin","../analysis/ItemTypes","dojo/i18n!../../nls/jsapi","dojo/text!./templates/RFxRasterInput.html"],(function(t,e,i,a,s,o,r,l,n,h,u,m,c,d,b,_,x){var f=t([r,l,n,d],{templateString:x,declaredClass:"esri.dijit.RasterFunctionEditor.RFxRasterInput",allowScalar:!1,selectDefault:!0,showBrowseLayers:!0,useArcGISComponents:!0,constructor:function(t){e.mixin(this,t),this.inherited(arguments),this._i18n=_.widgets.rasterFunctionEditor},startup:function(){this._comboBox.set("required",this.required),this._comboBox.set("validator",e.hitch(this,this.validator)),this._comboBox.set("placeHolder",this._i18n.rfxRasterInput.selectLayer),this._comboBox.on("keydown",this._handleKeyDown.bind(this)),this.on("add-ready-to-use-layer",e.hitch(this,(function(t){this.emit("add-layer",t)}))),this.inherited(arguments),this.rfxVariable?this._setRfxVariableAttr(this.rfxVariable):this.value&&this._setValueAttr(this.value)},validator:function(t,e){if(""===t&&this.required)return!1;var i=this._getStoreItems(t);return!!(i&&i.length>0)||(this.allowScalar?""!==t&&!isNaN(+t):this._getFormattedValue(this.value)===t||(!(!this.rfxVariable||this._getFormattedValueFromVariable(this.rfxVariable)!==t)||void 0))},_handleComboBoxChange:function(t){return"separator"===t?(this._comboBox.reset(),void(this.value=void 0)):"browselayers"===t?(this.set("allowedItemTypes",[b.IS]),this.defaultItemTypes=[],void this._createBrowseItems({},{layerTypes:[b.IS]},this._comboBox)):void(this.rfxVariable&&this._getFormattedValueFromVariable(this.rfxVariable)===t||this.value&&t===this.value.name||(this.value=this.get("value"),this.rfxVariable&&(!this.rfxVariable.value||this.rfxVariable.value&&this.rfxVariable.value.name!==t)&&(this.rfxVariable.value=this.value),this.emit("change",e.clone(this.value))))},getSelectedLayer:function(t){if(null!=(t=t||this._comboBox&&this._comboBox.value)&&this._comboBox){var e;e="object"==typeof t?t:{name:t};var i=this._comboBox.store&&this._comboBox.store.query(e),a=i&&i[0];if(a)return this.inputLayers[a.id]}},_getFormattedValue:function(t){return null==t?"":this.rfxVariable&&this.rfxVariable.type&&"scalar"===this.rfxVariable.type.toLowerCase()&&!isNaN(t)?String(t):t.type&&"scalar"===t.type.toLowerCase()?String(t.value):t.name?t.name:t.datasetName&&t.datasetName.name?t.datasetName.name:void 0},_getFormattedValueFromVariable:function(t){if(t){var e=m.getArgRFT(t);return e?"<"+(e.function&&e.function.name)+"."+this._i18n.rfxArgsEditor.outputRaster+">":"<"+this._i18n.rfxRasterInput.rfxVariable+": "+t.name+">"}},_setInputLayersAttr:function(t){this.inputLayers=t&&t.map((function(t){return t})),this._initStore()},_setAllowScalarAttr:function(t){this.allowScalar=!!t,this.allowScalar||(this._comboBox.textbox.readOnly=!0)},_setRfxVariableAttr:function(t){if(this._set("rfxVariable",t),t){if(t.value)return this._setValueAttr(t.value);this._comboBox.attr("value",this._getFormattedValueFromVariable(t),!1),m.getArgRFT(t)&&this._comboBox.set("disabled",!0)}},_setValueAttr:function(t){if(t){var e=this._getFormattedValue(t);if(!this.getSelectedLayer(t.name)&&t.url){var i=m.getArcGISImageServiceLayerItem(t);this.inputLayers.push(i),this._initStore()}this._comboBox.set("value",e),this.value=t}else this._comboBox.attr("value","",!1)},_addRFTLayerValue:function(t){this.inputLayers.push(t);var e=this._comboBox.get("store"),i=e&&e.data,a=i.splice(i.length-2,2),o={id:i.length,label:t.name,name:t.name,url:t.url};i.push(o),i=i.concat(a);var r=new s({data:i,idProperty:"id"});this._comboBox.set("store",r),this._comboBox.set("value",o.name)},_getValueAttr:function(){var t=this._comboBox&&this._comboBox.value;!t&&this.value&&this.value.name&&(t=this.value.name),"string"==typeof t&&t.length>0&&(t=t.trim());var e=this.getSelectedLayer(t);return e?(h.show(this._zoomToRaster),"browselayers"===e.id?e:m.getRasterJsonFromLayer(e)):this.rfxVariable&&this._getFormattedValueFromVariable(this.rfxVariable)===t?void 0:this.allowScalar&&this._comboBox.isValid()?(h.hide(this._zoomToRaster),{type:"Scalar",value:+t}):this.value},_getStoreItems:function(t){return this._comboBox.store&&this._comboBox.store.query({name:t})},_initStore:function(){var t=[];i.forEach(this.inputLayers,(function(e,i){t.push({id:i,name:e.name,label:e.name,url:e.url})}),this);var e=new s({data:t,idProperty:"id"});this._comboBox.set("labelAttr","label"),this._comboBox.set("labelType","html"),this._comboBox.set("store",e),this._comboBox.reset(),c.addReadyToUseLayerOption(this,[this._comboBox]),this.selectDefault&&t.length&&(void 0===this.value||null===this.value)&&this.set("value",t[0])},_handleBrowseItemsSelect:function(t){t&&t.selection&&c.addAnalysisReadyLayer({item:t.selection,layers:this.inputLayers,layersSelect:this._comboBox,posIncrement:1,browseDialog:t.dialog||this._browsedlg,widget:this})},_handleKeyDown:function(t){switch(t.keyCode){case o.BACKSPACE:this._comboBox.reset(),this.value=void 0,this._emitOnChange&&this.emit("change",e.clone(this.value))}},_setBrowsePropertiesAttr:function(t){t&&(this.isSingleTenant=!0,this.map=t.map?t.map:this.map,this.portalUrl=t.portalUrl?t.portalUrl:this.portalUrl,this.portalSelf=t.portalSelf?t.portalSelf:this.portalSelf)},_onZoomToRasterClick:function(){var t=this._comboBox.value,e=this.getSelectedLayer(t);e&&e.initialExtent&&this.emit("zoom-to-extent",{layerExtent:e.initialExtent})}});return a("extend-esri")&&e.setObject("dijit.RasterFunctionEditor.RFxRasterInput",f,u),f}));