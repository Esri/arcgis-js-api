// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/has","../../kernel","dojo/text!../../layers/support/rasterFunctionResources.json","dojo/i18n!../../nls/jsapi","dgrid/OnDemandGrid","dgrid/Keyboard","dgrid/editor","dojo/store/Memory","dojo/data/ItemFileReadStore","dojo/store/Observable","dojo/on","dojo/_base/lang","dojo/Evented","dojo/_base/array","dojo/json","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/form/NumberTextBox","dijit/form/Select","dijit/form/ComboBox","dijit/form/Button","esri/lang","./EditableGridMixin","./RFxColorInput","./RFxFieldSelect","./RFxScaleSelect","./RFxRasterInput","./utils"],(function(e,t,i,a,r,s,o,n,d,l,h,c,u,g,b,f,_,p,m,v,x,y,j,w,A,C,T,E,R,O){var F=e([s,o]),G=f.parse(a).dataTypes,S=e("RFxGridBase",[_,p,m,g,A],{templateString:"<div class='esriRFxGridBase'><div data-dojo-attach-point='gridNode'></div></div>",declaredClass:"esri.dijit.RasterFunctionEditor.RFxGridBase",schema:[],data:[],hasIdColumn:!1,idProperty:void 0,isExtensible:!0,isEditable:!0,isForMultidimensional:!1,hasCheckBoxColumn:!1,editorDataTypes:[G.string,G.boolean,G.long,G.double,G.longArray,G.doubleArray],renderCellDataTypes:[G.color,G.field,G.scale,G.raster,"dropdown","combobox","delete"],value:[],_store:null,_grid:null,showHeader:!0,constructor:function(){this.inherited(arguments),this._i18n=r.rasterFunctions.rfxArgs},postCreate:function(){this.inherited(arguments),this._initStore(this.data),this._initGrid(this.schema),this.attachGridEvents(),this.on("change",u.hitch(this,this._onGridChange))},_getGridColumns:function(e){var t=[];if(this.hasIdColumn){var i={label:"ID",field:"idNum",sortable:!1};t.push(i)}return e.forEach((function(e){var a={label:e.label,field:e.name,autoSave:!1,sortable:!1},r=void 0===e.isEditable?this.isEditable:e.isEditable;r||(a.canEdit=r),this.editorDataTypes.indexOf(e.dataType)>-1?r?(a.editor=this._getEditor(e.dataType),a.editOn="checkbox"===a.editor?a.editOn:"click",this._isFloatingDataType(e.dataType)&&(a.editorArgs={constraints:{fractional:!0,places:"0,20"}}),e.constraints&&(a.editorArgs={constraints:e.constraints}),i=n(a)):i=a:this.renderCellDataTypes.indexOf(e.dataType)>-1&&((i=a).renderCell=this._getRenderer(e.dataType)),t.push(i)}),this),t},_initStore:function(e){this.idProperty="id",e.forEach((function(e,t){e.id=t+1,e.idNum=t+1})),this._store=new d({data:e,idProperty:this.idProperty}),this._store=h(this._store)},_initGrid:function(e){var t=this.isExtensible?this._store.data.length+1:this._store.data.length;this._grid=new F({store:this._store,columns:this._getGridColumns(e),className:"dgrid-autoheight",showHeader:this.showHeader,selectionMode:"single",minRowsPerPage:t},this.gridNode),this.isExtensible?this._addBlankObject():this._grid.refresh()},_onGridChange:function(){if(this._store&&this._grid){(this.isForMultidimensional||this.hasCheckBoxColumn)&&(this._grid.revert(),this._grid.refresh());var e=this._store.data;this.emit("grid-data-change",e)}},_getEditor:function(e){var t;switch(e){case G.doubleArray:case G.double:case G.long:case G.longArray:t=v;break;case G.boolean:t="checkbox",this.hasCheckBoxColumn=!0;break;default:t="text"}return t},_getRenderer:function(e){return e===G.color?u.hitch(this,(function(e,t,i){var a=new C({colorObject:e.colorObject});a.placeAt(i),a.startup(),a.on("change-color",u.hitch(this,(function(t){t.id=t.id||e.id-1;var i=this._store.data;b.some(i,u.hitch(this,(function(e){if(e.colorObject&&e.colorObject.id===t.id||!w.isDefined(e.colorObject.id))return e.colorObject={r:t.r,g:t.g,b:t.b,a:t.a,id:t.id}}))),this._addNewRowToGrid(e),this.emit("grid-data-change",i)})))})):e===G.field?u.hitch(this,(function(e,t,i){var a=e.layerArg,r=new T({layerArg:a,isInGrid:!0});r.placeAt(i),r.startup(),e.fieldArg=r,r.on("change",function(e){e.field=e.fieldArg.value,this.emit("change")}.bind(this,e)),""!==t&&(r.set("value",t,!1),r.selectedValue=t)})):e===G.raster?u.hitch(this,(function(e,t,i){var a=new R({inputLayers:this.inputLayers,allowScalar:this.allowScalar,selectDefault:!1,browseProperties:this.browseProperties});a.placeAt(i),a.startup(),e.layerArg={input:a},a.set("rfxVariable",t,!1),a.on("change",this._onLayerChange.bind(this,e))})):e===G.scale?u.hitch(this,(function(e,t,i){var a;"*"!==e.idNum&&(a=e.scaleArg&&e.scaleArg.evalValues,t=t||"NODATA");var r=new E({evalValues:a,value:t});r.placeAt(i),r.startup(),e.scaleArg=r,r.on("change",this._onScaleChange.bind(this,e))})):"dropdown"===e?u.hitch(this,(function(e,t,i){var a=new x({options:t});a.placeAt(i),a.startup(),a.on("change",this._onDropdownChange.bind(this,e))})):"combobox"===e?function(e,t,i){var a=new l({data:{label:"label",items:t}}),r=t.filter((function(e){return e.selected}));r=1===r.length?r[0].value:"";var s=new y({store:a,value:r,searchAttr:"label"});s.placeAt(i),s.startup(),s.on("change",this._onComboBoxChange.bind(this,e))}.bind(this):"delete"===e?function(e,t,i){var a=new j({iconClass:"dijitIconDelete",showLabel:!1,label:this._i18n.deleteName});a.placeAt(i),a.startup(),a.on("click",this._onDeleteClick.bind(this,e))}.bind(this):void 0},_onLayerChange:function(e){e.fieldArg.setFieldOptions();var t=e.layerArg.input.rfxVariable;t||(t=u.clone(O.defaultRasterNodeProps)),t.value=e.layerArg.input.get("value"),e.layer=t,this.isExtensible&&this._addNewRowToGrid(e),this.emit("change")},_onScaleChange:function(e){e.scale=e.scaleArg.value,this.emit("change")},_onDropdownChange:function(e){this.isExtensible&&this._addNewRowToGrid(e),this.emit("change")},_onComboBoxChange:function(e,t){O.makeComboboxSelection(e.value,t),this.isExtensible&&this._addNewRowToGrid(e),this.emit("change")},updateStoreValue:function(e){this._initStore(e);var t=this.isExtensible?this._store.data.length+1:this._store.data.length;this._grid.set("minRowsPerPage",t),this.isExtensible&&this._addBlankObject(),this._grid.set("store",this._store),this._grid.refresh()},getStoreValue:function(){return this._grid.store.data},_addNewRowToGrid:function(e){"*"===e.idNum&&(this._addBlankObject(),this._grid.refresh())},_onDeleteClick:function(e){var t=this._store.data.filter(function(t){return t.value!==e.value}.bind(this));this.updateStoreValue(t),this.emit("grid-data-change",t)},_isNumericDataType:function(e){return[G.long,G.longArray,G.double,G.doubleArray].indexOf(e)>-1},_isFloatingDataType:function(e){return[G.double,G.doubleArray].indexOf(e)>-1}});return t("extend-esri")&&u.setObject("dijit.RasterFunctionEditor.RFxGridBase",S,i),S.DATA_TYPES=G,S}));