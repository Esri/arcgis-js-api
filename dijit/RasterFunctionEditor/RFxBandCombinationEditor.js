// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/query","dojo/_base/array","dojo/store/Memory","dojo/data/ObjectStore","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","../../kernel","../../lang","dojo/text!./templates/RFxBandCombinationEditor.html","dojo/i18n!../../nls/jsapi"],(function(t,e,a,n,s,i,o,d,h,r,l,u,b,m,c){var g=t("RFxBandCombinationEditor",[h,r,l],{baseClass:"esriRFxBandCombinationEditor",templateString:m,schemaArgDefinitions:{},inputArgs:{},rasterArgs:{},rasterFunctionSchema:null,rasterFunctionEnums:null,rasterSelect:null,constructor:function(e){this.inherited(arguments),t.safeMixin(this,e),this._i18n=c.widgets.rasterFunctionEditor.rfxBandCombinationEditor},postCreate:function(){this.inherited(arguments),this._setLabels(),this._processRasterArgs(),this._bandControls=[this.bandNameSelect,this.bandWavelengthSelect,this.bandIdSelect],this._setupBandComboStore(),this._setupValues()},startup:function(){this.inherited(arguments),this._setArgVisibilities()},_setupValues:function(){var t=this.inputArgs;t&&t.Method&&void 0!==t.Method.value?this.methodSelect.set("value",t.Method.value.toString()):(!t.BandIds||t.BandNames||t.BandWavelengths?!t.BandNames||t.BandIds||t.BandWavelengths?!t.bandWavelengths||t.BandIds||t.BandNames||this.methodSelect.set("value","1"):this.methodSelect.set("value","0"):this.methodSelect.set("value","2"),this.methodSelect.set("disabled",!0)),this._setBandCombinationValue()},_setBandCombinationValue:function(){var t=this.inputArgs;0===this.method&&t.BandNames&&t.BandNames.value&&t.BandNames.value.length?this.bandCombinationTextbox.set("value",t.BandNames.value.join(" ")):1===this.method&&t.BandWavelengths&&t.BandWavelengths.value&&t.BandWavelengths.value.length?this.bandCombinationTextbox.set("value",t.BandWavelengths.value.join(" ")):2===this.method&&t.BandIds&&t.BandIds.value&&t.BandIds.value.length&&this.bandCombinationTextbox.set("value",t.BandIds.value.map((function(t){return+t+1})).join(" "))},_setArgVisibilities:function(){var t,e=this.inputArgs;this.isShownFx(e.Method)||(t=n("."+this.baseClass+"--method",this.domNode),s.forEach(t,(function(t){d.set(t,"display","none")}))),this.isShownFx(e.BandIds)||this.isShownFx(e.BandNames)||this.isShownFx(e.BandWavelengths)||(t=(t=n("."+this.baseClass+"--band",this.domNode)).concat(n("."+this.baseClass+"--combination",this.domNode)),s.forEach(t,(function(t){d.set(t,"display","none")})))},_processRasterArgs:function(){if(this.rasterArgs){this.rasterArg=this.rasterArgs.Raster;var t=this.rasterArg&&this.rasterArg.input;t&&(this._updateRasterArg(t.value),t.on("change",e.hitch(this,this._updateRasterArg)))}},_updateRasterArg:function(t){var e=this.rasterArg&&this.rasterArg.input;this.layer=e&&"function"==typeof e.getSelectedLayer?e.getSelectedLayer():void 0,this._updateBands()},_updateBands:function(){this.layer&&(this.layer.loaded?this._updateBandsOnLayerLoad(this):this.layer.on("load",e.hitch(this,(function(){this._updateBandsOnLayerLoad().bind(this),this._setupValues()}))))},_updateBandsOnLayerLoad:function(){var t=[],a=[],n=[{label:"200"},{label:"400"},{label:"600"}];this.layer.getKeyProperties({renderingRule:this.layer.renderingRule}).then(e.hitch(this,(function(e){if(s.forEach(e.BandProperties,(function(e,n){t.push({label:String(n+1)}),e.BandName&&a.push({label:e.BandName})})),!e.BandProperties||e.BandProperties&&!e.BandProperties.length){var d=this._getDefaultBandProperties();a=d.bandNames,t=d.bandIds}this.bandWavelengthSelect&&this.bandWavelengthSelect.set("store",new o(new i({data:n,idProperty:"label"}))),this.bandNameSelect&&this.bandNameSelect.set("store",new o(new i({data:a,idProperty:"label"}))),this.bandIdSelect&&this.bandIdSelect.set("store",new o(new i({data:t,idProperty:"label"}))),this.bandIdSelect&&this.bandIdSelect.options.sort((function(t,e){return Number(t.value)-Number(e.value)}))})))},_getDefaultBandProperties:function(){for(var t=this.layer.bandCount,e=[],a=[],n=1;n<=t;n++)e.push({label:String(n)}),a.push({label:"Band_"+n});return{bandNames:a,bandIds:e}},_setupBandComboStore:function(){if(this.rasterFunctionEnums){var t=[];s.forEach(this.rasterFunctionEnums.bandComboMethods,(function(e){t.push({key:e.key+"",label:e.label})})),this.methodSelect.set("labelAttr","label"),this.methodSelect.set("store",new o(new i({idProperty:"key",data:t})));var e=b.isDefined(this.inputArgs.Method.value)?this.inputArgs.Method.value:this.methodSelect.value;this.onBandComboMethodChange(e)}},onBandComboMethodChange:function(t){this.method=parseInt(t,10),this.inputArgs&&this.inputArgs.Method&&(this.inputArgs.Method.value=this.method),s.forEach(this._bandControls,(function(t,e){if(e===this.method)return d.set(t.domNode,"display","");d.set(t.domNode,"display","none")}),this),this._setBandCombinationValue()},onBandChange:function(t){var e=this.bandCombinationTextbox.value;e.length?this.bandCombinationTextbox.set("value",e+" "+t):this.bandCombinationTextbox.set("value",t)},onBandCombinationChange:function(){var t=this.bandCombinationTextbox.value,e=s.indexOf(t,",")>0?t.split(","):t.split(" ");s.forEach(e,(function(t,a){1===this.method?e[a]=parseFloat(t):2===this.method?e[a]=parseInt(t,10)-1:e[a]=t.trim()}),this);var a=this.inputArgs;a&&(0===this.method&&a.BandNames?a.BandNames.value=e:1===this.method&&a.BandWavelengths?a.BandWavelengths.value=e:2===this.method&&a.BandIds&&(a.BandIds.value=e))},_clearArgValues:function(){var t=this.inputArgs;t&&(t.BandIds&&(t.BandIds.value=void 0),t.BandNames&&(t.BandNames.value=void 0),t.BandWavelengths&&(t.BandWavelengths.value=void 0))},_setLabels:function(){this.inputArgs&&this.inputArgs.Method&&(this.methodLabel.innerHTML=this.inputArgs.Method.displayName)}});return a("extend-esri")&&e.setObject("dijit.RasterFunctionEditor.RFxBandCombinationEditor",g,u),g}));