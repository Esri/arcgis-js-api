define(["../kernel","../numberUtils","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/form/NumberTextBox","dojo/i18n!../nls/jsapi","dojo/on","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dnd/move","dojo/dom-geometry","dojo/dom-construct","dojo/dom-style","dojo/Evented","dojo/number","dojo/has","dojo/text!./RendererSlider/templates/RendererSlider.html"],function(e,t,i,s,a,n,o,l,r,h,d,u,m,c,b,_,v,p,f){var N=h("esri.dijit.RendererSlider",[a,s,i,_],{templateString:f,theme:"Slider",intermediateChanges:!1,type:null,minimum:0,maximum:100,values:[50],precision:2,handles:[],primaryHandle:null,showHandles:null,showTicks:null,showLabels:null,_visibleLabels:["data","handle"],minLabel:null,maxLabel:null,classificationMethod:null,normalizationType:null,_roundedDataLabels:[],_roundedHandleLabels:[],_maximumNumberEditor:null,_minimumNumberEditor:null,_valueDifferenceByIndex:[],_primaryHandleIdx:null,_currentTopValue:[],_isLTR:!0,_isZoomed:!1,constructor:function(e,t){this.inherited(arguments),this.domNode=t,this._css={container:"esriRendererSlider",slidernode:"sliderNode",sliderarea:"sliderArea",sliderarearight:"sliderAreaRight",topLabelNode:"topLabelNode",bottomLabelNode:"bottomLabelNode"},this.showLabels=e.showLabels||this._visibleLabels,this.showHandles=e.showHandles||!0,this.showTicks=e.showTicks||!0,this.minimum=e.minimum||this.minimum,this.maximum=e.maximum||this.maximum,this.classificationMethod=e.classificationMethod||null,this.normalizationType=e.normalizationType||null},postCreate:function(){this.inherited(arguments)},startup:function(){if(this.inherited(arguments),this._sliderHeight=b.get(this._sliderArea,"height")||200,this.minimum===this.maximum&&(this.values&&this.values.length>0?(this.minimum=0,this.maximum=2*this.values[0]):console.log("values array is empty.")),this._isLTR=m.isBodyLtr(),!this._isLRT){var e=b.get(this._sliderNode,"padding-left")+b.get(this._sliderNode,"padding-right"),t=Math.round(b.get(this._sliderNode,"width"));this._sliderNodeWidth_RTL=e+t+4}this._updateRoundedLabels(),this._generateLabelEditors(),this._generateMoveables(),this.watch("values",this._valuesChange)},_generateLabelEditors:function(){"HeatmapSlider"!==this.type&&(l(this._topNode,"click",d.hitch(this,this._generateMaxEditor)),l(this._botNode,"click",d.hitch(this,this._generateMinEditor)))},_generateMaxEditor:function(){var e=this.minLabel,i=this.maxLabel;if(!(this._maximumNumberEditor&&this._topLabelNode||this._isZoomed)){var s=this.maximum;this._topNode.innerHTML="",this._topLabelNode=c.create("input",{type:"text"},this._topNode);var a;a=this.handles&&this.handles.length>0?this.values[this.handles[this.handles.length-1]]:this.values[this.values.length-1],"object"==typeof a&&(a=a.value);var o=new n({value:Number(s),required:!0,constraints:{min:a,places:"0,20"}},this._topLabelNode);this._maximumNumberEditor=o,o.startup(),o.focus(),o.textbox.select();var r=!1;l(o,"keydown",d.hitch(this,function(e){r!==!1&&(o.validate=r),13===e.keyCode&&(o.get("value")<=o.constraints.max&&o.get("value")>=o.constraints.min?o.focusNode.blur():(r=o.validate,o.validate(!1),o.validate=function(){return!1})),27===e.keyCode&&console.log("Esc")}));var h=this;l(o,"blur",function(){var a=isNaN(i)?i:t.round([e,i])[1],n=isNaN(a)||null===a?i:t.format(a),o=t.format(h._roundedDataLabels[1])||t.format(s);h._topNode.innerHTML=n||o,this.destroy(),h._maximumNumberEditor=null}),l(this._maximumNumberEditor,"change",d.hitch(this,function(n){if(n<Number(a)||isNaN(n)||void 0===n){var o=isNaN(i)?i:t.round([e,i])[1],l=isNaN(o)||null===o?i:t.format(o),r=t.format(this._roundedDataLabels[1])||t.format(s);return void(this._topNode.innerHTML=l||r)}this._topNode.innerHTML=t.format(n),this.maximum=n,this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateLabelEditors(),this.emit("data-value-change",{min:this.minimum,max:this.maximum,values:d.clone(this.values)})}))}},_generateMinEditor:function(){var e=this.minLabel,i=this.maxLabel;if(!(this._minimumNumberEditor&&this._botLabelNode||this._isZoomed)){var s=this.minimum;this._botNode.innerHTML="",this._botLabelNode=c.create("input",{type:"text"},this._botNode);var a;a=this.handles&&this.handles.length>0?this.values[this.handles[0]]:this.values[0],"object"==typeof a&&(a=a.value);var o=new n({value:Number(s),required:!0,constraints:{max:a,places:"0,20"}},this._botLabelNode);this._minimumNumberEditor=o,o.startup(),o.focus(),o.textbox.select();var r=!1;l(o,"keydown",d.hitch(this,function(e){r!==!1&&(o.validate=r),13===e.keyCode&&(o.get("value")<=o.constraints.max&&o.get("value")>=o.constraints.min?o.focusNode.blur():(r=o.validate,o.validate(!1),o.validate=function(){return!1})),27===e.keyCode&&console.log("Esc")}));var h=this;l(o,"blur",function(){var a=isNaN(e)?e:t.round([e,i])[0],n=isNaN(a)||null===a?e:t.format(a),o=t.format(h._roundedDataLabels[0])||t.format(s);h._botNode.innerHTML=n||o,this.destroy(),h._minimumNumberEditor=null}),l(this._minimumNumberEditor,"change",d.hitch(this,function(n){if(n>Number(a)||isNaN(n)||void 0===n){var o=isNaN(e)?e:t.round([e,i])[0],l=isNaN(o)||null===o?e:t.format(o),r=t.format(this._roundedDataLabels[0])||t.format(s);return void(this._botNode.innerHTML=l||r)}this._botNode.innerHTML=t.format(n),this.minimum=n,this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateLabelEditors(),this.emit("data-value-change",{min:this.minimum,max:this.maximum})}))}},_generateMoveables:function(){var e,i=this._sliderNode,s=this._sliderHeight,a=this.get("minimum"),o=this.get("maximum"),h=this.get("minLabel"),m=this.get("maxLabel"),_=this.get("precision"),v=this.get("step")||Math.pow(10,-_),p=this.get("showLabels"),f=this.get("showTicks"),N=d.hitch(this,this.setValue),L=this.get("values");if(p===!0||"object"==typeof p&&-1!==r.indexOf(p,"data")){var g=isNaN(h)?h:t.round([h,m])[0],x=isNaN(m)?m:t.round([h,m])[1],y=isNaN(g)||null===g?h:t.format(g),T=isNaN(x)||null===x?m:t.format(x),H=t.format(this._roundedDataLabels[1])||t.format(o),M=t.format(this._roundedDataLabels[0])||t.format(a);this._topNode.innerHTML=T||H,this._botNode.innerHTML=y||M}else this._topNode.innerHTML="&nbsp;",this._botNode.innerHTML="&nbsp;";this._primaryHandleIdx=null,e=r.map(L,d.hitch(this,function(h,m){if(h&&h.primaryHandle&&(this._primaryHandleIdx=m),"object"==typeof h&&h.hidden)return null;"object"==typeof h&&(h=h.value);var L,g,x,y,T,H,M;L=(h-a)/(o-a),g=Math.round((1-L)*s);var j=this._isLTR?0:this._sliderNodeWidth_RTL,E="left: "+j+"px;",k="top: "+g+"px;",w=k+" "+E;return x=c.create("div",{style:w,className:"moveable"},i),y=c.create("div",{className:"handler"},x),x._handler=y,"HeatmapSlider"!==this.type&&(p===!0||"object"==typeof p&&-1!==r.indexOf(p,"handles"))&&(T=c.create("div",{className:"handlerLabel",innerHTML:t.format(this._roundedHandleLabels[m])},x),x._label=T,l(T,"click",d.hitch(this,function(){if(!x._numberEditor){var e,i,s,h,u,b,_=this.values[m];"object"==typeof _&&(_=_.value),T.innerHTML="";var v=c.create("input",{type:"text",className:"NumberTextBoxContainer"},T);this.handles.length>0?(e=null!==this.handles[r.indexOf(this.handles,m)-1]?this.handles[r.indexOf(this.handles,m)-1]:null,i=null!==this.handles[r.indexOf(this.handles,m)+1]?this.handles[r.indexOf(this.handles,m)+1]:null,s=this.values[e],h=this.values[i],"object"==typeof s&&(s=s.value),"object"==typeof h&&(h=h.value)):(s=this.values[m-1],h=this.values[m+1],"object"==typeof s&&(s=s.value),"object"==typeof h&&(h=h.value)),u=void 0!==s&&null!==s?s:a,b=void 0!==h&&null!==h?h:o;var p=new n({value:_,constraints:{min:u,max:b,places:"0,20"}},v);x._numberEditor=p;var f=!1;l(p,"keydown",d.hitch(this,function(e){f!==!1&&(p.validate=f),13===e.keyCode&&(p.get("value")<=p.constraints.max&&p.get("value")>=p.constraints.min?p.focusNode.blur():(f=p.validate,p.validate(!1),p.validate=function(){return!1})),27===e.keyCode&&console.log("Esc")})),l(p,"blur",d.hitch(this,function(){isNaN(p.get("value"))&&p.set("value",_),T.innerHTML=t.format(this._roundedHandleLabels[m]),p.destroy(),x._numberEditor=null})),l(p,"change",d.hitch(this,function(e){return e>p.constraints.max||e<p.constraints.min||isNaN(e)||void 0===e?void(T.innerHTML=t.format(this._roundedHandleLabels[m])):("object"==typeof this.values[m]?this.values[m].value=e:this.values[m]=e,this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateLabelEditors(),void this.emit("handle-value-change",{values:this.values}))})),p.focus(),p.textbox.select()}}))),f&&(M=0===m?"handlerTick handlerTickBottom":"handlerTick handlerTickTop","HeatmapSlider"===this.type&&(M+=" heatmapTick"),x._tick=c.create("div",{className:M},x)),H=new u.constrainedMoveable(x,{handle:y,within:!0,constraints:d.hitch(this,function(){return{t:0,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s}})}),H.onMoveStart=d.hitch(this,function(t){var i,a,n,o,l,h,u,c;this._currentTopValue[m]=t.node.style.top,x._numberEditor&&(x._numberEditor.destroy(),x._numberEditor=null),this._primaryHandleIdx!==m?(this.handles.length>0?(i=null!==this.handles[r.indexOf(this.handles,m)-1]?this.handles[r.indexOf(this.handles,m)-1]:null,a=null!==this.handles[r.indexOf(this.handles,m)+1]?this.handles[r.indexOf(this.handles,m)+1]:null,n=e[i],o=e[a]):(n=e[m-1],o=e[m+1]),n&&o?(l=n.style.top,h=o.style.top,u=Number(l.replace("px","")),c=Number(h.replace("px","")),H.constraints=d.hitch(this,function(){return{t:c+2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-c-(s-u+4)}})):n?(l=n.style.top,u=Number(l.replace("px","")),H.constraints=d.hitch(this,function(){return{t:0,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-(s-u+2)}})):o&&(h=o.style.top,c=Number(h.replace("px","")),H.constraints=d.hitch(this,function(){return{t:c+2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-(c+2)}}))):console.log("this is the primary handle... it needs special rules... set some boundaries on it")}),H.onMoved=d.hitch(this,function(i){var n,l;if(m===this._primaryHandleIdx){var h=Number(this._currentTopValue[m].replace("px",""))-Number(i.node.style.top.replace("px",""));this._currentTopValue[m]=i.node.style.top,r.forEach(e,d.hitch(this,function(e,i){if(e){var r=Number(e.style.top.replace("px","")),d=r-h;if(n=1-Number(d/s),l=parseFloat((Math.round((n*(o-a)+a)/v)*v).toFixed(_)),a>l||l>o)return;b.set(e,"top",d+"px"),N(i,l,!1),e._label&&(e._label.innerHTML=t.format(l))}}))}n=1-Number(i.node.style.top.replace("px",""))/s,l=parseFloat(Math.round((n*(o-a)+a)/v)*v),1>a&&a>-1&&1>o&&o>-1&&(l=(n*(o-a)+a)/v*v),T&&(T.innerHTML=t.format(t.round([this._roundedHandleLabels[m-1],l,this._roundedHandleLabels[m+1]])[1])),N(m,l,!1)}),H.onMoveStop=d.hitch(this,function(e){var i,n;i=1-Number(e.node.style.top.replace("px",""))/s,n=parseFloat((Math.round((i*(o-a)+a)/v)*v).toFixed(20)),1>a&&a>-1&&1>o&&o>-1&&(n=(i*(o-a)+a)/v*v),N(m,n,!0),this._updateRoundedLabels(),T&&(T.innerHTML=t.format(this._roundedHandleLabels[m]))}),this.showHandles||b.set(y,"display","none"),x})),this.moveables=e},_updateRoundedLabels:function(){switch(this._roundedDataLabels=t.round([this.minimum,this.maximum]),this.type){case"SizeInfoSlider":this._roundedHandleLabels=t.round(this.values);break;case"ColorInfoSlider":this._roundedHandleLabels=t.round(this._getValuesFromObject(this.values));break;case"ClassedSizeSlider":this._roundedHandleLabels=t.round(this.values);break;case"ClassedColorSlider":this._roundedHandleLabels=t.round(this.values);break;case"OpacitySlider":this._roundedHandleLabels=t.round(this._getValuesFromObject(this.values))}},_reset:function(){r.forEach(this.moveables,d.hitch(this,function(e){e&&e.parentElement.removeChild(e)})),this.moveables=[]},_getValuesFromObject:function(e){var t=[];return r.forEach(e,function(e){t.push(e.value)}),t},_getDecimalPlaces:function(e){return v.format(e,{places:"0,20",round:-1}).replace(/^-?\d*\.?|0+$/g,"").length},setValue:function(e,t,i){var s=this.get("values"),a=s.slice(0);"object"==typeof s[0]?a[e].value=t:a[e]=t,(this.intermediateChanges||i)&&this.set("values",a),i?this.emit("stop",{values:this.get("values")}):this.emit("slide",{values:a})},_valuesChange:function(){this.emit("change",{values:this.get("values")})}});return p("extend-esri")&&d.setObject("dijit.RendererSlider",N,e),N});