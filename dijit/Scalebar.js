// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/has","dojo/query","../kernel","../lang","../domUtils","../units","../SpatialReference","../WKIDUnitConversion","../geometry/Point","../geometry/ScreenPoint","../geometry/Polyline","../geometry/geodesicUtils","../geometry/webMercatorUtils","../geometry/screenUtils","../geometry/normalizeUtils","dojo/i18n!../nls/jsapi"],function(e,i,a,s,t,r,c,l,n,h,o,d,m,b,p,S,v,u,g,f,y,L,_,w){var k=e(null,{declaredClass:"esri.dijit.Scalebar",map:null,mapUnit:null,scalebarUnit:null,unitsDictionary:[],domNode:null,screenPt1:null,screenPt2:null,localStrings:w.widgets.scalebar,constructor:function(e,c){if(this.metricScalebar=r.create("div",{innerHTML:"<div class='esriScaleLabelDiv'><div class='esriScalebarLabel esriScalebarLineLabel esriScalebarSecondNumber'></div></div><div class='esriScalebarLine esriScalebarMetricLine'></div>"}),this.englishScalebar=r.create("div",{innerHTML:"<div class='esriScalebarLine esriScalebarEnglishLine'></div><div class='esriScaleLabelDiv'><div class='esriScalebarLabel esriScalebarLineLabel esriScalebarSecondNumber'></div></div>"}),this.domNode=r.create("div"),e=e||{},!e.map)return void console.error("scalebar: unable to find the 'map' property in parameters");if(e.scalebarUnit){if("english"!==e.scalebarUnit&&"metric"!==e.scalebarUnit&&"dual"!==e.scalebarUnit)return void console.error("scalebar unit only accepts english or metric or dual");this.scalebarUnit=e.scalebarUnit}else this.scalebarUnit="english";if(e.scalebarStyle){if("ruler"!==e.scalebarStyle&&"line"!==e.scalebarStyle)return void console.error("scalebar style must be ruler or line");this.scalebarStyle=e.scalebarStyle}else this.scalebarStyle="ruler";switch(this.background=e.background,this.scalebarUnit){case"english":"ruler"===this.scalebarStyle&&(this.englishScalebar.innerHTML="<div class='esriScalebarRuler'><div class='esriScalebarRulerBlock upper_firstpiece'></div><div class='esriScalebarRulerBlock upper_secondpiece'></div><div class='esriScalebarRulerBlock lower_firstpiece'></div><div class='esriScalebarRulerBlock lower_secondpiece'></div></div><div class='scaleLabelDiv'><div class='esriScalebarLabel' style='left: -3%'>0</div><div class='esriScalebarLabel esriScalebarFirstNumber'></div><div class='esriScalebarLabel esriScalebarSecondNumber'></div></div>"),this.domNode.appendChild(this.englishScalebar);break;case"metric":"ruler"===this.scalebarStyle&&(this.metricScalebar.innerHTML="<div class='esriScalebarRuler'><div class='esriScalebarRulerBlock upper_firstpiece'></div><div class='esriScalebarRulerBlock upper_secondpiece'></div><div class='esriScalebarRulerBlock lower_firstpiece'></div><div class='esriScalebarRulerBlock lower_secondpiece'></div></div><div class='scaleLabelDiv'><div class='esriScalebarLabel' style='left: -3%'>0</div><div class='esriScalebarLabel esriScalebarFirstNumber'></div><div class='esriScalebarLabel esriScalebarSecondNumber'></div></div>"),this.domNode.appendChild(this.metricScalebar);break;case"dual":this.domNode.appendChild(this.metricScalebar),this.domNode.appendChild(this.englishScalebar)}if(this.map=e.map,c?c.appendChild(this.domNode):(this.map.container.appendChild(this.domNode),e.attachTo?t.add(this.domNode,"scalebar_"+e.attachTo):t.add(this.domNode,"scalebar_bottom-left")),t.add(this.domNode,"esriScalebar"),this.map.loaded)this._getDistance(this.map.extent),this._checkBingMaps();else var l=s.connect(this.map,"onLoad",this,function(){s.disconnect(l),l=null,this._getDistance(this.map.extent),this._checkBingMaps()});this._mapOnPan=s.connect(this.map,"onPan",this,this._getDistance),this._mapOnExtentChange=s.connect(this.map,"onExtentChange",this,this._getDistance),a.forEach(this.map.layerIds,function(e,a){"esri.virtualearth.VETiledLayer"===this.map.getLayer(e).declaredClass&&s.connect(this.map.getLayer(e),"onVisibilityChange",i.hitch(this,function(e){this._checkBingMaps()}))},this),this._mapOnLayerAdd=s.connect(this.map,"onLayerAdd",i.hitch(this,function(e){"esri.virtualearth.VETiledLayer"===e.declaredClass&&s.connect(e,"onVisibilityChange",i.hitch(this,function(e){this._checkBingMaps()})),this._checkBingMaps()})),this._mapOnLayerRemove=s.connect(this.map,"onLayerRemove",i.hitch(this,this._checkBingMaps))},hide:function(){this._hidden=!0,m.hide(this.domNode)},show:function(){this._hidden=!1,m.show(this.domNode)},destroy:function(){s.disconnect(this._mapOnPan),s.disconnect(this._mapOnExtentChange),s.disconnect(this._mapOnLayerAdd),s.disconnect(this._mapOnLayerRemove),this.hide(),this.map=null,r.destroy(this.domNode)},_checkBingMaps:function(){t.contains(this.domNode,"scalebar_bottom-left")&&(l.set(this.domNode,"left","25px"),a.forEach(this.map.layerIds,function(e,i){if("esri.virtualearth.VETiledLayer"===this.map.getLayer(e).declaredClass&&this.map.getLayer(e).visible){var a="95px";this.map._mapParams.nav&&(a="115px"),l.set(this.domNode,"left",a)}},this))},_getDistance:function(e){var i=c.position(this.domNode,!0),a=i.y-this.map.position.y;a=a>this.map.height?this.map.height:a,a=0>a?0:a;var s,t,r,l,n=new u(0,a),h=new u(this.map.width,a);this.mapUnit="esriDecimalDegrees";var o=L.toMapPoint(e,this.map.width,this.map.height,n),m=L.toMapPoint(e,this.map.width,this.map.height,h),w=new v(e.xmin,(e.ymin+e.ymax)/2,this.map.spatialReference),k=new v(e.xmax,(e.ymin+e.ymax)/2,this.map.spatialReference);if(3857===this.map.spatialReference.wkid||102100===this.map.spatialReference.wkid||102113===this.map.spatialReference.wkid||this.map.spatialReference.wkt&&-1!=this.map.spatialReference.wkt.indexOf("WGS_1984_Web_Mercator"))o=y.webMercatorToGeographic(o,!0),m=y.webMercatorToGeographic(m,!0),w=y.webMercatorToGeographic(w,!0),k=y.webMercatorToGeographic(k,!0);else if(d.isDefined(S[this.map.spatialReference.wkid])||this.map.spatialReference.wkt&&0===this.map.spatialReference.wkt.indexOf("PROJCS")){this.mapUnit="linearUnit",s=Math.abs(e.xmax-e.xmin);var M;if(d.isDefined(S[this.map.spatialReference.wkid]))M=S.values[S[this.map.spatialReference.wkid]];else{var R=this.map.spatialReference.wkt,N=R.lastIndexOf(",")+1,U=R.lastIndexOf("]]");M=parseFloat(R.substring(N,U))}s*=M,l=s/1609,r=s/1e3,s/=1e3}if("esriDecimalDegrees"===this.mapUnit){var x=new g(new p({wkid:4326}));x.addPath([o,m]);var B=_._straightLineDensify(x,10);s=f.geodesicLengths([B],b.KILOMETERS)[0];var D=new g(new p({wkid:4326}));D.addPath([w,k]);var T=_._straightLineDensify(D,10);t=f.geodesicLengths([T],b.KILOMETERS)[0],l=s/1.609,t/=1.609,r=s}"english"===this.scalebarUnit?this._getScaleBarLength(l,"mi"):"metric"===this.scalebarUnit?this._getScaleBarLength(r,"km"):"dual"===this.scalebarUnit&&(this._getScaleBarLength(l,"mi"),this._getScaleBarLength(r,"km"))},_getScaleBarLength:function(e,i){var a=50,s=a*e/this.map.width,t=0,r=i;for(.1>s&&("mi"===i?(s*=5280,r="ft"):"km"===i&&(s*=1e3,r="m"));s>=1;)s/=10,t++;var c,l;s>.5?(c=1,l=.5):s>.3?(c=.5,l=.3):s>.2?(c=.3,l=.2):s>.15?(c=.2,l=.15):s>=.1&&(c=.15,l=.1);var n=c/s>=s/l?l:c,h=n/s,o=a*h,d=Math.pow(10,t)*n;this._drawScaleBar(o,d,r)},_drawScaleBar:function(e,i,s){var t,r,c,l=2*Math.round(e);"mi"===s||"ft"===s?(this.englishScalebar.style.width=l+"px",t=h(".esriScalebarFirstNumber",this.englishScalebar),r=h(".esriScalebarSecondNumber",this.englishScalebar),c=h(".esriScalebarMetricLineBackground",this.englishScalebar)):(this.metricScalebar.style.width=l+"px",t=h(".esriScalebarFirstNumber",this.metricScalebar),r=h(".esriScalebarSecondNumber",this.metricScalebar),c=h(".esriScalebarMetricLineBackground",this.metricScalebar)),a.forEach(c,function(e,i){e.style.width=l-2+"px"},this),a.forEach(t,function(e,a){e.innerHTML=i},this),a.forEach(r,function(e,a){"esriUnknown"!==this.mapUnit?e.innerHTML=2*i+this.localStrings[s]:e.innerHTML=2*i+"Unknown Unit"},this)}});return n("extend-esri")&&i.setObject("dijit.Scalebar",k,o),k});