// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/query","dijit/registry","dijit/_WidgetBase","../../../../kernel"],function(n,t,e,i,l,u,r,o){var a=n([r],{gxeDocument:null,isPull:!0,portal:null,portalItem:null,portalUser:null,portalUrl:null,itemPropertiesToPush:null,postCreate:function(){this.inherited(arguments)},afterPullValue:function(n,t){},checkCoordinate:function(n){var t=typeof n;if("undefined"===t&&null===n)return null;if("string"===t){if(n=parseFloat(n),isNaN(n))return null;t=typeof n}return"number"===t&&isFinite(n)?n:null},checkVisibility:function(n,t){},findInputValue:function(n,t,e){var i,l=this.findInputWidget(n,t,e);if(null!==l)for(i=l.getParent();i;){if(i._isOptionallyOff){l=null;break}i=i.getParent()}return null!==l?l.getInputValue():void 0},findInputWidget:function(n,t,e){var i,r=l("[data-gxe-path='"+t+"']",this.gxeDocument.rootDescriptor.domNode);if(r&&1===r.length){if(i=u.byNode(r[0]))return i.inputWidget}else if(r&&r.length>0&&e&&(i=u.byNode(r[0])))return i.inputWidget;return null},generatePush:function(n,t){this.isPull=!1,this.gxeDocument=n,this.portalItem=t,this.itemPropertiesToPush=null;var e={},i=this.newTransformationInfo(n);this.populateTransformationInfo(n,t,i);var l=null,u=!1;for(l in i)i.hasOwnProperty(l)&&this.pushValue(e,i,l);for(l in e)e.hasOwnProperty(l)&&(u=!0);return u&&(this.itemPropertiesToPush=e),this.itemPropertiesToPush},pull:function(n,t){this.isPull=!0,this.gxeDocument=n,this.portalItem=t;var e=this.newTransformationInfo(n);this.populateTransformationInfo(n,t,e);var i=null;for(i in e)e.hasOwnProperty(i)&&this.pullValue(t,e,i,!1)},newTransformationInfo:function(n){var t=function(n){return{path:null,canPull:!0,canPush:n,isSelected:!0,valueToPush:null}},e={id:t(!1),title:t(!1),snippet:t(!0),description:t(!0),accessInformation:t(!1),licenseInfo:t(!1),thumbnail:t(!1),culture:t(!1),url:t(!1),created:t(!1),modified:t(!1),type:t(!1),tags:t(!0),typeKeywords:t(!1),extent:{xmin:t(!0),ymin:t(!0),xmax:t(!0),ymax:t(!0)},spatialReference:t(!1),name:t(!1),owner:t(!1)};return e},populateTransformationInfo:function(n,t,e){},pullValue:function(n,t,e,i){var l=null,u=null,r=null,o=null,a=null,s=null;if(e in n&&e in t){if(o=n[e],u=t[e],"undefined"==typeof o)return;if("string"==typeof o&&null!==o&&0===o.length)return;if("undefined"==typeof u)return;if("extent"===e){if(o&&o.push&&2===o.length&&2===o[0].length&&2===o[1].length){a={xmin:o[0][0],ymin:o[0][1],xmax:o[1][0],ymax:o[1][1]};for(s in a)a.hasOwnProperty(s)&&this.pullValue(a,u,s,!0)}return}null!==u&&u.canPull&&u.isSelected&&(r=u.path,"undefined"==typeof r&&(r=null)),"tags"===e&&null!==o&&0===o.length&&(o=null)}var f=!i;null!==o&&null!==r&&(l=this.findInputWidget(e,r,f),null!==l&&(l.setInputValue(o),l.parentXNode&&l.parentXNode.toggleContent&&l.parentXNode.toggleContent(!0),this.checkVisibility(l,r),this.afterPullValue(l,r)))},pushExtent:function(n,t,e,i,l){if(t=this.checkCoordinate(t),e=this.checkCoordinate(e),i=this.checkCoordinate(i),l=this.checkCoordinate(l),null!==t&&null!==i&&null!==e&&null!==l&&!(-180>t||t>180||-180>i||i>180||-90>e||e>90||-90>l||l>90||t>i||e>l)){var u=!0,r=this.portalItem.extent;r&&r.push&&2===r.length&&2===r[0].length&&2===r[1].length&&t===r[0][0]&&e===r[0][1]&&i===r[1][0]&&l===r[1][1]&&(u=!1),u&&(n.extent=t+","+e+","+i+","+l)}},pushString:function(n,e,i){if("undefined"!=typeof i&&null!==i&&"string"==typeof i){var l=t.trim(i);if(0!==l.length){var u=this.portalItem[e],r="undefined"==typeof u||l!==u;r&&(n[e]=l)}}},pushTags:function(n,t){if("undefined"!=typeof t&&null!==t&&t.push&&t.length>0){var i=this.portalItem.tags,l=[],u=!0,r=0;"undefined"!=typeof i&&null!==i&&i.push?(e.forEach(i,function(n){l.push(n)}),e.forEach(t,function(n){var t=e.some(i,function(t){return n===t});t||l.push(n)}),l.length===i.length&&(e.forEach(l,function(n){var t=e.some(i,function(t){return n===t});t&&r++}),r===l.length&&(u=!1)),u&&(n.tags=l.join(","))):n.tags=t.join(",")}},pushValue:function(n,t,e){var i,l=null,u=null,r={};if(i=t[e],"undefined"!=typeof i){if("extent"===e){for(u in i)i.hasOwnProperty(u)&&this.pushValue(r,i,u);return void this.pushExtent(n,r.xmin,r.ymin,r.xmax,r.ymax)}if(i.canPush&&i.isSelected&&(l=i.path,"undefined"==typeof l&&(l=null)),null!==l){var o="tags"===e,a=this.findInputValue(e,l,o);"undefined"!=typeof a&&null!==a&&("string"==typeof a?this.pushString(n,e,a):a.push&&a.length>0&&"tags"===e&&this.pushTags(n,a))}}}});return i("extend-esri")&&t.setObject("dijit.metadata.arcgis.portal.PortalItemTransformer",a,o),a});