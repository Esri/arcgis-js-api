// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","../kernel","dojo/uacss","dojo/Deferred","dojo/on","dojo/dom-class","dojo/dom-style","dojo/dom-construct","dojo/dom-attr","dojo/i18n!../nls/jsapi","dijit/_WidgetBase","dijit/_TemplatedMixin","../promiseList","dojo/text!./LayerList/templates/LayerList.html"],function(e,s,t,i,r,a,l,n,o,h,c,y,d,u,v,f){var b=s([d,u],{templateString:f,defaults:{theme:"esriLayerList",map:null,layers:null,subLayers:!0,removeUnderscores:!0,visible:!0},constructor:function(e){var s=t.mixin({},this.defaults,e);this.set(s),this.css={container:"esriContainer",noLayers:"esriNoLayers",noLayersText:"esriNoLayersText",list:"esriList",subList:"esriSubList",subListLayer:"esriSubListLayer",layer:"esriLayer",layerScaleInvisible:"esriScaleInvisible",title:"esriTitle",titleContainer:"esriTitleContainer",checkbox:"esriCheckbox",label:"esriLabel",button:"esriButton",content:"esriContent",clear:"esriClear"}},postCreate:function(){this.inherited(arguments);var e=this;this.own(l(this._layersNode,"."+this.css.checkbox+":click",function(){var s,t;s=c.get(this,"data-layer-index"),t=c.get(this,"data-sublayer-index"),e._toggleLayer(s,t)}))},startup:function(){this.inherited(arguments),this._mapLoaded(this.map).then(t.hitch(this,this._init))},destroy:function(){this._removeEvents(),this.inherited(arguments)},refresh:function(){var e=this.layers;this._nodes=[];var s=[];if(e&&e.length)for(var i=0;i<e.length;i++)s.push(this._layerLoaded(i));return v(s).always(t.hitch(this,function(e){this._loadedLayers=e,this._removeEvents(),this._createLayerNodes(),this._setLayerEvents(),this.emit("refresh")}))},_mapLoaded:function(e){var s=new a;return e?e.loaded?s.resolve():l.once(e,"load",t.hitch(this,function(){s.resolve()})):s.resolve(),s.promise},_layerLoaded:function(e){var s=this.layers,i=s[e],r=i.layer,n={layer:r,layerInfo:i,layerIndex:e},o=new a;if(r)if(r.loaded)o.resolve(n);else if(r.loadError)o.reject(r.loadError);else{var h,c;h=l.once(r,"load",t.hitch(this,function(){c.remove(),o.resolve(n)})),c=l.once(r,"error",t.hitch(this,function(e){h.remove(),o.reject(e)}))}else o.resolve(n);return o.promise},_checkboxStatus:function(e){return!!e.visibility},_WMSVisible:function(s,t){var i=[];return s&&s.layer&&(i=s.layer.visibleLayers),e.indexOf(i,t.name)>-1},_subCheckboxStatus:function(e,s){var t,i=e.layer.declaredClass;switch(i){case"esri.layers.KMLLayer":t=s.visible;break;case"esri.layers.WMSLayer":t=this._WMSVisible(e,s);break;default:t=s.defaultVisibility}return t},_getLayerTitle:function(e){var s="",t=e.layer,i=e.layerInfo;return i&&i.title?s=i.title:t&&t.arcgisProps&&t.arcgisProps.title?s=t.arcgisProps.title:t&&t.name?s=t.name:i&&i.id?s=i.id:t&&t.id&&(s=t.id),this.removeUnderscores?s.replace(/_/g," "):s},_showSublayers:function(e){return e.hasOwnProperty("subLayers")?e.subLayers:this.subLayers},_createLayerNodes:function(){this._layersNode.innerHTML="",this._noLayersNode.innerHTML="",n.remove(this._container,this.css.noLayers);var e=this._loadedLayers;if(e&&e.length)for(var s=0;s<e.length;s++){var t=e[s];if(t){var i=t.layer,r=t.layerIndex,a=t.layerInfo;if(a){if(a.featureCollection&&!a.hasOwnProperty("visibility")){var l=a.featureCollection.layers[0];l&&l.layerObject&&(a.visibility=l.layerObject.visible)}i&&!a.hasOwnProperty("visibility")&&(a.visibility=a.layer.visible),i&&!a.hasOwnProperty("id")&&(a.id=a.layer.id);var o,d=h.create("li",{className:this.css.layer});i&&!i.visibleAtMapScale&&n.add(d,this.css.layerScaleInvisible),h.place(d,this._layersNode,"first");var u,v=h.create("div",{className:this.css.title},d),f=[];i&&(u=i.declaredClass);var b=this._checkboxStatus(a),_=h.create("div",{className:this.css.titleContainer},v),L=this.id+"_checkbox_"+r,p=h.create("input",{type:"checkbox",id:L,"data-layer-index":r,className:this.css.checkbox},_);c.set(p,"checked",b);var m;a.button&&(m=h.create("div",{className:this.css.button},_),h.place(a.button,m));var g=this._getLayerTitle(t),I=h.create("label",{className:this.css.label,textContent:g},_);c.set(I,"for",L);var x,C=h.create("div",{className:this.css.clear},_);a.content&&(x=h.create("div",{className:this.css.content},v),h.place(a.content,x));var N={checkbox:p,title:v,titleContainer:_,label:I,layer:d,clear:C,button:m,content:x,subNodes:f};if(this._nodes[r]=N,i&&(o=i.layerInfos,"esri.layers.KMLLayer"===u&&(o=i.folders),this._showSublayers(a)&&"esri.layers.ArcGISTiledMapServiceLayer"!==u&&o&&o.length))for(var S=h.create("ul",{className:this.css.subList},d),k=0;k<o.length;k++){var j,M=o[k],E=-1,T=null;"esri.layers.ArcGISDynamicMapServiceLayer"===u?(j=M.id,E=M.parentLayerId):"esri.layers.KMLLayer"===u?(j=M.id,E=M.parentFolderId):"esri.layers.WMSLayer"===u&&(j=M.name,E=-1),-1!==E&&(T=h.create("ul",{className:this.css.subList},this._nodes[r].subNodes[E].subLayer));var V=this._subCheckboxStatus(a,M),w=this.id+"_checkbox_sub_"+r+"_"+j,A=h.create("li",{className:this.css.subListLayer},T||S),O=h.create("div",{className:this.css.title},A),P=h.create("div",{className:this.css.titleContainer},O),U=h.create("input",{type:"checkbox",id:w,"data-layer-index":r,"data-sublayer-index":j,className:this.css.checkbox},P);c.set(U,"checked",V);var W=M.name||"",G=h.create("label",{className:this.css.label,textContent:W},P);c.set(G,"for",w);var K=h.create("div",{className:this.css.clear},P),D={subList:S,subSubList:T,subLayer:A,subTitle:O,subTitleContainer:P,subCheckbox:U,subLabel:G,subClear:K};f[j]=D}}}}else n.add(this._container,this.css.noLayers),c.set(this._noLayersNode,"textContent",y.widgets.layerList.noLayers)},_removeEvents:function(){if(this._layerEvents&&this._layerEvents.length)for(var e=0;e<this._layerEvents.length;e++)this._layerEvents[e].remove();this._layerEvents=[]},_emitToggle:function(e,s,t){this.emit("toggle",{layerIndex:e,subLayerIndex:s,visible:t})},_toggleVisible:function(e,s){var t=this._nodes[e].checkbox,i=c.get(t,"checked");i!==s&&(c.set(t,"checked",s),this._emitToggle(e,null,s))},_layerVisChangeEvent:function(e,s,i){var r;if(s){var a=e.layerInfo.featureCollection.layers;r=a[i].layer}else r=e.layer;var o=l(r,"visibility-change",t.hitch(this,function(t){s?this._featureCollectionVisible(e.layerIndex,t.visible):this._toggleVisible(e.layerIndex,t.visible)}));if(this._layerEvents.push(o),!s){var h=l(r,"scale-visibility-change",t.hitch(this,function(s){var t=s.target.visibleAtMapScale;n.toggle(this._nodes[e.layerIndex].layer,this.css.layerScaleInvisible,!t)}));this._layerEvents.push(h)}},_layerEvent:function(e){var s=e.layerInfo;if(s.featureCollection&&s.featureCollection.layers&&s.featureCollection.layers.length){var t=s.featureCollection.layers;if(t&&t.length)for(var i=0;i<t.length;i++)this._layerVisChangeEvent(e,!0,i)}else this._layerVisChangeEvent(e)},_toggleLayer:function(s,t){if(this.layers&&this.layers.length){var i,r,a=this.layers[parseInt(s,10)],l=a.layer;l&&(r=l.declaredClass);var n,o,h=a.featureCollection;if(h)for(i=!a.visibility,a.visibility=i,o=0;o<h.layers.length;o++){var c=h.layers[o].layerObject;c.setVisibility(i)}else if(l)if(null!==t){if("esri.layers.ArcGISDynamicMapServiceLayer"===r){t=parseInt(t,10);var y=l.layerInfos;for(n=[-1],i=!y[t].defaultVisibility,y[t].defaultVisibility=i,o=0;o<y.length;o++){var d=y[o];if(d.defaultVisibility){n.push(d.id);var u=e.lastIndexOf(n,-1);-1!==u&&n.splice(u,1)}}var v=[];for(o=0;o<n.length;o++){var f=n[o],b=this._allIdsPresent(l,f,n);b&&v.push(f)}for(var _=[],L=0;L<v.length;L++){var p=this._getLayerInfo(l,v[L]);p&&null===p.subLayerIds&&_.push(v[L])}_.length||(_=[-1]),l.setVisibleLayers(_)}else if("esri.layers.KMLLayer"===r){t=parseInt(t,10);var m=l.folders;for(o=0;o<m.length;o++){var g=m[o];if(g.id===t){l.setFolderVisibility(g,!g.visible);break}}}else if("esri.layers.WMSLayer"===r){n=l.visibleLayers;var I=e.indexOf(n,t);-1===I?n.push(t):n.splice(I,1),l.setVisibleLayers(n)}}else i=!l.visible,a.visibility=i,l.setVisibility(i);else i=!a.visible,a.setVisibility(i);this._emitToggle(s,t,i)}},_featureCollectionVisible:function(s,t){var i,r=this.layers[s],a=r.visibleLayers,l=r.featureCollection.layers;i=a&&a.length?e.every(a,function(e){return l[e].layer.visible===t}):e.every(l,function(e){return e.layer.visible===t}),i&&this._toggleVisible(s,t)},_setLayerEvents:function(){var e=this._loadedLayers;if(e&&e.length)for(var s=0;s<e.length;s++){var t=e[s];t.layer&&this._layerEvent(t)}},_allIdsPresent:function(s,t,i){var r=this._walkUpLayerIds(s,t);return e.every(r,function(s){return e.indexOf(i,s)>-1})},_walkUpLayerIds:function(e,s){var t,i=this._getLayerInfo(e,s),r=[];if(i)for(;-1!==i.parentLayerId;)t=this._getLayerInfo(e,i.parentLayerId),t&&r.push(t.id),i=t;return r},_getLayerInfo:function(e,s){for(var t,i=0;i<e.layerInfos.length;i++){var r=e.layerInfos[i];if(r.id===s){t=r;break}}return t},_isSupportedLayerType:function(e){return e&&!e._basemapGalleryLayerType||e&&"basemap"!==e._basemapGalleryLayerType},_createLayerInfo:function(e){return{layer:e}},_updateAllMapLayers:function(){if(this.map&&(!this.layers||!this.layers.length)){var s=[];e.forEach(this.map.layerIds,function(e){var t=this.map.getLayer(e);this._isSupportedLayerType(t)&&s.push(this._createLayerInfo(t))},this),e.forEach(this.map.graphicsLayerIds,function(e){var t=this.map.getLayer(e);this._isSupportedLayerType(t)&&t._params&&t._params.drawMode&&s.push(this._createLayerInfo(t))},this),this._set("layers",s)}},_init:function(){this._visible(),this._updateAllMapLayers(),this.refresh().always(t.hitch(this,function(){this.set("loaded",!0),this.emit("load")}))},_visible:function(){this.visible?o.set(this.domNode,"display","block"):o.set(this.domNode,"display","none")},_setThemeAttr:function(e){this.domNode&&(n.remove(this.domNode,this.theme),n.add(this.domNode,e)),this._set("theme",e)},_setMapAttr:function(e){this._set("map",e),this._created&&this._mapLoaded(this.map).then(t.hitch(this,function(){this._updateAllMapLayers(),this.refresh()}))},_setLayersAttr:function(e){this._set("layers",e),this._created&&this.refresh()},_setRemoveUnderscoresAttr:function(e){this._set("removeUnderscores",e),this._created&&this.refresh()},_setSubLayersAttr:function(e){this._set("subLayers",e),this._created&&this.refresh()},_setVisibleAttr:function(e){this._set("visible",e),this._created&&this._visible()}});return r("extend-esri")&&t.setObject("dijit.LayerList",b,i),b});