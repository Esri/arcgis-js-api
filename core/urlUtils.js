/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","./global","../config","./maybe","./Logger","./Error"],(function(t,e,n,r,o,i){"use strict";const s=o.getLogger("esri.core.urlUtils"),u=n.request,l="esri/config: esriConfig.request.proxyUrl is not set.",c=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,a=/^\s*http:/i,f=/^\s*https:/i,h=/^\s*file:/i,p=/:\d+$/,d=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,g=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),m=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");let y=function(){function t(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let e=r.assumeNonNull(this.uri.match(g));this.scheme=e[2]||(e[1]?"":null),this.authority=e[4]||(e[3]?"":null),this.path=e[5],this.query=e[7]||(e[6]?"":null),this.fragment=e[9]||(e[8]?"":null),null!=this.authority&&(e=r.assumeNonNull(this.authority.match(m)),this.user=e[3]||null,this.password=e[4]||null,this.host=e[6]||e[7],this.port=e[9]||null)}return t.prototype.toString=function(){return this.uri},t}();const $=new y(n.applicationUrl),x={},O=(()=>{const t=r.assumeNonNull($.path),e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${$.scheme}://${$.host}${null!=$.port?`:${$.port}`:""}`}${e}`})();function w(t){const e={path:null,query:null},n=new y(t),r=t.indexOf("?");return null===n.query?e.path=t:(e.path=t.substring(0,r),e.query=b(n.query)),n.fragment&&(e.hash=n.fragment,null===n.query&&(e.path=e.path.substring(0,e.path.length-(n.fragment.length+1)))),e}function b(t){const e=t.split("&"),n={};for(const t of e){if(!t)continue;const e=t.indexOf("=");let r,o;e<0?(r=decodeURIComponent(t),o=""):(r=decodeURIComponent(t.slice(0,e)),o=decodeURIComponent(t.slice(e+1)));let i=n[r];"string"==typeof i&&(i=n[r]=[i]),Array.isArray(i)?i.push(o):n[r]=o}return n}function U(t){return t&&"object"==typeof t&&"toJSON"in t&&"function"==typeof t.toJSON}function R(t,e){return t?e&&"function"==typeof e?Object.keys(t).map((n=>encodeURIComponent(n)+"="+encodeURIComponent(e(n,t[n])))).join("&"):Object.keys(t).map((n=>{const r=t[n];if(null==r)return"";const o=encodeURIComponent(n)+"=",i=e&&e[n];return i?o+encodeURIComponent(i(r)):Array.isArray(r)?r.map((t=>U(t)?o+encodeURIComponent(JSON.stringify(t)):o+encodeURIComponent(t))).join("&"):U(r)?o+encodeURIComponent(JSON.stringify(r)):o+encodeURIComponent(r)})).filter((t=>t)).join("&"):""}const v={path:"",query:""};function C(t){const e=t.indexOf("?");return-1!==e?(v.path=t.slice(0,e),v.query=t.slice(e+1)):(v.path=t,v.query=null),v}function P(t){return t=(t=_(t=function(t){if(!t||"/"!==t[t.length-1])return`${t}/`;return t}(t=C(t).path),!0)).toLowerCase()}function q(t){const e=u.proxyRules,n=P(t);for(let t=0;t<e.length;t++)if(0===n.indexOf(e[t].urlPrefix))return e[t]}function j(t){const e=(t=I(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function L(t,e,n=!1){const r=G(t),o=G(e);return!(!n&&r.scheme!==o.scheme)&&(null!=r.host&&null!=o.host&&(r.host.toLowerCase()===o.host.toLowerCase()&&r.port===o.port))}function S(t){return x[t]||(H(t)||F(t)?x[t]=[new y(T(t))]:x[t]=[new y(`http://${t}`),new y(`https://${t}`)]),x[t]}function T(t,e=O,n){return F(t)?n&&n.preserveProtocolRelative?t:"http"===$.scheme&&$.authority===N(t).slice(2)?`http:${t}`:`https:${t}`:H(t)?t:r.assumeNonNull(A("/"===t[0]?function(t){const e=t.indexOf("//"),n=t.indexOf("/",e+2);if(-1===n)return t;return t.slice(0,n)}(e):e,t))}function I(t){return t=function(t){const e=u.httpsDomains;if(!function(t){return a.test(t)||"http"===$.scheme&&F(t)}(t))return t;const n=t.indexOf("/",7);let r;r=-1===n?t:t.slice(0,n);if(r=r.toLowerCase().slice(7),p.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}if("http"===$.scheme&&r===$.authority&&!d.test(t))return t;(M()&&r===$.authority||e&&e.some((t=>r===t||r.endsWith(`.${t}`)))||M()&&!q(t))&&(t=W(t));return t}(t=function(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}(t=function(t){if(/^https?:\/\//i.test(t)){const e=C(t);t=(t=e.path.replace(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}(t=T(t=t.trim()))))}function A(...t){const e=t.filter(r.isSome);if(!e||!e.length)return;const n=[];if(B(e[0])){const t=e[0],r=t.indexOf("//");-1!==r&&(n.push(t.slice(0,r+1)),o=e[0],h.test(o)&&(n[0]+="/"),e[0]=t.slice(r+2))}else"/"===e[0][0]&&n.push("");var o;const i=e.reduce(((t,e)=>e?t.concat(e.split("/")):t),[]);for(let t=0;t<i.length;t++){const e=i[t];".."===e&&n.length>0&&".."!==n[n.length-1]?n.pop():(!e&&t===i.length-1||e&&("."!==e||0===n.length))&&n.push(e)}return n.join("/")}function N(t,e=!1){if(k(t)||E(t))return null;let n=t.indexOf("://");if(-1===n&&F(t))n=2;else{if(-1===n)return null;n+=3}const r=t.indexOf("/",n);return-1!==r&&(t=t.slice(0,r)),e&&(t=_(t,!0)),t}function B(t){return F(t)||H(t)}function k(t){return null!=t&&"blob:"===t.slice(0,5)}function E(t){return"data:"===t.slice(0,5)}function Q(t){const e=J(t);if(!e||!e.isBase64)return null;const n=atob(e.data),r=new Uint8Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t);return r.buffer}const D=/^data:(.*?)(;base64)?,(.*)$/;function J(t){const e=t.match(D);if(!e)return null;const[,n,r,o]=e;return{mediaType:n,isBase64:!!r,data:o}}function z(t){const e=Q(t);if(!e)return null;const n=J(t);return new Blob([e],{type:n.mediaType})}function F(t){return null!=t&&void 0!==t&&"/"===t[0]&&"/"===t[1]}function H(t){return c.test(t)}function W(t){return F(t)?`https:${t}`:t.replace(a,"https:")}function M(){return"https"===$.scheme}function _(t,e=!1){return F(t)?t.slice(2):(t=t.replace(c,""),e&&t.length>1&&"/"===t[0]&&"/"===t[1]&&(t=t.slice(2)),t)}function G(t){return"string"==typeof t?new y(T(t)):(t.scheme||(t.scheme=$.scheme),t)}const V=/.*?\.([^\/]*)$/,K=/(^data:image\/svg|\.svg$)/i;t.Url=y,t.addProxy=function(t){const e=q(t);let n,r;if(e){const t=C(e.proxyUrl);n=t.path,r=t.query?b(t.query):null}if(n){const e=w(t);t=n+"?"+e.path;const o=R({...r,...e.query});o&&(t=`${t}?${o}`)}return t},t.addProxyRule=function(t){const e={proxyUrl:t.proxyUrl,urlPrefix:P(t.urlPrefix)},n=u.proxyRules,r=e.urlPrefix;let o=n.length;for(let t=0;t<n.length;t++){const e=n[t].urlPrefix;if(0===r.indexOf(e)){if(r.length===e.length)return-1;o=t;break}0===e.indexOf(r)&&(o=t+1)}return n.splice(o,0,e),o},t.addQueryParameter=function(t,e,n){const r=w(t),o=r.query||{};return o[e]=String(n),`${r.path}?${R(o)}`},t.addQueryParameters=function(t,e){const n=w(t),r=n.query||{};for(const t in e)r[t]=e[t];const o=R(r);return o?`${n.path}?${o}`:n.path},t.appBaseUrl=O,t.appUrl=$,t.changeDomain=function(t,e,n){if(!(e&&n&&t&&B(t)))return t;const r=t.indexOf("//"),o=t.indexOf("/",r+2),i=t.indexOf(":",r+2),s=Math.min(o<0?t.length:o,i<0?t.length:i);return t.slice(r+2,s).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,r+2)}${n}${t.slice(s)}`},t.dataComponents=J,t.dataToArrayBuffer=Q,t.dataToBlob=z,t.downloadDataAsFile=function(t,n){(function(t,n){const r=document.createElement("a");if(!("download"in r))return!1;let o=null;if(e.URL&&e.URL.createObjectURL){const n=z(t);if(!n)return!1;o=e.URL.createObjectURL(n)}r.download=n,r.href=o||t,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),o&&e.URL.revokeObjectURL(o);return})(t,n)||function(t,e){if(window.navigator.msSaveOrOpenBlob)return window.navigator.msSaveOrOpenBlob(z(t),e)}(t,n)},t.getFilename=function(t,e){if(!t)return"";const n=w(t).path.replace(/\/+$/,""),r=n.substring(n.lastIndexOf("/")+1);if(null==e||!e.length)return r;const o=new RegExp(`.(${e.join("|")})$`,"ig");return r.replace(o,"")},t.getInterceptor=function(t){const e=e=>null==e||e instanceof RegExp&&e.test(t)||"string"==typeof e&&t.startsWith(e),n=u.interceptors;if(n)for(const t of n)if(Array.isArray(t.urls)){if(t.urls.some(e))return t}else if(e(t.urls))return t;return null},t.getOrigin=N,t.getPathExtension=function(t){if(r.isNone(t))return null;const e=t.match(V);return e?e[1]:null},t.getProxyRule=q,t.getProxyUrl=function(t=!1){let e,n=u.proxyUrl;if("string"==typeof t){r=t,e=f.test(r)||"https"===$.scheme&&F(r);const o=q(t);o&&(n=o.proxyUrl)}else e=!!t;var r;if(!n)throw s.warn(l),new i("urlutils:proxy-not-set",l);return e&&M()&&(n=W(n)),w(n)},t.hasProtocol=H,t.hasSameOrigin=L,t.hasSamePortal=function(t,e){return t=j(t),e=j(e),_(t)===_(e)},t.isAbsolute=B,t.isAppHTTPS=M,t.isBlobProtocol=k,t.isDataProtocol=E,t.isProtocolRelative=F,t.isSVG=function(t){return K.test(t)},t.isTrustedServer=function(t){if("string"==typeof t){if(!B(t))return!0;t=G(t)}if(L(t,$))return!0;const e=u.trustedServers||[];for(let n=0;n<e.length;n++){const r=S(e[n]);for(let e=0;e<r.length;e++)if(L(t,r[e]))return!0}return!1},t.join=A,t.makeAbsolute=T,t.makeData=function(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`},t.makeRelative=function(t,e=O,n){if(!B(t))return t;const r=I(t),o=r.toLowerCase(),i=I(e).toLowerCase().replace(/\/+$/,""),s=n?I(n).toLowerCase().replace(/\/+$/,""):null;if(s&&0!==i.indexOf(s))return t;const u=(t,e,n)=>-1===(n=t.indexOf(e,n))?t.length:n;let l=u(o,"/",o.indexOf("//")+2),c=-1;for(;o.slice(0,l+1)===i.slice(0,l)+"/"&&(c=l+1,l!==o.length);)l=u(o,"/",l+1);if(-1===c)return t;if(s&&c<s.length)return t;t=r.slice(c);const a=i.slice(c-1).replace(/[^/]+/g,"").length;if(a>0)for(let e=0;e<a;e++)t=`../${t}`;else t=`./${t}`;return t},t.normalize=I,t.objectToQuery=R,t.queryToObject=b,t.removeFile=function(t){let e=0;if(B(t)){const n=t.indexOf("//");-1!==n&&(e=n+2)}const n=t.lastIndexOf("/");return n<e?t:t.slice(0,n+1)},t.removeQueryParameter=function(t,e){const{path:n,query:r}=w(t);if(!r)return t;delete r[e];const o=R(r);return o?`${n}?${o}`:n},t.removeQueryParameters=function(t,e){const n=w(t),r=Object.keys(n.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),n.path},t.removeTrailingSlash=function(t){return t.replace(/\/+$/,"")},t.toHTTP=function(t){return F(t)?`http:${t}`:t.replace(f,"http:")},t.toHTTPS=W,t.trustedServersUrlCache=x,t.urlToObject=w,Object.defineProperty(t,"__esModule",{value:!0})}));
