/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../config","./Error","./Logger","./maybe"],(function(t,e,n,r,o){"use strict";const i=r.getLogger("esri.core.urlUtils"),s=e.request,u="esri/config: esriConfig.request.proxyUrl is not set.",l=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,c=/^\s*http:/i,a=/^\s*https:/i,f=/^\s*file:/i,h=/:\d+$/,p=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,d=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),g=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");let m=function(){function t(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let e=o.assumeNonNull(this.uri.match(d));this.scheme=e[2]||(e[1]?"":null),this.authority=e[4]||(e[3]?"":null),this.path=e[5],this.query=e[7]||(e[6]?"":null),this.fragment=e[9]||(e[8]?"":null),null!=this.authority&&(e=o.assumeNonNull(this.authority.match(g)),this.user=e[3]||null,this.password=e[4]||null,this.host=e[6]||e[7],this.port=e[9]||null)}return t.prototype.toString=function(){return this.uri},t}();const y={},$=new m(e.applicationUrl);let x=$;const O=C();let w=O;const b=()=>x,U=()=>w;function C(){const t=o.assumeNonNull(x.path),e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${x.scheme}://${x.host}${null!=x.port?`:${x.port}`:""}`}${e}`}const P={setAppUrl:t=>x=t,setAppBaseUrl:t=>w=t,restoreUrls:()=>{x=$,w=O}};function R(t){const e={path:null,query:null},n=new m(t),r=t.indexOf("?");return null===n.query?e.path=t:(e.path=t.substring(0,r),e.query=v(n.query)),n.fragment&&(e.hash=n.fragment,null===n.query&&(e.path=e.path.substring(0,e.path.length-(n.fragment.length+1)))),e}function v(t){const e=t.split("&"),n={};for(const r of e){if(!r)continue;const t=r.indexOf("=");let e,o;t<0?(e=decodeURIComponent(r),o=""):(e=decodeURIComponent(r.slice(0,t)),o=decodeURIComponent(r.slice(t+1)));let i=n[e];"string"==typeof i&&(i=n[e]=[i]),Array.isArray(i)?i.push(o):n[e]=o}return n}function q(t){return t&&"object"==typeof t&&"toJSON"in t&&"function"==typeof t.toJSON}function S(t,e){return t?e&&"function"==typeof e?Object.keys(t).map((n=>encodeURIComponent(n)+"="+encodeURIComponent(e(n,t[n])))).join("&"):Object.keys(t).map((n=>{const r=t[n];if(null==r)return"";const o=encodeURIComponent(n)+"=",i=e&&e[n];return i?o+encodeURIComponent(i(r)):Array.isArray(r)?r.map((t=>q(t)?o+encodeURIComponent(JSON.stringify(t)):o+encodeURIComponent(t))).join("&"):q(r)?o+encodeURIComponent(JSON.stringify(r)):o+encodeURIComponent(r)})).filter((t=>t)).join("&"):""}function T(t=!1){let e,r=s.proxyUrl;if("string"==typeof t){e=ft(t);const n=B(t);n&&(r=n.proxyUrl)}else e=!!t;if(!r)throw i.warn(u),new n("urlutils:proxy-not-set",u);e&&yt()&&(r=gt(r));return R(r)}function A(t){const e=B(t);let n,r;if(e){const t=I(e.proxyUrl);n=t.path,r=t.query?v(t.query):null}if(n){const e=R(t);t=n+"?"+e.path;const o=S({...r,...e.query});o&&(t=`${t}?${o}`)}return t}const j={path:"",query:""};function I(t){const e=t.indexOf("?");return-1!==e?(j.path=t.slice(0,e),j.query=t.slice(e+1)):(j.path=t,j.query=null),j}function L(t){return t=(t=$t(t=bt(t=I(t).path),!0)).toLowerCase()}function N(t){const e={proxyUrl:t.proxyUrl,urlPrefix:L(t.urlPrefix)},n=s.proxyRules,r=e.urlPrefix;let o=n.length;for(let i=0;i<n.length;i++){const t=n[i].urlPrefix;if(0===r.indexOf(t)){if(r.length===t.length)return-1;o=i;break}0===t.indexOf(r)&&(o=i+1)}return n.splice(o,0,e),o}function B(t){const e=s.proxyRules,n=L(t);for(let r=0;r<e.length;r++)if(0===n.indexOf(e[r].urlPrefix))return e[r]}function k(t,e){return t=E(t),e=E(e),$t(t)===$t(e)}function E(t){const e=(t=M(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function Q(t){const e=e=>null==e||e instanceof RegExp&&e.test(t)||"string"==typeof e&&t.startsWith(e),n=s.interceptors;if(n)for(const r of n)if(Array.isArray(r.urls)){if(r.urls.some(e))return r}else if(e(r.urls))return r;return null}function D(t,e,n=!1){const r=qt(t),o=qt(e);return!(!n&&r.scheme!==o.scheme)&&(null!=r.host&&null!=o.host&&(r.host.toLowerCase()===o.host.toLowerCase()&&r.port===o.port))}function F(t){if("string"==typeof t){if(!G(t))return!0;t=qt(t)}if(D(t,x))return!0;const e=s.trustedServers||[];for(let n=0;n<e.length;n++){const r=H(e[n]);for(let e=0;e<r.length;e++)if(D(t,r[e]))return!0}return!1}function H(t){return y[t]||(at(t)||ct(t)?y[t]=[new m(J(t))]:y[t]=[new m(`http://${t}`),new m(`https://${t}`)]),y[t]}function J(t,e=w,n){return ct(t)?n&&n.preserveProtocolRelative?t:"http"===x.scheme&&x.authority===_(t).slice(2)?`http:${t}`:`https:${t}`:at(t)?t:o.assumeNonNull(W("/"===t[0]?xt(e):e,t))}function z(t,e=w,n){if(!G(t))return t;const r=M(t),o=r.toLowerCase(),i=M(e).toLowerCase().replace(/\/+$/,""),s=n?M(n).toLowerCase().replace(/\/+$/,""):null;if(s&&0!==i.indexOf(s))return t;const u=(t,e,n)=>-1===(n=t.indexOf(e,n))?t.length:n;let l=u(o,"/",o.indexOf("//")+2),c=-1;for(;o.slice(0,l+1)===i.slice(0,l)+"/"&&(c=l+1,l!==o.length);)l=u(o,"/",l+1);if(-1===c)return t;if(s&&c<s.length)return t;t=r.slice(c);const a=i.slice(c-1).replace(/[^/]+/g,"").length;if(a>0)for(let f=0;f<a;f++)t=`../${t}`;else t=`./${t}`;return t}function M(t){return t=Rt(t=Pt(t=Ct(t=J(t=t.trim()))))}function W(...t){const e=t.filter(o.isSome);if(!e||!e.length)return;const n=[];if(G(e[0])){const t=e[0],r=t.indexOf("//");-1!==r&&(n.push(t.slice(0,r+1)),pt(e[0])&&(n[0]+="/"),e[0]=t.slice(r+2))}else"/"===e[0][0]&&n.push("");const r=e.reduce(((t,e)=>e?t.concat(e.split("/")):t),[]);for(let o=0;o<r.length;o++){const t=r[o];".."===t&&n.length>0&&".."!==n[n.length-1]?n.pop():(!t&&o===r.length-1||t&&("."!==t||0===n.length))&&n.push(t)}return n.join("/")}function _(t,e=!1){if(V(t)||K(t))return null;let n=t.indexOf("://");if(-1===n&&ct(t))n=2;else{if(-1===n)return null;n+=3}const r=t.indexOf("/",n);return-1!==r&&(t=t.slice(0,r)),e&&(t=$t(t,!0)),t}function G(t){return ct(t)||at(t)}function V(t){return null!=t&&"blob:"===t.slice(0,5)}function K(t){return"data:"===t.slice(0,5)}function X(t){const e=tt(t);if(!e||!e.isBase64)return null;const n=atob(e.data),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++)r[o]=n.charCodeAt(o);return r.buffer}function Y(t){return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const Z=/^data:(.*?)(;base64)?,(.*)$/;function tt(t){const e=t.match(Z);if(!e)return null;const[,n,r,o]=e;return{mediaType:n,isBase64:!!r,data:o}}function et(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function nt(t){const e=X(t);if(!e)return null;const n=tt(t);return new Blob([e],{type:n.mediaType})}function rt(t,e){it(t,e)||ut(t,e)}function ot(t,e){st(t,e)||lt(t,e)}function it(t,e){const n=nt(t);return!!n&&st(n,e)}function st(t,e){if(!t)return!1;const n=document.createElement("a");if(!("download"in n))return!1;const r=URL.createObjectURL(t);return n.download=e,n.href=r,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),!0}function ut(t,e){const n=nt(t);return!!n&&lt(n,e)}function lt(t,e){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(t,e)}function ct(t){return null!=t&&void 0!==t&&"/"===t[0]&&"/"===t[1]}function at(t){return l.test(t)}function ft(t){return a.test(t)||"https"===x.scheme&&ct(t)}function ht(t){return c.test(t)||"http"===x.scheme&&ct(t)}function pt(t){return f.test(t)}function dt(t){return ct(t)?`http:${t}`:t.replace(a,"http:")}function gt(t){return ct(t)?`https:${t}`:t.replace(c,"https:")}function mt(){return"http"===x.scheme}function yt(){return"https"===x.scheme}function $t(t,e=!1){return ct(t)?t.slice(2):(t=t.replace(l,""),e&&t.length>1&&"/"===t[0]&&"/"===t[1]&&(t=t.slice(2)),t)}function xt(t){const e=t.indexOf("//"),n=t.indexOf("/",e+2);return-1===n?t:t.slice(0,n)}function Ot(t){let e=0;if(G(t)){const n=t.indexOf("//");-1!==n&&(e=n+2)}const n=t.lastIndexOf("/");return n<e?t:t.slice(0,n+1)}function wt(t,e){if(!t)return"";const n=R(t).path.replace(/\/+$/,""),r=n.substring(n.lastIndexOf("/")+1);if(null==e||!e.length)return r;const o=new RegExp(`.(${e.join("|")})$`,"ig");return r.replace(o,"")}function bt(t){return t&&"/"===t[t.length-1]?t:`${t}/`}function Ut(t){return t.replace(/\/+$/,"")}function Ct(t){if(/^https?:\/\//i.test(t)){const e=I(t);t=(t=e.path.replace(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}function Pt(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function Rt(t){const e=s.httpsDomains;if(!ht(t))return t;const n=t.indexOf("/",7);let r;if(r=-1===n?t:t.slice(0,n),r=r.toLowerCase().slice(7),h.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}return mt()&&r===x.authority&&!p.test(t)||(yt()&&r===x.authority||e&&e.some((t=>r===t||r.endsWith(`.${t}`)))||yt()&&!B(t))&&(t=gt(t)),t}function vt(t,e,n){if(!(e&&n&&t&&G(t)))return t;const r=t.indexOf("//"),o=t.indexOf("/",r+2),i=t.indexOf(":",r+2),s=Math.min(o<0?t.length:o,i<0?t.length:i);if(t.slice(r+2,s).toLowerCase()!==e.toLowerCase())return t;return`${t.slice(0,r+2)}${n}${t.slice(s)}`}function qt(t){return"string"==typeof t?new m(J(t)):(t.scheme||(t.scheme=x.scheme),t)}function St(t){return Bt.test(t)}function Tt(t,e){const n=R(t),r=Object.keys(n.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),n.path}function At(t,e,n){const r=R(t),o=r.query||{};return o[e]=String(n),`${r.path}?${S(o)}`}function jt(t,e){const n=R(t),r=n.query||{};for(const i in e)r[i]=e[i];const o=S(r);return o?`${n.path}?${o}`:n.path}function It(t,e){const{path:n,query:r}=R(t);if(!r)return t;delete r[e];const o=S(r);return o?`${n}?${o}`:n}function Lt(t){if(o.isNone(t))return null;const e=t.match(Nt);return e?e[1]:null}const Nt=/.*?\.([^\/]*)$/,Bt=/(^data:image\/svg|\.svg$)/i;t.Url=m,t.addProxy=A,t.addProxyRule=N,t.addQueryParameter=At,t.addQueryParameters=jt,t.base64UrlEncode=Y,t.changeDomain=vt,t.dataComponents=tt,t.dataToArrayBuffer=X,t.dataToBlob=nt,t.downloadBlobAsFile=ot,t.downloadDataAsFile=rt,t.getAppBaseUrl=U,t.getAppUrl=b,t.getFilename=wt,t.getInterceptor=Q,t.getOrigin=_,t.getPathExtension=Lt,t.getProxyRule=B,t.getProxyUrl=T,t.hasProtocol=at,t.hasSameOrigin=D,t.hasSamePortal=k,t.isAbsolute=G,t.isAppHTTPS=yt,t.isBlobProtocol=V,t.isDataProtocol=K,t.isHTTPSProtocol=ft,t.isProtocolRelative=ct,t.isSVG=St,t.isTrustedServer=F,t.join=W,t.makeAbsolute=J,t.makeData=et,t.makeRelative=z,t.normalize=M,t.objectToQuery=S,t.queryToObject=v,t.removeFile=Ot,t.removeQueryParameter=It,t.removeQueryParameters=Tt,t.removeTrailingSlash=Ut,t.test=P,t.toHTTP=dt,t.toHTTPS=gt,t.trustedServersUrlCache=y,t.urlToObject=R,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
