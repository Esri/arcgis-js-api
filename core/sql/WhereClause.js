/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../has","./AggregateFunctions","./StandardizedFunctions","./WhereGrammar"],(function(e,t,r,a,n,s){"use strict";const i=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,l=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,u=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,o=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,c=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/;function h(e,t){return(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e}function d(e,t,r="0",a="0",n="0",s="0",i="",l="0",u="0"){if("+"===i||"-"===i){const o=`${h(parseInt(e,10),4)}-${h(parseInt(t,10),2)}-${h(parseInt(r,10),2)}`;let c="";parseFloat(s)<10&&(c="0");const d=`${h(parseInt(a,10),2)}:${h(parseInt(n,10),2)}:${c+parseFloat(s).toString()}`,p=`${i}${h(parseInt(l,10),2)}:${h(parseInt(u,10),2)}`;return new Date(o+"T"+d+p)}return new Date(parseInt(e,10),parseInt(t,10)-1,parseInt(r,10),parseInt(a,10),parseInt(n,10),parseFloat(s))}let p=function(){function e(){}return e.makeBool=function(e){return m(e)},e.featureValue=function(e,t,r,a){return _(e,t,r,a)},e.equalsNull=function(e){return null===e},e.applyLike=function(e,t,r){return y(e,t,r)},e.ensureArray=function(e){return g(e)},e.applyIn=function(e,t){return w(e,t)},e.currentDate=function(){const e=new Date;return e.setHours(0,0,0,0),e},e.makeSqlInterval=function(e,t,r){return n.SqlInterval.createFromValueAndQualifer(e,t,r)},e.convertInterval=function(e){return e instanceof n.SqlInterval?e.valueInMilliseconds():e},e.currentTimestamp=function(){return new Date},e.compare=function(e,t,r){return A(e,t,r)},e.calculate=function(e,t,r){return x(e,t,r)},e.makeComparable=function(e){return J(e)},e.evaluateFunction=function(e,t){return n.evaluateFunction(e,t)},e.lookup=function(e,t){const r=t[e];return void 0===r?null:r},e.between=function(e,t){return null==e||null==t[0]||null==t[1]?null:e>=t[0]&&e<=t[1]},e.notbetween=function(e,t){return null==e||null==t[0]||null==t[1]?null:e<t[0]||e>t[1]},e.ternaryNot=function(e){return T(e)},e.ternaryAnd=function(e,t){return S(e,t)},e.ternaryOr=function(e,t){return I(e,t)},e}(),f=function(){function e(e,t){this.fieldsIndex=t,this.datefields={},this.parameters={},this.parseTree=s.WhereGrammar.parse(e);const{isStandardized:r,isAggregate:a,referencedFieldNames:n}=this.extractExpressionInfo(t);this.referencedFieldNames=n,this.isStandardized=r,this.isAggregate=a}e.create=function(t,r){return new e(t,r)};var i=e.prototype;return i.testSet=function(e,t=E){const r={};for(const a of this.fieldNames)r[a]=e.map((e=>t.getAttribute(e,a)));return!!this.evaluateNode(this.parseTree,{attributes:r},E)},i.calculateValue=function(e,t=E){const r=this.evaluateNode(this.parseTree,e,t);return r instanceof n.SqlInterval?r.valueInMilliseconds()/864e5:r},i.calculateValueCompiled=function(e,t=E){return null!=this.parseTree._compiledVersion?this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):r("csp-restrictions")?this.calculateValue(e,t):(this.compileMe(),this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))},i.testFeature=function(e,t=E){return!!this.evaluateNode(this.parseTree,e,t)},i.testFeatureCompiled=function(e,t=E){return null!=this.parseTree._compiledVersion?!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):r("csp-restrictions")?this.testFeature(e,t):(this.compileMe(),!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))},i.getFunctions=function(){const e=[];return this.visitAll(this.parseTree,(t=>{"function"===t.type&&e.push(t.name.toLowerCase())})),b(e)},i.getExpressions=function(){const e=new Map;return this.visitAll(this.parseTree,(t=>{if("function"===t.type){const r=t.name.toLowerCase(),a=t.args.value[0];if("column_ref"===a.type){const t=a.column,n=`${r}-${t}`;e.has(n)||e.set(n,{aggregateType:r,field:t})}}})),[...e.values()]},i.getVariables=function(){const e=[];return this.visitAll(this.parseTree,(t=>{"param"===t.type&&e.push(t.value.toLowerCase())})),b(e)},i.compileMe=function(){const e="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=new Function("feature","lookups","attributeAdapter","datefields",e).bind(p)},i.extractExpressionInfo=function(e){const t=[];let r=!0,s=!0;return this.visitAll(this.parseTree,(i=>{switch(i.type){case"column_ref":{const r=e.get(i.column),a=r&&r.name;!r||"date"!==r.type&&"esriFieldTypeDate"!==r.type||(this.datefields[r.name]=1),void 0!==a?(t.push(a),i.column=a):t.push(i.column);break}case"function":{const{name:e,args:t}=i,l=t.value.length;r&&(r=n.isStandardized(e,l)),s&&(s=a.isAggregate(e,l));break}}})),{referencedFieldNames:b(t),isStandardized:r,isAggregate:s}},i.visitAll=function(e,t){if(null!=e)switch(t(e),e.type){case"when_clause":this.visitAll(e.operand,t),this.visitAll(e.value,t);break;case"case_expression":for(const r of e.clauses)this.visitAll(r,t);"simple"===e.format&&this.visitAll(e.operand,t),null!==e.else&&this.visitAll(e.else,t);break;case"expr_list":for(const r of e.value)this.visitAll(r,t);break;case"unary_expr":this.visitAll(e.expr,t);break;case"binary_expr":this.visitAll(e.left,t),this.visitAll(e.right,t);break;case"function":this.visitAll(e.args,t)}},i.evaluateNodeToJavaScript=function(e){switch(e.type){case"interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(e.value)+", "+JSON.stringify(e.qualifier)+","+JSON.stringify(e.op)+")";case"case_expression":{let t="";if("simple"===e.format){const r="this.makeComparable("+this.evaluateNodeToJavaScript(e.operand)+")";t="( ";for(let a=0;a<e.clauses.length;a++)t+=" ("+r+" === this.makeComparable("+this.evaluateNodeToJavaScript(e.clauses[a].operand)+")) ? ("+this.evaluateNodeToJavaScript(e.clauses[a].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}else{t="( ";for(let r=0;r<e.clauses.length;r++)t+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[r].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[r].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}return t}case"param":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expr_list":{let t="[";for(const r of e.value)"["!==t&&(t+=","),t+=this.evaluateNodeToJavaScript(r);return t+="]",t}case"unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary_expr":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"*":case"-":case"+":case"/":return"this.calculate("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")"}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return JSON.stringify(e.value);case"date":return"(new Date("+N(e.value).getTime().toString()+"))";case"timestamp":return"(new Date("+v(e.value).getTime().toString()+"))";case"current_time":return"date"===e.mode?"this.currentDate()":"this.currentTimestamp()";case"column_ref":return"this.featureValue(feature,"+JSON.stringify(e.column)+",datefields,attributeAdapter)";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+")"}throw new Error("Unsupported sql syntax "+e.type)},i.evaluateNode=function(e,t,r){switch(e.type){case"interval":{const a=this.evaluateNode(e.value,t,r);return n.SqlInterval.createFromValueAndQualifer(a,e.qualifier,e.op)}case"case_expression":if("simple"===e.format){const a=J(this.evaluateNode(e.operand,t,r));for(let n=0;n<e.clauses.length;n++)if(a===J(this.evaluateNode(e.clauses[n].operand,t,r)))return this.evaluateNode(e.clauses[n].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}else{for(let a=0;a<e.clauses.length;a++)if(m(this.evaluateNode(e.clauses[a].operand,t,r)))return this.evaluateNode(e.clauses[a].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":{const a=[];for(const n of e.value)a.push(this.evaluateNode(n,t,r));return a}case"unary_expr":return T(this.evaluateNode(e.expr,t,r));case"binary_expr":switch(e.operator){case"AND":return S(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"OR":return I(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,t,r);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,t,r);case"IN":{const a=g(this.evaluateNode(e.right,t,r));return w(this.evaluateNode(e.left,t,r),a)}case"NOT IN":{const a=g(this.evaluateNode(e.right,t,r));return T(w(this.evaluateNode(e.left,t,r),a))}case"BETWEEN":{const a=this.evaluateNode(e.left,t,r),n=this.evaluateNode(e.right,t,r);return null==a||null==n[0]||null==n[1]?null:a>=J(n[0])&&a<=J(n[1])}case"NOTBETWEEN":{const a=this.evaluateNode(e.left,t,r),n=this.evaluateNode(e.right,t,r);return null==a||null==n[0]||null==n[1]?null:a<J(n[0])||a>J(n[1])}case"LIKE":return y(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape);case"NOT LIKE":return T(y(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return A(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"-":case"+":case"*":case"/":return x(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r))}case"null":case"bool":case"string":case"number":return e.value;case"date":return N(e.value);case"timestamp":return v(e.value);case"current_time":{const t=new Date;return"date"===e.mode&&t.setHours(0,0,0,0),t}case"column_ref":return _(t,e.column,this.datefields,r);case"function":{const s=this.evaluateNode(e.args,t,r);return this.isAggregate?a.aggregateFunction(e.name,s):n.evaluateFunction(e.name,s)}}throw new Error("Unsupported sql syntax "+e.type)},t._createClass(e,[{key:"fieldNames",get:function(){return this.referencedFieldNames}}]),e}();function v(e){let t=l.exec(e);if(null!==t){const[,e,r,a,n,s,i]=t;return d(e,r,a,n,s,i)}if(t=u.exec(e),null!==t){const[,e,r,a,n,s,i,l,u,o]=t;return d(e,r,a,n,s,i,l,u,o)}if(t=o.exec(e),null!==t){const[,e,r,a,n,s,i,l,u]=t;return d(e,r,a,n,s,"0",i,l,u)}if(t=c.exec(e),null!==t){const[,e,r,a,n,s]=t;return d(e,r,a,n,s)}if(t=i.exec(e),null!==t){const[,e,r,a]=t;return d(e,r,a)}throw new Error("SQL Invalid Timestamp")}function N(e){const t=i.exec(e);if(null===t)throw new Error("SQL Invalid Date");const[,r,a,n]=t;return new Date(parseInt(r,10),parseInt(a,10)-1,parseInt(n,10))}function m(e){return!0===e}function g(e){return Array.isArray(e)?e:[e]}function T(e){return null!==e?!0!==e:null}function S(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function I(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function w(e,t){if(null==e)return null;let r=!1;for(const a of t)if(null==a)r=null;else if(e===a){r=!0;break}return r}function y(e,t,r){if(null==e)return null;const a=t,n=r;let s="";const i="-[]/{}()*+?.\\^$|";let l=0;for(let u=0;u<a.length;u++){const e=a.charAt(u);switch(l){case 0:e===n?l=1:i.indexOf(e)>=0?s+="\\"+e:s+="%"===e?".*":"_"===e?".":e;break;case 1:i.indexOf(e)>=0?s+="\\"+e:s+=e,l=0}}return new RegExp("^"+s+"$").test(e)}function J(e){return e instanceof Date?e.valueOf():e}function A(e,t,r){if(null==t||null==r)return null;const a=J(t),n=J(r);switch(e){case"<>":return a!==n;case"=":return a===n;case">":return a>n;case"<":return a<n;case">=":return a>=n;case"<=":return a<=n}}function b(e){const t=[],r={};for(const a of e){const e=a.toLowerCase();void 0===r[e]&&(t.push(a),r[e]=1)}return t}function x(e,t,r){if(t instanceof n.SqlInterval)if(r instanceof Date)switch(e){case"+":return new Date(t.valueInMilliseconds()+r.getTime());case"-":return t.valueInMilliseconds()-r.getTime();case"*":return t.valueInMilliseconds()*r.getTime();case"/":return t.valueInMilliseconds()/r.getTime()}else if(r instanceof n.SqlInterval)switch(e){case"+":return n.SqlInterval.createFromMilliseconds(t.valueInMilliseconds()+r.valueInMilliseconds());case"-":return n.SqlInterval.createFromMilliseconds(t.valueInMilliseconds()-r.valueInMilliseconds());case"*":return t.valueInMilliseconds()*r.valueInMilliseconds();case"/":return t.valueInMilliseconds()/r.valueInMilliseconds()}else t=t.valueInMilliseconds();else if(r instanceof n.SqlInterval)if(t instanceof Date)switch(e){case"+":return new Date(r.valueInMilliseconds()+t.getTime());case"-":return new Date(t.getTime()-r.valueInMilliseconds());case"*":return t.getTime()*r.valueInMilliseconds();case"/":return t.getTime()/r.valueInMilliseconds()}else r=r.valueInMilliseconds();else if(t instanceof Date&&"number"==typeof r)switch(r=24*r*60*60*1e3,t=t.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}else if(r instanceof Date&&"number"==typeof t)switch(t=24*t*60*60*1e3,r=r.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}switch(e){case"+":return t+r;case"-":return t-r;case"*":return t*r;case"/":return t/r}}function D(e){return e&&"object"==typeof e.attributes}function _(e,t,r,a){const n=a.getAttribute(e,t);return null!=n&&1===r[t]?new Date(n):n}const E={getAttribute:(e,t)=>(D(e)?e.attributes:e)[t]};e.WhereClause=f,e.defaultAttributeAdapter=E,Object.defineProperty(e,"__esModule",{value:!0})}));
