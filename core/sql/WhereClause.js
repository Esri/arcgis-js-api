// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/array","@dojo/framework/shim/Map","../../moment","./AggregateFunctions","./StandardizedFunctions","./WhereGrammar"],function(e,t,r,a,n,s,u,i){function l(e){return e&&"object"==typeof e.attributes}function o(e){return n(e,["YYYY-M-D H:m:s","YYYY-M-D H:mZ","YYYY-M-D H:m:sZ","YYYY-M-D H:m","YYYY-m-d"]).toDate()}function c(e){return n(e,["YYYY-M-D"]).toDate()}function h(e){return!0===e}function f(e){return Array.isArray(e)?e:[e]}function v(e){return null!==e?!0!==e:null}function p(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function d(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function g(e,t){if(null==e)return null;for(var r=!1,a=0,n=t;a<n.length;a++){var s=n[a];if(null==s)r=null;else if(e===s){r=!0;break}}return r}function N(e,t,r){if(null==e)return null;for(var a=t,n=r,s="",u="-[]/{}()*+?.\\^$|",i=0,l=0;l<a.length;l++){var o=a.charAt(l);switch(i){case 0:o===n?i=1:u.indexOf(o)>=0?s+="\\"+o:s+="%"===o?".*":"_"===o?".":o;break;case 1:u.indexOf(o)>=0?s+="\\"+o:s+=o,i=0}}return new RegExp("^"+s+"$").test(e)}function m(e){return e instanceof Date?e.valueOf():e}function y(e,t,r){if(null==t||null==r)return null;var a=m(t),n=m(r);switch(e){case"<>":return a!==n;case"=":return a===n;case">":return a>n;case"<":return a<n;case">=":return a>=n;case"<=":return a<=n}}function A(e){for(var t=[],r={},a=0,n=e;a<n.length;a++){var s=n[a],u=s.toLowerCase();void 0===r[u]&&(t.push(s),r[u]=1)}return t}return function(){function e(){this.parseTree=null,this.parameters=null,this._hasStandardizedFunctions=null,this._hasAggregateFunctions=null}return e.create=function(t){var r=new e;r.parseTree=i.WhereGrammar.parse(t);var a=!0,n=!0;return r.visitAll(r.parseTree,function(e){if("function"===e.type){var t=e.name,r=e.args,i=r.value.length;a&&(a=u.isStandardized(t,i)),n&&(n=s.isAggregate(t,i))}}),r._hasStandardizedFunctions=a,r._hasAggregateFunctions=n,r},e.prototype.isStandardized=function(){return this._hasStandardizedFunctions},e.prototype.isAggregate=function(){return this._hasAggregateFunctions},e.prototype.setVariablesDictionary=function(e){this.parameters=e},e.prototype.testFeature=function(e){return!!this.evaluateNode(this.parseTree,e)},e.prototype.testSet=function(e){var t=this,r=new a.default;this.visitAll(this.parseTree,function(e){"column_ref"!==e.type||r.has(e.column)||r.set(e.column,e)});for(var n={},s=0,u=e;s<u.length;s++){var i=u[s];!function(e){r.forEach(function(r,a){var s=t.featureValue(e,a,r);n[a]?n[a].push(s):n[a]=[s]})}(i)}return!!this.evaluateNode(this.parseTree,{attributes:n})},e.prototype.calculateValue=function(e){return this.evaluateNode(this.parseTree,e)},e.prototype.getFunctions=function(){var e=[];return this.visitAll(this.parseTree,function(t){"function"===t.type&&e.push(t.name.toLowerCase())}),A(e)},e.prototype.getExpressions=function(){var e=new a.default;return this.visitAll(this.parseTree,function(t){if("function"===t.type){var r=t.name.toLowerCase(),a=t.args.value[0];if("column_ref"===a.type){var n=a.column,s=r+"-"+n;e.has(s)||e.set(s,{aggregateType:r,field:n})}}}),r.from(e.values())},e.prototype.getFields=function(){var e=[];return this.visitAll(this.parseTree,function(t){"column_ref"===t.type&&e.push(t.column)}),A(e)},e.prototype.getVariables=function(){var e=[];return this.visitAll(this.parseTree,function(t){"param"===t.type&&e.push(t.value.toLowerCase())}),A(e)},e.prototype.featureValue=function(e,t,r){var a=l(e)?e.attributes:e,n=a[t];if(void 0!==n)return n;for(var s in a)if(t.toLowerCase()===s.toLowerCase())return r.column=s,a[s];return null},e.prototype.visitAll=function(e,t){if(null!=e)switch(t(e),e.type){case"when_clause":this.visitAll(e.operand,t),this.visitAll(e.value,t);break;case"case_expression":for(var r=0,a=e.clauses;r<a.length;r++){var n=a[r];this.visitAll(n,t)}"simple"===e.format&&this.visitAll(e.operand,t),null!==e.else&&this.visitAll(e.else,t);break;case"expr_list":for(var s=0,u=e.value;s<u.length;s++){var n=u[s];this.visitAll(n,t)}break;case"unary_expr":this.visitAll(e.expr,t);break;case"binary_expr":this.visitAll(e.left,t),this.visitAll(e.right,t);break;case"function":this.visitAll(e.args,t)}},e.prototype.evaluateNode=function(e,t){switch(e.type){case"case_expression":if("simple"===e.format){for(var r=m(this.evaluateNode(e.operand,t)),a=0;a<e.clauses.length;a++)if(r===m(this.evaluateNode(e.clauses[a].operand,t)))return this.evaluateNode(e.clauses[a].value,t);if(null!==e.else)return this.evaluateNode(e.else,t)}else{for(var a=0;a<e.clauses.length;a++)if(h(this.evaluateNode(e.clauses[a].operand,t)))return this.evaluateNode(e.clauses[a].value,t);if(null!==e.else)return this.evaluateNode(e.else,t)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":for(var n=[],i=0,l=e.value;i<l.length;i++){var A=l[i];n.push(this.evaluateNode(A,t))}return n;case"unary_expr":return v(this.evaluateNode(e.expr,t));case"binary_expr":switch(e.operator){case"AND":return p(this.evaluateNode(e.left,t),this.evaluateNode(e.right,t));case"OR":return d(this.evaluateNode(e.left,t),this.evaluateNode(e.right,t));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,t);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,t);case"IN":var w=f(this.evaluateNode(e.right,t));return g(this.evaluateNode(e.left,t),w);case"NOT IN":var w=f(this.evaluateNode(e.right,t));return v(g(this.evaluateNode(e.left,t),w));case"BETWEEN":var Y=this.evaluateNode(e.left,t),T=this.evaluateNode(e.right,t);return null==Y||null==T[0]||null==T[1]?null:Y>=T[0]&&Y<=T[1];case"NOTBETWEEN":var Y=this.evaluateNode(e.left,t),T=this.evaluateNode(e.right,t);return null==Y||null==T[0]||null==T[1]?null:Y<T[0]||Y>T[1];case"LIKE":return N(this.evaluateNode(e.left,t),this.evaluateNode(e.right,t),e.escape);case"NOT LIKE":return v(N(this.evaluateNode(e.left,t),this.evaluateNode(e.right,t),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return y(e.operator,this.evaluateNode(e.left,t),this.evaluateNode(e.right,t));case"*":return this.evaluateNode(e.left,t)*this.evaluateNode(e.right,t);case"-":return this.evaluateNode(e.left,t)-this.evaluateNode(e.right,t);case"+":return this.evaluateNode(e.left,t)+this.evaluateNode(e.right,t);case"/":return this.evaluateNode(e.left,t)/this.evaluateNode(e.right,t)}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return e.value;case"date":return c(e.value);case"timestamp":return o(e.value);case"column_ref":if("CURRENT_DATE"===e.column.toUpperCase()){var A=new Date;return A.setHours(0,0,0,0),A}return"CURRENT_TIMESTAMP"===e.column.toUpperCase()?new Date:this.featureValue(t,e.column,e);case"function":var _=this.evaluateNode(e.args,t);return this.isAggregate()?s.aggregateFunction(e.name,_):u.evaluateFunction(e.name,_)}throw new Error("Unsupported sql syntax "+e.type)},e}()});