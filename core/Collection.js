/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","./ArrayPool","./Evented","./lang","./maybe","./ObjectPool","./ObservableChangesType","./scheduling","./accessorSupport/decorators/property","./accessorSupport/ensureType","./accessorSupport/decorators/shared","./accessorSupport/decorators/subclass","./accessorSupport/tracking","./accessorSupport/tracking/SimpleObservable"],(function(e,t,s,i,n,r,c,h,a,o,l,f,u,b,_){"use strict";var g;const p=new c(function(){function e(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}var t=e.prototype;return t.preventDefault=function(){this.cancellable&&(this.defaultPrevented=!0)},t.reset=function(e){this.defaultPrevented=!1,this.item=e},e}(),void 0,(e=>{e.item=null,e.target=null,e.defaultPrevented=!1,e.cancellable=!1})),m=()=>{};function v(e){return e?e instanceof M?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]}function d(e){if(e&&e.length)return e[0]}function y(e,t,s,i){const n=Math.min(e.length-s,t.length-i);let r=0;for(;r<n&&e[s+r]===t[i+r];)r++;return r}function A(e,t,s,i){t&&t.forEach(((t,n,r)=>{e.push(t),A(e,s.call(i,t,n,r),s,i)}))}const C=new Set,O=new Set,E=new Set,k=new Map;let T=0,M=g=function(t,i){function c(s){var i;return(i=t.call(this,s)||this)._chgListeners=[],i._notifications=null,i._timer=null,i._observable=new _.SimpleObservable,i.length=0,i._items=[],Object.defineProperty(e._assertThisInitialized(i),"uid",{value:T++}),i}e._inheritsLoose(c,t),c.isCollection=function(e){return null!=e&&e instanceof g};var o=c.prototype;return o.normalizeCtorArgs=function(e){return e?Array.isArray(e)||e instanceof g?{items:e}:e:{}},o.destroy=function(){this.removeAll()},o[i]=function*(){yield*this.items},o.hasEventListener=function(e){return"change"===e?this._chgListeners.length>0:this._emitter.hasEventListener(e)},o.on=function(e,t){if("change"===e){const e=this._chgListeners,s={removed:!1,callback:t};return e.push(s),this._notifications&&this._notifications.push({listeners:e.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=m,s.removed=!0,e.splice(e.indexOf(s),1)}}}return this._emitter.on(e,t)},o.once=function(e,t){const s=this.on(e,t);return{remove(){s.remove()}}},o.add=function(e,t){if(b.trackAccess(this._observable),this._emitBeforeChanges(h.ObservableChangesType.ADD))return this;const s=this.getNextIndex(null!=t?t:null);return this._splice(s,0,[e]),this._emitAfterChanges(h.ObservableChangesType.ADD),this},o.addMany=function(e,t=this._items.length){if(b.trackAccess(this._observable),!e||!e.length)return this;if(this._emitBeforeChanges(h.ObservableChangesType.ADD))return this;const s=this.getNextIndex(t);return this._splice(s,0,v(e)),this._emitAfterChanges(h.ObservableChangesType.ADD),this},o.at=function(e){if(b.trackAccess(this._observable),(e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this._items[e]},o.removeAll=function(){if(b.trackAccess(this._observable),!this.length||this._emitBeforeChanges(h.ObservableChangesType.REMOVE))return[];const e=this._splice(0,this.length)||[];return this._emitAfterChanges(h.ObservableChangesType.REMOVE),e},o.clone=function(){return b.trackAccess(this._observable),this._createNewInstance({items:this._items.map(n.clone)})},o.concat=function(...e){b.trackAccess(this._observable);const t=e.map(v);return this._createNewInstance({items:this._items.concat(...t)})},o.drain=function(e,t){if(b.trackAccess(this._observable),!this.length||this._emitBeforeChanges(h.ObservableChangesType.REMOVE))return;const s=r.assumeNonNull(this._splice(0,this.length)),i=s.length;for(let n=0;n<i;n++)e.call(t,s[n],n,s);this._emitAfterChanges(h.ObservableChangesType.REMOVE)},o.every=function(e,t){return b.trackAccess(this._observable),this._items.every(e,t)},o.filter=function(e,t){let s;return b.trackAccess(this._observable),s=2===arguments.length?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:s})},o.find=function(e,t){return b.trackAccess(this._observable),this._items.find(e,t)},o.findIndex=function(e,t){return b.trackAccess(this._observable),this._items.findIndex(e,t)},o.flatten=function(e,t){b.trackAccess(this._observable);const s=[];return A(s,this,e,t),new g(s)},o.forEach=function(e,t){return b.trackAccess(this._observable),this._items.forEach(e,t)},o.getItemAt=function(e){return b.trackAccess(this._observable),this._items[e]},o.getNextIndex=function(e){b.trackAccess(this._observable);const t=this.length;return(e=null==e?t:e)<0?e=0:e>t&&(e=t),e},o.includes=function(e,t=0){return b.trackAccess(this._observable),this._items.includes(e,t)},o.indexOf=function(e,t=0){return b.trackAccess(this._observable),this._items.indexOf(e,t)},o.join=function(e=","){return b.trackAccess(this._observable),this._items.join(e)},o.lastIndexOf=function(e,t=this.length-1){return b.trackAccess(this._observable),this._items.lastIndexOf(e,t)},o.map=function(e,t){b.trackAccess(this._observable);const s=this._items.map(e,t);return new g({items:s})},o.reorder=function(e,t=this.length-1){b.trackAccess(this._observable);const s=this.indexOf(e);if(-1!==s){if(t<0?t=0:t>=this.length&&(t=this.length-1),s!==t){if(this._emitBeforeChanges(h.ObservableChangesType.MOVE))return e;this._splice(s,1),this._splice(t,0,[e]),this._emitAfterChanges(h.ObservableChangesType.MOVE)}return e}},o.pop=function(){if(b.trackAccess(this._observable),!this.length||this._emitBeforeChanges(h.ObservableChangesType.REMOVE))return;const e=d(this._splice(this.length-1,1));return this._emitAfterChanges(h.ObservableChangesType.REMOVE),e},o.push=function(...e){return b.trackAccess(this._observable),this._emitBeforeChanges(h.ObservableChangesType.ADD)||(this._splice(this.length,0,e),this._emitAfterChanges(h.ObservableChangesType.ADD)),this.length},o.reduce=function(e,t){b.trackAccess(this._observable);const s=this._items;return 2===arguments.length?s.reduce(e,t):s.reduce(e)},o.reduceRight=function(e,t){b.trackAccess(this._observable);const s=this._items;return 2===arguments.length?s.reduceRight(e,t):s.reduceRight(e)},o.remove=function(e){return b.trackAccess(this._observable),this.removeAt(this.indexOf(e))},o.removeAt=function(e){if(b.trackAccess(this._observable),e<0||e>=this.length||this._emitBeforeChanges(h.ObservableChangesType.REMOVE))return;const t=d(this._splice(e,1));return this._emitAfterChanges(h.ObservableChangesType.REMOVE),t},o.removeMany=function(e){if(b.trackAccess(this._observable),!e||!e.length||this._emitBeforeChanges(h.ObservableChangesType.REMOVE))return[];const t=e instanceof g?e.toArray():e,s=this._items,i=[],n=t.length;for(let r=0;r<n;r++){const e=t[r],n=s.indexOf(e);if(n>-1){const e=1+y(t,s,r+1,n+1),c=this._splice(n,e);c&&c.length>0&&i.push.apply(i,c),r+=e-1}}return this._emitAfterChanges(h.ObservableChangesType.REMOVE),i},o.reverse=function(){if(b.trackAccess(this._observable),this._emitBeforeChanges(h.ObservableChangesType.MOVE))return this;const e=this._splice(0,this.length);return e&&(e.reverse(),this._splice(0,0,e)),this._emitAfterChanges(h.ObservableChangesType.MOVE),this},o.shift=function(){if(b.trackAccess(this._observable),!this.length||this._emitBeforeChanges(h.ObservableChangesType.REMOVE))return;const e=d(this._splice(0,1));return this._emitAfterChanges(h.ObservableChangesType.REMOVE),e},o.slice=function(e=0,t=this.length){return b.trackAccess(this._observable),this._createNewInstance({items:this._items.slice(e,t)})},o.some=function(e,t){return b.trackAccess(this._observable),this._items.some(e,t)},o.sort=function(e){if(b.trackAccess(this._observable),!this.length||this._emitBeforeChanges(h.ObservableChangesType.MOVE))return this;const t=r.assumeNonNull(this._splice(0,this.length));return arguments.length?t.sort(e):t.sort(),this._splice(0,0,t),this._emitAfterChanges(h.ObservableChangesType.MOVE),this},o.splice=function(e,t,...s){b.trackAccess(this._observable);const i=(t?h.ObservableChangesType.REMOVE:0)|(s.length?h.ObservableChangesType.ADD:0);if(this._emitBeforeChanges(i))return[];const n=this._splice(e,t,s)||[];return this._emitAfterChanges(i),n},o.toArray=function(){return b.trackAccess(this._observable),this._items.slice()},o.toJSON=function(){return b.trackAccess(this._observable),this.toArray()},o.toLocaleString=function(){return b.trackAccess(this._observable),this._items.toLocaleString()},o.toString=function(){return b.trackAccess(this._observable),this._items.toString()},o.unshift=function(...e){return b.trackAccess(this._observable),!e.length||this._emitBeforeChanges(h.ObservableChangesType.ADD)||(this._splice(0,0,e),this._emitAfterChanges(h.ObservableChangesType.ADD)),this.length},o._createNewInstance=function(e){return new this.constructor(e)},o._splice=function(e,t,s){const i=this._items,n=this.itemType;let r,c;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=a.schedule((()=>this._dispatchChange()))),t){if(c=i.splice(e,t),this.hasEventListener("before-remove")){const t=p.acquire();t.target=this,t.cancellable=!0;for(let s=0,n=c.length;s<n;s++)r=c[s],t.reset(r),this.emit("before-remove",t),t.defaultPrevented&&(c.splice(s,1),i.splice(e,0,r),e+=1,s-=1,n-=1);p.release(t)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const e=p.acquire();e.target=this,e.cancellable=!1;const t=c.length;for(let s=0;s<t;s++)e.reset(c[s]),this.emit("after-remove",e);p.release(e)}}if(s&&s.length){if(n){const e=[];for(const t of s){const s=n.ensureType(t);null==s&&null!=t||e.push(s)}s=e}const t=this.hasEventListener("before-add"),r=this.hasEventListener("after-add"),c=e===this.length;if(t||r){const n=p.acquire();n.target=this,n.cancellable=!0;const h=p.acquire();h.target=this,h.cancellable=!1;for(const a of s)t?(n.reset(a),this.emit("before-add",n),n.defaultPrevented||(c?i.push(a):i.splice(e++,0,a),this._set("length",i.length),r&&(h.reset(a),this.emit("after-add",h)))):(c?i.push(a):i.splice(e++,0,a),this._set("length",i.length),h.reset(a),this.emit("after-add",h));p.release(h),p.release(n)}else{if(c)for(const e of s)i.push(e);else i.splice(e,0,...s);this._set("length",i.length)}}return(s&&s.length||c&&c.length)&&this._notifyChangeEvent(s,c),c},o._emitBeforeChanges=function(e){let t=!1;if(this.hasEventListener("before-changes")){const s=p.acquire();s.target=this,s.cancellable=!0,s.type=e,this.emit("before-changes",s),t=s.defaultPrevented,p.release(s)}return t},o._emitAfterChanges=function(e){if(this.hasEventListener("after-changes")){const t=p.acquire();t.target=this,t.cancellable=!1,t.type=e,this.emit("after-changes",t),p.release(t)}this._observable.notify()},o._notifyChangeEvent=function(e,t){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:e,removed:t})},o._dispatchChange=function(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const e=this._notifications;this._notifications=null;for(const t of e){const e=t.changes;C.clear(),O.clear(),E.clear();for(const{added:t,removed:s}of e){if(t)if(0===E.size&&0===O.size)for(const e of t)C.add(e);else for(const e of t)O.has(e)?(E.add(e),O.delete(e)):E.has(e)||C.add(e);if(s)if(0===E.size&&0===C.size)for(const e of s)O.add(e);else for(const e of s)C.has(e)?C.delete(e):(E.delete(e),O.add(e))}const i=s.acquire();C.forEach((e=>{i.push(e)}));const n=s.acquire();O.forEach((e=>{n.push(e)}));const r=this._items,c=t.items,h=s.acquire();if(E.forEach((e=>{c.indexOf(e)!==r.indexOf(e)&&h.push(e)})),t.listeners&&(i.length||n.length||h.length)){const e={target:this,added:i,removed:n,moved:h},s=t.listeners.length;for(let i=0;i<s;i++){const s=t.listeners[i];s.removed||s.callback.call(this,e)}}s.release(i),s.release(n),s.release(h)}C.clear(),O.clear(),E.clear()},e._createClass(c,[{key:"items",get:function(){return b.trackAccess(this._observable),this._items},set:function(e){this._emitBeforeChanges(h.ObservableChangesType.ADD)||(this._splice(0,this.length,v(e)),this._emitAfterChanges(h.ObservableChangesType.ADD))}}]),c}(i.EventedAccessor,Symbol.iterator);M.ofType=s=>{if(!s)return g;if(k.has(s))return k.get(s);let i=null;if("function"==typeof s)i=s.prototype.declaredClass;else if(s.base)i=s.base.prototype.declaredClass;else for(const e in s.typeMap){const t=s.typeMap[e].prototype.declaredClass;i?i+=` | ${t}`:i=t}let n=function(t){function s(){return t.apply(this,arguments)||this}return e._inheritsLoose(s,t),s}(g);return t.__decorate([f.shared({Type:s,ensureType:"function"==typeof s?l.ensureType(s):l.ensureOneOfType(s)})],n.prototype,"itemType",void 0),n=t.__decorate([u.subclass(`esri.core.Collection<${i}>`)],n),k.set(s,n),n},t.__decorate([o.property()],M.prototype,"length",void 0),t.__decorate([o.property()],M.prototype,"items",null),M=g=t.__decorate([u.subclass("esri.core.Collection")],M);return M}));
