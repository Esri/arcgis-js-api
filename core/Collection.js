// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","./ArrayPool","./arrayUtils","./Evented","./lang","./maybe","./ObjectPool","./scheduling","./accessorSupport/ensureType","./accessorSupport/decorators/property","./accessorSupport/decorators/subclass"],(function(e,t,i,r,n,s,o,h,a,l,c,f,p){"use strict";var u=new a(function(){function e(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}return e.prototype.preventDefault=function(){this.cancellable&&(this.defaultPrevented=!0)},e.prototype.reset=function(e){this.defaultPrevented=!1,this.item=e},e}(),void 0,(function(e){e.item=null,e.target=null,e.defaultPrevented=!1,e.cancellable=!1})),g=function(){};function _(e){return e?e instanceof x?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]}function d(e){if(e&&e.length)return e[0]}function v(e,t,i,r){for(var n=Math.min(e.length-i,t.length-r),s=0;s<n&&e[i+s]===t[r+s];)s++;return s}var m=new Set,y=new Set,C=new Set,A=new Map,b=0,x=function(e){function t(t){var i=e.call(this,t)||this;return i._chgListeners=[],i._notifications=null,i._timer=null,i.length=0,i._items=[],Object.defineProperty(i,"uid",{value:b++}),i}var s;return i.__extends(t,e),s=t,t.isCollection=function(e){return null!=e&&e instanceof s},t.prototype.normalizeCtorArgs=function(e){return e?Array.isArray(e)||e instanceof s?{items:e}:e:{}},Object.defineProperty(t.prototype,"items",{get:function(){return this._items},set:function(e){this._emitBeforeChanges(1)||(this._splice.apply(this,i.__spreadArrays([0,this.length],_(e))),this._emitAfterChanges(1))},enumerable:!1,configurable:!0}),t.prototype.hasEventListener=function(e){return"change"===e?this._chgListeners.length>0:this._emitter.hasEventListener(e)},t.prototype.on=function(e,t){if("change"===e){var i=this._chgListeners,r={removed:!1,callback:t};return i.push(r),this._notifications&&this._notifications.push({listeners:i.slice(),items:this._items.slice(),changes:[]}),{remove:function(){this.remove=g,r.removed=!0,i.splice(i.indexOf(r),1)}}}return this._emitter.on(e,t)},t.prototype.once=function(e,t){var i=this.on(e,t);return{remove:function(){i.remove()}}},t.prototype.add=function(e,t){if(this._emitBeforeChanges(1))return this;var i=this.getNextIndex(null!=t?t:null);return this._splice(i,0,e),this._emitAfterChanges(1),this},t.prototype.addMany=function(e,t){if(void 0===t&&(t=this._items.length),!e||!e.length)return this;if(this._emitBeforeChanges(1))return this;var r=this.getNextIndex(t);return this._splice.apply(this,i.__spreadArrays([r,0],_(e))),this._emitAfterChanges(1),this},t.prototype.removeAll=function(){if(!this.length||this._emitBeforeChanges(2))return[];var e=this._splice(0,this.length)||[];return this._emitAfterChanges(2),e},t.prototype.clone=function(){return this._createNewInstance({items:this._items.map(o.clone)})},t.prototype.concat=function(){for(var e,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var r=t.map(_);return this._createNewInstance({items:(e=this._items).concat.apply(e,r)})},t.prototype.drain=function(e,t){if(this.length&&!this._emitBeforeChanges(2)){for(var i=h.assumeNonNull(this._splice(0,this.length)),r=i.length,n=0;n<r;n++)e.call(t,i[n],n,i);this._emitAfterChanges(2)}},t.prototype.every=function(e,t){return this._items.every(e,t)},t.prototype.filter=function(e,t){var i;return i=2===arguments.length?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:i})},t.prototype.find=function(e,t){return n.find(this._items,e,t)},t.prototype.findIndex=function(e,t){return n.findIndex(this._items,e,t)},t.prototype.flatten=function(e,t){var i=[];return function e(t,i,r,n){i&&i.forEach((function(i,s,o){t.push(i),e(t,r.call(n,i,s,o),r,n)}))}(i,this,e,t),new s(i)},t.prototype.forEach=function(e,t){return this._items.forEach(e,t)},t.prototype.getItemAt=function(e){return this._items[e]},t.prototype.getNextIndex=function(e){var t=this.length;return(e=null==e?t:e)<0?e=0:e>t&&(e=t),e},t.prototype.includes=function(e,t){return void 0===t&&(t=0),!!arguments.length&&-1!==this._items.indexOf(e,t)},t.prototype.indexOf=function(e,t){return void 0===t&&(t=0),this._items.indexOf(e,t)},t.prototype.join=function(e){return void 0===e&&(e=","),this._items.join(e)},t.prototype.lastIndexOf=function(e,t){return void 0===t&&(t=this.length-1),this._items.lastIndexOf(e,t)},t.prototype.map=function(e,t){var i=this._items.map(e,t);return new s({items:i})},t.prototype.reorder=function(e,t){void 0===t&&(t=this.length-1);var i=this.indexOf(e);if(-1!==i){if(t<0?t=0:t>=this.length&&(t=this.length-1),i!==t){if(this._emitBeforeChanges(4))return e;this._splice(i,1),this._splice(t,0,e),this._emitAfterChanges(4)}return e}},t.prototype.pop=function(){if(this.length&&!this._emitBeforeChanges(2)){var e=d(this._splice(this.length-1,1));return this._emitAfterChanges(2),e}},t.prototype.push=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._emitBeforeChanges(1)?this.length:(this._splice.apply(this,i.__spreadArrays([this.length,0],e)),this._emitAfterChanges(1),this.length)},t.prototype.reduce=function(e,t){var i=this._items;return 2===arguments.length?i.reduce(e,t):i.reduce(e)},t.prototype.reduceRight=function(e,t){var i=this._items;return 2===arguments.length?i.reduceRight(e,t):i.reduceRight(e)},t.prototype.remove=function(e){return this.removeAt(this.indexOf(e))},t.prototype.removeAt=function(e){if(!(e<0||e>=this.length||this._emitBeforeChanges(2))){var t=d(this._splice(e,1));return this._emitAfterChanges(2),t}},t.prototype.removeMany=function(e){if(!e||!e.length||this._emitBeforeChanges(2))return[];for(var t=e instanceof s?e.toArray():e,i=this._items,r=[],n=t.length,o=0;o<n;o++){var h=t[o],a=i.indexOf(h);if(a>-1){var l=1+v(t,i,o+1,a+1),c=this._splice(a,l);c&&c.length>0&&r.push.apply(r,c),o+=l-1}}return this._emitAfterChanges(2),r},t.prototype.reverse=function(){if(this._emitBeforeChanges(4))return this;var e=this._splice(0,this.length);return e&&(e.reverse(),this._splice.apply(this,i.__spreadArrays([0,0],e))),this._emitAfterChanges(4),this},t.prototype.shift=function(){if(this.length&&!this._emitBeforeChanges(2)){var e=d(this._splice(0,1));return this._emitAfterChanges(2),e}},t.prototype.slice=function(e,t){return void 0===e&&(e=0),void 0===t&&(t=this.length),this._createNewInstance({items:this._items.slice(e,t)})},t.prototype.some=function(e,t){return this._items.some(e,t)},t.prototype.sort=function(e){if(!this.length||this._emitBeforeChanges(4))return this;var t=h.assumeNonNull(this._splice(0,this.length));return arguments.length?t.sort(e):t.sort(),this._splice.apply(this,i.__spreadArrays([0,0],t)),this._emitAfterChanges(4),this},t.prototype.splice=function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var s=(t?2:0)|(r.length?1:0);if(this._emitBeforeChanges(s))return[];var o=this._splice.apply(this,i.__spreadArrays([e,t],r))||[];return this._emitAfterChanges(s),o},t.prototype.toArray=function(){return this._items.slice()},t.prototype.toJSON=function(){return this.toArray()},t.prototype.toLocaleString=function(){return this._items.toLocaleString()},t.prototype.toString=function(){return this._items.toString()},t.prototype.unshift=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return!e.length||this._emitBeforeChanges(1)?this.length:(this._splice.apply(this,i.__spreadArrays([0,0],e)),this._emitAfterChanges(1),this.length)},t.prototype._createNewInstance=function(e){return new this.constructor(e)},t.prototype._splice=function(e,t){for(var r=this,n=[],s=2;s<arguments.length;s++)n[s-2]=arguments[s];var o,h=this._items,a=this.constructor.prototype.itemType,c=void 0;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=l.schedule((function(){return r._dispatchChange()}))),t){if(c=h.splice(e,t),this.hasEventListener("before-remove")){var f=u.acquire();f.target=this,f.cancellable=!0;for(var p=0,g=c.length;p<g;p++)o=c[p],f.reset(o),this.emit("before-remove",f),f.defaultPrevented&&(c.splice(p,1),h.splice(e,0,o),e+=1,p-=1,g-=1);u.release(f)}if(this.length=this._items.length,this.hasEventListener("after-remove")){var _=u.acquire();_.target=this,_.cancellable=!1;for(g=c.length,p=0;p<g;p++)_.reset(c[p]),this.emit("after-remove",_);u.release(_)}}if(n&&n.length){if(a){for(var d=[],v=0,m=n;v<m.length;v++){var y=m[v],C=a.ensureType(y);null==C&&null!=y||d.push(C)}n=d}var A=this.hasEventListener("before-add"),b=this.hasEventListener("after-add"),x=e===this.length;if(A||b){var E=u.acquire();E.target=this,E.cancellable=!0;var O=u.acquire();O.target=this,O.cancellable=!1;for(var B=0,L=n;B<L.length;B++){var w=L[B];A?(E.reset(w),this.emit("before-add",E),E.defaultPrevented||(x?h.push(w):h.splice(e++,0,w),this._set("length",h.length),b&&(O.reset(w),this.emit("after-add",O)))):(x?h.push(w):h.splice(e++,0,w),this._set("length",h.length),O.reset(w),this.emit("after-add",O))}u.release(O),u.release(E)}else{if(x)for(var I=0,N=n;I<N.length;I++){var P=N[I];h.push(P)}else h.splice.apply(h,i.__spreadArrays([e,0],n));this._set("length",h.length)}}return(n&&n.length||c&&c.length)&&this._notifyChangeEvent(n,c),c},t.prototype._emitBeforeChanges=function(e){var t=!1;if(this.hasEventListener("before-changes")){var i=u.acquire();i.target=this,i.cancellable=!0,i.type=e,this.emit("before-changes",i),t=i.defaultPrevented,u.release(i)}return t},t.prototype._emitAfterChanges=function(e){if(this.hasEventListener("after-changes")){var t=u.acquire();t.target=this,t.cancellable=!1,t.type=e,this.emit("after-changes",t),u.release(t)}},t.prototype._notifyChangeEvent=function(e,t){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:e,removed:t})},t.prototype._dispatchChange=function(){if(this._timer&&(this._timer.remove(),this._timer=null),this._notifications){var e=this._notifications;this._notifications=null;for(var t=function(e){var t=e.changes;m.clear(),y.clear(),C.clear();for(var n=0,s=t;n<s.length;n++){var o=s[n],h=o.added,a=o.removed;if(h)if(0===C.size&&0===y.size)for(var l=0,c=h;l<c.length;l++){var f=c[l];m.add(f)}else for(var p=0,u=h;p<u.length;p++){f=u[p];y.has(f)?(C.add(f),y.delete(f)):C.has(f)||m.add(f)}if(a)if(0===C.size&&0===m.size)for(var g=0,_=a;g<_.length;g++){f=_[g];y.add(f)}else for(var d=0,v=a;d<v.length;d++){f=v[d];m.has(f)?m.delete(f):(C.delete(f),y.add(f))}}var A=r.acquire();m.forEach((function(e){A.push(e)}));var b=r.acquire();y.forEach((function(e){b.push(e)}));var x=i._items,E=e.items,O=r.acquire();if(C.forEach((function(e){E.indexOf(e)!==x.indexOf(e)&&O.push(e)})),e.listeners&&(A.length||b.length||O.length))for(var B={target:i,added:A,removed:b,moved:O},L=e.listeners.length,w=0;w<L;w++){var I=e.listeners[w];I.removed||I.callback.call(i,B)}r.release(A),r.release(b),r.release(O)},i=this,n=0,s=e;n<s.length;n++){t(s[n])}m.clear(),y.clear(),C.clear()}},t.ofType=function(e){if(!e)return s;if(A.has(e))return A.get(e);var t=null;if("function"==typeof e)t=e.prototype.declaredClass;else if(e.base)t=e.base.prototype.declaredClass;else for(var r in e.typeMap){var n=e.typeMap[r].prototype.declaredClass;t?t+=" | "+n:t=n}var o=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return i.__extends(r,e),r=i.__decorate([p.subclass("esri.core.Collection<"+t+">")],r)}(s),h={Type:e,ensureType:"function"==typeof e?c.ensureType(e):c.ensureOneOfType(e)};return Object.defineProperty(o.prototype,"itemType",{value:h}),A.set(e,o),o},i.__decorate([f.property()],t.prototype,"length",void 0),i.__decorate([f.property()],t.prototype,"items",null),t=s=i.__decorate([p.subclass("esri.core.Collection")],t)}(s.EventedAccessor);return x}));