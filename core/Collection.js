/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","./lang","./maybe","./accessorSupport/ensureType","./accessorSupport/decorators/property","./accessorSupport/decorators/subclass","./ObjectPool","./ArrayPool","./scheduling","./Evented"],(function(e,t,i,n,s,r,h,o,c,l,a){"use strict";var f;const u=new o(function(){function e(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}var t=e.prototype;return t.preventDefault=function(){this.cancellable&&(this.defaultPrevented=!0)},t.reset=function(e){this.defaultPrevented=!1,this.item=e},e}(),void 0,(e=>{e.item=null,e.target=null,e.defaultPrevented=!1,e.cancellable=!1})),g=()=>{};function m(e){return e?e instanceof E?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]}function _(e){if(e&&e.length)return e[0]}function d(e,t,i,n){const s=Math.min(e.length-i,t.length-n);let r=0;for(;r<s&&e[i+r]===t[n+r];)r++;return r}function p(e,t,i,n){t&&t.forEach(((t,s,r)=>{e.push(t),p(e,i.call(n,t,s,r),i,n)}))}const v=new Set,y=new Set,C=new Set,A=new Map;let b=0,E=f=function(t){function s(i){var n;return(n=t.call(this,i)||this)._chgListeners=[],n._notifications=null,n._timer=null,n.length=0,n._items=[],Object.defineProperty(e._assertThisInitialized(n),"uid",{value:b++}),n}e._inheritsLoose(s,t),s.isCollection=function(e){return null!=e&&e instanceof f};var r=s.prototype;return r.normalizeCtorArgs=function(e){return e?Array.isArray(e)||e instanceof f?{items:e}:e:{}},r[Symbol.iterator]=function*(){yield*this.items},r.hasEventListener=function(e){return"change"===e?this._chgListeners.length>0:this._emitter.hasEventListener(e)},r.on=function(e,t){if("change"===e){const e=this._chgListeners,i={removed:!1,callback:t};return e.push(i),this._notifications&&this._notifications.push({listeners:e.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=g,i.removed=!0,e.splice(e.indexOf(i),1)}}}return this._emitter.on(e,t)},r.once=function(e,t){const i=this.on(e,t);return{remove(){i.remove()}}},r.add=function(e,t){if(this._emitBeforeChanges(1))return this;const i=this.getNextIndex(null!=t?t:null);return this._splice(i,0,e),this._emitAfterChanges(1),this},r.addMany=function(e,t=this._items.length){if(!e||!e.length)return this;if(this._emitBeforeChanges(1))return this;const i=this.getNextIndex(t);return this._splice(i,0,...m(e)),this._emitAfterChanges(1),this},r.removeAll=function(){if(!this.length||this._emitBeforeChanges(2))return[];const e=this._splice(0,this.length)||[];return this._emitAfterChanges(2),e},r.clone=function(){return this._createNewInstance({items:this._items.map(i.clone)})},r.concat=function(...e){const t=e.map(m);return this._createNewInstance({items:this._items.concat(...t)})},r.drain=function(e,t){if(!this.length||this._emitBeforeChanges(2))return;const i=n.assumeNonNull(this._splice(0,this.length)),s=i.length;for(let n=0;n<s;n++)e.call(t,i[n],n,i);this._emitAfterChanges(2)},r.every=function(e,t){return this._items.every(e,t)},r.filter=function(e,t){let i;return i=2===arguments.length?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:i})},r.find=function(e,t){return this._items.find(e,t)},r.findIndex=function(e,t){return this._items.findIndex(e,t)},r.flatten=function(e,t){const i=[];return p(i,this,e,t),new f(i)},r.forEach=function(e,t){return this._items.forEach(e,t)},r.getItemAt=function(e){return this._items[e]},r.getNextIndex=function(e){const t=this.length;return(e=null==e?t:e)<0?e=0:e>t&&(e=t),e},r.includes=function(e,t=0){return this._items.includes(e,t)},r.indexOf=function(e,t=0){return this._items.indexOf(e,t)},r.join=function(e=","){return this._items.join(e)},r.lastIndexOf=function(e,t=this.length-1){return this._items.lastIndexOf(e,t)},r.map=function(e,t){const i=this._items.map(e,t);return new f({items:i})},r.reorder=function(e,t=this.length-1){const i=this.indexOf(e);if(-1!==i){if(t<0?t=0:t>=this.length&&(t=this.length-1),i!==t){if(this._emitBeforeChanges(4))return e;this._splice(i,1),this._splice(t,0,e),this._emitAfterChanges(4)}return e}},r.pop=function(){if(!this.length||this._emitBeforeChanges(2))return;const e=_(this._splice(this.length-1,1));return this._emitAfterChanges(2),e},r.push=function(...e){return this._emitBeforeChanges(1)||(this._splice(this.length,0,...e),this._emitAfterChanges(1)),this.length},r.reduce=function(e,t){const i=this._items;return 2===arguments.length?i.reduce(e,t):i.reduce(e)},r.reduceRight=function(e,t){const i=this._items;return 2===arguments.length?i.reduceRight(e,t):i.reduceRight(e)},r.remove=function(e){return this.removeAt(this.indexOf(e))},r.removeAt=function(e){if(e<0||e>=this.length||this._emitBeforeChanges(2))return;const t=_(this._splice(e,1));return this._emitAfterChanges(2),t},r.removeMany=function(e){if(!e||!e.length||this._emitBeforeChanges(2))return[];const t=e instanceof f?e.toArray():e,i=this._items,n=[],s=t.length;for(let e=0;e<s;e++){const s=t[e],r=i.indexOf(s);if(r>-1){const s=1+d(t,i,e+1,r+1),h=this._splice(r,s);h&&h.length>0&&n.push.apply(n,h),e+=s-1}}return this._emitAfterChanges(2),n},r.reverse=function(){if(this._emitBeforeChanges(4))return this;const e=this._splice(0,this.length);return e&&(e.reverse(),this._splice(0,0,...e)),this._emitAfterChanges(4),this},r.shift=function(){if(!this.length||this._emitBeforeChanges(2))return;const e=_(this._splice(0,1));return this._emitAfterChanges(2),e},r.slice=function(e=0,t=this.length){return this._createNewInstance({items:this._items.slice(e,t)})},r.some=function(e,t){return this._items.some(e,t)},r.sort=function(e){if(!this.length||this._emitBeforeChanges(4))return this;const t=n.assumeNonNull(this._splice(0,this.length));return arguments.length?t.sort(e):t.sort(),this._splice(0,0,...t),this._emitAfterChanges(4),this},r.splice=function(e,t,...i){const n=(t?2:0)|(i.length?1:0);if(this._emitBeforeChanges(n))return[];const s=this._splice(e,t,...i)||[];return this._emitAfterChanges(n),s},r.toArray=function(){return this._items.slice()},r.toJSON=function(){return this.toArray()},r.toLocaleString=function(){return this._items.toLocaleString()},r.toString=function(){return this._items.toString()},r.unshift=function(...e){return!e.length||this._emitBeforeChanges(1)||(this._splice(0,0,...e),this._emitAfterChanges(1)),this.length},r._createNewInstance=function(e){return new this.constructor(e)},r._splice=function(e,t,...i){const n=this._items,s=this.constructor.prototype.itemType;let r,h;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=l.schedule((()=>this._dispatchChange()))),t){if(h=n.splice(e,t),this.hasEventListener("before-remove")){const t=u.acquire();t.target=this,t.cancellable=!0;for(let i=0,s=h.length;i<s;i++)r=h[i],t.reset(r),this.emit("before-remove",t),t.defaultPrevented&&(h.splice(i,1),n.splice(e,0,r),e+=1,i-=1,s-=1);u.release(t)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const e=u.acquire();e.target=this,e.cancellable=!1;const t=h.length;for(let i=0;i<t;i++)e.reset(h[i]),this.emit("after-remove",e);u.release(e)}}if(i&&i.length){if(s){const e=[];for(const t of i){const i=s.ensureType(t);null==i&&null!=t||e.push(i)}i=e}const t=this.hasEventListener("before-add"),r=this.hasEventListener("after-add"),h=e===this.length;if(t||r){const s=u.acquire();s.target=this,s.cancellable=!0;const o=u.acquire();o.target=this,o.cancellable=!1;for(const c of i)t?(s.reset(c),this.emit("before-add",s),s.defaultPrevented||(h?n.push(c):n.splice(e++,0,c),this._set("length",n.length),r&&(o.reset(c),this.emit("after-add",o)))):(h?n.push(c):n.splice(e++,0,c),this._set("length",n.length),o.reset(c),this.emit("after-add",o));u.release(o),u.release(s)}else{if(h)for(const e of i)n.push(e);else n.splice(e,0,...i);this._set("length",n.length)}}return(i&&i.length||h&&h.length)&&this._notifyChangeEvent(i,h),h},r._emitBeforeChanges=function(e){let t=!1;if(this.hasEventListener("before-changes")){const i=u.acquire();i.target=this,i.cancellable=!0,i.type=e,this.emit("before-changes",i),t=i.defaultPrevented,u.release(i)}return t},r._emitAfterChanges=function(e){if(this.hasEventListener("after-changes")){const t=u.acquire();t.target=this,t.cancellable=!1,t.type=e,this.emit("after-changes",t),u.release(t)}},r._notifyChangeEvent=function(e,t){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:e,removed:t})},r._dispatchChange=function(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const e=this._notifications;this._notifications=null;for(const t of e){const e=t.changes;v.clear(),y.clear(),C.clear();for(const{added:t,removed:i}of e){if(t)if(0===C.size&&0===y.size)for(const e of t)v.add(e);else for(const e of t)y.has(e)?(C.add(e),y.delete(e)):C.has(e)||v.add(e);if(i)if(0===C.size&&0===v.size)for(const e of i)y.add(e);else for(const e of i)v.has(e)?v.delete(e):(C.delete(e),y.add(e))}const i=c.acquire();v.forEach((e=>{i.push(e)}));const n=c.acquire();y.forEach((e=>{n.push(e)}));const s=this._items,r=t.items,h=c.acquire();if(C.forEach((e=>{r.indexOf(e)!==s.indexOf(e)&&h.push(e)})),t.listeners&&(i.length||n.length||h.length)){const e={target:this,added:i,removed:n,moved:h},s=t.listeners.length;for(let i=0;i<s;i++){const n=t.listeners[i];n.removed||n.callback.call(this,e)}}c.release(i),c.release(n),c.release(h)}v.clear(),y.clear(),C.clear()},e._createClass(s,[{key:"items",get:function(){return this._items},set:function(e){this._emitBeforeChanges(1)||(this._splice(0,this.length,...m(e)),this._emitAfterChanges(1))}}]),s}(a.EventedAccessor);return E.ofType=i=>{if(!i)return f;if(A.has(i))return A.get(i);let n=null;if("function"==typeof i)n=i.prototype.declaredClass;else if(i.base)n=i.base.prototype.declaredClass;else for(const e in i.typeMap){const t=i.typeMap[e].prototype.declaredClass;n?n+=` | ${t}`:n=t}let r=function(t){function i(){return t.apply(this,arguments)||this}return e._inheritsLoose(i,t),i}(f);r=t.__decorate([h.subclass(`esri.core.Collection<${n}>`)],r);const o={Type:i,ensureType:"function"==typeof i?s.ensureType(i):s.ensureOneOfType(i)};return Object.defineProperty(r.prototype,"itemType",{value:o}),A.set(i,r),r},t.__decorate([r.property()],E.prototype,"length",void 0),t.__decorate([r.property()],E.prototype,"items",null),E=f=t.__decorate([h.subclass("esri.core.Collection")],E),E}));
