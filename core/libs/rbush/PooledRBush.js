// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../arrayUtils","../../maybe","../../PooledArray","../quickselect/quickselect"],(function(t,i,n,e,r,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.BBox=i.PooledRBush=void 0;var h=function(){function t(t,i){void 0===t&&(t=9),this.compareMinX=u,this.compareMinY=m,this.toBBox=function(t){return t},this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&("function"==typeof i?this.toBBox=i:this._initFormat(i)),this.clear()}return t.prototype.destroy=function(){this.clear(),_.prune(),B.prune(),M.prune(),X.prune()},t.prototype.all=function(t){this._all(this.data,t)},t.prototype.search=function(t,i){var n=this.data,e=this.toBBox;if(x(t,n))for(_.clear();n;){for(var r=0,a=n.children.length;r<a;r++){var o=n.children[r],h=n.leaf?e(o):o;x(t,h)&&(n.leaf?i(o):p(t,h)?this._all(o,i):_.push(o))}n=_.pop()}},t.prototype.collides=function(t){var i=this.data,n=this.toBBox;if(!x(t,i))return!1;for(_.clear();i;){for(var e=0,r=i.children.length;e<r;e++){var a=i.children[e],o=i.leaf?n(a):a;if(x(t,o)){if(i.leaf||p(t,o))return!0;_.push(a)}}i=_.pop()}return!1},t.prototype.load=function(t,i){if(void 0===i&&(i=t.length),!i)return this;if(i<this._minEntries){for(var n=0,e=i;n<e;n++)this.insert(t[n]);return this}var r=this._build(t.slice(0,i),0,i-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var a=this.data;this.data=r,r=a}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},t.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},t.prototype.clear=function(){return this.data=new y([]),this},t.prototype.remove=function(t){var i;if(!t)return this;var n,a=this.data,o=null,h=0,s=!1,l=this.toBBox(t);for(M.clear(),X.clear();a||M.length>0;){if(a||(a=r.assumeNonNull(M.pop()),o=M.data[M.length-1],h=null!==(i=X.pop())&&void 0!==i?i:0,s=!0),a.leaf&&-1!==(n=e.indexOf(a.children,t,a.children.length,a.indexHint)))return a.children.splice(n,1),M.push(a),this._condense(M),this;s||a.leaf||!p(a,l)?o?(h++,a=o.children[h],s=!1):a=null:(M.push(a),X.push(h),h=0,o=a,a=a.children[0])}return this},t.prototype.toJSON=function(){return this.data},t.prototype.fromJSON=function(t){return this.data=t,this},t.prototype._all=function(t,i){var n,e=t;for(B.clear();e;){if(!0===e.leaf)for(var r=0,a=e.children;r<a.length;r++){i(a[r])}else B.pushArray(e.children);e=null!==(n=B.pop())&&void 0!==n?n:null}},t.prototype._build=function(t,i,n,e){var r=n-i+1,a=this._maxEntries;if(r<=a){var o=new y(t.slice(i,n+1));return s(o,this.toBBox),o}e||(e=Math.ceil(Math.log(r)/Math.log(a)),a=Math.ceil(r/Math.pow(a,e-1)));var h=new w([]);h.height=e;var l=Math.ceil(r/a),c=l*Math.ceil(Math.sqrt(a));v(t,i,n,c,this.compareMinX);for(var u=i;u<=n;u+=c){var m=Math.min(u+c-1,n);v(t,u,m,l,this.compareMinY);for(var f=u;f<=m;f+=l){var d=Math.min(f+l-1,m);h.children.push(this._build(t,f,d,e-1))}}return s(h,this.toBBox),h},t.prototype._chooseSubtree=function(t,i,n,e){for(;e.push(i),!0!==i.leaf&&e.length-1!==n;){for(var r=1/0,a=1/0,o=void 0,h=0,s=i.children.length;h<s;h++){var l=i.children[h],c=f(l),u=(m=t,d=l,(Math.max(d.maxX,m.maxX)-Math.min(d.minX,m.minX))*(Math.max(d.maxY,m.maxY)-Math.min(d.minY,m.minY))-c);u<a?(a=u,r=c<r?c:r,o=l):u===a&&c<r&&(r=c,o=l)}i=o||i.children[0]}var m,d;return i},t.prototype._insert=function(t,i,n){var e=this.toBBox,r=n?t:e(t);M.clear();var a=this._chooseSubtree(r,this.data,i,M);for(a.children.push(t),c(a,r);i>=0&&M.data[i].children.length>this._maxEntries;)this._split(M,i),i--;this._adjustParentBBoxes(r,M,i)},t.prototype._split=function(t,i){var n=t.data[i],e=n.children.length,r=this._minEntries;this._chooseSplitAxis(n,r,e);var a=this._chooseSplitIndex(n,r,e);if(a){var o=n.children.splice(a,n.children.length-a),h=n.leaf?new y(o):new w(o);h.height=n.height,s(n,this.toBBox),s(h,this.toBBox),i?t.data[i-1].children.push(h):this._splitRoot(n,h)}else console.log("  Error: assertion failed at PooledRBush._split: no valid split index")},t.prototype._splitRoot=function(t,i){this.data=new w([t,i]),this.data.height=t.height+1,s(this.data,this.toBBox)},t.prototype._chooseSplitIndex=function(t,i,n){var e,r,a,o,h,s,c,u,m=void 0;e=r=1/0;for(var d=i;d<=n-i;d++){var p=l(t,0,d,this.toBBox),x=l(t,d,n,this.toBBox),v=(a=p,o=x,h=void 0,s=void 0,c=void 0,u=void 0,h=Math.max(a.minX,o.minX),s=Math.max(a.minY,o.minY),c=Math.min(a.maxX,o.maxX),u=Math.min(a.maxY,o.maxY),Math.max(0,c-h)*Math.max(0,u-s)),_=f(p)+f(x);v<e?(e=v,m=d,r=_<r?_:r):v===e&&_<r&&(r=_,m=d)}return m},t.prototype._chooseSplitAxis=function(t,i,n){var e=t.leaf?this.compareMinX:u,r=t.leaf?this.compareMinY:m;this._allDistMargin(t,i,n,e)<this._allDistMargin(t,i,n,r)&&t.children.sort(e)},t.prototype._allDistMargin=function(t,i,n,e){t.children.sort(e);for(var r=this.toBBox,a=l(t,0,i,r),o=l(t,n-i,n,r),h=d(a)+d(o),s=i;s<n-i;s++){var u=t.children[s];c(a,t.leaf?r(u):u),h+=d(a)}for(s=n-i-1;s>=i;s--){u=t.children[s];c(o,t.leaf?r(u):u),h+=d(o)}return h},t.prototype._adjustParentBBoxes=function(t,i,n){for(var e=n;e>=0;e--)c(i.data[e],t)},t.prototype._condense=function(t){for(var i=t.length-1;i>=0;i--){var n=t.data[i];if(0===n.children.length)if(i>0){var r=t.data[i-1],a=r.children;a.splice(e.indexOf(a,n,a.length,r.indexHint),1)}else this.clear();else s(n,this.toBBox)}},t.prototype._initFormat=function(t){var i=["return a"," - b",";"];this.compareMinX=new Function("a","b",i.join(t[0])),this.compareMinY=new Function("a","b",i.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")},t}();function s(t,i){l(t,0,t.children.length,i,t)}function l(t,i,n,e,r){r||(r=new y([])),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var a=i,o=void 0;a<n;a++)o=t.children[a],c(r,t.leaf?e(o):o);return r}function c(t,i){t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY)}function u(t,i){return t.minX-i.minX}function m(t,i){return t.minY-i.minY}function f(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function d(t){return t.maxX-t.minX+(t.maxY-t.minY)}function p(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function x(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function v(t,i,n,e,a){for(var h=[i,n];h.length;){var s=r.assumeNonNull(h.pop()),l=r.assumeNonNull(h.pop());if(!(s-l<=e)){var c=l+Math.ceil((s-l)/e/2)*e;o(t,c,l,s,a),h.push(l,c,c,s)}}}i.PooledRBush=h;var _=new a,B=new a,M=new a,X=new a({deallocator:void 0}),Y=function(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0};i.BBox=Y;var g=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.height=1,i.indexHint=new e.PositionHint,i}return n.__extends(i,t),i}(Y),y=function(t){function i(i){var n=t.call(this)||this;return n.children=i,n.leaf=!0,n}return n.__extends(i,t),i}(g),w=function(t){function i(i){var n=t.call(this)||this;return n.children=i,n.leaf=!1,n}return n.__extends(i,t),i}(g);i.default=h}));