/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","./clock","./Error","./events","./Logger","./maybe"],(function(e,r,t,n,o,i){"use strict";function s(e){return Promise.all(e)}function u(e,r){const t=e.slice();return Promise.all(e.map(((e,t)=>r(e,t)))).then((e=>t.filter(((r,t)=>e[t]))))}function c(e){return new Promise(((r,t)=>{try{e(r,t)}catch(n){Promise.resolve().then((()=>t(n)))}}))}function l(e="Aborted"){return new t("AbortError",e)}function f(e,r="Aborted"){if(m(e))throw l(r)}function a(e){return i.isSome(e)?"aborted"in e?e:e.signal:e}function m(e){const r=a(e);return i.isSome(r)&&r.aborted}function h(e){if(A(e))throw e}function b(e){if(!A(e))throw e}function w(e,r){const t=a(e);if(!i.isNone(t)){if(!t.aborted)return n.once(t,"abort",(()=>r()));r()}}function p(e,r){const t=a(e);if(!i.isNone(t))return f(t),n.once(t,"abort",(()=>r(l())))}function d(e,r){const t=a(r);return i.isNone(t)?e:new Promise(((t,n)=>{let o=w(r,(()=>n(l())));const s=()=>o=i.removeMaybe(o);e.then(s,s),e.then(t,n)}))}function v(e,r){return Promise.race([e,O(r).then((()=>{throw new t("timeout",`Did not resolve within ${r} milliseconds`)}))])}function A(e){return e&&"AbortError"===e.name}function P(e){return e.catch((e=>{if(!A(e))throw e}))}function y(e,r=o.getLogger("esri")){return e.catch((e=>{A(e)||r.error(e)}))}function E(){let e=null;const r=new Promise(((r,t)=>{e={promise:void 0,resolve:r,reject:t}}));return e.promise=r,e}function g(e){if(!e)return;if("function"!=typeof e.forEach){const r=Object.keys(e);return g(r.map((r=>e[r]))).then((e=>{const t={};return r.forEach(((r,n)=>t[r]=e[n])),t}))}const r=e;return c((e=>{const t=[];let n=r.length;0===n&&e(t),r.forEach((r=>{const o={promise:r||Promise.resolve(r)};t.push(o),o.promise.then((e=>{o.value=e})).catch((e=>{o.error=e})).then((()=>{--n,0===n&&e(t)}))}))}))}function T(e){return g(e).then((e=>e.filter((e=>!!e.value)).map((e=>e.value))))}function j(e){return Promise.reject(e)}function N(e){return Promise.resolve(e)}function O(e,r,t){const n=new AbortController;return w(t,(()=>n.abort())),new Promise(((t,o)=>{let i=setTimeout((()=>{i=0,t(r)}),e);w(n,(()=>{i&&(clearTimeout(i),o(l()))}))}))}function k(e,r,n,o){const i=n&&"abort"in n?n:null;null!=o||i||(o=n);let s=setTimeout((()=>{s=0,i&&i.abort()}),r);const u=()=>o||new t("promiseUtils:timeout","The wrapped promise did not resolve within "+r+" ms");return e.then((e=>{if(0===s)throw u();return clearTimeout(s),e}),(e=>{throw clearTimeout(s),0===s?u():e}))}function S(e){return e&&"function"==typeof e.then}function C(e){return I(e)?e:Promise.resolve(e)}function I(e){return e&&"object"==typeof e&&"then"in e&&"function"==typeof e.then}function L(e,r=-1){let t,n,o,s,u=null;const c=(...f)=>{if(t){n=f,s&&s.reject(l()),s=E();const e=i.assumeNonNull(s.promise);if(u){const e=u;u=null,e.abort()}return e}if(o=s||E(),s=null,r>0){const n=new AbortController;t=C(e(...f,n.signal));const o=t;O(r).then((()=>{t===o&&(s?n.abort():u=n)}))}else t=1,t=C(e(...f));const a=()=>{const e=n;n=o=t=u=null,null!=e&&c(...e)},m=t,h=o;return m.then(a,a),m.then(h.resolve,h.reject),i.assumeNonNull(h.promise)};return c}function D(){let e,t;const n=new Promise(((r,n)=>{e=r,t=n})),o=r=>{e(r)};return o.resolve=r=>e(r),o.reject=e=>t(e),o.timeout=(e,t)=>r.default.setTimeout((()=>o.reject(t)),e),o.promise=n,o}function M(e,r){return e.then(r,r)}function _(e,r){let t,n=new AbortController;const o=e(n.signal);let s={promise:o,finished:!1,abort:()=>{n&&(n.abort(),n=null)}};const u=()=>{s&&(s.finished=!0,s=null),i.isSome(t)&&(t.remove(),t=null),n=null};return o.then(u,u),t=w(r,(()=>{i.isSome(s)&&s.abort()})),s}function x(e){return Promise.resolve().then((()=>{f(e)}))}e.after=O,e.all=s,e.always=M,e.create=c,e.createAbortError=l,e.createDeferred=E,e.createResolver=D,e.createTask=_,e.debounce=L,e.eachAlways=g,e.eachAlwaysValues=T,e.filter=u,e.ignoreAbortErrors=P,e.isAbortError=A,e.isAborted=m,e.isPromise=I,e.isPromiseLike=S,e.logOnError=y,e.onAbort=w,e.onAbortOrThrow=p,e.reject=j,e.resolve=N,e.throwIfAbortError=h,e.throwIfAborted=f,e.throwIfNotAbortError=b,e.timeout=k,e.waitTick=x,e.when=C,e.whenOrAbort=d,e.whenOrTimeout=v,Object.defineProperty(e,"__esModule",{value:!0})}));
