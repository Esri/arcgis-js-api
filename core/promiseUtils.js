/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","./maybe","./Logger","./Error","./clock","./events"],(function(t,e,r,n,o,i){"use strict";const u=r.getLogger("esri");function c(t){return Promise.all(t)}function s(t){return new Promise(((e,r)=>{try{t(e,r)}catch(t){Promise.resolve().then((()=>r(t)))}}))}function l(t="Aborted"){return new n("AbortError",t)}function f(){return new AbortController}function a(t){if(m(t))throw l()}function h(t){return e.isSome(t)?"aborted"in t?t:t.signal:t}function m(t){const r=h(t);return e.isSome(r)&&r.aborted}function b(t,r){const n=h(t);if(!e.isNone(n)){if(!n.aborted)return i.once(n,"abort",(()=>r()));r()}}function p(t,r){const n=h(r);return e.isNone(n)?t:s(((n,o)=>{let i=b(r,(()=>o(l())));const u=()=>i=e.removeMaybe(i);t.then(u,u),t.then(n,o)}))}function w(t){return t&&"AbortError"===t.name}function d(){let t=null;const e=s(((e,r)=>{t={promise:void 0,resolve:e,reject:r}}));return t.promise=e,t}function A(t,e){if(!t)return;if("function"!=typeof t.forEach){const e=Object.keys(t);return A(e.map((e=>t[e]))).then((t=>{const r={};return e.forEach(((e,n)=>r[e]=t[n])),r}))}const r=t,n=v;return p(s((t=>{const e=[];let o=r.length;0===o&&t(e),r.forEach((r=>{const i={promise:r||n(r)};e.push(i),i.promise.then((t=>{i.value=t})).catch((t=>{i.error=t})).then((()=>{--o,0===o&&t(e)}))}))})),e)}function v(t){return Promise.resolve(t)}function y(t,e,r){const n=f();return b(r,(()=>n.abort())),s(((r,o)=>{let i=setTimeout((()=>{i=0,r(e)}),t);b(n,(()=>{i&&(clearTimeout(i),o(l()))}))}))}function g(t){return t&&"object"==typeof t&&"then"in t&&"function"==typeof t.then?t:v(t)}t.after=y,t.all=c,t.always=function(t,e){return t.then(e,e)},t.create=s,t.createAbortController=f,t.createAbortError=l,t.createDeferred=d,t.createResolver=function(){let t,e;const r=s(((r,n)=>{t=r,e=n})),n=e=>{t(e)};return n.resolve=e=>t(e),n.reject=t=>e(t),n.timeout=(t,e)=>o.default.setTimeout((()=>n.reject(e)),t),n.promise=r,n},t.createTask=function(t){let e=f();const r=t(e.signal);let n={promise:r,finished:!1,abort:()=>{e&&(e.abort(),e=null)}};const o=()=>{n&&(n.finished=!0,n=null),e=null};return r.then(o,o),n},t.debounce=function(t,r=-1){let n,o,i,u,c=null;const s=(...a)=>{if(n){o=a,u&&u.reject(l()),u=d();const t=e.assumeNonNull(u.promise);if(c){const t=c;c=null,t.abort()}return t}if(i=u||d(),u=null,r>0){const e=f();n=g(t(...a,e.signal));const o=n;y(r).then((()=>{n===o&&(u?e.abort():c=e)}))}else n=1,n=g(t(...a));const h=()=>{const t=o;o=i=n=c=null,null!=t&&s(...t)},m=n,b=i;return m.then(h,h),m.then(b.resolve,b.reject),e.assumeNonNull(b.promise)};return s},t.eachAlways=A,t.eachAlwaysValues=function(t){return A(t).then((t=>t.filter((t=>!!t.value)).map((t=>t.value))))},t.filter=function(t,e){const r=t.slice();return c(t.map(((t,r)=>e(t,r)))).then((t=>r.filter(((e,r)=>t[r]))))},t.first=function(t){return t&&t.length?s(((e,r)=>{for(const n of t)n.then(e,r)})):v()},t.ignoreAbortErrors=function(t){return t.catch((t=>{if(!w(t))throw t}))},t.isAbortError=w,t.isAborted=m,t.isPromiseLike=function(t){return t&&"function"==typeof t.then},t.isThenable=function(t){return t&&"function"==typeof t.then},t.logOnError=function(t,e=u){return t.catch((t=>{w(t)||e.error(t)}))},t.onAbort=b,t.onAbortOrThrow=function(t,r){const n=h(t);if(!e.isNone(n))return a(n),i.once(n,"abort",(()=>r(l())))},t.reject=function(t){return Promise.reject(t)},t.resolve=v,t.throwIfAbortError=function(t){if(w(t))throw t},t.throwIfAborted=a,t.throwIfNotAbortError=function(t){if(!w(t))throw t},t.timeout=function(t,e,r,o){const i=r&&"abort"in r?r:null;null!=o||i||(o=r);let u=setTimeout((()=>{u=0,i&&i.abort()}),e);const c=()=>{throw o||new n("promiseUtils:timeout","The wrapped promise did not resolve within "+e+" ms")};return t.then((t=>{if(0===u)throw c();return clearTimeout(u),t}),(t=>{throw clearTimeout(u),0===u?c():t}))},t.when=g,t.whenOrAbort=p,Object.defineProperty(t,"__esModule",{value:!0})}));
