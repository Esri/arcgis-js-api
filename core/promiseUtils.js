// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","@dojo/framework/shim/AbortController","./clock","./Error","./events","./Logger","./maybe","@dojo/framework/shim/Promise"],(function(r,t,n,e,o,i,u,c,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.always=t.createResolver=t.debounce=t.when=t.isPromiseLike=t.timeout=t.after=t.resolve=t.reject=t.first=t.eachAlwaysValues=t.isThenable=t.eachAlways=t.createDeferred=t.logOnError=t.ignoreAbortErrors=t.isAbortError=t.onAbortOrThrow=t.onAbort=t.throwIfNotAbortError=t.throwIfAbortError=t.isAborted=t.throwIfAborted=t.createAbortController=t.createAbortError=t.create=t.filter=t.all=void 0;var a=c.getLogger("esri");function l(r){return Promise.all(r)}function s(r){return new Promise((function(t,n){try{r(t,n)}catch(r){Promise.resolve().then((function(){return n(r)}))}}))}function h(r){return void 0===r&&(r="Aborted"),new i("AbortError",r)}function v(){return new e.default}function b(r){if(d(r))throw h()}function m(r){return f.isSome(r)?"aborted"in r?r:r.signal:r}function d(r){var t=m(r);return f.isSome(t)&&t.aborted}function w(r,t){var n=m(r);if(!f.isNone(n)){if(!n.aborted)return u.once(n,"abort",(function(){return t()}));t()}}function p(r){return r&&"AbortError"===r.name}function A(){var r=null,t=s((function(t,n){r={promise:void 0,resolve:t,reject:n}}));return r.promise=t,r}function y(r){if(r){if("function"!=typeof r.forEach){var t=Object.keys(r);return y(t.map((function(t){return r[t]}))).then((function(r){var n={};return t.forEach((function(t,e){return n[t]=r[e]})),n}))}var n=r,e=E;return s((function(r){var t=[],o=n.length;0===o&&r(t),n.forEach((function(n){var i={promise:n||e(n)};t.push(i),i.promise.then((function(r){i.value=r})).catch((function(r){i.error=r})).then((function(){0===--o&&r(t)}))}))}))}}function E(r){return void 0===r&&(r=void 0),Promise.resolve(r)}function g(r,t,n){void 0===t&&(t=void 0);var e=v();return w(n,(function(){return e.abort()})),s((function(n,o){var i=setTimeout((function(){i=0,n(t)}),r);w(e,(function(){i&&(clearTimeout(i),o(h()))}))}))}function j(r){return r&&"object"==typeof r&&"then"in r&&"function"==typeof r.then?r:E(r)}t.all=l,t.filter=function(r,t){var n=r.slice();return l(r.map((function(r,n){return t(r,n)}))).then((function(r){return n.filter((function(t,n){return r[n]}))}))},t.create=s,t.createAbortError=h,t.createAbortController=v,t.throwIfAborted=b,t.isAborted=d,t.throwIfAbortError=function(r){if(p(r))throw r},t.throwIfNotAbortError=function(r){if(!p(r))throw r},t.onAbort=w,t.onAbortOrThrow=function(r,t){var n=m(r);if(!f.isNone(n))return b(n),u.once(n,"abort",(function(){return t(h())}))},t.isAbortError=p,t.ignoreAbortErrors=function(r){return r.catch((function(r){if(!p(r))throw r}))},t.logOnError=function(r,t){return r.catch((function(r){p(r)||(t=f.isSome(t)?t:a).error(r)}))},t.createDeferred=A,t.eachAlways=y,t.isThenable=function(r){return r&&"function"==typeof r.then},t.eachAlwaysValues=function(r){return y(r).then((function(r){return r.filter((function(r){return!!r.value})).map((function(r){return r.value}))}))},t.first=function(r){return r&&r.length?s((function(t,n){for(var e=0,o=r;e<o.length;e++){o[e].then(t,n)}})):E()},t.reject=function(r){return Promise.reject(r)},t.resolve=E,t.after=g,t.timeout=function(r,t,n,e){var o=n&&"abort"in n?n:null;null!=e||o||(e=n);var u=setTimeout((function(){u=0,o&&o.abort()}),t),c=function(){throw e||new i("promiseUtils:timeout","The wrapped promise did not resolve within "+t+" ms")};return r.then((function(r){if(0===u)throw c();return clearTimeout(u),r}),(function(r){throw clearTimeout(u),0===u?c():r}))},t.isPromiseLike=function(r){return r&&"function"==typeof r.then},t.when=j,t.debounce=function(r,t){var e,o,i,u;void 0===t&&(t=-1);var c=null,a=function(){for(var l=[],s=0;s<arguments.length;s++)l[s]=arguments[s];if(e){o=l,u&&u.reject(h()),u=A();var b=f.assumeNonNull(u.promise);if(c){var m=c;c=null,m.abort()}return b}if(i=u||A(),u=null,t>0){var d=v(),w=e=j(r.apply(void 0,n.__spreadArrays(l,[d.signal])));g(t).then((function(){e===w&&(u?d.abort():c=d)}))}else e=1,e=j(r.apply(void 0,l));var p=function(){var r=o;o=i=e=c=null,null!=r&&a.apply(void 0,r)},y=e,E=i;return y.then(p,p),y.then(E.resolve,E.reject),f.assumeNonNull(E.promise)};return a},t.createResolver=function(){var r,t,n=s((function(n,e){r=n,t=e})),e=function(t){r(t)};return e.resolve=function(t){return r(t)},e.reject=function(r){return t(r)},e.timeout=function(r,t){return o.default.setTimeout((function(){return e.reject(t)}),r)},e.promise=n,e},t.always=function(r,t){return r.then(t,t)}}));