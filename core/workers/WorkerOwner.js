/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{workerMessages as e}from"../../kernel.js";import t from"../Error.js";import o from"../Logger.js";import{removeMaybe as s}from"../maybe.js";import{onAbortOrThrow as r,isPromiseLike as n,isAbortError as a}from"../promiseUtils.js";import{newJobId as i,receiveMessage as l,toInvokeError as d,postMessage as h,MessageType as c}from"./utils.js";import{createWorker as p}from"./workerFactory.js";const b=o.getLogger("esri.core.workers"),{ABORT:m,INVOKE:_,OPEN:g,OPENED:u,RESPONSE:j}=c;class f{constructor(e,t){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=t,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",(e=>{e.preventDefault(),b.error(e)}))}static async create(e){const t=await p();return new f(t,e)}terminate(){this.worker.terminate()}async open(e,t={}){const{signal:o}=t,s=i();return new Promise(((t,n)=>{const a={resolve:t,reject:n,abortHandle:r(o,(()=>{this._outJobs.delete(s),this._post({type:m,jobId:s})}))};this._outJobs.set(s,a),this._post({type:g,jobId:s,modulePath:e})}))}_onMessage(e){const t=l(e);if(t)switch(t.type){case u:this._onOpenedMessage(t);break;case j:this._onResponseMessage(t);break;case m:this._onAbortMessage(t);break;case _:this._onInvokeMessage(t)}}_onAbortMessage(e){const t=this._inJobs,o=e.jobId,s=t.get(o);s&&(s.controller&&s.controller.abort(),t.delete(o))}_onInvokeMessage(t){const{methodName:o,jobId:s,data:r,abortable:i}=t,l=i?new AbortController:null,h=this._inJobs,c=e[o];let p;try{if("function"!=typeof c)throw new TypeError(`${o} is not a function`);p=c.call(null,r,{signal:l?l.signal:null})}catch(b){return void this._post({type:j,jobId:s,error:d(b)})}n(p)?(h.set(s,{controller:l,promise:p}),p.then((e=>{h.has(s)&&(h.delete(s),this._post({type:j,jobId:s},e))}),(e=>{h.has(s)&&(h.delete(s),e||(e={message:"Error encountered at method"+o}),a(e)||this._post({type:j,jobId:s,error:d(e||{message:`Error encountered at method ${o}`})}))}))):this._post({type:j,jobId:s},p)}_onOpenedMessage(e){const{jobId:t,data:o}=e,r=this._outJobs.get(t);r&&(this._outJobs.delete(t),s(r.abortHandle),r.resolve(o))}_onResponseMessage(e){const{jobId:o,error:r,data:n}=e,a=this._outJobs.get(o);a&&(this._outJobs.delete(o),s(a.abortHandle),r?a.reject(t.fromJSON(JSON.parse(r))):a.resolve(n))}_post(e,t,o){return h(this.worker,e,t,o)}}export{f as default};
