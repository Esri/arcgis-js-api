/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../kernel","../Error","../Logger","../promiseUtils","./utils","./workerFactory"],(function(e,t,o,r,s,n,i){"use strict";const a=r.getLogger("esri.core.workers"),{ABORT:l,INVOKE:c,OPEN:u,OPENED:d,RESPONSE:h}=n.MessageType;let b=function(){function r(e,t){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=t,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",(e=>{e.preventDefault(),a.error(e)}))}r.create=function(){var t=e._asyncToGenerator((function*(e){return new r(yield i.createWorker(),e)}));function o(e){return t.apply(this,arguments)}return o}();var b=r.prototype;return b.terminate=function(){this.worker.terminate()},b.open=function(){var t=e._asyncToGenerator((function*(e,t={}){const{signal:o}=t,r=n.newJobId();return new Promise(((t,n)=>{const i={resolve:t,reject:n,abortHandle:s.onAbortOrThrow(o,(()=>{this._outJobs.delete(r),this._post({type:l,jobId:r})}))};this._outJobs.set(r,i),this._post({type:u,jobId:r,modulePath:e})}))}));function o(e){return t.apply(this,arguments)}return o}(),b._onMessage=function(e){const t=n.receiveMessage(e);if(t)switch(t.type){case d:this._onOpenedMessage(t);break;case h:this._onResponseMessage(t);break;case l:this._onAbortMessage(t);break;case c:this._onInvokeMessage(t)}},b._onAbortMessage=function(e){const t=this._inJobs,o=e.jobId,r=t.get(o);r&&(r.controller&&r.controller.abort(),t.delete(o))},b._onInvokeMessage=function(e){const{methodName:o,jobId:r,data:i,abortable:a}=e,l=a?new AbortController:null,c=this._inJobs,u=t.workerMessages[o];let d;try{if("function"!=typeof u)throw new TypeError(`${o} is not a function`);d=u.call(null,i,{signal:l?l.signal:null})}catch(b){return void this._post({type:h,jobId:r,error:n.toInvokeError(b)})}s.isPromiseLike(d)?(c.set(r,{controller:l,promise:d}),d.then((e=>{c.has(r)&&(c.delete(r),this._post({type:h,jobId:r},e))}),(e=>{c.has(r)&&(c.delete(r),e||(e={message:"Error encountered at method"+o}),s.isAbortError(e)||this._post({type:h,jobId:r,error:n.toInvokeError(e||{message:`Error encountered at method ${o}`})}))}))):this._post({type:h,jobId:r},d)},b._onOpenedMessage=function(e){var t;const{jobId:o,data:r}=e,s=this._outJobs.get(o);s&&(this._outJobs.delete(o),null==(t=s.abortHandle)||t.remove(),s.resolve(r))},b._onResponseMessage=function(e){var t;const{jobId:r,error:s,data:n}=e,i=this._outJobs.get(r);i&&(this._outJobs.delete(r),null==(t=i.abortHandle)||t.remove(),s?i.reject(o.fromJSON(JSON.parse(s))):i.resolve(n))},b._post=function(e,t,o){return n.postMessage(this.worker,e,t,o)},r}();return b}));
