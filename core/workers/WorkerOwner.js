/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../Logger","../Error","../promiseUtils","../../kernel","./utils","./workerFactory"],(function(e,t,o,s,r,n){"use strict";const i=e.getLogger("esri.core.workers"),{ABORT:a,INVOKE:c,OPEN:l,OPENED:d,RESPONSE:u}=r.MessageType;return function(){function e(e,t){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=t,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",(e=>{e.preventDefault(),i.error(e)}))}e.create=async function(t){return new e(await n.createWorker(),t)};var h=e.prototype;return h.terminate=function(){this.worker.terminate()},h.open=async function(e,t={}){const{signal:s}=t,n=r.newJobId();return new Promise(((t,r)=>{const i={resolve:t,reject:r,abortHandle:o.onAbortOrThrow(s,(()=>{this._outJobs.delete(n),this._post({type:a,jobId:n})}))};this._outJobs.set(n,i),this._post({type:l,jobId:n,modulePath:e})}))},h._onMessage=function(e){const t=r.receiveMessage(e);if(t)switch(t.type){case d:this._onOpenedMessage(t);break;case u:this._onResponseMessage(t);break;case a:this._onAbortMessage(t);break;case c:this._onInvokeMessage(t)}},h._onAbortMessage=function(e){const t=this._inJobs,o=e.jobId,s=t.get(o);s&&(s.controller&&s.controller.abort(),t.delete(o))},h._onInvokeMessage=function(e){const{methodName:t,jobId:n,data:i,abortable:a}=e,c=a?o.createAbortController():null,l=this._inJobs,d=s.workerMessages[t];let h;try{if("function"!=typeof d)throw new TypeError(`${t} is not a function`);h=d.call(null,i,{signal:c?c.signal:null})}catch(b){return void this._post({type:u,jobId:n,error:r.toInvokeError(b)})}o.isPromiseLike(h)?(l.set(n,{controller:c,promise:h}),h.then((e=>{l.has(n)&&(l.delete(n),this._post({type:u,jobId:n},e))}),(e=>{l.has(n)&&(l.delete(n),e||(e={message:"Error encountered at method"+t}),o.isAbortError(e)||this._post({type:u,jobId:n,error:r.toInvokeError(e||{message:`Error encountered at method ${t}`})}))}))):this._post({type:u,jobId:n},h)},h._onOpenedMessage=function(e){var t;const{jobId:o,data:s}=e,r=this._outJobs.get(o);r&&(this._outJobs.delete(o),null==(t=r.abortHandle)||t.remove(),r.resolve(s))},h._onResponseMessage=function(e){var o;const{jobId:s,error:r,data:n}=e,i=this._outJobs.get(s);i&&(this._outJobs.delete(s),null==(o=i.abortHandle)||o.remove(),r?i.reject(t.fromJSON(JSON.parse(r))):i.resolve(n))},h._post=function(e,t,o){return r.postMessage(this.worker,e,t,o)},e}()}));
