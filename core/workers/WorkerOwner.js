/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../kernel","../Error","../Logger","../maybe","../promiseUtils","./utils","./workerFactory"],(function(e,t,o,r,s,n,i,a){"use strict";const{ABORT:c,INVOKE:l,OPEN:u,OPENED:b,RESPONSE:d}=i.MessageType;let h=function(){function h(e,t){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=t,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",(e=>{e.preventDefault(),r.getLogger("esri.core.workers.WorkerOwner").error(e)}))}h.create=function(){var t=e._asyncToGenerator((function*(e){return new h(yield a.createWorker(),e)}));function o(e){return t.apply(this,arguments)}return o}();var p=h.prototype;return p.terminate=function(){this.worker.terminate()},p.open=function(){var t=e._asyncToGenerator((function*(e,t={}){const{signal:o}=t,r=i.newJobId();return new Promise(((t,s)=>{const i={resolve:t,reject:s,abortHandle:n.onAbortOrThrow(o,(()=>{this._outJobs.delete(r),this._post({type:c,jobId:r})}))};this._outJobs.set(r,i),this._post({type:u,jobId:r,modulePath:e})}))}));function o(e){return t.apply(this,arguments)}return o}(),p._onMessage=function(e){const t=i.receiveMessage(e);if(t)switch(t.type){case b:this._onOpenedMessage(t);break;case d:this._onResponseMessage(t);break;case c:this._onAbortMessage(t);break;case l:this._onInvokeMessage(t)}},p._onAbortMessage=function(e){const t=this._inJobs,o=e.jobId,r=t.get(o);r&&(r.controller&&r.controller.abort(),t.delete(o))},p._onInvokeMessage=function(e){const{methodName:o,jobId:r,data:s,abortable:a}=e,c=a?new AbortController:null,l=this._inJobs,u=t.workerMessages[o];let b;try{if("function"!=typeof u)throw new TypeError(`${o} is not a function`);b=u.call(null,s,{signal:c?c.signal:null})}catch(h){return void this._post({type:d,jobId:r,error:i.toInvokeError(h)})}n.isPromiseLike(b)?(l.set(r,{controller:c,promise:b}),b.then((e=>{l.has(r)&&(l.delete(r),this._post({type:d,jobId:r},e))}),(e=>{l.has(r)&&(l.delete(r),e||(e={message:"Error encountered at method"+o}),n.isAbortError(e)||this._post({type:d,jobId:r,error:i.toInvokeError(e||{message:`Error encountered at method ${o}`})}))}))):this._post({type:d,jobId:r},b)},p._onOpenedMessage=function(e){const{jobId:t,data:o}=e,r=this._outJobs.get(t);r&&(this._outJobs.delete(t),s.removeMaybe(r.abortHandle),r.resolve(o))},p._onResponseMessage=function(e){const{jobId:t,error:r,data:n}=e,i=this._outJobs.get(t);i&&(this._outJobs.delete(t),s.removeMaybe(i.abortHandle),r?i.reject(o.fromJSON(JSON.parse(r))):i.resolve(n))},p._post=function(e,t,o){return i.postMessage(this.worker,e,t,o)},h}();return h}));
