/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","../../kernel","../Error","../events","../maybe","../promiseUtils","./utils","../../support/revision"],(function(e,t,o,s,n,r,i,c){"use strict";function a(e){return Object.freeze({__proto__:null,default:e})}const l={statsWorker:()=>new Promise((function(t,o){e(["../../smartMapping/statistics/support/statsWorker"],t,o)})),geometryEngineWorker:()=>new Promise((function(t,o){e(["../../geometry/geometryEngineWorker"],t,o)})),CSVSourceWorker:()=>new Promise((function(t,o){e(["../../layers/graphics/sources/support/CSVSourceWorker"],t,o)})),EdgeProcessingWorker:()=>new Promise((function(t,o){e(["../../views/3d/webgl-engine/lib/edgeRendering/EdgeProcessingWorker"],t,o)})),ElevationSamplerWorker:()=>new Promise((function(t,o){e(["../../geometry/support/meshUtils/ElevationSamplerWorker"],t,o)})),FeatureServiceSnappingSourceWorker:()=>new Promise((function(t,o){e(["../../views/interactive/snapping/featureSources/featureServiceSource/FeatureServiceSnappingSourceWorker"],t,o)})),GeoJSONSourceWorker:()=>new Promise((function(t,o){e(["../../layers/graphics/sources/geojson/GeoJSONSourceWorker"],(function(e){t(a(e))}),o)})),LercWorker:()=>new Promise((function(t,o){e(["../../layers/support/LercWorker"],(function(e){t(a(e))}),o)})),MemorySourceWorker:()=>new Promise((function(t,o){e(["../../layers/graphics/sources/support/MemorySourceWorker"],(function(e){t(a(e))}),o)})),PBFDecoderWorker:()=>new Promise((function(t,o){e(["../../views/3d/support/PBFDecoderWorker"],(function(e){t(a(e))}),o)})),Pipeline:()=>new Promise((function(t,o){e(["../../views/2d/layers/features/Pipeline"],t,o)})),PointCloudWorker:()=>new Promise((function(t,o){e(["../../views/3d/layers/PointCloudWorker"],(function(e){t(a(e))}),o)})),RasterWorker:()=>new Promise((function(t,o){e(["../../layers/support/RasterWorker"],(function(e){t(a(e))}),o)})),SceneLayerWorker:()=>new Promise((function(t,o){e(["../../views/3d/layers/SceneLayerWorker"],t,o)})),WFSSourceWorker:()=>new Promise((function(t,o){e(["../../layers/graphics/sources/WFSSourceWorker"],(function(e){t(a(e))}),o)})),WorkerTileHandler:()=>new Promise((function(t,o){e(["../../views/2d/engine/vectorTiles/WorkerTileHandler"],(function(e){t(a(e))}),o)}))},{CLOSE:u,ABORT:h,INVOKE:p,RESPONSE:_,OPEN_PORT:d,ON:g}=i.MessageType;let f=function(){function e(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}var t=e.prototype;return t.push=function(e){e.type===i.MessageType.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),null===this._timer&&(this._timer=setTimeout(this._process,0)))},t.clear=function(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null},t._process=function(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0},e}(),m=function(){function e(e,t){this._port=e,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new f((e=>this._onInvokeMessage(e))),this._client=t.client,this._onMessage=this._onMessage.bind(this),this._channel=t.channel,this._schedule=t.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}e.connect=function(t){const o=new MessageChannel;let s;s="function"==typeof t?new t:"default"in t&&"function"==typeof t.default?new t.default:t;const n=new e(o.port1,{channel:o,client:s});return"object"==typeof s&&"remoteClient"in s&&(s.remoteClient=n),e.clients.set(n,s),o.port2},e.loadWorker=function(e){const t=l[e];return t?t():Promise.resolve(null)};var t=e.prototype;return t.close=function(){this._post({type:u}),this._close()},t.isBusy=function(){return this._outJobs.size>0},t.invoke=function(e,t,s){const n=s&&s.signal,c=s&&s.transferList;if(!this._port)return Promise.reject(new o("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:t}));const a=i.newJobId();return new Promise(((o,s)=>{const i=r.onAbortOrThrow(n,(()=>{var e;const t=this._outJobs.get(a);t&&(this._outJobs.delete(a),null==(e=t.abortHandle)||e.remove(),this._post({type:h,jobId:a}),s(r.createAbortError()))})),l={resolve:o,reject:s,abortHandle:i,debugInfo:e};this._outJobs.set(a,l),this._post({type:p,jobId:a,methodName:e,abortable:null!=n},t,c)}))},t.on=function(e,t){const o=new MessageChannel;function s(e){t(e.data)}return this._port.postMessage({type:i.MessageType.ON,eventType:e,port:o.port2},[o.port2]),o.port1.addEventListener("message",s),o.port1.start(),{remove(){o.port1.postMessage({type:i.MessageType.CLOSE}),o.port1.close(),o.port1.removeEventListener("message",s)}}},t.openPort=function(){const e=new MessageChannel;return this._post({type:d,port:e.port2}),e.port1},t._close=function(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach((e=>{var t;null==(t=e.abortHandle)||t.remove(),e.reject(r.createAbortError(`Worker closing, aborting job calling '${e.debugInfo}'`))})),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null},t._onMessage=function(e){n.isSome(this._schedule)?this._schedule((()=>this._processMessage(e))):this._processMessage(e)},t._processMessage=function(e){const t=i.receiveMessage(e);if(t)switch(t.type){case _:this._onResponseMessage(t);break;case p:this._invokeQueue.push(t);break;case h:this._onAbortMessage(t);break;case u:this._onCloseMessage();break;case d:this._onOpenPortMessage(t);break;case g:this._onOnMessage(t)}},t._onAbortMessage=function(e){const t=this._inJobs,o=e.jobId,s=t.get(o);this._invokeQueue.push(e),s&&(s.controller&&s.controller.abort(),t.delete(o))},t._onCloseMessage=function(){const t=this._client;this._close(),t&&"destroy"in t&&e.clients.get(this)===t&&t.destroy(),e.clients.delete(this),t&&t.remoteClient&&(t.remoteClient=null)},t._onInvokeMessage=function(e){const{methodName:t,jobId:o,data:s,abortable:n}=e,c=n?r.createAbortController():null,a=this._inJobs;let l,u=this._client,h=u[t];try{if(!h&&t&&-1!==t.indexOf(".")){const e=t.split(".");for(let t=0;t<e.length-1;t++)u=u[e[t]],h=u[e[t+1]]}if("function"!=typeof h)throw new TypeError(`${t} is not a function`);l=h.call(u,s,{client:this,signal:c?c.signal:null})}catch(p){return void this._post({type:_,jobId:o,error:i.toInvokeError(p)})}r.isPromiseLike(l)?(a.set(o,{controller:c,promise:l}),l.then((e=>{a.has(o)&&(a.delete(o),this._post({type:_,jobId:o},e))}),(e=>{a.has(o)&&(a.delete(o),r.isAbortError(e)||this._post({type:_,jobId:o,error:i.toInvokeError(e||{message:`Error encountered at method ${t}`})}))}))):this._post({type:_,jobId:o},l)},t._onOpenPortMessage=function(t){new e(t.port,{client:this._client})},t._onOnMessage=function(e){const{port:t}=e,o=this._client.on(e.eventType,(e=>{t.postMessage(e)})),n=s.on(e.port,"message",(e=>{i.receiveMessage(e).type===i.MessageType.CLOSE&&(n.remove(),o.remove(),t.close())}))},t._onResponseMessage=function(e){var t;const{jobId:s,error:n,data:r}=e,i=this._outJobs;if(!i.has(s))return;const c=i.get(s);i.delete(s),null==(t=c.abortHandle)||t.remove(),n?c.reject(o.fromJSON(JSON.parse(n))):c.resolve(r)},t._post=function(e,t,o){return i.postMessage(this._port,e,t,o)},e}();return m.kernelInfo={revision:c.commitHash,version:t.version,buildDate:c.buildDate},m.clients=new Map,m}));
