/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../has","../Error","../promiseUtils","./RemoteClient","./Connection","./WorkerOwner"],(function(e,t,n,r,o,i,a,c){"use strict";function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}let u=n("esri-workers-debug")?1:n("host-browser")?navigator.hardwareConcurrency-1:0;u||(u=n("safari")&&n("mac")||n("trident")?7:2);let l=0;const f=[];async function d(e,t){const n=new a;return await n.open(e,t),n}let w,m=null;async function b(){if(m)return m;w=o.createAbortController();const e=[];for(let t=0;t<u;t++){const n=c.create(t).then((e=>(f[t]=e,e)));e.push(n)}return m=o.all(e),m}t.RemoteClient=i,t.Connection=a,t.initialize=function(){b()},t.open=async function(t,a={}){if("string"!=typeof t)throw new r("workers:undefined-module","modulePath is missing");let c=a.strategy||"distributed";if(n("host-webworker")&&!n("esri-workers")&&(c="local"),"local"===c){let n=await i.loadWorker(t);n||(n=await new Promise((function(n,r){e([t],(function(e){n(s(e))}),r)}))),o.throwIfAborted(a.signal);const r=a.client||n;return d([i.connect(n)],{...a,client:r})}if(await b(),o.throwIfAborted(a.signal),"dedicated"===c){const e=l++%u;return d([await f[e].open(t,a)],a)}if(a.maxNumWorkers&&a.maxNumWorkers>0){const e=Math.min(a.maxNumWorkers,u);if(e<u){const n=new Array(e);for(let r=0;r<e;++r){const e=l++%u;n[r]=f[e].open(t,a)}return d(n,a)}}return d(f.map((e=>e.open(t,a))),a)},t.openWithPorts=function(e,t){return d(e,{client:t})},t.terminate=function(){m&&(w.abort(),m=null);for(let e=0;e<f.length;e++)f[e]&&f[e].terminate();f.length=0},Object.defineProperty(t,"__esModule",{value:!0})}));
