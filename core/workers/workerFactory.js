/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../assets","../../config","../../intl","../../kernel","../has","../Logger","../urlUtils","./loaderConfig","./utils","./WorkerFallback","../../intl/locale","../../support/revision"],(function(e,r,t,o,s,n,a,i,l,f,c,u,d,g){"use strict";const p=i.getLogger("esri.core.workers.workerFactory"),{HANDSHAKE:m}=c.MessageType,k='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,version:r}=configuration.kernelInfo,{revision:t,version:n}=e.kernelInfo;esriConfig.assetsPath!==esriConfig.defaultAssetsPath&&o!==t&&console.warn(`Version mismatch detected between ArcGIS API for JavaScript modules and assets. For more information visit https://bit.ly/3QnsuSo.\\nModules version: ${r}\\nAssets version: ${n}`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let n;function t(e){const o=n.connect(e);self.postMessage({type:2,jobId:r,data:o},[o])}"function"==typeof define&&define.amd?require([workerPath],(e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((e=>(n=e.default,checkWorkerRevision(n),n.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),n=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(n),n.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const i=outgoing.get(r);outgoing.delete(r),o.error?i.reject(JSON.parse(o.error)):i.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let h,y;const b="Failed to create Worker. Fallback to execute module in main thread";function w(){return v.apply(this,arguments)}function v(){return(v=r._asyncToGenerator((function*(){if(!a("esri-workers")||(a("mozilla"),0))return P(new u);if(!h&&!y)try{const e=k.split('"{CONFIGURATION}"').join(`'${C()}'`);h=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}catch(r){y=r||{}}let e;if(h)try{e=new Worker(h,{name:"esri-worker-"+S++})}catch(r){p.warn(b,y),e=new u}else p.warn(b,y),e=new u;return P(e)}))).apply(this,arguments)}function P(e){return A.apply(this,arguments)}function A(){return(A=r._asyncToGenerator((function*(e){return new Promise((r=>{function t(s){const n=c.receiveMessage(s);n&&n.type===m&&(e.removeEventListener("message",t),e.removeEventListener("error",o),r(e))}function o(r){r.preventDefault(),e.removeEventListener("message",t),e.removeEventListener("error",o),p.warn("Failed to create Worker. Fallback to execute module in main thread",r),(e=new u).addEventListener("message",t),e.addEventListener("error",o)}e.addEventListener("message",t),e.addEventListener("error",o)}))}))).apply(this,arguments)}function C(){let e;if(null!=o.default){const r={...o};delete r.default,e=JSON.parse(JSON.stringify(r))}else e=JSON.parse(JSON.stringify(o));e.assetsPath=l.makeAbsolute(e.assetsPath),e.defaultAssetsPath=e.defaultAssetsPath?l.makeAbsolute(e.defaultAssetsPath):void 0,e.request.interceptors=[],e.log.interceptors=[],e.locale=d.getLocale(),e.has={"esri-csp-restrictions":a("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":a("esri-2d-update-debug"),"featurelayer-pbf":a("featurelayer-pbf"),"featurelayer-simplify-thresholds":a("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":a("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":a("featurelayer-simplify-mobile-factor"),"esri-atomics":a("esri-atomics"),"esri-shared-array-buffer":a("esri-shared-array-buffer"),"esri-tiles-debug":a("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":a("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":a("feature-polyline-generalization-factor"),"host-webworker":1,"polylabel-placement-enabled":a("polylabel-placement-enabled")},e.workers.loaderUrl&&(e.workers.loaderUrl=l.makeAbsolute(e.workers.loaderUrl)),e.workers.workerPath?e.workers.workerPath=l.makeAbsolute(e.workers.workerPath):e.workers.workerPath=l.makeAbsolute(t.getAssetUrl("esri/core/workers/RemoteClient.js")),e.workers.useDynamicImport=!1;const r=o.workers.loaderConfig,s=f.loaderConfig({baseUrl:r?.baseUrl,locale:d.getLocale(),has:{"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1,...r?.has},map:{...r?.map},paths:{...r?.paths},packages:r?.packages||[]}),i={version:n.version,buildDate:g.buildDate,revision:g.commitHash};return JSON.stringify({esriConfig:e,loaderConfig:s,kernelInfo:i})}let S=0;e.createWorker=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
