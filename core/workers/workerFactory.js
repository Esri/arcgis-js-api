// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../config","../../intl","../has","../Logger","../promiseUtils","./loaderConfig","./utils","./WorkerFallback"],(function(e,r,t,o,s,a,n,i,d,g,l){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.createWorker=void 0;var c=n.getLogger("esri.core.workers");a.add("esri-workers-arraybuffer-transfer",!a("safari")||a("safari")>=12);var u,f=g.MessageType.CONFIGURED,v=g.MessageType.CONFIGURE,b=g.MessageType.HANDSHAKE;try{u=URL.createObjectURL(new Blob(['var globalId=0,outgoing=new Map,configured=!1,HANDSHAKE=0,CONFIGURE=1,CONFIGURED=2,OPEN=3,OPENED=4,RESPONSE=5,INVOKE=6,ABORT=7;function createAbortError(){var error=new Error("Aborted");return error.name="AbortError",error}function receiveMessage(event){return event&&event.data?"string"==typeof event.data?JSON.parse(event.data):event.data:null}function invokeStaticMessage(methodName,data,options){var signal=options&&options.signal,jobId=globalId++;return new Promise((function(resolve,reject){if(signal){if(signal.aborted)return reject(createAbortError());signal.addEventListener("abort",(function(){outgoing.get(jobId)&&(outgoing.delete(jobId),self.postMessage({type:ABORT,jobId:jobId}),reject(createAbortError()))}))}outgoing.set(jobId,{resolve:resolve,reject:reject}),self.postMessage({type:INVOKE,jobId:jobId,methodName:methodName,abortable:null!=signal,data:data})}))}function messageHandler(event){var message=receiveMessage(event);if(message){var jobId=message.jobId;switch(message.type){case CONFIGURE:var configuration=message.configure;if(configured)return;configured=!0,self.dojoConfig=configuration.loaderConfig,self.importScripts(configuration.loaderUrl),"function"==typeof require.config&&require.config(configuration.loaderConfig),self.esriConfig=configuration.esriConfig,self.postMessage({type:CONFIGURED});break;case OPEN:var modulePath=message.modulePath;require(["esri/core/workers/RemoteClient"],(function(RemoteClient){RemoteClient.loadWorker(modulePath).then((function(Module){return Module||new Promise((function(resolve){require([modulePath],resolve)}))})).then((function(Module){var port=RemoteClient.connect(Module);self.postMessage({type:OPENED,jobId:jobId,data:port},[port])}))}));break;case RESPONSE:if(outgoing.has(jobId)){var deferred=outgoing.get(jobId);outgoing.delete(jobId),message.error?deferred.reject(JSON.parse(message.error)):deferred.resolve(message.data)}}}}self.addEventListener("message",messageHandler),self.postMessage({type:HANDSHAKE});'],{type:"text/javascript"}))}catch(e){}var p="Failed to create Worker. Fallback to execute module in main thread";function m(e){return t.__awaiter(this,void 0,void 0,(function(){return t.__generator(this,(function(r){return[2,i.create((function(r){function n(l){var c=g.receiveMessage(l);if(c)switch(c.type){case b:!function(e){var r,n=o.workers.loaderUrl||d.DEFAULT_LOADER_URL;if(null!=o.default){var i=t.__assign({},o);delete i.default,r=JSON.parse(JSON.stringify(i))}else r=JSON.parse(JSON.stringify(o));r.locale=s.getLocale(),r.has={"csp-restrictions":a("csp-restrictions"),"esri-2d-debug":a("esri-2d-debug"),"esri-2d-update-debug":a("esri-2d-update-debug"),"esri-atomics":a("esri-atomics"),"esri-secure-context":a("esri-secure-context"),"esri-shared-array-buffer":a("esri-shared-array-buffer"),"esri-tiles-debug":a("esri-tiles-debug"),"esri-webgl-max-texture-size":a("esri-webgl-max-texture-size"),"esri-webgl-texture-float":a("esri-webgl-texture-float"),"esri-workers-arraybuffer-transfer":a("esri-workers-arraybuffer-transfer"),"host-webworker":1};var g=o.workers.loaderConfig,l=d.default({baseUrl:g.baseUrl,locale:s.getLocale(),has:t.__assign({"csp-restrictions":a("csp-restrictions"),"dojo-test-sniff":0,"host-webworker":1},g.has),map:t.__assign({},g.map),paths:t.__assign({},g.paths),packages:g.packages||[]});e.postMessage({type:v,configure:{esriConfig:r,loaderUrl:n,loaderConfig:l}})}(e);break;case f:e.removeEventListener("message",n),e.removeEventListener("error",i),r(e)}}function i(r){r.preventDefault(),e.removeEventListener("message",n),e.removeEventListener("error",i),c.warn("Failed to create Worker. Fallback to execute module in main thread",r),(e=new l).addEventListener("message",n),e.addEventListener("error",i)}e.addEventListener("message",n),e.addEventListener("error",i)}))]}))}))}r.createWorker=function(){return t.__awaiter(this,void 0,void 0,(function(){var e;return t.__generator(this,(function(r){if(!a("esri-workers"))return[2,m(new l)];if(u)try{e=new Worker(u)}catch(r){c.warn(p,event),e=new l}else c.warn(p,event),e=new l;return[2,m(e)]}))}))}}));