/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","./maybe","./nextTick","./PerformanceSampler","./PooledArray","./promiseUtils","./time"],(function(e,n,t,r,s,o,i){"use strict";let a=function(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1},c=function(){function e(e){this.callback=e,this.isActive=!0}return e.prototype.remove=function(){this.isActive=!1},e}(),l=0,u=0;const m={time:i.Milliseconds(0),deltaTime:i.Milliseconds(0),elapsedFrameTime:i.Milliseconds(0),frameDuration:i.Milliseconds(0)},d=["prepare","preRender","render","postRender","update"],f=[],p=new s;let h=function(){function e(e){this._task=e}var n=e.prototype;return n.remove=function(){this._task.removed=!0},n.pause=function(){this._task.paused=!0},n.resume=function(){this._task.paused=!1},e}();const k={frameTasks:p,willDispatch:!1,clearFrameTasks:M,dispatch:y,executeFrameTasks:x};function w(e){const n=new c(e);return f.push(n),k.willDispatch||(k.willDispatch=!0,t.nextTick(y)),n}function v(e){const n=new a(e);return p.push(n),null==T&&(l=performance.now(),T=requestAnimationFrame(F)),new h(n)}let T=null;function M(e=!1){p.forAll((e=>{e.removed=!0})),e&&D()}function A(e){u=Math.max(0,e)}function F(){const e=performance.now();T=null,T=p.length>0?requestAnimationFrame(F):null,k.executeFrameTasks(e)}function x(e){const n=i.Milliseconds(e-l);l=e;const t=u>0?u:1e3/60,r=Math.max(0,n-t);for(let s=0;s<d.length;s++){const o=performance.now(),a=d[s];p.forAll((o=>{var c;if(o.paused||o.removed)return;0===s&&o.ticks++;o.phases[a]&&(m.time=e,m.deltaTime=0===o.ticks?i.Milliseconds(0):n,m.elapsedFrameTime=i.Milliseconds(performance.now()-e),m.frameDuration=i.Milliseconds(t-r),null==(c=o.phases[a])||c.call(o,m))})),g[s].record(performance.now()-o)}D(),P.record(performance.now()-e)}const b=new s;function D(){p.forAll((e=>{e.removed&&b.push(e)})),p.removeUnorderedMany(b.data,b.length),b.clear()}function y(){for(;f.length;){const e=n.assumeNonNull(f.shift());e.isActive&&e.callback()}k.willDispatch=!1}function _(e=1,n){const r=o.createResolver(),s=()=>{o.isAborted(n)?r.reject(o.createAbortError()):0===e?r():(--e,t.nextTick((()=>s())))};return s(),r.promise}const g=d.map((e=>new r(e))),P=new r("total");e.FrameTaskHandle=h,e.addFrameTask=v,e.debug=k,e.performanceInfo=g,e.performanceTotal=P,e.schedule=w,e.setFrameDuration=A,e.waitTicks=_,Object.defineProperty(e,"__esModule",{value:!0})}));
