/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../Accessor","../Handles","../maybe","../reactiveUtils","../scheduling","../accessorSupport/decorators/property","../accessorSupport/decorators/subclass"],(function(e,t,n,s,i,a,d,r,h,o){"use strict";e.WatchUpdatingTracking=function(e){function n(){var t;return(t=e.apply(this,arguments)||this).updating=!1,t._handleId=0,t._handles=new i,t._scheduleHandleId=0,t._pendingPromises=new Set,t}t._inheritsLoose(n,e);var s=n.prototype;return s.destroy=function(){this.removeAll(),this._handles.destroy()},s.add=function(e,t,n={}){return this._installWatch(e,t,n,d.watch)},s.addWhen=function(e,t,n={}){return this._installWatch(e,t,n,d.when)},s.addOnCollectionChange=function(e,t,{initial:n=!1,final:s=!1}={}){const i=++this._handleId;return this._handles.add([d.on(e,"after-changes",this._createSyncUpdatingCallback(),d.sync),d.on(e,"change",t,{onListenerAdd:n?e=>t({added:e.toArray(),removed:[]}):void 0,onListenerRemove:s?e=>t({added:[],removed:e.toArray()}):void 0})],i),{remove:()=>this._handles.remove(i)}},s.addPromise=function(e){if(a.isNone(e))return e;const t=++this._handleId;this._handles.add({remove:()=>{this._pendingPromises.delete(e)&&(0!==this._pendingPromises.size||this._handles.has(c)||this._set("updating",!1))}},t),this._pendingPromises.add(e),this._set("updating",!0);const n=()=>this._handles.remove(t);return e.then(n,n),e},s.removeAll=function(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)},s._installWatch=function(e,t,n={},s){const i=++this._handleId;n.sync||this._installSyncUpdatingWatch(e,i);const a=s(e,t,n);return this._handles.add(a,i),{remove:()=>this._handles.remove(i)}},s._installSyncUpdatingWatch=function(e,t){const n=this._createSyncUpdatingCallback(),s=d.watch(e,n,{sync:!0,equals:()=>!1});return this._handles.add(s,t),s},s._createSyncUpdatingCallback=function(){return()=>{this._handles.remove(c),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this._handles.add(r.schedule((()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this._handles.remove(c))})),c)}},n}(s),n.__decorate([h.property({readOnly:!0})],e.WatchUpdatingTracking.prototype,"updating",void 0),e.WatchUpdatingTracking=n.__decorate([o.subclass("esri.core.support.WatchUpdatingTracking")],e.WatchUpdatingTracking);const c=-42;Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
