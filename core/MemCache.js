/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","./maybe","./PooledArray"],(function(t,e,i,s){"use strict";const n=-3;let r=function(){function t(t,e,i){this._namespace=t,this._storage=e,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",i&&(this._storage.registerRemoveFunc(this._namespace,i),this._removeFunc=!0)}var i=t.prototype;return i.destroy=function(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null},i.resetHitRate=function(){this._hit=this._miss=0},i.put=function(t,e,i,s=0){this._storage.put(this._namespace+t,e,i,s)},i.get=function(t){const e=this._storage.get(this._namespace+t);return void 0===e?++this._miss:++this._hit,e},i.pop=function(t){const e=this._storage.pop(this._namespace+t);return void 0===e?++this._miss:++this._hit,e},i.updateSize=function(t,e,i){this._storage.updateSize(this._namespace+t,e,i)},i.clear=function(){this._storage.clear(this._namespace)},i.clearAll=function(){this._storage.clearAll()},i.getStats=function(){return this._storage.getStats()},i.resetStats=function(){this._storage.resetStats()},e._createClass(t,[{key:"namespace",get:function(){return this._namespace.slice(0,-1)}},{key:"hitRate",get:function(){return this._hit/(this._hit+this._miss)}},{key:"size",get:function(){return this._storage.size}},{key:"maxSize",get:function(){return this._storage.maxSize}}]),t}(),h=function(){function t(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new s,this._users=new s}var r=t.prototype;return r.destroy=function(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null},r.register=function(t){this._users.push(t)},r.deregister=function(t){this._users.removeUnordered(t)},r.registerRemoveFunc=function(t,e){this._removeFuncs.push([t,e])},r.deregisterRemoveFunc=function(t){this._removeFuncs.filterInPlace((e=>e[0]!==t))},r.put=function(t,e,i,s){const r=this._db.get(t);if(r&&(this._size-=r.size,this._db.delete(t),r.entry!==e&&this._notifyRemove(t,r.entry,0)),i>this._maxSize)return void this._notifyRemove(t,e,0);if(void 0===e)return void console.warn("Refusing to cache undefined entry ");if(!i||i<0)return void console.warn("Refusing to cache entry with invalid size "+i);const h=1+Math.max(s,n)-n;this._db.set(t,{entry:e,size:i,lifetime:h,lives:h}),this._size+=i,this._checkSizeLimit()},r.updateSize=function(t,e,s){const n=this._db.get(t);if(n&&n.entry===e){for(this._size-=n.size;s>this._maxSize;){const n=this._notifyRemove(t,e,1);if(!(i.isSome(n)&&n>0))return void this._db.delete(t);s=n}n.size=s,this._size+=s,this._checkSizeLimit()}},r.pop=function(t){const e=this._db.get(t);if(e)return this._size-=e.size,this._db.delete(t),++this._hit,e.entry;++this._miss},r.get=function(t){const e=this._db.get(t);if(void 0!==e)return this._db.delete(t),e.lives=e.lifetime,this._db.set(t,e),++this._hit,e.entry;++this._miss},r.getStats=function(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},e={},i=new Array;this._db.forEach(((t,s)=>{const n=t.lifetime;i[n]=(i[n]||0)+t.size,this._users.forAll((i=>{const n=i.namespace;if(s.startsWith(n)){const i=e[n]||0;e[n]=i+t.size}}))}));const s={};this._users.forAll((t=>{const i=t.namespace;if(!isNaN(t.hitRate)&&t.hitRate>0){const n=e[i]||0;e[i]=n,s[i]=Math.round(100*t.hitRate)+"%"}else s[i]="0%"}));const r=Object.keys(e);r.sort(((t,i)=>e[i]-e[t])),r.forEach((i=>t[i]=Math.round(e[i]/2**20)+"MB / "+s[i]));for(let h=i.length-1;h>=0;--h){const e=i[h];e&&(t["Priority "+(h+n-1)]=Math.round(e/this.size*100)+"%")}return t},r.resetStats=function(){this._hit=this._miss=0,this._users.forAll((t=>t.resetHitRate()))},r.clear=function(t){this._db.forEach(((e,i)=>{i.startsWith(t)&&(this._size-=e.size,this._db.delete(i),this._notifyRemove(i,e.entry,0))}))},r.clearAll=function(){this._db.forEach(((t,e)=>this._notifyRemove(e,t.entry,0))),this._size=0,this._db.clear()},r._getHitRate=function(){return this._hit/(this._hit+this._miss)},r._notifyRemove=function(t,e,i){let s;return this._removeFuncs.some((n=>{if(t.startsWith(n[0])){const t=n[1](e,i);return"number"==typeof t&&(s=t),!0}return!1})),s},r._checkSizeLimit=function(){if(!(this._size<=this._maxSize))for(const[t,e]of this._db){if(this._db.delete(t),e.lives<=1){this._size-=e.size;const s=this._notifyRemove(t,e.entry,1);i.isSome(s)&&s>0&&(this._size+=s,e.lives=e.lifetime,e.size=s,this._db.set(t,e))}else--e.lives,this._db.set(t,e);if(this._size<=.9*this.maxSize)return}},e._createClass(t,[{key:"size",get:function(){return this._size}},{key:"maxSize",get:function(){return this._maxSize},set:function(t){this._maxSize=Math.max(t,0),this._checkSizeLimit()}}]),t}();t.MIN_PRIORITY=n,t.MemCache=r,t.MemCacheStorage=h,Object.defineProperty(t,"__esModule",{value:!0})}));
