/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../lang","./utils","./get","../ArrayPool","../ReentrantObjectPool","../scheduling","./trackingUtils"],(function(e,t,r,o,n,l,i,u){"use strict";let a=function(){function e(){this.uid=0,this.target=null,this.path=null,this.oldValue=null,this.callback=null,this.getValue=null,this.removed=!1,this.propertyPath=null}var t=e.prototype;return t.acquire=function(t,o,n,l,i){this.target=t,this.path=o,this.oldValue=n,this.callback=l,this.getValue=i,this.propertyPath=r.pathToStringOrArray(o),this.uid=++e.uid,this.removed=!1},t.release=function(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null,this.uid=++e.uid,this.removed=!0},e}();a.pool=new l.ReentrantObjectPool(a),a.uid=0;const s=new n,c=new Set;let d,h=s.acquire();function f(e){c.has(e)?h.splice(h.indexOf(e),1):c.add(e),h.push(e),d||(d=i.schedule(m))}function p(e){if(e.removed)return;const{callback:t,path:r,oldValue:o,target:n}=e,l=e.getValue();g(o,l)&&(e.oldValue=l,t.call(n,l,o,r,n))}function g(e,r){return!t.equals(e,r)}function v(e){const t=s.copy(h);for(let r=0;r<t.length;r++){const o=t[r];o.target===e&&(p(o),c.delete(o),h.splice(h.indexOf(o),1))}}function _(e){for(let t=0;t<h.length;t++){const r=h[t];r.target===e&&(r.removed=!0)}}function m(){let e=10;for(;d&&e--;){d=null;const e=h;h=s.acquire(),c.clear();const t=s.acquire();for(const r of e){const e=r.uid;p(r),e===r.uid&&r.removed&&t.push(r)}for(let r=0;r<h.length;r++){const e=h[r];e.removed&&(t.push(e),c.delete(e),h.splice(r,1),r-=1)}for(let r=0;r<t.length;r++)a.pool.release(t[r]);s.release(e),s.release(t),y.forEach((e=>e()))}}const y=new Set;function V(e){return y.add(e),{remove(){y.delete(e)}}}function O(e,t,n){let l=r.parse(e,t,n,((e,t,n)=>{let i,s,c=u.reactionAsync((()=>o.valueOf(e,t)),((r,o)=>{e.__accessor__.destroyed||i&&i.uid!==s?l.remove():(i||(i=a.pool.acquire(e,t,r,n,o),s=i.uid),f(i))}));return{remove:r.once((function(){c.remove(),i&&(i.uid!==s||i.removed||(i.removed=!0,f(i)),i=null),l=c=null}))}}));return l}function b(e,t,n){const l=r.parse(e,t,n,((e,t,r)=>{let n=!1;return u.reaction((()=>o.valueOf(e,t)),((o,i)=>{e.__accessor__.destroyed?l.remove():n||(n=!0,g(i,o)&&r.call(e,o,i,t,e),n=!1)}))}));return l}function P(e,t,r,o=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:o?b(e,t,r):O(e,t,r)}function q(e){return h.some((t=>t.oldValue===e))}e.afterDispatch=V,e.default=P,e.dispatch=m,e.dispatchTarget=v,e.isValueInUse=q,e.removeTarget=_,e.watch=P,Object.defineProperty(e,"__esModule",{value:!0})}));
