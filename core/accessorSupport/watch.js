/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../ArrayPool","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./trackingUtils","./utils"],(function(e,t,r,n,o,l,u,a,i,c){"use strict";var s;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(s||(s={}));let d=function(){function e(){this.uid=u.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}e.acquireUntracked=function(e,t,n,o,l){return this.pool.acquire(s.Untracked,e,t,n,o,l,r.equals)},e.acquireTracked=function(e,t,r,n){return this.pool.acquire(s.Tracked,e,t,r,null,null,n)};var t=e.prototype;return t.notify=function(e,t){this.type===s.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)},t.acquire=function(e,t,r,n,o,l,a){this.uid=u.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=n,this.target=o,this.path=l,this.equals=a},t.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=u.generateUID(),this.removed=!0},e}();d.pool=new n.ReentrantObjectPool(d);const h=new t,f=new Set;let v;function m(e){f.delete(e),f.add(e),v||(v=o.schedule(k))}function g(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function p(e){for(const t of f.values())t.target===e&&(t.removed=!0)}function k(){let e=10;for(;v&&e--;){v=null;const e=_(),t=h.acquire();for(const r of e){const e=r.uid;g(r),e===r.uid&&r.removed&&t.push(r)}for(const r of f)r.removed&&(t.push(r),f.delete(r));for(const r of t)d.pool.release(r);h.release(t),h.release(e),q.forEach((e=>e()))}}function _(){const e=h.acquire();e.length=f.size;let t=0;for(const r of f)e[t]=r,++t;return f.clear(),e}const q=new Set;function y(e){return q.add(e),{remove(){q.delete(e)}}}function U(e,t,r){let n=c.parse(e,t,r,((e,t,r)=>{let o,l,u=i.reactionDeferred((()=>a.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed||o&&o.uid!==l?n.remove():(o||(o=d.acquireUntracked(u,r,a,e,t),l=o.uid),m(o))}));return{remove:c.once((()=>{u.remove(),o&&(o.uid!==l||o.removed||(o.removed=!0,m(o)),o=null),n=u=null}))}}));return n}function V(e,t,n){const o=c.parse(e,t,n,((e,t,n)=>{let l=!1;return i.reaction((()=>a.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed?o.remove():l||(l=!0,r.equals(a,u)||n.call(e,u,a,t,e),l=!1)}))}));return o}function b(e,t,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?V(e,t,r):U(e,t,r)}function T(e,t,r){let n,o,l=i.reactionDeferred(e,((e,u)=>{n&&n.uid!==o?l.remove():(n||(n=d.acquireTracked(e,t,u,r),o=n.uid),m(n))}));return{remove:c.once((()=>{l.remove(),n&&(n.uid!==o||n.removed||(n.removed=!0,m(n)),n=null),l=null}))}}function w(e,t,r){let n=!1;return i.reaction(e,((e,o)=>{n||(n=!0,r(o,e)||t(e,o),n=!1)}))}function S(e,t,n=!1,o=r.equalsShallow){return n?w(e,t,o):T(e,t,o)}function D(e){return l.someSet(f,(t=>t.oldValue===e))}e.afterDispatch=y,e.dispatch=k,e.isValueInUse=D,e.removeTarget=p,e.watch=b,e.watchTracked=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
