/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../ArrayPool.js";import{equals as t,equalsShallow as r}from"../lang.js";import{ReentrantObjectPool as o}from"../ReentrantObjectPool.js";import{schedule as l}from"../scheduling.js";import{someSet as n}from"../SetUtils.js";import{generateUID as i}from"../uid.js";import{valueOf as s}from"./get.js";import{reaction as u,reactionDeferred as c}from"./trackingUtils.js";import{once as a,parse as d}from"./utils.js";var h;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(h||(h={}));class f{constructor(){this.uid=i(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,r,o,l,n){return this.pool.acquire(h.Untracked,e,r,o,l,n,t)}static acquireTracked(e,t,r,o){return this.pool.acquire(h.Tracked,e,t,r,null,null,o)}notify(e,t){this.type===h.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)}acquire(e,t,r,o,l,n,s){this.uid=i(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=o,this.target=l,this.path=n,this.equals=s}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=i(),this.removed=!0}}f.pool=new o(f);const m=new e,p=new Set;let v;function g(e){p.delete(e),p.add(e),v||(v=l(j))}function k(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function _(e){const t=Array.from(p);for(let r=0;r<t.length;r++){const o=t[r];o.target===e&&(k(o),p.delete(o))}}function q(e){for(const t of p.values())t.target===e&&(t.removed=!0)}function j(){let e=10;for(;v&&e--;){v=null;const e=y(),t=m.acquire();for(const r of e){const e=r.uid;k(r),e===r.uid&&r.removed&&t.push(r)}for(const r of p)r.removed&&(t.push(r),p.delete(r));for(const r of t)f.pool.release(r);m.release(t),m.release(e),V.forEach((e=>e()))}}function y(){const e=m.acquire();e.length=p.size;let t=0;for(const r of p)e[t]=r,++t;return p.clear(),e}const V=new Set;function U(e){return V.add(e),{remove(){V.delete(e)}}}function b(e,t,r){let o=d(e,t,r,((e,t,r)=>{let l,n,i=c((()=>s(e,t)),((i,s)=>{e.__accessor__.destroyed||l&&l.uid!==n?o.remove():(l||(l=f.acquireUntracked(i,r,s,e,t),n=l.uid),g(l))}));return{remove:a((()=>{i.remove(),l&&(l.uid!==n||l.removed||(l.removed=!0,g(l)),l=null),o=i=null}))}}));return o}function T(e,r,o){const l=d(e,r,o,((e,r,o)=>{let n=!1;return u((()=>s(e,r)),((i,s)=>{e.__accessor__.destroyed?l.remove():n||(n=!0,t(s,i)||o.call(e,i,s,r,e),n=!1)}))}));return l}function w(e,t,r,o=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:o?T(e,t,r):b(e,t,r)}function S(e,t,r){let o,l,n=c(e,((e,i)=>{o&&o.uid!==l?n.remove():(o||(o=f.acquireTracked(e,t,i,r),l=o.uid),g(o))}));return{remove:a((()=>{n.remove(),o&&(o.uid!==l||o.removed||(o.removed=!0,g(o)),o=null),n=null}))}}function A(e,t,r){let o=!1;return u(e,((e,l)=>{o||(o=!0,r(l,e)||t(e,l),o=!1)}))}function P(e,t,o=!1,l=r){return o?A(e,t,l):S(e,t,l)}function x(e){return n(p,(t=>t.oldValue===e))}export{U as afterDispatch,j as dispatch,_ as dispatchTarget,x as isValueInUse,q as removeTarget,w as watch,P as watchTracked};
