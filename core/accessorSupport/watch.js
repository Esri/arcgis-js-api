/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../lang","./utils","./get","../ArrayPool","../ReentrantObjectPool","../scheduling","./wire"],(function(e,t,r,o,l,n,u,i){"use strict";let s=function(){function e(){this.uid=0,this.target=null,this.path=null,this.oldValue=null,this.callback=null,this.getValue=null,this.removed=!1,this.propertyPath=null}var t=e.prototype;return t.acquire=function(t,o,l,n,u){this.target=t,this.path=o,this.oldValue=l,this.callback=n,this.getValue=u,this.propertyPath=r.pathToStringOrArray(o),this.uid=++e.uid,this.removed=!1},t.release=function(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null,this.uid=++e.uid,this.removed=!0},e}();s.pool=new n.ReentrantObjectPool(s),s.uid=0;const a=new l,c=new Set;let d,h=a.acquire();function f(e){c.has(e)?h.splice(h.indexOf(e),1):c.add(e),h.push(e),d||(d=u.schedule(g))}function p(e){if(e.removed)return;const{callback:t,path:r,oldValue:o,target:l}=e,n=e.getValue();v(o,n)&&(e.oldValue=n,t.call(l,n,o,r,l))}function v(e,r){return!t.equals(e,r)}function g(){let e=10;for(;d&&e--;){d=null;const e=h;h=a.acquire(),c.clear();const t=a.acquire();for(const r of e){const e=r.uid;p(r),e===r.uid&&r.removed&&t.push(r)}for(let e=0;e<h.length;e++){const r=h[e];r.removed&&(t.push(r),c.delete(r),h.splice(e,1),e-=1)}for(let e=0;e<t.length;e++)s.pool.release(t[e]);a.release(e),a.release(t),_.forEach((e=>e()))}}const _=new Set;function m(e,t,l,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?function(e,t,l){const n=r.parse(e,t,l,((e,t,r)=>{let l=!1;return i.wire((()=>o.valueOf(e,t)),((o,u)=>{e.__accessor__.destroyed?n.remove():l||(l=!0,v(o,u)&&r.call(e,u,o,t,e),l=!1)}))}));return n}(e,t,l):function(e,t,l){let n=r.parse(e,t,l,((e,t,l)=>{let u,a,c=i.wireAsync((()=>o.valueOf(e,t)),((r,o)=>{e.__accessor__.destroyed||u&&u.uid!==a?n.remove():(u||(u=s.pool.acquire(e,t,r,l,o),a=u.uid),f(u))}));return{remove:r.once((function(){c.remove(),u&&(u.uid!==a||u.removed||(u.removed=!0,f(u)),u=null),n=c=null}))}}));return n}(e,t,l)}e.afterDispatch=function(e){return _.add(e),{remove(){_.delete(e)}}},e.default=m,e.dispatch=g,e.dispatchTarget=function(e){const t=a.copy(h);for(let r=0;r<t.length;r++){const o=t[r];o.target===e&&(p(o),c.delete(o),h.splice(h.indexOf(o),1))}},e.isValueInUse=function(e){return h.some((t=>t.oldValue===e))},e.removeTarget=function(e){for(let t=0;t<h.length;t++){const r=h[t];r.target===e&&(r.removed=!0)}},e.watch=m,Object.defineProperty(e,"__esModule",{value:!0})}));
