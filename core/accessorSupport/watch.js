/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../ArrayPool","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./trackingUtils","./utils"],(function(e,t,r,n,l,o,u,a,i,c){"use strict";var s;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(s||(s={}));let d=function(){function e(){this.uid=u.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}e.acquireUntracked=function(e,t,n,l,o){return this.pool.acquire(s.Untracked,e,t,n,l,o,r.equals)},e.acquireTracked=function(e,t,r,n){return this.pool.acquire(s.Tracked,e,t,r,null,null,n)};var t=e.prototype;return t.notify=function(e,t){this.type===s.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)},t.acquire=function(e,t,r,n,l,o,a){this.uid=u.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=n,this.target=l,this.path=o,this.equals=a},t.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=u.generateUID(),this.removed=!0},e}();d.pool=new n.ReentrantObjectPool(d);const h=new t,f=new Set;let v;function m(e){f.delete(e),f.add(e),v||(v=l.schedule(k))}function g(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function p(e){for(const t of f.values())t.target===e&&(t.removed=!0)}function k(){let e=10;for(;v&&e--;){v=null;const e=_(),t=h.acquire();for(const r of e){const e=r.uid;g(r),e===r.uid&&r.removed&&t.push(r)}for(const r of f)r.removed&&(t.push(r),f.delete(r));for(const r of t)d.pool.release(r);h.release(t),h.release(e),q.forEach((e=>e()))}}function _(){const e=h.acquire();e.length=f.size;let t=0;for(const r of f)e[t]=r,++t;return f.clear(),e}const q=new Set;function U(e){return q.add(e),{remove(){q.delete(e)}}}function y(e,t,r){let n=c.parse(e,t,r,((e,t,r)=>{let l,o,u=i.reactionDeferred((()=>a.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed||l&&l.uid!==o?n.remove():(l||(l=d.acquireUntracked(u,r,a,e,t),o=l.uid),m(l))}));return{remove:c.once((()=>{u.remove(),l&&(l.uid!==o||l.removed||(l.removed=!0,m(l)),l=null),n=u=null}))}}));return n}function V(e,t,n){const l=c.parse(e,t,n,((e,t,n)=>{let o=!1;return i.reaction((()=>a.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed?l.remove():o||(o=!0,r.equals(a,u)||n.call(e,u,a,t,e),o=!1)}))}));return l}function b(e,t,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?V(e,t,r):y(e,t,r)}function T(e,t,r){let n,l,o=i.reactionDeferred(e,((e,u)=>{n&&n.uid!==l?o.remove():(n||(n=d.acquireTracked(e,t,u,r),l=n.uid),m(n))}));return{remove:c.once((()=>{o.remove(),n&&(n.uid!==l||n.removed||(n.removed=!0,m(n)),n=null),o=null}))}}function w(e,t,r){let n=!1;return i.reaction(e,((e,l)=>{n||(n=!0,r(l,e)||t(e,l),n=!1)}))}function S(e,t,n=!1,l=r.equalsShallow){return n?w(e,t,l):T(e,t,l)}function D(e){return o.someSet(f,(t=>t.oldValue===e))}e.afterDispatch=U,e.dispatch=k,e.isValueInUse=D,e.removeTarget=p,e.watch=b,e.watchTracked=S,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
