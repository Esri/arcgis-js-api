/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../ArrayPool","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./trackingUtils","./utils"],(function(e,t,r,n,o,l,u,i,a,c){"use strict";let s=function(){function e(){this.uid=u.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null}e.acquireUntracked=function(e,t,r,n,o){return this.pool.acquire(0,e,t,r,n,o)},e.acquireTracked=function(e,t,r){return this.pool.acquire(1,e,t,r,null,null)};var t=e.prototype;return t.notify=function(e,t){0===this.type?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)},t.acquire=function(e,t,r,n,o,l){this.uid=u.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=n,this.target=o,this.path=l},t.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=u.generateUID(),this.removed=!0},e}();s.pool=new n.ReentrantObjectPool(s);const d=new t,f=new Set;let h;function v(e){f.delete(e),f.add(e),h||(h=o.schedule(y))}function m(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();g(t,r)&&(e.oldValue=r,e.notify(r,t))}function g(e,t){return!r.equals(e,t)}function p(e){const t=Array.from(f);for(let r=0;r<t.length;r++){const n=t[r];n.target===e&&(m(n),f.delete(n))}}function _(e){for(const t of f.values())t.target===e&&(t.removed=!0)}function y(){let e=10;for(;h&&e--;){h=null;const e=k(),t=d.acquire();for(const r of e){const e=r.uid;m(r),e===r.uid&&r.removed&&t.push(r)}for(const r of f)r.removed&&(t.push(r),f.delete(r));for(const r of t)s.pool.release(r);d.release(t),d.release(e),V.forEach((e=>e()))}}function k(){const e=d.acquire();e.length=f.size;let t=0;for(const r of f)e[t]=r,++t;return f.clear(),e}const V=new Set;function q(e){return V.add(e),{remove(){V.delete(e)}}}function b(e,t,r){let n=c.parse(e,t,r,((e,t,r)=>{let o,l,u=a.reactionDeferred((()=>i.valueOf(e,t)),((u,i)=>{e.__accessor__.destroyed||o&&o.uid!==l?n.remove():(o||(o=s.acquireUntracked(u,r,i,e,t),l=o.uid),v(o))}));return{remove:c.once((()=>{u.remove(),o&&(o.uid!==l||o.removed||(o.removed=!0,v(o)),o=null),n=u=null}))}}));return n}function U(e,t,r){const n=c.parse(e,t,r,((e,t,r)=>{let o=!1;return a.reaction((()=>i.valueOf(e,t)),((l,u)=>{e.__accessor__.destroyed?n.remove():o||(o=!0,g(u,l)&&r.call(e,l,u,t,e),o=!1)}))}));return n}function w(e,t,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?U(e,t,r):b(e,t,r)}function D(e,t){let r,n,o=a.reactionDeferred(e,((e,l)=>{r&&r.uid!==n?o.remove():(r||(r=s.acquireTracked(e,t,l),n=r.uid),v(r))}));return{remove:c.once((()=>{o.remove(),r&&(r.uid!==n||r.removed||(r.removed=!0,v(r)),r=null),o=null}))}}function O(e,t,r=!1){return r?a.reaction(e,t):D(e,t)}function T(e){return l.someSet(f,(t=>t.oldValue===e))}e.afterDispatch=q,e.default=w,e.dispatch=y,e.dispatchTarget=p,e.isValueInUse=T,e.removeTarget=_,e.watch=w,e.watchTracked=O,Object.defineProperty(e,"__esModule",{value:!0})}));
