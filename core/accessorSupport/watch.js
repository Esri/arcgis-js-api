/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../ArrayPool","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./trackingUtils","./utils"],(function(e,t,r,n,o,l,u,a,i,c){"use strict";let s=function(){function e(){this.uid=u.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}e.acquireUntracked=function(e,t,n,o,l){return this.pool.acquire(0,e,t,n,o,l,r.equals)},e.acquireTracked=function(e,t,r,n){return this.pool.acquire(1,e,t,r,null,null,n)};var t=e.prototype;return t.notify=function(e,t){0===this.type?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)},t.acquire=function(e,t,r,n,o,l,a){this.uid=u.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=n,this.target=o,this.path=l,this.equals=a},t.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=u.generateUID(),this.removed=!0},e}();s.pool=new n.ReentrantObjectPool(s);const d=new t,h=new Set;let f;function v(e){h.delete(e),h.add(e),f||(f=o.schedule(_))}function m(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function g(e){const t=Array.from(h);for(let r=0;r<t.length;r++){const n=t[r];n.target===e&&(m(n),h.delete(n))}}function p(e){for(const t of h.values())t.target===e&&(t.removed=!0)}function _(){let e=10;for(;f&&e--;){f=null;const e=q(),t=d.acquire();for(const r of e){const e=r.uid;m(r),e===r.uid&&r.removed&&t.push(r)}for(const r of h)r.removed&&(t.push(r),h.delete(r));for(const r of t)s.pool.release(r);d.release(t),d.release(e),y.forEach((e=>e()))}}function q(){const e=d.acquire();e.length=h.size;let t=0;for(const r of h)e[t]=r,++t;return h.clear(),e}const y=new Set;function k(e){return y.add(e),{remove(){y.delete(e)}}}function V(e,t,r){let n=c.parse(e,t,r,((e,t,r)=>{let o,l,u=i.reactionDeferred((()=>a.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed||o&&o.uid!==l?n.remove():(o||(o=s.acquireUntracked(u,r,a,e,t),l=o.uid),v(o))}));return{remove:c.once((()=>{u.remove(),o&&(o.uid!==l||o.removed||(o.removed=!0,v(o)),o=null),n=u=null}))}}));return n}function b(e,t,n){const o=c.parse(e,t,n,((e,t,n)=>{let l=!1;return i.reaction((()=>a.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed?o.remove():l||(l=!0,r.equals(a,u)||n.call(e,u,a,t,e),l=!1)}))}));return o}function U(e,t,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?b(e,t,r):V(e,t,r)}function w(e,t,r){let n,o,l=i.reactionDeferred(e,((e,u)=>{n&&n.uid!==o?l.remove():(n||(n=s.acquireTracked(e,t,u,r),o=n.uid),v(n))}));return{remove:c.once((()=>{l.remove(),n&&(n.uid!==o||n.removed||(n.removed=!0,v(n)),n=null),l=null}))}}function D(e,t,r){let n=!1;return i.reaction(e,((e,o)=>{n||(n=!0,r(o,e)||t(e,o),n=!1)}))}function T(e,t,n=!1,o=r.equals){return n?D(e,t,o):w(e,t,o)}function O(e){return l.someSet(h,(t=>t.oldValue===e))}e.afterDispatch=k,e.default=U,e.dispatch=_,e.dispatchTarget=g,e.isValueInUse=O,e.removeTarget=p,e.syncWatchTracked=D,e.watch=U,e.watchTracked=T,Object.defineProperty(e,"__esModule",{value:!0})}));
