/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../multiOriginJSONSupportUtils","../../urlUtils","../../uuid","../metadata","../PropertyOrigin","./property","../../../portal/support/resourceExtension","../../../chunks/persistableUrlUtils"],(function(e,t,r,o,n,s,i,u,a,l,c){"use strict";const p=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function f(e){const t=e?.origins??[void 0];return(r,o)=>{const n=m(e,r,o);for(const e of t){const t=a.propertyJSONMeta(r,e,o);for(const e in n)t[e]=n[e]}}}function m(e,t,r){if("resource"===e?.type)return d(e,t,r);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=c.persistableUrlUtils;return{read:e,write:t}}}}function d(e,t,r){const s=i.getOwnPropertyMetadata(t,r);return{type:String,read:(e,t,r)=>{const o=c.read(e,t,r);return s.type===String?o:"function"==typeof s.type?new s.type({url:o}):void 0},write:{writer(t,i,a,l){if(!l||!l.resources)return"string"==typeof t?void(i[a]=c.toJSON(t,l)):void(i[a]=t.write({},l));const p=P(t),f=c.toJSON(p,{...l,verifyItemRelativeUrls:l&&l.verifyItemRelativeUrls?{writtenUrls:l.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},c.MarkKeep.NO),m=s.type!==String&&(!o.isMultiOriginJSONMixin(this)||l&&l.origin&&this.originIdOf(r)>u.nameToId(l.origin)),d={object:this,propertyName:r,value:t,targetUrl:f,dest:i,targetPropertyName:a,context:l,params:e};l&&l.portalItem&&f&&!n.isAbsolute(f)?m?g(d):h(d):l&&l.portalItem&&(null==f||null!=c.itemIdFromResourceUrl(f)||n.isBlobProtocol(f)||m)?y(d):i[a]=f}}}}function y(e){const{targetUrl:t,params:r,value:o,context:i,dest:u,targetPropertyName:a}=e;if(!i.portalItem)return;const p=c.prefixAndFilenameFromResourceUrl(t),f=p?.filename??s.generateUUID(),m=r?.prefix??p?.prefix,d=v(o,t,i),y=n.join(m,f),g=`${y}.${l.getResourceContentExtension(d)}`,h=i.portalItem.resourceFromPath(g);n.isBlobProtocol(t)&&i.resources&&i.resources.pendingOperations.push(b(t).then((e=>{h.path=`${y}.${l.getResourceContentExtension(e)}`,u[a]=h.itemRelativeUrl})).catch((()=>{})));const O=r?.compress??!1;i.resources&&U({...e,resource:h,content:d,compress:O,updates:i.resources.toAdd}),u[a]=h.itemRelativeUrl}function g(e){const{context:t,targetUrl:r,params:o,value:s,dest:i,targetPropertyName:u}=e;if(!t.portalItem)return;const a=t.portalItem.resourceFromPath(r),c=v(s,r,t),p=l.getResourceContentExtension(c),f=n.getPathExtension(a.path),m=o?.compress??!1;p===f?(t.resources&&U({...e,resource:a,content:c,compress:m,updates:t.resources.toUpdate}),i[u]=r):y(e)}function h({context:e,targetUrl:t,dest:r,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),r[o]=t)}function U({object:e,propertyName:t,updates:r,resource:o,content:n,compress:s}){r.push({resource:o,content:n,compress:s,finish:r=>{I(e,t,r)}})}function v(e,t,r){return"string"==typeof e?{url:t}:new Blob([JSON.stringify(e.toJSON(r))],{type:"application/json"})}function b(e){return O.apply(this,arguments)}function O(){return(O=r._asyncToGenerator((function*(t){const r=(yield new Promise(((t,r)=>e(["../../../request"],(e=>t(p(e))),r)))).default,{data:o}=yield r(t,{responseType:"blob"});return o}))).apply(this,arguments)}function P(e){return null==e?null:"string"==typeof e?e:e.url}function I(e,t,r){"string"==typeof e[t]?e[t]=r.url:e[t].url=r.url}t.persistable=f,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
