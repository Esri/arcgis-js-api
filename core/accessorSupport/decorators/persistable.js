/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../maybe","../metadata","./property","../../multiOriginJSONSupportUtils","../../urlUtils","../../uuid","../PropertyOrigin","../../../portal/support/resourceExtension","../../../chunks/persistableUrlUtils"],(function(t,e,r,o,n,i,s,u,l,c,a){"use strict";function p(t){return Object.freeze({__proto__:null,default:t})}function f(t){const e=r.isSome(t)&&t.origins?t.origins:[void 0];return(r,o)=>{const i=y(t,r,o);for(const t of e){const e=n.propertyJSONMeta(r,t,o);for(const t in i)e[t]=i[t]}}}function y(t,e,o){if(r.isSome(t)&&"resource"===t.type)return d(t,e,o);switch(r.isSome(t)&&t.type?t.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:e}=a.persistableUrlUtils;return{read:t,write:e}}}}function d(t,e,n){const u=o.getOwnPropertyMetadata(e,n);return{type:String,read:(t,e,r)=>{const o=a.read(t,e,r);return u.type===String?o:"function"==typeof u.type?new u.type({url:o}):void 0},write:{writer(e,o,c,p){if(!p||!p.resources)return"string"==typeof e?void(o[c]=a.toJSON(e,p)):void(o[c]=e.write({},p));const f=O(e),y=f?a.toJSON(f,{...p,verifyItemRelativeUrls:p&&p.verifyItemRelativeUrls?{writtenUrls:p.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},1):null,d=u.type!==String&&(!i.isMultiOriginJSONMixin(this)||p&&p.origin&&this.originIdOf(n)>l.nameToId(p.origin));p&&p.portalItem&&r.isSome(y)&&!s.isAbsolute(y)?d?g(this,n,e,y,o,c,p,t):h(y,o,c,p):p&&p.portalItem&&(r.isNone(y)||r.isSome(a.itemIdFromResourceUrl(y))||s.isBlobProtocol(y)||d)?m(this,n,e,y,o,c,p,t):o[c]=y}}}}function m(t,e,o,n,i,l,a,p){const f=u.generateUUID(),y=S(o,n,a),d=s.join(r.get(p,"prefix"),f),m=`${d}.${c.getResourceContentExtension(y)}`,g=a.portalItem.resourceFromPath(m);s.isBlobProtocol(n)&&a.resources.pendingOperations.push(w(n).then((t=>{g.path=`${d}.${c.getResourceContentExtension(t)}`,i[l]=g.itemRelativeUrl})).catch((()=>{}))),U(t,e,g,y,a.resources.toAdd),i[l]=g.itemRelativeUrl}function g(t,e,r,o,n,i,u,l){const a=u.portalItem.resourceFromPath(o),p=S(r,o,u);c.getResourceContentExtension(p)===s.getPathExtension(a.path)?(U(t,e,a,p,u.resources.toUpdate),n[i]=o):m(t,e,r,o,n,i,u,l)}function h(t,e,r,o){o.resources.toKeep.push({resource:o.portalItem.resourceFromPath(t)}),e[r]=t}function U(t,e,r,o,n){n.push({resource:r,content:o,finish:r=>{v(t,e,r)}})}function S(t,e,r){return"string"==typeof t?{url:e}:new Blob([JSON.stringify(t.toJSON(r))],{type:"application/json"})}async function w(e){const r=(await new Promise((function(e,r){t(["../../../request"],(function(t){e(p(t))}),r)}))).default,{data:o}=await r(e,{responseType:"blob"});return o}function O(t){return r.isNone(t)?null:"string"==typeof t?t:t.url}function v(t,e,r){"string"==typeof t[e]?t[e]=r.url:t[e].url=r.url}e.persistable=f,Object.defineProperty(e,"__esModule",{value:!0})}));
