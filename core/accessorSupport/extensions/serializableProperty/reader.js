/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../Logger","../../../object","../../../Warning","../../metadata","./type"],(function(e,t,r,n,o,i){"use strict";const p=t.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function u(e,t,n){e&&(!n&&!t.read||t.read?.reader||!1===t.read?.enabled||g(e)&&r.setDeepValue("read.reader",y(e),t))}function y(e){const t=e.ndimArray??0;if(t>1)return f(e);if(1===t)return d(e);if("type"in e&&l(e.type)){const t=e.type.prototype?.itemType?.Type,r=d("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return s(e)}function s(e){return"type"in e?c(e.type):j(e.types)}function c(e){return e.prototype.read?(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void p.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i}:e.fromJSON}function a(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map((t=>a(e,t,r,n-1))):e(t,void 0,r)}function f(e){const t=s(e),r=a.bind(null,t),n=e.ndimArray??0;return(e,t,o)=>{if(null==e)return e;e=r(e,o,n);let i=n,p=e;for(;i>0&&Array.isArray(p);)i--,p=p[0];if(void 0!==p)for(let r=0;r<i;r++)e=[e];return e}}function d(e){const t=s(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function l(e){if(!i.isCollection(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?v(t.Type):b(t.Type))}function g(e){return"types"in e?b(e.types):v(e.type)}function v(e){return!Array.isArray(e)&&(!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||l(e)))}function b(e){for(const t in e.typeMap){if(!v(e.typeMap[t]))return!1}return!0}function j(e){let t=null;const r=e.errorContext??"type";return(o,i,u)=>{if(null==o)return o;const y=typeof o;if("object"!==y)return void p.error(`Expected JSON value of type 'object' to deserialize, but got '${y}'`);t||(t=A(e));const s=e.key;if("string"!=typeof s)return;const c=o[s],a=c?t[c]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!a){const e=`Type '${c||"unknown"}' is not supported`;return u&&u.messages&&o&&u.messages.push(new n(`${r}:unsupported`,e,{definition:o,context:u})),void p.error(e)}const f=new a;return f.read(o,u),f}}function A(e){const t={};for(const r in e.typeMap){const n=e.typeMap[r],i=o.getPropertiesMetadata(n.prototype);if("function"==typeof e.key)continue;const p=i[e.key];if(!p)continue;p.json?.type&&Array.isArray(p.json.type)&&1===p.json.type.length&&"string"==typeof p.json.type[0]&&(t[p.json.type[0]]=n);const u=p.json?.write;if(!u||!u.writer){t[r]=n;continue}const y=u.target,s="string"==typeof y?y:e.key,c={};u.writer(r,c,s),c[s]&&(t[c[s]]=n)}return t}e.create=u,e.createTypeReader=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
