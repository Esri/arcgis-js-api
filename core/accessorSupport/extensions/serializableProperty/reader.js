/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../object","../../../Logger","../../metadata","../../../Warning","./type"],(function(e,t,r,n,o,i){"use strict";const u=r.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function p(e){var t;const r=null!=(t=e.ndimArray)?t:0;if(r>1)return function(e){var t;const r=s(e),n=y.bind(null,r),o=null!=(t=e.ndimArray)?t:0;return(e,t,r)=>{if(null==e)return e;e=n(e,r,o);let i=o,u=e;for(;i>0&&Array.isArray(u);)i--,u=u[0];if(void 0!==u)for(let t=0;t<i;t++)e=[e];return e}}(e);if(1===r)return a(e);if("type"in e&&c(e.type)){var n,o;const t=null==(n=e.type.prototype)||null==(o=n.itemType)?void 0:o.Type,r=a("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return s(e)}function s(e){return"type"in e?function(e){if(e.prototype.read)return(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void u.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i};return e.fromJSON}(e.type):function(e){var t;let r=null;const i=null!=(t=e.errorContext)?t:"type";return(t,p,s)=>{if(null==t)return t;const y=typeof t;if("object"!==y)return void u.error(`Expected JSON value of type 'object' to deserialize, but got '${y}'`);r||(r=function(e){const t={};for(const i in e.typeMap){var r,o;const u=e.typeMap[i],p=n.getOwnClassMetadata(u.prototype);if("function"==typeof e.key)continue;const s=p.properties[e.key];if(!s)continue;null!=(r=s.json)&&r.type&&Array.isArray(s.json.type)&&1===s.json.type.length&&"string"==typeof s.json.type[0]&&(t[s.json.type[0]]=u);const y=null==(o=s.json)?void 0:o.write;if(!y||!y.writer){t[i]=u;continue}const a=y.target,c="string"==typeof a?a:e.key,f={};y.writer(i,f,c),f[c]&&(t[f[c]]=u)}return t}(e));const a=e.key;if("string"!=typeof a)return;const c=t[a],f=c?r[c]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!f){const e=`Type '${c||"unknown"}' is not supported`;return s&&s.messages&&t&&s.messages.push(new o(`${i}:unsupported`,e,{definition:t,context:s})),void u.error(e)}const l=new f;return l.read(t,s),l}}(e.types)}function y(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map((t=>y(e,t,r,n-1))):e(t,void 0,r)}function a(e){const t=s(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function c(e){if(!i.isCollection(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?f(t.Type):l(t.Type))}function f(e){return!Array.isArray(e)&&(!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||c(e)))}function l(e){for(const t in e.typeMap){if(!f(e.typeMap[t]))return!1}return!0}e.create=function(e,r,n){var o,i;e&&(!n&&!r.read||null!=(o=r.read)&&o.reader||!1===(null==(i=r.read)?void 0:i.enabled)||function(e){if("types"in e)return l(e.types);return f(e.type)}(e)&&t.setDeepValue("read.reader",p(e),r))},e.createTypeReader=p,Object.defineProperty(e,"__esModule",{value:!0})}));
