/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../has","../lang","../Logger","./utils","./get","./PropertyOrigin","../ObjectPool","./Property","./Store","./tracking"],(function(t,e,i,s,n,r,o,a,c,l,u){"use strict";s.getLogger("esri.core.accessorSupport.Properties");function h(t,e,i){return void 0!==t}function f(t,e,i,s){return void 0!==t&&(!(null==i&&8&t.flags)||(s.lifecycle,!1))}let g=function(){function e(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=0,this.store=new l.Store,this._origin=6;const e=this.host.constructor.__accessorMetadata__,i=e.properties;for(const t in i){const e=new c.Property(t,i[t]);this.properties.set(t,e)}this.metadatas=i,this._autoDestroy=e.autoDestroy}var s=e.prototype;return s.initialize=function(){this.lifecycle=1},s.constructed=function(){this.lifecycle=2},s.destroy=function(){if(this.destroyed=!0,this._autoDestroy)for(const[e,i]of this.properties){const s=this.internalGet(e);s&&((t=s)&&"function"==typeof t.destroy)&&(s.destroy(),8&~i.flags&&this._internalSet(i,null)),i.destroy()}else for(const[t,e]of this.properties)e.destroy();var t},s.get=function(t){return this.properties.get(t).metadata.get?this.getterComputed(t):this.getterStatic(t)},s.getterStatic=function(t){const e=this.properties.get(t);if(void 0!==e)return u.trackPropertyAccess(e),this.store.has(t)?this.store.get(t):e.metadata.value},s.getterComputed=function(t){const e=this.properties.get(t);u.trackPropertyAccess(e);const i=this.store,s=e.flags,n=this.store.get(t);if(4&s)return n;if(i.has(t)&&(1&~s||c.isInvalidating()))return n;let r;e.flags|=4;const o=e.metadata.get;64&s?r=u.runTracked(e,o,this.host):(u.trackExplicitDependencies(this.host,e),r=o.call(this.host)),i.set(t,r,1);const a=this.store.get(t);return a===n?e.flags&=-2:e.commit(),e.flags&=-5,a},s.originOf=function(t){const e=this.store.originOf(t);if(void 0===e){const e=this.properties.get(t);if(void 0!==e&&16&e.flags)return"defaults"}return o.idToName(e)},s.has=function(t){return!!this.properties.has(t)&&this.store.has(t)},s.keys=function(){return[...this.properties.keys()]},s.internalGet=function(t){const e=this.properties.get(t);if(h(e))return this.store.has(t)?this.store.get(t):e.metadata.value},s.internalSet=function(t,e){const i=this.properties.get(t);h(i)&&this._internalSet(i,e)},s.getDependsInfo=function(t,e,i,s){const o=this.properties.get(i);if(!h(o))return"";let a=`${s}${e}.${i}: ${r.get(t,i)}\n`;if(!o.metadata.dependsOn||0===o.metadata.dependsOn.length)return a;s+="  ";for(const e of o.metadata.dependsOn){const i=e.split(".");if(1===i.length)a+=`${s}${e}: ${r.get(t,e)}\n`;else{const o=i[i.length-1];--i.length;const c=i.join("."),l=r.get(t,c),u=n.getProperties(l);a+=u?u.getDependsInfo(l,c,o,s):`${s}${e}: undefined\n`}}return a},s.setAtOrigin=function(t,e,i){const s=this.properties.get(t);if(h(s))return this._setAtOrigin(s,e,i)},s.isOverridden=function(t){const e=this.properties.get(t);return void 0!==e&&!!(2&e.flags)},s.clearOverride=function(t){const e=this.properties.get(t);void 0!==e&&2&e.flags&&(e.flags&=-3,e.invalidate())},s.override=function(t,e){const i=this.properties.get(t);if(!f(i,0,e,this))return;const s=i.metadata.cast;if(s){const t=this._cast(s,e),{valid:i,value:n}=t;if(p.release(t),!i)return;e=n}i.flags|=2,this._internalSet(i,e)},s.set=function(t,e){const i=this.properties.get(t);if(!f(i,0,e,this))return;const s=i.metadata.cast;if(s){const t=this._cast(s,e),{valid:i,value:n}=t;if(p.release(t),!i)return;e=n}const n=i.metadata.set;n?n.call(this.host,e):this._internalSet(i,e)},s.setDefaultOrigin=function(t){this._origin=o.nameToId(t)},s.getDefaultOrigin=function(){return o.idToName(this._origin)},s.propertyInvalidated=function(t){const e=this.properties.get(t);void 0!==e&&e.invalidate()},s.propertyCommitted=function(t){const e=this.properties.get(t);void 0!==e&&e.commit()},s._internalSet=function(t,e){const i=0!==this.lifecycle?this._origin:0;this._setAtOrigin(t,e,i)},s._setAtOrigin=function(t,e,s){const n=this.store,r=t.propertyName;n.has(r,s)&&i.equals(e,n.get(r))&&2&~t.flags&&s===n.originOf(r)||(c.startInvalidating(),t.invalidate(),c.stopInvalidating(),n.set(r,e,s),t.commit(),u.initializeDependencyTracking(this.host,t))},s._cast=function(t,e){const i=p.acquire();return i.valid=!0,i.value=e,t&&(i.value=t.call(this.host,e,i)),i},t._createClass(e,[{key:"initialized",get:function(){return 0!==this.lifecycle}}]),e}();const p=new a(function(){function t(){this.value=null,this.valid=!0}var e=t.prototype;return e.acquire=function(){this.valid=!0},e.release=function(){this.value=null},t}());return g}));
