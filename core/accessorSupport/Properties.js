/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../has","../lang","../Logger","../ObjectPool","./Property","./PropertyOrigin","./Store","./tracking","./utils"],(function(t,e,i,n,s,r,o,a,c,u){"use strict";function l(t,e,i){return void 0!==t}function f(t,e,i,n){return void 0!==t&&(!(null==i&&8&t.flags)||(n.lifecycle,!1))}function h(t){return t&&"function"==typeof t.destroy}n.getLogger("esri.core.accessorSupport.Properties");let p=function(){function e(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=0,this.store=new a.Store,this._origin=6;const e=this.host.constructor.__accessorMetadata__,i=e.properties;for(const n in i){const t=new r.Property(this,n,i[n]);this.properties.set(n,t)}this.metadatas=i,this._autoDestroy=e.autoDestroy}var n=e.prototype;return n.initialize=function(){this.lifecycle=1},n.constructed=function(){this.lifecycle=2},n.destroy=function(){if(this.destroyed=!0,this._autoDestroy)for(const[t,e]of this.properties){const i=this.internalGet(t);i&&h(i)&&(i.destroy(),8&~e.flags&&this._internalSet(e,null)),e.destroy()}else for(const[t,e]of this.properties)e.destroy()},n.get=function(t){const e=this.properties.get(t);if(e.metadata.get)return e.getComputed();c.trackAccess(e);const i=this.store;return i.has(t)?i.get(t):e.metadata.value},n.originOf=function(t){const e=this.store.originOf(t);if(void 0===e){const e=this.properties.get(t);if(void 0!==e&&16&e.flags)return"defaults"}return o.idToName(e)},n.has=function(t){return!!this.properties.has(t)&&this.store.has(t)},n.keys=function(){return[...this.properties.keys()]},n.internalGet=function(t){const e=this.properties.get(t);if(l(e))return this.store.has(t)?this.store.get(t):e.metadata.value},n.internalSet=function(t,e){const i=this.properties.get(t);l(i)&&this._internalSet(i,e)},n.getDependsInfo=function(t,e,i){const n=this.properties.get(e);if(!l(n))return"";const s=new Set,o=c.runTracked({onObservableAccessed:t=>s.add(t),onTrackingEnd:()=>{}},(()=>{var e;return null==(e=n.metadata.get)?void 0:e.call(t)}));let a=`${i}${t.declaredClass.split(".").pop()}.${e}: ${o}\n`;if(0===s.size)return a;i+="  ";for(const c of s){if(!(c instanceof r.Property))continue;const t=c.properties.host,e=c.propertyName,n=u.getProperties(t);a+=n?n.getDependsInfo(t,e,i):`${i}${e}: undefined\n`}return a},n.setAtOrigin=function(t,e,i){const n=this.properties.get(t);if(l(n))return this._setAtOrigin(n,e,i)},n.isOverridden=function(t){const e=this.properties.get(t);return void 0!==e&&!!(2&e.flags)},n.clearOverride=function(t){const e=this.properties.get(t);void 0!==e&&2&e.flags&&(e.flags&=-3,e.notifyChange())},n.override=function(t,e){const i=this.properties.get(t);if(!f(i,t,e,this))return;const n=i.metadata.cast;if(n){const t=this._cast(n,e),{valid:i,value:s}=t;if(g.release(t),!i)return;e=s}i.flags|=2,this._internalSet(i,e)},n.set=function(t,e){const i=this.properties.get(t);if(!f(i,t,e,this))return;const n=i.metadata.cast;if(n){const t=this._cast(n,e),{valid:i,value:s}=t;if(g.release(t),!i)return;e=s}const s=i.metadata.set;s?s.call(this.host,e):this._internalSet(i,e)},n.setDefaultOrigin=function(t){this._origin=o.nameToId(t)},n.getDefaultOrigin=function(){return o.idToName(this._origin)},n.notifyChange=function(t){const e=this.properties.get(t);void 0!==e&&e.notifyChange()},n.invalidate=function(t){const e=this.properties.get(t);void 0!==e&&e.invalidate()},n.commit=function(t){const e=this.properties.get(t);void 0!==e&&e.commit()},n._internalSet=function(t,e){const i=0!==this.lifecycle?this._origin:0;this._setAtOrigin(t,e,i)},n._setAtOrigin=function(t,e,n){const s=this.store,r=t.propertyName;s.has(r,n)&&i.equals(e,s.get(r))&&2&~t.flags&&n===s.originOf(r)||(t.invalidate(),s.set(r,e,n),t.commit(),c.initializeDependencyTracking(this.host,t))},n._cast=function(t,e){const i=g.acquire();return i.valid=!0,i.value=e,t&&(i.value=t.call(this.host,e,i)),i},t._createClass(e,[{key:"initialized",get:function(){return 0!==this.lifecycle}}]),e}();const g=new s(function(){function t(){this.value=null,this.valid=!0}var e=t.prototype;return e.acquire=function(){this.valid=!0},e.release=function(){this.value=null},t}());return p}));
