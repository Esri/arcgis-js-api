/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","exports","../arcade/arcadeCompiler","../arcade/arcadeRuntime","../arcade/parser","../arcade/treeAnalysis","../core/has","../core/promiseUtils"],(function(e,t,n,r,c,i,s,u){"use strict";const o=["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"];function a(){if(s("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}const p=a();let l=!1,f=!1,d=null,S=[];function y(e,t){if(!0===t.useAsync||!0===e.isAsync)return m(e,t);if(s("csp-restrictions")){return function(t){return r.executeScript(e,t)}}return n.compileScript(e,t)}function m(e,t){if(null===d)throw new Error("Async Arcade must be enabled for this script");if(s("csp-restrictions")||!1===p){return function(t){return d.executeScript(e,t)}}return n.compileScript(e,t,!0)}function x(e){r.extend(e),n.extend(e,"sync"),null===d?S.push(e):(n.extend(e,"async"),d.extend(e))}function b(e,t=[]){return c.parseScript(e,t)}function h(e,t,n=""){return c.validateScript(e,t,n)}function A(e,t,n,r=""){return c.scriptCheck(e,t,n,r)}function F(e,t,n=[]){return g(c.parseScript(e,n),t)}function g(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===d)throw new Error("Async Arcade must be enabled for this script");return d.executeScript(e,t)}return r.executeScript(e,t)}function E(e,t){return r.referencesMember(e,t)}function w(e,t){return r.referencesFunction(e,t)}function G(e,t=!1){return c.extractFieldLiterals(e)}function v(e){return c.extractExpectedFieldLiterals(e)}function P(e,t=[]){return void 0===e.usesGeometry&&i.findScriptDependencies(e,t),!0===e.usesGeometry}let U=null;function L(){return U||(U=u.all([new Promise((function(t,n){e(["../geometry/geometryEngine"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/geomsync"],t,n)}))]).then((([e,t])=>(f=!0,t.setGeometryEngine(e),!0))),U)}let k=null;function C(){return null!==k||(k=n.enableAsyncSupport().then((()=>new Promise((function(t,n){e(["../arcade/arcadeAsyncRuntime"],t,n)})))).then((e=>{d=e;for(const t of S)d.extend(t),n.extend(t,"async");return S=null,!0}))),k}function D(){return l}function _(){return!!d}function M(){return f}let I=null;function O(){return I||(I=C().then((()=>u.all([new Promise((function(t,n){e(["../arcade/featureSetUtils"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetbase"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetgeom"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetstats"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetstring"],t,n)}))]).then((([e,t,r,c,i])=>(B=e,d.extend([t,r,c,i]),n.extend([t,r,c,i],"async"),l=!0,!0))))),I)}function R(e,t=[]){return void 0===e.usesFeatureSet&&i.findScriptDependencies(e,t),!0===e.usesFeatureSet}function T(e,t=[]){return void 0===e.isAsync&&i.findScriptDependencies(e,t),!0===e.isAsync}function j(e,t){if(t){for(const n of t)if(E(e,n))return!0;return!1}return!1}function q(e,t,n=[],r=!1){return u.create(((c,i)=>{const s="string"==typeof e?b(e):e,o=[];s&&(!1===M()&&(P(s)||r)&&o.push(L()),!1===_()&&(!0===s.isAsync||t)&&o.push(C()),!1===D()&&(R(s)||j(s,n))&&o.push(O())),o.length?u.all(o).then((()=>{c(!0)}),i):c(!0)}))}function z(e){if(P(e))return!0;const t=i.findFunctionCalls(e);let n=!1;for(let r=0;r<t.length;r++)if(o.indexOf(t[r])>-1){n=!0;break}return n}let B=null;function H(){return B}var J=Object.freeze({__proto__:null,compileScript:y,extend:x,parseScript:b,validateScript:h,scriptCheck:A,parseAndExecuteScript:F,executeScript:g,referencesMember:E,referencesFunction:w,extractFieldLiterals:G,extractExpectedFieldLiterals:v,scriptUsesGeometryEngine:P,enableGeometrySupport:L,enableAsyncSupport:C,isFeatureSetSupportEnabled:D,isAsyncEnabled:_,isGeometryEnabled:M,enableFeatureSetSupport:O,scriptUsesFeatureSet:R,scriptIsAsync:T,loadScriptDependencies:q,scriptTouchesGeometry:z,featureSetUtils:H});t.arcade=J,t.compileScript=y,t.enableAsyncSupport=C,t.enableFeatureSetSupport=O,t.enableGeometrySupport=L,t.executeScript=g,t.extend=x,t.extractExpectedFieldLiterals=v,t.extractFieldLiterals=G,t.featureSetUtils=H,t.isAsyncEnabled=_,t.isFeatureSetSupportEnabled=D,t.isGeometryEnabled=M,t.loadScriptDependencies=q,t.parseAndExecuteScript=F,t.parseScript=b,t.referencesFunction=w,t.referencesMember=E,t.scriptCheck=A,t.scriptIsAsync=T,t.scriptTouchesGeometry=z,t.scriptUsesFeatureSet=R,t.scriptUsesGeometryEngine=P,t.validateScript=h}));
