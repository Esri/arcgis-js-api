/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../core/has","../core/promiseUtils","./languageUtils","../arcade/treeAnalysis","../arcade/arcadeCompiler","../arcade/arcadeRuntime","../arcade/parser","../intl/moment"],(function(e,t,n,r,c,i,u,s,o,a){"use strict";const p=function(){if(n("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}();let f=!1,l=!1,d=null,S=[];function m(e,t){if(!0===t.useAsync||!0===e.isAsync)return function(e,t){if(null===d)throw new Error("Async Arcade must be enabled for this script");if(n("csp-restrictions")||!1===p){return function(t){return d.executeScript(e,t)}}return u.compileScript(e,t,!0)}(e,t);if(n("csp-restrictions")){return function(t){return s.executeScript(e,t)}}return u.compileScript(e,t)}function y(e){s.extend(e),u.extend(e,"sync"),null===d?S.push(e):(u.extend(e,"async"),d.extend(e))}function x(e,t=[]){return o.parseScript(e,t)}function b(e,t,n=""){return o.validateScript(e,t,n)}function h(e,t,n,r=""){return o.scriptCheck(e,t,n,r)}function A(e,t,n=[]){return F(o.parseScript(e,n),t)}function F(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===d)throw new Error("Async Arcade must be enabled for this script");return d.executeScript(e,t)}return s.executeScript(e,t)}function E(e,t){return s.referencesMember(e,t)}function g(e,t){return s.referencesFunction(e,t)}function w(e,t=!1){return o.extractFieldLiterals(e)}function G(e,t=[]){return void 0===e.usesGeometry&&i.findScriptDependencies(e,t),!0===e.usesGeometry}let U=null;function P(){return U||(U=r.all([new Promise((function(t,n){e(["../geometry/geometryEngine"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/geomsync"],t,n)}))]).then((([e,t])=>(l=!0,t.setGeometryEngine(e),!0))),U)}let v=null;function M(){return null!==v||(v=u.enableAsyncSupport().then((()=>new Promise((function(t,n){e(["../arcade/arcadeAsyncRuntime"],t,n)})))).then((e=>{d=e;for(const e of S)d.extend(e),u.extend(e,"async");return S=null,!0}))),v}function C(){return f}function D(){return!!d}function L(){return l}let _=null;function k(){return _||(_=M().then((()=>r.all([new Promise((function(t,n){e(["../arcade/featureSetUtils"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetbase"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetgeom"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetstats"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetstring"],t,n)}))]).then((([e,t,n,r,c])=>(j=e,d.extend([t,n,r,c]),u.extend([t,n,r,c],"async"),f=!0,!0))))),_)}function O(e,t=[]){return void 0===e.usesFeatureSet&&i.findScriptDependencies(e,t),!0===e.usesFeatureSet}function I(e,t=[]){return void 0===e.isAsync&&i.findScriptDependencies(e,t),!0===e.isAsync}function R(e,t,n=[],c=!1){return r.create(((i,u)=>{const s="string"==typeof e?x(e):e,o=[];o.push(z()),s&&(!1===L()&&(G(s)||c)&&o.push(P()),!1===D()&&(!0===s.isAsync||t)&&o.push(M()),!1===C()&&(O(s)||function(e,t){if(t){for(const n of t)if(E(e,n))return!0;return!1}return!1}(s,n))&&o.push(k())),o?r.all(o).then((()=>{i(!0)}),u):i(!0)}))}function T(e){if(G(e))return!0;const t=i.findFunctionCalls(e);return t.indexOf("geometry")>-1||t.indexOf("feature")>-1}let j=null;function q(){return j}function z(){return null!==B||(B=a.loadMoment().then((e=>(c.MomentLibrary.Moment=e,!0)))),B}let B=null;var H=Object.freeze({__proto__:null,compileScript:m,extend:y,parseScript:x,validateScript:b,scriptCheck:h,parseAndExecuteScript:A,executeScript:F,referencesMember:E,referencesFunction:g,extractFieldLiterals:w,scriptUsesGeometryEngine:G,enableGeometrySupport:P,enableAsyncSupport:M,isFeatureSetSupportEnabled:C,isAsyncEnabled:D,isGeometryEnabled:L,enableFeatureSetSupport:k,scriptUsesFeatureSet:O,scriptIsAsync:I,loadScriptDependencies:R,scriptTouchesGeometry:T,featureSetUtils:q,load:z});t.arcade=H,t.compileScript=m,t.enableAsyncSupport=M,t.enableFeatureSetSupport=k,t.enableGeometrySupport=P,t.executeScript=F,t.extend=y,t.extractFieldLiterals=w,t.featureSetUtils=q,t.isAsyncEnabled=D,t.isFeatureSetSupportEnabled=C,t.isGeometryEnabled=L,t.load=z,t.loadScriptDependencies=R,t.parseAndExecuteScript=A,t.parseScript=x,t.referencesFunction=g,t.referencesMember=E,t.scriptCheck=h,t.scriptIsAsync=I,t.scriptTouchesGeometry=T,t.scriptUsesFeatureSet=O,t.scriptUsesGeometryEngine=G,t.validateScript=b}));
