/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../core/has","../core/promiseUtils","./languageUtils","../arcade/treeAnalysis","../arcade/arcadeCompiler","../arcade/arcadeRuntime","../arcade/parser","../intl/moment"],(function(e,t,n,r,c,i,u,s,o,a){"use strict";function p(){if(n("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}const f=p();let l=!1,d=!1,S=null,m=[];function y(e,t){if(!0===t.useAsync||!0===e.isAsync)return x(e,t);if(n("csp-restrictions")){return function(t){return s.executeScript(e,t)}}return u.compileScript(e,t)}function x(e,t){if(null===S)throw new Error("Async Arcade must be enabled for this script");if(n("csp-restrictions")||!1===f){return function(t){return S.executeScript(e,t)}}return u.compileScript(e,t,!0)}function b(e){s.extend(e),u.extend(e,"sync"),null===S?m.push(e):(u.extend(e,"async"),S.extend(e))}function h(e,t=[]){return o.parseScript(e,t)}function A(e,t,n=""){return o.validateScript(e,t,n)}function F(e,t,n,r=""){return o.scriptCheck(e,t,n,r)}function E(e,t,n=[]){return g(o.parseScript(e,n),t)}function g(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===S)throw new Error("Async Arcade must be enabled for this script");return S.executeScript(e,t)}return s.executeScript(e,t)}function w(e,t){return s.referencesMember(e,t)}function G(e,t){return s.referencesFunction(e,t)}function U(e,t=!1){return o.extractFieldLiterals(e)}function P(e,t=[]){return void 0===e.usesGeometry&&i.findScriptDependencies(e,t),!0===e.usesGeometry}let v=null;function M(){return v||(v=r.all([new Promise((function(t,n){e(["../geometry/geometryEngine"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/geomsync"],t,n)}))]).then((([e,t])=>(d=!0,t.setGeometryEngine(e),!0))),v)}let C=null;function D(){return null!==C||(C=u.enableAsyncSupport().then((()=>new Promise((function(t,n){e(["../arcade/arcadeAsyncRuntime"],t,n)})))).then((e=>{S=e;for(const t of m)S.extend(t),u.extend(t,"async");return m=null,!0}))),C}function L(){return l}function _(){return!!S}function k(){return d}let O=null;function I(){return O||(O=D().then((()=>r.all([new Promise((function(t,n){e(["../arcade/featureSetUtils"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetbase"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetgeom"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetstats"],t,n)})),new Promise((function(t,n){e(["../arcade/functions/featuresetstring"],t,n)}))]).then((([e,t,n,r,c])=>(B=e,S.extend([t,n,r,c]),u.extend([t,n,r,c],"async"),l=!0,!0))))),O)}function R(e,t=[]){return void 0===e.usesFeatureSet&&i.findScriptDependencies(e,t),!0===e.usesFeatureSet}function T(e,t=[]){return void 0===e.isAsync&&i.findScriptDependencies(e,t),!0===e.isAsync}function j(e,t){if(t){for(const n of t)if(w(e,n))return!0;return!1}return!1}function q(e,t,n=[],c=!1){return r.create(((i,u)=>{const s="string"==typeof e?h(e):e,o=[];o.push(J()),s&&(!1===k()&&(P(s)||c)&&o.push(M()),!1===_()&&(!0===s.isAsync||t)&&o.push(D()),!1===L()&&(R(s)||j(s,n))&&o.push(I())),o?r.all(o).then((()=>{i(!0)}),u):i(!0)}))}function z(e){if(P(e))return!0;const t=i.findFunctionCalls(e);return t.indexOf("geometry")>-1||t.indexOf("feature")>-1}let B=null;function H(){return B}function J(){return null!==K||(K=a.loadMoment().then((e=>(c.MomentLibrary.Moment=e,!0)))),K}let K=null;var N=Object.freeze({__proto__:null,compileScript:y,extend:b,parseScript:h,validateScript:A,scriptCheck:F,parseAndExecuteScript:E,executeScript:g,referencesMember:w,referencesFunction:G,extractFieldLiterals:U,scriptUsesGeometryEngine:P,enableGeometrySupport:M,enableAsyncSupport:D,isFeatureSetSupportEnabled:L,isAsyncEnabled:_,isGeometryEnabled:k,enableFeatureSetSupport:I,scriptUsesFeatureSet:R,scriptIsAsync:T,loadScriptDependencies:q,scriptTouchesGeometry:z,featureSetUtils:H,load:J});t.arcade=N,t.compileScript=y,t.enableAsyncSupport=D,t.enableFeatureSetSupport=I,t.enableGeometrySupport=M,t.executeScript=g,t.extend=b,t.extractFieldLiterals=U,t.featureSetUtils=H,t.isAsyncEnabled=_,t.isFeatureSetSupportEnabled=L,t.isGeometryEnabled=k,t.load=J,t.loadScriptDependencies=q,t.parseAndExecuteScript=E,t.parseScript=h,t.referencesFunction=G,t.referencesMember=w,t.scriptCheck=F,t.scriptIsAsync=T,t.scriptTouchesGeometry=z,t.scriptUsesFeatureSet=R,t.scriptUsesGeometryEngine=P,t.validateScript=A}));
