/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../arcade/FunctionWrapper","../arcade/ImmutableArray","../arcade/ImmutablePathArray","../arcade/ImmutablePointArray","../core/promiseUtils","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","./datetime","../core/maybe","../core/number","../geometry/support/coordsUtils","../intl/locale"],(function(e,t,n,r,i,o,a,u,l,s,f,c,m,g,d,y,h){"use strict";let p=function(e){this.value=e},S=function(e){this.value=e},x=function(e){this.fn=e},b=function(e,t){this.paramCount=t,this.fn=e};const T=x,N=S,R=p,D=b,A={type:"VOID"},k={type:"BREAK"},M={type:"CONTINUE"};function C(e,t,n){return""===t||null==t||t===n||t===n?e:e=e.split(t).join(n)}function v(e){return e instanceof x||e instanceof t||e instanceof b}function F(e){return!!I(e)||(!!w(e)||(!!E(e)||(!!_(e)||(null===e||(e===A||"number"==typeof e)))))}function O(e,t){return void 0===e?t:e}function I(e){return"string"==typeof e||e instanceof String}function _(e){return"boolean"==typeof e}function w(e){return"number"==typeof e}function Z(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}function J(e){return e instanceof Array}function L(e){return!0===(e&&e.declaredRootClass&&"esri.arcade.featureset.support.FeatureSet"===e.declaredRootClass)}function Y(e){return!0===(e&&e.declaredRootClass&&"esri.arcade.featureSetCollection"===e.declaredRootClass)}function P(e){return e instanceof n}function E(e){return e instanceof Date}function j(e,t,n){if(e.length<t||e.length>n)throw new Error("Function called with wrong number of Parameters")}function z(e){return e<0?-Math.round(-e):Math.round(e)}function G(){let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)}))}function U(e,t){return!1===isNaN(e)?null==t||""===t?e.toString():(t=C(t,"‰",""),t=C(t,"¤",""),d.format(e,{pattern:t})):e.toString()}function V(e,t){const n=m.DateTime.fromJSDate(e);return null==t||""===t?n.toISO({suppressMilliseconds:!0}):n.toFormat(H(t),{locale:h.getLocale(),numberingSystem:"latn"})}function H(e){e=e.replace(/LTS|LT|LL?L?L?|l{1,4}/g,"[$&]");let t="";const n=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;for(const r of e.match(n))switch(r){case"D":t+="d";break;case"DD":t+="dd";break;case"DDD":t+="o";break;case"d":t+="c";break;case"ddd":t+="ccc";break;case"dddd":t+="cccc";break;case"M":t+="L";break;case"MM":t+="LL";break;case"MMM":t+="LLL";break;case"MMMM":t+="LLLL";break;case"YY":t+="yy";break;case"Y":case"YYYY":t+="yyyy";break;case"Q":t+="q";break;case"Z":t+="ZZ";break;case"ZZ":t+="ZZZ";break;case"S":t+="'S'";break;case"SS":t+="'SS'";break;case"SSS":t+="u";break;case"A":case"a":t+="a";break;case"m":case"mm":case"h":case"hh":case"H":case"HH":case"s":case"ss":case"X":case"x":t+=r;break;default:r.length>=2&&"["===r.slice(0,1)&&"]"===r.slice(-1)?t+=`'${r.slice(1,-1)}'`:t+=`'${r}'`}return t}function q(e,t,n){switch(n){case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}return!1}function B(e,t,n){if(null===e){if(null===t||t===A)return q(null,null,n);if(w(t))return q(0,t,n);if(I(t))return q(0,ee(t),n);if(_(t))return q(0,ee(t),n);if(E(t))return q(0,t.getTime(),n)}if(e===A){if(null===t||t===A)return q(null,null,n);if(w(t))return q(0,t,n);if(I(t))return q(0,ee(t),n);if(_(t))return q(0,ee(t),n);if(E(t))return q(0,t.getTime(),n)}else if(w(e)){if(w(t))return q(e,t,n);if(_(t))return q(e,ee(t),n);if(null===t||t===A)return q(e,0,n);if(I(t))return q(e,ee(t),n);if(E(t))return q(e,t.getTime(),n)}else if(I(e)){if(I(t))return q(W(e),W(t),n);if(E(t))return q(ee(e),t.getTime(),n);if(w(t))return q(ee(e),t,n);if(null===t||t===A)return q(ee(e),0,n);if(_(t))return q(ee(e),ee(t),n)}else if(E(e)){if(E(t))return q(e,t,n);if(null===t||t===A)return q(e.getTime(),0,n);if(w(t))return q(e.getTime(),t,n);if(_(t))return q(e.getTime(),ee(t),n);if(I(t))return q(e.getTime(),ee(t),n)}else if(_(e)){if(_(t))return q(e,t,n);if(w(t))return q(ee(e),ee(t),n);if(E(t))return q(ee(e),t.getTime(),n);if(null===t||t===A)return q(ee(e),0,n);if(I(t))return q(ee(e),ee(t),n)}return!!$(e,t)&&("<="===n||">="===n)}function $(e,t){if(e===t)return!0;if(null===e&&t===A||null===t&&e===A)return!0;if(E(e)&&E(t))return e.getTime()===t.getTime();if(e instanceof r)return e.equalityTest(t);if(e instanceof i)return e.equalityTest(t);if(e instanceof s&&t instanceof s){const n=e.cache._arcadeCacheId,r=t.cache._arcadeCacheId;if(null!=n)return n===r}if(void 0!==e&&void 0!==t&&null!==e&&null!==t&&"object"==typeof e&&"object"==typeof t){if(e._arcadeCacheId===t._arcadeCacheId&&void 0!==e._arcadeCacheId&&null!==e._arcadeCacheId)return!0;if(e._underlyingGraphic===t._underlyingGraphic&&void 0!==e._underlyingGraphic&&null!==e._underlyingGraphic)return!0}return!1}function W(e,t){if(I(e))return e;if(null===e)return"";if(w(e))return U(e,t);if(_(e))return e.toString();if(E(e))return V(e,t);if(e instanceof u)return JSON.stringify(e.toJSON());if(J(e)){const t=[];for(let n=0;n<e.length;n++)t[n]=K(e[n]);return"["+t.join(",")+"]"}if(e instanceof n){const t=[];for(let n=0;n<e.length();n++)t[n]=K(e.get(n));return"["+t.join(",")+"]"}return null!==e&&"object"==typeof e&&void 0!==e.castToText?e.castToText():v(e)?"object, Function":""}function Q(e){const t=[];if(!1===J(e))return null;if(e instanceof n){for(let n=0;n<e.length();n++)t[n]=ee(e.get(n));return t}for(let n=0;n<e.length;n++)t[n]=ee(e[n]);return t}function X(e,t){if(I(e))return e;if(null===e)return"";if(w(e))return U(e,t);if(_(e))return e.toString();if(E(e))return V(e,t);if(e instanceof u)return e instanceof a?'{"xmin":'+e.xmin.toString()+',"ymin":'+e.ymin.toString()+","+(e.hasZ?'"zmin":'+e.zmin.toString()+",":"")+(e.hasM?'"mmin":'+e.mmin.toString()+",":"")+'"xmax":'+e.xmax.toString()+',"ymax":'+e.ymax.toString()+","+(e.hasZ?'"zmax":'+e.zmax.toString()+",":"")+(e.hasM?'"mmax":'+e.mmax.toString()+",":"")+'"spatialReference":'+ce(e.spatialReference)+"}":ce(e.toJSON(),((e,t)=>e.key===t.key?0:"spatialReference"===e.key?1:"spatialReference"===t.key||e.key<t.key?-1:e.key>t.key?1:0));if(J(e)){const t=[];for(let n=0;n<e.length;n++)t[n]=K(e[n]);return"["+t.join(",")+"]"}if(e instanceof n){const t=[];for(let n=0;n<e.length();n++)t[n]=K(e.get(n));return"["+t.join(",")+"]"}return null!==e&&"object"==typeof e&&void 0!==e.castToText?e.castToText():v(e)?"object, Function":""}function K(e){if(null===e)return"null";if(_(e)||w(e)||I(e))return JSON.stringify(e);if(e instanceof u)return X(e);if(e instanceof n)return X(e);if(e instanceof Array)return X(e);if(e instanceof Date)return JSON.stringify(V(e,""));if(null!==e&&"object"==typeof e){if(void 0!==e.castToText)return e.castToText()}else if(e===A)return"null";return"null"}function ee(e,t){return w(e)?e:null===e||""===e?0:E(e)?NaN:_(e)?e?1:0:J(e)||""===e||void 0===e?NaN:void 0!==t&&I(e)?(t=C(t,"‰",""),t=C(t,"¤",""),d.parse(e,{pattern:t})):e===A?0:Number(e)}function te(e){if(E(e))return e;if(I(e)){const t=re(e);if(t)return t.toJSDate()}return null}function ne(e){return E(e)?m.DateTime.fromJSDate(e):I(e)?re(e):null}function re(e){const t=/ (\d\d)/;let n=m.DateTime.fromISO(e);return n.isValid||t.test(e)&&(e=e.replace(t,"T$1"),n=m.DateTime.fromISO(e),n.isValid)?n:null}function ie(e){return _(e)?e:I(e)?"true"===(e=e.toLowerCase()):!!w(e)&&(0!==e&&!isNaN(e))}function oe(e,t){return g.isNone(e)?null:(null!==e.spatialReference&&void 0!==e.spatialReference||(e.spatialReference=t),e)}function ae(e){if(null===e)return null;if(e instanceof s)return"NaN"===e.x||null===e.x||isNaN(e.x)?null:e;if(e instanceof f){if(0===e.rings.length)return null;for(const t of e.rings)if(t.length>0)return e;return null}if(e instanceof c){if(0===e.paths.length)return null;for(const t of e.paths)if(t.length>0)return e;return null}return e instanceof l?0===e.points.length?null:e:e instanceof a?"NaN"===e.xmin||null===e.xmin||isNaN(e.xmin)?null:e:null}function ue(e,t){if(!e)return t;if(!e.domain)return t;let n=null;if("string"===e.field.type||"esriFieldTypeString"===e.field.type)t=W(t);else{if(null==t)return null;if(""===t)return t;t=ee(t)}for(let r=0;r<e.domain.codedValues.length;r++){const i=e.domain.codedValues[r];i.code===t&&(n=i)}return null===n?t:n.name}function le(e,t){if(!e)return t;if(!e.domain)return t;let n=null;t=W(t);for(let r=0;r<e.domain.codedValues.length;r++){const i=e.domain.codedValues[r];i.name===t&&(n=i)}return null===n?t:n.code}function se(e,t,n=null,r){if(!t)return null;if(!t.fields)return null;let i,o,a=null;for(let u=0;u<t.fields.length;u++){const n=t.fields[u];n.name.toLowerCase()===e.toString().toLowerCase()&&(a=n)}if(null===a)throw new Error("Field not found");return r||(r=n&&t.typeIdField&&n._field(t.typeIdField)),null!=r&&t.types.some((function(e){return e.id===r&&(i=e.domains&&e.domains[a.name],i&&"inherited"===i.type&&(i=fe(a.name,t),o=!0),!0)})),o||i||(i=fe(e,t)),{field:a,domain:i}}function fe(e,t){let n;return t.fields.some((function(t){return t.name.toLowerCase()===e.toLowerCase()&&(n=t.domain),!!n})),n}function ce(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});const n="boolean"==typeof t.cycles&&t.cycles,r=t.cmp&&(i=t.cmp,function(e){return function(t,n){const r={key:t,value:e[t]},o={key:n,value:e[n]};return i(r,o)}});var i;const o=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0===t)return;if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);let i,a;if(Array.isArray(t)){for(a="[",i=0;i<t.length;i++)i&&(a+=","),a+=e(t[i])||"null";return a+"]"}if(null===t)return"null";if(-1!==o.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const u=o.push(t)-1,l=Object.keys(t).sort(r&&r(t));for(a="",i=0;i<l.length;i++){const n=l[i],r=e(t[n]);r&&(a&&(a+=","),a+=JSON.stringify(n)+":"+r)}return o.splice(u,1),"{"+a+"}"}(e)}function me(e){if(null===e)return null;const t=[];for(const n of e)n&&(n.declaredClass&&"esri.arcade.Feature"===n.declaredClass||"FeatureSetReader"===n.type)?t.push(n.geometry()):t.push(n);return t}function ge(e,t){if(!(t instanceof s))throw new Error("Invalid Argument");e.push(t.hasZ?t.hasM?[t.x,t.y,t.z,t.m]:[t.x,t.y,t.z]:[t.x,t.y])}function de(e,t){if(J(e)||P(e)){let n=!1,r=!1,o=[],a=t;if(J(e)){for(const t of e)ge(o,t);o.length>0&&(a=e[0].spatialReference,n=e[0].hasZ,r=e[0].hasM)}else if(e instanceof i)o=e._elements,o.length>0&&(n=e._hasZ,r=e._hasM,a=e.get(0).spatialReference);else{if(!P(e))throw new Error("Invalid Argument");for(const t of e.toArray())ge(o,t);o.length>0&&(a=e.get(0).spatialReference,n=!0===e.get(0).hasZ,r=!0===e.get(0).hasM)}if(0===o.length)return null;return!1===y.isClockwise(o,r,n)&&(o=o.slice(0).reverse()),new f({rings:[o],spatialReference:a,hasZ:n,hasM:r})}return e}function ye(e,t){if(J(e)||P(e)){let n=!1,r=!1,o=[],a=t;if(J(e)){for(const t of e)ge(o,t);o.length>0&&(a=e[0].spatialReference,n=!0===e[0].hasZ,r=!0===e[0].hasM)}else if(e instanceof i)o=e._elements,o.length>0&&(n=e._hasZ,r=e._hasM,a=e.get(0).spatialReference);else if(P(e)){for(const t of e.toArray())ge(o,t);o.length>0&&(a=e.get(0).spatialReference,n=!0===e.get(0).hasZ,r=!0===e.get(0).hasM)}return 0===o.length?null:new c({paths:[o],spatialReference:a,hasZ:n,hasM:r})}return e}function he(e,t){if(J(e)||P(e)){let n=!1,r=!1,o=[],a=t;if(J(e)){for(const t of e)ge(o,t);o.length>0&&(a=e[0].spatialReference,n=!0===e[0].hasZ,r=!0===e[0].hasM)}else if(e instanceof i)o=e._elements,o.length>0&&(n=e._hasZ,r=e._hasM,a=e.get(0).spatialReference);else if(P(e)){for(const t of e.toArray())ge(o,t);o.length>0&&(a=e.get(0).spatialReference,n=!0===e.get(0).hasZ,r=!0===e.get(0).hasM)}return 0===o.length?null:new l({points:o,spatialReference:a,hasZ:n,hasM:r})}return e}function pe(e,t=!1){const r=[];if(null===e)return r;if(!0===J(e)){for(let n=0;n<e.length;n++){const i=W(e[n]);""===i&&!0!==t||r.push(i)}return r}if(e instanceof n){for(let n=0;n<e.length();n++){const i=W(e.get(n));""===i&&!0!==t||r.push(i)}return r}if(F(e)){const n=W(e);return""===n&&!0!==t||r.push(n),r}return[]}let Se=0;function xe(e){return Se++,Se%100==0?(Se=0,o.create((t=>{setTimeout((()=>{t(e)}),0)}))):e}function be(e,t,n){switch(n){case"&":return e&t;case"|":return e|t;case"^":return e^t;case"<<":return e<<t;case">>":return e>>t;case">>>":return e>>>t}}function Te(e,t=null){return null==e?null:_(e)||w(e)||I(e)?e:e instanceof u?!0===(null==t?void 0:t.keepGeometryType)?e:e.toJSON():e instanceof n?e.toArray().map((e=>Te(e,t))):e instanceof Array?e.map((e=>Te(e,t))):e instanceof Date?e:null!==e&&"object"==typeof e&&void 0!==e.castAsJson?e.castAsJson(t):null}function Ne(e,t,n,r,i){return Re(e,t,n).then((e=>{i[r]=e}))}function Re(e,t=null,r=null){if(e instanceof n&&(e=e.toArray()),null==e)return o.resolve(null);if(F(e)||e instanceof u||e instanceof Date)return o.resolve(Te(e,r));if(e instanceof Array){const n=[],i=[];for(const o of e)null===o||F(o)||o instanceof u||o instanceof Date?i.push(Te(o,r)):(i.push(null),n.push(Ne(o,t,r,i.length-1,i)));return n.length>0?o.all(n).then((()=>i)):o.resolve(i)}return null!==e&&"object"==typeof e&&void 0!==e.castAsJsonAsync?e.castAsJsonAsync(t,r):o.resolve(null)}const De=Object.freeze({__proto__:null,ReturnResultE:p,ImplicitResultE:S,NativeFunctionE:x,SizzleFunctionE:b,NativeFunction:T,ImplicitResult:N,ReturnResult:R,SizzleFunction:D,voidOperation:A,breakResult:k,continueResult:M,multiReplace:C,isFunctionParameter:v,isSimpleType:F,defaultUndefined:O,isString:I,isBoolean:_,isNumber:w,isInteger:Z,isArray:J,isFeatureSet:L,isFeatureSetCollection:Y,isImmutableArray:P,isDate:E,pcCheck:j,absRound:z,generateUUID:G,formatNumber:U,formatDate:V,standardiseDateFormat:H,greaterThanLessThan:B,equalityTest:$,toString:W,toNumberArray:Q,toStringExplicit:X,toNumber:ee,toDate:te,toDateTime:ne,toBoolean:ie,fixSpatialReference:oe,fixNullGeometry:ae,getDomainValue:ue,getDomainCode:le,getDomain:se,stableStringify:ce,autoCastFeatureToGeometry:me,autoCastArrayOfPointsToPolygon:de,autoCastArrayOfPointsToPolyline:ye,autoCastArrayOfPointsToMultiPoint:he,toStringArray:pe,tick:xe,binaryOperator:be,castAsJson:Te,castAsJsonAsync:Re});e.ImplicitResult=N,e.ImplicitResultE=S,e.NativeFunction=T,e.NativeFunctionE=x,e.ReturnResult=R,e.ReturnResultE=p,e.SizzleFunction=D,e.SizzleFunctionE=b,e.absRound=z,e.autoCastArrayOfPointsToMultiPoint=he,e.autoCastArrayOfPointsToPolygon=de,e.autoCastArrayOfPointsToPolyline=ye,e.autoCastFeatureToGeometry=me,e.binaryOperator=be,e.breakResult=k,e.castAsJson=Te,e.castAsJsonAsync=Re,e.continueResult=M,e.defaultUndefined=O,e.equalityTest=$,e.fixNullGeometry=ae,e.fixSpatialReference=oe,e.formatDate=V,e.formatNumber=U,e.generateUUID=G,e.getDomain=se,e.getDomainCode=le,e.getDomainValue=ue,e.greaterThanLessThan=B,e.isArray=J,e.isBoolean=_,e.isDate=E,e.isFeatureSet=L,e.isFeatureSetCollection=Y,e.isFunctionParameter=v,e.isImmutableArray=P,e.isInteger=Z,e.isNumber=w,e.isSimpleType=F,e.isString=I,e.lc=De,e.multiReplace=C,e.pcCheck=j,e.stableStringify=ce,e.standardiseDateFormat=H,e.tick=xe,e.toBoolean=ie,e.toDate=te,e.toDateTime=ne,e.toNumber=ee,e.toNumberArray=Q,e.toString=W,e.toStringArray=pe,e.toStringExplicit=X,e.voidOperation=A}));
