/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../core/mathUtils","./mat4","./mat4f64","./vec3","./vec3f64","../geometry/Extent","../geometry/projectionEllipsoid","../geometry/SpatialReference","../geometry/support/webMercatorUtils","../views/3d/support/cameraUtilsInternal","../views/3d/support/earthUtils","../views/3d/support/mathUtils"],(function(e,t,a,n,i,r,o,s,c,l,d,h,u){"use strict";const p=r.fromValues(0,0,1),y=i.normalize(r.create(),r.fromValues(1,1,1)),f=new u.Cyclical(-180,180),g=n.create(),M=r.create(),m=r.create();function T(e,n,r,o=d.createDirectionUp()){i.cross(M,e,p),0===i.dot(M,M)&&i.cross(M,e,y),a.identity(g),a.rotate(g,g,-t.deg2rad(n),e),a.rotate(g,g,-t.deg2rad(r),M);const{up:s,direction:c}=o;return i.cross(s,M,e),i.normalize(s,s),i.transformMat4(s,s,g),i.normalize(c,e),i.negate(c,c),i.transformMat4(c,c,g),o}function R(e,t,a,n){const r=M,o=m;return i.normalize(r,e),i.cross(m,r,p),0===i.dot(m,m)&&i.cross(m,r,y),i.cross(o,m,r),d.directionToHeadingTilt(t,a,n,r,o)}function x(e,a,n,o){const s={eye:r.create(),up:null,tilt:o,heading:n},c=M;c[0]=e[0],c[1]=e[2],c[2]=-e[1];const l=a,d=t.deg2rad(n),h=t.deg2rad(o),u=Math.sin(d),p=Math.cos(d),y=Math.sin(h),f=Math.cos(h),g=i.length(c);let m;if(Math.abs(h)<1e-8)m=l+g;else{const e=g/y,a=t.asinClamped(l/e),n=Math.PI-h-a;m=e*Math.sin(n)}const T=f*l,R=l*l*(y*y),x=p*p*R,b=m-T,I=b*b,v=x*(x+I-c[1]*c[1]);if(v<0)return i.scale(s.eye,c,m/g),s.tilt=0,s;const w=Math.sqrt(v),z=c[1]*b,C=x+I;let P;if(P=p>0?-w+z:w+z,Math.abs(C)<1e-8)return g<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=l):i.scale(s.eye,c,m/g),s.tilt=0,U(s.eye),E(s,e);s.eye[1]=P/C;const D=u*u*R,H=y*l,W=p*H*s.eye[1],k=s.eye[1]*s.eye[1],q=1-k,A=Math.sqrt(q),_=x*k+D-2*W*A*b+q*I;return Math.abs(_)<1e-8?(i.scale(s.eye,c,m/g),s.tilt=0,U(s.eye),E(s,e)):(s.eye[0]=(q*(m*c[0]-T*c[0])-H*A*(c[0]*s.eye[1]*p+c[2]*u))/_,s.eye[2]=(q*(m*c[2]-T*c[2])-H*A*(c[2]*s.eye[1]*p-c[0]*u))/_,i.scale(s.eye,s.eye,m),U(s.eye),E(s,e))}function U(e){const t=e[1];e[1]=-e[2],e[2]=t}function E(e,t){const a=T(t,e.heading,e.tilt);return e.up=a.up,e}function b(e,a,n){const r=i.length(a),o=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),s=t.asinClamped(n/(o/Math.sin(e)));return t.rad2deg(e-s)}function I(e,a,n){const r=t.deg2rad(e),o=i.length(a);return t.asinClamped(n/(o/Math.sin(r)))+r}function v(e,a,n,i,r){let d,p,y,g;const M=a.latitude,m=a.longitude,T=h.getLonDeltaForDistance(M,n,s.getReferenceEllipsoid(e.spatialReference).radius)/2;d=m-T,p=m+T;const R=t.deg2rad(M),x=s.getReferenceEllipsoid(e.spatialReference).radius,U=(1+Math.sin(R))/(1-Math.sin(R)),E=(U+1)*Math.tan(i/x/2),b=E*E;function I(e){const t=Math.PI/2;return(e=u.cyclical2PI.normalize(e,-t))>t&&(e=Math.PI-e),e}if(y=1.5*Math.PI-2*Math.atan(.5*(E+Math.sqrt(4*U+b))),g=y+i/x,y=I(y),g=I(g),g<y){const e=g;g=y,y=e}if(y=Math.max(t.rad2deg(y),-90),g=Math.min(t.rad2deg(g),90),p=f.monotonic(d,p),p-d>180){const e=(p-d-180)/2;d+=e,p-=e}const v=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:c.WGS84;return r?(r.xmin=d,r.ymin=y,r.xmax=p,r.ymax=g,r.spatialReference=v):r=new o(d,y,p,g,v),e.spatialReference&&e.spatialReference.isWebMercator&&l.geographicToWebMercator(r,!1,r),r}var w=Object.freeze({__proto__:null,headingTiltToDirectionUp:T,directionToHeadingTilt:R,eyeForCenterWithHeadingTilt:x,lookAtTiltToEyeTilt:b,eyeTiltToLookAtTilt:I,toExtent:v});e.cameraUtilsSpherical=w,e.directionToHeadingTilt=R,e.eyeForCenterWithHeadingTilt=x,e.eyeTiltToLookAtTilt=I,e.headingTiltToDirectionUp=T,e.lookAtTiltToEyeTilt=b,e.toExtent=v}));
