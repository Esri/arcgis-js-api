/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../request","../renderers/support/jsonUtils","../chunks/DataLayerSource","./support/StatisticDefinition","./support/Query","./Task","./QueryTask"],(function(e,t,s,r,n,o,i,a,l,u,c,p,d,f,h,y,_,g){"use strict";let k=function(t){function s(e){var s;return(s=t.call(this,e)||this)._field=null,s.checkValueRange=null,s.gdbVersion=null,s.source=null,s}e._inheritsLoose(s,t);var r=s.prototype;return r.execute=function(e,t){const{classificationDefinition:s}=e,r={...e.toJSON(),f:"json"};if("esri.tasks.support.ClassBreaksDefinition"===s.declaredClass?this._field=s.classificationField:this._field=s.attributeField,this.source){var n;const e={source:null==(n=this.source)?void 0:n.toJSON()};r.layer=JSON.stringify(e)}this.gdbVersion&&(r.gdbVersion=this.gdbVersion),r.classificationDef&&(r.classificationDef=JSON.stringify(r.classificationDef));let o={query:r};return(this.requestOptions||t)&&(o={...this.requestOptions,...t,...o}),p(this.parsedUrl.path,o).then((e=>this._handleExecuteResponse(e)))},r._handleExecuteResponse=function(e){const t=e&&e.data;if(!t)return;if(!this.checkValueRange){const e=this._processRendererJSON(t);return c.resolve(e)}const s=new g({url:this.url}),r=new h({statisticType:"min",onStatisticField:this._field}),n=new h({statisticType:"max",onStatisticField:this._field}),o=new y({outStatistics:[r,n]});return s.execute(o).then((e=>{const s=e.features[0].attributes;let r=null,n=null;for(const e in s)0===e.toLowerCase().indexOf("min")?r=s[e]:n=s[e];return this._processRendererJSON(t,r,n)}))},r._processRendererJSON=function(e,t,s){if("classBreaks"===e.type){const r=d.fromJSON(e);return{classBreaks:r.classBreakInfos.map(((e,n)=>(0===n&&null!=t&&(e.minValue=t),n===r.classBreakInfos.length-1&&null!=s&&(e.maxValue=s),{minValue:e.minValue,maxValue:e.maxValue,label:e.label}))),normalizationTotal:r.normalizationTotal}}return{uniqueValues:e.uniqueValueInfos.map(((r,n)=>(0===n&&null!=t&&(r.value=t),n===e.uniqueValueInfos.length-1&&null!=s&&(r.value=s),{count:r.count,value:r.value,label:r.label})))}},e._createClass(s,[{key:"parsedUrl",get:function(){const e=this._parseUrl(this.url);return e.path+="/generateRenderer",e}}]),s}(_);return t.__decorate([o.property()],k.prototype,"checkValueRange",void 0),t.__decorate([o.property()],k.prototype,"gdbVersion",void 0),t.__decorate([o.property({type:f.DataLayerSource})],k.prototype,"source",void 0),t.__decorate([o.property({readOnly:!0,dependsOn:["url"]})],k.prototype,"parsedUrl",null),k=t.__decorate([i.subclass("esri.tasks.GenerateRendererTask")],k),k}));
