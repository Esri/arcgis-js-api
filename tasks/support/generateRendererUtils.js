// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","dojo/number"],function(a,e,r){function n(a){for(var e=o(a),r=[],n=e.uniqueValues.length,u=0;u<n;u++){var l=e.uniqueValues[u],t=e.valueFrequency[u],i=l.toString();r.push({value:l,count:t,label:i})}return{uniqueValues:r}}function u(a){var e=a.normalizationTotal;return{classBreaks:l(a),normalizationTotal:e}}function l(a){var e=a.definition,n=e.classificationMethod,u=e.breakCount,l=e.normalizationType,s=[],f=a.values;if(0===f.length)return[];f=f.sort(function(a,e){return a-e});var m=f[0],b=f[f.length-1];if("equal-interval"===n)if(f.length>=u){for(var V=(b-m)/u,p=m,d=1;d<u;d++){var g=r.round(m+d*V,6);s.push({minValue:p,maxValue:g,label:t(p,g,l)}),p=g}s.push({minValue:p,maxValue:b,label:t(p,b,l)})}else f.forEach(function(a){s.push({minValue:a,maxValue:a,label:t(a,a,l)})});else if("natural-breaks"===n){for(var M=o(f),q=i(M.uniqueValues,M.valueFrequency,u),p=m,d=1;d<u;d++)if(M.uniqueValues.length>d){var g=r.round(M.uniqueValues[q[d]],6);s.push({minValue:p,maxValue:g,label:t(p,g,l)}),p=g}s.push({minValue:p,maxValue:b,label:t(p,b,l)})}else if("quantile"===n)if(f.length>=u&&m!==b){for(var p=m,x=Math.ceil(f.length/u),S=0,d=1;d<u;d++){var k=x+S-1;k>f.length&&(k=f.length-1),k<0&&(k=0),s.push({minValue:p,maxValue:f[k],label:t(p,f[k],l)}),p=f[k],S+=x,x=Math.ceil((f.length-S)/(u-d))}s.push({minValue:p,maxValue:b,label:t(p,b,l)})}else for(var p=-1,d=0;d<f.length;d++){var g=f[d];g!==p&&(p=g,s.push({minValue:p,maxValue:g,label:t(p,g,l)}),p=g)}else if("standard-deviation"===n){var y=h(f),z=c(f,y);if(0===z)s.push({minValue:f[0],maxValue:f[0],label:t(f[0],f[0],l)});else{for(var V=v(m,b,u,y,z),B=V*z,E=0,p=m,d=u;d>=1;d--){var F=r.round(y-(d-.5)*B,6);s.push({minValue:p,maxValue:F,label:t(p,F,l)}),p=F,E++}var g=r.round(y+.5*B,6);s.push({minValue:p,maxValue:g,label:t(p,g,l)}),p=g,E++;for(var d=1;d<=u;d++)g=E===2*u?b:r.round(y+(d+.5)*B,6),s.push({minValue:p,maxValue:g,label:t(p,g,l)}),p=g,E++}}return s}function t(a,e,r){return a===e?r&&"percent-of-total"===r?a+"%":a.toString():r&&"percent-of-total"===r?a+"% - "+e+"%":a+" - "+e}function o(a){for(var e=[],r=[],n=Number.MIN_VALUE,u=1,l=-1,t=0;t<a.length;t++){var o=a[t];o===n?(u++,r[l]=u):null!==o&&(e.push(o),n=o,u=1,r.push(u),l++)}return{uniqueValues:e,valueFrequency:r}}function i(a,e,r){var n=a.length,u=[];r>n&&(r=n);for(var l=0;l<r;l++)u.push(Math.round(l*n/r-1));u.push(n-1);var t=s(u,a,e,r);return f(t.mean,t.sdcm,u,a,e,r)&&(t=s(u,a,e,r)),u}function s(a,e,r,n){for(var u=[],l=[],t=[],o=0,i=[],s=[],f=0;f<n;f++){var v=m(f,a,e,r);i.push(v.sbMean),s.push(v.sbSdcm),o+=s[f]}for(var h,c=o,b=!0;b||o<c;){b=!1,u=[];for(var f=0;f<n;f++)u.push(a[f]);for(var f=0;f<n;f++)for(var V=a[f]+1;V<=a[f+1];V++)if(h=e[V],f>0&&V!==a[f+1]&&Math.abs(h-i[f])>Math.abs(h-i[f-1]))a[f]=V;else if(f<n-1&&a[f]!==V-1&&Math.abs(h-i[f])>Math.abs(h-i[f+1])){a[f+1]=V-1;break}c=o,o=0,l=[],t=[];for(var f=0;f<n;f++){l.push(i[f]),t.push(s[f]);var v=m(f,a,e,r);i[f]=v.sbMean,s[f]=v.sbSdcm,o+=s[f]}}if(o>c){for(var f=0;f<n;f++)a[f]=u[f],i[f]=l[f],s[f]=t[f];o=c}return{mean:i,sdcm:s}}function f(a,e,r,n,u,l){for(var t=0,o=0,i=0,s=0,f=!0,v=0;v<2&&f;v++){0===v&&(f=!1);for(var h=0;h<l-1;h++)for(;r[h+1]+1!==r[h+2];){r[h+1]=r[h+1]+1;var c=m(h,r,n,u);i=c.sbMean,t=c.sbSdcm;var b=m(h+1,r,n,u);if(s=b.sbMean,o=b.sbSdcm,!(t+o<e[h]+e[h+1])){r[h+1]=r[h+1]-1;break}e[h]=t,e[h+1]=o,a[h]=i,a[h+1]=s,f=!0}for(var h=l-1;h>0;h--)for(;r[h]!==r[h-1]+1;){r[h]=r[h]-1;var c=m(h-1,r,n,u);i=c.sbMean,t=c.sbSdcm;var b=m(h,r,n,u);if(s=b.sbMean,o=b.sbSdcm,!(t+o<e[h-1]+e[h])){r[h]=r[h]+1;break}e[h-1]=t,e[h]=o,a[h-1]=i,a[h]=s,f=!0}}return f}function v(a,e,r,n,u){var l=Math.max(n-a,e-n),t=l/u,o=t/r;return o=o>=1?1:o>=.5?.5:.25}function h(a){for(var e=0,r=0;r<a.length;r++)e+=a[r];return e/=a.length}function c(a,e){for(var r=0,n=0;n<a.length;n++){var u=a[n];r+=(u-e)*(u-e)}return r/=a.length,Math.sqrt(r)}function m(a,e,r,n){for(var u=0,l=0,t=e[a]+1;t<=e[a+1];t++){var o=n[t];u+=r[t]*o,l+=o}l<=0&&console.log("Exception in Natural Breaks calculation");for(var i=u/l,s=0,t=e[a]+1;t<=e[a+1];t++)s+=n[t]*Math.pow(r[t]-i,2);return{sbMean:i,sbSdcm:s}}Object.defineProperty(e,"__esModule",{value:!0}),e.createGenerateRendererUniqueValues=n,e.createGenerateRendererClassBreaks=u});