// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["dojo/Deferred","../request","../core/lang","../core/urlUtils","../geometry/support/normalizeUtils","../geometry/SpatialReference","../layers/MapImageLayer","../layers/support/MapImage","./Task","./support/DataFile","./support/Date","./support/FeatureSet","./support/GPMessage","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],function(e,t,s,r,a,n,i,o,u,l,p,h,c,d,f,m,g){return u.createSubclass({declaredClass:"esri.tasks.Geoprocessor",constructor:function(){this._updateTimers=[],this._handleExecuteResponse=this._handleExecuteResponse.bind(this),this._handleGetResultImageResponse=this._handleGetResultImageResponse.bind(this),this._handleGetResultDataResponse=this._handleGetResultDataResponse.bind(this)},properties:{outSpatialReference:{value:null,type:n},processSpatialReference:{value:null,type:n},updateDelay:{value:1e3,type:Number},url:{}},cancelJob:function(e,r){var a={query:s.mixin({},this.parsedUrl.query,{f:"json"})};return(this.requestOptions||r)&&(a=s.mixin({},this.requestOptions,r,a)),t(this.parsedUrl.path+"/jobs/"+e+"/cancel",a).then(function(e){return e.data})},cancelJobStatusUpdates:function(e){clearTimeout(this._updateTimers[e]),this._updateTimers[e]=null},checkJobStatus:function(e,r){var a={query:s.mixin({},this.parsedUrl.query,{f:"json"})};return(this.requestOptions||r)&&(a=s.mixin({},this.requestOptions,r,a)),t(this.parsedUrl.path+"/jobs/"+e,a).then(this._handleCheckJobStatusResponse)},getResultImage:function(e,r,a,n){var i=this._gpEncode(s.mixin({},this.parsedUrl.query,{f:"json"},a.toJSON())),o={query:i};return(this.requestOptions||n)&&(o=s.mixin({},this.requestOptions,n,o)),t(this.parsedUrl.path+"/jobs/"+e+"/results/"+r,o).then(this._handleGetResultImageResponse)},getResultData:function(e,r,a){var n={query:s.mixin({},this.parsedUrl.query,{f:"json",returnType:"data"})};return(this.requestOptions||a)&&(n=s.mixin({},this.requestOptions,a,n)),t(this.parsedUrl.path+"/jobs/"+e+"/results/"+r,n).then(this._handleGetResultDataResponse)},getResultMapImageLayer:function(e){var t,s,a=this.parsedUrl;return s=a.path.indexOf("/GPServer/"),t=a.path.substring(0,s)+"/MapServer/jobs/"+e,a.query&&(t+="?"+r.objectToQuery(a.query)),new i(t)},execute:function(e,r){var n={},i={},o=[];return this._collectGeometries(e,o,n),a.normalizeCentralMeridian(o).then(function(a){for(var o in n){var u=this.outSpatialReference,l=n[o];i[o]=a.slice(l[0],l[1])}var p=this._gpEncode(s.mixin({},this.parsedUrl.query,{f:"json","env:outSR":u?u.wkid||JSON.stringify(u.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},e),null,i),h={query:p};return(this.requestOptions||r)&&(h=s.mixin({},this.requestOptions,r,h)),t(this.parsedUrl.path+"/execute",h)}.bind(this)).then(this._handleExecuteResponse)},submitJob:function(r,n){var i={},o={},u=[],l=new e;return this._collectGeometries(r,u,i),a.normalizeCentralMeridian(u).then(function(e){for(var a in i){var u=this.outSpatialReference,l=i[a];o[a]=e.slice(l[0],l[1])}var p=this._gpEncode(s.mixin({},this.parsedUrl.query,{f:"json","env:outSR":u?u.wkid||JSON.stringify(u.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},r),null,o),h={query:p};return(this.requestOptions||n)&&(h=s.mixin({},this.requestOptions,n,h)),t(this.parsedUrl.path+"/submitJob",h)}.bind(this)).then(function(e){l.origJobId=e.data.jobId,this._jobUpdateHandler(e.data,l)}.bind(this)).then(null,function(e){l.reject(e)}),l.promise},_collectGeometries:function(e,t,s){for(var r in e){var a=e[r];if("object"==typeof a&&null!=a){var n;if(Array.isArray(a)&&a.length)n=a[0]&&a[0].declaredClass,n&&n.indexOf("Graphic")>-1?(s[r]=[t.length,t.length+a.length],a.forEach(function(e){t.push(e.geometry)})):n&&n.indexOf("esri.geometry.")>-1&&(s[r]=[t.length,t.length+a.length],a.forEach(function(e){t.push(e)}));else if((n=a.declaredClass)&&n.indexOf("FeatureSet")>-1){var i=a.features;s[r]=[t.length,t.length+i.length],i.forEach(function(e){t.push(e.geometry)})}}}},_gpEncode:function(e,t,s){var r;for(r in e){var a=e[r];Array.isArray(a)?e[r]=JSON.stringify(a.map(function(e){return this._gpEncode({item:e},!0).item},this)):a instanceof Date&&(e[r]=a.getTime())}return this._encode(e,t,s)},_decode:function(e){var t,s=e.dataType,r=m.fromJSON(e);if(-1!==["GPBoolean","GPDouble","GPLong","GPString"].indexOf(s))return r;if("GPLinearUnit"===s)r.value=f.fromJSON(r.value);else if("GPFeatureRecordSetLayer"===s||"GPRecordSet"===s)r.value=h.fromJSON(r.value);else if("GPDataFile"===s)r.value=l.fromJSON(r.value);else if("GPDate"===s)t=r.value,r.value="string"==typeof t?p.fromJSON({date:t}):Date.fromJSON(t);else if("GPRasterData"===s||"GPRasterDataLayer"===s){var a=e.value.mapImage;r.value=a?o.fromJSON(a):g.fromJSON(r.value)}else if(-1!==s.indexOf("GPMultiValue:")){var n=s.split(":")[1];t=r.value,r.value=t.map(function(e){return this._decode({paramName:"_name",dataType:n,value:e}).value},this)}else console.log(this.declaredClass+" : GP Data type not handled. : "+r.dataType),r=null;return r},_jobUpdateHandler:function(e,t){var r,a,n=t.origJobId||e.jobId,i=d.fromJSON(e);switch(clearTimeout(this._updateTimers[n]),this._updateTimers[n]=null,t.progress(i),i.jobStatus){case"job-submitted":case"job-executing":case"job-waiting":case"job-new":r=this._getJobStatus.bind(this),a=this._jobUpdateHandler.bind(this),this._updateTimers[n]=setTimeout(function(){r(n).then(function(e){a(e,t)})},this.updateDelay);break;default:t.resolve(s.mixin(i,{jobId:t.origJobId||n}))}},_getJobStatus:function(e){return t(this.parsedUrl.path+"/jobs/"+e,{query:s.mixin({},this.parsedUrl.query,{f:"json"})}).then(function(e){return e.data})},_handleGetResultDataResponse:function(e){return this._decode(e.data)},_handleCheckJobStatusResponse:function(e){return d.fromJSON(e.data)},_handleExecuteResponse:function(e){var t=e.data,s=t.results||[],r=t.messages||[];return{results:s.map(this._decode,this),messages:r.map(c.fromJSON)}},_handleGetResultImageResponse:function(e){return this._decode(e.data)}})});