/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/compilerUtils","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../geometry/SpatialReference","../geometry/Extent","../request","../geometry/support/normalizeUtils","../layers/support/Field","./support/FeatureSet","./Task","./support/GPMessage","../layers/support/MapImage","./support/DataFile","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],(function(e,t,r,a,o,s,n,u,c,i,l,p,d,f,h,m,b,v,S,_,y,g,G,P,O,J,R){"use strict";function j(e){return Object.freeze({__proto__:null,default:e})}let M=function(r){function a(e){var t;return(t=r.call(this,e)||this)._timers=new Map,t.outSpatialReference=null,t.processExtent=null,t.processSpatialReference=null,t.returnFeatureCollection=!1,t.returnM=!1,t.returnZ=!1,t}t._inheritsLoose(a,r);var s=a.prototype;return s.destroy=function(){this._timers.forEach((e=>{clearInterval(e)}))},s.cancelJob=function(e,t){const{path:r}=this.parsedUrl,a={...this.requestOptions,...t,query:{f:"json"}};this._clearTimer(e);return m(`${r}/jobs/${e}/cancel`,a).then((e=>P.fromJSON(e.data)))},s.checkJobStatus=function(e,t){const{path:r}=this.parsedUrl,a={...this.requestOptions,...t,query:{f:"json"}};return m(`${r}/jobs/${e}`,a).then((e=>P.fromJSON(e.data)))},s.execute=function(e,t){return this._constructRequest("execute",e,t).then((e=>{const t=e.data.results||[],r=e.data.messages||[];return{results:t.map(this._decode),messages:r.map((e=>y.fromJSON(e)))}}))},s.getResultData=function(e,t,r){const{returnFeatureCollection:a,returnM:o,returnZ:s,outSpatialReference:n,parsedUrl:u}=this,{path:c}=u,i={returnFeatureCollection:a||void 0,returnM:o||void 0,returnZ:s||void 0,outSR:n,returnType:"data",f:"json"},l=this._gpEncode(i,null),p={...this.requestOptions,...r,query:l};return m(`${c}/jobs/${e}/results/${t}`,p).then((e=>this._decode(e.data)))},s.getResultImage=function(e,t,r,a){const{path:o}=this.parsedUrl,s={...r.toJSON(),f:"json"},n=this._gpEncode(s),u={...this.requestOptions,...a,query:n};return m(`${o}/jobs/${e}/results/${t}`,u).then((e=>this._decode(e.data)))},s.getResultMapImageLayer=async function(t){const{path:r}=this.parsedUrl,a=r.indexOf("/GPServer/"),o=`${r.substring(0,a)}/MapServer/jobs/${t}`;return new(0,(await new Promise((function(t,r){e(["../layers/MapImageLayer"],(function(e){t(j(e))}),r)}))).default)({url:o})},s.submitJob=function(e,t){return this._constructRequest("submitJob",e,t).then((e=>P.fromJSON(e.data)))},s.waitForJobCompletion=function(e,t={}){const{interval:r=1e3,signal:a,statusCallback:s}=t;return d.create(((t,n)=>{d.onAbort(a,(()=>{this._clearTimer(e),n(d.createAbortError())})),this._clearTimer(e);const u=setInterval((()=>{this._timers.has(e)||n(d.createAbortError()),this._getJobStatus(e,this.requestOptions).then((r=>{const{jobStatus:a}=r;switch(a){case"job-succeeded":this._clearTimer(e),t(r);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":s&&s(r);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(e),n(r);break;default:o.neverReached(a)}}))}),r);this._timers.set(e,u)}))},s._clearTimer=function(e){this._timers.has(e)&&(clearInterval(this._timers.get(e)),this._timers.delete(e))},s._constructRequest=function(e,t,r){const a={},o={},s=[];return this._collectGeometries(t,s,a),b.normalizeCentralMeridian(s).then((s=>{const{outSpatialReference:n,parsedUrl:u,processExtent:c,processSpatialReference:i,returnFeatureCollection:l,returnM:p,returnZ:d}=this,{path:f}=u;for(const e in a){const t=a[e];o[e]=s.slice(t[0],t[1])}const h=n?n.wkid||n:null,b=i?i.wkid||i:null,v="execute"===e?{returnFeatureCollection:l||void 0,returnM:p||void 0,returnZ:d||void 0}:null,S={...c?{context:{extent:c,outSR:h,processSR:b}}:{"env:outSR":h,"env:processSR":b},...t,...v,f:"json"},_=this._gpEncode(S,null,o),y={...this.requestOptions,...r,query:_};return m(`${f}/${e}`,y)}))},s._collectGeometries=function(e,t,r){for(const a in e){const o=e[a];if(o&&"object"==typeof o&&o instanceof S){const{features:e}=o;r[a]=[t.length,t.length+e.length],e.forEach((e=>{t.push(e.geometry)}))}}},s._decode=function(e){const t=e.dataType,r=J.fromJSON(e);switch(t){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":return r;case"GPDate":r.value=new Date(r.value);break;case"GPDataFile":r.value=G.fromJSON(r.value);break;case"GPLinearUnit":r.value=O.fromJSON(r.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":{const t=e.value.url;r.value=t?G.fromJSON(r.value):S.fromJSON(r.value);break}case"GPRasterData":case"GPRasterDataLayer":{const t=e.value.mapImage;r.value=t?g.fromJSON(t):R.fromJSON(r.value);break}case"GPField":r.value=v.fromJSON(r.value);break;case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return r;case"GPMultiValue:GPDate":{const e=r.value;r.value=e.map((e=>new Date(e)));break}case"GPMultiValue:GPDataFile":r.value=r.value.map((e=>G.fromJSON(e)));break;case"GPMultiValue:GPLinearUnit":r.value=r.value.map((e=>O.fromJSON(e)));break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":r.value=r.value.map((e=>S.fromJSON(e)));break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":r.value=r.value.map((e=>e?g.fromJSON(e):R.fromJSON(r.value)));break;case"GPMultiValue:GPField":r.value=r.value.map((e=>v.fromJSON(e)))}return r},s._gpEncode=function(e,t,r){for(const t in e){const r=e[t];Array.isArray(r)?e[t]=JSON.stringify(r.map((e=>this._gpEncode({item:e},!0).item),this)):r instanceof Date&&(e[t]=r.getTime())}return this._encode(e,t,r)},s._getJobStatus=function(e,t){const{path:r}=this.parsedUrl,a=`${r}/jobs/${e}`,o={...this.requestOptions,...t,query:{f:"json"}};return m(a,o).then((e=>P.fromJSON(e.data)))},a}(_);return r.__decorate([u.property({type:f})],M.prototype,"outSpatialReference",void 0),r.__decorate([u.property({type:h})],M.prototype,"processExtent",void 0),r.__decorate([u.property({type:f})],M.prototype,"processSpatialReference",void 0),r.__decorate([u.property({nonNullable:!0})],M.prototype,"returnFeatureCollection",void 0),r.__decorate([u.property({nonNullable:!0})],M.prototype,"returnM",void 0),r.__decorate([u.property({nonNullable:!0})],M.prototype,"returnZ",void 0),M=r.__decorate([c.subclass("esri/tasks/Geoprocessor")],M),M}));
