/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../request","../geometry/support/normalizeUtils","./Task","../core/queryUtils","./mixins/NAServiceDescription","./support/RouteResultsContainer"],(function(e,r,t,s,o,i,a,n,u,l,c,p,m,f,h,y,d){"use strict";const g=h.createQueryParamsHelper({accumulateAttributes:{name:"accumulateAttributeNames"},attributeParameterValues:!0,directionsTimeAttribute:{name:"directionsTimeAttributeName"},impedanceAttribute:{name:"impedanceAttributeName"},outSpatialReference:{name:"outSR",getter:e=>e.outSpatialReference.wkid},pointBarriers:{name:"barriers"},polylineBarriers:!0,polygonBarriers:!0,restrictionAttributes:{name:"restrictionAttributeNames"},stops:!0,travelMode:!0});let B=function(r){function t(e){return r.call(this,e)||this}e._inheritsLoose(t,r);var s=t.prototype;return s.solve=function(e,r){const t=[],s=[],o={},i={};return e.stops&&e.stops.features&&this._collectGeometries(e.stops.features,s,"stops.features",o),e.pointBarriers&&e.pointBarriers.features&&this._collectGeometries(e.pointBarriers.features,s,"pointBarriers.features",o),e.polylineBarriers&&e.polylineBarriers.features&&this._collectGeometries(e.polylineBarriers.features,s,"polylineBarriers.features",o),e.polygonBarriers&&e.polygonBarriers.features&&this._collectGeometries(e.polygonBarriers.features,s,"polygonBarriers.features",o),m.normalizeCentralMeridian(s).then((e=>{for(const r in o){const s=o[r];t.push(r),i[r]=e.slice(s[0],s[1])}return this._isInputGeometryZAware(i,t)?this.getServiceDescription():c.resolve({dontCheck:!0})})).then((s=>{("dontCheck"in s?s.dontCheck:s.hasZ)||this._dropZValuesOffInputGeometry(i,t);for(const r in i)i[r].forEach(((t,s)=>{e.get(r)[s].geometry=t}));let o={query:{...this.parsedUrl.query,f:"json",...g.toQueryParams(e)}};(this.requestOptions||r)&&(o={...this.requestOptions,...r,...o});const{path:a}=this.parsedUrl,n="/solve",u=a.endsWith(n)?a:a+n;return p(u,o)})).then((e=>this._handleSolveResponse(e)))},s._collectGeometries=function(e,r,t,s){s[t]=[r.length,r.length+e.length],e.forEach((e=>{r.push(e.geometry)}))},s._handleSolveResponse=function(e){const r=[],t=[],{directions:s=[],routes:{features:o=[],spatialReference:i=null}={},stops:{features:a=[],spatialReference:n=null}={},barriers:u,polygonBarriers:l,polylineBarriers:c,messages:p}=e.data,m="esri.tasks.RouteTask.NULL_ROUTE_NAME";let f,h,y=!0;const g=o&&i||a&&n||u&&u.spatialReference||l&&l.spatialReference||c&&c.spatialReference;s.forEach((e=>{r.push(f=e.routeName),t[f]={directions:e}})),o.forEach((e=>{-1===r.indexOf(f=e.attributes.Name)&&(r.push(f),t[f]={}),e.geometry&&(e.geometry.spatialReference=g),t[f].route=e})),a.forEach((e=>{h=e.attributes,-1===r.indexOf(f=h.RouteName||m)&&(r.push(f),t[f]={}),f!==m&&(y=!1),e.geometry&&(e.geometry.spatialReference=g),null==t[f].stops&&(t[f].stops=[]),t[f].stops.push(e)})),a.length>0&&!0===y&&(t[r[0]].stops=t[m].stops,delete t[m],r.splice(r.indexOf(m),1));const B=r.map((e=>(t[e].routeName=e===m?null:e,t[e])));return d.fromJSON({routeResults:B,pointBarriers:u,polygonBarriers:l,polylineBarriers:c,messages:p})},t}(y.NAServiceDescriptionMixin(f));return B=r.__decorate([a.subclass("esri.tasks.RouteTask")],B),B}));
