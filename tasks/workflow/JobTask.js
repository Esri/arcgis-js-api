// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/Deferred","../../request","../../geometry/Polygon","../../geometry/Multipoint","./WMBaseTask","./support/Enum","./support/JSONUtil","./support/Util"],function(e,t,r,n,s,a,o,i,d){var u=new o,l=new i,h=new d,p=a.createSubclass({declaredClass:"esri.tasks.workflow.JobTask",properties:{url:{}},getJobIds:function(t){var n=this.parsedUrl.path+"/jobs",s=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),a=this._generateOptions(s,t);return r(n,a).then(function(e){return e.data.jobIds})},getJob:function(t,a){var o=this.parsedUrl.path+"/jobs/"+t,i=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),d=this._generateOptions(i,a);return r(o,d).then(function(e){var t=e.data;return t&&0==Object.keys(t).length?null:(t.assignedType=u.jobAssignmentTypeJsonDict.fromJSON(t.assignedType),t.stage=u.jobStageJsonDict.fromJSON(t.stage),t.relationshipType&&(t.relationshipType=u.tableRelationshipTypeJsonDict.fromJSON(t.relationshipType)),null!=t.createdDate&&(t.createdDate=new Date(t.createdDate)),null!=t.startDate&&(t.startDate=new Date(t.startDate)),null!=t.startedDate&&(t.startedDate=new Date(t.startedDate)),null!=t.dueDate&&(t.dueDate=new Date(t.dueDate)),null!=t.endDate&&(t.endDate=new Date(t.endDate)),t.aoi||t.poi?t.loi=t.aoi?new n(t.aoi):new s(t.poi):t.loi=null,delete t.aoi,delete t.poi,t)})},searchJobs:function(e,t){var r={text:e.text,user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/search",t)},queryJobs:function(e,t){var r={id:e.queryId,user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/query",t)},queryJobsAdHoc:function(e,t){var r=l._jobQueryParametersToJSON(e);return r.user=e.user,this._sendRequest(r,"/jobs/query",t)},createJobs:function(t,n){var s=this.parsedUrl.path+"/jobs/create",a=l._jobCreationParametersToJSON(t);a.user=t.user;var o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.jobIds})},assignJobs:function(e,t){var r={jobs:h._convertIdsToString(e.jobIds),assignedType:u.jobAssignmentTypeJsonDict.toJSON(e.assignedType),assignedTo:h._formatDomainUsername(e.assignedTo),user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/assign",t)},unassignJobs:function(e,t){var r={jobs:h._convertIdsToString(e.jobIds),user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/unassign",t)},closeJobs:function(e,t){var r={jobs:h._convertIdsToString(e.jobIds),user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/close",t)},reopenClosedJobs:function(e,t){var r={jobs:h._convertIdsToString(e.jobIds),user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/reopen",t)},deleteJobs:function(e,t){e.deleteHistory=e.deleteHistory?e.deleteHistory:!1;var r={jobs:h._convertIdsToString(e.jobIds),deleteHistory:e.deleteHistory,user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/delete",t)},updateJob:function(e,t){var r=l._jobUpdateParametersToJSON(e);return r.user=h._formatDomainUsername(e.user),this._sendRequest(r,"/jobs/"+e.jobId+"/update",t)},createJobVersion:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/createVersion",a={name:t.name,parent:t.parent,user:h._formatDomainUsername(t.user),f:"json"},o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.versionName})},getNotes:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t+"/notes",a=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),o=this._generateOptions(a,n);return r(s,o).then(function(e){return e.data.notes})},updateNotes:function(e,t){var r={notes:e.notes,user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/"+e.jobId+"/notes/update",t)},getAttachments:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t+"/attachments",a=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),o=this._generateOptions(a,n);return r(s,o).then(function(e){for(var t=e.data.attachments,r=0;r<t.length;r++)t[r].storageType=u.jobAttachmentTypeJsonDict.fromJSON(t[r].storageType);return t})},addLinkedAttachment:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/attachments/add",a={storageType:u.jobAttachmentTypeJsonDict.toJSON(t.attachmentType),filePath:t.path,user:h._formatDomainUsername(t.user),f:"json"},o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.attachmentId})},addEmbeddedAttachment:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/attachments/add",a={storageType:2,form:t.form,user:h._formatDomainUsername(t.user),f:"json"},o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data})},deleteAttachment:function(e,t){var r={user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/"+e.jobId+"/attachments/"+e.attachmentId+"/delete",t)},getAttachmentContentUrl:function(e){var t=this.parsedUrl.path+"/jobs/"+e.jobId+"/attachments/"+e.attachmentId+"/content?f=file";if(t+="&_ts="+Date.now(),this.requestOptions&&this.requestOptions.query){var r=this.requestOptions.query,n=Object.keys(r).map(function(e){return e+"="+r[e]}).join("&");n&&(t+="&"+n)}return t},getHolds:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t+"/holds",a=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),o=this._generateOptions(a,n);return r(s,o).then(function(e){for(var t=e.data.holds,r=0;r<t.length;r++)t[r].holdDate=h._convertToDate(t[r].holdDate),t[r].releaseDate=h._convertToDate(t[r].releaseDate);return t})},createHold:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/holds/create",a={type:t.holdTypeId,user:h._formatDomainUsername(t.user),f:"json"};t.comments&&(a.comments=t.comments);var o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.holdId})},releaseHold:function(e,t){var r={user:h._formatDomainUsername(e.user)};return e.comments&&(r.comments=e.comments),this._sendRequest(r,"/jobs/"+e.jobId+"/holds/"+e.holdId+"/release",t)},getDependencies:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t+"/dependencies",a=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),o=this._generateOptions(a,n);return r(s,o).then(function(e){for(var t=e.data.dependencies,r=0;r<t.length;r++)t[r].heldOnType=u.jobDependencyTypeJsonDict.fromJSON(t[r].heldOnType),t[r].depOnType=u.jobDependencyTypeJsonDict.fromJSON(t[r].depOnType);return t})},createDependency:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/dependencies/create",a=l._jobDependencyParametersToJSON(t);a.user=t.user;var o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.dependencyId})},deleteDependency:function(e,t){var r={user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/"+e.jobId+"/dependencies/"+e.dependencyId+"/delete",t)},getActivityLog:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t+"/activity",a=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),o=this._generateOptions(a,n);return r(s,o).then(function(e){for(var t=e.data.activity,r=0;r<t.length;r++)t[r].date=h._convertToDate(t[r].date);return t})},logAction:function(e,t){var r={type:e.activityTypeId,user:h._formatDomainUsername(e.user)};return e.comments&&(r.comments=e.comments),this._sendRequest(r,"/jobs/"+e.jobId+"/activity/logAction",t)},getExtendedProperties:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t+"/extendedProperties",a=this._encode(e.mixin({},this.parsedUrl.query,{f:"json"})),o=this._generateOptions(a,n);return r(s,o).then(function(e){for(var t=e.data.containers,r=0;r<t.length;r++){var n=t[r];n.relationshipType=u.tableRelationshipTypeJsonDict.fromJSON(n.relationshipType);for(var s=n.records,a=0;a<s.length;a++)for(var o=s[a].recordValues,i=0;i<o.length;i++)o[i].dataType=u.fieldTypeJsonDict.fromJSON(o[i].dataType),o[i].displayType=u.extendedPropertyDisplayTypeJsonDict.fromJSON(o[i].displayType)}return t})},addLinkedRecord:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/extendedProperties"+t.tableName+"/add",a={user:h._formatDomainUsername(t.user),f:"json"},o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.recordId})},deleteLinkedRecord:function(e,t){var r={user:h._formatDomainUsername(e.user)};return this._sendRequest(r,"/jobs/"+e.jobId+"/extendedProperties/"+e.tableName+"/"+e.recordId+"/delete",t)},updateRecord:function(e,t){var r=e.record,n={properties:r.properties,user:h._formatDomainUsername(e.user)};return this._sendRequest(n,"/jobs/"+e.jobId+"/extendedProperties/"+r.tableName+"/"+r.recordId+"/update",t)},listFieldValues:function(t,n){var s=this.parsedUrl.path+"/jobs/"+t.jobId+"/extendedProperties/"+t.tableName+"/listValues",a={field:t.field,user:h._formatDomainUsername(t.user),f:"json"},o=this._encode(e.mixin({},this.parsedUrl.query,a)),i=this._generateOptions(o,n);return r(s,i).then(function(e){return e.data.values})},listMultiLevelFieldValues:function(n,s){var a=!1,o=n.field,i=n.previousSelectedValues;if(null!=o&&"multi-level-table-list"==o.displayType){var d=o.tableListDisplayField.split(","),u=d.length,l=i?i.length:0;if(l>=u){var p=new t;return p.then(function(e){return[]}),p}a=l==u-1;var c=d[l];a&&(c+=","+o.tableListStoreField);for(var m="",f=0;l>f;f++){var b=i[f];m+=null==b||0==b.length?"("+d[f]+" IS NULL OR "+d[f]+" = '') AND ":"("+d[f]+" = '"+b+"') AND "}m.length>0&&(m=m.substring(0,m.length-" AND ".length));var y=this.parsedUrl.path+"/jobs/query",j={tables:o.tableListClass,fields:c,where:m,user:h._formatDomainUsername(n.user),f:"json"},_=this._encode(e.mixin({},this.parsedUrl.query,j)),v=this._generateOptions(_,s);return r(y,v).then(function(e){for(var t,r,n=e.data,s={},o=[],i=0;i<n.rows.length;i++)if(r=n.rows[i],a)t={},t.description=r[0],t.value=r[1],o.push(t);else{var d=r[0];null==s[d]&&(t={},t.description=d,t.value=d,o.push(t),s[d]=t)}return o.sort(function(e,t){var r=e.description,n=t.description;return null==r?null==n?0:1:null==n?-1:(r=r.toLowerCase(),n=n.toLowerCase(),r.localeCompare(n))}),o})}var p=new t;return p.then(function(e){return[]}),p},queryMultiLevelSelectedValues:function(n,s){var a=n.field;if(null!=a.data&&"multi-level-table-list"==a.displayType){var o="string"==a.dataType||"global-id"==a.dataType||"guid"==a.dataType,i=o?"'":"",d=this.parsedUrl.path+"/jobs/query",u={tables:a.tableListClass,fields:a.tableListDisplayField,where:a.tableListStoreField+" = "+i+a.data+i,user:h._formatDomainUsername(n.user),f:"json"},l=this._encode(e.mixin({},this.parsedUrl.query,u)),p=this._generateOptions(l,s);return r(d,p).then(function(e){var t=e.data,r=[];return t&&t.rows&&t.rows.length>0&&(r=t.rows[0]),r})}var c=new t;return c.then(function(e){return[]}),c}});return p});