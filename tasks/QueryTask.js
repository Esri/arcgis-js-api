/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../geometry/Extent","../geometry","./support/FeatureSet","../chunks/DataLayerSource","./support/AttachmentQuery","./support/Query","./support/RelationshipQuery","./Task","./operations/pbfJSONFeatureSet","./operations/query","./operations/queryAttachments","./operations/queryRelatedRecords"],(function(e,t,r,o,s,a,n,i,u,c,p,d,h,y,l,f,m,S,x,b,g,Q,_){"use strict";let D=function(t){function s(e){var r;return(r=t.call(this,e)||this).dynamicDataSource=null,r.format="json",r.gdbVersion=null,r.sourceSpatialReference=null,r}e._inheritsLoose(s,t);var a=s.prototype;return a.execute=function(e,t){return this.executeJSON(e,t).then((e=>y.fromJSON(e)))},a.executeJSON=async function(e,t){var o;const s={...this.requestOptions,...t},a=this._normalizeQuery(e),n=null!=(null==(o=e.outStatistics)?void 0:o[0]),i=r("featurelayer-pbf-statistics"),u=!n||i;let c;if("pbf"===this.format&&u){const e=!a.quantizationParameters;try{c=(await g.executeQueryPBF(this.parsedUrl,a,new b.JSONFeatureSetParserContext({sourceSpatialReference:this.sourceSpatialReference,applyTransform:e}),s)).data}catch(e){if("query:parsing-pbf"!==e.name)throw e;this.format="json"}}if("json"===this.format||!u){c=(await g.executeQuery(this.parsedUrl,a,this.sourceSpatialReference,s)).data}return this._normalizeFields(c.fields),c},a.executeForCount=function(e,t){return g.executeQueryForCount(this.parsedUrl,this._normalizeQuery(e),{...this.requestOptions,...t}).then((e=>e.data.count))},a.executeForExtent=function(e,t){return g.executeQueryForExtent(this.parsedUrl,this._normalizeQuery(e),{...this.requestOptions,...t}).then((e=>({count:e.data.count,extent:d.fromJSON(e.data.extent)})))},a.executeForIds=function(e,t){return g.executeQueryForIds(this.parsedUrl,this._normalizeQuery(e),{...this.requestOptions,...t}).then((e=>e.data.objectIds))},a.executeRelationshipQuery=function(e,t){return e=S.from(e),(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),_.executeRelationshipQuery(this.parsedUrl,e,{...this.requestOptions,...t}).then((e=>{const t=e.data,r={};return Object.keys(t).forEach((e=>r[e]=y.fromJSON(t[e]))),r}))},a.executeRelationshipQueryForCount=function(e,t){return e=S.from(e),(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),_.executeRelationshipQueryForCount(this.parsedUrl,e,{...this.requestOptions,...t}).then((e=>e.data))},a.executeAttachmentQuery=function(e,t){return Q.executeAttachmentQuery(this.parsedUrl,f.from(e),{...this.requestOptions,...t}).then((e=>Q.processAttachmentQueryResult(e.data.attachmentGroups,this.parsedUrl.path)))},a._normalizeQuery=function(e){const t=m.from(e);if(!this.gdbVersion&&!this.dynamicDataSource)return t;const r=t===e?t.clone():t;return r.gdbVersion=e.gdbVersion||this.gdbVersion,r.dynamicDataSource=e.dynamicDataSource?l.DataLayerSource.from(e.dynamicDataSource):this.dynamicDataSource,r},a._normalizeFields=function(e){if(o.isSome(this.fieldsIndex)&&o.isSome(e))for(const t of e){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}},s}(x);return t.__decorate([n.property({type:l.DataLayerSource})],D.prototype,"dynamicDataSource",void 0),t.__decorate([n.property()],D.prototype,"fieldsIndex",void 0),t.__decorate([n.property()],D.prototype,"format",void 0),t.__decorate([n.property()],D.prototype,"gdbVersion",void 0),t.__decorate([n.property()],D.prototype,"sourceSpatialReference",void 0),D=t.__decorate([i.subclass("esri.tasks.QueryTask")],D),D}));
