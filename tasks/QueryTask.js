/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Error","../core/has","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/Logger","../core/accessorSupport/decorators/subclass","../layers/support/source/DataLayerSource","../rest/query/executeAttachmentQuery","../rest/query/executeForCount","../rest/query/executeForExtent","../rest/query/executeForIds","../rest/query/executeQueryJSON","../rest/query/executeQueryPBF","../rest/query/executeRelationshipQuery","../rest/query/executeTopFeaturesQuery","../rest/query/executeForTopIds","../rest/query/executeForTopExtents","../rest/query/executeForTopCount","../rest/support/FeatureSet","../rest/support/Query","../rest/support/RelationshipQuery","./Task"],(function(e,t,r,o,s,i,n,u,c,a,p,l,f,y,d,h,m,F,S,x,D,O,b,_,q,g,Q){"use strict";let T=function(r){function u(e){var t;return(t=r.call(this,e)||this).dynamicDataSource=null,t.fieldsIndex=null,t.format="json",t.gdbVersion=null,t.infoFor3D=null,t.sourceSpatialReference=null,t}t._inheritsLoose(u,r);var c=u.prototype;return c.execute=function(e,t){return this.executeJSON(e,t).then((r=>this.featureSetFromJSON(e,r,t)))},c.executeJSON=function(){var e=t._asyncToGenerator((function*(e,t){var r;const o={...this.requestOptions,...t},i=this._normalizeQuery(e),n=null!=(null==(r=e.outStatistics)?void 0:r[0]),u=s("featurelayer-pbf-statistics"),c=!n||u;let a;if("pbf"===this.format&&c)try{a=yield F.executeRawQueryPBF(this.url,i,o)}catch(p){if("query:parsing-pbf"!==p.name)throw p;this.format="json"}return"json"!==this.format&&c||(a=yield m.executeRawQueryJSON(this.url,i,o)),this._normalizeFields(a.fields),a}));function r(t,r){return e.apply(this,arguments)}return r}(),c.featureSetFromJSON=function(){var r=t._asyncToGenerator((function*(t,r,o){if(!(this._queryIs3DObjectFormat(t)&&i.isSome(this.infoFor3D)&&r.features&&r.features.length))return _.fromJSON(r);const{meshFeatureSetFromJSON:s}=yield n.whenOrAbort(new Promise((function(t,r){e(["../rest/support/meshFeatureSet"],t,r)})),o);return s(t,this.infoFor3D,r)}));function o(e,t,o){return r.apply(this,arguments)}return o}(),c.executeForCount=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return y.executeForCount(this.url,o,r)},c.executeForExtent=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return d.executeForExtent(this.url,o,r)},c.executeForIds=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return h.executeForIds(this.url,o,r)},c.executeRelationshipQuery=function(e,t){e=g.from(e);const r={...this.requestOptions,...t};return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),S.executeRelationshipQuery(this.url,e,r)},c.executeRelationshipQueryForCount=function(e,t){e=g.from(e);const r={...this.requestOptions,...t};return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),S.executeRelationshipQueryForCount(this.url,e,r)},c.executeAttachmentQuery=function(e,t){const r={...this.requestOptions,...t};return f.executeAttachmentQuery(this.url,e,r)},c.executeTopFeaturesQuery=function(e,t){const r={...this.requestOptions,...t};return x.executeTopFeaturesQuery(this.parsedUrl,e,this.sourceSpatialReference,r)},c.executeForTopIds=function(e,t){const r={...this.requestOptions,...t};return D.executeForTopIds(this.parsedUrl,e,r)},c.executeForTopExtents=function(e,t){const r={...this.requestOptions,...t};return O.executeForTopExtents(this.parsedUrl,e,r)},c.executeForTopCount=function(e,t){const r={...this.requestOptions,...t};return b.executeForTopCount(this.parsedUrl,e,r)},c._normalizeQuery=function(e){let t=q.from(e);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?l.DataLayerSource.from(e.dynamicDataSource):this.dynamicDataSource),i.isSome(this.infoFor3D)&&this._queryIs3DObjectFormat(e)){t=t===e?t.clone():t,t.formatOf3DObjects=null;for(const e of this.infoFor3D.queryFormats){if("3D_glb"===e.id){t.formatOf3DObjects=e.id;break}"3D_gltf"!==e.id||t.formatOf3DObjects||(t.formatOf3DObjects=e.id)}if(!t.formatOf3DObjects)throw new o("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(i.isNone(t.outFields)||!t.outFields.includes("*")){t=t===e?t.clone():t,i.isNone(t.outFields)&&(t.outFields=[]);const{originX:r,originY:o,originZ:s,translationX:n,translationY:u,translationZ:c,scaleX:a,scaleY:p,scaleZ:l,rotationX:f,rotationY:y,rotationZ:d,rotationDeg:h}=this.infoFor3D.transformFieldRoles;t.outFields.push(r,o,s,n,u,c,a,p,l,f,y,d,h)}}return t},c._normalizeFields=function(e){if(i.isSome(this.fieldsIndex)&&i.isSome(e))for(const t of e){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}},c._queryIs3DObjectFormat=function(e){return i.isSome(this.infoFor3D)&&e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics},u}(Q);return r.__decorate([u.property({type:l.DataLayerSource})],T.prototype,"dynamicDataSource",void 0),r.__decorate([u.property()],T.prototype,"fieldsIndex",void 0),r.__decorate([u.property()],T.prototype,"format",void 0),r.__decorate([u.property()],T.prototype,"gdbVersion",void 0),r.__decorate([u.property()],T.prototype,"infoFor3D",void 0),r.__decorate([u.property()],T.prototype,"sourceSpatialReference",void 0),T=r.__decorate([p.subclass("esri.tasks.QueryTask")],T),T}));
