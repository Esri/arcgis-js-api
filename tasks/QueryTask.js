/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","./support/FeatureSet","../layers/support/source/DataLayerSource","./support/Query","./support/RelationshipQuery","../rest/query/executeAttachmentQuery","../rest/query/executeForCount","../rest/query/executeForExtent","../rest/query/executeForIds","../rest/query/executeQueryJSON","../rest/query/executeQueryPBF","../rest/query/executeRelationshipQuery","./Task"],(function(e,t,r,o,s,i,u,n,c,a,p,y,l,d,h,f,m,S,x,b,_,g,Q){"use strict";let D=function(t){function s(e){var r;return(r=t.call(this,e)||this).dynamicDataSource=null,r.format="json",r.gdbVersion=null,r.sourceSpatialReference=null,r}e._inheritsLoose(s,t);var i=s.prototype;return i.execute=function(e,t){return this.executeJSON(e,t).then((e=>y.fromJSON(e)))},i.executeJSON=async function(e,t){var o;const s={...this.requestOptions,...t},i=this._normalizeQuery(e),u=null!=(null==(o=e.outStatistics)?void 0:o[0]),n=r("featurelayer-pbf-statistics"),c=!u||n;let a;if("pbf"===this.format&&c)try{a=await _.executeRawQueryPBF(this.url,i,s)}catch(p){if("query:parsing-pbf"!==p.name)throw p;this.format="json"}return"json"!==this.format&&c||(a=await b.executeRawQueryJSON(this.url,i,s)),this._normalizeFields(a.fields),a},i.executeForCount=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return m.executeForCount(this.url,o,r)},i.executeForExtent=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return S.executeForExtent(this.url,o,r)},i.executeForIds=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return x.executeForIds(this.url,o,r)},i.executeRelationshipQuery=function(e,t){e=h.from(e);const r={...this.requestOptions,...t};return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),g.executeRelationshipQuery(this.url,e,r)},i.executeRelationshipQueryForCount=function(e,t){e=h.from(e);const r={...this.requestOptions,...t};return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),g.executeRelationshipQueryForCount(this.url,e,r)},i.executeAttachmentQuery=function(e,t){const r={...this.requestOptions,...t};return f.executeAttachmentQuery(this.url,e,r)},i._normalizeQuery=function(e){const t=d.from(e);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,!this.gdbVersion&&!this.dynamicDataSource)return t;const r=t===e?t.clone():t;return r.gdbVersion=e.gdbVersion||this.gdbVersion,r.dynamicDataSource=e.dynamicDataSource?l.DataLayerSource.from(e.dynamicDataSource):this.dynamicDataSource,r},i._normalizeFields=function(e){if(o.isSome(this.fieldsIndex)&&o.isSome(e))for(const t of e){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}},s}(Q);return t.__decorate([u.property({type:l.DataLayerSource})],D.prototype,"dynamicDataSource",void 0),t.__decorate([u.property()],D.prototype,"fieldsIndex",void 0),t.__decorate([u.property()],D.prototype,"format",void 0),t.__decorate([u.property()],D.prototype,"gdbVersion",void 0),t.__decorate([u.property()],D.prototype,"sourceSpatialReference",void 0),D=t.__decorate([n.subclass("esri.tasks.QueryTask")],D),D}));
