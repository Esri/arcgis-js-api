// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../kernel","../request","../core/Error","../core/has","../core/jsonMap","../core/lang","../core/promiseUtils","../core/screenUtils","../core/SetUtils","../core/string","../core/urlUtils","../core/accessorSupport/decorators","../geometry/Polygon","../renderers/visualVariables/support/visualVariableUtils","./Geoprocessor","./Task","./support/fileFormat","./support/layoutTemplate","./support/printTaskUtils","./support/PrintTemplate","./support/Query","@dojo/framework/shim/Promise"],(function(e,t,r,a,i,n,s,o,l,u,c,y,p,d,h,f,m,g,_,v,b,S,w,L){"use strict";var x={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},O=new o.default({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),J=new o.default({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),N=new L({returnGeometry:!0});function I(e){return e&&(e.path||"image/svg+xml"===e.contentType||e.url&&p.endsWith(e.url,".svg"))}return function(t){function o(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var a=t.apply(this,e)||this;return a._ssExtent=null,a._legendLayers=[],a._legendLayerNameMap={},a._gpServerUrl=null,a._cimVersion=null,a._is11xService=!1,a._gpMetadata=null,a.updateDelay=1e3,a}return r.__extends(o,t),Object.defineProperty(o.prototype,"_geoprocessor",{get:function(){return new g({url:this.url})},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"mode",{get:function(){return this._gpMetadata&&this._gpMetadata.executionType?J.fromJSON(this._gpMetadata.executionType):"sync"},enumerable:!1,configurable:!0}),o.prototype.execute=function(e,t){var r=this,a=this.url,n=a.lastIndexOf("/GPServer/");return n>0&&(a=a.slice(0,n+9)),u.resolve().then((function(){return r._gpServerUrl===a?{data:r._gpMetadata}:(r._gpServerUrl=a,i(a,{query:{f:"json"}}))})).then((function(t){return r._gpMetadata=t.data,r._cimVersion=r._gpMetadata.cimVersion,r._is11xService=!!r._cimVersion,r._getGpPrintParams(e)})).then((function(e){var a=function(e){return"sync"===r.mode?e.results&&e.results[0]&&e.results[0].value:r._geoprocessor.getResultData(e.jobId,"Output_File",t).then((function(e){return e.value}))};return"async"===r.mode?r._geoprocessor.submitJob(e,t).then((function(e){return r._geoprocessor.waitForJobCompletion(e.jobId,{interval:r.updateDelay}).then(a)})):r._geoprocessor.execute(e,t).then(a)}))},o.prototype._createOperationalLayers=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,i,n,s,o,l,u,c,y;return r.__generator(this,(function(r){switch(r.label){case 0:a=[],i={layerView:null,printTemplate:t,view:e},n=0,t.scalePreserved&&(n=t.outScale||e.scale),s=S.getVisibleLayerViews(e,n),o=0,l=s,r.label=1;case 1:return o<l.length?(u=l[o],!(c=u.layer).loaded||S.isGroupLayer(c)?[3,28]:(y=void 0,i.layerView=u,S.isBingMapsLayer(c)?(y=this._createBingMapsLayerJSON(c),[3,27]):[3,2])):[3,29];case 2:return S.isCSVLayer(c)?[4,this._createCSVLayerJSON(c,i)]:[3,4];case 3:return y=r.sent(),[3,27];case 4:return S.isFeatureLayer(c)?[4,this._createFeatureLayerJSON(c,i)]:[3,6];case 5:return y=r.sent(),[3,27];case 6:return S.isGeoJSONLayer(c)?[4,this._createGeoJSONLayer(c,i)]:[3,8];case 7:return y=r.sent(),[3,27];case 8:return S.isGraphicsLayer(c)?[4,this._createGraphicsLayerJSON(c,i)]:[3,10];case 9:return y=r.sent(),[3,27];case 10:return S.isImageryLayer(c)?(y=this._createImageryLayerJSON(c),[3,27]):[3,11];case 11:return S.isKMLLayer(c)?[4,this._createKMLLayerJSON(c,i)]:[3,13];case 12:return y=r.sent(),[3,27];case 13:return S.isMapImageLayer(c)?(y=this._createMapImageLayerJSON(c,i),[3,27]):[3,14];case 14:return S.isMapNotesLayer(c)?[4,this._createMapNotesLayerJSON(i)]:[3,16];case 15:return y=r.sent(),[3,27];case 16:return S.isOpenStreetMapLayer(c)?(y=this._createOpenStreetMapLayerJSON(),[3,27]):[3,17];case 17:return S.isStreamLayer(c)?[4,this._createStreamLayerJSON(c,i)]:[3,19];case 18:return y=r.sent(),[3,27];case 19:return S.isTileLayer(c)?(y=this._createTileLayerJSON(c),[3,27]):[3,20];case 20:return S.isVectorTileLayer(c)?[4,this._createVectorTileLayerJSON(c,i)]:[3,22];case 21:return y=r.sent(),[3,27];case 22:return S.isWebTileLayer(c)?(y=this._createWebTileLayerJSON(c),[3,27]):[3,23];case 23:return S.isWMSLayer(c)?(y=this._createWMSLayerJSON(c),[3,27]):[3,24];case 24:return S.isWMTSLayer(c)?(y=this._createWMTSLayerJSON(c),[3,27]):[3,25];case 25:return[4,this._createScreenshotJSON(c,i)];case 26:y=r.sent(),r.label=27;case 27:y&&(Array.isArray(y)?a.push.apply(a,y):(y.id=c.id,y.title=this._legendLayerNameMap[c.id]||c.title,y.opacity=c.opacity,y.minScale=c.minScale||0,y.maxScale=c.maxScale||0,a.push(y))),r.label=28;case 28:return o++,[3,1];case 29:return n&&a.forEach((function(e){e.minScale=0,e.maxScale=0})),e.graphics&&e.graphics.length?[4,this._createFeatureCollectionJSON(null,e.graphics,t)]:[3,31];case 30:(y=r.sent())&&a.push(y),r.label=31;case 31:return[2,a]}}))}))},o.prototype._createBingMapsLayerJSON=function(e){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}},o.prototype._createCSVLayerJSON=function(e,t){var a=t.layerView,i=t.printTemplate;return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),this._is11xService?(t={type:"CSV"},e.write(t,{origin:"web-map"}),delete t.popupInfo,delete t.layerType,t.showLabels=i.showLabels&&e.labelsVisible,[3,3]):[3,1];case 1:return[4,this._getGraphics(a)];case 2:return n=r.sent(),[2,this._createFeatureCollectionJSON(e,n,i)];case 3:return[2,t]}}))}))},o.prototype._createFeatureCollectionJSON=function(e,t,a){var i,n;return r.__awaiter(this,void 0,void 0,(function(){var s,o,l,u,c,p,d,h,m,g,_,v,b,w,L,x,O,J,N,M,D,T,V,P;return r.__generator(this,(function(F){switch(F.label){case 0:return o=S.createPolygonLayer(),l=S.createPolylineLayer(),u=S.createPointLayer(),c=S.createMultipointLayer(),(p=S.createPointLayer()).layerDefinition.name="textLayer",delete p.layerDefinition.drawingInfo,e&&("esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass?o.layerDefinition.name=l.layerDefinition.name=u.layerDefinition.name=c.layerDefinition.name=this._legendLayerNameMap[e.id]||e.get("arcgisProps.title")||e.title:"esri.layers.GraphicsLayer"===e.declaredClass&&(t=e.graphics.items),e.renderer&&(d=e.renderer.toJSON(),o.layerDefinition.drawingInfo.renderer=d,l.layerDefinition.drawingInfo.renderer=d,u.layerDefinition.drawingInfo.renderer=d,c.layerDefinition.drawingInfo.renderer=d),a.showLabels&&e.labelsVisible&&"function"==typeof e.write&&(h=e.write({},{origin:"web-map"}),(m=null===(n=null===(i=h.layerDefinition)||void 0===i?void 0:i.drawingInfo)||void 0===n?void 0:n.labelingInfo)&&(s=!0,o.layerDefinition.drawingInfo.labelingInfo=m,l.layerDefinition.drawingInfo.labelingInfo=m,u.layerDefinition.drawingInfo.labelingInfo=m,c.layerDefinition.drawingInfo.labelingInfo=m))),(null==e?void 0:e.renderer)||s||(delete o.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete u.layerDefinition.drawingInfo,delete c.layerDefinition.drawingInfo),_=e&&e.fields,v=e&&e.renderer,_&&v&&"function"==typeof v.collectRequiredFields?(b=new Set,[4,v.collectRequiredFields(b,_)]):[3,2];case 1:F.sent(),g=y.valuesOfSet(b),F.label=2;case 2:_&&(w=_.map((function(e){return e.toJSON()})),o.layerDefinition.fields=w,l.layerDefinition.fields=w,u.layerDefinition.fields=w,c.layerDefinition.fields=w),L=t&&t.length,O=function(i){var n,s,y,d,h,m;return r.__generator(this,(function(r){switch(r.label){case 0:return!1!==(n=t[i]||t.getItemAt(i)).visible&&n.geometry?((x=n.toJSON()).hasOwnProperty("popupTemplate")&&delete x.popupTemplate,x.geometry&&x.geometry.z&&delete x.geometry.z,x.symbol&&x.symbol.outline&&"esriCLS"===x.symbol.outline.type&&!J._is11xService?[2,"continue"]:(!J._is11xService&&x.symbol&&x.symbol.outline&&x.symbol.outline.color&&x.symbol.outline.color[3]&&(x.symbol.outline.color[3]=255),s=e&&e.renderer&&("valueExpression"in e.renderer&&e.renderer.valueExpression||"hasVisualVariables"in e.renderer&&e.renderer.hasVisualVariables()),!x.symbol&&e&&e.renderer&&s&&!J._is11xService?[4,(y=e.renderer).getSymbolAsync(n)]:[3,2])):[2,"continue"];case 1:if(!(d=r.sent()))return[2,"continue"];x.symbol=d.toJSON(),"hasVisualVariables"in y&&y.hasVisualVariables()&&S.applyVisualVariables(x.symbol,{renderer:y,graphic:n,symbol:d}),r.label=2;case 2:return x.symbol?(x.symbol.angle||delete x.symbol.angle,I(x.symbol)?(h=x,[4,J._convertSvgToPictureMarkerSymbolJson(x.symbol)]):[3,4]):[3,5];case 3:return h.symbol=r.sent(),[3,5];case 4:x.symbol.text&&delete x.attributes,r.label=5;case 5:return a&&a.forceFeatureAttributes||!g||!g.length||(m={},g.forEach((function(e){x.attributes&&x.attributes.hasOwnProperty(e)&&(m[e]=x.attributes[e])})),x.attributes=m),"polygon"===n.geometry.type?o.featureSet.features.push(x):"polyline"===n.geometry.type?l.featureSet.features.push(x):"point"===n.geometry.type?x.symbol&&x.symbol.text?p.featureSet.features.push(x):u.featureSet.features.push(x):"multipoint"===n.geometry.type?c.featureSet.features.push(x):"extent"===n.geometry.type&&(x.geometry=f.fromExtent(n.geometry).toJSON(),o.featureSet.features.push(x)),[2]}}))},J=this,N=0,F.label=3;case 3:return N<L?[5,O(N)]:[3,6];case 4:F.sent(),F.label=5;case 5:return N++,[3,3];case 6:M=[o,l,c,u,p].filter((function(e){return e.featureSet.features.length>0})),D=0,T=M,F.label=7;case 7:return D<T.length?(V=T[D],!(P=V.featureSet.features.every((function(e){return e.symbol})))||a&&a.forceFeatureAttributes||V.featureSet.features.forEach((function(e){delete e.attributes})),P&&delete V.layerDefinition.drawingInfo,V.layerDefinition.drawingInfo&&V.layerDefinition.drawingInfo.renderer?[4,this._convertSvgRenderer(V.layerDefinition.drawingInfo.renderer)]:[3,9]):[3,10];case 8:F.sent(),F.label=9;case 9:return D++,[3,7];case 10:return[2,M.length?{featureCollection:{layers:M},showLabels:s}:null]}}))}))},o.prototype._createFeatureLayerJSON=function(e,t){var a,i,n,s;return r.__awaiter(this,void 0,void 0,(function(){var o,l,u,c,y,p,d,h,f,g;return r.__generator(this,(function(r){switch(r.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),l=e.renderer,e.featureReduction||l&&"dot-density"===l.type&&(!this._is11xService||parseFloat(this._cimVersion)<2.6)?[2,this._createScreenshotJSON(e,t)]:(u=t.layerView,c=t.printTemplate,y=t.view,p=l&&("valueExpression"in l&&l.valueExpression||"hasVisualVariables"in l&&l.hasVisualVariables()),d="feature-layer"!==(null===(a=e.source)||void 0===a?void 0:a.type)&&"ogc-feature"!==(null===(i=e.source)||void 0===i?void 0:i.type),!this._is11xService&&p||e.featureReduction||d||!l||"field"in l&&null!=l.field&&("string"!=typeof l.field||!e.getField(l.field))?[3,3]:(_=e.write(),(o={id:_.id,title:_.title,opacity:_.opacity,minScale:_.minScale,maxScale:_.maxScale,url:_.url,layerDefinition:_.layerDefinition}).showLabels=c.showLabels&&e.labelsVisible,this._setURLandToken(o,e),(null===(s=null===(n=o.layerDefinition)||void 0===n?void 0:n.drawingInfo)||void 0===s?void 0:s.renderer)?(delete o.layerDefinition.minScale,delete o.layerDefinition.maxScale,[4,this._convertSvgRenderer(o.layerDefinition.drawingInfo.renderer)]):[3,2]));case 1:r.sent(),"visualVariables"in l&&l.visualVariables&&l.visualVariables[0]&&"size"===(h=l.visualVariables[0]).type&&h.maxSize&&"number"!=typeof h.maxSize&&h.minSize&&"number"!=typeof h.minSize&&(f=m.getSizeRangeAtScale(h,y.scale),o.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=f.minSize,o.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=f.maxSize),r.label=2;case 2:return[3,6];case 3:return[4,this._getGraphics(u)];case 4:return g=r.sent(),[4,this._createFeatureCollectionJSON(e,g,c)];case 5:o=r.sent(),r.label=6;case 6:return[2,o]}var _}))}))},o.prototype._createGeoJSONLayer=function(e,t){var a=t.layerView,i=t.printTemplate;return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),[4,this._getGraphics(a)];case 1:return t=r.sent(),[2,this._createFeatureCollectionJSON(e,t,i)]}}))}))},o.prototype._createGraphicsLayerJSON=function(e,t){var a=t.printTemplate;return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this._createFeatureCollectionJSON(e,null,a)]}))}))},o.prototype._createImageryLayerJSON=function(e){this._legendLayers&&this._legendLayers.push({id:e.id});var t={bandIds:e.bandIds,compressionQuality:e.compressionQuality,format:e.format,interpolation:e.interpolation};if((e.mosaicRule||e.definitionExpression)&&(t.mosaicRule=e.exportImageServiceParameters.mosaicRule.toJSON()),e.renderingRule||e.renderer)if(this._is11xService)e.renderingRule&&(t.renderingRule=e.renderingRule.toJSON()),e.renderer&&(t.layerDefinition=t.layerDefinition||{},t.layerDefinition.drawingInfo=t.layerDefinition.drawingInfo||{},t.layerDefinition.drawingInfo.renderer=e.renderer.toJSON());else{var r=e.exportImageServiceParameters.combineRendererWithRenderingRule();r&&(t.renderingRule=r.toJSON())}return this._setURLandToken(t,e),t},o.prototype._createKMLLayerJSON=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,i,n,s,o,l,u;return r.__generator(this,(function(c){switch(c.label){case 0:return a=t.printTemplate,this._is11xService?(i={type:"kml"},e.write(i,{origin:"web-map"}),delete i.layerType,i.url=d.normalize(e.url),[2,i]):(n=[],(s=t.layerView).allVisibleMapImages.forEach((function(t,r){var a={id:e.id+"_image"+r,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:e.opacity,extent:t.extent};"data:image/png;base64,"===t.href.substr(0,22)?a.imageData=t.href.substr(22):a.url=t.href,n.push(a)})),o=r.__spreadArrays(s.allVisiblePoints.items,s.allVisiblePolylines.items,s.allVisiblePolygons.items),u=[{id:e.id}],[4,this._createFeatureCollectionJSON(null,o,a)]);case 1:return l=r.__assign.apply(void 0,u.concat([c.sent()])),n.push(l),[2,n]}}))}))},o.prototype._createMapImageLayerJSON=function(e,t){var r,a=t.view,i={id:e.id,subLayerIds:[]},n=[],s=a.scale,o=function(e){var t=0===s,r=0===e.minScale||s<=e.minScale,a=0===e.maxScale||s>=e.maxScale;if(e.visible&&(t||r&&a))if(e.sublayers)e.sublayers.forEach(o);else{var l=e.toExportImageJSON(),u={id:e.id,name:e.title,layerDefinition:{drawingInfo:l.drawingInfo,definitionExpression:l.definitionExpression,source:l.source}};n.unshift(u),i.subLayerIds.push(e.id)}};return e.sublayers&&e.sublayers.forEach(o),n.length&&(r={layers:n=n.map((function(e){return{id:e.id,name:e.name,layerDefinition:e.layerDefinition}})),visibleLayers:i.subLayerIds},this._setURLandToken(r,e),this._legendLayers.push(i)),r},o.prototype._createMapNotesLayerJSON=function(e){var t=e.layerView,a=e.printTemplate;return r.__awaiter(this,void 0,void 0,(function(){var e,i,n,s,o;return r.__generator(this,(function(r){switch(r.label){case 0:e=[],i=0,n=t.graphicsViews,r.label=1;case 1:return i<n.length?(s=n[i],[4,this._createFeatureCollectionJSON(s,s.graphics,a)]):[3,4];case 2:(o=r.sent())&&e.push.apply(e,o.featureCollection.layers),r.label=3;case 3:return i++,[3,1];case 4:return[2,{featureCollection:{layers:e}}]}}))}))},o.prototype._createOpenStreetMapLayerJSON=function(){return{type:"OpenStreetMap"}},o.prototype._createScreenshotJSON=function(e,t){var a=t.printTemplate,i=t.view;return r.__awaiter(this,void 0,void 0,(function(){var t,n,s,o,l,u,y,p,h,f;return r.__generator(this,(function(r){switch(r.label){case 0:return t={type:"image"},n={format:"png",ignoreBackground:!0,layers:[e],rotation:0},s=this._ssExtent||i.extent.clone(),o=96,l=!0,u=!0,a.exportOptions&&((y=a.exportOptions).dpi>0&&(o=y.dpi),y.width>0&&(l=y.width%2==i.width%2),y.height>0&&(u=y.height%2==i.height%2)),"map-only"!==a.layout||!a.scalePreserved||a.outScale&&a.outScale!==i.scale||96!==o||l&&u||(n.area={x:0,y:0,width:i.width,height:i.height},l||(n.area.width-=1),u||(n.area.height-=1),this._ssExtent||(p=i.toMap(c.createScreenPoint(n.area.width,n.area.height)),s.ymin=p.y,s.xmax=p.x,this._ssExtent=s)),t.extent=s.clone()._normalize(!0).toJSON(),[4,i.takeScreenshot(n)];case 1:return h=r.sent(),f=d.dataComponents(h.dataUrl),t.imageData=f.data,[2,t]}}))}))},o.prototype._createStreamLayerJSON=function(e,t){var a=t.layerView,i=t.printTemplate;return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),[4,this._getGraphics(a)];case 1:return t=r.sent(),[2,this._createFeatureCollectionJSON(e,t,i)]}}))}))},o.prototype._createTileLayerJSON=function(e){var t={};return this._setURLandToken(t,e),t},o.prototype._createVectorTileLayerJSON=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,s;return r.__generator(this,(function(r){return this._is11xService&&e.serviceUrl&&e.styleUrl&&(i=a.id&&a.id.findCredential(e.styleUrl),n=a.id&&a.id.findCredential(e.serviceUrl),!i&&!n||"2.1.0"!==this._cimVersion)?((s={type:"VectorTileLayer"}).styleUrl=d.normalize(e.styleUrl),i&&(s.token=i.token),n&&n.token!==s.token&&(s.additionalTokens=[{url:e.serviceUrl,token:n.token}]),[2,s]):[2,this._createScreenshotJSON(e,t)]}))}))},o.prototype._createWebTileLayerJSON=function(e){var t={type:"WebTiledLayer",urlTemplate:e.urlTemplate.replace(/\${/g,"{"),credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(t.subDomains=e.subDomains),t},o.prototype._createWMSLayerJSON=function(e){var t,r=[],a=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(a):e.name&&r.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(a),r.length&&(t={type:"wms",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,transparentBackground:e.imageTransparency,visibleLayers:r,url:d.normalize(e.url),version:e.version}),t},o.prototype._createWMTSLayerJSON=function(e){var t=e.activeLayer;return{type:"wmts",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,format:t.imageFormat,layer:t.id,style:t.styleId,tileMatrixSet:t.tileMatrixSetId,url:d.normalize(e.url)}},o.prototype._setURLandToken=function(e,t){var r;if(t.url){e.url=d.normalize(e.url||t.url);var i=null===(r=a.id)||void 0===r?void 0:r.findCredential(t.url);i&&(e.token=i.token)}},o.prototype._convertSvgToPictureMarkerSymbolJson=function(t){var a;return r.__awaiter(this,void 0,void 0,(function(){var n,o,l,u,y,p,d,h,f,m,g,_,v,b;return r.__generator(this,(function(r){switch(r.label){case 0:return s("trident")?[2,null]:(this._canvas||(this._canvas=document.createElement("canvas")),n=1024,this._canvas.width=n,this._canvas.height=n,o=this._canvas.getContext("2d"),t.path?(y=void 0,s("edge")?(y=new Path2D,[4,new Promise((function(t,r){e(["../libs/draw-svg-path/index"],t,r)}))]):[3,2]):[3,4]);case 1:return r.sent().draw(y,t.path),[3,3];case 2:y=new Path2D(t.path),r.label=3;case 3:return y.closePath(),o.fillStyle=Array.isArray(t.color)?"rgba("+t.color[0]+","+t.color[1]+","+t.color[2]+","+t.color[3]/255+")":"rgb(0,0,0)",o.fill(y),(p=S.getContextBoundingBox(o))?(o.clearRect(0,0,n,n),d=c.pt2px(t.size)/Math.max(p.width,p.height),o.scale(d,d),f=(h=n/d)/2-p.width/2-p.x,m=h/2-p.height/2-p.y,o.translate(f,m),Array.isArray(t.color)&&o.fill(y),(null===(a=t.outline)||void 0===a?void 0:a.width)&&Array.isArray(t.outline.color)&&(g=t.outline,o.lineWidth=c.pt2px(g.width)/d,o.lineJoin="round",o.strokeStyle="rgba("+g.color[0]+","+g.color[1]+","+g.color[2]+","+g.color[3]/255+")",o.stroke(y),p.width+=o.lineWidth,p.height+=o.lineWidth),p.width*=d,p.height*=d,_=o.getImageData(n/2-p.width/2,n/2-p.height/2,Math.ceil(p.width),Math.ceil(p.height)),l=_.width,u=_.height,o.canvas.width=l,o.canvas.height=u,o.putImageData(_,0,0),[3,6]):[2,null];case 4:return v="image/svg+xml"===t.contentType?"data:image/svg+xml;base64,"+t.imageData:t.url,[4,i(v,{responseType:"image"})];case 5:b=r.sent().data,l=c.pt2px(t.width),u=c.pt2px(t.height),o.canvas.width=l,o.canvas.height=u,o.drawImage(b,0,0,o.canvas.width,o.canvas.height),r.label=6;case 6:return[2,{type:"esriPMS",imageData:o.canvas.toDataURL("image/png").substr(22),angle:t.angle,contentType:"image/png",height:c.px2pt(u),width:c.px2pt(l),xoffset:t.xoffset,yoffset:t.yoffset}]}}))}))},o.prototype._convertSvgRenderer=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,i,n,s,o,l,u;return r.__generator(this,(function(r){switch(r.label){case 0:return"simple"===(t=e.type)&&I(e.symbol)?(a=e,[4,this._convertSvgToPictureMarkerSymbolJson(e.symbol)]):[3,2];case 1:return a.symbol=r.sent(),[3,8];case 2:return"unique-value"!==t&&"class-breaks"!==t?[3,8]:I(e.defaultSymbol)?(i=e,[4,this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol)]):[3,4];case 3:i.defaultSymbol=r.sent(),r.label=4;case 4:if(!(n=e["unique-value"===t?"uniqueValueInfos":"classBreakInfos"]))return[3,8];s=0,o=n,r.label=5;case 5:return s<o.length?I((l=o[s]).symbol)?(u=l,[4,this._convertSvgToPictureMarkerSymbolJson(l.symbol)]):[3,7]:[3,8];case 6:u.symbol=r.sent(),r.label=7;case 7:return s++,[3,5];case 8:return[2]}}))}))},o.prototype._getGraphics=function(e){return e.queryFeatures(N).then((function(e){return e.features}))},o.prototype._getPrintDefinition=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var a,i,n,s,o;return r.__generator(this,(function(r){switch(r.label){case 0:return a=e.view,i=a.spatialReference,s={},[4,this._createOperationalLayers(a,t)];case 1:return s.operationalLayers=r.sent(),n=s,o=this._ssExtent||e.extent||a.extent,i&&i.isWrappable&&(o=o.clone()._normalize(!0),i=o.spatialReference),n.mapOptions={extent:o&&o.toJSON(),spatialReference:i&&i.toJSON(),showAttribution:t.attributionVisible},this._ssExtent=null,a.rotation&&(n.mapOptions.rotation=-a.rotation),t.scalePreserved&&(n.mapOptions.scale=t.outScale||a.scale),[2,n]}}))}))},o.prototype._getGpPrintParams=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,i,s,o,u,c,y,d,h,f,m,g,_,S,L,J,N,I,M=this;return r.__generator(this,(function(r){switch(r.label){case 0:return null==(t=e.template||new w).showLabels&&(t.showLabels=!0),a=t.exportOptions,s=b.toJSON(t.layout),a&&(o=a.dpi,i={dpi:o},"map_only"!==s.toLowerCase()&&""!==s||(u=a.width,c=a.height,i.outputSize=[u,c])),(y=t.layoutOptions)&&(h=void 0,f=void 0,"Miles"===y.scalebarUnit||"Kilometers"===y.scalebarUnit?(h="Kilometers",f="Miles"):"Meters"!==y.scalebarUnit&&"Feet"!==y.scalebarUnit||(h="Meters",f="Feet"),d={titleText:y.titleText,authorText:y.authorText,copyrightText:y.copyrightText,customTextElements:y.customTextElements,scaleBarOptions:{metricUnit:O.toJSON(h),metricLabel:x[h],nonMetricUnit:O.toJSON(f),nonMetricLabel:x[f]}}),m=null,y&&y.legendLayers&&(m=y.legendLayers.map((function(e){M._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t}))),[4,this._getPrintDefinition(e,t)];case 1:return(g=r.sent()).operationalLayers&&(_=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),S=/[\u0600-\u06FF]/,L=function(e){var t=e.text,r=e.font,a=r&&r.family&&r.family.toLowerCase();t&&r&&("arial"===a||"arial unicode ms"===a)&&(r.family=_.test(t)?"Arial Unicode MS":"Arial","normal"!==r.style&&S.test(t)&&(r.family="Arial Unicode MS"))},J=function(){throw new n("print-task:cim-symbol-unsupported","CIMSymbol is not supported by a print service published from ArcMap")},g.operationalLayers.forEach((function(e){var t,r,a;(null===(t=e.featureCollection)||void 0===t?void 0:t.layers)?e.featureCollection.layers.forEach((function(e){var t,r,a,i;if(null===(a=null===(r=null===(t=e.layerDefinition)||void 0===t?void 0:t.drawingInfo)||void 0===r?void 0:r.renderer)||void 0===a?void 0:a.symbol){var n=e.layerDefinition.drawingInfo.renderer;"esriTS"===n.symbol.type?L(n.symbol):"CIMSymbolReference"!==n.symbol.type||M._is11xService||J()}(null===(i=e.featureSet)||void 0===i?void 0:i.features)&&e.featureSet.features.forEach((function(e){e.symbol&&("esriTS"===e.symbol.type?L(e.symbol):"CIMSymbolReference"!==e.symbol.type||M._is11xService||J())}))})):!M._is11xService&&(null===(a=null===(r=e.layerDefinition)||void 0===r?void 0:r.drawingInfo)||void 0===a?void 0:a.renderer)&&p.includes(JSON.stringify(e.layerDefinition.drawingInfo.renderer),'"type":"CIMSymbolReference"')&&J()}))),e.outSpatialReference&&(g.mapOptions.spatialReference=e.outSpatialReference.toJSON()),l.mixin(g,{exportOptions:i,layoutOptions:d}),l.mixin(g.layoutOptions,{legendOptions:{operationalLayers:null!=m?m:this._legendLayers.slice()}}),this._legendLayers.length=0,N=JSON.stringify(g),I={Web_Map_as_JSON:N,Format:v.toJSON(t.format),Layout_Template:s},e.extraParameters&&l.mixin(I,e.extraParameters),[2,I]}}))}))},r.__decorate([h.property({dependsOn:["url"]})],o.prototype,"_geoprocessor",null),r.__decorate([h.property()],o.prototype,"_gpMetadata",void 0),r.__decorate([h.property({dependsOn:["_gpMetadata"],readOnly:!0})],o.prototype,"mode",null),r.__decorate([h.property()],o.prototype,"updateDelay",void 0),o=r.__decorate([h.subclass("esri.tasks.PrintTask")],o)}(_)}));