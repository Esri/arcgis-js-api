// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/pbf","./pbfDehydratedFeatureSet","./pbfOptimizedFeatureSet"],(function(e,r,t,a,s,n,i){Object.defineProperty(r,"__esModule",{value:!0});var c=a.getLogger("esri.tasks.operations.pbfFeatureServiceParser"),l=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],o=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],g=["upperLeft","lowerLeft"];function u(e){return e>=l.length?null:l[e]}function p(e){return e>=g.length?null:g[e]}function y(e,r){return r>=e.geometryTypes.length?null:e.geometryTypes[r]}function b(e,r,t){for(var a=r.createPointGeometry(t);e.next();)switch(e.tag()){case 3:for(var s=e.getUInt32(),n=e.pos()+s,i=0;e.pos()<n;)r.addCoordinatePoint(a,e.getSInt64(),0,i++);break;case 1:case 2:default:e.skip()}return a}function f(e,r,t){for(var a=r.createGeometry(t),s=2+(t.hasZ?1:0)+(t.hasM?1:0);e.next();)switch(e.tag()){case 2:for(var n=e.getUInt32(),i=e.pos()+n,c=0;e.pos()<i;)r.addLength(a,e.getUInt32(),c++);break;case 3:for(var l=e.getUInt32(),o=(i=e.pos()+l,0),g=0;e.pos()<i;)r.addCoordinate(a,e.getSInt64(),g,o),++o===s&&(g++,o=0);break;case 1:default:e.skip()}return a}function d(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function k(e){for(var r,t={type:u(0)};e.next();)switch(e.tag()){case 1:t.name=e.getString();break;case 2:t.type=u(e.getEnum());break;case 3:t.alias=e.getString();break;case 4:t.sqlType=(r=e.getEnum())>=o.length?null:o[r];break;case 5:case 6:default:e.skip()}return t}function T(e,r,t,a){for(var s=r.createFeature(t),n=0;e.next();)switch(e.tag()){case 1:var i=a[n++].name;s.attributes[i]=e.processMessage(d);break;case 2:s.geometry=e.processMessageWithArgs(f,r,t);break;case 4:s.centroid=e.processMessageWithArgs(b,r,t);break;default:e.skip()}return s}function h(e){for(var r=[1,1,1,1];e.next();)switch(e.tag()){case 1:r[0]=e.getDouble();break;case 2:r[1]=e.getDouble();break;case 4:r[2]=e.getDouble();break;case 3:r[3]=e.getDouble();break;default:e.skip()}return r}function m(e){for(var r=[0,0,0,0];e.next();)switch(e.tag()){case 1:r[0]=e.getDouble();break;case 2:r[1]=e.getDouble();break;case 4:r[2]=e.getDouble();break;case 3:r[3]=e.getDouble();break;default:e.skip()}return r}function F(e){for(var r={originPosition:p(0)};e.next();)switch(e.tag()){case 1:r.originPosition=p(e.getEnum());break;case 2:r.scale=e.processMessage(h);break;case 3:r.translate=e.processMessage(m);break;default:e.skip()}return r}function q(e){for(var r={};e.next();)switch(e.tag()){case 1:r.shapeAreaFieldName=e.getString();break;case 2:r.shapeLengthFieldName=e.getString();break;case 3:r.units=e.getString();break;default:e.skip()}return r}function w(e,r){for(var t=r.createSpatialReference();e.next();)switch(e.tag()){case 1:t.wkid=e.getUInt32();break;case 5:t.wkt=e.getString();break;case 2:case 3:case 4:default:e.skip()}return t}function I(e,r){var t=r.createFeatureResult();t.geometryType=y(r,0);for(var a=!1;e.next();)switch(e.tag()){case 1:t.objectIdFieldName=e.getString();break;case 3:t.globalIdFieldName=e.getString();break;case 4:t.geohashFieldName=e.getString();break;case 5:t.geometryProperties=e.processMessage(q);break;case 7:t.geometryType=y(r,e.getEnum());break;case 8:t.spatialReference=e.processMessageWithArgs(w,r);break;case 10:t.hasZ=e.getBool();break;case 11:t.hasM=e.getBool();break;case 12:t.transform=e.processMessage(F);break;case 9:var s=e.getBool();t.exceededTransferLimit=s;break;case 13:r.addField(t,e.processMessage(k));break;case 15:a||(r.prepareFeatures(t),a=!0),r.addFeature(t,e.processMessageWithArgs(T,r,t,t.fields));break;case 2:case 6:default:e.skip()}return r.finishFeatureResult(t),t}function S(e,r){for(var t={};e.next();)switch(e.tag()){case 1:t.featureResult=e.processMessageWithArgs(I,r);break;default:e.skip()}return t}r.parseFeatureQuery=function(e,r){var a=function(e){return e&&"dehydrated"===e.type?new n.Context(e):new i.Context(e)}(r);try{for(var l=new s(new Uint8Array(e),new DataView(e)),o={};l.next();)switch(l.tag()){case 2:o.queryResult=l.processMessageWithArgs(S,a);break;default:l.skip()}return o}catch(e){var g=new t("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});return c.error(g),{queryResult:{featureResult:a.createFeatureResult()}}}}}));