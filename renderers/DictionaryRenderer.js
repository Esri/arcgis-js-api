/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/lang","../core/maybe","../core/string","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/Error","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../support/arcadeOnDemand","../layers/support/fieldUtils","../Color","../symbols/CIMSymbol","../request","./Renderer","./mixins/VisualVariablesMixin","../core/LRUCache"],(function(e,t,s,r,i,o,n,a,l,c,u,p,y,f,h,d,m,g,b,_,S,w,x,v){"use strict";var M;const P=n.getLogger("esri.renderers.DictionaryRenderer"),E={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let R=M=function(t){function s(e){var s;return(s=t.call(this,e)||this)._ongoingRequests=new Map,s._symbolCache=new v(100),s.config=null,s.fieldMap=null,s.scaleExpression=null,s.scaleExpressionTitle=null,s.url=null,s.type="dictionary",s}e._inheritsLoose(s,t);var n=s.prototype;return n.writeData=function(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})},n.writeVisualVariables=function(e,s,r,i){null!=i&&i.origin||t.prototype.writeVisualVariables.call(this,e,s,r,i)},n.clone=function(){return new M({config:r.clone(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:r.clone(this.fieldMap),url:r.clone(this.url),visualVariables:r.clone(this.visualVariables)})},n.getSymbolAsync=async function(e,t){let s;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t));try{s=await this._dictionaryPromise}catch(h){if(d.isAbortError(h))return this._dictionaryPromise=null,null}const r={};if(this.fieldMap)for(const i of this._symbolFields){const t=this.fieldMap[i];if(t&&null!==e.attributes[t]&&void 0!==e.attributes[t]){const s=""+e.attributes[t];r[i]=s}else r[i]=""}const n=s(r,t);if(!n||"string"!=typeof n)return null;const a=o.numericHash(n).toString(),l=this._symbolCache.get(a);if(l)return l.catch((()=>{this._symbolCache.pop(a)})),l;const c=n.split(";"),u=[],p=[];for(const i of c)if(i&&0!==i.length)if(-1===i.indexOf("po:"))if(-1!==i.indexOf("|"))for(const e of i.split("|"))this._itemNames.has(e)&&u.push(e);else this._itemNames.has(i)&&u.push(i);else{const e=i.substr(3).split("|");if(3===e.length){const t=e[0],s=e[1];let r=e[2];if("DashTemplate"===s)r=r.split(" ").map((e=>Number(e)));else if("Color"===s){const e=new b(r).toRgba();r=[e[0],e[1],e[2],255*e[3]]}else r=Number(r);p.push({primitiveName:t,propertyName:s,value:r})}}const y=!i.isSome(e.geometry)||!e.geometry.hasZ&&"point"===e.geometry.type,f=this._cimPartsToCIMSymbol(u,p,y,t);return this._symbolCache.put(a,f,1),f},n.collectRequiredFields=async function(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await g.collectArcadeFieldNames(e,t,this.scaleExpression);const s=t.map((e=>e.name));for(const r in this.fieldMap)s.indexOf(this.fieldMap[r])<0||e.add(this.fieldMap[r])},n.fetchResources=async function(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void P.error("no valid URL!");const t=i.isSome(e)?e.abortOptions:null,s=S(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},...t}),[{data:r}]=await Promise.all([s,m.loadArcade()]);if(!r)throw this._dictionaryPromise=null,new p("esri.renderers.DictionaryRenderer","Bad dictionary data!");const o=r.expression,n=r.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+r.cimRefTemplateUrl,this._itemNames=new Set(r.itemsNames),this._symbolFields=n.symbol;const a={};if(this.config){const e=this.config;for(const t in e)a[t]=e[t]}if(n.configuration)for(const i of n.configuration)a.hasOwnProperty(i.name)||(a[i.name]=i.value);const l=[];if(i.isSome(e)&&e.fields&&this.fieldMap)for(const i of this._symbolFields){const t=this.fieldMap[i],s=e.fields.filter((e=>e.name===t));s.length>0&&l.push({...s[0],name:i})}return this._dictionaryPromise=m.createDictionaryExpression(o,i.isSome(e)?e.spatialReference:null,l,a).then((e=>{const t={scale:0};return(s,r)=>{const o=e.repurposeFeature({geometry:null,attributes:s});return t.scale=i.isSome(r)?r.scale:void 0,e.evaluate({$feature:o,$view:t})}})).catch((e=>(P.error("Creating dictinoary expression failed:",e),null))),this._dictionaryPromise},n.getSymbol=function(){return null},n.getSymbols=function(){return[]},n.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},n.getMeshHash=function(){return`${this.url}-${JSON.stringify(this.fieldMap)}`},n.getSymbolFields=function(){return this._symbolFields},n._getSymbolPart=async function(e,t){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const s=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),r=S(s,{responseType:"json",query:{f:"json"},...t});this._ongoingRequests.set(e,r);try{return(await r).data}catch(i){return this._ongoingRequests.delete(e),Promise.reject(i)}},n._combineSymbolParts=function(e,t,s){if(!e||0===e.length)return null;const r={...e[0]};if(e.length>1){r.symbolLayers=[];for(const t of e){const e=t;r.symbolLayers.unshift(...e.symbolLayers)}}return s&&(r.callout=E),{type:"CIMSymbolReference",symbol:r,primitiveOverrides:t}},n._cimPartsToCIMSymbol=async function(e,t,s,r){const i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=this._getSymbolPart(e[n],r);const o=await Promise.all(i);return new _({data:this._combineSymbolParts(o,t,s)})},e._createClass(s,[{key:"arcadeRequired",get:function(){return!0}}]),s}(x.VisualVariablesMixin(w));return t.__decorate([l.property({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],R.prototype,"config",void 0),t.__decorate([l.property({type:Object,json:{write:!0}})],R.prototype,"fieldMap",void 0),t.__decorate([l.property({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],R.prototype,"scaleExpression",void 0),t.__decorate([u.writer("scaleExpression")],R.prototype,"writeData",null),t.__decorate([l.property({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],R.prototype,"scaleExpressionTitle",void 0),t.__decorate([l.property({type:String,json:{write:!0}})],R.prototype,"url",void 0),t.__decorate([u.writer("visualVariables")],R.prototype,"writeVisualVariables",null),R=M=t.__decorate([c.subclass("esri.renderers.DictionaryRenderer")],R),R}));
