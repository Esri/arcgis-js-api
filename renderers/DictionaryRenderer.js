// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../Color","../request","../core/Error","../core/lang","../core/Logger","../core/LRUCache","../core/maybe","../core/promiseUtils","../core/SetUtils","../core/string","../core/accessorSupport/decorators","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","../support/arcadeOnDemand","../symbols/CIMSymbol"],(function(e,t,r,i,s,n,o,a,l,u,c,p,h,f,y,d,m,_,g){"use strict";var b=a.getLogger("esri.renderers.DictionaryRenderer");return function(e){function t(t){var r=e.call(this,t)||this;return r._ongoingRequests=new Map,r._symbolCache=new l(100),r.config=null,r.fieldMap=null,r.scaleExpression=null,r.scaleExpressionTitle=null,r.url=null,r.type="dictionary",r}var a;return r.__extends(t,e),a=t,t.prototype.writeData=function(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})},t.prototype.writeVisualVariables=function(t,r,i,s){(null==s?void 0:s.origin)||e.prototype.writeVisualVariables.call(this,t,r,i,s)},t.prototype.clone=function(){return new a({config:o.clone(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:o.clone(this.fieldMap),url:o.clone(this.url),visualVariables:o.clone(this.visualVariables)})},t.prototype.getSymbolAsync=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var s,n,o,a,l,u,p,f,y,d,m,_,g,b,v,w,x,S,M,R,E,P,V,j,C,T,q=this;return r.__generator(this,(function(r){switch(r.label){case 0:this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t)),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._dictionaryPromise];case 2:return s=r.sent(),[3,4];case 3:return n=r.sent(),c.isAbortError(n)?(this._dictionaryPromise=null,[2,null]):[3,4];case 4:if(o={},this.fieldMap)for(a=0,l=this._symbolFields;a<l.length;a++)u=l[a],(p=this.fieldMap[u])&&null!==e.attributes[p]&&void 0!==e.attributes[p]?(f=""+e.attributes[p],o[u]=f):o[u]="";if(!(y=s(o,t))||"string"!=typeof y)return[2,null];if(d=h.numericHash(y).toString(),m=this._symbolCache.get(d))return m.catch((function(){q._symbolCache.pop(d)})),[2,m];for(_=y.split(";"),g=[],b=[],v=0,w=_;v<w.length;v++)if((x=w[v])&&0!==x.length)if(-1===x.indexOf("po:"))if(-1!==x.indexOf("|"))for(V=0,j=x.split("|");V<j.length;V++)C=j[V],this._itemNames.has(C)&&g.push(C);else this._itemNames.has(x)&&g.push(x);else 3===(S=x.substr(3).split("|")).length&&(M=S[0],R=S[1],E=S[2],"DashTemplate"===R?E=E.split(" ").map((function(e){return Number(e)})):"Color"===R?(P=new i(E).toRgba(),E=[P[0],P[1],P[2],255*P[3]]):E=Number(E),b.push({primitiveName:M,propertyName:R,value:E}));return T=this._cimPartsToCIMSymbol(g,b,t),this._symbolCache.put(d,T,1),[2,T]}}))}))},t.prototype.collectRequiredFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.collectVVRequiredFields(e,t)];case 1:return r.sent(),this.scaleExpression?[4,y.collectArcadeFieldNames(e,t,this.scaleExpression)]:[3,3];case 2:r.sent(),r.label=3;case 3:for(s in i=t.map((function(e){return e.name})),this.fieldMap)i.indexOf(this.fieldMap[s])<0||e.add(this.fieldMap[s]);return[2]}}))}))},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return!0},enumerable:!1,configurable:!0}),t.prototype.fetchResources=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,a,l,h,f,y,d,m,g,v,w,x,S;return r.__generator(this,(function(M){switch(M.label){case 0:return this._dictionaryPromise?[2,this._dictionaryPromise]:this.url?(t=u.isSome(e)?e.abortOptions:null,i=s(this.url+"/resources/styles/dictionary-info.json",r.__assign({responseType:"json",query:{f:"json"}},t)),[4,c.all([i,_.loadArcade()])]):(b.error("no valid URL!"),[2,void 0]);case 1:if(!(o=M.sent()[0].data))throw this._dictionaryPromise=null,new n("esri.renderers.DictionaryRenderer","Bad dictionary data!");if(a=o.expression,l=o.authoringInfo,this._refSymbolUrlTemplate=this.url+"/"+o.cimRefTemplateUrl,this._itemNames=p.SetFromValues(o.itemsNames),this._symbolFields=l.symbol,h={},this.config)for(S in f=this.config)h[S]=f[S];for(y=0,d=l.configuration;y<d.length;y++)S=d[y],h.hasOwnProperty(S.name)||(h[S.name]=S.value);if(m=[],u.isSome(e)&&e.fields&&this.fieldMap)for(g=function(t){var i=v.fieldMap[t],s=e.fields.filter((function(e){return e.name===i}));s.length>0&&m.push(r.__assign(r.__assign({},s[0]),{name:t}))},v=this,w=0,x=this._symbolFields;w<x.length;w++)S=x[w],g(S);return this._dictionaryPromise=_.createDictionaryExpression(a,u.isSome(e)?e.spatialReference:null,m,h).then((function(e){var t={scale:0};return function(r,i){var s=e.repurposeFeature({geometry:null,attributes:r});return t.scale=u.isSome(i)?i.scale:void 0,e.evaluate({$feature:s,$view:t})}})).catch((function(e){return b.error("Creating dictinoary expression failed:",e),null})),[2,this._dictionaryPromise]}}))}))},t.prototype.getSymbol=function(){return null},t.prototype.getSymbols=function(){return[]},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((function(e,t){return e+t.getAttributeHash()}),"")},t.prototype.getMeshHash=function(){return this.url+"-"+JSON.stringify(this.fieldMap)},t.prototype.getSymbolFields=function(){return this._symbolFields},t.prototype._getSymbolPart=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o;return r.__generator(this,(function(a){switch(a.label){case 0:if(this._ongoingRequests.has(e))return[2,this._ongoingRequests.get(e).then((function(e){return e.data}))];i=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),n=s(i,r.__assign({responseType:"json",query:{f:"json"}},t)),this._ongoingRequests.set(e,n),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,n];case 2:return[2,a.sent().data];case 3:return o=a.sent(),this._ongoingRequests.delete(e),[2,c.reject(o)];case 4:return[2]}}))}))},t.prototype._combineSymbolParts=function(e,t){var i;if(!e||0===e.length)return null;if(1===e.length)return{type:"CIMSymbolReference",symbol:e[0],primitiveOverrides:t};var s=r.__assign({},e[0]);s.symbolLayers=[];for(var n=0,o=e;n<o.length;n++){var a=o[n];(i=s.symbolLayers).unshift.apply(i,a.symbolLayers)}return{type:"CIMSymbolReference",symbol:s,primitiveOverrides:t}},t.prototype._cimPartsToCIMSymbol=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var s,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:for(s=new Array(e.length),n=0;n<e.length;n++)s[n]=this._getSymbolPart(e[n],i);return[4,c.all(s)];case 1:return o=r.sent(),[2,new g({data:this._combineSymbolParts(o,t)})]}}))}))},r.__decorate([f.property({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],t.prototype,"config",void 0),r.__decorate([f.property({type:Object,json:{write:!0}})],t.prototype,"fieldMap",void 0),r.__decorate([f.property({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],t.prototype,"scaleExpression",void 0),r.__decorate([f.writer("scaleExpression")],t.prototype,"writeData",null),r.__decorate([f.property({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy:function(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],t.prototype,"scaleExpressionTitle",void 0),r.__decorate([f.property({type:String,json:{write:!0}})],t.prototype,"url",void 0),r.__decorate([f.writer("visualVariables")],t.prototype,"writeVisualVariables",null),t=a=r.__decorate([f.subclass("esri.renderers.DictionaryRenderer")],t)}(m.VisualVariablesMixin(d))}));