// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojox/gfx/_base","../kernel","../Color"],function(t,o,e,i,n,a,r){var s=Math.PI,l=t(null,{declaredClass:"esri.renderer.Renderer",constructor:function(t){if(this._ipDataCache={},t&&!t.declaredClass){if(this.rotationInfo=t.rotationInfo,!this.rotationInfo){var e=t.rotationType,i=t.rotationExpression;(e||i)&&(this.rotationInfo={type:e,expression:i})}this.setRotationInfo(this.rotationInfo),this.setSizeInfo(this._readSizeInfo(t.sizeInfo)),this.setColorInfo(this._readColorInfo(t.colorInfo)),this.setOpacityInfo(this._readOpacityInfo(t.transparencyInfo)),this.setVisualVariables(this._readVariables(t.visualVariables)),this.setAuthoringInfo(t.authoringInfo)}this.getSymbol=o.hitch(this,this.getSymbol)},getSymbol:function(){},_readSizeInfo:function(t){if(t){var o=t.minSize,e=t.maxSize;o&&"number"==typeof o&&(t.minSize=n.pt2px(o)),e&&"number"==typeof e&&(t.maxSize=n.pt2px(e))}return t},_readColorInfo:function(t){return t&&(e.forEach(t.colors,function(e,i){o.isArray(e)&&(t.colors[i]=r.toDojoColor(e))}),e.forEach(t.stops,function(e,i){e.color&&o.isArray(e.color)&&(t.stops[i].color=r.toDojoColor(e.color))})),t},_readOpacityInfo:function(t){var i;return t&&(i=o.mixin({},t),i.transparencyValues&&(i.opacityValues=e.map(i.transparencyValues,function(t){return 1-t/100}),delete i.transparencyValues),i.stops&&(i.stops=e.map(i.stops,function(t){return t=o.mixin({},t),t.opacity=1-t.transparency/100,delete t.transparency,t}))),i},_readVariables:function(t){return t&&(t=e.map(t,function(t){return"sizeInfo"===t.type?t=this._readSizeInfo(t):"colorInfo"===t.type?t=this._readColorInfo(t):"transparencyInfo"===t.type&&(t=this._readOpacityInfo(t),t.type="opacityInfo"),t},this)),t},setAuthoringInfo:function(t){this.authoringInfo=t},setRotationInfo:function(t){var e=this.rotationInfo="string"==typeof t?{field:t}:t;if(e){if(e.expression&&!o.isFunction(e.expression)&&!e.field){var i=e.expression.match(this.rotationRE);i&&i[1]&&(e.field=i[1])}e.rotationType=e.type}return this},rotationRE:/^\[([^\]]+)\]$/i,getRotationAngle:function(t,e){var i=this._getVarInfo(e&&e.rotationInfo,"rotationInfo"),n=i.variable,a="arithmetic"===this._getRotationType(n),r=n.field,s=t.attributes,l=0;return r&&(o.isFunction(r)?l=r.apply(this,arguments):s&&(l=s[r]||0),l=(l+(a?-90:0))*(a?-1:1)),l},_getRotationType:function(t){return t&&("rotationInfo"===t.type?t.rotationType:t.type)},setVisualVariables:function(t){var o=this._ipDataCache;e.forEach(this.visualVariables,function(t,e){o.hasOwnProperty(e)&&(o[e]=null)},this),this.visualVariables=t;var i=e.some(t,function(t){return!!t.target});return i&&t.sort(function(t,o){var e;return e=t.target===o.target?0:t.target?1:-1}),e.forEach(t,function(t,e){"colorInfo"===t.type?o[e]=this._processColorInfo(t):"opacityInfo"===t.type?o[e]=this._processOpacityInfo(t):"sizeInfo"===t.type&&(o[e]=this._processSizeInfo(t))},this),this},getVisualVariableValues:function(t){var o,i=this.visualVariables;return i&&(o=e.map(i,function(o){var e;switch(o.type){case"sizeInfo":e=this.getSize(t,{sizeInfo:o});break;case"colorInfo":e=this.getColor(t,{colorInfo:o});break;case"opacityInfo":e=this.getOpacity(t,{opacityInfo:o});break;case"rotationInfo":e=this.getRotationAngle(t,{rotationInfo:o})}return{variable:o,value:e}},this)),o},hasVisualVariables:function(t,o){return t?!!this.getVisualVariablesForType(t,o):!!(this.getVisualVariablesForType("sizeInfo",o)||this.getVisualVariablesForType("colorInfo",o)||this.getVisualVariablesForType("opacityInfo",o)||this.getVisualVariablesForType("rotationInfo",o))},getVisualVariablesForType:function(t,o){var i,n=this.visualVariables;return!o&&this[t]?("rotationInfo"===t&&(this[t].rotationType=this[t].type),i=[this[t]]):n&&(i=e.filter(n,function(e){return e.type===t&&("string"==typeof o?e.target===o:o===!1?!e.target:!0)}),i&&0===i.length&&(i=void 0)),i},setSizeInfo:function(t){return this.sizeInfo=this.proportionalSymbolInfo=t,this._ipDataCache.sizeInfo=this._processSizeInfo(t),this},_processSizeInfo:function(t){return t&&{root:this._interpolateData(t),minSize:this._interpolateData(t.minSize),maxSize:this._interpolateData(t.maxSize)}},_getVarInfo:function(t,o){var i;return t&&t.type===o?(i=e.indexOf(this.visualVariables,t),t=this.visualVariables[i]):(i=o,t=this[o]),{variable:t,cacheKey:i}},setProportionalSymbolInfo:function(t){return this.setSizeInfo(t),this},getSize:function(t,o){var e=this._getVarInfo(o&&o.sizeInfo,"sizeInfo"),i=e.variable,n=this._ipDataCache[e.cacheKey],a=null;if(i){var r=i.minSize,s=i.maxSize,l="object"==typeof r&&r?this._getSize(t,r,n&&n.minSize,o):r,c="object"==typeof s&&s?this._getSize(t,s,n&&n.maxSize,o):s;a=this._getSize(t,i,n&&n.root,o,[l,c])}return a},_getSize:function(t,e,i,n,a){var r=t.attributes,l=e.field,c=e.expression,f=e.stops,u=0,p="number"==typeof t,h=p?t:null;if(l||c){var y,I=n&&n.scale,m=a?a[0]:e.minSize,_=a?a[1]:e.maxSize,g=e.minDataValue,v=e.maxDataValue,z=e.valueUnit||"unknown",V=e.valueRepresentation,b=e.scaleBy,d=e.normalizationField,S=r?parseFloat(r[d]):void 0,C=n&&n.shape;if(c?h="view.scale"===c.toLowerCase()?I:null:"number"!=typeof h&&(o.isFunction(l)?h=l.apply(this,arguments):r&&(h=r[l])),null==h||d&&!p&&(isNaN(S)||0===S))return null;if(isNaN(S)||p||(h/=S),f){var x,O,D=this._lookupData(h,i),w=D[0],j=D[1];w===j?u=f[w].size:(x=f[w].size,O=f[j].size,u=x+(O-x)*D[2])}else if(null!=m&&null!=_&&null!=g&&null!=v)if(g>=h)u=m;else if(h>=v)u=_;else if(y=(h-g)/(v-g),"area"===b&&C){var F="circle"===C,T=F?s*Math.pow(m/2,2):m*m,R=F?s*Math.pow(_/2,2):_*_,k=T+y*(R-T);u=F?2*Math.sqrt(k/s):Math.sqrt(k)}else u=m+y*(_-m);else if("unknown"===z)null!=m&&null!=g&&(m&&g?(y=h/g,u="circle"===C?2*Math.sqrt(y*Math.pow(m/2,2)):"square"===C||"diamond"===C||"image"===C?Math.sqrt(y*Math.pow(m,2)):y*m):u=h+(m||g),u=m>u?m:u,null!=_&&u>_&&(u=_));else{var E=(n&&n.resolution?n.resolution:1)*this._meterIn[z];"area"===V?(u=Math.sqrt(h/s)/E,u*=2):(u=h/E,("radius"===V||"distance"===V)&&(u*=2)),null!=m&&m>u&&(u=m),null!=_&&u>_&&(u=_)}}else u=f&&f[0]&&f[0].size,null==u&&(u=e.minSize);return u=isNaN(u)?0:u},getSizeRangeAtScale:function(t,o){var e,i=this._getVarInfo(t,"sizeInfo"),n=this._ipDataCache[i.cacheKey],a={scale:o};if(t=i.variable,t&&o){var r=t.minSize,s=t.maxSize,l="object"==typeof r&&r?this._getSize({},r,n&&n.minSize,a):r,c="object"==typeof s&&s?this._getSize({},s,n&&n.maxSize,a):s;(null!=l||null!=c)&&(e={minSize:l,maxSize:c})}return e},setColorInfo:function(t){return this.colorInfo=t,this._ipDataCache.colorInfo=this._processColorInfo(t),this},_processColorInfo:function(t){return t&&(e.forEach(t.colors,function(e,i){o.isArray(e)&&(t.colors[i]=new r(e))}),e.forEach(t.stops,function(e,i){e.color&&o.isArray(e.color)&&(t.stops[i].color=new r(e.color))})),this._interpolateData(t)},getColor:function(t,o){var e=this._getVarInfo(o&&o.colorInfo,"colorInfo");return this._getColorComponent(t,e.variable,this._ipDataCache[e.cacheKey])},setOpacityInfo:function(t){return this.opacityInfo=t,this._ipDataCache.opacityInfo=this._processOpacityInfo(t),this},_processOpacityInfo:function(t){return this._interpolateData(t)},getOpacity:function(t,o){var e=this._getVarInfo(o&&o.opacityInfo,"opacityInfo");return this._getColorComponent(t,e.variable,this._ipDataCache[e.cacheKey],!0)},_getColorComponent:function(t,e,i,n,a){var r,s=t.attributes,l=e&&e.field,c="number"==typeof t,f=c?t:null;if(l){var u=e.normalizationField,p=s?parseFloat(s[u]):void 0;"number"!=typeof f&&(o.isFunction(l)?f=l.apply(this,arguments):s&&(f=s[l])),null==f||u&&!c&&(isNaN(p)||0===p)||(isNaN(p)||c||(f/=p),r=n?this._getOpacity(f,e,i):this._getColor(f,e,i))}else if(e){var h=e.stops;n?(r=h&&h[0]&&h[0].opacity,null==r&&(r=e.opacityValues&&e.opacityValues[0])):r=h&&h[0]&&h[0].color||e.colors&&e.colors[0]}return a&&(a.data=f,a.value=r),a||r},_interpolateData:function(t){var o;if(t)if(t.colors||t.opacityValues){var i,n=(t.colors||t.opacityValues).length,a=t.minDataValue,r=(t.maxDataValue-a)/(n-1);for(o=[],i=0;n>i;i++)o[i]=a+i*r}else t.stops&&(o=e.map(t.stops,function(t){return t.value}));return o},_getOpacity:function(t,o,e){var i,n=this._lookupData(t,e);if(o=o||this.opacityInfo,n){var a,r,s=n[0],l=n[1];s===l?i=this._getOpacValue(o,s):(a=this._getOpacValue(o,s),r=this._getOpacValue(o,l),i=a+(r-a)*n[2])}return i},_getOpacValue:function(t,o){return t.opacityValues?t.opacityValues[o]:t.stops[o].opacity},_getColor:function(t,o,e){var i,n=this._lookupData(t,e);if(o=o||this.colorInfo,n){var a=n[0],s=n[1];i=a===s?this._getColorObj(o,a):r.blendColors(this._getColorObj(o,a),this._getColorObj(o,s),n[2])}return i},_getColorObj:function(t,o){return t.colors?t.colors[o]:t.stops[o].color},_lookupData:function(t,o){var i;if(o){var n=0,a=o.length-1;e.some(o,function(o,e){return o>t?(a=e,!0):(n=e,!1)}),i=[n,a,(t-o[n])/(o[a]-o[n])]}return i},_meterIn:{inches:39.3701,feet:3.28084,yards:1.09361,miles:621371e-9,"nautical-miles":539957e-9,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_writeSizeInfo:function(t){if(t){t=o.mixin({},t);var e=t.minSize,i=t.maxSize;e&&(t.minSize="number"==typeof e?n.px2pt(e):o.clone(e)),i&&(t.maxSize="number"==typeof i?n.px2pt(i):o.clone(i));var a=t.legendOptions;a&&(t.legendOptions=o.mixin({},a),a=a.customValues,a&&(t.legendOptions.customValues=a.slice(0)))}return t},_writeColorInfo:function(t){return t&&(t=o.mixin({},t),t.colors&&(t.colors=e.map(t.colors,function(t){return r.toJsonColor(t)})),t.stops&&(t.stops=e.map(t.stops,function(t){return t=o.mixin({},t),t.color&&(t.color=r.toJsonColor(t.color)),t}))),t},_writeOpacityInfo:function(t){var i;return t&&(i=o.mixin({},t),i.opacityValues&&(i.transparencyValues=e.map(i.opacityValues,function(t){return 100*(1-t)}),delete i.opacityValues),i.stops&&(i.stops=e.map(i.stops,function(t){return t=o.mixin({},t),t.transparency=100*(1-t.opacity),delete t.opacity,t}))),i},toJson:function(){var t=this.visualVariables,i=o.clone(this.authoringInfo),n=this.getVisualVariablesForType("rotationInfo",!1),a=n&&n[0],r=a&&a.field,s=a&&(a.expression||r&&(o.isFunction(r)?r:"["+r+"]"));return t&&(t=e.map(t,function(t){return"sizeInfo"===t.type?t=this._writeSizeInfo(t):"colorInfo"===t.type?t=this._writeColorInfo(t):"opacityInfo"===t.type?(t=this._writeOpacityInfo(t),t.type="transparencyInfo"):"rotationInfo"===t.type&&(t=o.mixin({},t)),t},this)),i&&e.forEach(i.visualVariables,function(t){"opacityInfo"===t.type&&(t.type="transparencyInfo")}),{rotationType:s&&(this._getRotationType(a)||"geographic"),rotationExpression:s,colorInfo:this._writeColorInfo(this.colorInfo),transparencyInfo:this._writeOpacityInfo(this.opacityInfo),sizeInfo:this._writeSizeInfo(this.sizeInfo),visualVariables:t,authoringInfo:i}}});return i("extend-esri")&&o.setObject("renderer.Renderer",l,a),l});