// COPYRIGHT © 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/array","dojo/has","dojo/date/locale","../kernel","../numberUtils","../Color","dojo/i18n!dojo/cldr/nls/gregorian"],(function(e,t,n,a,o,i,r,s){var l={},u="<",m=">",c="%",d={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},p={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},f={dateOptions:{formatLength:"short",fullYear:!0},timeOptions:{formatLength:"short"}};function g(e,t,n){var a="";return 0===t?a=u+" ":t===n&&(a=m+" "),a+e}return e.mixin(l,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(n,o){var i=[];null==n||n instanceof Date||(n=new Date(n)),o=o||{};var r=(o=e.mixin({},o)).selector?o.selector.toLowerCase():null,l=!r||r.indexOf("time")>-1,u=!r||r.indexOf("date")>-1;return l&&(o.timeOptions=o.timeOptions||f.timeOptions,o.timeOptions&&(o.timeOptions=e.mixin({},o.timeOptions),o.timeOptions.selector=o.timeOptions.selector||"time",i.push(o.timeOptions))),u&&(o.dateOptions=o.dateOptions||f.dateOptions,o.dateOptions&&(o.dateOptions=e.mixin({},o.dateOptions),o.dateOptions.selector=o.dateOptions.selector||"date",i.push(o.dateOptions))),i&&i.length?1==(i=t.map(i,(function(e){return a.format(n,e)}))).length?i[0]:s["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,(function(e,t){return i[t]})):a.format(n)},createColorStops:function(e){var n=e.values,a=e.colors,o=e.labelIndexes,r=e.isDate,s=e.dateFormatOptions;return t.map(n,(function(e,u){var m,c=null;(!o||t.indexOf(o,u)>-1)&&((m=r?l.formatDate(e,s):i.format(e))&&(c=g(m,u,n.length-1)));return{value:e,color:a[u],label:c}}))},updateColorStops:function(e){var n,a=e.stops,o=e.changes,r=e.isDate,s=e.dateFormatOptions,u=[],m=t.map(a,(function(e){return e.value}));t.forEach(o,(function(e){u.push(e.index),m[e.index]=e.value})),n=i.round(m,{indexes:u}),t.forEach(a,(function(e,t){if(e.value=m[t],null!=e.label){var o,u=null;(o=r?l.formatDate(n[t],s):i.format(n[t]))&&(u=g(o,t,a.length-1)),e.label=u}}))},createClassBreakLabel:function(e){var t=e.minValue,n=e.maxValue,a=e.isFirstBreak,o="percent-of-total"===e.normalizationType?c:"";return(a?"":m+" ")+(t=null==t?"":i.format(t))+o+" – "+(n=null==n?"":i.format(n))+o},setLabelsForClassBreaks:function(e){var n=e.classBreaks,a=e.classificationMethod,o=e.normalizationType,r=[];n&&n.length&&("standard-deviation"===a?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):e.round?(r.push(n[0].minValue),t.forEach(n,(function(e){r.push(e.maxValue)})),r=i.round(r),t.forEach(n,(function(e,t){e.label=l.createClassBreakLabel({minValue:0===t?r[0]:r[t],maxValue:r[t+1],isFirstBreak:0===t,normalizationType:o})}))):t.forEach(n,(function(e,t){e.label=l.createClassBreakLabel({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:o})})))},updateClassBreak:function(e){var t,n=e.classBreaks,a=e.classificationMethod,o=e.normalizationType,i=e.change,r=i.index,s=i.value,u=-1,m=-1,c=n.length;"standard-deviation"!==a?(0===r?u=r:r===c?m=r-1:(m=r-1,u=r),u>-1&&u<c&&((t=n[u]).minValue=s,t.label=l.createClassBreakLabel({minValue:t.minValue,maxValue:t.maxValue,isFirstBreak:0===u,normalizationType:o})),m>-1&&m<c&&((t=n[m]).maxValue=s,t.label=l.createClassBreakLabel({minValue:t.minValue,maxValue:t.maxValue,isFirstBreak:0===m,normalizationType:o}))):console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method.")},calculateDateFormatInterval:function(e){var n,a,o,i,r,s,l,u,m,c,p=e.length,f=1/0;for(e=t.map(e,(function(e){return new Date(e)})),n=0;n<p-1;n++){for(o=e[n],r=[],u=1/0,m="",a=n+1;a<p;a++)i=e[a],s=(o.getFullYear()!==i.getFullYear()?"year":o.getMonth()!==i.getMonth()&&"month")||o.getDate()!==i.getDate()&&"day"||o.getHours()!==i.getHours()&&"hour"||o.getMinutes()!==i.getMinutes()&&"minute"||o.getSeconds()!==i.getSeconds()&&"second"||"millisecond",(l=d[s])<u&&(u=l,m=s),r.push(s);u<f&&(f=u,c=m)}return c},createUniqueValueLabel:function(e){var t=e.value,n=e.fieldInfo,a=e.domain,o=e.dateFormatInterval,r=String(t),s=a&&a.codedValues?a.getName(t):null;return s?r=s:"number"==typeof t&&(r=n&&"esriFieldTypeDate"===n.type?l.formatDate(t,o&&p[o]):i.format(t)),r},cloneColorInfo:function(n){var a,o;return n&&((a=e.mixin({},n)).colors=(o=a.colors)&&t.map(o,(function(e){return new r(e)})),a.stops=a.stops&&t.map(a.stops,(function(t){return(t=e.mixin({},t)).color&&(t.color=new r(t.color)),t})),a.legendOptions&&(a.legendOptions=e.mixin({},a.legendOptions))),a},cloneOpacityInfo:function(n){var a;if(n){var o=(a=e.mixin({},n)).opacityValues;o&&(a.opacityValues=o.slice(0)),(o=a.stops)&&(a.stops=t.map(o,(function(t){return e.mixin({},t)}))),(o=a.legendOptions)&&(a.legendOptions=e.mixin({},o))}return a},cloneSizeInfo:function(n){var a;if(n){(a=e.mixin({},n)).stops&&(a.stops=t.map(a.stops,(function(t){return e.mixin({},t)})));var o=a.minSize;o&&"object"==typeof o&&(a.minSize=l.cloneSizeInfo(o)),(o=a.maxSize)&&"object"==typeof o&&(a.maxSize=l.cloneSizeInfo(o)),(o=a.legendOptions)&&(a.legendOptions=e.mixin({},o),(o=o.customValues)&&(a.legendOptions.customValues=o.slice(0)))}return a},getClassCodesForRelationship:function(){return e.clone({2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return e.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}}),n("extend-esri")&&e.setObject("renderer.utils",l,o),l}));