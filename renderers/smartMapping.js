// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["require","module","dojo/_base/array","dojo/_base/lang","dojo/has","dojo/Deferred","dojo/DeferredList","dojo/promise/all","dojo/when","../kernel","../Color","../numberUtils","../styles/type","../styles/size","../styles/choropleth","../styles/heatmap","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","./UniqueValueRenderer","./ClassBreaksRenderer","./HeatmapRenderer","./BlendRenderer","./utils","dojo/i18n!../nls/jsapi"],function(e,a,t,n,r,i,l,o,s,u,c,m,d,p,f,h,g,y,v,b,w,S,z,V,C){function M(t){return e.toAbsMid?e.toAbsMid(t):a.id.replace(/\/[^\/]*$/gi,"/")+t}function x(e,a){e.reject(new Error(a))}function R(e,a,t,n){var r,i;switch(t){case"point":r=new g,r.setColor(a),r.setSize(null!=n?n:e.size),i=new y,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i);break;case"line":r=new y,r.setColor(a),r.setWidth(null!=n?n:e.width);break;case"polygon":r=new v,r.setColor(a),i=new y,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i)}return r}function k(e){var a=e.geometryType;return"esriGeometryPoint"===a||"esriGeometryMultipoint"===a?a="point":"esriGeometryPolyline"===a?a="line":"esriGeometryPolygon"===a&&(a="polygon"),a}function I(e,a){var t=e.scheme;return t?t=d.cloneScheme(t):(t=d.getSchemes({theme:e.theme||ra,basemap:e.basemap,geometryType:a}),t=t&&t.primaryScheme),t}function F(e,a){var t;return t=e.label<a.label?-1:e.label>a.label?1:0}function O(e,a){var t;return t=e.value<a.value?-1:e.value>a.value?1:0}function D(e,a){var t=a.count-e.count;return 0===t&&(t=F(e,a)),t}function T(e,a){var t=a.count-e.count;return 0===t&&(t=O(e,a)),t}function P(e,a,t){var n;"count"===a?(n=T,t&&t.codedValues&&(n=D)):"value"===a&&(n=O,t&&t.codedValues&&(n=F)),n&&e.sort(n)}function B(e,a,n,r){var i,l,o,s,u=e.uniqueValueInfos,c=n.layer,m=n.field,d=c.getField(m),p=c.getDomain(d.name),f=-1,h=null==n.numTypes?10:-1===n.numTypes?u.length:n.numTypes,g=null==n.showOthers?!0:n.showOthers,y=null==n.sortBy?"count":n.sortBy,v=n&&n.labelCallback,w=k(c),S=I(n,w),z=new b(null,m),C={domain:p,fieldInfo:d};for(t.forEach(u,function(e,a){C.value=e.value,e.label=V.createUniqueValueLabel(C),v&&(e.label=v(e)),null===e.value&&(f=a)}),f>-1&&(s=u.splice(f,1)[0]),P(u,y,p),C.dateFormatInterval=V.calculateDateFormatInterval(t.map(t.filter(u,function(e,a){return h>a}),function(e){return e.value})),o=aa.createColors(S.colors,u.length),t.forEach(u,function(e,a){C.value=e.value,e.label=V.createUniqueValueLabel(C),v&&(e.label=v(e)),e.symbol=R(S,o[a],w)}),o=aa.createColors(S.colors,h),i=0;h>i;i++)l=u[i],l&&z.addValue({value:l.value,label:l.label,symbol:R(S,o[i],w)});g&&(z.defaultSymbol=R(S,S.noDataColor,w),z.defaultLabel=na.other),s&&(s.symbol=R(S,S.noDataColor,w),u.push(s)),a&&a.widthInfo&&z.setVisualVariables([a.widthInfo]),r.resolve({renderer:z,uniqueValueInfos:u,source:e.source,othersStartIndex:z.infos.length===u.length?-1:z.infos.length,scheme:I(n,w)})}function j(e,a,t){var n=e.scheme;return n?n=f.cloneScheme(n):(n=f.getSchemes({theme:t||e.theme||ia,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function q(e){var a,t=e.avg,n=t-e.stddev,r=t+e.stddev;return n<e.min&&(n=e.min),r>e.max&&(r=e.max),a=m.round([n,r]),n=a[0],r=a[1],a=[n,n+(t-n)/2,t,t+(r-t)/2,r],m.round(a)}function L(e,a,t){var n,r=(a-e)/(t-1),i=[e];for(n=1;t-2>=n;n++)i.push(e+n*r);return i.push(a),m.round(i)}function H(e,a){var t,n;return null==e.min?(t=0,n=100):e.min===e.max?e.min<0?(t=2*e.min,n=0):e.min>0?(t=0,n=2*e.min):(t=0,n=100):!a||null!=e.avg&&null!=e.stddev||(t=e.min,n=e.max),null!=t?[t,n]:null}function E(e,a,n,r,i,l,o){var s=null==l.useDefaultStatistics?!0:l.useDefaultStatistics;if(e&&!e.count&&!s)return void x(o,"smartMapping.createColorRenderer: cannot create renderer when statistics.count is 0.");var u,d,p,f=l.layer,h=l.field,g=k(f),y=null==l.showOthers?!0:l.showOthers,v=j(l,g),b=l.semiContinuous,S=a&&a.classBreakInfos,z=S&&S.length,C=a?z:5;if(!v)return void x(o,"smartMapping.createColorRenderer: unable to find the specified scheme.");var M=a&&v.id.indexOf("seq-")>-1?J(v,{length:C}):aa.createColors(v.colors,C);if(M.length<C)return void x(o,"smartMapping.createColorRenderer: not enough colors in the scheme.");var I=new w(null,h);if(y&&(I.defaultSymbol=R(v,v.noDataColor,g),I.defaultLabel=na.other),I.addBreak({minValue:-ta,maxValue:ta,symbol:R(v,v.noDataColor,g)}),a){u=[];var F;1===z?(d=[S[0].minValue,S[0].maxValue],u=[0,1],F=aa.createColors(M,C)[0],p=[F,new c(F)]):b?(d=[],p=[],t.forEach(S,function(e,a){var t=e.maxValue-e.minValue,n=.1*t;d.push(0===a?e.minValue:e.minValue+n),d.push(a===z-1?e.maxValue:e.maxValue-n),F=new c(M[a]),p.push(F),p.push(new c(F)),u.push(2*a),u.push(2*a+1)})):(d=t.map(S,function(e,a){return u.push(a),(e.minValue+e.maxValue)/2}),p=aa.createColors(M,C)),d=m.round(d)}else{var O=s?H(e,!0):null;d=O?L(O[0],O[1],5):q(e),u=[0,2,4],p=aa.createColors(M,C)}I.normalizationType=r,I.normalizationField=i;var D=[{type:"colorInfo",field:h,normalizationField:i,stops:V.createColorStops({values:d,colors:p,labelIndexes:u})}];n&&n.widthInfo&&D.push(n.widthInfo),I.setVisualVariables(D),o.resolve({renderer:I,statistics:e,classBreaks:a,scheme:j(l,g)})}function U(e,a,t,n){var r=null==t.useDefaultStatistics?!0:t.useDefaultStatistics;if(e&&!e.count&&!r)return void x(n,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");var i=t.useStdDev,l=i?q(e):null,o=r?H(e,i):null,s=o||(i?[l[0],l[4]]:[e.min,e.max]),u={type:"opacityInfo",field:t.field,normalizationField:a,stops:[{value:s[0],opacity:.3},{value:s[1],opacity:.7}]};n.resolve({opacityInfo:u,statistics:e,defaultStatistics:!!o})}function W(e,a){var t=e.scheme;return t?t=p.cloneScheme(t):(t=p.getSchemes({theme:e.theme||la,basemap:e.basemap,geometryType:a}),t=t&&t.primaryScheme),t}function A(e,a){var t;switch(a){case"point":t=[e.minSize,e.maxSize];break;case"line":t=[e.minWidth,e.maxWidth];break;case"polygon":t=[e.marker.minSize,e.marker.maxSize]}return t}function G(e,a,t,n,r,i,l){var o=null==i.useDefaultStatistics?!0:i.useDefaultStatistics,s=a&&[a.minSize,a.maxSize];if(e&&!e.count&&!o)return void x(l,"smartMapping.createSizeRenderer: cannot create renderer when statistics.count is 0.");var u=i.layer,c=i.field,m=k(u),d=null==i.showOthers?!0:i.showOthers,p=W(i,m),f=s||A(p,m),h="polygon"===m,g=h?p.marker:p,y=h?p.background:null,v="line"===m?g.noDataWidth:g.noDataSize,b=i.useStdDev,S=b?q(e):null,z=o?H(e,b):null,V=z||(b?[S[0],S[4]]:[e.min,e.max]),C=new w(null,c);d&&(C.defaultSymbol=R(g,g.noDataColor,h?"point":m,v),C.defaultLabel=na.other),C.addBreak({minValue:-ta,maxValue:ta,symbol:R(g,g.color,h?"point":m)}),y&&(C.backgroundFillSymbol=R(y,y.color,m)),C.normalizationType=n,C.normalizationField=r;var M=[{type:"sizeInfo",field:c,valueUnit:"unknown",normalizationField:r,minSize:f[0],maxSize:f[1],minDataValue:V[0],maxDataValue:V[1]}];t&&t.widthInfo&&M.push(t.widthInfo),C.setVisualVariables(M),l.resolve({renderer:C,statistics:e,defaultStatistics:!!z,suggestedSizeRange:a,scheme:W(i,m)})}function _(e,a,t){var n,r=[],i=1/(t+1);for(n=1;t>=n;n++)r.push(c.blendColors(e,a,i*n));return r}function $(e,a){var t=[];if(1===a)t=[e[0]];else if(2===a)t=[e[0],e[2]];else if(3===a)t=e;else{var n,r,i=a-e.length,l=i/2;i%2===0?(n=_(e[0],e[1],l),r=_(e[1],e[2],l)):(n=_(e[0],e[1],Math.floor(l)),r=_(e[1],e[2],Math.ceil(l))),t=[e[0]].concat(n).concat([e[1]]).concat(r).concat([e[2]])}return t}function J(e,a,n){var r,i=a.length,l=-1;if(n&&t.some(a,function(e,a){return e.hasAvg&&(l=a),l>-1}),l>-1){var o=e.colors,s=l+1,u=i-l,c=o.slice(0,3),m=o.slice(2);c.reverse(),c=$(c,s),m=$(m,u),c.reverse(),r=[].concat(c).concat(m.slice(1))}else{var d=e.colorsForClassBreaks;if(d&&d.length>0&&(t.some(d,function(e){return e.numClasses===i&&(r=e.colors),!!r}),!r)){var p=d[d.length-1],f=i-p.numClasses;if(f>0){var h,g=p.colors[p.numClasses-1];for(r=p.colors.splice(0),h=1;f>=h;h++)r.push(g)}}}return r&&(r=aa.createColors(r,r.length)),r}function K(e,a,n,r){var i,l,o,s=n.layer,u=n.field,c=k(s),m=null==n.showOthers?!0:n.showOthers,d=n.classificationMethod||"equal-interval",p="standard-deviation"===d,f=n.normalizationType,h="high-to-low",g=e.classBreakInfos;return(i=j(n,c,h))?(l=J(i,g),l&&l.length==g.length?(o=new w(null,u),o.classificationMethod=d,o.normalizationType=f,o.normalizationField="field"===f?n.normalizationField:void 0,o.normalizationTotal="percent-of-total"===f?e.normalizationTotal:void 0,m&&(o.defaultSymbol=R(i,i.noDataColor,c),o.defaultLabel=na.other),t.forEach(g,function(e,a){o.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:R(i,l[a],c),label:e.label})}),p||V.setLabelsForClassBreaks({classBreaks:o.infos,classificationMethod:d,normalizationType:f,round:!0}),a&&a.widthInfo&&o.setVisualVariables([a.widthInfo]),e.renderer=o,e.scheme=j(n,c,h),void r.resolve(e)):void x(r,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes.")):void x(r,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function N(e,a){return a.layer.statisticsPlugin.getClassBreaks(n.mixin(a,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:e[0],maxValue:e[1],normalizationTotal:e[0]+e[1]}))}function Q(e){var a=new i,t=e.layer,n=null==e.useDefaultBreaks?!0:e.useDefaultBreaks,r=e.optimizeOutline,o=[t.statisticsPlugin.getClassBreaks(e)];return r&&o.push(t.statisticsPlugin.getSuggestedOutline("object"==typeof r?r:null)),new l(o).then(function(i){var l=i[0],o=i[1],u=r&&o[0]?o[1]:null;if(l[0]||n&&!t.graphics.length){var c=l[1],m=n?H(c?{min:c.minValue,max:c.maxValue}:{}):null;m&&(c=N(m,e)),s(c).then(function(e){e.defaultStatistics=!!m,a.resolve({cbResponse:e,suggestedOutline:u})}).otherwise(function(){x(a,"smartMapping: error when calculating default class breaks.")})}else x(a,"smartMapping: error when calculating class breaks.")}),a.promise}function X(e,a,t,n){var r,i=n||A(e,a),l=i[0],o=i[1],s=(o-l)/(t>=4?t-1:t),u=[];for(r=0;t>r;r++)u.push(l+s*r);return u}function Y(e,a,n,r,i){var l,o=r.layer,s=r.field,u=k(o),c=null==r.showOthers?!0:r.showOthers,m=r.classificationMethod||"equal-interval",d=r.normalizationType,p=e.classBreakInfos,f=W(r,u),h=X(f,u,p.length,a),g="polygon"===u,y=g?f.marker:f,v=g?f.background:null;l=new w(null,s),l.classificationMethod=m,l.normalizationType=d,l.normalizationField="field"===d?r.normalizationField:void 0,l.normalizationTotal="percent-of-total"===d?e.normalizationTotal:void 0,c&&(l.defaultSymbol=R(y,y.noDataColor,g?"point":u),l.defaultLabel=na.other),v&&(l.backgroundFillSymbol=R(v,v.color,u)),t.forEach(p,function(e,a){l.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:R(y,y.color,g?"point":u,h[a]),label:e.label})}),"standard-deviation"!==m&&V.setLabelsForClassBreaks({classBreaks:l.infos,classificationMethod:m,normalizationType:d,round:!0}),n&&n.widthInfo&&l.setVisualVariables([n.widthInfo]),e.renderer=l,e.scheme=W(r,u),i.resolve(e)}function Z(e){var a=e.scheme;return a?a=h.cloneScheme(a):(a=h.getSchemes({theme:e.theme||oa,basemap:e.basemap}),a=a&&a.primaryScheme),a}function ea(e,a,n){var r=null==a.useDefaultStatistics?!0:a.useDefaultStatistics;if(!e.count&&!r)return void x(n,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");var i=e.fieldOffset,l=null==a.blurRadius?10:a.blurRadius,o=null==a.minRatio?.01:a.minRatio,s=null==a.maxRatio?1:a.maxRatio,u=null==a.fadeToTransparent?!0:a.fadeToTransparent,m=Z(a),d=m.colors,p=d.length,f=!e.count&&r,h=f?[0,100]:[e.min,e.max],g=new S;g.setBlurRadius(l),g.setField(a.field),null!=i&&g.setFieldOffset(i),g.setMinPixelIntensity(h[0]),g.setMaxPixelIntensity(h[1]);var y=d[0],v=[{ratio:0,color:new c([y.r,y.g,y.b,0])},{ratio:sa,color:new c([y.r,y.g,y.b,0])},{ratio:u?o:sa,color:y}],b=(s-o)/(p-1);d=aa.createColors(d,p),t.forEach(d,function(e,a){v.push({ratio:o+b*a,color:e})}),g.setColorStops(v),n.resolve({renderer:g,statistics:e,defaultStatistics:f,scheme:Z(a)})}var aa={},ta=Math.pow(2,53)-1,na=C.smartMapping,ra="default",ia="high-to-low",la="default",oa="default",sa=.01,ua=M("../plugins/FeatureLayerStatistics");return n.mixin(aa,{createColors:function(e,a){var t,n=[],r=e.length;for(t=0;a>t;t++)n.push(new c(e[t%r]));return n},createTypeRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field&&(e.scheme||e.basemap)))return x(a,"smartMapping.createTypeRenderer: missing parameters."),a.promise;var t=e.layer,n=e.optimizeOutline;return t.addPlugin(ua).then(function(){var r=[t.statisticsPlugin.getUniqueValues({field:e.field,includeAllCodedValues:e.includeAllCodedValues})];n&&r.push(t.statisticsPlugin.getSuggestedOutline("object"==typeof n?n:null)),new l(r).then(function(t){var r=t[0],i=t[1],l=n&&i[0]?i[1]:null;r[0]?B(r[1],l,e,a):x(a,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(){x(a,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createColorRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field))return x(a,"smartMapping.createColorRenderer: missing parameters."),a.promise;var t=e.layer,n=e.normalizationField,r=n?"field":void 0,o=e.optimizeOutline;return e.statistics?E(e.statistics,null,null,r,n,e,a):t.addPlugin(ua).then(function(){var i="group-similar"===e.theme||e.scheme&&0===e.scheme.id.indexOf("group-similar/"),s=i?t.statisticsPlugin.getClassBreaks({field:e.field,classificationMethod:"natural-breaks",numClasses:e.numGroups||5,normalizationType:r,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}):t.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}),u=[s];o&&u.push(t.statisticsPlugin.getSuggestedOutline("object"==typeof o?o:null)),new l(u).then(function(t){var l,s,u=t[0],c=t[1],m=o&&c[0]?c[1]:null;u[0]?(i?l=u[1]:s=u[1],E(s,l,m,r,n,e,a)):x(a,i?"smartMapping.createColorRenderer: error when calculating class breaks.":"smartMapping.createColorRenderer: error when calculating field statistics.")})}).otherwise(function(){x(a,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")}),a.promise},createOpacityInfo:function(e){var a=new i;if(!(e&&e.layer&&e.field))return x(a,"smartMapping.createOpacityInfo: missing parameters."),a.promise;var t=e.layer,n=e.normalizationField,r=n?"field":void 0;return e.statistics?U(e.statistics,n,e,a):t.addPlugin(ua).then(function(){t.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue}).then(function(t){U(t,n,e,a)}).otherwise(function(){x(a,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(){x(a,"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")}),a.promise},createBlendRenderer:function(e){var a,n,r=new i,l=this,s=[],u={},m=[],d=[],p=e.opacityValueCombinationMethod||"avg",f={};return e&&e.layer&&e.blendedFields?(e.basemap=e.basemap||"topo",n=k(e.layer),a=I({basemap:e.basemap},n),a.colors=[new c("#e60000"),new c("#0000e6"),new c("#00e600"),new c("#e67300"),new c("#a900e6")],f.fields=[],f.normalizationField=e.normalizationField,f.blendMode=e.blendMode||"source-over",f.symbol=R(a,a.noDataColor,e.markers?"point":n),u.layer=e.layer,u.normalizationField=e.normalizationField,u.useStdDev=e.useStdDev||!1,s=t.map(e.blendedFields,function(e,t){return f.fields.push({field:e,color:a.colors[t]}),u.field=e,l.createOpacityInfo(u)}),o(s).then(function(n){d[0]=n[0].opacityInfo.stops[0].value,d[1]=n[1].opacityInfo.stops[1].value,t.forEach(n.slice(0,1),function(e){var a=e.opacityInfo.stops[0].value,t=e.opacityInfo.stops[1].value;"union"===p?(d[0]=a<d[0]?a:d[0],d[1]=t>d[1]?t:d[1]):"avg"===p&&(d[0]+=e.opacityInfo.stops[0].value,d[1]+=e.opacityInfo.stops[1].value)}),m[0]={value:"avg"===p?d[0]/n.length:d[0],opacity:e.minOpacity?e.minOpacity:n[0].opacityInfo.stops[0].opacity},m[1]={value:"avg"===p?d[1]/n.length:d[1],opacity:e.maxOpacity?e.maxOpacity:n[0].opacityInfo.stops[1].opacity},f.opacityStops=m,r.resolve({renderer:new z(f),scheme:a,opacityInfos:n})}),r.promise):(x(r,"smartMapping.createBlendRenderer: missing parameters."),r.promise)},createSizeRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field))return x(a,"smartMapping.createSizeRenderer: missing parameters."),a.promise;var t=e.layer,n=e.normalizationField,r=n?"field":void 0,o=e.optimizeForScale,s=e.optimizeOutline;return e.statistics?G(e.statistics,null,null,r,n,e,a):t.addPlugin(ua).then(function(){var i=[t.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:n,minValue:e.minValue,maxValue:e.maxValue})];o&&i.push(t.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:o===!0?"map-scale":o})),s&&i.push(t.statisticsPlugin.getSuggestedOutline("object"==typeof s?s:null)),new l(i).then(function(t){var i=t[0],l=o&&t[1],u=o&&l[0]?l[1]:null,c=o?t[2]:t[1],m=s&&c[0]?c[1]:null;i[0]?G(i[1],u,m,r,n,e,a):x(a,"smartMapping.createSizeRenderer: error when calculating field statistics.")})}).otherwise(function(){x(a,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createClassedColorRenderer:function(e){var a,t=new i,r=e.minValue,l=e.maxValue;if(!(e&&e.layer&&e.field))return x(t,"smartMapping.createClassedColorRenderer: missing parameters."),t.promise;if(a=null!=r&&null!=l,!a&&(null!=r||null!=l))return x(t,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),t.promise;e=n.mixin({analyzeData:!a},e);var o=e.layer;return o.addPlugin(ua).then(function(){Q(e).then(function(a){K(a.cbResponse,a.suggestedOutline,e,t)}).otherwise(function(){x(t,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(){x(t,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")}),t.promise},createClassedSizeRenderer:function(e){var a,t=new i,r=e.minValue,l=e.maxValue;if(!(e&&e.layer&&e.field))return x(t,"smartMapping.createClassedSizeRenderer: missing parameters."),t.promise;if(a=null!=r&&null!=l,!a&&(null!=r||null!=l))return x(t,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),t.promise;e=n.mixin({analyzeData:!a},e);var o=e.layer;return o.addPlugin(ua).then(function(){Q(e).then(function(a){e.optimizeForScale?o.statisticsPlugin.getSuggestedSizeRange().then(function(n){var r=[n.minSize,n.maxSize];Y(a.cbResponse,r,a.suggestedOutline,e,t)}).otherwise(function(){Y(a.cbResponse,null,a.suggestedOutline,e,t)}):Y(a.cbResponse,null,a.suggestedOutline,e,t)}).otherwise(function(){x(t,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(){x(t,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")}),t.promise},createHeatmapRenderer:function(e){var a=new i;if(!e||!e.layer)return x(a,"smartMapping.createHeatmapRenderer: missing parameters."),a.promise;var t=e.layer;return e.statistics?ea(e.statistics,e,a):t.addPlugin(ua).then(function(){t.statisticsPlugin.getHeatmapStatistics(e).then(function(t){ea(t,e,a)}).otherwise(function(){x(a,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(){x(a,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")}),a.promise},applyHeatmapScheme:function(e){if(!(e&&e.renderer&&e.scheme))return void console.log("smartMapping.applyHeatmapScheme: missing parameters.");var a=Z({scheme:e.scheme}),r=e.renderer,i=r.colorStops,l=a.colors;if(i.length!==l.length+3)return void console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");var o,s=new c(l[0]),u=t.map(i,function(e){return n.mixin({},e)});for(u[0].color=new c([s.r,s.g,s.b,0]),u[1].color=new c([s.r,s.g,s.b,0]),u[2].color=s,o=3;o<u.length;o++)u[o].color=l[o-3];r.setColorStops(u)}}),r("extend-esri")&&n.setObject("renderer.smartMapping",aa,u),aa});