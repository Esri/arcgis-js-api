// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../Color","../../../Graphic","../../../core/Logger","../../../core/maybe","../../support/utils","./sizeVariableUtils"],function(e,a,r,i,n,t,s,l){function o(e,a,i){var n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"color"===e.type})[0]:e;if(n){if("esri.renderers.visualVariables.ColorVariable"!==n.declaredClass)return void M.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");var s="number"==typeof a,l=s?null:a,o=l&&l.attributes,u=s?a:null,c=n.field,v=n.cache,f=v.ipData,d=v.hasExpression,p=n.cache.compiledFunc;if(!c&&!d){var b=n.stops;return b&&b[0]&&b[0].color}if("number"!=typeof u)if(d){if(!t.isSome(i)||!t.isSome(i.arcade))return void M.error("Use of arcade expressions requires an arcade context");var m={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},h=i.arcade.arcadeUtils,V=h.getViewInfo(m),x=h.createExecContext(l,V);if(!p){var g=h.createSyntaxTree(n.valueExpression);p=h.createFunction(g),n.cache.compiledFunc=p}u=h.executeFunction(p,x)}else o&&(u=o[c]);var y=n.normalizationField,S=o?parseFloat(o[y]):void 0;if(null!=u&&(!y||s||!isNaN(S)&&0!==S)){isNaN(S)||s||(u/=S);var z=N(u,f);if(z){var w=z[0],F=z[1],E=w===F?n.stops[w].color:r.blendColors(n.stops[w].color,n.stops[F].color,z[2],t.isSome(i)?i.color:void 0);return new r(E)}}}}function u(e,a,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"opacity"===e.type})[0]:e;if(i){if("esri.renderers.visualVariables.OpacityVariable"!==i.declaredClass)return void M.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");var n="number"==typeof a,s=n?null:a,l=s&&s.attributes,o=n?a:null,u=i.field,c=i.cache,v=c.ipData,f=c.hasExpression,d=i.cache.compiledFunc;if(!u&&!f){var p=i.stops;return p&&p[0]&&p[0].opacity}if("number"!=typeof o)if(f){if(t.isNone(r)||t.isNone(r.arcade))return void M.error("Use of arcade expressions requires an arcade context");var b={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},m=r.arcade.arcadeUtils,h=m.getViewInfo(b),V=m.createExecContext(s,h);if(!d){var x=m.createSyntaxTree(i.valueExpression);d=m.createFunction(x),i.cache.compiledFunc=d}o=m.executeFunction(d,V)}else l&&(o=l[u]);var g=i.normalizationField,y=l?parseFloat(l[g]):void 0;if(null!=o&&(!g||n||!isNaN(y)&&0!==y)){isNaN(y)||n||(o/=y);var S=N(o,v);if(S){var z=S[0],w=S[1];if(z===w)return i.stops[z].opacity;var F=i.stops[z].opacity;return F+(i.stops[w].opacity-F)*S[2]}}}}function c(e,a,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"rotation"===e.type})[0]:e;if(i){if("esri.renderers.visualVariables.RotationVariable"!==i.declaredClass)return void M.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");var n=i.axis||"heading",s="heading"===n&&"arithmetic"===i.rotationType?90:0,l="heading"===n&&"arithmetic"===i.rotationType?-1:1,o="number"==typeof a?null:a,u=o&&o.attributes,c=i.field,v=i.cache.hasExpression,f=i.cache.compiledFunc,d=0;if(!c&&!v)return d;if(v){if(t.isNone(r)||t.isNone(r.arcade))return void M.error("Use of arcade expressions requires an arcade context");var p={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},b=r.arcade.arcadeUtils,m=b.getViewInfo(p),h=b.createExecContext(o,m);if(!f){var V=b.createSyntaxTree(i.valueExpression);f=b.createFunction(V),i.cache.compiledFunc=f}d=b.executeFunction(f,h)}else u&&(d=u[c]||0);return d="number"!=typeof d||isNaN(d)?null:s+l*d}}function v(e,a,r){var i="number"==typeof a,n=i?null:a,s=n&&n.attributes,o=i?a:null,u=e.cache.isScaleDriven,c=e.cache.compiledFunc;if(u){var v=t.isSome(r)?r.scale:void 0,d=t.isSome(r)?r.view:void 0;o=null==v||d&&"3d"===d.type?f(e):v}else if(!i)switch(e.inputValueType){case"expression":if(t.isNone(r)||t.isNone(r.arcade))return void M.error("Use of arcade expressions requires an arcade context");var p={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},b=r.arcade.arcadeUtils,m=b.getViewInfo(p),h=b.createExecContext(n,m);if(!c){var V=b.createSyntaxTree(e.valueExpression);c=b.createFunction(V),e.cache.compiledFunc=c}o=b.executeFunction(c,h);break;case"field":s&&(o=s[e.field]);break;case"unknown":o=null}if(!l.isValidNumber(o))return null;if(i||!e.normalizationField)return o;var x=s?parseFloat(s[e.normalizationField]):null;return l.isValidNumber(x)&&0!==x?o/x:null}function f(e){var a=null,r=null,i=e.stops;return i?(a=i[0].value,r=i[i.length-1].value):(a=e.minDataValue||0,r=e.maxDataValue||0),(a+r)/2}function d(e,a,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"size"===e.type})[0]:e;if(i){if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void M.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");var n=v(i,a,r),t=z(n,i,a,r,i.cache.ipData);return null===t||void 0===t||isNaN(t)?0:t}}function p(e,a,r){return null==e?null:l.isSizeVariable(e)?d(e,a,r):l.isValidNumber(e)?e:null}function b(e,a,r){return l.isValidNumber(r)&&e>r?r:l.isValidNumber(a)&&e<a?a:e}function m(e,a,r,i){return e+(p(a.minSize,r,i)||a.minDataValue)}function h(e,a,r){var i=e.stops,n=i&&i.length&&i[0].size;return null==n&&(n=e.minSize),p(n,a,r)}function V(e,a,r,i){var n=(e-a.minDataValue)/(a.maxDataValue-a.minDataValue),s=p(a.minSize,r,i),l=p(a.maxSize,r,i),o=t.isSome(i)?i.shape:void 0;if(e<=a.minDataValue)return s;if(e>=a.maxDataValue)return l;if("area"===a.scaleBy&&o){var u="circle"===o,c=u?D*Math.pow(s/2,2):s*s,v=u?D*Math.pow(l/2,2):l*l,f=c+n*(v-c);return u?2*Math.sqrt(f/D):Math.sqrt(f)}return s+n*(l-s)}function x(e,a,r,i){var n=t.isSome(i)?i.shape:void 0,s=e/a.minDataValue,l=p(a.minSize,r,i),o=p(a.maxSize,r,i),u=null;return u="circle"===n?2*Math.sqrt(s*Math.pow(l/2,2)):"square"===n||"diamond"===n||"image"===n?Math.sqrt(s*Math.pow(l,2)):s*l,b(u,l,o)}function g(e,a,r,i,n){var t=N(e,n),s=t[0],l=t[1],o=t[2];if(s===l)return p(a.stops[s].size,r,i);var u=p(a.stops[s].size,r,i);return u+(p(a.stops[l].size,r,i)-u)*o}function y(e,a,r,i){var n=t.isSome(i)&&i.resolution?i.resolution:1,l=n*s.meterIn[a.valueUnit],o=p(a.minSize,r,i),u=p(a.maxSize,r,i),c=a.valueRepresentation,v=null;return v="area"===c?2*Math.sqrt(e/D)/l:"radius"===c||"distance"===c?2*e/l:e/l,b(v,o,u)}function S(e){return e}function z(e,a,r,i,n){switch(a.transformationType){case"additive":return m(e,a,r,i);case"constant":return h(a,r,i);case"clamped-linear":return V(e,a,r,i);case"proportional":return x(e,a,r,i);case"stops":return g(e,a,r,i,n);case"real-world-size":return y(e,a,r,i);case"identity":return S(e);case"unknown":return null}}function w(e,a,r){var i=e.cache.isScaleDriven,n=r&&"3d"===r.type;if(!(i&&n||a))return null;var t={scale:a,view:r},s=p(e.minSize,E,t),l=p(e.maxSize,E,t);if(null!=s||null!=l){if(s>l){var o=l;l=s,s=o}return{minSize:s,maxSize:l}}}function F(e,a,r){if(e.visualVariables){for(var i=[],n=[],t=[],s=[],l=[],v=0,f=e.visualVariables;v<f.length;v++){var p=f[v];switch(p.type){case"color":n.push(p);break;case"opacity":t.push(p);break;case"rotation":l.push(p);break;case"size":s.push(p)}}return n.forEach(function(e){var n=o(e,a,r);i.push({variable:e,value:n})}),t.forEach(function(e){var n=u(e,a,r);i.push({variable:e,value:n})}),l.forEach(function(e){var n=c(e,a,r);i.push({variable:e,value:n})}),s.forEach(function(e){var n=d(e,a,r);i.push({variable:e,value:n})}),i.filter(function(e){return null!=e.value})}}function N(e,a){if(a){var r=0,i=a.length-1;return a.some(function(a,n){return e<a?(i=n,!0):(r=n,!1)}),[r,i,(e-a[r])/(a[i]-a[r])]}}Object.defineProperty(a,"__esModule",{value:!0});var M=n.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),E=new i,D=Math.PI;a.getColor=o,a.getOpacity=u,a.getRotationAngle=c,a.getSize=d,a.getSizeFromNumberOrVariable=p,a.getSizeForValue=z,a.getSizeRangeAtScale=w,a.getVisualVariableValues=F});