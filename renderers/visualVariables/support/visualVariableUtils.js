/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../Graphic","../../../core/compilerUtils","../../../core/Logger","../../../core/maybe","../../support/lengthUtils","./sizeVariableUtils"],(function(e,a,i,r,n,t,s,o){"use strict";const l=n.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),c=new i,u=Math.PI,f=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function d(e,i,r){const n="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"color"===e.type)):e;if(!n)return;if("esri.renderers.visualVariables.ColorVariable"!==n.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s="number"==typeof i,o=s?null:i,c=o&&o.attributes;let u=s?i:null;const f=n.field,{ipData:d,hasExpression:p}=n.cache;let b=n.cache.compiledFunc;if(!f&&!p){const e=n.stops;return e&&e[0]&&e[0].color}if("number"!=typeof u)if(p){if(!t.isSome(r)||!t.isSome(r.arcade))return void l.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},a=r.arcade.arcadeUtils,i=a.getViewInfo(e),s=a.createExecContext(o,i);if(!b){const e=a.createSyntaxTree(n.valueExpression);b=a.createFunction(e),n.cache.compiledFunc=b}u=a.executeFunction(b,s)}else c&&(u=c[f]);const v=n.normalizationField,m=c?parseFloat(c[v]):void 0;if(null!=u&&(!v||s||!isNaN(m)&&0!==m)){isNaN(m)||s||(u/=m);const e=R(u,d);if(e){const i=e[0],s=e[1],o=i===s?n.stops[i].color:a.blendColors(n.stops[i].color,n.stops[s].color,e[2],t.isSome(r)?r.color:void 0);return new a(o)}}}function p(e,a,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.OpacityVariable"!==r.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const n="number"==typeof a,s=n?null:a,o=s&&s.attributes;let c=n?a:null;const u=r.field,{ipData:f,hasExpression:d}=r.cache;let p=r.cache.compiledFunc;if(!u&&!d){const e=r.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof c)if(d){if(t.isNone(i)||t.isNone(i.arcade))return void l.error("Use of arcade expressions requires an arcade context");const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},a=i.arcade.arcadeUtils,n=a.getViewInfo(e),o=a.createExecContext(s,n);if(!p){const e=a.createSyntaxTree(r.valueExpression);p=a.createFunction(e),r.cache.compiledFunc=p}c=a.executeFunction(p,o)}else o&&(c=o[u]);const b=r.normalizationField,v=o?parseFloat(o[b]):void 0;if(null!=c&&(!b||n||!isNaN(v)&&0!==v)){isNaN(v)||n||(c/=v);const e=R(c,f);if(e){const a=e[0],i=e[1];if(a===i)return r.stops[a].opacity;{const n=r.stops[a].opacity;return n+(r.stops[i].opacity-n)*e[2]}}}}function b(e,a,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.RotationVariable"!==r.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const n=r.axis||"heading",s="heading"===n&&"arithmetic"===r.rotationType?90:0,o="heading"===n&&"arithmetic"===r.rotationType?-1:1,c="number"==typeof a?null:a,u=c&&c.attributes,f=r.field,{hasExpression:d}=r.cache;let p=r.cache.compiledFunc,b=0;if(!f&&!d)return b;if(d){if(t.isNone(i)||t.isNone(i.arcade))return void l.error("Use of arcade expressions requires an arcade context");const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},a=i.arcade.arcadeUtils,n=a.getViewInfo(e),s=a.createExecContext(c,n);if(!p){const e=a.createSyntaxTree(r.valueExpression);p=a.createFunction(e),r.cache.compiledFunc=p}b=a.executeFunction(p,s)}else u&&(b=u[f]||0);return b="number"!=typeof b||isNaN(b)?null:s+o*b,b}function v(e,a,i){const r="number"==typeof a,n=r?null:a,s=n&&n.attributes;let c=r?a:null;const{isScaleDriven:u}=e.cache;let f=e.cache.compiledFunc;if(u){const a=t.isSome(i)?i.scale:void 0,r=t.isSome(i)?i.view:void 0;c=null==a||"3d"===r?m(e):a}else if(!r)switch(e.inputValueType){case o.InputValueType.Expression:{if(t.isNone(i)||t.isNone(i.arcade))return void l.error("Use of arcade expressions requires an arcade context");const a={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},r=i.arcade.arcadeUtils,s=r.getViewInfo(a),o=r.createExecContext(n,s);if(!f){const a=r.createSyntaxTree(e.valueExpression);f=r.createFunction(a),e.cache.compiledFunc=f}c=r.executeFunction(f,o);break}case o.InputValueType.Field:s&&(c=s[e.field]);break;case o.InputValueType.Unknown:c=null}if(!o.isValidNumber(c))return null;if(r||!e.normalizationField)return c;const d=s?parseFloat(s[e.normalizationField]):null;return o.isValidNumber(d)&&0!==d?c/d:null}function m(e){let a=null,i=null;const r=e.stops;return r?(a=r[0].value,i=r[r.length-1].value):(a=e.minDataValue||0,i=e.maxDataValue||0),(a+i)/2}function h(e,a,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.SizeVariable"!==r.declaredClass)return void l.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const n=N(v(r,a,i),r,a,i,r.cache.ipData);return null==n||isNaN(n)?0:n}function V(e,a,i){return null==e?null:o.isSizeVariable(e)?h(e,a,i):o.isValidNumber(e)?e:null}function y(e,a,i){return o.isValidNumber(i)&&e>i?i:o.isValidNumber(a)&&e<a?a:e}function x(e,a,i,r){return e+(V(a.minSize,i,r)||a.minDataValue)}function S(e,a,i){const r=e.stops;let n=r&&r.length&&r[0].size;return null==n&&(n=e.minSize),V(n,a,i)}function g(e,a,i,r){const n=(e-a.minDataValue)/(a.maxDataValue-a.minDataValue),s=V(a.minSize,i,r),o=V(a.maxSize,i,r),l=t.isSome(r)?r.shape:void 0;if(e<=a.minDataValue)return s;if(e>=a.maxDataValue)return o;if("area"===a.scaleBy&&l){const e="circle"===l,a=e?u*(s/2)**2:s*s,i=a+n*((e?u*(o/2)**2:o*o)-a);return e?2*Math.sqrt(i/u):Math.sqrt(i)}return s+n*(o-s)}function z(e,a,i,r){const n=t.isSome(r)?r.shape:void 0,s=e/a.minDataValue,o=V(a.minSize,i,r),l=V(a.maxSize,i,r);let c=null;return c="circle"===n?2*Math.sqrt(s*(o/2)**2):"square"===n||"diamond"===n||"image"===n?Math.sqrt(s*o**2):s*o,y(c,o,l)}function T(e,a,i,r,n){const[t,s,o]=R(e,n);if(t===s)return V(a.stops[t].size,i,r);{const e=V(a.stops[t].size,i,r);return e+(V(a.stops[s].size,i,r)-e)*o}}function w(e,a,i,r){const n=(t.isSome(r)&&r.resolution?r.resolution:1)*s.meterIn[a.valueUnit],o=V(a.minSize,i,r),l=V(a.maxSize,i,r),{valueRepresentation:c}=a;let f=null;return f="area"===c?2*Math.sqrt(e/u)/n:"radius"===c||"distance"===c?2*e/n:e/n,y(f,o,l)}function F(e){return e}function N(e,a,i,r,n){switch(a.transformationType){case o.TransformationType.Additive:return x(e,a,i,r);case o.TransformationType.Constant:return S(a,i,r);case o.TransformationType.ClampedLinear:return g(e,a,i,r);case o.TransformationType.Proportional:return z(e,a,i,r);case o.TransformationType.Stops:return T(e,a,i,r,n);case o.TransformationType.RealWorldSize:return w(e,a,i,r);case o.TransformationType.Identity:return F(e);case o.TransformationType.Unknown:return null}}function E(e,a,i){const{isScaleDriven:r}=e.cache;if(!(r&&"3d"===i||a))return null;const n={scale:a,view:i};let t=V(e.minSize,c,n),s=V(e.maxSize,c,n);if(null!=t||null!=s){if(t>s){const e=s;s=t,t=e}return{minSize:t,maxSize:s}}}function M(e,a,i){if(!e.visualVariables)return;const r=[],n=[],t=[],s=[],o=[];for(const l of e.visualVariables)switch(l.type){case"color":n.push(l);break;case"opacity":t.push(l);break;case"rotation":o.push(l);break;case"size":s.push(l)}return n.forEach((e=>{const n=d(e,a,i);r.push({variable:e,value:n})})),t.forEach((e=>{const n=p(e,a,i);r.push({variable:e,value:n})})),o.forEach((e=>{const n=b(e,a,i);r.push({variable:e,value:n})})),s.forEach((e=>{const n=h(e,a,i);r.push({variable:e,value:n})})),r.filter((e=>null!=e.value))}function R(e,a){if(!a)return;let i=0,r=a.length-1;return a.some(((a,n)=>e<a?(r=n,!0):(i=n,!1))),[i,r,(e-a[i])/(a[r]-a[i])]}function C(e,a,i){const n=["proportional","proportional","proportional"];for(const t of e){const e=t.useSymbolValue?"symbol-value":h(t,a,i);switch(t.axis){case"width":n[0]=e;break;case"depth":n[1]=e;break;case"height":n[2]=e;break;case"width-and-depth":n[0]=e,n[1]=e;break;case"all":case void 0:case null:n[0]=e,n[1]=e,n[2]=e;break;default:r.neverReached(t.axis)}}return n}e.getAllSizes=C,e.getColor=d,e.getOpacity=p,e.getRotationAngle=b,e.getSize=h,e.getSizeForValue=N,e.getSizeFromNumberOrVariable=V,e.getSizeRangeAtScale=E,e.getVisualVariableValues=M,e.viewScaleRE=f,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
