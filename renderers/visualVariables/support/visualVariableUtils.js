// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../Color","../../../Graphic","../../../core/compilerUtils","../../../core/Logger","../../../core/maybe","../../support/utils","./sizeVariableUtils"],(function(e,a,r,i,n,t,s,l,o){Object.defineProperty(a,"__esModule",{value:!0});var u=t.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),c=new i,v=Math.PI;function f(e,a,i){var n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((function(e){return"color"===e.type}))[0]:e;if(n)if("esri.renderers.visualVariables.ColorVariable"===n.declaredClass){var t="number"==typeof a,l=t?null:a,o=l&&l.attributes,c=t?a:null,v=n.field,f=n.cache,p=f.ipData,d=f.hasExpression,b=n.cache.compiledFunc;if(!v&&!d){var h=n.stops;return h&&h[0]&&h[0].color}if("number"!=typeof c)if(d){if(!s.isSome(i)||!s.isSome(i.arcade))return void u.error("Use of arcade expressions requires an arcade context");var m={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},V=i.arcade.arcadeUtils,g=V.getViewInfo(m),y=V.createExecContext(l,g);if(!b){var S=V.createSyntaxTree(n.valueExpression);b=V.createFunction(S),n.cache.compiledFunc=b}c=V.executeFunction(b,y)}else o&&(c=o[v]);var w=n.normalizationField,z=o?parseFloat(o[w]):void 0;if(null!=c&&(!w||t||!isNaN(z)&&0!==z)){isNaN(z)||t||(c/=z);var F=x(c,p);if(F){var N=F[0],M=F[1],E=N===M?n.stops[N].color:r.blendColors(n.stops[N].color,n.stops[M].color,F[2],s.isSome(i)?i.color:void 0);return new r(E)}}}else u.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable")}function p(e,a,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((function(e){return"opacity"===e.type}))[0]:e;if(i)if("esri.renderers.visualVariables.OpacityVariable"===i.declaredClass){var n="number"==typeof a,t=n?null:a,l=t&&t.attributes,o=n?a:null,c=i.field,v=i.cache,f=v.ipData,p=v.hasExpression,d=i.cache.compiledFunc;if(!c&&!p){var b=i.stops;return b&&b[0]&&b[0].opacity}if("number"!=typeof o)if(p){if(s.isNone(r)||s.isNone(r.arcade))return void u.error("Use of arcade expressions requires an arcade context");var h={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},m=r.arcade.arcadeUtils,V=m.getViewInfo(h),g=m.createExecContext(t,V);if(!d){var y=m.createSyntaxTree(i.valueExpression);d=m.createFunction(y),i.cache.compiledFunc=d}o=m.executeFunction(d,g)}else l&&(o=l[c]);var S=i.normalizationField,w=l?parseFloat(l[S]):void 0;if(null!=o&&(!S||n||!isNaN(w)&&0!==w)){isNaN(w)||n||(o/=w);var z=x(o,f);if(z){var F=z[0],N=z[1];if(F===N)return i.stops[F].opacity;var M=i.stops[F].opacity;return M+(i.stops[N].opacity-M)*z[2]}}}else u.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable")}function d(e,a,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((function(e){return"rotation"===e.type}))[0]:e;if(i){if("esri.renderers.visualVariables.RotationVariable"===i.declaredClass){var n=i.axis||"heading",t="heading"===n&&"arithmetic"===i.rotationType?90:0,l="heading"===n&&"arithmetic"===i.rotationType?-1:1,o="number"==typeof a?null:a,c=o&&o.attributes,v=i.field,f=i.cache.hasExpression,p=i.cache.compiledFunc,d=0;if(!v&&!f)return d;if(f){if(s.isNone(r)||s.isNone(r.arcade))return void u.error("Use of arcade expressions requires an arcade context");var b={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},h=r.arcade.arcadeUtils,m=h.getViewInfo(b),V=h.createExecContext(o,m);if(!p){var x=h.createSyntaxTree(i.valueExpression);p=h.createFunction(x),i.cache.compiledFunc=p}d=h.executeFunction(p,V)}else c&&(d=c[v]||0);return d="number"!=typeof d||isNaN(d)?null:t+l*d}u.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable")}}function b(e,a,r){var i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((function(e){return"size"===e.type}))[0]:e;if(i){if("esri.renderers.visualVariables.SizeVariable"===i.declaredClass){var n=V(function(e,a,r){var i="number"==typeof a,n=i?null:a,t=n&&n.attributes,l=i?a:null,c=e.cache.isScaleDriven,v=e.cache.compiledFunc;if(c){var f=s.isSome(r)?r.scale:void 0,p=s.isSome(r)?r.view:void 0;l=null==f||p&&"3d"===p.type?function(e){var a=null,r=null,i=e.stops;i?(a=i[0].value,r=i[i.length-1].value):(a=e.minDataValue||0,r=e.maxDataValue||0);return(a+r)/2}(e):f}else if(!i)switch(e.inputValueType){case"expression":if(s.isNone(r)||s.isNone(r.arcade))return void u.error("Use of arcade expressions requires an arcade context");var d={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},b=r.arcade.arcadeUtils,h=b.getViewInfo(d),m=b.createExecContext(n,h);if(!v){var V=b.createSyntaxTree(e.valueExpression);v=b.createFunction(V),e.cache.compiledFunc=v}l=b.executeFunction(v,m);break;case"field":t&&(l=t[e.field]);break;case"unknown":l=null}if(!o.isValidNumber(l))return null;if(i||!e.normalizationField)return l;var x=t?parseFloat(t[e.normalizationField]):null;return o.isValidNumber(x)&&0!==x?l/x:null}(i,a,r),i,a,r,i.cache.ipData);return null==n||isNaN(n)?0:n}u.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable")}}function h(e,a,r){return null==e?null:o.isSizeVariable(e)?b(e,a,r):o.isValidNumber(e)?e:null}function m(e,a,r){return o.isValidNumber(r)&&e>r?r:o.isValidNumber(a)&&e<a?a:e}function V(e,a,r,i,n){switch(a.transformationType){case"additive":return function(e,a,r,i){return e+(h(a.minSize,r,i)||a.minDataValue)}(e,a,r,i);case"constant":return function(e,a,r){var i=e.stops,n=i&&i.length&&i[0].size;return null==n&&(n=e.minSize),h(n,a,r)}(a,r,i);case"clamped-linear":return function(e,a,r,i){var n=(e-a.minDataValue)/(a.maxDataValue-a.minDataValue),t=h(a.minSize,r,i),l=h(a.maxSize,r,i),o=s.isSome(i)?i.shape:void 0;if(e<=a.minDataValue)return t;if(e>=a.maxDataValue)return l;if("area"===a.scaleBy&&o){var u="circle"===o,c=u?v*Math.pow(t/2,2):t*t,f=c+n*((u?v*Math.pow(l/2,2):l*l)-c);return u?2*Math.sqrt(f/v):Math.sqrt(f)}return t+n*(l-t)}(e,a,r,i);case"proportional":return function(e,a,r,i){var n=s.isSome(i)?i.shape:void 0,t=e/a.minDataValue,l=h(a.minSize,r,i),o=h(a.maxSize,r,i);return m("circle"===n?2*Math.sqrt(t*Math.pow(l/2,2)):"square"===n||"diamond"===n||"image"===n?Math.sqrt(t*Math.pow(l,2)):t*l,l,o)}(e,a,r,i);case"stops":return function(e,a,r,i,n){var t=x(e,n),s=t[0],l=t[1],o=t[2];if(s===l)return h(a.stops[s].size,r,i);var u=h(a.stops[s].size,r,i);return u+(h(a.stops[l].size,r,i)-u)*o}(e,a,r,i,n);case"real-world-size":return function(e,a,r,i){var n=(s.isSome(i)&&i.resolution?i.resolution:1)*l.meterIn[a.valueUnit],t=h(a.minSize,r,i),o=h(a.maxSize,r,i),u=a.valueRepresentation;return m("area"===u?2*Math.sqrt(e/v)/n:"radius"===u||"distance"===u?2*e/n:e/n,t,o)}(e,a,r,i);case"identity":return e;case"unknown":return null}}function x(e,a){if(a){var r=0,i=a.length-1;return a.some((function(a,n){return e<a?(i=n,!0):(r=n,!1)})),[r,i,(e-a[r])/(a[i]-a[r])]}}a.viewScaleRE=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,a.getColor=f,a.getOpacity=p,a.getRotationAngle=d,a.getSize=b,a.getSizeFromNumberOrVariable=h,a.getSizeForValue=V,a.getSizeRangeAtScale=function(e,a,r){var i=e.cache.isScaleDriven,n=r&&"3d"===r.type;if(!(i&&n||a))return null;var t={scale:a,view:r},s=h(e.minSize,c,t),l=h(e.maxSize,c,t);if(null!=s||null!=l){if(s>l){var o=l;l=s,s=o}return{minSize:s,maxSize:l}}},a.getVisualVariableValues=function(e,a,r){if(e.visualVariables){for(var i=[],n=[],t=[],s=[],l=[],o=0,u=e.visualVariables;o<u.length;o++){var c=u[o];switch(c.type){case"color":n.push(c);break;case"opacity":t.push(c);break;case"rotation":l.push(c);break;case"size":s.push(c)}}return n.forEach((function(e){var n=f(e,a,r);i.push({variable:e,value:n})})),t.forEach((function(e){var n=p(e,a,r);i.push({variable:e,value:n})})),l.forEach((function(e){var n=d(e,a,r);i.push({variable:e,value:n})})),s.forEach((function(e){var n=b(e,a,r);i.push({variable:e,value:n})})),i.filter((function(e){return null!=e.value}))}},a.getAllSizes=function(e,a,r){for(var i=["proportional","proportional","proportional"],t=0,s=e;t<s.length;t++){var l=s[t],o=l.useSymbolValue?"symbol-value":b(l,a,r);switch(l.axis){case"width":i[0]=o;break;case"depth":i[1]=o;break;case"height":i[2]=o;break;case"width-and-depth":i[0]=o,i[1]=o;break;case"all":case void 0:case null:i[0]=o,i[1]=o,i[2]=o;break;default:n.neverReached(l.axis)}}return i}}));