/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../rasterRenderers","../../core/maybe","../../core/unitUtils","../../layers/support/Field","../../layers/support/RasterInfo","../FlowRenderer","./AuthoringInfo","./ClassBreakInfo","./colorRampUtils","./UniqueValueInfo","../../rest/support/AlgorithmicColorRamp","../../rest/support/ClassBreaksDefinition","../../rest/support/generateRendererUtils","../../rest/support/MultipartColorRamp","../RasterStretchRenderer","../UniqueValueRenderer","../RasterColormapRenderer","../RasterShadedReliefRenderer","../ClassBreaksRenderer","../VectorFieldRenderer"],(function(e,t,n,r,a,l,o,i,s,u,c,m,d,f,p,b,h,g,v,y,S,R){"use strict";const C=.25,w=b.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),M=b.fromJSON(c.PREDEFINED_JSON_COLOR_RAMPS[0]),x=new Set(["scientific","standard-time","vector-uv","vector-magdir","vector-u","vector-v","vector-magnitude","vector-direction"]);function T(e,t){const{attributeTable:n,colormap:a}=e;if(Q(e)){const t=Z(e);if(r.isSome(t))return t}if(r.isSome(a)){const t=z(e);if(r.isSome(t))return t}if(r.isSome(n)){const t=N(e);if(r.isSome(t))return t}return I(e,t)}function k(e){const t=["raster-stretch"];return q(e)&&t.push("raster-colormap"),W(e)&&t.push("unique-value"),J(e)&&t.push("class-breaks"),_(e)&&t.push("raster-shaded-relief"),Q(e)&&t.push("vector-field"),X(e)&&t.push("flow"),t}function V(e,t,n){const r=["nearest","bilinear","cubic","majority"].find((e=>e===(null==n?void 0:n.toLowerCase())));if("Map"===t)return null!=r?r:"bilinear";if("standard-time"===e.dataType)return null!=r?r:"nearest";return"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===r||"majority"===r?r:"nearest":null!=r?r:"bilinear"}function I(e,t){var n,a,l,o;e=B(e,null==t?void 0:t.variableName);const{bandCount:i}=e;let{bandIds:s,stretchType:u}=t||{};null!=(n=s)&&n.some((e=>e>=i))&&(s=null);let c=r.unwrap(e.statistics),m=r.unwrap(e.histograms);var d;i>1?(s=null!=(d=s)&&d.length?s:F(e),c=null==c?null:s.map((e=>c[e])),m=null==m?null:s.map((e=>m[e]))):s=[0];null==u&&(u=E(e));let f=!1;switch(u){case"none":f=!1;break;case"percent-clip":f=!(null!=(a=m)&&a.length);break;default:f=!(null!=(l=c)&&l.length)}const{dataType:p}=e,b=1===(null==(o=s)?void 0:o.length)&&x.has(p)?w:null,g=new h({stretchType:u,dynamicRangeAdjustment:f,colorRamp:b,outputMin:0,outputMax:255,gamma:1===s.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===u?g.maxPercent=g.minPercent=C:"standard-deviation"===u&&(g.numberOfStandardDeviations=2),!f&&(r.isSome(e.multidimensionalInfo)||null!=t&&t.includeStatisticsInStretch)&&("percent-clip"===u?g.histograms=m:"min-max"!==u&&"standard-deviation"!==u||(g.statistics=c)),g}function B(e,t){if(null==t)return e;let n=r.unwrap(e.statistics),a=r.unwrap(e.histograms);const{multidimensionalInfo:l}=e;if(t&&r.isSome(l)){const{statistics:e,histograms:r}=l.variables.find((e=>e.name===t));null!=e&&e.length&&(n=e),null!=r&&r.length&&(a=r)}return o.fromJSON({...e.toJSON(),statistics:n,histograms:a})}function F(e){const t=e.bandCount;if(1===t)return null;if(2===t)return[0];const n=e.keyProperties&&e.keyProperties.BandProperties;let r;if(n&&n.length===t){const{red:e,green:t,blue:a,nir:l}=O(n);null!=e&&null!=t&&null!=a?r=[e,t,a]:null!=l&&null!=e&&null!=t&&(r=[l,e,t])}return!r&&t>=3&&(r=[0,1,2]),r}function L(e,t){var n;const r=e.keyProperties&&e.keyProperties.BandProperties;return(t=null!=(n=t)&&n.length?t:Array.from(Array(e.bandCount).keys())).map((t=>r&&r.length===e.bandCount&&r[t]&&r[t].BandName||"band_"+(t+1)))}function O(e){const t={};for(let r=0;r<e.length;r++){var n;const a=e[r],l=null==(n=a.BandName)?void 0:n.toLowerCase();if("red"===l)t.red=r;else if("green"===l)t.green=r;else if("blue"===l)t.blue=r;else if("nearinfrared"===l||"nearinfrared_1"===l||"nir"===l)t.nir=r;else if(a.WavelengthMax&&a.WavelengthMin){const e=a.WavelengthMin,n=a.WavelengthMax;null==t.blue&&e>=410&&e<=480&&n>=480&&n<=540?t.blue=r:null==t.green&&e>=490&&e<=560&&n>=560&&n<=610?t.green=r:null==t.red&&e>=595&&e<=670&&n>=660&&n<=730?t.red=r:null==t.nir&&e>=700&&e<=860&&n>=800&&n<=950&&(t.nir=r)}}return t}function E(e){let t="percent-clip";const{pixelType:n,dataType:a,histograms:l,statistics:o}=e;return"u8"!==n||"processed"!==a&&r.isSome(l)&&r.isSome(o)?"u8"===n||"elevation"===a||x.has(a)?t="min-max":r.isSome(l)?t="percent-clip":r.isSome(o)&&(t="min-max",t="min-max"):t="none",t}function N(e,n,a,l){if(!W(e,n))return null;const{attributeTable:o,statistics:i}=e,u=P(o,n),d=U(o,"red"),f=U(o,"green"),p=U(o,"blue"),b=new s,h=[],v=new Set,y=!!(d&&f&&p);if(r.isSome(o))o.features.forEach((e=>{const n=e.attributes[u.name];if(!v.has(e.attributes[u.name])&&null!=n){v.add(n);const r=y&&("single"===d.type||"double"===d.type)&&("single"===f.type||"double"===f.type)&&("single"===p.type||"double"===p.type)&&!o.features.some((e=>e.attributes[d.name]>1||e.attributes[f.name]>1||e.attributes[p.name]>1)),a=r?255:1;h.push(new m({value:e.attributes[u.name],label:e.attributes[u.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new t(y?[e.attributes[d.name]*a,e.attributes[f.name]*a,e.attributes[p.name]*a,1]:[0,0,0,0])}}))}}));else if(null!=i&&i[0])for(let r=i[0].min;r<=i[0].max;r++)h.push(new m({value:r,label:r.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new t([0,0,0,0])}}));if(h.sort(((e,t)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>t.value?1:-1)),!y){const e=c.convertColorRampToColormap(M,h.length);h.forEach(((n,r)=>n.symbol.color=new t(e[r].slice(1,4)))),b.colorRamp=M}if(a||l){const e=a||c.convertColorRampToColormap(l,h.length).map((e=>e.slice(1)));h.forEach(((n,r)=>n.symbol.color=new t(e[r]))),b.colorRamp=l}return new g({field:u.name,uniqueValueInfos:h,authoringInfo:b})}function P(e,t,n){let a;return r.isSome(e)?(a=t?e.fields.find((e=>t.toLowerCase()===e.name.toLowerCase())):D(e.fields),a||(n||(a=e.fields.find((e=>"string"===e.type))),a||(a=U(e,"value")))):a=new l({name:"value"}),a}function D(e){let t;for(let n=0;n<e.length;n++){const r=e[n].name.toLowerCase();if("string"===e[n].type){if(r.startsWith("class")){t=e[n];break}null==t&&(r.endsWith("name")||r.endsWith("type"))&&(t=e[n])}}return t}function U(e,t){return r.isSome(e)?e.fields.find((e=>e.name.toLowerCase()===t)):null}function W(e,t){const{attributeTable:n,bandCount:a}=e;if(!r.isSome(n)&&K(e))return!0;if(!r.isSome(n)||a>1)return!1;if(t){if(null==n.fields.find((e=>e.name.toLowerCase()===t.toLowerCase())))return!1}return!0}function q(e){const{bandCount:t,colormap:n}=e;return r.isSome(n)&&n.length&&1===t}function z(e){if(!q(e))return null;let t;const{attributeTable:n,colormap:a}=e;if(r.isSome(n)){const e=U(n,"value"),r=P(n,null,!0);"string"===r.type&&(t={},n.features.forEach((n=>{const a=n.attributes;t[a[e.name]]=r?a[r.name]:a[e.name]})))}return v.createFromColormap(r.unwrap(a),t)}function _(e){return"elevation"===e.dataType}function A(e,t){var n;if(!_(e))return null;const{extent:r}=e,l=r.width*a.getMetersPerUnitForSR(r.spatialReference);return t=null!=(n=t)?n:"multi-directional",new y({hillshadeType:t,scalingType:l>5e6?"adjusted":"none"})}function J(e){const{attributeTable:t,bandCount:n}=e;return 1===n&&(r.isSome(t)||r.isSome(e.histograms))}function j(e,t){e=B(e,null==t?void 0:t.variableName);const{attributeTable:n}=e;if(!J(e))return null;const a=r.isSome(e.histograms)?e.histograms[0]:null,l=isFinite(null==t?void 0:t.numClasses)?t.numClasses:5,o=new s({classificationMethod:null==t?void 0:t.classificationMethod,colorRamp:null==t?void 0:t.colorRamp});let i=(null==t?void 0:t.field)||"value";const m=[],d=[],b=1e3,h=r.isSome(n),g=h&&n.fields.find((e=>"count"===e.name.toLowerCase())),v=h&&n.fields.find((e=>e.name.toLowerCase()===i.toLowerCase()));if(v){i=v.name;const e=n.features.length;let t=0;n.features.forEach((n=>t+=(g?n.attributes[g.name]:50)/e)),n.features.forEach((n=>{const r=n.attributes[v.name],a=g?n.attributes[g.name]:50;if(a>0){d.push(a);const n=Math.max(1,Math.round(a/e/t*b));for(let e=0;e<n;e++)m.push(r)}}))}else{const{pixelType:t}=e,r=(a.max-a.min)/a.size,l=t.indexOf("s")>-1||t.indexOf("u")>-1,o=l&&1===r?Math.floor(a.min+.5):a.min,i=l&&1===r?Math.floor(a.max-.5):a.max,s=a.size;let u,c=0;a.counts.forEach((e=>c+=e/s)),a.counts.forEach(((e,t)=>{if(e>0){d.push(e);const l=Math.max(1,Math.round(e/s/c*b));u=h?n.features[t].attributes[v.name]:0===t?o:t===s-1?i:a.min+r*(t+.5);for(let e=0;e<l;e++)m.push(u)}}))}const y=(null==t?void 0:t.classificationMethod)||"natural-breaks";let R=null==t?void 0:t.definedInterval;"defined-interval"!==y||R||(R=G(e,v,l));const C=p.createGenerateRendererClassBreaks({values:m,valueFrequency:d,normalizationTotal:null,definition:new f({classificationMethod:y,breakCount:l,definedInterval:R})});let M=null==t?void 0:t.colors;if(!M){const e=(null==t?void 0:t.colorRamp)||w;o.colorRamp=e;const n=c.convertColorRampToColormap(e,C.classBreaks.length,!0);M=n.map((e=>e.slice(1)))}const x=C.classBreaks.map(((e,t)=>new u({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:M[t]}})));return new S({field:i,classBreakInfos:x,authoringInfo:o})}function G(e,t,n){let a=0,l=0;if(r.isSome(e.attributeTable)){const n=e.attributeTable;a=l=n.features[0].attributes[t.name],n.features.forEach((e=>{const n=e.attributes[t.name];n<a&&(a=n),n>l&&(l=n)}))}else if(r.isSome(e.histograms)){const t=e.histograms;a=t[0].min,l=t[0].max}return(l-a)/n}function K(e){var t,n,r;return["u8","s8"].indexOf(e.pixelType)>-1&&null!=(null==(t=e.statistics)||null==(n=t[0])?void 0:n.min)&&null!=(null==(r=e.statistics[0])?void 0:r.max)&&1===e.bandCount}function H(e){const n=[];for(let r=0;r<e.length-1;r++)n[r]=new d({algorithm:"hsv",fromColor:e[r],toColor:e[r+1]||new t({r:255,g:255,b:255,a:1})});if(e.length>2){return new b({colorRamps:n})}return n[0]}function Q(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}function X(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}const Y=new Map([["m/s","meter-per-second"],["km/h","kilometer-per-hour"],["knots","knots"],["ft/s","feet-per-second"],["mph","mile-per-hour"]]);function Z(e){if(!Q(e))return null;let t;if(r.isSome(e.statistics)&&e.statistics.length&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:n,maxMagnitude:r}=ne(e.dataType,e.statistics);t=[{type:"size",field:"Magnitude",minSize:10,maxSize:40,minDataValue:n,maxDataValue:r}]}const n=r.isSome(e.multidimensionalInfo)?Y.get(e.multidimensionalInfo.variables[0].unit):null,a=new R({visualVariables:t,inputUnit:n,rotationType:"geographic"});return a.visualVariables=[...a.sizeVariables,...a.rotationVariables],a}function $(e){var t;return{color:null==(t=e.symbolLayers[0].material)?void 0:t.color,type:"esriSFS",style:"esriSFSSolid"}}function ee(e){if("uniqueValue"===e.type){var t;const n=e.uniqueValueInfos,r=n[0].symbol;return null!=r&&null!=(t=r.symbolLayers)&&t.length&&(e.uniqueValueInfos=n.map((e=>({value:e.value,label:e.label,symbol:e.symbol?$(e.symbol):null})))),e}if("classBreaks"===e.type){var n;const t=e.classBreakInfos,r=t[0].symbol;return null!=r&&null!=(n=r.symbolLayers)&&n.length&&(e.classBreakInfos=t.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?$(e.symbol):null})))),e}return e}function te(e){if(!X(e))return null;let t;if(r.isSome(e.statistics)&&e.statistics.length>0&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:n,maxMagnitude:r}=ne(e.dataType,e.statistics);t=[{type:"color",field:"Magnitude",stops:[{value:n,color:"#1020C0"},{value:r,color:"#C02010"}]}]}return new i({visualVariables:t})}function ne(e,t){let n,r;if("vector-magdir"===e)n=t[0].min,r=t[0].max;else{const e=t[0].min,a=t[0].max,l=t[1].min,o=t[1].max;n=0,r=Math.max(Math.abs(e),Math.abs(l),Math.abs(a),Math.abs(o))}return{minMagnitude:n,maxMagnitude:r}}e.createClassBreaksRenderer=j,e.createColorRamp=H,e.createColormapRenderer=z,e.createDefaultRenderer=T,e.createFlowRenderer=te,e.createShadedReliefRenderer=A,e.createStretchRenderer=I,e.createUVRenderer=N,e.createVectorFieldRenderer=Z,e.estimateMagnitudeRange=ne,e.getBandNames=L,e.getClassField=P,e.getDefaultBandCombination=F,e.getDefaultInterpolation=V,e.getDefinedInterval=G,e.getField=U,e.getSupportedRendererTypes=k,e.getWellKnownBandIndexes=O,e.isClassBreaksSupported=J,e.isColormapRendererSupported=q,e.isFlowRendererSupported=X,e.isShadedReliefRendererSupported=_,e.isSingleBand8BitRasterWithStats=K,e.isUVRendererSupported=W,e.isVectorFieldRendererSupported=Q,e.normalizeRendererJSON=ee,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
