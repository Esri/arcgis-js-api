/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../Color","../../core/unitUtils","../../tasks/support/AlgorithmicColorRamp","../../tasks/support/MultipartColorRamp","./AuthoringInfo","./ClassBreakInfo","../ClassBreaksRenderer","./colorRampUtils","../RasterColormapRenderer","../RasterShadedReliefRenderer","../RasterStretchRenderer","./UniqueValueInfo","../UniqueValueRenderer","../VectorFieldRenderer","../../rasterRenderers","../../layers/support/Field","../../layers/support/RasterInfo","../../tasks/support/ClassBreaksDefinition","../../tasks/support/generateRendererUtils"],(function(e,n,t,r,l,a,o,s,i,u,c,m,f,d,p,h,b,v,g,y,C){"use strict";const R=.25,S=a.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),w=a.fromJSON(u.PREDEFINED_JSON_COLOR_RAMPS[0]);function x(e,t){const{attributeTable:r,colormap:l,dataType:a}=e;if("vector-uv"===a||"vector-magdir"===a){const t=G(e);if(n.isSome(t))return t}if(n.isSome(l)){const t=U(e);if(n.isSome(t))return t}if(n.isSome(r)){const t=N(e);if(n.isSome(t))return t}return T(e,t)}function k(e){const n=["raster-stretch"];return q(e)&&n.push("raster-colormap"),F(e)&&n.push("unique-value"),A(e)&&n.push("class-breaks"),D(e)&&n.push("raster-shaded-relief"),z(e)&&n.push("vector-field"),n}function M(e,n,t){const r=["nearest","bilinear","cubic","majority"].find((e=>e===(null==t?void 0:t.toLowerCase())));if("Map"===n)return null!=r?r:"bilinear";return"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===r||"majority"===r?r:"nearest":null!=r?r:"bilinear"}function T(e,t){var r,l,a,o;e=B(e,null==t?void 0:t.variableName);const{bandCount:s}=e;let{bandIds:i,stretchType:u}=t||{};null!=(r=i)&&r.some((e=>e>=s))&&(i=null);let c=n.unwrap(e.statistics),m=n.unwrap(e.histograms);var d;s>1?(i=null!=(d=i)&&d.length?i:I(e),c=null==c?null:i.map((e=>c[e])),m=null==m?null:i.map((e=>m[e]))):i=[0];null==u&&(u=O(e));let p=!1;switch(u){case"none":p=!1;break;case"percent-clip":p=!(null!=(l=m)&&l.length);break;default:p=!(null!=(a=c)&&a.length)}const h=1===(null==(o=i)?void 0:o.length)&&"scientific"===e.dataType?S:null,b=new f({stretchType:u,dynamicRangeAdjustment:p,colorRamp:h,outputMin:0,outputMax:255,gamma:1===i.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===u?b.maxPercent=b.minPercent=R:"standard-deviation"===u&&(b.numberOfStandardDeviations=2),p||("percent-clip"===u?b.histograms=m:"min-max"!==u&&"standard-deviation"!==u||(b.statistics=c)),b}function B(e,t){if(null==t)return e;let r=n.unwrap(e.statistics),l=n.unwrap(e.histograms);const{multidimensionalInfo:a}=e;if(t&&n.isSome(a)){const{statistics:e,histograms:n}=a.variables.find((e=>e.name===t));null!=e&&e.length&&(r=e),null!=n&&n.length&&(l=n)}return g.fromJSON({...e.toJSON(),statistics:r,histograms:l})}function I(e){const n=e.bandCount;if(1===n)return null;if(2===n)return[0];const t=e.keyProperties&&e.keyProperties.BandProperties;let r;if(t&&t.length===n){const{red:e,green:n,blue:l,nir:a}=L(t);null!=e&&null!=n&&null!=l?r=[e,n,l]:null!=a&&null!=e&&null!=n&&(r=[a,e,n])}return!r&&n>=3&&(r=[0,1,2]),r}function V(e,n){var t;const r=e.keyProperties&&e.keyProperties.BandProperties;return(n=null!=(t=n)&&t.length?n:Array.from(Array(e.bandCount).keys())).map((n=>r&&r.length===e.bandCount&&r[n]&&r[n].BandName||"band_"+(n+1)))}function L(e){const n={};for(let r=0;r<e.length;r++){var t;const l=e[r],a=null==(t=l.BandName)?void 0:t.toLowerCase();if("red"===a)n.red=r;else if("green"===a)n.green=r;else if("blue"===a)n.blue=r;else if("nearinfrared"===a||"nearinfrared_1"===a||"nir"===a)n.nir=r;else if(l.WavelengthMax&&l.WavelengthMin){const e=l.WavelengthMin,t=l.WavelengthMax;null==n.blue&&e>=410&&e<=480&&t>=480&&t<=540?n.blue=r:null==n.green&&e>=490&&e<=560&&t>=560&&t<=610?n.green=r:null==n.red&&e>=595&&e<=670&&t>=660&&t<=730?n.red=r:null==n.nir&&e>=700&&e<=860&&t>=800&&t<=950&&(n.nir=r)}}return n}function O(e){let t="percent-clip";const{pixelType:r,dataType:l,histograms:a,statistics:o}=e;return"u8"!==r||"processed"!==l&&n.isSome(a)&&n.isSome(o)?"u8"===r||"elevation"===l||"scientific"===l?t="min-max":n.isSome(a)?t="percent-clip":n.isSome(o)&&(t="min-max",t="min-max"):t="none",t}function N(e,r,l,a){if(!F(e,r))return null;const{attributeTable:s,statistics:i}=e,c=P(s,r),m=E(s,"red"),f=E(s,"green"),h=E(s,"blue"),b=new o,v=[],g=new Set,y=!!(m&&f&&h);if(n.isSome(s))s.features.forEach((e=>{const n=e.attributes[c.name];g.has(e.attributes[c.name])||null==n||(g.add(n),v.push(new d({value:e.attributes[c.name],label:e.attributes[c.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new t(y?[e.attributes[m.name],e.attributes[f.name],e.attributes[h.name],1]:[0,0,0,0])}})))}));else if(null!=i&&i[0])for(let n=i[0].min;n<=i[0].max;n++)v.push(new d({value:n,label:n.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new t([0,0,0,0])}}));if(v.sort(((e,n)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>n.value?1:-1)),!y){const e=u.convertColorRampToColormap(w,v.length);v.forEach(((n,r)=>n.symbol.color=new t(e[r].slice(1,4)))),b.colorRamp=w}if(l||a){const e=l||u.convertColorRampToColormap(a,v.length).map((e=>e.slice(1)));v.forEach(((n,r)=>n.symbol.color=new t(e[r]))),b.colorRamp=a}return new p({field:c.name,uniqueValueInfos:v,authoringInfo:b})}function P(e,t){let r;return n.isSome(e)?(r=t?e.fields.find((e=>t.toLowerCase()===e.name.toLowerCase())):e.fields.find((e=>"string"===e.type&&e.name.toLowerCase().indexOf("class")>-1)),r||(r=e.fields.find((e=>"string"===e.type)),r||(r=E(e,"value")))):r=new v({name:"value"}),r}function E(e,t){return n.isSome(e)?e.fields.find((e=>e.name.toLowerCase()===t)):null}function F(e,t){const{attributeTable:r,bandCount:l}=e;if(!n.isSome(r)&&W(e))return!0;if(!n.isSome(r)||l>1)return!1;if(t){if(null==r.fields.find((e=>e.name.toLowerCase()===t.toLowerCase())))return!1}return!0}function q(e){const{bandCount:t,colormap:r}=e;return n.isSome(r)&&r.length&&1===t}function U(e){if(!q(e))return null;let t;const{attributeTable:r,colormap:l}=e;if(n.isSome(r)){const e=E(r,"value"),n=P(r);"string"===n.type&&(t={},r.features.forEach((r=>{const l=r.attributes;t[l[e.name]]=n?l[n.name]:l[e.name]})))}return c.createFromColormap(n.unwrap(l),t)}function D(e){return"elevation"===e.dataType}function _(e,n){var t;if(!D(e))return null;const{extent:l}=e,a=l.width*r.getMetersPerUnitForSR(l.spatialReference);return n=null!=(t=n)?t:"multi-directional",new m({hillshadeType:n,scalingType:a>5e6?"adjusted":"none"})}function A(e){const{attributeTable:t,bandCount:r}=e;return 1===r&&(n.isSome(t)||n.isSome(e.histograms))}function J(e,t){e=B(e,null==t?void 0:t.variableName);const{attributeTable:r}=e;if(!A(e))return null;const l=n.isSome(e.histograms)?e.histograms[0]:null,a=(null==t?void 0:t.numClasses)||5,c=new o({classificationMethod:null==t?void 0:t.classificationMethod,colorRamp:null==t?void 0:t.colorRamp});let m=(null==t?void 0:t.field)||"value";const f=[],d=[],p=1e3;if(n.isSome(r)){const e=r.fields.find((e=>"count"===e.name.toLowerCase())),n=r.fields.find((e=>e.name.toLowerCase()===m.toLowerCase()));m=n.name;const t=r.features.length;let l=0;r.features.forEach((n=>l+=n.attributes[e.name]/t)),r.features.forEach((r=>{const a=r.attributes[n.name],o=r.attributes[e.name];if(o>0){d.push(o);const e=Math.max(1,Math.round(o/t/l*p));for(let n=0;n<e;n++)f.push(a)}}))}else{const{pixelType:n}=e,t=(l.max-l.min)/l.size,r=n.indexOf("s")>-1||n.indexOf("u")>-1,a=r&&1===t?Math.floor(l.min+.5):l.min,o=r&&1===t?Math.floor(l.max-.5):l.max,s=l.size;let i=0;l.counts.forEach((e=>i+=e/s)),l.counts.forEach(((e,n)=>{if(e>0){d.push(e);const r=Math.max(1,Math.round(e/s/i*p)),u=0===n?a:n===s-1?o:l.min+t*(n+.5);for(let e=0;e<r;e++)f.push(u)}}))}const h=(null==t?void 0:t.classificationMethod)||"natural-breaks",b=C.createGenerateRendererClassBreaks({values:f,valueFrequency:d,normalizationTotal:null,definition:new y({classificationMethod:h,breakCount:a,definedInterval:null==t?void 0:t.definedInterval})});let v=null==t?void 0:t.colors;if(!v){const e=(null==t?void 0:t.colorRamp)||S;c.colorRamp=e;const n=u.convertColorRampToColormap(e,b.classBreaks.length,!0);v=n.map((e=>e.slice(1)))}const g=b.classBreaks.map(((e,n)=>new s({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:v[n]}})));return new i({field:m,classBreakInfos:g,authoringInfo:c})}function W(e){var n,t,r;return["u8","s8"].indexOf(e.pixelType)>-1&&null!=(null==(n=e.statistics)||null==(t=n[0])?void 0:t.min)&&null!=(null==(r=e.statistics[0])?void 0:r.max)&&1===e.bandCount}function j(e){const n=[];for(let r=0;r<e.length-1;r++)n[r]=new l({algorithm:"hsv",fromColor:e[r],toColor:e[r+1]||new t({r:255,g:255,b:255,a:1})});if(e.length>2){return new a({colorRamps:n})}return n[0]}function z(e){const{dataType:n}=e;return"vector-uv"===n||"vector-magdir"===n}function G(e){return z(e)?new h:null}function K(e){var n;return{color:null==(n=e.symbolLayers[0].material)?void 0:n.color,type:"esriSFS",style:"esriSFSSolid"}}function H(e){if("uniqueValue"===e.type){var n;const t=e.uniqueValueInfos,r=t[0].symbol;return null!=r&&null!=(n=r.symbolLayers)&&n.length&&(e.uniqueValueInfos=t.map((e=>({value:e.value,label:e.label,symbol:e.symbol?K(e.symbol):null})))),e}if("classBreaks"===e.type){var t;const n=e.classBreakInfos,r=n[0].symbol;return null!=r&&null!=(t=r.symbolLayers)&&t.length&&(e.classBreakInfos=n.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?K(e.symbol):null})))),e}return e}e.createClassBreaksRenderer=J,e.createColorRamp=j,e.createColormapRenderer=U,e.createDefaultRenderer=x,e.createShadedReliefRenderer=_,e.createStretchRenderer=T,e.createUVRenderer=N,e.createVectorFieldRenderer=G,e.getBandNames=V,e.getClassField=P,e.getDefaultBandCombination=I,e.getDefaultInterpolation=M,e.getSupportedRendererTypes=k,e.getWellKnownBandIndexes=L,e.isClassBreaksSupported=A,e.isColormapRendererSupported=q,e.isShadedReliefRendererSupported=D,e.isSingleBand8BitRasterWithStats=W,e.isUVRendererSupported=F,e.isVectorFieldRendererSupported=z,e.normalizeRendererJSON=H,Object.defineProperty(e,"__esModule",{value:!0})}));
