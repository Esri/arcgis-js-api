/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../rasterRenderers","../../core/maybe","../../core/unitUtils","../../layers/support/Field","../../layers/support/RasterInfo","../FlowRenderer","./AuthoringInfo","./ClassBreakInfo","./colorRampUtils","./UniqueValueInfo","../../rest/support/ClassBreaksDefinition","../../rest/support/generateRendererUtils","../../rest/support/MultipartColorRamp","../RasterStretchRenderer","../UniqueValueRenderer","../RasterColormapRenderer","../RasterShadedReliefRenderer","../ClassBreaksRenderer","../VectorFieldRenderer"],(function(e,t,n,a,r,s,o,i,l,u,c,m,d,f,p,b,h,g,y,v,S){"use strict";const C=.25,R=p.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),w=p.fromJSON(c.PREDEFINED_JSON_COLOR_RAMPS[0]),M=new Set(["scientific","standard-time","vector-uv","vector-magdir","vector-u","vector-v","vector-magnitude","vector-direction"]);function T(e,t){const{attributeTable:n,colormap:r}=e;if(K(e)){const t=X(e);if(a.isSome(t))return t}if(a.isSome(r)){const t=q(e);if(a.isSome(t))return t}if(a.isSome(n)){const t=E(e);if(a.isSome(t))return t}return V(e,t)}function x(e,t=!1){const n=["raster-stretch"];return W(e)&&n.push("raster-colormap"),U(e)&&n.push("unique-value"),J(e,t)&&n.push("class-breaks"),z(e)&&n.push("raster-shaded-relief"),K(e)&&n.push("vector-field"),H(e)&&n.push("flow"),n}function k(e,t,n){const a=["nearest","bilinear","cubic","majority"].find((e=>e===n?.toLowerCase()));if("Map"===t)return a??"bilinear";if("standard-time"===e.dataType)return a??"nearest";return"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===a||"majority"===a?a:"nearest":a??"bilinear"}function V(e,t){e=I(e,t?.variableName);const{bandCount:n}=e;let{bandIds:r,stretchType:s}=t||{};r?.some((e=>e>=n))&&(r=null);let o=a.unwrap(e.statistics),i=a.unwrap(e.histograms);n>1?(r=r?.length?r:B(e),o=null==o?null:r?.map((e=>o[e])),i=null==i?null:r?.map((e=>i[e]))):r=[0],null==s&&(s=N(e));let l=!1;switch(s){case"none":l=!1;break;case"percent-clip":l=!i?.length;break;default:l=!o?.length}const{dataType:u}=e,c=1===r?.length&&M.has(u)?R:null,m=new b({stretchType:s,dynamicRangeAdjustment:l,colorRamp:c,outputMin:0,outputMax:255,gamma:1===r?.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===s?m.maxPercent=m.minPercent=C:"standard-deviation"===s&&(m.numberOfStandardDeviations=2),l||!a.isSome(e.multidimensionalInfo)&&!t?.includeStatisticsInStretch||("percent-clip"===s?m.histograms=i:"min-max"!==s&&"standard-deviation"!==s||(m.statistics=o)),m}function I(e,t){if(!t)return e;let n=a.unwrap(e.statistics),r=a.unwrap(e.histograms);const{multidimensionalInfo:s}=e;if(t&&a.isSome(s)){const e=s.variables.find((e=>e.name===t));if(e){const{statistics:t,histograms:a}=e;t?.length&&(n=t),a?.length&&(r=a)}}return o.fromJSON({...e.toJSON(),statistics:n,histograms:r})}function B(e){const t=e.bandCount;if(1===t)return null;if(2===t)return[0];const n=e.keyProperties&&e.keyProperties.BandProperties;let a;if(n&&n.length===t){const{red:e,green:t,blue:r,nir:s}=L(n);null!=e&&null!=t&&null!=r?a=[e,t,r]:null!=s&&null!=e&&null!=t&&(a=[s,e,t])}return!a&&t>=3&&(a=[0,1,2]),a}function F(e,t){const n=e.keyProperties&&e.keyProperties.BandProperties;return(t=t?.length?t:Array.from(Array(e.bandCount).keys())).map((t=>n&&n.length===e.bandCount&&n[t]&&n[t].BandName||"band_"+(t+1)))}function L(e){const t={};for(let n=0;n<e.length;n++){const a=e[n],r=a.BandName?.toLowerCase();if("red"===r)t.red=n;else if("green"===r)t.green=n;else if("blue"===r)t.blue=n;else if("nearinfrared"===r||"nearinfrared_1"===r||"nir"===r)t.nir=n;else if(a.WavelengthMax&&a.WavelengthMin){const e=a.WavelengthMin,r=a.WavelengthMax;null==t.blue&&e>=410&&e<=480&&r>=480&&r<=540?t.blue=n:null==t.green&&e>=490&&e<=560&&r>=560&&r<=610?t.green=n:null==t.red&&e>=595&&e<=670&&r>=660&&r<=730?t.red=n:null==t.nir&&e>=700&&e<=860&&r>=800&&r<=950&&(t.nir=n)}}return t}function N(e){let t="percent-clip";const{pixelType:n,dataType:r,histograms:s,statistics:o,multidimensionalInfo:i}=e,l=M.has(r)||"generic"===r&&a.isSome(i);return"u8"!==n||"processed"!==r&&a.isSome(s)&&a.isSome(o)?"u8"===n||"elevation"===r||l?t="min-max":a.isSome(s)?t="percent-clip":a.isSome(o)&&(t="min-max"):t="none",t}function E(e,n,r,s){if(!U(e,n))return null;const{attributeTable:o,statistics:i}=e,u=P(o,n),d=D(o,"red"),f=D(o,"green"),p=D(o,"blue"),b=new l,g=[],y=new Set,v=!!(d&&f&&p);if(a.isSome(o))o.features.forEach((e=>{const n=e.attributes[u.name];if(!y.has(e.attributes[u.name])&&null!=n){y.add(n);const a=v&&("single"===d.type||"double"===d.type)&&("single"===f.type||"double"===f.type)&&("single"===p.type||"double"===p.type)&&!o.features.some((e=>e.attributes[d.name]>1||e.attributes[f.name]>1||e.attributes[p.name]>1)),r=a?255:1;g.push(new m({value:e.attributes[u.name],label:e.attributes[u.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new t(v?[e.attributes[d.name]*r,e.attributes[f.name]*r,e.attributes[p.name]*r,1]:[0,0,0,0])}}))}}));else if(i?.[0])for(let a=i[0].min;a<=i[0].max;a++)g.push(new m({value:a,label:a.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new t([0,0,0,0])}}));if(g.sort(((e,t)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>t.value?1:-1)),!v){const e=c.convertColorRampToColormap(w,{numColors:g.length});g.forEach(((n,a)=>n.symbol.color=new t(e[a].slice(1,4)))),b.colorRamp=w}if(r||s){const e=r||c.convertColorRampToColormap(s,{numColors:g.length}).map((e=>e.slice(1)));g.forEach(((n,a)=>n.symbol.color=new t(e[a]))),b.colorRamp=s}return new h({field:u.name,uniqueValueInfos:g,authoringInfo:b})}function P(e,t,n){let r;return a.isSome(e)?(r=t?e.fields.find((e=>t.toLowerCase()===e.name.toLowerCase())):O(e.fields),r||(n||(r=e.fields.find((e=>"string"===e.type))),r||(r=D(e,"value")))):r=new s({name:"value"}),r}function O(e){let t;for(let n=0;n<e.length;n++){const a=e[n].name.toLowerCase();if("string"===e[n].type){if(a.startsWith("class")){t=e[n];break}null==t&&(a.endsWith("name")||a.endsWith("type"))&&(t=e[n])}}return t}function D(e,t){return a.isNone(e)?null:e.fields.find((e=>e.name.toLowerCase()===t))}function U(e,t){const{attributeTable:n,bandCount:r}=e;if(a.isNone(n)&&G(e))return!0;if(a.isNone(n)||r>1)return!1;if(t){if(null==n.fields.find((e=>e.name.toLowerCase()===t.toLowerCase())))return!1}return!0}function W(e){const{bandCount:t,colormap:n}=e;return a.isSome(n)&&n.length>0&&1===t}function q(e){if(!W(e))return null;let t;const{attributeTable:n,colormap:r}=e;if(a.isSome(n)){const e=D(n,"value"),a=P(n,null,!0);"string"===a.type&&(t={},n.features.forEach((n=>{const r=n.attributes;t[r[e.name]]=a?r[a.name]:r[e.name]})))}return g.createFromColormap(a.unwrap(r),t)}function z(e){const{bandCount:t,dataType:n,pixelType:a}=e;return"elevation"===n||"generic"===n&&1===t&&("s16"===a||"s32"===a||"f32"===a||"f64"===a)}function A(e,t="traditional"){if(!z(e))return null;const{extent:n}=e,a=n.width*r.getMetersPerUnitForSR(n.spatialReference);return new y({hillshadeType:t,scalingType:a>5e6?"adjusted":"none"})}function J(e,t=!1){const{attributeTable:n,bandCount:r}=e;return 1===r&&(!t||a.isSome(n)||a.isSome(e.histograms))}function j(e,t){e=I(e,t?.variableName);const{attributeTable:n}=e;if(!J(e))return null;const r=a.isSome(e.histograms)?e.histograms[0]:null,s=null!=t?.numClasses&&isFinite(t?.numClasses)?t.numClasses:5,o=new l({classificationMethod:t?.classificationMethod,colorRamp:t?.colorRamp});let i=t?.field||"value";const m=[],p=[],b=1e3,h=a.isSome(n),g=h&&n.fields.find((e=>"count"===e.name.toLowerCase())),y=h?n.fields.find((e=>e.name.toLowerCase()===i.toLowerCase())):void 0;if(y&&h){i=y.name;const e=n.features.length;let t=0;n.features.forEach((n=>t+=(g?n.attributes[g.name]:50)/e)),n.features.forEach((n=>{const a=n.attributes[y.name],r=g?n.attributes[g.name]:50;if(r>0){p.push(r);const n=Math.max(1,Math.round(r/e/t*b));for(let e=0;e<n;e++)m.push(a)}}))}else{const{pixelType:t}=e,a=(r.max-r.min)/r.size,s=t.includes("s")||t.includes("u"),o=s&&1===a?Math.floor(r.min+.5):r.min,i=s&&1===a?Math.floor(r.max-.5):r.max,l=r.size;let u,c=0;r.counts.forEach((e=>c+=e/l)),r.counts.forEach(((e,t)=>{if(e>0){p.push(e);const s=Math.max(1,Math.round(e/l/c*b));u=h?n.features[t].attributes[y.name]:0===t?o:t===l-1?i:r.min+a*(t+.5);for(let e=0;e<s;e++)m.push(u)}}))}const S=t?.classificationMethod||"natural-breaks";let C=t?.definedInterval;"defined-interval"!==S||C||(C=_(e,y,s));const w=f.createGenerateRendererClassBreaks({values:m,valueFrequency:p,normalizationTotal:null,definition:new d({classificationMethod:S,breakCount:s,definedInterval:C})});let M=t?.colors;if(!M){const e=t?.colorRamp||R;o.colorRamp=e;const n=c.convertColorRampToColormap(e,{numColors:w.classBreaks.length,interpolateAlpha:!0});M=n.map((e=>e.slice(1)))}const T=w.classBreaks.map(((e,t)=>new u({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:M[t]}})));return new v({field:i,classBreakInfos:T,authoringInfo:o})}function _(e,t,n){let r=0,s=0;if(a.isSome(e.attributeTable)){const n=e.attributeTable;r=s=n.features[0].attributes[t.name],n.features.forEach((e=>{const n=e.attributes[t.name];n<r&&(r=n),n>s&&(s=n)}))}else if(a.isSome(e.histograms)){const t=e.histograms;r=t[0].min,s=t[0].max}return(s-r)/n}function G(e){return["u8","s8"].includes(e.pixelType)&&null!=e.statistics?.[0]?.min&&null!=e.statistics[0]?.max&&1===e.bandCount}function K(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}function H(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}const Q=new Map([["m/s","meter-per-second"],["km/h","kilometer-per-hour"],["knots","knots"],["ft/s","feet-per-second"],["mph","mile-per-hour"]]);function X(e){if(!K(e))return null;let t;if(a.isSome(e.statistics)&&e.statistics.length&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:n,maxMagnitude:a}=ee(e.dataType,e.statistics);t=[{type:"size",field:"Magnitude",minSize:10,maxSize:40,minDataValue:n,maxDataValue:a}]}const n=a.isSome(e.multidimensionalInfo)?Q.get(e.multidimensionalInfo.variables[0].unit):null,r=new S({visualVariables:t,inputUnit:n,rotationType:"geographic"});return r.visualVariables=[...r.sizeVariables,...r.rotationVariables],r}function Y(e){return{color:e.symbolLayers[0].material?.color,type:"esriSFS",style:"esriSFSSolid"}}function Z(e){if("uniqueValue"===e.type){const t=e.uniqueValueInfos,n=t?.[0].symbol;return n?.symbolLayers?.length&&(e.uniqueValueInfos=t?.map((e=>({value:e.value,label:e.label,symbol:e.symbol?Y(e.symbol):null})))),e}if("classBreaks"===e.type){const t=e.classBreakInfos;return t[0].symbol?.symbolLayers?.length&&(e.classBreakInfos=t.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?Y(e.symbol):null})))),e}return e}function $(e){if(!H(e))return null;let t;if(a.isSome(e.statistics)&&e.statistics.length>0&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:n,maxMagnitude:a}=ee(e.dataType,e.statistics);t=[{type:"color",field:"Magnitude",stops:[{value:n,color:"#1020C0"},{value:a,color:"#C02010"}]}]}return new i({visualVariables:t})}function ee(e,t){let n,a;if("vector-magdir"===e)n=t[0].min,a=t[0].max;else{const e=t[0].min,r=t[0].max,s=t[1].min,o=t[1].max;n=0,a=Math.max(Math.abs(e),Math.abs(s),Math.abs(r),Math.abs(o))}return{minMagnitude:n,maxMagnitude:a}}e.createClassBreaksRenderer=j,e.createColormapRenderer=q,e.createDefaultRenderer=T,e.createFlowRenderer=$,e.createShadedReliefRenderer=A,e.createStretchRenderer=V,e.createUVRenderer=E,e.createVectorFieldRenderer=X,e.estimateMagnitudeRange=ee,e.getBandNames=F,e.getClassField=P,e.getDefaultBandCombination=B,e.getDefaultInterpolation=k,e.getDefinedInterval=_,e.getField=D,e.getSupportedRendererTypes=x,e.getVariableRasterInfo=I,e.getWellKnownBandIndexes=L,e.isClassBreaksSupported=J,e.isColormapRendererSupported=W,e.isFlowRendererSupported=H,e.isShadedReliefRendererSupported=z,e.isSingleBand8BitRasterWithStats=G,e.isUVRendererSupported=U,e.isVectorFieldRendererSupported=K,e.normalizeRendererJSON=Z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
