// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Color","../../rasterRenderers","../../core/arrayUtils","../../core/maybe","../../core/unitUtils","../../layers/support/RasterInfo","../../renderers/support/ClassBreakInfo","../../renderers/support/colorRampUtils","../../renderers/support/UniqueValueInfo","../../tasks/support/ClassBreaksDefinition","../../tasks/support/generateRendererUtils","../../tasks/support/MultipartColorRamp"],(function(e,r,n,t,a,i,l,o,u,s,d,f,c,m,p){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.createClassBreaksRenderer=r.isClassBreaksSupported=r.createShadedReliefRenderer=r.isShadedReliefRendererSupported=r.createColormapRenderer=r.isColormapRendererSupported=r.isUVRendererSupported=r.getClassField=r.createUVRenderer=r.getWellKnownBandIndexes=r.getDefaultBandCombination=r.createStretchRenderer=r.getDefaultInterpolation=r.getSupportedRendererTypes=r.createDefaultRenderer=void 0;var v=p.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),h=p.fromJSON(d.PREDEFINED_JSON_COLOR_RAMPS[0]);function b(e,r){var n=(e=g(e,null==r?void 0:r.variableName)).bandCount,t=r||{},i=t.bandIds,o=t.stretchType;(null==i?void 0:i.some((function(e){return e>=n})))&&(i=null);var u=l.unwrap(e.statistics),s=l.unwrap(e.histograms);n>1?(i=(null==i?void 0:i.length)?i:R(e),u=null==u?null:i.map((function(e){return u[e]})),s=null==s?null:i.map((function(e){return s[e]}))):i=[0],null==o&&(o=function(e){var r="percent-clip",n=e.pixelType,t=e.dataType,a=e.histograms,i=e.statistics;"u8"!==n||"processed"!==t&&l.isSome(a)&&l.isSome(i)?"u8"===n||"elevation"===t||"scientific"===t?r="min-max":l.isSome(a)?r="percent-clip":l.isSome(i)&&(r="min-max",r="min-max"):r="none";return r}(e));var d=!1;switch(o){case"none":d=!1;break;case"percent-clip":d=!(null==s?void 0:s.length);break;default:d=!(null==u?void 0:u.length)}var f=1===(null==i?void 0:i.length)&&"scientific"===e.dataType?v:null,c=new a.RasterStretchRenderer({stretchType:o,dynamicRangeAdjustment:d,colorRamp:f,outputMin:0,outputMax:255,gamma:1===i.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===o?c.maxPercent=c.minPercent=.25:"standard-deviation"===o&&(c.numberOfStandardDeviations=2),d||("percent-clip"===o?c.histograms=s:"min-max"!==o&&"standard-deviation"!==o||(c.statistics=u)),c}function g(e,r){if(null==r)return e;var t=l.unwrap(e.statistics),a=l.unwrap(e.histograms),o=e.multidimensionalInfo;if(r&&l.isSome(o)){var s=i.find(o.variables,(function(e){return e.name===r})),d=s.statistics,f=s.histograms;(null==d?void 0:d.length)&&(t=d),(null==f?void 0:f.length)&&(a=f)}return u.fromJSON(n.__assign(n.__assign({},e.toJSON()),{statistics:t,histograms:a}))}function R(e){var r=e.bandCount;if(1===r)return null;if(2===r)return[0];var n,t=e.keyProperties&&e.keyProperties.BandProperties;if(t&&t.length===r){var a=C(t),i=a.red,l=a.green,o=a.blue,u=a.nir;null!=i&&null!=l&&null!=o?n=[i,l,o]:null!=u&&null!=i&&null!=l&&(n=[u,i,l])}return!n&&r>=3&&(n=[0,1,2]),n}function C(e){for(var r,n={},t=0;t<e.length;t++){var a=e[t],i=null===(r=a.BandName)||void 0===r?void 0:r.toLowerCase();if("red"===i)n.red=t;else if("green"===i)n.green=t;else if("blue"===i)n.blue=t;else if("nearinfrared"===i||"nearinfrared_1"===i||"nir"===i)n.nir=t;else if(a.WavelengthMax&&a.WavelengthMin){var l=a.WavelengthMin,o=a.WavelengthMax;null==n.blue&&l>=410&&l<=480&&o>=480&&o<=540?n.blue=t:null==n.green&&l>=490&&l<=560&&o>=560&&o<=610?n.green=t:null==n.red&&l>=595&&l<=670&&o>=660&&o<=730?n.red=t:null==n.nir&&l>=700&&l<=860&&o>=800&&o<=950&&(n.nir=t)}}return n}function S(e,r){if(!x(e,r))return null;var n=e.attributeTable,i=y(n,r),l=w(n,"red"),o=w(n,"green"),u=w(n,"blue"),s=[],c=new Set,m=!!(l&&o&&u);if(n.features.forEach((function(e){var r=e.attributes[i.name];c.has(e.attributes[i.name])||null==r||(c.add(r),s.push(new f({value:e.attributes[i.name],label:e.attributes[i.name],symbol:{type:"simple-fill",style:"solid",outline:null,color:new t(m?[e.attributes[l.name],e.attributes[o.name],e.attributes[u.name],1]:[0,0,0,0])}})))})),!m){var p=d.convertColorRampToColormap(h,s.length);s.forEach((function(e,r){return e.symbol.color=new t(p[r].slice(1,4))}))}return new a.UniqueValueRenderer({field:i.name,uniqueValueInfos:s})}function y(e,r){var n=i.find(e.fields,(function(e){return"string"===e.type&&(r===e.name.toLowerCase()||e.name.toLowerCase().indexOf("class")>-1)}));return n||(n=i.find(e.fields,(function(e){return"string"===e.type})))||(n=w(e,"value")),n}function w(e,r){return i.find(e.fields,(function(e){return e.name.toLowerCase()===r}))}function x(e,r){var n=e.attributeTable,t=e.bandCount;if(!l.isSome(n)||t>1)return!1;if(r&&null==i.find(n.fields,(function(e){return e.name.toLowerCase()===r.toLowerCase()})))return!1;return!0}function T(e){var r=e.bandCount,n=e.colormap;return l.isSome(n)&&n.length&&1===r}function k(e){if(!T(e))return null;var r,n=e.attributeTable,t=e.colormap;if(l.isSome(n)){var i=w(n,"value"),o=y(n);"string"===o.type&&(r={},n.features.forEach((function(e){var n=e.attributes;r[n[i.name]]=o?n[o.name]:n[i.name]})))}return a.RasterColormapRenderer.createFromColormap(l.unwrap(t),r)}function M(e){return"elevation"===e.dataType}function B(e){var r=e.attributeTable;return 1===e.bandCount&&(l.isSome(r)||l.isSome(e.histograms))}r.createDefaultRenderer=function(e,r){var n=e.attributeTable,t=e.colormap,i=e.dataType;if("vector-uv"===i||"vector-magdir"===i)return new a.VectorFieldRenderer;if(l.isSome(t)){var o=k(e);if(l.isSome(o))return o}if(l.isSome(n)){o=S(e);if(l.isSome(o))return o}return b(e,r)},r.getSupportedRendererTypes=function(e){var r=["raster-stretch"];return T(e)&&r.push("raster-colormap"),x(e)&&r.push("unique-value"),B(e)&&r.push("class-breaks"),M(e)&&r.push("raster-shaded-relief"),r},r.getDefaultInterpolation=function(e,r,n){var t=i.find(["nearest","bilinear","cubic","majority"],(function(e){return e===(null==n?void 0:n.toLowerCase())}));return"Map"===r?null!=t?t:"bilinear":"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===t||"majority"===t?t:"nearest":null!=t?t:"bilinear"},r.createStretchRenderer=b,r.getDefaultBandCombination=R,r.getWellKnownBandIndexes=C,r.createUVRenderer=S,r.getClassField=y,r.isUVRendererSupported=x,r.isColormapRendererSupported=T,r.createColormapRenderer=k,r.isShadedReliefRendererSupported=M,r.createShadedReliefRenderer=function(e,r){if(!M(e))return null;var n=e.extent,t=n.width*o.getMetersPerUnitForSR(n.spatialReference)>5e6?"adjusted":"none";return r=null!=r?r:"multi-directional",new a.RasterShadedReliefRenderer({hillshadeType:r,scalingType:t})},r.isClassBreaksSupported=B,r.createClassBreaksRenderer=function(e,r){var n=(e=g(e,null==r?void 0:r.variableName)).attributeTable;if(!B(e))return null;var t=l.isSome(e.histograms)?e.histograms[0]:null,o=(null==r?void 0:r.numClasses)||4,u=null==r?void 0:r.colors;if(u&&u.length!==o)return null;var f=(null==r?void 0:r.field)||"value",p=[];if(l.isSome(n)){var h=i.find(n.fields,(function(e){return"count"===e.name.toLowerCase()})),b=i.find(n.fields,(function(e){return e.name.toLowerCase()===f.toLowerCase()}));f=b.name;var R=n.features.length,C=0;n.features.forEach((function(e){return C+=e.attributes[h.name]/R})),n.features.forEach((function(e){var r=e.attributes[b.name],n=e.attributes[h.name];if(n>0)for(var t=Math.max(1,Math.round(n/R/C*1e3)),a=0;a<t;a++)p.push(r)}))}else{var S=e.pixelType,y=(t.max-t.min)/t.size,w=S.indexOf("s")>-1||S.indexOf("u")>-1,x=w&&1===y?Math.floor(t.min+.5):t.min,T=w&&1===y?Math.floor(t.max-.5):t.max,k=t.size,M=0;t.counts.forEach((function(e){return M+=e/k})),t.counts.forEach((function(e,r){if(e>0)for(var n=Math.max(1,Math.round(e/k/M*1e3)),a=0===r?x:r===k-1?T:t.min+y*(r+.5),i=0;i<n;i++)p.push(a)}))}var I=(null==r?void 0:r.classificationMethod)||"equal-interval",O=m.createGenerateRendererClassBreaks({values:p,normalizationTotal:null,definition:new c({classificationMethod:I,breakCount:o})});if(!u){var V=(null==r?void 0:r.colorRamp)||v,L=d.convertColorRampToColormap(V,o,!0);u=L.map((function(e){return e.slice(1)}))}var U=O.classBreaks.map((function(e,r){return new s({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:u[r]}})}));return new a.ClassBreaksRenderer({field:f,classBreakInfos:U})}}));