/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../core/arrayUtils","../../core/Logger","../../intl/date","./numberUtils","../visualVariables/support/ColorStop"],(function(e,t,n,a,l,i){"use strict";const o=n.getLogger("esri.renderers.support.utils"),r={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"â€“"},s={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},u={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},d=a.convertDateFormatToIntlOptions("short-date");function f(e,t,n){let a="";return 0===t?a=r.lt+" ":t===n&&(a=r.gt+" "),a+e}function m(e){const{values:t,colors:n,labelIndexes:o,isDate:r,dateFormatOptions:s}=e;return t.map(((e,u)=>{let d=null;if(!o||o.indexOf(u)>-1){let n;n=r?a.formatDate(e,s):l.format(e),n&&(d=f(n,u,t.length-1))}return new i({value:e,color:n[u],label:d})}))}function c(e){const{stops:t,changes:n,isDate:i,dateFormatOptions:o}=e,r=t.map((e=>e.value)),s=[];for(const a of n)s.push(a.index),r[a.index]=a.value;const u=l.round(r,{indexes:s});t.forEach(((e,n)=>{if(e.value=r[n],null!=e.label){let r,s=null;r=i?a.formatDate(u[n],o):l.format(u[n]),r&&(s=f(r,n,t.length-1)),e.label=s}}))}function p(e){let t=e.minValue,n=e.maxValue;const a=e.isFirstBreak?"":r.gt+" ",i="percent-of-total"===e.normalizationType?r.pct:"";return t=null==t?"":l.format(t),n=null==n?"":l.format(n),a+t+i+" "+r.ld+" "+n+i}function h(e){const t=e.classBreakInfos,n=e.normalizationType;let a=[];if(t&&t.length)if("standard-deviation"!==e.classificationMethod)if(e.round){a.push(t[0].minValue);for(const e of t)a.push(e.maxValue);a=l.round(a),t.forEach(((e,t)=>{e.label=p({minValue:0===t?a[0]:a[t],maxValue:a[t+1],isFirstBreak:0===t,normalizationType:n})}))}else t.forEach(((e,t)=>{e.label=p({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:n})}));else o.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")}function y(e){if("standard-deviation"===e.classificationMethod)return void o.warn("updateClassBreak","cannot update labels for class breaks generated using 'standard-deviation' method.");const t=e.classBreaks,n=e.change,a=n.index,l=n.value,i=t.length;let r=-1,s=-1;0===a?r=a:a===i?s=a-1:(s=a-1,r=a);const u=e.normalizationType;let d=null;r>-1&&r<i&&(d=t[r],d.minValue=l,d.label=p({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===r,normalizationType:u})),s>-1&&s<i&&(d=t[s],d.maxValue=l,d.label=p({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===s,normalizationType:u}))}function g(e){const t=e.map((e=>new Date(e))),n=t.length;let a=1/0,l=null;for(let i=0;i<n-1;i++){const e=t[i];let o=1/0,r=null;for(let a=i+1;a<n;a++){const n=t[a],l=(e.getFullYear()!==n.getFullYear()?"year":e.getMonth()!==n.getMonth()&&"month")||e.getDate()!==n.getDate()&&"day"||e.getHours()!==n.getHours()&&"hour"||e.getMinutes()!==n.getMinutes()&&"minute"||e.getSeconds()!==n.getSeconds()&&"second"||"millisecond",i=s[l];i<o&&(o=i,r=l)}o<a&&(a=o,l=r)}return l}function b(e){const{value:t,domain:n,fieldInfo:i,dateFormatInterval:o}=e;let r=String(t);const s=n&&"codedValues"in n&&n.codedValues?n.getName(t):null;return s?r=s:"number"==typeof t&&(r=i&&"date"===i.type?a.formatDate(t,o&&a.convertDateFormatToIntlOptions(u[o])):l.format(t)),r}function V(e,t){return"normalizationField"in e&&e.normalizationField?x(e.field,e.normalizationField):"field"in e&&e.field?v(e.field):"valueExpression"in e&&e.valueExpression?F(e.valueExpression,e.valueExpressionTitle,t):null}function v(e){return{type:"field",field:e}}function x(e,t){return{type:"normalized-field",field:e,normalizationField:t}}function F(e,t,n){return{type:"expression",expression:e,title:t,returnType:n}}function z(e,n){const a=[];if("class-breaks"===e.type||"heatmap"===e.type)a.push(V(e,"number"));else if("unique-value"===e.type){const t=e.authoringInfo;if(t&&"relationship"===t.type){if(t.field1&&t.field2){const e=t.field1.field,n=t.field2.field,l=t.field1.normalizationField,i=t.field2.normalizationField;a.push(V({field:e,normalizationField:l})),a.push(V({field:n,normalizationField:i}))}}else{const t=e.uniqueValueInfos[0];let n=null;if(t&&t.value){const t=typeof e.uniqueValueInfos[0].value;"string"!==t&&"number"!==t||(n=t)}a.push(V(e,n)),[e.field2,e.field3].forEach((e=>e&&a.push(v(e))))}}else"dot-density"===e.type&&e.attributes.forEach((e=>a.push(V(e,"number"))));const l=n?n(e):"visualVariables"in e?e.visualVariables:null;return l&&l.forEach((e=>a.push(V(e,"number")))),t.unique(a.filter(Boolean),((e,t)=>"field"===e.type&&"field"===t.type?e.field===t.field:"normalized-field"===e.type&&"normalized-field"===t.type?e.field===t.field&&e.normalizationField===t.normalizationField:"expression"===e.type&&"expression"===t.type&&e.expression===t.expression))}e.calculateDateFormatInterval=g,e.createClassBreakLabel=p,e.createColorStops=m,e.createUniqueValueLabel=b,e.getAttribute=V,e.getAttributes=z,e.setLabelsForClassBreaks=h,e.timelineDateFormatOptions=d,e.updateClassBreak=y,e.updateColorStops=c,Object.defineProperty(e,"__esModule",{value:!0})}));
