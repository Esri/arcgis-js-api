/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/arrayUtils","../../core/Logger","../../core/MapUtils","../../core/maybe","../../intl/date","./numberUtils","../visualVariables/support/ColorStop","../../symbols/support/utils","../../widgets/Legend/support/colorRampUtils","../../widgets/Legend/support/heatmapRampUtils"],(function(e,t,l,o,n,i,a,r,s,u,d,f){"use strict";const m=o.getLogger("esri.renderers.support.utils"),p={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"â€“"},c={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},y={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},g=a.convertDateFormatToIntlOptions("short-date");function b(e,t,l){return h.apply(this,arguments)}function h(){return(h=t._asyncToGenerator((function*(e,t,l){n.getOrCreateMapValue(e,t,(()=>[])).push(...l)}))).apply(this,arguments)}function v(e){return F.apply(this,arguments)}function F(){return(F=t._asyncToGenerator((function*(e){const t=new Map;if(!e)return t;if("visualVariables"in e&&e.visualVariables){const l=e.visualVariables.filter((e=>"color"===e.type));for(const e of l){const l=((yield d.getRampStops(e))??[]).map((e=>e.color));yield b(t,e.field||e.valueExpression,l)}}if("heatmap"===e.type){const l=f.getHeatmapRampStops(e).map((e=>e.color));yield b(t,e.field||e.valueExpression,l)}else if("pie-chart"===e.type){for(const l of e.attributes)yield b(t,l.field||l.valueExpression,[l.color]);yield b(t,"default",[e?.othersCategory?.color,u.getColorFromSymbol(e.backgroundFillSymbol,null)])}else if("dot-density"===e.type){for(const l of e.attributes)yield b(t,l.field||l.valueExpression,[l.color]);yield b(t,"default",[e.backgroundColor])}else if("unique-value"===e.type)if("predominance"===e.authoringInfo?.type)for(const l of e.uniqueValueInfos??[])yield b(t,l.value.toString(),[u.getColorFromSymbol(l.symbol,null)]);else{const l=(e.uniqueValueInfos??[]).map((e=>u.getColorFromSymbol(e.symbol,null))),{field:o,field2:n,field3:i,valueExpression:a}=e;(o||a)&&(yield b(t,o||a,l)),n&&(yield b(t,n,l)),i&&(yield b(t,i,l))}else if("class-breaks"===e.type){const l=e.classBreakInfos.map((e=>u.getColorFromSymbol(e.symbol,null))),{field:o,valueExpression:n}=e;yield b(t,o??n,l)}else"simple"===e.type&&(yield b(t,"default",[u.getColorFromSymbol(e.symbol,null)]));return"defaultSymbol"in e&&e.defaultSymbol&&(yield b(t,"default",[u.getColorFromSymbol(e.defaultSymbol,null)])),t.forEach(((e,o)=>{const n=l.unique(e.filter(Boolean),((e,t)=>JSON.stringify(e)===JSON.stringify(t)));t.set(o,n)})),t}))).apply(this,arguments)}function V(e,t,l){let o="";return 0===t?o=p.lt+" ":t===l&&(o=p.gt+" "),o+e}function x(e){const{values:t,colors:l,labelIndexes:o,isDate:n,dateFormatOptions:i}=e;return t.map(((e,u)=>{let d=null;if(!o||o.includes(u)){let l;l=n?a.formatDate(e,i):r.format(e),l&&(d=V(l,u,t.length-1))}return new s({value:e,color:l[u],label:d})}))}function S(e){let t=e.minValue,l=e.maxValue;const o=e.isFirstBreak?"":p.gt+" ",n="percent-of-total"===e.normalizationType?p.pct:"";return t=null==t?"":r.format(t),l=null==l?"":r.format(l),o+t+n+" "+p.ld+" "+l+n}function z(e){const t=e.classBreakInfos,l=e.normalizationType;let o=[];if(t&&t.length)if("standard-deviation"!==e.classificationMethod)if(e.round){o.push(t[0].minValue);for(const e of t)o.push(e.maxValue);o=r.round(o),t.forEach(((e,t)=>{e.label=S({minValue:0===t?o[0]:o[t],maxValue:o[t+1],isFirstBreak:0===t,normalizationType:l})}))}else t.forEach(((e,t)=>{e.label=S({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:l})}));else m.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")}function E(e){const t=e.map((e=>new Date(e))),l=t.length;let o=1/0,n=null;for(let i=0;i<l-1;i++){const e=t[i];let a=1/0,r=null;for(let o=i+1;o<l;o++){const l=t[o],n=(e.getFullYear()!==l.getFullYear()?"year":e.getMonth()!==l.getMonth()&&"month")||e.getDate()!==l.getDate()&&"day"||e.getHours()!==l.getHours()&&"hour"||e.getMinutes()!==l.getMinutes()&&"minute"||e.getSeconds()!==l.getSeconds()&&"second"||"millisecond",i=c[n];i<a&&(a=i,r=n)}a<o&&(o=a,n=r)}return n}function C(e){const{value:t,domain:l,fieldInfo:o,dateFormatInterval:n}=e;let i=String(t);const s=l&&"codedValues"in l&&l.codedValues?l.getName(t):null;return s?i=s:"number"==typeof t&&(i=o&&"date"===o.type?a.formatDate(t,n&&a.convertDateFormatToIntlOptions(y[n])):r.format(t)),i}function k(e,t){return"normalizationField"in e&&e.normalizationField?T(e.field,e.normalizationField):"field"in e&&e.field?I(e.field):"valueExpression"in e&&e.valueExpression?B(e.valueExpression,e.valueExpressionTitle,t):null}function I(e){return{type:"field",field:e}}function T(e,t){return{type:"normalized-field",field:e,normalizationField:t}}function B(e,t,l){return{type:"expression",expression:e,title:t,returnType:l}}function D(e,t){const o=[];if("class-breaks"===e.type||"heatmap"===e.type)o.push(k(e,"number"));else if("unique-value"===e.type){const t=e.authoringInfo;if(t&&"relationship"===t.type){if(t.field1&&t.field2){const e=t.field1.field,l=t.field2.field,n=t.field1.normalizationField,i=t.field2.normalizationField;o.push(k({field:e,normalizationField:n})),o.push(k({field:l,normalizationField:i}))}}else{const t=e.uniqueValueInfos?.[0];let l=null;if(t&&t.value){const t=typeof e.uniqueValueInfos[0].value;"string"!==t&&"number"!==t||(l=t)}o.push(k(e,l)),[e.field2,e.field3].forEach((e=>e&&o.push(I(e))))}}else"attributes"in e&&e.attributes?.forEach((e=>o.push(k(e,"number"))));const n=t?t(e):"visualVariables"in e?e.visualVariables:null;return n&&n.forEach((e=>o.push(k(e,"number")))),l.unique(o.filter(i.isSome),((e,t)=>"field"===e.type&&"field"===t.type?e.field===t.field:"normalized-field"===e.type&&"normalized-field"===t.type?e.field===t.field&&e.normalizationField===t.normalizationField:"expression"===e.type&&"expression"===t.type&&e.expression===t.expression))}e.calculateDateFormatInterval=E,e.createClassBreakLabel=S,e.createColorStops=x,e.createUniqueValueLabel=C,e.getAttribute=k,e.getAttributes=D,e.getColorsFromRenderer=v,e.setLabelsForClassBreaks=z,e.timelineDateFormatOptions=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
