/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/Logger","../../core/arrayUtils","../../intl/date","../visualVariables/support/ColorStop","./numberUtils"],(function(e,t,a,n,l,i){"use strict";const o=t.getLogger("esri.renderers.support.utils"),r="<",s=">",u="%",d="â€“",m={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},f={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},c=n.convertDateFormatToIntlOptions("short-date");function p(e,t,a){let n="";return 0===t?n=r+" ":t===a&&(n=s+" "),n+e}function h(e){let t=e.minValue,a=e.maxValue;const n=e.isFirstBreak?"":s+" ",l="percent-of-total"===e.normalizationType?u:"";return t=null==t?"":i.format(t),a=null==a?"":i.format(a),n+t+l+" "+d+" "+a+l}function y(e,t){return"normalizationField"in e&&e.normalizationField?(a=e.field,n=e.normalizationField,{type:"normalized-field",field:a,normalizationField:n}):"field"in e&&e.field?g(e.field):"valueExpression"in e&&e.valueExpression?(l=e.valueExpression,i=e.valueExpressionTitle,{type:"expression",expression:l,title:i,returnType:t}):null;var a,n,l,i}function g(e){return{type:"field",field:e}}e.calculateDateFormatInterval=function(e){const t=e.map((e=>new Date(e))),a=t.length;let n=1/0,l=null;for(let e=0;e<a-1;e++){const i=t[e];let o=1/0,r=null;for(let n=e+1;n<a;n++){const e=t[n],a=(i.getFullYear()!==e.getFullYear()?"year":i.getMonth()!==e.getMonth()&&"month")||i.getDate()!==e.getDate()&&"day"||i.getHours()!==e.getHours()&&"hour"||i.getMinutes()!==e.getMinutes()&&"minute"||i.getSeconds()!==e.getSeconds()&&"second"||"millisecond",l=m[a];l<o&&(o=l,r=a)}o<n&&(n=o,l=r)}return l},e.createClassBreakLabel=h,e.createColorStops=function(e){const{values:t,colors:a,labelIndexes:o,isDate:r,dateFormatOptions:s}=e;return t.map(((e,u)=>{let d=null;if(!o||o.indexOf(u)>-1){let a;a=r?n.formatDate(e,s):i.format(e),a&&(d=p(a,u,t.length-1))}return new l({value:e,color:a[u],label:d})}))},e.createUniqueValueLabel=function(e){const{value:t,domain:a,fieldInfo:l,dateFormatInterval:o}=e;let r=String(t);const s=a&&"codedValues"in a&&a.codedValues?a.getName(t):null;return s?r=s:"number"==typeof t&&(r=l&&"date"===l.type?n.formatDate(t,o&&n.convertDateFormatToIntlOptions(f[o])):i.format(t)),r},e.getAttribute=y,e.getAttributes=function(e,t){const n=[];if("class-breaks"===e.type||"heatmap"===e.type)n.push(y(e,"number"));else if("unique-value"===e.type){const t=e.authoringInfo;if(t&&"relationship"===t.type){if(t.field1&&t.field2){const e=t.field1.field,a=t.field2.field,l=t.field1.normalizationField,i=t.field2.normalizationField;n.push(y({field:e,normalizationField:l})),n.push(y({field:a,normalizationField:i}))}}else{const t=e.uniqueValueInfos[0];let a=null;if(t&&t.value){const t=typeof e.uniqueValueInfos[0].value;"string"!==t&&"number"!==t||(a=t)}n.push(y(e,a)),[e.field2,e.field3].forEach((e=>e&&n.push(g(e))))}}else"dot-density"===e.type&&e.attributes.forEach((e=>n.push(y(e,"number"))));const l=t?t(e):"visualVariables"in e?e.visualVariables:null;return l&&l.forEach((e=>n.push(y(e,"number")))),a.unique(n.filter(Boolean),((e,t)=>"field"===e.type&&"field"===t.type?e.field===t.field:"normalized-field"===e.type&&"normalized-field"===t.type?e.field===t.field&&e.normalizationField===t.normalizationField:"expression"===e.type&&"expression"===t.type&&e.expression===t.expression))},e.setLabelsForClassBreaks=function(e){const t=e.classBreakInfos,a=e.normalizationType;let n=[];if(t&&t.length)if("standard-deviation"!==e.classificationMethod)if(e.round){n.push(t[0].minValue);for(const e of t)n.push(e.maxValue);n=i.round(n),t.forEach(((e,t)=>{e.label=h({minValue:0===t?n[0]:n[t],maxValue:n[t+1],isFirstBreak:0===t,normalizationType:a})}))}else t.forEach(((e,t)=>{e.label=h({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===t,normalizationType:a})}));else o.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")},e.timelineDateFormatOptions=c,e.updateClassBreak=function(e){if("standard-deviation"===e.classificationMethod)return void o.warn("updateClassBreak","cannot update labels for class breaks generated using 'standard-deviation' method.");const t=e.classBreaks,a=e.change,n=a.index,l=a.value,i=t.length;let r=-1,s=-1;0===n?r=n:n===i?s=n-1:(s=n-1,r=n);const u=e.normalizationType;let d=null;r>-1&&r<i&&(d=t[r],d.minValue=l,d.label=h({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===r,normalizationType:u})),s>-1&&s<i&&(d=t[s],d.maxValue=l,d.label=h({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===s,normalizationType:u}))},e.updateColorStops=function(e){const{stops:t,changes:a,isDate:l,dateFormatOptions:o}=e,r=t.map((e=>e.value)),s=[];for(const e of a)s.push(e.index),r[e.index]=e.value;const u=i.round(r,{indexes:s});t.forEach(((e,a)=>{if(e.value=r[a],null!=e.label){let r,s=null;r=l?n.formatDate(u[a],o):i.format(u[a]),r&&(s=p(r,a,t.length-1)),e.label=s}}))},Object.defineProperty(e,"__esModule",{value:!0})}));
