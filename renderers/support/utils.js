/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{unique as e}from"../../core/arrayUtils.js";import l from"../../core/Logger.js";import{getOrCreateMapValue as n}from"../../core/MapUtils.js";import{convertDateFormatToIntlOptions as t,formatDate as o}from"../../intl/date.js";import{format as i,round as a}from"./numberUtils.js";import s from"../visualVariables/support/ColorStop.js";import{getColorFromSymbol as r}from"../../symbols/support/utils.js";import{getRampStops as u}from"../../widgets/Legend/support/colorRampUtils.js";import{getHeatmapRampStops as f}from"../../widgets/Legend/support/heatmapRampUtils.js";const d=l.getLogger("esri.renderers.support.utils"),m={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"â€“"},p={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},c={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},y=t("short-date");function g(e,l,t){n(e,l,(()=>[])).push(...t)}async function h(l){const n=new Map;if("visualVariables"in l&&l.visualVariables){const e=l.visualVariables.filter((e=>"color"===e.type));for(const l of e){const e=l.field||l.valueExpression,t=(await u(l)).map((e=>e.color));g(n,e,t)}}if("heatmap"===l.type){const e=f(l).map((e=>e.color));g(n,l.field,e)}else if("pie-chart"===l.type){for(const e of l.attributes)g(n,e.field,[e.color]);g(n,null,[l?.othersCategory?.color,r(l.backgroundFillSymbol,null)])}else if("dot-density"===l.type){for(const e of l.attributes)g(n,e.field,[e.color]);g(n,null,[l.backgroundColor])}else if("unique-value"===l.type)if("predominance"===l.authoringInfo?.type)for(const e of l.uniqueValueInfos)g(n,e.value.toString(),[r(e.symbol,null)]);else{const e=l.uniqueValueInfos.map((e=>r(e.symbol,null))),{field:t,field2:o,field3:i,valueExpression:a}=l;(t||a)&&g(n,t||a,e),o&&g(n,o,e),i&&g(n,i,e)}else if("class-breaks"===l.type){const e=l.classBreakInfos.map((e=>r(e.symbol,null)));g(n,l.field||l.valueExpression,e)}else"simple"===l.type&&g(n,null,[r(l.symbol,null)]);return"defaultSymbol"in l&&l.defaultSymbol&&g(n,null,[r(l.defaultSymbol,null)]),n.forEach(((l,t)=>{const o=e(l.filter(Boolean),((e,l)=>JSON.stringify(e)===JSON.stringify(l)));n.set(t,o)})),n}function b(e,l,n){let t="";return 0===l?t=m.lt+" ":l===n&&(t=m.gt+" "),t+e}function V(e){const{values:l,colors:n,labelIndexes:t,isDate:a,dateFormatOptions:r}=e;return l.map(((e,u)=>{let f=null;if(!t||t.includes(u)){let n;n=a?o(e,r):i(e),n&&(f=b(n,u,l.length-1))}return new s({value:e,color:n[u],label:f})}))}function v(e){const{stops:l,changes:n,isDate:t,dateFormatOptions:s}=e,r=l.map((e=>e.value)),u=[];for(const o of n)u.push(o.index),r[o.index]=o.value;const f=a(r,{indexes:u});l.forEach(((e,n)=>{if(e.value=r[n],null!=e.label){let a,r=null;a=t?o(f[n],s):i(f[n]),a&&(r=b(a,n,l.length-1)),e.label=r}}))}function x(e){let l=e.minValue,n=e.maxValue;const t=e.isFirstBreak?"":m.gt+" ",o="percent-of-total"===e.normalizationType?m.pct:"";return l=null==l?"":i(l),n=null==n?"":i(n),t+l+o+" "+m.ld+" "+n+o}function F(e){const l=e.classBreakInfos,n=e.normalizationType;let t=[];if(l&&l.length)if("standard-deviation"!==e.classificationMethod)if(e.round){t.push(l[0].minValue);for(const e of l)t.push(e.maxValue);t=a(t),l.forEach(((e,l)=>{e.label=x({minValue:0===l?t[0]:t[l],maxValue:t[l+1],isFirstBreak:0===l,normalizationType:n})}))}else l.forEach(((e,l)=>{e.label=x({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===l,normalizationType:n})}));else d.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")}function z(e){if("standard-deviation"===e.classificationMethod)return void d.warn("updateClassBreak","cannot update labels for class breaks generated using 'standard-deviation' method.");const l=e.classBreaks,n=e.change,t=n.index,o=n.value,i=l.length;let a=-1,s=-1;0===t?a=t:t===i?s=t-1:(s=t-1,a=t);const r=e.normalizationType;let u=null;a>-1&&a<i&&(u=l[a],u.minValue=o,u.label=x({minValue:u.minValue,maxValue:u.maxValue,isFirstBreak:0===a,normalizationType:r})),s>-1&&s<i&&(u=l[s],u.maxValue=o,u.label=x({minValue:u.minValue,maxValue:u.maxValue,isFirstBreak:0===s,normalizationType:r}))}function k(e){const l=e.map((e=>new Date(e))),n=l.length;let t=1/0,o=null;for(let i=0;i<n-1;i++){const e=l[i];let a=1/0,s=null;for(let t=i+1;t<n;t++){const n=l[t],o=(e.getFullYear()!==n.getFullYear()?"year":e.getMonth()!==n.getMonth()&&"month")||e.getDate()!==n.getDate()&&"day"||e.getHours()!==n.getHours()&&"hour"||e.getMinutes()!==n.getMinutes()&&"minute"||e.getSeconds()!==n.getSeconds()&&"second"||"millisecond",i=p[o];i<a&&(a=i,s=o)}a<t&&(t=a,o=s)}return o}function E(e){const{value:l,domain:n,fieldInfo:a,dateFormatInterval:s}=e;let r=String(l);const u=n&&"codedValues"in n&&n.codedValues?n.getName(l):null;return u?r=u:"number"==typeof l&&(r=a&&"date"===a.type?o(l,s&&t(c[s])):i(l)),r}function B(e,l){return"normalizationField"in e&&e.normalizationField?S(e.field,e.normalizationField):"field"in e&&e.field?I(e.field):"valueExpression"in e&&e.valueExpression?j(e.valueExpression,e.valueExpressionTitle,l):null}function I(e){return{type:"field",field:e}}function S(e,l){return{type:"normalized-field",field:e,normalizationField:l}}function j(e,l,n){return{type:"expression",expression:e,title:l,returnType:n}}function T(l,n){const t=[];if("class-breaks"===l.type||"heatmap"===l.type)t.push(B(l,"number"));else if("unique-value"===l.type){const e=l.authoringInfo;if(e&&"relationship"===e.type){if(e.field1&&e.field2){const l=e.field1.field,n=e.field2.field,o=e.field1.normalizationField,i=e.field2.normalizationField;t.push(B({field:l,normalizationField:o})),t.push(B({field:n,normalizationField:i}))}}else{const e=l.uniqueValueInfos[0];let n=null;if(e&&e.value){const e=typeof l.uniqueValueInfos[0].value;"string"!==e&&"number"!==e||(n=e)}t.push(B(l,n)),[l.field2,l.field3].forEach((e=>e&&t.push(I(e))))}}else"attributes"in l&&l.attributes.forEach((e=>t.push(B(e,"number"))));const o=n?n(l):"visualVariables"in l?l.visualVariables:null;return o&&o.forEach((e=>t.push(B(e,"number")))),e(t.filter(Boolean),((e,l)=>"field"===e.type&&"field"===l.type?e.field===l.field:"normalized-field"===e.type&&"normalized-field"===l.type?e.field===l.field&&e.normalizationField===l.normalizationField:"expression"===e.type&&"expression"===l.type&&e.expression===l.expression))}export{k as calculateDateFormatInterval,x as createClassBreakLabel,V as createColorStops,E as createUniqueValueLabel,B as getAttribute,T as getAttributes,h as getColorsFromRenderer,F as setLabelsForClassBreaks,y as timelineDateFormatOptions,z as updateClassBreak,v as updateColorStops};
