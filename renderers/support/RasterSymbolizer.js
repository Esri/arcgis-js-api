/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/JSONSupport","../../core/colorUtils","./colorRampUtils","../../layers/support/RasterInfo","../../layers/support/rasterFunctions/pixelUtils","../../layers/support/rasterFunctions/surfaceUtils"],(function(e,t,r,o,s,a,i,n,l,u,c,p,h,f,m,d,g){"use strict";const S=s.getLogger("esri.renderers.support.RasterSymbolizer");function y(e,t){const{attributeTable:r,bandCount:s}=e;if(!o.isSome(r)||s>1)return!1;if(t){if(null==r.fields.find((e=>e.name.toLowerCase()===t.toLowerCase())))return!1}return!0}function b(e){return"elevation"===e.dataType}function x(e){const{bandCount:t,colormap:r}=e;return o.isSome(r)&&r.length&&1===t}const k={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]};let C=function(t){function r(e){return t.call(this,e)||this}e._inheritsLoose(r,t);var s=r.prototype;return s.bind=function(){const{rendererJSON:e}=this;if(!e)return!1;let t;switch(this.lookup={rendererJSON:{}},e.type){case"uniqueValue":t=this._updateUVRenderer(e);break;case"rasterColormap":t=this._updateColormapRenderer(e);break;case"rasterStretch":t=this._updateStretchRenderer(e);break;case"classBreaks":t=this._updateClassBreaksRenderer(e);break;case"rasterShadedRelief":t=this._updateShadedReliefRenderer(e)}return t},s.symbolize=function(e){let t=e&&e.pixelBlock;if(!this.isValidPixelBlock(t))return t;if(e.simpleStretchParams&&"rasterStretch"===this.rendererJSON.type)return this.simpleStretch(t,e.simpleStretchParams);try{let r;switch(t.pixels.length>3&&(t=d.extractBands(t,[0,1,2])),this.rendererJSON.type){case"uniqueValue":case"rasterColormap":r=this._symbolize_colormap(t);break;case"classBreaks":r=this._symbolize_classBreaks(t);break;case"rasterStretch":r=this._symbolize_stretch(t,e.bandIds);break;case"rasterShadedRelief":{const{extent:o}=e,s=o.spatialReference.isGeographic,a={x:(o.xmax-o.xmin)/t.width,y:(o.ymax-o.ymin)/t.height};r=this._symbolize_shadedRelief(t,{isGCS:s,resolution:a});break}}return r}catch(r){return S.error("symbolize",r.message),t}},s.simpleStretch=function(e,t){if(!this.isValidPixelBlock(e))return e;try{return e.pixels.length>3&&(e=d.extractBands(e,[0,1,2])),d.stretch(e,t)}catch(r){return S.error("symbolize",r.message),e}},s.generateWebGLParameters=function(e){if(["uniqueValue","rasterColormap","classBreaks"].indexOf(this.rendererJSON.type)>-1){var t;const{indexedColormap:e,offset:r}=(null==(t=this.lookup)?void 0:t.colormapLut)||{};return{colormap:e,colormapOffset:r,type:"lut"}}const{pixelBlock:r,isGCS:o,resolution:s,bandIds:a}=e,{rendererJSON:i}=this;return"rasterStretch"===i.type?this.generateStretchWebGLParams(r,i,a):"rasterShadedRelief"===i.type?this.generateShadedReliefWebGLParams(i,o,s):null},s._isLUTChanged=function(e){if(!this.lookup||!this.lookup.rendererJSON)return!0;if("colorRamp"in this.rendererJSON){const t=this.rendererJSON.colorRamp;if(e)return JSON.stringify(t)!==JSON.stringify(this.lookup.rendererJSON.colorRamp);const r={...this.rendererJSON},o={...this.lookup.rendererJSON};return r.colorRamp=null,o.colorRamp=null,JSON.stringify(this.rendererJSON)!==JSON.stringify(this.lookup.rendererJSON)}return JSON.stringify(this.rendererJSON)!==JSON.stringify(this.lookup.rendererJSON)},s._symbolize_colormap=function(e){if(this._isLUTChanged()){if(!this.bind())return e}return d.colorize(e,this.lookup.colormapLut)},s._symbolize_classBreaks=function(e){const t=this.rasterInfo.pixelType,r=["u8","u16","s8","s16"].indexOf(t)>-1;let o;if(this._isLUTChanged()){if(!this.bind())return e}return o=r?d.colorize(e,this.lookup.colormapLut):d.remapColor(e,this.lookup.remapLut),o},s._symbolize_stretch=function(e,t){const{pixelType:r,bandCount:o}=this.rasterInfo,s=this.rendererJSON,a=["u8","u16","s8","s16"].indexOf(r)>-1;let i,n;const{dra:l}=s,u=s.useGamma?s.gamma:null;if("histogramEqualization"===s.stretchType){const r=l?null:this.lookup.histogramLut,o=this.getStretchCutoff(s,e,t,!r),a=d.stretch(e,{...o,gamma:u});n=d.lookupPixels(a,{lut:l?o.histogramLut:r,offset:0})}else if(a){var c;if(l){const o=this.getStretchCutoff(s,e,t);i=d.createStretchLUT({pixelType:r,...o,gamma:u})}else if(this._isLUTChanged()){if(!this.bind())return e;i=this.lookup?this.lookup.stretchLut:null}else i=this.lookup?this.lookup.stretchLut:null;if(!i)return e;o>1&&(null==t?void 0:t.length)===e.pixels.length&&(null==(c=i)?void 0:c.lut.length)===o&&(i={lut:t.map((e=>i.lut[e])),offset:i.offset}),n=d.lookupPixels(e,i)}else{const r=this.getStretchCutoff(s,e,t);n=d.stretch(e,{...r,gamma:u})}if(s.colorRamp){if(this._isLUTChanged(!0)){if(!this.bind())return e}n=d.colorize(n,this.lookup.colormapLut)}return n},s._symbolize_shadedRelief=function(e,t){var r,s;const a=this.rendererJSON,i={...a,...t},n=g.hillshade(e,i);if(!a.colorRamp)return n;let l;if(this._isLUTChanged(!0)){if(!this.bind())return n;l=this.lookup?this.lookup.hsvMap:null}else l=this.lookup?this.lookup.hsvMap:null;if(!l)return n;const u=null!=(r=null==(s=o.unwrap(this.rasterInfo.statistics))?void 0:s[0])?r:{min:0,max:8e3};return g.tintHillshade(n,e,l,u),n},s._updateUVRenderer=function(e){const{bandCount:t,attributeTable:r,statistics:o,pixelType:s}=this.rasterInfo,a=e.field1;if(!a)return!1;const i=["u8","s8"].indexOf(s)>-1&&o&&null!=o[0].min&&null!=o[0].max;if(!(y(this.rasterInfo,a)||1===t&&i))return!1;const n=[];if(r){const t=r.fields.filter((e=>"value"===e.name.toLowerCase()))[0];if(!t)return!1;r.features.forEach((r=>{var o;const s=e.uniqueValueInfos.filter((e=>String(e.value)===String(r.attributes[a])))[0],i=null==s||null==(o=s.symbol)?void 0:o.color;i&&n.push([r.attributes[t.name]].concat(i))}))}else{if("value"!==a.toLowerCase())return!1;e.uniqueValueInfos.forEach((e=>{var t;const r=null==e||null==(t=e.symbol)?void 0:t.color;r&&n.push([parseInt(""+e.value,10)].concat(r))}))}if(0===n.length)return!1;const l=d.createColormapLUT({colormap:n});return this.lookup={rendererJSON:e,colormapLut:l},this.canRenderInWebGL=!0,!0},s._updateColormapRenderer=function(e){if(!x(this.rasterInfo))return!1;const t=e.colormapInfos.map((e=>[e.value].concat(e.color))).sort(((e,t)=>e[0]-t[0]));if(!t||0===t.length)return!1;const r=d.createColormapLUT({colormap:t});return this.lookup={rendererJSON:e,colormapLut:r},this.canRenderInWebGL=!0,!0},s._updateShadedReliefRenderer=function(e){if(!b(this.rasterInfo))return!1;if(e.colorRamp){const t=f.convertColorRampToColormap(e.colorRamp,256,!0),r=d.createColormapLUT({colormap:t}),o=[],s=r.indexedColormap;for(let e=0;e<s.length;e+=4){const t=h.toHSV({r:s[e],g:s[e+1],b:s[e+2]});o.push([t.h/60,t.s/100,255*t.v/100])}this.lookup={rendererJSON:e,colormapLut:r,hsvMap:o}}else this.lookup=null;return this.canRenderInWebGL=!0,!0},s._updateClassBreaksRenderer=function(e){const t=this.rasterInfo.pixelType,r=["u8","u16","s8","s16"].indexOf(t)>-1,o=e.classBreakInfos;if(null==o||!o.length)return!1;const s=o.sort(((e,t)=>e.classMaxValue-t.classMaxValue)),a=s[s.length-1];let i=e.minValue;if(!r){const t=[];for(let e=0;e<s.length;e++){var n;t.push({value:null!=(n=s[e].classMinValue)?n:i,mappedColor:s[e].symbol.color}),i=s[e].classMaxValue}return t.push({value:a.classMaxValue,mappedColor:a.symbol.color}),this.lookup={rendererJSON:e,remapLut:t},this.canRenderInWebGL=!1,!0}const l=[];i=Math.floor(e.minValue);for(let c=0;c<s.length;c++){const e=s[c];for(let t=i;t<e.classMaxValue;t++)l.push([t].concat(e.symbol.color));i=Math.ceil(e.classMaxValue)}a.classMaxValue===i&&l.push([a.classMaxValue].concat(a.symbol.color));const u=d.createColormapLUT({colormap:l,fillUnspecified:!1});return this.lookup={rendererJSON:e,colormapLut:u},this.canRenderInWebGL=!0,!0},s._isHistogramRequired=function(e){return"percentClip"===e||"histogramEqualization"===e},s._updateStretchRenderer=function(e){let{stretchType:t,dra:r}=e;if(!("none"===t||e.statistics||this.rasterInfo.statistics||r))return!1;const s=o.unwrap(e.histograms||this.rasterInfo.histograms);!this._isHistogramRequired(e.stretchType)||null!=s&&s.length||r||(t="minMax");const{gamma:a,useGamma:i,colorRamp:n}=e,l=this.rasterInfo.pixelType,u=!r&&["u8","u16","s8","s16"].indexOf(l)>-1;if("histogramEqualization"===t){const t=s.map((e=>d.createHistogramEqualizationLUT(e)));this.lookup={rendererJSON:e,histogramLut:t}}else if(u){const t=this.getStretchCutoff(e),r=d.createStretchLUT({pixelType:l,...t,gamma:i?a:null});this.lookup={rendererJSON:e,stretchLut:r}}if(n){const t=f.convertColorRampToColormap(n,256,!0);this.lookup||(this.lookup={rendererJSON:e}),this.lookup.colormapLut=d.createColormapLUT({colormap:t}),this.lookup.rendererJSON=e}return this.canRenderInWebGL=!0,!0},s.getStretchCutoff=function(e,t,r,s){var a;let i,n,l=e.stretchType;var u;if(e.dra)if("minMax"===l&&t.statistics)i=t.statistics.map((e=>[e.minValue,e.maxValue,0,0]));else{const e=d.estimateStatisticsHistograms(t);i=e.statistics,n=e.histograms}else i=(null==(u=e.statistics)?void 0:u.length)>0?e.statistics:o.unwrap(this.rasterInfo.statistics),n=e.histograms||o.unwrap(this.rasterInfo.histograms);!this._isHistogramRequired(l)||null!=(a=n)&&a.length||(l="minMax");const c=i||n?(i||n).length:this.rasterInfo.bandCount,p=[],h=[];let f,m,g,S,y,b,x,C,L,O,_,R;switch(i&&!Array.isArray(i[0])&&(i=i.map((e=>[e.min,e.max,e.avg,e.stddev]))),l){case"none":{const e=k[this.rasterInfo.pixelType]||k.f32;for(C=0;C<c;C++)p[C]=e[0],h[C]=e[1]}break;case"minMax":for(C=0;C<c;C++)p[C]=i[C][0],h[C]=i[C][1];break;case"standardDeviation":for(C=0;C<c;C++)p[C]=i[C][2]-e.numberOfStandardDeviations*i[C][3],h[C]=i[C][2]+e.numberOfStandardDeviations*i[C][3],p[C]<i[C][0]&&(p[C]=i[C][0]),h[C]>i[C][1]&&(h[C]=i[C][1]);break;case"histogramEqualization":for(C=0;C<c;C++)p[C]=n[C].min,h[C]=n[C].max;break;case"percentClip":for(C=0;C<n.length;C++){for(f=n[C],y=new Uint32Array(f.size),S=f.counts,g=0,m=(f.max-f.min)/f.size,x=-.5===f.min&&1===m?.5:0,L=0;L<f.size;L++)g+=S[L],y[L]=g;for(b=e.minPercent*g/100,L=0;L<f.size;L++)if(y[L]>b){p[C]=f.min+m*(L+x);break}for(b=(1-e.maxPercent/100)*g,L=f.size-2;L>=0;L--)if(y[L]<b){h[C]=f.min+m*(L+2-x);break}}break;default:for(C=0;C<c;C++)p[C]=i[C][0],h[C]=i[C][1]}"histogramEqualization"===l?(_=n[0].size||256,O=0,s&&(R=n.map((e=>d.createHistogramEqualizationLUT(e))))):(_=e.max||255,O=e.min||0);const v={minCutOff:p,maxCutOff:h,outMax:_,outMin:O,histogramLut:R};return this.getSelectedBandCutoffs(v,r)},s.getSelectedBandCutoffs=function(e,t){if(null==t||0===t.length)return e;const r=Math.max.apply(null,t),{minCutOff:o,maxCutOff:s,outMin:a,outMax:i,histogramLut:n}=e;return o.length===t.length||o.length<=r?e:{minCutOff:t.map((e=>o[e])),maxCutOff:t.map((e=>s[e])),histogramLut:n?t.map((e=>n[e])):null,outMin:a,outMax:i}},s.generateStretchWebGLParams=function(e,t,r){var o;let s=null,a=null;const i=this.lookup&&this.lookup.colormapLut;t.colorRamp&&i&&(s=i.indexedColormap,a=i.offset),"histogramEqualization"===t.stretchType&&(t={...t,stretchType:"minMax"});const{gamma:n}=t,l=!!(t.useGamma&&n&&n.some((e=>1!==e))),{minCutOff:u,maxCutOff:c,outMin:p,outMax:h}=this.getStretchCutoff(t,e,r),f=null==(o=e)?void 0:o.getPlaneCount();2===f&&((e=e.clone()).statistics=[e.statistics[0]],e.pixels=[e.pixels[0]]);const m=Math.min(3,(null==r?void 0:r.length)||f||this.rasterInfo.bandCount),d=new Float32Array(m),g=s||l?1:255;let S;for(S=0;S<m;S++)d[S]=(h-p)/(c[S]-u[S])/g;const y=new Float32Array(m);if(l)for(S=0;S<m;S++)n[S]>1?n[S]>2?y[S]=6.5+(n[S]-2)**2.5:y[S]=6.5+100*(2-n[S])**4:y[S]=1;return{bandCount:m,outMin:p/g,outMax:h/g,minCutOff:u,maxCutOff:c,factor:d,useGamma:l,gamma:l?n:[1,1,1],gammaCorrection:l?y:[1,1,1],colormap:s,colormapOffset:a,type:"stretch"}},s.generateShadedReliefWebGLParams=function(e,t,r){var s,a,i;let n=null,l=null;const u=this.lookup&&this.lookup.colormapLut;e.colorRamp&&u&&(n=u.indexedColormap,l=u.offset);const c={...e,isGCS:t,resolution:r},p=g.calculateHillshadeParams(c),h=null==(s=o.unwrap(this.rasterInfo.statistics))?void 0:s[0];return{...p,minValue:null!=(a=h.min)?a:0,maxValue:null!=(i=h.max)?i:8e3,hillshadeType:"traditional"===e.hillshadeType?0:1,type:"hillshade",colormap:n,colormapOffset:l}},s.isValidPixelBlock=function(e){return!!(e&&e.pixels&&e.pixels.length>0&&0!==e.validPixelCount)},r}(p.JSONSupport);return t.__decorate([i.property({json:{write:!0}})],C.prototype,"rendererJSON",void 0),t.__decorate([i.property({type:m,json:{write:!0}})],C.prototype,"rasterInfo",void 0),t.__decorate([i.property({json:{write:!0}})],C.prototype,"lookup",void 0),t.__decorate([i.property()],C.prototype,"canRenderInWebGL",void 0),C=t.__decorate([n.subclass("esri.renderers.support.RasterSymbolizer")],C),C}));
