// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../rasterRenderers","../../core/JSONSupport","../../core/Logger","../../core/accessorSupport/decorators","../../layers/support/RasterInfo","../../layers/support/rasterFunctions/pixelUtils","../support/colorRampUtils"],function(r,e,t,o,s,a,n,i,l,u,p,c,m,f){var h=u.getLogger("esri.renderers.support.RasterSymbolizer");return function(r){function e(e){return r.call(this)||this}return o(e,r),e.prototype.readRenderer=function(r,e,t){return i.read(r,t)},e.prototype.bind=function(){if(this.lookup={},!this.renderer)return!1;var r;switch(this.renderer.type){case"unique-value":r=this._updateUVRenderer(this.renderer);break;case"raster-colormap":r=this._updateColormapRenderer(this.renderer);break;case"raster-stretch":r=this._updateStretchRenderer(this.renderer);break;case"class-breaks":r=this._updateClassBreaksRenderer(this.renderer)}return r},e.prototype.symbolize=function(r){if(!(r&&r.pixels&&r.pixels.length>0&&0!==r.validPixelCount))return r;try{r.pixels.length>3&&(r=m.extractBands(r,[0,1,2]));var e=void 0;switch(this.renderer.type){case"unique-value":case"raster-colormap":e=this._symbolize_colormap(r);break;case"class-breaks":e=this._symbolize_classBreaks(r);break;case"raster-stretch":e=this._symbolize_stretch(r)}return e}catch(e){return h.error("symbolize",e.message),r}},e.prototype._isLUTChanged=function(r){if(!this.lookup)return!0;if("raster-stretch"===this.renderer.type){var e=this.renderer.colorRamp;if(r)return JSON.stringify(e.toJSON())!==JSON.stringify(this.lookup.rendererJson.colorRamp);var o=t({},this.renderer.toJSON()),s=t({},this.lookup.rendererJson);return o.colorRamp=null,s.colorRamp=null,JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)}return JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)},e.prototype._symbolize_colormap=function(r){if(this._isLUTChanged()){if(!this.bind())return r}return m.colorize(r,this.lookup.lut)},e.prototype._symbolize_classBreaks=function(r){var e=this.rasterInfo.pixelType,t=["u8","u16","s8","s16"].indexOf(e)>-1;if(this._isLUTChanged()){if(!this.bind())return r}return t?m.colorize(r,this.lookup.lut):m.remapColor(r,this.lookup.lut)},e.prototype._symbolize_stretch=function(r){var e,o,s,a=this.rasterInfo.pixelType,n=this.renderer,i=["u8","u16","s8","s16"].indexOf(a)>-1,l=n.gamma,u=n.useGamma;if(i){if(n.dynamicRangeAdjustment)o=this.getStretchCutoff(n,r),e=m.createStretchLUT(t({pixelType:a},o,{gamma:u?l:null}));else if(this._isLUTChanged()){var p=this.bind();if(!p)return r;e=this.lookup?this.lookup.lut:null}else e=this.lookup?this.lookup.lut:null;if(!e)return r;s=m.lookupPixels(r,e)}else o=this.getStretchCutoff(n,r),s=m.stretch(r,t({},o,{gamma:u?l:null}));if(n.colorRamp){if(this._isLUTChanged(!0)){var p=this.bind();if(!p)return r}s=m.colorize(s,this.lookup.colorRampLut)}return s},e.prototype._updateUVRenderer=function(r){var e=this.rasterInfo,t=e.bandCount,o=e.attributeTable,s=e.statistics,a=e.pixelType,n=["u8","s8"].indexOf(a)>-1&&s&&null!=s[0].min&&null!=s[0].max;if(1!==t||!o&&!n)return!1;var i=r.field;if(!i)return!1;var l=[];if(o){var u=o.fields.filter(function(r){return"value"===r.name.toLowerCase()})[0];if(!u)return!1;o.features.forEach(function(e){var t=r.uniqueValueInfos.filter(function(r){return String(r.value)===String(e.attributes[i])})[0],o=t&&t.symbol&&t.symbol.color;o&&l.push([e.attributes[u.name],o.r,o.g,o.b,o.a>1?o.a:Math.round(255*o.a)])})}else{if("Value"!==i.toLowerCase())return!1;r.uniqueValueInfos.forEach(function(r){var e=r&&r.symbol&&r.symbol.color;e&&l.push([parseInt(r.value,10),e.r,e.g,e.b,e.a>1?e.a:Math.round(255*e.a)])})}if(0===l.length)return!1;var p=m.createColormapLUT({colormap:l});return this.lookup={rendererJson:r.toJSON(),lut:p},!0},e.prototype._updateColormapRenderer=function(r){var e=r.extractColormap();if(!e||0===e.length)return!1;var t=m.createColormapLUT({colormap:e});return this.lookup={rendererJson:r.toJSON(),lut:t},!0},e.prototype._updateClassBreaksRenderer=function(r){var e=this.rasterInfo.pixelType,t=["u8","u16","s8","s16"].indexOf(e)>-1,o=r.classBreakInfos;if(!o||0===o.length)return!1;var s=o.sort(function(r,e){return r.minValue-e.minValue}),a=s[s.length-1];if(!t){var n=s.map(function(r){return{value:r.minValue,mappedColor:[r.symbol.color.r,r.symbol.color.g,r.symbol.color.b,r.symbol.color.a>1?r.symbol.color.a:Math.round(255*r.symbol.color.a)]}});return n.push({value:a.maxValue,mappedColor:[a.symbol.color.g,a.symbol.color.b,a.symbol.color.a>1?a.symbol.color.a:Math.round(255*a.symbol.color.a)]}),this.lookup={rendererJson:r.toJSON(),lut:n},!0}var i,l=[],u=0;s.forEach(function(r){i=Math.ceil(r.minValue),u=Math.floor(r.maxValue);for(var e=i;e<u;e++)l.push([e,r.symbol.color.r,r.symbol.color.g,r.symbol.color.b,r.symbol.color.a>1?r.symbol.color.a:Math.round(255*r.symbol.color.a)])}),l.push([a.maxValue,a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,a.symbol.color.a>1?a.symbol.color.a:Math.round(255*a.symbol.color.a)]);var p=m.createColormapLUT({colormap:l,fillUnspecified:!1});return this.lookup={rendererJson:r.toJSON(),lut:p},!0},e.prototype._updateStretchRenderer=function(r){if(!(r.statistics||this.rasterInfo.statistics||r.dynamicRangeAdjustment))return!1;var e=r.histograms||this.rasterInfo.histograms;if(!r.dynamicRangeAdjustment&&"percent-clip"===r.stretchType&&!e)return!1;var o=r.gamma,s=r.useGamma,a=r.colorRamp,n=this.rasterInfo.pixelType;if(!r.dynamicRangeAdjustment&&["u8","u16","s8","s16"].indexOf(n)>-1){var i=this.getStretchCutoff(r),l=m.createStretchLUT(t({pixelType:n},i,{gamma:s?o:null}));this.lookup={rendererJson:r.toJSON(),lut:l}}if(a){var u=f.convertColorRampToColormap(a,256);this.lookup.colorRampLut=m.createColormapLUT({colormap:u}),this.lookup.rendererJson=r.toJSON()}return!0},e.prototype.getStretchCutoff=function(r,e){var t,o,s=r.stretchType;if(r.dynamicRangeAdjustment)if("min-max"===s&&e.statistics)t=e.statistics.map(function(r){return[r.minValue,r.maxValue,0,0]});else{var a=m.estimateStatisticsHistograms(e);t=a.statistics,o=a.histograms}else t=r.statistics,o=r.histograms||this.rasterInfo.histograms;var n,i,l,u,p,c,f,h,d,y=t||o?(t||o).length:this.rasterInfo.bandCount,b=[],g=[];switch(t[0]instanceof Array||(t=t.map(function(r){return[r.min,r.max,r.avg,r.stddev]})),s){case"min-max":for(h=0;h<y;h++)b[h]=t[h][0],g[h]=t[h][1];break;case"standard-deviation":for(h=0;h<y;h++)b[h]=t[h][2]-r.numberOfStandardDeviations*t[h][3],g[h]=t[h][2]+r.numberOfStandardDeviations*t[h][3],b[h]<t[h][0]&&(b[h]=t[h][0]),g[h]>t[h][1]&&(g[h]=t[h][1]);break;case"percent-clip":for(h=0;h<y;h++){for(n=o[h],p=new Uint32Array(n.size),u=n.counts,l=0,i=(n.max-n.min)/n.size,f=-.5===n.min&&1===i?.5:0,d=0;d<n.size;d++)l+=u[d],p[d]=l;for(c=r.minPercent*l/100,d=0;d<n.size;d++)if(p[d]>c){b[h]=n.min+i*(d+f);break}for(c=(1-r.maxPercent/100)*l,d=n.size-2;d>=0;d--)if(p[d]<c){g[h]=n.min+i*(d+2-f);break}}break;default:for(h=0;h<y;h++)b[h]=t[h][0],g[h]=t[h][1]}return{minCutOff:b,maxCutOff:g,outMax:r.outputMax||255,outMin:r.outputMin||0}},s([p.property({types:i.rasterRendererTypes,json:{write:!0}})],e.prototype,"renderer",void 0),s([p.reader("renderer")],e.prototype,"readRenderer",null),s([p.property({type:c,json:{write:!0}})],e.prototype,"rasterInfo",void 0),s([p.property({json:{write:!0}})],e.prototype,"lookup",void 0),e=s([p.subclass("esri.renderers.support.RasterSymbolizer")],e)}(p.declared(l.JSONSupport))});