/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/colorUtils","../../core/JSONSupport","../../core/Logger","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../layers/support/RasterInfo","../../layers/support/rasterFunctions/pixelUtils","../../layers/support/rasterFunctions/surfaceUtils","./colorRampUtils"],(function(e,t,r,o,s,a,i,n,l,u,c,p,h,m){"use strict";const f=s.getLogger("esri.renderers.support.RasterSymbolizer");function d(e,t){const{attributeTable:r,bandCount:o}=e;if(!a.isSome(r)||o>1)return!1;if(t){if(null==r.fields.find((e=>e.name.toLowerCase()===t.toLowerCase())))return!1}return!0}function S(e){return"elevation"===e.dataType}function g(e){const{bandCount:t,colormap:r}=e;return a.isSome(r)&&r.length&&1===t}const y={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]};let b=function(t){function o(e){return t.call(this,e)||this}e._inheritsLoose(o,t);var s=o.prototype;return s.bind=function(){const{rendererJSON:e}=this;if(!e)return!1;let t;switch(this.lookup={rendererJSON:{}},e.type){case"uniqueValue":t=this._updateUVRenderer(e);break;case"rasterColormap":t=this._updateColormapRenderer(e);break;case"rasterStretch":t=this._updateStretchRenderer(e);break;case"classBreaks":t=this._updateClassBreaksRenderer(e);break;case"rasterShadedRelief":t=this._updateShadedReliefRenderer(e);break;case"vectorField":t=this._updateVectorFieldRenderer()}return t},s.symbolize=function(e){let t=e&&e.pixelBlock;if(!x(t))return t;if(e.simpleStretchParams&&"rasterStretch"===this.rendererJSON.type)return this.simpleStretch(t,e.simpleStretchParams);try{let r;switch(t.pixels.length>3&&(t=p.extractBands(t,[0,1,2])),this.rendererJSON.type){case"uniqueValue":case"rasterColormap":r=this._symbolize_colormap(t);break;case"classBreaks":r=this._symbolize_classBreaks(t);break;case"rasterStretch":r=this._symbolize_stretch(t,e.bandIds);break;case"rasterShadedRelief":{const{extent:o}=e,s=o.spatialReference.isGeographic,a={x:(o.xmax-o.xmin)/t.width,y:(o.ymax-o.ymin)/t.height};r=this._symbolize_shadedRelief(t,{isGCS:s,resolution:a});break}}return r}catch(r){return f.error("symbolize",r.message),t}},s.simpleStretch=function(e,t){if(!x(e))return e;try{return e.pixels.length>3&&(e=p.extractBands(e,[0,1,2])),p.stretch(e,t)}catch(r){return f.error("symbolize",r.message),e}},s.generateWebGLParameters=function(e){if(["uniqueValue","rasterColormap","classBreaks"].indexOf(this.rendererJSON.type)>-1){var t;const{indexedColormap:e,offset:r}=(null==(t=this.lookup)?void 0:t.colormapLut)||{};return{colormap:e,colormapOffset:r,type:"lut"}}const{pixelBlock:r,isGCS:o,resolution:s,bandIds:a}=e,{rendererJSON:i}=this;return"rasterStretch"===i.type?this.generateStretchWebGLParams(r,i,a):"rasterShadedRelief"===i.type?this.generateShadedReliefWebGLParams(i,o,s):"vectorField"===i.type?this._generateVectorFieldWebGLParams(i):null},s._isLUTChanged=function(e){if(!this.lookup||!this.lookup.rendererJSON)return!0;if("colorRamp"in this.rendererJSON){const t=this.rendererJSON.colorRamp;return e?JSON.stringify(t)!==JSON.stringify(this.lookup.rendererJSON.colorRamp):(this.rendererJSON,this.lookup.rendererJSON,JSON.stringify(this.rendererJSON)!==JSON.stringify(this.lookup.rendererJSON))}return JSON.stringify(this.rendererJSON)!==JSON.stringify(this.lookup.rendererJSON)},s._symbolize_colormap=function(e){if(this._isLUTChanged()){if(!this.bind())return e}return p.colorize(e,this.lookup.colormapLut)},s._symbolize_classBreaks=function(e){const t=this.rasterInfo.pixelType,r=["u8","u16","s8","s16"].indexOf(t)>-1;if(this._isLUTChanged()){if(!this.bind())return e}return r?p.colorize(e,this.lookup.colormapLut):p.remapColor(e,this.lookup.remapLut)},s._symbolize_stretch=function(e,t){const{pixelType:r,bandCount:o}=this.rasterInfo,s=this.rendererJSON,i=["u8","u16","s8","s16"].indexOf(r)>-1;let n,l;const{dra:u}=s,c=s.useGamma?s.gamma:null;if("histogramEqualization"===s.stretchType){const r=u?null:this.lookup.histogramLut,o=this.getStretchCutoff(s,e,t,!r),a=p.stretch(e,{...o,gamma:c});l=p.lookupPixels(a,{lut:u?o.histogramLut:r,offset:0})}else if(i){var h,m;if(u){const o=this.getStretchCutoff(s,e,t);n=p.createStretchLUT({pixelType:r,...o,gamma:c})}else if(this._isLUTChanged()){if(!this.bind())return e;n=this.lookup?this.lookup.stretchLut:null}else n=this.lookup?this.lookup.stretchLut:null;if(!n)return e;o>1&&(null==t?void 0:t.length)===(null==(h=a.unwrap(e))?void 0:h.pixels.length)&&(null==(m=n)?void 0:m.lut.length)===o&&(n={lut:t.map((e=>n.lut[e])),offset:n.offset}),l=p.lookupPixels(e,n)}else{const r=this.getStretchCutoff(s,e,t);l=p.stretch(e,{...r,gamma:c})}if(s.colorRamp){if(this._isLUTChanged(!0)){if(!this.bind())return e}l=p.colorize(l,this.lookup.colormapLut)}return l},s._symbolize_shadedRelief=function(e,t){var r,o;const s=this.rendererJSON,i={...s,...t},n=h.hillshade(e,i);if(!s.colorRamp)return n;let l;if(this._isLUTChanged(!0)){if(!this.bind())return n;l=this.lookup?this.lookup.hsvMap:null}else l=this.lookup?this.lookup.hsvMap:null;if(!l)return n;const u=null!=(r=null==(o=a.unwrap(this.rasterInfo.statistics))?void 0:o[0])?r:{min:0,max:8e3};return h.tintHillshade(n,e,l,u),n},s._updateVectorFieldRenderer=function(){const{bandCount:e,dataType:t}=this.rasterInfo;return 2===e&&("vector-magdir"===t||"vector-uv"===t)},s._updateUVRenderer=function(e){const{bandCount:t,attributeTable:r,pixelType:o}=this.rasterInfo,s=e.field1;if(!s)return!1;const a=e.defaultSymbol,i=1===t&&["u8","s8"].includes(o);if(!d(this.rasterInfo,s)&&!i)return!1;const n=[];if(r){const t=r.fields.filter((e=>"value"===e.name.toLowerCase()))[0];if(!t)return!1;r.features.forEach((r=>{var o;const i=e.uniqueValueInfos.filter((e=>String(e.value)===String(r.attributes[s])))[0],l=null==i||null==(o=i.symbol)?void 0:o.color;l?n.push([r.attributes[t.name]].concat(l)):a&&n.push([r.attributes[t.name]].concat(a.color))}))}else{if("value"!==s.toLowerCase())return!1;e.uniqueValueInfos.forEach((e=>{var t;const r=null==e||null==(t=e.symbol)?void 0:t.color;r?n.push([parseInt(""+e.value,10)].concat(r)):a&&n.push([parseInt(""+e.value,10)].concat(a.color))}))}if(0===n.length)return!1;const l=p.createColormapLUT({colormap:n});return this.lookup={rendererJSON:e,colormapLut:l},this.canRenderInWebGL=!0,!0},s._updateColormapRenderer=function(e){if(!g(this.rasterInfo))return!1;const t=e.colormapInfos.map((e=>[e.value].concat(e.color))).sort(((e,t)=>e[0]-t[0]));if(!t||0===t.length)return!1;const r=p.createColormapLUT({colormap:t});return this.lookup={rendererJSON:e,colormapLut:r},this.canRenderInWebGL=!0,!0},s._updateShadedReliefRenderer=function(e){if(!S(this.rasterInfo))return!1;if(e.colorRamp){const t=m.convertColorRampToColormap(e.colorRamp,256,!0),o=p.createColormapLUT({colormap:t}),s=[],a=o.indexedColormap;for(let e=0;e<a.length;e+=4){const t=r.toHSV({r:a[e],g:a[e+1],b:a[e+2]});s.push([t.h/60,t.s/100,255*t.v/100])}this.lookup={rendererJSON:e,colormapLut:o,hsvMap:s}}else this.lookup=null;return this.canRenderInWebGL=!0,!0},s._updateClassBreaksRenderer=function(e){const t=this.rasterInfo.pixelType,r=["u8","u16","s8","s16"].indexOf(t)>-1,o=e.classBreakInfos;if(null==o||!o.length)return!1;const s=o.sort(((e,t)=>e.classMaxValue-t.classMaxValue)),a=s[s.length-1];let i=e.minValue;if(!r){const t=[];for(let e=0;e<s.length;e++){var n;t.push({value:null!=(n=s[e].classMinValue)?n:i,mappedColor:s[e].symbol.color}),i=s[e].classMaxValue}return t.push({value:a.classMaxValue,mappedColor:a.symbol.color}),this.lookup={rendererJSON:e,remapLut:t},this.canRenderInWebGL=!1,!0}const l=[];i=Math.floor(e.minValue);for(let c=0;c<s.length;c++){const e=s[c];for(let t=i;t<e.classMaxValue;t++)l.push([t].concat(e.symbol.color));i=Math.ceil(e.classMaxValue)}a.classMaxValue===i&&l.push([a.classMaxValue].concat(a.symbol.color));const u=p.createColormapLUT({colormap:l,fillUnspecified:!1});return this.lookup={rendererJSON:e,colormapLut:u},this.canRenderInWebGL=!0,!0},s._isHistogramRequired=function(e){return"percentClip"===e||"histogramEqualization"===e},s._isValidRasterStatistics=function(e){return a.isSome(e)&&e.length>0&&null!=e[0].min&&null!=e[0].max},s._updateStretchRenderer=function(e){var t;let{stretchType:r,dra:o}=e;if(!("none"===r||null!=(t=e.statistics)&&t.length||this._isValidRasterStatistics(this.rasterInfo.statistics)||o))return!1;const s=a.unwrap(e.histograms||this.rasterInfo.histograms);!this._isHistogramRequired(e.stretchType)||null!=s&&s.length||o||(r="minMax");const{gamma:i,useGamma:n,colorRamp:l}=e,u=this.rasterInfo.pixelType,c=!o&&["u8","u16","s8","s16"].indexOf(u)>-1;if("histogramEqualization"===r){const t=s.map((e=>p.createHistogramEqualizationLUT(e)));this.lookup={rendererJSON:e,histogramLut:t}}else if(c){const t=this.getStretchCutoff(e),r=p.createStretchLUT({pixelType:u,...t,gamma:n?i:null});this.lookup={rendererJSON:e,stretchLut:r}}if(l){const t=m.convertColorRampToColormap(l,256,!0);this.lookup||(this.lookup={rendererJSON:e}),this.lookup.colormapLut=p.createColormapLUT({colormap:t}),this.lookup.rendererJSON=e}return this.canRenderInWebGL=!0,!0},s.getStretchCutoff=function(e,t=null,r,o){var s,i,n;let l,u,c=e.stretchType;var h;if(e.dra)if("minMax"===c&&a.isSome(t)&&t.statistics)l=t.statistics.map((e=>[e.minValue,e.maxValue,0,0]));else{const e=p.estimateStatisticsHistograms(t);l=a.isSome(e)?e.statistics:null,u=a.isSome(e)?e.histograms:null}else l=(null==(h=e.statistics)?void 0:h.length)>0?e.statistics:a.unwrap(this.rasterInfo.statistics),u=e.histograms||a.unwrap(this.rasterInfo.histograms);!this._isHistogramRequired(c)||null!=(s=u)&&s.length||(c="minMax");const m=(null==(i=l)?void 0:i.length)||(null==(n=u)?void 0:n.length)||this.rasterInfo.bandCount,f=[],d=[];let S,g,b,x,k,C,v,_,L,O,R,T;switch(l&&!Array.isArray(l[0])&&(l=l.map((e=>[e.min,e.max,e.avg,e.stddev]))),c){case"none":{const e=y[this.rasterInfo.pixelType]||y.f32;for(_=0;_<m;_++)f[_]=e[0],d[_]=e[1]}break;case"minMax":for(_=0;_<m;_++)f[_]=l[_][0],d[_]=l[_][1];break;case"standardDeviation":for(_=0;_<m;_++)f[_]=l[_][2]-e.numberOfStandardDeviations*l[_][3],d[_]=l[_][2]+e.numberOfStandardDeviations*l[_][3],f[_]<l[_][0]&&(f[_]=l[_][0]),d[_]>l[_][1]&&(d[_]=l[_][1]);break;case"histogramEqualization":for(_=0;_<m;_++)f[_]=u[_].min,d[_]=u[_].max;break;case"percentClip":for(_=0;_<u.length;_++){for(S=u[_],k=new Uint32Array(S.size),x=S.counts,b=0,g=(S.max-S.min)/S.size,v=-.5===S.min&&1===g?.5:0,L=0;L<S.size;L++)b+=x[L],k[L]=b;for(C=e.minPercent*b/100,L=0;L<S.size;L++)if(k[L]>C){f[_]=S.min+g*(L+v);break}for(C=(1-e.maxPercent/100)*b,L=S.size-2;L>=0;L--)if(k[L]<C){d[_]=S.min+g*(L+2-v);break}}break;default:for(_=0;_<m;_++)f[_]=l[_][0],d[_]=l[_][1]}"histogramEqualization"===c?(R=u[0].size||256,O=0,o&&(T=u.map((e=>p.createHistogramEqualizationLUT(e))))):(R=e.max||255,O=e.min||0);const I={minCutOff:f,maxCutOff:d,outMax:R,outMin:O,histogramLut:T};return this.getSelectedBandCutoffs(I,r)},s.getSelectedBandCutoffs=function(e,t){if(null==t||0===t.length)return e;const r=Math.max.apply(null,t),{minCutOff:o,maxCutOff:s,outMin:a,outMax:i,histogramLut:n}=e;return o.length===t.length||o.length<=r?e:{minCutOff:t.map((e=>o[e])),maxCutOff:t.map((e=>s[e])),histogramLut:n?t.map((e=>n[e])):null,outMin:a,outMax:i}},s.generateStretchWebGLParams=function(e,t,r){let o=null,s=null;const i=this.lookup&&this.lookup.colormapLut;t.colorRamp&&i&&(o=i.indexedColormap,s=i.offset),"histogramEqualization"===t.stretchType&&(t={...t,stretchType:"minMax"});const{gamma:n}=t,l=!!(t.useGamma&&n&&n.some((e=>1!==e))),{minCutOff:u,maxCutOff:c,outMin:p,outMax:h}=this.getStretchCutoff(t,e,r);let m=0;a.isSome(e)&&(m=e.getPlaneCount(),2===m&&((e=e.clone()).statistics=[e.statistics[0]],e.pixels=[e.pixels[0]]));const f=Math.min(3,(null==r?void 0:r.length)||m||this.rasterInfo.bandCount),d=new Float32Array(f),S=o||l?1:255;let g;for(g=0;g<f;g++)d[g]=(h-p)/(c[g]-u[g])/S;const y=new Float32Array(f);if(l)for(g=0;g<f;g++)n[g]>1?n[g]>2?y[g]=6.5+(n[g]-2)**2.5:y[g]=6.5+100*(2-n[g])**4:y[g]=1;return{bandCount:f,outMin:p/S,outMax:h/S,minCutOff:u,maxCutOff:c,factor:d,useGamma:l,gamma:l?n:[1,1,1],gammaCorrection:l?y:[1,1,1],colormap:o,colormapOffset:s,stretchType:t.stretchType,type:"stretch"}},s.generateShadedReliefWebGLParams=function(e,t,r){var o,s,i;let n=null,l=null;const u=this.lookup&&this.lookup.colormapLut;e.colorRamp&&u&&(n=u.indexedColormap,l=u.offset);const c={...e,isGCS:t,resolution:r},p=h.calculateHillshadeParams(c),m=null==(o=a.unwrap(this.rasterInfo.statistics))?void 0:o[0];return{...p,minValue:null!=(s=null==m?void 0:m.min)?s:0,maxValue:null!=(i=null==m?void 0:m.max)?i:8e3,hillshadeType:"traditional"===e.hillshadeType?0:1,type:"hillshade",colormap:n,colormapOffset:l}},s._generateVectorFieldWebGLParams=function(e){var t,r,o,s,i;const{style:n,inputUnit:l,outputUnit:u,visualVariables:c,symbolTileSize:p,flowRepresentation:h}=e;let m;const f=null!=(t=null==c?void 0:c.find((e=>"sizeInfo"===e.type)))?t:{type:"sizeInfo",field:"Magnitude",maxDataValue:null==(r=this.rasterInfo.statistics)?void 0:r[0].max,maxSize:.8*p,minDataValue:null==(o=this.rasterInfo.statistics)?void 0:o[0].min,minSize:.2*p},d=f?f.minDataValue:null==(s=this.rasterInfo.statistics)?void 0:s[0].min,S=f?f.maxDataValue:null==(i=this.rasterInfo.statistics)?void 0:i[0].max,g=a.isSome(f.maxSize)&&a.isSome(f.minSize)?[f.minSize/p,f.maxSize/p]:[.2,.8];if("wind_speed"===n||"simple_scalar"===n){const e=(g[0]+g[1])/2;g[0]=g[1]=e}const y=a.isSome(d)&&a.isSome(S)?[d,S]:null;if("classified_arrow"===n)if(a.isSome(d)&&a.isSome(S)&&a.isSome(f)){m=[];const e=(f.maxDataValue-f.minDataValue)/5;for(let t=0;t<6;t++)m.push(f.minDataValue+e*t)}else m=[0,1e-6,3.5,7,10.5,14];const b="flow_to"===h===("ocean_current_kn"===n||"ocean_current_m"===n)?0:Math.PI,x=null==c?void 0:c.find((e=>"rotationInfo"===e.type));return{breakValues:m,dataRange:y,inputUnit:l,outputUnit:u,symbolTileSize:p,symbolPercentRange:g,style:n||"single_arrow",rotation:b,rotationType:(null==x?void 0:x.rotationType)||e.rotationType,type:"vectorField"}},o}(o.JSONSupport);function x(e){return p.isValidPixelBlock(e)&&0!==e.validPixelCount}return t.__decorate([i.property({json:{write:!0}})],b.prototype,"rendererJSON",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],b.prototype,"rasterInfo",void 0),t.__decorate([i.property({json:{write:!0}})],b.prototype,"lookup",void 0),t.__decorate([i.property()],b.prototype,"canRenderInWebGL",void 0),b=t.__decorate([u.subclass("esri.renderers.support.RasterSymbolizer")],b),b}));
