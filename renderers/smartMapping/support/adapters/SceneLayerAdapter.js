// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Graphic","../../../../core/Error","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../layers/support/fieldUtils","../../statistics/support/utils","../utils","./FeatureLayerAdapter","./LayerAdapter","./support/utils","../../../../tasks/support/FeatureSet"],function(e,t,r,a,s,i,n,o,u,l,c,p,d,m,h,f,y,g,v){return function(e){function t(t){return e.call(this,t)||this}return a(t,e),t.prototype._hasCachedStatistics=function(e){return this.layer.hasCachedStatistics(e)},t.prototype._fetchFeaturesFromMemory=function(e,t){return e?e.whenLayerView(this.layer).then(function(e){var r=c.whenFalseOnce(e,"updating").then(function(){return e.queryFeatures(t)}).then(function(e){return"esri.tasks.support.FeatureSet"===e.declaredClass?e.features:e});return l.timeout(r,1e4,null)}):l.reject(new u("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))},t.prototype._generateFeatureSetForCachedHistogram=function(e,t,r,a){void 0===t&&(t=e.minimum),void 0===r&&(r=e.maximum);for(var s=[],i=0;i<a;i++)s[i]=0;for(var n=e.counts.length,u=e.minimum,l=e.maximum,i=0;i<n;i++){var c=(i+.5)/n,p=(1-c)*u+c*l,d=(p-t)/(r-t)*a;d>=0&&d<=a&&(s[d===a?a-1:Math.floor(d)]+=e.counts[i])}var m=[];s.forEach(function(e,t){var r=new o({attributes:{}});r.attributes.EXPR_1=t+1,r.attributes.countOFExpr=e,m.push(r)});var h=new v;return h.features=m,h},t.prototype._getCachedStatistics=function(e,t){var r=this.layer;return e.valueExpression||e.sqlExpression||e.sqlWhere||e.minValue||e.maxValue?l.reject(new u("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):r.queryCachedStatistics(t&&t.name).then(function(e){var t=e.stats,r=t.min,a=t.max,s=t.avg,i=t.stddev,n=t.sum,o=t.variance,u=t.count;return 0===r&&0===a||(s=0===s?null:s,n=0===n?null:n,i=0===i?null:i,o=0===o?null:o,u=0===u?null:u),null==u&&null!=n&&null!=s&&(u=Math.round(n/s)),{avg:s,count:u,max:a,min:r,stddev:i,sum:n,variance:o}})},t.prototype._getSummaryStatisticsFromMemory=function(e,t){return(e.features?l.resolve(e.features):this._fetchFeaturesFromMemory(e.view)).then(function(a){if(!a||!a.length)return l.reject(new u("scene-layer-adapter:insufficient-data","No features are available to calculate statistics"));var s=d.isDateField(t),i=r({},e);if("percent-of-total"===i.normalizationType){var n=g.calculateStatsFromMemory({field:i.field},a).sum;if(null==n)return l.reject(new u("scene-layer-adapter:invalid","invalid normalizationTotal"));i.normalizationTotal=n}var o=g.calculateStatsFromMemory(i,a,s);return g.processSummaryStatisticsResult(o)})},t.prototype._getCachedStatisticsForUniqueValues=function(e,t){var r=this,a=this.layer,s=t&&t.name,i=t&&this.getFieldDomain(e.field);return e.valueExpression||e.sqlExpression||e.sqlWhere?l.reject(new u("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):a.queryCachedStatistics(s).then(function(i){var n=i.stats,u=i.labels&&i.labels.labels,l={},c=[];if(n.mostFrequentValues){var p="countOF"+s;n.mostFrequentValues.forEach(function(e){var r=new o({attributes:{}});r.attributes[s]=t&&t.name!==a.objectIdField&&(d.isNumericField(t)||d.isDateField(t))?Number(e.value):e.value,r.attributes[p]=e.count,c.push(r)}),u&&u.forEach(function(e){l[e.value]=e.label})}var m=new v;return m.features=c,g.getUniqueValuesFromFeatureSet(m,r,e.field,l)}).then(function(t){return g.createUVResult(t,"service-cached-query",i,e.returnAllCodedValues)})},t.prototype._getUniqueValuesFromMemory=function(e,t){var r=t&&this.getFieldDomain(e.field);return(e.features?l.resolve(e.features):this._fetchFeaturesFromMemory(e.view)).then(function(t){return g.calculateUniqueValuesFromMemory(e,t,r)})},t.prototype._getCachedStatisticsForHistogram=function(e,t){var r=this,a=this.layer;return e.valueExpression||e.sqlExpression||e.sqlWhere||e.normalizationType?l.reject(new u("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):a.queryCachedStatistics(t&&t.name).then(function(t){var a=t.stats,s=e.minValue,i=e.maxValue,n=null!=s?s:a.min,o=null!=i?i:a.max,u=e.numBins||10,l=r._generateFeatureSetForCachedHistogram(a.histogram,n,o,u);return g.getHistogramFromFeatureSet(l,n,o,u)})},t.prototype._getClassBreaksFromMemory=function(e){return(e.features?l.resolve(e.features):this._fetchFeaturesFromMemory(e.view)).then(function(t){if(!t||!t.length)return l.reject(new u("scene-layer-adapter:insufficient-data","No features are available to calculate statistics"));var a=r({},e);if("percent-of-total"===a.normalizationType){var s=g.calculateStatsFromMemory({field:a.field},t).sum;if(null==s)return l.reject(new u("scene-layer-adapter:invalid","invalid normalizationTotal"));a.normalizationTotal=s}return g.calculateClassBreaksFromMemory(a,t)})},t.prototype._getHistogramFromMemory=function(e){var t=this;return(e.features?l.resolve(e.features):this._fetchFeaturesFromMemory(e.view)).then(function(a){if(!a||!a.length)return l.reject(new u("scene-layer-adapter:insufficient-data","No features are available to calculate histogram"));var s=e.field,i=e.normalizationType,n=e.valueExpression,o=e.classificationMethod,c=e.minValue,p=e.maxValue,d=e.view,m=!o||"equal-interval"===o,h=null!=c&&null!=p,f=null;if(m&&!i)f=h?l.resolve({min:c,max:p}):t.summaryStatistics({field:s,valueExpression:n,features:a,view:d}).then(function(e){return e.count?{min:e.min,max:e.max}:l.reject(new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});else{var y=r({},e);y.features=a,f=t._getBinParamsFromMemory(y)}return f.then(function(t){return g.calculateHistogramFromMemory(e,t,a)})})},t.prototype._getBinParamsFromMemory=function(e){var t=e.field,r=e.valueExpression,a=e.classificationMethod,s=e.standardDeviationInterval,i=e.normalizationType,n=e.normalizationField,o=e.minValue,u=e.maxValue,l=e.features,c=e.view;return this._getClassBreaksFromMemory({field:t,valueExpression:r,normalizationType:i,normalizationField:n,classificationMethod:a,standardDeviationInterval:s,minValue:o,maxValue:u,numClasses:e.numBins,features:l,view:c}).then(function(e){var r=e.normalizationTotal,a=e.classBreakInfos,s=m.getSQLFilterForNormalization({field:t,normalizationType:i,normalizationField:n});return g.generateBinParams({field:t,normalizationType:i,normalizationField:n,normalizationTotal:r,classBreaks:a,where:s})})},t.prototype.getField=function(e){return void 0===e&&(e=""),this.layer.getField(e)},t.prototype.getFieldUsageInfo=function(e){var t=this.getField(e);if(!t)return null;var r=this.layer.getFieldUsageInfo(t.name);return{supportsLabelingInfo:r.supportsLabelingInfo,supportsPopupTemplate:r.supportsPopupTemplate,supportsRenderer:r.supportsRenderer,supportsLayerQuery:r.supportsLayerQuery,supportsStatistics:!0}},t.prototype.getFieldDomain=function(e,t){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(e,t):null},t.prototype.summaryStatistics=function(e){var t=this,r=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(e):this._hasCachedStatistics(r&&r.name)?this._getCachedStatistics(e,r).catch(function(a){return t._getSummaryStatisticsFromMemory(e,r)}):this._getSummaryStatisticsFromMemory(e,r)},t.prototype.uniqueValues=function(e){var t=this,r=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(e):this._hasCachedStatistics(r&&r.name)?this._getCachedStatisticsForUniqueValues(e,r).catch(function(a){return t._getUniqueValuesFromMemory(e,r)}):this._getUniqueValuesFromMemory(e,r)},t.prototype.histogram=function(e){var t=this,r=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(e):this._hasCachedStatistics(r&&r.name)?this._getCachedStatisticsForHistogram(e,r).catch(function(r){return t._getHistogramFromMemory(e)}):this._getHistogramFromMemory(e)},t.prototype.classBreaks=function(e){var t=this.getField(e.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(e):this._hasCachedStatistics(t&&t.name)?l.reject(new u("scene-layer-adapter:not-supported","Cached stats not supported")):this._getClassBreaksFromMemory(e)},t.prototype.queryFeatureCount=function(e){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(e):l.reject(new u("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))},t.prototype.generateRenderer=function(e){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(e):l.reject(new u("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))},t.prototype.heatmapStatistics=function(e){return this._featureLayerAdapter?this._featureLayerAdapter.heatmapStatistics(e):l.reject(new u("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))},t.prototype.getPredominantCategories=function(e,t){return this._featureLayerAdapter?this._featureLayerAdapter.getPredominantCategories(e,t):l.reject(new u("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support getPredominantCategories"))},t.prototype.getSampleFeatures=function(e){return n(this,void 0,void 0,function(){var t,a,s,n,o,l,c;return i(this,function(i){switch(i.label){case 0:if("mesh"===this.layer.geometryType)throw new u("scene-layer-adapter:not-supported","getSampleFeatures does not support scene layer with mesh geometry type");t=e.view,a=e.sampleSize,s=this.layer.createQuery(),s.outFields=null,s.returnGeometry=!0,s.where=null,s.num=a,n=[],i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this._fetchFeaturesFromMemory(t,s)];case 2:return n=i.sent(),n.length&&a>0&&a<=n.length?[2,h.pickRandomItems(n,a)]:[3,4];case 3:return o=i.sent(),[3,4];case 4:return l=null,this._featureLayerAdapter?(c=r({},e),delete c.view,[4,this._featureLayerAdapter.getSampleFeatures(c)]):[3,6];case 5:l=i.sent(),i.label=6;case 6:return l&&l.length?[2,l]:[2,h.pickRandomItems(n,n.length)]}})})},t.prototype.load=function(e){var t=this,r=this.layer.load(e).then(function(r){var a=r.associatedLayer;if(t.geometryType=r.geometryType,a){t._featureLayerAdapter=new f({layer:a});return t._featureLayerAdapter.load(e).then(function(){t.objectIdField=t._featureLayerAdapter.objectIdField,t.supportsSQLExpression=t._featureLayerAdapter.supportsSQLExpression,t.minScale=t._featureLayerAdapter.minScale,t.maxScale=t._featureLayerAdapter.maxScale,t.fullExtent=t._featureLayerAdapter.fullExtent})}t.objectIdField=r.objectIdField,t.supportsSQLExpression=!1,t.hasQueryEngine=!1,t.fullExtent=r.fullExtent});return this.addResolvingPromise(r),this.when()},s([p.property({constructOnly:!0})],t.prototype,"layer",void 0),t=s([p.subclass("esri.renderers.smartMapping.support.adapters.SceneLayerAdapter")],t)}(p.declared(y))});