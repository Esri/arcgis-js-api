/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../symbols","../core/Error","../core/lang","../core/Logger","../core/maybe","../core/object","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/has","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/diffUtils","../core/accessorSupport/ensureType","../layers/support/fieldUtils","../portal/Portal","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","./support/LegendOptions","./support/UniqueValueInfo","../support/arcadeOnDemand","../chunks/persistableUrlUtils","../symbols/support/styleUtils","../symbols/WebStyleSymbol"],(function(e,t,r,o,i,l,n,s,a,u,c,d,p,f,y,h,m,b,g,_,v,S,V,q,I,O,U,w){"use strict";var F;const x=l.getLogger("esri.renderers.UniqueValueRenderer"),D=m.ensureType(q);let N=F=function(t){function l(e){var r;return(r=t.call(this,e)||this)._valueInfoMap={},r._isDefaultSymbolDerived=!1,r.type="unique-value",r.backgroundFillSymbol=null,r.field=null,r.field2=null,r.field3=null,r.valueExpression=null,r.valueExpressionTitle=null,r.legendOptions=null,r.defaultLabel=null,r.fieldDelimiter=null,r.portal=null,r.styleOrigin=null,r.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let r=!1;const o={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let i=0;i<t.length;i++){const l=e.find((e=>e.value===t[i].value));l?h.diff(l,t[i])?(o.changed.push({type:"complete",oldValue:l,newValue:t[i]}),r=!0):o.unchanged.push({oldValue:l,newValue:t[i]}):(o.added.push(t[i]),r=!0)}for(let i=0;i<e.length;i++){t.find((t=>t.value===e[i].value))||(o.removed.push(e[i]),r=!0)}return r?o:void 0}},r._set("uniqueValueInfos",[]),r}e._inheritsLoose(l,t);var s=l.prototype;return s.castField=function(e){return null==e||"function"==typeof e?e:m.ensureString(e)},s.writeField=function(e,t,r,i){"string"==typeof e?t[r]=e:i&&i.messages?i.messages.push(new o("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):x.error(".field: cannot write field to JSON since it's not a string value")},s.readPortal=function(e,t,r){return r.portal||g.getDefault()},s.readStyleOrigin=function(e,t,r){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=O.fromJSON(t.styleUrl,r);return Object.freeze({styleUrl:e})}},s.writeStyleOrigin=function(e,t,r,o){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=O.toJSON(e.styleUrl,o))},s.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void x.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let o;o="object"==typeof e?D(e):new q({value:e,symbol:r.ensureType(t)}),this.uniqueValueInfos.push(o),this._valueInfoMap[o.value]=o},s.removeUniqueValueInfo=function(e){if(this.styleOrigin)x.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++){if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}},s.getUniqueValueInfo=function(){var t=e._asyncToGenerator((function*(e,t){let r=t;return this.valueExpression&&(n.isNone(t)||n.isNone(t.arcade))&&(r={...r,arcade:yield I.loadArcade()}),this._getUniqueValueInfo(e,r)}));function r(e,r){return t.apply(this,arguments)}return r}(),s.getSymbol=function(e,t){if(this.valueExpression&&(n.isNone(t)||n.isNone(t.arcade)))return void x.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this._getUniqueValueInfo(e,t);return r&&r.symbol||this.defaultSymbol},s.getSymbolAsync=function(){var t=e._asyncToGenerator((function*(e,t){let r=t;if(this.valueExpression&&(n.isNone(r)||n.isNone(r.arcade))){const e=yield I.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&(yield t.enableGeometryOperations()),r={...r,arcade:e}}const o=this._getUniqueValueInfo(e,r);return o&&o.symbol||this.defaultSymbol}));function r(e,r){return t.apply(this,arguments)}return r}(),s.getSymbols=function(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e},s.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},s.getMeshHash=function(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce(((e,t)=>e+t.getMeshHash()),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`},s.clone=function(){const e=new F({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:i.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:i.clone(this.visualVariables),legendOptions:i.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:i.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=i.clone(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(i.clone(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e},s.collectRequiredFields=function(){var t=e._asyncToGenerator((function*(e,t){const r=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];yield Promise.all(r)}));function r(e,r){return t.apply(this,arguments)}return r}(),s.collectSymbolFields=function(){var t=e._asyncToGenerator((function*(e,t){const r=[...this.getSymbols().map((r=>r.collectRequiredFields(e,t))),b.collectArcadeFieldNames(e,t,this.valueExpression)];b.collectField(e,t,this.field),b.collectField(e,t,this.field2),b.collectField(e,t,this.field3),yield Promise.all(r)}));function r(e,r){return t.apply(this,arguments)}return r}(),s.populateFromStyle=function(){return U.fetchStyle(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((r=>{const o=new w({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:r.name});this.defaultSymbol||r.name!==e.data.defaultItem||(this.defaultSymbol=o,this._isDefaultSymbolDerived=!0);const i=new q({value:r.name,symbol:o});t.push(i),this._valueInfoMap[r.name]=i})),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))},s._updateValueInfoMap=function(){this._valueInfoMap={},this.uniqueValueInfos.forEach((e=>this._valueInfoMap[e.value+""]=e))},s._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},s._getUnqiueValueInfoForExpression=function(e,t){const{viewingMode:r,scale:o,spatialReference:i,arcade:l}=n.unwrapOr(t,{});let s=this._cache.compiledFunc;const a=n.unwrap(l).arcadeUtils;if(!s){const e=a.createSyntaxTree(this.valueExpression);s=a.createFunction(e),this._cache.compiledFunc=s}const u=a.executeFunction(s,a.createExecContext(e,a.getViewInfo({viewingMode:r,scale:o,spatialReference:i})));return this._valueInfoMap[u+""]},s._getUnqiueValueInfoForFields=function(e){const t=this.field,r=e.attributes;let o;if("function"!=typeof t&&this.field2){const e=this.field2,i=this.field3,l=[];t&&l.push(r[t]),e&&l.push(r[e]),i&&l.push(r[i]),o=l.join(this.fieldDelimiter||"")}else"function"==typeof t?o=t(e):t&&(o=r[t]);return this._valueInfoMap[o+""]},l.fromPortalStyle=function(e,t){const r=new F(t&&t.properties);r._set("styleOrigin",Object.freeze({styleName:e})),r._set("portal",t&&t.portal||g.getDefault());const o=r.populateFromStyle();return o.catch((t=>{x.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),o},l.fromStyleUrl=function(e,t){const r=new F(t&&t.properties);r._set("styleOrigin",Object.freeze({styleUrl:e}));const o=r.populateFromStyle();return o.catch((t=>{x.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),o},e._createClass(l,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"defaultSymbol",set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}},{key:"uniqueValueInfos",set:function(e){this.styleOrigin?x.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),l}(v.VisualVariablesMixin(_));return t.__decorate([a.property({readOnly:!0})],N.prototype,"_cache",null),t.__decorate([d.enumeration({uniqueValue:"unique-value"})],N.prototype,"type",void 0),t.__decorate([a.property(S.rendererBackgroundFillSymbolProperty)],N.prototype,"backgroundFillSymbol",void 0),t.__decorate([a.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],N.prototype,"field",void 0),t.__decorate([u.cast("field")],N.prototype,"castField",null),t.__decorate([y.writer("field")],N.prototype,"writeField",null),t.__decorate([a.property({type:String,json:{write:!0}})],N.prototype,"field2",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],N.prototype,"field3",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],N.prototype,"valueExpression",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],N.prototype,"valueExpressionTitle",void 0),t.__decorate([a.property({type:V.default,json:{write:!0}})],N.prototype,"legendOptions",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],N.prototype,"defaultLabel",void 0),t.__decorate([a.property(s.deepMerge({...S.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],N.prototype,"defaultSymbol",null),t.__decorate([a.property({type:String,json:{write:!0}})],N.prototype,"fieldDelimiter",void 0),t.__decorate([a.property({type:g,readOnly:!0})],N.prototype,"portal",void 0),t.__decorate([p.reader("portal",["styleName"])],N.prototype,"readPortal",null),t.__decorate([a.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],N.prototype,"styleOrigin",void 0),t.__decorate([p.reader("styleOrigin",["styleName","styleUrl"])],N.prototype,"readStyleOrigin",null),t.__decorate([y.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],N.prototype,"writeStyleOrigin",null),t.__decorate([a.property({type:[q],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],N.prototype,"uniqueValueInfos",null),N=F=t.__decorate([f.subclass("esri.renderers.UniqueValueRenderer")],N),N}));
