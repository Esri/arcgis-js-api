/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/lang","../core/object","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/Error","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../chunks/persistableUrlUtils","../support/arcadeOnDemand","../layers/support/fieldUtils","../portal/Portal","../symbols/WebStyleSymbol","../symbols","./support/LegendOptions","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","../core/accessorSupport/diffUtils","./support/UniqueValueInfo","../symbols/support/styleUtils"],(function(e,t,r,o,i,l,n,s,a,u,c,d,p,f,y,h,m,b,g,_,v,S,V,q,I,w,O,U,F,x,D){"use strict";var E;const N=n.getLogger("esri.renderers.UniqueValueRenderer"),j=s.ensureType(x);let M=E=function(t){function r(e){var r;return(r=t.call(this,e)||this)._valueInfoMap={},r._isDefaultSymbolDerived=!1,r.type="unique-value",r.backgroundFillSymbol=null,r.field=null,r.field2=null,r.field3=null,r.valueExpression=null,r.valueExpressionTitle=null,r.legendOptions=null,r.defaultLabel=null,r.fieldDelimiter=null,r.portal=null,r.styleOrigin=null,r.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let r=!1;const o={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let i=0;i<t.length;i++){const l=e.find((e=>e.value===t[i].value));l?F.diff(l,t[i])?(o.changed.push({type:"complete",oldValue:l,newValue:t[i]}),r=!0):o.unchanged.push({oldValue:l,newValue:t[i]}):(o.added.push(t[i]),r=!0)}for(let i=0;i<e.length;i++){t.find((t=>t.value===e[i].value))||(o.removed.push(e[i]),r=!0)}return r?o:void 0}},r._set("uniqueValueInfos",[]),r}e._inheritsLoose(r,t);var i=r.prototype;return i.castField=function(e){return null==e||"function"==typeof e?e:s.ensureString(e)},i.writeField=function(e,t,r,o){"string"==typeof e?t[r]=e:o&&o.messages?o.messages.push(new y("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):N.error(".field: cannot write field to JSON since it's not a string value")},i.readPortal=function(e,t,r){return r.portal||S.getDefault()},i.readStyleOrigin=function(e,t,r){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=g.fromJSON(t.styleUrl,r);return Object.freeze({styleUrl:e})}},i.writeStyleOrigin=function(e,t,r,o){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=g.toJSON(e.styleUrl,o))},i.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void N.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let r;r="object"==typeof e?j(e):new x({value:e,symbol:q.ensureType(t)}),this.uniqueValueInfos.push(r),this._valueInfoMap[r.value]=r},i.removeUniqueValueInfo=function(e){if(this.styleOrigin)N.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++){if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}},i.getUniqueValueInfo=async function(e,t){let r=t;return this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade))&&(r={...r,arcade:await _.loadArcade()}),this._getUniqueValueInfo(e,r)},i.getSymbol=function(e,t){if(this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade)))return void N.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this._getUniqueValueInfo(e,t);return r&&r.symbol||this.defaultSymbol},i.getSymbolAsync=async function(e,t){let r=t;if(this.valueExpression&&(l.isNone(r)||l.isNone(r.arcade))){const e=await _.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&await t.enableGeometryOperations(),r={...r,arcade:e}}const o=this._getUniqueValueInfo(e,r);return o&&o.symbol||this.defaultSymbol},i.getSymbols=function(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e},i.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},i.getMeshHash=function(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce(((e,t)=>e+t.getMeshHash()),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`},i.clone=function(){const e=new E({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:o.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:o.clone(this.visualVariables),legendOptions:o.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:o.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=o.clone(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(o.clone(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e},i.collectRequiredFields=async function(e,t){const r=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(r)},i.collectSymbolFields=async function(e,t){const r=[...this.getSymbols().map((r=>r.collectRequiredFields(e,t))),v.collectArcadeFieldNames(e,t,this.valueExpression)];v.collectField(e,t,this.field),v.collectField(e,t,this.field2),v.collectField(e,t,this.field3),await Promise.all(r)},i.populateFromStyle=function(){return D.fetchStyle(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((r=>{const o=new V({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:r.name});this.defaultSymbol||r.name!==e.data.defaultItem||(this.defaultSymbol=o,this._isDefaultSymbolDerived=!0);const i=new x({value:r.name,symbol:o});t.push(i),this._valueInfoMap[r.name]=i})),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))},i._updateValueInfoMap=function(){this._valueInfoMap={},this.uniqueValueInfos.forEach((e=>this._valueInfoMap[e.value+""]=e))},i._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},i._getUnqiueValueInfoForExpression=function(e,t){const{viewingMode:r,scale:o,spatialReference:i,arcade:n}=l.unwrapOr(t,{});let s=this._cache.compiledFunc;const a=l.unwrap(n).arcadeUtils;if(!s){const e=a.createSyntaxTree(this.valueExpression);s=a.createFunction(e),this._cache.compiledFunc=s}const u=a.executeFunction(s,a.createExecContext(e,a.getViewInfo({viewingMode:r,scale:o,spatialReference:i})));return this._valueInfoMap[u+""]},i._getUnqiueValueInfoForFields=function(e){const t=this.field,r=e.attributes;let o;if("function"!=typeof t&&this.field2){const e=this.field2,i=this.field3,l=[];t&&l.push(r[t]),e&&l.push(r[e]),i&&l.push(r[i]),o=l.join(this.fieldDelimiter||"")}else"function"==typeof t?o=t(e):t&&(o=r[t]);return this._valueInfoMap[o+""]},r.fromPortalStyle=function(e,t){const r=new E(t&&t.properties);r._set("styleOrigin",Object.freeze({styleName:e})),r._set("portal",t&&t.portal||S.getDefault());const o=r.populateFromStyle();return o.catch((t=>{N.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),o},r.fromStyleUrl=function(e,t){const r=new E(t&&t.properties);r._set("styleOrigin",Object.freeze({styleUrl:e}));const o=r.populateFromStyle();return o.catch((t=>{N.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),o},e._createClass(r,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"defaultSymbol",set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}},{key:"uniqueValueInfos",set:function(e){this.styleOrigin?N.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),r}(O.VisualVariablesMixin(w));return t.__decorate([a.property({readOnly:!0})],M.prototype,"_cache",null),t.__decorate([c.enumeration({uniqueValue:"unique-value"})],M.prototype,"type",void 0),t.__decorate([a.property(U.rendererBackgroundFillSymbolProperty)],M.prototype,"backgroundFillSymbol",void 0),t.__decorate([a.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],M.prototype,"field",void 0),t.__decorate([u.cast("field")],M.prototype,"castField",null),t.__decorate([f.writer("field")],M.prototype,"writeField",null),t.__decorate([a.property({type:String,json:{write:!0}})],M.prototype,"field2",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],M.prototype,"field3",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],M.prototype,"valueExpression",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],M.prototype,"valueExpressionTitle",void 0),t.__decorate([a.property({type:I.default,json:{write:!0}})],M.prototype,"legendOptions",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],M.prototype,"defaultLabel",void 0),t.__decorate([a.property(i.deepMerge({...U.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],M.prototype,"defaultSymbol",null),t.__decorate([a.property({type:String,json:{write:!0}})],M.prototype,"fieldDelimiter",void 0),t.__decorate([a.property({type:S,readOnly:!0})],M.prototype,"portal",void 0),t.__decorate([d.reader("portal",["styleName"])],M.prototype,"readPortal",null),t.__decorate([a.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],M.prototype,"styleOrigin",void 0),t.__decorate([d.reader("styleOrigin",["styleName","styleUrl"])],M.prototype,"readStyleOrigin",null),t.__decorate([f.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],M.prototype,"writeStyleOrigin",null),t.__decorate([a.property({type:[x],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],M.prototype,"uniqueValueInfos",null),M=E=t.__decorate([p.subclass("esri.renderers.UniqueValueRenderer")],M),M}));
