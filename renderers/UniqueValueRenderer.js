// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../symbols","../symbols","../core/arrayUtils","../core/Error","../core/lang","../core/Logger","../core/maybe","../core/object","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/diffUtils","../core/accessorSupport/ensureType","../layers/support/fieldUtils","../portal/Portal","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","./support/LegendOptions","./support/UniqueValueInfo","../support/arcadeOnDemand","../support/persistableUrlUtils","../symbols/support/styleUtils"],(function(e,t,r,i,o,n,l,a,u,s,p,d,c,f,y,h,v,m,_,b,g,S,V,q,I){"use strict";var w=u.getLogger("esri.renderers.UniqueValueRenderer"),O=y.ensureType(S);return function(e){function t(t){var r=e.call(this,t)||this;return r._valueInfoMap={},r._isDefaultSymbolDerived=!1,r.type="unique-value",r.backgroundFillSymbol=null,r.field=null,r.field2=null,r.field3=null,r.valueExpression=null,r.valueExpressionTitle=null,r.legendOptions=null,r.defaultLabel=null,r.fieldDelimiter=null,r.portal=null,r.styleOrigin=null,r.diff={uniqueValueInfos:function(e,t){if(e||t){if(!e||!t)return{type:"complete",oldValue:e,newValue:t};for(var r=!1,i={type:"collection",added:[],removed:[],changed:[],unchanged:[]},o=function(o){var l=n.find(e,(function(e){return e.value===t[o].value}));l?f.diff(l,t[o])?(i.changed.push({type:"complete",oldValue:l,newValue:t[o]}),r=!0):i.unchanged.push({oldValue:l,newValue:t[o]}):(i.added.push(t[o]),r=!0)},l=0;l<t.length;l++)o(l);var a=function(o){n.find(t,(function(t){return t.value===e[o].value}))||(i.removed.push(e[o]),r=!0)};for(l=0;l<e.length;l++)a(l);return r?i:void 0}}},r._set("uniqueValueInfos",[]),r}var u;return r.__extends(t,e),u=t,Object.defineProperty(t.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!1,configurable:!0}),t.prototype.castField=function(e){return null==e?e:"function"==typeof e?e:y.ensureString(e)},t.prototype.writeField=function(e,t,r,i){"string"==typeof e?t[r]=e:i&&i.messages?i.messages.push(new l("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):w.error(".field: cannot write field to JSON since it's not a string value")},Object.defineProperty(t.prototype,"defaultSymbol",{set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)},enumerable:!1,configurable:!0}),t.prototype.readPortal=function(e,t,r){return r.portal||v.getDefault()},t.prototype.readStyleOrigin=function(e,t,r){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){var i=q.fromJSON(t.styleUrl,r);return Object.freeze({styleUrl:i})}},t.prototype.writeStyleOrigin=function(e,t,r,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=q.toJSON(e.styleUrl,i))},Object.defineProperty(t.prototype,"uniqueValueInfos",{set:function(e){this.styleOrigin?w.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())},enumerable:!1,configurable:!0}),t.prototype.addUniqueValueInfo=function(e,t){var r;this.styleOrigin?w.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(r="object"==typeof e?O(e):new S({value:e,symbol:o.ensureType(t)}),this.uniqueValueInfos.push(r),this._valueInfoMap[r.value]=r)},t.prototype.removeUniqueValueInfo=function(e){if(this.styleOrigin)w.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(var t=0;t<this.uniqueValueInfos.length;t++){if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}},t.prototype.getUniqueValueInfo=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,o,n;return r.__generator(this,(function(l){switch(l.label){case 0:return i=t,this.valueExpression&&(s.isNone(t)||s.isNone(t.arcade))?(o=[r.__assign({},i)],n={},[4,V.loadArcade()]):[3,2];case 1:i=r.__assign.apply(void 0,o.concat([(n.arcade=l.sent(),n)])),l.label=2;case 2:return[2,this._getUniqueValueInfo(e,i)]}}))}))},t.prototype.getSymbol=function(e,t){if(!this.valueExpression||!s.isNone(t)&&!s.isNone(t.arcade)){var r=this._getUniqueValueInfo(e,t);return r&&r.symbol||this.defaultSymbol}w.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used")},t.prototype.getSymbolAsync=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,o,n,l;return r.__generator(this,(function(a){switch(a.label){case 0:return i=t,this.valueExpression&&(s.isNone(i)||s.isNone(i.arcade))?(o=[r.__assign({},i)],n={},[4,V.loadArcade()]):[3,2];case 1:i=r.__assign.apply(void 0,o.concat([(n.arcade=a.sent(),n)])),a.label=2;case 2:return[2,(l=this._getUniqueValueInfo(e,i))&&l.symbol||this.defaultSymbol]}}))}))},t.prototype.getSymbols=function(){for(var e=[],t=0,r=this.uniqueValueInfos;t<r.length;t++){var i=r[t];i.symbol&&e.push(i.symbol)}return this.defaultSymbol&&e.push(this.defaultSymbol),e},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((function(e,t){return e+t.getAttributeHash()}),"")},t.prototype.getMeshHash=function(){return JSON.stringify(this.backgroundFillSymbol)+"."+JSON.stringify(this.defaultSymbol)+"."+this.uniqueValueInfos.reduce((function(e,t){return e+t.getMeshHash()}),"")+"."+(this.field+"."+this.field2+"."+this.field3+"."+this.fieldDelimiter)+"."+this.valueExpression},t.prototype.clone=function(){var e=new u({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:a.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:a.clone(this.visualVariables),legendOptions:a.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:a.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);var t=a.clone(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(a.clone(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression},enumerable:!1,configurable:!0}),t.prototype.collectRequiredFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)],[4,d.all(i)];case 1:return r.sent(),[2]}}))}))},t.prototype.collectSymbolFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(o){switch(o.label){case 0:return i=r.__spreadArrays(this.getSymbols().map((function(r){return r.collectRequiredFields(e,t)})),[h.collectArcadeFieldNames(e,t,this.valueExpression)]),h.collectField(e,t,this.field),h.collectField(e,t,this.field2),h.collectField(e,t,this.field3),[4,d.all(i)];case 1:return o.sent(),[2]}}))}))},t.prototype.populateFromStyle=function(){var e=this;return I.fetchStyle(this.styleOrigin,{portal:this.portal}).then((function(t){var r=[];return e._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach((function(o){var n=new i.WebStyleSymbol({styleUrl:t.styleUrl,styleName:t.styleName,portal:e.portal,name:o.name});e.defaultSymbol||o.name!==t.data.defaultItem||(e.defaultSymbol=n,e._isDefaultSymbolDerived=!0);var l=new S({value:o.name,symbol:n});r.push(l),e._valueInfoMap[o.name]=l})),e._set("uniqueValueInfos",Object.freeze(r)),!e.defaultSymbol&&e.uniqueValueInfos.length&&(e.defaultSymbol=e.uniqueValueInfos[0].symbol,e._isDefaultSymbolDerived=!0),e}))},t.prototype._updateValueInfoMap=function(){var e=this;this._valueInfoMap={},this.uniqueValueInfos.forEach((function(t){return e._valueInfoMap[t.value+""]=t}))},t.prototype._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},t.prototype._getUnqiueValueInfoForExpression=function(e,t){var r=s.unwrapOr(t,{}),i=r.viewingMode,o=r.scale,n=r.spatialReference,l=r.arcade,a=this._cache.compiledFunc,u=s.unwrap(l).arcadeUtils;if(!a){var p=u.createSyntaxTree(this.valueExpression);a=u.createFunction(p),this._cache.compiledFunc=a}var d=u.executeFunction(a,u.createExecContext(e,u.getViewInfo({viewingMode:i,scale:o,spatialReference:n})));return this._valueInfoMap[d+""]},t.prototype._getUnqiueValueInfoForFields=function(e){var t,r=this.field,i=e.attributes;if("function"!=typeof r&&this.field2){var o=this.field2,n=this.field3,l=[];r&&l.push(i[r]),o&&l.push(i[o]),n&&l.push(i[n]),t=l.join(this.fieldDelimiter||"")}else"function"==typeof r?t=r(e):r&&(t=i[r]);return this._valueInfoMap[t+""]},t.fromPortalStyle=function(e,t){var r=new u(t&&t.properties);r._set("styleOrigin",Object.freeze({styleName:e})),r._set("portal",t&&t.portal||v.getDefault());var i=r.populateFromStyle();return i.catch((function(t){w.error("#fromPortalStyle('"+e+"'[, ...])","Failed to create unique value renderer from style name",t)})),i},t.fromStyleUrl=function(e,t){var r=new u(t&&t.properties);r._set("styleOrigin",Object.freeze({styleUrl:e}));var i=r.populateFromStyle();return i.catch((function(t){w.error("#fromStyleUrl('"+e+"'[, ...])","Failed to create unique value renderer from style URL",t)})),i},r.__decorate([c.property({readOnly:!0,dependsOn:["valueExpression"]})],t.prototype,"_cache",null),r.__decorate([c.enumeration({uniqueValue:"unique-value"})],t.prototype,"type",void 0),r.__decorate([c.property(b.rendererBackgroundFillSymbolProperty)],t.prototype,"backgroundFillSymbol",void 0),r.__decorate([c.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],t.prototype,"field",void 0),r.__decorate([c.cast("field")],t.prototype,"castField",null),r.__decorate([c.writer("field")],t.prototype,"writeField",null),r.__decorate([c.property({type:String,json:{write:!0}})],t.prototype,"field2",void 0),r.__decorate([c.property({type:String,json:{write:!0}})],t.prototype,"field3",void 0),r.__decorate([c.property({type:String,json:{write:!0}})],t.prototype,"valueExpression",void 0),r.__decorate([c.property({type:String,json:{write:!0}})],t.prototype,"valueExpressionTitle",void 0),r.__decorate([c.property({type:g.default,json:{write:!0}})],t.prototype,"legendOptions",void 0),r.__decorate([c.property({type:String,json:{write:!0}})],t.prototype,"defaultLabel",void 0),r.__decorate([c.property(p.deepMerge(r.__assign({},b.rendererSymbolProperty),{json:{write:{overridePolicy:function(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy:function(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],t.prototype,"defaultSymbol",null),r.__decorate([c.property({type:String,json:{write:!0}})],t.prototype,"fieldDelimiter",void 0),r.__decorate([c.property({type:v,readOnly:!0})],t.prototype,"portal",void 0),r.__decorate([c.reader("portal",["styleName"])],t.prototype,"readPortal",null),r.__decorate([c.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:function(){return{enabled:!0}}}}})],t.prototype,"styleOrigin",void 0),r.__decorate([c.reader("styleOrigin",["styleName","styleUrl"])],t.prototype,"readStyleOrigin",null),r.__decorate([c.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],t.prototype,"writeStyleOrigin",null),r.__decorate([c.property({type:[S],json:{write:{overridePolicy:function(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],t.prototype,"uniqueValueInfos",null),t=u=r.__decorate([c.subclass("esri.renderers.UniqueValueRenderer")],t)}(_.VisualVariablesMixin(m))}));