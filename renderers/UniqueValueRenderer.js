/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../symbols","../core/Error","../core/lang","../core/Logger","../core/maybe","../core/object","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/diffUtils","../core/accessorSupport/ensureType","../layers/support/fieldUtils","../portal/Portal","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","./support/LegendOptions","./support/UniqueValue","./support/UniqueValueClass","./support/UniqueValueGroup","./support/UniqueValueInfo","../support/arcadeOnDemand","../chunks/persistableUrlUtils","../symbols/support/styleUtils","../symbols/WebStyleSymbol"],(function(e,t,i,s,o,l,n,r,u,a,c,p,f,d,h,y,_,m,b,v,V,g,q,I,S,w,U,F,O,G,D){"use strict";var x;const E="esri.renderers.UniqueValueRenderer",N=l.getLogger(E),j="uvInfos-watcher",M="uvGroups-watcher",k=",",P=_.ensureType(U);function R(e){const{field1:t,field2:i,field3:s,fieldDelimiter:o,uniqueValueInfos:l,valueExpression:n}=e,r=!(!t||!i);return[{classes:(l??[]).map((e=>{const{symbol:l,label:u,value:a,description:c}=e,[p,f,d]=r?a?.toString()?.split(o||"")||[]:[a],h=[];return(t||n)&&h.push(p),i&&h.push(f),s&&h.push(d),{symbol:l,label:u,values:[h],description:c}}))}]}let T=x=function(t){function l(e){var i;return(i=t.call(this,e)||this)._valueInfoMap={},i._isDefaultSymbolDerived=!1,i._isInfosSource=null,i.type="unique-value",i.backgroundFillSymbol=null,i.valueExpressionTitle=null,i.legendOptions=null,i.defaultLabel=null,i.portal=null,i.styleOrigin=null,i.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let i=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let o=0;o<t.length;o++){const l=e.find((e=>e.value===t[o].value));l?y.diff(l,t[o])?(s.changed.push({type:"complete",oldValue:l,newValue:t[o]}),i=!0):s.unchanged.push({oldValue:l,newValue:t[o]}):(s.added.push(t[o]),i=!0)}for(let o=0;o<e.length;o++){t.find((t=>t.value===e[o].value))||(s.removed.push(e[o]),i=!0)}return i?s:void 0}},i._set("uniqueValueInfos",[]),i._set("uniqueValueGroups",[]),i}e._inheritsLoose(l,t);var r=l.prototype;return r.castField=function(e){return null==e||"function"==typeof e?e:_.ensureString(e)},r.writeField=function(e,t,i,o){"string"==typeof e?t[i]=e:o&&o.messages?o.messages.push(new s("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):N.error(".field: cannot write field to JSON since it's not a string value")},r.readPortal=function(e,t,i){return i.portal||b.getDefault()},r.readStyleOrigin=function(e,t,i){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=O.fromJSON(t.styleUrl,i);return Object.freeze({styleUrl:e})}},r.writeStyleOrigin=function(e,t,i,s){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=O.toJSON(e.styleUrl,s))},r.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void N.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let s;s="object"==typeof e?P(e):new U({value:e,symbol:i.ensureType(t)}),this.uniqueValueInfos?.push(s),this._valueInfoMap[s.value]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()},r.removeUniqueValueInfo=function(e){if(this.styleOrigin)return void N.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let i=0;i<t.length;i++){if(t[i].value===e+""){delete this._valueInfoMap[e],t.splice(i,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()},r.getUniqueValueInfo=function(){var t=e._asyncToGenerator((function*(e,t){let i=t;return this.valueExpression&&(n.isNone(t)||n.isNone(t.arcade))&&(i={...i,arcade:yield F.loadArcade()}),this._getUniqueValueInfo(e,i)}));function i(e,i){return t.apply(this,arguments)}return i}(),r.getSymbol=function(e,t){if(this.valueExpression&&(n.isNone(t)||n.isNone(t.arcade)))return void N.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this._getUniqueValueInfo(e,t);return i&&i.symbol||this.defaultSymbol},r.getSymbolAsync=function(){var t=e._asyncToGenerator((function*(e,t){let i=t;if(this.valueExpression&&(n.isNone(i)||n.isNone(i.arcade))){const e=yield F.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&(yield t.enableGeometryOperations()),i={...i,arcade:e}}const s=this._getUniqueValueInfo(e,i);return s&&s.symbol||this.defaultSymbol}));function i(e,i){return t.apply(this,arguments)}return i}(),r.getSymbols=function(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e},r.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},r.getMeshHash=function(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),i=this.uniqueValueInfos?.reduce(((e,t)=>e+t.getMeshHash()),"");return`${e}.${t}.${i}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`},r.clone=function(){const e=new x({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:o.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:o.clone(this.visualVariables),legendOptions:o.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:o.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=o.clone(this.uniqueValueInfos),i=o.clone(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(o.clone(this.styleOrigin))),Object.freeze(t),Object.freeze(i)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",i),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e},r.collectRequiredFields=function(){var t=e._asyncToGenerator((function*(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];yield Promise.all(i)}));function i(e,i){return t.apply(this,arguments)}return i}(),r.collectSymbolFields=function(){var t=e._asyncToGenerator((function*(e,t){const i=[...this.getSymbols().map((i=>i.collectRequiredFields(e,t))),m.collectArcadeFieldNames(e,t,this.valueExpression)];m.collectField(e,t,this.field),m.collectField(e,t,this.field2),m.collectField(e,t,this.field3),yield Promise.all(i)}));function i(e,i){return t.apply(this,arguments)}return i}(),r.populateFromStyle=function(){return G.fetchStyle(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((i=>{const s=new D({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=s,this._isDefaultSymbolDerived=!0);const o=new U({value:i.name,symbol:s});t.push(o),this._valueInfoMap[i.name]=o})),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))},r._updateFieldDelimiter=function(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",k)},r._updateUniqueValues=function(){null!=this._isInfosSource&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())},r._updateValueInfoMap=function(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[t.value+""]=t},r._watchUniqueValueInfosAndGroups=function(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()},r._watchUniqueValueInfos=function(){this.removeHandles(j);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const i of e)t.push(u.watch((()=>({symbol:i.symbol,value:i.value,label:i.label,description:i.description})),((e,t)=>{e!==t&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)}),{sync:!0}));this.addHandles(t,j)}},r._watchUniqueValueGroups=function(){this.removeHandles(M);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const i of e){t.push(u.watch((()=>({classes:i.classes})),((e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)}),{sync:!0}));for(const e of i.classes)t.push(u.watch((()=>({symbol:e.symbol,values:e.values,label:e.label,description:e.description})),((e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)}),{sync:!0}))}this.addHandles(t,M)}},r._updateInfosFromGroups=function(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:i,field3:s,fieldDelimiter:o,uniqueValueGroups:l,valueExpression:n}=this;if(!t&&!n)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const r=!(!t||!i);for(const u of l)for(const t of u.classes??[]){const{symbol:l,label:n,values:u,description:a}=t;for(const t of u??[]){const{value:u,value2:c,value3:p}=t,f=[u];i&&f.push(c),s&&f.push(p);const d=r?f.join(o||""):f[0];e.push(new U({symbol:l,label:n,value:d,description:a}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()},r._updateGroupsFromInfos=function(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:i,valueExpression:s,fieldDelimiter:o,uniqueValueInfos:l}=this;if(!t&&!s||!l.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const n=!(!t||!i),r=l.map((e=>{const{symbol:t,label:i,value:s,description:l}=e,[r,u,a]=n?s?.toString()?.split(o||"")||[]:[s];return new S({symbol:t,label:i,description:l,values:[new I({value:r,value2:u,value3:a})]})})),u=[new w({classes:r})];e&&Object.freeze(u),this._set("uniqueValueGroups",u),this._watchUniqueValueGroups()},r._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},r._getUnqiueValueInfoForExpression=function(e,t){const{viewingMode:i,scale:s,spatialReference:o,arcade:l}=n.unwrapOr(t,{});let r=this._cache.compiledFunc;const u=n.unwrap(l).arcadeUtils;if(!r){const e=u.createSyntaxTree(this.valueExpression);r=u.createFunction(e),this._cache.compiledFunc=r}const a=u.executeFunction(r,u.createExecContext(e,u.getViewInfo({viewingMode:i,scale:s,spatialReference:o})));return this._valueInfoMap[a+""]},r._getUnqiueValueInfoForFields=function(e){const t=this.field,i=e.attributes;let s;if("function"!=typeof t&&this.field2){const e=this.field2,o=this.field3,l=[];t&&l.push(i[t]),e&&l.push(i[e]),o&&l.push(i[o]),s=l.join(this.fieldDelimiter||"")}else"function"==typeof t?s=t(e):t&&(s=i[t]);return this._valueInfoMap[s+""]},l.fromPortalStyle=function(e,t){const i=new x(t&&t.properties);i._set("styleOrigin",Object.freeze({styleName:e})),i._set("portal",t&&t.portal||b.getDefault());const s=i.populateFromStyle();return s.catch((t=>{N.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),s},l.fromStyleUrl=function(e,t){const i=new x(t&&t.properties);i._set("styleOrigin",Object.freeze({styleUrl:e}));const s=i.populateFromStyle();return s.catch((t=>{N.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),s},e._createClass(l,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"field",set:function(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}},{key:"field2",set:function(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}},{key:"field3",set:function(e){this._set("field3",e),this._updateUniqueValues()}},{key:"valueExpression",set:function(e){this._set("valueExpression",e),this._updateUniqueValues()}},{key:"defaultSymbol",set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}},{key:"fieldDelimiter",set:function(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}},{key:"uniqueValueGroups",set:function(e){this.styleOrigin?N.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}},{key:"uniqueValueInfos",set:function(e){this.styleOrigin?N.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),l}(V.VisualVariablesMixin(v));t.__decorate([a.property({readOnly:!0})],T.prototype,"_cache",null),t.__decorate([p.enumeration({uniqueValue:"unique-value"})],T.prototype,"type",void 0),t.__decorate([a.property(g.rendererBackgroundFillSymbolProperty)],T.prototype,"backgroundFillSymbol",void 0),t.__decorate([a.property({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],T.prototype,"field",null),t.__decorate([c.cast("field")],T.prototype,"castField",null),t.__decorate([h.writer("field")],T.prototype,"writeField",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],T.prototype,"field2",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],T.prototype,"field3",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],T.prototype,"valueExpression",null),t.__decorate([a.property({type:String,json:{write:!0}})],T.prototype,"valueExpressionTitle",void 0),t.__decorate([a.property({type:q.LegendOptions,json:{write:!0}})],T.prototype,"legendOptions",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],T.prototype,"defaultLabel",void 0),t.__decorate([a.property(r.deepMerge({...g.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],T.prototype,"defaultSymbol",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],T.prototype,"fieldDelimiter",null),t.__decorate([a.property({type:b,readOnly:!0})],T.prototype,"portal",void 0),t.__decorate([f.reader("portal",["styleName"])],T.prototype,"readPortal",null),t.__decorate([a.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],T.prototype,"styleOrigin",void 0),t.__decorate([f.reader("styleOrigin",["styleName","styleUrl"])],T.prototype,"readStyleOrigin",null),t.__decorate([h.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],T.prototype,"writeStyleOrigin",null),t.__decorate([a.property({type:[w],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,i)=>(t.uniqueValueGroups||R(t)).map((e=>w.fromJSON(e,i)))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],T.prototype,"uniqueValueGroups",null),t.__decorate([a.property({type:[U],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],T.prototype,"uniqueValueInfos",null),T=x=t.__decorate([d.subclass(E)],T);return T}));
