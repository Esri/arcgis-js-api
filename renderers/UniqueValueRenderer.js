/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../symbols","../core/Error","../core/lang","../core/Logger","../core/maybe","../core/object","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/diffUtils","../core/accessorSupport/ensureType","../layers/support/fieldUtils","../portal/Portal","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","./support/LegendOptions","./support/UniqueValue","./support/UniqueValueClass","./support/UniqueValueGroup","./support/UniqueValueInfo","../support/arcadeOnDemand","../chunks/persistableUrlUtils","../symbols/support/styleUtils","../symbols/WebStyleSymbol"],(function(e,t,s,i,o,r,l,n,u,a,c,p,d,f,h,y,_,m,b,v,V,g,q,I,S,w,U,F,O,G,D){"use strict";var x;const E="esri.renderers.UniqueValueRenderer",j=r.getLogger(E),N="uvInfos-watcher",M="uvGroups-watcher",k=",",P=_.ensureType(U);function R(e){const{field1:t,field2:s,field3:i,fieldDelimiter:o,uniqueValueInfos:r,valueExpression:l}=e,n=!(!t||!s);return[{classes:(r??[]).map((e=>{const{symbol:r,label:u,value:a,description:c}=e,[p,d,f]=n?a?.toString()?.split(o||"")||[]:[a],h=[];return(t||l)&&h.push(p),s&&h.push(d),i&&h.push(f),{symbol:r,label:u,values:[h],description:c}}))}]}let C=x=function(t){function r(e){var s;return(s=t.call(this,e)||this)._valueInfoMap={},s._isDefaultSymbolDerived=!1,s._isInfosSource=null,s.type="unique-value",s.backgroundFillSymbol=null,s.orderByClassesEnabled=!1,s.valueExpressionTitle=null,s.legendOptions=null,s.defaultLabel=null,s.portal=null,s.styleOrigin=null,s.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let s=!1;const i={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let o=0;o<t.length;o++){const r=e.find((e=>e.value===t[o].value));r?y.diff(r,t[o])?(i.changed.push({type:"complete",oldValue:r,newValue:t[o]}),s=!0):i.unchanged.push({oldValue:r,newValue:t[o]}):(i.added.push(t[o]),s=!0)}for(let o=0;o<e.length;o++){t.find((t=>t.value===e[o].value))||(i.removed.push(e[o]),s=!0)}return s?i:void 0}},s._set("uniqueValueInfos",[]),s._set("uniqueValueGroups",[]),s}e._inheritsLoose(r,t);var n=r.prototype;return n.castField=function(e){return null==e||"function"==typeof e?e:_.ensureString(e)},n.writeField=function(e,t,s,o){"string"==typeof e?t[s]=e:o&&o.messages?o.messages.push(new i("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):j.error(".field: cannot write field to JSON since it's not a string value")},n.readPortal=function(e,t,s){return s.portal||b.getDefault()},n.readStyleOrigin=function(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=O.fromJSON(t.styleUrl,s);return Object.freeze({styleUrl:e})}},n.writeStyleOrigin=function(e,t,s,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=O.toJSON(e.styleUrl,i))},n.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void j.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i="object"==typeof e?P(e):new U({value:e,symbol:s.ensureType(t)}),this.uniqueValueInfos?.push(i),this._valueInfoMap[i.value]=i,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()},n.removeUniqueValueInfo=function(e){if(this.styleOrigin)return void j.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){if(t[s].value===e+""){delete this._valueInfoMap[e],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()},n.getUniqueValueInfo=function(){var t=e._asyncToGenerator((function*(e,t){let s=t;return this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade))&&(s={...s,arcade:yield F.loadArcade()}),this._getUniqueValueInfo(e,s)}));function s(e,s){return t.apply(this,arguments)}return s}(),n.getSymbol=function(e,t){if(this.valueExpression&&(l.isNone(t)||l.isNone(t.arcade)))return void j.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this._getUniqueValueInfo(e,t);return s&&s.symbol||this.defaultSymbol},n.getSymbolAsync=function(){var t=e._asyncToGenerator((function*(e,t){let s=t;if(this.valueExpression&&(l.isNone(s)||l.isNone(s.arcade))){const e=yield F.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&(yield t.enableGeometryOperations()),s={...s,arcade:e}}const i=this._getUniqueValueInfo(e,s);return i&&i.symbol||this.defaultSymbol}));function s(e,s){return t.apply(this,arguments)}return s}(),n.getSymbols=function(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e},n.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},n.getMeshHash=function(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=this.uniqueValueInfos?.reduce(((e,t)=>e+t.getMeshHash()),"");return`${e}.${t}.${s}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`},n.clone=function(){const e=new x({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:o.clone(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:o.clone(this.visualVariables),legendOptions:o.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:o.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=o.clone(this.uniqueValueInfos),s=o.clone(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(o.clone(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e},n.collectRequiredFields=function(){var t=e._asyncToGenerator((function*(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];yield Promise.all(s)}));function s(e,s){return t.apply(this,arguments)}return s}(),n.collectSymbolFields=function(){var t=e._asyncToGenerator((function*(e,t){const s=[...this.getSymbols().map((s=>s.collectRequiredFields(e,t))),m.collectArcadeFieldNames(e,t,this.valueExpression)];m.collectField(e,t,this.field),m.collectField(e,t,this.field2),m.collectField(e,t,this.field3),yield Promise.all(s)}));function s(e,s){return t.apply(this,arguments)}return s}(),n.populateFromStyle=function(){return G.fetchStyle(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((s=>{const i=new D({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:s.name});this.defaultSymbol||s.name!==e.data.defaultItem||(this.defaultSymbol=i,this._isDefaultSymbolDerived=!0);const o=new U({value:s.name,symbol:i});t.push(o),this._valueInfoMap[s.name]=o})),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))},n._updateFieldDelimiter=function(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",k)},n._updateUniqueValues=function(){null!=this._isInfosSource&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())},n._updateValueInfoMap=function(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[t.value+""]=t},n._watchUniqueValueInfosAndGroups=function(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()},n._watchUniqueValueInfos=function(){this.removeHandles(N);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(u.watch((()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description})),((e,t)=>{e!==t&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)}),{sync:!0}));this.addHandles(t,N)}},n._watchUniqueValueGroups=function(){this.removeHandles(M);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(u.watch((()=>({classes:s.classes})),((e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)}),{sync:!0}));for(const e of s.classes??[])t.push(u.watch((()=>({symbol:e.symbol,values:e.values,label:e.label,description:e.description})),((e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)}),{sync:!0}))}this.addHandles(t,M)}},n._updateInfosFromGroups=function(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:s,field3:i,fieldDelimiter:o,uniqueValueGroups:r,valueExpression:l}=this;if(!t&&!l)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const n=!(!t||!s);for(const u of r)for(const t of u.classes??[]){const{symbol:r,label:l,values:u,description:a}=t;for(const t of u??[]){const{value:u,value2:c,value3:p}=t,d=[u];s&&d.push(c),i&&d.push(p);const f=n?d.join(o||""):d[0];e.push(new U({symbol:r,label:l,value:f,description:a}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()},n._updateGroupsFromInfos=function(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:s,valueExpression:i,fieldDelimiter:o,uniqueValueInfos:r}=this;if(!t&&!i||!r.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const l=!(!t||!s),n=r.map((e=>{const{symbol:t,label:s,value:i,description:r}=e,[n,u,a]=l?i?.toString()?.split(o||"")||[]:[i];return new S({symbol:t,label:s,description:r,values:[new I({value:n,value2:u,value3:a})]})})),u=[new w({classes:n})];e&&Object.freeze(u),this._set("uniqueValueGroups",u),this._watchUniqueValueGroups()},n._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},n._getUnqiueValueInfoForExpression=function(e,t){const{viewingMode:s,scale:i,spatialReference:o,arcade:r}=l.unwrapOr(t,{});let n=this._cache.compiledFunc;const u=l.unwrap(r).arcadeUtils;if(!n){const e=u.createSyntaxTree(this.valueExpression);n=u.createFunction(e),this._cache.compiledFunc=n}const a=u.executeFunction(n,u.createExecContext(e,u.getViewInfo({viewingMode:s,scale:i,spatialReference:o})));return this._valueInfoMap[a+""]},n._getUnqiueValueInfoForFields=function(e){const t=this.field,s=e.attributes;let i;if("function"!=typeof t&&this.field2){const e=this.field2,o=this.field3,r=[];t&&r.push(s[t]),e&&r.push(s[e]),o&&r.push(s[o]),i=r.join(this.fieldDelimiter||"")}else"function"==typeof t?i=t(e):t&&(i=s[t]);return this._valueInfoMap[i+""]},r.fromPortalStyle=function(e,t){const s=new x(t&&t.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",t&&t.portal||b.getDefault());const i=s.populateFromStyle();return i.catch((t=>{j.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),i},r.fromStyleUrl=function(e,t){const s=new x(t&&t.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const i=s.populateFromStyle();return i.catch((t=>{j.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),i},e._createClass(r,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"field",set:function(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}},{key:"field2",set:function(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}},{key:"field3",set:function(e){this._set("field3",e),this._updateUniqueValues()}},{key:"valueExpression",set:function(e){this._set("valueExpression",e),this._updateUniqueValues()}},{key:"defaultSymbol",set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}},{key:"fieldDelimiter",set:function(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}},{key:"uniqueValueGroups",set:function(e){this.styleOrigin?j.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}},{key:"uniqueValueInfos",set:function(e){this.styleOrigin?j.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),r}(V.VisualVariablesMixin(v));t.__decorate([a.property({readOnly:!0})],C.prototype,"_cache",null),t.__decorate([p.enumeration({uniqueValue:"unique-value"})],C.prototype,"type",void 0),t.__decorate([a.property(g.rendererBackgroundFillSymbolProperty)],C.prototype,"backgroundFillSymbol",void 0),t.__decorate([a.property({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],C.prototype,"field",null),t.__decorate([c.cast("field")],C.prototype,"castField",null),t.__decorate([h.writer("field")],C.prototype,"writeField",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],C.prototype,"field2",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],C.prototype,"field3",null),t.__decorate([a.property({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],C.prototype,"orderByClassesEnabled",void 0),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],C.prototype,"valueExpression",null),t.__decorate([a.property({type:String,json:{write:!0}})],C.prototype,"valueExpressionTitle",void 0),t.__decorate([a.property({type:q.LegendOptions,json:{write:!0}})],C.prototype,"legendOptions",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],C.prototype,"defaultLabel",void 0),t.__decorate([a.property(n.deepMerge({...g.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],C.prototype,"defaultSymbol",null),t.__decorate([a.property({type:String,value:null,json:{write:!0}})],C.prototype,"fieldDelimiter",null),t.__decorate([a.property({type:b,readOnly:!0})],C.prototype,"portal",void 0),t.__decorate([d.reader("portal",["styleName"])],C.prototype,"readPortal",null),t.__decorate([a.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],C.prototype,"styleOrigin",void 0),t.__decorate([d.reader("styleOrigin",["styleName","styleUrl"])],C.prototype,"readStyleOrigin",null),t.__decorate([h.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],C.prototype,"writeStyleOrigin",null),t.__decorate([a.property({type:[w],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>(t.uniqueValueGroups||R(t)).map((e=>w.fromJSON(e,s)))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],C.prototype,"uniqueValueGroups",null),t.__decorate([a.property({type:[U],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],C.prototype,"uniqueValueInfos",null),C=x=t.__decorate([f.subclass(E)],C);return C}));
