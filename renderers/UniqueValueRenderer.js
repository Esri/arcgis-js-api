/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/lang","../core/object","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/Error","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../chunks/persistableUrlUtils","../core/promiseUtils","../support/arcadeOnDemand","../layers/support/fieldUtils","../portal/Portal","../symbols/WebStyleSymbol","../chunks/symbols","./support/LegendOptions","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","../core/accessorSupport/diffUtils","./support/UniqueValueInfo","../symbols/support/styleUtils"],(function(e,t,r,o,l,i,n,s,a,u,c,d,p,f,y,h,m,b,g,_,v,S,V,q,I,w,O,U,F,x,D,E){"use strict";var N;const j=n.getLogger("esri.renderers.UniqueValueRenderer"),M=s.ensureType(D);let k=N=function(t){function r(e){var r;return(r=t.call(this,e)||this)._valueInfoMap={},r._isDefaultSymbolDerived=!1,r.type="unique-value",r.backgroundFillSymbol=null,r.field=null,r.field2=null,r.field3=null,r.valueExpression=null,r.valueExpressionTitle=null,r.legendOptions=null,r.defaultLabel=null,r.fieldDelimiter=null,r.portal=null,r.styleOrigin=null,r.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let r=!1;const o={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let l=0;l<t.length;l++){const i=e.find((e=>e.value===t[l].value));i?x.diff(i,t[l])?(o.changed.push({type:"complete",oldValue:i,newValue:t[l]}),r=!0):o.unchanged.push({oldValue:i,newValue:t[l]}):(o.added.push(t[l]),r=!0)}for(let l=0;l<e.length;l++){t.find((t=>t.value===e[l].value))||(o.removed.push(e[l]),r=!0)}return r?o:void 0}},r._set("uniqueValueInfos",[]),r}e._inheritsLoose(r,t);var l=r.prototype;return l.castField=function(e){return null==e||"function"==typeof e?e:s.ensureString(e)},l.writeField=function(e,t,r,o){"string"==typeof e?t[r]=e:o&&o.messages?o.messages.push(new y("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):j.error(".field: cannot write field to JSON since it's not a string value")},l.readPortal=function(e,t,r){return r.portal||V.getDefault()},l.readStyleOrigin=function(e,t,r){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=g.fromJSON(t.styleUrl,r);return Object.freeze({styleUrl:e})}},l.writeStyleOrigin=function(e,t,r,o){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=g.toJSON(e.styleUrl,o))},l.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void j.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let r;r="object"==typeof e?M(e):new D({value:e,symbol:I.ensureType(t)}),this.uniqueValueInfos.push(r),this._valueInfoMap[r.value]=r},l.removeUniqueValueInfo=function(e){if(this.styleOrigin)j.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++){if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}},l.getUniqueValueInfo=async function(e,t){let r=t;return this.valueExpression&&(i.isNone(t)||i.isNone(t.arcade))&&(r={...r,arcade:await v.loadArcade()}),this._getUniqueValueInfo(e,r)},l.getSymbol=function(e,t){if(this.valueExpression&&(i.isNone(t)||i.isNone(t.arcade)))return void j.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this._getUniqueValueInfo(e,t);return r&&r.symbol||this.defaultSymbol},l.getSymbolAsync=async function(e,t){let r=t;this.valueExpression&&(i.isNone(r)||i.isNone(r.arcade))&&(r={...r,arcade:await v.loadArcade()});const o=this._getUniqueValueInfo(e,r);return o&&o.symbol||this.defaultSymbol},l.getSymbols=function(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e},l.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},l.getMeshHash=function(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce(((e,t)=>e+t.getMeshHash()),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`},l.clone=function(){const e=new N({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:o.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:o.clone(this.visualVariables),legendOptions:o.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:o.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=o.clone(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(o.clone(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e},l.collectRequiredFields=async function(e,t){const r=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await _.all(r)},l.collectSymbolFields=async function(e,t){const r=[...this.getSymbols().map((r=>r.collectRequiredFields(e,t))),S.collectArcadeFieldNames(e,t,this.valueExpression)];S.collectField(e,t,this.field),S.collectField(e,t,this.field2),S.collectField(e,t,this.field3),await _.all(r)},l.populateFromStyle=function(){return E.fetchStyle(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((r=>{const o=new q({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:r.name});this.defaultSymbol||r.name!==e.data.defaultItem||(this.defaultSymbol=o,this._isDefaultSymbolDerived=!0);const l=new D({value:r.name,symbol:o});t.push(l),this._valueInfoMap[r.name]=l})),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))},l._updateValueInfoMap=function(){this._valueInfoMap={},this.uniqueValueInfos.forEach((e=>this._valueInfoMap[e.value+""]=e))},l._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},l._getUnqiueValueInfoForExpression=function(e,t){const{viewingMode:r,scale:o,spatialReference:l,arcade:n}=i.unwrapOr(t,{});let s=this._cache.compiledFunc;const a=i.unwrap(n).arcadeUtils;if(!s){const e=a.createSyntaxTree(this.valueExpression);s=a.createFunction(e),this._cache.compiledFunc=s}const u=a.executeFunction(s,a.createExecContext(e,a.getViewInfo({viewingMode:r,scale:o,spatialReference:l})));return this._valueInfoMap[u+""]},l._getUnqiueValueInfoForFields=function(e){const t=this.field,r=e.attributes;let o;if("function"!=typeof t&&this.field2){const e=this.field2,l=this.field3,i=[];t&&i.push(r[t]),e&&i.push(r[e]),l&&i.push(r[l]),o=i.join(this.fieldDelimiter||"")}else"function"==typeof t?o=t(e):t&&(o=r[t]);return this._valueInfoMap[o+""]},r.fromPortalStyle=function(e,t){const r=new N(t&&t.properties);r._set("styleOrigin",Object.freeze({styleName:e})),r._set("portal",t&&t.portal||V.getDefault());const o=r.populateFromStyle();return o.catch((t=>{j.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),o},r.fromStyleUrl=function(e,t){const r=new N(t&&t.properties);r._set("styleOrigin",Object.freeze({styleUrl:e}));const o=r.populateFromStyle();return o.catch((t=>{j.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),o},e._createClass(r,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"defaultSymbol",set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}},{key:"uniqueValueInfos",set:function(e){this.styleOrigin?j.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),r}(U.VisualVariablesMixin(O));return t.__decorate([a.property({readOnly:!0,dependsOn:["valueExpression"]})],k.prototype,"_cache",null),t.__decorate([c.enumeration({uniqueValue:"unique-value"})],k.prototype,"type",void 0),t.__decorate([a.property(F.rendererBackgroundFillSymbolProperty)],k.prototype,"backgroundFillSymbol",void 0),t.__decorate([a.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],k.prototype,"field",void 0),t.__decorate([u.cast("field")],k.prototype,"castField",null),t.__decorate([f.writer("field")],k.prototype,"writeField",null),t.__decorate([a.property({type:String,json:{write:!0}})],k.prototype,"field2",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],k.prototype,"field3",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],k.prototype,"valueExpression",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],k.prototype,"valueExpressionTitle",void 0),t.__decorate([a.property({type:w.default,json:{write:!0}})],k.prototype,"legendOptions",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],k.prototype,"defaultLabel",void 0),t.__decorate([a.property(l.deepMerge({...F.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],k.prototype,"defaultSymbol",null),t.__decorate([a.property({type:String,json:{write:!0}})],k.prototype,"fieldDelimiter",void 0),t.__decorate([a.property({type:V,readOnly:!0})],k.prototype,"portal",void 0),t.__decorate([d.reader("portal",["styleName"])],k.prototype,"readPortal",null),t.__decorate([a.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],k.prototype,"styleOrigin",void 0),t.__decorate([d.reader("styleOrigin",["styleName","styleUrl"])],k.prototype,"readStyleOrigin",null),t.__decorate([f.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],k.prototype,"writeStyleOrigin",null),t.__decorate([a.property({type:[D],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],k.prototype,"uniqueValueInfos",null),k=N=t.__decorate([p.subclass("esri.renderers.UniqueValueRenderer")],k),k}));
