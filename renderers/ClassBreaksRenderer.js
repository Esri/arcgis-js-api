// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/has","../kernel","../lang","../symbols/jsonUtils","./Renderer","./arcadeUtils"],function(e,s,i,a,t,l,r,o,n){var u=e(o,{declaredClass:"esri.renderer.ClassBreaksRenderer",constructor:function(e,i){if(this.breaks=[],this._symbols={},this.infos=[],this.isMaxInclusive=!0,e&&!e.declaredClass){var a=e;this.attributeField=a.field,this.setValueExpression(a.valueExpression),e=a.defaultSymbol,this.defaultSymbol=e&&(e.declaredClass?e:r.fromJson(e)),e=a.backgroundFillSymbol,this.backgroundFillSymbol=e&&(e.declaredClass?e:r.fromJson(e)),this._copy(["defaultLabel","classificationMethod:rest","normalizationType:rest","normalizationField","normalizationTotal"],a,this);var t=a.minValue,o=a.classBreakInfos;o&&o[0]&&l.isDefined(o[0].classMaxValue)&&s.forEach(o,function(e){var s=e.classMaxValue;e.minValue=t,e.maxValue=s,t=s},this),s.forEach(o,this._addBreakInfo,this)}else this.defaultSymbol=e,this.attributeField=i},addBreak:function(e,s,a){var t=i.isObject(e)?e:{minValue:e,maxValue:s,symbol:a};this._addBreakInfo(t)},removeBreak:function(e,s){var i,a,t=this.breaks,l=t.length,r=this._symbols;for(a=0;l>a;a++)if(i=t[a],i[0]==e&&i[1]==s){t.splice(a,1),delete r[e+"-"+s],this.infos.splice(a,1);break}},clearBreaks:function(){this.breaks=[],this._symbols={},this.infos=[]},getBreakIndex:function(e){var s,a,t,l=this.attributeField,r=e.attributes,o=this.breaks,u=o.length,d=this.isMaxInclusive;if(this._exprTree)s=n.executeExpression(this._exprTree,n.createExecContext(e));else if(i.isFunction(l))s=l(e);else{s=parseFloat(r[l]);var f,h,c=this.normalizationType;if(c)if(f=parseFloat(this.normalizationTotal),h=parseFloat(r[this.normalizationField]),"log"===c)s=Math.log(s)*Math.LOG10E;else if("percent-of-total"!==c||isNaN(f)){if("field"===c){if(isNaN(s)||isNaN(h))return-1;s/=h}}else s=s/f*100}if(null!=s&&!isNaN(s))for(a=0;u>a;a++)if(t=o[a],t[0]<=s&&(d?s<=t[1]:s<t[1]))return a;return-1},getBreakInfo:function(e){var s=this.getBreakIndex(e);return-1!==s?this.infos[s]:null},getSymbol:function(e){var s=this.breaks[this.getBreakIndex(e)];return s?this._symbols[s[0]+"-"+s[1]]:this.defaultSymbol},setMaxInclusive:function(e){this.isMaxInclusive=e},setValueExpression:function(e){this.valueExpression=e,this._exprTree=n.parseExpression(e)},_normalizationTypeEnums:[["field","esriNormalizeByField"],["log","esriNormalizeByLog"],["percent-of-total","esriNormalizeByPercentOfTotal"]],_classificationMethodEnums:[["natural-breaks","esriClassifyNaturalBreaks"],["equal-interval","esriClassifyEqualInterval"],["quantile","esriClassifyQuantile"],["standard-deviation","esriClassifyStandardDeviation"],["geometrical-interval","esriClassifyGeometricalInterval"]],_copy:function(e,i,a){s.forEach(e,function(e){var s,t,l,r,o=e.split(":");if(o.length>1&&(e=o[0],s=this["_"+e+"Enums"],"rest"===o[1]?(t="1",l="0"):"sdk"===o[1]&&(t="0",l="1")),r=i[e],void 0!==r&&(a[e]=r,s&&t)){var n,u=s.length;for(n=0;u>n;n++)if(s[n][t]===r){a[e]=s[n][l];break}}},this)},_addBreakInfo:function(e){var s=e.minValue,i=e.maxValue;this.breaks.push([s,i]),this.infos.push(e);var a=e.symbol;a&&(a.declaredClass||(e.symbol=r.fromJson(a))),this._symbols[s+"-"+i]=e.symbol},toJson:function(){var e=this.infos||[],a=l.fixJson,t=e[0]&&e[0].minValue,r=this.backgroundFillSymbol,o=i.mixin(this.inherited(arguments),{type:"classBreaks",field:this.attributeField,valueExpression:this.valueExpression,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.toJson(),backgroundFillSymbol:r&&r.toJson(),minValue:t===-1/0?-Number.MAX_VALUE:t,classBreakInfos:s.map(e,function(e){return e=i.mixin({},e),e.symbol=e.symbol&&e.symbol.toJson(),e.classMaxValue=1/0===e.maxValue?Number.MAX_VALUE:e.maxValue,delete e.minValue,delete e.maxValue,a(e)})});return this._copy(["defaultLabel","classificationMethod:sdk","normalizationType:sdk","normalizationField","normalizationTotal"],this,o),o.hasOwnProperty("normalizationType")&&!o.normalizationType&&delete o.normalizationType,o.hasOwnProperty("classificationMethod")&&!o.classificationMethod&&delete o.classificationMethod,a(o)}});return a("extend-esri")&&i.setObject("renderer.ClassBreaksRenderer",u,t),u});