/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../symbols","../core/jsonMap","../core/lang","../core/Logger","../core/maybe","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/ensureType","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","./support/ClassBreakInfo","./support/commonProperties","./support/LegendOptions","../support/arcadeOnDemand"],(function(e,t,s,r,o,n,a,i,l,u,c,p,d,f,y,h,m,g,b,k,v){"use strict";var _;const x="log",I="percent-of-total",B="field",S=new r.JSONMap({esriNormalizeByLog:x,esriNormalizeByPercentOfTotal:I,esriNormalizeByField:B}),F=f.ensureType(g);let V=_=function(t){function r(e){var s;return(s=t.call(this,e)||this)._compiledValueExpression={valueExpression:null,compiledFunction:null},s.backgroundFillSymbol=null,s.classBreakInfos=null,s.defaultLabel=null,s.defaultSymbol=null,s.field=null,s.isMaxInclusive=!0,s.legendOptions=null,s.normalizationField=null,s.normalizationTotal=null,s.type="class-breaks",s.valueExpression=null,s.valueExpressionTitle=null,s._set("classBreakInfos",[]),s}e._inheritsLoose(r,t);var i=r.prototype;return i.readClassBreakInfos=function(e,t,s){if(!Array.isArray(e))return;let r=t.minValue;return e.map((e=>{const t=new g;return t.read(e,s),null==t.minValue&&(t.minValue=r),null==t.maxValue&&(t.maxValue=t.minValue),r=t.maxValue,t}))},i.writeClassBreakInfos=function(e,t,s,r){const o=e.map((e=>e.write({},r)));this._areClassBreaksConsecutive()&&o.forEach((e=>delete e.classMinValue)),t[s]=o},i.castField=function(e){return null==e?e:"function"==typeof e?(n.getLogger(this.declaredClass).error(".field: field must be a string value"),null):f.ensureString(e)},i.addClassBreakInfo=function(e,t,r){let n=null;n="number"==typeof e?new g({minValue:e,maxValue:t,symbol:s.ensureType(r)}):F(o.clone(e)),this.classBreakInfos.push(n),1===this.classBreakInfos.length&&this.notifyChange("minValue")},i.removeClassBreakInfo=function(e,t){const s=this.classBreakInfos.length;for(let r=0;r<s;r++){const s=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(s[0]===e&&s[1]===t){this.classBreakInfos.splice(r,1);break}}},i.getBreakIndex=function(e,t){return this.valueExpression&&(a.isNone(t)||a.isNone(t.arcade))&&n.getLogger(this.declaredClass).warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)},i.getClassBreakInfo=function(){var t=e._asyncToGenerator((function*(e,t){let s=t;this.valueExpression&&(a.isNone(t)||a.isNone(t.arcade))&&(s={...s,arcade:yield v.loadArcade()});const r=this.getBreakIndex(e,s);return-1!==r?this.classBreakInfos[r]:null}));function s(e,s){return t.apply(this,arguments)}return s}(),i.getSymbol=function(e,t){if(this.valueExpression&&(a.isNone(t)||a.isNone(t.arcade)))return void n.getLogger(this.declaredClass).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this.getBreakIndex(e,t);return s>-1?this.classBreakInfos[s].symbol:this.defaultSymbol},i.getSymbolAsync=function(){var t=e._asyncToGenerator((function*(e,t){let s=t;if(this.valueExpression&&(a.isNone(t)||a.isNone(t.arcade))){const e=yield v.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&(yield t.enableGeometryOperations()),s={...s,arcade:e}}const r=this.getBreakIndex(e,s);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}));function s(e,s){return t.apply(this,arguments)}return s}(),i.getSymbols=function(){const e=[];return this.classBreakInfos.forEach((t=>{t.symbol&&e.push(t.symbol)})),this.defaultSymbol&&e.push(this.defaultSymbol),e},i.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},i.getMeshHash=function(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${e}.${t}.${this.classBreakInfos.reduce(((e,t)=>e+t.getMeshHash()),"")}.${s}.${this.field}.${this.valueExpression}`},i.clone=function(){return new _({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:o.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:o.clone(this.visualVariables),legendOptions:o.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},i.collectRequiredFields=function(){var t=e._asyncToGenerator((function*(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];yield Promise.all(s)}));function s(e,s){return t.apply(this,arguments)}return s}(),i.collectSymbolFields=function(){var t=e._asyncToGenerator((function*(e,t){const s=[...this.getSymbols().map((s=>s.collectRequiredFields(e,t))),y.collectArcadeFieldNames(e,t,this.valueExpression)];y.collectField(e,t,this.field),y.collectField(e,t,this.normalizationField),yield Promise.all(s)}));function s(e,s){return t.apply(this,arguments)}return s}(),i._getBreakIndexForExpression=function(e,t){const{viewingMode:s,scale:r,spatialReference:o,arcade:n}=a.unwrapOr(t,{}),{valueExpression:i}=this;let l=this._compiledValueExpression.valueExpression===i?this._compiledValueExpression.compiledFunction:null;const u=a.unwrap(n).arcadeUtils;if(!l){const e=u.createSyntaxTree(i);l=u.createFunction(e),this._compiledValueExpression.compiledFunction=l}this._compiledValueExpression.valueExpression=i;const c=u.executeFunction(l,u.createExecContext(e,u.getViewInfo({viewingMode:s,scale:r,spatialReference:o})));return this._getBreakIndexfromInfos(c)},i._getBreakIndexForField=function(e){const t=this.field,s=e.attributes,r=this.normalizationType;let o=parseFloat(s[t]);if(r){const e=this.normalizationTotal,t=parseFloat(this.normalizationField?s[this.normalizationField]:void 0);if(r===x)o=Math.log(o)*Math.LOG10E;else if(r!==I||null==e||isNaN(e)){if(r===B&&!isNaN(t)){if(isNaN(o)||isNaN(t))return-1;o/=t}}else o=o/e*100}return this._getBreakIndexfromInfos(o)},i._getBreakIndexfromInfos=function(e){const t=this.isMaxInclusive;if(null!=e&&"number"==typeof e&&!isNaN(e))for(let s=0;s<this.classBreakInfos.length;s++){const r=[this.classBreakInfos[s].minValue,this.classBreakInfos[s].maxValue];if(r[0]<=e&&(t?e<=r[1]:e<r[1]))return s}return-1},i._areClassBreaksConsecutive=function(){const e=this.classBreakInfos,t=e.length;for(let s=1;s<t;s++)if(e[s-1].maxValue!==e[s].minValue)return!1;return!0},e._createClass(r,[{key:"minValue",get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}},{key:"normalizationType",get:function(){let e=this._get("normalizationType");const t=!!this.normalizationField,s=null!=this.normalizationTotal;return t||s?(e=t&&B||s&&I||null,t&&s&&n.getLogger(this.declaredClass).warn("warning: both normalizationField and normalizationTotal are set!")):e!==B&&e!==I||(e=null),e},set:function(e){this._set("normalizationType",e)}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),r}(m.VisualVariablesMixin(h));t.__decorate([i.property(b.rendererBackgroundFillSymbolProperty)],V.prototype,"backgroundFillSymbol",void 0),t.__decorate([i.property({type:[g]})],V.prototype,"classBreakInfos",void 0),t.__decorate([c.reader("classBreakInfos")],V.prototype,"readClassBreakInfos",null),t.__decorate([d.writer("classBreakInfos")],V.prototype,"writeClassBreakInfos",null),t.__decorate([i.property({type:String,json:{write:!0}})],V.prototype,"defaultLabel",void 0),t.__decorate([i.property(b.rendererSymbolProperty)],V.prototype,"defaultSymbol",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],V.prototype,"field",void 0),t.__decorate([l.cast("field")],V.prototype,"castField",null),t.__decorate([i.property({type:Boolean})],V.prototype,"isMaxInclusive",void 0),t.__decorate([i.property({type:k.LegendOptions,json:{write:!0}})],V.prototype,"legendOptions",void 0),t.__decorate([i.property({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],V.prototype,"minValue",null),t.__decorate([i.property({type:String,json:{write:!0}})],V.prototype,"normalizationField",void 0),t.__decorate([i.property({type:Number,cast:e=>f.ensureNumber(e),json:{write:!0}})],V.prototype,"normalizationTotal",void 0),t.__decorate([i.property({type:S.apiValues,value:null,json:{type:S.jsonValues,read:S.read,write:S.write}})],V.prototype,"normalizationType",null),t.__decorate([u.enumeration({classBreaks:"class-breaks"})],V.prototype,"type",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],V.prototype,"valueExpression",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],V.prototype,"valueExpressionTitle",void 0),V=_=t.__decorate([p.subclass("esri.renderers.ClassBreaksRenderer")],V);return V}));
