// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/assignHelper","../symbols","../symbols","../core/jsonMap","../core/lang","../core/Logger","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","./support/ClassBreakInfo","./support/LegendOptions","../support/arcadeOnDemand","../symbols/support/jsonUtils"],(function(e,t,r,o,n,a,i,s,l,u,p,c,d,f,y,m,h,b,v,g,k,I,B,S){var x=d.getLogger("esri.renderers.ClassBreaksRenderer"),w=new p.default({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),F=h.ensureType(k);return function(e){function t(t){var r=e.call(this,t)||this;return r.backgroundFillSymbol=null,r.classBreakInfos=null,r.defaultLabel=null,r.defaultSymbol=null,r.field=null,r.isMaxInclusive=!0,r.legendOptions=null,r.normalizationField=null,r.normalizationTotal=null,r.type="class-breaks",r.valueExpression=null,r.valueExpressionTitle=null,r._set("classBreakInfos",[]),r}var n;return r(t,e),n=t,Object.defineProperty(t.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!0,configurable:!0}),t.prototype.readClassBreakInfos=function(e,t,r){if(Array.isArray(e)){var o=t.minValue;return e.map((function(e){var t=new k;return t.read(e,r),null==t.minValue&&(t.minValue=o),null==t.maxValue&&(t.maxValue=t.minValue),o=t.maxValue,t}))}},t.prototype.writeClassBreakInfos=function(e,t,r,o){var n=e.map((function(e){return e.write({},o)}));this._areClassBreaksConsecutive()&&n.forEach((function(e){return delete e.classMinValue})),t[r]=n},t.prototype.readDefaultSymbol=function(e,t,r){return S.read(e,t,r)},t.prototype.writeDefaultSymbolWebScene=function(e,t,r,o){S.writeTarget(e,t,r,o)},t.prototype.writeDefaultSymbol=function(e,t,r,o){S.writeTarget(e,t,r,o)},t.prototype.castField=function(e){return null==e?e:"function"==typeof e?(x.error(".field: field must be a string value"),null):h.ensureString(e)},Object.defineProperty(t.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalizationType",{get:function(){var e=this._get("normalizationType"),t=!!this.normalizationField,r=null!=this.normalizationTotal;return t||r?(e=(t?"field":r&&"percent-of-total")||null,t&&r&&x.warn("warning: both normalizationField and normalizationTotal are set!")):"field"!==e&&"percent-of-total"!==e||(e=null),e},set:function(e){this._set("normalizationType",e)},enumerable:!0,configurable:!0}),t.prototype.addClassBreakInfo=function(e,t,r){var o=null;o="number"==typeof e?new k({minValue:e,maxValue:t,symbol:u.ensureType(r)}):F(c.clone(e)),this.classBreakInfos.push(o),1===this.classBreakInfos.length&&this.notifyChange("minValue")},t.prototype.removeClassBreakInfo=function(e,t){for(var r=this.classBreakInfos.length,o=0;o<r;o++){var n=[this.classBreakInfos[o].minValue,this.classBreakInfos[o].maxValue];if(n[0]===e&&n[1]===t){this.classBreakInfos.splice(o,1);break}}},t.prototype.getBreakIndex=function(e,t){return this.valueExpression&&(f.isNone(t)||f.isNone(t.arcade))&&x.warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)},t.prototype.getClassBreakInfo=function(e,t){return i(this,void 0,void 0,(function(){var r,o,n,i;return a(this,(function(a){switch(a.label){case 0:return r=t,this.valueExpression&&(f.isNone(t)||f.isNone(t.arcade))?(o=[{},r],n={},[4,B.loadArcade()]):[3,2];case 1:r=s.apply(void 0,o.concat([(n.arcade=a.sent(),n)])),a.label=2;case 2:return[2,-1!==(i=this.getBreakIndex(e,r))?this.classBreakInfos[i]:null]}}))}))},t.prototype.getSymbol=function(e,t){if(!this.valueExpression||!f.isNone(t)&&!f.isNone(t.arcade)){var r=this.getBreakIndex(e,t);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}x.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used")},t.prototype.getSymbolAsync=function(e,t){return i(this,void 0,void 0,(function(){var r,o,n,i;return a(this,(function(a){switch(a.label){case 0:return r=t,this.valueExpression&&(f.isNone(t)||f.isNone(t.arcade))?(o=[{},r],n={},[4,B.loadArcade()]):[3,2];case 1:r=s.apply(void 0,o.concat([(n.arcade=a.sent(),n)])),a.label=2;case 2:return[2,(i=this.getBreakIndex(e,r))>-1?this.classBreakInfos[i].symbol:this.defaultSymbol]}}))}))},t.prototype.getSymbols=function(){var e=[];return this.classBreakInfos.forEach((function(t){t.symbol&&e.push(t.symbol)})),this.defaultSymbol&&e.push(this.defaultSymbol),e},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((function(e,t){return e+t.getAttributeHash()}),"")},t.prototype.getMeshHash=function(){var e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),r=this.normalizationField+"."+this.normalizationType+"."+this.normalizationTotal;return e+"."+t+"."+this.classBreakInfos.reduce((function(e,t){return e+t.getMeshHash()}),"")+"."+r+"."+this.field+"."+this.valueExpression},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression},enumerable:!0,configurable:!0}),t.prototype.clone=function(){return new n({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:c.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:c.clone(this.visualVariables),legendOptions:c.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},t.prototype.collectRequiredFields=function(e,t){return i(this,void 0,void 0,(function(){var r;return a(this,(function(o){switch(o.label){case 0:return r=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)],[4,y.all(r)];case 1:return o.sent(),[2]}}))}))},t.prototype.collectSymbolFields=function(e,t){return i(this,void 0,void 0,(function(){var r;return a(this,(function(o){switch(o.label){case 0:return r=this.getSymbols().map((function(r){return r.collectRequiredFields(e,t)})).concat([b.collectArcadeFieldNames(e,t,this.valueExpression)]),b.collectField(e,t,this.field),b.collectField(e,t,this.normalizationField),[4,y.all(r)];case 1:return o.sent(),[2]}}))}))},t.prototype._getBreakIndexForExpression=function(e,t){var r=f.unwrapOr(t,{}),o=r.viewingMode,n=r.scale,a=r.spatialReference,i=r.arcade,s=this._cache.compiledFunc,l=f.expect(i).arcadeUtils;if(!s){var u=l.createSyntaxTree(this.valueExpression);s=l.createFunction(u),this._cache.compiledFunc=s}var p=l.executeFunction(s,l.createExecContext(e,l.getViewInfo({viewingMode:o,scale:n,spatialReference:a})));return this._getBreakIndexfromInfos(p)},t.prototype._getBreakIndexForField=function(e){var t=this.field,r=e.attributes,o=this.normalizationType,n=parseFloat(r[t]);if(o){var a=this.normalizationTotal,i=parseFloat(r[this.normalizationField]);if("log"===o)n=Math.log(n)*Math.LOG10E;else if("percent-of-total"!==o||isNaN(a)){if("field"===o&&!isNaN(i)){if(isNaN(n)||isNaN(i))return-1;n/=i}}else n=n/a*100}return this._getBreakIndexfromInfos(n)},t.prototype._getBreakIndexfromInfos=function(e){var t=this.isMaxInclusive;if(null!=e&&"number"==typeof e&&!isNaN(e))for(var r=0;r<this.classBreakInfos.length;r++){var o=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(o[0]<=e&&(t?e<=o[1]:e<o[1]))return r}return-1},t.prototype._areClassBreaksConsecutive=function(){for(var e=this.classBreakInfos,t=e.length,r=1;r<t;r++)if(e[r-1].maxValue!==e[r].minValue)return!1;return!0},o([m.property({readOnly:!0,dependsOn:["valueExpression"]})],t.prototype,"_cache",null),o([m.property({types:{base:l.BaseSymbol,key:"type",typeMap:{"simple-fill":u.symbolTypesRenderer.typeMap["simple-fill"],"picture-fill":u.symbolTypesRenderer.typeMap["picture-fill"],"polygon-3d":u.symbolTypesRenderer.typeMap["polygon-3d"]}},json:{origins:{"web-scene":{type:l.PolygonSymbol3D,read:S.read,write:S.writeTarget}},read:S.read,write:S.writeTarget}})],t.prototype,"backgroundFillSymbol",void 0),o([m.property({type:[k]})],t.prototype,"classBreakInfos",void 0),o([m.reader("classBreakInfos")],t.prototype,"readClassBreakInfos",null),o([m.writer("classBreakInfos")],t.prototype,"writeClassBreakInfos",null),o([m.property({type:String,json:{write:!0}})],t.prototype,"defaultLabel",void 0),o([m.property({types:u.symbolTypesRenderer})],t.prototype,"defaultSymbol",void 0),o([m.reader("defaultSymbol")],t.prototype,"readDefaultSymbol",null),o([m.writer("web-scene","defaultSymbol",{defaultSymbol:{types:u.symbolTypesRenderer3D}})],t.prototype,"writeDefaultSymbolWebScene",null),o([m.writer("defaultSymbol")],t.prototype,"writeDefaultSymbol",null),o([m.property({type:String,json:{write:!0}})],t.prototype,"field",void 0),o([m.cast("field")],t.prototype,"castField",null),o([m.property({type:Boolean})],t.prototype,"isMaxInclusive",void 0),o([m.property({type:I.default,json:{write:!0}})],t.prototype,"legendOptions",void 0),o([m.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],t.prototype,"minValue",null),o([m.property({type:String,json:{write:!0}})],t.prototype,"normalizationField",void 0),o([m.property({type:Number,cast:function(e){return h.ensureNumber(e)},json:{write:!0}})],t.prototype,"normalizationTotal",void 0),o([m.property({type:w.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:w.jsonValues,read:w.read,write:w.write}})],t.prototype,"normalizationType",null),o([m.enumeration.serializable()({classBreaks:"class-breaks"})],t.prototype,"type",void 0),o([m.property({type:String,json:{write:!0}})],t.prototype,"valueExpression",void 0),o([m.property({type:String,json:{write:!0}})],t.prototype,"valueExpressionTitle",void 0),t=n=o([m.subclass("esri.renderers.ClassBreaksRenderer")],t)}(m.declared(g.VisualVariablesMixin(v)))}));