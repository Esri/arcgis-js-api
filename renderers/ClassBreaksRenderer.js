/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/lang","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/jsonMap","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../support/arcadeOnDemand","../layers/support/fieldUtils","../chunks/symbols","./support/LegendOptions","./Renderer","./mixins/VisualVariablesMixin","./support/ClassBreakInfo","./support/commonProperties"],(function(e,t,s,r,o,a,n,i,l,c,u,p,d,f,y,h,m,g,b,k,B,I,_,v,x,S){"use strict";var F;const V=a.getLogger("esri.renderers.ClassBreaksRenderer"),w="percent-of-total",z="field",N=new c.JSONMap({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:w,esriNormalizeByField:z}),E=n.ensureType(x);let T=F=function(t){function s(e){var s;return(s=t.call(this,e)||this).backgroundFillSymbol=null,s.classBreakInfos=null,s.defaultLabel=null,s.defaultSymbol=null,s.field=null,s.isMaxInclusive=!0,s.legendOptions=null,s.normalizationField=null,s.normalizationTotal=null,s.type="class-breaks",s.valueExpression=null,s.valueExpressionTitle=null,s._set("classBreakInfos",[]),s}e._inheritsLoose(s,t);var a=s.prototype;return a.readClassBreakInfos=function(e,t,s){if(!Array.isArray(e))return;let r=t.minValue;return e.map((e=>{const t=new x;return t.read(e,s),null==t.minValue&&(t.minValue=r),null==t.maxValue&&(t.maxValue=t.minValue),r=t.maxValue,t}))},a.writeClassBreakInfos=function(e,t,s,r){const o=e.map((e=>e.write({},r)));this._areClassBreaksConsecutive()&&o.forEach((e=>delete e.classMinValue)),t[s]=o},a.castField=function(e){return null==e?e:"function"==typeof e?(V.error(".field: field must be a string value"),null):n.ensureString(e)},a.addClassBreakInfo=function(e,t,s){let o=null;o="number"==typeof e?new x({minValue:e,maxValue:t,symbol:B.ensureType(s)}):E(r.clone(e)),this.classBreakInfos.push(o),1===this.classBreakInfos.length&&this.notifyChange("minValue")},a.removeClassBreakInfo=function(e,t){const s=this.classBreakInfos.length;for(let r=0;r<s;r++){const s=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(s[0]===e&&s[1]===t){this.classBreakInfos.splice(r,1);break}}},a.getBreakIndex=function(e,t){return this.valueExpression&&(o.isNone(t)||o.isNone(t.arcade))&&V.warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)},a.getClassBreakInfo=async function(e,t){let s=t;this.valueExpression&&(o.isNone(t)||o.isNone(t.arcade))&&(s={...s,arcade:await b.loadArcade()});const r=this.getBreakIndex(e,s);return-1!==r?this.classBreakInfos[r]:null},a.getSymbol=function(e,t){if(this.valueExpression&&(o.isNone(t)||o.isNone(t.arcade)))return void V.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this.getBreakIndex(e,t);return s>-1?this.classBreakInfos[s].symbol:this.defaultSymbol},a.getSymbolAsync=async function(e,t){let s=t;this.valueExpression&&(o.isNone(t)||o.isNone(t.arcade))&&(s={...s,arcade:await b.loadArcade()});const r=this.getBreakIndex(e,s);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol},a.getSymbols=function(){const e=[];return this.classBreakInfos.forEach((t=>{t.symbol&&e.push(t.symbol)})),this.defaultSymbol&&e.push(this.defaultSymbol),e},a.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},a.getMeshHash=function(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${e}.${t}.${this.classBreakInfos.reduce(((e,t)=>e+t.getMeshHash()),"")}.${s}.${this.field}.${this.valueExpression}`},a.clone=function(){return new F({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:r.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:r.clone(this.visualVariables),legendOptions:r.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},a.collectRequiredFields=async function(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await g.all(s)},a.collectSymbolFields=async function(e,t){const s=[...this.getSymbols().map((s=>s.collectRequiredFields(e,t))),k.collectArcadeFieldNames(e,t,this.valueExpression)];k.collectField(e,t,this.field),k.collectField(e,t,this.normalizationField),await g.all(s)},a._getBreakIndexForExpression=function(e,t){const{viewingMode:s,scale:r,spatialReference:a,arcade:n}=o.unwrapOr(t,{});let i=this._cache.compiledFunc;const l=o.unwrap(n).arcadeUtils;if(!i){const e=l.createSyntaxTree(this.valueExpression);i=l.createFunction(e),this._cache.compiledFunc=i}const c=l.executeFunction(i,l.createExecContext(e,l.getViewInfo({viewingMode:s,scale:r,spatialReference:a})));return this._getBreakIndexfromInfos(c)},a._getBreakIndexForField=function(e){const t=this.field,s=e.attributes,r=this.normalizationType;let o=parseFloat(s[t]);if(r){const e=this.normalizationTotal,t=parseFloat(s[this.normalizationField]);if("log"===r)o=Math.log(o)*Math.LOG10E;else if(r!==w||isNaN(e)){if(r===z&&!isNaN(t)){if(isNaN(o)||isNaN(t))return-1;o/=t}}else o=o/e*100}return this._getBreakIndexfromInfos(o)},a._getBreakIndexfromInfos=function(e){const t=this.isMaxInclusive;if(null!=e&&"number"==typeof e&&!isNaN(e))for(let s=0;s<this.classBreakInfos.length;s++){const r=[this.classBreakInfos[s].minValue,this.classBreakInfos[s].maxValue];if(r[0]<=e&&(t?e<=r[1]:e<r[1]))return s}return-1},a._areClassBreaksConsecutive=function(){const e=this.classBreakInfos,t=e.length;for(let s=1;s<t;s++)if(e[s-1].maxValue!==e[s].minValue)return!1;return!0},e._createClass(s,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"minValue",get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}},{key:"normalizationType",get:function(){let e=this._get("normalizationType");const t=!!this.normalizationField,s=null!=this.normalizationTotal;return t||s?(e=(t?z:s&&w)||null,t&&s&&V.warn("warning: both normalizationField and normalizationTotal are set!")):e!==z&&e!==w||(e=null),e},set:function(e){this._set("normalizationType",e)}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),s}(v.VisualVariablesMixin(_));return t.__decorate([i.property({readOnly:!0,dependsOn:["valueExpression"]})],T.prototype,"_cache",null),t.__decorate([i.property(S.rendererBackgroundFillSymbolProperty)],T.prototype,"backgroundFillSymbol",void 0),t.__decorate([i.property({type:[x]})],T.prototype,"classBreakInfos",void 0),t.__decorate([p.reader("classBreakInfos")],T.prototype,"readClassBreakInfos",null),t.__decorate([f.writer("classBreakInfos")],T.prototype,"writeClassBreakInfos",null),t.__decorate([i.property({type:String,json:{write:!0}})],T.prototype,"defaultLabel",void 0),t.__decorate([i.property(S.rendererSymbolProperty)],T.prototype,"defaultSymbol",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],T.prototype,"field",void 0),t.__decorate([l.cast("field")],T.prototype,"castField",null),t.__decorate([i.property({type:Boolean})],T.prototype,"isMaxInclusive",void 0),t.__decorate([i.property({type:I.default,json:{write:!0}})],T.prototype,"legendOptions",void 0),t.__decorate([i.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],T.prototype,"minValue",null),t.__decorate([i.property({type:String,json:{write:!0}})],T.prototype,"normalizationField",void 0),t.__decorate([i.property({type:Number,cast:e=>n.ensureNumber(e),json:{write:!0}})],T.prototype,"normalizationTotal",void 0),t.__decorate([i.property({type:N.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:N.jsonValues,read:N.read,write:N.write}})],T.prototype,"normalizationType",null),t.__decorate([u.enumeration({classBreaks:"class-breaks"})],T.prototype,"type",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],T.prototype,"valueExpression",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],T.prototype,"valueExpressionTitle",void 0),T=F=t.__decorate([d.subclass("esri.renderers.ClassBreaksRenderer")],T),T}));
