define(["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/has","dojo/Deferred","dojo/on","dojo/promise/all","dojo/when","../kernel","../config","../SpatialReference","../tasks/query","../tasks/StatisticDefinition","../tasks/GenerateRendererTask","../tasks/UniqueValueDefinition","../tasks/ClassBreaksDefinition","../tasks/GenerateRendererParameters","../tasks/generateRenderer","../tasks/GeometryService","../tasks/ProjectParameters","../layers/TileInfo","../layers/HeatmapManager","../workers/heatmapCalculator","../geometry/mathUtils","../geometry/webMercatorUtils","../geometry/scaleUtils","../geometry/Point","../geometry/Extent"],function(e,t,i,a,n,r,s,l,o,u,c,f,d,m,h,g,_,p,v,y,S,F,w,x,D,L,b,z){u=u.defaults;var R=w.prototype._calculateIntensityMatrix,j=w.calculateStats,V=F.prototype._getScreenPoints,M=i(null,{declaredClass:"esri.plugins.FeatureLayerStatistics",sampleSize:500,worldScale:1e8,generalizeForScale:4e5,generalizeForResolution:105,mapWidth:1280,mapHeight:800,mapPaddingRatioForFE:.25,minDistance:12,minLength:30,minSize:15,minScaleRelaxationRatio:.25,samplingThreshold:2e4,numBins:10,numClasses:5,classificationMethod:"equal-interval",standardDeviationInterval:1,geometryServiceUrl:window.location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",tileInfo:new S({rows:256,cols:256,dpi:96,format:"JPEG",compressionQuality:90,origin:{x:-20037508.342787,y:20037508.342787},spatialReference:{wkid:102100,latestWkid:3857},lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555},{level:1,resolution:78271.51696399994,scale:295828763.795777},{level:2,resolution:39135.75848200009,scale:147914381.897889},{level:3,resolution:19567.87924099992,scale:73957190.948944},{level:4,resolution:9783.93962049996,scale:36978595.474472},{level:5,resolution:4891.96981024998,scale:18489297.737236},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.992452562495,scale:4622324.434309},{level:8,resolution:611.4962262813797,scale:2311162.217155},{level:9,resolution:305.74811314055756,scale:1155581.108577},{level:10,resolution:152.87405657041106,scale:577790.554289},{level:11,resolution:76.43702828507324,scale:288895.277144},{level:12,resolution:38.21851414253662,scale:144447.638572},{level:13,resolution:19.10925707126831,scale:72223.819286},{level:14,resolution:9.554628535634155,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.388657133974685,scale:9027.977411},{level:17,resolution:1.1943285668550503,scale:4513.988705},{level:18,resolution:.5971642835598172,scale:2256.994353},{level:19,resolution:.29858214164761665,scale:1128.497176}]}),_outlineInfo:[{size:5,width:0},{size:10,width:1},{size:40,width:1},{size:250,width:2}],constructor:function(t){e.mixin(this,t),this._scaleCache=this._sampleCache=null,this._gsTask=u.geometryService||new v(this.geometryServiceUrl),this.layer.loaded?this._createGRTask():r.once(this.layer,"load",e.hitch(this,this._createGRTask))},destroy:function(){this.layer=this._grTask=this._scaleCache=this._sampleCache=null},getUniqueValues:function(e){var t=new n;return e&&e.field?this._callAfterLoad(this._findUniqueValues,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getUniqueValues: 'field' parameter is missing."),t.promise},getFieldStatistics:function(e){var t=new n;return e&&e.field?this._callAfterLoad(this._getFieldStats,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getFieldStatistics: 'field' parameter is missing."),t.promise},getSpatialStatistics:function(e){var t=new n;return e&&e.features&&e.features.length?this._callAfterLoad(this._spatialStats,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getSpatialStatistics: 'features' parameter is missing or it has no features."),t.promise},getSuggestedSizeRange:function(e){var t=new n;return this._callAfterLoad(this._getSizeRange,{dfd:t,params:e}),t.promise},getSuggestedOutline:function(e){var t=new n;return this._callAfterLoad(this._getOutline,{dfd:t,params:e}),t.promise},getHeatmapStatistics:function(e){var t=new n;return this._callAfterLoad(this._getHeatmapStats,{dfd:t,params:e}),t.promise},getHistogram:function(e){var t=new n;return e&&e.field?this._callAfterLoad(this._getHistogram,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getHistogram: 'field' parameter is missing."),t.promise},getSampleFeatures:function(e){var t=new n;return this._callAfterLoad(this._sampleFeatures,{dfd:t,params:e}),t.promise},getSuggestedScaleRange:function(e){var t=new n;return this._callAfterLoad(this._scaleRange,{dfd:t,params:e}),t.promise},getClassBreaks:function(e){var t=new n;return e&&e.field?this._callAfterLoad(this._findClassBreaks,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getClassBreaks: 'field' parameter is missing."),t.promise},_srcQuery:"service-query",_srcGenRend:"service-generate-renderer",_srcMemory:"features-in-memory",_log10e:Math.LOG10E,_reNumber:/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,_isCollection:function(){return!this.layer.url},_getFieldStats:function(e){var t=this,i=e.params,a=this.layer.getField(i.field);if(!this._rejectNonNumeric(e.dfd,a,"getFieldStatistics"))if(this._isCollection())this._statsFromMemory(i).then(function(t){e.dfd.resolve(t)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")});else{var n=i.normalizationType?this._statsFromGenRend(i):this._statsFromQuery(i);n.then(function(t){e.dfd.resolve(t)}).otherwise(function(){t._statsFromMemory(i).then(function(t){e.dfd.resolve(t)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")})})}},_statsFromQuery:function(e){var i=this.layer,a=new n;if(i.url&&i.supportsStatistics){var r=new f,s=this,l=["min","max","avg","stddev","count","sum","var"],o=this._getRangeExpr(e.field,e.minValue,e.maxValue);o&&(r.where=o),r.outStatistics=t.map(l,function(t){var i=new d;return i.statisticType=t,i.onStatisticField=e.field,i.outStatisticFieldName="var"===t?"variance":t,i}),i.queryFeatures(r).then(function(e){var t,i=e&&e.features,n=i&&i[0]&&i[0].attributes,r={source:s._srcQuery};for(t in n)r[t.toLowerCase()]=n[t];r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),a.resolve(r)}).otherwise(function(){s._rejectDfd(a,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(a,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return a.promise},_statsFromMemory:function(t){var i,a=new n;if("percent-of-total"===t.normalizationType){if(i=this._calcStatsFromMemory({field:t.field}).sum,null==i)return void this._rejectDfd(a,"getFieldStatistics: invalid normalizationTotal.");t=e.mixin({normalizationTotal:i},t)}return a.resolve(this._calcStatsFromMemory(t)),a.promise},_calcStatsFromMemory:function(e){var t=this._getDataValues(this.layer.graphics,e),i=this._calcStatistics(t,!e.normalizationType);return i.source=this._srcMemory,i},_getDataValues:function(e,i){var a,n,r,s=i.field,l=i.normalizationType,o=i.normalizationField,u=i.normalizationTotal,c=null==i.minValue?-1/0:i.minValue,f=null==i.maxValue?1/0:i.maxValue,d=[];return t.forEach(e,function(e){a=e.attributes,r=a&&a[s],l&&null!=r&&(n=a&&parseFloat(a[o]),"log"===l&&0!=r?r=Math.log(r)*this._log10e:"percent-of-total"!==l||isNaN(u)||0==u?"field"!==l||isNaN(n)||0==n||(r/=n):r=r/u*100),null!=r&&!isNaN(r)&&r>=c&&f>=r&&d.push(r)},this),d},_calcStatistics:function(e,i){var a=1/0,n=-1/0,r=0,s=null,l=null,o=null,u=null;if(t.forEach(e,function(e){r++,s+=e,a>e&&(a=e),e>n&&(n=e)}),r){l=s/r;var c=0;t.forEach(e,function(e){c+=Math.pow(e-l,2)}),u=i?r>1?c/(r-1):0:r>0?c/r:0,o=Math.sqrt(u)}return{min:r?a:null,max:r?n:null,count:r,sum:s,avg:l,stddev:o,variance:u}},_statsFromGenRend:function(e){var i=new n,a=this,r=e.normalizationType,s=e.normalizationField;return this.getClassBreaks({field:e.field,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:r,normalizationField:"field"===r?s:void 0,minValue:e.minValue,maxValue:e.maxValue}).then(function(e){var n,r,s,l;t.some(e.classBreakInfos,function(e){return e.hasAvg&&(n=e),!!n}),n&&(l=n.maxValue-n.minValue,r=n.minValue+l/2,s=4*l),i.resolve({min:e.minValue,max:e.maxValue,avg:r,stddev:s,source:a._srcGenRend})}).otherwise(function(){a._rejectDfd(i,"FeatureLayerStatistics.getFieldStatistics: unable to calculate class breaks.")}),i.promise},_spatialStats:function(e){var t=e.params.features,i=this.layer.geometryType,a={},n={point:"esriGeometryPoint"===i,mPoint:"esriGeometryMultipoint"===i,line:"esriGeometryPolyline"===i,polygon:"esriGeometryPolygon"===i};n.point?a=this._getPointStats(t):n.mPoint?a=this._getPointStats(t,!0):n.line?a=this._getLineStats(t):n.polygon&&(a=this._getPolygonStats(t)),a.avgXY=this._getAvgXY(t,n),e.dfd.resolve(a)},_getPointStats:function(e,t){var i,a,n,r,s,l,o,u=e.length,c={},f={},d=0,m=0,h=1/0,g=-1/0,_=0,p=0,v=[];if(t)for(i=0;u>i;i++)e[i].geometry&&v.push.apply(v,e[i].geometry.points);else v=e;for(u=v.length,i=0;u>i;i++)if(t?(c.x=v[i][0],c.y=v[i][1],n=c):n=v[i].geometry,n){for(l=1/0,o=-1/0,a=0;u>a;a++)a!==i&&(t?(f.x=v[a][0],f.y=v[a][1],r=f):r=v[a].geometry,r&&(s=x.getLength(n,r),s>0&&(l>s&&(l=s),h>s&&(h=s),s>o&&(o=s),s>g&&(g=s))));1/0!==l&&(++_,d+=l),o!==-1/0&&(++p,m+=o)}return{minDistance:1/0!==h?h:null,maxDistance:g!==-1/0?g:null,avgMinDistance:_?d/_:null,avgMaxDistance:p?m/p:null}},_getLineStats:function(e){var t,i,a,n=e.length,r={},s={},l=1/0,o=-1/0,u=0,c=0;for(t=0;n>t;t++)i=e[t].geometry,i&&(a=this._getLineLength(i,r,s),a>0&&(++c,u+=a,l>a&&(l=a),a>o&&(o=a)));return{minLength:1/0!==l?l:null,maxLength:o!==-1/0?o:null,avgLength:c?u/c:null}},_getLineLength:function(e,t,i){var a,n,r,s=e.paths,l=s.length,o=0;for(a=0;l>a;a++)n=s[a],r=this._getActualLineLength(n,t,i),r>0&&(o+=r);return o},_getApproxLineLength:function(e,t,i){var a=e[0],n=e[e.length-1],r=0;return a&&n&&a[0]===n[0]&&a[1]===n[1]&&(n=e[e.length-2]),a&&n&&a!==n&&(t.x=a[0],t.y=a[1],i.x=n[0],i.y=n[1],r=x.getLength(t,i)),r},_getActualLineLength:function(e,t,i){var a,n,r,s=e.length,l=0;for(a=0;s-1>a;a++)n=e[a],r=e[a+1],n&&r&&(t.x=n[0],t.y=n[1],i.x=r[0],i.y=r[1],l+=x.getLength(t,i));return l},_getPolygonStats:function(e){var t,i,a,n=e.length,r=1/0,s=-1/0,l=0,o=0;for(t=0;n>t;t++)e[t].geometry&&(a=e[t].geometry.getExtent(),a&&(i=(a.getWidth()+a.getHeight())/2,i>0&&(++o,l+=i,r>i&&(r=i),i>s&&(s=i))));return{minSize:1/0!==r?r:null,maxSize:s!==-1/0?s:null,avgSize:o?l/o:null}},_getAvgXY:function(e,t){var i,a,n,r,s,l,o,u,c,f,d=e.length,m=null,h=null,g=0;for(i=0;d>i;i++)if(l=e[i].geometry)if(t.point)++g,m+=l.x,h+=l.y;else if(t.mPoint)for(o=l.points,s=o.length,a=0;s>a;a++)++g,m+=o[a][0],h+=o[a][1];else if(t.line)for(u=l.paths,r=u.length,a=0;r>a;a++)for(o=u[a],s=o.length,n=0;s>n;n++)++g,m+=o[n][0],h+=o[n][1];else if(t.polygon)for(c=l.rings,r=c.length,a=0;r>a;a++)for(o=c[a],s=o.length,n=0;s>n;n++)++g,m+=o[n][0],h+=o[n][1];return null!=m&&null!=h&&(f={x:m/g,y:h/g}),f},_getSizeRange:function(e){var t=this,i=e.params,a=this.layer,n=a.getMap();if("esriGeometryPolygon"!==a.geometryType)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: not supported for points and lines.");if(!n)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: layer has to be added to the map.");if(i&&"visible-scale-range"===i.optimizeForScale){var r=this._projectExtent(a.fullExtent,this.tileInfo.spatialReference);this.getSuggestedScaleRange({map:!1}).then(function(i){t._processSizeRange(i.spatialStatistics,n,e.dfd,r,i)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate suggested scale range.")})}else this._getFeatures(n,i).then(function(i){t.getSpatialStatistics({features:i}).then(function(i){t._processSizeRange(i,n,e.dfd)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate spatial statistics.")})}).otherwise(function(i){t._rejectDfd(e.dfd,i.message)})},_processSizeRange:function(e,t,i,a,n){var r=this;l(a).always(function(a){a=a&&a.hasOwnProperty("xmin")?a:null,r._calcSizeRange(e,t,i,a,n)})},_getFeatures:function(e,t){var i,a=new n,r=this;if(t&&t.useMapExtent){var s=new f;s.geometry=e.extent,i=this.layer.queryFeatures(s)}else i={features:this.layer.graphics.slice(0)};return l(i).then(function(e){var t=e&&e.features;t&&t.length?a.resolve(t):r._rejectDfd(a,"FeatureLayerStatistics: layer has 0 features.")}).otherwise(function(){r._rejectDfd(a,"FeatureLayerStatistics: unable to query features.")}),a.promise},_calcSizeRange:function(e,i,a,n,r){var s=e&&e.avgSize,l=i.getResolution(),o=i.getScale();if(null==s||isNaN(s))this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedSizeRange: invalid average feature size.");else if(l&&o){var u,c,f;if(r){var d=l/o,m=this._getScaleValues(n,r),h=m.feScaleIndex,g=[],_=[];f=m.scales[h],t.forEach(m.scales,function(e,t){var i=this._calcSizeValues(s,d*e),a=h>-1&&t>h?2:1;g.push({value:e,size:i.min/a}),_.push({value:e,size:i.max/a})},this),u={type:"sizeInfo",expression:"view.scale",stops:g},c={type:"sizeInfo",expression:"view.scale",stops:_}}else{var p=this._calcSizeValues(s,l);u=p.min,c=p.max}a.resolve({minSize:u,maxSize:c,spatialStatistics:e,avgFeatureSize:s,scaleAtFullExtent:f,suggestedScaleRange:r})}else this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedSizeRange: invalid map scale/resolution.")},_getScaleValues:function(e,i){var a=this.tileInfo.lods,n=this.layer.minScale||a[0].scale,r=this.layer.maxScale||a[a.length-1].scale,s=i&&i.minScale||0,l=i&&i.maxScale||0,o=e&&this._findLODForFE(this.tileInfo.lods,e,this.mapWidth,this.mapHeight),u=o&&o.scale<n&&o.scale>r?Math.round(o.scale):0,c=t.map([n,r,s,l,u],Math.round);return c.sort(this._numberSorter),c=t.filter(c,function(e,i){return!!e&&t.indexOf(c,e)===i}),c=t.filter(c,function(e,t,i){return t?Math.abs(e-i[t-1])>5:!0}),{scales:c,feScaleIndex:t.indexOf(c,u)}},_numberSorter:function(e,t){return e-t},_findLODForFE:function(e,t,i,a){var n,r,s,l=e.length,o=t.getWidth(),u=t.getHeight();for(n=0;l>n;n++){if(r=e[n],i*r.resolution<o||a*r.resolution<u){s=0===n?e[n]:e[n-1];break}if(n===l-1){s=e[n];break}}return s},_calcSizeValues:function(e,t){e=Math.ceil(e/t);var i=Math.ceil(e/4);4>i?i=4:i>16&&(i=16);var a=5*i,n=50>a?50:a;return{min:i,max:n}},_getOutline:function(e){var i=this;return"esriGeometryPolygon"!==this.layer.geometryType?void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedOutline: not supported for points and lines."):void this._getFeatures().then(function(a){i.getSpatialStatistics({features:a}).then(function(n){if(n.avgSize){var r;t.some(a,function(e){return e.geometry&&(r=e.geometry.spatialReference),!!r}),i._calcOutline(n,r,e.params,e.dfd)}else i._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedOutline: average feature size is 0 or null.")}).otherwise(function(){i._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedOutline: unable to calculate spatial statistics.")})}).otherwise(function(t){i._rejectDfd(e.dfd,t.message)})},_calcOutline:function(e,i,a,n){var r=e.avgSize,s=a&&null!=a.allowZeroWidth?a.allowZeroWidth:!0,l=39.37*96*L.getUnitValueForSR(i),o=t.map(t.filter(this._outlineInfo,function(e,t){return s||t>1}),function(e){return{size:e.width,value:Math.round(r/e.size*l)}});o.sort(function(e,t){return e.value-t.value}),n.resolve({widthInfo:{type:"sizeInfo",target:"outline",expression:"view.scale",stops:o},spatialStatistics:e})},_getHeatmapStats:function(e){var t=this,i=this.layer,a=e.params,n=e.dfd,r=a.fieldOffset,s=a.field&&this.layer.getField(a.field);a.field&&this._rejectNonNumeric(n,s,"getHeatmapStatistics")||(a.field&&null==r?i.statisticsPlugin.getFieldStatistics({field:a.field}).then(function(e){t._calcHeatmapStats(e,r,a,n)}).otherwise(function(){t._rejectDfd(n,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate field statistics.")}):this._calcHeatmapStats(null,r,a,n))},_calcHeatmapStats:function(e,t,i,a){var n=this;if(e){var r=e.min,s=e.max;e.count?r===s&&0===r?t=1:0>=s?t="abs":0>r&&(t=-1.01*r):t=1}this._heatStatsFromMemory(i,t).then(function(i){i.fieldStatistics=e,i.fieldOffset=t,a.resolve(i)}).otherwise(function(){n._rejectDfd(a,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.")})},_heatStatsFromMemory:function(e,t){var i,a=new n,r=this.layer,s=r.graphics,l=s.length,o=r.getMap();if(!l)return a.resolve({count:0,min:null,max:null,avg:null,stddev:null,source:this._srcMemory}),a.promise;var u=o&&R(V(s,o,r),o.width,o.height,e.blurRadius||10,e.field,t);return i=u&&u.matrix&&j(u.matrix),i?a.resolve({count:l,min:i.min,max:i.max,avg:i.mean,stddev:i.stdDev,source:this._srcMemory}):this._rejectDfd(a,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics."),a.promise},_getHistogram:function(e){var t=this,i=e.params,a=i.minValue,n=i.maxValue,r=null!=a&&null!=n,s=this.layer.getField(i.field);this._rejectNonNumeric(e.dfd,s,"getHistogram")||(i.normalizationType||i.classificationMethod&&"equal-interval"!==i.classificationMethod?this._binParamsFromGenRend(i).then(function(s){if(r)if(a>s.max||n<s.min)t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: custom value range is beyond field value range.");else{var l=t._getFieldExpr(i,s.normTotal),o=t._getRangeExpr(l,a,n);t._binParamsFromGenRend(i,o).then(function(i){t._getBins(e,i.sqlExpr,i.min,i.max,i.intervals,i.source,i.normTotal,i.excludeZerosExpr)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate histogram parameters using custom min/max values.")})}else t._getBins(e,s.sqlExpr,s.min,s.max,s.intervals,s.source,s.normTotal,s.excludeZerosExpr)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max from generate renderer operation.")}):r?this._getBins(e,null,a,n,null,"parameters"):this.getFieldStatistics(i).then(function(i){i.count?t._getBins(e,null,i.min,i.max,null,i.source):t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: cannot calculate histogram for 0 features (statistics.count = 0).")}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")}))},_getBins:function(e,i,a,n,r,s,l,o){var u,c,f=this,d=e.params.field,m=e.params.numBins||this.numBins,h=(n-a)/m,g=a;if(!r)for(r=[],u=1;m>=u;u++)c=g+h,r.push([g,c]),g=c;i=i||d,this._isCollection()?this._countBinsInMemory(e,a,n,r,l,s):this._queryBins(i,r,o).then(function(i){var o=t.map(i,function(e,t){return{minValue:r[t][0],maxValue:r[t][1],count:e}});e.dfd.resolve({bins:o,minValue:a,maxValue:n,normalizationTotal:l,source:f._srcQuery,statisticsSource:s})}).otherwise(function(){f._countBinsInMemory(e,a,n,r,l,s)})},_countBinsInMemory:function(e,t,i,a,n,r){var s=this;this._binsFromMemory(e.params,t,i,a,n).then(function(a){e.dfd.resolve({bins:a,minValue:t,maxValue:i,normalizationTotal:n,source:s._srcMemory,statisticsSource:r})}).otherwise(function(){s._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate histogram.")})},_queryBins:function(e,i,a){var n,r,l=this.layer,o=[],u=i.length;for(n=0;u>n;n++)r=new f,r.where=(a?a+" AND ":"")+e+" >= "+i[n][0]+(null!==i[n][1]?" AND "+e+(n===u-1?" <= ":" < ")+i[n][1]:""),o.push(r);return s(t.map(o,function(e){return l.queryCount(e)}))},_binsFromMemory:function(e,t,i,a,r){var s,l,o,u,c,f,d,m,h=new n,g=e.field,_=e.normalizationType,p=e.normalizationField,v=this.layer.graphics,y=[];if(!v.length)return this._rejectDfd(h,"Layer has 0 features in memory."),h.promise;for(c=a.length,u=0;c>u;u++)y.push({minValue:a[u][0],maxValue:a[u][1],count:0});for(c=v.length,u=0;c>u;u++)s=v[u],l=s&&s.attributes,o=l&&l[g],null!=o&&(_?(d=null,m=l&&parseFloat(l[p]),"log"===_&&0!=o?d=Math.log(o)*this._log10e:"percent-of-total"!==_||isNaN(r)||0==r?"field"!==_||isNaN(m)||0==m||(d=o/m):d=o/r*100):d=o,null!=d&&!isNaN(d)&&d>=t&&i>=d&&(f=this._binIndex(a,d),f>-1&&y[f].count++));return h.resolve(y),h.promise},_binIndex:function(e,t){var i,a,n=e.length,r=-1;for(i=n-1;i>=0;i--)if(a=e[i][0],t>=a){r=i;break}return r},_binParamsFromGenRend:function(e,t){var i=this.layer,a=new n,r=this,s=this._getGRWhereInfo(i,e),l=s.where,o=e.numBins||this.numBins,u=this._createCBDefn(e,o),c=new _;return c.classificationDefinition=u,c.where=l?l+(t?" AND "+t:""):t,!this._isCollection()&&i.version>=10.1?this._grTask.execute(c).then(function(t){r._resolveBinParams(t,s,r._srcGenRend,e,a)}).otherwise(function(){r._binParamsFromMemory(o,s,r._srcMemory,e,a)}):r._binParamsFromMemory(o,s,r._srcMemory,e,a),a.promise},_binParamsFromMemory:function(e,t,i,a,n){var r=this;this._cbFromMemory(a,e).then(function(e){r._resolveBinParams(e,t,i,a,n)}).otherwise(function(){r._rejectDfd(n,"FeatureLayerStatistics.getHistogram: unable to calculate class breaks.")})},_resolveBinParams:function(e,i,a,n,r){var s,l,o=[],u=e.infos,c=u.length;s=u[0].minValue,l=u[c-1].maxValue,t.forEach(u,function(e){o.push([e.minValue,e.maxValue])}),r.resolve({min:s,max:l,intervals:o,sqlExpr:this._getFieldExpr(n,e.normalizationTotal),excludeZerosExpr:i.excludeZerosExpr,normTotal:e.normalizationTotal,source:a})},_getGRWhereInfo:function(e,t){var i,a=t.field,n=t.normalizationType,r=t.normalizationField,s=e.getDefinitionExpression();return"log"===n?i="(NOT "+a+" = 0)":"field"===n&&(i="(NOT "+r+" = 0)"),{where:i?i+(s?" AND "+s:""):s,excludeZerosExpr:i}},_getFieldExpr:function(e,t){var i=e.field,a=e.normalizationType,n=e.normalizationField,r=i;return"percent-of-total"===a?r="(("+i+" / "+t+") * 100)":"log"===a?r="(log("+i+") * "+this._log10e+")":"field"===a&&(r="("+i+" / "+n+")"),r},_getRangeExpr:function(e,t,i){var a=null!=t?e+" >= "+t:"",n=null!=i?e+" <= "+i:"",r="";return r=a&&n?a+" AND "+n:a||n,r?"("+r+")":""},_sampleFeatures:function(e){var t=this,i=e.params,a=e.dfd,n=this.layer,r=n.graphics,s=this._sampleCache,l=i&&i.resample,o=i&&i.sampleSize||this.sampleSize;if(s&&!l)return void a.resolve(this._cloneSample(s));if(a._time={start:this._getTime()},r.length&&o<=r.length)this._resolveSample(a,this._pickItems(r,o),this._srcMemory);else{var u=new f;u.where="1=1",a._time.countStart=this._getTime(),n.queryCount(u).then(function(e){a._time.countEnd=t._getTime(),a._totalFeatures=e,o>n.maxRecordCount&&(o=n.maxRecordCount);var s;if(e)if(e<=r.length)t._resolveSample(a,t._pickItems(r,r.length),t._srcMemory);else if(o>=e)s=new f,s.where="1=1",t._queryFeatures(s,i,n,r,a);else if(e<=t.samplingThreshold){var l=new f;l.where="1=1",a._time.idStart=t._getTime(),n.queryIds(l).then(function(e){a._time.idEnd=t._getTime();var s=new f;s.objectIds=t._pickItems(e,o),t._queryFeatures(s,i,n,r,a)}).otherwise(function(){s=new f,s.where="1=1",t._queryFeatures(s,i,n,r,a)})}else{s=new f,s.where="1=1";var u=n.advancedQueryCapabilities;u&&u.supportsPagination&&(s.num=o),t._queryFeatures(s,i,n,r,a)}else t._resolveSample(a,[],t._srcQuery)}).otherwise(function(){t._resolveSample(a,t._pickItems(r,r.length),t._srcMemory)})}},_queryFeatures:function(e,t,i,a,n){var r=this;e.outSpatialReference=t&&t.spatialReference,e.maxAllowableOffset=t&&t.maxAllowableOffset,e.outFields=t&&t.outFields,n._time.featStart=this._getTime(),i.queryFeatures(e).then(function(e){n._time.featEnd=r._getTime();var t=e&&e.features;r._resolveSample(n,t||[],r._srcQuery)}).otherwise(function(){r._resolveSample(n,r._pickItems(a,a.length),r._srcMemory)})},_pickItems:function(e,i){var a,n=e.length,r=[],s=[];if(i>=n)s=e.slice(0);else for(;s.length<i;)a=this._getRandomInt(0,n),-1===t.indexOf(r,a)&&(r.push(a),s.push(e[a]));return s},_getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e))+e},_resolveSample:function(e,t,i){t=t||[];var a,n,r,s=t.length;for(a=0;s>a&&(n=t[a].geometry,!(r=n&&n.spatialReference));a++);e._time.end=(new Date).getTime();var l=e._time;e._time=null,this._sampleCache={features:t,spatialReference:r&&new c(r.toJson()),source:i,time:this._getTimeStats(l),totalFeatures:e._totalFeatures},e.resolve(this._cloneSample(this._sampleCache))},_cloneSample:function(i){return{features:t.map(i.features,function(e){return new e.constructor(e.toJson())}),spatialReference:i.spatialReference&&new c(i.spatialReference.toJson()),source:i.source,time:e.clone(i.time),totalFeatures:i.totalFeatures}},_getTimeStats:function(e){var t=this._getTimeDiff;return{total:t(e.start,e.end),features:t(e.featStart,e.featEnd),featureIds:t(e.idStart,e.idEnd),featureCount:t(e.countStart,e.countEnd)}},_getTimeDiff:function(e,t){var i,a,n;return null!=e&&null!=t&&(a=t-e,n="millisecond",a>=1e3&&(a/=1e3,n="second",a>=60&&(a/=60,n="minute")),i={value:Number(a.toFixed(2)),unit:n}),i},_getTime:function(){return(new Date).getTime()},_scaleRange:function(e){var t,i,a,n=this,r=e.params,s=this.layer,o=r&&r.sampleSize||this.sampleSize,u=r&&r.map||s.getMap(),c=r&&r.mapWidth||this.mapWidth,f=r&&r.mapHeight||this.mapHeight,d=r&&r.generalizeForScale||this.generalizeForScale;r&&r.map===!1&&(u=null),u&&u.__tileInfo?(t=u.__tileInfo,i=u.spatialReference,a=u.extent.getWidth()/u.width/u.getScale()*d):(t=this.tileInfo,i=t.spatialReference,a=this.generalizeForResolution/this.generalizeForScale*d),this.getSampleFeatures({sampleSize:o,spatialReference:i,maxAllowableOffset:a,outFields:[]}).then(function(a){var o=n._projectExtent(s.fullExtent,i),u=a.features;u&&u.length?n.getSpatialStatistics({features:u}).then(function(i){l(o).always(function(s){s=s&&s.hasOwnProperty("xmin")?s:null,n._processScaleRange(e.dfd,r,t,c,f,s,a,i)})}).otherwise(function(){n._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to calculate spatial statistics.")}):n._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: sampling returned 0 features.")}).otherwise(function(){n._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to sample features.")})},_processScaleRange:function(e,t,i,a,n,r,s,l){var o,u,f=this.layer.geometryType,d={point:"esriGeometryPoint"===f,mPoint:"esriGeometryMultipoint"===f,line:"esriGeometryPolyline"===f,polygon:"esriGeometryPolygon"===f},m=i.lods,h=this._getLODForMinScale(t,l,d,i),g=d.polygon?this._getLODForMaxScale(t,l,d,i):null,_=1-this.mapPaddingRatioForFE,p=r&&this._findLODForFE(m,r,a*_,n*_),v=p?p.scale:null,y=this._getLODForMinScale(t,l,d,i,this.minScaleRelaxationRatio),S=y?y.scale:null,F=l.avgXY,w=F&&new b(F.x,F.y,s.spatialReference&&new c(s.spatialReference.toJson())),x=this,D=d.polygon?g?Math.floor(g.scale):null:0;h&&r&&w&&(u=this._findClosestLOD(m,h,r,w,a,n)),h=u||h,o=h?Math.ceil(h.scale):null,S=S&&v?Math.max(S,2*v):S||2*v,v=v&&Math.ceil(v),S=S&&Math.ceil(S),h||g?h&&w?this._countAtView(w,h,a,n).then(function(t){var i;if(!t){var a,n=s.features[0];d.point?i=n.geometry:(a=n.geometry&&n.geometry.getExtent(),i=a&&a.getCenter())}x._resolveScaleRange(e,o,D,v,S,i||w,s,l)}).otherwise(function(){x._resolveScaleRange(e,o,D,v,S,w,s,l)}):this._resolveScaleRange(e,o,D,v,S,w,s,l):this._rejectDfd(e,"FeatureLayerStatistics.getSuggestedScaleRange: unable to find optimal scale range.")},_resolveScaleRange:function(e,t,i,a,n,r,s,l){i>t?this._rejectDfd(e,"FeatureLayerStatistics.getSuggestedScaleRange: invalid scale range - calculated minScale is less than maxScale."):e.resolve({minScale:t&&(t>this.worldScale?0:t),maxScale:i,scaleAtFullExtent:a,relaxedMinScale:n&&(n>this.worldScale?0:n),center:r,sampleInfo:s,spatialStatistics:l})},_countAtView:function(e,t,i,a){var n=this._getExtentFromCenter(e,t,i,a),r=new f;return r.geometry=n,this.layer.queryCount(r).promise},_projectExtent:function(e,t){if(e.spatialReference.equals(t))return new e.constructor(e.toJson());if(D.canProject(e.spatialReference,t))return D.project(e,t);var i=new y;return i.geometries=[e],i.outSR=t,this._gsTask.project(i).then(function(e){return e&&e[0]})},_getLODForMinScale:function(e,t,i,a,n){var r,s,l,o=e&&e.minDistance||this.minDistance,u=e&&e.minLength||this.minLength,c=e&&e.minSize||this.minSize;return i.point?(r=t.avgMinDistance,l=o):i.mPoint?(r=t.avgMinDistance,l=o):i.line?(r=t.avgLength,l=u):i.polygon&&(r=t.avgSize,l=c),r>0&&(s=this._findLOD(a,r,l*(n||1))),s},_getLODForMaxScale:function(e,t,i,a){var n,r,s,l=this.mapWidth,o=e&&e.maxDistance||l/4,u=e&&e.maxLength||l/4,c=e&&e.maxSize||l/2;return i.point?(n=t.minDistance,s=o):i.mPoint?(n=t.minDistance,s=o):i.line?(n=t.minLength,s=u):i.polygon&&(n=t.minSize,s=c),n>0&&(r=this._findLOD(a,n,null,s)),r},_findLOD:function(e,t,i,a){var n,r,s,l,o=e&&e.lods;if(o&&o.length){var u=null!=a,c=u?o.length-1:0,f=u?0:o.length-1,d=u?-1:1;for(s=c;u?s>=f:f>=s;s+=d)if(r=o[s],l=Math.round(t/r.resolution),u){if(a>=l){n=r;break}}else if(l>=i){n=r;break}}return n},_getExtentFromCenter:function(e,t,i,a){var n=i/2*t.resolution,r=a/2*t.resolution;return new z(e.x-n,e.y-r,e.x+n,e.y+r,new c(e.spatialReference.toJson()))},_findClosestLOD:function(e,t,i,a,n,r){var s,l,o,u=e.length;for(s=0;u>s;s++)if(!(e[s].level<t.level)){if(l=this._getExtentFromCenter(a,e[s],n,r),!l.contains(i)){o=e[s-1];break}if(s===u-1){o=e[s];break}}return o=o&&o.level>t.level?o:null},_findUniqueValues:function(e){var t=this,i=e.params,a=this.layer.getField(i.field);return a?void(this._isCollection()?this._uvFromMemory(i).then(function(i){t._resolveUVDfd(i,e,a,t._srcMemory)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate unique values.")}):this._uvFromStatisticsQuery(i).then(function(i){t._resolveUVDfd(i,e,a,t._srcQuery)}).otherwise(function(){t._uvFromGenRenderer(i,a).then(function(i){t._resolveUVDfd(i,e,a,t._srcGenRend)}).otherwise(function(){t._uvFromMemory(i).then(function(i){t._resolveUVDfd(i,e,a,t._srcMemory)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate unique values.")})})})):void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getUniqueValues: unknown 'field'.")},_uvFromStatisticsQuery:function(i){var a=this.layer,r=new n;if(a.supportsStatistics){var s="countOF"+i.field,l=this,o=new d;o.statisticType="count",o.onStatisticField=i.field,o.outStatisticFieldName=s;var u=new f;u.outStatistics=[o],u.groupByFieldsForStatistics=[i.field],a.queryFeatures(u).then(function(n){var o,c,d,m,h={};t.forEach(n.features,function(t){o=t.attributes,c=this._getAttributeVal(o,i.field),d=this._getAttributeVal(o,s),null===c&&0===d&&(m=!0),(null==c||""===c||"string"==typeof c&&""===e.trim(c))&&(c=null),null==h[c]?h[c]={count:d,data:c}:h[c].count=h[c].count+d},l),m?(u=new f,u.where=i.field+" is NULL",a.queryCount(u).then(function(e){e=e||0,h["null"].count=h["null"].count+e,r.resolve({count:h})}).otherwise(function(){r.resolve({count:h})})):r.resolve({count:h})}).otherwise(function(){l._rejectDfd(r,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(r,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return r.promise},_uvFromGenRenderer:function(i,a){var r=this.layer,s=new n,l=this;if(r.version>=10.1){var o=new h;o.attributeField=i.field;var u=new _;u.classificationDefinition=o,u.where=r.getDefinitionExpression(),this._grTask.execute(u).then(function(i){var n,r={},o=t.indexOf(l._numericTypes,a.type)>-1;t.forEach(i.infos,function(t){n=t.value,(null==n||""===n||"string"==typeof n&&(""===e.trim(n)||"<null>"===n.toLowerCase()))&&(n=null),null==r[n]?r[n]={count:t.count,data:o&&n?Number(n):n}:r[n].count=r[n].count+t.count}),s.resolve({count:r})}).otherwise(function(){l._rejectDfd(s,"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(s,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return s.promise},_uvFromMemory:function(i){var a,r,s=this.layer,l=new n,o=i.field,u={};return t.forEach(s.graphics,function(t){a=t.attributes,r=a&&a[o],(null==r||""===r||"string"==typeof r&&""===e.trim(r))&&(r=null),null==u[r]?u[r]={count:1,data:r}:u[r].count++}),l.resolve({count:u}),l.promise},_resolveUVDfd:function(e,i,a,n){var r,s,l=e.count,o=this.layer.getDomain(a.name),u=[];i.params.includeAllCodedValues&&o&&"codedValue"===o.type&&t.forEach(o.codedValues,function(e){var t=e.code;
l.hasOwnProperty(t)||(l[t]={data:t,count:0})});for(r in l)s=l[r],u.push({value:s.data,count:s.count});i.dfd.resolve({source:n,uniqueValueInfos:u})},_findClassBreaks:function(e){var t=this,i=e.params,a=i.minValue,n=i.maxValue,r=null!=a||null!=n,s=i.classificationMethod,l="percent-of-total"===i.normalizationType,o=i.numClasses||this.numClasses,u=i.analyzeData!==!1,c=this.layer.getField(i.field);if(!this._rejectNonNumeric(e.dfd,c,"getClassBreaks")){if(r)if(u){if(l&&null==i.normalizationTotal)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when minValue/maxValue are specified.")}else{if(null==a||null==n)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");if(s&&"equal-interval"!==s)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: data analysis can be disabled only for equal-interval classification.");if(l&&null==i.normalizationTotal)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when data analysis is disabled.")}else if(!u)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");u?this._cbFromGenRend(i,o).then(function(a){t._resolveCBDfd(e.dfd,i,a,t._srcGenRend)}).otherwise(function(){r?t._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: cannot calculate class breaks in-memory when minValue/maxValue are specified."):t._cbFromMemory(i,o).then(function(a){t._resolveCBDfd(e.dfd,i,a,t._srcMemory)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}):this._cbFromInterpolation(i,o).then(function(a){t._resolveCBDfd(e.dfd,i,a,t._srcMemory)}).otherwise(function(){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}},_cbFromGenRend:function(e,t){var i=this.layer,a=new n,r=this;if(i.url&&i.version>=10.1){var s=this._createCBDefn(e,t),l=this._getGRWhereInfo(i,e),o=l.where,u=this._getFieldExpr(e,e.normalizationTotal),c=this._getRangeExpr(u,e.minValue,e.maxValue),f=new _;f.classificationDefinition=s,f.where=o?o+(c?" AND "+c:""):c,this._grTask.execute(f).then(function(e){a.resolve(e)}).otherwise(function(){r._rejectDfd(a,"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(a,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return a.promise},_cbFromMemory:function(t,i){var a=new n,r=this.layer.graphics;if(r.length){var s,l=this._createCBDefn(t,i);if("percent-of-total"===t.normalizationType){if(s=this._calcStatsFromMemory({field:t.field}).sum,null==s)return this._rejectDfd(a,"FeatureLayerStatistics: Invalid normalizationTotal."),a.promise;t=e.mixin({normalizationTotal:s},t)}a.resolve(p.createClassBreaksRenderer({features:r,definition:l,values:this._getDataValues(r,t)}))}else this._rejectDfd(a,"Layer has 0 features in memory.");return a.promise},_cbFromInterpolation:function(e,t){var i=new n,a=e.minValue,r=e.maxValue;if(a>=r||!t||1>t)this._rejectDfd(i,"FeatureLayerStatistics.getClassBreaks: invalid input parameters: minValue, maxValue or numClasses.");else{var s,l,o=[],u=(r-a)/t;for(s=0;t>s;s++)l=a+s*u,o.push({minValue:l,maxValue:l+u});o[t-1].maxValue=r,i.resolve({infos:o,normalizationTotal:e.normalizationTotal})}return i.promise},_createCBDefn:function(e,t){var i=e.field,a=e.classificationMethod||this.classificationMethod,n=e.normalizationType,r=e.normalizationField,s=new g;return s.classificationField=i,s.breakCount=t,s.classificationMethod=a,s.standardDeviationInterval="standard-deviation"===a?e.standardDeviationInterval||this.standardDeviationInterval:void 0,s.normalizationType=n,s.normalizationField="field"===n?r:void 0,s},_resolveCBDfd:function(i,a,n,r){var s,l,o,u=n.infos,c=u.length,f=u[0].minValue,d=u[c-1].maxValue,m="standard-deviation"===a.classificationMethod,h=this._reNumber;u=t.map(u,function(i){return o=i.label,l={minValue:i.minValue,maxValue:i.maxValue,label:o},m&&o&&(s=o.match(h),s=t.map(s,function(t){return+e.trim(t)}),2===s.length?(l.minStdDev=s[0],l.maxStdDev=s[1],s[0]<0&&s[1]>0&&(l.hasAvg=!0)):1===s.length&&(o.indexOf("<")>-1?(l.minStdDev=null,l.maxStdDev=s[0]):o.indexOf(">")>-1&&(l.minStdDev=s[0],l.maxStdDev=null))),l}),i.resolve({minValue:f,maxValue:d,classBreakInfos:u,normalizationTotal:n.normalizationTotal,source:r})},_rejectDfd:function(e,t){e.reject(new Error(t))},_rejectNonNumeric:function(e,i,a){var n;return i?(i.name===this.layer.objectIdField||-1===t.indexOf(this._numericTypes,i.type))&&(this._rejectDfd(e,"FeatureLayerStatistics."+a+": 'field' should be numeric."),n=!0):(this._rejectDfd(e,"FeatureLayerStatistics."+a+": unknown 'field'."),n=!0),n},_getAttributeVal:function(e,t){var i,a;if(t=t.toLowerCase(),e)for(a in e)if(a.toLowerCase()===t){i=e[a];break}return i},_callAfterLoad:function(t,i){this.layer.loaded?t.call(this,i):r.once(this.layer,"load",e.hitch(this,t,i))},_numericTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_createGRTask:function(){this._grTask=new m(this.layer,{source:this.layer.source,gdbVersion:this.layer.gdbVersion})}});return e.mixin(M,{add:function(e,t){if(!e.statisticsPlugin){var i=t||{};i.layer=e,e.statisticsPlugin=new M(i)}},remove:function(e){e.statisticsPlugin&&(e.statisticsPlugin.destroy(),delete e.statisticsPlugin)}}),a("extend-esri")&&e.setObject("plugins.FeatureLayerStatistics",M,o),M});