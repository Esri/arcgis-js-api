// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/has","dojo/Deferred","dojo/on","dojo/promise/all","dojo/when","dojo/string","../kernel","../config","../urlUtils","../Evented","../SpatialReference","../support/expressionUtils","../tasks/query","../tasks/StatisticDefinition","../tasks/GenerateRendererTask","../tasks/UniqueValueDefinition","../tasks/ClassBreaksDefinition","../tasks/GenerateRendererParameters","../tasks/generateRenderer","../tasks/GeometryService","../tasks/ProjectParameters","../layers/TileInfo","../layers/support/attributeUtils","../layers/HeatmapManager","../workers/heatmapCalculator","../geometry/mathUtils","../geometry/webMercatorUtils","../geometry/scaleUtils","../geometry/Point","../geometry/Extent"],(function(e,t,i,a,s,r,n,l,o,u,c,f,d,m,h,g,p,_,v,y,S,F,x,D,E,L,w,T,j,V,b,z,C){c=c.defaults;var M=T.prototype._calculateIntensityMatrix,q=T.calculateStats,R=w.prototype._getScreenPoints,A=/_value$/i,I=["min","max","avg","stddev","count","sum","variance"],k=i([d],{declaredClass:"esri.plugins.FeatureLayerStatistics",sampleSize:500,worldScale:1e8,generalizeForScale:4e5,generalizeForResolution:105,mapWidth:1280,mapHeight:800,mapPaddingRatioForFE:.25,minDistance:12,minLength:30,minSize:15,minScaleRelaxationRatio:.25,samplingThreshold:2e4,numBins:10,numClasses:5,classificationMethod:"equal-interval",standardDeviationInterval:1,geometryServiceUrl:f.getProtocolForWebResource()+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",tileInfo:new E({rows:256,cols:256,dpi:96,format:"JPEG",compressionQuality:90,origin:{x:-20037508.342787,y:20037508.342787},spatialReference:{wkid:102100,latestWkid:3857},lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555},{level:1,resolution:78271.51696399994,scale:295828763.795777},{level:2,resolution:39135.75848200009,scale:147914381.897889},{level:3,resolution:19567.87924099992,scale:73957190.948944},{level:4,resolution:9783.93962049996,scale:36978595.474472},{level:5,resolution:4891.96981024998,scale:18489297.737236},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.992452562495,scale:4622324.434309},{level:8,resolution:611.4962262813797,scale:2311162.217155},{level:9,resolution:305.74811314055756,scale:1155581.108577},{level:10,resolution:152.87405657041106,scale:577790.554289},{level:11,resolution:76.43702828507324,scale:288895.277144},{level:12,resolution:38.21851414253662,scale:144447.638572},{level:13,resolution:19.10925707126831,scale:72223.819286},{level:14,resolution:9.554628535634155,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.388657133974685,scale:9027.977411},{level:17,resolution:1.1943285668550503,scale:4513.988705},{level:18,resolution:.5971642835598172,scale:2256.994353},{level:19,resolution:.29858214164761665,scale:1128.497176}]}),_outlineInfo:[{size:10,width:0},{size:20,width:.5},{size:80,width:1},{size:250,width:2}],_srcQuery:"service-query",_srcGenRend:"service-generate-renderer",_srcMemory:"features-in-memory",_srcFeatures:"features",_log10e:Math.LOG10E,_reNumber:/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,constructor:function(t){e.mixin(this,t),this._sampleCache=this._maxFeaturesForStats=null,this._gsTask=c.geometryService||new x(this.geometryServiceUrl),this.layer.loaded?this._createGRTask():r.once(this.layer,"load",e.hitch(this,this._createGRTask))},destroy:function(){this.clearFeaturesCache(),this.layer=this._grTask=null},clearFeaturesCache:function(){this._sampleCache=this._maxFeaturesForStats=null},getUniqueValues:function(e){var t=new s;return e&&(e.field||e.valueExpression)?this._callAfterLoad(this._fetchFeatures,{dfd:t,params:e},this._findUniqueValues):this._rejectDfd(t,"FeatureLayerStatistics.getUniqueValues: 'field' or 'valueExpression' parameter is required."),t.promise},getPredominantCategories:function(e){var t=new s;return e&&e.fields?e.fields.length<2?this._rejectDfd(t,"FeatureLayerStatistics.getPredominantCategories: invalid fields. Minimum required is 2."):this._callAfterLoad(this._predominantCategories,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getPredominantCategories: 'fields' parameter is missing."),t.promise},getPredominanceExpressions:function(e){var t=new s;return e&&e.fields?e.fields.length<2?this._rejectDfd(t,"FeatureLayerStatistics.getPredominanceExpressions: invalid fields. Minimum required is 2."):this._callAfterLoad(this._predominanceExpressions,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getPredominanceExpressions: 'fields' parameter is missing."),t.promise},getAgeStatistics:function(e){var t=new s;return null==e.startTime||null==e.endTime||null==e.units?this._rejectDfd(t,"FeatureLayerStatistics.getAgeStatistics: 'startTime', 'endTime' or 'units' parameter is missing."):this._callAfterLoad(this._ageStatistics,{dfd:t,params:e}),t.promise},getSuggestedAgeUnits:function(e){var t=new s;return null==e.startTime||null==e.endTime?this._rejectDfd(t,"FeatureLayerStatistics.getSuggestedAgeUnits: 'startTime' or 'endTime' parameter is missing."):this._callAfterLoad(this._suggestedAgeUnits,{dfd:t,params:e}),t.promise},getAgeExpressions:function(e){var t=new s;return null==e.startTime||null==e.endTime?this._rejectDfd(t,"FeatureLayerStatistics.getAgeExpressions: 'startTime' or 'endTime' parameter is missing."):this._callAfterLoad(this._ageExpressions,{dfd:t,params:e}),t.promise},getFieldStatistics:function(e){var t=new s;return e&&(e.field||e.valueExpression||e.sqlExpression)?this._callAfterLoad(this._getFieldStats,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getFieldStatistics: 'field', 'valueExpression' or 'sqlExpression' parameter is required."),t.promise},getSuggestedDataRange:function(e){var t=e&&e.statistics;if(t){var i,a;if(null==t.min)if(e.isDate){var s=this._getYearOfDate();i=s[0],a=s[1]}else i=0,a=100;else if(t.min===t.max)if(e.isDate){var r=this._getYearOfDate(t.min);i=r[0],a=r[1]}else t.min<0?(i=2*t.min,a=0):t.min>0?(i=0,a=2*t.min):(i=0,a=100);return{min:null!=i?i:t.min,max:null!=a?a:t.max,defaultStatistics:null!=i||null!=a}}console.log("FeatureLayerStatistics.getSuggestedDataRange: 'statistics' parameter is required.")},getSpatialStatistics:function(e){var t=new s;return e&&e.features&&e.features.length?this._callAfterLoad(this._spatialStats,{dfd:t,params:e}):this._rejectDfd(t,"FeatureLayerStatistics.getSpatialStatistics: 'features' parameter is missing or it has no features."),t.promise},getSuggestedSizeRange:function(e){var t=new s;return this._callAfterLoad(this._getSizeRange,{dfd:t,params:e}),t.promise},getSuggestedOutline:function(e){var t=new s;return this._callAfterLoad(this._getOutline,{dfd:t,params:e}),t.promise},getHeatmapStatistics:function(e){var t=new s;return this._callAfterLoad(this._getHeatmapStats,{dfd:t,params:e}),t.promise},getHistogram:function(e){var t=new s;return e&&(e.field||e.valueExpression||e.sqlExpression)?this._callAfterLoad(this._fetchFeatures,{dfd:t,params:e},this._getHistogram):this._rejectDfd(t,"FeatureLayerStatistics.getHistogram: 'field', 'valueExpression' or 'sqlExpression' parameter is required."),t.promise},getSampleFeatures:function(t){var i=new s;return(t=e.mixin({},t)).caching=null==t.caching||t.caching,t.sampleSize=t.sampleSize||this.sampleSize,this._callAfterLoad(this._sampleFeatures,{dfd:i,params:t}),i.promise},getSuggestedScaleRange:function(e){var t=new s;return this._callAfterLoad(this._scaleRange,{dfd:t,params:e}),t.promise},getClassBreaks:function(e){var t=new s;return e&&(e.field||e.valueExpression)?this._callAfterLoad(this._fetchFeatures,{dfd:t,params:e},this._findClassBreaks):this._rejectDfd(t,"FeatureLayerStatistics.getClassBreaks: 'field' or 'valueExpression' parameter is required."),t.promise},_isCollection:function(){return!this.layer.url||this.layer.declaredClass.indexOf("CSVLayer")>-1},_getFieldStats:function(t){var i=this,a=t.params,s=e.isFunction(a.field),r=a.valueExpression||a.sqlExpression,n=r&&!a.sqlExpression,o=this._isCollection()||a.features,u=s||n,c=a.field&&!s?this.layer.getField(a.field):null,f=!!c&&c.type===this._dateType;if(c){if(this._rejectIfInvalidType(t.dfd,c,"getFieldStatistics",[].concat(this._numericTypes).concat(this._dateType)))return;if(f&&a.normalizationType)return void this._rejectDfd(t.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when calculating statistics for date field.")}else if(r){if(a.normalizationType)return void this._rejectDfd(t.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when valueExpression or sqlExpression is specified.");if(n){var d=this._getExpressionInfo(a.valueExpression);if(this._rejectIfInvalidExpression(t.dfd,d,"getFieldStatistics"))return}}if(o||u){var m=!o&&u?this._fetchMaxFeaturesForStats():null;l(m).always((function(s){var r=s&&s.features;r&&((a=e.mixin({},a)).features=r),i._statsFromMemory(a,f).then((function(e){var a=s&&s.hasAllFeatures;i._resolveStats(t.dfd,e,a)})).otherwise((function(e){i._rejectDfd(t.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")}))}))}else{if(!this._canUseSQL92Expression()&&(f||r))return void this._rejectDfd(t.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate statistics. Make sure the layer supports SQL expressions and standardized queries.");(a.normalizationType?this._statsFromGenRend(a):this._statsFromQuery(a,f)).then((function(e){i._resolveStats(t.dfd,e)})).otherwise((function(s){l(i._fetchMaxFeaturesForStats()).always((function(s){var r=s&&s.features;r&&((a=e.mixin({},a)).features=r),i._statsFromMemory(a,f).then((function(e){var a=s&&s.hasAllFeatures;i._resolveStats(t.dfd,e,a)})).otherwise((function(e){i._rejectDfd(t.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")}))}))}))}},_resolveStats:function(e,i,a){for(var s in i)t.indexOf(I,s)>-1&&(this._isValidNumber(i[s])||(i[s]=null));i.partialData=null!=a?!a:!this._isCollection()&&i.source===this._srcMemory,e.resolve(i)},_statsFromQuery:function(i,a){var s;return this._canUseSQL92Expression()&&a&&(delete(s=e.mixin({},i)).field,s.sqlExpression=this._msSinceUnixEpochSQL(i.field)),this._executeStatsQuery(s||i).then((function(e){return a&&(t.forEach(["min","max","avg","stddev","sum","variance"],(function(t){null!=e[t]&&(e[t]=Math.ceil(e[t]))})),e.min===e.max&&null!=e.min&&(e.avg=e.min,e.stddev=e.variance=0)),e}))},_msSinceUnixEpochSQL:function(e){return this._getDateDiffSQL(new Date(0),e,"milliseconds").sqlExpression},_executeStatsQuery:function(e){var i=this.layer,a=new s;if(i.url&&i.supportsStatistics){var r=new g,n=this,l=e.sqlExpression||e.field,o=l?this._getRangeExpr(l,e.minValue,e.maxValue):null;r.sqlFormat=e.sqlExpression?"standard":null,r.where=this._mergeWhereClauses(e.sqlWhere,o),r.outStatistics=t.map(I,(function(e){var t=new p;return t.statisticType="variance"===e?"var":e,t.onStatisticField=l,t.outStatisticFieldName=e+"_value",t})),i.queryFeatures(r).then((function(e){var t,i=e&&e.features,s=i&&i[0]&&i[0].attributes,r={source:n._srcQuery};for(t in s)r[t.replace(A,"").toLowerCase()]=s[t];r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),a.resolve(r)})).otherwise((function(e){n._rejectDfd(a,"FeatureLayerStatistics: Statistics query operation failed.")}))}else this._rejectDfd(a,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return a.promise},_mergeWhereClauses:function(e,t){var i=e;return t&&(i=i?"("+i+") AND ("+t+")":t),i},_statsFromMemory:function(t,i){var a,r=new s;if("percent-of-total"===t.normalizationType){if(null==(a=this._calcStatsFromMemory({field:t.field}).sum))return void this._rejectDfd(r,"getFieldStatistics: invalid normalizationTotal.");t=e.mixin({normalizationTotal:a},t)}return r.resolve(this._calcStatsFromMemory(t,i)),r.promise},_calcStatsFromMemory:function(e,i){var a=!(!e.features||!e.features.length),s=this._getDataValues(a?e.features:this.layer.graphics,e),r=this._calcStatistics(s,!e.normalizationType);return r.source=a?this._srcFeatures:this._srcMemory,i&&t.forEach(["avg","stddev","variance"],(function(e){null!=r[e]&&(r[e]=Math.ceil(r[e]))})),r},_isValidNumber:function(e){return"number"==typeof e&&!isNaN(e)&&e!==1/0&&e!==-1/0},_getDataValues:function(e,i){var a=L.createAttributeCache({field:i.field,valueExpression:i.valueExpression,normalizationType:i.normalizationType,normalizationField:i.normalizationField,normalizationTotal:i.normalizationTotal}),s=null==i.minValue?-1/0:i.minValue,r=null==i.maxValue?1/0:i.maxValue,n=[];return t.forEach(e,(function(e){var t=e._getDataValue(a.attributeInfo,a,h,this.layer);null!=t&&t>=s&&t<=r&&n.push(t)}),this),n},_calcStatistics:function(e,i){var a=1/0,s=-1/0,r=0,n=null,l=null,o=null,u=null;if(t.forEach(e,(function(e){r++,n+=e,e<a&&(a=e),e>s&&(s=e)})),r){l=n/r;var c=0;t.forEach(e,(function(e){c+=Math.pow(e-l,2)})),u=i?r>1?c/(r-1):0:r>0?c/r:0,o=Math.sqrt(u)}return{min:r?a:null,max:r?s:null,count:r,sum:n,avg:l,stddev:o,variance:u}},_statsFromGenRend:function(e){var i=new s,a=this,r=e.normalizationType,n=e.normalizationField;return this.getClassBreaks({field:e.field,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:r,normalizationField:"field"===r?n:void 0,minValue:e.minValue,maxValue:e.maxValue}).then((function(e){var s,r,n,l;t.some(e.classBreakInfos,(function(e,t){return e.hasAvg&&(s=e),!!s})),s&&(l=s.maxValue-s.minValue,r=s.minValue+l/2,n=4*l),i.resolve({min:e.minValue,max:e.maxValue,avg:r,stddev:n,source:a._srcGenRend})})).otherwise((function(e){a._rejectDfd(i,"FeatureLayerStatistics.getFieldStatistics: unable to calculate class breaks.")})),i.promise},_getYearOfDate:function(e){var t=("number"==typeof e?new Date(e):new Date).getUTCFullYear(),i=Date.UTC(t,0,1,12,0,0,0),a=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<i&&(i=e),e>a&&(a=e)),[i,a]},_spatialStats:function(e){var t=e.params.features,i=this.layer.geometryType,a={},s={point:"esriGeometryPoint"===i,mPoint:"esriGeometryMultipoint"===i,line:"esriGeometryPolyline"===i,polygon:"esriGeometryPolygon"===i||this.layer.hasXYFootprint()};s.point?a=this._getPointStats(t):s.mPoint?a=this._getPointStats(t,!0):s.line?a=this._getLineStats(t):s.polygon&&(a=this._getPolygonStats(t)),a.avgXY=this._getAvgXY(t,s),e.dfd.resolve(a)},_getPointStats:function(e,t){var i,a,s,r,n,l,o,u=e.length,c={},f={},d=0,m=0,h=1/0,g=-1/0,p=0,_=0,v=[];if(t)for(i=0;i<u;i++)e[i].geometry&&v.push.apply(v,e[i].geometry.points);else v=e;for(u=v.length,i=0;i<u;i++)if(t?(c.x=v[i][0],c.y=v[i][1],s=c):s=v[i].geometry,s){for(l=1/0,o=-1/0,a=0;a<u;a++)a!==i&&(t?(f.x=v[a][0],f.y=v[a][1],r=f):r=v[a].geometry,r&&(n=j.getLength(s,r))>0&&(n<l&&(l=n),n<h&&(h=n),n>o&&(o=n),n>g&&(g=n)));l!==1/0&&(++p,d+=l),o!==-1/0&&(++_,m+=o)}return{minDistance:h!==1/0?h:null,maxDistance:g!==-1/0?g:null,avgMinDistance:p?d/p:null,avgMaxDistance:_?m/_:null}},_getLineStats:function(e){var t,i,a,s=e.length,r={},n={},l=1/0,o=-1/0,u=0,c=0;for(t=0;t<s;t++)(i=e[t].geometry)&&(a=this._getLineLength(i,r,n))>0&&(++c,u+=a,a<l&&(l=a),a>o&&(o=a));return{minLength:l!==1/0?l:null,maxLength:o!==-1/0?o:null,avgLength:c?u/c:null}},_getLineLength:function(e,t,i){var a,s,r,n=e.paths,l=n.length,o=0;for(a=0;a<l;a++)s=n[a],(r=this._getActualLineLength(s,t,i))>0&&(o+=r);return o},_getApproxLineLength:function(e,t,i){var a=e[0],s=e[e.length-1],r=0;return a&&s&&a[0]===s[0]&&a[1]===s[1]&&(s=e[e.length-2]),a&&s&&a!==s&&(t.x=a[0],t.y=a[1],i.x=s[0],i.y=s[1],r=j.getLength(t,i)),r},_getActualLineLength:function(e,t,i){var a,s,r,n=e.length,l=0;for(a=0;a<n-1;a++)s=e[a],r=e[a+1],s&&r&&(t.x=s[0],t.y=s[1],i.x=r[0],i.y=r[1],l+=j.getLength(t,i));return l},_getPolygonStats:function(e){var t,i,a,s=e.length,r=1/0,n=-1/0,l=0,o=0;for(t=0;t<s;t++)e[t].geometry&&(a=e[t].geometry.getExtent())&&(i=(a.getWidth()+a.getHeight())/2)>0&&(++o,l+=i,i<r&&(r=i),i>n&&(n=i));return{minSize:r!==1/0?r:null,maxSize:n!==-1/0?n:null,avgSize:o?l/o:null}},_getAvgXY:function(e,t){var i,a,s,r,n,l,o,u,c,f,d=e.length,m=null,h=null,g=0;for(i=0;i<d;i++)if(l=e[i].geometry)if(t.point)++g,m+=l.x,h+=l.y;else if(t.mPoint)for(n=(o=l.points).length,a=0;a<n;a++)++g,m+=o[a][0],h+=o[a][1];else if(t.line)for(r=(u=l.paths).length,a=0;a<r;a++)for(n=(o=u[a]).length,s=0;s<n;s++)++g,m+=o[s][0],h+=o[s][1];else if(t.polygon)for(r=(c=l.rings).length,a=0;a<r;a++)for(n=(o=c[a]).length,s=0;s<n;s++)++g,m+=o[s][0],h+=o[s][1];return null!=m&&null!=h&&(f={x:m/g,y:h/g}),f},_getSizeRange:function(e){var t=this,i=e.params,a=this.layer,s=a.getMap();if("esriGeometryPolygon"===a.geometryType||a.hasXYFootprint())if(s)if(i&&"visible-scale-range"===i.optimizeForScale){var r=this._projectExtent(a.fullExtent,this.tileInfo.spatialReference);this.getSuggestedScaleRange({map:!1}).then((function(i){t._processSizeRange(i.spatialStatistics,s,e.dfd,r,i)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate suggested scale range.")}))}else this._getFeatures(s,i).then((function(i){t.getSpatialStatistics({features:i}).then((function(i){t._processSizeRange(i,s,e.dfd)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate spatial statistics.")}))})).otherwise((function(i){t._rejectDfd(e.dfd,i.message)}));else this._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: layer has to be added to the map.");else this._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: not supported for points and lines.")},_processSizeRange:function(e,t,i,a,s){var r=this;l(a).always((function(a){a=a&&a.hasOwnProperty("xmin")?a:null,r._calcSizeRange(e,t,i,a,s)}))},_getFeatures:function(e,t){var i,a=new s,r=this;if(t&&t.useMapExtent){var n=new g;n.geometry=e.extent,i=this.layer.queryFeatures(n)}else i={features:this.layer.graphics.slice(0)};return l(i).then((function(e){var t=e&&e.features;t&&t.length?a.resolve(t):r._rejectDfd(a,"FeatureLayerStatistics: layer has 0 features.")})).otherwise((function(e){r._rejectDfd(a,"FeatureLayerStatistics: unable to query features.")})),a.promise},_calcSizeRange:function(e,i,a,s,r){var n=e&&e.avgSize,l=i.getResolution(),o=i.getScale();if(null==n||isNaN(n))this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedSizeRange: invalid average feature size.");else if(l&&o){var u,c,f;if(r){var d=l/o,m=this._getScaleValues(s,r),h=m.feScaleIndex,g=[],p=[];f=m.scales[h],t.forEach(m.scales,(function(e,t){var i=this._calcSizeValues(n,d*e),a=h>-1&&t>h?2:1;g.push({value:e,size:i.min/a}),p.push({value:e,size:i.max/a})}),this),u={type:"sizeInfo",expression:"view.scale",valueExpression:"$view.scale",stops:g},c={type:"sizeInfo",expression:"view.scale",valueExpression:"$view.scale",stops:p}}else{var _=this._calcSizeValues(n,l);u=_.min,c=_.max}a.resolve({minSize:u,maxSize:c,spatialStatistics:e,avgFeatureSize:n,scaleAtFullExtent:f,suggestedScaleRange:r})}else this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedSizeRange: invalid map scale/resolution.")},_getScaleValues:function(e,i){var a=this.tileInfo.lods,s=this.layer.minScale||a[0].scale,r=this.layer.maxScale||a[a.length-1].scale,n=i&&i.minScale||0,l=i&&i.maxScale||0,o=e&&this._findLODForFE(this.tileInfo.lods,e,this.mapWidth,this.mapHeight),u=o&&o.scale<s&&o.scale>r?Math.round(o.scale):0,c=t.map([s,r,n,l,u],Math.round);return c.sort(this._numberSorter),c=t.filter(c,(function(e,i){return!!e&&t.indexOf(c,e)===i})),{scales:c=t.filter(c,(function(e,t,i){return!t||Math.abs(e-i[t-1])>5})),feScaleIndex:t.indexOf(c,u)}},_numberSorter:function(e,t){return e-t},_findLODForFE:function(e,t,i,a){var s,r,n,l=e.length,o=t.getWidth(),u=t.getHeight();for(s=0;s<l;s++){if(i*(r=e[s]).resolution<o||a*r.resolution<u){n=0===s?e[s]:e[s-1];break}if(s===l-1){n=e[s];break}}return n},_calcSizeValues:function(e,t){e=Math.ceil(e/t);var i=Math.ceil(e/4);i<4?i=4:i>16&&(i=16);var a=5*i;return{min:i,max:a<50?50:a}},_getOutline:function(e){var i=this;"esriGeometryPolygon"===this.layer.geometryType||this.layer.hasXYFootprint()?this._getFeatures().then((function(a){i.getSpatialStatistics({features:a}).then((function(s){var r;s.avgSize?(t.some(a,(function(e){return e.geometry&&(r=e.geometry.spatialReference),!!r})),i._calcOutline(s,r,e.params,e.dfd)):i._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedOutline: average feature size is 0 or null.")})).otherwise((function(t){i._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedOutline: unable to calculate spatial statistics.")}))})).otherwise((function(t){i._rejectDfd(e.dfd,t.message)})):this._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedOutline: not supported for points and lines.")},_calcOutline:function(e,i,a,s){var r=e.avgSize,n=!a||null==a.allowZeroWidth||a.allowZeroWidth,l=39.37*96*b.getUnitValueForSR(i),o=t.map(t.filter(this._outlineInfo,(function(e,t){return n||t>0})),(function(e){return{size:e.width,value:Math.round(r/e.size*l)}}));o.sort((function(e,t){return e.value-t.value})),s.resolve({widthInfo:{type:"sizeInfo",target:"outline",expression:"view.scale",valueExpression:"$view.scale",stops:o},opacity:.25,spatialStatistics:e})},_getHeatmapStats:function(e){var t=this,i=this.layer,a=e.params,s=e.dfd,r=a.fieldOffset,n=a.field&&this.layer.getField(a.field);a.field&&this._rejectNonNumeric(s,n,"getHeatmapStatistics")||(a.field&&null==r?i.statisticsPlugin.getFieldStatistics({field:a.field}).then((function(e){t._calcHeatmapStats(e,r,a,s)})).otherwise((function(e){t._rejectDfd(s,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate field statistics.")})):this._calcHeatmapStats(null,r,a,s))},_calcHeatmapStats:function(e,t,i,a){var s=this;if(e){var r=e.min,n=e.max;e.count?r===n&&0===r?t=1:n<=0?t="abs":r<0&&(t=-1.01*r):t=1}this._heatStatsFromMemory(i,t).then((function(i){i.fieldStatistics=e,i.fieldOffset=t,a.resolve(i)})).otherwise((function(e){s._rejectDfd(a,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.")}))},_heatStatsFromMemory:function(e,t){var i,a=new s,r=this.layer,n=r.graphics,l=n.length,o=r.getMap();if(!l)return a.resolve({count:0,min:null,max:null,avg:null,stddev:null,source:this._srcMemory}),a.promise;var u=o&&M(R(n,o,r),o.width,o.height,e.blurRadius||10,e.field,t);return(i=u&&u.matrix&&q(u.matrix))?a.resolve({count:l,min:i.min,max:i.max,avg:i.mean,stddev:i.stdDev,source:this._srcMemory}):this._rejectDfd(a,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics."),a.promise},_getHistogram:function(e){var t=this,i=e.params,a=i.minValue,s=i.maxValue,r=i.valueExpression||i.sqlExpression,n=r&&!i.sqlExpression,l=this._isCollection()||n,o=this._canUseSQL92Expression(),u=null!=a&&null!=s,c=i.field?this.layer.getField(i.field):null,f=!!c&&c.type===this._dateType,d=!i.classificationMethod||"equal-interval"===i.classificationMethod;if(c){if(this._rejectIfInvalidType(e.dfd,c,"getHistogram",[].concat(this._numericTypes).concat(this._dateType)))return;if(f){if(i.normalizationType)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when calculating histogram for date field.");if(!d)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram:  classification methods other than 'equal-interval' are not supported when calculating histogram for date field.")}}else if(r){if(i.normalizationType)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when valueExpression or sqlExpression is specified.");if(!d)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: classification methods other than 'equal-interval' are not supported when valueExpression or sqlExpression is specified.");if(n){var m=this._getExpressionInfo(i.valueExpression);if(this._rejectIfInvalidExpression(e.dfd,m,"getHistogram"))return}else if(!i.valueExpression)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: valueExpression parameter is missing.")}r&&!l?this._getBinsFromStatsQueryForExpr(e.dfd,i,a,s):o&&d&&!l?this._getBinsFromStatsQueryForField(e,f):i.normalizationType||!d?this._binParamsFromGenRend(i).then((function(r){if(u)if(a>r.max||s<r.min)t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: custom value range is beyond field value range.");else{var n=t._getFieldExpr(i,r.normTotal),l=t._getRangeExpr(n,a,s);d?t._getBins(e,r.sqlExpr,a,s,null,"parameters",null,r.excludeZerosExpr):t._binParamsFromGenRend(i,l).then((function(i){t._getBins(e,i.sqlExpr,i.min,i.max,i.intervals,i.source,i.normTotal,i.excludeZerosExpr)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate histogram parameters using custom min/max values.")}))}else t._getBins(e,r.sqlExpr,r.min,r.max,r.intervals,r.source,r.normTotal,r.excludeZerosExpr)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max from generate renderer operation.")})):u?this._getBins(e,null,a,s,null,"parameters"):this.getFieldStatistics(i).then((function(i){i.count?t._getBins(e,null,i.min,i.max,null,i.source):t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: cannot calculate histogram for 0 features (statistics.count = 0).")})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")}))},_getBins:function(e,i,a,s,r,n,l,o){var u=this,c=e.params.field,f=c?this.layer.getField(c):null,d=!!f&&f.type===this._dateType,m=e.params.numBins||this.numBins;r=r||this._getEqualIntervalBins(a,s,m),i=i||c,this._isCollection()||d||e.params.features?this._countBinsInMemory(e,a,s,r,l,n):this._queryBins(i,r,o).then((function(i){var o=t.map(i,(function(e,t){return{minValue:r[t][0],maxValue:r[t][1],count:e}}));e.dfd.resolve({bins:o,minValue:a,maxValue:s,normalizationTotal:l,source:u._srcQuery,statisticsSource:n,partialData:!1})})).otherwise((function(t){u._countBinsInMemory(e,a,s,r,l,n)}))},_getEqualIntervalBins:function(e,t,i){var a,s,r=(t-e)/i,n=e,l=[];for(a=1;a<=i;a++)s=n+r,s=Number(s.toFixed(16)),l.push([n,a===i?t:s]),n=s;return l},_countBinsInMemory:function(e,t,i,a,s,r){var n=this;this._binsFromMemory(e.params,t,i,a,s).then((function(a){var l=e.params.hasAllFeatures;e.dfd.resolve({bins:a,minValue:t,maxValue:i,normalizationTotal:s,source:e.params.features?n._srcFeatures:n._srcMemory,statisticsSource:r,partialData:null!=l?!l:!n._isCollection()})})).otherwise((function(t){n._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate histogram.")}))},_queryBins:function(e,i,a){var s,r,l=this.layer,o=[],u=i.length;for(s=0;s<u;s++)(r=new g).where=(a?a+" AND ":"")+e+" >= "+i[s][0]+(null!==i[s][1]?" AND "+e+(s===u-1?" <= ":" < ")+i[s][1]:""),o.push(r);return n(t.map(o,(function(e){return l.queryCount(e)})))},_binsFromMemory:function(e,t,i,a,r){var n,l,o,u=new s,c=L.createAttributeCache({field:e.field,valueExpression:e.valueExpression,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:r}),f=e.features||this.layer.graphics,d=[];if(!f.length)return this._rejectDfd(u,"Layer has 0 features in memory."),u.promise;for(l=a.length,n=0;n<l;n++)d.push({minValue:a[n][0],maxValue:a[n][1],count:0});for(l=f.length,n=0;n<l;n++){var m=f[n]._getDataValue(c.attributeInfo,c,h,this.layer);null!=m&&m>=t&&m<=i&&(o=this._binIndex(a,m))>-1&&d[o].count++}return u.resolve(d),u.promise},_binIndex:function(e,t){var i,a=-1;for(i=e.length-1;i>=0;i--)if(t>=e[i][0]){a=i;break}return a},_binParamsFromGenRend:function(e,t){var i=this.layer,a=new s,r=this,n=this._getGRWhereInfo(i,e),l=n.where,o=e.numBins||this.numBins,u=this._createCBDefn(e,o),c=new S;return c.classificationDefinition=u,c.where=l?l+(t?" AND "+t:""):t,!this._isCollection()&&i.version>=10.1&&!e.features?this._grTask.execute(c).then((function(t){r._resolveBinParams(t,n,r._srcGenRend,e,a)})).otherwise((function(t){r._binParamsFromMemory(o,n,e,a)})):r._binParamsFromMemory(o,n,e,a),a.promise},_binParamsFromMemory:function(e,t,i,a){var s=this;this._cbFromMemory(i,e).then((function(e){var r=i.features?s._srcFeatures:s._srcMemory;s._resolveBinParams(e,t,r,i,a)})).otherwise((function(e){s._rejectDfd(a,"FeatureLayerStatistics.getHistogram: unable to calculate class breaks.")}))},_resolveBinParams:function(e,i,a,s,r){var n,l,o=[],u=e.infos,c=u.length;n=u[0].minValue,l=u[c-1].maxValue,t.forEach(u,(function(e,t){o.push([e.minValue,e.maxValue])})),r.resolve({min:n,max:l,intervals:o,sqlExpr:this._getFieldExpr(s,e.normalizationTotal),excludeZerosExpr:i.excludeZerosExpr,normTotal:e.normalizationTotal,source:a})},_getGRWhereInfo:function(e,t){var i,a=t.field,s=t.normalizationType,r=t.normalizationField,n=e.getDefinitionExpression();return"log"===s?i="(NOT "+a+" = 0)":"field"===s&&(i="(NOT "+r+" = 0)"),{where:i?i+(n?" AND "+n:""):n,excludeZerosExpr:i}},_getFieldExpr:function(e,t){var i=e.field,a=e.normalizationType,s=e.normalizationField,r=i;return"percent-of-total"===a?r="(("+i+" / "+t+") * 100)":"log"===a?r="(log("+i+") * "+this._log10e+")":"field"===a&&(r="("+i+" / "+s+")"),r},_getRangeExpr:function(e,t,i){var a=null!=t?e+" >= "+t:"",s=null!=i?e+" <= "+i:"",r="";return(r=a&&s?a+" AND "+s:a||s)?"("+r+")":""},_getBinsFromStatsQueryForExpr:function(e,t,i,a){var s=this,r=null!=i&&null!=a,n=r?{min:i,max:a}:this.getFieldStatistics(t);l(n).then((function(i){s._getBinsFromStatsQuery(t,i.min,i.max,r?"parameters":i.source).then((function(t){e.resolve(t)})).otherwise((function(t){s._rejectDfd(e,"FeatureLayerStatistics.getHistogram: query to calculate count failed.")}))})).otherwise((function(t){s._rejectDfd(e,"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")}))},_getBinsFromStatsQueryForField:function(e,t){var i,a=this,s=e.params,r=this.layer;"percent-of-total"===s.normalizationType&&(i=this.getFieldStatistics({field:s.field}).then((function(e){return e.sum}))),l(i).then((function(i){var n={numBins:s.numBins,sqlExpression:t?a._msSinceUnixEpochSQL(s.field):a._getFieldExpr(s,i),sqlWhere:t?null:a._getGRWhereInfo(r,s).excludeZerosExpr};a._getBinsFromStatsQueryForExpr(e.dfd,n,s.minValue,s.maxValue)})).otherwise((function(t){a._rejectDfd(e.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate normalizationTotal.")}))},_getBinsFromStatsQuery:function(e,i,a,r){var n=this.layer,l=new s;if(this._canUseSQL92Expression()){var o=e.numBins||this.numBins,u=this._getEqualIntervalBins(i,a,o),c=this._calcBinsSQL(e.sqlExpression,u),f=this,d=new p;d.statisticType="count",d.outStatisticFieldName="countOFExpr",d.onStatisticField="*";var m=new g;m.outStatistics=[d],m.groupByFieldsForStatistics=[c],m.orderByFields=[c],m.where=e.sqlWhere,m.sqlFormat="standard",n.queryFeatures(m).then((function(e){var s={};t.forEach(e.features,(function(e){var t=e.attributes,i=this._getCustomExprVal(t,"countOFExpr"),a=this._getAttributeVal(t,"countOFExpr");0!==i&&(s[i]=a)}),f);var n=[];t.forEach(u,(function(e,t){var i=t+1;n.push({minValue:e[0],maxValue:e[1],count:s.hasOwnProperty(i)?s[i]:0})})),l.resolve({bins:n,minValue:i,maxValue:a,source:f._srcQuery,statisticsSource:r,partialData:!1})})).otherwise((function(e){f._rejectDfd(l,"FeatureLayerStatistics.getHistogram: Statistics query operation failed.")}))}else this._rejectDfd(l,"FeatureLayerStatistics.getHistogram: make sure the layer supports advanced SQL expressions and standardized queries.");return l.promise},_fetchMaxFeaturesForStats:function(){var e=this;if(this._maxFeaturesForStats){var t=new s;return t.resolve(this._maxFeaturesForStats),t.promise}return this.getSampleFeatures({sampleSize:-1,caching:!1,returnGeometry:!1}).then((function(t){return e._maxFeaturesForStats={features:t.features,hasAllFeatures:t.features.length===t.totalFeatures},e._maxFeaturesForStats}))},_sampleFeatures:function(e){var t=this,i=e.params,a=e.dfd,s=this.layer,r=s.graphics,n=i.caching,l=this._sampleCache,o=i.resample,u=i.sampleSize;if(n&&l&&!o)a.resolve(this._cloneSample(l));else if(a._time={start:this._getTime()},r.length&&u>0&&u<=r.length)this._resolveSample(a,this._pickItems(r,u),n,this._srcMemory);else{var c=new g;c.where="1=1",a._time.countStart=this._getTime(),s.queryCount(c).then((function(e){var l;if(a._time.countEnd=t._getTime(),a._totalFeatures=e,-1===u&&(u=e),u>s.maxRecordCount&&(u=s.maxRecordCount),e)if(e<=r.length||r.length>=s.maxRecordCount)t._resolveSample(a,t._pickItems(r,r.length),n,t._srcMemory);else if(e<=u)(l=new g).where="1=1",t._queryFeatures(l,i,s,r,a);else if(e<=t.samplingThreshold){var o=new g;o.where="1=1",a._time.idStart=t._getTime(),s.queryIds(o).then((function(e){a._time.idEnd=t._getTime();var n=new g;n.objectIds=t._pickItems(e,u),t._queryFeatures(n,i,s,r,a)})).otherwise((function(e){(l=new g).where="1=1",t._queryFeatures(l,i,s,r,a)}))}else{(l=new g).where="1=1";var c=s.advancedQueryCapabilities;c&&c.supportsPagination&&(l.num=u),t._queryFeatures(l,i,s,r,a)}else t._resolveSample(a,[],n,t._srcQuery)})).otherwise((function(e){t._resolveSample(a,t._pickItems(r,r.length),n,t._srcMemory)}))}},_queryFeatures:function(e,t,i,a,s){var r=this;e.outSpatialReference=t.spatialReference,e.maxAllowableOffset=t.maxAllowableOffset,e.outFields=t.outFields,null!=t.returnGeometry&&(e.returnGeometry=t.returnGeometry),s._time.featStart=this._getTime(),i.queryFeatures(e).then((function(e){s._time.featEnd=r._getTime();var i=e&&e.features;r._resolveSample(s,i||[],t.caching,r._srcQuery)})).otherwise((function(e){r._resolveSample(s,r._pickItems(a,a.length),t.caching,r._srcMemory)}))},_pickItems:function(e,i){var a,s=e.length,r=[],n=[];if(i>=s)n=e.slice(0);else for(;n.length<i;)a=this._getRandomInt(0,s),-1===t.indexOf(r,a)&&(r.push(a),n.push(e[a]));return n},_getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e))+e},_resolveSample:function(e,t,i,a){var s,r,n,l=(t=t||[]).length;for(s=0;s<l&&!(n=(r=t[s].geometry)&&r.spatialReference);s++);e._time.end=(new Date).getTime();var o=e._time;e._time=null;var u={features:t,spatialReference:n&&new m(n.toJson()),source:a,time:this._getTimeStats(o),totalFeatures:e._totalFeatures};i&&(this._sampleCache=this._cloneSample(u)),e.resolve(u)},_cloneSample:function(i){return{features:t.map(i.features,(function(e){return new e.constructor(e.toJson())})),spatialReference:i.spatialReference&&new m(i.spatialReference.toJson()),source:i.source,time:e.clone(i.time),totalFeatures:i.totalFeatures}},_getTimeStats:function(e){var t=this._getTimeDiff;return{total:t(e.start,e.end),features:t(e.featStart,e.featEnd),featureIds:t(e.idStart,e.idEnd),featureCount:t(e.countStart,e.countEnd)}},_getTimeDiff:function(e,t){var i,a,s;return null!=e&&null!=t&&(s="millisecond",(a=t-e)>=1e3&&(s="second",(a/=1e3)>=60&&(a/=60,s="minute")),i={value:Number(a.toFixed(2)),unit:s}),i},_getTime:function(){return(new Date).getTime()},_scaleRange:function(e){var t,i,a,s=this,r=e.params,n=this.layer,o=r&&r.sampleSize||this.sampleSize,u=r&&r.map||n.getMap(),c=r&&r.mapWidth||this.mapWidth,f=r&&r.mapHeight||this.mapHeight,d=r&&r.generalizeForScale||this.generalizeForScale;r&&!1===r.map&&(u=null),u&&u.__tileInfo?(t=u.__tileInfo,i=u.spatialReference,a=u.extent.getWidth()/u.width/u.getScale()*d):(t=this.tileInfo,i=t.spatialReference,a=this.generalizeForResolution/this.generalizeForScale*d),this.getSampleFeatures({sampleSize:o,spatialReference:i,maxAllowableOffset:a,outFields:[]}).then((function(a){var o=s._projectExtent(n.fullExtent,i),u=a.features;u&&u.length?s.getSpatialStatistics({features:u}).then((function(i){l(o).always((function(n){n=n&&n.hasOwnProperty("xmin")?n:null,s._processScaleRange(e.dfd,r,t,c,f,n,a,i)}))})).otherwise((function(t){s._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to calculate spatial statistics.")})):s._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: sampling returned 0 features.")})).otherwise((function(t){s._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to sample features.")}))},_processScaleRange:function(e,t,i,a,s,r,n,l){var o,u,c=this.layer.geometryType,f={point:"esriGeometryPoint"===c,mPoint:"esriGeometryMultipoint"===c,line:"esriGeometryPolyline"===c,polygon:"esriGeometryPolygon"===c||this.layer.hasXYFootprint()},d=t&&t.forPublishingTiles,h=i.lods,g=this._getLODForMinScale(t,l,f,i),p=d||f.polygon?this._getLODForMaxScale(t,l,f,i):null,_=1-this.mapPaddingRatioForFE,v=r&&this._findLODForFE(h,r,a*_,s*_),y=v?v.scale:null,S=this._getLODForMinScale(t,l,f,i,this.minScaleRelaxationRatio),F=S?S.scale:null,x=l.avgXY,D=x&&new z(x.x,x.y,n.spatialReference&&new m(n.spatialReference.toJson())),E=this,L=d||f.polygon?p?Math.floor(p.scale):null:0;g&&r&&D&&(u=this._findClosestLOD(h,g,r,D,a,s)),o=(g=u||g)?Math.ceil(g.scale):null,F=F&&y?Math.max(F,2*y):F||2*y,y=y&&Math.ceil(y),F=F&&Math.ceil(F),g||p?g&&D?this._countAtView(D,g,a,s).then((function(t){var i;if(!t){var a,s=n.features[0];i=f.point?s.geometry:(a=s.geometry&&s.geometry.getExtent())&&a.getCenter()}E._resolveScaleRange(e,o,L,y,F,i||D,n,l)})).otherwise((function(t){E._resolveScaleRange(e,o,L,y,F,D,n,l)})):this._resolveScaleRange(e,o,L,y,F,D,n,l):this._rejectDfd(e,"FeatureLayerStatistics.getSuggestedScaleRange: unable to find optimal scale range.")},_resolveScaleRange:function(e,t,i,a,s,r,n,l){t<i?this._rejectDfd(e,"FeatureLayerStatistics.getSuggestedScaleRange: invalid scale range - calculated minScale is less than maxScale."):(i>t/2&&(i=Math.floor(i/2)),e.resolve({minScale:t&&(t>this.worldScale?0:t),maxScale:i,scaleAtFullExtent:a,relaxedMinScale:s&&(s>this.worldScale?0:s),center:r,sampleInfo:n,spatialStatistics:l}))},_countAtView:function(e,t,i,a){var s=this._getExtentFromCenter(e,t,i,a),r=new g;return r.geometry=s,this.layer.queryCount(r).promise},_projectExtent:function(e,t){if(e.spatialReference.equals(t))return new e.constructor(e.toJson());if(V.canProject(e.spatialReference,t))return V.project(e,t);var i=new D;return i.geometries=[e],i.outSR=t,this._gsTask.project(i).then((function(e){return e&&e[0]}))},_getLODForMinScale:function(e,t,i,a,s){var r,n,l,o=e&&e.minDistance||this.minDistance,u=e&&e.minLength||this.minLength,c=e&&e.minSize||this.minSize;return i.point?(r=t.avgMinDistance,l=o):i.mPoint?(r=t.avgMinDistance,l=o):i.line?(r=t.avgLength,l=u):i.polygon&&(r=t.avgSize,l=c),r>0&&(n=this._findLOD(a,r,l*(s||1))),n},_getLODForMaxScale:function(e,t,i,a){var s,r,n,l=this.mapWidth,o=e&&e.forPublishingTiles,u=e&&e.maxDistance||l/4,c=e&&e.maxLength||l/4,f=e&&e.maxSize||l/2;return i.point?(s=o?t.avgMinDistance:t.minDistance,n=u):i.mPoint?(s=o?t.avgMinDistance:t.minDistance,n=u):i.line?(s=o?t.avgLength:t.minLength,n=c):i.polygon&&(s=o?t.avgSize:t.minSize,n=f),s>0&&(r=this._findLOD(a,s,null,n)),r},_findLOD:function(e,t,i,a){var s,r,n,l,o=e&&e.lods;if(o&&o.length){var u=null!=a,c=u?o.length-1:0,f=u?0:o.length-1,d=u?-1:1;for(n=c;u?n>=f:n<=f;n+=d)if(r=o[n],l=Math.round(t/r.resolution),u){if(l<=a){s=r;break}}else if(l>=i){s=r;break}}return s},_getExtentFromCenter:function(e,t,i,a){var s=i/2*t.resolution,r=a/2*t.resolution;return new C(e.x-s,e.y-r,e.x+s,e.y+r,new m(e.spatialReference.toJson()))},_findClosestLOD:function(e,t,i,a,s,r){var n,l,o=e.length;for(n=0;n<o;n++)if(!(e[n].level<t.level)){if(!this._getExtentFromCenter(a,e[n],s,r).contains(i)){l=e[n-1];break}if(n===o-1){l=e[n];break}}return l=l&&l.level>t.level?l:null},_findUniqueValues:function(e){var t=this,i=e.params,a=i.field,s=a?this.layer.getField(a):null,r=i.valueExpression||i.sqlExpression,n=i.valueExpression&&(!i.sqlExpression||!this._canUseSQL92Expression()),l=this._isCollection()||i.features||n;if(!a||s){if(r)if(n){var o=this._getExpressionInfo(i.valueExpression);if(this._rejectIfInvalidExpression(e.dfd,o,"getUniqueValues"))return}else if(!i.valueExpression)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getUniqueValues: valueExpression parameter is missing.");l?this._uvFromMemory(i).then((function(a){var r=i.features?t._srcFeatures:t._srcMemory;t._resolveUVDfd(a,e,s,r)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate unique values.")})):this._uvFromStatisticsQuery(i).then((function(i){t._resolveUVDfd(i,e,s,t._srcQuery)})).otherwise((function(a){t._uvFromGenRenderer(i,s).then((function(i){t._resolveUVDfd(i,e,s,t._srcGenRend)})).otherwise((function(a){t._uvFromMemory(i).then((function(i){t._resolveUVDfd(i,e,s,t._srcMemory)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate unique values.")}))}))}))}else this._rejectDfd(e.dfd,"FeatureLayerStatistics.getUniqueValues: unknown 'field'.")},_uvFromStatisticsQuery:function(i){var a=this.layer,r=new s;if(a.supportsStatistics){var n=i.field,l=i.sqlExpression,o="countOF"+(n||"Expr"),u=this,c=new p;c.statisticType="count",c.onStatisticField=l?"*":n,c.outStatisticFieldName=o;var f=new g;f.outStatistics=[c],f.groupByFieldsForStatistics=[n||l],f.sqlFormat=l?"standard":null,a.queryFeatures(f).then((function(i){var s,l,c,d,m={},h=!!i.exceededTransferLimit;t.forEach(i.features,(function(t){s=t.attributes,l=n?this._getAttributeVal(s,n):this._getCustomExprVal(s,o),c=this._getAttributeVal(s,o),null===l&&0===c&&(d=!0),(null==l||""===l||"string"==typeof l&&""===e.trim(l))&&(l=null),null==m[l]?m[l]={count:c,data:l}:m[l].count=m[l].count+c}),u),n&&d?((f=new g).where=n+" is NULL",a.queryCount(f).then((function(e){e=e||0,m.null.count=m.null.count+e,r.resolve({count:m,partialData:h})})).otherwise((function(e){r.resolve({count:m,partialData:h})}))):r.resolve({count:m,partialData:h})})).otherwise((function(e){u._rejectDfd(r,"FeatureLayerStatistics: Statistics query operation failed.")}))}else this._rejectDfd(r,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return r.promise},_uvFromGenRenderer:function(i,a){var r=this.layer,n=new s,l=this;if(r.version>=10.1){var o=new v;o.attributeField=i.field;var u=new S;u.classificationDefinition=o,u.where=r.getDefinitionExpression(),this._grTask.execute(u).then((function(i){var s,r={},o=t.indexOf(l._numericTypes,a.type)>-1;t.forEach(i.infos,(function(t){null!=(s=t.value)&&""!==s&&("string"!=typeof s||""!==e.trim(s)&&"<null>"!==s.toLowerCase())||(s=null),null==r[s]?r[s]={count:t.count,data:o&&s?Number(s):s}:r[s].count=r[s].count+t.count})),n.resolve({count:r})})).otherwise((function(e){l._rejectDfd(n,"FeatureLayerStatistics: Generate renderer operation failed.")}))}else this._rejectDfd(n,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return n.promise},_uvFromMemory:function(i){var a=this.layer,r=new s,n=L.createAttributeCache({field:i.field,valueExpression:i.valueExpression},!0),l={};return t.forEach(i.features||a.graphics,(function(t){var i=t._getDataValue(n.attributeInfo,n,h,a);(null==i||""===i||"string"==typeof i&&""===e.trim(i))&&(i=null),null==l[i]?l[i]={count:1,data:i}:l[i].count++}),this),r.resolve({count:l}),r.promise},_resolveUVDfd:function(e,i,a,s){var r,n,l=e.count,o=a&&this.layer.getDomain(a.name),u=[];for(r in i.params.includeAllCodedValues&&o&&"codedValue"===o.type&&t.forEach(o.codedValues,(function(e){var t=e.code;l.hasOwnProperty(t)||(l[t]={data:t,count:0})})),l)n=l[r],u.push({value:n.data,count:n.count});i.dfd.resolve({source:s,partialData:null!=i.params.hasAllFeatures?!i.params.hasAllFeatures:!this._isCollection()&&(s===this._srcMemory||e.partialData),uniqueValueInfos:u})},_findClassBreaks:function(e){var t=this,i=e.params,a=i.minValue,s=i.maxValue,r=null!=a||null!=s,n=i.classificationMethod,l="percent-of-total"===i.normalizationType,o=i.numClasses||this.numClasses,u=!1!==i.analyzeData,c=i.field,f=c?this.layer.getField(c):null,d=i.valueExpression,m=this._isCollection()||i.features||d;if(!f||!this._rejectNonNumeric(e.dfd,f,"getClassBreaks")){if(d){if(i.normalizationType)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: normalization is not supported when valueExpression is specified.");var h=this._getExpressionInfo(d);if(this._rejectIfInvalidExpression(e.dfd,h,"getClassBreaks"))return}else if(r)if(u){if(l&&null==i.normalizationTotal)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when minValue/maxValue are specified.")}else{if(null==a||null==s)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");if(n&&"equal-interval"!==n)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: data analysis can be disabled only for equal-interval classification.");if(l&&null==i.normalizationTotal)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when data analysis is disabled.")}else if(!u)return void this._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");u?m?this._cbFromMemory(i,o).then((function(a){var s=i.features?t._srcFeatures:t._srcMemory;t._resolveCBDfd(e.dfd,i,a,s)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})):this._cbFromGenRend(i,o).then((function(a){t._resolveCBDfd(e.dfd,i,a,t._srcGenRend)})).otherwise((function(a){r?t._rejectDfd(e.dfd,"FeatureLayerStatistics.getClassBreaks: cannot calculate class breaks in-memory when minValue/maxValue are specified."):t._cbFromMemory(i,o).then((function(a){t._resolveCBDfd(e.dfd,i,a,t._srcMemory)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")}))})):this._cbFromInterpolation(i,o).then((function(a){t._resolveCBDfd(e.dfd,i,a,t._srcMemory)})).otherwise((function(i){t._rejectDfd(e.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")}))}},_cbFromGenRend:function(e,t){var i=this.layer,a=new s,r=this;if(i.url&&i.version>=10.1){var n=this._createCBDefn(e,t),l=this._getGRWhereInfo(i,e).where,o=this._getFieldExpr(e,e.normalizationTotal),u=this._getRangeExpr(o,e.minValue,e.maxValue),c=new S;c.classificationDefinition=n,c.where=l?l+(u?" AND "+u:""):u,this._grTask.execute(c).then((function(e){a.resolve(e)})).otherwise((function(e){r._rejectDfd(a,"FeatureLayerStatistics: Generate renderer operation failed.")}))}else this._rejectDfd(a,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return a.promise},_cbFromMemory:function(t,i){var a=new s,r=t.features||this.layer.graphics;if(r.length){var n,l=this._createCBDefn(t,i);if("percent-of-total"===t.normalizationType){if(null==(n=this._calcStatsFromMemory({field:t.field}).sum))return this._rejectDfd(a,"FeatureLayerStatistics: Invalid normalizationTotal."),a.promise;t=e.mixin({normalizationTotal:n},t)}a.resolve(F.createClassBreaksRenderer({features:r,definition:l,values:this._getDataValues(r,t)}))}else this._rejectDfd(a,"Layer has 0 features in memory.");return a.promise},_cbFromInterpolation:function(e,t){var i=new s,a=e.minValue,r=e.maxValue;if(a>=r||!t||t<1)this._rejectDfd(i,"FeatureLayerStatistics.getClassBreaks: invalid input parameters: minValue, maxValue or numClasses.");else{var n,l,o=[],u=(r-a)/t;for(n=0;n<t;n++)l=a+n*u,o.push({minValue:l,maxValue:l+u});o[t-1].maxValue=r,i.resolve({infos:o,normalizationTotal:e.normalizationTotal})}return i.promise},_createCBDefn:function(e,t){var i=e.field,a=e.classificationMethod||this.classificationMethod,s=e.normalizationType,r=e.normalizationField,n=new y;return n.classificationField=i,n.breakCount=t,n.classificationMethod=a,n.standardDeviationInterval="standard-deviation"===a?e.standardDeviationInterval||this.standardDeviationInterval:void 0,n.normalizationType=s,n.normalizationField="field"===s?r:void 0,n},_resolveCBDfd:function(i,a,s,r){var n,l,o,u,c=s.infos,f=c.length,d=c[0].minValue,m=c[f-1].maxValue,h="standard-deviation"===a.classificationMethod,g=this._reNumber;c=t.map(c,(function(i){return o=i.label,l={minValue:i.minValue,maxValue:i.maxValue,label:o},h&&o&&(n=o.match(g),2===(n=t.map(n,(function(t){return+e.trim(t)}))).length?(l.minStdDev=n[0],l.maxStdDev=n[1],n[0]<0&&n[1]>0&&(l.hasAvg=!0)):1===n.length&&(o.indexOf("<")>-1?(l.minStdDev=null,l.maxStdDev=n[0]):o.indexOf(">")>-1&&(l.minStdDev=n[0],l.maxStdDev=null))),l})),u=!1!==a.analyzeData&&(null!=a.hasAllFeatures?!a.hasAllFeatures:!this._isCollection()&&r===this._srcMemory),i.resolve({minValue:d,maxValue:m,classBreakInfos:c,normalizationTotal:s.normalizationTotal,source:r,partialData:u})},_reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,_noDominantCategoryField:"no_dominant_category",_predominantCategories:function(e){var t=e.dfd,i=e.params.fields,a=this;if(this._canUseExpression()){var s=this._predominantCategoryArcade(i),r=this._predominantCategoryNameSQL(i);(this._isCollection()?this._uvFromMemory({valueExpression:s}):this._uvFromStatisticsQuery({sqlExpression:r.expression,valueExpression:s})).then((function(e){var s=a._isCollection()?a._srcMemory:a._srcQuery;a._resolvePredominantCategories(t,i,e,s)})).otherwise((function(e){a._rejectDfd(t,"FeatureLayerStatistics.getPredominantCategories: error when counting features in each predominant category.")}))}else this._rejectDfd(t,"FeatureLayerStatistics.getPredominantCategories: make sure the layer supports advanced SQL expressions and standardized queries.")},_resolvePredominantCategories:function(e,i,a,s){var r,n,l=[],o=a.count;for(r in o)n=o[r],l.push({value:n.data,count:n.count});var u=t.map(l,(function(e){return e.value})),c=t.filter(i,(function(e){return-1===t.indexOf(u,e)}));t.forEach(c,(function(e){l.push({value:e,count:0})})),l.sort(this._predominantFieldSorter(i)),t.forEach(l,(function(e){e.value===this._noDominantCategoryField&&(e.value=null)}),this),e.resolve({predominantCategoryInfos:l,source:s})},_predominantCategoryNameSQL:function(e){return{expression:this._calcMaxFieldSQL(e,{returnFieldName:!0,defaultValue:"'"+this._noDominantCategoryField+"'"})}},_calcMaxFieldSQL:function(e,i){var a,s,r,n,l=[];if(i&&(a=i.resultValue,s=i.returnFieldName,r=i.defaultValue,n=i.integerFields),s&&r){var o=t.map(e,(function(e){return e+" <= 0"}));l.push("WHEN "+o.join(" AND ")+" THEN "+r)}return t.forEach(e,(function(i){var r=[];t.forEach(e,(function(e){i!==e&&r.push(i+" > "+e)})),l.push("WHEN "+r.join(" AND ")+" THEN "+(a||s&&"'"+i+"'"||(t.indexOf(n,i)>-1?"cast("+i+" as float)":i)))})),["CASE",l.join(" "),"ELSE "+(r||"0"),"END"].join(" ")},_predominantFieldSorter:function(e){return function(i,a){return t.indexOf(e,i.value)-t.indexOf(e,a.value)}},_predominanceExpressions:function(e){var i=e.params.fields,a=t.map(t.filter(this.layer.fields,(function(e){return t.indexOf(this._integerTypes,e.type)>-1}),this),(function(e){return e.name})),s=this._sumOfFieldsSQL(i),r=this._strengthOfPredominanceSQL(i,a);e.dfd.resolve({predominantCategory:{valueExpression:this._predominantCategoryArcade(i)},size:{valueExpression:this._sumOfFieldsArcade(i),statisticsQuery:s,histogramQuery:s},opacity:{valueExpression:this._strengthOfPredominanceArcade(i),statisticsQuery:r,histogramQuery:r}})},_calcMaxFieldInfo:function(e,i){var a=["var fieldNames = [ "+(e=t.map(e,(function(e){return'"'+e+'"'}))).join(", ")+" ];","var numFields = "+e.length+";","var maxValueField = null;","var maxValue = -Infinity;","var value, i, totalValue = null;","for(i = 0; i < numFields; i++) {","value = $feature[fieldNames[i]];","if(value > 0) {","if(value > maxValue) {","maxValue = value;","maxValueField = fieldNames[i];","}","else if (value == maxValue) {","maxValueField = null;","}","}"];return i&&a.push("if(value != null && value >= 0) {","if (totalValue == null) { totalValue = 0; }","totalValue = totalValue + value;","}"),a.push("}"),a},_declareFieldNames:function(e){var i=[];return(i=t.map(e,(function(e){return'$feature["'+e+'"];'}))).length?i.join("\n")+"\n":""},_predominantCategoryArcade:function(e){var t=this._calcMaxFieldInfo(e);return t.push("return maxValueField;"),this._declareFieldNames(e)+t.join("\n")},_sumOfFieldsArcade:function(e){return this._declareFieldNames(e)+["var fieldNames = [ "+(e=t.map(e,(function(e){return'"'+e+'"'}))).join(", ")+" ];","var numFields = "+e.length+";","var value, i, totalValue = null;","for(i = 0; i < numFields; i++) {","value = $feature[fieldNames[i]];","if(value != null && value >= 0) {","if (totalValue == null) { totalValue = 0; }","totalValue = totalValue + value;","}","}","return totalValue;"].join("\n")},_strengthOfPredominanceArcade:function(e){var t=this._calcMaxFieldInfo(e,!0);return t.push("var strength = null;","if (maxValueField != null && totalValue > 0) {","strength = (maxValue / totalValue) * 100;","}","return strength;"),this._declareFieldNames(e)+t.join("\n")},_calcSumOfFieldsSQL:function(e){return e.join(" + ")},_ensurePositiveFields:function(e){return"("+t.map(e,(function(e){return e+" >= 0"})).join(" OR ")+")"},_sumOfFieldsSQL:function(e){return{sqlExpression:"("+this._calcSumOfFieldsSQL(e)+")",sqlWhere:this._ensurePositiveFields(e)}},_strengthOfPredominanceSQL:function(e,t){return{sqlExpression:"((("+this._calcMaxFieldSQL(e,{integerFields:t})+") / ("+this._calcSumOfFieldsSQL(e)+")) * 100)",sqlWhere:this._ensurePositiveFields(e)+" AND (("+this._calcSumOfFieldsSQL(e)+") > 0)"}},_calcBinsSQL:function(e,i){var a=[],s=i.length;return t.forEach(i,(function(t,i){var r=t[0],n=t[1],l=[e+" >= "+r,e+(i===s-1?" <= ":" < ")+n];a.push("WHEN ("+l.join(" AND ")+") THEN "+(i+1))})),["CASE",a.join(" "),"ELSE 0","END"].join(" ")},_ageStatistics:function(t){var i=t.params.units,a=this;this.getAgeExpressions({startTime:t.params.startTime,endTime:t.params.endTime,units:i}).then((function(s){var r={valueExpression:s.valueExpression};e.mixin(r,s.statisticsQuery),a.getFieldStatistics(r).then((function(e){t.dfd.resolve({units:i,statistics:e})})).otherwise((function(e){a._rejectDfd(t.dfd,"FeatureLayerStatistics.getAgeStatistics: unable to calculate statistics.")}))})).otherwise((function(e){a._rejectDfd(t.dfd,"FeatureLayerStatistics.getAgeStatistics: unable to generate expressions to calculate age.")}))},_supportedAgeUnits:["years","months","days","hours","minutes","seconds"],_unitValueInDays:{years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/864e5},_suggestedAgeUnits:function(e){var t=e.params.startTime,i=e.params.endTime,a=this;this._rejectIfInvalidDates(e.dfd,t,i,"getSuggestedAgeUnits")||this.getAgeStatistics({startTime:t,endTime:i,units:"days"}).then((function(t){var i=t.statistics;null!=i.avg?e.dfd.resolve({units:a._calcSuggestedAgeUnits(i),statistics:i}):a._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedAgeUnits: 'avg' statistic is not available.")})).otherwise((function(t){a._rejectDfd(e.dfd,"FeatureLayerStatistics.getSuggestedAgeUnits: unable to calculate statistics.")}))},_calcSuggestedAgeUnits:function(e){var i,a=this._unitValueInDays,s=Math.abs(e.avg);return t.some(this._supportedAgeUnits,(function(e){var t=a[e];return s>2*t&&(i=e),!!i})),i},_ageExpressions:function(e){var i=e.params.startTime,a=e.params.endTime,s=e.params.units||"days";if(!this._rejectIfInvalidDates(e.dfd,i,a,"getAgeExpressions"))if(-1!==t.indexOf(this._supportedAgeUnits,s)){var r=this._getDateDiffSQL(i,a,s);e.dfd.resolve({valueExpression:this._getDateDiffArcade(i,a,s),statisticsQuery:r,histogramQuery:r})}else this._rejectDfd(e.dfd,"FeatureLayerStatistics.getAgeExpressions: invalid 'units'. Supported units are: years, months, days, hours, minutes, seconds.")},_getDateDiffArcade:function(e,t,i){var a=this._getDateType(e),s=this._getDateType(t),r=[this._readDateValueArcade(e,a,"startTime"),this._readDateValueArcade(t,s,"endTime"),"var retVal = null;","if (startTime != null && endTime != null) {","startTime = Date(startTime);","endTime = Date(endTime);","retVal = DateDiff(endTime, startTime, '"+i+"');","}","return retVal;"],n=[];return"field"===a&&n.push(e),"field"===s&&n.push(t),this._declareFieldNames(n)+r.join("\n")},_readDateValueArcade:function(e,t,i){return"var "+i+" = "+("number"===t?e:"date"===t?e.getTime():'$feature["'+e+'"]')+";"},_getDateDiffSQL:function(e,t,i){var a="("+this._getDateValueSQL(t,this._getDateType(t))+" - "+this._getDateValueSQL(e,this._getDateType(e))+")",s=this._unitValueInDays[i],r="/";return s<1&&(s=1/s,r="*"),{sqlExpression:1===s?a:"("+a+" "+r+" "+s+")",sqlWhere:null}},_getDateValueSQL:function(e,t){var i;return"date"===t||"number"===t?("number"===t&&(e=new Date(e)),i="TIMESTAMP'"+e.getUTCFullYear()+"-"+this._padZeros(e.getUTCMonth()+1)+"-"+this._padZeros(e.getUTCDate())+" "+this._padZeros(e.getUTCHours())+":"+this._padZeros(e.getUTCMinutes())+":"+this._padZeros(e.getUTCSeconds())+"'"):i=e,i},_padZeros:function(e){return o.pad(e,2,"0")},_getDateType:function(e){var t;if(e instanceof Date)t="date";else if("number"==typeof e)t="number";else if("string"==typeof e){var i=this.layer.getField(e);"<now>"===e.toLowerCase()?t="":i&&i.type===this._dateType&&(t="field")}return t},_rejectIfInvalidDates:function(e,i,a,s){var r=[],n=!1,l="FeatureLayerStatistics."+s+": invalid combination of 'startTime' and 'endTime' parameters.",o=["date","number"];return t.every([i,a],(function(e){var t=this._getDateType(e);return t&&r.push(t),!!t}),this)?r[0]===r[1]?"field"===r[0]?i===a&&(this._rejectDfd(e,"FeatureLayerStatistics."+s+": 'startTime' and 'endTime' parameters cannot be identical."),n=!0):(this._rejectDfd(e,l),n=!0):t.indexOf(o,r[0])>-1&&t.indexOf(o,r[1])>-1&&(this._rejectDfd(e,l),n=!0):(this._rejectDfd(e,"FeatureLayerStatistics."+s+": 'startTime' and 'endTime' parameters must be one of these values: a date object, unix epoch time, name of a valid date field or &lt;now&gt;."),n=!0),n},_fetchFeatures:function(t,i){var a=t.params,s=a.valueExpression&&(!a.sqlExpression||!this._canUseSQL92Expression()),r=this,n=a.features||this._isCollection()||!s?null:this._fetchMaxFeaturesForStats();l(n).always((function(s){var n,l;s&&(n=s.features,l=s.hasAllFeatures),n&&(t.params=e.mixin({},a),t.params.features=n,t.params.hasAllFeatures=l),i.call(r,t)}))},_rejectDfd:function(e,t){e.reject(new Error(t))},_rejectNonNumeric:function(e,i,a){var s;return i?i.name!==this.layer.objectIdField&&-1!==t.indexOf(this._numericTypes,i.type)||(this._rejectDfd(e,"FeatureLayerStatistics."+a+": 'field' should be numeric."),s=!0):(this._rejectDfd(e,"FeatureLayerStatistics."+a+": unknown 'field'."),s=!0),s},_rejectIfInvalidType:function(e,i,a,s){var r;return i?i.name!==this.layer.objectIdField&&-1!==t.indexOf(s,i.type)||(this._rejectDfd(e,"FeatureLayerStatistics."+a+": 'field' should be one of these types: "+s.join(",")),r=!0):(this._rejectDfd(e,"FeatureLayerStatistics."+a+": unknown 'field'."),r=!0),r},_canUseExpression:function(){return this._isCollection()||this._canUseSQL92Expression()},_canUseSQL92Expression:function(){return this._reHostedFS.test(this.layer.url)},_getExpressionInfo:function(e){var i=this.layer,a=t.map(i.fields,(function(e){return e.name})),s=h.extractFieldNames(e,a),r=[];return t.forEach(s,(function(e,t){var a=i.getField(e);a?s[t]=a.name:r.push(e)})),{fields:s,unknownFields:r}},_rejectIfInvalidExpression:function(e,t,i){var a,s=t.unknownFields;return s&&s.length&&(this._rejectDfd(e,"FeatureLayerStatistics."+i+": valueExpression has unknown field names: "+s.join(", ")),a=!0),a},_getAttributeVal:function(e,t){var i,a;if(t=t.toLowerCase(),e)for(a in e)if(a.toLowerCase()===t){i=e[a];break}return i},_getCustomExprVal:function(e,t){var i,a;if(t=t.toLowerCase(),e)for(a in e)if(a.toLowerCase()!==t){i=e[a];break}return i},_callAfterLoad:function(t,i,a){this._loaded?t.call(this,i,a):r.once(this,"_load",e.hitch(this,t,i,a))},_numericTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_integerTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger"],_dateType:"esriFieldTypeDate",_createGRTask:function(){this._grTask=new _(this.layer,{source:this.layer.source,gdbVersion:this.layer.gdbVersion}),this._loaded=!0,this.emit("_load")}});return e.mixin(k,{add:function(e,t){if(!e.statisticsPlugin){var i=t||{};i.layer=e,e.statisticsPlugin=new k(i)}},remove:function(e){e.statisticsPlugin&&(e.statisticsPlugin.destroy(),delete e.statisticsPlugin)}}),a("extend-esri")&&e.setObject("plugins.FeatureLayerStatistics",k,u),k}));