/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../geometry","../../request","../../core/Error","../../core/Logger","../../core/maybe","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../support/FieldsIndex","../support/fieldType","../../rest/support/FeatureSet","../../geometry/SpatialReference"],(function(e,t,n,i,r,o,a,s,l,c,u,p,d,f,m,y,g){"use strict";const h=o.getLogger("esri.layers.graphics.sources.ogcfeature");function w(e,t){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t,n={},o=5){const{links:s}=e,l=Z(s,"items","application/geo+json")||Z(s,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a.isNone(l))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=yield i(l.href,{signal:n.signal,query:{limit:o,...n.customParameters,token:n.apiKey},headers:{accept:"application/geo+json"}});yield p.validateGeoJSON(c);const u=p.inferLayerProperties(c,{geometryType:t.geometryType}),y=t.fields||u.fields||[],g=null!=t.hasZ?t.hasZ:u.hasZ,w=u.geometryType,b=t.objectIdField||u.objectIdFieldName||"OBJECTID";let F=t.timeInfo;const T=y.find((e=>e.name===b));if(!T){if(!u.objectIdFieldType)throw new r("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");y.unshift({name:b,alias:b,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else T.type="esriFieldTypeOID",T.editable=!1,T.nullable=!1;if(b!==u.objectIdFieldName){const e=y.find((e=>e.name===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!w)throw new r("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");y===u.fields&&u.unknownFields.length>0&&h.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const i of y){if(null==i.name&&(i.name=i.alias),null==i.alias&&(i.alias=i.name),"esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&(i.editable=null==i.editable||!!i.editable,i.nullable=null==i.nullable||!!i.nullable),!i.name)throw new r("ogc-feature-layer:invalid-field-name","field name is missing",{field:i});if(-1===m.kebabDict.jsonValues.indexOf(i.type))throw new r("ogc-feature-layer:invalid-field-type",`invalid type for field "${i.name}"`,{field:i})}if(F){const e=new f(y);if(F.startTimeField){const t=e.get(F.startTimeField);t?(F.startTimeField=t.name,t.type="esriFieldTypeDate"):F.startTimeField=null}if(F.endTimeField){const t=e.get(F.endTimeField);t?(F.endTimeField=t.name,t.type="esriFieldTypeDate"):F.endTimeField=null}if(F.trackIdField){const t=e.get(F.trackIdField);t?F.trackIdField=t.name:(F.trackIdField=null,h.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:F}}))}F.startTimeField||F.endTimeField||(h.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:F}}),F=null)}return{drawingInfo:d.createDrawingInfo(w),geometryType:w,fields:y,hasZ:!!g,objectIdField:b,timeInfo:F}}))).apply(this,arguments)}function F(e){return T.apply(this,arguments)}function T(){return(T=t._asyncToGenerator((function*(e,t={}){const{links:n}=e,o=Z(n,"data","application/json")||Z(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(a.isNone(o))throw new r("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:s,customParameters:l,signal:c}=t,{data:u}=yield i(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s}});return u}))).apply(this,arguments)}function I(e){return j.apply(this,arguments)}function j(){return(j=t._asyncToGenerator((function*(e,t={}){const{links:n}=e,o=Z(n,"conformance","application/json")||Z(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(a.isNone(o))throw new r("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:s,customParameters:l,signal:c}=t,{data:u}=yield i(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s}});return u}))).apply(this,arguments)}function S(e){return k.apply(this,arguments)}function k(){return(k=t._asyncToGenerator((function*(e,t={}){const{apiKey:n,customParameters:r,signal:o}=t,{data:a}=yield i(e,{signal:o,headers:{accept:"application/json"},query:{...r,token:n}});return a}))).apply(this,arguments)}function v(e){return N.apply(this,arguments)}function N(){return(N=t._asyncToGenerator((function*(e,t={}){const n="application/vnd.oai.openapi+json;version=3.0",r=Z(e.links,"service-desc",n);if(a.isNone(r))return h.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:s,signal:l}=t,{data:c}=yield i(r.href,{signal:l,headers:{accept:n},query:{...s,token:o}});return c}))).apply(this,arguments)}function G(e){const n=t._wrapRegExp(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(e),i=null==n?void 0:n.groups;if(!i)return null;const{authority:r,code:o}=i;switch(r.toLowerCase()){case"ogc":switch(o.toLowerCase()){case"crs27":return g.GCS_NAD_1927;case"crs83":return new g({wkid:4269});case"crs84":case"crs84h":return g.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(o,10);return Number.isNaN(e)?null:900913===e?g.WebMercator:new g({wkid:e})}default:return null}}function O(e,t,n){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e,t,n){const i=yield q(e,t,n);return y.fromJSON(i)}))).apply(this,arguments)}function q(e,t,n){return M.apply(this,arguments)}function M(){return(M=t._asyncToGenerator((function*(e,t,n){const i=yield _(e,t,n);return c.convertToFeatureSet(i)}))).apply(this,arguments)}function _(e,t,n){return D.apply(this,arguments)}function D(){return(D=t._asyncToGenerator((function*(e,t,n){const{capabilities:{query:{maxRecordCount:o}},collection:d,layerDefinition:f,queryParameters:{apiKey:m,customParameters:y},spatialReference:h,supportedCrs:w}=e,{links:b}=d,F=Z(b,"items","application/geo+json")||Z(b,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a.isNone(F))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:T,num:I,start:j,timeExtent:S,where:k}=t;if(t.objectIds)throw new r("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const v=g.fromJSON(h),N=a.unwrapOr(t.outSpatialReference,v),G=N.isWGS84?null:C(N,w),O=L(T,w),x=W(S),q=$(k),M=null!=I?I:null!=j&&void 0!==j?10:o,{data:_}=yield i(F.href,{...n,query:{...y,...O,crs:G,datetime:x,query:q,limit:M,startindex:j,token:m},headers:{accept:"application/geo+json"}});let D=!1;if(_.links){D=!!_.links.find((e=>"next"===e.rel))}!D&&Number.isInteger(_.numberMatched)&&Number.isInteger(_.numberReturned)&&(D=_.numberReturned<_.numberMatched);const{fields:P,globalIdField:R,hasM:J,hasZ:K,objectIdField:A}=f,E=f.geometryType,z=p.createOptimizedFeatures(_,{geometryType:E,hasZ:K,objectIdField:A});if(!G&&N.isWebMercator)for(const i of z)if(i.geometry){const e=c.convertToGeometry(i.geometry,E,K,!1);e.spatialReference=g.WGS84,i.geometry=c.convertFromGeometry(l.project(e,N))}for(const i of z)i.objectId=i.attributes[A];const U=G||!G&&N.isWebMercator?N.toJSON():s.WGS84,B=new u;return B.exceededTransferLimit=D,B.features=z,B.fields=P,B.geometryType=E,B.globalIdFieldName=R,B.hasM=J,B.hasZ=K,B.objectIdFieldName=A,B.spatialReference=U,B}))).apply(this,arguments)}function P(e){return a.isSome(e)&&"extent"===e.type}function C(e,t){return t.find((t=>{const n=G(t);return s.equals(n,e)}))}function R(e){const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function W(e){if(a.isNone(e))return null;const{start:t,end:n}=e;return`${a.isSome(t)?t.toISOString():".."}/${a.isSome(n)?n.toISOString():".."}`}function $(e){return a.isNone(e)||!e||"1=1"===e?null:e}function L(e,t){if(!P(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:R(e)};const i=C(n,t);return i?{bbox:R(e),"bbox-crs":i}:n.isWebMercator?{bbox:R(l.project(e,g.WGS84))}:null}function Z(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}e.getCollectionDefinition=w,e.getServerCollections=F,e.getServerConformance=I,e.getServerLandingPage=S,e.getServerOpenApi=v,e.getSpatialReference=G,e.queryFeatureSet=O,e.queryFeatureSetJSON=q,e.queryOptimizedFeatureSet=_,Object.defineProperty(e,"__esModule",{value:!0})}));
