/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../geometry","../../request","../../core/Error","../../core/Logger","../../core/maybe","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../support/FieldsIndex","../support/fieldType","../../geometry/SpatialReference"],(function(e,t,n,i,r,o,a,s,l,c,u,d,p,f,m,y){"use strict";const g=o.getLogger("esri.layers.graphics.sources.ogcfeature"),h="http://www.opengis.net/def/crs/",w=`${h}OGC/1.3/CRS84`;function b(e,t){return F.apply(this,arguments)}function F(){return(F=t._asyncToGenerator((function*(e,t,n={},o=5){const{links:s}=e,l=L(s,"items","application/geo+json")||L(s,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a.isNone(l))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=yield i(l.href,{signal:n.signal,query:{limit:o,...n.customParameters,token:n.apiKey},headers:{accept:"application/geo+json"}});yield d.validateGeoJSON(c);const u=d.inferLayerProperties(c,{geometryType:t.geometryType}),y=t.fields||u.fields||[],h=null!=t.hasZ?t.hasZ:u.hasZ,w=u.geometryType,b=t.objectIdField||u.objectIdFieldName||"OBJECTID";let F=t.timeInfo;const I=y.find((e=>e.name===b));if(!I){if(!u.objectIdFieldType)throw new r("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");y.unshift({name:b,alias:b,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else I.type="esriFieldTypeOID",I.editable=!1,I.nullable=!1;if(b!==u.objectIdFieldName){const e=y.find((e=>e.name===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}y===u.fields&&u.unknownFields.length>0&&g.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const i of y){if(null==i.name&&(i.name=i.alias),null==i.alias&&(i.alias=i.name),"esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&(i.editable=null==i.editable||!!i.editable,i.nullable=null==i.nullable||!!i.nullable),!i.name)throw new r("ogc-feature-layer:invalid-field-name","field name is missing",{field:i});if(-1===m.kebabDict.jsonValues.indexOf(i.type))throw new r("ogc-feature-layer:invalid-field-type",`invalid type for field "${i.name}"`,{field:i})}if(F){const e=new f(y);if(F.startTimeField){const t=e.get(F.startTimeField);t?(F.startTimeField=t.name,t.type="esriFieldTypeDate"):F.startTimeField=null}if(F.endTimeField){const t=e.get(F.endTimeField);t?(F.endTimeField=t.name,t.type="esriFieldTypeDate"):F.endTimeField=null}if(F.trackIdField){const t=e.get(F.trackIdField);t?F.trackIdField=t.name:(F.trackIdField=null,g.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:F}}))}F.startTimeField||F.endTimeField||(g.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:F}}),F=null)}return{drawingInfo:w?p.createDrawingInfo(w):null,geometryType:w,fields:y,hasZ:!!h,objectIdField:b,timeInfo:F}}))).apply(this,arguments)}function I(e){return T.apply(this,arguments)}function T(){return(T=t._asyncToGenerator((function*(e,t={}){const{links:n}=e,o=L(n,"data","application/json")||L(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(a.isNone(o))throw new r("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:s,customParameters:l,signal:c}=t,{data:u}=yield i(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s}});return u}))).apply(this,arguments)}function S(e){return j.apply(this,arguments)}function j(){return(j=t._asyncToGenerator((function*(e,t={}){const{links:n}=e,o=L(n,"conformance","application/json")||L(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(a.isNone(o))throw new r("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:s,customParameters:l,signal:c}=t,{data:u}=yield i(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s}});return u}))).apply(this,arguments)}function k(e){return v.apply(this,arguments)}function v(){return(v=t._asyncToGenerator((function*(e,t={}){const{apiKey:n,customParameters:r,signal:o}=t,{data:a}=yield i(e,{signal:o,headers:{accept:"application/json"},query:{...r,token:n}});return a}))).apply(this,arguments)}function N(e){return G.apply(this,arguments)}function G(){return(G=t._asyncToGenerator((function*(e,t={}){const n="application/vnd.oai.openapi+json;version=3.0",r=L(e.links,"service-desc",n);if(a.isNone(r))return g.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:s,signal:l}=t,{data:c}=yield i(r.href,{signal:l,headers:{accept:n},query:{...s,token:o}});return c}))).apply(this,arguments)}function O(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=null==t?void 0:t.groups;if(!n)return null;const{authority:i,code:r}=n;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return y.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return y.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}}function x(e,t,n){return q.apply(this,arguments)}function q(){return(q=t._asyncToGenerator((function*(e,t,n){const i=yield M(e,t,n);return c.convertToFeatureSet(i)}))).apply(this,arguments)}function M(e,t,n){return C.apply(this,arguments)}function C(){return C=t._asyncToGenerator((function*(e,t,n){const{capabilities:{query:{maxRecordCount:o}},collection:p,layerDefinition:f,queryParameters:{apiKey:m,customParameters:g},spatialReference:h,supportedCrs:w}=e,{links:b}=p,F=L(b,"items","application/geo+json")||L(b,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a.isNone(F))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:I,num:T,start:S,timeExtent:j,where:k}=t;if(t.objectIds)throw new r("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const v=y.fromJSON(h),N=a.unwrapOr(t.outSpatialReference,v),G=N.isWGS84?null:P(N,w),O=$(I,w),x=_(j),q=W(k),M=null!=T?T:null!=S&&void 0!==S?10:o,{data:C}=yield i(F.href,{...n,query:{...g,...O,crs:G,datetime:x,query:q,limit:M,startindex:S,token:m},headers:{accept:"application/geo+json"}});let D=!1;if(C.links){const e=C.links.find((e=>"next"===e.rel));D=!!e}!D&&Number.isInteger(C.numberMatched)&&Number.isInteger(C.numberReturned)&&(D=C.numberReturned<C.numberMatched);const{fields:R,globalIdField:Z,hasM:K,hasZ:J,objectIdField:A}=f,z=f.geometryType,E=d.createOptimizedFeatures(C,{geometryType:z,hasZ:J,objectIdField:A});if(!G&&N.isWebMercator)for(const i of E)if(a.isSome(i.geometry)){const e=c.convertToGeometry(i.geometry,z,J,!1);e.spatialReference=y.WGS84,i.geometry=c.convertFromGeometry(l.project(e,N))}for(const i of E)i.objectId=i.attributes[A];const U=G||!G&&N.isWebMercator?N.toJSON():s.WGS84,B=new u;return B.exceededTransferLimit=D,B.features=E,B.fields=R,B.geometryType=z,B.globalIdFieldName=Z,B.hasM=K,B.hasZ=J,B.objectIdFieldName=A,B.spatialReference=U,B})),C.apply(this,arguments)}function D(e){return a.isSome(e)&&"extent"===e.type}function P(e,t){var n,i,r;const{isWebMercator:o,wkid:a}=e;if(!a)return null;const s=o?null!=(n=null!=(i=null!=(r=t[3857])?r:t[102100])?i:t[102113])?n:t[900913]:t[e.wkid];return s?`${h}${s}`:null}function R(e){if(a.isNone(e))return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function _(e){if(a.isNone(e))return null;const{start:t,end:n}=e;return`${a.isSome(t)?t.toISOString():".."}/${a.isSome(n)?n.toISOString():".."}`}function W(e){return a.isNone(e)||!e||"1=1"===e?null:e}function $(e,t){if(!D(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:R(e)};const i=P(n,t);return a.isSome(i)?{bbox:R(e),"bbox-crs":i}:n.isWebMercator?{bbox:R(l.project(e,y.WGS84))}:null}function L(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}e.crsDefault=w,e.crsPrefix=h,e.getCollectionDefinition=b,e.getServerCollections=I,e.getServerConformance=S,e.getServerLandingPage=k,e.getServerOpenApi=N,e.getSpatialReferenceWkid=O,e.queryFeatureSetJSON=x,e.queryOptimizedFeatureSet=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
