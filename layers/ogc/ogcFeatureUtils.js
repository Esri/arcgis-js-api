/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../geometry","../../request","../../core/Error","../../core/Logger","../../core/maybe","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../support/FieldsIndex","../support/fieldType","../../rest/support/FeatureSet","../../geometry/SpatialReference"],(function(e,t,n,i,r,a,o,s,l,c,u,d,p,f,m,y,g){"use strict";const h=a.getLogger("esri.layers.graphics.sources.ogcfeature");function b(e,t){return w.apply(this,arguments)}function w(){return(w=t._asyncToGenerator((function*(e,t,n={},a=5){const{links:s}=e,l=Z(s,"items","application/geo+json")||Z(s,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(o.isNone(l))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=yield i(l.href,{signal:n.signal,query:{limit:a,...n.customParameters,token:n.apiKey},headers:{accept:"application/geo+json"}});yield d.validateGeoJSON(c);const u=d.inferLayerProperties(c,{geometryType:t.geometryType}),y=t.fields||u.fields||[],g=null!=t.hasZ?t.hasZ:u.hasZ,b=u.geometryType,w=t.objectIdField||u.objectIdFieldName||"OBJECTID";let F=t.timeInfo;const I=y.find((e=>e.name===w));if(!I){if(!u.objectIdFieldType)throw new r("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");y.unshift({name:w,alias:w,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else I.type="esriFieldTypeOID",I.editable=!1,I.nullable=!1;if(w!==u.objectIdFieldName){const e=y.find((e=>e.name===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}y===u.fields&&u.unknownFields.length>0&&h.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const i of y){if(null==i.name&&(i.name=i.alias),null==i.alias&&(i.alias=i.name),"esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&(i.editable=null==i.editable||!!i.editable,i.nullable=null==i.nullable||!!i.nullable),!i.name)throw new r("ogc-feature-layer:invalid-field-name","field name is missing",{field:i});if(-1===m.kebabDict.jsonValues.indexOf(i.type))throw new r("ogc-feature-layer:invalid-field-type",`invalid type for field "${i.name}"`,{field:i})}if(F){const e=new f(y);if(F.startTimeField){const t=e.get(F.startTimeField);t?(F.startTimeField=t.name,t.type="esriFieldTypeDate"):F.startTimeField=null}if(F.endTimeField){const t=e.get(F.endTimeField);t?(F.endTimeField=t.name,t.type="esriFieldTypeDate"):F.endTimeField=null}if(F.trackIdField){const t=e.get(F.trackIdField);t?F.trackIdField=t.name:(F.trackIdField=null,h.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:F}}))}F.startTimeField||F.endTimeField||(h.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:F}}),F=null)}return{drawingInfo:b?p.createDrawingInfo(b):null,geometryType:b,fields:y,hasZ:!!g,objectIdField:w,timeInfo:F}}))).apply(this,arguments)}function F(e){return I.apply(this,arguments)}function I(){return(I=t._asyncToGenerator((function*(e,t={}){const{links:n}=e,a=Z(n,"data","application/json")||Z(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(o.isNone(a))throw new r("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:s,customParameters:l,signal:c}=t,{data:u}=yield i(a.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s}});return u}))).apply(this,arguments)}function T(e){return S.apply(this,arguments)}function S(){return(S=t._asyncToGenerator((function*(e,t={}){const{links:n}=e,a=Z(n,"conformance","application/json")||Z(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(o.isNone(a))throw new r("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:s,customParameters:l,signal:c}=t,{data:u}=yield i(a.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s}});return u}))).apply(this,arguments)}function j(e){return k.apply(this,arguments)}function k(){return(k=t._asyncToGenerator((function*(e,t={}){const{apiKey:n,customParameters:r,signal:a}=t,{data:o}=yield i(e,{signal:a,headers:{accept:"application/json"},query:{...r,token:n}});return o}))).apply(this,arguments)}function v(e){return N.apply(this,arguments)}function N(){return(N=t._asyncToGenerator((function*(e,t={}){const n="application/vnd.oai.openapi+json;version=3.0",r=Z(e.links,"service-desc",n);if(o.isNone(r))return h.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:a,customParameters:s,signal:l}=t,{data:c}=yield i(r.href,{signal:l,headers:{accept:n},query:{...s,token:a}});return c}))).apply(this,arguments)}function G(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=null==t?void 0:t.groups;if(!n)return null;const{authority:i,code:r}=n;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return g.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return g.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}}function O(e,t,n){return x.apply(this,arguments)}function x(){return(x=t._asyncToGenerator((function*(e,t,n){const i=yield q(e,t,n);return y.fromJSON(i)}))).apply(this,arguments)}function q(e,t,n){return M.apply(this,arguments)}function M(){return(M=t._asyncToGenerator((function*(e,t,n){const i=yield D(e,t,n);return c.convertToFeatureSet(i)}))).apply(this,arguments)}function D(e,t,n){return P.apply(this,arguments)}function P(){return P=t._asyncToGenerator((function*(e,t,n){const{capabilities:{query:{maxRecordCount:a}},collection:p,layerDefinition:f,queryParameters:{apiKey:m,customParameters:y},spatialReference:h,supportedCrs:b}=e,{links:w}=p,F=Z(w,"items","application/geo+json")||Z(w,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(o.isNone(F))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:I,num:T,start:S,timeExtent:j,where:k}=t;if(t.objectIds)throw new r("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const v=g.fromJSON(h),N=o.unwrapOr(t.outSpatialReference,v),G=N.isWGS84?null:C(N,b),O=L(I,b),x=W(j),q=$(k),M=null!=T?T:null!=S&&void 0!==S?10:a,{data:D}=yield i(F.href,{...n,query:{...y,...O,crs:G,datetime:x,query:q,limit:M,startindex:S,token:m},headers:{accept:"application/geo+json"}});let P=!1;if(D.links){const e=D.links.find((e=>"next"===e.rel));P=!!e}!P&&Number.isInteger(D.numberMatched)&&Number.isInteger(D.numberReturned)&&(P=D.numberReturned<D.numberMatched);const{fields:_,globalIdField:R,hasM:J,hasZ:K,objectIdField:A}=f,z=f.geometryType,E=d.createOptimizedFeatures(D,{geometryType:z,hasZ:K,objectIdField:A});if(!G&&N.isWebMercator)for(const i of E)if(o.isSome(i.geometry)){const e=c.convertToGeometry(i.geometry,z,K,!1);e.spatialReference=g.WGS84,i.geometry=c.convertFromGeometry(l.project(e,N))}for(const i of E)i.objectId=i.attributes[A];const U=G||!G&&N.isWebMercator?N.toJSON():s.WGS84,B=new u;return B.exceededTransferLimit=P,B.features=E,B.fields=_,B.geometryType=z,B.globalIdFieldName=R,B.hasM=J,B.hasZ=K,B.objectIdFieldName=A,B.spatialReference=U,B})),P.apply(this,arguments)}function _(e){return o.isSome(e)&&"extent"===e.type}function C(e,t){var n;const{isWebMercator:i,wkid:r}=e;return r?i?null!=(a=null!=(o=null!=(s=null!=(l=t[3857])?l:t[102100])?s:t[102113])?o:t[900913])?a:null:null!=(n=t[e.wkid])?n:null:null;var a,o,s,l}function R(e){if(o.isNone(e))return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function W(e){if(o.isNone(e))return null;const{start:t,end:n}=e;return`${o.isSome(t)?t.toISOString():".."}/${o.isSome(n)?n.toISOString():".."}`}function $(e){return o.isNone(e)||!e||"1=1"===e?null:e}function L(e,t){if(!_(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:R(e)};const i=C(n,t);return i?{bbox:R(e),"bbox-crs":i}:n.isWebMercator?{bbox:R(l.project(e,g.WGS84))}:null}function Z(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}e.getCollectionDefinition=b,e.getServerCollections=F,e.getServerConformance=T,e.getServerLandingPage=j,e.getServerOpenApi=v,e.getSpatialReferenceWkid=G,e.queryFeatureSet=O,e.queryFeatureSetJSON=q,e.queryOptimizedFeatureSet=D,Object.defineProperty(e,"__esModule",{value:!0})}));
