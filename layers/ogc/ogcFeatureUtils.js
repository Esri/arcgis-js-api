// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../request","../../core/arrayUtils","../../core/Error","../../core/Logger","../../geometry/support/spatialReferenceUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/data/projectionSupport","../graphics/data/projectionSupport","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../support/FieldsIndex","../support/fieldType","../../tasks/support/FeatureSet"],(function(e,t,r,i,n,a,o,l,s,u,d,c,f,g,m,p,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.queryOptimizedFeatureSet=t.queryFeatureSetJSON=t.queryFeatureSet=t.getServerLandingPage=t.getServerConformance=t.getServerCollections=t.getServerCollection=t.getCollectionDefinition=void 0;var h=o.getLogger("esri.layers.graphics.sources.ogcfeature");function F(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,v(e,t,i)];case 1:return n=r.sent(),[2,s.convertToFeatureSet(n)]}}))}))}function v(e,t,n){var a;return r.__awaiter(this,void 0,void 0,(function(){var o,g,m,p,y,h,F,v,b,w,_,I,S,T,j,q,O,k,x,D,C,N,G,Z,L,P,J,R,W,z,E,M,U;return r.__generator(this,(function(B){switch(B.label){case 0:return o=e.capabilities.query.maxRecordCount,g=e.collectionId,m=e.layerDefinition,p=e.url,y=p+"/collections/"+g+"/items",h=t.geometry,F=t.num,v=t.outSpatialReference,b=t.start,w=t.timeExtent,_=t.where,I=c.project(h,l.WGS84),S=function(e){if(!e)return null;var t=e.xmin,r=e.ymin,i=e.xmax,n=e.ymax;return t+","+r+","+i+","+n}(I),T=function(e){if(!e)return null;var t=e.start,r=e.end;return(t?t.toISOString():"..")+"/"+(r?r.toISOString():"..")}(w),j=function(e){if(!e||"1=1"===e)return null;return e}(_),q=null!=b?b:0,O=null!=F?F:null!=b&&void 0!==b?10:o,[4,i(y,r.__assign(r.__assign({},n),{query:{bbox:S,datetime:T,query:j,limit:O,startindex:q,f:"application/geo+json"}}))];case 1:if(k=B.sent().data,x=null===(a=k.links)||void 0===a?void 0:a.filter((function(e){return"next"===e.rel})),D=0!==(null==x?void 0:x.length),C=m.fields,N=m.globalIdField,G=m.hasM,Z=m.hasZ,L=m.objectIdField,P=m.geometryType,J=f.createOptimizedFeatures(k,{geometryType:P,hasZ:Z,objectIdFieldName:L}),!l.equals(v,l.WGS84))for(R=0,W=J;R<W.length;R++)(M=W[R]).geometry&&(M.geometry=s.convertFromGeometry(d.project(s.convertToGeometry(M.geometry,P,Z,!1),l.WGS84,v)));for(z=0,E=J;z<E.length;z++)(M=E[z]).objectId=M.attributes[L];return(U=new u.default).exceededTransferLimit=D,U.features=J,U.fields=C,U.geometryType=P,U.globalIdFieldName=N,U.hasM=G,U.hasZ=Z,U.objectIdFieldName=L,U.spatialReference=v||l.WGS84,[2,U]}}))}))}t.getCollectionDefinition=function(e,t,o,s,u){return void 0===u&&(u=5),r.__awaiter(this,void 0,void 0,(function(){var c,y,F,v,b,w,_,I,S,T,j,q,O,k,x;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,d.checkProjectionSupport(l.WGS84,o.spatialReference)];case 1:return r.sent(),[3,3];case 2:throw r.sent(),new a("ogc-feature-layer:projection-not-supported","Projection not supported");case 3:return[4,i(e+"/collections/"+t+"/items",{signal:s,query:{limit:u,f:"application/geo+json"}})];case 4:return c=r.sent().data,[4,f.validateGeoJSON(c)];case 5:if(r.sent(),y=f.inferLayerProperties(c,{geometryType:o.geometryType}),F=o.fields||y.fields||[],v=null!=o.hasZ?o.hasZ:y.hasZ,b=y.geometryType,w=o.objectIdField||y.objectIdFieldName||"OBJECTID",_=o.timeInfo,I=n.find(F,(function(e){return e.name===w})),!I){if(!y.objectIdFieldType)throw new a("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");F.unshift({name:w,alias:w,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else I.type="esriFieldTypeOID",I.editable=!1,I.nullable=!1;if(w!==y.objectIdFieldName&&(j=n.find(F,(function(e){return e.name===y.objectIdFieldName})))&&(j.type="esriFieldTypeInteger"),!b)throw new a("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");for(F===y.fields&&y.unknownFields.length>0&&h.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:y.unknownFields}}),S=0,T=F;S<T.length;S++){if(null==(j=T[S]).name&&(j.name=j.alias),null==j.alias&&(j.alias=j.name),"esriFieldTypeOID"!==j.type&&"esriFieldTypeGlobalID"!==j.type&&(j.editable=null==j.editable||!!j.editable,j.nullable=null==j.nullable||!!j.nullable),!j.name)throw new a("ogc-feature-layer:invalid-field-name","field name is missing",{field:j});if(-1===p.kebabDict.jsonValues.indexOf(j.type))throw new a("ogc-feature-layer:invalid-field-type",'invalid type for field "'+j.name+'"',{field:j})}return _&&(q=new m(F),_.startTimeField&&((O=q.get(_.startTimeField))?(_.startTimeField=O.name,O.type="esriFieldTypeDate"):_.startTimeField=null),_.endTimeField&&((k=q.get(_.endTimeField))?(_.endTimeField=k.name,k.type="esriFieldTypeDate"):_.endTimeField=null),_.trackIdField&&((x=q.get(_.trackIdField))?_.trackIdField=x.name:(_.trackIdField=null,h.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:_}}))),_.startTimeField||_.endTimeField||(h.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:_}}),_=null)),[2,{drawingInfo:g.createDrawingInfo(b),geometryType:b,fields:F,hasZ:!!v,objectIdField:w,timeInfo:_}]}}))}))},t.getServerCollection=function(e,t,n,a){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,i(e+"/collections/"+t,{signal:a,query:{f:n}})];case 1:return[2,r.sent().data]}}))}))},t.getServerCollections=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,i(e+"/collections",{signal:n,query:{f:t}})];case 1:return[2,r.sent().data]}}))}))},t.getServerConformance=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,i(e+"/conformance",{signal:n,query:{f:t}})];case 1:return[2,r.sent().data]}}))}))},t.getServerLandingPage=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,i(e,{signal:n,query:{f:t}})];case 1:return[2,r.sent().data]}}))}))},t.queryFeatureSet=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,F(e,t,i)];case 1:return n=r.sent(),[2,y.fromJSON(n)]}}))}))},t.queryFeatureSetJSON=F,t.queryOptimizedFeatureSet=v}));