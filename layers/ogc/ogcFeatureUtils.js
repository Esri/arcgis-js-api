/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../core/Logger","../../core/Error","../../geometry/support/spatialReferenceUtils","../../geometry/SpatialReference","../../geometry/support/webMercatorUtils","../../geometry","../../request","../support/fieldType","../graphics/OptimizedFeatureSet","../graphics/featureConversionUtils","../support/FieldsIndex","../../tasks/support/FeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults"],(function(e,t,n,r,i,a,o,s,l,c,d,u,f,m,y,p){"use strict";const g=n.getLogger("esri.layers.graphics.sources.ogcfeature"),b="json";async function F(e,t,n,i,a=5){const o=`${e}/collections/${t}/items`,{data:s}=await l(o,{signal:i,query:{limit:a,f:b}});await y.validateGeoJSON(s);const d=y.inferLayerProperties(s,{geometryType:n.geometryType}),u=n.fields||d.fields||[],m=null!=n.hasZ?n.hasZ:d.hasZ,F=d.geometryType,w=n.objectIdField||d.objectIdFieldName||"OBJECTID";let I=n.timeInfo;const h=u.find((e=>e.name===w));if(!h){if(!d.objectIdFieldType)throw new r("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");u.unshift({name:w,alias:w,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else h.type="esriFieldTypeOID",h.editable=!1,h.nullable=!1;if(w!==d.objectIdFieldName){const e=u.find((e=>e.name===d.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!F)throw new r("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");u===d.fields&&d.unknownFields.length>0&&g.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:d.unknownFields}});for(const l of u){if(null==l.name&&(l.name=l.alias),null==l.alias&&(l.alias=l.name),"esriFieldTypeOID"!==l.type&&"esriFieldTypeGlobalID"!==l.type&&(l.editable=null==l.editable||!!l.editable,l.nullable=null==l.nullable||!!l.nullable),!l.name)throw new r("ogc-feature-layer:invalid-field-name","field name is missing",{field:l});if(-1===c.kebabDict.jsonValues.indexOf(l.type))throw new r("ogc-feature-layer:invalid-field-type",`invalid type for field "${l.name}"`,{field:l})}if(I){const e=new f(u);if(I.startTimeField){const t=e.get(I.startTimeField);t?(I.startTimeField=t.name,t.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const t=e.get(I.endTimeField);t?(I.endTimeField=t.name,t.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const t=e.get(I.trackIdField);t?I.trackIdField=t.name:(I.trackIdField=null,g.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(g.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}return{drawingInfo:p.createDrawingInfo(F),geometryType:F,fields:u,hasZ:!!m,objectIdField:w,timeInfo:I}}async function w(e,t,n){const r=`${e}/collections/${t}`,{data:i}=await l(r,{signal:n,query:{f:b}});return i}async function I(e,t){const n=`${e}/collections`,{data:r}=await l(n,{signal:t,query:{f:b}});return r}async function h(e,t){const n=`${e}/conformance`,{data:r}=await l(n,{signal:t,query:{f:b}});return r}async function T(e,t){const{data:n}=await l(e,{signal:t,query:{f:b}});return n}function S(e){const t=new RegExp("^http://www.opengis.net/def/crs/(?<authority>.*)/(?<version>.*)/(?<code>.*)$","i").exec(e),n=null==t?void 0:t.groups;if(!n)return null;const{authority:r,code:i}=n;switch(r.toLowerCase()){case"ogc":switch(i.toLowerCase()){case"crs27":return a.GCS_NAD_1927;case"crs83":return new a({wkid:4269});case"crs84":case"crs84h":return a.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(i,10);return Number.isNaN(e)?null:900913===e?a.WebMercator:new a({wkid:e})}default:return null}}async function j(e,t,n){const r=await N(e,t,n);return m.fromJSON(r)}async function N(e,t,n){const r=await v(e,t,n);return u.convertToFeatureSet(r)}async function v(e,n,s){const{capabilities:{query:{maxRecordCount:c}},collectionId:f,layerDefinition:m,spatialReference:p,supportedCrs:g,url:F}=e,w=`${F}/collections/${f}/items`,{geometry:I,num:h,start:T,timeExtent:S,where:j}=n;if(n.objectIds)throw new r("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const N=a.fromJSON(p),v=t.unwrapOr(n.outSpatialReference,N),x=v.isWGS84?null:O(v,g),k=D(I,g),C=q(S),R=$(j),G=null!=h?h:null!=T&&void 0!==T?10:c,{data:M}=await l(w,{...s,query:{...k,crs:x,datetime:C,query:R,limit:G,startindex:T,f:b}});let W=!1;if(M.links){W=!!M.links.find((e=>"next"===e.rel))}!W&&Number.isInteger(M.numberMatched)&&Number.isInteger(M.numberReturned)&&(W=M.numberReturned<M.numberMatched);const{fields:L,globalIdField:Z,hasM:J,hasZ:E,objectIdField:_}=m,z=m.geometryType,P=y.createOptimizedFeatures(M,{geometryType:z,hasZ:E,objectIdFieldName:_});if(!x&&v.isWebMercator)for(const t of P)if(t.geometry){const e=u.convertToGeometry(t.geometry,z,E,!1);e.spatialReference=a.WGS84,t.geometry=u.convertFromGeometry(o.project(e,v))}for(const t of P)t.objectId=t.attributes[_];const U=x||!x&&v.isWebMercator?v.toJSON():i.WGS84,A=new d;return A.exceededTransferLimit=W,A.features=P,A.fields=L,A.geometryType=z,A.globalIdFieldName=Z,A.hasM=J,A.hasZ=E,A.objectIdFieldName=_,A.spatialReference=U,A}function x(e){return t.isSome(e)&&"extent"===e.type}function O(e,t){return t.find((t=>{const n=S(t);return i.equals(n,e)}))}function k(e){const{xmin:t,ymin:n,xmax:r,ymax:i}=e;return`${t},${n},${r},${i}`}function q(e){if(t.isNone(e))return null;const{start:n,end:r}=e;return`${n?n.toISOString():".."}/${r?r.toISOString():".."}`}function $(e){return t.isNone(e)||!e||"1=1"===e?null:e}function D(e,t){if(!x(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:k(e)};const r=O(n,t);return r?{bbox:k(e),"bbox-crs":r}:n.isWebMercator?{bbox:k(o.project(e,a.WGS84))}:null}e.getCollectionDefinition=F,e.getServerCollection=w,e.getServerCollections=I,e.getServerConformance=h,e.getServerLandingPage=T,e.getSpatialReference=S,e.queryFeatureSet=j,e.queryFeatureSetJSON=N,e.queryOptimizedFeatureSet=v,Object.defineProperty(e,"__esModule",{value:!0})}));
