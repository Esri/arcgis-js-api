// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/Deferred","dojo/has","../kernel","../SpatialReference","../tasks/query","../tasks/QueryTask","../geometry/jsonUtils","./RenderMode"],(function(e,t,r,i,a,s,n,u,h,d,o){var f=e([o],{declaredClass:"esri.layers._StreamMode",constructor:function(e,r){this.featureLayer=e,this._featureMap={},this._setRefreshRate(),this._drawBuffer={adds:[],updates:[]},this._timeoutId=null,this._flushDrawBuffer=t.hitch(this,this._flushDrawBuffer),this._featuresByTime={},this._lastEndTimeCheck=null,this._maxFeatureAge=0,e.purgeOptions&&e.purgeOptions.age&&"number"==typeof e.purgeOptions.age&&(this._maxFeatureAge=1e3*Math.ceil(60*e.purgeOptions.age)),this._drawFeatures=t.hitch(this,this._drawFeatures),this._queryErrorHandler=t.hitch(this,this._queryErrorHandler)},startup:function(){this._started||(this.inherited(arguments),this.featureLayer._collection)},propertyChangeHandler:function(e){this._init&&(0===e?this._applyTimeFilter():3===e?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id = "+this.featureLayer.id))},destroy:function(){this.inherited(arguments),clearTimeout(this._timeoutId),this._featureMap=null,this._drawBuffer=null,this._featuresByTime=null},drawFeature:function(e){var t=this.featureLayer,r=t.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate)),(t._joinField?this._getFeature(e.attributes[r]):null)?this._drawBuffer.updates.push({oid:e.attributes[r],updates:e}):this._drawBuffer.adds.push(e)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){this._pendingRequest&&this._cancelPendingRequest(this._pendingRequest);var e=this.featureLayer;e&&(e._relatedUrl||e._keepLatestUrl?(e._fireUpdateStart(),e._refreshing=!0,e.disconnect(),e.clear(),e._relatedQueried=!1,e._keepLatestQueried=!1,e.connect()):(e._fireUpdateStart(),e.clear(),e._fireUpdateEnd()))},_drawFeatures:function(e,t){var r=e.features||[],i=this.featureLayer;i._create(r),i._fireUpdateEnd(null,t)},_applyTimeFilter:function(e){this.inherited(arguments),this._redrawAllTracks()},_removeFeatures:function(e){var t=this.featureLayer,i=t.objectIdField;e&&r.forEach(e,(function(e){var r=e.attributes[i];t._unSelectFeatureIIf(r,this),this._decRefCount(r),this._removeFeatureIIf(r)}),this)},_addFeatures:function(e){var t,i,a,s,n=this.featureLayer,u=n._endTimeField,h=n._startTimeField,d=[],o=[],f=[];if(t=n._trackManager,a=n.objectIdField,t)for(s in i=t.addFeatures(e))i.hasOwnProperty(s)&&(d.push(s),i[s].adds&&(o=o.concat(i[s].adds)),i[s].deletes&&(f=f.concat(i[s].deletes)));else o=e;r.forEach(o,(function(e){var t,r,i=e.attributes[a];!(t=u&&e.attributes[u])&&this._maxFeatureAge&&(t=h&&e.attributes[h]?e.attributes[h]+this._maxFeatureAge:Date.now()+this._maxFeatureAge),t&&(r=1e3*Math.ceil(t/1e3),this._featuresByTime[r]?this._featuresByTime[r].push(i):this._featuresByTime[r]=[i]),this._addFeatureIIf(i,e),this._incRefCount(i)}),this),f.length&&this._removeFeatures(f),t&&t.refreshTracks(d)},_updateFeatures:function(e){var t,i,a=this.featureLayer,s=[];t=a._trackManager,a.objectIdField,i=a._trackIdField,r.forEach(e,(function(e){var r,n,u=e.updates,h=e.oid,d=this._getFeature(h);if(d){for(n in u.geometry&&d.setGeometry(u.geometry),r=u.attributes||{})r.hasOwnProperty(n)&&(d.attributes[n]=r[n]);d.setAttributes(d.attributes),d.visible=this._checkFeatureTimeIntersects(d),t&&d.attributes[i]?s.push(d.attributes[i]):a._repaint(d,null,!0)}}),this),s.length&&t.refreshTracks(s)},_redrawAllTracks:function(){var e,t=this.featureLayer._trackManager;t&&(e=t.trimTracks())&&e.length>0&&(this._removeFeatures(e),t.refreshTracks())},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var e,t=this._drawBuffer,r=t.adds.splice(0,t.adds.length),i=t.updates.splice(0,t.updates.length),a=this.featureLayer;if(!a)return!1;a.updating||a._fireUpdateStart(),this._addFeatures(r),this._updateFeatures(i),(e=this._getExpiredFeatures())&&e.length&&(this._removeFeatures(e),a._trackManager&&a._trackManager.removeFeatures(e)),a._purge(),a._fireUpdateEnd(),this._timeoutId=null},_clearDrawBuffer:function(){var e=this._timeoutId,t=this._drawBuffer,r=t.adds,i=t.updates;e&&clearTimeout(e),r.splice(0,r.length),i.splice(0,i.length),this._timeoutId=null},_clearTimeBin:function(){this._featuresByTime={},this._lastEndTimeCheck=1e3*Math.ceil(Date.now()/1e3)},_clearFeatureMap:function(){this._featureMap={}},_setRefreshRate:function(e){(e=e||0===e?e:200)<0&&(e=200),this._refreshRate=e},_checkFeatureTimeIntersects:function(e){var t=this.featureLayer,r=t.getMap(),i=r?r.timeExtent:null;return!i||!t.timeInfo||!t.timeInfo.startTimeField&&!t.timeInfo.endTimeField||t._filterByTime([e],i.startTime,i.endTime).match.length>0},_fetchArchive:function(e){var t,r,a,s,o,f,l,_=new i,c=this.featureLayer;return this._pendingRequest&&this._cancelPendingRequest(this._pendingRequest),c._fireUpdateStart(),e&&this.map?(t=new h(e),r=new u,a=this.map,o=(s=c.getFilter()||{}).where||"1=1",f=s.geometry?d.fromJson(s.geometry):null,l=s.outFields?s.outFields.split(","):["*"],r.geometry=f,r.where=o,r.outFields=l,r.returnGeometry=!0,r.outSpatialReference=new n(a.spatialReference.toJson()),this._pendingRequest=t.execute(r).then(function(e){this._pendingRequest=null;var t=this._fixFieldNameCasing(c,e);e.features=t,this._drawFeatures(e),c._fireUpdateEnd(),_.resolve()}.bind(this)).otherwise(function(e){this._pendingRequest=null,c._errorHandler(e),c._fireUpdateEnd(e),_.reject(e)}.bind(this))):_.resolve(),_.promise},_queryErrorHandler:function(e){var t=this.featureLayer;t._errorHandler(e),t._fireUpdateEnd(e)},_fixFieldNameCasing:function(e,t){var r=t.features||[],i=t.fields,a=e.fields;if(!i||!r.length)return r;for(var s,n,u=this._mapFieldNameDifferences(a,i),h=[],d=0,o=t.features.length;d<o;d++)s=r[d],n=this._swizzleResponseAttributes(s.attributes,u),h.push({geometry:s.geometry,attributes:n});return h},_mapFieldNameDifferences:function(e,t){var r,i,a=[],s={};for(r=0,i=t.length;r<i;r++)a.push(t[r].name);for(r=0,i=e.length;r<i;r++){var n=e[r].name,u=this._checkForStreamFieldName(n,a);u&&(s[u]=n)}return s},_checkForStreamFieldName:function(e,t){for(var r,i=e.toLowerCase(),a=0,s=t.length;a<s;a++)if(t[a].toLowerCase()===i){r=t[a];break}return r},_swizzleResponseAttributes:function(e,t){var r={};for(var i in e)if(e.hasOwnProperty(i)){var a=e[i];t.hasOwnProperty(i)?r[t[i]]=a:r[i]=a}return r},_getExpiredFeatures:function(){var e,t,i,a,s=this.featureLayer._endTimeField,n=[],u=[];if(!s&&!this._maxFeatureAge)return u;if(e=1e3*Math.floor(this._lastEndTimeCheck/1e3),t=1e3*Math.ceil(Date.now()/1e3),this._lastEndTimeCheck=t,e&&e!==t)for(a=this._featuresByTime,i=e;i<=t;i+=1e3)a[i]&&(n=n.concat(a[i]),delete a[i]);return r.forEach(n,(function(e){var t=this._getFeature(e);t&&u.push(t)}),this),u}});return a("extend-esri")&&t.setObject("layers._StreamMode",f,s),f}));