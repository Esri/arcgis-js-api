/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/Error","../core/Handles","../core/Logger","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../chunks/vec3","../chunks/vec3f64","./Layer","./VoxelWasmManager","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./support/arcgisLayerUrl","./support/commonProperties","./support/VoxelDynamicSection","./support/VoxelSection","./support/VoxelSlice","./support/VoxelStyle","./support/VoxelVariable","./support/VoxelVolume","./support/VoxelVolumeIndex"],(function(e,r,t,o,i,s,n,a,l,c,p,d,u,y,h,m,_,v,b,S,g,f,V,x,w,I,L,T,P,N,A,M,W,E,D){"use strict";const R=s.getLogger(" esri.layers.VoxelLayer");var O;!function(e){e[e.API=1]="API",e[e.VerboseAPI=2]="VerboseAPI",e[e.Error=3]="Error"}(O||(O={}));let j=function(r){function s(e){var o;return(o=r.call(this,e)||this).serviceRoot="",o.popupEnabled=!0,o.operationalLayerType="Voxel",o.legendEnabled=!0,o.title=null,o.sections=new t,o.style=null,o.opacity=1,o.variables=new t,o.volumes=new t,o.index=null,o.minScale=0,o.maxScale=0,o.type="voxel",o._dbgFlags=new Set,o._handles=new i,o.version={major:Number.NaN,minor:Number.NaN,versionString:""},o}e._inheritsLoose(s,r);var a=s.prototype;return a.destroy=function(){this._handles=n.destroyMaybe(this._handles)},a._dbg=function(e,r){this._dbgFlags.has(e)&&(e===O.Error?R.error(r):R.warn(r))},a.load=function(e){const r=n.isSome(e)?e.signal:null,t=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(l.throwIfAbortError).then((()=>this._fetchService(r))).then((()=>this.serviceRoot=this.url));return this.addResolvingPromise(t),Promise.resolve(this)},a.getConfiguration=function(){this._handles.add([c.watch((()=>this._getRenderMode()),(e=>this._pushRenderModeToWasm(e))),c.watch((()=>this._getCurrentVariableId()),(e=>this._pushCurrentVariableIdToWasm(e))),c.watch((()=>this._getDynamicSections()),(e=>this._pushDynamicSectionsToWasm(e))),c.watch((()=>this._getSlices()),(e=>this._pushSlicesToWasm(e))),c.watch((()=>this._getSections()),(e=>this._pushSectionsToWasm(e)))]);const e={layerType:this.operationalLayerType,version:this.version.versionString,name:this.title,spatialReference:this.spatialReference,fullExtent:this.fullExtent,volumes:this.volumes.toJSON(),variables:this.variables.toJSON(),index:this.index.toJSON(),sections:this.sections.toJSON(),style:this.style};return e.index&&this.index.isValid()?JSON.stringify(e):""},a.readVersion=function(e,t){return r.prototype.parseVersionString.call(this,e)},a._getSections=function(){const e=[];for(const r of this.sections)e.push(new N({enabled:r.enabled,href:r.href,id:r.id,label:r.label,normal:r.normal,point:r.point,sizeInPixel:r.sizeInPixel,slices:r.slices,timeId:r.timeId,variableId:r.variableId}));return e},a._pushSectionsToWasm=function(e){this._dbg(O.VerboseAPI,"VoxelLayer._pushSectionsToWasm() called");S.getInstance().setLayerStaticSections(this,e)||this._dbg(O.Error,"VoxelLayer._pushSectionsToWasm() failed!")},a._isPlaneValid=function(e,r,t){if(!e.point)return!1;if(!Array.isArray(e.point)||3!==e.point.length)return!1;if(!e.normal)return!1;if(!Array.isArray(e.normal)||3!==e.normal.length)return!1;for(let s=0;s<3;++s){const o=e.point[s];if(o<0||o>=t[r[s]].size)return!1}const o=v.fromValues(e.normal[0],e.normal[1],e.normal[2]);_.normalize(o,o);const i=1e-6;return!(Math.abs(o[0])+Math.abs(o[1])+Math.abs(o[2])<i)&&(e.normal[0]=o[0],e.normal[1]=o[1],e.normal[2]=o[2],!0)},a.getVariableStyle=function(e){let r=-1;r=n.isSome(e)?e:this._getCurrentVariableId();if(!(null==this?void 0:this.style.variableStyles)||-1===r)return null;const t=this.style.variableStyles.findIndex((e=>e.variableId===r));return t<0?null:this.style.variableStyles.getItemAt(t)},a.getVariable=function(e){let r=-1;if(r=n.isSome(e)?e:this._getCurrentVariableId(),!this.variables||-1===r)return null;const t=this.variables.findIndex((e=>e.id===r));return t<0?null:this.variables.getItemAt(t)},a.getVolume=function(e){const r=this.getVariable(e);return n.isSome(r)?this.volumes.find((({id:e})=>e===r.volumeId)):null},a.validateLayer=function(e){if(e.layerType&&e.layerType!==this.operationalLayerType)throw new o("voxel-layer:layer-type-not-supported","VoxelLayer does not support this layer type",{layerType:e.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor)||this.version.major<3)throw new o("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"3.x"});if(this.version.major>3)throw new o("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"3.x"})},a._getVolumeStyle=function(e){const r=this.getVariable(e);return n.isSome(r)?this.style.volumeStyles.find((({volumeId:e})=>e===r.volumeId)):null},a._getSlices=function(){const e=[],r=this.getVolume(null);if(!n.isSome(r)||!r.isVolumeValid())return e;const t=this._getVolumeStyle(null);if(!n.isSome(t))return e;for(const o of t.slices)this._isPlaneValid(o,[0,1,r.getZDimension()],r.dimensions)?e.push(new A({enabled:o.enabled,label:o.label,point:o.point,normal:o.normal})):e.push(new A({enabled:!1,label:"invalid",point:o.point,normal:o.normal}));return e},a._pushSlicesToWasm=function(e){this._dbg(O.VerboseAPI,"VoxelLayer._pushSlicesToWasm() called!");S.getInstance().setLayerSlices(this,e)||this._dbg(O.Error,"VoxelLayer._pushSlicesToWasm() failed!")},a._getDynamicSections=function(){const e=[],r=this.getVolume(null);if(!n.isSome(r)||!r.isVolumeValid())return e;const t=this._getVolumeStyle(null);if(!n.isSome(t))return e;for(const o of t.dynamicSections)this._isPlaneValid(o,[0,1,r.getZDimension()],r.dimensions)?e.push(new P({enabled:o.enabled,label:o.label,point:o.point,normal:o.normal})):e.push(new P({enabled:!1,label:"invalid",point:o.point,normal:o.normal}));return e},a._pushDynamicSectionsToWasm=function(e){this._dbg(O.VerboseAPI,"VoxelLayer._pushDynamicSectionsToWasm() called!");S.getInstance().setLayerDynamicSections(this,e)||this._dbg(O.Error,"VoxelLayer._updateDynamicSections() failed!")},a._getCurrentVariableId=function(){return this.style?this.style.currentVariableId:-1},a._pushCurrentVariableIdToWasm=function(e){this._dbg(O.VerboseAPI,"VoxelLayer._pushCurrentVariableIdToWasm() called!");S.getInstance().setLayerCurrentVariable(this,e)||this._dbg(O.Error,"VoxelLayer._pushCurrentVariableIdToWasm() failed!")},a._getRenderMode=function(){return this.style?this.style.renderMode:"volume"},a._pushRenderModeToWasm=function(e){this._dbg(O.VerboseAPI,"VoxelLayer._pushRenderModeToWasm() called!");S.getInstance().setLayerRenderMode(this,e)||this._dbg(O.Error,"VoxelLayer.setLayerRenderMode() failed!")},e._createClass(s,[{key:"url",set:function(e){this._set("url",L.sanitizeUrl(e,R))}}]),s}(I.SceneService(f.ArcGISService(V.OperationalLayer(x.PortalLayer(w.ScaleRangeLayer(a.MultiOriginJSONMixin(g.APIKeyMixin(b))))))));r.__decorate([p.property(T.popupEnabled)],j.prototype,"popupEnabled",void 0),r.__decorate([p.property({type:["Voxel"]})],j.prototype,"operationalLayerType",void 0),r.__decorate([p.property(T.legendEnabled)],j.prototype,"legendEnabled",void 0),r.__decorate([p.property({json:{write:!0}})],j.prototype,"title",void 0),r.__decorate([p.property(T.url)],j.prototype,"url",null),r.__decorate([p.property({type:t.ofType(N),json:{write:!0,origins:{"web-scene":{name:"layerDefinition.sections",write:!0},service:{write:!1}}}})],j.prototype,"sections",void 0),r.__decorate([p.property({type:M,json:{write:!0,origins:{"web-scene":{name:"layerDefinition.style",write:!0},service:{write:!1}}}})],j.prototype,"style",void 0),r.__decorate([p.property({type:["show","hide"]})],j.prototype,"listMode",void 0),r.__decorate([p.property({type:Number,range:{min:0,max:1},nonNullable:!0,json:{read:!1,write:!1,origins:{"web-scene":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],j.prototype,"opacity",void 0),r.__decorate([p.property({type:t.ofType(W)})],j.prototype,"variables",void 0),r.__decorate([p.property({type:t.ofType(E)})],j.prototype,"volumes",void 0),r.__decorate([p.property({type:D})],j.prototype,"index",void 0),r.__decorate([p.property({type:Number,json:{name:"layerDefinition.minScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],j.prototype,"minScale",void 0),r.__decorate([p.property({type:Number,json:{name:"layerDefinition.maxScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],j.prototype,"maxScale",void 0),r.__decorate([p.property({json:{read:!1},readOnly:!0})],j.prototype,"type",void 0),r.__decorate([p.property({readOnly:!0,json:{name:"serviceVersion"}})],j.prototype,"version",void 0),r.__decorate([h.reader("service","version")],j.prototype,"readVersion",null),j=r.__decorate([m.subclass("esri.layers.VoxelLayer")],j);return j}));
