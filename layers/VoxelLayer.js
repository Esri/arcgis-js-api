/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/Handles","../core/Logger","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../chunks/vec3","../chunks/vec3f64","./Layer","./VoxelWasmManager","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./support/arcgisLayerUrl","./support/commonProperties","./support/VoxelDynamicSection","./support/VoxelSection","./support/VoxelSlice","./support/VoxelStyle","./support/VoxelVariable","./support/VoxelVolume","./support/VoxelVolumeIndex"],(function(e,t,r,i,o,n,s,a,l,c,p,d,u,y,h,m,_,b,S,g,f,v,V,x,I,L,w,T,M,W,N,D,P,R){"use strict";const O=o.getLogger(" esri.layers.VoxelLayer");let C=function(t){function o(e){var o;return(o=t.call(this,e)||this).serviceRoot="",o.popupEnabled=!0,o.operationalLayerType="Voxel",o.legendEnabled=!0,o.title=null,o.sections=new r,o.style=null,o.opacity=1,o.variables=new r,o.volumes=new r,o.index=null,o.minScale=0,o.maxScale=0,o.type="voxel",o._dbgFlags=new Set,o._handles=new i,o.version={major:Number.NaN,minor:Number.NaN,versionString:""},o}e._inheritsLoose(o,t);var s=o.prototype;return s.destroy=function(){this._handles=n.destroyMaybe(this._handles)},s.dbg=function(e,t){this._dbgFlags.has(e)&&(3===e?O.error(t):O.warn(t))},s.load=function(e){const t=n.isSome(e)?e.signal:null,r=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(a.throwIfAbortError).then((()=>this._fetchService(t))).then((()=>this.serviceRoot=this.url));return this.addResolvingPromise(r),Promise.resolve(this)},s.getConfiguration=function(){this._handles.add([l.react((()=>this._getRenderMode()),(e=>this._pushRenderModeToWasm(e))),l.react((()=>this._getCurrentVariableId()),(e=>this._pushCurrentVariableIdToWasm(e))),l.react((()=>this._getDynamicSections()),(e=>this._pushDynamicSectionsToWasm(e))),l.react((()=>this._getSlices()),(e=>this._pushSlicesToWasm(e))),l.react((()=>this._getSections()),(e=>this._pushSectionsToWasm(e)))]);const e={layerType:this.operationalLayerType,version:this.version.versionString,name:this.title,spatialReference:this.spatialReference,fullExtent:this.fullExtent,volumes:this.volumes.toJSON(),variables:this.variables.toJSON(),index:this.index.toJSON(),sections:this.sections.toJSON(),style:this.style};return e.index&&this.index.isValid()?JSON.stringify(e):""},s.readVersion=function(e,r){return t.prototype.parseVersionString.call(this,e)},s._getSections=function(){const e=[];for(const t of this.sections)e.push(new M({enabled:t.enabled,href:t.href,id:t.id,label:t.label,normal:t.normal,point:t.point,sizeInPixel:t.sizeInPixel,slices:t.slices,timeId:t.timeId,variableId:t.variableId}));return e},s._pushSectionsToWasm=function(e){this.dbg(2,"VoxelLayer._pushSectionsToWasm() called");S.getInstance().setLayerStaticSections(this,e)||this.dbg(3,"VoxelLayer._pushSectionsToWasm() failed!")},s._isPlaneValid=function(e,t,r){if(!e.point)return!1;if(!Array.isArray(e.point)||3!==e.point.length)return!1;if(!e.normal)return!1;if(!Array.isArray(e.normal)||3!==e.normal.length)return!1;for(let n=0;n<3;++n){const i=e.point[n];if(i<0||i>=r[t[n]].size)return!1}const i=_.fromValues(e.normal[0],e.normal[1],e.normal[2]);m.normalize(i,i);const o=1e-6;return!(Math.abs(i[0])+Math.abs(i[1])+Math.abs(i[2])<o)&&(e.normal[0]=i[0],e.normal[1]=i[1],e.normal[2]=i[2],!0)},s.getVariableStyle=function(e){let t=-1;t=n.isSome(e)?e:this._getCurrentVariableId();if(!(null==this?void 0:this.style.variableStyles)||-1===t)return null;const r=this.style.variableStyles.findIndex((e=>e.variableId===t));return r<0?null:this.style.variableStyles.getItemAt(r)},s.getVariable=function(e){let t=-1;if(t=n.isSome(e)?e:this._getCurrentVariableId(),!this.variables||-1===t)return null;const r=this.variables.findIndex((e=>e.id===t));return r<0?null:this.variables.getItemAt(r)},s._getVolume=function(e){const t=this.getVariable(e);return n.isSome(t)?this.volumes.find((({id:e})=>e===t.volumeId)):null},s._getVolumeStyle=function(e){const t=this.getVariable(e);return n.isSome(t)?this.style.volumeStyles.find((({volumeId:e})=>e===t.volumeId)):null},s._getSlices=function(){const e=[],t=this._getVolume(null);if(!n.isSome(t)||!t.isVolumeValid())return e;const r=this._getVolumeStyle(null);if(!n.isSome(r))return e;for(const i of r.slices)this._isPlaneValid(i,[0,1,t.getZDimension()],t.dimensions)?e.push(new W({enabled:i.enabled,label:i.label,point:i.point,normal:i.normal})):e.push(new W({enabled:!1,label:"invalid",point:i.point,normal:i.normal}));return e},s._pushSlicesToWasm=function(e){this.dbg(2,"VoxelLayer._pushSlicesToWasm() called!");S.getInstance().setLayerSlices(this,e)||this.dbg(3,"VoxelLayer._pushSlicesToWasm() failed!")},s._getDynamicSections=function(){const e=[],t=this._getVolume(null);if(!n.isSome(t)||!t.isVolumeValid())return e;const r=this._getVolumeStyle(null);if(!n.isSome(r))return e;for(const i of r.dynamicSections)this._isPlaneValid(i,[0,1,t.getZDimension()],t.dimensions)?e.push(new T({enabled:i.enabled,label:i.label,point:i.point,normal:i.normal})):e.push(new T({enabled:!1,label:"invalid",point:i.point,normal:i.normal}));return e},s._pushDynamicSectionsToWasm=function(e){this.dbg(2,"VoxelLayer._pushDynamicSectionsToWasm() called!");S.getInstance().setLayerDynamicSections(this,e)||this.dbg(3,"VoxelLayer._updateDynamicSections() failed!")},s._getCurrentVariableId=function(){return this.style?this.style.currentVariableId:-1},s._pushCurrentVariableIdToWasm=function(e){this.dbg(2,"VoxelLayer._pushCurrentVariableIdToWasm() called!");S.getInstance().setLayerCurrentVariable(this,e)||this.dbg(3,"VoxelLayer._pushCurrentVariableIdToWasm() failed!")},s._getRenderMode=function(){return this.style?this.style.renderMode:"volume"},s._pushRenderModeToWasm=function(e){this.dbg(2,"VoxelLayer._pushRenderModeToWasm() called!");S.getInstance().setLayerRenderMode(this,e)||this.dbg(3,"VoxelLayer.setLayerRenderMode() failed!")},e._createClass(o,[{key:"url",set:function(e){this._set("url",L.sanitizeUrl(e,O))}}]),o}(I.SceneService(f.ArcGISService(v.OperationalLayer(V.PortalLayer(x.ScaleRangeLayer(s.MultiOriginJSONMixin(g.APIKeyMixin(b))))))));t.__decorate([c.property(w.popupEnabled)],C.prototype,"popupEnabled",void 0),t.__decorate([c.property({type:["Voxel"]})],C.prototype,"operationalLayerType",void 0),t.__decorate([c.property(w.legendEnabled)],C.prototype,"legendEnabled",void 0),t.__decorate([c.property({json:{write:!0}})],C.prototype,"title",void 0),t.__decorate([c.property(w.url)],C.prototype,"url",null),t.__decorate([c.property({type:r.ofType(M),json:{write:!0,origins:{"web-scene":{name:"layerDefinition.sections",write:!0},service:{write:!1}}}})],C.prototype,"sections",void 0),t.__decorate([c.property({type:N,json:{write:!0,origins:{"web-scene":{name:"layerDefinition.style",write:!0},service:{write:!1}}}})],C.prototype,"style",void 0),t.__decorate([c.property({type:["show","hide"]})],C.prototype,"listMode",void 0),t.__decorate([c.property({type:Number,range:{min:0,max:1},nonNullable:!0,json:{read:!1,write:!1,origins:{"web-scene":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],C.prototype,"opacity",void 0),t.__decorate([c.property({type:r.ofType(D)})],C.prototype,"variables",void 0),t.__decorate([c.property({type:r.ofType(P)})],C.prototype,"volumes",void 0),t.__decorate([c.property({type:R})],C.prototype,"index",void 0),t.__decorate([c.property({type:Number,json:{name:"layerDefinition.minScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],C.prototype,"minScale",void 0),t.__decorate([c.property({type:Number,json:{name:"layerDefinition.maxScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],C.prototype,"maxScale",void 0),t.__decorate([c.property({json:{read:!1},readOnly:!0})],C.prototype,"type",void 0),t.__decorate([c.property({readOnly:!0,json:{name:"serviceVersion"}})],C.prototype,"version",void 0),t.__decorate([y.reader("service","version")],C.prototype,"readVersion",null),C=t.__decorate([h.subclass("esri.layers.VoxelLayer")],C);return C}));
