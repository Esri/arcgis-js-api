define(["dojo/_base/declare","dojo/_base/kernel","dojo/_base/lang","dojo/_base/connect","dojo/has","dojo/on","../request","../kernel","../graphic","../Color","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../SpatialReference","../geometry/webMercatorUtils","../geometry/Extent","../geometry/Point","../geometry/Multipoint","../geometry/Polyline","../geometry/Polygon","./GraphicsLayer"],function(e,t,r,i,s,a,n,o,l,h,m,g,d,_,u,p,y,f,N,S,v){var c=e([v],{declaredClass:"esri.layers.WFSLayer",constructor:function(e){this.id="WFSLayer",this.fullExtent=null,this.fields=[],this.geometryType="esriGeometryComplex",this.visible=!0,this.visibleAtMapScale=!0,this.renderer=null,this._graphicArray=[],this._gmlNS="http://www.opengis.net/gml",this._layerEventHandlers=[],this._getCapabilitiesCallback=null,this._options={},r.mixin(this._options,e),this._url="",this._version="1.1.0",this._nsLayerName="",this._wkid=3857,this._mode="snapshot",this._inverseFilter=!1,this._inverseResponse=!1,this._maxFeatures=100,this._getFeatureRequest="",this._getFeatureUrl="",this._nsGeometryFieldName="",this._showDetails=!1,this._parseGml=r.hitch(this,this._parseGml),this._getCapabilities=r.hitch(this,this._getCapabilities),this._getCapabilitiesResponse=r.hitch(this,this._getCapabilitiesResponse),this._messageHandler=r.hitch(this,this._messageHandler),this._pointSymbol=new m(m.STYLE_CIRCLE,6,new g(g.STYLE_SOLID,new h([0,255,0]),1),new h([255,0,0])),this._lineSymbol=new g(g.STYLE_SOLID,new h([0,255,0]),3),this._polygonSymbol=new d(d.STYLE_SOLID,new g(g.STYLE_SOLID,new h([255,0,0]),2),new h([255,255,0,.25])),this.setWFSParameters(e),""!==this._getFeatureUrl&&""!==this._getFeatureRequest?this.getFeature():(this.mode="snapshot",this.getCapabilities())},getCapabilities:function(e){this._getCapabilitiesCallback=e;var t=r.trim(this._url);if(""!==t){this._messageHandler("connect to wfs server...");var i=t.indexOf("?"),s=-1===i?"?":"&",a=t+s+"service=WFS&request=GetCapabilities&version="+this._version,o=n({url:a,handleAs:"text",headers:{"Content-Type":"text/plain"},timeout:1e4},{usePost:!1});o.then(this._getCapabilitiesResponse,this._messageHandler)}},buildRequest:function(){var e=this._nsLayerName.indexOf("|"),t=this._nsLayerName.substring(0,e),r=this._nsLayerName.substring(e+1),e=this._nsGeometryFieldName.indexOf("|"),i=this._nsGeometryFieldName.substring(0,e),s=this._nsGeometryFieldName.substring(e+1),a="";return a+="<?xml version='1.0' encoding='utf-8'?>\n",a+="<GetFeature \n",a+=" xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'\n",a+=" xmlns:gml='http://www.opengis.net/gml'\n",a+=" xmlns:ogc='http://www.opengis.net/ogc'\n",a+=" xmlns:wfs='http://www.opengis.net/wfs'\n",a+="2.0.0"===this._version?" xmlns='http://www.opengis.net/wfs/2.0'\n":" xmlns='http://www.opengis.net/wfs'\n",a+=" xmlns:ns1='"+t+"'\n","ondemand"===this._mode.toLowerCase()&&(a+=" xmlns:ns2='"+i+"'\n"),a+="2.0.0"===this._version?" version='"+this._version+"' service='WFS' count='"+this._maxFeatures+"'>\n":" version='"+this._version+"' service='WFS' maxFeatures='"+this._maxFeatures+"'>\n",a+="2.0.0"===this._version?" <Query typeNames='ns1:"+r+"' srsName='EPSG:"+this._wkid+"'>\n":" <wfs:Query typeName='ns1:"+r+"' srsName='EPSG:"+this._wkid+"'>\n","ondemand"===this._mode.toLowerCase()&&(a+="  <ogc:Filter xmlns:ogc='http://www.opengis.net/ogc'>\n",a+="   <ogc:BBOX>\n",a+="    <ogc:PropertyName>ns2:"+s+"</ogc:PropertyName>\n",a+="    <gml:Box srsName='EPSG:"+this._wkid+"'>\n",a+=this._inverseFilter?"      <gml:coordinates>{ymin},{xmin} {ymax},{xmax}</gml:coordinates>\n":"      <gml:coordinates>{xmin},{ymin} {xmax},{ymax}</gml:coordinates>\n",a+="    </gml:Box>\n",a+="   </ogc:BBOX>\n",a+="  </ogc:Filter>\n"),a+="2.0.0"===this._version?" </Query>\n":" </wfs:Query>\n",a+="</GetFeature>\n",this._getFeatureRequest=a,this._getFeatureRequest},getFeature:function(){if(""!==this._getFeatureUrl&&""!==this._getFeatureRequest&&this._map&&null!==this._map.spatialReference.wkid){var e=this._getFeatureRequest;if("ondemand"===this._mode.toLowerCase()){var t=this._map.extent.xmin,r=this._map.extent.ymin,i=this._map.extent.xmax,s=this._map.extent.ymax,a={},o=this._map.spatialReference,l=new _(this._wkid),h=this._projectFromSRToSR(o,l,t,r,a);h&&(t=a.x,r=a.y);var m=this._projectFromSRToSR(o,l,i,s,a);m&&(i=a.x,s=a.y);var g=this._getFeatureRequest.replace(/{xmin}/,t),d=g.replace(/{ymin}/,r),u=d.replace(/{xmax}/,i);e=u.replace(/{ymax}/,s)}this._messageHandler("connect to wfs server...");var p=n({url:this._getFeatureUrl,handleAs:"text",headers:{"Content-Type":"text/xml"},postData:e,timeout:1e4},{usePost:!0});p.then(this._parseGml,this._messageHandler)}},getWFSParameters:function(){return{url:this._url,version:this._version,nsLayerName:this._nsLayerName,wkid:this._wkid,mode:this._mode,nsGeometryFieldName:this._nsGeometryFieldName,inverseFilter:this._inverseFilter,inverseResponse:this._inverseResponse,maxFeatures:this._maxFeatures,getFeatureUrl:this._getFeatureUrl,getFeatureRequest:this._getFeatureRequest,showDetails:this._showDetails}},setWFSParameters:function(e){e&&(e.url&&(this._url=e.url),e.version&&(this._version=e.version),e.nsLayerName&&(this._nsLayerName=e.nsLayerName),e.wkid&&(this._wkid=parseInt(e.wkid,10)),e.mode&&(this._mode=e.mode),void 0!==e.inverseFilter&&(this._inverseFilter=e.inverseFilter?!0:!1),void 0!==e.inverseResponse&&(this._inverseResponse=e.inverseResponse?!0:!1),e.maxFeatures&&(this._maxFeatures=parseInt(e.maxFeatures,10)),e.getFeatureRequest&&(this._getFeatureRequest=e.getFeatureRequest),e.getFeatureUrl&&(this._getFeatureUrl=e.getFeatureUrl),e.nsGeometryFieldName&&(this._nsGeometryFieldName=e.nsGeometryFieldName),e.showDetails&&(this._showDetails=e.showDetails))},setPointSymbol:function(e){this._pointSymbol=e},setLineSymbol:function(e){this._lineSymbol=e},setPolygonSymbol:function(e){this._polygonSymbol=e},_setMap:function(e){this._map=e;var t=this.inherited(arguments);return this._map&&this._layerEventHandlers.push(this._map.on("extent-change",r.hitch(this,"refresh"))),this.getFeature(),this.refresh(),t},_getCapabilitiesResponse:function(e){var t,r,i,s,a;this._messageHandler("done."),this._messageHandler("response parsing...");var n=new DOMParser,o=n.parseFromString(e,"text/xml"),l=o.documentElement.attributes;this._version=l.getNamedItem("version").value;var h="2.0.0"===this._version?"http://www.opengis.net/wfs/2.0":"http://www.opengis.net/wfs";if("2.0.0"===this._version){var m="http://www.opengis.net/ows/1.1";for(t=o.getElementsByTagNameNS(m,"Operation"),r=0;r<t.length;r++)s=t[r].attributes.getNamedItem("name"),s&&"GetFeature"===s.value&&(a=t[r].getElementsByTagNameNS(m,"Post"),this._getFeatureUrl=a[0].attributes.getNamedItem("xlink:href").value)}else if("1.1.0"===this._version){var g="http://www.opengis.net/ows";for(t=o.getElementsByTagNameNS(g,"Operation"),r=0;r<t.length;r++)s=t[r].attributes.getNamedItem("name"),s&&"GetFeature"===s.value&&(a=t[r].getElementsByTagNameNS(g,"Post"),this._getFeatureUrl=a[0].attributes.getNamedItem("xlink:href").value)}else if("1.0.0"===this._version){var d=o.getElementsByTagNameNS(h,"GetFeature");a=d[0].getElementsByTagNameNS(h,"Post"),this._getFeatureUrl=a[0].attributes.getNamedItem("onlineResource").value}var _=[],u=o.getElementsByTagNameNS(h,"FeatureTypeList");for(r=0;r<u.length;r++){var p=u[r],y=p.getElementsByTagNameNS(h,"FeatureType");for(i=0;i<y.length;i++){var f=y[i],N=f.getElementsByTagNameNS(h,"Name"),S=N[0].textContent,v=S.indexOf(":"),c=S.substring(0,v),w=S.substring(v+1),T=N[0].lookupNamespaceURI(c),E=f.getElementsByTagNameNS(h,"Title"),F=E.length>0?E[0].textContent:"",x=this._readDefaultSR(this._version,f),R=T+"|"+w;_.push({name:R,title:F,wkid:x,selected:R===this._nsLayerName?!0:!1})}}""===this._nsLayerName&&_.length>0&&(this._nsLayerName=_[0].name),this.buildRequest(),this._messageHandler("done.");var k=this._getCapabilitiesCallback;k&&(delete this._loadCallback,k(_)),this.getFeature()},_readDefaultSR:function(e,t){var r="";if("2.0.0"===e){var i=t.getElementsByTagNameNS("*","DefaultCRS");r=i[0].textContent}else if("1.1.0"===e){var s=t.getElementsByTagNameNS("*","DefaultSRS");r=s[0].textContent}else if("1.0.0"===e){var a=t.getElementsByTagNameNS("*","SRS");r=a[0].textContent}var n=r.match(/\d+/g);if(n&&n.length>0){var o=parseInt(n[n.length-1],10);return 84===o&&(o=4326),parseInt(o,10)}return-1},_messageHandler:function(e){this._showDetails&&console.log("WFSLayer: "+e)},_unsetMap:function(){for(var e=0;e<this._layerEventHandlers.length;e++)i.disconnect(this._layerEventHandlers[e]);this.refresh(),this.inherited(arguments)},refresh:function(){this.clear(),this.redraw(),"ondemand"===this._mode.toLowerCase()&&this._fireUpdateStart()},redraw:function(){if(this.visible){this._showDetails&&this._drawExtent();for(var e=0;e<this._graphicArray.length;e++){var t=this._graphicArray[e],r=t.geometry,i=null;"point"===r.type?i=this.renderer?this.renderer.getSymbol(null):this._pointSymbol:"multipoint"===r.type?i=this.renderer?this.renderer.getSymbol(null):this._pointSymbol:"polyline"===r.type?i=this.renderer?this.renderer.getSymbol(null):this._lineSymbol:"polygon"===r.type&&(i=this.renderer?this.renderer.getSymbol(null):this._polygonSymbol),t.setSymbol(i),this.add(t)}}},onUpdateStart:function(){this.getFeature()},onUpdateEnd:function(){this.clear(),this.redraw()},_parseGml:function(e){if(this._messageHandler("done."),this._map){this._messageHandler("response parsing...");var t=new DOMParser,r=t.parseFromString(e,"text/xml");this._gmlNS="2.0.0"===this._version?"http://www.opengis.net/gml/3.2":"http://www.opengis.net/gml",""===this._wkid&&(this._wkid=this._map.spatialReference.latestWkid);var i=this._nsLayerName.indexOf("|"),s=this._nsLayerName.substring(0,i),a=this._nsLayerName.substring(i+1),n=2;if(this._graphicArray=this._readFeatureMembers(r,this._wkid,n,s,a),this.fullExtent=this._createFullExtent(this._graphicArray),this._messageHandler("done."),this._messageHandler("got "+this._graphicArray.length+" features (close, but not same as 'maxFeatures')."),this.fields=[],this._graphicArray[0])for(var o=this._graphicArray[0].attributes,l=Object.keys(o),h=0;h<l.length;h++){var m={};m.type="esriFieldTypeString",m.name=l[h],m.alias=l[h],this.fields.push(m)}"ondemand"===this._mode.toLowerCase()?this._fireUpdateEnd():this.refresh()}},_createFullExtent:function(e){for(var t=null,r=0;r<e.length;r++){var i=e[r],s=i.geometry,a=null;a="point"===s.geometryType?new p(s.x,s.y,s.x,s.y,s.spatialReference):s.getExtent(),a&&(t=null===t?a:t.union(a))}return t},_drawExtent:function(){if(this.fullExtent){var e={geometryType:"polygon",spatialReference:this.fullExtent.spatialReference,rings:[[[this.fullExtent.xmin,this.fullExtent.ymin],[this.fullExtent.xmax,this.fullExtent.ymin],[this.fullExtent.xmax,this.fullExtent.ymax],[this.fullExtent.xmin,this.fullExtent.ymax],[this.fullExtent.xmin,this.fullExtent.ymin]]]},t=new S(e),r=new l(t),i=new d(d.STYLE_SOLID,null,new h([0,127,255,.1]));r.setSymbol(i),r.attributes={FullExtent:"",xmin:this.fullExtent.xmin,ymin:this.fullExtent.ymin,xmax:this.fullExtent.xmax,ymax:this.fullExtent.ymax},this.add(r)}},_readFeatureMembers:function(e,t,r,i,s){var a,n,o,l,h=this._readWkidFromNode(e);-1!=h&&(t=h);var m=this._readSrsDimension(e);0!==m&&(r=m);var g=[];for(o=e.getElementsByTagNameNS("*","featureMembers"),n=0;n<o.length;n++){var d=o[n];for(l=d.getElementsByTagNameNS(i,s),0===l.length&&(l=d.getElementsByTagNameNS(null,s)),0===l.length&&(l=d.getElementsByTagNameNS("*",s)),a=0;a<l.length;a++)this._readLayer(g,l[a],t,r)}for(o=e.getElementsByTagNameNS("*","featureMember"),n=0;n<o.length;n++)for(d=o[n],l=d.getElementsByTagNameNS(i,s),0===l.length&&(l=d.getElementsByTagNameNS(null,s)),0===l.length&&(l=d.getElementsByTagNameNS("*",s)),a=0;a<l.length;a++)this._readLayer(g,l[a],t,r);for(o=e.getElementsByTagNameNS("*","member"),n=0;n<o.length;n++)for(d=o[n],l=d.getElementsByTagNameNS(i,s),0===l.length&&(l=d.getElementsByTagNameNS(null,s)),0===l.length&&(l=d.getElementsByTagNameNS("*",s)),a=0;a<l.length;a++)this._readLayer(g,l[a],t,r);return g},_readLayer:function(e,t,r,i){var s,a,n,o=this._readSrsDimension(t);0!==o&&(i=o);var l=t.childNodes,h="",m=null;for(s=0;s<l.length;s++)if(a=l[s],1==a.nodeType&&(n=a.localName,"boundedBy"!==n)){var g=this._readGeometry(a,r,i);if(null!==g){m=g,h=n,this._nsGeometryFieldName=a.namespaceURI+"|"+a.localName;break}}if(!m)return void this._messageHandler("_readLayer(): warnining - no geometry found.");var d={};for(s=0;s<l.length;s++)a=l[s],n=a.localName,n!==h&&(d[n]=a.textContent.trim());this._convertWFSGeometryToGraphicObjects(e,m,d)},_convertWFSGeometryToGraphicObjects:function(e,t,r){var i;if("point"===t.geometryType){i=new l;var s=new y(t);i.setGeometry(s),i.setAttributes(r),e.push(i)}else if("multipoint"===t.geometryType){i=new l;var a=new f(t);i.setGeometry(a),i.setAttributes(r),e.push(i)}else if("polyline"===t.geometryType){i=new l;var n=new N(t);i.setGeometry(n),i.setAttributes(r),e.push(i)}else if("polygon"===t.geometryType){i=new l;var o=new S(t);i.setGeometry(o),i.setAttributes(r),e.push(i)}else if("multigeometry"===t.geometryType)for(var h=0;h<t.length;h++)this._convertWFSGeometryToGraphicObjects(e,t[h],r)},_readGeometry:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);if(0!==o&&(r=o),a=e.getElementsByTagNameNS(this._gmlNS,"MultiSurface"),a.length>=1)for(i=0;i<a.length;i++){var l=this._readMultiSurface(a[i],t,r);return l}if(a=e.getElementsByTagNameNS(this._gmlNS,"MultiCurve"),a.length>=1){var h=[];for(i=0;i<a.length;i++){var m=this._readMultiCurve(a[i],t,r);for(s=0;s<m.length;s++)h.push(m[s])}var g={geometryType:"polyline",paths:h,spatialReference:{wkid:this._map.spatialReference.latestWkid}};return g}for(a=e.getElementsByTagNameNS(this._gmlNS,"MultiGeometry"),i=0;i<a.length;i++)return this._readMultiGeometry(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Geometry"),i=0;i<a.length;i++)return this._readGeometry(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"GeometryCollection"),i=0;i<a.length;i++)return this._readGeometryCollection(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Surface"),i=0;i<a.length;i++)return this._readSurface(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Curve"),i=0;i<a.length;i++)return this._readCurve(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"MultiPolygon"),i=0;i<a.length;i++)return this._readMultiPolygon(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<a.length;i++)return this._readPolygon(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"MultiLineString"),i=0;i<a.length;i++)return this._readMultiLineString(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<a.length;i++){var d=this._readLineString(a[i],t,r),_={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}},u=[];for(s=0;s<d.length;s++)u.push(d[s]);return _.paths.push(u),_}for(a=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<a.length;i++)return this._readLinearRing(a[i],t,r);if(a=e.getElementsByTagNameNS(this._gmlNS,"Box"),a.length>=1)for(i=0;i<a.length;i++)return this._readBox(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Envelope"),i=0;i<a.length;i++)return this._readEnvelope(a[i],t,r);if(a=e.getElementsByTagNameNS(this._gmlNS,"MultiPoint"),a.length>=1)for(i=0;i<a.length;i++)return this._readMultiPoint(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<a.length;i++)return this._readPoint(a[i],t,r);return null},_readGeometryCollection:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"geometryMember"),i=0;i<s.length;i++){var l=this._readGeometryMember(s[i],t,r);o.push(l)}return o},_readMultiGeometry:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"geometryMember"),i=0;i<s.length;i++){var l=this._readGeometryMember(s[i],t,r);o.push(l)}return o},_readSurface:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<s.length;i++)o.push(this._readPoint(s[i],t,r));for(s=e.getElementsByTagNameNS(this._gmlNS,"patches"),i=0;i<s.length;i++)for(var l=this._readPatches(s[i],t,r),h=0;h<l.length;h++){var m=l[h];o.push(m)}return o},_readMultiSurface:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);0!==o&&(r=o);var l=[];for(l.geometryType="multigeometry",l.spatialReference={wkid:this._map.spatialReference.latestWkid},a=e.getElementsByTagNameNS(this._gmlNS,"surfaceMember"),i=0;i<a.length;i++){var h=this._readSurfaceMember(a[i],t,r);for(s=0;s<h.length;s++)l.push(h[s])}for(a=e.getElementsByTagNameNS(this._gmlNS,"surfaceMembers"),i=0;i<a.length;i++){var m=this._readSurfaceMembers(a[i],t,r);for(s=0;s<m.length;s++)l.push(m[s])}return l},_readCurve:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"segments"),i=0;i<s.length;i++)for(var l=this._readSegments(s[i],t,r),h=0;h<l.length;h++)o.paths.push(l[h]);return o},_readSegments:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"LineStringSegment"),i=0;i<s.length;i++){var l=this._readLineStringSegment(s[i],t,r);o.push(l)}return o},_readLineStringSegment:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"posList"),i=0;i<s.length;i++)return this._readPosList(s[i],t,r)},_readMultiCurve:function(e,t,r){var i,s,a,n,o=this._readWkidFromNode(e);-1!=o&&(t=o);var l=this._readSrsDimension(e);0!==l&&(r=l);var h=[];for(h.spatialReference={wkid:this._map.spatialReference.latestWkid},a=e.getElementsByTagNameNS(this._gmlNS,"curveMember"),i=0;i<a.length;i++)for(n=this._readCurveMember(a[i],t,r),s=0;s<n.length;s++)h.push(n[s]);for(a=e.getElementsByTagNameNS(this._gmlNS,"curveMembers"),i=0;i<a.length;i++)for(n=this._readCurveMembers(a[i],t,r),s=0;s<n.length;s++)h.push(n[s]);return h},_readGeometryMember:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);for(0!==o&&(r=o),a=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<a.length;i++)return this._readPoint(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<a.length;i++){var l=this._readLineString(a[i],t,r),h={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}},m=[];for(s=0;s<l.length;s++)m.push(l[s]);return h.paths.push(m),h}for(a=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<a.length;i++)return this._readPolygon(a[i],t,r);return null},_readSurfaceMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<s.length;i++){var l=this._readPolygon(s[i],t,r);o.push(l)}return o},_readSurfaceMembers:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<s.length;i++){var l=this._readPolygon(s[i],t,r);o.push(l)}return o},_readCurveMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<s.length;i++){var l=this._readLineString(s[i],t,r);o.push(l)}return o},_readCurveMembers:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<s.length;i++){var l=this._readLineString(s[i],t,r);o.push(l)}return o},_readBox:function(e,t,r){var i,s,a,n,o,l,h,m=this._readWkidFromNode(e);-1!=m&&(t=m);var g=this._readSrsDimension(e);0!==g&&(r=g);var d={geometryType:"polygon",rings:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<s.length;i++)if(a=this._readCoordinates(s[i],t,r))return a.length>=1&&(n=l=a[0][0],o=h=a[0][1]),a.length>=1&&(l=a[1][0],h=a[1][1]),d.rings.push([[n,o],[n,h],[l,h],[l,o],[n,o]]),d;if(s=e.getElementsByTagNameNS(this._gmlNS,"coord"),s.length>=2){var _=this._readCoord(s[0],t,r);_&&_.length>=1&&(n=l=_[0][0],o=h=_[0][1]);var u=this._readCoord(s[1],t,r);return u&&u.length>=1&&(l=u[0][0],h=u[0][1]),d.rings.push([[n,o],[n,h],[l,h],[l,o],[n,o]]),d}return null},_readEnvelope:function(e,t,r){var i,s,a,n,o=this._readWkidFromNode(e);-1!=o&&(t=o);var l=this._readSrsDimension(e);for(0!==l&&(r=l),s=e.getElementsByTagNameNS(this._gmlNS,"lowerCorner"),i=0;i<s.length;i++){var h=this._readCoordinates(s[i],t,r);h&&(a=h[0])}for(s=e.getElementsByTagNameNS(this._gmlNS,"upperCorner"),i=0;i<s.length;i++){var m=this._readCoordinates(s[i],t,r);m&&(n=m[0])}if(a&&n){var g={geometryType:"polygon",rings:[[[a[0],a[1]],[a[0],n[1]],[n[0],n[1]],[n[0],a[1]],[a[0],a[1]]]],spatialReference:{wkid:this._map.spatialReference.latestWkid}};return g}return null},_readPolygon:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);0!==o&&(r=o);var l={geometryType:"polygon",rings:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"outerBoundaryIs"),i=0;i<s.length;i++)a=this._readOuterBoundaryIs(s[i],t,r),l.rings.push(a);for(s=e.getElementsByTagNameNS(this._gmlNS,"innerBoundaryIs"),i=0;i<s.length;i++)a=this._readInnerBoundaryIs(s[i],t,r),l.rings.push(a);for(s=e.getElementsByTagNameNS(this._gmlNS,"exterior"),i=0;i<s.length;i++)a=this._readExterior(s[i],t,r),l.rings.push(a);for(s=e.getElementsByTagNameNS(this._gmlNS,"interior"),i=0;i<s.length;i++)a=this._readInterior(s[i],t,r),l.rings.push(a);return l},_readPolygonMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<s.length;i++)return this._readPolygon(s[i],t,r);return null},_readMultiPolygon:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"polygonMember"),i=0;i<s.length;i++){var l=this._readPolygonMember(s[i],t,r);o.push(l)}return o},_readOuterBoundaryIs:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readInnerBoundaryIs:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readExterior:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readInterior:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readPatches:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.spatialReference={wkid:this._map.spatialReference.latestWkid},s=e.getElementsByTagNameNS(this._gmlNS,"PolygonPatch"),i=0;i<s.length;i++)o.push(this._readPolygon(s[i],t,r));return o},_readLineString:function(e,t,r){var i,s,a,n,o,l=this._readWkidFromNode(e);-1!=l&&(t=l);var h=this._readSrsDimension(e);0!==h&&(r=h);var m=[];for(m.spatialReference={wkid:this._map.spatialReference.latestWkid},a=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<a.length;i++)if(n=this._readCoordinates(a[i],t,r))for(s=0;s<n.length;s++)o=n[s],m.push(o);for(a=e.getElementsByTagNameNS(this._gmlNS,"coord"),i=0;i<a.length;i++)if(n=this._readCoord(a[i],t,r))for(s=0;s<n.length;s++)o=n[s],m.push(o);for(a=e.getElementsByTagNameNS(this._gmlNS,"posList"),i=0;i<a.length;i++)if(n=this._readPosList(a[i],t,r))for(s=0;s<n.length;s++)o=n[s],m.push(o);return m},_readLineStringMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<s.length;i++)return this._readLineString(s[i],t,r);return null},_readMultiLineString:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"lineStringMember"),i=0;i<s.length;i++){var l=this._readLineStringMember(s[i],t,r);l&&o.paths.push(l)}return o.paths.length>=1?o:null},_readPoint:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);for(0!==o&&(r=o),s=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<s.length;i++)if(a=this._readCoordinates(s[i],t,r))return{geometryType:"point",x:a[0][0],y:a[0][1],spatialReference:{wkid:this._map.spatialReference.latestWkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"pos"),i=0;i<s.length;i++){var l=this._readPos(s[i],t,r);if(l&&l.length>0)return{geometryType:"point",x:l[0][0],y:l[0][1],spatialReference:{wkid:this._map.spatialReference.latestWkid}}}for(s=e.getElementsByTagNameNS(this._gmlNS,"coord"),i=0;i<s.length;i++){var h=this._readCoord(s[i],t,r);if(h){var m={geometryType:"point",x:h[0][0],y:h[0][1],spatialReference:{wkid:this._map.spatialReference.latestWkid}};return m}}return null},_readPointMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<s.length;i++)return this._readPoint(s[i],t,r);return null},_readMultiPoint:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o={geometryType:"multipoint",points:[],spatialReference:{wkid:this._map.spatialReference.latestWkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"pointMember"),i=0;i<s.length;i++){var l=this._readPointMember(s[i],t,r);l&&o.points.push([l.x,l.y])}return o.points.length>=1?o:null},_readLinearRing:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<s.length;i++)return this._readCoordinates(s[i],t,r);for(s=e.getElementsByTagNameNS(this._gmlNS,"posList"),i=0;i<s.length;i++)return this._readCoordinates(s[i],t,r);for(s=e.getElementsByTagNameNS(this._gmlNS,"pos"),i=0;i<s.length;i++)return this._readPos(s[i],t,r)},_readCoordinatesBody:function(e,t,r){var i,s,a=new _(e);t=t.trim();var n,o,l,h=[];h.spatialReference={wkid:this._map.spatialReference.latestWkid};var m=this._isReverse(e,this.version);if(t)if(2===r){if(i=t.match(/[0123456789.\-\+eE]+/g),i&&i.length>=2)for(n=0;n<i.length;n+=2){o=parseFloat(i[n]),l=parseFloat(i[n+1]),m&&(s=l,l=o,o=s);var g={};this._projectFromSRToSR(a,this._map.spatialReference,o,l,g)&&(o=g.x,l=g.y),h.push([o,l])}}else if(3===r&&(i=t.match(/[0123456789.\-\+eE]+/g),i&&i.length>=3))for(n=0;n<i.length;n+=3){o=parseFloat(i[n]),l=parseFloat(i[n+1]),m&&(s=l,l=o,o=s);var d={};this._projectFromSRToSR(a,this._map.spatialReference,o,l,d)&&(o=d.x,l=d.y),h.push([o,l])}return h},_readCoord:function(e,t,r){var i,s,a,n,o=this._readWkidFromNode(e);-1!=o&&(t=o);var l=new _(t),h=this._readSrsDimension(e);0!==h&&(r=h);var m=this._isReverse(t,this.version),g=[];for(g.spatialReference={wkid:this._map.spatialReference.latestWkid},a=0,s=e.getElementsByTagNameNS(this._gmlNS,"X"),i=0;i<s.length;i++){a=this._readFloat(s[i],t,r);break}for(n=0,s=e.getElementsByTagNameNS(this._gmlNS,"Y"),i=0;i<s.length;i++){n=this._readFloat(s[i],t,r);break}if(m){var d=n;n=a,a=d}var u={};return this._projectFromSRToSR(l,this._map.spatialReference,a,n,u)&&(a=u.x,n=u.y),g.push(m?[n,a]:[a,n]),g},_readCoordinates:function(e,t,r){var i=this._readWkidFromNode(e);-1!=i&&(t=i);var s=this._readSrsDimension(e);0!==s&&(r=s);var a=e.textContent;return this._readCoordinatesBody(t,a,r)},_readPos:function(e,t,r){var i=this._readWkidFromNode(e);-1!=i&&(t=i);var s=this._readSrsDimension(e);0!==s&&(r=s);var a=e.textContent;return this._readCoordinatesBody(t,a,r)},_readPosList:function(e,t,r){var i=this._readWkidFromNode(e);-1!=i&&(t=i);var s=this._readSrsDimension(e);0!==s&&(r=s);var a=e.textContent;return this._readCoordinatesBody(t,a,r)},_projectFromSRToSR:function(e,t,r,i,s){if(u.canProject(e,t)){var a=new y(r,i,e),n=u.project(a,t);return s.x=n.x,s.y=n.y,!0}return s.x=r,s.y=i,!1},_readFloat:function(e){var t=e.textContent;return t?parseFloat(t):0},_readSrsDimension:function(e){if(e.attributes){var t=e.attributes.getNamedItem("srsDimension");if(t)return parseInt(t.value,10)}return 0},_readWkidFromNode:function(e){if(e.attributes){var t=e.attributes.getNamedItem("srsName");if(t){var r=t.value,i=r.match(/\d+/g);if(i&&i.length>0){var s=parseInt(i[i.length-1],10);return 84===s&&(s=4326),parseInt(s,10)}}}return-1},_isReverse:function(){return this._inverseResponse}});return s("extend-esri")&&r.setObject("layers.WFSLayer",c,o),c});