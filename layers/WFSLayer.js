// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/kernel","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/has","dojo/on","../request","../kernel","../graphic","../renderers/jsonUtils","../symbols/jsonUtils","../Color","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../SpatialReference","../geometry/webMercatorUtils","../geometry/Extent","../geometry/Point","../geometry/Multipoint","../geometry/Polyline","../geometry/Polygon","./LabelClass","./GraphicsLayer"],function(e,t,r,i,s,a,n,o,l,m,h,g,d,u,p,y,_,f,c,N,S,v,T,b,w){var F=e([w],{declaredClass:"esri.layers.WFSLayer",constructor:function(e){this.layerNamespace="",this.getFeatureUrl="",this.describeFeatureTypeUrl="",this.geometryType="",this.fields=[],this.spatialReferences=[],this.fullExtent=null,this.visible=!0,this.renderer=null,this.id="WFSLayer",this._url="",this._version="1.1.0",this._layerName="",this._nsLayerNames={},this._layerDefinedGeometryType="esriGeometryComplex",this._wkid=3857,this._mode="snapshot",this._maxFeatures=100,this._inverseFilter=!1,this._inverseResponse=!1,this._nsFields="",this._getFeatureRequest="",this._nsGeometryFieldName="",this._graphicArray=[],this._gmlNS="http://www.opengis.net/gml",this._layerEventHandlers=[],this._getCapabilitiesCallback=null,this._describeFeatureTypeCallback=null,this.customParameters=null,this.showLabels=!0,this.labelingInfo=null,e&&(e.id&&(this.id=e.id),this.showLabels=null!==e.showLabels?e.showLabels:!0),this.onError=r.hitch(this,this.onError),this._errorSupport=r.hitch(this,this._errorSupport),this._parseGml=r.hitch(this,this._parseGml),this._getCapabilities=r.hitch(this,this._getCapabilities),this._getCapabilitiesResponse=r.hitch(this,this._getCapabilitiesResponse),this._describeFeatureTypeResponse=r.hitch(this,this._describeFeatureTypeResponse),this._pointSymbol=new u(u.STYLE_CIRCLE,6,new p(p.STYLE_SOLID,new d([0,255,0]),1),new d([255,0,0])),this._lineSymbol=new p(p.STYLE_SOLID,new d([0,255,0]),3),this._polygonSymbol=new y(y.STYLE_SOLID,new p(p.STYLE_SOLID,new d([255,0,0]),2),new d([255,255,0,.25])),this.loaded=!1,this._isProjectedOk=!0},initialize:function(e,t){e.id&&(this.id=e.id),e.url&&(this._url=e.url),e.version&&(this._version=e.version),this.customParameters=e.customParameters,this._getCapabilities(t)},selectLayer:function(e,t){this._layerName=e.layerName,this._wkid=e.wkid,this._mode=e.mode,this._maxFeatures=e.maxFeatures,this._inverseResponse=e.swapXY,this._inverseFilter=e.swapXYFilter,this.geometryType=e.geometryType,this._describeFeatureType(t),this.loaded=!0},toJson:function(){var e={};return e.id=this.id,e.url=this._url,e.version=this._version,e.mode="snapshot"===this._mode?0:1,e.name=this._layerName,e.geometryType=this.geometryType,e.wkid=this._wkid,e.maxFeatures=this._maxFeatures,e.swapXY=this._inverseResponse,e.swapXYFilter=this._inverseFilter,e.pointSymbol=this._pointSymbol.toJson(),e.lineSymbol=this._lineSymbol.toJson(),e.polygonSymbol=this._polygonSymbol.toJson(),e.showLabels=this.showLabels,this.labelingInfo&&(e.labelingInfo=i.map(this.labelingInfo,function(e){return e.toJson()})),this.customParameters&&(e.customParameters=this.customParameters),e},fromJson:function(e,t){e.id&&(this.id=e.id),e.url&&(this._url=e.url),e.version&&(this._version=e.version),e.mode&&(this._mode=0===e.mode?"snapshot":"onDemand"),e.name&&(this._layerName=e.name),e.geometryType&&(this.geometryType=e.geometryType),e.wkid&&(this._wkid=e.wkid),e.maxFeatures&&(this._maxFeatures=e.maxFeatures),e.swapXY&&(this._inverseResponse=e.swapXY),e.swapXYFilter&&(this._inverseFilter=e.swapXYFilter),e.pointSymbol&&(this._pointSymbol=g.fromJson(e.pointSymbol)),e.lineSymbol&&(this._lineSymbol=g.fromJson(e.lineSymbol)),e.polygonSymbol&&(this._polygonSymbol=g.fromJson(e.polygonSymbol)),this.showLabels=null!=e.showLabels?e.showLabels:!0,e.labelingInfo&&(this.labelingInfo=i.map(e.labelingInfo,function(e){return new b(e)})),this.customParameters=e.customParameters,this._getCapabilities(t),this.loaded=!0},setPointSymbol:function(e){this._pointSymbol=e},setLineSymbol:function(e){this._lineSymbol=e},setPolygonSymbol:function(e){this._polygonSymbol=e},_setMap:function(e){this._map=e;var t=this.inherited(arguments);return this._map&&(this._layerEventHandlers.push(this._map.on("extent-change",r.hitch(this,"refresh"))),this._layerEventHandlers.push(this.on("visibility-change",r.hitch(this,"_visibilityChange")))),this._getFeature(),this.refresh(),t},_unsetMap:function(){for(var e=0;e<this._layerEventHandlers.length;e++)s.disconnect(this._layerEventHandlers[e]);this.refresh(),this.inherited(arguments)},refresh:function(e){this.clear(),this.redraw(),"ondemand"===this._mode.toLowerCase()&&this._fireUpdateStart()},redraw:function(){if(this.visible)for(var e=0;e<this._graphicArray.length;e++){var t=this._graphicArray[e],r=t.geometry,i=null;"point"===r.type?i=this.renderer?this.renderer.getSymbol(t):this._pointSymbol:"multipoint"===r.type?i=this.renderer?this.renderer.getSymbol(t):this._pointSymbol:"polyline"===r.type?i=this.renderer?this.renderer.getSymbol(t):this._lineSymbol:"polygon"===r.type&&(i=this.renderer?this.renderer.getSymbol(t):this._polygonSymbol),t.setSymbol(i),this.add(t)}},_visibilityChange:function(e){this.visible=e.visible,this.redraw()},onUpdateStart:function(){this._getFeature()},onUpdateEnd:function(){this.clear(),this.redraw()},setLabelingInfo:function(e){e?(this.labelingInfo=e,this._fixLabelExpr()):delete this.labelingInfo,this.onLabelingInfoChange()},onLabelingInfoChange:function(){},_fixLabelExpr:function(){var e,t=/\[([^\[\]]+)\]/gi,r=this,s=function(e,t){var i=r._getField(t,!0);return"["+(i&&i.name||t)+"]"};i.forEach(this.labelingInfo,function(r){e=r.labelExpression,e&&(r.labelExpression=e.replace(t,s))})},_getField:function(e,t){var r=this.fields;if(!r||0===r.length)return null;var s;return t&&(e=e.toLowerCase()),i.some(r,function(r){var i=!1;return i=t?r&&r.name.toLowerCase()===e?!0:!1:r&&r.name===e?!0:!1,i&&(s=r),i}),s},setCustomParameters:function(e){this.customParameters=e,this._getFeature(),this.refresh()},_getCapabilities:function(e){this._getCapabilitiesCallback=e;var t=r.trim(this._url);if(""===t)return void this.onError("WFSLayer: url is invalid");if("1.0.0"!==this._version&&"1.1.0"!==this._version&&"2.0.0"!==this._version)return void this.onError("WFSLayer: version is invalid");if(""!==t){var i=t.indexOf("?"),s=-1===i?"?":"&",a=t+s+"service=WFS&request=GetCapabilities&version="+this._version;a=this._appendCustomParameters(a);var n=o({url:a,handleAs:"text",headers:{"Content-Type":null}},{usePost:!1});n.then(this._getCapabilitiesResponse,this._errorSupport)}},_errorSupport:function(e){this.onError(e)},_getCapabilitiesResponse:function(e){var t,r,i,s,a,n=new DOMParser;try{var o=n.parseFromString(e,"text/xml"),l=this._readExceptionReport(o,e);if(l)return void this.onError("WFSLayer: getCapabilities - returns exception: "+l);var m=o.documentElement.attributes,h=m.getNamedItem("version");if(!h)return void this.onError("WFSLayer: getCapabilities - document not recognized.");this._version=h.value;var g="2.0.0"===this._version?"http://www.opengis.net/wfs/2.0":"http://www.opengis.net/wfs";if("2.0.0"===this._version){var d="http://www.opengis.net/ows/1.1";for(t=o.getElementsByTagNameNS(d,"Operation"),r=0;r<t.length;r++)s=t[r].attributes.getNamedItem("name"),s&&"DescribeFeatureType"===s.value&&(getList=t[r].getElementsByTagNameNS(d,"Get"),this.describeFeatureTypeUrl=getList[0].attributes.getNamedItem("xlink:href").value),s&&"GetFeature"===s.value&&(a=t[r].getElementsByTagNameNS(d,"Post"),this.getFeatureUrl=a[0].attributes.getNamedItem("xlink:href").value)}else if("1.1.0"===this._version){var u="http://www.opengis.net/ows";for(t=o.getElementsByTagNameNS(u,"Operation"),r=0;r<t.length;r++)s=t[r].attributes.getNamedItem("name"),s&&"DescribeFeatureType"===s.value&&(getList=t[r].getElementsByTagNameNS(u,"Get"),this.describeFeatureTypeUrl=getList[0].attributes.getNamedItem("xlink:href").value),s&&"GetFeature"===s.value&&(a=t[r].getElementsByTagNameNS(u,"Post"),a&&a.length&&(this.getFeatureUrl=a[0].attributes.getNamedItem("xlink:href").value))}else if("1.0.0"===this._version){var p=o.getElementsByTagNameNS(g,"DescribeFeatureType");if(!p||!p.length)return void this.onError("WFSLayer: getCapabilities - no describeFeatureType info");getList=p[0].getElementsByTagNameNS(g,"Get"),this.describeFeatureTypeUrl=getList[0].attributes.getNamedItem("onlineResource").value;var y=o.getElementsByTagNameNS(g,"GetFeature");if(!y||!y.length)return void this.onError("WFSLayer: getCapabilities - no GetFeature info");a=y[0].getElementsByTagNameNS(g,"Post"),a&&a.length&&(this.getFeatureUrl=a[0].attributes.getNamedItem("onlineResource").value)}this._nsLayerNames={};var _=[],f=o.getElementsByTagNameNS(g,"FeatureTypeList");for(r=0;r<f.length;r++){var c=f[r],N=c.getElementsByTagNameNS(g,"FeatureType");for(i=0;i<N.length;i++){var S=N[i],v=S.getElementsByTagNameNS(g,"Name")[0],T=v.textContent,b=T.indexOf(":"),w=T.substring(0,b),F=T.substring(b+1),E=v.lookupNamespaceURI(w);null===E&&(E=v.lookupNamespaceURI(null)),this._nsLayerNames[F]={prefix:w,namespace:E};var k=S.getElementsByTagNameNS(g,"Title"),x=k.length>0?k[0].textContent:"";""===x&&(x=F),this.spatialReferences=this._readFactoryCodes(this._version,S);var R=this._readDefaultBBOX(this._version,S);_.push({name:F,title:x,spatialReferences:this.spatialReferences,extent:R})}}this._describeFeatureType();var B=this._getCapabilitiesCallback;B&&B(_)}catch(L){this.onError("WFSLayer: getCapabilities - parsing error")}},_readFactoryCodes:function(e,t){var r,i,s=[];if("2.0.0"===e||"1.1.0"===e){for(r=t.getElementsByTagNameNS("*","DefaultSRS"),this._addCodeList(s,r[0]),r=t.getElementsByTagNameNS("*","DefaultCRS"),this._addCodeList(s,r[0]),r=t.getElementsByTagNameNS("*","OtherSRS"),i=0;i<r.length;i++)this._addCodeList(s,r[i]);for(r=t.getElementsByTagNameNS("*","OtherCRS"),i=0;i<r.length;i++)this._addCodeList(s,r[i])}else"1.0.0"===e&&(r=t.getElementsByTagNameNS("*","SRS"),this._addCodeList(s,r[0]));for(var a=!1,n=0;n<s.length;n++){4326===s[n]&&(a=!0);break}return a||s.push(4326),s},_addCodeList:function(e,t){if(t){var r=t.textContent.match(/\d+/g);if(r.length>0){var i=parseInt(r[r.length-1],10);84===i&&(i=4326),e.push(i)}}},_readDefaultBBOX:function(e,t){var r,i,s,a,n;if("2.0.0"===e||"1.1.0"===e){if(r=t.getElementsByTagNameNS("*","WGS84BoundingBox"),!r[0]||!r[0].attributes)return[];var o=r[0].getElementsByTagNameNS("*","LowerCorner"),l=r[0].getElementsByTagNameNS("*","UpperCorner");if(o.length<=0||l.length<=0)return[];var m=o[0].textContent,h=m.indexOf(" ");i=m.substring(0,h),s=m.substring(h+1);var g=l[0].textContent,d=g.indexOf(" ");a=g.substring(0,d),n=g.substring(d+1)}else if("1.0.0"===e){if(r=t.getElementsByTagNameNS("*","LatLongBoundingBox"),!r[0]||!r[0].attributes)return[];i=r[0].attributes.getNamedItem("minx").value,s=r[0].attributes.getNamedItem("miny").value,a=r[0].attributes.getNamedItem("maxx").value,n=r[0].attributes.getNamedItem("maxy").value}var u=parseFloat(i,10),p=parseFloat(s,10),y=parseFloat(a,10),_=parseFloat(n,10);return[u,p,y,_]},_describeFeatureType:function(e){if(""!==this._layerName){if(""===this.describeFeatureTypeUrl)return void this.onError("WFSLayer: invalid describeFeatureType url");if(""===this._wkid)return void this.onError("WFSLayer: invalid wkid");if("snapshot"!==this._mode&&"onDemand"!==this._mode)return void this.onError("WFSLayer: invalid mode");if(""===this._maxFeatures||this._maxFeatures<0||this._maxFeatures>1e6)return void this.onError("WFSLayer: invalid maxFeatures");this._describeFeatureTypeCallback=e;var t=r.trim(this.describeFeatureTypeUrl);if(""!==t){var i=t.indexOf("?"),s=-1===i?"?":"&",a=this._nsLayerNames[this._layerName];if(void 0===a)return void this.onError("WFSLayer: invalid layerName");var n=a.prefix,l=a.namespace,m=t+s+"service=WFS&request=DescribeFeatureType&version="+this._version;m+="&typeName=",""!==n&&(m+=n+":"),m+=this._layerName,""!==n&&(m+="&namespace=xmlns("+n+"="+l+")"),m=this._appendCustomParameters(m);var h=o({url:m,handleAs:"text",headers:{"Content-Type":null}},{usePost:!1});h.then(this._describeFeatureTypeResponse,this._errorSupport)}}},_describeFeatureTypeResponse:function(e){var t,r=new DOMParser,i=r.parseFromString(e,"text/xml"),s=this._readExceptionReport(i,e);if(s)return void this.onError("WFSLayer: DescribeFeatureType - returns exception: "+s);this.fields=[];var a=i.getElementsByTagNameNS("http://www.w3.org/2001/XMLSchema","schema");for(t=0;t<a.length;t++){var n=a[t],o=this._readAllFields(n);null!==o&&(this._layerDefinedGeometryType=o[0],this.fields=o[1])}for(this.geometryType&&""!==this.geometryType||(this.geometryType=this._layerDefinedGeometryType),t=0;t<this.fields.length;t++){var l=this.fields[t];"esriFieldTypeGeometry"===l.type&&(this._nsGeometryFieldName=l.name)}if(this.layerNamespace=this._nsLayerNames[this._layerName].namespace,0===this.fields.length)return void this.onError("WFSLayer: DescribeFeatureType - can't get fields");this._getFeature();var m=this._describeFeatureTypeCallback;m&&m(this.fields)},_readAllFields:function(e){for(var t=e.childNodes,r=0;r<t.length;r++){var i=t[r];if("element"===i.localName){var s=i.attributes,a=s.name.value;if(a===this._layerName){var n=s.type;if(n){var o=n.value,l=o.indexOf(":"),m=o.substring(l+1);return this._readFieldsFromGlobalComplextType(e,m)}return this._readFieldsFromLocalComplextType(i)}}}return null},_readFieldsFromGlobalComplextType:function(e,t){for(var r=e.childNodes,i=0;i<r.length;i++){var s=r[i];if("complexType"===s.localName){var a=s.attributes,n=a.name.value;if(n===t)return this._readFieldsFromLocalComplextType(s)}}return null},_readFieldsFromLocalComplextType:function(e){for(var t=[],r="esriGeometryComplex",i=e.getElementsByTagNameNS("http://www.w3.org/2001/XMLSchema","element"),s=0;s<i.length;s++){var a=i[s],n="",o=a.attributes.getNamedItem("name");if(o&&(n=o.value),""!==n){var l="",m="",h=a.attributes.getNamedItem("type"),g="unknown";if(null!==h){var d=h.value,u=d.indexOf(":");l=d.substring(0,u),m=d.substring(u+1),g=h.lookupNamespaceURI(l),null===g&&(g=h.lookupNamespaceURI(null))}var p="Unknown";switch(m){case"integer":case"nonPositiveInteger":case"negativeInteger":case"long":case"int":case"short":case"byte":case"nonNegativeInteger":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":case"positiveInteger":p="esriFieldTypeInteger",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"float":case"double":case"decimal":p="esriFieldTypeDouble",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"boolean":case"string":case"gYearMonth":case"gYear":case"gMonthDay":case"gDay":case"gMonth":case"anyURI":case"QName":case"NOTATION":case"normalizedString":case"token":case"language":case"IDREFS":case"ENTITIES":case"NMTOKEN":case"NMTOKENS":case"Name":case"NCName":case"ID":case"IDREF":case"ENTITY":p="esriFieldTypeString",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"duration":case"dateTime":case"time":case"date":p="esriFieldTypeDate",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"PointPropertyType":case"MultiPointPropertyType":p="esriFieldTypeGeometry",r="esriGeometryPoint",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"MultiCurvePropertyType":case"MultiLineStringPropertyType":p="esriFieldTypeGeometry",r="esriGeometryPolyline",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"MultiSurfacePropertyType":case"MultiPolygonPropertyType":p="esriFieldTypeGeometry",r="esriGeometryPolygon",t.push({name:n,alias:n,type:p,wfsNamespace:g});break;case"GeometryPropertyType":case"MultiGeometryPropertyType":p="esriFieldTypeGeometry",r="esriGeometryComplex",t.push({name:n,alias:n,type:p,wfsNamespace:g})}}}return[r,t]},_getFeature:function(){var e="";e+="<?xml version='1.0' encoding='utf-8'?>\n",e+="<GetFeature \n",e+=" xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'\n",e+=" xmlns:gml='http://www.opengis.net/gml'\n",e+=" xmlns:ogc='http://www.opengis.net/ogc'\n",e+=" xmlns:wfs='http://www.opengis.net/wfs'\n",e+="2.0.0"===this._version?" xmlns='http://www.opengis.net/wfs/2.0'\n":" xmlns='http://www.opengis.net/wfs'\n";var t=this._nsLayerNames[this._layerName];if(void 0===t)return void this.onError("WFSLayer: invalid layerName");var r=t.prefix,i=t.namespace;if("ondemand"===this._mode.toLowerCase()&&""===this._nsGeometryFieldName)return void this.onError("WFSLayer: GetFeature - can't use 'onDemand' mode as geometryFieldName is unknown.");if(e+=" xmlns:"+r+"='"+i+"'\n",e+="2.0.0"===this._version?" version='"+this._version+"' service='WFS' count='"+this._maxFeatures+"'>\n":" version='"+this._version+"' service='WFS' maxFeatures='"+this._maxFeatures+"'>\n",e+="2.0.0"===this._version?" <Query typeNames='"+r+":"+this._layerName+"' srsName='EPSG:"+this._wkid+"'>\n":" <wfs:Query typeName='"+r+":"+this._layerName+"' srsName='EPSG:"+this._wkid+"'>\n","ondemand"===this._mode.toLowerCase()&&(e+="  <ogc:Filter xmlns:ogc='http://www.opengis.net/ogc'>\n",e+="   <ogc:BBOX>\n",e+="    <ogc:PropertyName>"+r+":"+this._nsGeometryFieldName+"</ogc:PropertyName>\n",e+="    <gml:Box srsName='EPSG:"+this._wkid+"'>\n",e+=this._inverseFilter?"      <gml:coordinates>{ymin},{xmin} {ymax},{xmax}</gml:coordinates>\n":"      <gml:coordinates>{xmin},{ymin} {xmax},{ymax}</gml:coordinates>\n",e+="    </gml:Box>\n",e+="   </ogc:BBOX>\n",e+="  </ogc:Filter>\n"),e+="2.0.0"===this._version?" </Query>\n":" </wfs:Query>\n",e+="</GetFeature>\n",this._getFeatureRequest=e,""===this.getFeatureUrl)return void this.onError("WFSLayer: getFeature - server doesn't support POST method.");if(""!==this._getFeatureRequest&&this._map&&null!==this._map.spatialReference.wkid){var s=this._getFeatureRequest;if("ondemand"===this._mode.toLowerCase()){var a=this._map.extent.xmin,n=this._map.extent.ymin,l=this._map.extent.xmax,m=this._map.extent.ymax,h={},g=this._map.spatialReference,d=new _(this._wkid),u=this._projectFromSRToSR(g,d,a,n,h);u&&(a=h.x,n=h.y);var p=this._projectFromSRToSR(g,d,l,m,h);p&&(l=h.x,m=h.y);var y=this._getFeatureRequest.replace(/{xmin}/,a),f=y.replace(/{ymin}/,n),c=f.replace(/{xmax}/,l);s=c.replace(/{ymax}/,m)}var N=this._appendCustomParameters(this.getFeatureUrl),S=o({url:N,handleAs:"text",headers:{"Content-Type":"text/xml"},postData:s},{usePost:!0});S.then(this._parseGml,this._errorSupport)}},_parseGml:function(e){if(this._map&&this._map.spatialReference&&this._map.spatialReference.wkid){var t=new DOMParser,r=t.parseFromString(e,"text/xml"),i=this._readExceptionReport(r,e);if(i)return void this.onError("WFSLayer: GetFeature - returns exception: "+i);this._gmlNS="2.0.0"===this._version?"http://www.opengis.net/gml/3.2":"http://www.opengis.net/gml",""===this._wkid&&(this._wkid=this._map.spatialReference.wkid);var s=2,a=this._nsLayerNames[this._layerName],n=a.namespace;this._graphicArray=this._readFeatureMembers(r,this._wkid,s,n,this._layerName),this.fullExtent=this._createFullExtent(this._graphicArray),this.onLabelingInfoChange(),"ondemand"===this._mode.toLowerCase()?this._fireUpdateEnd():this.refresh()}},_limit4326:function(e){for(var t=0;t<e.length;t++){var r=e[t],i=r.geometry;4326===i.spatialReference.wkid&&(i.x=this._limit4326X(i.x),i.y=this._limit4326Y(i.y))}},_limit4326X:function(e){return e>=180&&(e=179.99),-180>=e&&(e=-179.99),e},_limit4326Y:function(e){return e>=90&&(e=89.99),-90>=e&&(e=-89.99),e},_createFullExtent:function(e){for(var t=null,r=0;r<e.length;r++){var i=e[r],s=i.geometry,a=null;a="point"===s.geometryType?new c(s.x,s.y,s.x,s.y,s.spatialReference):s.getExtent(),a&&(t=null===t?a:t.union(a))}return t},_readExceptionReport:function(e,t){var r=e.getElementsByTagNameNS("*","ExceptionReport");if(r.length>0)return t;var i=e.getElementsByTagNameNS("*","ServiceExceptionReport");return i.length>0?t:""},_readFeatureMembers:function(e,t,r,i,s){var a,n,o,l,m,h=this._readWkidFromNode(e);-1!=h&&(t=h);var g=this._readSrsDimension(e);0!==g&&(r=g);var d=[];for(l=e.getElementsByTagNameNS("*","featureMembers"),n=0;n<l.length;n++)for(o=l[n],m=o.getElementsByTagNameNS(i,s),0===m.length&&(m=o.getElementsByTagNameNS(null,s)),0===m.length&&(m=o.getElementsByTagNameNS("*",s)),a=0;a<m.length;a++)this._readLayer(d,m[a],t,r);for(l=e.getElementsByTagNameNS("*","featureMember"),n=0;n<l.length;n++)for(o=l[n],m=o.getElementsByTagNameNS(i,s),0===m.length&&(m=o.getElementsByTagNameNS(null,s)),0===m.length&&(m=o.getElementsByTagNameNS("*",s)),a=0;a<m.length;a++)this._readLayer(d,m[a],t,r);for(l=e.getElementsByTagNameNS("*","member"),n=0;n<l.length;n++)for(o=l[n],m=o.getElementsByTagNameNS(i,s),0===m.length&&(m=o.getElementsByTagNameNS(null,s)),0===m.length&&(m=o.getElementsByTagNameNS("*",s)),a=0;a<m.length;a++)this._readLayer(d,m[a],t,r);return d},_readLayer:function(e,t,r,i){var s,a,n,o=this._readSrsDimension(t);0!==o&&(i=o);var l=t.childNodes,m="",h=null;for(s=0;s<l.length;s++)if(a=l[s],1==a.nodeType&&(n=a.localName,"boundedBy"!==n)){var g=this._readGeometry(a,r,i);if(!this._isProjectedOk){this._isProjectedOk=!0,console.error("WFSLayer: could not project geometry.");break}if(null!==g){h=g,m=n;break}}if(h){var d={};for(s=0;s<l.length;s++){a=l[s],n=a.localName;var u=a.textContent;if(n!==m)for(var p=0;p<this.fields.length;p++){var y=this.fields[p];y.name==n&&("esriFieldTypeDouble"===y.type?d[n]=parseFloat(u,10):"esriFieldTypeInteger"===y.type?d[n]=parseInt(u,10):d[n]=u.trim())}}this._convertWFSGeometryToGraphicObjects(e,h,d)}},_convertWFSGeometryToGraphicObjects:function(e,t,r){var i;if("point"!==t.geometryType||"esriGeometryPoint"!==this.geometryType&&"esriGeometryComplex"!==this.geometryType)if("multipoint"!==t.geometryType||"esriGeometryPoint"!==this.geometryType&&"esriGeometryComplex"!==this.geometryType)if("polyline"!==t.geometryType||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryComplex"!==this.geometryType)if("polygon"!==t.geometryType||"esriGeometryPolygon"!==this.geometryType&&"esriGeometryComplex"!==this.geometryType){if("multigeometry"===t.geometryType)for(var s=0;s<t.length;s++)this._convertWFSGeometryToGraphicObjects(e,t[s],r)}else{i=new m;var a=new T(t);i.setGeometry(a),i.setAttributes(r),e.push(i)}else{i=new m;var n=new v(t);i.setGeometry(n),i.setAttributes(r),e.push(i)}else{i=new m;var o=new S(t);i.setGeometry(o),i.setAttributes(r),e.push(i)}else{i=new m;var l=new N(t);i.setGeometry(l),i.setAttributes(r),e.push(i)}},_readGeometry:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);if(0!==o&&(r=o),a=e.getElementsByTagNameNS(this._gmlNS,"MultiSurface"),a.length>=1)for(i=0;i<a.length;i++){var l=this._readMultiSurface(a[i],t,r);return l}if(a=e.getElementsByTagNameNS(this._gmlNS,"MultiCurve"),a.length>=1){var m=[];for(i=0;i<a.length;i++){var h=this._readMultiCurve(a[i],t,r);for(s=0;s<h.length;s++)m.push(h[s])}var g={geometryType:"polyline",paths:m,spatialReference:{wkid:this._map.spatialReference.wkid}};return g}for(a=e.getElementsByTagNameNS(this._gmlNS,"MultiGeometry"),i=0;i<a.length;i++)return this._readMultiGeometry(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Geometry"),i=0;i<a.length;i++)return this._readGeometry(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"GeometryCollection"),i=0;i<a.length;i++)return this._readGeometryCollection(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Surface"),i=0;i<a.length;i++)return this._readSurface(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Curve"),i=0;i<a.length;i++)return this._readCurve(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"MultiPolygon"),i=0;i<a.length;i++)return this._readMultiPolygon(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<a.length;i++)return this._readPolygon(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"MultiLineString"),i=0;i<a.length;i++)return this._readMultiLineString(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<a.length;i++){var d=this._readLineString(a[i],t,r),u={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.wkid}},p=[];for(s=0;s<d.length;s++)p.push(d[s]);return u.paths.push(p),u}for(a=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<a.length;i++)return this._readLinearRing(a[i],t,r);if(a=e.getElementsByTagNameNS(this._gmlNS,"Box"),a.length>=1)for(i=0;i<a.length;i++)return this._readBox(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Envelope"),i=0;i<a.length;i++)return this._readEnvelope(a[i],t,r);if(a=e.getElementsByTagNameNS(this._gmlNS,"MultiPoint"),a.length>=1)for(i=0;i<a.length;i++)return this._readMultiPoint(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<a.length;i++)return this._readPoint(a[i],t,r);return null},_readGeometryCollection:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"geometryMember"),i=0;i<s.length;i++){var l=this._readGeometryMember(s[i],t,r);o.push(l)}return o},_readMultiGeometry:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"geometryMember"),i=0;i<s.length;i++){var l=this._readGeometryMember(s[i],t,r);o.push(l)}return o},_readSurface:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<s.length;i++)o.push(this._readPoint(s[i],t,r));for(s=e.getElementsByTagNameNS(this._gmlNS,"patches"),i=0;i<s.length;i++)for(var l=this._readPatches(s[i],t,r),m=0;m<l.length;m++){var h=l[m];o.push(h)}return o},_readMultiSurface:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);0!==o&&(r=o);var l=[];for(l.geometryType="multigeometry",l.spatialReference={wkid:this._map.spatialReference.wkid},a=e.getElementsByTagNameNS(this._gmlNS,"surfaceMember"),i=0;i<a.length;i++){var m=this._readSurfaceMember(a[i],t,r);for(s=0;s<m.length;s++)l.push(m[s])}for(a=e.getElementsByTagNameNS(this._gmlNS,"surfaceMembers"),i=0;i<a.length;i++){var h=this._readSurfaceMembers(a[i],t,r);for(s=0;s<h.length;s++)l.push(h[s])}return l},_readCurve:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.wkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"segments"),i=0;i<s.length;i++)for(var l=this._readSegments(s[i],t,r),m=0;m<l.length;m++)o.paths.push(l[m]);return o},_readSegments:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"LineStringSegment"),i=0;i<s.length;i++){var l=this._readLineStringSegment(s[i],t,r);o.push(l)}return o},_readLineStringSegment:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"posList"),i=0;i<s.length;i++)return this._readPosList(s[i],t,r)},_readMultiCurve:function(e,t,r){var i,s,a,n,o=this._readWkidFromNode(e);-1!=o&&(t=o);var l=this._readSrsDimension(e);0!==l&&(r=l);var m=[];for(m.spatialReference={wkid:this._map.spatialReference.wkid},a=e.getElementsByTagNameNS(this._gmlNS,"curveMember"),i=0;i<a.length;i++)for(n=this._readCurveMember(a[i],t,r),s=0;s<n.length;s++)m.push(n[s]);for(a=e.getElementsByTagNameNS(this._gmlNS,"curveMembers"),i=0;i<a.length;i++)for(n=this._readCurveMembers(a[i],t,r),s=0;s<n.length;s++)m.push(n[s]);return m},_readGeometryMember:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);for(0!==o&&(r=o),a=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<a.length;i++)return this._readPoint(a[i],t,r);for(a=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<a.length;i++){var l=this._readLineString(a[i],t,r),m={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.wkid}},h=[];for(s=0;s<l.length;s++)h.push(l[s]);return m.paths.push(h),m}for(a=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<a.length;i++)return this._readPolygon(a[i],t,r);return null},_readSurfaceMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<s.length;i++){var l=this._readPolygon(s[i],t,r);o.push(l)}return o},_readSurfaceMembers:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<s.length;i++){var l=this._readPolygon(s[i],t,r);o.push(l)}return o},_readCurveMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<s.length;i++){var l=this._readLineString(s[i],t,r);o.push(l)}return o},_readCurveMembers:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<s.length;i++){var l=this._readLineString(s[i],t,r);o.push(l)}return o},_readBox:function(e,t,r){var i,s,a,n,o,l,m,h=this._readWkidFromNode(e);-1!=h&&(t=h);var g=this._readSrsDimension(e);0!==g&&(r=g);var d={geometryType:"polygon",rings:[],spatialReference:{wkid:this._map.spatialReference.wkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<s.length;i++)if(a=this._readCoordinates(s[i],t,r))return a.length>=1&&(n=l=a[0][0],o=m=a[0][1]),a.length>=1&&(l=a[1][0],m=a[1][1]),d.rings.push([[n,o],[n,m],[l,m],[l,o],[n,o]]),d;if(s=e.getElementsByTagNameNS(this._gmlNS,"coord"),s.length>=2){var u=this._readCoord(s[0],t,r);u&&u.length>=1&&(n=l=u[0][0],o=m=u[0][1]);var p=this._readCoord(s[1],t,r);return p&&p.length>=1&&(l=p[0][0],m=p[0][1]),d.rings.push([[n,o],[n,m],[l,m],[l,o],[n,o]]),d}return null},_readEnvelope:function(e,t,r){var i,s,a,n,o=this._readWkidFromNode(e);-1!=o&&(t=o);var l=this._readSrsDimension(e);for(0!==l&&(r=l),s=e.getElementsByTagNameNS(this._gmlNS,"lowerCorner"),i=0;i<s.length;i++){var m=this._readCoordinates(s[i],t,r);m&&(a=m[0])}for(s=e.getElementsByTagNameNS(this._gmlNS,"upperCorner"),i=0;i<s.length;i++){var h=this._readCoordinates(s[i],t,r);h&&(n=h[0])}if(a&&n){var g={geometryType:"polygon",rings:[[[a[0],a[1]],[a[0],n[1]],[n[0],n[1]],[n[0],a[1]],[a[0],a[1]]]],spatialReference:{wkid:this._map.spatialReference.wkid}};return g}return null},_readPolygon:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);0!==o&&(r=o);var l={geometryType:"polygon",rings:[],spatialReference:{wkid:this._map.spatialReference.wkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"outerBoundaryIs"),i=0;i<s.length;i++)a=this._readOuterBoundaryIs(s[i],t,r),l.rings.push(a);for(s=e.getElementsByTagNameNS(this._gmlNS,"innerBoundaryIs"),i=0;i<s.length;i++)a=this._readInnerBoundaryIs(s[i],t,r),l.rings.push(a);for(s=e.getElementsByTagNameNS(this._gmlNS,"exterior"),i=0;i<s.length;i++)a=this._readExterior(s[i],t,r),l.rings.push(a);for(s=e.getElementsByTagNameNS(this._gmlNS,"interior"),i=0;i<s.length;i++)a=this._readInterior(s[i],t,r),
l.rings.push(a);return l},_readPolygonMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"Polygon"),i=0;i<s.length;i++)return this._readPolygon(s[i],t,r);return null},_readMultiPolygon:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.geometryType="multigeometry",o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"polygonMember"),i=0;i<s.length;i++){var l=this._readPolygonMember(s[i],t,r);o.push(l)}return o},_readOuterBoundaryIs:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readInnerBoundaryIs:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readExterior:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readInterior:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LinearRing"),i=0;i<s.length;i++)return this._readLinearRing(s[i],t,r);return null},_readPatches:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o=[];for(o.spatialReference={wkid:this._map.spatialReference.wkid},s=e.getElementsByTagNameNS(this._gmlNS,"PolygonPatch"),i=0;i<s.length;i++)o.push(this._readPolygon(s[i],t,r));return o},_readLineString:function(e,t,r){var i,s,a,n,o,l=this._readWkidFromNode(e);-1!=l&&(t=l);var m=this._readSrsDimension(e);0!==m&&(r=m);var h=[];for(h.spatialReference={wkid:this._map.spatialReference.wkid},a=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<a.length;i++)if(n=this._readCoordinates(a[i],t,r))for(s=0;s<n.length;s++)o=n[s],h.push(o);for(a=e.getElementsByTagNameNS(this._gmlNS,"coord"),i=0;i<a.length;i++)if(n=this._readCoord(a[i],t,r))for(s=0;s<n.length;s++)o=n[s],h.push(o);for(a=e.getElementsByTagNameNS(this._gmlNS,"posList"),i=0;i<a.length;i++)if(n=this._readPosList(a[i],t,r))for(s=0;s<n.length;s++)o=n[s],h.push(o);return h},_readLineStringMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"LineString"),i=0;i<s.length;i++)return this._readLineString(s[i],t,r);return null},_readMultiLineString:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o={geometryType:"polyline",paths:[],spatialReference:{wkid:this._map.spatialReference.wkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"lineStringMember"),i=0;i<s.length;i++){var l=this._readLineStringMember(s[i],t,r);l&&o.paths.push(l)}return o.paths.length>=1?o:null},_readPoint:function(e,t,r){var i,s,a,n=this._readWkidFromNode(e);-1!=n&&(t=n);var o=this._readSrsDimension(e);for(0!==o&&(r=o),s=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<s.length;i++)if(a=this._readCoordinates(s[i],t,r))return{geometryType:"point",x:a[0][0],y:a[0][1],spatialReference:{wkid:this._map.spatialReference.wkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"pos"),i=0;i<s.length;i++){var l=this._readPos(s[i],t,r);if(l&&l.length>0)return{geometryType:"point",x:l[0][0],y:l[0][1],spatialReference:{wkid:this._map.spatialReference.wkid}}}for(s=e.getElementsByTagNameNS(this._gmlNS,"coord"),i=0;i<s.length;i++){var m=this._readCoord(s[i],t,r);if(m){var h={geometryType:"point",x:m[0][0],y:m[0][1],spatialReference:{wkid:this._map.spatialReference.wkid}};return h}}return null},_readPointMember:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"Point"),i=0;i<s.length;i++)return this._readPoint(s[i],t,r);return null},_readMultiPoint:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);0!==n&&(r=n);var o={geometryType:"multipoint",points:[],spatialReference:{wkid:this._map.spatialReference.wkid}};for(s=e.getElementsByTagNameNS(this._gmlNS,"pointMember"),i=0;i<s.length;i++){var l=this._readPointMember(s[i],t,r);l&&o.points.push([l.x,l.y])}return o.points.length>=1?o:null},_readLinearRing:function(e,t,r){var i,s,a=this._readWkidFromNode(e);-1!=a&&(t=a);var n=this._readSrsDimension(e);for(0!==n&&(r=n),s=e.getElementsByTagNameNS(this._gmlNS,"coordinates"),i=0;i<s.length;i++)return this._readCoordinates(s[i],t,r);for(s=e.getElementsByTagNameNS(this._gmlNS,"posList"),i=0;i<s.length;i++)return this._readCoordinates(s[i],t,r);for(s=e.getElementsByTagNameNS(this._gmlNS,"pos"),i=0;i<s.length;i++)return this._readPos(s[i],t,r)},_readCoordinatesBody:function(e,t,r){var i,s,a=new _(e);t=t.trim();var n,o,l,m=[];m.spatialReference={wkid:this._map.spatialReference.wkid};var h=this._isReverse(e,this.version);if(t)if(2===r){if(i=t.match(/[0123456789.\-\+eE]+/g),i&&i.length>=2)for(n=0;n<i.length;n+=2){o=parseFloat(i[n]),l=parseFloat(i[n+1]),h&&(s=l,l=o,o=s);var g={};this._projectFromSRToSR(a,this._map.spatialReference,o,l,g)&&(o=g.x,l=g.y),m.push([o,l])}}else if(3===r&&(i=t.match(/[0123456789.\-\+eE]+/g),i&&i.length>=3))for(n=0;n<i.length;n+=3){o=parseFloat(i[n]),l=parseFloat(i[n+1]),h&&(s=l,l=o,o=s);var d={};this._projectFromSRToSR(a,this._map.spatialReference,o,l,d)&&(o=d.x,l=d.y),m.push([o,l])}return m},_readCoord:function(e,t,r){var i,s,a,n,o=this._readWkidFromNode(e);-1!=o&&(t=o);var l=new _(t),m=this._readSrsDimension(e);0!==m&&(r=m);var h=this._isReverse(t,this.version),g=[];for(g.spatialReference={wkid:this._map.spatialReference.wkid},a=0,s=e.getElementsByTagNameNS(this._gmlNS,"X"),i=0;i<s.length;i++){a=this._readFloat(s[i],t,r);break}for(n=0,s=e.getElementsByTagNameNS(this._gmlNS,"Y"),i=0;i<s.length;i++){n=this._readFloat(s[i],t,r);break}if(h){var d=n;n=a,a=d}var u={};return this._projectFromSRToSR(l,this._map.spatialReference,a,n,u)&&(a=u.x,n=u.y),g.push(h?[n,a]:[a,n]),g},_readCoordinates:function(e,t,r){var i=this._readWkidFromNode(e);-1!=i&&(t=i);var s=this._readSrsDimension(e);0!==s&&(r=s);var a=e.textContent;return this._readCoordinatesBody(t,a,r)},_readPos:function(e,t,r){var i=this._readWkidFromNode(e);-1!=i&&(t=i);var s=this._readSrsDimension(e);0!==s&&(r=s);var a=e.textContent;return this._readCoordinatesBody(t,a,r)},_readPosList:function(e,t,r){var i=this._readWkidFromNode(e);-1!=i&&(t=i);var s=this._readSrsDimension(e);0!==s&&(r=s);var a=e.textContent;return this._readCoordinatesBody(t,a,r)},_projectFromSRToSR:function(e,t,r,i,s){if(f.canProject(e,t)){var a=new N(r,i,e),n=f.project(a,t);return s.x=n.x,s.y=n.y,!0}return s.x=r,s.y=i,this._isProjectedOk=!1,!1},_readFloat:function(e){var t=e.textContent;return t?parseFloat(t):0},_readSrsDimension:function(e){if(e.attributes){var t=e.attributes.getNamedItem("srsDimension");if(t)return parseInt(t.value,10)}return 0},_readWkidFromNode:function(e){if(e.attributes){var t=e.attributes.getNamedItem("srsName");if(t){var r=t.value,i=r.match(/\d+/g);if(i&&i.length>0){var s=parseInt(i[i.length-1],10);return 84===s&&(s=4326),parseInt(s,10)}}}return-1},_isReverse:function(e,t){return this._inverseResponse},_appendCustomParameters:function(e){if(this.customParameters)for(var t in this.customParameters)e+=(-1===e.indexOf("?")?"?":"&")+t+"="+encodeURIComponent(this.customParameters[t]);return e}});return a("extend-esri")&&r.setObject("layers.WFSLayer",F,l),F});