/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../colorUtils","../../core/Error","../../core/lang","../../core/Logger","./effects","./parser"],(function(e,t,s,n,r,f,c,i){"use strict";const l=-1;let o=function(){function e(e=200){this.duration=e,this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this._effect="",this._effects=[],this._scale=0}var s=e.prototype;return s.transitionStep=function(e,t){this._applyTimeTransition(e),this._updateForScale(t)},s._transitionTo=function(e){this.scale>0&&g(this._current,e,this.scale)?(this._final=e,this._to=r.clone(e),p(this._current,this._to,this.scale),this._from=r.clone(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=e),this._effects=this._current[0]?r.clone(this._current[0].effects):[]},s._applyTimeTransition=function(e){if(!this._to)return;this._time+=e;const t=Math.min(1,this._time/this.duration);for(let s=0;s<this._current.length;s++){const e=this._current[s],n=this._from[s],r=this._to[s];e.scale=y(n.scale,r.scale,t);for(let s=0;s<e.effects.length;s++){const f=e.effects[s],c=n.effects[s],i=r.effects[s];f.interpolate(c,i,t)}}1===t&&(this._current=this._final,this._effects=this._current[0]?r.clone(this._current[0].effects):[],this._from=this._to=this._final=null)},s._updateForScale=function(e){if(0===this._current.length)return;this._scale=e;const t=this._current,s=this._current.length-1;let n,r,f=1;if(1===t.length||e>=t[0].scale)r=n=t[0].effects;else if(e<=t[s].scale)r=n=t[s].effects;else for(let c=0;c<s;c++){const s=t[c],i=t[c+1];if(s.scale>=e&&i.scale<=e){f=(e-s.scale)/(i.scale-s.scale),n=s.effects,r=i.effects;break}}for(let c=0;c<this._effects.length;c++){this._effects[c].interpolate(n[c],r[c],f)}},t._createClass(e,[{key:"effect",get:function(){return this._effect},set:function(e){if(e=e||"",this._effect===e)return;this._effect=e;const t=a(e);Array.isArray(t)?this._transitionTo(t):(this._transitionTo([]),f.getLogger("esri.views.layers.effects.EffectList").warn("Invalid Effect",{effect:e,error:t}))}},{key:"hasEffects",get:function(){return this.transitioning||!!this._effects.length}},{key:"effects",get:function(){return this._effects}},{key:"scale",get:function(){return this._scale}},{key:"transitioning",get:function(){return null!==this._to}}]),e}();function a(e){if(!e)return[];if("string"==typeof e){const t=i.parse(e);return t.error?t.error:[{scale:l,effects:t.effects}]}const t=[];for(const s of e){if(!isFinite(s.scale)||s.scale<=0)return new n("effect:invalid-scale","scale must be finite and greater than 0",{stop:s});const e=i.parse(s.value);if(e.error)return e.error;t.push({scale:s.scale,effects:e.effects})}t.sort(((e,t)=>t.effects.length-e.effects.length));for(let s=0;s<t.length-1;s++){if(!u(t[s].effects,t[s+1].effects))return new n("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[s].effects,b:t[s+1].effects});_(t[s].effects,t[s+1].effects)}return t.sort(((e,t)=>t.scale-e.scale)),t}function h(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new c.ColorMatrixEffect(e.type,0);case"saturate":case"brightness":case"contrast":return new c.ColorMatrixEffect(e.type,1);case"opacity":return new c.OpacityEffect(1);case"hue-rotate":return new c.HueRotateEffect(0);case"blur":return new c.BlurEffect(0);case"drop-shadow":return new c.DropShadowEffect(0,0,0,[...s.getNamedColor("transparent")]);case"bloom":return new c.BloomEffect(0,0,0)}}function u(e,t){const s=e.length>t.length?e:t;return(e.length>t.length?t:e).every(((e,t)=>e.type===s[t].type))}function _(e,t){const s=e.length>t.length?e:t,n=e.length>t.length?t:e;for(let r=n.length;r<s.length;r++)n.push(h(s[r]))}function g(e,t,s){var n,r,f,c;if(null==(n=e[0])||!n.effects||null==(r=t[0])||!r.effects)return!0;return!(((null==(f=e[0])?void 0:f.scale)===l||(null==(c=t[0])?void 0:c.scale)===l)&&(e.length>1||t.length>1)&&s<=0)&&u(e[0].effects,t[0].effects)}function p(e,t,s){var n,r;const f=e.length>t.length?e:t,c=e.length>t.length?t:e,i=c[c.length-1],o=null!=(n=null==i?void 0:i.scale)?n:s,a=null!=(r=null==i?void 0:i.effects)?r:[];for(let l=c.length;l<f.length;l++)c.push({scale:o,effects:[...a]});for(let h=0;h<f.length;h++)c[h].scale=c[h].scale===l?s:c[h].scale,f[h].scale=f[h].scale===l?s:f[h].scale,_(c[h].effects,f[h].effects)}function y(e,t,s){return e+(t-e)*s}e.canInterpolateEffectStops=g,e.canInterpolateEffects=u,e.convertEffectToStops=a,e.default=o,e.normalizeEffectStops=p,e.normalizeEffects=_,Object.defineProperty(e,"__esModule",{value:!0})}));
