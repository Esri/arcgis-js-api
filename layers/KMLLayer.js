/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../geometry/SpatialReference","../geometry/Extent","../geometry","../core/Collection","../core/CollectionFlattener","./Layer","../core/MultiOriginJSONSupport","./support/commonProperties","./mixins/OperationalLayer","./mixins/BlendLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./support/kmlUtils","./support/KMLSublayer"],(function(e,r,t,o,s,l,i,a,n,p,u,c,y,d,h,b,f,_,m,g,v,S,L,x,w,E,O,F){"use strict";const M=["kml","xml"];let k=function(r){function t(...t){var o;return(o=r.call(this,...t)||this)._visibleFolders=[],o.allSublayers=new _({root:e._assertThisInitialized(o),rootCollectionNames:["sublayers"],getChildrenFunction:e=>e.sublayers}),o.outSpatialReference=d.WGS84,o.path=null,o.legendEnabled=!1,o.operationalLayerType="KML",o.sublayers=null,o.type="kml",o.url=null,o}e._inheritsLoose(t,r);var s=t.prototype;return s.initialize=function(){this.watch("sublayers",((e,r)=>{r&&r.forEach((e=>{e.parent=null,e.layer=null})),e&&e.forEach((e=>{e.parent=this,e.layer=this}))}),!0),this.on("sublayer-update",(()=>this.notifyChange("fullExtent")))},s.normalizeCtorArgs=function(e,r){return"string"==typeof e?{url:e,...r}:e},s.readSublayersFromItemOrWebMap=function(e,r){this._visibleFolders=r.visibleFolders},s.readSublayers=function(e,r,t){return O.sublayersFromJSON(F,r,t,this._visibleFolders)},s.writeSublayers=function(e,r){const t=[],o=e.toArray();for(;o.length;){const e=o[0];e.networkLink||(e.visible&&t.push(e.id),e.sublayers&&o.push(...e.sublayers.toArray())),o.shift()}r.visibleFolders=t},s.load=function(e){const r=o.isSome(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["KML"]},e).then((()=>this._fetchService(r)))),Promise.resolve(this)},s.destroy=function(){r.prototype.destroy.call(this),this.allSublayers.destroy()},s._fetchService=async function(e){const r=await Promise.resolve().then((()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:O.fetchService(this.url,this.outSpatialReference,this.refreshInterval,e))),t=O.parseKML(r.data);t&&this.read(t,{origin:"service"})},s._recomputeFullExtent=function(){let e=null;this.extent&&(e=this.extent.clone());const r=t=>{if(t.sublayers)for(const o of t.sublayers.items)r(o),o.visible&&o.fullExtent&&(e?e.union(o.fullExtent):e=o.fullExtent.clone())};return r(this),e},e._createClass(t,[{key:"title",get:function(){const e=this._get("title");return e&&"defaults"!==this.originOf("title")?e:this.url?u.getFilename(this.url,M)||"KML":e||""},set:function(e){this._set("title",e)}},{key:"visibleSublayers",get:function(){const e=this.sublayers,r=[],t=e=>{e.visible&&(r.push(e),e.sublayers&&e.sublayers.forEach(t))};return e&&e.forEach(t),r}},{key:"fullExtent",get:function(){return this._recomputeFullExtent()}}]),t}(L.BlendLayer(w.RefreshableLayer(E.ScaleRangeLayer(S.OperationalLayer(x.PortalLayer(g.MultiOriginJSONMixin(m)))))));return r.__decorate([i.property({readOnly:!0})],k.prototype,"allSublayers",void 0),r.__decorate([i.property({type:d})],k.prototype,"outSpatialReference",void 0),r.__decorate([i.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],k.prototype,"path",void 0),r.__decorate([i.property({readOnly:!0,json:{read:!1,write:!1}})],k.prototype,"legendEnabled",void 0),r.__decorate([i.property({type:["show","hide","hide-children"]})],k.prototype,"listMode",void 0),r.__decorate([i.property({type:["KML"]})],k.prototype,"operationalLayerType",void 0),r.__decorate([i.property({})],k.prototype,"resourceInfo",void 0),r.__decorate([i.property({type:f.ofType(F),json:{write:{ignoreOrigin:!0}}})],k.prototype,"sublayers",void 0),r.__decorate([a.reader(["web-map","portal-item"],"sublayers",["visibleFolders"])],k.prototype,"readSublayersFromItemOrWebMap",null),r.__decorate([a.reader("service","sublayers",["sublayers"])],k.prototype,"readSublayers",null),r.__decorate([p.writer("sublayers")],k.prototype,"writeSublayers",null),r.__decorate([i.property({readOnly:!0,json:{read:!1}})],k.prototype,"type",void 0),r.__decorate([i.property({json:{origins:{"web-map":{read:{source:"title"}}},write:{ignoreOrigin:!0}}})],k.prototype,"title",null),r.__decorate([i.property(v.url)],k.prototype,"url",void 0),r.__decorate([i.property({readOnly:!0})],k.prototype,"visibleSublayers",null),r.__decorate([i.property({type:h})],k.prototype,"extent",void 0),r.__decorate([i.property()],k.prototype,"fullExtent",null),k=r.__decorate([n.subclass("esri.layers.KMLLayer")],k),k}));
