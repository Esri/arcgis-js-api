/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Color","../../core/Clonable","../../core/Collection","../../core/collectionUtils","../../core/JSONSupport","../../core/mathUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./VoxelColorStop","./VoxelOpacityStop","./VoxelRangeFilter"],(function(o,t,e,r,s,i,n,p,l,c,a,h,u,y,f){"use strict";var S;!function(o){o[o.Color=1]="Color",o[o.Alpha=2]="Alpha",o[o.Both=3]="Both"}(S||(S={}));let g=function(t){function r(o){var e;return(e=t.call(this,o)||this).interpolation=null,e.stretchRange=null,e.rangeFilter=null,e._colorMapSize=256,e.colorStops=new(s.ofType(u)),e.opacityStops=new(s.ofType(y)),e}o._inheritsLoose(r,t);var n=r.prototype;return n.getPreviousNext=function(o,t,e){let r=o;for(;--r>0&&t[r].type!==e&&t[r].type!==S.Both;);let s=o;const i=t.length;for(;++s<i&&t[s].type!==e&&t[s].type!==S.Both;);return[r,s]},n.getColorForContinuousDataValue=function(o,t){const e=this.rasterizedTransferFunction;if(this.colorStops.length<2||!Array.isArray(this.stretchRange)||this.stretchRange.length<2||e.length<256)return null;let r=this.stretchRange[0],s=this.stretchRange[1];if(r>s){const o=r;r=s,s=o}o=p.clamp(o,r,s);const i=e[Math.round((o-r)/(s-r)*(this._colorMapSize-1))].clone();return t||(i.a=1),i},o._createClass(r,[{key:"colorStops",set:function(o){this._set("colorStops",i.referenceSetter(o,this._get("colorStops"),s.ofType(u)))}},{key:"opacityStops",set:function(o){this._set("opacityStops",i.referenceSetter(o,this._get("opacityStops"),s.ofType(y)))}},{key:"rasterizedTransferFunction",get:function(){const o=[];if(this.colorStops.length<2)return o;const t=[],r=[],s=1e-5;for(const e of this.colorStops){if(!e.color)return o;r.push({color:{r:e.color.r,g:e.color.g,b:e.color.b,a:Math.round(255*(1-e.color.a))},position:e.position,type:S.Color})}if(0===this.opacityStops.length)for(const e of r)t.push({color:e.color,position:e.position});else{for(const t of this.opacityStops){const o=p.clamp(t.position,0,1),e=Math.round(255*p.clamp(1-t.opacity,0,1));let i=!1;for(const t of r)if(t.type===S.Color&&Math.abs(t.position-o)<s){t.color.a=e,t.type=S.Both,i=!0;break}i||r.push({color:{r:0,g:0,b:0,a:e},position:t.position,type:S.Alpha})}r.sort(((o,t)=>o.position<t.position?-1:1));const o=r.length;for(let t=0;t<o;++t){const e=r[t];if(e.type!==S.Both)if(e.type===S.Color){const[s,i]=this.getPreviousNext(t,r,S.Alpha);if(-1!==s&&i!==o){const o=(e.position-r[s].position)/(r[i].position-r[s].position);e.color.a=Math.round(p.lerp(r[s].color.a,r[i].color.a,o))}else e.color.a=-1!==s?r[s].color.a:r[i].color.a}else{const[s,i]=this.getPreviousNext(t,r,S.Color);if(-1!==s&&i!==o){const o=(e.position-r[s].position)/(r[i].position-r[s].position),t=r[s].color,n=r[i].color;["r","g","b"].forEach((r=>{e.color[r]=Math.round(p.lerp(t[r],n[r],o))}))}else["r","g","b"].forEach(-1!==s?o=>{e.color[o]=r[s][o]}:o=>{e.color[o]=r[i][o]})}}for(const e of r)t.push({color:e.color,position:e.position})}t[0].position=0,t[t.length-1].position=1;let i=0,n=1;for(let l=0;l<this._colorMapSize;++l){const r=l/this._colorMapSize;for(;r>t[n].position;)i=n++;const s=(r-t[i].position)/(t[n].position-t[i].position),c=t[i].color,a=t[n].color,h=new e;["r","g","b"].forEach((o=>{h[o]=Math.round(p.lerp(c[o],a[o],s))})),h.a=p.clamp(1-p.lerp(c.a,a.a,s)/255,0,1),o.push(h)}return o}}]),r}(r.ClonableMixin(n.JSONSupport));t.__decorate([l.property({type:["linear","nearest"],json:{write:!0}})],g.prototype,"interpolation",void 0),t.__decorate([l.property({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],g.prototype,"stretchRange",void 0),t.__decorate([l.property({type:s.ofType(u),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.colorStops&&this.colorStops.length>0}}}}})],g.prototype,"colorStops",null),t.__decorate([l.property({type:s.ofType(y),json:{read:{source:"alphaStops"},write:{enabled:!0,target:"alphaStops",overridePolicy(){return{enabled:!!this.opacityStops&&this.opacityStops.length>0}}}}})],g.prototype,"opacityStops",null),t.__decorate([l.property({type:f,json:{write:!0}})],g.prototype,"rangeFilter",void 0),t.__decorate([l.property({type:[e],clonable:!1,json:{read:!1}})],g.prototype,"rasterizedTransferFunction",null),g=t.__decorate([h.subclass("esri.layers.voxel.VoxelTransferFunctionStyle")],g);return g}));
