// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

//  copyright

/**
       * The copyright text as defined by the image service.
       *
       * @type {string}
       */

// We expose "copyrightText" as "copyright" in the SDK.

define(["dojo/_base/lang","./ArcGISService","../support/Field","../support/Raster","../support/PixelBlock","../support/MosaicRule","../support/RasterFunction","../support/DimensionalDefinition","../../geometry/Extent","../../geometry/Point","../../geometry/SpatialReference","../../tasks/QueryTask","../../tasks/ImageServiceIdentifyTask","../../tasks/support/ImageServiceIdentifyParameters","../../request","../../Graphic","../../PopupTemplate","../../core/lang","../../core/Accessor","../../core/kebabDictionary","../../core/promiseUtils","../../core/Logger"],function(e,t,i,r,a,n,s,o,l,u,c,d,p,f,h,m,v,g,y,b,x,I){var R=b({S8:"s8",S16:"s16",S32:"s32",U8:"u8",U16:"u16",U32:"u32",F32:"f32",F64:"f64"}),D=I.getLogger("esri.layers.mixins.ArcGISImageService"),T=y.createSubclass({properties:{layer:{},mosaicRule:{dependsOn:["layer.mosaicRule"],get:function(){return this.get("layer.mosaicRule")||null}},version:{value:0,dependsOn:["layer.bandIds","layer.format","layer.compressionQuality","layer.compressionTolerance","layer.interpolation","layer.noData","layer.noDataInterpretation","layer.mosaicRule","layer.renderingRule","layer.adjustAspectRatio"],get:function(){return this._get("version")+1}}},toJSON:function(){var e=this.layer;return{bandIds:e.bandIds?e.bandIds.join(","):null,format:e.format,compressionQuality:e.compressionQuality,compressionTolerance:e.compressionTolerance,interpolation:e.interpolation,noData:e.noData,noDataInterpretation:e.noDataInterpretation,mosaicRule:this.mosaicRule?JSON.stringify(this.mosaicRule.toJSON()):null,renderingRule:e.renderingRule?JSON.stringify(e.renderingRule.toJSON()):null,adjustAspectRatio:e.adjustAspectRatio}}}),w=t.createSubclass({declaredClass:"esri.layers.mixins.ArcGISImageService",getDefaults:function(){return e.mixin(this.inherited(arguments),{exportImageServiceParameters:{layer:this}})},_raster:null,properties:{adjustAspectRatio:{},bandCount:{},bandIds:{json:{write:!0}},capabilities:{json:{read:function(e){return e&&e.split(",").map(function(e){return e.trim()})}}},compressionQuality:{json:{write:!0}},compressionTolerance:.01,copyright:{json:{read:{source:["copyrightText"],reader:function(e,t){return t.copyrightText}}}},definitionExpression:{get:function(){return this.mosaicRule?this.mosaicRule.where:null},set:function(e){var t=this.mosaicRule||new n;t.where=e,this._set("mosaicRule",t)},json:{read:{source:["definitionExpression","layerDefinition.definitionExpression"],reader:function(e,t){return e||t.layerDefinition&&t.layerDefinition.definitionExpression||void 0}}}},domainFields:{value:null,type:[i],dependsOn:["fields"],get:function(){return this.fields&&this.fields.filter(function(e){return null!=e.domain})||[]}},exportImageServiceParameters:{readOnly:!0,type:T},fields:{type:[i]},fullExtent:{type:l,json:{read:{source:["extent"],reader:function(e,t){return l.fromJSON(t.extent)}}}},format:{value:"jpgpng",json:{write:!0}},hasRasterAttributeTable:{},hasMultidimensions:{},imageMaxHeight:{value:4100,json:{origins:{service:{read:{source:"maxImageHeight"}}}}},imageMaxWidth:{value:15e3,json:{origins:{service:{read:{source:"maxImageWidth"}}}}},interpolation:{json:{write:!0}},mosaicRule:{value:null,type:n,json:{origins:{service:{read:{source:["defaultMosaicMethod"],reader:function(e,t){return n.fromJSON(t)}}}},write:!0}},multidimensionalInfo:null,noData:{json:{write:!0}},noDataInterpretation:{json:{write:!0}},objectIdField:{json:{read:{source:["fields"],reader:function(e,t){return!e&&t.fields&&t.fields.some(function(t){return"esriFieldTypeOID"===t.type&&(e=t.name),!!e}),e}}}},pixelType:{value:null,json:{read:R.fromJSON,write:R.write}},popupTemplate:{value:null,type:v,json:{read:{source:["popupInfo"],reader:function(e,t){return t.popupInfo?v.fromJSON(t.popupInfo):null}},write:function(e,t){e&&(t.popupInfo=e.toJSON())}}},queryTask:{readOnly:!0,dependsOn:["url"],get:function(){return new d({url:this.url})}},renderer:{json:{origins:{service:{read:!1}},read:{source:"layerDefinition.drawingInfo.renderer",reader:function(){D.warn("Client side renderer configuration on ImageryLayer (id: "+this.id+", title: "+this.title+") is not yet supported. Visualization of the layer data may differ from what is expected.")}},write:!1}},rasterAttributeTable:null,rasterAttributeTableFieldPrefix:"Raster.",rasterFields:{value:null,dependsOn:["fields","rasterAttributeTable","rasterAttributeTableFieldPrefix"],get:function(){var e=this.rasterAttributeTableFieldPrefix,t={name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"string"},i={name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"string"},r=this.fields?g.clone(this.fields):[],a=r.length;if(r[a]=i,(this.capabilities&&this.capabilities.indexOf("Catalog")>-1||this.fields&&this.fields.length>0)&&(r[a+1]=t),g.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var n={name:"Raster.Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"double"},s={name:"Raster.Direction",alias:"Direction",domain:null,editable:!1,type:"double"};r[a+2]=n,r[a+3]=s}var o=this.rasterAttributeTable&&this.rasterAttributeTable.fields||null;if(o&&o.length>0){var l=o.filter(function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()}),u=l.map(function(t){var i=g.clone(t);return i.name=e+t.name,i});r=r.concat(u)}return r}},renderingRule:{value:null,type:s,json:{origins:{service:{read:{source:["rasterFunctionInfos"],reader:function(e,t){var i=t.rasterFunctionInfos;return t.renderingRule||i&&i.length&&"None"!==i[0].name?s.fromJSON(t.renderingRule||{rasterFunctionInfos:t.rasterFunctionInfos}):null}}}},write:!0}},serviceDataType:{},spatialReference:{value:null,readOnly:!0,json:{read:{source:["extent"],reader:function(e,t){return e=t.extent&&t.extent.spatialReference,e&&c.fromJSON(e)}}}},url:{},version:{value:null,readOnly:!0,json:{read:{source:["currentVersion","fields","timeInfo"],reader:function(e,t){return e=t.currentVersion,e||(e=t.hasOwnProperty("fields")||t.hasOwnProperty("objectIdField")||t.hasOwnProperty("timeInfo")?10:9.3),e}}}}},applyFilter:function(e){var t=this._clonePixelData(e);return this.pixelFilter&&this.pixelFilter(t),t},fetchImage:function(e,t,i,r){if(!(g.isDefined(this._raster)&&g.isDefined(e)&&g.isDefined(t)&&g.isDefined(i)))return x.reject(new Error("Insufficient parameters for requesting an image. A valid extent, width and height values are required."));var a=this.getExportImageServiceParameters(e,t,i,r),n={imageServiceParameters:a,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType};return this._raster.read(n)},fetchKeyProperties:function(){return h(this.parsedUrl.path+"/keyProperties",{query:e.mixin({f:"json"}),responseType:"json",callbackParamName:"callback"}).then(function(e){return e.data})},getExportImageServiceParameters:function(t,i,r,a){var t=t.clone().shiftCentralMeridian(),n=t&&t.spatialReference;return n=n&&(n.wkid||JSON.stringify(n.toJSON())),e.mixin({bbox:t&&t.xmin+","+t.ymin+","+t.xmax+","+t.ymax,bboxSR:n,imageSR:n,size:i+","+r},this.exportImageServiceParameters.toJSON())},queryRasters:function(e){return this.queryTask.execute(e)},queryVisibleRasters:function(e,t){this._visibleRasters=[];var i=!1,r=this.popupTemplate;r&&r.fieldInfos&&r.fieldInfos.length>0&&(i=r.fieldInfos.length>1||"raster.servicepixelvalue"!==r.fieldInfos[0].toLowerCase()),r&&!i&&this.rasterFields&&(i=this.rasterFields.some(function(e){var t=e&&e.name?e.name.toLowerCase():null;return t&&"raster.servicepixelvalue"!==t&&(r.title&&r.title.toLowerCase().indexOf(t)>-1||r.content&&r.content.toLowerCase().indexOf(t)>-1)}));var a,n,s,o;if(t.layerView&&t.layerView.view){var l=t.layerView.view;if("2d"===l.type){var c=l.state;a=c.spatialReference.clone(),n=c.resolution}else a=l.spatialReference.clone(),n=l.resolution;n&&(s=new u(.5*n,.5*n,a)),o=a.equals(this.spatialReference)}var d=new f({geometry:e.geometry,returnCatalogItems:i,timeExtent:e.timeExtent,mosaicRule:this.mosaicRule||null,renderingRule:this.renderingRule||null,returnGeometry:o,outSpatialReference:a,pixelSize:s}),h=new p({url:this.url});return h.execute(d).then(function(e){return this._processVisibleRastersResponse(e,t)}.bind(this)).otherwise(function(e){throw new Error("Error querying for visible rasters")})},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType},_fetchService:function(){return x.resolve().then(function(){return this.resourceInfo||h(this.parsedUrl.path,{query:e.mixin({f:"json"},this.parsedUrl.query),responseType:"json",callbackParamName:"callback"})}.bind(this)).then(function(e){e.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.read(e.data,{origin:"service",url:this.parsedUrl}),this._raster=new r({url:this.url})}.bind(this)).then(function(){return this.version>10&&this.hasRasterAttributeTable?h(this.parsedUrl.path+"/rasterAttributeTable",{query:{f:"json"},responseType:"json"}).then(function(e){var t=e.data;t&&t.features&&t.fields&&this.read({rasterAttributeTable:t},{origin:"service",url:this.parsedUrl})}.bind(this)):void 0}.bind(this)).then(function(){return this.version>=10.3&&this._isScientificData()&&this.hasMultidimensions?h(this.parsedUrl.path+"/multiDimensionalInfo",{query:{f:"json"},responseType:"json"}).then(function(e){var t=e.data;t&&t.multidimensionalInfo&&(this._updateMultidimensionalDefinition(t.multidimensionalInfo),this.multidimensionalInfo=t.multidimensionalInfo)}.bind(this)):void 0}.bind(this))},_updateMultidimensionalDefinition:function(e){var t,i="",r=e.variables[0].dimensions,a=[];for(t in r)if(r.hasOwnProperty(t)){var s=r[t],l=!0,u=s.extent,c=[u[0]];s.hasRanges&&s.hasRanges===!0?(l=!1,c=[s.values[0]]):"stdz"===s.name.toLowerCase()&&Math.abs(u[1])<=Math.abs(u[0])&&(c=[u[1]]),a.push(new o({variableName:i,dimensionName:r[t].name,isSlice:l,values:c}))}if(a.length>0){this.mosaicRule=this.mosaicRule||new n;var d=this.mosaicRule.multidimensionalDefinition;(!d||d&&d.length<=0)&&(this.mosaicRule.multidimensionalDefinition=a)}},_clonePixelData:function(e){if(null===e||void 0===e)return e;var t={};e.extent&&(t.extent=e.extent.clone());var i=e.pixelBlock;return null===i||void 0===i?t:(t.pixelBlock=i.clone(),t)},_processVisibleRastersResponse:function(e,t){var i,r,a,n,s=e.value,o=0,u=this.objectIdField,c=e.catalogItems&&e.catalogItems.features&&e.catalogItems.features.length||0;if(c){var d,p,f=0,h=0;for(r=[c],i=[c],n=[c],o=0;c>o;o++)e.properties.Values[o].toLowerCase().indexOf("nodata")>-1&&h++;for(d=c-h,o=0;c>o;o++)p=e.properties.Values[o].toLowerCase().indexOf("nodata")>-1?d++:f++,r[p]=e.catalogItems.features[o],i[p]=e.properties.Values[o],n[p]=r[p].attributes[u]}this._visibleRasters=[];var v,g=s.toLowerCase().indexOf("nodata")>-1;if(s&&!r&&!g){u="ObjectId",r=[];var y={};y.ObjectId=0,v=new m(new l(this.fullExtent),null,y),r.push(v)}var b=[];if(!r)return b;var x,I,R=t&&t.returnDomainValues||!1;for(o=0,a=r.length;a>o;o++)v=r[o],v.popupTemplate=this.popupTemplate,v._layer=this,s&&(x=s,i&&i.length>=o&&(I=i[o],x=I.replace(/ /gi,", ")),v.attributes["Raster.ItemPixelValue"]=x,v.attributes["Raster.ServicePixelValue"]=s,this._updateFeatureWithMagDirValues(v,x),this._updateFeatureWithRasterAttributeTableValues(v,x)),R&&this._updateFeatureWithDomainValues(v),b.push(v);return b},_updateFeatureWithRasterAttributeTableValues:function(t,i){var r=this.rasterAttributeTable&&this.rasterAttributeTable.features;if(r&&!(r.length<1)&&this.rasterAttributeTableFieldPrefix){var a=null;if(r.forEach(function(e){e&&e.attributes&&(e.attributes.Value==i||e.attributes.VALUE==i)&&(a=e)}),a){var n,s,o={};for(n in a.attributes)a.attributes.hasOwnProperty(n)&&(s=this.rasterAttributeTableFieldPrefix+n,o[s]=a.attributes[n]);t.attributes=e.mixin(t.attributes,o)}}},_updateFeatureWithMagDirValues:function(e,t){if(this.pixelFilter&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var i=t.replace(" ","").split(","),r=new a({height:1,width:1,pixelType:"f32",pixels:[],statistics:[]});i.forEach(function(e){r.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})}),this.pixelFilter({pixelBlock:r,extent:new l(0,0,0,0,this.spatialReference)}),e.attributes["Raster.Magnitude"]=r.pixels[0][0],e.attributes["Raster.Direction"]=r.pixels[1][0]}},_updateFeatureWithDomainValues:function(e){var t=this.domainFields;g.isDefined(t)&&t.forEach(function(t){if(t){var i=e.attributes[t.name];if(g.isDefined(i)){var r=this._findMatchingDomainValue(t.domain,i);g.isDefined(r)&&(e.attributes[t.name]=r)}}},this)},_findMatchingDomainValue:function(e,t){var i=e&&e.codedValues;if(i){var r;return i.some(function(e){return e.code===t?(r=e.name,!0):!1}),r}}});return w});