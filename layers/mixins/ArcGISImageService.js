/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/lang","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/aliasOf","../../core/jsonMap","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/Error","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../geometry/SpatialReference","../../geometry/Point","../../geometry/Extent","../../geometry/Polygon","../../geometry","../../request","../../Graphic","../support/commonProperties","../support/PixelBlock","../../rasterRenderers","../support/Field","../support/FieldsIndex","../../tasks/support/FeatureSet","../../tasks/support/Query","../../tasks/QueryTask","../support/DimensionalDefinition","../support/RasterFunction","../support/imageryRendererUtils","../support/MosaicRule","../support/ExportImageServiceParameters","../support/RasterInfo","../support/RasterJobHandler","../support/rasterFormats/RasterCodec","../../renderers/support/rasterRendererHelper","../../renderers/support/RasterSymbolizer","../../rest/imageService","../../tasks/ImageIdentifyTask","../../tasks/support/ImageIdentifyParameters"],(function(e,t,r,i,n,a,s,o,l,u,p,c,d,h,f,m,y,g,_,R,v,b,x,I,S,w,O,N,P,D,T,F,C,J,V,M,j,q,z,A,k,H,U,E,L,Q,B){"use strict";const G=s.getLogger("esri.layers.mixins.ArcGISImageService"),W=p.strict()({RSP_NearestNeighbor:"nearest",RSP_BilinearInterpolation:"bilinear",RSP_CubicConvolution:"cubic",RSP_Majority:"majority"}),X=p.strict()({esriNoDataMatchAny:"any",esriNoDataMatchAll:"all"}),Y=p.strict()({U1:"u1",U2:"u2",U4:"u4",U8:"u8",S8:"s8",U16:"u16",S16:"s16",U32:"u32",S32:"s32",F32:"f32",F64:"f64",C64:"c64",C128:"c128",UNKNOWN:"unknown"}),K=new Set(["png","png8","png24","png32","jpg","bmp","gif","jpgpng","lerc","tiff"]),$=l.ensureRange(o.ensureNumber,{min:0,max:255});e.ArcGISImageService=e=>{let i=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._functionRasterInfos={},t._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},t._symbolizer=null,t._defaultServiceMosaicRule=null,t.rasterAttributeTableFieldPrefix="Raster.",t.adjustAspectRatio=null,t.bandCount=null,t.bandIds=void 0,t.capabilities=null,t.compressionQuality=void 0,t.compressionTolerance=.01,t.copyright=null,t.definitionExpression=null,t.exportImageServiceParameters=null,t.rasterInfo=null,t.fields=null,t.fullExtent=null,t.hasMultidimensions=!1,t.imageMaxHeight=4100,t.imageMaxWidth=4100,t.interpolation=void 0,t.minScale=0,t.maxScale=0,t.multidimensionalInfo=null,t.noData=null,t.noDataInterpretation=void 0,t.objectIdField=null,t.pixelSizeX=null,t.pixelSizeY=null,t.pixelFilter=null,t.raster=void 0,t.viewId=void 0,t.renderer=null,t.rasterAttributeTable=null,t.rasterFunctionInfos=null,t.serviceDataType=null,t.spatialReference=null,t.pixelType=null,t.serviceRasterInfo=null,t.sourceJSON=null,t.url=null,t.version=null,t}t._inheritsLoose(r,e);var i=r.prototype;return i.initialize=function(){this._set("exportImageServiceParameters",new z.ExportImageServiceParameters({layer:this}))},i.readDefaultServiceMosaicRule=function(e,t){return q.fromJSON(t)},i.readBandIds=function(e,t){if(Array.isArray(e)&&e.length>0&&e.every((e=>"number"==typeof e)))return e},i.readCapabilities=function(e,t){return this._readCapabilities(t)},i.writeCompressionQuality=function(e,t,r){null!=e&&"lerc"!==this.format&&(t[r]=e)},i.writeCompressionTolerance=function(e,t,r){"lerc"===this.format&&null!=e&&(t[r]=e)},i.readFormat=function(e,t){return"esriImageServiceDataTypeVector-UV"===t.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===t.serviceDataType||null!=this.pixelFilter?"lerc":"jpgpng"},i.readMinScale=function(e,t){return null!=t.minLOD&&null!=t.maxLOD?e:0},i.readMaxScale=function(e,t){return null!=t.minLOD&&null!=t.maxLOD?e:0},i.readMosaicRule=function(e,t){return q.fromJSON(e||t.mosaicRule||t)},i.writeMosaicRule=function(e,t,r){let i=this.mosaicRule;const n=this.definitionExpression;i?n&&n!==i.where&&(i=i.clone(),i.where=n):n&&(i=new q({where:n})),this._isValidCustomizedMosaicRule(i)&&(t[r]=i.toJSON())},i.writeNoData=function(e,t,r){null!=e&&"number"==typeof e&&(t[r]=$(e))},i.readObjectIdField=function(e,t){if(!e){const r=t.fields.filter((e=>"esriFieldTypeOID"===e.type||"oid"===e.type));e=r&&r[0]&&r[0].name}return e},i.readRenderer=function(e,t,r){const i=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,n=P.read(i,r)||void 0;if(null!=n)return j.isSupportedRendererType(n)||G.warn("ArcGISImageService","Imagery layer doesn't support given renderer type."),n},i.readRenderingRule=function(e,t){const r=t.rasterFunctionInfos;return t.renderingRule||r&&r.length&&"None"!==r[0].name?M.fromJSON(t.renderingRule||{rasterFunctionInfos:t.rasterFunctionInfos}):null},i.writeRenderingRule=function(e,t,r){this._isRFTJson(e)||(t[r]=e.toJSON())},i.readSpatialReference=function(e,t){const r=e||t.extent.spatialReference;return r?R.fromJSON(r):null},i.readPixelType=function(e){return Y.fromJSON(e)||e},i.writePixelType=function(e,t,r){(a.isNone(this.serviceRasterInfo)||this.pixelType!==this.serviceRasterInfo.pixelType)&&(t[r]=Y.toJSON(e))},i.readVersion=function(e,t){let r=t.currentVersion;return r||(r=t.hasOwnProperty("fields")||t.hasOwnProperty("timeInfo")?10:9.3),r},i.applyFilter=function(e){let t=e;return this.pixelFilter&&(t=this._clonePixelData(e),this.pixelFilter(t)),t},i.applyRenderer=async function(e,t){let r=e;if(!this._isPicture()&&this.renderer&&this._symbolizer&&!this.pixelFilter){const i=JSON.stringify(this._cachedRendererJson)!==JSON.stringify(this.renderer.toJSON()),n=this._rasterJobHandler.instance,{bandIds:a}=this;if(n){i&&(this._symbolizer.bind(),await n.updateSymbolizer(this._symbolizer,t),this._cachedRendererJson=this.renderer.toJSON());const s=await n.symbolize({bandIds:a,...e},t);r={extent:e.extent,pixelBlock:s}}else r={extent:e.extent,pixelBlock:this._symbolizer.symbolize({bandIds:a,...e})}}return r},i.destroy=function(){this._shutdownJobHandler()},i.increaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount++},i.decreaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()},i.computeHistograms=async function(e,t){const r=null==t?void 0:t.signal;if(await this._fetchCapabilities(r),!this.capabilities.operations.supportsComputeHistograms)throw new f("imagery-layer:compute-histograms","this operation is not supported on the input image service");e=e.clone();const{raster:i,mosaicRule:n,renderingRule:a}=this;return a&&null==e.renderingRule&&(e.renderingRule=a),n&&null==e.mosaicRule&&(e.mosaicRule=n),i&&null==e.raster&&(e.raster=i),L.computeHistograms(this.url,e,{signal:r})},i.computeStatisticsHistograms=async function(e,t){const r=null==t?void 0:t.signal;if(await this._fetchCapabilities(r),!this.capabilities.operations.supportsComputeStatisticsHistograms)throw new f("imagery-layer:compute-statistics-histograms","this operation is not supported on the input image service");e=e.clone();const{raster:i,mosaicRule:n,renderingRule:a}=this;return a&&null==e.renderingRule&&(e.renderingRule=a),n&&null==e.mosaicRule&&(e.mosaicRule=n),i&&null==e.raster&&(e.raster=i),L.computeStatisticsHistograms(this.url,e,{signal:r})},i.fetchImage=function(e,t,r,i={}){if(null==e||null==t||null==r)return _.reject(new f("imagery-layer:fetch-image","Insufficient parameters for requesting an image. A valid extent, width and height values are required."));const n=this.renderer||this._symbolizer?this.generateRasterInfo(this.renderingRule,{signal:i.signal}):null;return _.when(n).then((n=>{n&&(this.rasterInfo=n);const a={imageServiceParameters:this.getExportImageServiceParameters(e,t,r,i.timeExtent),imageProps:{extent:e,width:t,height:r,format:this.format},requestAsImageElement:i.requestAsImageElement&&!this.pixelFilter||!1,signal:i.signal};return this._requestArrayBuffer(a)}))},i.fetchKeyProperties=function(e){const t=e&&e.renderingRule&&e.renderingRule.toJSON();return S(this.parsedUrl.path+"/keyProperties",{query:this._getQueryParams({renderingRule:this.version>=10.3&&t?JSON.stringify(t):null})}).then((e=>e.data))},i.fetchRasterAttributeTable=function(e){const t=e&&e.renderingRule&&e.renderingRule.toJSON();return this.version<10.1?_.reject(new f("#fetchRasterAttributeTable()","Failed to get rasterAttributeTable")):S(this.parsedUrl.path+"/rasterAttributeTable",{query:this._getQueryParams({renderingRule:this.version>=10.3&&t?JSON.stringify(t):null})}).then((e=>F.fromJSON(e.data)))},i.getCatalogItemRasterInfo=async function(e,t){const r=S(this.parsedUrl.path+"/"+e+"/info",{query:this._getQueryParams(),...t}).then((e=>e.data)),i=S(this.parsedUrl.path+"/"+e+"/info/keyProperties",{query:this._getQueryParams(),...t}).then((e=>e.data)).catch((()=>{})),n=await _.all([r,i]);if(!n[0])return;const a=b.fromJSON(n[0].extent),s=n[0].statistics?n[0].statistics.map((e=>({min:e[0],max:e[1],avg:e[2],stddev:e[3]}))):null;return new A({bandCount:n[0].bandCount,extent:a,spatialReference:a.sr,pixelSize:new v({x:n[0].pixelSizeX,y:n[0].pixelSizeY,spatialReference:a.sr}),pixelType:n[0].pixelType.toLowerCase(),statistics:s,histograms:n[0].histograms,keyProperties:n[1]||{}})},i.getCatalogItemICSInfo=async function(e,t){const{data:r}=await S(this.parsedUrl.path+"/"+e+"/info/ics",{query:this._getQueryParams(),...t}),i=r&&r.ics;if(!i)return;let n=null;try{n=(await S(this.parsedUrl.path+"/"+e+"/info",{query:this._getQueryParams(),...t})).data.extent}catch{}if(!n||!n.spatialReference)return{ics:i,icsToPixelTransform:null,icsExtent:null,northDirection:null};const a=this.version>=10.7?S(this.parsedUrl.path+"/"+e+"/info/icstopixel",{query:this._getQueryParams(),...t}).then((e=>e.data)).catch((()=>({}))):{},s=n.spatialReference,o={geometries:JSON.stringify({geometryType:"esriGeometryEnvelope",geometries:[n]}),inSR:s.wkid||JSON.stringify(s),outSR:"0:"+e},l=S(this.parsedUrl.path+"/project",{query:this._getQueryParams(o),...t}).then((e=>e.data)).catch((()=>({}))),u=(n.xmin+n.xmax)/2,p=(n.ymax-n.ymin)/6,c=n.ymin+p,d=[];for(let e=0;e<5;e++)d.push({x:u,y:c+p*e});const h={geometries:JSON.stringify({geometryType:"esriGeometryPoint",geometries:d}),inSR:s.wkid||JSON.stringify(s),outSR:"0:"+e},f=S(this.parsedUrl.path+"/project",{query:this._getQueryParams(h),...t}).then((e=>e.data)).catch((()=>({}))),m=await _.all([a,l,f]);let y=m[0].ipxf;if(null==y){var g,v,x;const e=null==(g=i.geodataXform)?void 0:g.xf_0;"topup"===(null==e||null==(v=e.name)?void 0:v.toLowerCase())&&6===(null==e||null==(x=e.coefficients)?void 0:x.length)&&(y={affine:{name:"ics [sensor: Frame] to pixel (column, row) transformation",coefficients:e.coefficients,cellsizeRatio:0,type:"GeometricXform"}})}const I=b.fromJSON(m[1]&&m[1].geometries&&m[1].geometries[0]);I&&(I.spatialReference=new R({wkid:0,imageCoordinateSystem:i}));const w=m[2].geometries?m[2].geometries.filter((e=>null!=e&&null!=e.x&&null!=e.y&&"NaN"!==e.x&&"NaN"!==e.y)):[],O=w.length;if(O<3)return{ics:i,icsToPixelTransform:y,icsExtent:I,northDirection:null};let N=0,P=0,D=0,T=0;for(let e=0;e<O;e++)N+=w[e].x,P+=w[e].y,D+=w[e].x*w[e].x,T+=w[e].x*w[e].y;const F=(O*T-N*P)/(O*D-N*N);let C=0;const J=w[4].x>w[0].x,V=w[4].y>w[0].y;return F===1/0?C=V?90:270:0===F?C=J?0:180:F>0?C=J?180*Math.atan(F)/Math.PI:180*Math.atan(F)/Math.PI+180:F<0&&(C=V?180+180*Math.atan(F)/Math.PI:360+180*Math.atan(F)/Math.PI),{ics:i,icsToPixelTransform:y,icsExtent:I,northDirection:C}},i.generateRasterInfo=async function(e,t){if((!e||"none"===e.functionName.toLowerCase())&&a.isSome(this.serviceRasterInfo))return this.serviceRasterInfo;const r=function(e){if(!e)return null;const t=JSON.stringify(e).match(/"rasterFunction":"(.*?")/gi),r=null==t?void 0:t.map((e=>e.replace('"rasterFunction":"',"").replace('"',"")));return r?r.join("/"):null}(e);if(this._functionRasterInfos[r])return this._functionRasterInfos[r];const i=this._generateRasterInfo(e,t);this._functionRasterInfos[r]=i;try{return await i}catch{return this._functionRasterInfos[r]=null,null}},i.getExportImageServiceParameters=function(e,t,r,i){const n=(e=e.clone().shiftCentralMeridian()).spatialReference;let s;if(n.imageCoordinateSystem){const{id:e,referenceServiceName:t}=n.imageCoordinateSystem;s=null!=e?t?this.parsedUrl.path.toLowerCase().indexOf("/"+t.toLowerCase()+"/")>-1?"0:"+e:JSON.stringify({icsid:e,icsns:t}):"0:"+e:JSON.stringify({ics:n.imageCoordinateSystem})}else s=n.wkid||JSON.stringify(n.toJSON());a.isSome(this.serviceRasterInfo)&&this.pixelType!==this.serviceRasterInfo.pixelType&&(this.exportImageServiceParameters.pixelType=this.pixelType);const o=this.exportImageServiceParameters.toJSON(),{bandIds:l,noData:u,mosaicRule:p,renderingRule:c}=o;l instanceof Array&&l.length>0&&(o.bandIds=l.join(",")),u instanceof Array&&u.length>0&&(o.noData=u.join(","));const d=this.timeInfo;p&&p.multidimensionalDefinition&&i&&d&&d.startField&&(p.multidimensionalDefinition=p.multidimensionalDefinition.filter((e=>e.dimensionName!==d.startField))),o.mosaicRule=p&&JSON.stringify(p),o.renderingRule=c&&JSON.stringify(c);const h={};if(i){const{start:e,end:t}=i.toJSON();e&&t&&e===t?h.time=""+e:null==e&&null==t||(h.time=`${null==e?"null":e},${null==t?"null":t}`)}return{bbox:e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,bboxSR:s,imageSR:s,size:t+","+r,...o,...h}},i.identify=async function(e,t){if(await this._fetchCapabilities(null==t?void 0:t.signal),!this.capabilities.operations.supportsIdentify)throw new f("imagery-layer:query-rasters","query operation is not supported on the input image service");e=e.clone();const{raster:r,mosaicRule:i,renderingRule:n}=this;n&&null==e.renderingRule&&(e.renderingRule=n),i&&null==e.mosaicRule&&(e.mosaicRule=i),r&&null==e.raster&&(e.raster=r);return new Q({url:this.url}).execute(e,t)},i.queryRasters=async function(e,t){if(await this._fetchCapabilities(null==t?void 0:t.signal),!this.capabilities.operations.supportsQuery)throw new f("imagery-layer:query-rasters","query operation is not supported on the input image service");return this.queryTask.execute(e,t)},i.queryVisibleRasters=function(e,t){if(!e)return _.reject(new f("imagery-layer: query-visible-rasters","missing query parameter"));const{pixelSize:r,returnDomainValues:i,returnTopmostRaster:n,showNoDataRecords:s}=t||{pixelSize:null,returnDomainValues:!1,returnTopmostRaster:!1,showNoDataRecords:!1};let o=!1,l=null,u=null;const p="raster.servicepixelvalue",c=this.rasterFunctionNamesIndex;if(a.isSome(e.outFields)&&(o=e.outFields.some((e=>-1===e.toLowerCase().indexOf(p))),this.version>=10.4)){const t=e.outFields.filter((e=>e.toLowerCase().indexOf(p)>-1&&e.length>p.length)).map((e=>{const t=e.slice(p.length+1);return[this._updateRenderingRulesFunctionName(t,c),t]}));l=t.map((e=>new M({functionName:e[0]}))),u=t.map((e=>e[1])),0===l.length?this.renderingRule?(l.push(this.renderingRule),u.push(this.renderingRule.functionName)):l=null:this.renderingRule&&!l.some((e=>e.functionName===this.renderingRule.functionName))&&(l.push(this.renderingRule),u.push(this.renderingRule.functionName))}const d=a.isNone(e.outSpatialReference)||e.outSpatialReference.equals(this.spatialReference),h=this._getQueryParams({geometry:e.geometry,timeExtent:e.timeExtent,mosaicRule:this.exportImageServiceParameters.mosaicRule,renderingRule:this.version<10.4?this.renderingRule:null,renderingRules:l,pixelSize:r,returnCatalogItems:o,returnGeometry:d,maxItemCount:n?1:null});delete h.f;const m=new B(h),y=new Q({url:this.url}),g=this.generateRasterInfo(this.renderingRule);return _.create((t=>{g.then((()=>{y.execute(m).then((r=>{const n=e.outFields;if(o&&!d&&r.catalogItems&&r.catalogItems.features&&r.catalogItems.features.length>0){const a=this.objectIdField||"ObjectId",o=r.catalogItems.features,l=o.map((e=>e.attributes&&e.attributes[a])),p=new C({objectIds:l,returnGeometry:!0,outSpatialReference:e.outSpatialReference,outFields:[a]});return this.queryRasters(p).then((l=>{l&&l.features&&l.features.length>0&&l.features.forEach((t=>{o.forEach((r=>{r.attributes[a]===t.attributes[a]&&(r.geometry=new x(t.geometry),r.geometry.spatialReference=e.outSpatialReference)}))})),t(this._processVisibleRastersResponse(r,{returnDomainValues:i,templateRRFunctionNames:u,showNoDataRecords:s,templateFields:n}))})).catch((()=>{throw new f("imagery-layer:query-visible-rasters","encountered error when querying visible rasters geometry")}))}t(this._processVisibleRastersResponse(r,{returnDomainValues:i,templateRRFunctionNames:u,showNoDataRecords:s,templateFields:n}))})).catch((()=>{throw new f("imagery-layer:query-visible-rasters","encountered error when querying visible rasters")}))}))}))},i.fetchVariableStatisticsHistograms=async function(e,t){const r=S(this.parsedUrl.path+"/statistics",{query:this._getQueryParams({variable:e}),signal:t}).then((e=>{var t;return null==(t=e.data)?void 0:t.statistics})),i=S(this.parsedUrl.path+"/histograms",{query:this._getQueryParams({variable:e}),signal:t}).then((e=>{var t;return null==(t=e.data)?void 0:t.histograms})),n=await _.all([r,i]);return n[0]&&n[0].forEach((e=>{e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:n[0]||null,histograms:n[1]||null}},i._fetchService=async function(e){await this._fetchServiceInfo(e),a.isSome(this.serviceRasterInfo)&&!this.rasterInfo&&(this.rasterInfo=this.serviceRasterInfo);const t=this.sourceJSON,r=a.isSome(this.serviceRasterInfo)?_.resolve(this.serviceRasterInfo):this._fetchAuxiliaryRasterInfo({serviceInfo:t,signal:e}).then((e=>(this._set("serviceRasterInfo",e),e))),i=this.renderingRule&&"none"!==this.renderingRule.functionName.toLowerCase()?this.generateRasterInfo(this.renderingRule,{signal:e}):null;return _.all([r,i]).then((e=>{e[1]?this._set("rasterInfo",e[1]):this._set("rasterInfo",e[0]),this.renderer&&U.getSupportedRendererTypes(this.rasterInfo).indexOf(this.renderer.type)<0&&(this.renderer=null,G.warn("ArcGISImageService","Switching to the default renderer. Renderer applied is not valid for this Imagery Layer")),this._configDefaultRenderer(),this.watch("renderer",(()=>this._configDefaultRenderer())),this.watch("renderingRule",(e=>{(this.renderer||this._symbolizer||this.popupEnabled&&this.popupTemplate)&&this.generateRasterInfo(e).then((e=>{e&&(this.rasterInfo=e)}))}));const t=a.isSome(this.serviceRasterInfo)&&this.serviceRasterInfo.multidimensionalInfo;t&&this._updateMultidimensionalDefinition(t)}))},i._initJobHandler=async function(){if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;const e=new k;this._rasterJobHandler.connectionPromise=e.initialize().then((()=>{this._rasterJobHandler.instance=e}),(()=>null)),await this._rasterJobHandler.connectionPromise},i._shutdownJobHandler=function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0},i._fetchCapabilities=async function(e){return this.capabilities||await this._fetchServiceInfo(e),this.capabilities},i._fetchServiceInfo=async function(e){var t;let r=this.sourceJSON;if(!r){const{data:t,ssl:i}=await S(this.parsedUrl.path,{query:this._getQueryParams(),signal:e});r=t,this.sourceJSON=r,i&&(this.url=this.url.replace(/^http:/i,"https:"))}if((null==(t=r.capabilities)?void 0:t.toLowerCase().split(",").map((e=>e.trim())).indexOf("tilesonly"))>-1)throw new f("imagery-layer:fetch-service-info","use ImageryTileLayer to open tiles-only image services");this.read(r,{origin:"service",url:this.parsedUrl})},i._isPicture=function(){return!this.format||this.format.indexOf("jpg")>-1||this.format.indexOf("png")>-1},i._configDefaultRenderer=function(){if(!this._isPicture()&&!this.pixelFilter){if(!this.bandIds&&this.rasterInfo.bandCount>=3){const e=U.getDefaultBandCombination(this.rasterInfo);!e||3===this.rasterInfo.bandCount&&0===e[0]&&1===e[1]&&2===e[2]||(this.bandIds=e)}var e,t;if(!this.renderer)this.renderer=U.createDefaultRenderer(this.rasterInfo,{bandIds:this.bandIds,variableName:this.renderingRule?null:null==(e=this.mosaicRule)||null==(t=e.multidimensionalDefinition)?void 0:t[0].variableName});this._symbolizer?(this._symbolizer.rendererJSON=this.renderer.toJSON(),this._symbolizer.rasterInfo=this.rasterInfo):this._symbolizer=new E({rendererJSON:this.renderer.toJSON(),rasterInfo:this.rasterInfo}),this._symbolizer.bind()||(this._symbolizer=null)}},i._clonePixelData=function(e){return null==e?e:{extent:e.extent&&e.extent.clone(),pixelBlock:e.pixelBlock&&e.pixelBlock.clone()}},i._getQueryParams=function(e){const{raster:t,viewId:r}=this;return{raster:t,viewId:r,f:"json",...e}},i._decodePixelBlock=function(e,t,r){return this._rasterJobHandler.instance?this._rasterJobHandler.instance.decode({data:e,options:t}):H.decode(e,t,r)},i._fetchMultidimensionalInfo=async function(e){var t;const r=await S(this.parsedUrl.path+"/multidimensionalInfo",{query:this._getQueryParams(),signal:e}).then((e=>{var t;return null==(t=e.data)?void 0:t.multidimensionalInfo}));return null!=(t=r.variables)&&t.length&&r.variables.forEach((e=>{var t;null!=(t=e.statistics)&&t.length&&e.statistics.forEach((e=>{e.avg=e.mean,e.stddev=e.standardDeviation}))})),r},i._fetchAuxiliaryRasterInfo=function(e){const t=e&&e.serviceInfo;if(!t)return _.reject(new f("imagery-layer:fetch-metadata","valid serviceInfo is required"));const r=e.renderingRule?JSON.stringify(e.renderingRule.toJSON()):null,i=e.signal,n=!!(t.hasRasterAttributeTable&&this.version>=10.1)&&S(this.parsedUrl.path+"/rasterAttributeTable",{query:this._getQueryParams({renderingRule:this.version>=10.1?r:null}),signal:i}).then((e=>F.fromJSON(e.data))).catch((()=>null)),a=!!(t.hasColormap&&this.version>=10.1)&&S(this.parsedUrl.path+"/colormap",{query:this._getQueryParams({renderingRule:this.version>=10.6?r:null}),signal:i}).then((e=>{var t;return null==(t=e.data)?void 0:t.colormap})),s=!!(t.hasHistograms&&this.version>=10.1)&&S(this.parsedUrl.path+"/histograms",{query:this._getQueryParams({renderingRule:this.version>=10.1?r:null}),signal:i}).then((e=>{var t;return null==(t=e.data)?void 0:t.histograms})),o=this.version>=10.3&&S(this.parsedUrl.path+"/keyProperties",{query:this._getQueryParams({renderingRule:r}),signal:i}).then((e=>e.data)).catch((()=>{})),l=!!(t.hasMultidimensions&&this.version>=10.3)&&this._fetchMultidimensionalInfo();return _.all([n,a,s,o,l]).then((e=>{let r=null;if(t.minValues&&t.minValues.length===t.bandCount){r=[];for(let e=0;e<t.minValues.length;e++)r.push({min:t.minValues[e],max:t.maxValues[e],avg:t.meanValues[e],stddev:t.stdvValues[e]})}const i=Math.ceil((t.extent.xmax-t.extent.xmin)/t.pixelSizeX-.1),n=Math.ceil((t.extent.ymax-t.extent.ymin)/t.pixelSizeY-.1),a=R.fromJSON(t.spatialReference||t.extent.spatialReference);return new A({width:i,height:n,bandCount:t.bandCount,extent:b.fromJSON(t.extent),spatialReference:a,pixelSize:new v({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:a}),pixelType:t.pixelType.toLowerCase(),statistics:r,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||{},multidimensionalInfo:e[4]||null})}))},i._requestArrayBuffer=function(e){const{imageProps:t,requestAsImageElement:r,signal:i}=e;if(r&&!this.pixelFilter&&t.format&&t.format.indexOf("png")>-1)return S(this.parsedUrl.path+"/exportImage",{responseType:"image",query:this._getQueryParams({f:"image",...e.imageServiceParameters}),signal:i}).then((e=>({imageElement:e.data,params:t})));const n=this._initJobHandler(),a=S(this.parsedUrl.path+"/exportImage",{responseType:"array-buffer",query:this._getQueryParams({f:"image",...e.imageServiceParameters}),signal:i});return _.all([a,n]).then((e=>{const r=e[0].data,n=t.format||"jpgpng";let a=n;if("bsq"!==a&&"bip"!==a&&(a=H.getFormat(r)),!a){throw new f("imagery-layer:fetch-image","unsupported format signature "+String.fromCharCode.apply(null,new Uint8Array(r)))}const s="gif"===n||"bmp"===n||n.indexOf("png")>-1&&("png"===a||"jpg"===a),o={signal:i};return s?H.decode(r,{useCanvas:!0,...t},o).then((e=>({pixelData:{pixelBlock:e,extent:t.extent},params:t}))):this._decodePixelBlock(r,{width:t.width,height:t.height,planes:null,pixelType:null,noDataValue:null,format:n},o).then((e=>({pixelData:{pixelBlock:e,extent:t.extent},params:t})))}))},i._generateRasterInfo=async function(e,t){const{data:r}=await S(this.parsedUrl.path,{query:this._getQueryParams({renderingRule:e}),...t});return await this._fetchAuxiliaryRasterInfo({serviceInfo:r,renderingRule:e,...t})},i._isValidCustomizedMosaicRule=function(e){return e&&JSON.stringify(e.toJSON())!==JSON.stringify(this._defaultServiceMosaicRule&&this._defaultServiceMosaicRule.toJSON())},i._updateMultidimensionalDefinition=function(e){if(this._isValidCustomizedMosaicRule(this.mosaicRule))return;const t=e.variables[0].dimensions,r=[];for(const e in t)if(t.hasOwnProperty(e)){const i=t[e],n=i.extent;let a=!0,s=[n[0]];i.hasRanges&&!0===i.hasRanges?(a=!1,s=[i.values[0]]):"stdz"===i.name.toLowerCase()&&Math.abs(n[1])<=Math.abs(n[0])&&(s=[n[1]]),r.push(new V({variableName:"",dimensionName:t[e].name,isSlice:a,values:s}))}if(r.length>0){this.mosaicRule=this.mosaicRule||new q;const e=this.mosaicRule.multidimensionalDefinition;(!e||e&&e.length<=0)&&(this.mosaicRule.multidimensionalDefinition=r)}},i._formatAttributeValue=function(e,t){if("string"==typeof e){const r=this.popupTemplate&&this.popupTemplate.fieldInfos,i=this._getFieldInfo(r,t),n=i&&i.format;if(n){let t,r;return e.trim().indexOf(",")>-1?(t=",",r=t+" ",this._formatDelimitedString(e,t,r,n)):e.trim().indexOf(" ")>-1?(t=r=" ",this._formatDelimitedString(e,t,r,n)):this._formatNumberFromString(e,n)}}return e},i._getFieldInfo=function(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let i;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r&&e.fieldName.toLowerCase()!==r.replace(/ /g,"_"))&&(i=e,!0))),i},i._formatDelimitedString=function(e,t,r,i){return e&&t&&r&&i?e.trim().split(t).map((e=>this._formatNumberFromString(e,i))).join(r):e},i._formatNumberFromString=function(e,t){if(!e||!t)return e;const r=Number(e);return isNaN(r)?e:t.format(r)},i._processVisibleRastersResponse=function(e,t){t=t||{};const r=e.value,{templateRRFunctionNames:i,showNoDataRecords:n,returnDomainValues:s,templateFields:o}=t,l=e.processedValues;let u=e.catalogItems&&e.catalogItems.features,p=e.properties&&e.properties.Values&&e.properties.Values.map((e=>e.replace(/ /gi,", ")))||[];const c=this.objectIdField||"ObjectId",d="string"==typeof r&&r.toLowerCase().indexOf("nodata")>-1,h=[];if(r&&!u&&!d){const e={};e[c]=0;p=[r],u=[new w(this.fullExtent,null,e)]}if(!u)return[];let f,m,y;this._updateResponseFieldNames(u,o);for(let e=0;e<u.length;e++){if(f=u[e],null!=r&&!d){if(m=p[e],y=this.renderingRule&&l&&l.length>0&&i&&i.length>0&&i.indexOf(this.renderingRule.functionName)>-1?l[i.indexOf(this.renderingRule.functionName)]:r,"nodata"===m.toLowerCase()&&!n)continue;const t="Raster.ItemPixelValue",s="Raster.ServicePixelValue";f.attributes[t]=this._formatAttributeValue(m,t),f.attributes[s]=this._formatAttributeValue(y,s),this._updateFeatureWithMagDirValues(f,m);const o=this.fields&&this.fields.length>0;let u=this.renderingRule&&a.isSome(this.serviceRasterInfo)&&this.serviceRasterInfo.attributeTable?o?m:r:y;this.renderingRule||(u=o?m:r),this._updateFeatureWithRasterAttributeTableValues(f,u)}if(f.sourceLayer=this,s&&this._updateFeatureWithDomainValues(f),i&&l&&i.length===l.length)for(let e=0;e<i.length;e++){const t="Raster.ServicePixelValue."+i[e];f.attributes[t]=this._formatAttributeValue(l[e],t)}h.push(u[e])}return h},i._updateFeatureWithRasterAttributeTableValues=function(e,t){const r=this.rasterInfo&&this.rasterInfo.attributeTable||a.isSome(this.serviceRasterInfo)&&this.serviceRasterInfo.attributeTable,i=r&&r.features;if(!i)return;const n=r.fields,s=n.map((e=>e.name)).filter((e=>"value"===e.toLowerCase())),o=s&&s[0];if(!o)return;const l=i.filter((e=>e.attributes[o]===(null!=t?parseInt(t,10):null)));l&&l[0]&&n.forEach((t=>{const r=this.rasterAttributeTableFieldPrefix+t.name;e.attributes[r]=this._formatAttributeValue(l[0].attributes[t.name],r)}))},i._updateFeatureWithMagDirValues=function(e,t){if(!this.pixelFilter||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType)return;const r=t.replace(" ",",").split(",").map((e=>parseFloat(e))),i=r.map((e=>[e])),n=r.map((e=>({minValue:e,maxValue:e,noDataValue:null}))),a=new N({height:1,width:1,pixelType:"f32",pixels:i,statistics:n});this.pixelFilter({pixelBlock:a,extent:new b(0,0,0,0,this.spatialReference)}),e.attributes["Raster.Magnitude"]=a.pixels[0][0],e.attributes["Raster.Direction"]=a.pixels[1][0]},i._updateFeatureWithDomainValues=function(e){const t=this.fields&&this.fields.filter((e=>e.domain&&"coded-value"===e.domain.type));null!=t&&t.forEach((t=>{const r=e.attributes[t.name];if(null!=r){const i=t.domain.codedValues.filter((e=>e.code===r))[0];i&&(e.attributes[t.name]=i.name)}}))},i._updateResponseFieldNames=function(e,t){if(!t||t.length<1)return;const r=this.fieldsIndex;r&&e.forEach((e=>{if(e&&e.attributes)for(const i of t)if(r.has(i)){const t=r.get(i).name;t!==i&&(e.attributes[i]=e.attributes[t],delete e.attributes[t])}}))},i._updateRenderingRulesFunctionName=function(e,t){if(!e||e.length<1)return;if("Raw"===e)return e.replace("Raw","None");const r=e.toLowerCase().replace(/ /gi,"_");return t.has(r)?t.get(r):e},i._isRFTJson=function(e){return e.name&&e.arguments&&e.function&&e.hasOwnProperty("functionType")},i._readCapabilities=function(e){const t=e.capabilities?e.capabilities.toLowerCase().split(",").map((e=>e.trim())):["image","catalog"],{currentVersion:r,advancedQueryCapabilities:i,maxRecordCount:n}=e,a=t.indexOf("image")>-1,s="esriImageServiceDataTypeElevation"===e.serviceDataType,o=!!(e.spatialReference||e.extent&&e.extent.spatialReference);return{operations:{supportsComputeHistograms:a,supportsExportImage:a,supportsIdentify:a,supportsMeasure:t.indexOf("mensuration")>-1&&o,supportsDownload:t.indexOf("download")>-1,supportsQuery:t.indexOf("catalog")>-1&&e.fields&&e.fields.length>0,supportsGetSamples:r>=10.2&&a,supportsProject:r>=10.3&&a,supportsComputeStatisticsHistograms:r>=10.4&&a,supportsQueryBoundary:r>=10.6&&a,supportsCalculateVolume:r>=10.7&&s,supportsComputePixelLocation:r>=10.7&&t.indexOf("catalog")>-1},query:{supportsStatistics:!(!i||!i.supportsStatistics),supportsOrderBy:!(!i||!i.supportsOrderBy),supportsDistinct:!(!i||!i.supportsDistinct),supportsPagination:!(!i||!i.supportsPagination),supportsStandardizedQueriesOnly:!(!i||!i.useStandardizedQueries),maxRecordCount:n}}},t._createClass(r,[{key:"rasterFunctionNamesIndex",get:function(){const e=new Map;return!this.rasterFunctionInfos||this.rasterFunctionInfos.length<1||this.rasterFunctionInfos.forEach((t=>{e.set(t.name.toLowerCase().replace(/ /gi,"_"),t.name)})),e}},{key:"queryTask",get:function(){return new J({url:this.url})}},{key:"fieldsIndex",get:function(){return this.fields?new T(this.fields):null}},{key:"format",set:function(e){e&&K.has(e.toLowerCase())&&this._set("format",e.toLowerCase())}},{key:"mosaicRule",set:function(e){let t=e;t&&t.mosaicMethod&&(t=q.fromJSON({...t.toJSON(),mosaicMethod:t.mosaicMethod,mosaicOperation:t.mosaicOperation})),this._set("mosaicRule",t)}},{key:"parsedUrl",get:function(){return this.url?m.urlToObject(this.url):null}},{key:"rasterFields",get:function(){const e=this.rasterAttributeTableFieldPrefix||"Raster.",t=new D({name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"string"}),r=new D({name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"string"}),i=new D({name:"Raster.ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"string"});let a=this.fields?n.clone(this.fields):[];a.push(r),this.capabilities.operations.supportsQuery&&this.fields&&this.fields.length>0&&a.push(t),this.version>=10.4&&this.rasterFunctionInfos&&this.rasterFunctionInfos.some((e=>"none"===e.name.toLowerCase()))&&a.push(i),this.rasterFunctionInfos&&this.rasterFunctionInfos.filter((e=>"none"!==e.name.toLowerCase())).forEach((e=>{a.push(new D({name:"Raster.ServicePixelValue."+e.name,alias:e.name,domain:null,editable:!1,length:50,type:"string"}))})),null==this.pixelFilter||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(a.push(new D({name:"Raster.Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"double"})),a.push(new D({name:"Raster.Direction",alias:"Direction",domain:null,editable:!1,type:"double"})));const s=this.rasterInfo.attributeTable&&this.rasterInfo.attributeTable.fields||null;if(s&&s.length>0){const t=s.filter((e=>"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase())).map((t=>{const r=n.clone(t);return r.name=e+t.name,r}));a=a.concat(t)}return a}},{key:"renderingRule",set:function(e){let t=e;t&&t.rasterFunction&&(t=M.fromJSON({...t.toJSON(),rasterFunction:t.rasterFunction,rasterFunctionArguments:t.rasterFunctionArguments})),this._set("renderingRule",t)}}]),r}(e);return r.__decorate([l.property()],i.prototype,"_functionRasterInfos",void 0),r.__decorate([l.property()],i.prototype,"_rasterJobHandler",void 0),r.__decorate([l.property()],i.prototype,"_symbolizer",void 0),r.__decorate([l.property()],i.prototype,"_defaultServiceMosaicRule",void 0),r.__decorate([c.reader("_defaultServiceMosaicRule",["defaultMosaicMethod"])],i.prototype,"readDefaultServiceMosaicRule",null),r.__decorate([l.property()],i.prototype,"_cachedRendererJson",void 0),r.__decorate([l.property()],i.prototype,"rasterAttributeTableFieldPrefix",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["rasterFunctionInfos"]})],i.prototype,"rasterFunctionNamesIndex",null),r.__decorate([l.property({readOnly:!0,dependsOn:["url"]})],i.prototype,"queryTask",null),r.__decorate([l.property()],i.prototype,"adjustAspectRatio",void 0),r.__decorate([l.property({readOnly:!0}),u.aliasOf("serviceRasterInfo.bandCount")],i.prototype,"bandCount",void 0),r.__decorate([l.property({type:[o.Integer],json:{write:!0}})],i.prototype,"bandIds",void 0),r.__decorate([c.reader("bandIds")],i.prototype,"readBandIds",null),r.__decorate([l.property({readOnly:!0,json:{read:!1}})],i.prototype,"capabilities",void 0),r.__decorate([c.reader("service","capabilities",["capabilities","currentVersion","serviceDataType"])],i.prototype,"readCapabilities",null),r.__decorate([l.property({type:Number})],i.prototype,"compressionQuality",void 0),r.__decorate([h.writer("compressionQuality")],i.prototype,"writeCompressionQuality",null),r.__decorate([l.property({type:Number})],i.prototype,"compressionTolerance",void 0),r.__decorate([h.writer("compressionTolerance")],i.prototype,"writeCompressionTolerance",null),r.__decorate([l.property({json:{read:{source:"copyrightText"}}})],i.prototype,"copyright",void 0),r.__decorate([l.property({type:String,json:{read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],i.prototype,"definitionExpression",void 0),r.__decorate([l.property({readOnly:!0,constructOnly:!0})],i.prototype,"exportImageServiceParameters",void 0),r.__decorate([l.property()],i.prototype,"rasterInfo",void 0),r.__decorate([l.property({readOnly:!0,type:[D]})],i.prototype,"fields",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["fields"]})],i.prototype,"fieldsIndex",null),r.__decorate([l.property({type:["png","png8","png24","png32","jpg","bmp","gif","jpgpng","lerc","tiff"],json:{write:!0}})],i.prototype,"format",null),r.__decorate([c.reader("service","format",["serviceDataType"])],i.prototype,"readFormat",null),r.__decorate([l.property({type:b})],i.prototype,"fullExtent",void 0),r.__decorate([l.property({readOnly:!0})],i.prototype,"hasMultidimensions",void 0),r.__decorate([l.property({json:{read:{source:"maxImageHeight"}}})],i.prototype,"imageMaxHeight",void 0),r.__decorate([l.property({json:{read:{source:"maxImageWidth"}}})],i.prototype,"imageMaxWidth",void 0),r.__decorate([l.property({type:String,json:{type:W.jsonValues,read:W.read,write:W.write}})],i.prototype,"interpolation",void 0),r.__decorate([l.property()],i.prototype,"minScale",void 0),r.__decorate([c.reader("service","minScale")],i.prototype,"readMinScale",null),r.__decorate([l.property()],i.prototype,"maxScale",void 0),r.__decorate([c.reader("service","maxScale")],i.prototype,"readMaxScale",null),r.__decorate([l.property({type:q})],i.prototype,"mosaicRule",null),r.__decorate([c.reader("mosaicRule",["mosaicRule","defaultMosaicMethod"])],i.prototype,"readMosaicRule",null),r.__decorate([h.writer("mosaicRule")],i.prototype,"writeMosaicRule",null),r.__decorate([l.property({readOnly:!0}),u.aliasOf("serviceRasterInfo.multidimensionalInfo")],i.prototype,"multidimensionalInfo",void 0),r.__decorate([l.property({json:{type:o.Integer}})],i.prototype,"noData",void 0),r.__decorate([h.writer("noData")],i.prototype,"writeNoData",null),r.__decorate([l.property({type:String,json:{type:X.jsonValues,read:X.read,write:X.write}})],i.prototype,"noDataInterpretation",void 0),r.__decorate([l.property({type:String,readOnly:!0,json:{read:{source:["fields"]}}})],i.prototype,"objectIdField",void 0),r.__decorate([c.reader("objectIdField")],i.prototype,"readObjectIdField",null),r.__decorate([l.property({readOnly:!0,dependsOn:["url"]})],i.prototype,"parsedUrl",null),r.__decorate([l.property({readOnly:!0}),u.aliasOf("serviceRasterInfo.pixelSize.x")],i.prototype,"pixelSizeX",void 0),r.__decorate([l.property({readOnly:!0}),u.aliasOf("serviceRasterInfo.pixelSize.y")],i.prototype,"pixelSizeY",void 0),r.__decorate([l.property({type:Function})],i.prototype,"pixelFilter",void 0),r.__decorate([l.property()],i.prototype,"raster",void 0),r.__decorate([l.property()],i.prototype,"viewId",void 0),r.__decorate([l.property({types:P.rasterRendererTypes,json:{name:"layerDefinition.drawingInfo.renderer",origins:{"web-scene":{types:P.websceneRasterRendererTypes,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type})}}}}})],i.prototype,"renderer",void 0),r.__decorate([c.reader("renderer")],i.prototype,"readRenderer",null),r.__decorate([l.property(O.opacityDrawingInfo)],i.prototype,"opacity",void 0),r.__decorate([l.property({readOnly:!0}),u.aliasOf("serviceRasterInfo.attributeTable")],i.prototype,"rasterAttributeTable",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["fields","rasterInfo","capabilities"]})],i.prototype,"rasterFields",null),r.__decorate([l.property({readOnly:!0})],i.prototype,"rasterFunctionInfos",void 0),r.__decorate([l.property({type:M})],i.prototype,"renderingRule",null),r.__decorate([c.reader("renderingRule",["renderingRule","rasterFunctionInfos"])],i.prototype,"readRenderingRule",null),r.__decorate([h.writer("renderingRule")],i.prototype,"writeRenderingRule",null),r.__decorate([l.property()],i.prototype,"serviceDataType",void 0),r.__decorate([l.property({readOnly:!0,type:R})],i.prototype,"spatialReference",void 0),r.__decorate([c.reader("spatialReference",["spatialReference","extent"])],i.prototype,"readSpatialReference",null),r.__decorate([l.property({json:{type:Y.jsonValues}})],i.prototype,"pixelType",void 0),r.__decorate([c.reader("pixelType")],i.prototype,"readPixelType",null),r.__decorate([h.writer("pixelType")],i.prototype,"writePixelType",null),r.__decorate([l.property({constructOnly:!0,type:A})],i.prototype,"serviceRasterInfo",void 0),r.__decorate([l.property()],i.prototype,"sourceJSON",void 0),r.__decorate([l.property(O.url)],i.prototype,"url",void 0),r.__decorate([l.property({readOnly:!0})],i.prototype,"version",void 0),r.__decorate([c.reader("version",["currentVersion","fields","timeInfo"])],i.prototype,"readVersion",null),i=r.__decorate([d.subclass("esri.layers.mixins.ArcGISImageService")],i),i},Object.defineProperty(e,"__esModule",{value:!0})}));
