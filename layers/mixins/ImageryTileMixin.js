// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../geometry","../../rasterRenderers","../../request","../../core/Logger","../../core/maybe","../../core/accessorSupport/decorators","../../geometry/support/spatialReferenceUtils","../support/arcgisLayerUrl","../support/commonProperties","../support/DimensionalDefinition","../support/RasterJobHandler","../support/TileInfo","../../renderers/support/rasterRendererHelper","../../renderers/support/RasterSymbolizer"],(function(e,t,r,i,n,o,s,a,l,d,p,u,c,f,h,_,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageryTileMixin=void 0;var m=s.getLogger("esri.layers.mixins.ImageryTileMixin");t.ImageryTileMixin=function(e){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},t.bandIds=null,t.copyright=null,t.fullExtent=null,t.interpolation="nearest",t.raster=null,t.rasterInfo=null,t.sourceJSON=null,t.spatialReference=null,t.tileInfo=null,t.symbolizer=null,t}return r.__extends(t,e),Object.defineProperty(t.prototype,"multidimensionalDefinition",{set:function(e){this.raster&&(this._sliceId=this.raster.getSliceIndex(e)),this._set("multidimensionalDefinition",e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"url",{set:function(e){this._set("url",p.sanitizeUrl(e,m))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{set:function(e){this._set("renderer",e),this.updateRenderer()},enumerable:!1,configurable:!0}),t.prototype.updateRenderer=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return this.loaded?JSON.stringify(this._cachedRendererJson)===JSON.stringify(this.renderer)?[2]:(e=this._rasterJobHandler.instance)?(this.symbolizer.renderer=this.renderer,this.symbolizer.bind(),[4,e.updateSymbolizer(this.symbolizer)]):[2]:[2];case 1:return t.sent(),this._cachedRendererJson=this.renderer.toJSON(),[2]}}))}))},t.prototype.applyRenderer=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o,s;return r.__generator(this,(function(a){switch(a.label){case 0:return(i=e&&e.pixelBlock)&&i.pixels&&i.pixels.length>0?(this.updateRenderer(),o=this._rasterJobHandler.instance,s=this.bandIds,o?[4,o.symbolize(r.__assign(r.__assign({},e),{simpleStretchParams:t,bandIds:s}))]:[3,2]):[2,null];case 1:return n=a.sent(),[3,3];case 2:n=this.symbolizer.symbolize(r.__assign(r.__assign({},e),{simpleStretchParams:t,bandIds:s})),a.label=3;case 3:return[2,n]}}))}))},t.prototype.getTileUrl=function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?this.url+"/tile/"+e+"/"+t+"/"+r:""},t.prototype.getCompatibleTileInfo=function(e,t){if(!this.loaded)return null;var r=d.getInfo(e);return h.create({size:256,spatialReference:e,origin:r?{x:r.origin[0],y:r.origin[1]}:{x:t.xmin,y:t.ymax}})},t.prototype.getCompatibleFullExtent=function(e){return this.loaded?this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)?this._compatibleFullExtent:(this._compatibleFullExtent=this.raster.computeExtent(e),this._compatibleFullExtent):null},t.prototype.fetchTile=function(e,t,i,n){return void 0===n&&(n={}),r.__awaiter(this,void 0,void 0,(function(){var s,a;return r.__generator(this,(function(l){switch(l.label){case 0:return n.requestAsImageElement?(s=this.getTileUrl(e,t,i),[2,o(s,{responseType:"image",query:{sliceId:this._sliceId,_ts:n.timestamp},signal:n.signal}).then((function(e){return e.data}))]):[4,this._initJobHandler()];case 1:return l.sent(),this.multidimensionalDefinition&&(a=this._sliceId,n=r.__assign({multidimensionalDefinition:this.multidimensionalDefinition,sliceId:a},n)),"raster-shaded-relief"===this.renderer.type&&(n=r.__assign({buffer:{cols:1,rows:1}},n)),[2,this.raster.fetchTile(e,t,i,n)]}}))}))},t.prototype.fetchPixels=function(e,t,i,n){return r.__awaiter(this,void 0,void 0,(function(){var o;return r.__generator(this,(function(s){switch(s.label){case 0:return[4,this._initJobHandler()];case 1:return s.sent(),this.multidimensionalDefinition&&(o=this._sliceId,n=r.__assign({multidimensionalDefinition:this.multidimensionalDefinition,sliceId:o},n)),[2,this.raster.fetchPixels(e,t,i,n)]}}))}))},t.prototype.identify=function(e,t){return void 0===t&&(t={}),this.multidimensionalDefinition&&!t.multidimensionalDefinition&&(t=r.__assign(r.__assign({},t),{multidimensionalDefinition:this.multidimensionalDefinition})),this.raster.identify(e,t)},t.prototype.increaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount++},t.prototype.decreaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()},t.prototype._configDefaultSettings=function(){this._configDefaultInterpolation(),this._configDefaultSlice(),this._configDefaultRenderer()},t.prototype._initJobHandler=function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new f;return this._rasterJobHandler.connectionPromise=t.initialize().then((function(){e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,e.renderer&&e.updateRenderer()})).catch((function(){return null})),this._rasterJobHandler.connectionPromise},t.prototype._shutdownJobHandler=function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this.raster.rasterJobHandler=null},t.prototype._configDefaultInterpolation=function(){var e;if(null==this.interpolation){var t=_.getDefaultInterpolation(this.rasterInfo,this.raster.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}},t.prototype._configDefaultSlice=function(){var e=this.raster.rasterInfo.multidimensionalInfo;if(a.isSome(e)){if(!this.multidimensionalDefinition){var t=e.variables[0],r=[];t.dimensions.forEach((function(e){r.push(new c({variableName:t.name,dimensionName:e.name,values:e.hasRegularIntervals?e.extent[0]:e.values[0],isSlice:!0}))})),this.multidimensionalDefinition=r}this._sliceId=this.raster.getSliceIndex(this.multidimensionalDefinition)}},t.prototype._configDefaultRenderer=function(){var e,t=this.raster.rasterInfo;this.bandIds||(this.bandIds=_.getDefaultBandCombination(t)),this.renderer||(this.renderer=_.createDefaultRenderer(t,{bandIds:this.bandIds,variableName:null===(e=this.multidimensionalDefinition)||void 0===e?void 0:e[0].variableName})),this.symbolizer?(this.symbolizer.renderer=this.renderer,this.symbolizer.rasterInfo=t):this.symbolizer=new y({renderer:this.renderer,rasterInfo:t}),this.symbolizer.bind()||m.warn("imagery-tile-mixin","The given renderer is not supported by the layer.")},r.__decorate([l.property()],t.prototype,"_cachedRendererJson",void 0),r.__decorate([l.property()],t.prototype,"_sliceId",void 0),r.__decorate([l.property()],t.prototype,"_compatibleFullExtent",void 0),r.__decorate([l.property()],t.prototype,"_rasterJobHandler",void 0),r.__decorate([l.property()],t.prototype,"bandIds",void 0),r.__decorate([l.property()],t.prototype,"copyright",void 0),r.__decorate([l.property({type:i.Extent}),l.aliasOf("rasterInfo.extent")],t.prototype,"fullExtent",void 0),r.__decorate([l.property()],t.prototype,"interpolation",void 0),r.__decorate([l.property({type:[c]})],t.prototype,"multidimensionalDefinition",null),r.__decorate([l.property()],t.prototype,"raster",void 0),r.__decorate([l.property({readOnly:!0}),l.aliasOf("raster.rasterInfo")],t.prototype,"rasterInfo",void 0),r.__decorate([l.property()],t.prototype,"sourceJSON",void 0),r.__decorate([l.property({type:i.SpatialReference}),l.aliasOf("rasterInfo.spatialReference")],t.prototype,"spatialReference",void 0),r.__decorate([l.property({type:h,dependsOn:["rasterInfo"]}),l.aliasOf("rasterInfo.storageInfo.tileInfo")],t.prototype,"tileInfo",void 0),r.__decorate([l.property(u.url)],t.prototype,"url",null),r.__decorate([l.property({types:n.rasterRendererTypes})],t.prototype,"renderer",null),r.__decorate([l.property()],t.prototype,"symbolizer",void 0),t=r.__decorate([l.subclass("esri.layers.ImageryTileMixin")],t)}(e)}}));