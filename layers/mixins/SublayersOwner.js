// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Collection","../../core/CollectionFlattener","../../core/Error","../../core/Logger","../../core/accessorSupport/decorators","../../core/accessorSupport/PropertyOrigin","../../core/accessorSupport/utils","../support/Sublayer","../support/sublayerUtils"],(function(e,r,t,a,s,o,n,l,i,u,y,c){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SublayersOwner=r.forEachSublayer=void 0;var b=n.getLogger("esri.layers.TileLayer");var d=a.ofType(y);function p(e,r){e&&e.forEach((function(e){r(e),e.sublayers&&e.sublayers.length&&p(e.sublayers,r)}))}r.forEachSublayer=p,r.SublayersOwner=function(e){return function(e){function r(){for(var r,t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];var o=e.apply(this,t)||this;return o.allSublayers=new s({root:o,rootCollectionNames:["sublayers"],getChildrenFunction:function(e){return e.sublayers}}),o.sublayersSourceJSON=((r={})[2]={},r[3]={},r[4]={},r[5]={},r),o.watch("sublayers",(function(e,r){return o._handleSublayersChange(e,r)}),!0),o}return t.__extends(r,e),r.prototype.readSublayers=function(e,r){if(r&&e){var t=this.sublayersSourceJSON,a=i.nameToId(r.origin);if(!(a<2||(t[a]={context:r,visibleLayers:e.visibleLayers||t[a].visibleLayers,layers:e.layers||t[a].layers},a>2))){this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);var s=this.createSublayersForOrigin("web-document"),o=s.sublayers,n=s.origin,l=u.getProperties(this);l.setDefaultOrigin(n),this._set("sublayers",new d(o)),l.setDefaultOrigin("user")}}},r.prototype.findSublayerById=function(e){return this.allSublayers.find((function(r){return r.id===e}))},r.prototype.createServiceSublayers=function(){return this.createSublayersForOrigin("service").sublayers},r.prototype.createSublayersForOrigin=function(e){for(var r="web-document"===e?i.nameToId("web-map"):i.nameToId(e),t=2,a=this.sublayersSourceJSON[2].layers,s=this.sublayersSourceJSON[2].context,o=null,n=0,l=[3,4,5].filter((function(e){return e<=r}));n<l.length;n++){var u=l[n],b=this.sublayersSourceJSON[u];c.isSublayerOverhaul(b.layers)&&(t=u,a=b.layers,s=b.context,b.visibleLayers&&(o={visibleLayers:b.visibleLayers,context:b.context}))}for(var f=[3,4,5].filter((function(e){return e>t&&e<=r})),h=null,v=0,S=f;v<S.length;v++){var g=S[v],O=this.sublayersSourceJSON[g],w=O.layers,m=O.visibleLayers,_=O.context;w&&(h={layers:w,context:_}),m&&(o={visibleLayers:m,context:_})}var L=function(e,r){var t=[],a={};return e?(e.forEach((function(e){var s=new y;if(s.read(e,r),a[s.id]=s,null!=e.parentLayerId&&-1!==e.parentLayerId){var o=a[e.parentLayerId];o.sublayers||(o.sublayers=[]),o.sublayers.unshift(s)}else t.unshift(s)})),t):t}(a,s),x=new Map,N=new Set;if(h)for(var E=0,I=h.layers;E<I.length;E++){var J=I[E];x.set(J.id,J)}if(o)for(var T=0,C=o.visibleLayers;T<C.length;T++){var F=C[T];N.add(F)}return p(L,(function(e){h&&e.read(x.get(e.id),h.context),o&&e.read({defaultVisibility:N.has(e.id)},o.context)})),{origin:i.idToName(t),sublayers:new d({items:L})}},r.prototype.read=function(r,t){e.prototype.read.call(this,r,t),this.readSublayers(r,t)},r.prototype._handleSublayersChange=function(e,r){var t=this;r&&(r.forEach((function(e){e.parent=null,e.layer=null})),this.handles.remove("sublayers-owner")),e&&(e.forEach((function(e){e.parent=t,e.layer=t})),this.handles.add([e.on("after-add",(function(e){var r=e.item;r.parent=t,r.layer=t})),e.on("after-remove",(function(e){var r=e.item;r.parent=null,r.layer=null}))],"sublayers-owner"),"tile"===this.type&&this.handles.add(e.on("before-changes",(function(e){b.error(new o("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{layer:t})),e.preventDefault()})),"sublayers-owner"))},t.__decorate([l.property({readOnly:!0})],r.prototype,"allSublayers",void 0),t.__decorate([l.property({readOnly:!0,type:a.ofType(y)})],r.prototype,"serviceSublayers",void 0),t.__decorate([l.property({value:null,type:d,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],r.prototype,"sublayers",void 0),t.__decorate([l.property({readOnly:!0})],r.prototype,"sublayersSourceJSON",void 0),r=t.__decorate([l.subclass("esri.layers.mixins.SublayersOwner")],r)}(e)}}));