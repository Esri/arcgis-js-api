/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/utils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/Error","../../core/urlUtils","../../core/uuid","../../core/accessorSupport/PropertyOrigin","../../portal/support/resourceExtension","../../core/Collection","../../core/CollectionFlattener","../support/Sublayer","../support/sublayerUtils"],(function(e,r,s,t,o,a,l,n,i,u,c,y,b,d,p,h,f,S){"use strict";const v=o.getLogger("esri.layers.TileLayer");const g=p.ofType(f);function O(e,r){e&&e.forEach((e=>{r(e),e.sublayers&&e.sublayers.length&&O(e.sublayers,r)}))}e.SublayersOwner=e=>{let t=function(e){function s(...s){var t;return(t=e.call(this,...s)||this).allSublayers=new h({root:r._assertThisInitialized(t),rootCollectionNames:["sublayers"],getChildrenFunction:e=>e.sublayers}),t.sublayersSourceJSON={2:{},3:{},4:{},5:{}},t.watch("sublayers",((e,r)=>t._handleSublayersChange(e,r)),!0),t}r._inheritsLoose(s,e);var t=s.prototype;return t.readSublayers=function(e,r){if(!r||!e)return;const{sublayersSourceJSON:s}=this,t=b.nameToId(r.origin);if(t<2)return;if(s[t]={context:r,visibleLayers:e.visibleLayers||s[t].visibleLayers,layers:e.layers||s[t].layers},t>2)return;this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);const{sublayers:o,origin:a}=this.createSublayersForOrigin("web-document"),n=l.getProperties(this);n.setDefaultOrigin(a),this._set("sublayers",new g(o)),n.setDefaultOrigin("user")},t.findSublayerById=function(e){return this.allSublayers.find((r=>r.id===e))},t.createServiceSublayers=function(){return this.createSublayersForOrigin("service").sublayers},t.createSublayersForOrigin=function(e){const r="web-document"===e?b.nameToId("web-map"):b.nameToId(e);let s=2,t=this.sublayersSourceJSON[2].layers,o=this.sublayersSourceJSON[2].context,a=null;const l=[3,4,5].filter((e=>e<=r));for(const e of l){const r=this.sublayersSourceJSON[e];S.isSublayerOverhaul(r.layers)&&(s=e,t=r.layers,o=r.context,r.visibleLayers&&(a={visibleLayers:r.visibleLayers,context:r.context}))}const n=[3,4,5].filter((e=>e>s&&e<=r));let i=null;for(const e of n){const{layers:r,visibleLayers:s,context:t}=this.sublayersSourceJSON[e];r&&(i={layers:r,context:t}),s&&(a={visibleLayers:s,context:t})}const u=function(e,r){const s=[],t={};return e?(e.forEach((e=>{const o=new f;if(o.read(e,r),t[o.id]=o,null!=e.parentLayerId&&-1!==e.parentLayerId){const r=t[e.parentLayerId];r.sublayers||(r.sublayers=[]),r.sublayers.unshift(o)}else s.unshift(o)})),s):s}(t,o),c=new Map,y=new Set;if(i)for(const e of i.layers)c.set(e.id,e);if(a)for(const e of a.visibleLayers)y.add(e);return O(u,(e=>{i&&e.read(c.get(e.id),i.context),a&&e.read({defaultVisibility:y.has(e.id)},a.context)})),{origin:b.idToName(s),sublayers:new g({items:u})}},t.read=function(r,s){e.prototype.read.call(this,r,s),this.readSublayers(r,s)},t._handleSublayersChange=function(e,r){r&&(r.forEach((e=>{e.parent=null,e.layer=null})),this.handles.remove("sublayers-owner")),e&&(e.forEach((e=>{e.parent=this,e.layer=this})),this.handles.add([e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))],"sublayers-owner"),"tile"===this.type&&this.handles.add(e.on("before-changes",(e=>{v.error(new u("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{layer:this})),e.preventDefault()})),"sublayers-owner"))},s}(e);return s.__decorate([n.property({readOnly:!0})],t.prototype,"allSublayers",void 0),s.__decorate([n.property({readOnly:!0,type:p.ofType(f)})],t.prototype,"serviceSublayers",void 0),s.__decorate([n.property({value:null,type:g,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],t.prototype,"sublayers",void 0),s.__decorate([n.property({readOnly:!0})],t.prototype,"sublayersSourceJSON",void 0),t=s.__decorate([i.subclass("esri.layers.mixins.SublayersOwner")],t),t},e.forEachSublayer=O,Object.defineProperty(e,"__esModule",{value:!0})}));
