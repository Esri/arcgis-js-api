/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../config","../../kernel","../../request","../../core/asyncUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/urlUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../support/layerUtils","../../portal/Portal","../../portal/PortalItem","../../portal/PortalUser","../../portal/support/portalItemUtils"],(function(e,t,r,i,o,s,a,l,n,u,c,p,d,h,y,f,m,g,v,I,_,P,U,b){"use strict";const E=t=>{let y=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).resourceReferences={portalItem:null,paths:[]},e.userHasEditingPrivileges=!0,e.userHasFullEditingPrivileges=!1,e.userHasUpdateItemPrivileges=!1,e}r._inheritsLoose(i,t);var h=i.prototype;return h.destroy=function(){this.portalItem=c.destroyMaybe(this.portalItem)},h.readPortalItem=function(e,t,r){if(t.itemId)return new P({id:t.itemId,portal:r&&r.portal})},h.writePortalItem=function(e,t){e&&e.id&&(t.itemId=e.id)},h.loadFromPortal=function(){var t=r._asyncToGenerator((function*(t,r){if(this.portalItem&&this.portalItem.id)try{const i=yield new Promise(((t,r)=>e(["../../portal/support/layersLoader"],t,r)));return p.throwIfAborted(r),yield i.load({instance:this,supportedTypes:t.supportedTypes,validateItem:t.validateItem,supportsData:t.supportsData,layerModuleTypeMap:t.layerModuleTypeMap},r)}catch(i){throw p.isAbortError(i)||u.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\n  ${i}`),i}}));function i(e,r){return t.apply(this,arguments)}return i}(),h.finishLoadEditablePortalLayer=function(){var e=r._asyncToGenerator((function*(e){this._set("userHasEditingPrivileges",yield this._fetchUserHasEditingPrivileges(e).catch((e=>(p.throwIfAbortError(e),!0))))}));function t(t){return e.apply(this,arguments)}return t}(),h._setUserPrivileges=function(){var e=r._asyncToGenerator((function*(e,t){if(!o.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(t);if(this.url)try{const{features:{edit:r,fullEdit:i},content:{updateItem:o}}=yield this._fetchUserPrivileges(e,t);this._set("userHasEditingPrivileges",r),this._set("userHasFullEditingPrivileges",i),this._set("userHasUpdateItemPrivileges",o)}catch(r){p.throwIfAbortError(r)}}));function t(t,r){return e.apply(this,arguments)}return t}(),h._fetchUserPrivileges=function(){var e=r._asyncToGenerator((function*(e,t){let r=this.portalItem;if(!e||!r||!r.loaded||r.sourceUrl)return this._fetchFallbackUserPrivileges(t);const i=e===r.id;if(i&&r.portal.user)return b.getUserPrivileges(r);let o,a;if(i)o=r.portal.url;else try{o=yield I.getOwningPortalUrl(this.url,t)}catch(h){p.throwIfAbortError(h)}if(!o||!d.hasSameCanonicalPortal(o,r.portal.url))return this._fetchFallbackUserPrivileges(t);try{const e=c.isSome(t)?t.signal:null;a=yield s.id?.getCredential(`${o}/sharing`,{prompt:!1,signal:e})}catch(h){p.throwIfAbortError(h)}const l=!0,n=!1,u=!1;if(!a)return{features:{edit:l,fullEdit:n},content:{updateItem:u}};try{if(i?yield r.reload():(r=new P({id:e,portal:{url:o}}),yield r.load(t)),r.portal.user)return b.getUserPrivileges(r)}catch(h){p.throwIfAbortError(h)}return{features:{edit:l,fullEdit:n},content:{updateItem:u}}}));function t(t,r){return e.apply(this,arguments)}return t}(),h._fetchFallbackUserPrivileges=function(){var e=r._asyncToGenerator((function*(e){let t=!0;try{t=yield this._fetchUserHasEditingPrivileges(e)}catch(r){p.throwIfAbortError(r)}return{features:{edit:t,fullEdit:!1},content:{updateItem:!1}}}));function t(t){return e.apply(this,arguments)}return t}(),h._fetchUserHasEditingPrivileges=function(){var e=r._asyncToGenerator((function*(e){const t=this.url?s.id?.findCredential(this.url):null;if(!t)return!0;const r=w.credential===t?w.user:yield this._fetchEditingUser(e);return w.credential=t,w.user=r,c.isNone(r)||null==r.privileges||r.privileges.includes("features:user:edit")}));function t(t){return e.apply(this,arguments)}return t}(),h._fetchEditingUser=function(){var e=r._asyncToGenerator((function*(e){const t=this.portalItem?.portal?.user;if(t)return t;const r=s.id.findServerInfo(this.url??"");if(!r?.owningSystemUrl)return null;const i=`${r.owningSystemUrl}/sharing/rest`,o=_.getDefault();if(o&&o.loaded&&d.normalize(o.restUrl)===d.normalize(i))return o.user;const n=`${i}/community/self`,u=c.isSome(e)?e.signal:null,p=yield l.result(a(n,{authMode:"no-prompt",query:{f:"json"},signal:u}));return p.ok?U.fromJSON(p.value.data):null}));function t(t){return e.apply(this,arguments)}return t}(),h.read=function(e,r){r&&(r.layer=this),t.prototype.read.call(this,e,r)},h.write=function(e,r){const i=r&&r.portal,o=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||_.getDefault());return i&&o&&!d.hasSamePortal(o.restUrl,i.restUrl)?(r.messages&&r.messages.push(new n("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):t.prototype.write.call(this,e,{...r,layer:this})},r._createClass(i,[{key:"portalItem",set:function(e){e!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",e))}}]),i}(t);return i.__decorate([h.property({type:P})],y.prototype,"portalItem",null),i.__decorate([m.reader("web-document","portalItem",["itemId"])],y.prototype,"readPortalItem",null),i.__decorate([v.writer("web-document","portalItem",{itemId:{type:String}})],y.prototype,"writePortalItem",null),i.__decorate([h.property({clonable:!1})],y.prototype,"resourceReferences",void 0),i.__decorate([h.property({type:Boolean,readOnly:!0})],y.prototype,"userHasEditingPrivileges",void 0),i.__decorate([h.property({type:Boolean,readOnly:!0})],y.prototype,"userHasFullEditingPrivileges",void 0),i.__decorate([h.property({type:Boolean,readOnly:!0})],y.prototype,"userHasUpdateItemPrivileges",void 0),y=i.__decorate([g.subclass("esri.layers.mixins.PortalLayer")],y),y},w={credential:null,user:null};t.PortalLayer=E,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
