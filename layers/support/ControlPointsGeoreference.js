/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Logger","../../core/maybe","../../core/perspectiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../chunks/mat3","../../chunks/mat3f64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Point","../../geometry/Polygon","../../geometry/projection","./GeoreferenceBase"],(function(t,o,e,r,n,i,s,c,a,l,u,p,f,P,h,m,y,d,v){"use strict";const _=f.create(),g=h.create();let j=function(o){function e(){var t;return(t=o.apply(this,arguments)||this).sourcePoint=null,t.mapPoint=null,t}return t._inheritsLoose(e,o),e}(e);o.__decorate([c.property()],j.prototype,"sourcePoint",void 0),o.__decorate([c.property({type:m})],j.prototype,"mapPoint",void 0),j=o.__decorate([u.subclass("esri.layers.support.ControlPoint")],j);let N=function(o){function e(t){var e;return(e=o.call(this,t)||this).controlPoints=null,e.height=0,e.type="control-points",e.width=0,e}t._inheritsLoose(e,o);var c=e.prototype;return c.toMap=function(t){if(n.isNone(t)||n.isNone(this.transform)||n.isNone(this.controlPoints)||!S(this.controlPoints[0]))return null;P.set(g,t.x,t.y);const o=this.controlPoints[0].mapPoint.spatialReference;return i.transformProjective(g,g,this.transform),new m({x:g[0],y:g[1],spatialReference:o})},c.toSource=function(t){if(n.isNone(t)||n.isNone(this.inverseTransform)||n.isNone(this.controlPoints)||!S(this.controlPoints[0]))return null;const o=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),t=d.projectOrLoad(t,o).geometry,n.isNone(t)?null:(P.set(g,t.x,t.y),i.transformProjective(g,g,this.inverseTransform),s.createScreenPoint(g[0],g[1]))},c._updateTransform=function(t){const{controlPoints:o,width:e,height:r}=this;if(n.isNone(o)||!(e>0)||!(r>0))return null;const[i,s,c,a]=o;if(!S(i))return null;const l=i.mapPoint.spatialReference,u=this._projectControlPoint(s,l),p=this._projectControlPoint(c,l),P=this._projectControlPoint(a,l);if(!u.valid||!p.valid||!P.valid)return null;if(!S(u.controlPoint))return null;n.isNone(t)&&(t=f.create());let h=null;return h=S(p.controlPoint)&&S(P.controlPoint)?I(t,i,u.controlPoint,p.controlPoint,P.controlPoint):S(p.controlPoint)?A(t,i,u.controlPoint,p.controlPoint):V(t,i,u.controlPoint),h.every((t=>0===t))?null:h},c._projectControlPoint=function(t,o){if(!S(t))return{valid:!0,controlPoint:t};const{sourcePoint:e,mapPoint:n}=t,{geometry:i,pending:s}=d.projectOrLoad(n,o);return s?{valid:!1,controlPoint:null}:s||i?{valid:!0,controlPoint:{sourcePoint:e,mapPoint:i}}:(r.getLogger(this.declaredClass).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:n.spatialReference,targetSpatialReference:o}),{valid:!1,controlPoint:null})},t._createClass(e,[{key:"coords",get:function(){if(n.isNone(this.controlPoints))return null;const t=this._updateTransform(_);if(n.isNone(t)||!S(this.controlPoints[0]))return null;const o=this.controlPoints[0].mapPoint.spatialReference;return H(t,this.width,this.height,o)}},{key:"inverseTransform",get:function(){return n.isNone(this.transform)?null:p.invert(f.create(),this.transform)}},{key:"transform",get:function(){return this._updateTransform()}}]),e}(v);function S(t){return n.isSome(t)&&n.isSome(t.sourcePoint)&&n.isSome(t.mapPoint)}o.__decorate([c.property({type:[j]})],N.prototype,"controlPoints",void 0),o.__decorate([c.property({readOnly:!0})],N.prototype,"coords",null),o.__decorate([c.property()],N.prototype,"height",void 0),o.__decorate([c.property({readOnly:!0})],N.prototype,"inverseTransform",null),o.__decorate([c.property({readOnly:!0})],N.prototype,"transform",null),o.__decorate([c.property()],N.prototype,"width",void 0),N=o.__decorate([u.subclass("esri.layers.support.ControlPointsGeoreference")],N);const k=h.create(),w=h.create(),R=h.create(),T=h.create(),C=h.create(),b=h.create(),L=h.create(),x=h.create(),O=Math.PI/2;function M(t,o,e){P.set(t,e.sourcePoint.x,e.sourcePoint.y),P.set(o,e.mapPoint.x,e.mapPoint.y)}function V(t,o,e){return M(k,C,o),M(w,b,e),P.rotate(R,w,k,O),P.rotate(T,k,w,O),P.rotate(L,b,C,-O),P.rotate(x,C,b,-O),z(t,k,w,R,T,C,b,L,x)}function A(t,o,e,r){return M(k,C,o),M(w,b,e),M(R,L,r),P.lerp(T,k,w,.5),P.rotate(T,R,T,Math.PI),P.lerp(x,C,b,.5),P.rotate(x,L,x,Math.PI),z(t,k,w,R,T,C,b,L,x)}function I(t,o,e,r,n){return M(k,C,o),M(w,b,e),M(R,L,r),M(T,x,n),z(t,k,w,R,T,C,b,L,x)}const U=new Array(8).fill(0),B=new Array(8).fill(0);function G(t,o,e,r,n){return t[0]=o[0],t[1]=o[1],t[2]=e[0],t[3]=e[1],t[4]=r[0],t[5]=r[1],t[6]=n[0],t[7]=n[1],t}function z(t,o,e,r,n,s,c,a,l){return i.getProjectiveTransform(t,G(U,o,e,r,n),G(B,s,c,a,l))}function H(t,o,e,r){const n=h.fromValues(0,e),s=h.fromValues(0,0),c=h.fromValues(o,0),a=h.fromValues(o,e);return i.transformProjective(n,n,t),i.transformProjective(s,s,t),i.transformProjective(c,c,t),i.transformProjective(a,a,t),new y({rings:[[n,s,c,a,n]],spatialReference:r})}return N}));
