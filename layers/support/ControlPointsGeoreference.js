/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/JSONSupport","../../core/Logger","../../core/maybe","../../core/perspectiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../chunks/mat3","../../chunks/mat3f64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Point","../../geometry/Polygon","../../geometry/projection","../../geometry/SpatialReference","./GeoreferenceBase"],(function(e,t,o,r,n,i,s,c,a,l,p,u,f,P,m,h,y,d,g,v,_,w,S,j){"use strict";const R=y.create(),N=g.create();let x=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).sourcePoint=null,e.mapPoint=null,e}return e._inheritsLoose(o,t),o}(o);t.__decorate([l.property()],x.prototype,"sourcePoint",void 0),t.__decorate([l.property({type:v})],x.prototype,"mapPoint",void 0),x=t.__decorate([P.subclass("esri.layers.support.ControlPoint")],x);let C=function(t){function o(e){var o;return(o=t.call(this,e)||this).controlPoints=null,o.height=0,o.type="control-points",o.width=0,o}e._inheritsLoose(o,t);var n=o.prototype;return n.readControlPoints=function(e,t){const o=S.fromJSON(t.spatialReference),r=y.fromValues(...t.coefficients,1);return e.map((e=>(d.set(N,e.x,e.y),c.transformProjective(N,N,r),{sourcePoint:e,mapPoint:new v({x:N[0],y:N[1],spatialReference:o})})))},n.writeControlPoints=function(e,t,o,n){if(s.isNone(this.transform)){const e=new r("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:n?.layer,georeference:this});n?.messages?n.messages.push(e):i.getLogger(this.declaredClass).error(e.name,e.message)}else s.isSome(e)&&k(e[0])&&(t.controlPoints=e.map((e=>{const t=s.unwrap(e.sourcePoint);return{x:t.x,y:t.y}})),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8))},n.toMap=function(e){if(s.isNone(e)||s.isNone(this.transform)||s.isNone(this.controlPoints)||!k(this.controlPoints[0]))return null;d.set(N,e.x,e.y);const t=this.controlPoints[0].mapPoint.spatialReference;return c.transformProjective(N,N,this.transform),new v({x:N[0],y:N[1],spatialReference:t})},n.toSource=function(e){if(s.isNone(e)||s.isNone(this.inverseTransform)||s.isNone(this.controlPoints)||!k(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),e=w.projectOrLoad(e,t).geometry,s.isNone(e)?null:(d.set(N,e.x,e.y),c.transformProjective(N,N,this.inverseTransform),a.createScreenPoint(N[0],N[1]))},n._updateTransform=function(e){const{controlPoints:t,width:o,height:r}=this;if(s.isNone(t)||!(o>0)||!(r>0))return null;const[n,i,c,a]=t;if(!k(n))return null;const l=n.mapPoint.spatialReference,p=this._projectControlPoint(i,l),u=this._projectControlPoint(c,l),f=this._projectControlPoint(a,l);if(!p.valid||!u.valid||!f.valid)return null;if(!k(p.controlPoint))return null;s.isNone(e)&&(e=y.create());let P=null;return P=k(u.controlPoint)&&k(f.controlPoint)?q(e,n,p.controlPoint,u.controlPoint,f.controlPoint):k(u.controlPoint)?G(e,n,p.controlPoint,u.controlPoint):B(e,n,p.controlPoint),P.every((e=>0===e))?null:P},n._projectControlPoint=function(e,t){if(!k(e))return{valid:!0,controlPoint:e};const{sourcePoint:o,mapPoint:r}=e,{geometry:n,pending:s}=w.projectOrLoad(r,t);return s?{valid:!1,controlPoint:null}:s||n?{valid:!0,controlPoint:{sourcePoint:o,mapPoint:n}}:(i.getLogger(this.declaredClass).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:e,sourceSpatialReference:r.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})},e._createClass(o,[{key:"coords",get:function(){if(s.isNone(this.controlPoints))return null;const e=this._updateTransform(R);if(s.isNone(e)||!k(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return D(e,this.width,this.height,t)},set:function(e){if(s.isNone(this.controlPoints)||!k(this.controlPoints[0]))return;const t=this.controlPoints[0].mapPoint.spatialReference;if(e=this.projectOrWarn(e,t),s.isNone(e))return;const{width:o,height:r}=this,{rings:[[n,i,l,p]]}=e,u={sourcePoint:a.createScreenPoint(0,r),mapPoint:new v({x:n[0],y:n[1],spatialReference:t})},f={sourcePoint:a.createScreenPoint(0,0),mapPoint:new v({x:i[0],y:i[1],spatialReference:t})},P={sourcePoint:a.createScreenPoint(o,0),mapPoint:new v({x:l[0],y:l[1],spatialReference:t})},m={sourcePoint:a.createScreenPoint(o,r),mapPoint:new v({x:p[0],y:p[1],spatialReference:t})};k(u)&&k(f)&&k(P)&&k(m)&&(q(R,u,f,P,m),this.controlPoints=s.unwrap(this.controlPoints).map((({sourcePoint:e})=>(d.set(N,e.x,e.y),c.transformProjective(N,N,R),{sourcePoint:e,mapPoint:new v({x:N[0],y:N[1],spatialReference:t})}))))}},{key:"inverseTransform",get:function(){return s.isNone(this.transform)?null:h.invert(y.create(),this.transform)}},{key:"transform",get:function(){return this._updateTransform()}}]),o}(n.JSONSupportMixin(j));function k(e){return s.isSome(e)&&s.isSome(e.sourcePoint)&&s.isSome(e.mapPoint)}t.__decorate([l.property({type:[x],json:{write:{allowNull:!1,isRequired:!0}}})],C.prototype,"controlPoints",void 0),t.__decorate([f.reader("controlPoints")],C.prototype,"readControlPoints",null),t.__decorate([m.writer("controlPoints")],C.prototype,"writeControlPoints",null),t.__decorate([l.property()],C.prototype,"coords",null),t.__decorate([l.property({json:{write:!0}})],C.prototype,"height",void 0),t.__decorate([l.property({readOnly:!0})],C.prototype,"inverseTransform",null),t.__decorate([l.property({readOnly:!0})],C.prototype,"transform",null),t.__decorate([l.property({json:{write:!0}})],C.prototype,"width",void 0),C=t.__decorate([P.subclass("esri.layers.support.ControlPointsGeoreference")],C);const O=g.create(),T=g.create(),b=g.create(),L=g.create(),M=g.create(),V=g.create(),I=g.create(),J=g.create(),A=Math.PI/2;function U(e,t,o){d.set(e,o.sourcePoint.x,o.sourcePoint.y),d.set(t,o.mapPoint.x,o.mapPoint.y)}function B(e,t,o){return U(O,M,t),U(T,V,o),d.rotate(b,T,O,A),d.rotate(L,O,T,A),d.rotate(I,V,M,-A),d.rotate(J,M,V,-A),W(e,O,T,b,L,M,V,I,J)}function G(e,t,o,r){return U(O,M,t),U(T,V,o),U(b,I,r),d.lerp(L,O,T,.5),d.rotate(L,b,L,Math.PI),d.lerp(J,M,V,.5),d.rotate(J,I,J,Math.PI),W(e,O,T,b,L,M,V,I,J)}function q(e,t,o,r,n){return U(O,M,t),U(T,V,o),U(b,I,r),U(L,J,n),W(e,O,T,b,L,M,V,I,J)}const z=new Array(8).fill(0),E=new Array(8).fill(0);function H(e,t,o,r,n){return e[0]=t[0],e[1]=t[1],e[2]=o[0],e[3]=o[1],e[4]=r[0],e[5]=r[1],e[6]=n[0],e[7]=n[1],e}function W(e,t,o,r,n,i,s,a,l){return c.getProjectiveTransform(e,H(z,t,o,r,n),H(E,i,s,a,l))}function D(e,t,o,r){const n=g.fromValues(0,o),i=g.fromValues(0,0),s=g.fromValues(t,0),a=g.fromValues(t,o);return c.transformProjective(n,n,e),c.transformProjective(i,i,e),c.transformProjective(s,s,e),c.transformProjective(a,a,e),new _({rings:[[n,i,s,a,n]],spatialReference:r})}return C}));
