/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","../../core/urlUtils","./arcgisLayerUrl","./fetchService","./lazyLayerLoader"],(function(e,r,t,a,n,l,s,o,u){"use strict";const i=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function c(e){return y.apply(this,arguments)}function y(){return(y=t._asyncToGenerator((function*(r){const t=r.properties?.customParameters,a=yield f(r.url,t),n={...r.properties,url:r.url};if(!a.sublayerIds)return null!=a.layerOrTableId&&(n.layerId=a.layerOrTableId,n.sourceJSON=a.sourceJSON),new a.Constructor(n);const l=new(0,(yield new Promise(((r,t)=>e(["../GroupLayer"],(e=>r(i(e))),t)))).default)({title:a.parsedUrl.title});return d(l,a,n),l}))).apply(this,arguments)}function p(e,r){return e?e.find((e=>e.id===r)):null}function d(e,r,t){function a(e,a){const l={...t,layerId:e,sublayerTitleMode:"service-name"};return n.isSome(a)&&(l.sourceJSON=a),new r.Constructor(l)}r.sublayerIds.forEach((t=>{const n=a(t,p(r.sublayerInfos,t));e.add(n)})),r.tableIds.forEach((t=>{const n=a(t,p(r.tableInfos,t));e.tables.add(n)}))}function f(e,r){return S.apply(this,arguments)}function S(){return(S=t._asyncToGenerator((function*(e,r){let t=s.parse(e);if(n.isNone(t)&&(t=yield h(e,r)),n.isNone(t))throw new a("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:l,sublayer:u}=t;let i;const c={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(l){case"MapServer":i=null!=u?"FeatureLayer":O(e,r).then((e=>e?"TileLayer":"MapImageLayer"));break;case"ImageServer":i=o.fetchService(e,{customParameters:r}).then((e=>{const r=e.tileInfo&&e.tileInfo.format;return e.tileInfo?"LERC"!==r?.toUpperCase()||e.cacheType&&"elevation"!==e.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"}));break;case"SceneServer":i=o.fetchService(t.url.path,{customParameters:r}).then((e=>{if(e){if("Voxel"===e?.layerType)return"VoxelLayer";if(e?.layers&&Array.isArray(e.layers)&&e.layers.length>0){const r={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"},t=e.layers[0]?.layerType;if(null!=r[t])return r[t]}}return"SceneLayer"}));break;default:i=c[l]}const y={FeatureLayer:!0,SceneLayer:!0},p="FeatureServer"===l,d={parsedUrl:t,Constructor:null,layerOrTableId:p?u:null,sublayerIds:null,tableIds:null},f=yield i;if(y[f]&&null==u){const t=yield I(e,l,r);p&&(d.sublayerInfos=t.layerInfos,d.tableInfos=t.tableInfos);1!==t.layerIds.length+t.tableIds.length?(d.sublayerIds=t.layerIds,d.tableIds=t.tableIds):p&&(d.layerOrTableId=t.layerIds[0]??t.tableIds[0],d.sourceJSON=t.layerInfos[0]??t.tableInfos[0])}return d.Constructor=yield T(f),d}))).apply(this,arguments)}function h(e,r){return m.apply(this,arguments)}function m(){return(m=t._asyncToGenerator((function*(e,r){const t=yield o.fetchService(e,{customParameters:r});let a=null,u=null;const i=t.type;if("Feature Layer"===i||"Table"===i?(a="FeatureServer",u=t.id):"indexedVector"===i?a="VectorTileServer":t.hasOwnProperty("mapName")?a="MapServer":t.hasOwnProperty("bandCount")&&t.hasOwnProperty("pixelSizeX")?a="ImageServer":t.hasOwnProperty("maxRecordCount")&&t.hasOwnProperty("allowGeometryUpdates")?a="FeatureServer":t.hasOwnProperty("streamUrls")?a="StreamServer":b(t)?(a="SceneServer",u=t.id):t.hasOwnProperty("layers")&&b(t.layers?.[0])&&(a="SceneServer"),!a)return null;const c=null!=u?s.parseNonStandardSublayerUrl(e):null;return{title:n.isSome(c)&&t.name||l.getFilename(e),serverType:a,sublayer:u,url:{path:n.isSome(c)?c.serviceUrl:l.urlToObject(e).path}}}))).apply(this,arguments)}function b(e){return e?.hasOwnProperty("store")&&e.hasOwnProperty("id")&&"number"==typeof e.id}function I(e,r,t){return v.apply(this,arguments)}function v(){return(v=t._asyncToGenerator((function*(e,r,t){let a,n=!1;if("FeatureServer"===r){const r=yield o.fetchFeatureService(e,{customParameters:t});n=!!r.layersJSON,a=r.layersJSON||r.serviceJSON}else a=yield o.fetchService(e,{customParameters:t});const l=a?.layers,s=a?.tables;return{layerIds:l?.map((e=>e.id)).reverse()||[],tableIds:s?.map((e=>e.id)).reverse()||[],layerInfos:n?l:[],tableInfos:n?s:[]}}))).apply(this,arguments)}function T(e){return L.apply(this,arguments)}function L(){return(L=t._asyncToGenerator((function*(e){return(0,u.layerLookupMap[e])()}))).apply(this,arguments)}function O(e,r){return P.apply(this,arguments)}function P(){return(P=t._asyncToGenerator((function*(e,r){return(yield o.fetchService(e,{customParameters:r})).tileInfo}))).apply(this,arguments)}r.fromUrl=c,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
