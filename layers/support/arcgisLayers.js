/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../core/maybe","../../core/Error","../../core/urlUtils","../../request","./arcgisLayerUrl","./lazyLayerLoader"],(function(e,r,a,t,n,l,s,o){"use strict";function u(e){return Object.freeze({__proto__:null,default:e})}async function i(r){var a;const t=null==(a=r.properties)?void 0:a.customParameters,n=await d(r.url,t),l={...r.properties,url:r.url};if(!n.sublayerIds)return null!=n.layerOrTableId&&(l.layerId=n.layerOrTableId,l.sourceJSON=n.sourceJSON),new n.Constructor(l);const s=new(0,(await new Promise((function(r,a){e(["../GroupLayer"],(function(e){r(u(e))}),a)}))).default)({title:n.parsedUrl.title});return c(s,n,l),s}function y(e,r){return e?e.find((e=>e.id===r)):null}function c(e,r,t){function n(e,n){const l={...t,layerId:e,sublayerTitleMode:"service-name"};return a.isSome(n)&&(l.sourceJSON=n),new r.Constructor(l)}r.sublayerIds.forEach((a=>{const t=n(a,y(r.sublayerInfos,a));e.add(t)})),r.tableIds.forEach((a=>{const t=n(a,y(r.tableInfos,a));e.tables.add(t)}))}async function d(e,r){let n=s.parse(e);if(a.isNone(n)&&(n=await f(e,r)),a.isNone(n))throw new t("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:l,sublayer:o}=n;let u;const i={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(l){case"MapServer":u=null!=o?"FeatureLayer":S(e,r).then((e=>e?"TileLayer":"MapImageLayer"));break;case"ImageServer":u=m(e,r).then((e=>{const r=e.tileInfo&&e.tileInfo.format;return e.tileInfo?!r||"LERC"!==r.toUpperCase()||e.cacheType&&"elevation"!==e.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"}));break;case"SceneServer":u=m(n.url.path,r).then((e=>{const r={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};if(e&&Array.isArray(e.layers)&&e.layers.length>0){const a=e.layers[0].layerType;if(null!=r[a])return r[a]}return"SceneLayer"}));break;default:u=i[l]}const y={FeatureLayer:!0,SceneLayer:!0},c="FeatureServer"===l,d={parsedUrl:n,Constructor:null,layerOrTableId:c?o:null,sublayerIds:null,tableIds:null},I=await u;if(y[I]&&null==o){const a=await p(e,l,r);c&&(d.sublayerInfos=a.layerInfos,d.tableInfos=a.tableInfos);if(1!==a.layerIds.length+a.tableIds.length)d.sublayerIds=a.layerIds,d.tableIds=a.tableIds;else if(c){var b,w;d.layerOrTableId=null!=(b=a.layerIds[0])?b:a.tableIds[0],d.sourceJSON=null!=(w=a.layerInfos[0])?w:a.tableInfos[0]}}return d.Constructor=await v(I),d}async function f(e,r){const t=await m(e,r);let l=null,o=null;const u=t.type;if("Feature Layer"===u||"Table"===u?(l="FeatureServer",o=t.id):"indexedVector"===u?l="VectorTileServer":t.hasOwnProperty("mapName")?l="MapServer":t.hasOwnProperty("bandCount")&&t.hasOwnProperty("pixelSizeX")?l="ImageServer":t.hasOwnProperty("maxRecordCount")&&t.hasOwnProperty("allowGeometryUpdates")?l="FeatureServer":t.hasOwnProperty("streamUrls")&&(l="StreamServer"),!l)return null;const i=null!=o?s.parseNonStandardSublayerUrl(e):null;return{title:a.isSome(i)&&t.name||n.getFilename(e),serverType:l,sublayer:o,url:{path:a.isSome(i)?i.serviceUrl:n.urlToObject(e).path}}}async function p(e,r,a){var t,n;let l,s=!1;if("FeatureServer"===r){const r=await b(e,a);s=!!r.layersJSON,l=r.layersJSON||r.serviceJSON}else l=await m(e,a);const o=null==(t=l)?void 0:t.layers,u=null==(n=l)?void 0:n.tables;return{layerIds:(null==o?void 0:o.map((e=>e.id)).reverse())||[],tableIds:(null==u?void 0:u.map((e=>e.id)).reverse())||[],layerInfos:s?o:[],tableInfos:s?u:[]}}function I(e){return!e.type||"Feature Layer"===e.type}async function b(e,r){var a,t;let n=await m(e,r);n=n||{},n.layers=(null==(a=n.layers)?void 0:a.filter(I))||[];const l={serviceJSON:n};if(n.currentVersion<10.5)return l;const s=await m(e+"/layers",r);return l.layersJSON={layers:(null==s||null==(t=s.layers)?void 0:t.filter(I))||[],tables:(null==s?void 0:s.tables)||[]},l}async function v(e){return(0,o.layerLookupMap[e])()}async function S(e,r){return(await m(e,r)).tileInfo}async function m(e,r){return(await l(e,{responseType:"json",query:{f:"json",...r}})).data}r.fromUrl=i,Object.defineProperty(r,"__esModule",{value:!0})}));
