/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/maybe","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/promiseUtils","../../core/JSONSupport","../../geometry/Extent","../../geometry","../../core/Evented","../../core/Collection","../../core/Loadable","../../core/watchUtils","./kmlUtils"],(function(e,r,t,s,o,l,i,a,n,u,c,p,y,h,d,_,b,v,f,S,k,m){"use strict";var g;let w=g=function(r){function t(){var e;return(e=r.apply(this,arguments)||this)._sublayersHandles=null,e.description=null,e.id=null,e.networkLink=null,e.title=null,e.sourceJSON=null,e.fullExtent=null,e}e._inheritsLoose(t,r);var o=t.prototype;return o.initialize=function(){k.whenOnce(this,"networkLink").then((()=>k.whenTrueOnce(this,"visible"))).then((()=>this.load()))},o.load=function(e){if(!this.networkLink)return;const r=s.isSome(e)?e.signal:null,t=this._fetchService(this._get("networkLink").href,r).then((e=>{const r=m.computeExtent(e.sublayers);this.fullExtent=_.fromJSON(r),this.sourceJSON=e;const t=l.ensureType(f.ofType(g),m.sublayersFromJSON(g,e));this.sublayers?this.sublayers.addMany(t):this.sublayers=t,this.layer.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")}));return this.addResolvingPromise(t),h.resolve(this)},o.castSublayers=function(e){return l.ensureType(f.ofType(g),e)},o.readVisible=function(e,r){return!!r.visibility},o._fetchService=function(e,r){return m.fetchService(e,this.layer.outSpatialReference,this.layer.refreshInterval,r).then((e=>m.parseKML(e.data)))},e._createClass(t,[{key:"sublayers",set:function(e){const r=this._get("sublayers");r&&(r.forEach((e=>{e.parent=null,e.layer=null})),this._sublayersHandles.forEach((e=>e.remove())),this._sublayersHandles=null),e&&(e.forEach((e=>{e.parent=this,e.layer=this.layer})),this._sublayersHandles=[e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this.layer})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))]),this._set("sublayers",e)}},{key:"visible",get:function(){return this._get("visible")},set:function(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}},{key:"layer",set:function(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach((r=>r.layer=e))}}]),t}(v.EventedMixin(d.JSONSupportMixin(S)));return r.__decorate([i.property()],w.prototype,"description",void 0),r.__decorate([i.property()],w.prototype,"id",void 0),r.__decorate([i.property({readOnly:!0,value:null})],w.prototype,"networkLink",void 0),r.__decorate([i.property({json:{write:{allowNull:!0}}})],w.prototype,"parent",void 0),r.__decorate([i.property({value:null,json:{write:{allowNull:!0}}})],w.prototype,"sublayers",null),r.__decorate([a.cast("sublayers")],w.prototype,"castSublayers",null),r.__decorate([i.property({value:null,json:{read:{source:"name"}}})],w.prototype,"title",void 0),r.__decorate([i.property({value:!0})],w.prototype,"visible",null),r.__decorate([n.reader("visible",["visibility"])],w.prototype,"readVisible",null),r.__decorate([i.property()],w.prototype,"sourceJSON",void 0),r.__decorate([i.property({value:null})],w.prototype,"layer",null),r.__decorate([i.property({type:_})],w.prototype,"fullExtent",void 0),w=g=r.__decorate([u.subclass("esri.layers.support.KMLSublayer")],w),w}));
