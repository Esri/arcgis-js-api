// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../core/arrayUtils","../../core/lang","../../core/SetUtils","./RasterFunction","../../renderers/support/colorRampUtils","../../renderers/support/stretchRendererUtils","../../renderers/visualVariables/SizeVariable"],(function(e,r,n,a,t,o,i,u,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.convertRendererToRenderingRule=r.combineRenderingRules=r.isSupportedRendererType=r.pixelTypeRanges=void 0,r.pixelTypeRanges={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]};var l={simple_scalar:"Simple Scalar",wind_speed:"Wind Barb",single_arrow:"Single Arrow",beaufort_kn:"Beaufort Wind (Knots)",beaufort_m:"Beaufort Wind (MetersPerSecond)",ocean_current_m:"Ocean Current (MetersPerSecond)",ocean_current_kn:"Ocean Current (Knots)"},m=t.SetFromValues(["raster-stretch","unique-value","class-breaks","raster-shaded-relief","vector-field"]);r.isSupportedRendererType=function(e){return m.has(e.type)},r.combineRenderingRules=function(e,r){if(!e||!r)return a.clone(e||r);var n=a.clone(e);return"none"!==r.functionName.toLowerCase()&&((function e(r){var n=r.Raster;if(n&&"esri.layers.support.RasterFunction"===n.declaredClass)return e(n.functionArguments);return r}(n.functionArguments)).Raster=r),n},r.convertRendererToRenderingRule=function(e,r){switch(r=r||{},e.type){case"raster-stretch":return function(e,r){var n=new o;n.functionName="Stretch";var a=c[u.stretchTypeJSONDict.toJSON(e.stretchType)],t=function(e){var r=[];return e.forEach((function(e){var n=e;if(Array.isArray(n))r.push(n);else{if(null==n.min||null==n.max)return;var a=[n.min,n.max,n.avg||0,n.stddev||0];r.push(a)}})),r}(e.statistics),s={StretchType:a,Statistics:t,DRA:e.dynamicRangeAdjustment,UseGamma:e.useGamma,Gamma:e.gamma,ComputeGamma:e.computeGamma};null!=e.outputMin&&(s.Min=e.outputMin);null!=e.outputMax&&(s.Max=e.outputMax);a===c.standardDeviation?(s.NumberOfStandardDeviations=e.numberOfStandardDeviations,n.outputPixelType="u8"):a===c.percentClip?(s.MinPercent=e.minPercent,s.MaxPercent=e.maxPercent,n.outputPixelType="u8"):a===c.minMax?n.outputPixelType="u8":a===c.sigmoid&&(s.SigmoidStrengthLevel=e.sigmoidStrengthLevel);if(n.functionArguments=s,n.variableName="Raster",e.colorRamp){var l=e.colorRamp,m=new o,p=i.getColorRampName(l);return p?m.functionArguments={colorRamp:p}:!r.convertColorRampToColormap||"algorithmic"!==l.type&&"multipart"!==l.type?m.functionArguments={colorRamp:e.colorRamp.toJSON()}:m.functionArguments={Colormap:i.convertColorRampToColormap(l,256)},m.variableName="Raster",m.functionName="Colormap",m.functionArguments.Raster=n,m}return n}(e,r);case"class-breaks":return function(e,r){var n=[],a=[],t=[],i=[],u=r.pixelType,s=r.rasterAttributeTable,l=s&&s.features,m=f(s);if(l&&Array.isArray(l)&&e.classBreakInfos){e.classBreakInfos.forEach((function(r,n){var a,t=r.symbol.color;t.a&&l.forEach((function(o){((a=o.attributes[e.field])>=r.minValue&&a<r.maxValue||n===e.classBreakInfos.length-1&&a>=r.minValue)&&i.push([o.attributes[m],t.r,t.g,t.b])}))}));var c=u?p(i,u):i,d=new o;return d.functionName="Colormap",d.functionArguments={},d.functionArguments.Colormap=c,d.variableName="Raster",d}e.classBreakInfos.forEach((function(e,r){var o=e.symbol&&e.symbol.color;o.a?(0===r?n.push(e.minValue,e.maxValue+1e-6):n.push(e.minValue+1e-6,e.maxValue+1e-6),a.push(r),i.push([r,o.r,o.g,o.b])):t.push(e.minValue,e.maxValue)}));var v=u?p(i,u):i,g=new o;g.functionName="Remap",g.functionArguments={InputRanges:n,OutputValues:a,NoDataRanges:t},g.variableName="Raster";var R=new o;return R.functionName="Colormap",R.functionArguments={Colormap:v,Raster:g},R}(e,r);case"unique-value":return function(e,r){var n=[],a=r.pixelType,t=r.rasterAttributeTable,i=t&&t.features,u=f(t),s=!1;e.uniqueValueInfos&&e.uniqueValueInfos.forEach((function(r){var a=r.symbol.color;a.a&&(e.field!==u&&i?i&&i.forEach((function(t){String(t.attributes[e.field])===String(r.value)&&n.push([t.attributes[u],a.r,a.g,a.b])})):isNaN(+r.value)?s=!0:n.push([+r.value,a.r,a.g,a.b]))}));if(s)return null;var l=a&&n.length>0?p(n,a):n,m=new o;return m.functionName="Colormap",m.functionArguments={},m.functionArguments.Colormap=l,m.variableName="Raster",m}(e,r);case"raster-colormap":return function(e,r){var n=e.extractColormap();if(!n||0===n.length)return;var a=r.pixelType,t=a?p(n,a):n,i=new o;return i.functionName="Colormap",i.functionArguments={},i.functionArguments.Colormap=t,i}(e,r);case"vector-field":return function(e,r){var n=new o;n.functionName="VectorFieldRenderer";var a,t,i=r.dataType,u=r.bandProperties,m="vector-uv"===i;u&&2===u.length&&(a=u.map((function(e){return e.BandName.toLowerCase()})).indexOf("magnitude"),t=u.map((function(e){return e.BandName.toLowerCase()})).indexOf("direction"));-1!==a&&null!==a||(a=0,t=1);var c="arithmetic"===e.rotationType?1:2,p="flow-from"===e.flowRepresentation?0:1,f=e.visualVariables?e.visualVariables.filter((function(e){return"Magnitude"===e.field}))[0]:new s,d={magnitudeBandID:a,directionBandID:t,isUVComponents:m,referenceSystem:c,massFlowAngleRepresentation:p,symbolTileSize:50,symbolTileSizeUnits:100,calculationMethod:"Vector Average",symbologyName:l[e.style.toLowerCase()],minimumMagnitude:f.minDataValue,maximumMagnitude:f.maxDataValue,minimumSymbolSize:f.minSize,maximumSymbolSize:f.maxSize};return n.functionArguments=d,n}(e,r);case"raster-shaded-relief":return function(e,r){if("elevation"!==r.dataType)return new o;var n=new o;n.functionName="Hillshade";var a="traditional"===e.hillshadeType?0:1,t="none"===e.scalingType?1:3,u={HillshadeType:a,SlopeType:t,ZFactor:e.zFactor};0===a&&(u.Azimuth=e.azimuth,u.Altitude=e.altitude);3===t&&(u.PSPower=e.pixelSizePower,u.PSZFactor=e.pixelSizeFactor);n.functionArguments=u,n.variableName="Raster",e.colorRamp&&(n.functionName="ShadedRelief",u.Colormap=i.convertColorRampToColormap(e.colorRamp,256));return n}(e,r)}};var c={none:0,standardDeviation:3,histogramEqualization:4,minMax:5,percentClip:6,sigmoid:9};function p(e,n){var a=r.pixelTypeRanges[String(n).toLowerCase()];return a&&e.push([Math.floor(a[0]-1),0,0,0],[Math.ceil(a[1]+1),0,0,0]),e}function f(e){if(e){var r=e.fields,a=r&&n.find(r,(function(e){return e&&e.name&&"value"===e.name.toLowerCase()}));return a&&a.name}}}));