/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../core/lang","../../core/maybe","./RasterFunction","./rasterFunctionUtils","../../renderers/support/colorRampUtils","../../renderers/support/stretchRendererUtils","../../renderers/visualVariables/SizeVariable"],(function(e,n,t,r,o,a,i,s){"use strict";const u={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767]},l={simple_scalar:"Simple Scalar",wind_barb:"Wind Barb",single_arrow:"Single Arrow",beaufort_kn:"Beaufort Wind (Knots)",beaufort_m:"Beaufort Wind (MetersPerSecond)",ocean_current_m:"Ocean Current (MetersPerSecond)",ocean_current_kn:"Ocean Current (Knots)"},c=new Set(["raster-stretch","unique-value","class-breaks","raster-shaded-relief","vector-field","raster-colormap"]);function m(e){return c.has(e.type)}function p(e,t){if(!e||!t)return n.clone(e||t);const r=n.clone(e);if(t.rasterFunctionDefinition){const e=t.rasterFunctionDefinition;(e.thumbnail||e.thumbnailEx)&&(e.thumbnail=e.thumbnailEx=null),f(r.rasterFunctionDefinition.arguments,t)}else if("none"!==t.functionName.toLowerCase()){h(r.functionArguments).Raster=t}return r}function f(e,n){for(const t in e)"raster"===t.toLowerCase()&&("RasterFunctionVariable"===e[t].type?(e[t]=n.rasterFunctionDefinition,e[t].type="RasterFunctionTemplate"):"RasterFunctionTemplate"===e[t].type&&f(e[t].arguments,n))}function g(e){const t=n.clone(o.schema[e.functionName+"Function"]),r=e.functionArguments;for(const n in r)"raster"===n.toLowerCase()?(t.arguments[n]=g(r[n]),t.arguments[n].type="RasterFunctionTemplate"):"colormap"===n.toLowerCase()?(t.arguments[n].value=F(r[n]),t.arguments.ColorSchemeType.value=0):t.arguments[n].value=r[n];return t}function d(e,n){switch(n=n||{},e.type){case"raster-stretch":return T(e,n);case"class-breaks":return v(e,n);case"unique-value":return S(e,n);case"raster-colormap":return x(e,n);case"vector-field":return y(e,n);case"raster-shaded-relief":return b(e,n);case"flow":throw new Error("Unsupported rendering rule.")}}function h(e){const n=e?.Raster;return n&&"esri.layers.support.RasterFunction"===n.declaredClass?h(n.functionArguments):e}const R={none:0,standardDeviation:3,histogramEqualization:4,minMax:5,percentClip:6,sigmoid:9};function y(e,n){const t=new r;t.functionName="VectorFieldRenderer";const{dataType:o,bandProperties:a}=n,i="vector-uv"===o;let u,c;a&&2===a.length&&(u=a.map((e=>e.BandName.toLowerCase())).indexOf("magnitude"),c=a.map((e=>e.BandName.toLowerCase())).indexOf("direction")),-1!==u&&null!==u||(u=0,c=1);const m="arithmetic"===e.rotationType?1:2,p="flow-from"===e.flowRepresentation?0:1,f=e.visualVariables?e.visualVariables.find((e=>"Magnitude"===e.field)):new s,d={magnitudeBandID:u,directionBandID:c,isUVComponents:i,referenceSystem:m,massFlowAngleRepresentation:p,symbolTileSize:50,symbolTileSizeUnits:100,calculationMethod:"Vector Average",symbologyName:l[e.style.toLowerCase().replace("-","_")],minimumMagnitude:f.minDataValue,maximumMagnitude:f.maxDataValue,minimumSymbolSize:f.minSize,maximumSymbolSize:f.maxSize};return t.functionArguments=d,n.convertToRFT?new r({rasterFunctionDefinition:g(t)}):t}function b(e,n){const t=n.convertToRFT;if("elevation"!==n.dataType&&("generic"!==n.dataType||1!==n.bandCount||"s16"!==n.pixelType&&"s32"!==n.pixelType&&"f32"!==n.pixelType&&"f64"!==n.pixelType))return new r;const o=new r;o.functionName="Hillshade";const i="traditional"===e.hillshadeType?0:1,s="none"===e.scalingType?1:3,u={HillshadeType:i,SlopeType:s,ZFactor:e.zFactor};return 0===i&&(u.Azimuth=e.azimuth,u.Altitude=e.altitude),3===s&&(u.PSPower=e.pixelSizePower,u.PSZFactor=e.pixelSizeFactor),o.functionArguments=u,o.variableName="Raster",e.colorRamp&&(o.functionName="ShadedRelief",t?u.ColorRamp=a.getRFxArgColorRampValue(e.colorRamp):u.Colormap=a.convertColorRampToColormap(e.colorRamp,256)),t?new r({rasterFunctionDefinition:g(o)}):o}function T(e,n){const t=n.convertToRFT,o=new r;o.functionName="Stretch";const s=R[i.stretchTypeJSONDict.toJSON(e.stretchType)],u="u8",l={StretchType:s,Statistics:A(e.statistics),DRA:e.dynamicRangeAdjustment,UseGamma:e.useGamma,Gamma:e.gamma,ComputeGamma:e.computeGamma};if(null!=e.outputMin&&(l.Min=e.outputMin),null!=e.outputMax&&(l.Max=e.outputMax),s===R.standardDeviation?(l.NumberOfStandardDeviations=e.numberOfStandardDeviations,o.outputPixelType=u):s===R.percentClip?(l.MinPercent=e.minPercent,l.MaxPercent=e.maxPercent,o.outputPixelType=u):s===R.minMax?o.outputPixelType=u:s===R.sigmoid&&(l.SigmoidStrengthLevel=e.sigmoidStrengthLevel),o.functionArguments=l,o.variableName="Raster",e.colorRamp){const i=e.colorRamp,s=new r;if(t)s.functionArguments={ColorRamp:a.getRFxArgColorRampValue(i)};else{const t=a.getColorRampName(i);if(t)s.functionArguments={colorRamp:t};else if(!n.convertColorRampToColormap||"algorithmic"!==i.type&&"multipart"!==i.type){const n=e.colorRamp.toJSON();"algorithmic"===n.type?n.algorithm=n.algorithm||"esriCIELabAlgorithm":"multipart"===n.type&&n.colorRamps?.length&&n.colorRamps.forEach((e=>e.algorithm=e.algorithm||"esriCIELabAlgorithm")),s.functionArguments={colorRamp:n}}else s.functionArguments={Colormap:a.convertColorRampToColormap(i,256)}}return s.variableName="Raster",s.functionName="Colormap",s.functionArguments.Raster=o,t?new r({rasterFunctionDefinition:g(s)}):s}return t?new r({rasterFunctionDefinition:g(o)}):o}function v(e,n){const o=[],a=[],i=[],s=[],u=1e-6,{pixelType:l,rasterAttributeTable:c}=n,m=t.isNone(c)?null:c.features,p=w(c);if(m&&Array.isArray(m)&&e.classBreakInfos){e.classBreakInfos.forEach(((n,t)=>{const r=n.symbol.color;let o;r.a&&m.forEach((a=>{o=a.attributes[e.field],(o>=n.minValue&&o<n.maxValue||t===e.classBreakInfos.length-1&&o>=n.minValue)&&s.push([a.attributes[p],r.r,r.g,r.b])}))}));const t=l?C(s,l):s,o=new r;return o.functionName="Colormap",o.functionArguments={},o.functionArguments.Colormap=t,o.variableName="Raster",n.convertToRFT?new r({rasterFunctionDefinition:g(o)}):o}e.classBreakInfos.forEach(((e,n)=>{const t=e.symbol&&e.symbol.color;t.a?(0===n?o.push(e.minValue,e.maxValue+u):o.push(e.minValue+u,e.maxValue+u),a.push(n),s.push([n,t.r,t.g,t.b])):i.push(e.minValue,e.maxValue)}));const f=l?C(s,l):s,d=new r;d.functionName="Remap",d.functionArguments={InputRanges:o,OutputValues:a,NoDataRanges:i},d.variableName="Raster";const h=new r;return h.functionName="Colormap",h.functionArguments={Colormap:f,Raster:d},n.convertToRFT?new r({rasterFunctionDefinition:g(h)}):h}function C(e,n){const t=u[String(n).toLowerCase()];return t&&e.push([Math.floor(t[0]-1),0,0,0],[Math.ceil(t[1]+1),0,0,0]),e}function w(e){if(t.isNone(e))return;const{fields:n}=e,r=n&&n.find((e=>e&&e.name&&"value"===e.name.toLowerCase()));return r&&r.name}function S(e,n){const o=[],{pixelType:a,rasterAttributeTable:i}=n,s=t.isNone(i)?null:i.features,u=w(i),l=e.defaultSymbol?.color?.toRgb(),c=e.uniqueValueInfos;if(c)if(s){const n=new Map;c.forEach((e=>{const t=e.value,r=e.symbol.color;null!=t&&r&&r.a&&n.set(String(t),r.toRgb())}));const t=e.field;s.forEach((({attributes:e})=>{const r=String(e[t]),a=e[u];if(n.has(r)){const e=n.get(r);o.push([a,...e])}else l&&o.push([a,...l])}))}else for(let t=0;t<c.length;t++){const e=c[t],n=e.symbol.color,r=+e.value;if(n?.a){if(isNaN(r))return null;o.push([r,n.r,n.g,n.b])}}const m=a&&o.length>0?C(o,a):o,p=new r;return p.functionName="Colormap",p.functionArguments={},p.functionArguments.Colormap=m,p.variableName="Raster",n.convertToRFT?new r({rasterFunctionDefinition:g(p)}):p}function x(e,n){const t=e.extractColormap();if(!t||0===t.length)return;const{pixelType:o}=n,a=o?C(t,o):t,i=new r;return i.functionName="Colormap",i.functionArguments={},i.functionArguments.Colormap=a,n.convertToRFT?new r({rasterFunctionDefinition:g(i)}):i}function A(e){const n=[];return e.forEach((e=>{const t=e;if(Array.isArray(t))n.push(t);else{if(null==t.min||null==t.max)return;const e=[t.min,t.max,t.avg||0,t.stddev||0];n.push(e)}})),n}function F(e){const n=[],t=[];return e.forEach((e=>{n.push(e[0]),t.push(a.rgbaConvertTo32Bit([...e.slice(1),255]))})),{type:"RasterColormap",values:n,colors:t}}e.combineRenderingRules=p,e.convertRendererToRenderingRule=d,e.convertRenderingRuleToRFT=g,e.isSupportedRendererType=m,e.pixelTypeRanges=u,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
