/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../core/Logger","../../core/Error","../../core/urlUtils","../../request"],(function(t,e,i,s,a){"use strict";const r=e.getLogger("esri.layers.support.SpriteSource"),h=1.15;return function(){function e(t,e,i,s){this.baseURL=t,this.devicePixelRatio=e,this.maxTextureSize=i,this._spriteImageFormat=s,this._isRetina=!1,this._spritesData={},this.image=null,this.width=null,this.height=null,this.loadStatus="not-loaded"}var o=e.prototype;return o.getSpriteInfo=function(t){return this._spritesData[t]},o.load=async function(t){if(this.baseURL){this.loadStatus="loading";try{await this._loadSprites(t),this.loadStatus="loaded"}catch{this.loadStatus="failed"}}else this.loadStatus="failed"},o._loadSprites=function(t){this._isRetina=this.devicePixelRatio>h;const e=s.urlToObject(this.baseURL),o=e.query?"?"+s.objectToQuery(e.query):"",n=this._isRetina?"@2x":"",l=`${e.path}${n}.${this._spriteImageFormat}${o}`,u=`${e.path}${n}.json${o}`;return Promise.all([a(u,t),a(l,{responseType:"image",...t})]).then((([t,s])=>{const a=Object.keys(t.data);if(!a||0===a.length||1===a.length&&"_ssl"===a[0]||!s||!s.data)return this._spritesData=this.image=null,this.width=this.height=0,Promise.resolve(null);this._spritesData=t.data;const h=s.data,o=Math.max(this.maxTextureSize,4096);if(h.width>o||h.height>o){const t=`Sprite resource for style ${e.path} is bigger than the maximum allowed of ${o} pixels}`;throw r.error(t),new i("SpriteSource",t)}this.width=h.width,this.height=h.height;const n=document.createElement("canvas"),l=n.getContext("2d");n.width=h.width,n.height=h.height,l.drawImage(h,0,0,h.width,h.height);const u=l.getImageData(0,0,h.width,h.height),c=new Uint8Array(u.data);let d;for(let e=0;e<c.length;e+=4)d=c[e+3]/255,c[e]=c[e]*d,c[e+1]=c[e+1]*d,c[e+2]=c[e+2]*d;this.image=c}))},t._createClass(e,[{key:"spriteNames",get:function(){const t=[];for(const e in this._spritesData)t.push(e);return t.sort(),t}}]),e}()}));
