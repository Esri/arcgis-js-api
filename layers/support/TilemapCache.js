// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../request","../../core/Accessor","../../core/Error","../../core/Handles","../../core/Logger","../../core/LRUCache","../../core/PooledArray","../../core/promiseUtils","../../core/scheduling","../../core/urlUtils","../../core/watchUtils","../../core/accessorSupport/decorators","./Tilemap"],(function(e,t,i,r,l,a,n,o,s,p,c,u,h,f,v,y,m,d,b,_){Object.defineProperty(t,"__esModule",{value:!0}),t.TILEMAP_SIZE_EXP=5;var g=u.getLogger("esri.layers.support.TilemapCache"),T=function(e){function s(t){var i=e.call(this,t)||this;return i._handles=new c,i._pendingTilemapRequests={},i._availableLevels={},i.levels=5,i.cacheByteSize=2097152,i.request=o,i._prefetchingEnabled=!0,i}var u;return r(s,e),u=s,s.prototype.initialize=function(){var e=this;this._tilemapCache=new h(this.cacheByteSize),this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers?"],(function(){return e._initializeTilemapDefinition()})),d.init(this,"layer.tileInfo.lods",(function(t){return e._initializeAvailableLevels(t)}),!0)]),this._initializeTilemapDefinition()},s.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)},s.prototype.castLevels=function(e){return e<=2?(g.error("Minimum levels for Tilemap is 3, but got ",e),3):e},Object.defineProperty(s.prototype,"size",{get:function(){return 1<<this.levels},enumerable:!0,configurable:!0}),s.prototype.fetchTilemap=function(e,t,r,l){var a=this;if(!this._availableLevels[e])return v.reject(new p("tilemap-cache:level-unavailable","Level "+e+" is unavailable in the service"));var n=this._tmpTilemapDefinition,o=this._tilemapFromCache(e,t,r,n);if(o)return v.resolve(o);var s=l&&l.signal;return l=i({},l,{signal:null}),v.create((function(e,t){v.onAbort(s,(function(){return t(v.createAbortError())}));var i=_.tilemapDefinitionId(n),r=a._pendingTilemapRequests[i];if(!r){r=_.Tilemap.fromDefinition(n,l).then((function(e){return a._tilemapCache.put(i,e,e.byteSize),e}));var o=function(){return delete a._pendingTilemapRequests[i]};a._pendingTilemapRequests[i]=r,r.then(o,o)}r.then(e,t)}))},s.prototype.getAvailability=function(e,t,i){if(!this._availableLevels[e])return"unavailable";var r=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return r?r.getAvailability(t,i):"unknown"},s.prototype.getAvailabilityUpsample=function(e,t,i,r){r.level=e,r.row=t,r.col=i;var l=this.layer.tileInfo;for(l.updateTileInfo(r);;){var a=this.getAvailability(r.level,r.row,r.col);if("unavailable"!==a)return a;if(!l.upsampleTile(r))return"unavailable"}},s.prototype.fetchAvailability=function(e,t,i,r){return this._availableLevels[e]?this.fetchTilemap(e,t,i,r).catch((function(e){return e})).then((function(r){if(r instanceof _.Tilemap){var l=r.getAvailability(t,i);return"unavailable"===l?v.reject(new p("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:i})):l}if(v.isAbortError(r))throw r;return"unknown"})):v.reject(new p("tilemap-cache:level-unavailable","Level "+e+" is unavailable in the service"))},s.prototype.fetchAvailabilityUpsample=function(e,t,i,r,l){var a=this;r.level=e,r.row=t,r.col=i;var n=this.layer.tileInfo;n.updateTileInfo(r);var o=this.fetchAvailability(e,t,i,l).catch((function(e){if(v.isAbortError(e))throw e;if(n.upsampleTile(r))return a.fetchAvailabilityUpsample(r.level,r.row,r.col,r);throw e}));return this._fetchAvailabilityUpsamplePrefetch(r.id,e,t,i,l,o),o},s.prototype._fetchAvailabilityUpsamplePrefetch=function(e,t,r,l,o,s){return n(this,void 0,void 0,(function(){var n,p,c,h,f,m,d,b,_,g;return a(this,(function(a){switch(a.label){case 0:if(!this._prefetchingEnabled)return[2];if(n="prefetch-"+e,this._handles.has(n))return[2];p=v.createAbortController(),s.then((function(){return p.abort()}),(function(){return p.abort()})),c=!1,h={remove:function(){c||(c=!0,p.abort())}},this._handles.add(h,n),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,y.waitTicks(10,p.signal)];case 2:return a.sent(),[3,4];case 3:return a.sent(),[3,4];case 4:if(c||(c=!0,this._handles.remove(n)),v.isAborted(p))return[2];for(f={id:e,level:t,row:r,col:l},m=i({},o,{signal:p.signal}),d=this.layer.tileInfo,b=function(e){var t=_.fetchAvailability(f.level,f.row,f.col,m);u._prefetches.push(t);var i=function(){u._prefetches.removeUnordered(t)};t.then(i,i)},_=this,g=0;u._prefetches.length<u._maxPrefetch&&d.upsampleTile(f);++g)b();return[2]}}))}))},s.prototype._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var e=this.layer.parsedUrl,t=e.query;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:t?m.objectToQuery(t):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}},s.prototype._tilemapFromCache=function(e,t,i,r){var l=this._getTilemapDefinition(e,t,i,r),a=_.tilemapDefinitionId(l);return this._tilemapCache.get(a)},s.prototype._getTilemapDefinition=function(e,i,r,l){l.level=e;var a=e>t.TILEMAP_SIZE_EXP;return l.row=a?i-i%this.size:i,l.col=a?r-r%this.size:r,l},s.prototype._initializeAvailableLevels=function(e){var t=this;this._availableLevels={},e&&e.forEach((function(e){return t._availableLevels[e.level]=!0}))},Object.defineProperty(s.prototype,"test",{get:function(){var e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:function(t,i,r){return!!e._tilemapFromCache(t,i,r,e._tmpTilemapDefinition)}}},enumerable:!0,configurable:!0}),s._maxPrefetch=4,s._prefetches=new f({initialSize:u._maxPrefetch}),l([b.property({constructOnly:!0,type:Number})],s.prototype,"levels",void 0),l([b.cast("levels")],s.prototype,"castLevels",null),l([b.property({readOnly:!0,dependsOn:["levels"],type:Number})],s.prototype,"size",null),l([b.property({constructOnly:!0,type:Number})],s.prototype,"cacheByteSize",void 0),l([b.property({constructOnly:!0})],s.prototype,"layer",void 0),l([b.property({constructOnly:!0})],s.prototype,"request",void 0),s=u=l([b.subclass("esri.layers.support.TilemapCache")],s)}(b.declared(s));t.TilemapCache=T}));