// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../request","../../core/Accessor","../../core/Error","../../core/Handles","../../core/Logger","../../core/LRUCache","../../core/PooledArray","../../core/promiseUtils","../../core/scheduling","../../core/urlUtils","../../core/watchUtils","../../core/accessorSupport/decorators","./Tilemap"],(function(e,t,i,r,a,l,n,o,s,c,p,u,h,f,v,_){Object.defineProperty(t,"__esModule",{value:!0});var y=o.getLogger("esri.layers.support.TilemapCache"),d=function(e){function t(t){var i=e.call(this,t)||this;return i._handles=new n,i._pendingTilemapRequests={},i._availableLevels={},i.levels=5,i.cacheByteSize=2097152,i.request=r,i._prefetchingEnabled=!0,i}var a;return i.__extends(t,e),a=t,t.prototype.initialize=function(){var e=this;this._tilemapCache=new s(this.cacheByteSize),this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers?"],(function(){return e._initializeTilemapDefinition()})),f.init(this,"layer.tileInfo.lods",(function(t){return e._initializeAvailableLevels(t)}),!0)]),this._initializeTilemapDefinition()},t.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)},t.prototype.castLevels=function(e){return e<=2?(y.error("Minimum levels for Tilemap is 3, but got ",e),3):e},Object.defineProperty(t.prototype,"size",{get:function(){return 1<<this.levels},enumerable:!0,configurable:!0}),t.prototype.fetchTilemap=function(e,t,r,a){var n=this;if(!this._availableLevels[e])return p.reject(new l("tilemap-cache:level-unavailable","Level "+e+" is unavailable in the service"));var o=this._tmpTilemapDefinition,s=this._tilemapFromCache(e,t,r,o);if(s)return p.resolve(s);var c=a&&a.signal;return a=i.__assign(i.__assign({},a),{signal:null}),p.create((function(e,t){p.onAbort(c,(function(){return t(p.createAbortError())}));var i=_.tilemapDefinitionId(o),r=n._pendingTilemapRequests[i];if(!r){r=_.Tilemap.fromDefinition(o,a).then((function(e){return n._tilemapCache.put(i,e,e.byteSize),e}));var l=function(){return delete n._pendingTilemapRequests[i]};n._pendingTilemapRequests[i]=r,r.then(l,l)}r.then(e,t)}))},t.prototype.getAvailability=function(e,t,i){if(!this._availableLevels[e])return"unavailable";var r=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return r?r.getAvailability(t,i):"unknown"},t.prototype.getAvailabilityUpsample=function(e,t,i,r){r.level=e,r.row=t,r.col=i;var a=this.layer.tileInfo;for(a.updateTileInfo(r);;){var l=this.getAvailability(r.level,r.row,r.col);if("unavailable"!==l)return l;if(!a.upsampleTile(r))return"unavailable"}},t.prototype.fetchAvailability=function(e,t,i,r){return this._availableLevels[e]?this.fetchTilemap(e,t,i,r).catch((function(e){return e})).then((function(r){if(r instanceof _.Tilemap){var a=r.getAvailability(t,i);return"unavailable"===a?p.reject(new l("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:i})):a}if(p.isAbortError(r))throw r;return"unknown"})):p.reject(new l("tilemap-cache:level-unavailable","Level "+e+" is unavailable in the service"))},t.prototype.fetchAvailabilityUpsample=function(e,t,i,r,a){var l=this;r.level=e,r.row=t,r.col=i;var n=this.layer.tileInfo;n.updateTileInfo(r);var o=this.fetchAvailability(e,t,i,a).catch((function(e){if(p.isAbortError(e))throw e;if(n.upsampleTile(r))return l.fetchAvailabilityUpsample(r.level,r.row,r.col,r);throw e}));return this._fetchAvailabilityUpsamplePrefetch(r.id,e,t,i,a,o),o},t.prototype._fetchAvailabilityUpsamplePrefetch=function(e,t,r,l,n,o){return i.__awaiter(this,void 0,void 0,(function(){var s,c,h,f,v,_,y,d,m,b;return i.__generator(this,(function(g){switch(g.label){case 0:if(!this._prefetchingEnabled)return[2];if(s="prefetch-"+e,this._handles.has(s))return[2];c=p.createAbortController(),o.then((function(){return c.abort()}),(function(){return c.abort()})),h=!1,f={remove:function(){h||(h=!0,c.abort())}},this._handles.add(f,s),g.label=1;case 1:return g.trys.push([1,3,,4]),[4,u.waitTicks(10,c.signal)];case 2:return g.sent(),[3,4];case 3:return g.sent(),[3,4];case 4:if(h||(h=!0,this._handles.remove(s)),p.isAborted(c))return[2];for(v={id:e,level:t,row:r,col:l},_=i.__assign(i.__assign({},n),{signal:c.signal}),y=this.layer.tileInfo,d=function(e){var t=m.fetchAvailability(v.level,v.row,v.col,_);a._prefetches.push(t);var i=function(){a._prefetches.removeUnordered(t)};t.then(i,i)},m=this,b=0;a._prefetches.length<a._maxPrefetch&&y.upsampleTile(v);++b)d();return[2]}}))}))},t.prototype._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var e=this.layer.parsedUrl,t=e.query;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:t?h.objectToQuery(t):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}},t.prototype._tilemapFromCache=function(e,t,i,r){r.level=e,r.row=t-t%this.size,r.col=i-i%this.size;var a=_.tilemapDefinitionId(r);return this._tilemapCache.get(a)},t.prototype._initializeAvailableLevels=function(e){var t=this;this._availableLevels={},e&&e.forEach((function(e){return t._availableLevels[e.level]=!0}))},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:function(t,i,r){return!!e._tilemapFromCache(t,i,r,e._tmpTilemapDefinition)}}},enumerable:!0,configurable:!0}),t._maxPrefetch=4,t._prefetches=new c({initialSize:a._maxPrefetch}),i.__decorate([v.property({constructOnly:!0,type:Number})],t.prototype,"levels",void 0),i.__decorate([v.cast("levels")],t.prototype,"castLevels",null),i.__decorate([v.property({readOnly:!0,dependsOn:["levels"],type:Number})],t.prototype,"size",null),i.__decorate([v.property({constructOnly:!0,type:Number})],t.prototype,"cacheByteSize",void 0),i.__decorate([v.property({constructOnly:!0})],t.prototype,"layer",void 0),i.__decorate([v.property({constructOnly:!0})],t.prototype,"request",void 0),t=a=i.__decorate([v.subclass("esri.layers.support.TilemapCache")],t)}(a);t.TilemapCache=d}));