/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../../../geometry/Point","../../../geometry/Extent","../../../geometry","../../../core/unitUtils","../../../geometry/projection"],(function(e,t,n,o,i,r,a,s,l){"use strict";const c=5e-4,x=function(e,t){const n=(e.isWGS84||e.isWebMercator)&&(t.isWGS84||t.isWebMercator);return!(e.equals(t)||n)},u=function(e,t){const n=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,o=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4;return[Math.abs(n-e[2*t.rows+2]),Math.abs(o-e[2*t.rows+3])]},p=32;async function f(){if(l.isLoaded()||!l.isSupported())return null;await l.load()}function m(e,n,o){if(!x(e.spatialReference,n))return null;if(!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");return o?l.getTransformation(n,e.spatialReference,e):l.getTransformation(e.spatialReference,n,e)}function h(e,n,i,a=null){if(e.spatialReference.equals(n))return e;const s=x(e.spatialReference,n);if(s&&!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");const c=i.center,u=new r({xmin:c.x-e.x/2,xmax:c.x+e.x/2,ymin:c.y-e.y/2,ymax:c.y+e.y/2,spatialReference:e.spatialReference}),p=s?l.project(u,n,a):o.project(u,n);if(null==p)return null;return{x:p.xmax-p.xmin,y:p.ymax-p.ymin}}function y(e,t=.01){return s.getMetersPerUnitForSR(e)?t/s.getMetersPerUnitForSR(e):0}function d(e,i,r=null,a=!0){const s=e.spatialReference;if(s.equals(i))return e;const u=x(s,i);if(u&&!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");const p=u?l.project(e,i,r):o.project(e,i);if(p&&a&&i.isGeographic){var f,m;const[t,o]=s.isWebMercator?n.getInfo(s).origin:null!=(f=null==(m=n.getInfo(s))?void 0:m.valid)?f:[],i=y(s);i&&null!=t&&null!=o&&(Math.abs(e.x-t)<i&&Math.abs(180-p.x)<c?p.x-=360:Math.abs(e.x-o)<i&&Math.abs(180+p.x)<c&&(p.x+=360))}return p}function M(e,r,a=null,s=!0){var u,p,f,m;const h=e.spatialReference;if(h.equals(r))return e;const M=x(h,r);if(M&&!l.isLoaded())throw new t("rasterprojectionhelper-projectExtent","projection engine is not loaded");const g=M?l.project(e,r,a):o.project(e,r);let[w,R]=null!=(u=null==(p=n.getInfo(h))?void 0:p.origin)?u:[];if(g&&s&&h.isWebMercator&&r.isGeographic&&null!=w&&null!=R){const t=.001,n=1e3;if(Math.abs(e.xmin-w)<t&&Math.abs(R-e.xmax)>n&&Math.abs(180-g.xmax)<c){g.xmin=-180;const t=[];t.push(new i(e.xmax,e.ymin,h)),t.push(new i(e.xmax,(e.ymin+e.ymax)/2,h)),t.push(new i(e.xmax,e.ymax,h));const n=t.map((e=>d(e,r,a))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));g.xmax=Math.max.apply(null,n)}if(Math.abs(e.xmax-R)<t&&Math.abs(w-e.xmin)>n&&Math.abs(180+g.xmin)<c){g.xmax=180;const t=[];t.push(new i(e.xmin,e.ymin,h)),t.push(new i(e.xmin,(e.ymin+e.ymax)/2,h)),t.push(new i(e.xmin,e.ymax,h));const n=t.map((e=>d(e,r,a))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));g.xmin=Math.min.apply(null,n)}}[w,R]=r.isWebMercator?n.getInfo(r).origin:null!=(f=null==(m=n.getInfo(r))?void 0:m.valid)?f:[];const j=y(r);return j&&null!=w&&null!=R&&(Math.abs(g.xmin-w)<j&&(g.xmin=w),Math.abs(g.xmax-R)<j&&(g.xmax=R)),g}function g(e,o,r,a=null,s=null,c=!1,f=[p,p]){var m,h;if(x(e.spatialReference,o.spatialReference)&&!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(e&&o&&r))return null;const{xmin:y,ymin:M,xmax:g,ymax:w}=e,R=e.spatialReference,j=o.spatialReference,[b,v]=null!=(m=null==(h=n.getInfo(R))?void 0:h.valid)?m:[],S={x:f[0]*r.x,y:f[1]*r.y},P={cols:Math.ceil((g-y)/S.x-.1)+1,rows:Math.ceil((w-M)/S.y-.1)+1},N=S.x,L=S.y,z=[];let G,W=!1;for(let t=0;t<P.cols;t++){const e=[];for(let n=0;n<P.rows;n++){let r=d(new i({x:y+N*t,y:w-L*n,spatialReference:R}),j,a);s&&(r=s.inverseTransform(r)),e.push(r),t>0&&c&&r&&G[n]&&null!=b&&r.x<G[n].x&&(r.x+=v-b),r?(z.push((r.x-o.xmin)/(o.xmax-o.xmin)),z.push((o.ymax-r.y)/(o.ymax-o.ymin))):(z.push(NaN),z.push(NaN),W=!0)}G=e}const F=u(z,P),I=new Float32Array((P.cols-1)*(P.rows-1)*2*6),T=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),U=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let t=0;t<P.cols-1;t++){for(let e=0;e<P.rows-1;e++){let n=t*P.rows*2+2*e;const o=z[n],i=z[n+1],r=z[n+2],a=z[n+3];n+=2*P.rows;const s=z[n],l=z[n+1],c=z[n+2],x=z[n+3];let u=0,p=12*(e*(P.cols-1)+t);for(let e=0;e<3;e++)I[p++]=T[u++]*o+T[u++]*r+T[u++]*c;u=0;for(let e=0;e<3;e++)I[p++]=T[u++]*i+T[u++]*a+T[u++]*x;u=0;for(let e=0;e<3;e++)I[p++]=U[u++]*o+U[u++]*s+U[u++]*c;u=0;for(let e=0;e<3;e++)I[p++]=U[u++]*i+U[u++]*l+U[u++]*x}if(W)for(let e=0;e<I.length;e++)isNaN(I[e])&&(I[e]=-1)}return{offsets:z,error:F,coefficients:I,spacing:f,size:[P.cols-1,P.rows-1]}}function w(e,t,n){const o=Math.log(e.x/t.pixelSize.x)/Math.LN2,r=Math.log(e.y/t.pixelSize.y)/Math.LN2,a=t.storageInfo.maximumPyramidLevel||0;let s="down"===n?Math.floor(Math.min(o,r)):"up"===n?Math.ceil(Math.max(o,r)):Math.round((o+r)/2),l=!1;s<0?s=0:s>a&&(l=s>a+3,s=a);const c=2**s;return{pyramidLevel:s,pyramidResolution:new i({x:c*t.nativePixelSize.x,y:c*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:l}}function R(e,t,n=512,o=!0){const{extent:r,spatialReference:a,pixelSize:l}=e,c=h(new i({x:l.x,y:l.y,spatialReference:a}),t,r);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const x=(c.x+c.y)/2,u=s.getMetersPerUnitForSR(t),p=x*u*96*39.37,f=t.isGeographic?512/n*295828763.7958547:512/n*591657527.591555;let m=!1;const y=M(r,t);o&&(t.isGeographic||t.isWebMercator)&&(m=y.xmin*y.xmax<0);let d,g=p;const w=1.001;if(m){g=f;const e=.29858214164761665,t=e*(96*u*39.37);d=h(new i({x:e,y:e,spatialReference:{wkid:3857}}),a,y),d.x*=g/t,d.y*=g/t}else{d={x:l.x,y:l.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let n=0;for(;g<f*(w/2)&&n<t;)n++,g*=2,d.x*=2,d.y*=2;Math.max(g,f)/Math.min(g,f)<=w&&(g=f)}const R=[g],j=[{x:d.x,y:d.y}],b=70.5310735,v=Math.min(b,p)/w;for(;g>=v;)g/=2,d.x/=2,d.y/=2,R.push(g),j.push({x:d.x,y:d.y});return{projectedPixelSize:c,scales:R,srcResolutions:j,isCustomTilingScheme:!m}}e.computeProjectedScales=R,e.defaultGridSpacing=p,e.getDefaultDatumTransformationForDataset=m,e.getProjectionOffsetGrid=g,e.load=f,e.projectExtent=M,e.projectPoint=d,e.projectResolution=h,e.snapPyramid=w,Object.defineProperty(e,"__esModule",{value:!0})}));
