/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/unitUtils","../../../geometry/projection","../../../geometry/support/webMercatorUtils","../../../geometry/Extent","../../../geometry/Point"],(function(e,t,n,o,i,r,a,s,l,c){"use strict";const u=5e-4,x=function(e,t){const n=(e.isWGS84||e.isWebMercator)&&(t.isWGS84||t.isWebMercator);return!(e.equals(t)||n)},f=function(e,t){const n=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,o=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4;return[Math.abs(n-e[2*t.rows+2]),Math.abs(o-e[2*t.rows+3])]},m={3395:20037508.342789244,3410:17334193.943686873,3832:3339584.723798206,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,8858:7396237.374497803,8859:2465412.4581659334,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53025:7276828.3848298555,53031:10384677.558821043,53034:20015086.79602057,53036:7389443.187332862,53037:2463147.729110953,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54025:7311399.09166516,54031:10396310.810074743,54034:20037508.342789244,54050:808820.9223376509,54053:1920897.3915568967,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244,102038:4297258.582585486,102299:5013965.117483125},p=32;function h(){return y.apply(this,arguments)}function y(){return(y=t._asyncToGenerator((function*(){if(a.isLoaded()||!a.isSupported())return null;yield a.load()}))).apply(this,arguments)}function d(e,t,n){if(!x(e.spatialReference,t))return null;if(!a.isLoaded())throw new o("rasterprojectionhelper-projectResolution","projection engine is not loaded");return n?a.getTransformation(t,e.spatialReference,e):a.getTransformation(e.spatialReference,t,e)}function g(e,t,n,r=null){if(e.spatialReference.equals(t))return e;const c=x(e.spatialReference,t);if(c&&!a.isLoaded())throw new o("rasterprojectionhelper-projectResolution","projection engine is not loaded");const u=n.center,f=new l({xmin:u.x-e.x/2,xmax:u.x+e.x/2,ymin:u.y-e.y/2,ymax:u.y+e.y/2,spatialReference:e.spatialReference}),m=c?a.project(f,t,r):s.project(f,t);if(i.isNone(m))return null;return{x:m.xmax-m.xmin,y:m.ymax-m.ymin}}function M(e,t=.01){return r.getMetersPerUnitForSR(e)?t/r.getMetersPerUnitForSR(e):0}function w(e,t,n=null,r=!0){const l=e.spatialReference;if(l.equals(t))return e;let c=s.project(e,t);if(i.isNone(c)){if(!a.isLoaded())throw new o("rasterprojectionhelper-projectResolution","projection engine is not loaded");c=a.project(e,t,n)}if(r&&t.isGeographic){const[t,n]=P(l,!0),o=M(l);o&&null!=t&&null!=n&&(Math.abs(e.x-t)<o&&Math.abs(180-c.x)<u?c.x-=360:Math.abs(e.x-n)<o&&Math.abs(180+c.x)<u&&(c.x+=360))}return c}function R(e){const t=b(e[0].spatialReference);if(e.length<2||!i.isSome(t))return e[0];let{xmin:n,xmax:o,ymin:r,ymax:a}=e[0];for(let i=1;i<e.length;i++){const n=e[i];o=n.xmax+t*i,r=Math.min(r,n.ymin),a=Math.max(a,n.ymax)}return new l({xmin:n,xmax:o,ymin:r,ymax:a,spatialReference:e[0].spatialReference})}function j(e,t,n=null,o=!0){if(e.spatialReference.equals(t))return e;const r=N(e),a=b(e.spatialReference,!0);if(!i.isSome(a)||0===r)return S(e,t,n,o);return R(e.clone().normalize().map((e=>S(e,t,n,o))))}function S(e,t,n=null,r=!0){const l=e.spatialReference;if(l.equals(t))return e;if(x(l,t)&&!a.isLoaded())throw new o("rasterprojectionhelper-projectExtent","projection engine is not loaded");let f=s.project(e,t);i.isNone(f)&&(f=a.project(e,t,n));let[m,p]=P(l,!0);if(f&&r&&l.isWebMercator&&t.isGeographic&&null!=m&&null!=p){const o=.001,i=1e3;if(Math.abs(e.xmin-m)<o&&Math.abs(p-e.xmax)>i&&Math.abs(180-f.xmax)<u){f.xmin=-180;const o=[];o.push(new c(e.xmax,e.ymin,l)),o.push(new c(e.xmax,(e.ymin+e.ymax)/2,l)),o.push(new c(e.xmax,e.ymax,l));const i=o.map((e=>w(e,t,n))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));f.xmax=Math.max.apply(null,i)}if(Math.abs(e.xmax-p)<o&&Math.abs(m-e.xmin)>i&&Math.abs(180+f.xmin)<u){f.xmax=180;const o=[];o.push(new c(e.xmin,e.ymin,l)),o.push(new c(e.xmin,(e.ymin+e.ymax)/2,l)),o.push(new c(e.xmin,e.ymax,l));const i=o.map((e=>w(e,t,n))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));f.xmin=Math.min.apply(null,i)}}[m,p]=P(t,!0);const h=M(t);return h&&null!=m&&null!=p&&(Math.abs(f.xmin-m)<h&&(f.xmin=m),Math.abs(f.xmax-p)<h&&(f.xmax=p)),f}function b(e,t=!1){const n=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*n:e.wkid&&e.isGeographic?360:2*m[e.wkid]||null}function P(e,t=!1){const n=[],o=b(e,t);return i.isSome(o)&&(n.push(-o/2),n.push(o/2)),n}function v(e,t,n,o){let i=(e-t)/n;return i-Math.floor(i)!=0?i=Math.floor(i):o&&(i-=1),i}function N(e,t=!1){const n=b(e.spatialReference);if(!i.isSome(n))return 0;const o=t?0:-(n/2);return v(e.xmax,o,n,!0)-v(e.xmin,o,n,!1)}function W(e){const t=e.storageInfo.origin.x,n=b(e.spatialReference,!0);if(!i.isSome(n))return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const o=n/2,{nativePixelSize:r,storageInfo:a,extent:s}=e,{maximumPyramidLevel:l,blockWidth:c,pyramidScalingFactor:u}=a;let x=r.x;const f=[],m=i.isSome(e.transform)&&"gcs-shift"===e.transform.type,p=t+o,h=m?n-t:o-t;for(let i=0;i<=l;i++){const e=(s.xmax-t)/x/c,o=e-Math.floor(e)==0?e:Math.ceil(e),i=(n/2-t)/x/c,r=i-Math.floor(i)==0?i:Math.ceil(i),a=Math.floor(p/x/c),l=Math.round(p/x)%c,m=(c-Math.round(h/x)%c)%c;f.push({resolutionX:x,blockWidth:c,datsetColumnCount:o,worldColumnCountFromOrigin:r,leftMargin:l,rightPadding:m,originColumnOffset:a}),x*=u}return{originX:t,halfWorldWidth:o,pyramidsInfo:f,hasGCSSShiftTransform:m}}function G(e,t,n,r=null,s=null,l=!1,u=[p,p]){if(x(e.spatialReference,t.spatialReference)&&!a.isLoaded())throw new o("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(e&&t&&n))return null;const{xmin:m,ymin:h,xmax:y,ymax:d}=e,g=e.spatialReference,M=t.spatialReference,R=b(M);l=l||"gcs-shift"===(null==s?void 0:s.type);const j={x:u[0]*n.x,y:u[1]*n.y},S={cols:Math.ceil((y-m)/j.x-.1/u[0])+1,rows:Math.ceil((d-h)/j.y-.1/u[1])+1},P=j.x,v=j.y,N=[];let W,G=!1;for(let o=0;o<S.cols;o++){const e=[];for(let n=0;n<S.rows;n++){let a=w(new c({x:m+P*o,y:d-v*n,spatialReference:g}),M,r);s&&(a=s.inverseTransform(a)),e.push(a),o>0&&l&&a&&W[n]&&i.isSome(R)&&a.x<W[n].x&&(a.x+=R),a?(N.push((a.x-t.xmin)/(t.xmax-t.xmin)),N.push((t.ymax-a.y)/(t.ymax-t.ymin))):(N.push(NaN),N.push(NaN),G=!0)}W=e}const L=f(N,S),z=new Float32Array((S.cols-1)*(S.rows-1)*2*6),T=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),C=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let o=0;o<S.cols-1;o++){for(let e=0;e<S.rows-1;e++){let t=o*S.rows*2+2*e;const n=N[t],i=N[t+1],r=N[t+2],a=N[t+3];t+=2*S.rows;const s=N[t],l=N[t+1],c=N[t+2],u=N[t+3];let x=0,f=12*(e*(S.cols-1)+o);for(let e=0;e<3;e++)z[f++]=T[x++]*n+T[x++]*r+T[x++]*c;x=0;for(let e=0;e<3;e++)z[f++]=T[x++]*i+T[x++]*a+T[x++]*u;x=0;for(let e=0;e<3;e++)z[f++]=C[x++]*n+C[x++]*s+C[x++]*c;x=0;for(let e=0;e<3;e++)z[f++]=C[x++]*i+C[x++]*l+C[x++]*u}if(G)for(let e=0;e<z.length;e++)isNaN(z[e])&&(z[e]=-1)}return{offsets:N,error:L,coefficients:z,spacing:u,size:[S.cols-1,S.rows-1]}}function L(e){const t=e.clone().normalize();return 1===t.length?t[0]:R(t)}function z(e,t,n){const{storageInfo:o,pixelSize:r}=t;let a,s=!1;const{pyramidResolutions:l}=o;if(i.isSome(l)&&l.length){const o=(e.x+e.y)/2,i=l[l.length-1],u=(i.x+i.y)/2,x=(r.x+r.y)/2;if(o<=x)a=0;else if(o>=u)a=l.length,s=o/u>8;else{let e,t=x;for(let i=1;i<=l.length;i++){if(e=(l[i-1].x+l[i-1].y)/2,o<=e){o===e?a=i:"down"===n?(a=i-1,s=o/t>8):a="up"===n||o-t>e-o||o/t>2?i:i-1;break}t=e}}const f=0===a?r:l[a-1];return{pyramidLevel:a,pyramidResolution:new c({x:f.x,y:f.y,spatialReference:t.spatialReference}),excessiveReading:s}}const u=Math.log(e.x/r.x)/Math.LN2,x=Math.log(e.y/r.y)/Math.LN2,f=t.storageInfo.maximumPyramidLevel||0;a="down"===n?Math.floor(Math.min(u,x)):"up"===n?Math.ceil(Math.max(u,x)):Math.round((u+x)/2),a<0?a=0:a>f&&(s=a>f+3,a=f);const m=2**a;return{pyramidLevel:a,pyramidResolution:new c({x:m*t.nativePixelSize.x,y:m*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:s}}function T(e,t,n=512,o=!0){const{extent:i,spatialReference:a,pixelSize:s}=e,l=g(new c({x:s.x,y:s.y,spatialReference:a}),t,i);if(null==l)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const u=(l.x+l.y)/2,x=r.getMetersPerUnitForSR(t),f=u*x*96*39.37,m=t.isGeographic?256/n*295828763.7958547:256/n*591657527.591555;let p="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const h=j(i,t);p||o&&(t.isGeographic||t.isWebMercator)&&(p=h.xmin*h.xmax<0);let y,d=f;const M=1.001;if(p){d=m;const e=t.isGeographic?1341104507446289e-21:.29858214164761665,n=e*(96*x*39.37),o=t.isGeographic?4326:3857;y=g(new c({x:e,y:e,spatialReference:{wkid:o}}),a,h),y.x*=d/n,y.y*=d/n}else{y={x:s.x,y:s.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let n=0;for(;d<m*(M/2)&&n<t;)n++,d*=2,y.x*=2,y.y*=2;Math.max(d,m)/Math.min(d,m)<=M&&(d=m)}const w=[d],R=[{x:y.x,y:y.y}],S=70.5310735,b=Math.min(S,f)/M;for(;d>=b;)d/=2,y.x/=2,y.y/=2,w.push(d),R.push({x:y.x,y:y.y});return{projectedPixelSize:l,scales:w,srcResolutions:R,isCustomTilingScheme:!p}}e.computeProjectedScales=T,e.defaultGridSpacing=p,e.getDefaultDatumTransformationForDataset=d,e.getProjectionOffsetGrid=G,e.getRasterDatasetAlignmentInfo=W,e.getWorldWrapCount=N,e.load=h,e.projectExtent=j,e.projectPoint=w,e.projectResolution=g,e.snapExtent=L,e.snapPyramid=z,Object.defineProperty(e,"__esModule",{value:!0})}));
