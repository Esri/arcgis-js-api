// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../core/Error","../../../core/unitUtils","../../../geometry/projection","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils"],(function(e,r,i,n,t,a,o,l,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.computeProjectedScales=r.snapPyramid=r.getProjectionOffsetGrid=r.projectExtent=r.projectPoint=r.projectResolution=r.load=r.defaultGridSpacing=void 0;var u=function(e,r){var i=(e.isWGS84||e.isWebMercator)&&(r.isWGS84||r.isWebMercator);return!(e.equals(r)||i)};function c(e,r,i,a){if(void 0===a&&(a=null),e.spatialReference.equals(r))return e;var l=u(e.spatialReference,r);if(l&&!o.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");var c=i.center,x=new n.Extent({xmin:c.x-e.x/2,xmax:c.x+e.x/2,ymin:c.y-e.y/2,ymax:c.y+e.y/2,spatialReference:e.spatialReference}),p=l?o.project(x,r,a):s.project(x,r);return null==p?null:{x:p.xmax-p.xmin,y:p.ymax-p.ymin}}function x(e,r){return void 0===r&&(r=.01),a.getMetersPerUnitForSR(e)?r/a.getMetersPerUnitForSR(e):0}function p(e,r,i,n){var a,c;void 0===i&&(i=null),void 0===n&&(n=!0);var p=e.spatialReference;if(p.equals(r))return e;var f=u(p,r);if(f&&!o.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");var d=f?o.project(e,r,i):s.project(e,r);if(d&&n&&r.isGeographic){var m=p.isWebMercator?l.getInfo(p).origin:null!==(c=null===(a=l.getInfo(p))||void 0===a?void 0:a.valid)&&void 0!==c?c:[],h=m[0],v=m[1],y=x(p);y&&null!=h&&null!=v&&(Math.abs(e.x-h)<y&&Math.abs(180-d.x)<5e-4?d.x-=360:Math.abs(e.x-v)<y&&Math.abs(180+d.x)<5e-4&&(d.x+=360))}return d}function f(e,r,i,a){var c,f,d,m,h;void 0===i&&(i=null),void 0===a&&(a=!0);var v=e.spatialReference;if(v.equals(r))return e;var y=u(v,r);if(y&&!o.isLoaded())throw new t("rasterprojectionhelper-projectExtent","projection engine is not loaded");var M=y?o.project(e,r,i):s.project(e,r),g=null!==(d=null===(f=l.getInfo(v))||void 0===f?void 0:f.origin)&&void 0!==d?d:[],w=g[0],j=g[1];if(M&&a&&v.isWebMercator&&r.isGeographic&&null!=w&&null!=j){if(Math.abs(e.xmin-w)<.001&&Math.abs(j-e.xmax)>1e3&&Math.abs(180-M.xmax)<5e-4){M.xmin=-180,(P=[]).push(new n.Point(e.xmax,e.ymin,v)),P.push(new n.Point(e.xmax,(e.ymin+e.ymax)/2,v)),P.push(new n.Point(e.xmax,e.ymax,v));var R=P.map((function(e){return p(e,r,i)})).filter((function(e){return!isNaN(null==e?void 0:e.x)})).map((function(e){return e.x}));M.xmax=Math.max.apply(null,R)}if(Math.abs(e.xmax-j)<.001&&Math.abs(w-e.xmin)>1e3&&Math.abs(180+M.xmin)<5e-4){var P;M.xmax=180,(P=[]).push(new n.Point(e.xmin,e.ymin,v)),P.push(new n.Point(e.xmin,(e.ymin+e.ymax)/2,v)),P.push(new n.Point(e.xmin,e.ymax,v));R=P.map((function(e){return p(e,r,i)})).filter((function(e){return!isNaN(null==e?void 0:e.x)})).map((function(e){return e.x}));M.xmin=Math.min.apply(null,R)}}w=(c=r.isWebMercator?l.getInfo(r).origin:null!==(h=null===(m=l.getInfo(r))||void 0===m?void 0:m.valid)&&void 0!==h?h:[])[0],j=c[1];var b=x(r);return b&&null!=w&&null!=j&&(Math.abs(M.xmin-w)<b&&(M.xmin=w),Math.abs(M.xmax-j)<b&&(M.xmax=j)),M}r.defaultGridSpacing=32,r.load=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){switch(e.label){case 0:return o.isLoaded()||!o.isSupported()?[2,null]:[4,o.load()];case 1:return e.sent(),[2]}}))}))},r.projectResolution=c,r.projectPoint=p,r.projectExtent=f,r.getProjectionOffsetGrid=function(e,i,a,s,c,x){var f,d;if(void 0===s&&(s=null),void 0===c&&(c=!1),void 0===x&&(x=[r.defaultGridSpacing,r.defaultGridSpacing]),u(e.spatialReference,i.spatialReference)&&!o.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(e&&i&&a))return null;for(var m,h,v=e.xmin,y=e.ymin,M=e.xmax,g=e.ymax,w=e.spatialReference,j=i.spatialReference,R=null!==(d=null===(f=l.getInfo(w))||void 0===f?void 0:f.valid)&&void 0!==d?d:[],P=R[0],b=R[1],S={x:x[0]*a.x,y:x[1]*a.y},N={cols:Math.ceil((M-v)/S.x-.1)+1,rows:Math.ceil((g-y)/S.y-.1)+1},G=S.x,L=S.y,z=[],W=!1,I=0;I<N.cols;I++){for(var F=[],U=0;U<N.rows;U++)m=p(new n.Point({x:v+G*I,y:g-L*U,spatialReference:w}),j,s),F.push(m),I>0&&c&&m&&h[U]&&null!=P&&m.x<h[U].x&&(m.x+=b-P),m?(z.push((m.x-i.xmin)/(i.xmax-i.xmin)),z.push((i.ymax-m.y)/(i.ymax-i.ymin))):(z.push(NaN),z.push(NaN),W=!0);h=F}var _=function(e,r){var i=(e[0]+e[4]+e[4*r.cols]+e[4*r.cols+4])/4,n=(e[1]+e[5]+e[4*r.rows+1]+e[4*r.rows+5])/4;return[Math.abs(i-e[2*r.rows+2]),Math.abs(n-e[2*r.rows+3])]}(z,N),q=new Float32Array((N.cols-1)*(N.rows-1)*2*6),E=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),A=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(I=0;I<N.cols-1;I++){for(U=0;U<N.rows-1;U++){for(var O=I*N.rows*2+2*U,k=z[O],B=z[O+1],C=z[O+2],D=z[O+3],H=z[O+=2*N.rows],J=z[O+1],K=z[O+2],Q=z[O+3],T=0,V=12*(U*(N.cols-1)+I),X=0;X<3;X++)q[V++]=E[T++]*k+E[T++]*C+E[T++]*K;T=0;for(X=0;X<3;X++)q[V++]=E[T++]*B+E[T++]*D+E[T++]*Q;T=0;for(X=0;X<3;X++)q[V++]=A[T++]*k+A[T++]*H+A[T++]*K;T=0;for(X=0;X<3;X++)q[V++]=A[T++]*B+A[T++]*J+A[T++]*Q}if(W)for(var Y=0;Y<q.length;Y++)isNaN(q[Y])&&(q[Y]=-1)}return{offsets:z,error:_,coefficients:q,spacing:x,size:[N.cols-1,N.rows-1]}},r.snapPyramid=function(e,r,i){var t=Math.log(e.x/r.pixelSize.x)/Math.LN2,a=Math.log(e.y/r.pixelSize.y)/Math.LN2,o=r.storageInfo.maximumPyramidLevel||0,l="down"===i?Math.floor(Math.min(t,a)):"up"===i?Math.ceil(Math.max(t,a)):Math.round((t+a)/2),s=!1;l<0?l=0:l>o&&(s=l>o+3,l=o);var u=Math.pow(2,l);return{pyramidLevel:l,pyramidResolution:new n.Point({x:u*r.pixelSize.x,y:u*r.pixelSize.y,spatialReference:r.spatialReference}),excessiveReading:s}},r.computeProjectedScales=function(e,r,i,t){void 0===i&&(i=512),void 0===t&&(t=!0);var o=e.extent,l=e.spatialReference,s=e.pixelSize,u=c(new n.Point({x:s.x,y:s.y,spatialReference:l}),r,o);if(null==u)return{projectedPixelSize:null,scales:null,srcResolutions:null};var x=(u.x+u.y)/2,p=a.getMetersPerUnitForSR(r),d=x*p*96*39.37,m=r.isGeographic?512/i*295828763.7958547:512/i*591657527.591555,h=!1;if(t&&(r.isGeographic||r.isWebMercator)){var v=f(o,r);h=v.xmin*v.xmax<0}var y,M=d;if(h){var g=(M=m)/(96*p*39.37);y=c(new n.Point({x:g,y:g,spatialReference:r}),l,o)}else{y={x:s.x,y:s.y};for(var w=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2),j=0;M<.5005*m&&j<w;)j++,M*=2,y.x*=2,y.y*=2;Math.max(M,m)/Math.min(M,m)<=1.001&&(M=m)}for(var R=[],P=[],b=Math.min(70.5310735,d)/1.001;M>=b;)R.push(M),P.push({x:y.x,y:y.y}),M/=2,y.x/=2,y.y/=2;return{projectedPixelSize:u,scales:R,srcResolutions:P}}}));