/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/unitUtils","../../../geometry/projection","../../../geometry/Extent","../../../geometry/Point"],(function(e,t,n,o,i,r,a,s,l){"use strict";const c=5e-4;function u(e,t,n){return!a.canProjectWithoutEngine(e,t,n)}function f(e,t,n){const i=u(e,t,n);if(i&&!a.isLoaded())throw new o("rasterprojectionhelper-project","projection engine is not loaded");return i}const x=function(e,t,n){const o=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,i=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4,r=(e[4*t.cols]-e[0]+e[4*t.cols+4]-e[4])/n[0]*.5,a=(e[4*t.cols+1]-e[1]+e[4*t.cols+5]-e[5])/n[1]*.5;return[0===r||isNaN(r)?0:Math.abs(o-e[2*t.rows+2])/Math.abs(r),0===a||isNaN(a)?0:Math.abs(i-e[2*t.rows+3])/Math.abs(a)]},m={3395:20037508.342789244,3410:17334193.943686873,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53034:20015086.79602057,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54034:20037508.342789244,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244},p=32,h=4,y=h;function d(){return g.apply(this,arguments)}function g(){return(g=t._asyncToGenerator((function*(){if(a.isLoaded())return null;yield a.load()}))).apply(this,arguments)}function M(e,t,n){if(!f(e.spatialReference,t))return null;return n?a.getTransformation(t,e.spatialReference,e):a.getTransformation(e.spatialReference,t,e)}function R(e,t,n,o=null){if(e.spatialReference.equals(t))return e;f(e.spatialReference,t,o);const r=n.center,l=new s({xmin:r.x-e.x/2,xmax:r.x+e.x/2,ymin:r.y-e.y/2,ymax:r.y+e.y/2,spatialReference:e.spatialReference}),c=a.project(l,t,o);if(i.isNone(c))return null;return{x:c.xmax-c.xmin,y:c.ymax-c.ymin}}function w(e,t=.01){return r.getMetersPerUnitForSR(e)?t/r.getMetersPerUnitForSR(e):0}function S(e,t,n=null,o=!0){const i=e.spatialReference;if(i.equals(t))return e;f(i,t,n);const r=a.project(e,t,n);if(o&&t.isGeographic){const[t,n]=z(i,!0),o=w(i);o&&null!=t&&null!=n&&(Math.abs(e.x-t)<o&&Math.abs(180-r.x)<c?r.x-=360:Math.abs(e.x-n)<o&&Math.abs(180+r.x)<c&&(r.x+=360))}return r}function b(e,t,n=null){const o=e[0].spatialReference;return o.equals(t)?e:(f(o,t,n),a.project(e,t,n))}function P(e){const t=N(e[0].spatialReference);if(e.length<2||!i.isSome(t))return e[0];let{xmin:n,xmax:o,ymin:r,ymax:a}=e[0];for(let i=1;i<e.length;i++){const n=e[i];o=n.xmax+t*i,r=Math.min(r,n.ymin),a=Math.max(a,n.ymax)}return new s({xmin:n,xmax:o,ymin:r,ymax:a,spatialReference:e[0].spatialReference})}function j(e,t,n=null,o=!0){if(e.spatialReference.equals(t))return e;const r=T(e),a=N(e.spatialReference,!0);if(!i.isSome(a)||0===r)return v(e,t,n,o);return P(e.clone().normalize().map((e=>v(e,t,n,o))))}function v(e,t,n=null,o=!0){const i=e.spatialReference;if(i.equals(t))return e;f(i,t,n);const r=a.project(e,t,n);let[s,u]=z(i,!0);if(r&&o&&i.isWebMercator&&t.isGeographic&&null!=s&&null!=u){const o=.001,a=1e3;if(Math.abs(e.xmin-s)<o&&Math.abs(u-e.xmax)>a&&Math.abs(180-r.xmax)<c){r.xmin=-180;const o=[];o.push(new l(e.xmax,e.ymin,i)),o.push(new l(e.xmax,(e.ymin+e.ymax)/2,i)),o.push(new l(e.xmax,e.ymax,i));const a=o.map((e=>S(e,t,n))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));r.xmax=Math.max.apply(null,a)}if(Math.abs(e.xmax-u)<o&&Math.abs(s-e.xmin)>a&&Math.abs(180+r.xmin)<c){r.xmax=180;const o=[];o.push(new l(e.xmin,e.ymin,i)),o.push(new l(e.xmin,(e.ymin+e.ymax)/2,i)),o.push(new l(e.xmin,e.ymax,i));const a=o.map((e=>S(e,t,n))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));r.xmin=Math.min.apply(null,a)}}[s,u]=z(t,!0);const x=w(t);return x&&null!=s&&null!=u&&r&&(Math.abs(r.xmin-s)<x&&(r.xmin=s),Math.abs(r.xmax-u)<x&&(r.xmax=u)),r}function N(e,t=!1){const n=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*n:e.wkid&&e.isGeographic?360:2*m[e.wkid]||null}function z(e,t=!1){const n=[],o=N(e,t);return i.isSome(o)&&(n.push(-o/2),n.push(o/2)),n}function W(e,t,n,o){let i=(e-t)/n;return i-Math.floor(i)!=0?i=Math.floor(i):o&&(i-=1),i}function T(e,t=!1){const n=N(e.spatialReference);if(!i.isSome(n))return 0;const o=t?0:-(n/2);return W(e.xmax,o,n,!0)-W(e.xmin,o,n,!1)}function C(e){const t=e.storageInfo.origin.x,n=N(e.spatialReference,!0);if(!i.isSome(n))return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const o=n/2,{nativePixelSize:r,storageInfo:a,extent:s}=e,{maximumPyramidLevel:l,blockWidth:c,pyramidScalingFactor:u}=a;let f=r.x;const x=[],m=i.isSome(e.transform)&&"gcs-shift"===e.transform.type,p=t+(m?0:o),h=m?n-t:o-t;for(let i=0;i<=l;i++){const e=(s.xmax-t)/f/c,n=e-Math.floor(e)==0?e:Math.ceil(e),o=h/f/c,i=o-Math.floor(o)==0?o:Math.ceil(o),r=Math.floor(p/f/c),a=Math.round(p/f)%c,l=(c-Math.round(h/f)%c)%c;x.push({resolutionX:f,blockWidth:c,datsetColumnCount:n,worldColumnCountFromOrigin:i,leftMargin:a,rightPadding:l,originColumnOffset:r}),f*=u}return{originX:t,halfWorldWidth:o,pyramidsInfo:x,hasGCSSShiftTransform:m}}function G(e){const t=e.isAdaptive&&null==e.spacing,n=e.spacing||[p,p];let o=F(e),i={cols:o.size[0]+1,rows:o.size[1]+1},r=x(o.offsets,i,n);const a=(r[0]+r[1])/2,s=o.outofBoundPointCount>0&&o.outofBoundPointCount<o.offsets.length/2;return t&&(s||a>y)&&(o=F({...e,spacing:[h,h]}),i={cols:o.size[0]+1,rows:o.size[1]+1},r=x(o.offsets,i,n)),o.error=r,o.coefficients=L(o.offsets,i,s),o}function F(e){const{projectedExtent:t,srcBufferExtent:n,pixelSize:o,datumTransformation:r,rasterTransform:a}=e,s=t.spatialReference,c=n.spatialReference;f(s,c);const{xmin:u,ymin:x,xmax:m,ymax:h}=t,y=N(c),d=e.hasWrapAround||"gcs-shift"===(null==a?void 0:a.type),g=e.spacing||[p,p],M={x:g[0]*o.x,y:g[1]*o.y},R={cols:Math.ceil((m-u)/M.x-.1/g[0])+1,rows:Math.ceil((h-x)/M.y-.1/g[1])+1},w=M.x,S=M.y,P=[];let j,v=0;const z=[];for(let i=0;i<R.cols;i++)for(let e=0;e<R.rows;e++)z.push(new l({x:u+w*i,y:h-S*e,spatialReference:s}));const W=b(z,c,r);for(let l=0;l<R.cols;l++){const e=[];for(let t=0;t<R.rows;t++){let o=W[l*R.rows+t];a&&(o=a.inverseTransform(o)),e.push(o),l>0&&d&&o&&j[t]&&i.isSome(y)&&o.x<j[t].x&&(o.x+=y),o?(P.push((o.x-n.xmin)/(n.xmax-n.xmin)),P.push((n.ymax-o.y)/(n.ymax-n.ymin))):(P.push(NaN),P.push(NaN),v++)}j=e}return{offsets:P,error:null,coefficients:null,outofBoundPointCount:v,spacing:g,size:[R.cols-1,R.rows-1]}}function L(e,t,n){const{cols:o,rows:i}=t,r=new Float32Array((o-1)*(i-1)*2*6),a=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),s=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let l=0;l<o-1;l++){for(let t=0;t<i-1;t++){let n=l*i*2+2*t;const c=e[n],u=e[n+1],f=e[n+2],x=e[n+3];n+=2*i;const m=e[n],p=e[n+1],h=e[n+2],y=e[n+3];let d=0,g=12*(t*(o-1)+l);for(let e=0;e<3;e++)r[g++]=a[d++]*c+a[d++]*f+a[d++]*h;d=0;for(let e=0;e<3;e++)r[g++]=a[d++]*u+a[d++]*x+a[d++]*y;d=0;for(let e=0;e<3;e++)r[g++]=s[d++]*c+s[d++]*m+s[d++]*h;d=0;for(let e=0;e<3;e++)r[g++]=s[d++]*u+s[d++]*p+s[d++]*y}if(n)for(let e=0;e<r.length;e++)isNaN(r[e])&&(r[e]=-1)}return r}function E(e){const t=e.clone().normalize();return 1===t.length?t[0]:P(t)}function I(e,t,n){const{storageInfo:o,pixelSize:r}=t;let a,s=!1;const{pyramidResolutions:c}=o;if(i.isSome(c)&&c.length){const o=(e.x+e.y)/2,i=c[c.length-1],u=(i.x+i.y)/2,f=(r.x+r.y)/2;if(o<=f)a=0;else if(o>=u)a=c.length,s=o/u>8;else{let e,t=f;for(let i=1;i<=c.length;i++){if(e=(c[i-1].x+c[i-1].y)/2,o<=e){o===e?a=i:"down"===n?(a=i-1,s=o/t>8):a="up"===n||o-t>e-o||o/t>2?i:i-1;break}t=e}}const x=0===a?r:c[a-1];return{pyramidLevel:a,pyramidResolution:new l({x:x.x,y:x.y,spatialReference:t.spatialReference}),excessiveReading:s}}const u=Math.log(e.x/r.x)/Math.LN2,f=Math.log(e.y/r.y)/Math.LN2,x=t.storageInfo.maximumPyramidLevel||0;a="down"===n?Math.floor(Math.min(u,f)):"up"===n?Math.ceil(Math.max(u,f)):Math.round((u+f)/2),a<0?a=0:a>x&&(s=a>x+3,a=x);const m=2**a;return{pyramidLevel:a,pyramidResolution:new l({x:m*t.nativePixelSize.x,y:m*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:s}}function k(e,t,n=512,o=!0){const{extent:i,spatialReference:a,pixelSize:s}=e,c=R(new l({x:s.x,y:s.y,spatialReference:a}),t,i);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const u=(c.x+c.y)/2,f=r.getMetersPerUnitForSR(t),x=u*f*96*39.37,m=t.isGeographic?256/n*295828763.7958547:256/n*591657527.591555;let p="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const h=j(i,t);p||o&&(t.isGeographic||t.isWebMercator)&&(p=h.xmin*h.xmax<0);let y,d=x;const g=1.001;if(p){d=m;const e=t.isGeographic?1341104507446289e-21:.29858214164761665,n=e*(96*f*39.37),o=t.isGeographic?4326:3857;y=R(new l({x:e,y:e,spatialReference:{wkid:o}}),a,h),y.x*=d/n,y.y*=d/n}else{y={x:s.x,y:s.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let n=0;for(;d<m*(g/2)&&n<t;)n++,d*=2,y.x*=2,y.y*=2;Math.max(d,m)/Math.min(d,m)<=g&&(d=m)}const M=[d],w=[{x:y.x,y:y.y}],S=70.5310735,b=Math.min(S,x)/g;for(;d>=b;)d/=2,y.x/=2,y.y/=2,M.push(d),w.push({x:y.x,y:y.y});return{projectedPixelSize:c,scales:M,srcResolutions:w,isCustomTilingScheme:!p}}e.computeProjectedScales=k,e.defaultGridSpacing=p,e.defaultProjectionToleranceInPixels=y,e.getDefaultDatumTransformationForDataset=M,e.getProjectionOffsetGrid=G,e.getRasterDatasetAlignmentInfo=C,e.getWorldWidth=N,e.getWorldWrapCount=T,e.load=d,e.minimumGridSpacing=h,e.projectExtent=j,e.projectPoint=S,e.projectResolution=R,e.requirePE=u,e.snapExtent=E,e.snapPyramid=I,Object.defineProperty(e,"__esModule",{value:!0})}));
