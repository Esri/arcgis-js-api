/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../../../geometry/Point","../../../geometry/Extent","../../../geometry","../../../core/unitUtils","../../../geometry/projection"],(function(e,t,n,o,i,r,a,s,l){"use strict";const c=5e-4,x=function(e,t){const n=(e.isWGS84||e.isWebMercator)&&(t.isWGS84||t.isWebMercator);return!(e.equals(t)||n)};function u(e,n,i,a=null){if(e.spatialReference.equals(n))return e;const s=x(e.spatialReference,n);if(s&&!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");const c=i.center,u=new r({xmin:c.x-e.x/2,xmax:c.x+e.x/2,ymin:c.y-e.y/2,ymax:c.y+e.y/2,spatialReference:e.spatialReference}),p=s?l.project(u,n,a):o.project(u,n);if(null==p)return null;return{x:p.xmax-p.xmin,y:p.ymax-p.ymin}}function p(e,t=.01){return s.getMetersPerUnitForSR(e)?t/s.getMetersPerUnitForSR(e):0}function f(e,i,r=null,a=!0){const s=e.spatialReference;if(s.equals(i))return e;const u=x(s,i);if(u&&!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");const f=u?l.project(e,i,r):o.project(e,i);if(f&&a&&i.isGeographic){var m,h;const[t,o]=s.isWebMercator?n.getInfo(s).origin:null!=(m=null==(h=n.getInfo(s))?void 0:h.valid)?m:[],i=p(s);i&&null!=t&&null!=o&&(Math.abs(e.x-t)<i&&Math.abs(180-f.x)<c?f.x-=360:Math.abs(e.x-o)<i&&Math.abs(180+f.x)<c&&(f.x+=360))}return f}function m(e,r,a=null,s=!0){var u,m,h,y;const d=e.spatialReference;if(d.equals(r))return e;const M=x(d,r);if(M&&!l.isLoaded())throw new t("rasterprojectionhelper-projectExtent","projection engine is not loaded");const w=M?l.project(e,r,a):o.project(e,r);let[g,R]=null!=(u=null==(m=n.getInfo(d))?void 0:m.origin)?u:[];if(w&&s&&d.isWebMercator&&r.isGeographic&&null!=g&&null!=R){const t=.001,n=1e3;if(Math.abs(e.xmin-g)<t&&Math.abs(R-e.xmax)>n&&Math.abs(180-w.xmax)<c){w.xmin=-180;const t=[];t.push(new i(e.xmax,e.ymin,d)),t.push(new i(e.xmax,(e.ymin+e.ymax)/2,d)),t.push(new i(e.xmax,e.ymax,d));const n=t.map((e=>f(e,r,a))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));w.xmax=Math.max.apply(null,n)}if(Math.abs(e.xmax-R)<t&&Math.abs(g-e.xmin)>n&&Math.abs(180+w.xmin)<c){w.xmax=180;const t=[];t.push(new i(e.xmin,e.ymin,d)),t.push(new i(e.xmin,(e.ymin+e.ymax)/2,d)),t.push(new i(e.xmin,e.ymax,d));const n=t.map((e=>f(e,r,a))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));w.xmin=Math.min.apply(null,n)}}[g,R]=r.isWebMercator?n.getInfo(r).origin:null!=(h=null==(y=n.getInfo(r))?void 0:y.valid)?h:[];const j=p(r);return j&&null!=g&&null!=R&&(Math.abs(w.xmin-g)<j&&(w.xmin=g),Math.abs(w.xmax-R)<j&&(w.xmax=R)),w}e.computeProjectedScales=function(e,t,n=512,o=!0){const{extent:r,spatialReference:a,pixelSize:l}=e,c=u(new i({x:l.x,y:l.y,spatialReference:a}),t,r);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null};const x=(c.x+c.y)/2,p=s.getMetersPerUnitForSR(t),f=x*p*96*39.37,h=t.isGeographic?512/n*295828763.7958547:512/n*591657527.591555;let y=!1;if(o&&(t.isGeographic||t.isWebMercator)){const e=m(r,t);y=e.xmin*e.xmax<0}let d,M=f;const w=1.001;if(y){M=h;const e=M/(96*p*39.37);d=u(new i({x:e,y:e,spatialReference:t}),a,r)}else{d={x:l.x,y:l.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let n=0;for(;M<.5005*h&&n<t;)n++,M*=2,d.x*=2,d.y*=2;Math.max(M,h)/Math.min(M,h)<=w&&(M=h)}const g=[],R=[],j=Math.min(70.5310735,f)/w;for(;M>=j;)g.push(M),R.push({x:d.x,y:d.y}),M/=2,d.x/=2,d.y/=2;return{projectedPixelSize:c,scales:g,srcResolutions:R}},e.defaultGridSpacing=32,e.getProjectionOffsetGrid=function(e,o,r,a=null,s=null,c=!1,u=[32,32]){var p,m;if(x(e.spatialReference,o.spatialReference)&&!l.isLoaded())throw new t("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(e&&o&&r))return null;const{xmin:h,ymin:y,xmax:d,ymax:M}=e,w=e.spatialReference,g=o.spatialReference,[R,j]=null!=(p=null==(m=n.getInfo(w))?void 0:m.valid)?p:[],b={x:u[0]*r.x,y:u[1]*r.y},v={cols:Math.ceil((d-h)/b.x-.1)+1,rows:Math.ceil((M-y)/b.y-.1)+1},S=b.x,P=b.y,N=[];let L,z=!1;for(let e=0;e<v.cols;e++){const t=[];for(let n=0;n<v.rows;n++){let r=f(new i({x:h+S*e,y:M-P*n,spatialReference:w}),g,a);s&&(r=s.inverseTransform(r)),t.push(r),e>0&&c&&r&&L[n]&&null!=R&&r.x<L[n].x&&(r.x+=j-R),r?(N.push((r.x-o.xmin)/(o.xmax-o.xmin)),N.push((o.ymax-r.y)/(o.ymax-o.ymin))):(N.push(NaN),N.push(NaN),z=!0)}L=t}const G=function(e,t){const n=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,o=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4;return[Math.abs(n-e[2*t.rows+2]),Math.abs(o-e[2*t.rows+3])]}(N,v),W=new Float32Array((v.cols-1)*(v.rows-1)*2*6),I=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),F=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let e=0;e<v.cols-1;e++){for(let t=0;t<v.rows-1;t++){let n=e*v.rows*2+2*t;const o=N[n],i=N[n+1],r=N[n+2],a=N[n+3];n+=2*v.rows;const s=N[n],l=N[n+1],c=N[n+2],x=N[n+3];let u=0,p=12*(t*(v.cols-1)+e);for(let e=0;e<3;e++)W[p++]=I[u++]*o+I[u++]*r+I[u++]*c;u=0;for(let e=0;e<3;e++)W[p++]=I[u++]*i+I[u++]*a+I[u++]*x;u=0;for(let e=0;e<3;e++)W[p++]=F[u++]*o+F[u++]*s+F[u++]*c;u=0;for(let e=0;e<3;e++)W[p++]=F[u++]*i+F[u++]*l+F[u++]*x}if(z)for(let e=0;e<W.length;e++)isNaN(W[e])&&(W[e]=-1)}return{offsets:N,error:G,coefficients:W,spacing:u,size:[v.cols-1,v.rows-1]}},e.load=async function(){if(l.isLoaded()||!l.isSupported())return null;await l.load()},e.projectExtent=m,e.projectPoint=f,e.projectResolution=u,e.snapPyramid=function(e,t,n){const o=Math.log(e.x/t.pixelSize.x)/Math.LN2,r=Math.log(e.y/t.pixelSize.y)/Math.LN2,a=t.storageInfo.maximumPyramidLevel||0;let s="down"===n?Math.floor(Math.min(o,r)):"up"===n?Math.ceil(Math.max(o,r)):Math.round((o+r)/2),l=!1;s<0?s=0:s>a&&(l=s>a+3,s=a);const c=Math.pow(2,s);return{pyramidLevel:s,pyramidResolution:new i({x:c*t.nativePixelSize.x,y:c*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:l}},Object.defineProperty(e,"__esModule",{value:!0})}));
