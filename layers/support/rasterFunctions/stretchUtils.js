/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../PixelBlock","../rasterFormats/pixelRangeUtils","../../../renderers/support/stretchRendererUtils"],(function(t,e,n,s,i){"use strict";const a=1,o=[.299,.587,.114];function r(t,e=256){e=Math.min(e,256);const{size:n,counts:s}=t,i=new Uint8Array(n),a=s.reduce(((t,n)=>t+n/e),0);let o=0,r=0,l=0,u=a;for(let f=0;f<n;f++)if(l+=s[f],!(f<n-1&&l+s[f+1]<u)){for(;o<e-1&&u<l;)o++,u+=a;for(let t=r;t<=f;t++)i[t]=o;r=f+1}for(let f=r;f<n;f++)i[f]=e-1;return i}function l(t){const{minCutOff:e,maxCutOff:n,gamma:s,pixelType:i,rounding:a}=t,o=t.outMin||0,r=t.outMax||255;if(!["u8","u16","s8","s16"].includes(i))return null;const l=e.length;let f,c,m=0;"s8"===i?m=-127:"s16"===i&&(m=-32767);let h=256;["u16","s16"].includes(i)&&(h=65536);const g=[],p=[],d=r-o;for(f=0;f<l;f++)p[f]=n[f]-e[f],g[f]=0===p[f]?0:d/p[f];let M;const y=[];let C,S,b;if(s&&s.length>=l){const t=x(l,s);for(f=0;f<l;f++){for(b=[],c=0;c<h;c++)if(0!==p[f])if(C=c+m,M=(C-e[f])/p[f],S=1,s[f]>1&&(S-=(1/d)**(M*t[f])),C<n[f]&&C>e[f]){const t=S*d*M**(1/s[f])+o;b[c]="floor"===a?Math.floor(t):"round"===a?Math.round(t):t}else C>=n[f]?b[c]=r:b[c]=o;else b[c]=o;y[f]=b}}else for(f=0;f<l;f++){for(b=[],c=0;c<h;c++)if(C=c+m,C<=e[f])b[c]=o;else if(C>=n[f])b[c]=r;else{const t=(C-e[f])*g[f]+o;b[c]="floor"===a?Math.floor(t):"round"===a?Math.round(t):t}y[f]=b}if(null!=t.contrastOffset){const e=u(t.contrastOffset,t.brightnessOffset);for(f=0;f<l;f++)for(b=y[f],c=0;c<h;c++)b[c]=e[b[c]]}return{lut:y,offset:m}}function u(t,e){const n=Math.min(Math.max(t,-100),100),s=Math.min(Math.max(e??0,-100),100),i=255,a=128;let o=0,r=0;const l=new Uint8Array(256);for(o=0;o<256;o++)n>0&&n<100?r=(200*o-100*i+2*i*s)/(2*(100-n))+a:n<=0&&n>-100?r=(200*o-100*i+2*i*s)*(100+n)/2e4+a:100===n?(r=200*o-100*i+(i+1)*(100-n)+2*i*s,r=r>0?i:0):-100===n&&(r=a),l[o]=r>i?i:r<0?0:r;return l}function f(t,e,n){const s=[];for(let i=0;i<e.length;i++){let a=0,r=0,l=0;"min"in e[i]?({min:a,max:r,avg:l}=e[i]):[a,r,l]=e[i];let u=l??0;"u8"!==t&&(u=255*(u-a)/(r-a)),n&&(u*=o[i]),s.push(c(u))}return s}function c(t){if(t<=0||t>=255)return a;let e=0;150!==t&&(e=t<=150?45*Math.cos(.01047*t):17*Math.sin(.021*t));const n=255,s=t+e,i=Math.log(t/n),o=Math.log(s/n);if(0===o)return a;const r=i/o;return isNaN(r)?a:Math.min(9.9,Math.max(.01,r))}function m(t){if(e.isNone(t)||!t.pixels?.length)return null;const{pixels:n,mask:s,pixelType:i}=t,a=t.width*t.height,o=n.length;let r,l,u,f,c;const m=[],h=[];let g,p,x,d,M,y,C,S,b,O;const v=256;for(f=0;f<o;f++){if(g=new Uint32Array(v),x=n[f],"u8"===i)if(r=-.5,l=255.5,s)for(c=0;c<a;c++)s[c]&&g[x[c]]++;else for(c=0;c<a;c++)g[x[c]]++;else{let e=!1;t.statistics||(t.updateStatistics(),e=!0);const n=t.statistics;if(r=n[f].minValue,l=n[f].maxValue,u=(l-r)/v,0===u){!n||t.validPixelCount||e||t.updateStatistics();const s=(t.validPixelCount||t.width*t.height)/v;for(let t=0;t<v;t++)g[t]=Math.round(s*(t+1))-Math.round(s*t)}else{for(p=new Uint32Array(v+1),c=0;c<a;c++)s&&!s[c]||p[Math.floor((x[c]-r)/u)]++;for(c=0;c<v-1;c++)g[c]=p[c];g[v-1]=p[v-1]+p[v]}}for(m.push({min:r,max:l,size:v,counts:g}),d=0,M=0,S=0,c=0;c<v;c++)d+=g[c],M+=c*g[c];for(b=M/d,c=0;c<v;c++)S+=g[c]*(c-b)**2;O=Math.sqrt(S/(d-1)),u=(l-r)/v,y=(b+.5)*u+r,C=O*u,h.push({min:r,max:l,avg:y,stddev:C})}return{statistics:h,histograms:m}}function h(t){const e=[];for(let n=0;n<t.length;n++){const{min:s,max:i,size:a,counts:o}=t[n];let r=0,l=0;for(let t=0;t<a;t++)r+=o[t],l+=t*o[t];const u=l/r;let f=0;for(let t=0;t<a;t++)f+=o[t]*(t-u)**2;const c=(i-s)/a,m=(u+.5)*c+s,h=Math.sqrt(f/(r-1))*c;e.push({min:s,max:i,avg:m,stddev:h})}return e}function g(t,n){const{pixelBlock:a,bandIds:o,returnHistogramLut:l,rasterInfo:u}=n;let f=null,c=null,h=t.stretchType;if("number"==typeof h&&(h=i.stretchTypeFunctionEnum[h]),t.dra)if("minMax"===h&&e.isSome(a)&&a.statistics)f=a.statistics.map((t=>[t.minValue,t.maxValue,0,0]));else{const t=m(a);f=e.isSome(t)?t.statistics:null,c=e.isSome(t)?t.histograms:null}else f=t.statistics?.length>0?t.statistics:e.unwrap(u.statistics),c=t.histograms||e.unwrap(u.histograms);"percentClip"!==h&&"histogramEqualization"!==h||c?.length||(h="minMax");const g=f?.length||c?.length||u.bandCount,x=[],d=[];let M,y,C,S,b,O,v,w,z;f&&!Array.isArray(f[0])&&(f=f.map((t=>[t.min,t.max,t.avg,t.stddev])));const[k,T]=s.getPixelValueRange(u.pixelType);if(!f?.length){for(f=[],w=0;w<g;w++)f.push([k,T,1,1]);"standardDeviation"===h&&(h="minMax")}switch(h){case"none":for(w=0;w<g;w++)x[w]=k,d[w]=T;break;case"minMax":for(w=0;w<g;w++)x[w]=f[w][0],d[w]=f[w][1];break;case"standardDeviation":for(w=0;w<g;w++)x[w]=f[w][2]-t.numberOfStandardDeviations*f[w][3],d[w]=f[w][2]+t.numberOfStandardDeviations*f[w][3],x[w]<f[w][0]&&(x[w]=f[w][0]),d[w]>f[w][1]&&(d[w]=f[w][1]);break;case"histogramEqualization":for(e.assertIsSome(c),w=0;w<g;w++)x[w]=c[w].min,d[w]=c[w].max;break;case"percentClip":for(e.assertIsSome(c),w=0;w<c.length;w++){for(M=c[w],b=new Uint32Array(M.size),S=[...M.counts],S.length>=20&&(S[0]=S[1]=S[2]=S[S.length-1]=S[S.length-2]=0),C=0,y=(M.max-M.min)/M.size,v=-.5===M.min&&1===y?.5:0,z=0;z<M.size;z++)C+=S[z],b[z]=C;for(O=(t.minPercent||0)*C/100,x[w]=M.min+v,z=0;z<M.size;z++)if(b[z]>O){x[w]=M.min+y*(z+v);break}for(O=(1-(t.maxPercent||0)/100)*C,d[w]=M.max+v,z=M.size-2;z>=0;z--)if(b[z]<O){d[w]=M.min+y*(z+2-v);break}if(d[w]<x[w]){const t=x[w];x[w]=d[w],d[w]=t}}break;default:for(w=0;w<g;w++)x[w]=f[w][0],d[w]=f[w][1]}let U,A,P;"histogramEqualization"===h?(e.assertIsSome(c),A=c[0].size||256,U=0,l&&(P=c.map((t=>r(t))))):(A=t.max||255,U=t.min||0);return p({minCutOff:x,maxCutOff:d,outMax:A,outMin:U,histogramLut:P},o)}function p(t,e){if(null==e||0===e.length)return t;const n=Math.max.apply(null,e),{minCutOff:s,maxCutOff:i,outMin:a,outMax:o,histogramLut:r}=t;return s.length===e.length||s.length<=n?t:{minCutOff:e.map((t=>s[t])),maxCutOff:e.map((t=>i[t])),histogramLut:r?e.map((t=>r[t])):null,outMin:a,outMax:o}}function x(t,e){const n=new Float32Array(t);for(let s=0;s<t;s++)e[s]>1?e[s]>2?n[s]=6.5+(e[s]-2)**2.5:n[s]=6.5+100*(2-e[s])**4:n[s]=1;return n}function d(t,s){if(e.isNone(t)||!t.pixels?.length)return t;const{mask:i,width:a,height:o,pixels:r}=t,{minCutOff:l,maxCutOff:u,gamma:f}=s,c=s.outMin||0,m=s.outMax||255,h=a*o,g=s.outputPixelType||"u8",p=t.pixels.map((()=>n.createEmptyBand(g,h))),d=p.length;let M,y,C,S,b;const O=m-c,v=[],w=[];for(M=0;M<d;M++)w[M]=u[M]-l[M],v[M]=0===w[M]?0:O/w[M];const z=g.startsWith("u")||g.startsWith("s"),k=f&&f.length>=d,T=!!s.isRenderer;if(k){const t=x(d,f);for(y=0;y<h;y++)if(null==i||i[y])for(M=0;M<d;M++)if(0!==w[M])if(C=r[M][y],b=(C-l[M])/w[M],S=1,f[M]>1&&(S-=(1/O)**(b*t[M])),C<u[M]&&C>l[M]){const t=S*O*b**(1/f[M])+c;p[M][y]=T?Math.floor(t):z?Math.round(t):t}else C>=u[M]?p[M][y]=m:p[M][y]=c;else p[M][y]=c}else for(y=0;y<h;y++)if(null==i||i[y])for(M=0;M<d;M++)if(C=r[M][y],C<u[M]&&C>l[M]){const t=(C-l[M])*v[M]+c;p[M][y]=T?Math.floor(t):z?Math.round(t):t}else C>=u[M]?p[M][y]=m:p[M][y]=c;const U=new n({width:a,height:o,mask:i,pixels:p,pixelType:g});return U.updateStatistics(),U}t.computeGammaCorrection=x,t.computeGammaValues=f,t.createContrastBrightnessLUT=u,t.createHistogramEqualizationLUT=r,t.createStretchLUT=l,t.estimateStatisticsFromHistograms=h,t.estimateStatisticsHistograms=m,t.getStretchCutoff=g,t.stretch=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
