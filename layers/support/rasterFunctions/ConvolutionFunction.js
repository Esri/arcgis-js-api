/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../rasterFunctionConstants","../rasterFormats/pixelRangeUtils","./BaseRasterFunction","./ConvolutionFunctionArguments","./convolutionUtils"],(function(e,t,n,o,r,s,u,i,c,l,p,a){"use strict";const h=25;let y=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).functionName="Convolution",e.rasterArgumentNames=["raster"],e}e._inheritsLoose(o,t);var r=o.prototype;return r._bindSourceRasters=function(){const{convolutionType:e,rows:t,cols:n,kernel:o}=this.functionArguments;if(!Object.values(i.convolutionKernel).includes(e))return{success:!1,supportsGPU:!1,error:`convolution-function: the specified kernel type is not supported ${e}`};if(e!==i.convolutionKernel.none&&t*n!==o.length)return{success:!1,supportsGPU:!1,error:"convolution-function: the specified rows and cols do not match the length of the kernel"};const r=this.sourceRasterInfos[0];this.outputPixelType=this._getOutputPixelType(r.pixelType);const s=r.clone();s.pixelType=this.outputPixelType;const u=[i.convolutionKernel.none,i.convolutionKernel.sharpen,i.convolutionKernel.sharpen2,i.convolutionKernel.sharpening3x3,i.convolutionKernel.sharpening5x5];"u8"===this.outputPixelType||u.includes(e)||(s.statistics=null,s.histograms=null),s.colormap=null,s.attributeTable=null,this.rasterInfo=s;return{success:!0,supportsGPU:o.length<=h}},r._processPixels=function(e){const t=e.pixelBlocks?.[0];if(n.isNone(t)||this.functionArguments.convolutionType===i.convolutionKernel.none)return t;let{kernel:o,rows:r,cols:s}=this.functionArguments;const u=o.reduce(((e,t)=>e+t));return 0!==u&&1!==u&&(o=o.map((e=>e/u))),a.convolute(t,{kernel:o,rows:r,cols:s,outputPixelType:this.outputPixelType})},r._getWebGLParameters=function(){let{kernel:e}=this.functionArguments;const t=e.reduce(((e,t)=>e+t));0!==t&&1!==t&&(e=e.map((e=>e/t)));const n=new Float32Array(h);return n.set(e),{kernelRows:this.functionArguments.rows,kernelCols:this.functionArguments.cols,kernel:n,clampRange:c.getPixelValueRange(this.outputPixelType)}},o}(l);t.__decorate([o.property({json:{write:!0,name:"rasterFunction"}})],y.prototype,"functionName",void 0),t.__decorate([o.property({type:p,json:{write:!0,name:"rasterFunctionArguments"}})],y.prototype,"functionArguments",void 0),t.__decorate([o.property()],y.prototype,"rasterArgumentNames",void 0),y=t.__decorate([u.subclass("esri.layers.support.rasterFunctions.ConvolutionFunction")],y);return y}));
