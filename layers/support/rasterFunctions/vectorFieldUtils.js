/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../core/jsonMap","../../../core/maybe","../PixelBlock","./pixelUtils"],(function(t,e,n,r,o){"use strict";const i=new Map;i.set("meter-per-second",1),i.set("kilometer-per-hour",.277778),i.set("knots",.514444),i.set("feet-per-second",.3048),i.set("mile-per-hour",.44704);const a=180/Math.PI,s=5,l=new e.JSONMap({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function c(t,e){return i.get(t)/i.get(e)||1}function h(t){return(450-t)%360}function u(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let i=Math.atan2(r,n)*a;return i=(360+i)%360,"geographic"===e&&(i=h(i)),[o,i]}function f(t,e="geographic"){let n=t[1];"geographic"===e&&(n=h(n)),n%=360;const r=t[0];return[r*Math.cos(n/a),r*Math.sin(n/a)]}function p(t,e,r,i="geographic"){if(!o.isValidPixelBlock(t)||n.isNone(r))return t;const a="vector-magdir"===e?t.clone():n.unwrap(m(t,e)),s=a.pixels[1];for(let n=0;n<s.length;n++)s[n]="geographic"===i?(s[n]+r[n]+270)%360:(s[n]+360-r[n])%360;return"vector-magdir"===e?a:m(a,"vector-magdir")}function m(t,e,n="geographic",i=1){if(!o.isValidPixelBlock(t))return t;const{pixels:a,width:s,height:l}=t,c=s*l,h=a[0],p=a[1],m=t.pixelType.startsWith("f")?t.pixelType:"f32",d=r.createEmptyBand(m,c),g=r.createEmptyBand(m,c);let M=0;for(let r=0;r<l;r++)for(let t=0;t<s;t++)"vector-uv"===e?([d[M],g[M]]=u([h[M],p[M]],n),d[M]*=i):([d[M],g[M]]=f([h[M],p[M]],n),d[M]*=i,g[M]*=i),M++;const x=new r({pixelType:m,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[d,g]});return x.updateStatistics(),x}function d(t,e,n=1){if(1===n||!o.isValidPixelBlock(t))return t;const r=t.clone(),{pixels:i,width:a,height:s}=r,l=i[0],c=i[1];let h=0;for(let o=0;o<s;o++)for(let t=0;t<a;t++)"vector-uv"===e?(l[h]*=n,c[h]*=n):l[h]*=n,h++;return r.updateStatistics(),r}function g(t,e,r,o,i){if(n.isNone(i)||!i.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/o),height:Math.round(r/o),resolution:t.width/e};const a=i.xmin,s=i.ymax,l=(t.xmax-t.xmin)/e*o,c=(t.ymax-t.ymin)/r*o,h=(l+c)/2;return t.xmin=a+Math.floor((t.xmin-a)/l)*l,t.xmax=a+Math.ceil((t.xmax-a)/l)*l,t.ymin=s+Math.floor((t.ymin-s)/c)*c,t.ymax=s+Math.ceil((t.ymax-s)/c)*c,{extent:t,width:Math.round(t.width/l),height:Math.round(t.height/c),resolution:h}}const M=x(0,0,0);function x(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,i=13*o,a=-7*o,s=-2*o,l=-16*o,c=21.75,[h,u]=w(0,e+i,n,c),[f,p]=w(t-5.5,e+a,n,c),[m,d]=w(t+5.5,e+a,n,c),[g,M]=w(t-1.5,e+s,n,c),[x,k]=w(t+1.5,e+s,n,c),[y,b]=w(t-1.5,e+l,n,c),[P,v]=w(t+1.5,e+l,n,c);return[h,u,f,p,g,M,x,k,m,d,y,b,P,v]}function k(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=10,o=n?-1:1,i=5*o,a=20*o,l=25*o,c=45,h=0,u=0,f=2,p=0,m=f*o,d=n?1:-1,g=r/2*d;let[M,x]=[h+g,u-a],[k,y]=[M+f*d,x],[b,P]=[k-p*d,y+m],[v,I]=[h-g,u-l],[S,_]=[v+p*d,I-m],A=Math.ceil(t/s),F=Math.floor(A/10);A-=8*F;const U=[],D=[];for(let s=0;s<A/2;s++,F--){F<=0&&A%2==1&&s===(A-1)/2&&(v=h,S=v+p*d,I=(I+x)/2,_=I-m);const[t,n]=w(v,I,e,c);if(F>0){const[r,o]=w(k,I,e,c),[i,a]=w(M,x,e,c);U.push(r),U.push(o),U.push(t),U.push(n),U.push(i),U.push(a)}else{const[r,o]=w(k,y,e,c),[i,a]=w(b,P,e,c),[s,l]=w(S,_,e,c);D.push(t),D.push(n),D.push(s),D.push(l),D.push(i),D.push(a),D.push(r),D.push(o)}I+=i,x+=i,y+=i,P+=i,_+=i}const[V,N]=w(h+g,u+a,e,c),T=(r/2+f)*d,[B,O]=w(h+T,u+a,e,c),[J,C]=w(h+g,u-l,e,c),[q,E]=w(h+T,u-l,e,c);return{pennants:U,barbs:D,shaft:[V,N,B,O,J,C,q,E]}}function w(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,i=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+i-n)%(2*Math.PI)]}const y=[0,1,3,6,10,16,21,27,33,40,47,55,63],b=[0,.5,1,1.5,2],P=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function v(t,e,n,r){const o=c(r||"knots",n);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(t<e[i]*o)break}else if(t<=e[i]*o)break;return Math.min(i-1,e.length-2)}function I(t,e,n,r,o){let i=0;switch(e){case"beaufort_kn":i=v(t,y,"knots",n);break;case"beaufort_km":i=v(t,y,"kilometer-per-hour",n);break;case"beaufort_ft":i=v(t,y,"feet-per-second",n);break;case"beaufort_m":i=v(t,y,"meter-per-second",n);break;case"classified_arrow":i=v(t,o??[],r,n);break;case"ocean_current_m":i=v(t,b,"meter-per-second",n);break;case"ocean_current_kn":i=v(t,P,"knots",n)}return i}function S(t,e){const{style:r,inputUnit:o,outputUnit:i,breakValues:a}=e,s=l.fromJSON(o),c=l.fromJSON(i),h=7*6,u=15;let f=0,p=0;const{width:m,height:d,mask:g}=t,k=t.pixels[0],w=t.pixels[1],y=n.isSome(g)?g.filter((t=>t>0)).length:m*d,b=new Float32Array(y*h),P=new Uint32Array(u*y),v=e.invertDirection?x(0,0,0,!1):M;for(let n=0;n<d;n++)for(let t=0;t<m;t++){const e=n*m+t;if(!g||g[n*m+t]){const o=(w[e]+360)%360/180*Math.PI,i=I(k[e],r,s,c,a);for(let r=0;r<v.length;r+=2)b[f++]=(t+.5)/m,b[f++]=(n+.5)/d,b[f++]=v[r],b[f++]=v[r+1]+o,b[f++]=i,b[f++]=k[e];const l=7*(f/h-1);P[p++]=l,P[p++]=l+1,P[p++]=l+2,P[p++]=l+0,P[p++]=l+4,P[p++]=l+3,P[p++]=l+0,P[p++]=l+2,P[p++]=l+3,P[p++]=l+2,P[p++]=l+5,P[p++]=l+3,P[p++]=l+5,P[p++]=l+6,P[p++]=l+3}}return{vertexData:b,indexData:P}}const _=[];function A(t,e){if(0===_.length)for(let s=0;s<30;s++)_.push(k(5*s,0,!e.invertDirection));const n=c(l.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:i}=t,a=t.pixels[0],h=t.pixels[1],u=6,f=[],p=[];let m=0,d=0;for(let l=0;l<o;l++)for(let t=0;t<r;t++){const e=l*r+t,c=a[e]*n;if((!i||i[l*r+t])&&c>=s){const n=(h[e]+360)%360/180*Math.PI,{pennants:i,barbs:a,shaft:s}=_[Math.min(Math.floor(c/5),29)];if(i.length+a.length===0)continue;let g=f.length/u;const M=(t+.5)/r,x=(l+.5)/o;for(let t=0;t<i.length;t+=2)f[m++]=M,f[m++]=x,f[m++]=i[t],f[m++]=i[t+1]+n,f[m++]=0,f[m++]=c;for(let t=0;t<a.length;t+=2)f[m++]=M,f[m++]=x,f[m++]=a[t],f[m++]=a[t+1]+n,f[m++]=0,f[m++]=c;for(let t=0;t<s.length;t+=2)f[m++]=M,f[m++]=x,f[m++]=s[t],f[m++]=s[t+1]+n,f[m++]=0,f[m++]=c;for(let t=0;t<i.length/6;t++)p[d++]=g,p[d++]=g+1,p[d++]=g+2,g+=3;for(let t=0;t<a.length/8;t++)p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+2,p[d++]=g+3,g+=4;p[d++]=g+0,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2,g+=4}}return{vertexData:new Float32Array(f),indexData:new Uint32Array(p)}}function F(t,e){const n=4*6;let r=0,o=0;const{width:i,height:a,mask:h}=t,u=t.pixels[0],f=[],p=[],m=c(l.fromJSON(e.inputUnit),"knots"),d="wind_speed"===e.style?s:Number.MAX_VALUE;for(let s=0;s<a;s++)for(let t=0;t<i;t++){const e=u[s*i+t]*m;if((!h||h[s*i+t])&&e<d){for(let n=0;n<4;n++)f[r++]=(t+.5)/i,f[r++]=(s+.5)/a,f[r++]=n<2?-.5:.5,f[r++]=n%2==0?-.5:.5,f[r++]=0,f[r++]=e;const l=4*(r/n-1);p[o++]=l,p[o++]=l+1,p[o++]=l+2,p[o++]=l+1,p[o++]=l+2,p[o++]=l+3}}return{vertexData:new Float32Array(f),indexData:new Uint32Array(p)}}function U(t,e){return"simple_scalar"===e.style?F(t,e):"wind_speed"===e.style?A(t,e):S(t,e)}function D(t,e,n,o=[0,0],i=.5){const{width:a,height:s,mask:l}=t,[c,h]=t.pixels,[p,m]=o,d=Math.round((a-p)/n),g=Math.round((s-m)/n),M=d*g,x=new Float32Array(M),k=new Float32Array(M),w=new Uint8Array(M),y="vector-uv"===e;for(let r=0;r<g;r++)for(let t=0;t<d;t++){let e=0;const o=r*d+t,g=Math.max(0,r*n+m),M=Math.max(0,t*n+p),b=Math.min(s,g+n),P=Math.min(a,M+n);for(let t=g;t<b;t++)for(let n=M;n<P;n++){const r=t*a+n;if(!l||l[r]){e++;const t=y?[c[r],h[r]]:[c[r],(360+h[r])%360],[n,i]=y?t:f(t);x[o]+=n,k[o]+=i}}if(e>=(b-g)*(P-M)*(1-i)){w[o]=1;const[t,n]=u([x[o]/e,k[o]/e]);x[o]=t,k[o]=n}else w[o]=0,x[o]=0,k[o]=0}const b=new r({width:d,height:g,pixels:[x,k],mask:w});return b.updateStatistics(),b}t.convertToLocalDirections=p,t.convertVectorFieldData=m,t.convertVectorFieldUnit=d,t.createVFMesh=U,t.createVFMeshScalar=F,t.getUnitConversionFactor=c,t.sampleVectorField=D,t.snapImageToSymbolTile=g,t.unitKebabDict=l,t.uvComponentToVector=u,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
