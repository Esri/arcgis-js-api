/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../core/jsonMap","../../../core/maybe","../PixelBlock","./pixelUtils"],(function(t,e,n,r,o){"use strict";const a=new Map;a.set("meter-per-second",1),a.set("kilometer-per-hour",.277778),a.set("knots",.514444),a.set("feet-per-second",.3048),a.set("mile-per-hour",.44704);const i=180/Math.PI,s=5,l=new e.JSONMap({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function c(t,e){return a.get(t)/a.get(e)||1}function h(t){return(450-t)%360}function u(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let a=Math.atan2(r,n)*i;return a=(360+a)%360,"geographic"===e&&(a=h(a)),[o,a]}function f(t,e="geographic"){let n=t[1];"geographic"===e&&(n=h(n)),n%=360;const r=t[0];return[r*Math.cos(n/i),r*Math.sin(n/i)]}function p(t,e,r,a="geographic"){if(!o.isValidPixelBlock(t)||n.isNone(r))return t;const i="vector-magdir"===e?t.clone():n.unwrap(m(t,e)),s=i.pixels[1];for(let n=0;n<s.length;n++)s[n]="geographic"===a?(s[n]+r[n]+270)%360:(s[n]+360-r[n])%360;return"vector-magdir"===e?i:m(i,"vector-magdir")}function m(t,e,n="geographic",a=1){if(!o.isValidPixelBlock(t))return t;const{pixels:i,width:s,height:l}=t,c=s*l,h=i[0],p=i[1],m=t.pixelType.startsWith("f")?t.pixelType:"f32",d=r.createEmptyBand(m,c),M=r.createEmptyBand(m,c);let g=0;for(let r=0;r<l;r++)for(let t=0;t<s;t++)"vector-uv"===e?([d[g],M[g]]=u([h[g],p[g]],n),d[g]*=a):([d[g],M[g]]=f([h[g],p[g]],n),d[g]*=a,M[g]*=a),g++;const x=new r({pixelType:m,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[d,M]});return x.updateStatistics(),x}function d(t,e,n=1){if(1===n||!o.isValidPixelBlock(t))return t;const r=t.clone(),{pixels:a,width:i,height:s}=r,l=a[0],c=a[1];let h=0;for(let o=0;o<s;o++)for(let t=0;t<i;t++)"vector-uv"===e?(l[h]*=n,c[h]*=n):l[h]*=n,h++;return r.updateStatistics(),r}function M(t,e,r,o,a){if(!n.isSome(a)||!a.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/o),height:Math.round(r/o),resolution:t.width/e};const i=a.xmin,s=a.ymax,l=(t.xmax-t.xmin)/e*o,c=(t.ymax-t.ymin)/r*o,h=(l+c)/2;return t.xmin=i+Math.floor((t.xmin-i)/l)*l,t.xmax=i+Math.ceil((t.xmax-i)/l)*l,t.ymin=s+Math.floor((t.ymin-s)/c)*c,t.ymax=s+Math.ceil((t.ymax-s)/c)*c,{extent:t,width:Math.round(t.width/l),height:Math.round(t.height/c),resolution:h}}const g=x(0,0,0);function x(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,a=13*o,i=-7*o,s=-2*o,l=-16*o,c=21.75,[h,u]=w(0,e+a,n,c),[f,p]=w(t-5.5,e+i,n,c),[m,d]=w(t+5.5,e+i,n,c),[M,g]=w(t-1.5,e+s,n,c),[x,k]=w(t+1.5,e+s,n,c),[y,P]=w(t-1.5,e+l,n,c),[b,v]=w(t+1.5,e+l,n,c);return[h,u,f,p,M,g,x,k,m,d,y,P,b,v]}function k(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=10,o=n?-1:1,a=5*o,i=20*o,l=25*o,c=45,h=0,u=0,f=2,p=0,m=f*o;let[d,M]=[h+r/2,u-i],[g,x]=[d+f,M],[k,y]=[g-p,x+m],[P,b]=[h-r/2,u-l],[v,I]=[P+p,b-m],S=Math.ceil(t/s),_=Math.floor(S/10);S-=8*_;const A=[],F=[];for(let s=0;s<S/2;s++,_--){_<=0&&S%2==1&&s===(S-1)/2&&(P=h,v=P+p,b=(b+M)/2,I=b-m);const[t,n]=w(P,b,e,c);if(_>0){const[r,o]=w(g,b,e,c),[a,i]=w(d,M,e,c);A.push(r),A.push(o),A.push(t),A.push(n),A.push(a),A.push(i)}else{const[r,o]=w(g,x,e,c),[a,i]=w(k,y,e,c),[s,l]=w(v,I,e,c);F.push(t),F.push(n),F.push(s),F.push(l),F.push(a),F.push(i),F.push(r),F.push(o)}b+=a,M+=a,x+=a,y+=a,I+=a}const[U,V]=w(h+r/2,u+i,e,c),D=r/2+f,[T,N]=w(h+D,u+i,e,c),[B,O]=w(h+r/2,u-l,e,c),[J,C]=w(h+D,u-l,e,c);return{pennants:A,barbs:F,shaft:[U,V,T,N,B,O,J,C]}}function w(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,a=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+a-n)%(2*Math.PI)]}const y=[0,1,3,6,10,16,21,27,33,40,47,55,63],P=[0,.5,1,1.5,2],b=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function v(t,e,n,r){const o=c(r||"knots",n);let a;for(a=1;a<e.length;a++)if(a===e.length-1){if(t<e[a]*o)break}else if(t<=e[a]*o)break;return Math.min(a-1,e.length-2)}function I(t,e,n,r,o){let a=0;switch(e){case"beaufort_kn":a=v(t,y,"knots",n);break;case"beaufort_km":a=v(t,y,"kilometer-per-hour",n);break;case"beaufort_ft":a=v(t,y,"feet-per-second",n);break;case"beaufort_m":a=v(t,y,"meter-per-second",n);break;case"classified_arrow":a=v(t,o,r,n);break;case"ocean_current_m":a=v(t,P,"meter-per-second",n);break;case"ocean_current_kn":a=v(t,b,"knots",n)}return a}function S(t,e){const{style:n,inputUnit:r,outputUnit:o,breakValues:a}=e,i=l.fromJSON(r),s=l.fromJSON(o),c=7*6,h=15;let u=0,f=0;const{width:p,height:m,mask:d}=t,M=t.pixels[0],x=t.pixels[1],k=d?d.filter((t=>t>0)).length:p*m,w=new Float32Array(k*c),y=new Uint32Array(h*k);for(let l=0;l<m;l++)for(let t=0;t<p;t++){const e=l*p+t;if(!d||d[l*p+t]){var P;const r=null!=(P=(x[e]+360)%360/180*Math.PI)?P:2*Math.PI*Math.random(),o=I(M[e],n,i,s,a);for(let n=0;n<g.length;n+=2)w[u++]=(t+.5)/p,w[u++]=(l+.5)/m,w[u++]=g[n],w[u++]=g[n+1]+r,w[u++]=o,w[u++]=M[e];const h=7*(u/c-1);y[f++]=h,y[f++]=h+1,y[f++]=h+2,y[f++]=h+0,y[f++]=h+4,y[f++]=h+3,y[f++]=h+0,y[f++]=h+2,y[f++]=h+3,y[f++]=h+2,y[f++]=h+5,y[f++]=h+3,y[f++]=h+5,y[f++]=h+6,y[f++]=h+3}}return{vertexData:w,indexData:y}}const _=[];function A(t,e){if(0===_.length)for(let s=0;s<30;s++)_.push(k(5*s,0));const n=c(l.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:a}=t,i=t.pixels[0],h=t.pixels[1],u=6,f=[],p=[];let m=0,d=0;for(let l=0;l<o;l++)for(let t=0;t<r;t++){const e=l*r+t,c=i[e]*n;if((!a||a[l*r+t])&&c>=s){var M;const n=null!=(M=(h[e]+360)%360/180*Math.PI)?M:2*Math.PI*Math.random(),{pennants:a,barbs:i,shaft:s}=_[Math.min(Math.floor(c/5),29)];if(a.length+i.length===0)continue;let g=f.length/u;const x=(t+.5)/r,k=(l+.5)/o;for(let t=0;t<a.length;t+=2)f[m++]=x,f[m++]=k,f[m++]=a[t],f[m++]=a[t+1]+n,f[m++]=0,f[m++]=c;for(let t=0;t<i.length;t+=2)f[m++]=x,f[m++]=k,f[m++]=i[t],f[m++]=i[t+1]+n,f[m++]=0,f[m++]=c;for(let t=0;t<s.length;t+=2)f[m++]=x,f[m++]=k,f[m++]=s[t],f[m++]=s[t+1]+n,f[m++]=0,f[m++]=c;for(let t=0;t<a.length/6;t++)p[d++]=g,p[d++]=g+1,p[d++]=g+2,g+=3;for(let t=0;t<i.length/8;t++)p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+2,p[d++]=g+3,g+=4;p[d++]=g+0,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2,g+=4}}return{vertexData:new Float32Array(f),indexData:new Uint32Array(p)}}function F(t,e){const n=4*6;let r=0,o=0;const{width:a,height:i,mask:h}=t,u=t.pixels[0],f=[],p=[],m=c(l.fromJSON(e.inputUnit),"knots"),d="wind_speed"===e.style?s:Number.MAX_VALUE;for(let s=0;s<i;s++)for(let t=0;t<a;t++){const e=u[s*a+t]*m;if((!h||h[s*a+t])&&e<d){for(let n=0;n<4;n++)f[r++]=(t+.5)/a,f[r++]=(s+.5)/i,f[r++]=n<2?-.5:.5,f[r++]=n%2==0?-.5:.5,f[r++]=0,f[r++]=e;const l=4*(r/n-1);p[o++]=l,p[o++]=l+1,p[o++]=l+2,p[o++]=l+1,p[o++]=l+2,p[o++]=l+3}}return{vertexData:new Float32Array(f),indexData:new Uint32Array(p)}}function U(t,e){return"simple_scalar"===e.style?F(t,e):"wind_speed"===e.style?A(t,e):S(t,e)}function V(t,e,n,o=[0,0],a=.5){const{width:i,height:s,mask:l}=t,[c,h]=t.pixels,[p,m]=o,d=Math.round((i-p)/n),M=Math.round((s-m)/n),g=d*M,x=new Float32Array(g),k=new Float32Array(g),w=new Uint8Array(g),y="vector-uv"===e;for(let r=0;r<M;r++)for(let t=0;t<d;t++){let e=0;const o=r*d+t,M=Math.max(0,r*n+m),g=Math.max(0,t*n+p),P=Math.min(s,M+n),b=Math.min(i,g+n);for(let t=M;t<P;t++)for(let n=g;n<b;n++){const r=t*i+n;if(!l||l[r]){e++;const t=y?[c[r],h[r]]:[c[r],(360+h[r])%360],[n,a]=y?t:f(t);x[o]+=n,k[o]+=a}}if(e>=(P-M)*(b-g)*(1-a)){w[o]=1;const[t,n]=u([x[o]/e,k[o]/e]);x[o]=t,k[o]=n}else w[o]=0,x[o]=0,k[o]=0}const P=new r({width:d,height:M,pixels:[x,k],mask:w});return P.updateStatistics(),P}t.convertToLocalDirections=p,t.convertVectorFieldData=m,t.convertVectorFieldUnit=d,t.createVFMesh=U,t.createVFMeshScalar=F,t.getUnitConversionFactor=c,t.sampleVectorField=V,t.snapImageToSymbolTile=M,t.unitKebabDict=l,t.uvComponentToVector=u,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
