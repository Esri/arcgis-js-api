/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../PixelBlock"],(function(t,e){"use strict";const n=function(t){return t&&"esri.layers.support.PixelBlock"===t.declaredClass&&t.pixels&&t.pixels.length>0};function i(t,i){if(null==i||!i.length||!n(t))return t;const l=t.pixels.length;return i&&i.some((t=>t>=l))||1===l&&1===i.length&&0===i[0]?t:l!==i.length||i.some(((t,e)=>t!==e))?new e({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:i.map((e=>t.pixels[e])),statistics:t.statistics&&i.map((e=>t.statistics[e]))}):t}function l(t){if(!t)return;const e=t.colormap;if(!e||0===e.length)return;const n=e.sort(((t,e)=>t[0]-e[0]));let i=0;n[0][0]<0&&(i=n[0][0]);const l=Math.max(256,n[n.length-1][0]-i+1),r=new Uint8Array(4*l),o=[];let s,a=0,h=0;const f=5===n[0].length;if(l>65536)return n.forEach((t=>{o[t[0]-i]=f?t.slice(1):t.slice(1).concat([255])})),{indexed2DColormap:o,offset:i,alphaSpecified:f};if(t.fillUnspecified)for(s=n[h],a=s[0]-i;a<l;a++)r[4*a]=s[1],r[4*a+1]=s[2],r[4*a+2]=s[3],r[4*a+3]=f?s[4]:255,a===s[0]-i&&(s=h===n.length-1?s:n[++h]);else for(a=0;a<n.length;a++)s=n[a],h=4*(s[0]-i),r[h]=s[1],r[h+1]=s[2],r[h+2]=s[3],r[h+3]=f?s[4]:255;return{indexedColormap:r,offset:i,alphaSpecified:f}}function r(t,e){if(!n(t))return t;if(!e&&(e.indexedColormap||e.indexed2DColormap))return t;const i=t.clone(),l=i.pixels;let r=i.mask;const o=i.width*i.height;if(1!==l.length)return t;const{indexedColormap:s,indexed2DColormap:a,offset:h,alphaSpecified:f}=e,u=s.length-1;let c=0;const m=l[0],x=new Uint8Array(m.length),p=new Uint8Array(m.length),d=new Uint8Array(m.length);let g,y=0;if(s)if(r)for(c=0;c<o;c++)r[c]&&(y=4*(m[c]-h),y<h||y>u?r[c]=0:(x[c]=s[y],p[c]=s[y+1],d[c]=s[y+2],r[c]=s[y+3]));else{for(r=new Uint8Array(o),c=0;c<o;c++)y=4*(m[c]-h),y<h||y>u?r[c]=0:(x[c]=s[y],p[c]=s[y+1],d[c]=s[y+2],r[c]=s[y+3]);i.mask=r}else if(r)for(c=0;c<o;c++)r[c]&&(g=a[m[c]],x[c]=g[0],p[c]=g[1],d[c]=g[2],r[c]=g[3]);else{for(r=new Uint8Array(o),c=0;c<o;c++)g=a[m[c]],x[c]=g[0],p[c]=g[1],d[c]=g[2],r[c]=g[3];i.mask=r}return i.pixels=[x,p,d],i.statistics=null,i.pixelType="u8",i.maskIsAlpha=f,i}function o(t){if(!n(t))return null;t.statistics||t.updateStatistics();const{pixels:e,mask:i,pixelType:l,statistics:r}=t,o=t.width*t.height,s=e.length;let a,h,f,u,c;const m=[],x=[];let p,d,g,y,w,M,k,A,U,C;const T=256;for(u=0;u<s;u++){if(p=new Uint32Array(T),g=e[u],"u8"===l)if(a=-.5,h=255.5,i)for(c=0;c<o;c++)i[c]&&p[g[c]]++;else for(c=0;c<o;c++)p[g[c]]++;else{if(a=r[u].minValue,h=r[u].maxValue,f=(h-a)/T,d=new Uint32Array(T+1),i)for(c=0;c<o;c++)i[c]&&d[Math.floor((g[c]-a)/f)]++;else for(c=0;c<o;c++)d[Math.floor((g[c]-a)/f)]++;for(c=0;c<255;c++)p[c]=d[c];p[255]=d[255]+d[256]}for(m.push({min:a,max:h,size:T,counts:p}),y=0,w=0,A=0,c=0;c<T;c++)y+=p[c],w+=c*p[c];for(U=w/y,c=0;c<T;c++)A+=p[c]*(c-U)**2;C=Math.sqrt(A/(y-1)),f=(h-a)/T,M=(U+.5)*f+a,k=C*f,x.push({min:a,max:h,avg:M,stddev:k})}return{statistics:x,histograms:m}}function s(t){const e=[];for(let n=0;n<t.length;n++){const{min:i,max:l,size:r,counts:o}=t[n];let s=0,a=0;for(let t=0;t<r;t++)s+=o[t],a+=t*o[t];const h=a/s;let f=0;for(let t=0;t<r;t++)f+=o[t]*(t-h)**2;const u=(l-i)/r,c=(h+.5)*u+i,m=Math.sqrt(f/(s-1))*u;e.push({min:i,max:l,avg:c,stddev:m})}return e}function a(t){const{minCutOff:e,maxCutOff:n,gamma:i,pixelType:l}=t,r=t.outMin||0,o=t.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(l))return null;const s=e.length;let a,f,u=0;"s8"===l?u=-127:"s16"===l&&(u=-32767);let c=256;["u16","s16"].indexOf(l)>-1&&(c=65536);const m=[],x=[],p=o-r;for(a=0;a<s;a++)x[a]=n[a]-e[a],m[a]=p/(n[a]-e[a]);const d=i&&i.length>=s,g=[];if(d)for(a=0;a<s;a++)i[a]>1?i[a]>2?g[a]=6.5+(i[a]-2)**2.5:g[a]=6.5+100*(2-i[a])**4:g[a]=1;let y;const w=[];let M,k,A;if(d)for(a=0;a<s;a++){for(A=[],f=0;f<c;f++)M=f+u,y=(M-e[a])/x[a],k=1,i[a]>1&&(k-=(1/p)**(y*g[a])),M<n[a]&&M>e[a]?A[f]=Math.floor(k*p*y**(1/i[a]))+r:M>=n[a]?A[f]=o:A[f]=r;w[a]=A}else for(a=0;a<s;a++){for(A=[],f=0;f<c;f++)M=f+u,M<=e[a]?A[f]=r:M>=n[a]?A[f]=o:A[f]=Math.floor((M-e[a])/x[a]*p)+r;w[a]=A}if(null!=t.contrastOffset){const e=h(t.contrastOffset,t.brightnessOffset);for(a=0;a<s;a++)for(A=w[a],f=0;f<c;f++)A[f]=e[A[f]]}return{lut:w,offset:u}}function h(t,e){const n=Math.min(Math.max(t,-100),100),i=Math.min(Math.max(e,-100),100),l=255,r=128;let o,s;const a=new Uint8Array(256);for(o=0;o<256;o++)n>0&&n<100?s=(200*o-100*l+2*l*i)/(2*(100-n))+r:n<=0&&n>-100?s=(200*o-100*l+2*l*i)*(100+n)/2e4+r:100===n?(s=200*o-100*l+(l+1)*(100-n)+2*l*i,s=s>0?l:0):-100===n&&(s=r),a[o]=s>l?l:s<0?0:s;return a}function f(t,e=256){e=Math.min(e,256);const{size:n,counts:i}=t,l=new Uint8Array(n),r=i.reduce(((t,n)=>t+n/e),0);let o=0,s=0,a=0,h=r;for(let f=0;f<n;f++)if(a+=i[f],!(f<n-1&&a+i[f+1]<h)){for(;o<e-1&&h<a;)o++,h+=r;for(let t=s;t<=f;t++)l[t]=o;s=f+1}for(let f=s;f<n;f++)l[f]=e-1;return l}function u(t,e){if(!n(t))return null;const i=t.clone(),{pixels:l,mask:r}=i,{minCutOff:o,maxCutOff:s,gamma:a}=e,h=e.outMin||0,f=e.outMax||255,u=i.width*i.height,c=l.length;let m,x,p,d,g;const y=f-h,w=[],M=[];for(m=0;m<c;m++)M[m]=s[m]-o[m],w[m]=y/(s[m]-o[m]);const k=a&&a.length>=c,A=[];if(k)for(m=0;m<c;m++)a[m]>1?a[m]>2?A[m]=6.5+(a[m]-2)**2.5:A[m]=6.5+100*(2-a[m])**4:A[m]=1;if(k)if(null!=r){for(x=0;x<u;x++)if(r[x])for(m=0;m<c;m++)p=l[m][x],g=(p-o[m])/M[m],d=1,a[m]>1&&(d-=(1/y)**(g*A[m])),p<s[m]&&p>o[m]?l[m][x]=Math.floor(d*y*g**(1/a[m]))+h:p>=s[m]?l[m][x]=f:l[m][x]=h}else for(x=0;x<u;x++)for(m=0;m<c;m++)p=l[m][x],g=(p-o[m])/M[m],d=1,a[m]>1&&(d-=(1/y)**(g*A[m])),p<s[m]&&p>o[m]?l[m][x]=Math.floor(d*y*g**(1/a[m]))+h:p>=s[m]?l[m][x]=f:l[m][x]=h;else if(null!=r){for(x=0;x<u;x++)if(r[x])for(m=0;m<c;m++)p=l[m][x],p<s[m]&&p>o[m]?l[m][x]=Math.floor((p-o[m])/M[m]*y)+h:p>=s[m]?l[m][x]=f:l[m][x]=h}else for(x=0;x<u;x++)for(m=0;m<c;m++)p=l[m][x],p<s[m]&&p>o[m]?l[m][x]=Math.floor((p-o[m])/M[m]*y)+h:p>=s[m]?l[m][x]=f:l[m][x]=h;return i.pixelType="u8",i.updateStatistics(),i}function c(t,i){if(!n(t))return null;const{pixels:l,mask:r}=t,o=t.width*t.height,s=l.length;let a=i.lut;const{offset:h}=i;let f,u;a&&1===a[0].length&&(a=l.map((()=>a)));const c=[];let m,x,p;if(h)if(null==r)for(f=0;f<s;f++){for(m=l[f],x=a[f],p=new Uint8Array(o),u=0;u<o;u++)p[u]=x[m[u]-h];c.push(p)}else for(f=0;f<s;f++){for(m=l[f],x=a[f],p=new Uint8Array(o),u=0;u<o;u++)r[u]&&(p[u]=x[m[u]-h]);c.push(p)}else if(null==r)for(f=0;f<s;f++){for(m=l[f],x=a[f],p=new Uint8Array(o),u=0;u<o;u++)p[u]=x[m[u]];c.push(p)}else for(f=0;f<s;f++){for(m=l[f],x=a[f],p=new Uint8Array(o),u=0;u<o;u++)r[u]&&(p[u]=x[m[u]]);c.push(p)}const d=new e({width:t.width,height:t.height,pixels:c,mask:r,pixelType:"u8"});return d.updateStatistics(),d}function m(t,e){if(!n(t))return null;const i=t.clone(),{pixels:l}=i,r=i.width*i.height,o=e.length,s=Math.floor(o/2),a=e[Math.floor(s)],h=l[0];let f,u,c,m,x,p,d=!1;const g=new Uint8Array(r),y=new Uint8Array(r),w=new Uint8Array(r);let M=i.mask;const k=4===e[0].mappedColor.length;for(M||(M=new Uint8Array(r),M.fill(k?255:1),i.mask=M),x=0;x<r;x++)if(M[x]){for(f=h[x],d=!1,p=s,u=a,c=0,m=o-1;m-c>1;){if(f===u.value){d=!0;break}f>u.value?c=p:m=p,p=Math.floor((c+m)/2),u=e[Math.floor(p)]}d||(f===e[c].value?(u=e[c],d=!0):f===e[m].value?(u=e[m],d=!0):f<e[c].value?(d=!1,u=null):f>e[c].value&&(f<e[m].value?(u=e[c],d=!0):m===o-1?(d=!1,u=null):(u=e[m],d=!0))),d?(g[x]=u.mappedColor[0],y[x]=u.mappedColor[1],w[x]=u.mappedColor[2],M[x]=u.mappedColor[3]):g[x]=y[x]=w[x]=M[x]=0}return i.pixels=[g,y,w],i.mask=M,i.pixelType="u8",i.maskIsAlpha=k,i}function x(t,e,n,i,l,r,o,s){return{xmin:l<=n*t?0:l<n*t+t?l-n*t:t,ymin:r<=i*e?0:r<i*e+e?r-i*e:e,xmax:l+o<=n*t?0:l+o<n*t+t?l+o-n*t:t,ymax:r+s<=i*e?0:r+s<i*e+e?r+s-i*e:e}}function p(t,e){if(!t||0===t.length)return null;const n=t.filter((t=>t.pixelBlock))[0];if(!n)return null;const i=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,l=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,r=.01*Math.min(i,l),o=t.sort(((t,e)=>Math.abs(t.extent.ymax-e.extent.ymax)>r?e.extent.ymax-t.extent.ymax:Math.abs(t.extent.xmin-e.extent.xmin)>r?t.extent.xmin-e.extent.xmin:0)),s=Math.min.apply(null,o.map((t=>t.extent.xmin))),a=Math.min.apply(null,o.map((t=>t.extent.ymin))),h=Math.max.apply(null,o.map((t=>t.extent.xmax))),f=Math.max.apply(null,o.map((t=>t.extent.ymax))),u={x:Math.round((e.xmin-s)/i),y:Math.round((f-e.ymax)/l)},c={width:Math.round((h-s)/i),height:Math.round((f-a)/l)},m={width:Math.round((e.xmax-e.xmin)/i),height:Math.round((e.ymax-e.ymin)/l)};if(Math.round(c.width/n.pixelBlock.width)*Math.round(c.height/n.pixelBlock.height)!==o.length||u.x<0||u.y<0||c.width<m.width||c.height<m.height)return null;return{extent:e,pixelBlock:g(o.map((t=>t.pixelBlock)),c,u,m)}}function d(t,e,n,i,l,r){const{width:o,height:s}=n.block,{x:a,y:h}=n.offset,{width:f,height:u}=n.mosaic,c=x(o,s,i,l,a,h,f,u);let m=0,p=0;if(r){const t=r.hasGCSSShiftTransform?360:r.halfWorldWidth,e=o*r.resolutionX,n=r.startX+i*e,l=n+e;n<t&&l>t?p=r.rightPadding:n>=t&&(m=r.leftMargin-r.rightPadding,p=0)}if(c.xmax-=p,"number"!=typeof e)for(let x=c.ymin;x<c.ymax;x++){const n=(l*s+x-h)*f+(i*o-a)+m,r=x*o;for(let i=c.xmin;i<c.xmax;i++)t[n+i]=e[r+i]}else for(let x=c.ymin;x<c.ymax;x++){const n=(l*s+x-h)*f+(i*o-a)+m;for(let i=c.xmin;i<c.xmax;i++)t[n+i]=e}}function g(t,i,l,r,o){const s=t.filter((t=>n(t)))[0];if(null==s)return null;const a=r?r.width:i.width,h=r?r.height:i.height,f=s.width,u=s.height,c=i.width/f,m=i.height/u,x={offset:l||{x:0,y:0},mosaic:r||i,block:{width:f,height:u}},p=s.pixelType,g=e.getPixelArrayConstructor(p),y=s.pixels.length,w=[];let M,k;for(let e=0;e<y;e++){k=new g(a*h);for(let i=0;i<m;i++)for(let l=0;l<c;l++){const r=t[i*c+l];n(r)&&(M=r.pixels[e],d(k,M,x,l,i,o))}w.push(k)}let A;if(t.some((t=>null==t||t.mask&&t.mask.length>0))){A=new Uint8Array(a*h);for(let e=0;e<m;e++)for(let n=0;n<c;n++){const i=t[e*c+n],l=i?i.mask:null;d(A,l||(i?1:0),x,n,e,o)}}const U=new e({width:a,height:h,pixels:w,pixelType:p,mask:A});return U.updateStatistics(),U}function y(t,e,i){if(!n(t))return null;const{width:l,height:r}=t,o=e.x,s=e.y,a=i.width+o,h=i.height+s;if(o<0||s<0||a>l||h>r)return t;if(0===o&&0===s&&a===l&&h===r)return t;t.mask||(t.mask=new Uint8Array(l*r));const f=t.mask;for(let n=0;n<r;n++){const t=n*l;for(let e=0;e<l;e++)f[t+e]=n<s||n>=h||e<o||e>=a?0:1}return t.updateStatistics(),t}function w(t){if(!n(t))return null;const e=t.clone(),{width:i,height:l,pixels:r,mask:o}=t,s=r[0],a=e.pixels[0];for(let n=2;n<l-1;n++){const t=new Map;for(let l=n-2;l<n+2;l++)for(let e=0;e<4;e++){const n=l*i+e;A(t,s[n],o?o[n]:1)}a[n*i]=M(t),a[n*i+1]=a[n*i+2]=a[n*i];let e=3;for(;e<i-1;e++){let l=(n-2)*i+e+1;A(t,s[l],o?o[l]:1),l=(n-1)*i+e+1,A(t,s[l],o?o[l]:1),l=n*i+e+1,A(t,s[l],o?o[l]:1),l=(n+1)*i+e+1,A(t,s[l],o?o[l]:1),l=(n-2)*i+e-3,k(t,s[l],o?o[l]:1),l=(n-1)*i+e-3,k(t,s[l],o?o[l]:1),l=n*i+e-3,k(t,s[l],o?o[l]:1),l=(n+1)*i+e-3,k(t,s[l],o?o[l]:1),a[n*i+e]=M(t)}a[n*i+e+1]=a[n*i+e]}for(let n=0;n<i;n++)a[n]=a[i+n]=a[2*i+n],a[(l-1)*i+n]=a[(l-2)*i+n];return e.updateStatistics(),e}function M(t){if(0===t.size)return 0;let e=0,n=-1,i=0;const l=t.keys();let r=l.next();for(;!r.done;)i=t.get(r.value),i>e&&(n=r.value,e=i),r=l.next();return n}function k(t,e,n){if(0===n)return;const i=t.get(e);1===i?t.delete(e):t.set(e,i-1)}function A(t,e,n){0!==n&&t.set(e,t.has(e)?t.get(e)+1:1)}function U(t,i,l){let{x:r,y:o}=i;const{width:s,height:a}=l;if(0===r&&0===o&&a===t.height&&s===t.width)return t;const{width:h,height:f}=t,u=Math.max(0,o),c=Math.max(0,r),m=Math.min(r+s,h),x=Math.min(o+a,f);if(m<0||x<0||!n(t))return null;r=Math.max(0,-r),o=Math.max(0,-o);const{pixels:p,mask:d}=t,g=s*a,y=p.length,w=[];for(let n=0;n<y;n++){const i=p[n],l=e.createEmptyBand(t.pixelType,g);for(let t=u;t<x;t++){const e=t*h;let n=(t+o-u)*s+r;for(let t=c;t<m;t++)l[n++]=i[e+t]}w.push(l)}const M=new Uint8Array(g);for(let e=u;e<x;e++){const t=e*h;let n=(e+o-u)*s+r;for(let e=c;e<m;e++)M[n++]=d?d[t+e]:1}const k=new e({width:l.width,height:l.height,pixelType:t.pixelType,pixels:w,mask:M});return k.updateStatistics(),k}function C(t,i=!0){if(!n(t))return null;const{pixels:l,width:r,height:o,mask:s,pixelType:a}=t,h=[],f=Math.round(r/2),u=Math.round(o/2),c=o-1,m=r-1;for(let n=0;n<l.length;n++){const t=l[n],s=e.createEmptyBand(a,f*u);let x=0;for(let e=0;e<o;e+=2)for(let n=0;n<r;n+=2){const l=t[e*r+n];if(i){const i=n===m?l:t[e*r+n+1],o=e===c?l:t[e*r+n+r],a=n===m?o:e===c?i:t[e*r+n+r+1];s[x++]=(l+i+o+a)/4}else s[x++]=l}h.push(s)}let x=null;if(s){x=new Uint8Array(f*u);let t=0;for(let e=0;e<o;e+=2)for(let n=0;n<r;n+=2){const l=s[e*r+n];if(i){const i=n===m?l:s[e*r+n+1],o=e===c?l:s[e*r+n+r],a=n===m?o:e===c?i:s[e*r+n+r+1];x[t++]=l*i*o*a?1:0}else x[t++]=l}}return new e({width:f,height:u,pixelType:a,pixels:h,mask:x})}function T(t,e,i){if(!n(t))return null;const{width:l,height:r}=e;let{width:o,height:s}=t;const a=new Map,h={x:0,y:0},f=null==i?1:1+i;let u=t;for(let n=0;n<f;n++){const t=Math.ceil(o/l),i=Math.ceil(s/r);for(let o=0;o<i;o++){h.y=o*r;for(let i=0;i<t;i++){h.x=i*l;const t=U(u,h,e);a.set(`${n}/${o}/${i}`,t)}}n<f-1&&(u=C(u)),o=Math.round(o/2),s=Math.round(s/2)}return a}function S(t,i,l,r,o="nearest"){if(!n(t))return null;"majority"===o&&(t=w(t));const{pixels:s,mask:a,pixelType:h}=t,f=t.width,u=t.height,c=e.getPixelArrayConstructor(h),m=s.length,{width:x,height:p}=i,d=r.cols,g=r.rows,y=Math.ceil(x/d),M=Math.ceil(p/g);let k,A,U,C,T,S,v,B=!1;for(let e=0;e<l.length;e+=3)-1===l[e]&&-1===l[e+1]&&-1===l[e+2]&&(B=!0);const P=new Float32Array(x*p),O=new Float32Array(x*p);let b,z,j=0;const D="majority"===o?0:.5;for(let e=0;e<M;e++)for(let t=0;t<y;t++){k=12*(e*y+t),A=l[k],U=l[k+1],C=l[k+2],T=l[k+3],S=l[k+4],v=l[k+5];for(let n=0;n<g;n++){j=(e*g+n)*x+t*d,z=(n+.5)/g;for(let t=0;t<n;t++)b=(t+.5)/d,P[j+t]=Math.round((A*b+U*z+C)*f-D),O[j+t]=Math.round((T*b+S*z+v)*u-D)}k+=6,A=l[k],U=l[k+1],C=l[k+2],T=l[k+3],S=l[k+4],v=l[k+5];for(let n=0;n<g;n++){j=(e*g+n)*x+t*d,z=(n+.5)/g;for(let t=n;t<d;t++)b=(t+.5)/d,P[j+t]=Math.round((A*b+U*z+C)*f-D),O[j+t]=Math.round((T*b+S*z+v)*u-D)}}const E=(t,e)=>{for(let n=0;n<p;n++){k=n*x;for(let n=0;n<x;n++)P[k]<0||O[k]<0?t[k]=0:t[k]=e[P[k]+O[k]*f],k++}},I=[];let L;for(let e=0;e<m;e++)L=new c(x*p),E(L,s[e]),I.push(L);const q=new e({width:x,height:p,pixelType:h,pixels:I});if(a)q.mask=new Uint8Array(x*p),E(q.mask,a);else if(B){q.mask=new Uint8Array(x*p);for(let t=0;t<x*p;t++)q.mask[t]=P[t]<0||O[t]<0?0:1}return q.updateStatistics(),q}t.approximateTransform=S,t.clip=U,t.colorize=r,t.createColormapLUT=l,t.createContrastBrightnessLUT=h,t.createHistogramEqualizationLUT=f,t.createStretchLUT=a,t.estimateStatisticsFromHistograms=s,t.estimateStatisticsHistograms=o,t.extractBands=i,t.getClipBounds=x,t.lookupPixels=c,t.mosaic=g,t.mosaicPixelData=p,t.remapColor=m,t.resampleByMajority=w,t.setValidBoundary=y,t.split=T,t.stretch=u,Object.defineProperty(t,"__esModule",{value:!0})}));
