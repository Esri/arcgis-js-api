/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../kernel","../../core/Error","../../core/jsonMap","../../core/maybe","../../core/sql","./layerUtils","../../rest/support/AttachmentQuery","../../rest/support/Query","../../rest/support/RelationshipQuery"],(function(e,t,r,n,i,o,a,s,u,c,p,l){"use strict";const y=new o.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});function d(e,t,r,n){return f.apply(this,arguments)}function f(){return(f=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(yield h(e,t,n),!o.addAttachment)throw new i(n,"Layer source does not support addAttachment capability");return o.addAttachment(t,r)}))).apply(this,arguments)}function h(e,t,r){const{attributes:n}=t,{objectIdField:o}=e;return e.get("capabilities.data.supportsAttachment")?t?n?o&&n[o]?Promise.resolve():Promise.reject(new i(r,`feature is missing the identifying attribute ${o}`)):Promise.reject(new i(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new i(r,"A feature is required to add/delete/update attachments")):Promise.reject(new i(r,"this layer doesn't support attachments"))}function m(e,t,r,n,i){return b.apply(this,arguments)}function b(){return(b=r._asyncToGenerator((function*(e,t,r,n,o){const a=yield H(e);if(yield h(e,t,o),!a.updateAttachment)throw new i(o,"Layer source does not support updateAttachment capability");return a.updateAttachment(t,r,n)}))).apply(this,arguments)}function w(e,t,r){return g.apply(this,arguments)}function g(){return(g=r._asyncToGenerator((function*(t,r,n){const i=yield new Promise(((t,r)=>e(["../graphics/editingSupport"],t,r))),o=yield t.load();return i.applyEdits(o,o.source,r,n)}))).apply(this,arguments)}function q(e,t,r,n){return F.apply(this,arguments)}function F(){return(F=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(yield h(e,t,n),!o.deleteAttachments)throw new i(n,"Layer source does not support deleteAttachments capability");return o.deleteAttachments(t,r)}))).apply(this,arguments)}function G(e,t,r){return P.apply(this,arguments)}function P(){return(P=r._asyncToGenerator((function*(e,t,r){const n=(yield e.load({signal:t?.signal})).source;if(!n.fetchRecomputedExtents)throw new i(r,"Layer source does not support fetchUpdates capability");return n.fetchRecomputedExtents(t)}))).apply(this,arguments)}function I(e,t,r,n){return A.apply(this,arguments)}function A(){return(A=r._asyncToGenerator((function*(e,t,r,n){t=c.from(t),yield e.load();const o=e.source,a=e.capabilities;if(!a?.data?.supportsAttachment)throw new i(n,"this layer doesn't support attachments");const{attachmentTypes:s,objectIds:u,globalIds:p,num:l,size:y,start:d,where:f}=t;if(!a?.operations?.supportsQueryAttachments){if(s?.length>0||p?.length>0||y?.length>0||l||d||f)throw new i(n,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",t)}if(!(u?.length||p?.length||f))throw new i(n,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",t);if(!o.queryAttachments)throw new i(n,"Layer source does not support queryAttachments capability",t);return o.queryAttachments(t)}))).apply(this,arguments)}function E(e,t,r,n){return O.apply(this,arguments)}function O(){return(O=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(!o.queryObjectIds)throw new i(n,"Layer source does not support queryObjectIds capability");return o.queryObjectIds(p.from(t)??e.createQuery(),r)}))).apply(this,arguments)}function T(e,t,r,n){return j.apply(this,arguments)}function j(){return(j=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(!o.queryFeatureCount)throw new i(n,"Layer source does not support queryFeatureCount capability");return o.queryFeatureCount(p.from(t)??e.createQuery(),r)}))).apply(this,arguments)}function _(e,t,r,n){return C.apply(this,arguments)}function C(){return(C=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(!o.queryExtent)throw new i(n,"Layer source does not support queryExtent capability");return o.queryExtent(p.from(t)??e.createQuery(),r)}))).apply(this,arguments)}function x(e,t,r,n){return R.apply(this,arguments)}function R(){return(R=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(!o.queryRelatedFeatures)throw new i(n,"Layer source does not support queryRelatedFeatures capability");return o.queryRelatedFeatures(l.from(t),r)}))).apply(this,arguments)}function S(e,t,r,n){return M.apply(this,arguments)}function M(){return(M=r._asyncToGenerator((function*(e,t,r,n){const o=yield H(e);if(!o.queryRelatedFeaturesCount)throw new i(n,"Layer source does not support queryRelatedFeaturesCount capability");return o.queryRelatedFeaturesCount(l.from(t),r)}))).apply(this,arguments)}function L(e){return v.apply(this,arguments)}function v(){return(v=r._asyncToGenerator((function*(e){const t=e.source;if(t?.refresh)try{const{dataChanged:r,updates:n}=yield t.refresh();if(a.isSome(n)&&(e.sourceJSON={...e.sourceJSON,...n},e.read(n,{origin:"service",url:e.parsedUrl})),r)return!0}catch{}if(e.definitionExpression)try{return(yield s.parseWhereClause(e.definitionExpression,e.fieldsIndex)).hasDateFunctions}catch{}return!1}))).apply(this,arguments)}function Q(e){const t=new p,r=e.get("capabilities.data"),n=e.get("capabilities.query");t.historicMoment=e.historicMoment,t.gdbVersion=e.gdbVersion,t.returnGeometry=!0,n&&(t.compactGeometryEnabled=n.supportsCompactGeometry,t.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=e.returnZ&&(t.returnZ=e.returnZ),r.supportsM&&null!=e.returnM&&(t.returnM=e.returnM)),t.outFields=["*"];const{timeOffset:i,timeExtent:o}=e;return t.timeExtent=null!=i&&null!=o?o.offset(-i.value,i.unit):o||null,t.multipatchOption="multipatch"===e.geometryType?"xyFootprint":null,t}function U(e){const{globalIdField:t,fields:r}=e;if(t)return t;if(r)for(const n of r)if("esriFieldTypeGlobalID"===n.type)return n.name}function D(e){const{objectIdField:t,fields:r}=e;if(t)return t;if(r)for(const n of r)if("esriFieldTypeOID"===n.type)return n.name}function V(e){return e.currentVersion?e.currentVersion:e.hasOwnProperty("capabilities")||e.hasOwnProperty("drawingInfo")||e.hasOwnProperty("hasAttachments")||e.hasOwnProperty("htmlPopupType")||e.hasOwnProperty("relationships")||e.hasOwnProperty("timeInfo")||e.hasOwnProperty("typeIdField")||e.hasOwnProperty("types")?10:9.3}function H(e){return J.apply(this,arguments)}function J(){return(J=r._asyncToGenerator((function*(e){return(yield e.load()).source}))).apply(this,arguments)}function N(e,t){return Z.apply(this,arguments)}function Z(){return(Z=r._asyncToGenerator((function*(e,t){if(!n.id)return;if(n.id.findCredential(e))return;let r;try{const i=yield u.getOwningPortalUrl(e,t);i&&(r=yield n.id.checkSignInStatus(`${i}/sharing`))}catch(i){}if(r)try{const r=a.isSome(t)?t.signal:null;yield n.id.getCredential(e,{signal:r})}catch(i){}}))).apply(this,arguments)}function k(e,t){return $.apply(this,arguments)}function $(){return($=r._asyncToGenerator((function*(e,t){const r=e.parsedUrl?.path;if(!r)return;const n=e.editFieldsInfo;(e.userHasUpdateItemPrivileges||e.userHasFullEditingPrivileges&&e.capabilities.operations.supportsEditing||n?.creatorField||n?.editorField)&&(yield N(r,t))}))).apply(this,arguments)}function z(e){return!e.sourceJSON?.isMultiServicesView&&(e.userHasUpdateItemPrivileges||e.editingEnabled)}t.addAttachment=d,t.applyEdits=w,t.computeEffectiveEditingEnabled=z,t.createQuery=Q,t.deleteAttachments=q,t.ensureLayerCredential=k,t.fetchRecomputedExtents=G,t.geometryTypeKebabDict=y,t.hasDataChanged=L,t.queryAttachments=I,t.queryExtent=_,t.queryFeatureCount=T,t.queryObjectIds=E,t.queryRelatedFeatures=x,t.queryRelatedFeaturesCount=S,t.readGlobalIdField=U,t.readObjectIdField=D,t.readVersion=V,t.updateAttachment=m,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
