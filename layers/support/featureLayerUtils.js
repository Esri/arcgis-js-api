/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/has","../../core/jsonMap","../../core/maybe","../../core/sql","./arcgisLayerUrl","../../rest/support/AttachmentQuery","../../rest/support/Query","../../rest/support/RelationshipQuery"],(function(t,e,r,s,o,n,u,a,p,i,c,l){"use strict";const d=new n.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),y={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function h(t,e,r){return!!(t&&t.hasOwnProperty(e)?t[e]:r)}function f(t,e,r){return t&&t.hasOwnProperty(e)?t[e]:r}function m(t){const e=t?.supportedSpatialAggregationStatistics?.map((t=>t.toLowerCase()));return{envelope:!!e?.includes("envelopeaggregate"),centroid:!!e?.includes("centroidaggregate"),convexHull:!!e?.includes("convexhullaggregate")}}function g(t,e){const r=t?.supportedOperationsWithCacheHint?.map((t=>t.toLowerCase()));return!!r?.includes(e.toLowerCase())}function w(t,e,r){return{analytics:b(e),attachment:C(e),data:A(e),metadata:S(e),operations:R(e.capabilities||t,e,r),query:F(e,r),queryRelated:q(e),queryTopFeatures:Q(e),editing:T(e)}}function b(t){return{supportsCacheHint:g(t.advancedQueryCapabilities,"queryAnalytics")}}function C(t){const e=t.attachmentProperties,r={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:g(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:h(t,"supportsAttachmentsResizing",!1)};return e&&Array.isArray(e)&&e.forEach((t=>{const e=y[t.name];e&&(r[e]=!!t.isEnabled)})),r}function A(t){return{isVersioned:h(t,"isDataVersioned",!1),supportsAttachment:h(t,"hasAttachments",!1),supportsM:h(t,"hasM",!1),supportsZ:h(t,"hasZ",!1)}}function S(t){return{supportsAdvancedFieldProperties:h(t,"supportsFieldDescriptionProperty",!1)}}function R(t,e,r){const s=t?t.toLowerCase().split(",").map((t=>t.trim())):[],o=r?p.parse(r):null,n=s.includes(u.isSome(o)&&"MapServer"===o.serverType?"data":"query"),a=s.includes("editing")&&!e.datesInUnknownTimezone;let i=a&&s.includes("create"),c=a&&s.includes("delete"),l=a&&s.includes("update");const d=s.includes("changetracking"),y=e.advancedQueryCapabilities;return a&&!(i||c||l)&&(i=c=l=!0),{supportsCalculate:h(e,"supportsCalculate",!1),supportsTruncate:h(e,"supportsTruncate",!1),supportsValidateSql:h(e,"supportsValidateSql",!1),supportsAdd:i,supportsDelete:c,supportsEditing:a,supportsChangeTracking:d,supportsQuery:n,supportsQueryAnalytics:h(y,"supportsQueryAnalytic",!1),supportsQueryAttachments:h(y,"supportsQueryAttachments",!1),supportsQueryTopFeatures:h(y,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:h(e,"supportsAttachmentsResizing",!1),supportsSync:s.includes("sync"),supportsUpdate:l,supportsExceedsLimitStatistics:h(e,"supportsExceedsLimitStatistics",!1)}}function F(t,e){const r=t.advancedQueryCapabilities,s=t.ownershipBasedAccessControlForFeatures,n=t.archivingInfo,u=rt(t),a=e?.includes("MapServer"),i=!o("mapserver-pbf-enabled")&&a&&(u??0)<10.81,c=p.isHostedAgolService(e),l=(t.supportedQueryFormats||"").split(",").reduce(((t,e)=>{const r=e.toLowerCase().trim();return r&&t.add(r),t}),new Set);return{supportsStatistics:h(r,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:h(r,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:h(r,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:m(r),supportsCentroid:h(r,"supportsReturningGeometryCentroid",!1),supportsDistance:h(r,"supportsQueryWithDistance",!1),supportsDistinct:h(r,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:h(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:h(r,"supportsReturningGeometryProperties",!1),supportsHavingClause:h(r,"supportsHavingClause",!1),supportsOrderBy:h(r,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:h(r,"supportsPagination",!1),supportsQuantization:h(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:h(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:h(t,"supportsReturningQueryGeometry",!1),supportsResultType:h(r,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:h(r,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:h(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:h(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:h(r,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:h(s,"allowOthersToQuery",!0),supportsHistoricMoment:h(n,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:!i&&l.has("pbf"),supportsDisjointSpatialRelationship:h(r,"supportsDisjointSpatialRel",!1),supportsCacheHint:h(r,"supportsQueryWithCacheHint",!1)||g(r,"query"),supportsDefaultSpatialReference:h(r,"supportsDefaultSR",!1),supportsCompactGeometry:c,supportsFullTextSearch:h(r,"supportsFullTextSearch",!1),maxRecordCountFactor:f(t,"maxRecordCountFactor",void 0),maxRecordCount:f(t,"maxRecordCount",void 0),standardMaxRecordCount:f(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:f(t,"tileMaxRecordCount",void 0)}}function q(t){const e=t.advancedQueryCapabilities,r=h(e,"supportsAdvancedQueryRelated",!1);return{supportsPagination:h(e,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r,supportsCacheHint:g(e,"queryRelated")}}function Q(t){return{supportsCacheHint:g(t.advancedQueryCapabilities,"queryTopFilter")}}function T(t){const e=t.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:h(t,"allowGeometryUpdates",!0),supportsGlobalId:h(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:h(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:h(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:h(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:h(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:h(e,"allowAnonymousToDelete",!0),supportsDeleteByOthers:h(e,"allowOthersToDelete",!0),supportsUpdateByAnonymous:h(e,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:h(e,"allowOthersToUpdate",!0)}}function x(t,e,r,s){return P.apply(this,arguments)}function P(){return(P=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(yield O(t,e,o),!n.addAttachment)throw new s(o,"Layer source does not support addAttachment capability");return n.addAttachment(e,r)}))).apply(this,arguments)}function O(t,e,r){const{attributes:o}=e,{objectIdField:n}=t;return t.get("capabilities.data.supportsAttachment")?e?o?n&&o[n]?Promise.resolve():Promise.reject(new s(r,`feature is missing the identifying attribute ${n}`)):Promise.reject(new s(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new s(r,"A feature is required to add/delete/update attachments")):Promise.reject(new s(r,"this layer doesn't support attachments"))}function v(t,e,r,s,o){return E.apply(this,arguments)}function E(){return(E=r._asyncToGenerator((function*(t,e,r,o,n){const{source:u}=yield t.load();if(yield O(t,e,n),!u.updateAttachment)throw new s(n,"Layer source does not support updateAttachment capability");return u.updateAttachment(e,r,o)}))).apply(this,arguments)}function G(t,e,r){return I.apply(this,arguments)}function I(){return(I=r._asyncToGenerator((function*(e,r,s){const o=yield new Promise(((e,r)=>t(["../graphics/editingSupport"],e,r))),n=yield e.load();return o.applyEdits(n,n.source,r,s)}))).apply(this,arguments)}function M(t,e,r,s){return D.apply(this,arguments)}function D(){return(D=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(yield O(t,e,o),!n.deleteAttachments)throw new s(o,"Layer source does not support deleteAttachments capability");return n.deleteAttachments(e,r)}))).apply(this,arguments)}function L(t,e,r){return j.apply(this,arguments)}function j(){return(j=r._asyncToGenerator((function*(t,e,r){const{source:o}=yield t.load({signal:e?.signal});if(!o.fetchRecomputedExtents)throw new s(r,"Layer source does not support fetchUpdates capability");return o.fetchRecomputedExtents(e)}))).apply(this,arguments)}function z(t,e,r,s){return U.apply(this,arguments)}function U(){return(U=r._asyncToGenerator((function*(t,e,r,o){e=i.from(e);const{source:n,capabilities:u}=yield t.load();if(!u?.data?.supportsAttachment)throw new s(o,"this layer doesn't support attachments");const{attachmentTypes:a,objectIds:p,globalIds:c,num:l,size:d,start:y,where:h}=e;if(!u?.operations?.supportsQueryAttachments){const t=p&&p.length>1,r=a&&a.length,n=c&&c.length,u=d&&d.length;if(t||r||n||u||l||y||h)throw new s(o,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",e)}if(!p?.length&&!h)throw new s(o,"'objectIds' or 'where' are required to perform attachment query",e);if(!n.queryAttachments)throw new s(o,"Layer source does not support queryAttachments capability",e);return n.queryAttachments(e)}))).apply(this,arguments)}function _(t,e,r,s){return H.apply(this,arguments)}function H(){return(H=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(!n.queryObjectIds)throw new s(o,"Layer source does not support queryObjectIds capability");return n.queryObjectIds(c.from(e)??t.createQuery(),r)}))).apply(this,arguments)}function B(t,e,r,s){return V.apply(this,arguments)}function V(){return(V=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(!n.queryFeatureCount)throw new s(o,"Layer source does not support queryFeatureCount capability");return n.queryFeatureCount(c.from(e)??t.createQuery(),r)}))).apply(this,arguments)}function W(t,e,r,s){return k.apply(this,arguments)}function k(){return(k=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(!n.queryExtent)throw new s(o,"Layer source does not support queryExtent capability");return n.queryExtent(c.from(e)??t.createQuery(),r)}))).apply(this,arguments)}function Z(t,e,r,s){return N.apply(this,arguments)}function N(){return(N=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(!n.queryRelatedFeatures)throw new s(o,"Layer source does not support queryRelatedFeatures capability");return n.queryRelatedFeatures(l.from(e),r)}))).apply(this,arguments)}function J(t,e,r,s){return K.apply(this,arguments)}function K(){return(K=r._asyncToGenerator((function*(t,e,r,o){const{source:n}=yield t.load();if(!n.queryRelatedFeaturesCount)throw new s(o,"Layer source does not support queryRelatedFeaturesCount capability");return n.queryRelatedFeaturesCount(l.from(e),r)}))).apply(this,arguments)}function $(t){return X.apply(this,arguments)}function X(){return(X=r._asyncToGenerator((function*(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:s}=yield e.refresh();if(u.isSome(s)&&(t.sourceJSON={...t.sourceJSON,...s},t.read(s,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(yield a.parseWhereClause(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}))).apply(this,arguments)}function Y(t){const e=new c,r=t.get("capabilities.data"),s=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,s&&(e.compactGeometryEnabled=s.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=s.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:o,timeExtent:n}=t;return e.timeExtent=null!=o&&null!=n?n.offset(-o.value,o.unit):n||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function tt(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const s of r)if("esriFieldTypeGlobalID"===s.type)return s.name}function et(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const s of r)if("esriFieldTypeOID"===s.type)return s.name}function rt(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}e.addAttachment=x,e.applyEdits=G,e.createQuery=Y,e.deleteAttachments=M,e.fetchRecomputedExtents=L,e.geometryTypeKebabDict=d,e.getFeatureLayerCapabilities=w,e.hasDataChanged=$,e.queryAttachments=z,e.queryExtent=W,e.queryFeatureCount=B,e.queryObjectIds=_,e.queryRelatedFeatures=Z,e.queryRelatedFeaturesCount=J,e.readGlobalIdField=tt,e.readObjectIdField=et,e.readVersion=rt,e.updateAttachment=v,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
