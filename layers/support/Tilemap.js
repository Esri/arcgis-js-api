/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../request","../../core/arrayUtils","../../core/Error","../../core/lang"],(function(t,i,e,a,o){"use strict";let l=function(){function t(){this.location={left:0,top:0,width:0,height:0},this._allAvailability="unknown",this.byteSize=40}var l=t.prototype;return l.getAvailability=function(t,i){if("unknown"!==this._allAvailability)return this._allAvailability;const e=(t-this.location.top)*this.location.width+(i-this.location.left),a=e%8,o=e>>3,l=this._tileAvailabilityBitSet;return o<0||o>l.length?"unknown":l[o]&1<<a?"available":"unavailable"},l._updateFromData=function(t){const i=this.location.width,e=this.location.height;let a=!0,o=!0;const l=Math.ceil(i*e/8),n=new Uint8Array(l);let r=0;for(let h=0;h<t.length;h++){const i=h%8;t[h]?(o=!1,n[r]|=1<<i):a=!1,7===i&&++r}o?this._allAvailability="unavailable":a?this._allAvailability="available":(this._allAvailability="unknown",this._tileAvailabilityBitSet=n,this.byteSize+=n.length)},t.fromDefinition=function(o,l){const n=o.service.request||i,{row:h,col:s,width:c,height:f}=o,d={query:{f:"json"}};return l=l?{...d,...l}:d,n(r(o),l).then((t=>t.data)).catch((t=>{if(t&&t.details&&422===t.details.httpStatus)return{location:{top:h,left:s,width:c,height:f},valid:!0,data:e.constant(c*f,0)};throw t})).then((i=>{if(i.location&&(i.location.top!==h||i.location.left!==s||i.location.width!==c||i.location.height!==f))throw new a("tilemap:location-mismatch","Tilemap response for different location than requested",{response:i,definition:{top:h,left:s,width:c,height:f}});return t.fromJSON(i)}))},t.fromJSON=function(i){t._validateJSON(i);const e=new t;return e.location=Object.freeze(o.clone(i.location)),e._updateFromData(i.data),Object.freeze(e)},t._validateJSON=function(t){if(!t||!t.location)throw new a("tilemap:missing-location","Location missing from tilemap response");if(!1===t.valid)throw new a("tilemap:invalid","Tilemap response was marked as invalid");if(!t.data)throw new a("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(t.data))throw new a("tilemap:data-mismatch","Data must be an array of numbers");if(t.data.length!==t.location.width*t.location.height)throw new a("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")},t}();function n(t){return`${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}function r(t){let i;if("vector-tile"===t.service.type)i=`${t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;else{const e=t.service.tileServers;i=`${e&&e.length?e[t.row%e.length]:t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}const e=t.service.query;return e&&(i=`${i}?${e}`),i}t.Tilemap=l,t.tilemapDefinitionId=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
