// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","../../core/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","../../geometry/Point","../../geometry/support/webMercatorUtils","./MapImage","../FeatureLayer","../../renderers/HeatmapRenderer","../../tasks/support/Query","dojo/_base/fx"],function(e,t,r,a,n,i,s,o,h,u,c,l){function d(){}function m(e){var t=e.geometry,r=e.attributes,a=e.layer;return{geometry:t,attributes:r,getLayer:function(){return a}}}var g=t(null,{declaredClass:"esri.layers.support.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(e){this.sourceLayer=e,this._hndls=[]},initialize:function(t){this.map=t;var a=this.sourceLayer,n=a.renderer;a.setDrawMode(!1),this.imageLayer=t._getMapImageLyr();var i=this;n instanceof u?this.heatmapRenderer=n:this.heatmapRenderer=(n.getRendererInfoByZoom(t.getZoom())||n.getRendererInfoByScale(t.getScale())).renderer,this.recalculateHeatmap=this.recalculateHeatmap.bind(this),this._removeRenderer=this._removeRenderer.bind(this),this._handleRendererChange=this._handleRendererChange.bind(this),this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange),this._handleOpacityChange=this._handleOpacityChange.bind(this),this._reprojectFeature=this._reprojectFeature.bind(this),e(["../../workers/heatmapCalculator"],function(e){i._calculator=new e(r.mixin({width:i.map.width,height:i.map.height},i._getOptions())),i._setupRenderer(),i.heatmapRenderer.getStats=e.calculateStats,i.heatmapRenderer.getHistogramData=e.getHistogramData})},destroy:function(){this._removeHandlers(),this._rendererChangeHandle&&this._rendererChangeHandle.remove(),this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(e){var t=e.renderer,r=t instanceof u;this.heatmapRenderer?r?this.heatmapRenderer=t:this._removeRenderer(e):r&&(this.heatmapRenderer=t,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(e){var t=e.opacity,r=this._getImageBySourceId(this.sourceLayer.id);r&&r.setOpacity(t)},_setupRenderer:function(){var e=this._hndls,t=this.sourceLayer,r=this.map,i=this;t._originalDraw=t._draw,t._draw=d,t._div.clear(),setTimeout(this._resetGraphics.bind(this),250),e.push(t.on("update-end",function(e){i.recalculateHeatmap()})),e.push(t.on("suspend",function(e){var t=i._getImageBySourceId(i.sourceLayer.id);t&&t.hide()})),e.push(t.on("resume",function(e){var t=i._getImageBySourceId(i.sourceLayer.id);t&&t.show()})),e.push(n.after(t,"redraw",this.recalculateHeatmap)),e.push(r.on("layer-remove",function(e){if(e.layer==t){var r=i._getImageBySourceId(i.sourceLayer.id);r&&i.imageLayer.removeImage(r),i._removeRenderer({target:t})}})),t._collection&&e.push(t.on("graphic-add",function(e){i._reprojectFeature(e.graphic)})),t.mode!==h.MODE_ONDEMAND&&(e.push(r.on("resize, pan-end",function(e){setTimeout(i.recalculateHeatmap,16)})),e.push(r.on("zoom-end",function(e){setTimeout(function(){t._getRenderer().isInstanceOf(u)&&i.recalculateHeatmap()},16)}))),e.push(t.on("opacity-change",this._handleOpacityChange)),this.imageLayer.suspended&&this.imageLayer.resume(),t.graphics&&t.graphics.length&&(t.graphics[0].geometry&&!r.spatialReference.equals(t.graphics[0].geometry.spatialReference)&&a.forEach(t.graphics,function(e){this._reprojectFeature(e)}.bind(this)),this.recalculateHeatmap())},_removeRenderer:function(e){var t=e.target;t._draw=t._originalDraw,delete t._originalDraw,t.setDrawMode(!0),this._removeHandlers(),this._hndls=[];var r=this._getImageBySourceId(this.sourceLayer.id);r&&this.imageLayer.removeImage(r),t.renderer!=e.renderer&&t.renderer.getRendererInfo?this.heatmapRenderer=null:(t.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(e){if(e&&e.geometry){var t=e.geometry,r=this.map.spatialReference,a=t.spatialReference;if(!r.equals(a)){var n=s.project(t,r);null==n?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):e.geometry=n}}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var e=this.sourceLayer,t=this.map,a=this.heatmapRenderer,n=this.map.extent,i=this.map.width,s=this.map.height,h=this._calculator,u=this,l=function(c){var l=u._getScreenPoints(c.features,t,e),d=h.calculateImageData(r.mixin({screenPoints:l,mapinfo:{extent:[n.xmin,n.ymin,n.xmax,n.ymax],resolution:t.getResolution()},width:i,height:s},u._getOptions())),g=a.getSymbol(m({geometry:t.extent,attributes:{size:[i,s],imageData:d},layer:e})),p=new o({extent:t.extent,href:g.url,opacity:0,sourceId:e.id});u._swapMapImages(p,u._getImageBySourceId(e.id)),e.suspended&&p.hide()},d={geometry:t.extent,timeExtent:e.useMapTime?t.timeExtent:void 0,spatialRelationship:c.SPATIAL_REL_INTERSECTS};null!=e._canDoClientSideQuery(d)?e.queryFeatures(d,l):l({features:e.graphics})},_getScreenPoints:function(e,t,r){var n,s,o,h=[],u=e.length,c=0,l=0,d=new i(t.extent.xmin,t.extent.ymax,t.spatialReference),m=t.toScreen(d),g=m.x,p=m.y,y=t.getResolution(),_=t.extent.getCacheValue("_parts");for(_&&(o=a.map(_,function(e){return r._intersects(t,e.extent)[0]}));u--;)n=e[u],n.geometry&&(s={x:Math.ceil((n.geometry.x-d.x)/y+g),y:Math.floor((d.y-n.geometry.y)/y-p),attributes:n.attributes},o&&(l=o.length>1&&s.x<-o[0]?o[1]:o[0],s.x+=l),h[c++]=s);return h},_getImageBySourceId:function(e){var t=this.imageLayer.getImages();return t=a.filter(t,function(t){return t.sourceId==e}),t.length?t[t.length-1]:void 0},_swapMapImages:function(e,t){function r(){a.removeImage(t)}var a=this.imageLayer,n=this.sourceLayer,i=n.opacity||1;a.addImage(e),l.anim(e._node,{opacity:i},null,null,function(){e.opacity=i}),null!=t&&l.anim(t._node,{opacity:0},null,null,r)},_removeHandlers:function(){if(null!=this._hndls)for(var e=this._hndls.length;e--;)this._hndls[e].remove()},_getOptions:function(){var e=this.heatmapRenderer;return{blurRadius:e.blurRadius,gradient:e.gradient,maxPixelIntensity:e.maxPixelIntensity,minPixelIntensity:e.minPixelIntensity,field:e.field,fieldOffset:e.fieldOffset}},_resetGraphics:function(){for(var e,t=this.sourceLayer.graphics,r=t.length;r--;)e=t[r],e._shape=e._offsets=void 0}});return g});