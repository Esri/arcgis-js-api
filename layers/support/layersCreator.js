/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/has","../../core/promiseUtils","../../core/Collection","../../portal/PortalItem","../../renderers/support/styleUtils","./lazyLayerLoader","../../portal/support/featureCollectionUtils","../../portal/support/portalLayers"],(function(e,a,r,y,t,i,L,o,l){"use strict";async function n(e,a,y){if(!a)return;const t=[];for(const r of a){const e=I(r,y);"GroupLayer"===r.layerType?t.push(m(e,r,y)):t.push(e)}const i=await r.eachAlways(t);for(const r of i)!r.value||y.filter&&!y.filter(r.value)||e.add(r.value)}const c={ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",PointCloudLayer:"PointCloudLayer",ArcGISSceneServiceLayer:"SceneLayer",IntegratedMeshLayer:"IntegratedMeshLayer",BuildingSceneLayer:"BuildingSceneLayer",ArcGISTiledElevationServiceLayer:"ElevationLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",GroupLayer:"GroupLayer",WebTiledLayer:"WebTileLayer",CSV:"CSVLayer",VectorTileLayer:"VectorTileLayer",WMS:"WMSLayer",DefaultTileLayer:"TileLayer",KML:"KMLLayer",RasterDataLayer:"UnsupportedLayer"},p={ArcGISTiledElevationServiceLayer:"ElevationLayer",DefaultTileLayer:"ElevationLayer",RasterDataElevationLayer:"UnsupportedLayer"},s={ArcGISTiledMapServiceLayer:"TileLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",OpenStreetMap:"OpenStreetMapLayer",WebTiledLayer:"WebTileLayer",VectorTileLayer:"VectorTileLayer",ArcGISImageServiceLayer:"UnsupportedLayer",WMS:"UnsupportedLayer",ArcGISMapServiceLayer:"UnsupportedLayer",DefaultTileLayer:"TileLayer"},u={ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISStreamLayer:"StreamLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",VectorTileLayer:"VectorTileLayer",GroupLayer:"GroupLayer",WebTiledLayer:"WebTileLayer",CSV:"CSVLayer",GeoRSS:"GeoRSSLayer",KML:"KMLLayer",WFS:"UnsupportedLayer",SubtypeGroupLayer:"UnsupportedLayer",WMS:"WMSLayer",BingMapsAerial:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",DefaultTileLayer:"TileLayer"},S={ArcGISFeatureLayer:"FeatureLayer"},d={ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",OpenStreetMap:"OpenStreetMapLayer",VectorTileLayer:"VectorTileLayer",WebTiledLayer:"WebTileLayer",BingMapsAerial:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",WMS:"WMSLayer",DefaultTileLayer:"TileLayer"};async function I(e,a){return M(await T(e,a),e,a)}async function M(e,a,r){const y=new e;return y.read(a,r.context),"group"===y.type&&g(a)&&await A(y,a,r.context),await i.loadStyleRenderer(y,r.context),y}async function T(e,a){const r=a.context,y=G(r);let i=e.layerType||e.type;!i&&a&&a.defaultLayerType&&(i=a.defaultLayerType);const n=y[i];let c=n?L.layerLookupMap[n]:L.layerLookupMap.UnknownLayer;const p=r&&r.portal;if(f(e)){if(e.itemId){const a=new t({id:e.itemId,portal:p});await a.load();const r=(await l.selectLayerClassPath(a)).className||"UnknownLayer";c=L.layerLookupMap[r]}}else"ArcGISFeatureLayer"===i&&(await o.isMapNotesLayer(e,p)?c=L.layerLookupMap.MapNotesLayer:await o.isRouteLayer(e,p)?c=L.layerLookupMap.RouteLayer:g(e)&&(c=L.layerLookupMap.GroupLayer));return e.wmtsInfo&&e.wmtsInfo.url&&e.wmtsInfo.layerIdentifier&&(c=L.layerLookupMap.WMTSLayer),c()}function g(e){if("ArcGISFeatureLayer"!==e.layerType||f(e))return!1;const a=e.featureCollection;return!!(a&&a.layers&&a.layers.length>1)}function f(e){return"Feature Collection"===e.type}function G(e){let a;switch(e.origin){case"web-scene":switch(e.layerContainerType){case"basemap":a=s;break;case"ground":a=p;break;default:a=c}break;default:switch(e.layerContainerType){case"basemap":a=d;break;case"tables":a=S;break;default:a=u}}return a}async function m(e,a,r){const t=new y,i=n(t,Array.isArray(a.layers)?a.layers:[],r),L=await e;if(await i,"group"===L.type)return L.layers.addMany(t),L}async function A(e,a,r){const y=L.layerLookupMap.FeatureLayer,t=await y(),i=a.featureCollection,o=i.showLegend,l=i.layers.map((e=>{const a=new t;return a.read(e,r),null!=o&&a.read({showLegend:o},r),a}));e.layers.addMany(l)}e.populateOperationalLayers=n,Object.defineProperty(e,"__esModule",{value:!0})}));
