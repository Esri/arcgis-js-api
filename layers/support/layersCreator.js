/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/has","../../core/promiseUtils","../../core/Collection","../../portal/PortalItem","../../renderers/support/styleUtils","./lazyLayerLoader","../../portal/support/featureCollectionUtils","../../portal/support/portalLayers"],(function(e,a,r,y,t,i,L,o,l){"use strict";async function n(e,a,y){if(!a)return;const t=[];for(const e of a){const a=I(e,y);"GroupLayer"===e.layerType?t.push(g(a,e,y)):t.push(a)}const i=await r.eachAlways(t);for(const a of i)!a.value||y.filter&&!y.filter(a.value)||e.add(a.value)}const c={ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",PointCloudLayer:"PointCloudLayer",ArcGISSceneServiceLayer:"SceneLayer",IntegratedMeshLayer:"IntegratedMeshLayer",BuildingSceneLayer:"BuildingSceneLayer",ArcGISTiledElevationServiceLayer:"ElevationLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",GroupLayer:"GroupLayer",WebTiledLayer:"WebTileLayer",CSV:"CSVLayer",VectorTileLayer:"VectorTileLayer",WMS:"WMSLayer",DefaultTileLayer:"TileLayer",KML:"KMLLayer",RasterDataLayer:"UnsupportedLayer"},p={ArcGISTiledElevationServiceLayer:"ElevationLayer",DefaultTileLayer:"ElevationLayer",RasterDataElevationLayer:"UnsupportedLayer"},s={ArcGISTiledMapServiceLayer:"TileLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",OpenStreetMap:"OpenStreetMapLayer",WebTiledLayer:"WebTileLayer",VectorTileLayer:"VectorTileLayer",ArcGISImageServiceLayer:"UnsupportedLayer",WMS:"UnsupportedLayer",ArcGISMapServiceLayer:"UnsupportedLayer",DefaultTileLayer:"TileLayer"},u={ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISStreamLayer:"StreamLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",VectorTileLayer:"VectorTileLayer",GroupLayer:"GroupLayer",WebTiledLayer:"WebTileLayer",CSV:"CSVLayer",GeoRSS:"GeoRSSLayer",KML:"KMLLayer",WFS:"UnsupportedLayer",SubtypeGroupLayer:"UnsupportedLayer",WMS:"WMSLayer",BingMapsAerial:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",DefaultTileLayer:"TileLayer"},S={ArcGISFeatureLayer:"FeatureLayer"},d={ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",OpenStreetMap:"OpenStreetMapLayer",VectorTileLayer:"VectorTileLayer",WebTiledLayer:"WebTileLayer",BingMapsAerial:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",WMS:"WMSLayer",DefaultTileLayer:"TileLayer"};async function I(e,a){return async function(e,a,r){const y=new e;y.read(a,r.context),"group"===y.type&&M(a)&&await async function(e,a,r){const y=L.layerLookupMap.FeatureLayer,t=await y(),i=a.featureCollection,o=i.showLegend,l=i.layers.map((e=>{const a=new t;return a.read(e,r),null!=o&&a.read({showLegend:o},r),a}));e.layers.addMany(l)}(y,a,r.context);return await i.loadStyleRenderer(y,r.context),y}(await async function(e,a){const r=a.context,y=function(e){let a;switch(e.origin){case"web-scene":switch(e.layerContainerType){case"basemap":a=s;break;case"ground":a=p;break;default:a=c}break;default:switch(e.layerContainerType){case"basemap":a=d;break;case"tables":a=S;break;default:a=u}}return a}(r);let i=e.layerType||e.type;!i&&a&&a.defaultLayerType&&(i=a.defaultLayerType);const n=y[i];let I=n?L.layerLookupMap[n]:L.layerLookupMap.UnknownLayer;const g=r&&r.portal;if(T(e)){if(e.itemId){const a=new t({id:e.itemId,portal:g});await a.load();const r=(await l.selectLayerClassPath(a)).className||"UnknownLayer";I=L.layerLookupMap[r]}}else"ArcGISFeatureLayer"===i&&(await o.isMapNotesLayer(e,g)?I=L.layerLookupMap.MapNotesLayer:await o.isRouteLayer(e,g)?I=L.layerLookupMap.RouteLayer:M(e)&&(I=L.layerLookupMap.GroupLayer));e.wmtsInfo&&e.wmtsInfo.url&&e.wmtsInfo.layerIdentifier&&(I=L.layerLookupMap.WMTSLayer);return I()}(e,a),e,a)}function M(e){if("ArcGISFeatureLayer"!==e.layerType||T(e))return!1;const a=e.featureCollection;return!!(a&&a.layers&&a.layers.length>1)}function T(e){return"Feature Collection"===e.type}async function g(e,a,r){const t=new y,i=n(t,Array.isArray(a.layers)?a.layers:[],r),L=await e;if(await i,"group"===L.type)return L.layers.addMany(t),L}e.populateOperationalLayers=n,Object.defineProperty(e,"__esModule",{value:!0})}));
