/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/asyncUtils","../../core/Error","../../core/maybe","../../core/promiseUtils","../../core/unitUtils","../../geometry/Multipoint","../../geometry/Point","../../geometry/Polyline","../../geometry/projection","../../geometry/support/aaBoundingRect","./ElevationSampler","./ElevationTile","./TileKey"],(function(e,t,n,i,o,l,s,r,a,c,u,f,p,h,y){"use strict";let d=function(){function e(){}var r=e.prototype;return r.queryAll=function(){var e=t._asyncToGenerator((function*(e,t,n){if(!(e=n&&n.ignoreInvisibleLayers?e.filter((e=>e.visible)):e.slice()).length)throw new i("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");const o=m.fromGeometry(t);let l=!1;n&&n.returnSampleInfo||(l=!0);const s={...w,...n,returnSampleInfo:!0},r=yield this.query(e[e.length-1],o,s),a=yield this._queryAllContinue(e,r,s);return a.geometry=a.geometry.export(),l&&delete a.sampleInfo,a}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r.query=function(){var e=t._asyncToGenerator((function*(e,t,n){if(!e)throw new i("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof m)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new i("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");const o={...w,...n},l=new _(e,t.spatialReference,o),s=o.signal;return yield e.load({signal:s}),yield this._createGeometryDescriptor(l,t,s),yield this._selectTiles(l,s),yield this._populateElevationTiles(l,s),this._sampleGeometryWithElevation(l),this._createQueryResult(l,s)}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r.createSampler=function(){var e=t._asyncToGenerator((function*(e,t,n){if(!e)throw new i("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new i("elevation-query:invalid-extent","Invalid or undefined extent");const o={...w,...n};return this._createSampler(e,t,o)}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r.createSamplerAll=function(){var e=t._asyncToGenerator((function*(e,t,n){if(!(e=n&&n.ignoreInvisibleLayers?e.filter((e=>e.visible)):e.slice()).length)throw new i("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new i("elevation-query:invalid-extent","Invalid or undefined extent");const o={...w,...n,returnSampleInfo:!0},l=yield this._createSampler(e[e.length-1],t,o);return this._createSamplerAllContinue(e,t,l,o)}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r._createSampler=function(){var e=t._asyncToGenerator((function*(e,t,n,i){const o=n.signal;yield e.load({signal:o});const l=t.spatialReference,s=e.tileInfo.spatialReference;l.equals(s)||(yield u.initializeProjection([{source:l,dest:s}],{signal:o}),t=u.project(t,s));const r=new g(e,t,n,i);return yield this._selectTiles(r,o),yield this._populateElevationTiles(r,o),new p.MultiTileElevationSampler(r.elevationTiles,r.layer.tileInfo,r.options.noDataValue)}));function n(t,n,i,o){return e.apply(this,arguments)}return n}(),r._createSamplerAllContinue=function(){var e=t._asyncToGenerator((function*(e,t,n,i){if(e.pop(),!e.length)return n;const o=n.samplers.map((e=>f.fromExtent(e.extent))),l=yield this._createSampler(e[e.length-1],t,i,o);if(0===l.samplers.length)return n;const s=n.samplers.concat(l.samplers),r=new p.MultiTileElevationSampler(s,i.noDataValue);return this._createSamplerAllContinue(e,t,r,i)}));function n(t,n,i,o){return e.apply(this,arguments)}return n}(),r._queryAllContinue=function(){var e=t._asyncToGenerator((function*(e,t,n){const i=e.pop(),l=t.geometry.coordinates,s=t.sampleInfo;o.assertIsSome(s);const r=[],a=[];for(let o=0;o<l.length;o++){const t=s[o];t.demResolution>=0?t.source||(t.source=i):e.length&&(r.push(l[o]),a.push(o))}if(!e.length||0===r.length)return t;const c=t.geometry.clone(r),u=yield this.query(e[e.length-1],c,n),f=u.sampleInfo;if(!f)throw new Error("no sampleInfo");return a.forEach(((e,t)=>{l[e].z=u.geometry.coordinates[t].z,s[e].demResolution=f[t].demResolution})),this._queryAllContinue(e,t,n)}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r._createQueryResult=function(){var e=t._asyncToGenerator((function*(e,t){const n=yield e.geometry.project(e.outSpatialReference,t);o.assertIsSome(n);const i={geometry:n.export(),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(i.sampleInfo=this._extractSampleInfo(e)),e.geometry.coordinates.forEach((e=>{e.tile=null,e.elevationTile=null})),i}));function n(t,n){return e.apply(this,arguments)}return n}(),r._createGeometryDescriptor=function(){var e=t._asyncToGenerator((function*(e,t,n){let o;const l=e.layer.tileInfo.spatialReference;if(t instanceof m?o=yield t.project(l,n):(yield u.initializeProjection([{source:t.spatialReference,dest:l}],{signal:n}),o=u.project(t,l)),!o)throw new i("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${t.spatialReference.wkid}' on an elevation service in '${l.wkid}'`);e.geometry=m.fromGeometry(o)}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r._selectTiles=function(){var e=t._asyncToGenerator((function*(e,t){const n=e.options.demResolution;if("geometry"===e.type&&this._preselectOutsideLayerExtent(e),"number"==typeof n)this._selectTilesClosestResolution(e);else if("finest-contiguous"===n)yield this._selectTilesFinestContiguous(e,t);else{if("auto"!==n)throw new i("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${n}', expected a number, "finest-contiguous" or "auto"`);yield this._selectTilesAuto(e,t)}}));function n(t,n){return e.apply(this,arguments)}return n}(),r._preselectOutsideLayerExtent=function(e){if(o.isNone(e.layer.fullExtent))return;const t=new h.ElevationTile(null);t.sample=()=>e.options.noDataValue,e.outsideExtentTile=t;const n=e.layer.fullExtent;e.geometry.coordinates.forEach((e=>{const i=e.x,o=e.y;(i<n.xmin||i>n.xmax||o<n.ymin||o>n.ymax)&&(e.elevationTile=t)}))},r._selectTilesClosestResolution=function(e){const t=e.layer.tileInfo,n=this._findNearestDemResolutionLODIndex(t,e.options.demResolution);e.selectTilesAtLOD(n)},r._findNearestDemResolutionLODIndex=function(e,t){const n=t/s.getMetersPerUnitForSR(e.spatialReference);let i=e.lods[0],o=0;for(let l=1;l<e.lods.length;l++){const t=e.lods[l];Math.abs(t.resolution-n)<Math.abs(i.resolution-n)&&(i=t,o=l)}return o},r._selectTilesFinestContiguous=function(){var e=t._asyncToGenerator((function*(e,t){const n=x(e.layer.tileInfo,e.options.minDemResolution);yield this._selectTilesFinestContiguousAt(e,n,t)}));function n(t,n){return e.apply(this,arguments)}return n}(),r._selectTilesFinestContiguousAt=function(){var e=t._asyncToGenerator((function*(e,t,n){const o=e.layer;if(e.selectTilesAtLOD(t),t<0)return;const s=o.tilemapCache,r=e.getTilesToFetch();try{if(s)yield l.whenOrAbort(Promise.all(r.map((e=>s.fetchAvailability(e.level,e.row,e.col,{signal:n})))),n);else if(yield this._populateElevationTiles(e,n),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new i("elevation-query:has-unavailable-tiles")}catch(a){l.throwIfAbortError(a),yield this._selectTilesFinestContiguousAt(e,t-1,n)}}));function n(t,n,i){return e.apply(this,arguments)}return n}(),r._populateElevationTiles=function(){var e=t._asyncToGenerator((function*(e,n){const i=e.getTilesToFetch(),s={},r=e.options.cache,a=e.options.noDataValue,c=i.map(function(){var i=t._asyncToGenerator((function*(t){if(null==t.id)return;const i=`${e.layer.uid}:${t.id}:${a}`,l=o.isSome(r)?r.get(i):null,c=o.isSome(l)?l:yield e.layer.fetchTile(t.level,t.row,t.col,{noDataValue:a,signal:n});o.isSome(r)&&r.put(i,c),s[t.id]=new h.ElevationTile(t,c)}));return function(e){return i.apply(this,arguments)}}());yield l.whenOrAbort(l.eachAlways(c),n),e.populateElevationTiles(s)}));function n(t,n){return e.apply(this,arguments)}return n}(),r._selectTilesAuto=function(){var e=t._asyncToGenerator((function*(e,i){this._selectTilesAutoFinest(e),this._reduceTilesForMaximumRequests(e);const o=e.layer.tilemapCache;if(!o)return this._selectTilesAutoPrefetchUpsample(e,i);const s=e.getTilesToFetch(),r={},a=s.map(function(){var e=t._asyncToGenerator((function*(e){const t=new y.TileKey(null,0,0,0,f.create()),s=yield n.result(o.fetchAvailabilityUpsample(e.level,e.row,e.col,t,{signal:i}));!1!==s.ok?null!=e.id&&(r[e.id]=t):l.throwIfAbortError(s.error)}));return function(t){return e.apply(this,arguments)}}());yield l.whenOrAbort(Promise.all(a),i),e.remapTiles(r)}));function i(t,n){return e.apply(this,arguments)}return i}(),r._reduceTilesForMaximumRequests=function(e){const t=e.layer.tileInfo;let n=0;const i={},o=e=>{null!=e.id&&(e.id in i?i[e.id]++:(i[e.id]=1,n++))},l=e=>{if(null==e.id)return;const t=i[e.id];1===t?(delete i[e.id],n--):i[e.id]=t-1};e.forEachTileToFetch(o,l);let s=!0;for(;s&&(s=!1,e.forEachTileToFetch((i=>{n<=e.options.maximumAutoTileRequests||(l(i),t.upsampleTile(i)&&(s=!0),o(i))}),l),s););},r._selectTilesAutoFinest=function(e){const t=x(e.layer.tileInfo,e.options.minDemResolution);e.selectTilesAtLOD(t,e.options.maximumAutoTileRequests)},r._selectTilesAutoPrefetchUpsample=function(){var e=t._asyncToGenerator((function*(e,t){const n=e.layer.tileInfo;yield this._populateElevationTiles(e,t);let i=!1;e.forEachTileToFetch(((e,t)=>{n.upsampleTile(e)?i=!0:t()})),i&&(yield this._selectTilesAutoPrefetchUpsample(e,t))}));function n(t,n){return e.apply(this,arguments)}return n}(),r._sampleGeometryWithElevation=function(e){e.geometry.coordinates.forEach((t=>{const n=t.elevationTile;let i=e.options.noDataValue;if(n){const e=n.sample(t.x,t.y);o.isSome(e)?i=e:t.elevationTile=null}t.z=i}))},r._extractSampleInfo=function(e){const t=e.layer.tileInfo,n=s.getMetersPerUnitForSR(t.spatialReference);return e.geometry.coordinates.map((i=>{let o=-1;if(i.elevationTile&&i.elevationTile!==e.outsideExtentTile){o=t.lodAt(i.elevationTile.tile.level).resolution*n}return{demResolution:o}}))},e}(),m=function(){function e(){}var n=e.prototype;return n.export=function(){return this._exporter(this.coordinates,this.spatialReference)},n.clone=function(t){const n=new e;return n.geometry=this.geometry,n.spatialReference=this.spatialReference,n.coordinates=t||this.coordinates.map((e=>e.clone())),n._exporter=this._exporter,n},n.project=function(){var e=t._asyncToGenerator((function*(e,t){if(this.spatialReference.equals(e))return this.clone();yield u.initializeProjection([{source:this.spatialReference,dest:e}],{signal:t});const n=new r({spatialReference:this.spatialReference,points:this.coordinates.map((e=>[e.x,e.y]))}),i=u.project(n,e);if(!i)return null;const o=this.coordinates.map(((e,t)=>{const n=e.clone(),o=i.points[t];return n.x=o[0],n.y=o[1],n})),l=this.clone(o);return l.spatialReference=e,l}));function n(t,n){return e.apply(this,arguments)}return n}(),e.fromGeometry=function(t){const n=new e;if(n.geometry=t,n.spatialReference=t.spatialReference,t instanceof e)n.coordinates=t.coordinates.map((e=>e.clone())),n._exporter=(e,n)=>{const i=t.clone(e);return i.spatialReference=n,i};else switch(t.type){case"point":{const e=t,{hasZ:i,hasM:o}=e;n.coordinates=i&&o?[new T(e.x,e.y,e.z,e.m)]:i?[new T(e.x,e.y,e.z)]:o?[new T(e.x,e.y,null,e.m)]:[new T(e.x,e.y)],n._exporter=(e,n)=>t.hasM?new a(e[0].x,e[0].y,e[0].z,e[0].m,n):new a(e[0].x,e[0].y,e[0].z,n);break}case"multipoint":{const e=t,{hasZ:i,hasM:o}=e;n.coordinates=i&&o?e.points.map((e=>new T(e[0],e[1],e[2],e[3]))):i?e.points.map((e=>new T(e[0],e[1],e[2]))):o?e.points.map((e=>new T(e[0],e[1],null,e[2]))):e.points.map((e=>new T(e[0],e[1]))),n._exporter=(e,n)=>t.hasM?new r({points:e.map((e=>[e.x,e.y,e.z,e.m])),hasZ:!0,hasM:!0,spatiaReference:n}):new r(e.map((e=>[e.x,e.y,e.z])),n);break}case"polyline":{const e=t,i=[],o=[],{hasZ:l,hasM:s}=t;let r=0;for(const t of e.paths)if(o.push([r,r+t.length]),r+=t.length,l&&s)for(const e of t)i.push(new T(e[0],e[1],e[2],e[3]));else if(l)for(const e of t)i.push(new T(e[0],e[1],e[2]));else if(s)for(const e of t)i.push(new T(e[0],e[1],null,e[2]));else for(const e of t)i.push(new T(e[0],e[1]));n.coordinates=i,n._exporter=(e,n)=>{const i=t.hasM?e.map((e=>[e.x,e.y,e.z,e.m])):e.map((e=>[e.x,e.y,e.z])),l=o.map((e=>i.slice(e[0],e[1])));return new c({paths:l,hasM:t.hasM,hasZ:!0,spatialReference:n})};break}}return n},e}(),T=function(){function e(e,t,n=null,i=null,o=null,l=null){this.x=e,this.y=t,this.z=n,this.m=i,this.tile=o,this.elevationTile=l}return e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.m)},e}(),v=function(e,t){this.layer=e,this.options=t},_=function(e){function n(t,n,i){var o;return(o=e.call(this,t,i)||this).outSpatialReference=n,o.type="geometry",o}t._inheritsLoose(n,e);var i=n.prototype;return i.selectTilesAtLOD=function(e){if(e<0)this.geometry.coordinates.forEach((e=>{e.tile=null}));else{const t=this.layer.tileInfo,n=t.lods[e].level;this.geometry.coordinates.forEach((e=>{e.tile=t.tileAt(n,e.x,e.y)}))}},i.allElevationTilesFetched=function(){return!this.geometry.coordinates.some((e=>!e.elevationTile))},i.clearElevationTiles=function(){for(const e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)},i.populateElevationTiles=function(e){for(const t of this.geometry.coordinates)!t.elevationTile&&t.tile?.id&&(t.elevationTile=e[t.tile.id])},i.remapTiles=function(e){for(const t of this.geometry.coordinates){const n=t.tile?.id;t.tile=n?e[n]:null}},i.getTilesToFetch=function(){const e={},t=[];for(const n of this.geometry.coordinates){const i=n.tile;if(!i)continue;const o=n.tile?.id;n.elevationTile||!o||e[o]||(e[o]=i,t.push(i))}return t},i.forEachTileToFetch=function(e){for(const t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,(()=>{t.tile=null}))},n}(v),g=function(e){function n(t,n,i,o){var l;return(l=e.call(this,t,i)||this).type="extent",l.elevationTiles=[],l._candidateTiles=[],l._fetchedCandidates=new Set,l.extent=n.intersection(t.fullExtent),l.maskExtents=o,l}t._inheritsLoose(n,e);var i=n.prototype;return i.selectTilesAtLOD=function(e,t){const n=this._maximumLodForRequests(t),i=Math.min(n,e);i<0?this._candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(i)},i._maximumLodForRequests=function(e){const t=this.layer.tileInfo;if(!e)return t.lods.length-1;const n=this.extent;if(o.isNone(n))return-1;for(let i=t.lods.length-1;i>=0;i--){const o=t.lods[i],l=o.resolution*t.size[0],s=o.resolution*t.size[1];if(Math.ceil(n.width/l)*Math.ceil(n.height/s)<=e)return i}return-1},i.allElevationTilesFetched=function(){return this._candidateTiles.length===this.elevationTiles.length},i.clearElevationTiles=function(){this.elevationTiles.length=0,this._fetchedCandidates.clear()},i.populateElevationTiles=function(e){for(const t of this._candidateTiles){const n=t.id&&e[t.id];n&&(this._fetchedCandidates.add(t),this.elevationTiles.push(n))}},i.remapTiles=function(e){this._candidateTiles=this._uniqueNonOverlappingTiles(this._candidateTiles.map((t=>e[t.id])))},i.getTilesToFetch=function(){return this._candidateTiles},i.forEachTileToFetch=function(e,t){const n=this._candidateTiles;this._candidateTiles=[],n.forEach((n=>{if(this._fetchedCandidates.has(n))return void(t&&t(n));let i=!1;e(n,(()=>i=!0)),i?t&&t(n):this._candidateTiles.push(n)})),this._candidateTiles=this._uniqueNonOverlappingTiles(this._candidateTiles,t)},i._uniqueNonOverlappingTiles=function(e,t){const n={},i=[];for(const l of e){const e=l.id;e&&!n[e]?(n[e]=l,i.push(l)):t&&t(l)}const o=i.sort(((e,t)=>e.level-t.level));return o.filter(((e,n)=>{for(let i=0;i<n;i++){const n=o[i].extent;if(n&&e.extent&&f.contains(n,e.extent))return t&&t(e),!1}return!0}))},i._selectCandidateTilesCoveringExtentAt=function(e){this._candidateTiles.length=0;const t=this.extent;if(o.isNone(t))return;const n=this.layer.tileInfo,i=n.lods[e],l=n.tileAt(i.level,t.xmin,t.ymin),s=l.extent;if(o.isNone(s))return;const r=i.resolution*n.size[0],a=i.resolution*n.size[1],c=Math.ceil((t.xmax-s[0])/r),u=Math.ceil((t.ymax-s[1])/a);for(let o=0;o<u;o++)for(let e=0;e<c;e++){const t=new y.TileKey(null,l.level,l.row-o,l.col+e);n.updateTileInfo(t),this._tileIsMasked(t)||this._candidateTiles.push(t)}},i._tileIsMasked=function(e){return!!this.maskExtents&&this.maskExtents.some((t=>e.extent&&f.contains(t,e.extent)))},n}(v);function x(e,t=0){let n=e.lods.length-1;if(t>0){const i=t/s.getMetersPerUnitForSR(e.spatialReference),o=e.lods.findIndex((e=>e.resolution<i));0===o?n=0:o>0&&(n=o-1)}return n}const w={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0};e.ElevationQuery=d,e.GeometryDescriptor=m,e.getFinestLodIndex=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
