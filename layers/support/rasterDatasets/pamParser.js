/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../geometry","../../../core/maybe","./xmlUtilities","../rasterTransforms/PolynomialTransform","../../../geometry/SpatialReference"],(function(e,t,n,a,r,s){"use strict";function l(e,t){if(!e||!t)return null;const n=[];for(let a=0;a<e.length;a++)n.push(e[a]),n.push(t[a]);return n}function i(e){const t=a.getElement(e,"GeodataXform"),n=o(a.getElementNumericValue(t,"SpatialReference/WKID")||a.getElementValue(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:n,transform:null};const s=a.getElementNumericValue(t,"PolynomialOrder")??1,i=a.getElementNumericValues(t,"CoeffX/Double"),u=a.getElementNumericValues(t,"CoeffY/Double"),m=a.getElementNumericValues(t,"InverseCoeffX/Double"),c=a.getElementNumericValues(t,"InverseCoeffY/Double"),f=l(i,u),g=l(m,c);return{spatialReference:n,transform:f&&g&&f.length&&g.length?new r({spatialReference:n,polynomialOrder:s,forwardCoefficients:f,inverseCoefficients:g}):null}}function u(e){const t=a.getElementNumericValue(e,"NoDataValue"),n=a.getElement(e,"Histograms/HistItem"),r=a.getElementNumericValue(n,"HistMin"),s=a.getElementNumericValue(n,"HistMax"),l=a.getElementNumericValue(n,"BucketCount"),i=a.getElementValue(n,"HistCounts")?.split("|").map((e=>Number(e)));let u,o,m,c;a.getElements(e,"Metadata/MDI").forEach((e=>{const t=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":u=t;break;case"STATISTICS_MAXIMUM":o=t;break;case"STATISTICS_MEAN":m=t;break;case"STATISTICS_STDDEV":c=t}}));const f=a.getElementNumericValue(e,"Metadata/SourceBandIndex");return{noDataValue:t,histogram:i?.length&&null!=r&&null!=s?{min:r,max:s,size:l||i.length,counts:i}:null,sourceBandIndex:f,statistics:null!=u&&null!=o?{min:u,max:o,avg:m,stddev:c}:null}}function o(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new s({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;const n=e.indexOf("VERTCS"),a=e.indexOf("PROJCS"),r=a>-1?a:e.indexOf("GEOGCS");if(-1===r)return null;const l=e.slice(r,e.lastIndexOf("]",n)+1).trim(),i=e.slice(n,e.lastIndexOf("]")).trim();t=m(l);const u=new s(t?{wkid:t}:{wkt:l}),o=m(i);return o&&(u.vcsWkid=o),u}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=m(e),new s(0!==t?{wkid:t}:{wkt:e})):null}function m(e){const t=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((e=>e.trim())).filter((e=>""!==e)),n=t[t.length-1].split(","),a=n[0]?.toLowerCase();if(("epsg"===a||"esri"===a)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}function c(e){if("pamdataset"!==e?.documentElement.tagName?.toLowerCase())return{};const t={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if(a.isSameTagIgnoreNS(e,"SRS")){if(!t.spatialReference){const n=a.getElementValue(e);t.spatialReference=o(n)}}else if(a.isSameTagIgnoreNS(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:n,transform:a}=i(e);t.transform=a,t.spatialReference||(t.spatialReference=n)}else{a.getElements(e,"MDI").forEach((e=>t.metadata[e.getAttribute("key")]=a.getElementValue(e)))}else if(a.isSameTagIgnoreNS(e,"PAMRasterBand")){const n=u(e);null!=n.sourceBandIndex&&null==t.rasterBands[n.sourceBandIndex]?t.rasterBands[n.sourceBandIndex]=n:t.rasterBands.push(n)}}));const r=t.rasterBands;if(r.length){const e=!!r[0].statistics;t.statistics=e?r.map((e=>e.statistics)).filter(n.isSome):null;const a=!!r[0].histogram;t.histograms=a?r.map((e=>e.histogram)).filter(n.isSome):null}return t}e.parsePAMInfo=c,e.parseSpatialReference=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
