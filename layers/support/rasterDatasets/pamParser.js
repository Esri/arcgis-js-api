/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../geometry/SpatialReference","../../../geometry","../rasterTransforms/PolynomialTransform","./xmlUtilities"],(function(e,t,n,a,l){"use strict";function r(e,t){if(!e||!t)return null;const n=[];for(let a=0;a<e.length;a++)n.push(e[a]),n.push(t[a]);return n}function s(e){var t;const n=l.getElement(e,"GeodataXform"),s=u(l.getElementNumericValue(n,"SpatialReference/WKID")||l.getElementValue(n,"SpatialReference/WKT"));if("typens:PolynomialXform"!==n.getAttribute("xsi:type"))return{spatialReference:s,transform:null};const i=null!=(t=l.getElementNumericValue(n,"PolynomialOrder"))?t:1,o=l.getElementNumericValues(n,"CoeffX/Double"),m=l.getElementNumericValues(n,"CoeffY/Double"),c=l.getElementNumericValues(n,"InverseCoeffX/Double"),f=l.getElementNumericValues(n,"InverseCoeffY/Double"),g=r(o,m),d=r(c,f);return{spatialReference:s,transform:new a({spatialReference:s,polynomialOrder:i,forwardCoefficients:g,inverseCoefficients:d})}}function i(e){var t;const n=l.getElementNumericValue(e,"NoDataValue"),a=l.getElement(e,"Histograms/HistItem"),r=l.getElementNumericValue(a,"HistMin"),s=l.getElementNumericValue(a,"HistMax"),i=l.getElementNumericValue(a,"BucketCount"),u=null==(t=l.getElementValue(a,"HistCounts"))?void 0:t.split("|").map((e=>Number(e)));let o,m,c,f;l.getElements(e,"Metadata/MDI").forEach((e=>{var t;const n=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":o=n;break;case"STATISTICS_MAXIMUM":m=n;break;case"STATISTICS_MEAN":c=n;break;case"STATISTICS_STDDEV":f=n}}));const g=l.getElementNumericValue(e,"Metadata/SourceBandIndex");return{noDataValue:n,histogram:null!=u&&u.length&&null!=o&&null!=m?{min:r,max:s,size:i||u.length,counts:u}:null,sourceBandIndex:g,statistics:null!=o&&null!=m?{min:o,max:m,avg:c,stddev:f}:null}}function u(e){if(!e)return null;let n=Number(e);if(!isNaN(n)&&0!==n)return new t({wkid:n});if(!(e=String(e)).startsWith("GEOGCS")&&!e.startsWith("PROJCS"))return null;const a=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((e=>e.trim())).filter((e=>""!==e)),l=a[a.length-1].split(",");return"EPSG"===l[0]&&e.endsWith('"]]')&&(n=Number(l[1]),!isNaN(n)&&0!==n)?new t({wkid:n}):new t({wkt:e})}function o(e){var t;if("pamdataset"!==(null==e||null==(t=e.documentElement.tagName)?void 0:t.toLowerCase()))return{};const n={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if(l.isSameTagIgnoreNS(e,"SRS")){if(!n.spatialReference){const t=l.getElementValue(e);n.spatialReference=u(t)}}else if(l.isSameTagIgnoreNS(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:a}=s(e);n.transform=a,n.spatialReference||(n.spatialReference=t)}else{l.getElements(e,"MDI").forEach((e=>n.metadata[e.getAttribute("key")]=l.getElementValue(e)))}else if(l.isSameTagIgnoreNS(e,"PAMRasterBand")){const t=i(e);null!=t.sourceBandIndex&&null==n.rasterBands[t.sourceBandIndex]?n.rasterBands[t.sourceBandIndex]=t:n.rasterBands.push(t)}}));const a=n.rasterBands;if(a){const e=!!a[0].statistics;n.statistics=e?a.map((e=>e.statistics)):null;const t=!!a[0].histogram;n.histograms=t?a.map((e=>e.histogram)):null}return n}e.parsePAMInfo=o,e.parseSpatialReference=u,Object.defineProperty(e,"__esModule",{value:!0})}));
