/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{isSameTagIgnoreNS as e,getElementValue as t,getElements as n,getElement as s,getElementNumericValue as r,getElementNumericValues as a}from"./xmlUtilities.js";import i from"../rasterTransforms/PolynomialTransform.js";import l from"../../../geometry/SpatialReference.js";function o(e,t){if(!e||!t)return null;const n=[];for(let s=0;s<e.length;s++)n.push(e[s]),n.push(t[s]);return n}function u(e){const n=s(e,"GeodataXform"),l=c(r(n,"SpatialReference/WKID")||t(n,"SpatialReference/WKT"));if("typens:PolynomialXform"!==n.getAttribute("xsi:type"))return{spatialReference:l,transform:null};const u=r(n,"PolynomialOrder")??1,f=a(n,"CoeffX/Double"),m=a(n,"CoeffY/Double"),d=a(n,"InverseCoeffX/Double"),p=a(n,"InverseCoeffY/Double"),S=o(f,m),C=o(d,p);return{spatialReference:l,transform:new i({spatialReference:l,polynomialOrder:u,forwardCoefficients:S,inverseCoefficients:C})}}function f(e){const a=r(e,"NoDataValue"),i=s(e,"Histograms/HistItem"),l=r(i,"HistMin"),o=r(i,"HistMax"),u=r(i,"BucketCount"),f=t(i,"HistCounts")?.split("|").map((e=>Number(e)));let c,m,d,p;n(e,"Metadata/MDI").forEach((e=>{const t=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":c=t;break;case"STATISTICS_MAXIMUM":m=t;break;case"STATISTICS_MEAN":d=t;break;case"STATISTICS_STDDEV":p=t}}));const S=r(e,"Metadata/SourceBandIndex");return{noDataValue:a,histogram:f?.length&&null!=c&&null!=m?{min:l,max:o,size:u||f.length,counts:f}:null,sourceBandIndex:S,statistics:null!=c&&null!=m?{min:c,max:m,avg:d,stddev:p}:null}}function c(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new l({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;const n=e.indexOf("VERTCS"),s=e.indexOf("PROJCS"),r=s>-1?s:e.indexOf("GEOGCS");if(-1===r)return null;const a=e.slice(r,e.lastIndexOf("]",n)+1).trim(),i=e.slice(n,e.lastIndexOf("]")).trim();t=m(a);const o=new l(t?{wkid:t}:{wkt:a}),u=m(i);return u&&(o.vcsWkid=u),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=m(e),new l(0!==t?{wkid:t}:{wkt:e})):null}function m(e){const t=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((e=>e.trim())).filter((e=>""!==e)),n=t[t.length-1].split(","),s=n[0]?.toLowerCase();if(("epsg"===s||"esri"===s)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}function d(s){if("pamdataset"!==s?.documentElement.tagName?.toLowerCase())return{};const r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};s.documentElement.childNodes.forEach((s=>{if(1===s.nodeType)if(e(s,"SRS")){if(!r.spatialReference){const e=t(s);r.spatialReference=c(e)}}else if(e(s,"Metadata"))if("xml:ESRI"===s.getAttribute("domain")){const{spatialReference:e,transform:t}=u(s);r.transform=t,r.spatialReference||(r.spatialReference=e)}else{n(s,"MDI").forEach((e=>r.metadata[e.getAttribute("key")]=t(e)))}else if(e(s,"PAMRasterBand")){const e=f(s);null!=e.sourceBandIndex&&null==r.rasterBands[e.sourceBandIndex]?r.rasterBands[e.sourceBandIndex]=e:r.rasterBands.push(e)}}));const a=r.rasterBands;if(a){const e=!!a[0].statistics;r.statistics=e?a.map((e=>e.statistics)):null;const t=!!a[0].histogram;r.histograms=t?a.map((e=>e.histogram)):null}return r}export{d as parsePAMInfo,c as parseSpatialReference};
