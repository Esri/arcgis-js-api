/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","./BaseRaster"],(function(e,r,t,s,o,a,n,i,c){"use strict";let p=function(r){function o(){var e;return(e=r.apply(this,arguments)||this).datasetFormat="Function",e.tileType="Raster",e.rasterFunction=null,e}e._inheritsLoose(o,r);var a=o.prototype;return a.open=function(){var r=e._asyncToGenerator((function*(e){yield this.init();const{rasterFunction:r}=this;this.primaryRasters?.rasters?.length?r.sourceRasters=this.primaryRasters.rasters:this.primaryRasters=r.getPrimaryRasters();const{rasters:s,rasterIds:o}=this.primaryRasters,a=s.map((r=>r.rasterInfo?void 0:r.open(e)));yield Promise.all(a);const n=s.map((({rasterInfo:e})=>e)),i=r.bind({rasterInfos:n,rasterIds:o});if(!i.success||0===n.length)throw new t("raster-function:open",`cannot bind the function: ${i.error??""}`);yield this.syncJobHandler();const c=n[0];this.hasUniqueSourceStorageInfo=1===n.length||n.slice(1).every((e=>this._hasSameStorageInfo(e,c))),this.set("sourceJSON",s[0].sourceJSON),this.set("rasterInfo",r.rasterInfo)}));function s(e){return r.apply(this,arguments)}return s}(),a.syncJobHandler=function(){var r=e._asyncToGenerator((function*(){return this.rasterJobHandler?.updateRasterFunction(this.rasterFunction)}));function t(){return r.apply(this,arguments)}return t}(),a.fetchPixels=function(){var r=e._asyncToGenerator((function*(e,r,t,o={}){const{rasters:a,rasterIds:n}=this.primaryRasters,i=a.map((s=>s.fetchPixels(e,r,t,o))),c=yield Promise.all(i),p=c.map((e=>e.pixelBlock));if(o.skipRasterFunction||p.every((e=>s.isNone(e))))return c[0];const l=c.find((e=>s.isSome(e.pixelBlock)))?.extent??e,u=this.rasterJobHandler?yield this.rasterJobHandler.process({extent:l,primaryPixelBlocks:p,primaryRasterIds:n}):this.rasterFunction.process({extent:l,primaryPixelBlocks:p,primaryRasterIds:n});return{...c[0],pixelBlock:u}}));function t(e,t,s){return r.apply(this,arguments)}return t}(),a._hasSameStorageInfo=function(e,r){const{storageInfo:t,pixelSize:s,spatialReference:o,extent:a}=e,{storageInfo:n,pixelSize:i,spatialReference:c,extent:p}=r;return s.x===i.x&&s.y===i.y&&o.equals(c)&&a.equals(p)&&t.blockHeight===n.blockHeight&&t.blockWidth===n.blockWidth&&t.maximumPyramidLevel===n.maximumPyramidLevel},o}(c);r.__decorate([o.property({type:String,json:{write:!0}})],p.prototype,"datasetFormat",void 0),r.__decorate([o.property()],p.prototype,"tileType",void 0),r.__decorate([o.property()],p.prototype,"rasterFunction",void 0),r.__decorate([o.property()],p.prototype,"primaryRasters",void 0),p=r.__decorate([i.subclass("esri.layers.support.rasterDatasets.FunctionRaster")],p);return p}));
