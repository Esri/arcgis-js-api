/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{isSome as e,isNone as n}from"../../../core/maybe.js";import t from"../DimensionalDefinition.js";function a(e,n,t){const r=n.shift();if(0===t.length){const e=[];t.push({sliceId:-1,multidimensionalDefinition:e})}const s=t.length;for(let a=0;a<s;a++){const n=t.shift().multidimensionalDefinition;r.values.forEach((a=>{t.push({sliceId:-1,multidimensionalDefinition:[...n,{variableName:e,dimensionName:r.name,values:[a]}]})}))}n.length&&a(e,n,t)}function r(e,n){const t=[];let r=0;return(n?e.variables.filter((e=>e.name.toLowerCase()===n.toLowerCase())):[...e.variables].sort(((e,n)=>e.name>n.name?1:-1))).forEach((e=>{const n=[],s=[...e.dimensions].sort(((e,n)=>e.name>n.name?-1:1));a(e.name,s,n),n.forEach((e=>{t.push({...e,sliceId:r++})}))})),t}function s(n,t,a){let r=n;if(t&&(t=[...t].sort(((e,n)=>e.dimensionName<n.dimensionName?-1:1))).forEach((({dimensionName:e,values:n,isSlice:t})=>{n.length&&(r=r.filter((a=>{const r=a.multidimensionalDefinition.find((n=>n.dimensionName===e));if(null==r)return!1;const s=r.values[0];return"number"==typeof s?"number"==typeof n[0]?n.includes(s):n.some((e=>e[0]<=s&&e[1]>=s)):"number"==typeof n[0]?n.some((e=>s[0]<=e&&s[1]>=e)):t?n.some((e=>e[0]===s[0]&&e[0]===s[1])):n.some((e=>e[0]>=s[0]&&e[0]<=s[1]||e[1]>=s[0]&&e[1]<=s[1]||e[0]<s[0]&&e[1]>s[1]))})))})),r.length&&a&&e(a.start)&&e(a.end)){const e=a.start.getTime(),n=a.end.getTime(),t=r[0].multidimensionalDefinition.findIndex((e=>"StdTime"===e.dimensionName));t>-1&&(r=r.filter((a=>{const r=a.multidimensionalDefinition[t].values[0];return e<=r&&n>=r})))}return r.map((e=>e.sliceId))}function i(e,a){const{multidimensionalInfo:r,keyProperties:s}=e;if(n(r))return null;const i=s?.DefaultVariable,{variables:o}=r,l=i?o.find((({name:e})=>e===i))??o[0]:o[0];return l.dimensions.map((e=>{const{values:n,extent:r}=e;let s=n?.[0]??r[0];return"stdz"===e.name.toLowerCase()&&!e.hasRanges&&Math.abs(r[1])<=Math.abs(r[0])&&(s=n?.length?e.values[n.length-1]:r[1]),new t({variableName:l.name,dimensionName:e.name,values:[s],isSlice:!a||!!e.hasRanges})}))}function o(e){return!(n(e)||!e.length)&&e.some((e=>{if(null==e.values)return!0;const n=e.values.length;return 0===n||n>1||!e.isSlice&&Array.isArray(e.values[0])}))}function l(e,n){const{values:t}=n;if(t?.length)return Array.isArray(t[0])!==Array.isArray(e)?-1:Array.isArray(t[0])?t.findIndex((n=>n[0]===e[0]&&n[1]===e[1])):t.indexOf(e);const{extent:a}=n;if(Array.isArray(e)||e<a[0]||e>a[1])return-1;const r=n.interval||1;if("ISO8601"!==n.unit)return Math.round((e-a[0])/r);const s=a[0];let i=-1;switch(n.intervalUnit?.toLowerCase()||"seconds"){case"seconds":i=Math.round((e-s)/1e3/r);break;case"minutes":i=Math.round((e-s)/6e4/r);break;case"hours":i=Math.round((e-s)/36e5/r);break;case"days":i=Math.round((e-s)/864e5/r);break;case"months":{const n=new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear(),t=new Date(s).getUTCMonth(),a=new Date(e).getUTCMonth();i=0===n?a-t:a+11-t+12*(n-1)}break;case"years":i=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/r);break;case"decades":i=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/r)}return i}function u(e){let n=e.values?.length;if(n)return n;const{extent:t,unit:a}=e,r=e.interval||1,s=t[1]-t[0];if("ISO8601"!==a)return Math.round(s/r);switch(e.intervalUnit?.toLowerCase()??"seconds"){case"seconds":n=Math.round(s/1e3/r);break;case"minutes":n=Math.round(s/6e4/r);break;case"hours":n=Math.round(s/36e5/r);break;case"days":n=Math.round(s/864e5/r);break;case"months":{const e=new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear(),a=new Date(t[1][0]).getUTCMonth(),r=new Date(t[1][1]).getUTCMonth();n=0===e?r-a+1:r+11-a+12*(e-1)+1}break;case"years":n=Math.round((new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear())/r);break;case"decades":n=Math.round((new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear())/10/r);break;default:n=0}return n}function m(e,n){let t=0;const a=e[0].variableName,r=[...n.variables].sort(((e,n)=>e.name>n.name?1:-1));for(let s=0;s<r.length;s++){const n=r[s],i=[...n.dimensions].sort(((e,n)=>e.name>n.name?-1:1));if(n.name!==a){t+=i.map((e=>u(e))).reduce(((e,n)=>e*n));continue}const o=i.map((e=>u(e))),m=i.length;for(let a=0;a<m;a++){const n=e.find((e=>e.dimensionName===i[a].name));if(null==n)return null;const r=l(n.values[0],i[a]);if(-1===r)return null;o.shift(),t+=a===m-1?r:r*o.reduce(((e,n)=>e*n))}break}return t}export{r as createSlices,i as getDefaultMultidimensionalDefinition,s as getSliceIds,m as getSliceIndex,o as isMultiSliceOrRangeDefinition};
