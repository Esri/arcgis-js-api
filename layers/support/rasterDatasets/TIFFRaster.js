// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","./BaseRaster","../rasterFormats/TiffDecoder","../rasterFormats/TiffTags"],(function(e,t,r,i,a,n,s,o,l,u,f,d){"use strict";var h=function(e,t){var r=e.get(t);return r&&r.values},c=function(e,t){var r=e.get(t);return r&&r.values[0]};return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._files=null,t._headerInfo=null,t._bufferSize=1048576,t.datasetFormat="TIFF",t}return r.__extends(t,e),t.prototype.open=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,s,u,d,h,c,p,y,m,I,g,_,T,v,b,F,w,x,S,E,B,D,k,R,L,O,z;return r.__generator(this,(function(H){switch(H.label){case 0:return[4,this.init()];case 1:return H.sent(),t=e?n.unwrap(e.signal):null,[4,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:t})];case 2:if(!(s=H.sent().data))throw new a("tiffraster:open","failed to open url "+this.url);return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),u=f.parseSignature(s),d=u.littleEndian,h=u.firstIFD,c=[],[4,this.readIFDs(c,s,d,h,0,4,t)];case 3:if(H.sent(),p=f.getImageInfo(c),y=p.width,m=p.height,I=p.tileWidth,g=p.tileHeight,_=p.planes,T=p.pixelType,v=p.compression,b=p.firstPyramidLevel,F=p.maximumPyramidLevel,w=p.pyramidBlockWidth,x=p.pyramidBlockHeight,S=p.tileBoundary,E=p.metadata,B=i.Extent.fromJSON(p.extent),D=B.spatialReference,k=B?new i.Point({x:B.xmin,y:B.ymax,spatialReference:D}):new i.Point({x:0,y:0}),R=new l({blockWidth:I,blockHeight:g,pyramidBlockWidth:w,pyramidBlockHeight:x,compression:v,origin:k,firstPyramidLevel:b,maximumPyramidLevel:F,blockBoundary:S}),L=new i.Point({x:(B.xmax-B.xmin)/y,y:(B.ymax-B.ymin)/m,spatialReference:D}),O=E?{BandProperties:E.bandProperties,DataType:E.dataType}:{},z=new o({width:y,height:m,bandCount:_,pixelType:T,compression:v,pixelSize:L,storageInfo:R,spatialReference:D,keyProperties:O,extent:B,statistics:E?E.statistics:null}),this._set("rasterInfo",z),this._headerInfo=r.__assign({littleEndian:d,ifds:c},p),!this._headerInfo.isSupported)throw new a("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);return this.updateTileInfo(),[2]}}))}))},t.prototype.fetchRawTile=function(e,t,i,a){return void 0===a&&(a={}),r.__awaiter(this,void 0,void 0,(function(){var n,s,o,l,u,f,d,h,c,p,y,m,I,g,_;return r.__generator(this,(function(r){switch(r.label){case 0:return!this._headerInfo&&this._headerInfo.isSupported?[2,null]:(n=this.rasterInfo.storageInfo.blockBoundary,s=e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,o=e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight,!(l=n[e])||l.maxRow<t||l.maxCol<i||l.minRow>t||l.minCol>i?[2,null]:(u=this.getTileLocation(e,t,i))?(f=u.range,d=u.actualTileWidth,h=u.actualTileHeight,c=u.ifd,[4,this.request(this.url,{range:f,responseType:"array-buffer",signal:a.signal})]):[2,null]);case 1:return p=r.sent().data,[4,this.decodePixelBlock(p,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:c,offset:0,size:0},width:s,height:o,planes:null,pixelType:null})];case 2:if(y=r.sent(),d!==s||h!==o)if(_=y.mask)for(m=0;m<o;m++)if(g=m*s,m<h)for(I=d;I<s;I++)_[g+I]=0;else for(I=0;I<s;I++)_[g+I]=0;else for(_=new Uint8Array(s*o),y.mask=_,m=0;m<h;m++)for(g=m*s,I=0;I<d;I++)_[g+I]=1;return[2,y]}}))}))},t.prototype.readIFDs=function(e,t,i,a,n,s,o){return void 0===s&&(s=4),r.__awaiter(this,void 0,void 0,(function(){var l,u;return r.__generator(this,(function(r){switch(r.label){case 0:return a?a>=t.byteLength||a<0?[4,this.request(this.url,{range:{from:a+n,to:a+n+this._bufferSize},responseType:"array-buffer",signal:o})]:[3,2]:[2,null];case 1:l=r.sent(),t=l.data,n=a+n,a=0,r.label=2;case 2:return[4,this.readIFD(t,i,a,n,d.TIFF_TAGS,s,o)];case 3:return u=r.sent(),e.push(u.ifd),u.nextIFD?[4,this.readIFDs(e,t,i,u.nextIFD-n,n,s,o)]:[2,null];case 4:return r.sent(),[2]}}))}))},t.prototype.readIFD=function(e,t,i,a,n,s,o){return void 0===n&&(n=d.TIFF_TAGS),void 0===s&&(s=4),r.__awaiter(this,void 0,void 0,(function(){var l,u,h,c,p,y,m,I,g,_;return r.__generator(this,(function(r){switch(r.label){case 0:return e?(l=f.parseIFD(e,t,i,a,n,s)).success?(u=[],l.ifd.forEach((function(e){e.values||u.push(e)})),u.length>0?(h=u.map((function(e){return e.offlineOffsetSize})),c=Math.min.apply(null,h.map((function(e){return e[0]}))),Math.min.apply(null,h.map((function(e){return e[0]+e[1]})))-c<=this._bufferSize?[4,this.request(this.url,{range:{from:c,to:c+this._bufferSize},responseType:"array-buffer",signal:o})]:[3,2]):[3,2]):[3,5]:[2,null];case 1:p=r.sent().data,e=p,a=c,u.forEach((function(r){return f.parseFieldValues(e,t,r,a)})),r.label=2;case 2:return l.ifd.has("GEOKEYDIRECTORY")?(y=l.ifd.get("GEOKEYDIRECTORY"),(m=y.values)&&m.length>4?(I=m[0]+"."+m[1]+"."+m[2],[4,this.readIFD(e,t,y.valueOffset+6-a,a,d.GEO_KEYS,2,o)]):[3,4]):[3,4];case 3:g=r.sent(),y.data=g.ifd,y.data&&y.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[I]}),r.label=4;case 4:return[2,l];case 5:return l.requiredBufferSize&&l.requiredBufferSize!==e.byteLength?[4,this.request(this.url,{range:{from:a,to:a+l.requiredBufferSize+4},responseType:"array-buffer",signal:o})]:[3,7];case 6:return _=r.sent(),(e=_.data).byteLength<l.requiredBufferSize?[2,null]:[2,this.readIFD(e,t,0,a,d.TIFF_TAGS,4,o)];case 7:return[2]}}))}))},t.prototype.getTileLocation=function(e,t,r){var i=this.rasterInfo.storageInfo,a=i.firstPyramidLevel,n=i.blockBoundary,s=0===e?0:e-(a-1),o=this._headerInfo.ifds[s];if(!o)return null;var l=h(o,"TILEOFFSETS");if(void 0===l)return null;var u=h(o,"TILEBYTECOUNTS"),f=n[s],d=f.minRow,p=f.minCol,y=f.maxRow,m=f.maxCol;if(t>y||r>m||t<d||r<p)return null;var I=c(o,"IMAGEWIDTH"),g=c(o,"IMAGELENGTH"),_=c(o,"TILEWIDTH"),T=c(o,"TILELENGTH"),v=t*(m+1)+r,b=l[v],F=u[v];return null==b||null==F?null:{range:{from:b,to:b+F-1},ifd:o,actualTileWidth:r===m?I%_:_,actualTileHeight:t===y?g%T:T}},r.__decorate([s.property()],t.prototype,"_files",void 0),r.__decorate([s.property()],t.prototype,"_headerInfo",void 0),r.__decorate([s.property()],t.prototype,"_bufferSize",void 0),r.__decorate([s.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=r.__decorate([s.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],t)}(u)}));