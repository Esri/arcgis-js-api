/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../RasterInfo","../RasterStorageInfo","./BaseRaster","./pamParser","../rasterFormats/TiffDecoder","../rasterFormats/TiffTags","../rasterFunctions/pixelUtils","../rasterTransforms/PolynomialTransform","../../../geometry/SpatialReference","../../../geometry/Extent","../../../geometry/Point"],(function(e,t,r,i,n,a,s,o,l,f,u,c,p,d,h,y,m,g,x,T,_){"use strict";const I=function(e,t){const r=e.get(t);return r&&r.values},v=function(e,t){const r=e.get(t);return r&&r.values[0]};let S=function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}e._inheritsLoose(r,t);var a=r.prototype;return a.open=function(){var t=e._asyncToGenerator((function*(e){var t,r,a;yield this.init();const s=e?n.unwrap(e.signal):null,{data:o}=yield this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:s});if(!o)throw new i("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const{littleEndian:l,firstIFD:f,isBigTiff:p}=h.parseSignature(o),y=[];yield this._readIFDs(y,o,l,f,0,p?8:4,s);const I=h.getImageInfo(y),{width:v,height:S,tileWidth:b,tileHeight:w,planes:F,pixelType:E,compression:R,firstPyramidLevel:k,maximumPyramidLevel:B,pyramidBlockWidth:D,pyramidBlockHeight:L,tileBoundary:G,affine:P,metadata:z}=I,O=(null==(t=I.extent.spatialReference)?void 0:t.wkt)||(null==(r=I.extent.spatialReference)?void 0:r.wkid);let H=d.parseSpatialReference(O),A=!1;null==H&&(A=!0,H=new x({wkid:3857}));const C=new T({...I.extent,spatialReference:H}),q=new _(C?{x:C.xmin,y:C.ymax,spatialReference:H}:{x:0,y:0}),W=new c({blockWidth:b,blockHeight:w,pyramidBlockWidth:D,pyramidBlockHeight:L,compression:R,origin:q,firstPyramidLevel:k,maximumPyramidLevel:B,blockBoundary:G}),U=new _({x:(C.xmax-C.xmin)/v,y:(C.ymax-C.ymin)/S,spatialReference:H}),Y=z?{BandProperties:z.bandProperties,DataType:z.dataType}:{},M=new u({width:v,height:S,bandCount:F,pixelType:E,compression:R,pixelSize:U,storageInfo:W,spatialReference:H,isPseudoSpatialReference:A,keyProperties:Y,extent:C,statistics:z?z.statistics:null});if(null!=P&&P.length&&(M.nativeExtent=new T({xmin:-.5,ymin:.5-S,xmax:v-.5,ymax:.5,spatialReference:H}),M.transform=new g({polynomialOrder:1,forwardCoefficients:[P[2]+P[0]/2,P[5]-P[3]/2,P[0],P[3],-P[1],-P[4]]}),M.extent=M.transform.forwardTransform(M.nativeExtent),M.pixelSize=new _({x:(C.xmax-C.xmin)/v,y:(C.ymax-C.ymin)/S,spatialReference:H}),W.origin.x=-.5,W.origin.y=.5),null==(a=this.ioConfig.skipExtensions)||!a.includes("aux.xml")){const t=yield this._fetchAuxiliaryData(e);if(null!=t){var N;if(M.statistics=null!=(N=t.statistics)?N:M.statistics,M.histograms=t.histograms,t.histograms&&!n.isSome(M.statistics)&&(M.statistics=m.estimateStatisticsFromHistograms(t.histograms)),t.transform&&!P){M.transform=t.transform,M.nativeExtent=M.extent;const e=M.transform.forwardTransform(M.nativeExtent);M.pixelSize=new _({x:(e.xmax-e.xmin)/v,y:(e.ymax-e.ymin)/S,spatialReference:H}),M.extent=e}M.spatialReference||(M.spatialReference=t.spatialReference)}}if(this._set("rasterInfo",M),this._headerInfo={littleEndian:l,isBigTiff:p,ifds:y,...I},!this._headerInfo.isSupported)throw new i("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);this.updateTileInfo()}));function r(e){return t.apply(this,arguments)}return r}(),a.fetchRawTile=function(){var t=e._asyncToGenerator((function*(e,t,r,i={}){var n;if(null==(n=this._headerInfo)||!n.isSupported||this.isBlockOutside(e,t,r))return null;const a=this._getTileLocation(e,t,r);if(!a)return null;const{ranges:s,actualTileWidth:o,actualTileHeight:l,ifd:f}=a,u=s.map((e=>this.request(this.url,{range:e,responseType:"array-buffer",signal:i.signal}))),c=yield Promise.all(u),p=c.map((e=>e.data.byteLength)).reduce(((e,t)=>e+t)),d=1===c.length?c[0].data:new ArrayBuffer(p),h=[0],y=[0];if(c.length>1){const e=new Uint8Array(d);for(let t=0,r=0;t<c.length;t++){const i=c[t].data;e.set(new Uint8Array(i),r),h[t]=r,r+=i.byteLength,y[t]=i.byteLength}}const{blockWidth:m,blockHeight:g}=this.getBlockWidthHeight(e),x=yield this.decodePixelBlock(d,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:h,sizes:y},width:m,height:g,planes:null,pixelType:null});let T,_,I;if(o!==m||l!==g){let e=x.mask;if(e)for(T=0;T<g;T++)if(I=T*m,T<l)for(_=o;_<m;_++)e[I+_]=0;else for(_=0;_<m;_++)e[I+_]=0;else for(e=new Uint8Array(m*g),x.mask=e,T=0;T<l;T++)for(I=T*m,_=0;_<o;_++)e[I+_]=1}return x}));function r(e,r,i){return t.apply(this,arguments)}return r}(),a._readIFDs=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,a=4,s){if(!i)return null;if(i>=t.byteLength||i<0){t=(yield this.request(this.url,{range:{from:i+n,to:i+n+this._bufferSize},responseType:"array-buffer",signal:s})).data,n=i+n,i=0}const o=yield this._readIFD(t,r,i,n,y.TIFF_TAGS,a,s);if(e.push(o.ifd),!o.nextIFD)return null;yield this._readIFDs(e,t,r,o.nextIFD-n,n,a,s)}));function r(e,r,i,n,a){return t.apply(this,arguments)}return r}(),a._readIFD=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n=y.TIFF_TAGS,a=4,s){if(!e)return null;const o=h.parseIFD(e,t,r,i,n,a);if(o.success){const r=[];if(o.ifd.forEach((e=>{e.values||r.push(e)})),r.length>0){const n=r.map((e=>e.offlineOffsetSize)),a=Math.min.apply(null,n.map((e=>e[0])));if(Math.min.apply(null,n.map((e=>e[0]+e[1])))-a<=this._bufferSize){const{data:n}=yield this.request(this.url,{range:{from:a,to:a+this._bufferSize},responseType:"array-buffer",signal:s});e=n,i=a,r.forEach((r=>h.parseFieldValues(e,t,r,i)))}}if(o.ifd.has("GEOKEYDIRECTORY")){const r=o.ifd.get("GEOKEYDIRECTORY"),n=r.values;if(n&&n.length>4){const a=n[0]+"."+n[1]+"."+n[2],o=yield this._readIFD(e,t,r.valueOffset+6-i,i,y.GEO_KEYS,2,s);r.data=o.ifd,r.data&&r.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[a]})}}return o}if(o.requiredBufferSize&&o.requiredBufferSize!==e.byteLength){const r=yield this.request(this.url,{range:{from:i,to:i+o.requiredBufferSize+4},responseType:"array-buffer",signal:s});return(e=r.data).byteLength<o.requiredBufferSize?null:this._readIFD(e,t,0,i,y.TIFF_TAGS,4,s)}}));function r(e,r,i,n){return t.apply(this,arguments)}return r}(),a._getTileLocation=function(e,t,r){const{firstPyramidLevel:i,blockBoundary:n}=this.rasterInfo.storageInfo,a=0===e?0:e-(i-1),s=this._headerInfo.ifds[a];if(!s)return null;const o=h.isBSQConfig(s,this._headerInfo),l=I(s,"TILEOFFSETS");if(void 0===l)return null;const f=I(s,"TILEBYTECOUNTS"),{minRow:u,minCol:c,maxRow:p,maxCol:d}=n[a];if(t>p||r>d||t<u||r<c)return null;const y=v(s,"IMAGEWIDTH"),m=v(s,"IMAGELENGTH"),g=v(s,"TILEWIDTH"),x=v(s,"TILELENGTH"),T=o?this.rasterInfo.bandCount:1,_=T*t*(d+1)+r,S=[{from:l[_],to:l[_+T-1]+f[_+T-1]-1}];if(o){let e=!0;for(let t=0;t<T;t++)if(l[_+t]+f[_+t]!==l[_+t+1]){e=!1;break}if(!e)for(let t=0;t<T;t++)S[t]={from:l[_+t],to:l[_+t]+f[_+t]-1}}const b=l[_],w=f[_];if(null==b||null==w)return null;return{ranges:S,ifd:s,actualTileWidth:r===d?y%g:g,actualTileHeight:t===p?m%x:x}},a._fetchAuxiliaryData=function(){var t=e._asyncToGenerator((function*(e){try{const{data:t}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return d.parsePAMInfo(t)}catch{return null}}));function r(e){return t.apply(this,arguments)}return r}(),r}(p);t.__decorate([a.property()],S.prototype,"_files",void 0),t.__decorate([a.property()],S.prototype,"_headerInfo",void 0),t.__decorate([a.property()],S.prototype,"_bufferSize",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],S.prototype,"datasetFormat",void 0),S=t.__decorate([f.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],S);return S}));
