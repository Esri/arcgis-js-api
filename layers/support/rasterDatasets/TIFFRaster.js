/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../RasterInfo","../RasterStorageInfo","./BaseRaster","./pamParser","../../../chunks/TiffDecoder","../rasterFormats/TiffTags","../rasterFunctions/pixelUtils","../rasterTransforms/PolynomialTransform","../../../geometry/SpatialReference","../../../geometry/Extent","../../../geometry/Point"],(function(e,t,r,i,n,a,s,o,l,f,u,c,p,d,h,y,m,g,x,T,I){"use strict";const _=function(e,t){const r=e.get(t);return r&&r.values},v=function(e,t){const r=e.get(t);return r&&r.values[0]};let S=function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}e._inheritsLoose(r,t);var a=r.prototype;return a.open=function(){var t=e._asyncToGenerator((function*(e){var t,r,a;yield this.init();const s=e?n.unwrap(e.signal):null,{data:o}=yield this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:s});if(!o)throw new i("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const{littleEndian:l,firstIFD:f,isBigTiff:p}=h.parseSignature(o),y=[];yield this.readIFDs(y,o,l,f,0,p?8:4,s);const _=h.getImageInfo(y),{width:v,height:S,tileWidth:b,tileHeight:w,planes:F,pixelType:E,compression:R,firstPyramidLevel:k,maximumPyramidLevel:B,pyramidBlockWidth:L,pyramidBlockHeight:D,tileBoundary:G,affine:P,metadata:z}=_,O=(null==(t=_.extent.spatialReference)?void 0:t.wkt)||(null==(r=_.extent.spatialReference)?void 0:r.wkid);let H=d.parseSpatialReference(O),A=!1;null==H&&(A=!0,H=new x({wkid:3857}));const C=new T({..._.extent,spatialReference:H}),q=new I(C?{x:C.xmin,y:C.ymax,spatialReference:H}:{x:0,y:0}),W=new c({blockWidth:b,blockHeight:w,pyramidBlockWidth:L,pyramidBlockHeight:D,compression:R,origin:q,firstPyramidLevel:k,maximumPyramidLevel:B,blockBoundary:G}),Y=new I({x:(C.xmax-C.xmin)/v,y:(C.ymax-C.ymin)/S,spatialReference:H}),M=z?{BandProperties:z.bandProperties,DataType:z.dataType}:{},U=new u({width:v,height:S,bandCount:F,pixelType:E,compression:R,pixelSize:Y,storageInfo:W,spatialReference:H,isPseudoSpatialReference:A,keyProperties:M,extent:C,statistics:z?z.statistics:null});if(null!=P&&P.length&&(U.nativeExtent=new T({xmin:-.5,ymin:.5-S,xmax:v-.5,ymax:.5,spatialReference:H}),U.transform=new g({polynomialOrder:1,forwardCoefficients:[P[2]+P[0]/2,P[5]-P[3]/2,P[0],P[3],-P[1],-P[4]]}),U.extent=U.transform.forwardTransform(U.nativeExtent),U.pixelSize=new I({x:(C.xmax-C.xmin)/v,y:(C.ymax-C.ymin)/S,spatialReference:H}),W.origin.x=-.5,W.origin.y=.5),null==(a=this.ioConfig.skipExtensions)||!a.includes("aux.xml")){const t=yield this._fetchAuxiliaryData(e);if(null!=t){var N;if(U.statistics=null!=(N=t.statistics)?N:U.statistics,U.histograms=t.histograms,t.histograms&&!n.isSome(U.statistics)&&(U.statistics=m.estimateStatisticsFromHistograms(t.histograms)),t.transform&&!P){U.transform=t.transform,U.nativeExtent=U.extent;const e=U.transform.forwardTransform(U.nativeExtent);U.pixelSize=new I({x:(e.xmax-e.xmin)/v,y:(e.ymax-e.ymin)/S,spatialReference:H}),U.extent=e}U.spatialReference||(U.spatialReference=t.spatialReference)}}if(this._set("rasterInfo",U),this._headerInfo={littleEndian:l,isBigTiff:p,ifds:y,..._},!this._headerInfo.isSupported)throw new i("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);this.updateTileInfo()}));function r(e){return t.apply(this,arguments)}return r}(),a.fetchRawTile=function(){var t=e._asyncToGenerator((function*(e,t,r,i={}){var n;if(null==(n=this._headerInfo)||!n.isSupported||this.isBlockOutside(e,t,r))return null;const a=this.getTileLocation(e,t,r);if(!a)return null;const{ranges:s,actualTileWidth:o,actualTileHeight:l,ifd:f}=a,u=s.map((e=>this.request(this.url,{range:e,responseType:"array-buffer",signal:i.signal}))),c=yield Promise.all(u),p=c.map((e=>e.data.byteLength)).reduce(((e,t)=>e+t)),d=1===c.length?c[0].data:new ArrayBuffer(p),h=[0],y=[0];if(c.length>1){const e=new Uint8Array(d);for(let t=0,r=0;t<c.length;t++){const i=c[t].data;e.set(new Uint8Array(i),r),h[t]=r,r+=i.byteLength,y[t]=i.byteLength}}const{blockWidth:m,blockHeight:g}=this.getBlockWidthHeight(e),x=yield this.decodePixelBlock(d,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:h,sizes:y},width:m,height:g,planes:null,pixelType:null});let T,I,_;if(o!==m||l!==g){let e=x.mask;if(e)for(T=0;T<g;T++)if(_=T*m,T<l)for(I=o;I<m;I++)e[_+I]=0;else for(I=0;I<m;I++)e[_+I]=0;else for(e=new Uint8Array(m*g),x.mask=e,T=0;T<l;T++)for(_=T*m,I=0;I<o;I++)e[_+I]=1}return x}));function r(e,r,i){return t.apply(this,arguments)}return r}(),a.readIFDs=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n,a=4,s){if(!i)return null;if(i>=t.byteLength||i<0){t=(yield this.request(this.url,{range:{from:i+n,to:i+n+this._bufferSize},responseType:"array-buffer",signal:s})).data,n=i+n,i=0}const o=yield this.readIFD(t,r,i,n,y.TIFF_TAGS,a,s);if(e.push(o.ifd),!o.nextIFD)return null;yield this.readIFDs(e,t,r,o.nextIFD-n,n,a,s)}));function r(e,r,i,n,a){return t.apply(this,arguments)}return r}(),a.readIFD=function(){var t=e._asyncToGenerator((function*(e,t,r,i,n=y.TIFF_TAGS,a=4,s){if(!e)return null;const o=h.parseIFD(e,t,r,i,n,a);if(o.success){const r=[];if(o.ifd.forEach((e=>{e.values||r.push(e)})),r.length>0){const n=r.map((e=>e.offlineOffsetSize)),a=Math.min.apply(null,n.map((e=>e[0])));if(Math.min.apply(null,n.map((e=>e[0]+e[1])))-a<=this._bufferSize){const{data:n}=yield this.request(this.url,{range:{from:a,to:a+this._bufferSize},responseType:"array-buffer",signal:s});e=n,i=a,r.forEach((r=>h.parseFieldValues(e,t,r,i)))}}if(o.ifd.has("GEOKEYDIRECTORY")){const r=o.ifd.get("GEOKEYDIRECTORY"),n=r.values;if(n&&n.length>4){const a=n[0]+"."+n[1]+"."+n[2],o=yield this.readIFD(e,t,r.valueOffset+6-i,i,y.GEO_KEYS,2,s);r.data=o.ifd,r.data&&r.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[a]})}}return o}if(o.requiredBufferSize&&o.requiredBufferSize!==e.byteLength){const r=yield this.request(this.url,{range:{from:i,to:i+o.requiredBufferSize+4},responseType:"array-buffer",signal:s});return(e=r.data).byteLength<o.requiredBufferSize?null:this.readIFD(e,t,0,i,y.TIFF_TAGS,4,s)}}));function r(e,r,i,n){return t.apply(this,arguments)}return r}(),a.getTileLocation=function(e,t,r){const{firstPyramidLevel:i,blockBoundary:n}=this.rasterInfo.storageInfo,a=0===e?0:e-(i-1),s=this._headerInfo.ifds[a];if(!s)return null;const o=h.isBSQConfig(s,this._headerInfo),l=_(s,"TILEOFFSETS");if(void 0===l)return null;const f=_(s,"TILEBYTECOUNTS"),{minRow:u,minCol:c,maxRow:p,maxCol:d}=n[a];if(t>p||r>d||t<u||r<c)return null;const y=v(s,"IMAGEWIDTH"),m=v(s,"IMAGELENGTH"),g=v(s,"TILEWIDTH"),x=v(s,"TILELENGTH"),T=o?this.rasterInfo.bandCount:1,I=T*t*(d+1)+r,S=[{from:l[I],to:l[I+T-1]+f[I+T-1]-1}];if(o){let e=!0;for(let t=0;t<T;t++)if(l[I+t]+f[I+t]!==l[I+t+1]){e=!1;break}if(!e)for(let t=0;t<T;t++)S[t]={from:l[I+t],to:l[I+t]+f[I+t]-1}}const b=l[I],w=f[I];if(null==b||null==w)return null;return{ranges:S,ifd:s,actualTileWidth:r===d?y%g:g,actualTileHeight:t===p?m%x:x}},a._fetchAuxiliaryData=function(){var t=e._asyncToGenerator((function*(e){try{const{data:t}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return d.parsePAMInfo(t)}catch{return null}}));function r(e){return t.apply(this,arguments)}return r}(),r}(p);return t.__decorate([a.property()],S.prototype,"_files",void 0),t.__decorate([a.property()],S.prototype,"_headerInfo",void 0),t.__decorate([a.property()],S.prototype,"_bufferSize",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],S.prototype,"datasetFormat",void 0),S=t.__decorate([f.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],S),S}));
