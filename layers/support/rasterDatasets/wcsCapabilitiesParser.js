/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import t from"../../../geometry/Extent.js";import{getElementValue as r,getElement as o,getElements as i,getSpaceDelimitedNumericValues as n,getElementValues as a,isSameTagIgnoreNS as s,getNodeNameIgnoreNS as c}from"./xmlUtilities.js";function l(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function u(e){const a=r(e,"Service/name"),s=o(e,"Capability"),c=o(s,"GetCapabilities/Get/OnlineResource").getAttribute("xlink:href")??"",u=o(s,"DescribeCoverage/Get/OnlineResource").getAttribute("xlink:href")??"",p=o(s,"GetCoverage/Get/OnlineResource").getAttribute("xlink:href")??"",m={getCapabilities:l(c),describeCoverage:l(u),getCoverage:l(p)},g=i(e,"CoverageOfferingBrief"),v=[];for(let o=0;o<g.length;o++){const e=g[o],a=r(e,"name"),s=i(e,"pos"),c=n(s[0]),l=n(s[1]),u=new t({xmin:c[0],ymin:c[1],xmax:l[0],ymax:l[1],spatialReference:{wkid:4326}});v.push({id:a,lonLatEnvelope:u})}return{name:a,onlineResources:m,coverages:v,supportedVersions:["1.0.0"]}}function p(e){const o={};for(let i=0;i<e.childNodes.length;i++){const a=e.childNodes[i];if(1!==a.nodeType)continue;const s=c(a).toLowerCase();switch(s){case"title":case"abstract":o[s]=r(a);break;case"identifier":o.id=r(a);break;case"wgs84boundingbox":{const e=n(a,"LowerCorner"),r=n(a,"UpperCorner");o.lonLatEnvelope=new t({xmin:e[0],ymin:e[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":o.coverageSummaries=o.coverageSummaries||[],o.coverageSummaries.push(p(a))}}return o}function m(e,t){if(e.coverageSummaries)for(let r=0;r<e.coverageSummaries.length;r++)e.coverageSummaries[r].abstract=e.coverageSummaries[r].abstract||e.abstract,e.coverageSummaries[r].lonLatEnvelope=e.coverageSummaries[r].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[r].title=e.coverageSummaries[r].title||e.title,m(e.coverageSummaries[r],t);null!=e.id&&t.push(e)}function g(e){const t=o(e.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")||"",r=o(e.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")||"",i=o(e.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")||"";return{getCapabilities:l(t),describeCoverage:l(r),getCoverage:l(i)}}function v(e){const t=r(e,"ServiceIdentification/Title"),i=a(e,"ServiceIdentification/ServiceTypeVersion"),n=g(o(e,"OperationsMetadata")),c=[],l=o(e,"Contents");for(let r=0;r<l.childNodes.length;r++){const e=l.childNodes[r];1===e.nodeType&&(s(e,"CoverageSummary")&&m(p(e),c))}return{name:t,onlineResources:n,coverages:c,supportedVersions:i,supportedFormats:a(l,"SupportedFormat")}}function f(e){const s=o(e,"ServiceIdentification"),c=r(s,"Title"),l=a(s,"ServiceTypeVersion"),u=a(s,"Profile"),p=g(o(e,"OperationsMetadata")),m=i(e,"Contents/CoverageSummary"),v=[];for(let i=0;i<m.length;i++){const e=m[i],a=r(e,"CoverageId"),s=o(e,"WGS84BoundingBox");let c;if(s){const e=n(s,"LowerCorner"),r=n(s,"UpperCorner");c=new t({xmin:e[0],ymin:e[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}const l=r(e,"CoverageSubtype")||"RectifiedGridCoverage";v.push({id:a,lonLatEnvelope:c,coverageSubType:l})}const f=o(e,"ServiceMetadata");return{name:c,supportedVersions:l,supportedFormats:a(f,"formatSupported"),supportedInterpolations:a(f,"interpolationSupported").concat(a(f,"InterpolationSupported")),onlineResources:p,profiles:u,coverages:v}}function d(t,r=null){let o=null;if("string"==typeof t){o=(new DOMParser).parseFromString(t,"text/xml")}else o=t;const i=o.documentElement.getAttribute("version"),n=(i||r||"1.0.0").slice(0,3);let a;if("2.0"===n)a=f(o);else if("1.1"===n)a=v(o);else{if("1.0"!==n)throw new e("wcsraster:parsecapabilities","the capabilities version is not supported");a=u(o)}return a.capabilitiesVersion=i,a}export{d as parseCapabilities};
