/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../geometry/SpatialReference","../../../geometry/Extent","../../../geometry","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","./BaseRaster","./InMemoryRaster","../rasterTransforms/PolynomialTransform","./pamParser"],(function(t,e,r,s,a,o,i,n,l,c,u,p,f,h,m,d,y,w,g,x,P,_){"use strict";let v=function(e){function r(){return e.apply(this,arguments)||this}t._inheritsLoose(r,e);var a=r.prototype;return a.open=async function(t){await this.init();const e=await this._fetchData(t);let{spatialReference:r,statistics:s,histograms:a,transform:o}=await this._fetchAuxiliaryData(t);const i=!r;i&&(r=new h({wkid:3857})),null!=a&&a.length&&null==s&&(s=w.estimateStatisticsFromHistograms(a));const{width:n,height:l}=e;let c=new m({xmin:-.5,ymin:.5-l,xmax:n-.5,ymax:.5,spatialReference:r});const u=o?o.forwardTransform(c):c;let p=!0;if(o){const t=o.forwardCoefficients;p=t&&0===t[1]&&0===t[2],p&&(o=null,c=u)}const f=new x({data:{extent:u,nativeExtent:c,transform:o,pixelBlock:e,statistics:s,histograms:a,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:i}});await f.open(),this._set("rasterInfo",f.rasterInfo),this._inMemoryRaster=f},a.fetchRawTile=function(t,e,r,s={}){return this._inMemoryRaster.fetchRawTile(t,e,r,s)},a._fetchData=async function(t){const{data:e}=await this.request(this.url,{responseType:"array-buffer",signal:null==t?void 0:t.signal}),r=y.getFormat(e).toUpperCase();if("JPG"!==r&&"PNG"!==r&&"GIF"!==r&&"BMP"!==r)throw new l("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",r);return await this.decodePixelBlock(e,{format:"jpg",width:1,height:1,useCanvas:!0})},a._fetchAuxiliaryData=async function(t){var e,r;const a=s.unwrap(null==t?void 0:t.signal),o=null!=(e=this.ioConfig.skipExtensions)?e:[],i=o.indexOf("aux.xml")>-1?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:a}),n=this.datasetFormat,l="JPG"===n?"jgw":"PNG"===n?"pgw":"BMP"===n?"bpw":null,c=o.indexOf(l)>-1?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+l,{responseType:"text",signal:a}),u=await f.eachAlways([i,c]);if(null!=a&&a.aborted)throw f.createAbortError();const p=_.parsePAMInfo(null==(r=u[0].value)?void 0:r.data);if(!p.transform){const t=u[1].value?u[1].value.data.split("\n").slice(0,6).map((t=>Number(t))):null;p.transform=6===(null==t?void 0:t.length)?new P({forwardCoefficients:[t[4],t[5],t[0],-t[1],t[2],-t[3]]}):null}return p},r}(g);return e.__decorate([i.property({type:String,json:{write:!0}})],v.prototype,"datasetFormat",void 0),v=e.__decorate([n.subclass("esri.layers.support.rasterDatasets.ImageAuxRaster")],v),v}));
