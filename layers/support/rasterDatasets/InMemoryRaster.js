/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../RasterInfo","./BaseRaster","../rasterFunctions/pixelUtils","../rasterFunctions/stretchUtils","../../../geometry/Extent","../../../geometry/SpatialReference"],(function(e,t,s,r,i,a,o,n,l,c,p,h,u,m,y,d){"use strict";let f=function(t){function s(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="MEMORY",e.data=null,e}e._inheritsLoose(s,t);var o=s.prototype;return o.open=function(){var t=e._asyncToGenerator((function*(e){yield this.init();const t=this.data,{pixelBlock:s,statistics:r,histograms:i,name:a,keyProperties:o,nativeExtent:n,transform:l}=this.data,{width:c,height:h,pixelType:u}=s,m=t.extent??new y({xmin:-.5,ymin:.5,xmax:c-.5,ymax:h-.5,spatialReference:new d({wkid:3857})}),f=t.isPseudoSpatialReference??!t.extent,x={x:m.width/c,y:m.height/h},g=new p({width:c,height:h,pixelType:u,extent:m,nativeExtent:n,transform:l,pixelSize:x,spatialReference:m.spatialReference,bandCount:s.pixels.length,keyProperties:o||{},statistics:r,isPseudoSpatialReference:f,histograms:i});this.createRemoteDatasetStorageInfo(g,512,512),this._set("rasterInfo",g),this.updateTileInfo(),yield this._buildInMemoryRaster(s,{width:512,height:512},e),this.datasetName=a,this.url="/InMemory/"+a}));function s(e){return t.apply(this,arguments)}return s}(),o.fetchRawTile=function(e,t,s,r={}){const i=this._pixelBlockTiles.get(`${e}/${t}/${s}`);return Promise.resolve(i)},o._buildInMemoryRaster=function(){var t=e._asyncToGenerator((function*(e,t,s){const o=this.rasterInfo.storageInfo.maximumPyramidLevel,n=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:o},s):Promise.resolve(u.split(e,t,o)),l=i.isSome(this.rasterInfo.statistics),c=i.isSome(this.rasterInfo.histograms),p=l?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},s):Promise.resolve(m.estimateStatisticsHistograms(e)),h=yield a.eachAlways([n,p]);if(!h[0].value&&h[1].value)throw new r("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=h[0].value,l||(this.rasterInfo.statistics=h[1].value?.statistics),c||(this.rasterInfo.histograms=h[1].value?.histograms)}));function s(e,s,r){return t.apply(this,arguments)}return s}(),s}(h);t.__decorate([o.property({type:String,json:{write:!0}})],f.prototype,"datasetFormat",void 0),t.__decorate([o.property()],f.prototype,"data",void 0),f=t.__decorate([c.subclass("esri.layers.support.rasterDatasets.InMemoryRaster")],f);return f}));
