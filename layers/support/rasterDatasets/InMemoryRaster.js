/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../RasterInfo","./BaseRaster","../rasterFunctions/pixelUtils","../../../geometry/Extent","../../../geometry/SpatialReference"],(function(e,t,s,r,i,a,o,n,l,c,p,h,u,m,d,y){"use strict";let f=function(t){function s(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="MEMORY",e}e._inheritsLoose(s,t);var o=s.prototype;return o.open=function(){var t=e._asyncToGenerator((function*(e){var t;yield this.init();const{pixelBlock:s,statistics:r,histograms:i,name:a,keyProperties:o,nativeExtent:n,transform:l}=this.data,{width:c,height:p,pixelType:u}=s,m=this.data.extent||new d({xmin:-.5,ymin:.5,xmax:c-.5,ymax:p-.5,spatialReference:new y({wkid:3857})}),f=null!=(t=this.data.isPseudoSpatialReference)?t:!this.data.extent,v={x:m.width/c,y:m.height/p},g=new h({width:c,height:p,pixelType:u,extent:m,nativeExtent:n,transform:l,pixelSize:v,spatialReference:m.spatialReference,bandCount:3,keyProperties:o||{},statistics:r,isPseudoSpatialReference:f,histograms:i});this.createRemoteDatasetStorageInfo(g,512,512),this._set("rasterInfo",g),this.updateTileInfo(),yield this._buildInMemoryRaster(s,{width:512,height:512},e),this.datasetName=a,this.url="/InMemory/"+a}));function s(e){return t.apply(this,arguments)}return s}(),o.fetchRawTile=function(e,t,s,r={}){const i=this._pixelBlockTiles.get(`${e}/${t}/${s}`);return Promise.resolve(i)},o._buildInMemoryRaster=function(){var t=e._asyncToGenerator((function*(e,t,s){const o=this.rasterInfo.storageInfo.maximumPyramidLevel,n=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:o},s):Promise.resolve(m.split(e,t,o)),l=i.isSome(this.rasterInfo.statistics),c=i.isSome(this.rasterInfo.histograms),p=l&&c?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},s):Promise.resolve(m.estimateStatisticsHistograms(e)),h=yield a.eachAlways([n,p]);if(!h[0].value&&h[1].value)throw new r("inmemory-raster:open","failed to build in memory raster");var u,d;(this._pixelBlockTiles=h[0].value,l)||(this.rasterInfo.statistics=null==(u=h[1].value)?void 0:u.statistics);c&&(this.rasterInfo.histograms=null==(d=h[1].value)?void 0:d.histograms)}));function s(e,s,r){return t.apply(this,arguments)}return s}(),s}(u);return t.__decorate([o.property({type:String,json:{write:!0}})],f.prototype,"datasetFormat",void 0),t.__decorate([o.property()],f.prototype,"data",void 0),f=t.__decorate([p.subclass("esri.layers.support.rasterDatasets.InMemoryRaster")],f),f}));
