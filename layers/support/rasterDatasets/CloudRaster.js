/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../LOD","../RasterInfo","../RasterStorageInfo","../TileInfo","./BaseRaster","./DBFParser","../rasterTransforms/utils","../../../rest/support/FeatureSet","../../../geometry/SpatialReference","../../../geometry/Extent","../../../geometry/Point"],(function(e,t,r,n,i,o,a,s,l,f,c,u,d,p,m,h,y,g,x,S){"use strict";const I=new Map;I.set("int16","esriFieldTypeSmallInteger"),I.set("int32","esriFieldTypeInteger"),I.set("int64","esriFieldTypeInteger"),I.set("float32","esriFieldTypeSingle"),I.set("float64","esriFieldTypeDouble"),I.set("text","esriFieldTypeString");const _=8;let v=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).storageInfo=null,e.datasetFormat="CRF",e}e._inheritsLoose(r,t);var o=r.prototype;return o.open=function(){var t=e._asyncToGenerator((function*(e){yield this.init();const{data:t}=yield this.request(this.url+"/conf.json",{signal:e?.signal});if(!this._validateHeader(t))throw new n("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const{storageInfo:r,rasterInfo:i}=this._parseHeader(t);if("thematic"===i.dataType){const e=yield this._fetchAuxiliaryInformation();i.attributeTable=e}this._set("storageInfo",r),this._set("rasterInfo",i),this.ioConfig.retryCount=this.ioConfig.retryCount||0}));function r(e){return t.apply(this,arguments)}return r}(),o.fetchRawTile=function(){var t=e._asyncToGenerator((function*(e,t,r,n={}){const{transposeInfo:i}=this.rasterInfo.storageInfo,{transposedVariableName:o}=n,a=!(!i||!o),s=a?0:this.rasterInfo.storageInfo.maximumPyramidLevel-e;if(s<0)return null;const l=this._buildCacheFilePath(s,t,r,n.multidimensionalDefinition,o),f=this._getIndexRecordFromBundle(t,r,a),c=yield this.request(l,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:n.signal});if(!c)return null;const u=new Uint8Array(c.data),d=this._getTileEndAndContentType(u,f);if(0===d.recordSize)return null;const p=yield this.request(l,{range:{from:d.position,to:d.position+d.recordSize},responseType:"array-buffer",signal:n.signal});if(!p)return null;const[m,h]=this._getTileSize(a);return this.decodePixelBlock(p.data,{width:m,height:h,planes:null,pixelType:null,returnInterleaved:a})}));function r(e,r,n){return t.apply(this,arguments)}return r}(),o._validateHeader=function(e){const t=["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"];return e&&"RasterInfo"===e.type&&!t.some((t=>!e[t]))},o._parseHeader=function(e){const t=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],{bandCount:r,histograms:n,colormap:i,blockWidth:o,blockHeight:a,firstPyramidLevel:s,maximumPyramidLevel:l}=e,p=e.statistics&&e.statistics.map((e=>({min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}))),m=e.extent.spatialReference,h=e.geodataXform?.spatialReference,y=new g(m?.wkid||m?.wkt?m:h);let I=new x({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:y});const v=new S({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:y}),T=Math.round((I.xmax-I.xmin)/v.x),b=Math.round((I.ymax-I.ymin)/v.y),w=this._parseTransform(e.geodataXform),z=w?I:null;w&&(I=w.forwardTransform(I),v.x=(I.xmax-I.xmin)/T,v.y=(I.ymax-I.ymin)/b);const k=e.properties??{},C=e.format.toLowerCase().replace("cache/",""),R=new S(e.origin.x,e.origin.y,y);let F,P,H,L;if(i&&i.colors)for(F=[],P=0;P<i.colors.length;P++)H=i.colors[P],L=i.values?i.values[P]:P,F.push([L,255&H,H<<16>>>24,H<<8>>>24,H>>>24]);const D=e.LODInfos,B=[];for(P=0;P<D.levels.length;P++)B.push(new f({level:D.levels[P],resolution:D.resolutions[P],scale:96/.0254*D.resolutions[P]}));const M=new d({dpi:96,lods:B,format:C,origin:R,size:[o,a],spatialReference:y}),O={recordSize:_,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*_+64},N=[{maxCol:Math.ceil(T/o)-1,maxRow:Math.ceil(b/a)-1,minCol:0,minRow:0}];let $=2;if(l>0)for(P=0;P<l;P++)N.push({maxCol:Math.ceil(T/$/o)-1,maxRow:Math.ceil(b/$/a)-1,minCol:0,minRow:0}),$*=2;const q=e.mdInfo;let E=null;if(q&&k._yxs){const e=k._yxs;E={packetSize:e.PacketSize,tileSize:[e.TileXSize,e.TileYSize]}}return{storageInfo:O,rasterInfo:new c({width:T,height:b,pixelType:t,bandCount:r,extent:I,nativeExtent:z,transform:w,spatialReference:y,pixelSize:v,keyProperties:k,statistics:p,histograms:n,multidimensionalInfo:q,colormap:F,storageInfo:new u({blockWidth:o,blockHeight:a,pyramidBlockWidth:o,pyramidBlockHeight:a,origin:R,tileInfo:M,transposeInfo:E,firstPyramidLevel:s,maximumPyramidLevel:l,blockBoundary:N})})}},o._parseTransform=function(e){if(!h.isTransformSupported(e))throw new n("cloudraster:open","the data contains unsupported geodata transform types");const t=h.readTransform(e);if("identity"===t.type)return null;if("polynomial"!==t.type||!t.forwardCoefficients?.length||!t.inverseCoefficients?.length)throw new n("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return t},o._fetchAuxiliaryInformation=function(){var t=e._asyncToGenerator((function*(e){const t=this.request(this.url+"/conf.vat.json",{signal:e}).then((e=>e.data)).catch((()=>null)),r=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:e}).then((e=>e.data)).catch((()=>null)),n=yield Promise.all([t,r]);let i;if(n[0]){let e=n[0].fields;const t=n[0].values;if(e&&t){e=e.map((e=>({type:"OID"===e.name?"esriFieldTypeOID":I.get(e.type),name:e.name,alias:e.alias||e.name})));const r=t.map((e=>({attributes:e})));e&&t&&(i={fields:e,features:r})}}if(!i&&n[1]){i=m.parse(n[1]).recordSet}return y.fromJSON(i)}));function r(e){return t.apply(this,arguments)}return r}(),o._buildCacheFilePath=function(e,t,r,n,o){const a=this._getPackageSize(!!o),s=Math.floor(t/a)*a,l=Math.floor(r/a)*a,f="R"+this._toHexString4(s)+"C"+this._toHexString4(l);let c="L";c+=e>=10?e.toString():"0"+e.toString();const{multidimensionalInfo:u}=this.rasterInfo,d=n?.[0];if(i.isNone(u)||!d)return`${this.url}/_alllayers/${c}/${f}.bundle`;let p="_yxs";if(!o){p=u.variables.find((e=>e.name===d.variableName)).dimensions[0].values.indexOf(d.values[0]).toString(16);const e=4-p.length;for(let t=0;t<e;t++)p="0"+p;p="S"+p}const m=this._getVariableFolderName(o||d.variableName);return`${this.url}/_alllayers/${m}/${p}/${c}/${f}.bundle`},o._getPackageSize=function(e=!1){const{transposeInfo:t}=this.rasterInfo.storageInfo;return e&&i.isSome(t)?t.packetSize??0:this.storageInfo.packetSize},o._getTileSize=function(e=!1){const{storageInfo:t}=this.rasterInfo,{transposeInfo:r}=t;return e&&i.isSome(r)?r.tileSize:t.tileInfo.size},o._getVariableFolderName=function(e){return""===(e=e.trim())?"_v":e.replace(/[\{|\}\-]/g,"_").replace("\\*","_v")},o._getIndexRecordFromBundle=function(e,t,r=!1){const n=this._getPackageSize(r),i=n*(e%n)+t%n;if(i<0)throw new Error("Invalid level / row / col");return 20+i*this.storageInfo.recordSize+44},o._getTileEndAndContentType=function(e,t){const r=e.subarray(t,t+8);let n,i=0;for(n=0;n<5;n++)i|=(255&r[n])<<8*n;const o=0xffffffffff&i;for(i=0,n=5;n<8;n++)i|=(255&r[n])<<8*(n-5);return{position:o,recordSize:0xffffffffff&i}},o._toHexString4=function(e){let t=e.toString(16);if(4!==t.length){let e=4-t.length;for(;e-- >0;)t="0"+t}return t},r}(p);t.__decorate([o.property({readOnly:!0})],v.prototype,"storageInfo",void 0),t.__decorate([o.property({type:String,json:{write:!0}})],v.prototype,"datasetFormat",void 0),v=t.__decorate([l.subclass("esri.layers.support.rasterDatasets.CloudRaster")],v);return v}));
