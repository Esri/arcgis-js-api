// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","../TileInfo","./BaseRaster","./DBFParser","../../../tasks/support/FeatureSet"],(function(e,t,r,i,n,o,a,s,l,u,f,c,d,p){"use strict";var h=new Map;h.set("int16","esriFieldTypeSmallInteger"),h.set("int32","esriFieldTypeInteger"),h.set("int64","esriFieldTypeInteger"),h.set("float32","esriFieldTypeSingle"),h.set("float64","esriFieldTypeDouble"),h.set("text","esriFieldTypeString");return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.storageInfo=null,t.datasetFormat="CRF",t}return r.__extends(t,e),t.prototype.open=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,a,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),[4,this.request(this.url+"/conf.json",{signal:null==e?void 0:e.signal})];case 2:if(t=r.sent().data,!this._validateHeader(t))throw new n("cloudraster:open","Invalid or unsupported conf.json.");return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),i=this._parseHeader(t),o=i.storageInfo,"thematic"!==(a=i.rasterInfo).dataType?[3,4]:[4,this._fetchAuxiliaryInformation()];case 3:s=r.sent(),a.attributeTable=s,r.label=4;case 4:return this._set("storageInfo",o),this._set("rasterInfo",a),this.ioConfig.retryCount=this.ioConfig.retryCount||0,[2]}}))}))},t.prototype.fetchRawTile=function(e,t,i,n){return void 0===n&&(n={}),r.__awaiter(this,void 0,void 0,(function(){var o,a,s,l,u,f,c;return r.__generator(this,(function(r){switch(r.label){case 0:return(o=this.rasterInfo.storageInfo.maximumPyramidLevel-e)<0?[2,null]:(a=this._buildCacheFilePath(o,t,i,n.multidimensionalDefinition),s=this._getIndexRecordFromBundle(t,i),[4,this.request(a,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:n.signal})]);case 1:return(l=r.sent())?(u=new Uint8Array(l.data),0===(f=this._getTileEndAndContentType(u,s)).recordSize?[2,null]:[4,this.request(a,{range:{from:f.position,to:f.position+f.recordSize},responseType:"array-buffer",signal:n.signal})]):[2,null];case 2:return(c=r.sent())?[2,this.decodePixelBlock(c.data,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null})]:[2,null]}}))}))},t.prototype._validateHeader=function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))},t.prototype._parseHeader=function(e){var t,r,n,o,a,s=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],c=e.bandCount,d=e.histograms,p=e.colormap,h=e.blockWidth,m=e.blockHeight,g=e.firstPyramidLevel,y=e.maximumPyramidLevel,x=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),v=new i.SpatialReference(e.extent.spatialReference||e.geodataXform.spatialReference),I=new i.Extent({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:v}),_=new i.Point({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:v}),S=null!==(t=e.properties)&&void 0!==t?t:{},b=e.format.toLowerCase().replace("cache/",""),w=new i.Point(e.origin.x,e.origin.y,v);if(p&&p.colors)for(r=[],n=0;n<p.colors.length;n++)o=p.colors[n],a=p.values?p.values[n]:n,r.push([a,255&o,o<<16>>>24,o<<8>>>24,o>>>24]);var z=e.LODInfos,T=[];for(n=0;n<z.levels.length;n++)T.push({level:z.levels[n],resolution:z.resolutions[n],scale:96/.0254*z.resolutions[n]});var R=new f({dpi:96,lods:T,format:b,origin:w,size:[h,m],spatialReference:v}),k={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},C=Math.round((I.xmax-I.xmin)/_.x),F=Math.round((I.ymax-I.ymin)/_.y),P=[{maxCol:Math.ceil(C/h)-1,maxRow:Math.ceil(F/m)-1,minCol:0,minRow:0}],H=2;if(y>0)for(n=0;n<y;n++)P.push({maxCol:Math.ceil(C/H/h)-1,maxRow:Math.ceil(F/H/m)-1,minCol:0,minRow:0}),H*=2;var D=e.mdInfo;return{storageInfo:k,rasterInfo:new l({width:C,height:F,pixelType:s,bandCount:c,extent:I,spatialReference:v,pixelSize:_,keyProperties:S,statistics:x,histograms:d,multidimensionalInfo:D,colormap:r,storageInfo:new u({blockWidth:h,blockHeight:m,pyramidBlockWidth:h,pyramidBlockHeight:m,origin:w,tileInfo:R,firstPyramidLevel:g,maximumPyramidLevel:y,blockBoundary:P})})}},t.prototype._fetchAuxiliaryInformation=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,o,s,l,u,f;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.request(this.url+"/conf.vat.json",{signal:e}).then((function(e){return e.data})).catch((function(){return null})),i=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:e}).then((function(e){return e.data})).catch((function(){return null})),[4,a.all([t,i])];case 1:return(n=r.sent())[0]&&(s=n[0].fields,l=n[0].values,s&&l&&(s=s.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":h.get(e.type),name:e.name,alias:e.alias||e.name}})),u=l.map((function(e){return{attributes:e}})),s&&l&&(o={fields:s,features:u}))),!o&&n[1]&&(f=d.parse(n[1]),o=f.recordSet),[2,p.fromJSON(o)]}}))}))},t.prototype._buildCacheFilePath=function(e,t,r,i){var n=this.storageInfo.packetSize,a=Math.floor(t/n)*n,s=Math.floor(r/n)*n,l="R"+this._toHexString4(a)+"C"+this._toHexString4(s),u="L";u+=e>=10?e.toString():"0"+e.toString();var f=this.rasterInfo.multidimensionalInfo,c=null==i?void 0:i[0];if(!o.isSome(f)||!c)return this.url+"/_alllayers/"+u+"/"+l+".bundle";for(var d=f.variables.filter((function(e){return e.name===c.variableName}))[0].dimensions[0].values.indexOf(c.values[0]).toString(16),p=4-d.length,h=0;h<p;h++)d="0"+d;return d="S"+d,this.url+"/_alllayers/"+c.variableName+"/"+d+"/"+u+"/"+l+".bundle"},t.prototype._getIndexRecordFromBundle=function(e,t){var r=this.storageInfo.packetSize,i=r*(e%r)+t%r;if(i<0)throw"Invalid level / row / col";return 20+i*this.storageInfo.recordSize+44},t.prototype._getTileEndAndContentType=function(e,t){var r,i=e.subarray(t,t+8),n=0;for(r=0;r<5;r++)n|=(255&i[r])<<8*r;var o=0xffffffffff&n;for(n=0,r=5;r<8;r++)n|=(255&i[r])<<8*(r-5);return{position:o,recordSize:0xffffffffff&n}},t.prototype._toHexString4=function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t},r.__decorate([s.property({readOnly:!0})],t.prototype,"storageInfo",void 0),r.__decorate([s.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),t=r.__decorate([s.subclass("esri.layers.support.rasterDatasets.CloudRaster")],t)}(c)}));