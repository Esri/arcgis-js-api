// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/arrayUtils","../../../geometry/Extent","../RasterInfo","../wmsUtils","./xmlUtilities"],(function(e,t,n,a,i,r,l,s){"use strict";function o(e){var t=s.getElementValues(e,"interpolationMethod"),n=e.getAttribute("default");return null!=n?[n].concat(t.filter((function(e){return e.toLowerCase()!==n.toLowerCase()}))):t}function u(e){return null==e?["nearest"]:e.map((function(e){var t=e.toLowerCase();return t.indexOf("nearest")>-1?"nearest":t.indexOf("linear")>-1?"bilinear":t.indexOf("cubic")>-1?"cubic":null})).filter((function(e){return!!e}))}function m(e){var t=s.getElements(e,"pos"),n=s.getSpaceDelimitedNumericValues(t[0]),a=s.getSpaceDelimitedNumericValues(t[1]);return new i({xmin:n[0],ymin:n[1],xmax:a[0],ymax:a[1],spatialReference:{wkid:4326}})}function p(e){for(var t=[],n=s.getElements(e,"RangeSet"),a=[],i=0;i<n.length;i++){for(var r=s.getElementValue(n[i],"name"),l=s.getElementValue(n[i],"label"),o=[],u=s.getElements(n[i],"AxisDescription"),m=0;m<u.length;m++){var p=s.getElementValue(u[m],"name"),g=s.getElementValue(u[m],"label"),d=s.getElementValues(u[m],"singleValue");if(0===d.length){var f=s.getElementValue(u[m],"min"),c=s.getElementValue(u[m],"max"),v=Number(s.getElementValue(u[m],"res"))||1;if(null!==f&&null!==c)for(var h=parseInt(f,10);h<=parseInt(c,10);h+=v)d.push(h.toString())}"band"===p.toLowerCase()&&(a=d),o.push({name:p,label:g,values:d})}t.push({name:r,label:l,axis:o})}return{rangeSet:t,bandNames:a}}function g(e){var t=s.getElements(e,"timeposition");if(t.length>0){for(var i=[],r=0;r<t.length;r++)i.push(new Date(s.getElementValue(t[r])));return{begin:i[0],end:i[i.length-1],values:i}}var l=s.getElement(e,"timePeriod");if(l){var o=new Date(s.getElementValue(l,"beginPosition")),u=new Date(s.getElementValue(l,"endPosition")),m=function(e){if(void 0===e&&(e=null),!e)return{resolution:null,units:null};var t,n,i,r=e.toUpperCase(),l=["Years","Months","Days","Hours","Minutes","Seconds"];return-1===r.indexOf("PT")?(r=r.slice(1),(i=a.findIndex(["Y","M","D"],(function(e){return r.indexOf(e)>-1})))>-1&&(t=l[i]),n=parseFloat(r.substring(0,r.length-1))):(r=r.slice(2),t=l[3+(i=a.findIndex(["H","M","S"],(function(e){return r.indexOf(e)>-1})))],n=parseFloat(r.substring(0,r.length-1))),{resolution:n,units:t}}(s.getElementValue(l,"timeResolution"));return n.__assign({begin:o,end:u},m)}return null}function d(e){var t=s.getElement(e,"spatialDomain"),n=s.getElement(t,"Envelope")||s.getElement(t,"EnvelopeWithTimePeriod"),a=n.getAttribute("srsName").split(":"),r=a[a.length-1],l=s.getElements(n,"pos"),o=s.getSpaceDelimitedNumericValues(l[0]),u=s.getSpaceDelimitedNumericValues(l[1]),m=new i({xmin:o[0],ymin:o[1],xmax:u[0],ymax:u[1],spatialReference:{wkid:parseInt(r,10)}}),p=s.getElement(t,"RectifiedGrid"),d=s.getElementValue(p,"low").split(" "),f=s.getElementValue(p,"high").split(" "),c=parseInt(f[0],10)-parseInt(d[0],10)+1,v=parseInt(f[1],10)-parseInt(d[1],10)+1,h=s.getSpaceDelimitedNumericValues(t,"origin/pos"),x=s.getElements(t,"offsetVector"),E={envelope:m,columns:c,rows:v,offset:{x:parseFloat(s.getElementValue(x[0]).split(" ")[0]),y:parseFloat(s.getElementValue(x[1]).split(" ")[1])},origin:{x:h[0],y:h[1]}},b=s.getElement(e,"temporalDomain");return{spatialDomain:E,temporalDomain:b?g(b):null}}function f(e){for(var t=[],n=s.getElements(e,"Field"),a=[],i=0;i<n.length;i++){for(var r=s.getElementValue(n[i],"Identifier"),l=s.getElementValue(n[i],"Description"),o=s.getElementValue(n[i],"Definition"),u=s.getElementValue(n[i],"Abstract"),m=s.getElementValue(n[i],"Title"),p=s.getElementValues(n[i],"InterpolationMethod"),g=[],d=s.getElements(n[i],"Axis"),f=0;f<d.length;f++){var c=d[f].getAttribute("identifier"),v=s.getElementValue(d[f],"valuesUnit"),h=s.getElementValue(d[f],"DataType"),x=s.getElementValues(d[f],"Key");"band"===c.toLowerCase()&&(a=x),g.push({identifier:c,valuesUnit:v,dataType:h,values:x})}t.push({identifier:r,description:l,definition:o,abstract:u,title:m,supportedInterpolations:p,axis:g})}return{rangeSet:t,bandNames:a}}function c(e){for(var t,n,a,r,o,u,m=s.getElement(e,"SpatialDomain"),p=s.getElement(m,"GridCRS"),d=s.getElementValue(p,"GridBaseCRS"),f=s.getElementValue(p,"GridOrigin"),c=null!==(t=null==f?void 0:f.split(" ").map((function(e){return parseFloat(e)})))&&void 0!==t?t:[0,0],v=s.getSpaceDelimitedNumericValues(p,"GridOffsets"),h=s.getElements(m,"BoundingBox"),x=0;x<h.length;x++){var E=null===(n=h[x].getAttribute("crs"))||void 0===n?void 0:n.toLowerCase();if(null!=E)if(E.indexOf("imagecrs")>-1){var b=s.getSpaceDelimitedNumericValues(h[x],"LowerCorner");a=(V=s.getSpaceDelimitedNumericValues(h[x],"UpperCorner"))[0]-b[0]+1,r=V[1]-b[1]+1}else if(E.indexOf("epsg")>0){var S=E.split(":");o=parseInt(S[S.length-1],10);b=s.getSpaceDelimitedNumericValues(h[x],"LowerCorner");var V=s.getSpaceDelimitedNumericValues(h[x],"UpperCorner");u=new i({xmin:b[0],ymin:b[1],xmax:V[0],ymax:V[1],spatialReference:{wkid:o}})}}var D=a>r,w=u.xmax-u.xmin>u.ymax-u.ymin,I=!1;l.coordsReversed(o)&&(D===w?I=!1:(I=!0,u=new i({xmin:u.ymin,ymin:u.xmin,xmax:u.ymax,ymax:u.xmax,spatialReference:{wkid:o}})));var N={columns:a,rows:r,origin:{x:c[0],y:c[1]},offset:{x:v[0],y:v[1]},gridBaseCRS:d,envelope:u,useEPSGAxis:I},y=s.getElement(e,"temporalDomain");return{spatialDomain:N,temporalDomain:y?g(y):null}}function v(e,t){for(var n,a=[],i=[],l={supportedFormats:a,supportedCRSs:i,version:"1.1"},o=0;o<e.childNodes.length;o++){var m=e.childNodes[o];if(1===m.nodeType){var p=s.getNodeNameIgnoreNS(m).toLowerCase();switch(p){case"title":case"abstract":case"identifier":l[p]=s.getElementValue(m);break;case"supportedformat":var g=s.getElementValue(m);-1===a.indexOf(g)&&a.push(g);break;case"supportedcrs":var d=s.getElementValue(m);-1===i.indexOf(d)&&i.push(d);break;case"range":var v=f(m);l.range=v.rangeSet,n=v.bandNames;break;case"domain":l.domain=c(m)}}}var h=u(l.range[0].supportedInterpolations),x=l.identifier,E=l.abstract,b=l.title,S=l.domain,V=l.range,D={x:Math.abs(S.spatialDomain.offset.x),y:Math.abs(S.spatialDomain.offset.y)},w=function(e,t){var n=e.filter((function(e){return-1===e.identifier.toLowerCase().indexOf("field_1")&&!e.axis.some((function(e){return"band"===e.identifier.toLowerCase()}))})),a=[];if(n.length&&n.forEach((function(e){var t,n=e.axis.map((function(e){var t=e.values.map((function(e){return parseFloat(e.trim())})),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.valuesUnit?e.valuesUnit.trim():"",hasRegularIntervals:!1,values:t,extent:n}}));a.push({name:e.identifier.trim(),description:null!==(t=null==e?void 0:e.description.trim())&&void 0!==t?t:"",unit:"",dimensions:n})})),t.temporalDomain){var i=t.temporalDomain,r=i.begin,l=i.end,s=i.values,o=i.units,u=i.resolution;a.forEach((function(e){e.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==s?void 0:s.map((function(e){return e.getTime()})),hasRegularIntervals:!s,interval:u,intervalUnit:o,extent:[r.getTime(),l.getTime()]})}))}return a.length?{variables:a}:null}(V,S),I=new r({width:S.spatialDomain.columns,height:S.spatialDomain.rows,pixelSize:D,extent:S.spatialDomain.envelope,spatialReference:S.spatialDomain.envelope.spatialReference,bandCount:n.length||1,multidimensionalInfo:w});return{id:x,title:l.title,description:E||b,lonLatEnvelope:null,bandNames:n,rasterInfo:I,supportedFormats:a,supportedInterpolations:h,coverageDescription:l,version:t,useEPSGAxis:S.spatialDomain.useEPSGAxis}}function h(e){var t,n=s.getElement(e,"Envelope")||s.getElement(e,"EnvelopeWithTimePeriod"),a=n.getAttribute("srsName"),r=a.slice(a.lastIndexOf("/")+1),l=n.getAttribute("axisLabels"),o=s.getSpaceDelimitedNumericValues(n,"lowerCorner"),u=s.getSpaceDelimitedNumericValues(n,"upperCorner"),m=!["y","lat","latitude","north","nor","n","b"].some((function(e){return e===l[0].toLowerCase()}));t=new i(m?{xmin:o[0],ymin:o[1],xmax:u[0],ymax:u[1],spatialReference:{wkid:parseInt(r,10)}}:{xmin:o[1],ymin:o[0],xmax:u[1],ymax:u[0],spatialReference:{wkid:parseInt(r,10)}});var p,g,d={mins:o,maxs:u},f=n.getAttribute("uomLabels").trim().split(" ");return s.isSameTagIgnoreNS(n,"EnvelopeWithTimePeriod")&&(p=new Date(s.getElementValue(e,"beginPosition")),g=new Date(s.getElementValue(e,"endPosition"))),{envelope:t,axisLabels:l,uomLabels:f.length?f:null,envelopeAllDims:d,beginPosition:p,endPosition:g,isEastFirst:m}}function x(e){for(var t=[],n=s.getElements(e,"DataRecord"),a=[],i=0;i<n.length;i++){for(var r=s.getElements(n[i],"field"),l=[],o=0;o<r.length;o++){var u=r[o].getAttribute("name"),m=s.getElementValue(r[o],"description")||"",p=s.getElement(r[o],"uom").getAttribute("code")||"",g=s.getSpaceDelimitedNumericValues(r[o],"interval");u.toLowerCase().indexOf("band")>-1&&a.push(u),l.push({name:u,description:m,uom:p,allowedValues:g})}t.push(l)}return{rangeType:t,bandNames:a}}function E(e){var t=1,n="";return Math.abs(e-1/24)<1/24*.01?n="Hours":Math.abs(e-1)<.01?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>27.99&&e<31.01?n="Months":Math.round(e/30)<12?n="Months":e>364.99&&e<366.01&&(n="Years"),{interval:t,intervalUnit:n}}function b(e){for(var t=s.getElement(e,"RectifiedGrid"),n=s.getSpaceDelimitedNumericValues(t,"low"),a=s.getSpaceDelimitedNumericValues(t,"high"),i=[],r=0;r<n.length;r++)i.push(a[r]-n[r]+1);var l=s.getElementValue(t,"axisLabels").split(" "),o=s.getSpaceDelimitedNumericValues(t,"origin/pos"),u=s.getElements(t,"offsetVector"),m=[];for(r=0;r<u.length;r++)m.push(parseFloat(s.getElementValue(u[r]).split(" ")[r]));var p,g,d;return["y","lat","latitude","north","nor","n","b"].some((function(e){return e===l[0].toLowerCase()}))?(p=i[1],g=i[0],d={y:Math.abs(m[0]),x:Math.abs(m[1])}):(p=i[0],g=i[1],d={x:Math.abs(m[0]),y:Math.abs(m[1])}),{columns:p,rows:g,origin:o,offset:m,resolution:d,gridSamples:i,axisLabels:l}}function S(e){for(var t={version:"2.0"},n=[],a=0;a<e.childNodes.length;a++){var i=e.childNodes[a];if(1===i.nodeType)if(s.isSameTagIgnoreNS(i,"coverageId"))t.coverageId=s.getElementValue(i);else if(s.isSameTagIgnoreNS(i,"ServiceParameters"))t.serviceParameters={supportedFormats:s.getElementValues(i,"nativeFormat")};else if(s.isSameTagIgnoreNS(i,"boundedBy"))t.boundedBy=h(i);else if(s.isSameTagIgnoreNS(i,"rangeType")){var l=x(i);t.rangeType=l.rangeType,n=l.bandNames}else s.isSameTagIgnoreNS(i,"domainSet")&&(t.domainSet=b(i))}var o=t.coverageId,u=t.boundedBy,m=t.domainSet,p=t.rangeType,g=t.serviceParameters,d=function(e,t,n){for(var a=[],i=0;i<e.length;i++)for(var r=e[i],l=0;l<r.length;l++)-1===r[l].name.toLowerCase().indexOf("band")&&a.push(r[l]);var s=[];if(a.length){for(var o=[],u=2;u<n.axisLabels.length;u++){var m=(t.uomLabels&&t.uomLabels.length)>u?t.uomLabels[u]:"",p=n.axisLabels[u].toLowerCase().indexOf("time")>-1||"iso8601"===m.toLowerCase(),g=void 0,d=void 0;if(p){var f=E(n.offset[u]);g=f.interval,d=f.intervalUnit}else g=n.offset[u],d=m;var c=[];p?(c.push((new Date).setTime(24*(t.envelopeAllDims.mins[u]-25569)*3600*1e3)),c.push((new Date).setTime(24*(t.envelopeAllDims.maxs[u]-25569)*3600*1e3))):(c.push(t.envelopeAllDims.mins[u]),c.push(t.envelopeAllDims.maxs[u])),o.push({name:n.axisLabels[u].trim(),description:n.axisLabels[u].trim(),unit:t.uomLabels&&t.uomLabels.length>u?t.uomLabels[u].trim():"",hasRegularIntervals:!0,extent:c,interval:g,intervalUnit:d})}if(a.forEach((function(e){return s.push({name:e.name.trim(),description:e.description.trim(),unit:e.uom.trim(),dimensions:o})})),s.length)return{variables:s}}return null}(p,u,m);return{id:o,title:o,description:o,lonLatEnvelope:null,bandNames:n,rasterInfo:new r({width:m.columns,height:m.rows,pixelSize:m.resolution,extent:u.envelope,spatialReference:u.envelope.spatialReference,bandCount:n.length||1,multidimensionalInfo:d}),supportedFormats:g.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.parseCoverages=t.standardizeInterpolations=void 0,t.standardizeInterpolations=u,t.parseCoverages=function(e,t){var n=null;if(n="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e,"1.0.0"===t)return s.getElements(n,"CoverageOffering").map((function(e){return function(e){for(var t,n={version:"1.0"},a=[],i=0;i<e.childNodes.length;i++){var l=e.childNodes[i];if(1===l.nodeType)if(s.isSameTagIgnoreNS(l,"description"))n.description=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"name"))n.name=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"label"))n.label=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"supportedFormats"))n.supportedFormats=s.getElementValues(l,"formats");else if(s.isSameTagIgnoreNS(l,"supportedCRSs"))n.supportedCRSs=(t=l,{requestResponseCRSs:s.getElementValues(t,"requestResponseCRSs").map((function(e){return e.split(":")[1]})),nativeCRSs:s.getElementValues(t,"nativeCRSs").map((function(e){return e.split(":")[1]}))});else if(s.isSameTagIgnoreNS(l,"supportedInterpolations"))n.supportedInterpolations=o(l);else if(s.isSameTagIgnoreNS(l,"lonLatEnvelope"))n.lonLatEnvelope=m(l);else if(s.isSameTagIgnoreNS(l,"rangeSet")){var g=p(l);n.rangeSet=g.rangeSet,a=g.bandNames}else s.isSameTagIgnoreNS(l,"domainSet")&&(n.domainSet=d(l))}var f=u(n.supportedInterpolations),c=n.name,v=n.description,h=n.label,x=n.lonLatEnvelope,E=n.supportedFormats,b=n.domainSet.spatialDomain,S={x:Math.abs(b.offset.x),y:Math.abs(b.offset.y)},V=new r({width:b.columns,height:b.rows,pixelSize:S,extent:b.envelope,spatialReference:b.envelope.spatialReference,bandCount:a.length||1});return{id:c,title:n.name,description:v||h,lonLatEnvelope:x,rasterInfo:V,bandNames:a,supportedFormats:E,supportedInterpolations:f,coverageDescription:n,version:"1.0.0",useEPSGAxis:!1}}(e)}));var a=s.getElements(n,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?a.map((function(e){return v(e,t)})):a.map((function(e){return S(e)}))}}));