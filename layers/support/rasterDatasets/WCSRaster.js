/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../geometry/Point","../../../geometry/Extent","../../../geometry","../DimensionalDefinition","../rasterFunctions/pixelUtils","./BaseRaster","../wmsUtils","./multipartParser","./wcsCapabilitiesParser","./wcsCoverageParser"],(function(e,t,i,n,r,o,s,a,c,l,p,d,h,u,f,g,v,m,w,x,y,I,b){"use strict";const C=["nearest neighbor","bilinear","bicubic"],$=["nearest","linear","cubic"],S=["nearest-neighbor","linear","cubic"];let _=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="WCSServer",e}e._inheritsLoose(i,t);var r=i.prototype;return r.open=async function(e){await this.init();const t=null==e?void 0:e.signal,i=await this._getCapabilities(t);if(this.capabilities=i,!this.version){var n;let e=null==(n=i.capabilitiesVersion)?void 0:n.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=i.capabilitiesVersion:(e=i.supportedVersions.find((e=>"2.0.1"===e))||i.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}this.coverageId||(this.coverageId=i.coverages[0].id);const r=i.coverages.filter((e=>e.id===this.coverageId))[0];if(null==r)throw new c("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const o=await this._describeCoverage(t);this.coverageInfo=o[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=r.lonLatEnvelope,this.coverageInfo.supportedInterpolations=b.standardizeInterpolations(i.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:s}=this.coverageInfo;this.createRemoteDatasetStorageInfo(s,512,512),this._set("rasterInfo",s);const{pixelType:a,bandCount:l}=await this._getPixelTypeAndBandCount(t);s.pixelType=a,1===s.bandCount&&l>1&&(s.bandCount=l),this.updateTileInfo()},r.fetchRawTile=async function(e,t,i,n={}){const{tileInfo:r,maximumPyramidLevel:o}=this.rasterInfo.storageInfo,s=r.lodAt(Math.max(o-e,0)),a=new u({x:s.resolution,y:s.resolution,spatialReference:r.spatialReference}),l=this.getTileExtent(a,t,i,r);let[p,d]=r.size;const h=this.rasterInfo.extent,f=l.xmax>h.xmax||l.ymin<h.ymin;let g=l;if(f&&(g=l.clone().intersection(h),p=Math.floor((g.xmax-g.xmin)/s.resolution),d=Math.floor((g.ymax-g.ymin)/s.resolution)),p<=1||d<=1)return null;const v=await this._getCoverage(g,p,d,n);if(!v)return null;let w=await this.decodePixelBlock(v,{width:p,height:d,planes:null,pixelType:null});if(w&&(w.width!==p||w.height!==d))throw new c("wcsraster-fetch",`the reponse has unexpected dimension width: ${w.width}, height: {pixelBlock.height}`);return f&&(w=m.clip(w,{x:0,y:0},{width:r.size[0],height:r.size[1]})),w},r._getCapabilities=async function(e){const t={service:"WCS",request:"GetCapabilities"};this.version&&(t.version=this.version,t.acceptVersions=this.version);try{const{data:i}=await this.request(this.url,{query:t,responseType:"xml",signal:e});return I.parseCapabilities(i)}catch(e){if(!h.isAbortError(e))throw new c("wcslayer:open","wcs capabilities is not valid or supported");throw e}},r._describeCoverage=async function(e){const t={service:"WCS",request:"DescribeCoverage",version:this.version},i=this.version.slice(0,3);"1.0"===i?t.coverage=this.coverageId:"1.1"===i?t.identifiers=this.coverageId:"2.0"===i&&(t.coverageId=this.coverageId);try{const{data:i}=await this.request(this.url,{query:t,responseType:"xml",signal:e});return b.parseCoverages(i,this.version)}catch(e){if(!h.isAbortError(e))throw new c("wcslayer:open","wcs coverage description is not valid or supported");throw e}},r._getPixelTypeAndBandCount=async function(e){const{pixelSize:t,extent:i,multidimensionalInfo:r}=this.rasterInfo,o=i.center,s=new f({xmin:o.x-t.x,xmax:o.x+t.x,ymin:o.y-t.y,ymax:o.y+t.y,spatialReference:i.spatialReference});let a;if(n.isSome(r)){const e=r.variables[0];a=[],e.dimensions.forEach((t=>{a.push(new v({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values[0],isSlice:!0}))}))}const l=await this._getCoverage(s,2,2,{multidimensionalDefinition:a,signal:n.unwrap(e)});if(!l)throw new c("wcsraster-open","unable to determine pixel type");const p=await this.decodePixelBlock(l,{width:2,height:2,planes:null,pixelType:null});return{pixelType:p.pixelType,bandCount:p.getPlaneCount()}},r._getCoverage=async function(e,t,i,n){const{coverageDescription:r}=this.coverageInfo,{version:o}=r,s="2.0"===r.version?this._getCoverage201Parameters(e,t,i,n,r):"1.1"===r.version?this._getCoverage110Parameters(e,t,i,n,r):this._getCoverage100Parameters(e,t,i,n),a=await this.request(this.url,{query:s,signal:n.signal,responseType:"array-buffer"});if("1.0"===o)return a.data;const l=y.parse(a);if(l.isMultipart){return l.data.filter((e=>{var t;return(null==(t=e.contentType)?void 0:t.toLowerCase().indexOf("image"))>-1}))[0].contentData}throw new c("wcsraster:getcoverage","response is not a valid coverage")},r._getInterpolationIndex=function(e){return-1===this.coverageInfo.supportedInterpolations.indexOf(e)||"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0},r._getCoverage100Parameters=function(e,t,i,n){const r=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,o=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"GEOTIFF",{bandIds:a,interpolation:c}=n,l=this._getInterpolationIndex(c),p=a?a.map((e=>this.coverageInfo.bandNames[e])):null,d=C[l];return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${o}`,bbox:r,width:t,height:i,interpolation:d,band:null==p?void 0:p.join(",")}},r._getCoverage110Parameters=function(e,t,i,n,r){const{multidimensionalDefinition:o,bandIds:s,interpolation:a}=n,c=e.spatialReference.wkid,l=`urn:ogc:def:crs:EPSG::${c}`,p=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",d=this._getInterpolationIndex(a),h=$[d],u=r.domain.spatialDomain,f=u.origin.x<=u.envelope.xmin&&u.origin.y<=u.envelope.ymin,g=e.width/t,v=e.height/i*(f?1:-1),m=f?[e.xmin,e.ymin]:[e.xmin,e.ymax],w=u.useEPSGAxis&&x.coordsReversed(c),y=w?`${m[1]},${m[0]}`:`${m[0]},${m[1]}`,I=w?`${v},0,0,${g}`:`${g},0,0,${v}`,b=g/2,C=e.xmin+b,S=e.xmax-b,_=Math.abs(v)/2,T=e.ymin+_,O=e.ymax-_,P=w?`${T},${C},${O},${S},${l}`:`${C},${T},${S},${O},${l}`,L=r.range.filter((e=>e.axis.some((e=>e.identifier.toLowerCase().indexOf("band")>-1))))[0];let E,G=L&&h&&s?`${L.identifier}:${h}[${L.axis[0].identifier}[${s.join(",")}]]`:null;if(o)for(let e=0;e<o.length;e++){let t=o[e].values;const i=o[e].dimensionName.toLowerCase(),n=o[e].variableName.toLowerCase();if(t.length>0)if(t[0]instanceof Array&&(t=t[0]),"stdtime"===i)E=t.map((e=>this._convertToISOTime(e))).join(",");else{const e=r.range.filter((e=>e.identifier.toLowerCase()===n))[0];if(e){const n=e.axis.filter((e=>e.identifier.toLowerCase()===i))[0];n&&(G=e.identifier+":"+h+"["+n.identifier+"["+t.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:p,crs:`EPSG:${c}`,boundingbox:P,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:y,gridOffsets:I,gridBaseCRS:l,timeSequence:E,rangeSubset:G}},r._convertToISOTime=function(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()},r._getCoverage201Parameters=function(e,t,i,n,r){const{multidimensionalDefinition:o,interpolation:s}=n,a=this._getInterpolationIndex(s),c="http://www.opengis.net/def/interpolation/OGC/1/"+S[a],l=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",{bandNames:p}=this.coverageInfo,{boundedBy:d,domainSet:h,rangeType:u}=r,f=d.isEastFirst?0:1,g=1-f,{axisLabels:v}=h,m=v[f],w=v[g],x=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,y=[];y.push(`${m},${x}(${e.xmin},${e.xmax})`),y.push(`${w},${x}(${e.ymin},${e.ymax})`);const I=[];if(v.length>2)for(let e=2;e<v.length;e++){const t=h.origin[e];if(v[e].toLowerCase().indexOf("time")>-1){let i=t.toString();d.uomLabels[e].toLowerCase().indexOf("ole")>-1&&(I.push(v[e]),i=this._convertToISOTime(t,!0)),y.push(v[e]+",http://www.opengis.net("+i+")")}else y.push(v[e]+",http://www.opengis.net("+t+")")}let b=null;if(o){const e=[];u.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let i=0;i<o.length;i++){const n=v.find((e=>e===o[i].dimensionName)),r=e.find((e=>e===o[i].variableName));if(-1===t.indexOf(r)&&t.push(r),n){let e=o[i].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=n.toLowerCase().indexOf("time")>-1?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const i=y.findIndex((e=>0===e.indexOf(n+",http://www.opengis.net")));-1===i&&y.push(n+",http://www.opengis.net("+t+")"),-1!==i&&-1===y[i].indexOf("("+t+")")&&y.splice(i,1,n+",http://www.opengis.net("+t+")")}}}t.length&&(b=t.join(","))}else if(null!=p&&p.length){b=(n.bandIds?n.bandIds.map((e=>p[e])):p).join(",")}const C=y.join("&subset="),$=`${m}(${t}),${w}(${i})`;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:b,interpolation:c,scaleSize:$,subset:C,format:l,outputcrs:x}},i}(w);return t.__decorate([s.property({type:String,json:{write:!0}})],_.prototype,"datasetFormat",void 0),t.__decorate([s.property()],_.prototype,"tileType",void 0),t.__decorate([s.property({type:String,json:{write:!0}})],_.prototype,"version",void 0),t.__decorate([s.property({type:String,json:{write:!0}})],_.prototype,"coverageId",void 0),_=t.__decorate([a.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],_),_}));
