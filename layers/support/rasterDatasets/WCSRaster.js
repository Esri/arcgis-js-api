/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../DimensionalDefinition","../wmsUtils","./BaseRaster","./multipartParser","./wcsCapabilitiesParser","./wcsCoverageParser","../rasterFunctions/pixelUtils","../../../geometry/Extent"],(function(e,t,i,n,r,o,s,a,l,c,d,p,u,h,f,g,v,m,y){"use strict";const x=["nearest neighbor","bilinear","bicubic"],w=["nearest","linear","cubic"];let b=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="WCSServer",e}e._inheritsLoose(i,t);var s=i.prototype;return s.open=function(){var t=e._asyncToGenerator((function*(e){yield this.init();const t=null==e?void 0:e.signal,i=yield this._getCapabilities(t);if(this.capabilities=i,!this.version){var r;let e=null==(r=i.capabilitiesVersion)?void 0:r.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=i.capabilitiesVersion:(e=i.supportedVersions.find((e=>"2.0.1"===e))||i.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}null==this.coverageId&&(this.coverageId=i.coverages[0].id);const o=i.coverages.filter((e=>e.id===this.coverageId))[0];if(null==o)throw new n("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const s=yield this._describeCoverage(t);this.coverageInfo=s[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=o.lonLatEnvelope,this.coverageInfo.supportedInterpolations=v.standardizeInterpolations(i.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a),null==a.spatialReference)throw new n("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:c}=yield this._getPixelTypeAndBandCount(t);a.pixelType=l,1===a.bandCount&&c>1&&(a.bandCount=c),this.updateTileInfo()}));function i(e){return t.apply(this,arguments)}return i}(),s.fetchRawTile=function(){var t=e._asyncToGenerator((function*(e,t,i,o={}){if(this.isBlockOutside(e,t,i))return null;const{nativePixelSize:s,spatialReference:a}=this.rasterInfo,l=2**e,c=s.x*l,d=s.y*l,{blockWidth:p,blockHeight:u}=this.getBlockWidthHeight(e),{origin:h}=this.rasterInfo.storageInfo.tileInfo,f=this.getTileExtent({x:c,y:d},t,i,h,a,[p,u]),g=this.rasterInfo.extent,v=f.xmax>g.xmax||f.ymin<g.ymin;let y=f,x=p,w=u;if(v&&(y=f.clone().intersection(g),r.isSome(y)&&(x=Math.floor((y.xmax-y.xmin)/c),w=Math.floor((y.ymax-y.ymin)/d),y.xmax=y.xmin+c*x,y.ymin=y.ymax-d*w)),r.isNone(y)||x<=1||w<=1)return null;const b=yield this._getCoverage(y,x,w,l,o);if(!b)return null;const I=yield this.decodePixelBlock(b,{width:x,height:w,planes:null,pixelType:null});if(I&&(I.width!==x||I.height!==w))throw new n("wcsraster-fetch",`the reponse has unexpected dimension width: ${I.width}, height: {pixelBlock.height}`);return v?m.clip(I,{x:0,y:0},{width:u,height:u}):I}));function i(e,i,n){return t.apply(this,arguments)}return i}(),s._getCapabilities=function(){var t=e._asyncToGenerator((function*(e){const t={service:"WCS",request:"GetCapabilities"};this.version&&(t.version=this.version,t.acceptVersions=this.version);try{const{data:i}=yield this.request(this.url,{query:t,responseType:"xml",signal:e});return g.parseCapabilities(i)}catch(i){if(!o.isAbortError(i))throw new n("wcslayer:open","wcs capabilities is not valid or supported");throw i}}));function i(e){return t.apply(this,arguments)}return i}(),s._describeCoverage=function(){var t=e._asyncToGenerator((function*(e){const t={service:"WCS",request:"DescribeCoverage",version:this.version},i=this.version.slice(0,3);"1.0"===i?t.coverage=this.coverageId:"1.1"===i?t.identifiers=this.coverageId:"2.0"===i&&(t.coverageId=this.coverageId);try{const{data:i}=yield this.request(this.url,{query:t,responseType:"xml",signal:e});return v.parseCoverages(i,this.version)}catch(r){if(!o.isAbortError(r))throw new n("wcslayer:open","wcs coverage description is not valid or supported");throw r}}));function i(e){return t.apply(this,arguments)}return i}(),s._getPixelTypeAndBandCount=function(){var t=e._asyncToGenerator((function*(e){const{pixelSize:t,extent:i,multidimensionalInfo:o}=this.rasterInfo,s=i.center,a=new y({xmin:s.x-t.x,xmax:s.x+t.x,ymin:s.y-t.y,ymax:s.y+t.y,spatialReference:i.spatialReference});let l;if(r.isSome(o)){const e=o.variables[0];l=[],e.dimensions.forEach((t=>{l.push(new p({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values[0],isSlice:!0}))}))}const c=yield this._getCoverage(a,2,2,1,{multidimensionalDefinition:l,signal:r.unwrap(e)});if(!c)throw new n("wcsraster-open","unable to determine pixel type");const d=yield this.decodePixelBlock(c,{width:2,height:2,planes:null,pixelType:null});return{pixelType:d.pixelType,bandCount:d.getPlaneCount()}}));function i(e){return t.apply(this,arguments)}return i}(),s._getCoverage=function(){var t=e._asyncToGenerator((function*(e,t,i,r,o){const{coverageDescription:s}=this.coverageInfo,{version:a}=s,l="2.0"===s.version?this._getCoverage201Parameters(e,t,i,r,o,s):"1.1"===s.version?this._getCoverage110Parameters(e,t,i,o,s):this._getCoverage100Parameters(e,t,i,o),c="2.0"===s.version?yield this.request(this._constructWCS201Url(l),{signal:o.signal,responseType:"array-buffer"}):yield this.request(this.url,{query:l,signal:o.signal,responseType:"array-buffer"});if("1.0"===a)return c.data;const d=f.parse(c);if(d.isMultipart&&d.data){const e=d.data.filter((e=>{var t;return(null==(t=e.contentType)?void 0:t.toLowerCase().includes("image"))&&null!=e.contentData}))[0];return null==e?void 0:e.contentData}if(this.ioConfig.allowAnyMediaType)return c.data;throw new n("wcsraster:getcoverage","response is not a valid coverage, multipart response is expected")}));function i(e,i,n,r,o){return t.apply(this,arguments)}return i}(),s._getInterpolationIndex=function(e){return-1===this.coverageInfo.supportedInterpolations.indexOf(e)||"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0},s._getCoverage100Parameters=function(e,t,i,n){const r=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,o=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"GEOTIFF",{bandIds:a,interpolation:l}=n,c=this._getInterpolationIndex(l),d=a?a.map((e=>this.coverageInfo.bandNames[e])):null,p=x[c];return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${o}`,bbox:r,width:t,height:i,interpolation:p,band:null==d?void 0:d.join(",")}},s._getCoverage110Parameters=function(e,t,i,n,o){var s;const{multidimensionalDefinition:a,bandIds:l,interpolation:c}=n,d=e.spatialReference.wkid,p=`urn:ogc:def:crs:EPSG::${d}`,h=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",f=this._getInterpolationIndex(c),g=w[f],v=null==c||0===(null==(s=this.coverageInfo.supportedInterpolations)?void 0:s.indexOf(c)),m=o.domain.spatialDomain,y=m.origin.x<=m.envelope.xmin&&m.origin.y<=m.envelope.ymin,x=e.width/t,b=e.height/i*(y?1:-1),I=y?[e.xmin,e.ymin]:[e.xmin,e.ymax],C=m.useEPSGAxis&&u.coordsReversedForWKID(d),$=C?`${I[1]},${I[0]}`:`${I[0]},${I[1]}`,S=C?`${b},0,0,${x}`:`${x},0,0,${b}`,_=x/2,T=e.xmin+_,O=e.xmax-_,P=Math.abs(b)/2,E=e.ymin+P,G=e.ymax-P,L=C?`${E},${T},${G},${O},${p}`:`${T},${E},${O},${G},${p}`,j=o.range.filter((e=>e.axis.some((e=>e.identifier.toLowerCase().indexOf("band")>-1))))[0];let R,k=j&&g&&l?v?`${j.identifier}[${j.axis[0].identifier}[${l.join(",")}]]`:`${j.identifier}:${g}[${j.axis[0].identifier}[${l.join(",")}]]`:null;if(r.isSome(a)&&a.length)for(let r=0;r<a.length;r++){let e=a[r].values;const t=a[r].dimensionName.toLowerCase(),i=a[r].variableName.toLowerCase();if(e.length>0)if(e[0]instanceof Array&&(e=e[0]),"stdtime"===t)R=e.map((e=>this._convertToISOTime(e))).join(",");else{const n=o.range.filter((e=>e.identifier.toLowerCase()===i))[0];if(n){const i=n.axis.filter((e=>e.identifier.toLowerCase()===t))[0];i&&(k=v?n.identifier+"["+i.identifier+"["+e.join(",")+"]]":n.identifier+":"+g+"["+i.identifier+"["+e.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:h,crs:`EPSG:${d}`,boundingbox:L,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:$,gridOffsets:S,gridBaseCRS:p,timeSequence:R,rangeSubset:k}},s._convertToISOTime=function(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()},s._getCoverage201Parameters=function(e,t,i,n,o,s){const{multidimensionalDefinition:a,interpolation:l}=o,c=this._getInterpolationIndex(l);let d=null;const{supportedInterpolations:p}=this.capabilities;if(null!=p&&p.length)switch(c){case 0:d=p.find((e=>e.includes("nearest")));break;case 1:d=p.find((e=>e.includes("linear")));break;case 2:d=p.find((e=>e.includes("cubic")||e.includes("quadratic")))}const u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",{bandNames:h}=this.coverageInfo,{boundedBy:f,domainSet:g,rangeType:v}=s,m=f.isEastFirst?0:1,y=1-m,{axisLabels:x}=f,w=x[m],b=x[y],I=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,C=I,$=[];$.push(`${w}(${e.xmin},${e.xmax})`),$.push(`${b}(${e.ymin},${e.ymax})`);const S=[];if(x.length>2)for(let r=2;r<x.length;r++){const e=g.origin[r];if(x[r].toLowerCase().indexOf("time")>-1){let t=e.toString();f.uomLabels[r].toLowerCase().indexOf("ole")>-1&&(S.push(x[r]),t=this._convertToISOTime(e,!0)),$.push(x[r]+",http://www.opengis.net("+t+")")}else $.push(x[r]+",http://www.opengis.net("+e+")")}let _=null;if(r.isSome(a)&&a.length){const e=[];v.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let i=0;i<a.length;i++){const n=x.find((e=>e===a[i].dimensionName)),r=e.find((e=>e===a[i].variableName));if(-1===t.indexOf(r)&&t.push(r),n){let e=a[i].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=n.toLowerCase().indexOf("time")>-1?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const i=$.findIndex((e=>0===e.indexOf(n+",http://www.opengis.net")));-1===i&&$.push(n+",http://www.opengis.net("+t+")"),-1!==i&&-1===$[i].indexOf("("+t+")")&&$.splice(i,1,n+",http://www.opengis.net("+t+")")}}}t.length&&(_=t.join(","))}else if(null!=h&&h.length){_=(o.bandIds?o.bandIds.map((e=>h[e])):h).join(",")}const T=$.join("&subset="),O=!(s.domainSet.axisLabels.join("")===s.boundedBy.axisLabels.join(""))&&!1!==this.ioConfig.allowScaleFactor,P=O?null:`${w}(${t}),${b}(${i})`,E=O?1/n:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:_,interpolation:d,scaleSize:P,scaleFactor:E,subset:T,format:u,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:I,subsettingcrs:C}},s._constructWCS201Url=function(e){const t={...this.ioConfig.customFetchParameters,...e},i=[];Object.keys(t).forEach((e=>{const n=t[e];null!=n&&("subset"===e?n.split("&subset=").forEach((e=>{e&&i.push(`subset=${encodeURIComponent(e)}`)})):i.push(`${e}=${encodeURIComponent(n)}`))}));return`${encodeURI(this.url)}?${i.join("&")}`},i}(h);t.__decorate([s.property({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0),t.__decorate([s.property()],b.prototype,"tileType",void 0),t.__decorate([s.property({type:String,json:{write:!0}})],b.prototype,"version",void 0),t.__decorate([s.property({type:String,json:{write:!0}})],b.prototype,"coverageId",void 0),b=t.__decorate([d.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],b);return b}));
