/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../ogc/crsUtils","../DimensionalDefinition","./BaseRaster","./multipartParser","./wcsCapabilitiesParser","./wcsCoverageParser","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../../../geometry/Extent"],(function(e,t,i,n,r,s,o,a,l,c,d,p,u,h,f,g,m,y,v,w){"use strict";const x=["nearest neighbor","bilinear","bicubic"],b=["nearest","linear","cubic"],C="response is not a supported multipart/related mediaType with inline tiff,  switching to compability mode",I="response is not a supported multipart mediaType with inline tiff",S="response is base64 encoded which may impact layer display performance",$="server returns an exception";let T=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="WCSServer",e}e._inheritsLoose(i,t);var a=i.prototype;return a.open=function(){var t=e._asyncToGenerator((function*(e){yield this.init();const t=e?.signal,i=yield this._getCapabilities(t);if(this.capabilities=i,!this.version){let e=i.capabilitiesVersion?.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=i.capabilitiesVersion:(e=i.supportedVersions.find((e=>"2.0.1"===e))||i.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}const r=i.coverages.filter((e=>null==e.coverageSubType||""===e.coverageSubType||e.coverageSubType?.toLowerCase().startsWith("rectifiedgrid")));null==this.coverageId&&(this.coverageId=r[0].id);const s=r.find((e=>e.id===this.coverageId));if(null==s)throw new n("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const o=yield this._describeCoverage(t);this.coverageInfo=o[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=s.lonLatEnvelope,this.coverageInfo.supportedInterpolations=m.standardizeInterpolations(i.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a),null==a.spatialReference)throw new n("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:c}=yield this._getPixelTypeAndBandCount(t);a.pixelType=l,1===a.bandCount&&c>1&&(a.bandCount=c),this.updateTileInfo()}));function i(e){return t.apply(this,arguments)}return i}(),a.fetchRawTile=function(){var t=e._asyncToGenerator((function*(e,t,i,r={}){if(this.isBlockOutside(e,t,i))return null;const{nativePixelSize:o,spatialReference:a}=this.rasterInfo,l=2**e,c=o.x*l,d=o.y*l,{blockWidth:p,blockHeight:u}=this.getBlockWidthHeight(e),{origin:h}=this.rasterInfo.storageInfo.tileInfo,f=this.getTileExtent({x:c,y:d},t,i,h,a,[p,u]),g=this.rasterInfo.extent,m=f.xmax>g.xmax,y=f.ymin<g.ymin,w=m||y;let x=f,b=p,C=u;if(w&&(x=f.clone().intersection(g),s.isSome(x)&&(m&&(b=Math.floor((x.xmax-x.xmin)/c),x.xmax=x.xmin+c*b),y&&(C=Math.floor((x.ymax-x.ymin)/d),x.ymin=x.ymax-d*C))),s.isNone(x)||b<=1||C<=1)return null;const I=yield this._getCoverage(x,b,C,l,r);if(!I)return null;const{coverageDescription:S}=this.coverageInfo;let{noDataValue:$,multidimensionalInfo:T}=this.rasterInfo;const{multidimensionalDefinition:_}=r;if(s.isSome(T)&&s.isSome(_)&&_.length){const e=_[0].variableName;if("2.0"===S.version){$=S.rangeType[0].find((t=>t.name===e))?.nilValue}else if("1.1"===S.version){$=S.range.find((t=>t.identifier===e))?.nullValues}}const L=yield this.decodePixelBlock(I,{width:b,height:C,planes:null,pixelType:null,noDataValue:Array.isArray($)?$[0]:$});if(null==L)return null;if(L&&(L.width!==b||L.height!==C))throw new n("wcsraster-fetch",`the reponse has unexpected dimension width: ${L.width}, height: {pixelBlock.height}`);return w?v.clip(L,{x:0,y:0},{width:u,height:u}):L}));function i(e,i,n){return t.apply(this,arguments)}return i}(),a._getCapabilities=function(){var t=e._asyncToGenerator((function*(e){const t={service:"WCS",request:"GetCapabilities"};this.version&&(t.version=this.version,t.acceptVersions=this.version);try{const{data:i}=yield this.request(this.url,{query:t,responseType:"xml",signal:e});return g.parseCapabilities(i)}catch(i){if(!o.isAbortError(i))throw new n("wcslayer:open","wcs capabilities is not valid or supported");throw i}}));function i(e){return t.apply(this,arguments)}return i}(),a._describeCoverage=function(){var t=e._asyncToGenerator((function*(e){const t={service:"WCS",request:"DescribeCoverage",version:this.version},i=this.version?.slice(0,3);"1.0"===i?t.coverage=this.coverageId:"1.1"===i?t.identifiers=this.coverageId:"2.0"===i&&(t.coverageId=this.coverageId);try{const{data:i}=yield this.request(this.url,{query:t,responseType:"xml",signal:e});return m.parseCoverages(i,this.version)}catch(r){if(!o.isAbortError(r))throw new n("wcslayer:open","wcs coverage description is not valid or supported");throw r}}));function i(e){return t.apply(this,arguments)}return i}(),a._getPixelTypeAndBandCount=function(){var t=e._asyncToGenerator((function*(e){const{pixelSize:t,extent:i,multidimensionalInfo:o}=this.rasterInfo,a=i.center,l=new w({xmin:a.x-t.x,xmax:a.x+t.x,ymin:a.y-t.y,ymax:a.y+t.y,spatialReference:i.spatialReference});let c=[];if(s.isSome(o)){const e=o.variables[0];c=[],e.dimensions.forEach((t=>{c.push(new u({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values?.[0],isSlice:!0}))}))}const{coverageDescription:d}=this.coverageInfo,p={interpolation:"nearest",multidimensionalDefinition:c,signal:s.unwrap(e)},{version:h}=d,{ioConfig:f}=this,g="2.0"===h&&null==f.allowAnyMediaType||"1.1"===h&&null==f.use2GridOffsets;let m;try{m=yield this._getCoverage(l,2,2,1,p,!0)}catch(v){if(!g)throw v;if("1.1"===h){if(!v.details?.isResolutionMismatch)throw v;f.use2GridOffsets=!0}}if(!m&&g&&("2.0"===h&&(f.allowAnyMediaType=!0),m=yield this._getCoverage(l,2,2,1,p),m&&r.getLogger(this.declaredClass).warn("wcsraster:getcoverage",C)),!m)throw new n("wcsraster-open","unable to determine pixel type");const y=yield this.decodePixelBlock(m,{width:2,height:2,planes:null,pixelType:null});if(null==y)throw new n("wcsraster-open","unable to determine pixel type");return{pixelType:y.pixelType,bandCount:y.getPlaneCount()??0}}));function i(e){return t.apply(this,arguments)}return i}(),a._getCoverage=function(){var t=e._asyncToGenerator((function*(e,t,i,s,o,a=!1){const{coverageDescription:l}=this.coverageInfo,{version:c}=l,d="2.0"===c?this._getCoverage201Parameters(e,t,i,s,o,l):"1.1"===c?this._getCoverage110Parameters(e,t,i,o,l):this._getCoverage100Parameters(e,t,i,o),p="2.0"===c?yield this.request(this._constructWCS201Url(d),{signal:o.signal,responseType:"array-buffer"}):yield this.request(this.url,{query:d,signal:o.signal,responseType:"array-buffer"});if("1.0"===c)return p.data;if("2.0"===c&&!1!==this.ioConfig.allowAnyMediaType){if("tiff"===y.getFormat(p.data))return a&&(this.ioConfig.allowAnyMediaType=!0,r.getLogger(this.declaredClass).warn("wcsraster:getcoverage",C)),p.data}const u=f.parse(p);if(u.isMultipart&&u.data){const e=u.data.find((e=>e.contentType?.toLowerCase().includes("image")&&null!=e.contentData));return a&&"base64"===e?.contentTransferEncoding&&r.getLogger(this.declaredClass).warn("wcsraster:getcoverage",S),e?.contentData}const h=new Uint8Array(p.data,0,Math.min(p.data.byteLength,2e3)),g=String.fromCharCode.apply(null,h).toLowerCase().includes("exception"),m=g&&String.fromCharCode.apply(null,h).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");if(g)throw new n("wcsraster:getcoverage",$,{isResolutionMismatch:m});throw new n("wcsraster:getcoverage",I)}));function i(e,i,n,r,s){return t.apply(this,arguments)}return i}(),a._getInterpolationIndex=function(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0:0},a._getCoverage100Parameters=function(e,t,i,n){const r=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,o=e.spatialReference.wkid,a=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"GEOTIFF",{bandIds:l,interpolation:c}=n,d=this._getInterpolationIndex(c),p=l?l.map((e=>this.coverageInfo.bandNames[e])):null,u=x[d],{multidimensionalDefinition:h}=n;let f;if(s.isSome(h)&&s.isSome(this.rasterInfo.multidimensionalInfo)){let e=h.find((e=>"StdTime"===e.dimensionName))?.values;e&&e.length>0&&(e[0]instanceof Array&&(e=e[0]),f=e.map((e=>this._convertToISOTime(e))).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:a,crs:`EPSG:${o}`,bbox:r,width:t,height:i,time:f,interpolation:u,band:p?.join(",")}},a._getCoverage110Parameters=function(e,t,i,n,r){const{multidimensionalDefinition:o,bandIds:a,interpolation:l}=n,c=e.spatialReference.wkid,d=`urn:ogc:def:crs:EPSG::${c}`,u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",h=this._getInterpolationIndex(l),f=b[h],g=null==l||0===this.coverageInfo.supportedInterpolations?.indexOf(l),m=r.domain.spatialDomain,y=m.origin.x<=m.envelope.xmin&&m.origin.y<=m.envelope.ymin,v=e.width/t,w=e.height/i*(y?1:-1),x=y?[e.xmin,e.ymin]:[e.xmin,e.ymax],C=m.useEPSGAxis&&p.isAxesOrderReversedForWkid(c),I=C?`${x[1]},${x[0]}`:`${x[0]},${x[1]}`,S=this.ioConfig.use2GridOffsets,$=C?S?`${w},${v}`:`${w},0,0,${v}`:S?`${v},${w}`:`${v},0,0,${w}`,T=v/2,_=e.xmin+T,L=e.xmax-T,E=Math.abs(w)/2,G=e.ymin+E,P=e.ymax-E,R=C?`${G},${_},${P},${L},${d}`:`${_},${G},${L},${P},${d}`,A=r.range.find((e=>e.axis.some((e=>e.identifier.toLowerCase().includes("band")))));let D,O=A&&f&&a?g?`${A.identifier}[${A.axis[0].identifier}[${a.join(",")}]]`:`${A.identifier}:${f}[${A.axis[0].identifier}[${a.join(",")}]]`:null;if(s.isSome(o)&&o.length)for(let s=0;s<o.length;s++){let e=o[s].values;const t=o[s].dimensionName?.toLowerCase(),i=o[s].variableName?.toLowerCase();if(e.length>0)if(e[0]instanceof Array&&(e=e[0]),"stdtime"===t)D=e.map((e=>this._convertToISOTime(e))).join(",");else{const n=r.range.find((e=>e.identifier.toLowerCase()===i));if(n){const i=n.axis.find((e=>e.identifier.toLowerCase()===t));i&&(O=g?n.identifier+"["+i.identifier+"["+e.join(",")+"]]":n.identifier+":"+f+"["+i.identifier+"["+e.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:u,crs:`EPSG:${c}`,boundingbox:R,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:I,gridOffsets:$,gridBaseCRS:d,timeSequence:D,rangeSubset:O}},a._convertToISOTime=function(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()},a._getCoverage201Parameters=function(e,t,i,n,r,o){const{multidimensionalDefinition:a,interpolation:l}=r,c=this._getInterpolationIndex(l);let d=null;const{supportedInterpolations:p}=this.capabilities;if(p?.length)switch(c){case 0:d=p.find((e=>e.toLowerCase().includes("nearest")));break;case 1:d=p.find((e=>e.toLowerCase().includes("linear")));break;case 2:d=p.find((e=>e.toLowerCase().includes("cubic")||e.toLowerCase().includes("quadratic")))}const u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",{bandNames:h}=this.coverageInfo,{boundedBy:f,domainSet:g,rangeType:m}=o,y=f.isEastFirst?0:1,v=1-y,{axisLabels:w}=f,x=w[y],b=w[v],C=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,I=C,S=[];S.push(`${x}(${e.xmin},${e.xmax})`),S.push(`${b}(${e.ymin},${e.ymax})`);const $=[];if(w.length>2)for(let s=2;s<w.length;s++){const e=g.origin[s];if(w[s].toLowerCase().includes("time")){let t=e.toString();f.uomLabels?.[s].toLowerCase().includes("ole")&&($.push(w[s]),t=this._convertToISOTime(e,!0)),S.push(w[s]+",http://www.opengis.net("+t+")")}else S.push(w[s]+",http://www.opengis.net("+e+")")}let T=null;if(s.isSome(a)&&a.length){const e=[];m.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let i=0;i<a.length;i++){const n=w.find((e=>e===a[i].dimensionName)),r=e.find((e=>e===a[i].variableName));if(t.includes(r)||t.push(r),n){let e=a[i].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=n.toLowerCase().includes("time")?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const i=S.findIndex((e=>0===e.indexOf(n+",http://www.opengis.net")));-1===i&&S.push(n+",http://www.opengis.net("+t+")"),-1===i||S[i].includes("("+t+")")||S.splice(i,1,n+",http://www.opengis.net("+t+")")}}}t.length&&(T=t.join(","))}else if(h?.length>=2){T=(r.bandIds?r.bandIds.map((e=>h[e])):h).join(",")}const _=S.join("&subset="),L=!o.domainSet.hasSameAxisLabelsAsBoundedBy&&!1!==this.ioConfig.allowScaleFactor,E=L?null:`${x}(${t}),${b}(${i})`,G=L?1/n:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:T,interpolation:d,scaleSize:E,scaleFactor:G,subset:_,format:u,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:C,subsettingcrs:I}},a._constructWCS201Url=function(e){const t={...this.ioConfig.customFetchParameters,...e},i=[];Object.keys(t).forEach((e=>{const n=t[e];null!=n&&("subset"===e?n.split("&subset=").forEach((e=>{e&&i.push(`subset=${encodeURIComponent(e)}`)})):i.push(`${e}=${encodeURIComponent(n)}`))}));return`${encodeURI(this.url)}?${i.join("&")}`},i}(h);t.__decorate([a.property({type:String,json:{write:!0}})],T.prototype,"datasetFormat",void 0),t.__decorate([a.property()],T.prototype,"tileType",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],T.prototype,"version",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],T.prototype,"coverageId",void 0),T=t.__decorate([d.subclass("esri.layers.support.rasterDatasets.WCSRaster")],T);return T}));
