/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../request","../../../core/Error","../../../core/JSONSupport","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../arcgisLayerUrl","../commonProperties","../RasterStorageInfo","../TileInfo","./RawBlockCache","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../rasterFunctions/rasterProjectionHelper","../rasterFunctions/vectorFieldUtils","../../../geometry/Point","../../../geometry/Extent"],(function(e,t,n,r,o,i,s,a,l,c,u,f,h,m,d,p,x,y,g,I,R,v,w,k,T,b){"use strict";const _=8;let C=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}e._inheritsLoose(n,t);var i=n.prototype;return i.init=function(){var t=e._asyncToGenerator((function*(){const e=w.load();this.addResolvingPromise(e),yield this.when()}));function n(){return t.apply(this,arguments)}return n}(),i.normalizeCtorArgs=function(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:g.create(),...e.ioConfig}}),e},i.open=function(){var t=e._asyncToGenerator((function*(e){throw new o("BaseRaster:open-not-implemented","open() is not implemented")}));function n(e){return t.apply(this,arguments)}return n}(),i.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){const o=r.tileInfo||this.rasterInfo.storageInfo.tileInfo,i=this.getTileExtentFromTileInfo(e,t,n,o);return this.fetchPixels(i,o.size[0],o.size[1],r)}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i.identify=function(){var t=e._asyncToGenerator((function*(e,t={}){t=this._getRequestOptionsWithSliceId(t);const{spatialReference:n,extent:r}=this.rasterInfo,{datumTransformation:o}=t;let i=w.projectPoint(e,n,o);if(!r.intersects(i))return{location:i,value:null};if(a.isSome(this.rasterInfo.transform)){const e=this.rasterInfo.transform.inverseTransform(i);if(!this.rasterInfo.nativeExtent.intersects(e))return{location:e,value:null};i=e}let s=0;if(t.srcResolution){s=w.snapPyramid(t.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel}else if(s=yield this.computeBestPyramidLevelForLocation(e,t),null==s)return{location:i,value:null};const l=this.identifyPixelLocation(i,s,null);if(null===l)return{location:i,value:null};const{row:c,col:u,rowOffset:f,colOffset:h}=l,m=I.getRasterId(this.url,t.sliceId),d=`${s}/${c}/${u}`;let p=I.getBlock(m,null,d);a.isNone(p)&&(p=this.fetchRawTile(s,c,u,t),I.putBlock(m,null,d,p));const x=yield p;if(a.isNone(x)||!x.pixels||0===x.pixels.length)return{location:i,value:null};const y=f*this.rasterInfo.storageInfo.blockHeight+h,g=!x.mask||x.mask[y]?x.pixels.map((e=>e[y])):null,R=this.rasterInfo.dataType;if(("vector-magdir"===R||"vector-uv"===R)&&(null==g?void 0:g.length)>1){return{location:i,value:g,magdirValue:"vector-magdir"===R?[g[0],g[1]]:k.uvComponentToVector([g[0],g[1]]),pyramidLevel:s}}return{location:i,value:g,pyramidLevel:s}}));function n(e){return t.apply(this,arguments)}return n}(),i.fetchPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){e=w.snapExtent(e);const o=w.getWorldWidth(e.spatialReference),i=w.getWorldWrapCount(e),s=w.getWorldWidth(this.rasterInfo.spatialReference),l=a.isSome(s)&&this.rasterInfo.extent.width>=s/2;if(r=this._getRequestOptionsWithSliceId(r),a.isNone(o)||0===i||1===i&&l)return this._fetchPixels(e,t,n,r);if(i>=3)return{extent:e,pixelBlock:null};const c=[],{xmin:u,xmax:f}=e,h=Math.round(o/(f-u)*t),m=h-Math.round((o/2-u)/(f-u)*t);let d=0;const p=[];for(let a=0;a<=i;a++){const s=new b({xmin:0===a?u:-o/2,xmax:a===i?f-o*a:o/2,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference}),l=0===a?h-m:a===i?t-d:h;d+=l,p.push(l);const x=this._fetchPixels(s,l,n,r);c.push(x)}const x=(yield Promise.all(c)).map((e=>null==e?void 0:e.pixelBlock));let y=null;const g={width:t,height:n};y=this.rasterJobHandler?yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:x,srcMosaicSize:g,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:p},r):v.mosaic(x,g,{blockWidths:p});return{extent:e,srcExtent:w.projectExtent(e,this.rasterInfo.spatialReference,r.datumTransformation),pixelBlock:y}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i.fetchRawPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r){const{origin:o,blockBoundary:i}=this.rasterInfo.storageInfo,{blockWidth:s,blockHeight:l}=this.getBlockWidthHeight(e);let{x:c,y:u}=t,{width:f,height:h,wrapCount:m}=n;const d=a.unwrap(this._getRasterTileAlignmentInfo(e,0));r.buffer&&(c-=r.buffer.cols,u-=r.buffer.rows,f+=2*r.buffer.cols,h+=2*r.buffer.rows);const p=Math.floor(c/s),x=Math.floor(u/l),y=Math.floor((c+f-1)/s),g=Math.floor((u+h-1)/l),I=i[e];if(!I)return null;const{minRow:R,minCol:v,maxCol:w,maxRow:k}=I;if(0===m&&(g<R||y<v||x>k||p>w))return null;const T=new Array;let _=!1;const C=null==this.ioConfig.allowPartialFill?r.allowPartialFill:this.ioConfig.allowPartialFill;for(let a=x;a<=g;a++)for(let t=p;t<=y;t++){const n=0===m||null==d||t<d.worldColumnCountFromOrigin?t:t%d.worldColumnCountFromOrigin-d.originColumnOffset;if(a>=R&&n>=v&&k>=a&&w>=n){const t=this._fetchRawTile(e,a,n,r);C?T.push(new Promise((e=>{t.then((t=>e(t))).catch((()=>{_=!0,e(null)}))}))):T.push(t)}else T.push(null)}if(0===T.length)return null;const S=yield Promise.all(T),P={height:(g-x+1)*l,width:(y-p+1)*s},{spatialReference:M}=this.rasterInfo,B=this.getPyramidPixelSize(e),{x:W,y:F}=B;return{extent:new b({xmin:o.x+p*s*W,xmax:o.x+(y+1)*s*W,ymin:o.y-(g+1)*l*F,ymax:o.y-x*l*F,spatialReference:M}),pixelBlocks:S,mosaicSize:P,isPartiallyFilled:_}}));function n(e,n,r,o){return t.apply(this,arguments)}return n}(),i.fetchRawTile=function(e,t,n,r){throw new o("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")},i.computeExtent=function(e){return w.projectExtent(this.rasterInfo.extent,e)},i.decodePixelBlock=function(e,t){return!this.rasterJobHandler||t.useCanvas?R.decode(e,t):this.rasterJobHandler.decode({data:e,options:t})},i.request=function(){var t=e._asyncToGenerator((function*(e,t,n){var o,i;const{customFetchParameters:s}=this.ioConfig,{range:a,query:l,headers:c}=t;n=null!=(o=null!=(i=n)?i:t.retryCount)?o:this.ioConfig.retryCount;const u=a?{Range:`bytes=${a.from}-${a.to}`}:null;try{return yield r(e,{...t,query:{...l,...s},headers:{...c,...u}})}catch(f){if(n>0)return n--,this.request(e,t,n);throw f}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i.getSliceIndex=function(e){const{multidimensionalInfo:t}=this.rasterInfo;if(!a.isSome(t))return null;if(!a.isSome(e)||0===e.length)return null;let n=0;const r=e[0].variableName;for(let o=0;o<t.variables.length;o++){const i=t.variables[o],s=i.dimensions;if(i.name!==r){n+=s.map((e=>this._getDimensionValuesCount(e))).reduce(((e,t)=>e+t));break}const a=s.map((e=>this._getDimensionValuesCount(e))),l=s.length;for(let t=0;t<l;t++){const r=e.filter((e=>e.dimensionName===s[t].name))[0];if(null==r)return null;const o=Array.isArray(r.values[0])?r.values[0][0]:r.values[0],i=this._getIndexFromDimensions(o,s[t]);if(-1===i)return null;a.shift(),n+=t===l-1?i:i*a.reduce(((e,t)=>e+t))}}return n},i.getTileExtentFromTileInfo=function(e,t,n,r){const o=r.lodAt(e);return this.getTileExtent({x:o.resolution,y:o.resolution},t,n,r.origin,r.spatialReference,r.size)},i.updateTileInfo=function(){const{storageInfo:e,spatialReference:t,extent:n,pixelSize:r}=this.rasterInfo;if(!e.tileInfo){const o=[],i=e.maximumPyramidLevel||0;let s=Math.max(r.x,r.y),a=1/.0254*96*s;for(let e=0;e<=i;e++)o.push({level:i-e,resolution:s,scale:a}),s*=2,a*=2;const l=new T({x:n.xmin,y:n.ymax,spatialReference:t});e.tileInfo=new g({origin:l,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:o}),e.isVirtualTileInfo=!0}},i.createRemoteDatasetStorageInfo=function(e,t=512,n=512,r){const{width:o,height:i,nativeExtent:s,pixelSize:a,spatialReference:l}=e,c=new T({x:s.xmin,y:s.ymax,spatialReference:l});null==r&&(r=Math.max(0,Math.round(Math.log(Math.max(o,i))/Math.LN2-8)));const u=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[a],r);e.storageInfo=new y({blockWidth:t,blockHeight:n,pyramidBlockWidth:t,pyramidBlockHeight:n,origin:c,firstPyramidLevel:1,maximumPyramidLevel:r,blockBoundary:u})},i.computeBestPyramidLevelForLocation=function(){var t=e._asyncToGenerator((function*(e,t={}){return 0}));function n(e){return t.apply(this,arguments)}return n}(),i.computeBlockBoundary=function(e,t,n,r,o,i=0,s=2){if(1===o.length&&i>0){o=[...o];let{x:e,y:t}=o[0];for(let n=0;n<i;n++)e*=s,t*=s,o.push({x:e,y:t})}const a=[],{x:l,y:c}=r;for(let u=0;u<o.length;u++){const{x:r,y:i}=o[u];a.push({minCol:Math.floor((e.xmin-l+.1*r)/t/r),maxCol:Math.floor((e.xmax-l-.1*r)/t/r),minRow:Math.floor((c-e.ymax+.1*i)/n/i),maxRow:Math.floor((c-e.ymin-.1*i)/n/i)})}return a},i.getPyramidPixelSize=function(e){const{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:n,pyramidScalingFactor:r}=this.rasterInfo.storageInfo;if(0===e)return t;if(a.isSome(n)&&n.length)return n[e-1];const o=r**e;return{x:t.x*o,y:t.y*o}},i.identifyPixelLocation=function(e,t,n){const{spatialReference:r,nativeExtent:o}=this.rasterInfo,{blockWidth:i,blockHeight:s,maximumPyramidLevel:a,origin:l}=this.rasterInfo.storageInfo,c=w.projectPoint(e,r,n);if(!o.intersects(c))return null;if(t<0||t>a)return null;const u=this.getPyramidPixelSize(t),{x:f,y:h}=u,m=(l.y-c.y)/h/s,d=(c.x-l.x)/f/i,p=Math.min(s-1,Math.floor((m-Math.floor(m))*s)),x=Math.min(i-1,Math.floor((d-Math.floor(d))*i));return{pyramidLevel:t,row:Math.floor(m),col:Math.floor(d),rowOffset:p,colOffset:x,srcLocation:c}},i.getTileExtent=function(e,t,n,r,o,i){const[s,a]=i,l=r.x+n*s*e.x,c=l+s*e.x,u=r.y-t*a*e.y,f=u-a*e.y;return new b({xmin:l,xmax:c,ymin:f,ymax:u,spatialReference:o})},i.getBlockWidthHeight=function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}},i.isBlockOutside=function(e,t,n){const r=this.rasterInfo.storageInfo.blockBoundary[e];return!r||r.maxRow<t||r.maxCol<n||r.minRow>t||r.minCol>n},i._fetchPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){let o=w.getWorldWrapCount(e);if(o>=2)return{extent:e,pixelBlock:null};const i=this._getSourceDataInfo(e,t,n,r),{pyramidLevel:s,pyramidResolution:l,srcResolution:c,srcExtent:u,srcWidth:f,srcHeight:h}=i;if(0===f||0===h)return{extent:e,srcExtent:u,pixelBlock:null};const m=a.unwrap(this.rasterInfo.transform);"gcs-shift"===(null==m?void 0:m.type)&&(o=w.getWorldWrapCount(i.srcExtent,!0));const d=this.rasterInfo.storageInfo,p={x:Math.floor((u.xmin-d.origin.x)/l.x+.1),y:Math.floor((d.origin.y-u.ymax)/l.y+.1)},x=yield this.fetchRawPixels(s,p,{width:f,height:h,wrapCount:o},r);if(!x)return{extent:e,srcExtent:u,pixelBlock:null};const y=s>0?d.pyramidBlockWidth:d.blockWidth,g=s>0?d.pyramidBlockHeight:d.blockHeight,I=y===f&&g===h&&p.x%y==0&&p.y%g==0,R=new T({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/n,spatialReference:e.spatialReference}),k=!e.spatialReference.equals(this.rasterInfo.spatialReference),{datumTransformation:b}=r;if(!k&&I&&1===x.pixelBlocks.length&&y===t&&g===n&&c.x===R.x&&c.y===R.y)return{extent:e,srcExtent:u,pixelBlock:x.pixelBlocks[0]};const _=this.rasterJobHandler?yield this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:x.extent,pixelSize:R.toJSON(),datumTransformation:b,rasterTransform:m,hasWrapAround:o>0,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy},r):w.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:x.extent,pixelSize:R,datumTransformation:b,rasterTransform:m,hasWrapAround:o>0,isAdaptive:!1});let C;const S=!r.requestRawData,P={rows:_.spacing[0],cols:_.spacing[1]},M=a.unwrap(this._getRasterTileAlignmentInfo(s,x.extent.xmin)),{pixelBlocks:B,mosaicSize:W,isPartiallyFilled:F}=x;if(this.rasterJobHandler)C=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:B,srcMosaicSize:W,destDimension:S?{width:t,height:n}:null,coefs:S?_.coefficients:null,sampleSpacing:S?P:null,interpolation:r.interpolation,alignmentInfo:M,blockWidths:null},r);else{const e=v.mosaic(B,W,{alignmentInfo:M});C=S?v.approximateTransform(e,{width:t,height:n},_.coefficients,P,r.interpolation):e}return r.requestRawData?{srcExtent:u,pixelBlock:C,transformGrid:_,extent:e,isPartiallyFilled:F}:{srcExtent:u,extent:e,pixelBlock:C}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i._fetchRawTile=function(e,t,n,r){const o=this.rasterInfo.storageInfo.blockBoundary[e];if(!o)return Promise.resolve(null);const{minRow:i,minCol:s,maxCol:l,maxRow:u}=o;if(t<i||n<s||t>u||n>l)return Promise.resolve(null);const f=I.getRasterId(this.url,r.sliceId),h=`${e}/${t}/${n}`;let m=I.getBlock(f,r.registryId,h);if(a.isNone(m)){const o=new AbortController;m=this.fetchRawTile(e,t,n,{...r,signal:o.signal}),I.putBlock(f,r.registryId,h,m,o),m.catch((()=>I.deleteBlock(f,r.registryId,h)))}return r.signal&&c.onAbort(r,(()=>{I.decreaseRefCount(f,r.registryId,h)})),m},i._getIndexFromDimensions=function(e,t){const{extent:n,interval:r,unit:o,values:i}=t;if(null!=i&&i.length)return Array.isArray(i[0])?i.findIndex((t=>t[0]<=e&&t[1]>=e)):i.indexOf(e);if(e>n[1])return-1;const s=n[0];let a=-1;if("ISO8601"===o){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":a=Math.round((e-s)/1e3/r);break;case"minutes":a=Math.round((e-s)/6e4/r);break;case"hours":a=Math.round((e-s)/36e5/r);break;case"days":a=Math.round((e-s)/864e5/r);break;case"years":a=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/r);break;case"decades":a=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/r)}return a}return Math.round((e-s)/r)},i._getDimensionValuesCount=function(e){const{extent:t,interval:n,unit:r,values:o}=e;let i=(null==o?void 0:o.length)||0;if(i)return i;const s=t[0];if(0===i&&"ISO8601"===r){var a;switch((null==(a=e.intervalUnit)?void 0:a.toLowerCase())||"seconds"){case"seconds":i=Math.round((t[1]-t[0])/1e3/n);break;case"minutes":i=Math.round((t[1]-t[0])/6e4/n);break;case"hours":i=Math.round((t[1]-t[0])/36e5/n);break;case"days":i=Math.round((t[1]-t[0])/864e5/n);break;case"years":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/n);break;case"decades":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/10/n)}return i}return Math.round((t[1]-t[0])/n)},i._getRasterTileAlignmentInfo=function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=w.getRasterDatasetAlignmentInfo(this.rasterInfo)),a.isSome(this._rasterTileAlighmentInfo.pyramidsInfo)?{startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[e]}:null},i._getSourceDataInfo=function(e,t,n,r={}){const o={datumTransformation:r.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0};r.srcResolution&&(o.srcResolution=r.srcResolution,this._updateSourceDataInfo(e,o));const i=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:s,srcHeight:a,pyramidLevel:l}=o,c=s/t,u=a/n,f=l<i&&c*u>=16;if(f||l===i&&(c>_||u>_)||(0===s||0===a)){const s=new T({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/n,spatialReference:e.spatialReference});let a=w.projectResolution(s,this.rasterInfo.spatialReference,e,o.datumTransformation);const h=!a||r.srcResolution&&a.x+a.y<r.srcResolution.x+r.srcResolution.y;if(f&&r.srcResolution&&h){const e=Math.round(Math.log(Math.max(c,u))/Math.LN2)-1;if(i-l+3>=e){const t=2**e;a={x:r.srcResolution.x*t,y:r.srcResolution.y*t}}}a&&(o.srcResolution=a,this._updateSourceDataInfo(e,o))}return(o.srcWidth/t>_||o.srcHeight/n>_)&&(o.srcWidth=0,o.srcHeight=0),o},i._updateSourceDataInfo=function(e,t){t.srcWidth=0,t.srcHeight=0;const n=this.rasterInfo.spatialReference,{srcResolution:r,datumTransformation:o}=t,{pyramidLevel:i,pyramidResolution:s,excessiveReading:l}=w.snapPyramid(r,this.rasterInfo,this.ioConfig.sampling);if(l)return;let c=t.srcExtent||w.projectExtent(e,n,o);if(null==c)return;const u=a.unwrap(this.rasterInfo.transform);u&&(c=u.inverseTransform(c)),t.srcExtent=c;const f=Math.ceil((c.xmax-c.xmin)/s.x-.1),h=Math.ceil((c.ymax-c.ymin)/s.y-.1);t.pyramidLevel=i,t.pyramidResolution=s,t.srcWidth=f,t.srcHeight=h},i._getRequestOptionsWithSliceId=function(e){return a.isSome(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e={...e,sliceId:this.getSliceIndex(e.multidimensionalDefinition)}),e},e._createClass(n,[{key:"url",set:function(e){this._set("url",p.sanitizeUrl(e,s.getLogger(this.declaredClass)))}}]),n}(l.EsriPromiseMixin(i.JSONSupport));t.__decorate([u.property()],C.prototype,"_rasterTileAlighmentInfo",void 0),t.__decorate([u.property(x.url)],C.prototype,"url",null),t.__decorate([u.property({type:String,json:{write:!0}})],C.prototype,"datasetName",void 0),t.__decorate([u.property({type:String,json:{write:!0}})],C.prototype,"datasetFormat",void 0),t.__decorate([u.property()],C.prototype,"rasterInfo",void 0),t.__decorate([u.property()],C.prototype,"ioConfig",void 0),t.__decorate([u.property()],C.prototype,"sourceJSON",void 0),C=t.__decorate([d.subclass("esri.layers.support.rasterDatasets.BaseRaster")],C);return C}));
