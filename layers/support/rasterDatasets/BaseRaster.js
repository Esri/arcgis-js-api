/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../request","../../../core/Error","../../../core/JSONSupport","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../arcgisLayerUrl","../commonProperties","../RasterStorageInfo","../TileInfo","./RawBlockCache","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../rasterFunctions/rasterProjectionHelper","../../../geometry/Point","../../../geometry/Extent"],(function(e,t,n,r,o,i,s,a,l,c,u,f,h,m,d,p,y,g,x,I,w,v,k,R){"use strict";let b=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}e._inheritsLoose(n,t);var i=n.prototype;return i.init=function(){var t=e._asyncToGenerator((function*(){const e=v.load();this.addResolvingPromise(e),yield this.when()}));function n(){return t.apply(this,arguments)}return n}(),i.normalizeCtorArgs=function(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:g.create(),...e.ioConfig}}),e},i.open=function(){var t=e._asyncToGenerator((function*(e){throw new o("BaseRaster:open-not-implemented","open() is not implemented")}));function n(e){return t.apply(this,arguments)}return n}(),i.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){var o;const{tileInfo:i}=r,s=i.lodAt(e),l=this.getTileExtent({x:s.resolution,y:s.resolution},t,n,i.origin,i.spatialReference,i.size);return null!=(o=r.multidimensionalDefinition)&&o.length&&a.isSome(this.rasterInfo.multidimensionalInfo)&&null==r.sliceId&&(r={...r,sliceId:this.getSliceIndex(r.multidimensionalDefinition)||0}),this.fetchPixels(l,i.size[0],i.size[1],r)}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i.identify=function(){var t=e._asyncToGenerator((function*(e,t={}){const{spatialReference:n,extent:r}=this.rasterInfo,{datumTransformation:o}=t;let i=v.projectPoint(e,n,o);if(!r.intersects(i))return{location:i,value:null};if(a.isSome(this.rasterInfo.transform)){const e=this.rasterInfo.transform.inverseTransform(i);if(!this.rasterInfo.nativeExtent.intersects(e))return{location:e,value:null};i=e}let s=0;if(t.srcResolution){s=v.snapPyramid(t.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel}else if(s=yield this.computeBestPyramidLevelForLocation(e,t),null==s)return{location:i,value:null};const l=this.identifyPixelLocation(i,s,null);if(null===l)return{location:i,value:null};const{row:c,col:u,rowOffset:f,colOffset:h}=l,m=x.getRasterId(this.url,t.sliceId),d=`${s}/${c}/${u}`;let p=x.getBlock(m,null,d);a.isSome(p)||(p=this.fetchRawTile(s,c,u,t),x.putBlock(m,null,d,p));const y=yield p;if(!(y&&y.pixels&&y.pixels.length>0))return{location:i,value:null};const g=f*this.rasterInfo.storageInfo.blockHeight+h;return{location:i,value:!y.mask||y.mask[g]?y.pixels.map((e=>e[g])):null,pyramidLevel:s}}));function n(e){return t.apply(this,arguments)}return n}(),i.fetchPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){e=v.snapExtent(e);const o=v.getWorldWrapCount(e),i=this.rasterInfo.spatialReference,s=!e.spatialReference.equals(i),{datumTransformation:l}=r,c=new k({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/n,spatialReference:e.spatialReference}),u=r.srcResolution||(s?v.projectResolution(c,i,e,l):c);if(!u)return null;const{pyramidLevel:f,pyramidResolution:h,excessiveReading:m}=v.snapPyramid(u,this.rasterInfo,this.ioConfig.sampling);if(m)return null;const d=this.rasterInfo.storageInfo;let p=s?v.projectExtent(e,i,l):e;const y=a.unwrap(this.rasterInfo.transform);if(y&&(p=y.inverseTransform(p)),null==p)return null;const g={x:Math.floor((p.xmin-d.origin.x)/h.x+.1),y:Math.floor((d.origin.y-p.ymax)/h.y+.1)},x=Math.ceil((p.xmax-p.xmin)/h.x-.1),I=Math.ceil((p.ymax-p.ymin)/h.y-.1);if(x/t>8||I/n>8||o>=2)return null;const R=yield this.fetchRawPixels(f,g,{width:x,height:I,wrapCount:o},r);if(!R)return null;const b=f>0?d.pyramidBlockWidth:d.blockWidth,C=f>0?d.pyramidBlockHeight:d.blockHeight;if(!s&&1===R.pixelBlocks.length&&b===t&&C===n&&u.x===c.x&&u.y===c.y)return{extent:e,srcExtent:p,pixelBlock:R.pixelBlocks[0]};const T=v.getProjectionOffsetGrid(e,R.extent,c,l,y,o>0);let _;const M=!r.requestRawData,P={rows:T.spacing[0],cols:T.spacing[1]},S=a.unwrap(this._getRasterTileAlignmentInfo(f,R.extent.xmin)),{pixelBlocks:B,mosaicSize:F,isPartiallyFilled:L}=R;if(this.rasterJobHandler)_=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:B,srcMosaicSize:F,destDimension:M?{width:t,height:n}:null,coefs:M?T.coefficients:null,sampleSpacing:M?P:null,interpolation:r.interpolation,alignmentInfo:S},r);else{const e=w.mosaic(B,F,null,null,S);_=M?w.approximateTransform(e,{width:t,height:n},T.coefficients,P,r.interpolation):e}return r.requestRawData?{srcExtent:p,pixelBlock:_,transformGrid:T,extent:e,isPartiallyFilled:L}:{srcExtent:p,extent:e,pixelBlock:_}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i.fetchRawPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r){const{origin:o,blockBoundary:i}=this.rasterInfo.storageInfo,{blockWidth:s,blockHeight:l}=this.getBlockWidthHeight(e);let{x:c,y:u}=t,{width:f,height:h,wrapCount:m}=n;const d=a.unwrap(this._getRasterTileAlignmentInfo(e,0));r.buffer&&(c-=r.buffer.cols,u-=r.buffer.rows,f+=2*r.buffer.cols,h+=2*r.buffer.rows);const p=Math.floor(c/s),y=Math.floor(u/l),g=Math.floor((c+f-1)/s),x=Math.floor((u+h-1)/l),I=i[e];if(!I)return null;const{minRow:w,minCol:v,maxCol:k,maxRow:b}=I;if(x<w||g<v||y>b||p>k)return null;const C=[];let T,_=!1;for(let a=y;a<=x;a++)for(let t=p;t<=g;t++){const n=0===m||null==d||t<d.worldColumnCountFromOrigin?t:t%d.worldColumnCountFromOrigin-d.originColumnOffset;a>=w&&n>=v&&b>=a&&k>=n?(T=this._fetchRawTile(e,a,n,r),this.ioConfig.allowPartialFill&&(T=new Promise((e=>{T.then((t=>e(t))).catch((()=>{_=!0,e(null)}))}))),C.push(T)):C.push(null)}if(0===C.length)return null;const M=yield Promise.all(C),P={height:(x-y+1)*l,width:(g-p+1)*s},{spatialReference:S}=this.rasterInfo,B=this.getPyramidPixelSize(e),{x:F,y:L}=B;return{extent:new R({xmin:o.x+p*s*F,xmax:o.x+(g+1)*s*F,ymin:o.y-(x+1)*l*L,ymax:o.y-y*l*L,spatialReference:S}),pixelBlocks:M,mosaicSize:P,isPartiallyFilled:_}}));function n(e,n,r,o){return t.apply(this,arguments)}return n}(),i.fetchRawTile=function(){var t=e._asyncToGenerator((function*(e,t,n,r){throw new o("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}));function n(e,n,r,o){return t.apply(this,arguments)}return n}(),i.computeExtent=function(e){return v.projectExtent(this.rasterInfo.extent,e)},i.decodePixelBlock=function(e,t){return!this.rasterJobHandler||t.useCanvas?I.decode(e,t):this.rasterJobHandler.decode({data:e,options:t})},i.request=function(){var t=e._asyncToGenerator((function*(e,t,n){var o,i;const{customFetchParameters:s}=this.ioConfig,{range:a,query:l,headers:c}=t;n=null!=(o=null!=(i=n)?i:t.retryCount)?o:this.ioConfig.retryCount;const u=a?{Range:`bytes=${a.from}-${a.to}`}:null;try{return yield r(e,{...t,query:{...l,...s},headers:{...c,...u}})}catch(f){if(n>0)return n--,this.request(e,t,n);throw f}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),i.getSliceIndex=function(e){const{multidimensionalInfo:t}=this.rasterInfo;if(!a.isSome(t)||null==e||!e.length)return null;let n=0;const r=e[0].variableName;for(let o=0;o<t.variables.length;o++){const i=t.variables[o],s=i.dimensions;if(i.name!==r){n+=s.map((e=>this._getDimensionValuesCount(e))).reduce(((e,t)=>e+t));break}const a=s.map((e=>this._getDimensionValuesCount(e))),l=s.length;for(let t=0;t<l;t++){const r=e.filter((e=>e.dimensionName===s[t].name))[0];if(null==r)return null;const o=Array.isArray(r.values[0])?r.values[0][0]:r.values[0],i=this._getIndexFromDimensions(o,s[t]);if(-1===i)return null;a.shift(),n+=t===l-1?i:i*a.reduce(((e,t)=>e+t))}}return n},i.updateTileInfo=function(){const{storageInfo:e,spatialReference:t,extent:n,pixelSize:r}=this.rasterInfo;if(!e.tileInfo){const o=[],i=e.maximumPyramidLevel||0;let s=Math.max(r.x,r.y),a=1/.0254*96*s;for(let e=0;e<=i;e++)o.push({level:i-e,resolution:s,scale:a}),s*=2,a*=2;const l=new k({x:n.xmin,y:n.ymax,spatialReference:t});e.tileInfo=new g({origin:l,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:o}),e.isVirtualTileInfo=!0}},i.createRemoteDatasetStorageInfo=function(e,t=512,n=512,r){const{width:o,height:i,nativeExtent:s,pixelSize:a,spatialReference:l}=e,c=new k({x:s.xmin,y:s.ymax,spatialReference:l});null==r&&(r=Math.max(0,Math.round(Math.log(Math.max(o,i))/Math.LN2-8)));const u=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[a],r);e.storageInfo=new y({blockWidth:t,blockHeight:n,pyramidBlockWidth:t,pyramidBlockHeight:n,origin:c,firstPyramidLevel:1,maximumPyramidLevel:r,blockBoundary:u})},i.computeBestPyramidLevelForLocation=function(){var t=e._asyncToGenerator((function*(e,t={}){return 0}));function n(e){return t.apply(this,arguments)}return n}(),i.computeBlockBoundary=function(e,t,n,r,o,i=0,s=2){if(1===o.length&&i>0){o=[...o];let{x:e,y:t}=o[0];for(let n=0;n<i;n++)e*=s,t*=s,o.push({x:e,y:t})}const a=[],{x:l,y:c}=r;for(let u=0;u<o.length;u++){const{x:r,y:i}=o[u];a.push({minCol:Math.floor((e.xmin-l+.1*r)/t/r),maxCol:Math.floor((e.xmax-l-.1*r)/t/r),minRow:Math.floor((c-e.ymax+.1*i)/n/i),maxRow:Math.floor((c-e.ymin-.1*i)/n/i)})}return a},i.getPyramidPixelSize=function(e){const{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:n,pyramidScalingFactor:r}=this.rasterInfo.storageInfo;if(0===e)return t;if(a.isSome(n)&&n.length)return n[e-1];const o=r**e;return{x:t.x*o,y:t.y*o}},i.identifyPixelLocation=function(e,t,n){const{spatialReference:r,nativeExtent:o}=this.rasterInfo,{blockWidth:i,blockHeight:s,maximumPyramidLevel:a,origin:l}=this.rasterInfo.storageInfo,c=v.projectPoint(e,r,n);if(!o.intersects(c))return null;if(t<0||t>a)return null;const u=this.getPyramidPixelSize(t),{x:f,y:h}=u,m=(l.y-c.y)/h/s,d=(c.x-l.x)/f/i,p=Math.min(s-1,Math.floor((m-Math.floor(m))*s)),y=Math.min(i-1,Math.floor((d-Math.floor(d))*i));return{pyramidLevel:t,row:Math.floor(m),col:Math.floor(d),rowOffset:p,colOffset:y,srcLocation:c}},i.getTileExtent=function(e,t,n,r,o,i){const[s,a]=i,l=r.x+n*s*e.x,c=l+s*e.x,u=r.y-t*a*e.y,f=u-a*e.y;return new R({xmin:l,xmax:c,ymin:f,ymax:u,spatialReference:o})},i.getBlockWidthHeight=function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}},i.isBlockOutside=function(e,t,n){const r=this.rasterInfo.storageInfo.blockBoundary[e];return!r||r.maxRow<t||r.maxCol<n||r.minRow>t||r.minCol>n},i._fetchRawTile=function(e,t,n,r){const o=this.rasterInfo.storageInfo.blockBoundary[e];if(!o)return Promise.resolve(null);const{minRow:i,minCol:s,maxCol:l,maxRow:u}=o;if(t<i||n<s||t>u||n>l)return Promise.resolve(null);const f=x.getRasterId(this.url,r.sliceId),h=`${e}/${t}/${n}`;let m=x.getBlock(f,r.registryId,h);if(!a.isSome(m)){const o=c.createAbortController();m=this.fetchRawTile(e,t,n,{...r,signal:o.signal}),x.putBlock(f,r.registryId,h,m,o),m.catch((()=>{x.deleteBlock(f,r.registryId,h)}))}return r.signal&&c.onAbort(r,(()=>{x.decreaseRefCount(f,r.registryId,h)})),m},i._getIndexFromDimensions=function(e,t){const{extent:n,interval:r,unit:o,values:i}=t;if(null!=i&&i.length)return Array.isArray(i[0])?i.findIndex((t=>t[0]<=e&&t[1]>=e)):i.indexOf(e);if(e>n[1])return-1;const s=n[0];let a=-1;if("ISO8601"===o){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":a=Math.round((e-s)/1e3/r);break;case"minutes":a=Math.round((e-s)/6e4/r);break;case"hours":a=Math.round((e-s)/36e5/r);break;case"days":a=Math.round((e-s)/864e5/r);break;case"years":a=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/r);break;case"decades":a=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/r)}return a}return Math.round((e-s)/r)},i._getDimensionValuesCount=function(e){const{extent:t,interval:n,unit:r,values:o}=e;let i=(null==o?void 0:o.length)||0;if(i)return i;const s=t[0];if(0===i&&"ISO8601"===r){var a;switch((null==(a=e.intervalUnit)?void 0:a.toLowerCase())||"seconds"){case"seconds":i=Math.round((t[1]-t[0])/1e3/n);break;case"minutes":i=Math.round((t[1]-t[0])/6e4/n);break;case"hours":i=Math.round((t[1]-t[0])/36e5/n);break;case"days":i=Math.round((t[1]-t[0])/864e5/n);break;case"years":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/n);break;case"decades":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/10/n)}return i}return Math.round((t[1]-t[0])/n)},i._getRasterTileAlignmentInfo=function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=v.getRasterDatasetAlignmentInfo(this.rasterInfo)),a.isSome(this._rasterTileAlighmentInfo.pyramidsInfo)?{startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[e]}:null},e._createClass(n,[{key:"url",set:function(e){this._set("url",d.sanitizeUrl(e,s.getLogger(this.declaredClass)))}}]),n}(l.EsriPromiseMixin(i.JSONSupport));return t.__decorate([u.property()],b.prototype,"_rasterTileAlighmentInfo",void 0),t.__decorate([u.property(p.url)],b.prototype,"url",null),t.__decorate([u.property({type:String,json:{write:!0}})],b.prototype,"datasetName",void 0),t.__decorate([u.property({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0),t.__decorate([u.property()],b.prototype,"rasterInfo",void 0),t.__decorate([u.property()],b.prototype,"ioConfig",void 0),t.__decorate([u.property()],b.prototype,"sourceJSON",void 0),b=t.__decorate([m.subclass("esri.layers.support.rasterDatasets.BaseRaster")],b),b}));
