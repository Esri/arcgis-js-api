// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../request","../../../core/arrayUtils","../../../core/Error","../../../core/JSONSupport","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../arcgisLayerUrl","../commonProperties","../RasterStorageInfo","../TileInfo","./RawBlockCache","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../rasterFunctions/rasterProjectionHelper"],(function(e,t,r,n,o,i,a,s,l,u,c,f,h,d,p,m,g,y,x,v,_){"use strict";return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.rasterJobHandler=null,t.datasetName=null,t.datasetFormat=null,t.rasterInfo=null,t.ioConfig={sampling:"closest"},t}return r.__extends(t,e),t.prototype.init=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=_.load(),this.addResolvingPromise(e),[4,this.when()];case 1:return t.sent(),[2]}}))}))},t.prototype.normalizeCtorArgs=function(e){return e&&e.ioConfig&&(e=r.__assign(r.__assign({},e),{ioConfig:r.__assign({resolution:null,bandIds:null,sampling:"closest",tileInfo:g.create()},e.ioConfig)})),e},Object.defineProperty(t.prototype,"url",{set:function(e){this._set("url",d.sanitizeUrl(e,l.getLogger(this.declaredClass)))},enumerable:!1,configurable:!0}),t.prototype.open=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){throw new a("BaseRaster:open-not-implemented","open() is not implemented")}))}))},t.prototype.fetchTile=function(e,t,o,i){var a;return void 0===i&&(i={}),r.__awaiter(this,void 0,void 0,(function(){var s,l,c,f;return r.__generator(this,(function(h){return s=i.tileInfo,l=s.lodAt(e),c=new n.Point({x:l.resolution,y:l.resolution,spatialReference:s.spatialReference}),f=this.getTileExtent(c,t,o,s),(null===(a=i.multidimensionalDefinition)||void 0===a?void 0:a.length)&&u.isSome(this.rasterInfo.multidimensionalInfo)&&null==i.sliceId&&(i=r.__assign(r.__assign({},i),{sliceId:this.getSliceIndex(i.multidimensionalDefinition)||0})),[2,this.fetchPixels(f,s.size[0],s.size[1],i)]}))}))},t.prototype.identify=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var n,o,i,a,s,l,c,f,h,d,p,m,g,x,v,w,I,b;return r.__generator(this,(function(r){switch(r.label){case 0:return n=this.rasterInfo,o=n.spatialReference,i=n.extent,a=t.datumTransformation,s=_.projectPoint(e,o,a),i.intersects(s)?(l=0,t.srcResolution?(c=_.snapPyramid(t.srcResolution,this.rasterInfo,this.ioConfig.sampling),l=c.pyramidLevel,[3,3]):[3,1]):[2,{location:s,value:null}];case 1:return[4,this.computeBestPyramidLevelForLocation(e,t)];case 2:if(null==(l=r.sent()))return[2,{location:s,value:null}];r.label=3;case 3:return null===(f=this.identifyPixelLocation(s,l,null))?[2,{location:s,value:null}]:(h=f.row,d=f.col,p=f.rowOffset,m=f.colOffset,g=y.getRasterId(this.url,t.sliceId),x=l+"/"+h+"/"+d,v=y.getBlock(g,null,x),u.isSome(v)||(v=this.fetchRawTile(l,h,d,t),y.putBlock(g,null,x,v)),[4,v]);case 4:return(w=r.sent())&&w.pixels&&w.pixels.length>0?(I=p*this.rasterInfo.storageInfo.blockHeight+m,b=!w.mask||w.mask[I]?w.pixels.map((function(e){return e[I]})):null,[2,{location:s,value:b,pyramidLevel:l}]):[2,{location:s,value:null}]}}))}))},t.prototype.fetchPixels=function(e,t,o,i){return void 0===i&&(i={}),r.__awaiter(this,void 0,void 0,(function(){var a,s,l,u,c,f,h,d,p,m,g,y,x,w,I,b,k,R,M,C,P,B,S,T,F;return r.__generator(this,(function(r){switch(r.label){case 0:return a=e.clone().normalize(),e=a[0],s=this.rasterInfo.spatialReference,l=!e.spatialReference.equals(s),u=i.datumTransformation,c=new n.Point({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/o,spatialReference:e.spatialReference}),(f=i.srcResolution||(l?_.projectResolution(c,s,e,u):c))?(h=_.snapPyramid(f,this.rasterInfo,this.ioConfig.sampling),d=h.pyramidLevel,p=h.pyramidResolution,h.excessiveReading?[2,null]:(m=this.rasterInfo.storageInfo,null==(g=l?_.projectExtent(e,s,u):e)?[2,null]:(y={x:Math.floor((g.xmin-m.origin.x)/p.x+.1),y:Math.floor((m.origin.y-g.ymax)/p.y+.1)},x=Math.ceil((g.xmax-g.xmin)/p.x-.1),w=Math.ceil((g.ymax-g.ymin)/p.y-.1),x/t>8||w/o>8?[2,null]:[4,this.fetchRawPixels(d,y,{width:x,height:w},i)]))):[2,null];case 1:return(I=r.sent())?(b=d>0?m.pyramidBlockWidth:m.blockWidth,k=d>0?m.pyramidBlockHeight:m.blockHeight,!l&&1===I.pixelBlocks.length&&b===t&&k===o&&f.x===c.x&&f.y===c.y?[2,{extent:e,srcExtent:g,pixelBlock:I.pixelBlocks[0],transformGrid:null}]:(R=_.getProjectionOffsetGrid(e,I.extent,c,u),C=!i.requestRawData,P={rows:R.spacing[0],cols:R.spacing[1]},B=I.pixelBlocks,S=I.mosaicSize,T=I.isPartiallyFilled,this.rasterJobHandler?[4,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:B,srcMosaicSize:S,destDimension:C?{width:t,height:o}:null,coefs:C?R.coefficients:null,sampleSpacing:C?P:null,interpolation:i.interpolation},i)]:[3,3])):[2,null];case 2:return M=r.sent(),[3,4];case 3:F=v.mosaic(B,S),M=C?v.approximateTransform(F,{width:t,height:o},R.coefficients,P,i.interpolation):F,r.label=4;case 4:return[2,{srcExtent:g,pixelBlock:M,transformGrid:R,extent:e,isPartiallyFilled:T}]}}))}))},t.prototype.fetchRawPixels=function(e,t,o,i){return r.__awaiter(this,void 0,void 0,(function(){var a,s,l,u,c,h,d,p,m,g,y,x,v,_,w,I,b,k,R,M,C,P,B,S,T,F,L,D,z,H;return r.__generator(this,(function(r){switch(r.label){case 0:if(a=this.rasterInfo.storageInfo,s=a.origin,l=a.blockBoundary,u=e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,c=e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight,h=t.x,d=t.y,p=o.width,m=o.height,i.buffer&&(h-=i.buffer.cols,d-=i.buffer.rows,p+=2*i.buffer.cols,m+=2*i.buffer.rows),g=Math.floor(h/u),y=Math.floor(d/c),x=Math.floor((h+p-1)/u),v=Math.floor((d+m-1)/c),_=this.rasterInfo,w=_.pixelSize,I=_.spatialReference,!(b=l[e]))return[2,null];if(k=b.minRow,R=b.minCol,M=b.maxCol,C=b.maxRow,v<k||x<R||y>C||g>M)return[2,null];for(P=[],S=!1,T=y;T<=v;T++)for(F=g;F<=x;F++)T>=k&&F>=R&&C>=T&&M>=F?(B=this._fetchRawTile(e,T,F,i),this.ioConfig.allowPartialFill&&(B=f.create((function(e){B.then((function(t){return e(t)})).catch((function(){S=!0,e(null)}))}))),P.push(B)):P.push(null);return 0===P.length?[2,null]:[4,f.all(P)];case 1:return L=r.sent(),D={height:(v-y+1)*u,width:(x-g+1)*c},z=w.x*Math.pow(2,e),H=w.y*Math.pow(2,e),[2,{extent:new n.Extent({xmin:s.x+g*u*z,xmax:s.x+(x+1)*u*z,ymin:s.y-(v+1)*c*H,ymax:s.y-y*c*H,spatialReference:I}),pixelBlocks:L,mosaicSize:D,isPartiallyFilled:S}]}}))}))},t.prototype.fetchRawTile=function(e,t,n,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){throw new a("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}))}))},t.prototype.computeExtent=function(e){return _.projectExtent(this.rasterInfo.extent,e)},t.prototype.decodePixelBlock=function(e,t){return this.rasterJobHandler?this.rasterJobHandler.decode({data:e,options:t}):x.decode(e,t)},t.prototype.request=function(e,t,n){var i;return r.__awaiter(this,void 0,void 0,(function(){var a,s,l,u,c,f;return r.__generator(this,(function(h){switch(h.label){case 0:a=this.ioConfig.customFetchParameters,s=t.range,l=t.query,u=t.headers,n=null!==(i=null!=n?n:t.retryCount)&&void 0!==i?i:this.ioConfig.retryCount,c=s?{Range:"bytes="+s.from+"-"+s.to}:null,h.label=1;case 1:return h.trys.push([1,3,,4]),[4,o(e,r.__assign(r.__assign({},t),{query:r.__assign(r.__assign({},l),a),headers:r.__assign(r.__assign({},u),c)}))];case 2:return[2,h.sent()];case 3:if(f=h.sent(),n>0)return n--,[2,this.request(e,t,n)];throw f;case 4:return[2]}}))}))},t.prototype.getSliceIndex=function(e){var t=this,r=this.rasterInfo.multidimensionalInfo;if(!u.isSome(r)||!(null==e?void 0:e.length))return null;for(var n=0,o=e[0].variableName,i=function(i){var s=r.variables[i],l=s.dimensions;if(s.name!==o)return n+=l.map((function(e){return t._getDimensionValuesCount(e)})).reduce((function(e,t){return e+t})),"break";for(var u=l.map((function(e){return t._getDimensionValuesCount(e)})),c=l.length,f=function(t){var r=e.filter((function(e){return e.dimensionName===l[t].name}))[0];if(null==r)return{value:null};var o=Array.isArray(r.values[0])?r.values[0][0]:r.values[0],i=a._getIndexFromDimensions(o,l[t]);if(-1===i)return{value:null};u.shift(),n+=t===c-1?i:i*u.reduce((function(e,t){return e+t}))},h=0;h<c;h++){var d=f(h);if("object"==typeof d)return d}},a=this,s=0;s<r.variables.length;s++){var l=i(s);if("object"==typeof l)return l.value;if("break"===l)break}return n},t.prototype.updateTileInfo=function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.pixelSize;if(!t.tileInfo){for(var o=[],i=t.maximumPyramidLevel||0,a=Math.max(n.x,n.y),s=1/.0254*96*a,l=0;l<=i;l++)o.push({level:i-l,resolution:a,scale:s}),a*=2,s*=2;t.tileInfo=new g({origin:t.origin,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:o}),t.isVirtualTileInfo=!0}},t.prototype.createRemoteDatasetStorageInfo=function(e,t,r){void 0===t&&(t=512),void 0===r&&(r=512);var o=e.width,i=e.height,a=e.extent,s=e.pixelSize,l=e.spatialReference,u=new n.Point({x:a.xmin,y:a.ymax,spatialReference:l}),c=Math.max(0,Math.round(Math.log(Math.max(o,i))/Math.LN2-8)),f=this._computeBlockBoundary(a,s,c,512,512);e.storageInfo=new m({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:c,blockBoundary:f})},t.prototype.computeBestPyramidLevelForLocation=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2,0]}))}))},t.prototype.identifyPixelLocation=function(e,t,r){var n=this.rasterInfo,o=n.spatialReference,i=n.pixelSize,a=n.extent,s=this.rasterInfo.storageInfo,l=s.blockWidth,u=s.blockHeight,c=s.maximumPyramidLevel,f=s.pyramidScalingFactor,h=s.origin,d=_.projectPoint(e,o,r);if(!a.intersects(d))return null;if(t<0||t>c)return null;var p=Math.pow(f,t),m=p*i.x,g=p*i.y,y=(h.y-d.y)/g/u,x=(d.x-h.x)/m/l,v=Math.min(u-1,Math.floor((y-Math.floor(y))*u)),w=Math.min(l-1,Math.floor((x-Math.floor(x))*l));return{pyramidLevel:t,row:Math.floor(y),col:Math.floor(x),rowOffset:v,colOffset:w,srcLocation:d}},t.prototype.getTileExtent=function(e,t,r,o){var i=o.origin,a=o.spatialReference,s=o.size[0],l=o.size[1],u=i.x+r*s*e.x,c=u+s*e.x,f=i.y-t*l*e.y,h=f-l*e.y;return new n.Extent({xmin:u,xmax:c,ymin:h,ymax:f,spatialReference:a})},t.prototype._computeBlockBoundary=function(e,t,r,n,o){var i=t.x,a=t.y,s=e.xmin,l=e.ymax,u=[{minCol:Math.floor((e.xmin-s+.1*i)/n/i),maxCol:Math.floor((e.xmax-s-.1*i)/n/i),minRow:Math.floor((l-e.ymax+.1*a)/o/a),maxRow:Math.floor((l-e.ymin-.1*a)/o/a)}];if(r>0)for(var c=0;c<r;c++)i*=2,a*=2,u.push({minCol:Math.floor((e.xmin-s+.1*i)/n/i),maxCol:Math.floor((e.xmax-s-.1*i)/n/i),minRow:Math.floor((l-e.ymax+.1*a)/o/i),maxRow:Math.floor((l-e.ymin-.1*a)/o/i)});return u},t.prototype._fetchRawTile=function(e,t,n,o){var i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return f.resolve(null);var a=i.minRow,s=i.minCol,l=i.maxCol,c=i.maxRow;if(t<a||n<s||t>c||n>l)return f.resolve(null);var h=y.getRasterId(this.url,o.sliceId),d=e+"/"+t+"/"+n,p=y.getBlock(h,o.registryId,d);if(!u.isSome(p)){var m=f.createAbortController();p=this.fetchRawTile(e,t,n,r.__assign(r.__assign({},o),{signal:m.signal})),y.putBlock(h,o.registryId,d,p,m),p.catch((function(){y.deleteBlock(h,o.registryId,d)}))}return o.signal&&f.onAbort(o,(function(){y.decreaseRefCount(h,o.registryId,d)})),p},t.prototype._getIndexFromDimensions=function(e,t){var r,n=t.extent,o=t.interval,a=t.unit,s=t.values;if(null==s?void 0:s.length)return Array.isArray(s[0])?i.findIndex(s,(function(t){return t[0]<=e&&t[1]>=e})):s.indexOf(e);if(e>n[1])return-1;var l=n[0],u=-1;if("ISO8601"===a){switch((null===(r=t.intervalUnit)||void 0===r?void 0:r.toLowerCase())||"seconds"){case"seconds":u=Math.round((e-l)/1e3/o);break;case"minutes":u=Math.round((e-l)/6e4/o);break;case"hours":u=Math.round((e-l)/36e5/o);break;case"days":u=Math.round((e-l)/864e5/o);break;case"years":u=Math.round((new Date(e).getUTCFullYear()-new Date(l).getUTCFullYear())/o);break;case"decades":u=Math.round((new Date(e).getUTCFullYear()-new Date(l).getUTCFullYear())/10/o)}return u}return Math.round((e-l)/o)},t.prototype._getDimensionValuesCount=function(e){var t,r=e.extent,n=e.interval,o=e.unit,i=e.values,a=(null==i?void 0:i.length)||0;if(a)return a;var s=r[0];if(0===a&&"ISO8601"===o){switch((null===(t=e.intervalUnit)||void 0===t?void 0:t.toLowerCase())||"seconds"){case"seconds":a=Math.round((r[1]-r[0])/1e3/n);break;case"minutes":a=Math.round((r[1]-r[0])/6e4/n);break;case"hours":a=Math.round((r[1]-r[0])/36e5/n);break;case"days":a=Math.round((r[1]-r[0])/864e5/n);break;case"years":a=Math.round((new Date(r[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/n);break;case"decades":a=Math.round((new Date(r[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/10/n)}return a}return Math.round((r[1]-r[0])/n)},r.__decorate([h.property(p.url)],t.prototype,"url",null),r.__decorate([h.property({type:String,json:{write:!0}})],t.prototype,"datasetName",void 0),r.__decorate([h.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),r.__decorate([h.property()],t.prototype,"rasterInfo",void 0),r.__decorate([h.property()],t.prototype,"ioConfig",void 0),r.__decorate([h.property()],t.prototype,"sourceJSON",void 0),t=r.__decorate([h.subclass("esri.layers.support.rasterDatasets.BaseRaster")],t)}(c.EsriPromiseMixin(s.JSONSupport))}));