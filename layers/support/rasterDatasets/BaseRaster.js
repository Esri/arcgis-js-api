/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../core/JSONSupport","../../../geometry/Point","../../../geometry/Extent","../../../geometry","../../../request","../../../core/Promise","../arcgisLayerUrl","../commonProperties","../TileInfo","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../RasterStorageInfo","../rasterFunctions/rasterProjectionHelper","./RawBlockCache"],(function(e,t,n,o,r,i,a,s,l,c,u,f,h,m,d,p,y,x,g,w,I,k,R,v,M,b,C){"use strict";let B=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}e._inheritsLoose(n,t);var i=n.prototype;return i.init=async function(){const e=b.load();this.addResolvingPromise(e),await this.when()},i.normalizeCtorArgs=function(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:k.create(),...e.ioConfig}}),e},i.open=async function(e){throw new l("BaseRaster:open-not-implemented","open() is not implemented")},i.fetchTile=async function(e,t,n,r={}){var i;const{tileInfo:a}=r,s=a.lodAt(e),l=new d({x:s.resolution,y:s.resolution,spatialReference:a.spatialReference}),c=this.getTileExtent(l,t,n,a);return null!=(i=r.multidimensionalDefinition)&&i.length&&o.isSome(this.rasterInfo.multidimensionalInfo)&&null==r.sliceId&&(r={...r,sliceId:this.getSliceIndex(r.multidimensionalDefinition)||0}),this.fetchPixels(c,a.size[0],a.size[1],r)},i.identify=async function(e,t={}){const{spatialReference:n,extent:r}=this.rasterInfo,{datumTransformation:i}=t,a=b.projectPoint(e,n,i);if(!r.intersects(a))return{location:a,value:null};let s=0;if(t.srcResolution){s=b.snapPyramid(t.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel}else if(s=await this.computeBestPyramidLevelForLocation(e,t),null==s)return{location:a,value:null};const l=this.identifyPixelLocation(a,s,null);if(null===l)return{location:a,value:null};const{row:c,col:u,rowOffset:f,colOffset:h}=l,m=C.getRasterId(this.url,t.sliceId),d=`${s}/${c}/${u}`;let p=C.getBlock(m,null,d);o.isSome(p)||(p=this.fetchRawTile(s,c,u,t),C.putBlock(m,null,d,p));const y=await p;if(!(y&&y.pixels&&y.pixels.length>0))return{location:a,value:null};const x=f*this.rasterInfo.storageInfo.blockHeight+h;return{location:a,value:!y.mask||y.mask[x]?y.pixels.map((e=>e[x])):null,pyramidLevel:s}},i.fetchPixels=async function(e,t,n,r={}){const i=e.clone().normalize();e=i[0];const a=this.rasterInfo.spatialReference,s=!e.spatialReference.equals(a),{datumTransformation:l}=r,c=new d({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/n,spatialReference:e.spatialReference}),u=r.srcResolution||(s?b.projectResolution(c,a,e,l):c);if(!u)return null;const{pyramidLevel:f,pyramidResolution:h,excessiveReading:m}=b.snapPyramid(u,this.rasterInfo,this.ioConfig.sampling);if(m)return null;const p=this.rasterInfo.storageInfo;let y=s?b.projectExtent(e,a,l):e;const x=o.unwrap(this.rasterInfo.transform);if(x&&(y=x.inverseTransform(y)),null==y)return null;const g={x:Math.floor((y.xmin-p.origin.x)/h.x+.1),y:Math.floor((p.origin.y-y.ymax)/h.y+.1)},w=Math.ceil((y.xmax-y.xmin)/h.x-.1),I=Math.ceil((y.ymax-y.ymin)/h.y-.1);if(w/t>8||I/n>8)return null;const k=await this.fetchRawPixels(f,g,{width:w,height:I},r);if(!k)return null;const R=f>0?p.pyramidBlockWidth:p.blockWidth,M=f>0?p.pyramidBlockHeight:p.blockHeight;if(!s&&1===k.pixelBlocks.length&&R===t&&M===n&&u.x===c.x&&u.y===c.y)return{extent:e,srcExtent:y,pixelBlock:k.pixelBlocks[0],transformGrid:null};const C=b.getProjectionOffsetGrid(e,k.extent,c,l,x);let B;const P=!r.requestRawData,S={rows:C.spacing[0],cols:C.spacing[1]},{pixelBlocks:_,mosaicSize:T,isPartiallyFilled:F}=k;if(this.rasterJobHandler)B=await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:_,srcMosaicSize:T,destDimension:P?{width:t,height:n}:null,coefs:P?C.coefficients:null,sampleSpacing:P?S:null,interpolation:r.interpolation},r);else{const e=v.mosaic(_,T);B=P?v.approximateTransform(e,{width:t,height:n},C.coefficients,S,r.interpolation):e}return{srcExtent:y,pixelBlock:B,transformGrid:C,extent:e,isPartiallyFilled:F}},i.fetchRawPixels=async function(e,t,n,o){const{origin:r,blockBoundary:i}=this.rasterInfo.storageInfo,a=e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,s=e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;let{x:l,y:c}=t,{width:u,height:f}=n;o.buffer&&(l-=o.buffer.cols,c-=o.buffer.rows,u+=2*o.buffer.cols,f+=2*o.buffer.rows);const m=Math.floor(l/a),d=Math.floor(c/s),y=Math.floor((l+u-1)/a),x=Math.floor((c+f-1)/s),g=i[e];if(!g)return null;const{minRow:w,minCol:I,maxCol:k,maxRow:R}=g;if(x<w||y<I||d>R||m>k)return null;const v=[];let M,b=!1;for(let t=d;t<=x;t++)for(let n=m;n<=y;n++)t>=w&&n>=I&&R>=t&&k>=n?(M=this._fetchRawTile(e,t,n,o),this.ioConfig.allowPartialFill&&(M=h.create((e=>{M.then((t=>e(t))).catch((()=>{b=!0,e(null)}))}))),v.push(M)):v.push(null);if(0===v.length)return null;const C=await h.all(v),B={height:(x-d+1)*a,width:(y-m+1)*s},{nativePixelSize:P,spatialReference:S}=this.rasterInfo,_=P.x*Math.pow(2,e),T=P.y*Math.pow(2,e);return{extent:new p({xmin:r.x+m*a*_,xmax:r.x+(y+1)*a*_,ymin:r.y-(x+1)*s*T,ymax:r.y-d*s*T,spatialReference:S}),pixelBlocks:C,mosaicSize:B,isPartiallyFilled:b}},i.fetchRawTile=async function(e,t,n,o){throw new l("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")},i.computeExtent=function(e){return b.projectExtent(this.rasterInfo.extent,e)},i.decodePixelBlock=function(e,t){return!this.rasterJobHandler||t.useCanvas?R.decode(e,t):this.rasterJobHandler.decode({data:e,options:t})},i.request=async function(e,t,n){var o,r;const{customFetchParameters:i}=this.ioConfig,{range:a,query:s,headers:l}=t;n=null!=(o=null!=(r=n)?r:t.retryCount)?o:this.ioConfig.retryCount;const c=a?{Range:`bytes=${a.from}-${a.to}`}:null;try{return await x(e,{...t,query:{...s,...i},headers:{...l,...c}})}catch(o){if(n>0)return n--,this.request(e,t,n);throw o}},i.getSliceIndex=function(e){const{multidimensionalInfo:t}=this.rasterInfo;if(!o.isSome(t)||null==e||!e.length)return null;let n=0;const r=e[0].variableName;for(let o=0;o<t.variables.length;o++){const i=t.variables[o],a=i.dimensions;if(i.name!==r){n+=a.map((e=>this._getDimensionValuesCount(e))).reduce(((e,t)=>e+t));break}const s=a.map((e=>this._getDimensionValuesCount(e))),l=a.length;for(let t=0;t<l;t++){const o=e.filter((e=>e.dimensionName===a[t].name))[0];if(null==o)return null;const r=Array.isArray(o.values[0])?o.values[0][0]:o.values[0],i=this._getIndexFromDimensions(r,a[t]);if(-1===i)return null;s.shift(),n+=t===l-1?i:i*s.reduce(((e,t)=>e+t))}}return n},i.updateTileInfo=function(){const{storageInfo:e,spatialReference:t,extent:n,pixelSize:o}=this.rasterInfo;if(!e.tileInfo){const r=[],i=e.maximumPyramidLevel||0;let a=Math.max(o.x,o.y),s=1/.0254*96*a;for(let e=0;e<=i;e++)r.push({level:i-e,resolution:a,scale:s}),a*=2,s*=2;const l=new d({x:n.xmin,y:n.ymax,spatialReference:t});e.tileInfo=new k({origin:l,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:r}),e.isVirtualTileInfo=!0}},i.createRemoteDatasetStorageInfo=function(e,t=512,n=512,o){const{width:r,height:i,nativeExtent:a,pixelSize:s,spatialReference:l}=e,c=new d({x:a.xmin,y:a.ymax,spatialReference:l});null==o&&(o=Math.max(0,Math.round(Math.log(Math.max(r,i))/Math.LN2-8)));const u=this._computeBlockBoundary(a,s,o,512,512);e.storageInfo=new M({blockWidth:t,blockHeight:n,pyramidBlockWidth:t,pyramidBlockHeight:n,origin:c,firstPyramidLevel:1,maximumPyramidLevel:o,blockBoundary:u})},i.computeBestPyramidLevelForLocation=async function(e,t={}){return 0},i.identifyPixelLocation=function(e,t,n){const{spatialReference:o,pixelSize:r,extent:i}=this.rasterInfo,{blockWidth:a,blockHeight:s,maximumPyramidLevel:l,pyramidScalingFactor:c,origin:u}=this.rasterInfo.storageInfo,f=b.projectPoint(e,o,n);if(!i.intersects(f))return null;if(t<0||t>l)return null;const h=Math.pow(c,t),m=h*r.x,d=h*r.y,p=(u.y-f.y)/d/s,y=(f.x-u.x)/m/a,x=Math.min(s-1,Math.floor((p-Math.floor(p))*s)),g=Math.min(a-1,Math.floor((y-Math.floor(y))*a));return{pyramidLevel:t,row:Math.floor(p),col:Math.floor(y),rowOffset:x,colOffset:g,srcLocation:f}},i.getTileExtent=function(e,t,n,o){const{origin:r,spatialReference:i}=o,a=o.size[0],s=o.size[1],l=r.x+n*a*e.x,c=l+a*e.x,u=r.y-t*s*e.y,f=u-s*e.y;return new p({xmin:l,xmax:c,ymin:f,ymax:u,spatialReference:i})},i._computeBlockBoundary=function(e,t,n,o,r){let{x:i,y:a}=t;const s=e.xmin,l=e.ymax,c=[{minCol:Math.floor((e.xmin-s+.1*i)/o/i),maxCol:Math.floor((e.xmax-s-.1*i)/o/i),minRow:Math.floor((l-e.ymax+.1*a)/r/a),maxRow:Math.floor((l-e.ymin-.1*a)/r/a)}];if(n>0)for(let t=0;t<n;t++)i*=2,a*=2,c.push({minCol:Math.floor((e.xmin-s+.1*i)/o/i),maxCol:Math.floor((e.xmax-s-.1*i)/o/i),minRow:Math.floor((l-e.ymax+.1*a)/r/i),maxRow:Math.floor((l-e.ymin-.1*a)/r/i)});return c},i._fetchRawTile=function(e,t,n,r){const i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return h.resolve(null);const{minRow:a,minCol:s,maxCol:l,maxRow:c}=i;if(t<a||n<s||t>c||n>l)return h.resolve(null);const u=C.getRasterId(this.url,r.sliceId),f=`${e}/${t}/${n}`;let m=C.getBlock(u,r.registryId,f);if(!o.isSome(m)){const o=h.createAbortController();m=this.fetchRawTile(e,t,n,{...r,signal:o.signal}),C.putBlock(u,r.registryId,f,m,o),m.catch((()=>{C.deleteBlock(u,r.registryId,f)}))}return r.signal&&h.onAbort(r,(()=>{C.decreaseRefCount(u,r.registryId,f)})),m},i._getIndexFromDimensions=function(e,t){const{extent:n,interval:o,unit:r,values:i}=t;if(null!=i&&i.length)return Array.isArray(i[0])?i.findIndex((t=>t[0]<=e&&t[1]>=e)):i.indexOf(e);if(e>n[1])return-1;const a=n[0];let s=-1;if("ISO8601"===r){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":s=Math.round((e-a)/1e3/o);break;case"minutes":s=Math.round((e-a)/6e4/o);break;case"hours":s=Math.round((e-a)/36e5/o);break;case"days":s=Math.round((e-a)/864e5/o);break;case"years":s=Math.round((new Date(e).getUTCFullYear()-new Date(a).getUTCFullYear())/o);break;case"decades":s=Math.round((new Date(e).getUTCFullYear()-new Date(a).getUTCFullYear())/10/o)}return s}return Math.round((e-a)/o)},i._getDimensionValuesCount=function(e){const{extent:t,interval:n,unit:o,values:r}=e;let i=(null==r?void 0:r.length)||0;if(i)return i;const a=t[0];if(0===i&&"ISO8601"===o){var s;switch((null==(s=e.intervalUnit)?void 0:s.toLowerCase())||"seconds"){case"seconds":i=Math.round((t[1]-t[0])/1e3/n);break;case"minutes":i=Math.round((t[1]-t[0])/6e4/n);break;case"hours":i=Math.round((t[1]-t[0])/36e5/n);break;case"days":i=Math.round((t[1]-t[0])/864e5/n);break;case"years":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(a).getUTCFullYear())/n);break;case"decades":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(a).getUTCFullYear())/10/n)}return i}return Math.round((t[1]-t[0])/n)},e._createClass(n,[{key:"url",set:function(e){this._set("url",w.sanitizeUrl(e,r.getLogger(this.declaredClass)))}}]),n}(g.EsriPromiseMixin(m.JSONSupport));return t.__decorate([a.property(I.url)],B.prototype,"url",null),t.__decorate([a.property({type:String,json:{write:!0}})],B.prototype,"datasetName",void 0),t.__decorate([a.property({type:String,json:{write:!0}})],B.prototype,"datasetFormat",void 0),t.__decorate([a.property()],B.prototype,"rasterInfo",void 0),t.__decorate([a.property()],B.prototype,"ioConfig",void 0),t.__decorate([a.property()],B.prototype,"sourceJSON",void 0),B=t.__decorate([s.subclass("esri.layers.support.rasterDatasets.BaseRaster")],B),B}));
