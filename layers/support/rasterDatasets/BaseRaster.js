/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../request","../../../core/Error","../../../core/JSONSupport","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../arcgisLayerUrl","../commonProperties","../RasterStorageInfo","../TileInfo","./RawBlockCache","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../rasterFunctions/rasterProjectionHelper","../rasterFunctions/vectorFieldUtils","../../../geometry/Point","../../../geometry/Extent"],(function(e,t,n,r,i,o,s,a,l,c,u,f,h,d,m,p,x,y,g,I,R,v,k,w,b,T){"use strict";const S=8;let _=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}e._inheritsLoose(n,t);var o=n.prototype;return o.init=function(){var t=e._asyncToGenerator((function*(){const e=k.load();this.addResolvingPromise(e),yield this.when()}));function n(){return t.apply(this,arguments)}return n}(),o.normalizeCtorArgs=function(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:g.create(),...e.ioConfig}}),e},o.open=function(){var t=e._asyncToGenerator((function*(e){throw new i("BaseRaster:open-not-implemented","open() is not implemented")}));function n(e){return t.apply(this,arguments)}return n}(),o.fetchTile=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){const i=r.tileInfo||this.rasterInfo.storageInfo.tileInfo,o=this.getTileExtentFromTileInfo(e,t,n,i);return this.fetchPixels(o,i.size[0],i.size[1],r)}));function n(e,n,r){return t.apply(this,arguments)}return n}(),o.identify=function(){var t=e._asyncToGenerator((function*(e,t={}){t=this._getRequestOptionsWithSliceId(t);const{spatialReference:n,extent:r}=this.rasterInfo,{datumTransformation:i}=t;let o=k.projectPoint(e,n,i);if(!r.intersects(o))return{location:o,value:null};if(a.isSome(this.rasterInfo.transform)){const e=this.rasterInfo.transform.inverseTransform(o);if(!this.rasterInfo.nativeExtent.intersects(e))return{location:e,value:null};o=e}let s=0;if(t.srcResolution){s=k.snapPyramid(t.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel}else if(s=yield this.computeBestPyramidLevelForLocation(e,t),null==s)return{location:o,value:null};const l=this.identifyPixelLocation(o,s,null);if(null===l)return{location:o,value:null};const{row:c,col:u,rowOffset:f,colOffset:h}=l,d=I.getRasterId(this.url,t.sliceId),m=`${s}/${c}/${u}`;let p=I.getBlock(d,null,m);a.isNone(p)&&(p=this.fetchRawTile(s,c,u,t),I.putBlock(d,null,m,p));const x=yield p;if(a.isNone(x)||!x.pixels||0===x.pixels.length)return{location:o,value:null};const y=f*this.rasterInfo.storageInfo.blockHeight+h,g=!x.mask||x.mask[y]?x.pixels.map((e=>e[y])):null,R=this.rasterInfo.dataType;if(("vector-magdir"===R||"vector-uv"===R)&&(null==g?void 0:g.length)>1){return{location:o,value:g,magdirValue:"vector-magdir"===R?[g[0],g[1]]:w.uvComponentToVector([g[0],g[1]]),pyramidLevel:s}}return{location:o,value:g,pyramidLevel:s}}));function n(e){return t.apply(this,arguments)}return n}(),o.fetchPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){if(e=k.snapExtent(e),(r=this._getRequestOptionsWithSliceId(r)).requestRawData)return this._fetchPixels(e,t,n,r);const i=k.getWorldWidth(e.spatialReference),o=k.getWorldWrapCount(e);if(a.isNone(i)||0===o||1===o&&this._isGlobalWrappableSource)return this._fetchPixels(e,t,n,r);if(o>=3)return{extent:e,pixelBlock:null};const s=[],{xmin:l,xmax:c}=e,u=Math.round(i/(c-l)*t),f=u-Math.round((i/2-l)/(c-l)*t);let h=0;const d=[];for(let a=0;a<=o;a++){const m=new T({xmin:0===a?l:-i/2,xmax:a===o?c-i*a:i/2,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference}),p=0===a?u-f:a===o?t-h:u;h+=p,d.push(p);const x=r.disableWrapAround&&a>0?null:this._fetchPixels(m,p,n,r);s.push(x)}const m=(yield Promise.all(s)).map((e=>null==e?void 0:e.pixelBlock));let p=null;const x={width:t,height:n};if(this.rasterJobHandler){p=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:m,srcMosaicSize:x,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:d},r)).pixelBlock}else p=v.mosaic(m,x,{blockWidths:d});return{extent:e,srcExtent:k.projectExtent(e,this.rasterInfo.spatialReference,r.datumTransformation),pixelBlock:p}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),o.fetchRawPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){t={x:Math.floor(t.x),y:Math.floor(t.y)};const i=yield this._fetchRawTiles(e,t,n,r),{nativeExtent:o,nativePixelSize:s,storageInfo:l}=this.rasterInfo,c=2**e,u=s.x*c,f=s.y*c,h=new T({xmin:o.xmin+u*t.x,xmax:o.xmin+u*(t.x+n.width-1),ymin:o.ymax-f*(t.y+n.height-1),ymax:o.ymax-f*t.y,spatialReference:o.spatialReference});if(!i)return{extent:h,srcExtent:h,pixelBlock:null};const{pixelBlocks:d,mosaicSize:m}=i;if(1===d.length&&a.isSome(d[0])&&d[0].width===n.width&&d[0].height===n.height)return{extent:h,srcExtent:h,pixelBlock:i.pixelBlocks[0]};const p=e>0?l.pyramidBlockWidth:l.blockWidth,x=e>0?l.pyramidBlockHeight:l.blockHeight,y={x:t.x%p,y:t.y%x};let g;if(this.rasterJobHandler){g=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:d,srcMosaicSize:m,destDimension:n,clipOffset:y,clipSize:n,coefs:null,sampleSpacing:null,interpolation:r.interpolation,alignmentInfo:null,blockWidths:null},r)).pixelBlock}else g=v.mosaic(d,m,{clipOffset:y,clipSize:n});return{extent:h,srcExtent:h,pixelBlock:g}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),o.fetchRawTile=function(e,t,n,r){throw new i("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")},o.computeExtent=function(e){return k.projectExtent(this.rasterInfo.extent,e)},o.decodePixelBlock=function(e,t){return!this.rasterJobHandler||t.useCanvas?R.decode(e,t):this.rasterJobHandler.decode({data:e,options:t})},o.request=function(){var t=e._asyncToGenerator((function*(e,t,n){var i,o;const{customFetchParameters:s}=this.ioConfig,{range:a,query:l,headers:c}=t;n=null!=(i=null!=(o=n)?o:t.retryCount)?i:this.ioConfig.retryCount;const u=a?{Range:`bytes=${a.from}-${a.to}`}:null;try{return yield r(e,{...t,query:{...l,...s},headers:{...c,...u}})}catch(f){if(n>0)return n--,this.request(e,t,n);throw f}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),o.getSliceIndex=function(e){const{multidimensionalInfo:t}=this.rasterInfo;if(!a.isSome(t))return null;if(!a.isSome(e)||0===e.length)return null;let n=0;const r=e[0].variableName;for(let i=0;i<t.variables.length;i++){const o=t.variables[i],s=o.dimensions;if(o.name!==r){n+=s.map((e=>this._getDimensionValuesCount(e))).reduce(((e,t)=>e+t));break}const a=s.map((e=>this._getDimensionValuesCount(e))),l=s.length;for(let t=0;t<l;t++){const r=e.find((e=>e.dimensionName===s[t].name));if(null==r)return null;const i=Array.isArray(r.values[0])?r.values[0][0]:r.values[0],o=this._getIndexFromDimensions(i,s[t]);if(-1===o)return null;a.shift(),n+=t===l-1?o:o*a.reduce(((e,t)=>e+t))}}return n},o.getTileExtentFromTileInfo=function(e,t,n,r){const i=r.lodAt(e);return this.getTileExtent({x:i.resolution,y:i.resolution},t,n,r.origin,r.spatialReference,r.size)},o.updateTileInfo=function(){const{storageInfo:e,spatialReference:t,extent:n,pixelSize:r}=this.rasterInfo;if(!e.tileInfo){const i=[],o=e.maximumPyramidLevel||0;let s=Math.max(r.x,r.y),a=1/.0254*96*s;for(let e=0;e<=o;e++)i.push({level:o-e,resolution:s,scale:a}),s*=2,a*=2;const l=new b({x:n.xmin,y:n.ymax,spatialReference:t});e.tileInfo=new g({origin:l,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:i}),e.isVirtualTileInfo=!0}},o.createRemoteDatasetStorageInfo=function(e,t=512,n=512,r){const{width:i,height:o,nativeExtent:s,pixelSize:a,spatialReference:l}=e,c=new b({x:s.xmin,y:s.ymax,spatialReference:l});null==r&&(r=Math.max(0,Math.round(Math.log(Math.max(i,o))/Math.LN2-8)));const u=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[a],r);e.storageInfo=new y({blockWidth:t,blockHeight:n,pyramidBlockWidth:t,pyramidBlockHeight:n,origin:c,firstPyramidLevel:1,maximumPyramidLevel:r,blockBoundary:u})},o.computeBestPyramidLevelForLocation=function(){var t=e._asyncToGenerator((function*(e,t={}){return 0}));function n(e){return t.apply(this,arguments)}return n}(),o.computeBlockBoundary=function(e,t,n,r,i,o=0,s=2){if(1===i.length&&o>0){i=[...i];let{x:e,y:t}=i[0];for(let n=0;n<o;n++)e*=s,t*=s,i.push({x:e,y:t})}const a=[],{x:l,y:c}=r;for(let u=0;u<i.length;u++){const{x:r,y:o}=i[u];a.push({minCol:Math.floor((e.xmin-l+.1*r)/t/r),maxCol:Math.floor((e.xmax-l-.1*r)/t/r),minRow:Math.floor((c-e.ymax+.1*o)/n/o),maxRow:Math.floor((c-e.ymin-.1*o)/n/o)})}return a},o.getPyramidPixelSize=function(e){const{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:n,pyramidScalingFactor:r}=this.rasterInfo.storageInfo;if(0===e)return t;if(a.isSome(n)&&n.length)return n[e-1];const i=r**e;return{x:t.x*i,y:t.y*i}},o.identifyPixelLocation=function(e,t,n){const{spatialReference:r,nativeExtent:i}=this.rasterInfo,{blockWidth:o,blockHeight:s,maximumPyramidLevel:a,origin:l}=this.rasterInfo.storageInfo,c=k.projectPoint(e,r,n);if(!i.intersects(c))return null;if(t<0||t>a)return null;const u=this.getPyramidPixelSize(t),{x:f,y:h}=u,d=(l.y-c.y)/h/s,m=(c.x-l.x)/f/o,p=Math.min(s-1,Math.floor((d-Math.floor(d))*s)),x=Math.min(o-1,Math.floor((m-Math.floor(m))*o));return{pyramidLevel:t,row:Math.floor(d),col:Math.floor(m),rowOffset:p,colOffset:x,srcLocation:c}},o.getTileExtent=function(e,t,n,r,i,o){const[s,a]=o,l=r.x+n*s*e.x,c=l+s*e.x,u=r.y-t*a*e.y,f=u-a*e.y;return new T({xmin:l,xmax:c,ymin:f,ymax:u,spatialReference:i})},o.getBlockWidthHeight=function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}},o.isBlockOutside=function(e,t,n){const r=this.rasterInfo.storageInfo.blockBoundary[e];return!r||r.maxRow<t||r.maxCol<n||r.minRow>t||r.minCol>n},o._fetchPixels=function(){var t=e._asyncToGenerator((function*(e,t,n,r={}){let i=k.getWorldWrapCount(e);if(i>=2)return{extent:e,pixelBlock:null};const o=this._getSourceDataInfo(e,t,n,r),{pyramidLevel:s,pyramidResolution:l,srcResolution:c,srcExtent:u,srcWidth:f,srcHeight:h}=o;if(0===f||0===h)return{extent:e,srcExtent:u,pixelBlock:null};const d=a.unwrap(this.rasterInfo.transform),m="gcs-shift"===(null==d?void 0:d.type),p=a.isSome(k.getWorldWidth(e.spatialReference));!m&&p||(i=k.getWorldWrapCount(o.srcExtent,m));const x=this.rasterInfo.storageInfo,y={x:Math.floor((u.xmin-x.origin.x)/l.x+.1),y:Math.floor((x.origin.y-u.ymax)/l.y+.1)},g=yield this._fetchRawTiles(s,y,{width:f,height:h,wrapCount:i},r);if(!g)return{extent:e,srcExtent:u,pixelBlock:null};const I=s>0?x.pyramidBlockWidth:x.blockWidth,R=s>0?x.pyramidBlockHeight:x.blockHeight,T=I===f&&R===h&&y.x%I==0&&y.y%R==0,S=new b({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/n,spatialReference:e.spatialReference}),_=!e.spatialReference.equals(this.rasterInfo.spatialReference),{datumTransformation:B}=r;if(!_&&T&&1===g.pixelBlocks.length&&I===t&&R===n&&c.x===S.x&&c.y===S.y)return{extent:e,srcExtent:u,pixelBlock:g.pixelBlocks[0]};const C=p&&a.isSome(k.getWorldWidth(u.spatialReference)),P=r.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector");P&&!this.rasterJobHandler&&(yield k.load());const W=this.rasterJobHandler?yield this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:g.extent,pixelSize:S.toJSON(),datumTransformation:B,rasterTransform:d,hasWrapAround:i>0||C,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:P},r):k.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:g.extent,pixelSize:S,datumTransformation:B,rasterTransform:d,hasWrapAround:i>0||C,isAdaptive:!1,includeGCSGrid:P});let M;const H=!r.requestRawData,E={rows:W.spacing[0],cols:W.spacing[1]},D=a.unwrap(this._getRasterTileAlignmentInfo(s,g.extent.xmin)),{pixelBlocks:L,mosaicSize:A,isPartiallyFilled:F}=g;let G=null;if(this.rasterJobHandler){const e=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:L,srcMosaicSize:A,destDimension:H?{width:t,height:n}:null,coefs:H?W.coefficients:null,sampleSpacing:H?E:null,projectDirections:P,gcsGrid:P?W.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:r.interpolation,alignmentInfo:D,blockWidths:null},r);({pixelBlock:M,localNorthDirections:G}=e)}else{const e=v.mosaic(L,A,{alignmentInfo:D});M=H?v.approximateTransform(e,{width:t,height:n},W.coefficients,E,r.interpolation):e,P&&W.gcsGrid&&(G=v.getLocalArithmeticNorthRotations({width:t,height:n},W.gcsGrid),M=w.convertToLocalDirections(M,this.rasterInfo.dataType,G))}return r.requestRawData||P?{srcExtent:u,pixelBlock:M,transformGrid:W,localNorthDirections:G,extent:e,isPartiallyFilled:F}:{srcExtent:u,extent:e,pixelBlock:M}}));function n(e,n,r){return t.apply(this,arguments)}return n}(),o._fetchRawTiles=function(){var t=e._asyncToGenerator((function*(e,t,n,r){const{origin:i,blockBoundary:o}=this.rasterInfo.storageInfo,{blockWidth:s,blockHeight:l}=this.getBlockWidthHeight(e);let{x:c,y:u}=t,{width:f,height:h,wrapCount:d}=n;const m=this._getRasterTileAlignmentInfo(e,0);r.buffer&&(c-=r.buffer.cols,u-=r.buffer.rows,f+=2*r.buffer.cols,h+=2*r.buffer.rows);let p=0,x=0,y=0;if(d&&a.isSome(m)){({worldColumnCountFromOrigin:x,originColumnOffset:y,rightPadding:p}=m);x*m.blockWidth-p>=c+f&&(p=0)}const g=Math.floor(c/s),I=Math.floor(u/l),R=Math.floor((c+f+p-1)/s),v=Math.floor((u+h+p-1)/l),k=o[e];if(!k)return null;const{minRow:w,minCol:b,maxCol:S,maxRow:_}=k;if(0===d&&(v<w||R<b||I>_||g>S))return null;const B=new Array;let C=!1;const P=null==this.ioConfig.allowPartialFill?r.allowPartialFill:this.ioConfig.allowPartialFill;for(let T=I;T<=v;T++)for(let t=g;t<=R;t++){let n=t;if(!r.disableWrapAround&&d&&a.isSome(m)&&x<=t&&(n=t-x-y),T>=w&&n>=b&&_>=T&&S>=n){const t=this._fetchRawTile(e,T,n,r);P?B.push(new Promise((e=>{t.then((t=>e(t))).catch((()=>{C=!0,e(null)}))}))):B.push(t)}else B.push(null)}if(0===B.length)return null;const W=yield Promise.all(B),M={height:(v-I+1)*l,width:(R-g+1)*s},{spatialReference:H}=this.rasterInfo,E=this.getPyramidPixelSize(e),{x:D,y:L}=E;return{extent:new T({xmin:i.x+g*s*D,xmax:i.x+(R+1)*s*D,ymin:i.y-(v+1)*l*L,ymax:i.y-I*l*L,spatialReference:H}),pixelBlocks:W,mosaicSize:M,isPartiallyFilled:C}}));function n(e,n,r,i){return t.apply(this,arguments)}return n}(),o._fetchRawTile=function(e,t,n,r){const i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);const{minRow:o,minCol:s,maxCol:l,maxRow:u}=i;if(t<o||n<s||t>u||n>l)return Promise.resolve(null);const f=I.getRasterId(this.url,r.sliceId),h=`${e}/${t}/${n}`;let d=I.getBlock(f,r.registryId,h);if(a.isNone(d)){const i=new AbortController;d=this.fetchRawTile(e,t,n,{...r,signal:i.signal}),I.putBlock(f,r.registryId,h,d,i),d.catch((()=>I.deleteBlock(f,r.registryId,h)))}return r.signal&&c.onAbort(r,(()=>{I.decreaseRefCount(f,r.registryId,h)})),d},o._getIndexFromDimensions=function(e,t){const{extent:n,interval:r,unit:i,values:o}=t;if(null!=o&&o.length)return Array.isArray(o[0])?o.findIndex((t=>t[0]<=e&&t[1]>=e)):o.indexOf(e);if(e>n[1])return-1;const s=n[0];let a=-1;if("ISO8601"===i){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":a=Math.round((e-s)/1e3/r);break;case"minutes":a=Math.round((e-s)/6e4/r);break;case"hours":a=Math.round((e-s)/36e5/r);break;case"days":a=Math.round((e-s)/864e5/r);break;case"years":a=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/r);break;case"decades":a=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/r)}return a}return Math.round((e-s)/r)},o._getDimensionValuesCount=function(e){const{extent:t,interval:n,unit:r,values:i}=e;let o=(null==i?void 0:i.length)||0;if(o)return o;const s=t[0];if(0===o&&"ISO8601"===r){var a;switch((null==(a=e.intervalUnit)?void 0:a.toLowerCase())||"seconds"){case"seconds":o=Math.round((t[1]-t[0])/1e3/n);break;case"minutes":o=Math.round((t[1]-t[0])/6e4/n);break;case"hours":o=Math.round((t[1]-t[0])/36e5/n);break;case"days":o=Math.round((t[1]-t[0])/864e5/n);break;case"years":o=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/n);break;case"decades":o=Math.round((new Date(t[1]).getUTCFullYear()-new Date(s).getUTCFullYear())/10/n)}return o}return Math.round((t[1]-t[0])/n)},o._getRasterTileAlignmentInfo=function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=k.getRasterDatasetAlignmentInfo(this.rasterInfo)),a.isSome(this._rasterTileAlighmentInfo.pyramidsInfo)?{startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[e]}:null},o._getSourceDataInfo=function(e,t,n,r={}){const i={datumTransformation:r.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0};r.srcResolution&&(i.srcResolution=r.srcResolution,this._updateSourceDataInfo(e,i));const o=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:s,srcHeight:a,pyramidLevel:l}=i,c=s/t,u=a/n,f=l<o&&c*u>=16;if(f||l===o&&(c>S||u>S)||(0===s||0===a)){const s=new b({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/n,spatialReference:e.spatialReference});let a=k.projectResolution(s,this.rasterInfo.spatialReference,e,i.datumTransformation);const h=!a||r.srcResolution&&a.x+a.y<r.srcResolution.x+r.srcResolution.y;if(f&&r.srcResolution&&h){const e=Math.round(Math.log(Math.max(c,u))/Math.LN2)-1;if(o-l+3>=e){const t=2**e;a={x:r.srcResolution.x*t,y:r.srcResolution.y*t}}}a&&(i.srcResolution=a,this._updateSourceDataInfo(e,i))}return(i.srcWidth/t>S||i.srcHeight/n>S)&&(i.srcWidth=0,i.srcHeight=0),i},o._updateSourceDataInfo=function(e,t){t.srcWidth=0,t.srcHeight=0;const n=this.rasterInfo.spatialReference,{srcResolution:r,datumTransformation:i}=t,{pyramidLevel:o,pyramidResolution:s,excessiveReading:l}=k.snapPyramid(r,this.rasterInfo,this.ioConfig.sampling);if(l)return;let c=t.srcExtent||k.projectExtent(e,n,i);if(null==c)return;const u=a.unwrap(this.rasterInfo.transform);u&&(c=u.inverseTransform(c)),t.srcExtent=c;const f=Math.ceil((c.xmax-c.xmin)/s.x-.1),h=Math.ceil((c.ymax-c.ymin)/s.y-.1);t.pyramidLevel=o,t.pyramidResolution=s,t.srcWidth=f,t.srcHeight=h},o._getRequestOptionsWithSliceId=function(e){return a.isSome(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e={...e,sliceId:this.getSliceIndex(e.multidimensionalDefinition)}),e},e._createClass(n,[{key:"_isGlobalWrappableSource",get:function(){const{rasterInfo:e}=this,t=k.getWorldWidth(e.spatialReference);return a.isSome(t)&&e.extent.width>=t/2}},{key:"url",set:function(e){this._set("url",p.sanitizeUrl(e,s.getLogger(this.declaredClass)))}}]),n}(l.EsriPromiseMixin(o.JSONSupport));t.__decorate([u.property()],_.prototype,"_rasterTileAlighmentInfo",void 0),t.__decorate([u.property({readOnly:!0})],_.prototype,"_isGlobalWrappableSource",null),t.__decorate([u.property(x.url)],_.prototype,"url",null),t.__decorate([u.property({type:String,json:{write:!0}})],_.prototype,"datasetName",void 0),t.__decorate([u.property({type:String,json:{write:!0}})],_.prototype,"datasetFormat",void 0),t.__decorate([u.property()],_.prototype,"rasterInfo",void 0),t.__decorate([u.property()],_.prototype,"ioConfig",void 0),t.__decorate([u.property()],_.prototype,"sourceJSON",void 0),_=t.__decorate([m.subclass("esri.layers.support.rasterDatasets.BaseRaster")],_);return _}));
