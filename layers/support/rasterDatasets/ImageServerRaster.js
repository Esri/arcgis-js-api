// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators","../RasterInfo","../RasterStorageInfo","../serviceTileInfoProperty","../TileInfo","../TilemapCache","./BaseRaster","../rasterFunctions/pixelUtils","../../../tasks/support/FeatureSet"],(function(e,t,i,n,r,a,s,l,o,u,c,h,f,m,d,p,v,y){"use strict";return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._levelOffset=0,t._slices=null,t._tilemapCache=null,t.datasetFormat="RasterTileServer",t}return i.__extends(t,e),t.prototype.open=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,n,s,l,u,c,p,v,y,x,g,_,w,b,S,M,I,T,R,C,q,z,O,P,j;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,this.init()];case 1:return i.sent(),t=e&&e.signal,this.sourceJSON?(s={data:this.sourceJSON},[3,4]):[3,2];case 2:return[4,this.request(this.url,{query:{f:"json"},signal:t})];case 3:s=i.sent(),i.label=4;case 4:if((n=s).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),l=n.data,this.sourceJSON=l,u=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=l.cacheType,null==this.tileType&&(u.indexOf(l.tileInfo.format.toLowerCase())>-1?this.tileType="Map":"lerc"===l.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),!l)throw new r("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!l.tileInfo)throw new r("imageserverraster:open","use ImageryLayer to open non-tiled image services");return this.datasetName=l.name.slice(l.name.indexOf("/")+1),[4,this._fetchRasterInfo({signal:t})];case 5:if(c=i.sent(),!a.isSome(c))throw new r("image-server-raster:open","cannot initialize image service");if(p="Map"===this.tileType?f.readServiceTileInfo(l.tileInfo,l,null):m.fromJSON(l.tileInfo),v=c.extent,y=c.pixelSize,x=.5/c.width*y.x,g=void 0,_=void 0,w=p.lodAt(Math.max.apply(null,p.lods.map((function(e){return e.level})))),"Map"!==this.tileType&&0!==l.maxScale&&("Raster"===this.tileType?(g=p.lods.filter((function(e){return e.resolution===y.x}))[0])||(g=p.lods[p.lods.length-1]):(g=p.lods.filter((function(e){return Math.abs(e.scale-l.maxScale)<x}))[0])||(g=p.lods.filter((function(e){return e.scale>l.maxScale})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0]),y.x=y.y=g.resolution,c.width=Math.ceil((v.xmax-v.xmin)/y.x-.1),c.height=Math.ceil((v.ymax-v.ymin)/y.y-.1)),g||(g=w),b=p.lodAt(Math.min.apply(null,p.lods.map((function(e){return e.level})))),"Map"===this.tileType?this._levelOffset=p.lods[0].level:0!==l.minScale&&"Elevation"===this.tileType&&(_=p.lods.filter((function(e){return Math.abs(e.scale-l.minScale)<x}))[0],this._levelOffset=_.level-b.level),_||(_=b),S=Math.max(y.x,y.y),(Math.abs(y.x-y.y)>x||!p.lods.some((function(e){return Math.abs(e.resolution-S)<x})))&&(y.x=y.y=g.resolution,c.width=Math.ceil((v.xmax-v.xmin)/y.x-.1),c.height=Math.ceil((v.ymax-v.ymin)/y.y-.1)),M=g.level-_.level,I=p.size,T=I[0],R=I[1],C=p.origin,q=y.x,z=y.y,O=[{minCol:Math.floor((v.xmin-C.x+.1*q)/T/q),maxCol:Math.floor((v.xmax-C.x-.1*q)/T/q),minRow:Math.floor((C.y-v.ymax+.1*z)/R/z),maxRow:Math.floor((C.y-v.ymin-.1*z)/R/z)}],M>0)for(P=0;P<M;P++)q*=2,z*=2,O.push({minCol:Math.floor((v.xmin-C.x+.1*q)/T/q),maxCol:Math.floor((v.xmax-C.x-.1*q)/T/q),minRow:Math.floor((C.y-v.ymax+.1*z)/R/q),maxRow:Math.floor((C.y-v.ymin-.1*z)/R/q)});return c.storageInfo=new h({blockWidth:p.size[0],blockHeight:p.size[1],pyramidBlockWidth:p.size[0],pyramidBlockHeight:p.size[1],compression:p.format,origin:p.origin,firstPyramidLevel:1,maximumPyramidLevel:M,tileInfo:p,blockBoundary:O}),this._set("rasterInfo",c),l.capabilities.toLowerCase().indexOf("tilemap")>-1&&(j={tileInfo:c.storageInfo.tileInfo,parsedUrl:o.urlToObject(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new d.TilemapCache({layer:j})),[2]}}))}))},t.prototype.fetchRawTile=function(e,t,n,r){return void 0===r&&(r={}),i.__awaiter(this,void 0,void 0,(function(){var a,s,l,o,u,c,h,f,m,d,p,y,x,g,_,w,b,S,M,I,T,R;return i.__generator(this,(function(i){switch(i.label){case 0:return a=this.rasterInfo,s=a.storageInfo,l=a.extent,o=a.pixelSize,u=s.maximumPyramidLevel-e+this._levelOffset,c=this.url+"/tile/"+u+"/"+t+"/"+n,h=this._slices?{sliceId:r.sliceId||0}:null,[4,this.request(c,{query:h,responseType:"array-buffer",signal:r.signal})];case 1:return(f=i.sent().data)?[4,this.decodePixelBlock(f,{width:s.tileInfo.size[0],height:s.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType})]:[2,null];case 2:return m=i.sent(),d=s.blockBoundary[e],"jpg"!==s.compression||n>d.minCol&&n<d.maxCol&&t>d.minRow&&t<d.maxRow?[2,m]:(p=s.origin,y=s.blockWidth,x=s.blockHeight,g=Math.pow(2,e),_=Math.round((l.xmin-p.x)/(o.x*g))%y,w=Math.round((l.xmax-p.x)/(o.x*g))%y,b=Math.round((p.y-l.ymax)/(o.x*g))%x,S=Math.round((p.y-l.ymin)/(o.x*g))%x,M=n===d.minCol?_:0,I=t===d.minRow?b:0,T=n===d.maxCol?w:y,R=t===d.maxRow?S:x,v.setValidBoundary(m,{x:M,y:I},{width:T-M,height:R-I}),[2,m])}}))}))},t.prototype.getSliceIndex=function(e){if(!(null==e?void 0:e.length)||!this._slices)return null;for(var t=e,i=0;i<this._slices.length;i++){var n=this._slices[i].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var i=t.filter((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}))[0];return!i||(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(i.values[0])?i.values[0][0]:i.values[0])})))return i}return null},t.prototype.fetchVariableStatisticsHistograms=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var n,r,a;return i.__generator(this,(function(i){switch(i.label){case 0:return n=this.request(this.url+"/statistics",{query:{variable:e,f:"json"},signal:t}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),r=this.request(this.url+"/histograms",{query:{variable:e,f:"json"},signal:t}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),[4,l.all([n,r])];case 1:return(a=i.sent())[0]&&a[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),[2,{statistics:a[0]||null,histograms:a[1]||null}]}}))}))},t.prototype.computeBestPyramidLevelForLocation=function(e,t){return void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){var n,r,a,s,l;return i.__generator(this,(function(i){switch(i.label){case 0:if(!this._tilemapCache)return[2,0];if(null===(n=this.identifyPixelLocation(e,0,t.datumTransformation)))return[2,null];r=0,a=this.rasterInfo.storageInfo.maximumPyramidLevel,s=a-r+this._levelOffset,l=n.srcLocation,i.label=1;case 1:if(!(s>=0))return[3,6];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this._tilemapCache.fetchAvailability(s,n.row,n.col,t)];case 3:return"available"===i.sent()?[3,6]:[3,5];case 4:return i.sent(),[3,5];case 5:return s--,r++,null===(n=this.identifyPixelLocation(l,r,t.datumTransformation))?[2,null]:[3,1];case 6:return-1===s||null==n?[2,null]:[2,r]}}))}))},t.prototype._fetchRasterInfo=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,a,l,o,u,h,f,m,d,p,v,x=this;return i.__generator(this,(function(i){return t=this.sourceJSON,r=Math.ceil((t.extent.xmax-t.extent.xmin)/t.pixelSizeX-.1),a=Math.ceil((t.extent.ymax-t.extent.ymin)/t.pixelSizeY-.1),l=n.SpatialReference.fromJSON(t.spatialReference||t.extent.spatialReference),"Map"===this.tileType?[2,new c({width:r,height:a,bandCount:3,extent:n.Extent.fromJSON(t.extent),spatialReference:l,pixelSize:new n.Point({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:l}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})]:(o=e.slice,u=e.signal,h=!!t.hasRasterAttributeTable&&this.request(this.url+"/rasterAttributeTable",{query:{slice:o,f:"json"},signal:u}).then((function(e){return y.fromJSON(e.data)})).catch((function(){return null})),f=!!t.hasColormap&&this.request(this.url+"/colormap",{query:{slice:o,f:"json"},signal:u}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.colormap})),m=!!t.hasHistograms&&this.request(this.url+"/histograms",{query:{slice:o,f:"json"},signal:u}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),d=this.request(this.url+"/keyProperties",{query:{f:"json"},signal:u}).then((function(e){return e.data})).catch((function(){})),p=!!t.hasMultidimensions&&this._fetchMultidimensionalInfo(),v=!!t.hasMultidimensions&&this.request(this.url+"/slices",{query:{f:"json"},signal:u}).then((function(e){return e.data&&e.data.slices})).catch((function(){})),[2,s.all([h,f,m,d,p,v]).then((function(e){var i=null;if(t.minValues&&t.minValues.length===t.bandCount){i=[];for(var s=0;s<t.minValues.length;s++)i.push({min:t.minValues[s],max:t.maxValues[s],avg:t.meanValues[s],stddev:t.stdvValues[s]})}return x._slices=e[5]||null,new c({width:r,height:a,bandCount:t.bandCount,extent:n.Extent.fromJSON(t.extent),spatialReference:l,pixelSize:new n.Point({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:l}),pixelType:t.pixelType.toLowerCase(),statistics:i,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||{},multidimensionalInfo:e[4]||null})}))])}))}))},t.prototype._fetchMultidimensionalInfo=function(e){var t;return i.__awaiter(this,void 0,void 0,(function(){var n;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,this.request(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:e}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.multidimensionalInfo}))];case 1:return n=i.sent(),(null===(t=n.variables)||void 0===t?void 0:t.length)&&n.variables.forEach((function(e){var t;(null===(t=e.statistics)||void 0===t?void 0:t.length)&&e.statistics.forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation}))})),[2,n]}}))}))},i.__decorate([u.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0),i.__decorate([u.property()],t.prototype,"tileType",void 0),t=i.__decorate([u.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],t)}(p)}));