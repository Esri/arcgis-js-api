/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../PopupTemplate","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/has","../../core/HandleOwner","../../core/Identifiable","../../core/lang","../../core/Loadable","../../core/maybe","../../core/MultiOriginJSONSupport","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/accessorSupport/PropertyOrigin","../../core/accessorSupport/extensions/serializableProperty/reader","../../form/FormTemplate","./commonProperties","./FeatureTemplate","./fieldProperties","./fieldUtils","./LabelClass","./labelingInfo","../../support/popupUtils","../../symbols/support/defaults"],(function(e,r,t,o,n,i,l,a,s,p,d,c,u,y,f,g,m,b,_,v,h,S,w,O,I,T,F,j,x,P,D,R,E,C,k,V){"use strict";const M=["charts","editingEnabled","formTemplate","labelsVisible","labelingInfo","legendEnabled","minScale","maxScale","opacity","popupEnabled","popupTemplate","renderer","subtypeCode","templates","title","visible"],L={key:"type",base:s,errorContext:"renderer",typeMap:{simple:p,"unique-value":d,"class-breaks":o}},N=D.defineFieldProperties(),G=F.createTypeReader({types:L});let U=0;function q(e){const r=e.json.write;return"object"==typeof r?r.ignoreOrigin=!0:e.json.write={ignoreOrigin:!0},e}function B(e){return new p({symbol:H(e)})}function H(e){switch(e){case"point":case"multipoint":return V.defaultPointSymbol2D.clone();case"polyline":return V.defaultPolylineSymbol2D.clone();case"polygon":case"multipatch":return V.defaultPolygonSymbol2D.clone();default:return null}}function A(e,r){return!!r&&("unique-value"===e?.type&&"string"==typeof e.field&&e.field.toLowerCase()===r.toLowerCase()&&!e.field2&&!e.field3&&!e.valueExpression)}function J(e,r){return null==e?null:r.subtypes?.find((r=>r.code===e))}function $(e,r){let t=null;switch(r.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":t="point";break;case"esriGeometryPolyline":t="line";break;case"esriGeometryPolygon":case"esriGeometryMultiPatch":t="polygon";break;default:r.type,t=null}const o={},n=J(e,r);if(b.isSome(n)){const{defaultValues:e}=n;for(const r in e)o[r]=e[r]}return o[r.subtypeField]=e,new P({name:"New Feature",drawingTool:t,prototype:{attributes:o}})}const z="esri.layers.support.SubtypeSublayer";let K=function(r){function t(e){var t;return(t=r.call(this,e)||this).charts=null,t.editingEnabled=!0,t.fieldOverrides=null,t.fieldsIndex=null,t.formTemplate=null,t.id=`${Date.now().toString(16)}-subtype-sublayer-${U++}`,t.type="subtype-sublayer",t.labelsVisible=!0,t.labelingInfo=null,t.layerType="ArcGISFeatureLayer",t.legendEnabled=!0,t.listMode="show",t.minScale=0,t.maxScale=0,t.opacity=1,t.popupEnabled=!0,t.popupTemplate=null,t.subtypeCode=null,t.templates=null,t.title=null,t.visible=!0,t}e._inheritsLoose(t,r);var o=t.prototype;return o.writeFieldOverrides=function(e,r,t){const{fields:o,parent:n}=this;let i;if(o){i=[];let e=0;o.forEach((({name:r,alias:t,editable:o,visible:l})=>{if(!l)return;const a=n?.fields?.find((e=>e.name===r));if(!a)return;const s={name:r};let p=!1;t!==a.alias&&(s.alias=t,p=!0),o!==a.editable&&(s.editable=o,p=!0),i.push(s),p&&e++})),0===e&&i.length===o.length&&(i=null)}else i=g.clone(e);i?.length&&v.setDeepValue(t,i,r)},o.readRendererFromService=function(e,r,t){if("Table"===r.type)return null;const o=r.drawingInfo?.renderer,n=G(o,r,t);let i;const{subtypeCode:l}=this;if(null!=l&&A(n,r.subtypeField)){const e=n.uniqueValueInfos?.find((({value:e})=>(e="number"==typeof e?String(e):e)===String(l)));e&&(i=new p({symbol:e.symbol}))}else"simple"!==n?.type||n.visualVariables?.length||(i=n);return i},o.readRenderer=function(e,r,t){const o=r?.layerDefinition?.drawingInfo?.renderer;if(o&&!o.visualVariables?.length)return G(o,r,t)||void 0},o.readTemplatesFromService=function(e,r){return[$(this.subtypeCode,r)]},o.readTitleFromService=function(e,r){const t=J(this.subtypeCode,r);return b.isSome(t)?t.name:null},o.createPopupTemplate=function(e){let r=this;const{parent:t,fields:o,title:n}=this;if(t){const{displayField:e,editFieldsInfo:i,objectIdField:l}=t;r={displayField:e,editFieldsInfo:i,fields:o,objectIdField:l,title:n}}return k.createPopupTemplate(r,e)},o.getField=function(e){return this.fieldsIndex.get(e)},o.getFieldDomain=function(e){return this._getLayerDomain(e)},o.hasUserOverrides=function(){return M.some((e=>this.originIdOf(e)===T.OriginId.USER))},o._getLayerDomain=function(e){const r=this.fieldsIndex.get(e);return r?r.domain:null},e._createClass(t,[{key:"fields",get:function(){const{parent:e,fieldOverrides:r,subtypeCode:t}=this,o=e?.fields;if(!o?.length)return null;const{subtypes:n,subtypeField:i}=e,l=n.find((e=>e.code===t)),a=l?.defaultValues,s=l?.domains,p=[];for(const d of o){const e=d.clone(),{name:o}=e,n=r?.find((e=>e.name===o));if(e.visible=!r||!!n,n){const{alias:r,editable:t}=n;r&&(e.alias=r),!1===t&&(e.editable=!1)}const l=a?.[o]??null;e.defaultValue=o===i?t:l;const c=s?.[o]??null;e.domain=o===i?null:c?"inherited"===c.type?e.domain:c.clone():null,p.push(e)}return p}},{key:"effectiveScaleRange",get:function(){const{minScale:e,maxScale:r}=this;return{minScale:e,maxScale:r}}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"renderer",get:function(){if(this._isOverridden("renderer"))return this._get("renderer");const{parent:e}=this;return e&&!e.isTable&&"mesh"!==e.geometryType?B(e.geometryType):null},set:function(e){R.fixRendererFields(e,this.fieldsIndex),this._override("renderer",e)}}]),t}(y.HandleOwnerMixin(_.MultiOriginJSONMixin(f.IdentifiableMixin(m))));r.__decorate([h.property({json:{write:{ignoreOrigin:!0}}})],K.prototype,"charts",void 0),r.__decorate([h.property({type:Boolean,nonNullable:!0,json:{name:"enableEditing",write:{ignoreOrigin:!0}}})],K.prototype,"editingEnabled",void 0),r.__decorate([h.property({readOnly:!0,json:{name:"layerDefinition.fieldOverrides",origins:{service:{read:!1}},write:{ignoreOrigin:!0,allowNull:!0}}})],K.prototype,"fieldOverrides",void 0),r.__decorate([I.writer("fieldOverrides")],K.prototype,"writeFieldOverrides",null),r.__decorate([h.property({...N.fields,readOnly:!0,json:{read:!1}})],K.prototype,"fields",null),r.__decorate([h.property(N.fieldsIndex)],K.prototype,"fieldsIndex",void 0),r.__decorate([h.property({type:j,json:{name:"formInfo",write:{ignoreOrigin:!0}}})],K.prototype,"formTemplate",void 0),r.__decorate([h.property({type:String,readOnly:!0,json:{origins:{service:{read:!1}},write:{ignoreOrigin:!0}}})],K.prototype,"id",void 0),r.__decorate([h.property({readOnly:!0,json:{read:!1}})],K.prototype,"type",void 0),r.__decorate([h.property(q(g.clone(x.labelsVisible)))],K.prototype,"labelsVisible",void 0),r.__decorate([h.property({type:[E],json:{name:"layerDefinition.drawingInfo.labelingInfo",origins:{service:{read:!1}},read:{reader:C.reader},write:{ignoreOrigin:!0}}})],K.prototype,"labelingInfo",void 0),r.__decorate([h.property({type:["ArcGISFeatureLayer"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],K.prototype,"layerType",void 0),r.__decorate([h.property(q(g.clone(x.legendEnabled)))],K.prototype,"legendEnabled",void 0),r.__decorate([h.property({type:["show","hide"]})],K.prototype,"listMode",void 0),r.__decorate([h.property((()=>{const e=g.clone(x.minScale);return e.json.origins.service.read=!1,q(e)})())],K.prototype,"minScale",void 0),r.__decorate([h.property((()=>{const e=g.clone(x.maxScale);return e.json.origins.service.read=!1,q(e)})())],K.prototype,"maxScale",void 0),r.__decorate([h.property({readOnly:!0})],K.prototype,"effectiveScaleRange",null),r.__decorate([h.property({type:Number,range:{min:0,max:1},nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],K.prototype,"opacity",void 0),r.__decorate([h.property()],K.prototype,"parent",void 0),r.__decorate([h.property(q(g.clone(x.popupEnabled)))],K.prototype,"popupEnabled",void 0),r.__decorate([h.property({type:t,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],K.prototype,"popupTemplate",void 0),r.__decorate([h.property({readOnly:!0})],K.prototype,"defaultPopupTemplate",null),r.__decorate([h.property({types:L,json:{write:{target:"layerDefinition.drawingInfo.renderer",ignoreOrigin:!0}}})],K.prototype,"renderer",null),r.__decorate([w.reader("service","renderer",["drawingInfo.renderer","subtypeField","type"])],K.prototype,"readRendererFromService",null),r.__decorate([w.reader("renderer",["layerDefinition.drawingInfo.renderer"])],K.prototype,"readRenderer",null),r.__decorate([h.property({type:Number,json:{origins:{service:{read:!1}},write:{ignoreOrigin:!0}}})],K.prototype,"subtypeCode",void 0),r.__decorate([h.property({type:[P],json:{name:"layerDefinition.templates",write:{ignoreOrigin:!0}}})],K.prototype,"templates",void 0),r.__decorate([w.reader("service","templates",["geometryType","subtypeField","subtypes","type"])],K.prototype,"readTemplatesFromService",null),r.__decorate([h.property({type:String,json:{write:{ignoreOrigin:!0}}})],K.prototype,"title",void 0),r.__decorate([w.reader("service","title",["subtypes"])],K.prototype,"readTitleFromService",null),r.__decorate([h.property({type:Boolean,nonNullable:!0,json:{name:"visibility",write:{ignoreOrigin:!0}}})],K.prototype,"visible",void 0),K=r.__decorate([O.subclass(z)],K);return K}));
