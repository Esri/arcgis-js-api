/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/maybe","../../geometry/ellipsoidUtils","../../geometry/Extent","../../geometry/Point","../../geometry/support/WKIDUnitConversion","../ogc/crsUtils","../ogc/xmlUtils","./LOD","./TileInfo"],(function(e,t,i,n,r,l,o,s,a,c,u){"use strict";const p=90.71428571428571;function d(e){const i=e.replace(/ows:/gi,"");if(!x("Contents",(new DOMParser).parseFromString(i,"text/xml").documentElement))throw new t("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant",{text:e})}function f(e,i){e=e.replace(/ows:/gi,"");const n=(new DOMParser).parseFromString(e,"text/xml").documentElement,r=new Map,l=new Map,o=x("Contents",n);if(!o)throw new t("wmtslayer:wmts-capabilities-xml-is-not-valid");const s=x("OperationsMetadata",n)?.querySelector("[name='GetTile']"),a=s?.getElementsByTagName("Get"),c=a&&Array.prototype.slice.call(a),u=i.url?.indexOf("https"),p=void 0!==u&&u>-1;let d,f,m=i.serviceMode,g=i?.url;if(c&&c.length&&c.some((e=>{const t=x("Constraint",e);return!t||T("AllowedValues","Value",m,t)?(g=e.attributes[0].nodeValue,!0):(!t||T("AllowedValues","Value","RESTful",t)||T("AllowedValues","Value","REST",t)?f=e.attributes[0].nodeValue:t&&!T("AllowedValues","Value","KVP",t)||(d=e.attributes[0].nodeValue),!1)})),!g)if(f)g=f,m="RESTful";else if(d)g=d,m="KVP";else{const e=x("ServiceMetadataURL",n);g=e?.getAttribute("xlink:href")}const w=g.indexOf("1.0.0/");-1===w&&"RESTful"===m?g+="/":w>-1&&(g=g.substring(0,w)),"KVP"===m&&(g+=w>-1?"":"?"),p&&(g=g.replace(/^http:/i,"https:"));const R=C("ServiceIdentification>ServiceTypeVersion",n),y=C("ServiceIdentification>AccessConstraints",n),S=y&&/^none$/i.test(y)?null:y,b=h("Layer",o),V=h("TileMatrixSet",o),E=b.map((e=>{const t=C("Identifier",e);return r.set(t,e),M(t,e,V,p,R)}));return{copyright:S,dimensionMap:l,layerMap:r,layers:E,serviceMode:m,tileUrl:g}}function m(e){return e.layers.forEach((e=>{e.tileMatrixSets?.forEach((e=>{const t=e.tileInfo;t&&96!==t.dpi&&(t.lods?.forEach((i=>{i.scale=96*i.scale/t.dpi,i.resolution=W(t.spatialReference?.wkid,i.scale*p/96,e.id)})),t.dpi=96)}))})),e}function g(e){return e.nodeType===Node.ELEMENT_NODE}function x(e,t){for(let i=0;i<t.childNodes.length;i++){const n=t.childNodes[i];if(g(n)&&n.nodeName===e)return n}return null}function h(e,t){const i=[];for(let n=0;n<t.childNodes.length;n++){const r=t.childNodes[n];g(r)&&r.nodeName===e&&i.push(r)}return i}function w(e,t){const n=[];for(let i=0;i<t.childNodes.length;i++){const r=t.childNodes[i];g(r)&&r.nodeName===e&&n.push(r)}return n.map((e=>e.textContent)).filter(i.isSome)}function C(e,t){return e.split(">").forEach((e=>{t&&(t=x(e,t))})),t&&t.textContent}function T(e,t,i,n){let r;return Array.prototype.slice.call(n.childNodes).some((n=>{if(n.nodeName.includes(e)){const e=x(t,n),l=e&&e.textContent;if(l===i||i.split(":")&&i.split(":")[1]===l)return r=n,!0}return!1})),r}function M(e,t,i,n,r){const l=C("Abstract",t),o=w("Format",t);return{id:e,fullExtent:V(t),fullExtents:E(t),description:l,formats:o,styles:L(t,n),title:C("Title",t),tileMatrixSets:v(r,t,i)}}function R(e,t){const i=[],n=e.layerMap?.get(t);if(!n)return null;const r=h("ResourceURL",n),l=h("Dimension",n);let o,s,a,c;return l.length&&(o=C("Identifier",l[0]),s=w("Default",l[0])||w("Value",l[0])),l.length>1&&(a=C("Identifier",l[1]),c=w("Default",l[1])||w("Value",l[1])),e.dimensionMap.set(t,{dimensions:s,dimensions2:c}),r.forEach((e=>{let t=e.getAttribute("template");if("tile"===e.getAttribute("resourceType")){if(o&&s.length)if(t.includes("{"+o+"}"))t=t.replace("{"+o+"}","{dimensionValue}");else{const e=t.toLowerCase().indexOf("{"+o.toLowerCase()+"}");e>-1&&(t=t.substring(0,e)+"{dimensionValue}"+t.substring(e+o.length+2))}if(a&&c.length)if(t.includes("{"+a+"}"))t=t.replace("{"+a+"}","{dimensionValue2}");else{const e=t.toLowerCase().indexOf("{"+a.toLowerCase()+"}");e>-1&&(t=t.substring(0,e)+"{dimensionValue2}"+t.substring(e+a.length+2))}i.push({template:t,format:e.getAttribute("format"),resourceType:"tile"})}})),i}function y(e,t,i,n,r,l,o,s){const a=S(e,t,n);if(!(a?.length>0))return"";const{dimensionMap:c}=e,u=c.get(t).dimensions?.[0],p=c.get(t).dimensions2?.[0];return a[o%a.length].template.replace(/\{Style\}/gi,r??"").replace(/\{TileMatrixSet\}/gi,i??"").replace(/\{TileMatrix\}/gi,l).replace(/\{TileRow\}/gi,""+o).replace(/\{TileCol\}/gi,""+s).replace(/\{dimensionValue\}/gi,u).replace(/\{dimensionValue2\}/gi,p)}function S(e,t,i){const n=R(e,t),r=n?.filter((e=>e.format===i));return(r?.length?r:n)??[]}function b(e,t,i,n){const{dimensionMap:r}=e,l=R(e,t);let o="";if(l&&l.length>0){const e=r.get(t).dimensions&&r.get(t).dimensions[0],s=r.get(t).dimensions2&&r.get(t).dimensions2[0];o=l[0].template,o.indexOf(".xxx")===o.length-4&&(o=o.slice(0,o.length-4)),o=o.replace(/\{Style\}/gi,n),o=o.replace(/\{TileMatrixSet\}/gi,i),o=o.replace(/\{TileMatrix\}/gi,"{level}"),o=o.replace(/\{TileRow\}/gi,"{row}"),o=o.replace(/\{TileCol\}/gi,"{col}"),o=o.replace(/\{dimensionValue\}/gi,e),o=o.replace(/\{dimensionValue2\}/gi,s)}return o}function V(e){const t=x("WGS84BoundingBox",e),i=t?C("LowerCorner",t).split(" "):["-180","-90"],n=t?C("UpperCorner",t).split(" "):["180","90"];return{xmin:parseFloat(i[0]),ymin:parseFloat(i[1]),xmax:parseFloat(n[0]),ymax:parseFloat(n[1]),spatialReference:{wkid:4326}}}function E(e){const t=[];return a.visitXML(e,{BoundingBox:e=>{if(!e.getAttribute("crs"))return;const i=e.getAttribute("crs").toLowerCase(),n=I(i),r=i.includes("epsg")&&s.isAxesOrderReversedForWkid(n.wkid);let l,o,c,u;a.visitXML(e,{LowerCorner:e=>{[l,o]=e.textContent.split(" ").map((e=>Number.parseFloat(e))),r&&([l,o]=[o,l])},UpperCorner:e=>{[c,u]=e.textContent.split(" ").map((e=>Number.parseFloat(e))),r&&([c,u]=[u,c])}}),t.push({xmin:l,ymin:o,xmax:c,ymax:u,spatialReference:n})}}),t}function L(e,t){return h("Style",e).map((e=>{const i=x("LegendURL",e),n=x("Keywords",e),r=n?w("Keyword",n):[];let l=i&&i.getAttribute("xlink:href");t&&(l=l&&l.replace(/^http:/i,"https:"));return{abstract:C("Abstract",e),id:C("Identifier",e),isDefault:"true"===e.getAttribute("isDefault"),keywords:r,legendUrl:l,title:C("Title",e)}}))}function v(e,t,i){return h("TileMatrixSetLink",t).map((t=>F(e,t,i)))}function F(e,t,i){const n=x("TileMatrixSet",t).textContent,r=w("TileMatrix",t),l=i.find((e=>{const t=x("Identifier",e),i=t&&t.textContent;return!!(i===n||n.split(":")&&n.split(":")[1]===i)})),o=x("TileMatrixSetLimits",t),s=o&&h("TileMatrixLimits",o),a=new Map;if(s?.length)for(const u of s){const e=x("TileMatrix",u).textContent,t=+x("MinTileRow",u).textContent,i=+x("MaxTileRow",u).textContent,n=+x("MinTileCol",u).textContent,r=+x("MaxTileCol",u).textContent;a.set(e,{minCol:n,maxCol:r,minRow:t,maxRow:i})}const c=C("SupportedCRS",l).toLowerCase(),p=A(l,c),d=p.spatialReference,f=x("TileMatrix",l),m=[parseInt(C("TileWidth",f),10),parseInt(C("TileHeight",f),10)],g=[];if(r.length)r.forEach(((e,t)=>{const i=T("TileMatrix","Identifier",e,l);g.push(P(i,c,t,n,a))}));else{h("TileMatrix",l).forEach(((e,t)=>{g.push(P(e,c,t,n,a))}))}const M=O(e,l,p,m,g[0]).toJSON(),R=new u({dpi:96,spatialReference:d,size:m,origin:p,lods:g}).toJSON();return{id:n,fullExtent:M,tileInfo:R}}function I(e){e=e.toLowerCase();let t=parseInt(e.split(":").pop(),10);900913!==t&&3857!==t||(t=102100);const n=D(e);return i.isSome(n)&&(t=n),{wkid:t}}function A(e,t){return N(x("TileMatrix",e),t)}function N(e,t){const i=I(t),[n,r]=C("TopLeftCorner",e).split(" ").map((e=>parseFloat(e))),o=t.includes("epsg")&&s.isAxesOrderReversedForWkid(i.wkid);return new l(o?{x:r,y:n,spatialReference:i}:{x:n,y:r,spatialReference:i})}function O(e,t,i,n,l){const o=x("BoundingBox",t);let s,a,c,u,p,d;if(o&&(s=C("LowerCorner",o).split(" "),a=C("UpperCorner",o).split(" ")),s&&s.length>1&&a&&a.length>1)c=parseFloat(s[0]),p=parseFloat(s[1]),u=parseFloat(a[0]),d=parseFloat(a[1]);else{const e=x("TileMatrix",t),r=parseInt(C("MatrixWidth",e),10),o=parseInt(C("MatrixHeight",e),10);c=i.x,d=i.y,u=c+r*n[0]*l.resolution,p=d-o*n[1]*l.resolution}return U(e,i.spatialReference,i)?new r(p,c,d,u,i.spatialReference):new r(c,p,u,d,i.spatialReference)}function U(e,t,i){return"1.0.0"===e&&s.isAxesOrderReversedForWkid(t.wkid)&&!(i.spatialReference.isGeographic&&i.x<-90&&i.y>=-90)}var k;function D(e){return e.includes("crs84")||e.includes("crs:84")?k.CRS84:e.includes("crs83")||e.includes("crs:83")?k.CRS83:e.includes("crs27")||e.includes("crs:27")?k.CRS27:null}function P(e,t,i,n,r){const l=I(t),o=C("Identifier",e);let s=parseFloat(C("ScaleDenominator",e));const a=W(l.wkid,s,n);s*=96/p;const u=+C("MatrixWidth",e),d=+C("MatrixHeight",e),{maxCol:f=u-1,maxRow:m=d-1,minCol:g=0,minRow:x=0}=r.get(o)??{},{x:h,y:w}=N(e,t);return new c({cols:[g,f],level:i,levelValue:o,origin:[h,w],scale:s,resolution:a,rows:[x,m]})}function W(e,t,i){let r;return r=o.hasOwnProperty(""+e)?o.values[o[e]]:"default028mm"===i?6370997*Math.PI/180:n.getReferenceEllipsoidFromWKID(e).metersPerDegree,7*t/25e3/r}!function(e){e[e.CRS84=4326]="CRS84",e[e.CRS83=4269]="CRS83",e[e.CRS27=4267]="CRS27"}(k||(k={})),e.getTileUrlFromResourceUrls=y,e.getTileUrlTemplateFromResourceUrls=b,e.getTileUrlTemplates=S,e.parseCapabilities=f,e.parseResourceInfo=m,e.validateCapabilities=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
