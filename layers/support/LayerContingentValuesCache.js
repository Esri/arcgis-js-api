/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../request","../../core/JSONSupport","../../core/Loadable","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","./arcgisLayerUrl","./Contingency","./ContingencyConstraintViolation","./ContingentValue","./ContingentValuesResult","./FieldGroup","./Subtype"],(function(e,t,n,i,r,o,s,a,u,l,c,p,f,y,d,h,m){"use strict";var g;let V=g=function(t){function i(e){var i;return(i=t.call(this,e)||this).request=n,i.fieldGroups=null,i.fieldGroupDefinitions=null,i}e._inheritsLoose(i,t);var r=i.prototype;return r.initialize=function(){},i.createLoadedLayerContingentValuesCache=function(){var t=e._asyncToGenerator((function*(e){yield e.load();const t=e.sourceJSON;if(void 0===e.layerId)return null;const n=t.hasContingentValuesDefinition;if(n)return new g({layer:e}).load();if(void 0===n){const t=c.parse(e.url);if(o.isNone(t))return null;const n=t.url.path;if((yield g._staticFetchEnterpriseFeatureRoot(n)).supportsQueryDataElements){const t=e.layerId.toString(),i=yield g._staticFetchEnterpriseFieldGroup(n,t);if(i){const t=i.map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names})));return new g({layer:e,fieldGroupDefinitions:t}).load()}}}return null}));function n(e){return t.apply(this,arguments)}return n}(),r.load=function(){var t=e._asyncToGenerator((function*(e){const t=this.layer.load(e).then((()=>this._initializeContingentValues(this.fieldGroupDefinitions,e)));return this.addResolvingPromise(t),this}));function n(e){return t.apply(this,arguments)}return n}(),r.validateContingencyConstraints=function(e,t){const n=Object.keys(e),i=[],r=[];for(const o of this.fieldGroups){const s=o.isEditingRestrictive?"error":"warning";if(t&&!o.fields.some((e=>t.includes(e))))continue;if(!o.fields.every((e=>n.includes(e)))){r.push(new f({fieldGroup:o,type:s}));continue}let a=!1;const u=e[this.subtypeFieldName],l=o.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===u));for(const t of l){let n=!0;for(const i in t.values){const r=t.values[i];if("any"!==r.objectType)if("null"===r.objectType){if(null!=e[i]){n=!1;break}}else if("code"===r.objectType){if(e[i]!==r.codedValue.code){n=!1;break}}else if("range"===r.objectType){const t=e[i];if(t<r.minValue||t>r.maxValue){n=!1;break}}}if(n){a=!0;break}}a||i.push(new f({fieldGroup:o,type:s}))}return{invalid:i,incomplete:r}},r.getContingentValues=function(e,t,n=!1){const i=e[this.subtypeFieldName],r=null!=i,o={};let s=[];const a=this.fieldGroups.filter((e=>e.fields.includes(t)));s.push(new y({objectType:"any"}));for(const u of a){let a=[];const l=u.contingencies.filter((e=>!(e.isRetired||e.subtype&&r&&e.subtype.code!==i)));let c=!1;const p={};for(const n of l){let i,r=!0;for(const o in n.values){const s=n.values[o];if(t!==o){if(void 0!==e[o]&&"any"!==s.objectType)if("null"===s.objectType)null!==e[o]&&(r=!1);else if("code"===s.objectType)e[o]!==s.codedValue.code&&(r=!1);else if("range"===s.objectType){const t=e[o];(t<s.minValue||t>s.maxValue)&&(r=!1)}}else i=s,c=c||"range"===s.objectType}if(i&&r){if("any"===i.objectType){a.length=0,a.push(i);break}const e=this._generateKey(i);p[e]||a.push(i),p[e]=!0}}c&&(a=this._joinRange(a)),o[u.name]=a,s=n?this._filterIntersection(s,a):[]}return 1===a.length&&n&&(s=[]),new d({contingentValuesAllGroups:s,contingentValuesByFieldGroup:o})},r._generateKey=function(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}},r._joinRange=function(e){let t,n;e.sort(((e,t)=>"null"===e.objectType?-1:"null"===t.objectType?1:e.minValue-t.minValue));const i=[];for(const r of e)"null"!==r.objectType?null!=t&&null!=n?n<r.minValue?(i.push(new y({objectType:"range",minValue:t,maxValue:n})),t=r.minValue,n=r.maxValue):n<r.maxValue&&(n=r.maxValue):(t=r.minValue,n=r.maxValue):i.push(r);return i.push(new y({objectType:"range",minValue:t,maxValue:n})),i},r._filterIntersection=function(e,t){if(0===e.length||0===t.length)return[];if("any"===e[0].objectType)return t;if("any"===t[0].objectType)return e;const n="range"===e[0].objectType||"range"===e[1]?.objectType,i="range"===t[0].objectType||"range"===t[1]?.objectType;return n||i?this._intersectRanges(e,t):this._intersectValues(e,t)},r._intersectRanges=function(e,t){const n=[];let i,r=0;for(const o of e)for(;r<t.length;r++){const e=t[r];if("null"===o.objectType&&"null"===e.objectType)n.push(new y({objectType:"null"}));else{if("null"===o.objectType)break;if("null"===e.objectType)continue}if(o.maxValue<e.minValue)break;if(o.maxValue===e.minValue){n.push(new y({objectType:"range",minValue:o.maxValue,maxValue:e.minValue}));break}if(!(o.minValue>e.maxValue))if(o.minValue!==e.maxValue){if(i=o.minValue>e.minValue?o.minValue:e.minValue,o.maxValue<e.maxValue){n.push(new y({objectType:"range",minValue:i,maxValue:o.maxValue}));break}n.push(new y({objectType:"range",minValue:i,maxValue:e.maxValue}))}else n.push(new y({objectType:"range",minValue:o.minValue,maxValue:e.maxValue}))}return n},r._intersectValues=function(e,t){const n=[];for(const i of e)t.some((e=>{if(i.objectType===e.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===e.codedValue.code&&i.codedValue.name===e.codedValue.name}return!1}))&&n.push(i);return n},i._staticFetchEnterpriseFeatureRoot=function(){var t=e._asyncToGenerator((function*(e,t){return n(e,{responseType:"json",query:{f:"json"},...t}).then((e=>e.data))}));function i(e,n){return t.apply(this,arguments)}return i}(),i._staticFetchEnterpriseFieldGroup=function(){var t=e._asyncToGenerator((function*(e,t,i){return n(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...i}).then((e=>e.data.layerDataElements?.[0].dataElement.fieldGroups))}));function i(e,n,i){return t.apply(this,arguments)}return i}(),r._initializeContingentValues=function(){var t=e._asyncToGenerator((function*(e,t){const n=e||(yield this._fetchFieldGroupDefs(t));if(0===n.length)return void(this.fieldGroups=[]);const i=yield this._fetchContingentValues(n,t);this.fieldGroups=i}));function n(e,n){return t.apply(this,arguments)}return n}(),r._fetchFieldGroupDefs=function(){var t=e._asyncToGenerator((function*(t){var n=this;if(void 0===this.layer.layerId)return[];const i=this.layer.sourceJSON,r=this.layer.layerId.toString(),s=o.unwrap(c.parse(this.layer.url)).url.path;if(i.hasContingentValuesDefinition){return(yield this._fetchAGOLFieldGroup(s,r,t)).map((e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))})))}return void 0!==i.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(s,t).then(function(){var i=e._asyncToGenerator((function*(e){if(e.supportsQueryDataElements){return(yield n._fetchEnterpriseFieldGroup(s,r,t)).map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map((e=>n.layer.fieldsIndex.normalizeFieldName(e)))})))}return[]}));return function(e){return i.apply(this,arguments)}}())}));function n(e){return t.apply(this,arguments)}return n}(),r._fetchAGOLFieldGroup=function(){var t=e._asyncToGenerator((function*(e,t,i){return n(`${e}/${t}/fieldgroups`,{responseType:"json",query:{f:"json"},...i}).then((e=>e.data.fieldGroups))}));function i(e,n,i){return t.apply(this,arguments)}return i}(),r._fetchEnterpriseFieldGroup=function(){var t=e._asyncToGenerator((function*(e,t,n){return g._staticFetchEnterpriseFieldGroup(e,t,n)}));function n(e,n,i){return t.apply(this,arguments)}return n}(),r._fetchEnterpriseFeatureRoot=function(){var t=e._asyncToGenerator((function*(e,t){return g._staticFetchEnterpriseFeatureRoot(e,t)}));function n(e,n){return t.apply(this,arguments)}return n}(),r._fetchContingentValues=function(){var t=e._asyncToGenerator((function*(e,t){if(void 0===this.layer.layerId)return[];const n=this.layer.sourceJSON,i=this.layer.layerId.toString(),r=o.unwrap(c.parse(this.layer.url)).url.path;if(n.hasContingentValuesDefinition){const n=yield this._fetchAGOLContingentValues(r,i,t);return this._constructFieldGroupsAGOL(e,n)}const s=yield this._fetchEnterpriseContingentValues(r,i,t);return this._constructFieldGroupsEnterprise(e,s)}));function n(e,n){return t.apply(this,arguments)}return n}(),r._constructFieldGroupsAGOL=function(e,t){return e.map((e=>{const n=t.contingentValuesDefinition.fieldGroups.find((t=>t.name===e.name));if(n){let i=[];return i=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,t,n.subTypes):this._parseAGOLFieldGroup(e,t,n.contingentValues),new h({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:i})}return null})).filter(o.isSome)},r._parseAGOLFieldGroupSubtype=function(e,t,n){let i=[];return n?.forEach((n=>{const r=this._getSubtypeAGOL(n.name);i=i.concat(this._parseAGOLFieldGroup(e,t,n.contingentValues,r))})),i},r._parseAGOLFieldGroup=function(e,t,n,i=null){const r=[];for(const o of n??[]){const n=this._parseAGOLContingency(o,e,t,i);r.push(n)}return r},r._parseAGOLContingency=function(e,t,n,i){const r=e.id,o=!!e.retired&&1===e.retired,s={};for(let a=0,u=0;a<t.fields.length;a++){const r=t.fields[a],o=n.typeCodes[e.types[a]];if("Code"===o){let t=e.values[u];u++;const o=this._getDomain(i,r);if("string"===this.layer.getField(r)?.type){const e=n.stringDicts.find((e=>e.domain===o.name));e&&(t=e.entries[t])}const a=o.codedValues.find((e=>e.code===t)),l=new y({codedValue:a,objectType:"code"});s[r]=l}else if("Range"===o){const t=e.values[u];u++;const n=t.range[0],i=t.range[1],o=new y({minValue:n,maxValue:i,objectType:"range"});s[r]=o}else if("Any"===o){const e=new y({objectType:"any"});s[r]=e}else{const e=new y({objectType:"null"});s[r]=e}}return new p({id:r,isRetired:o,subtype:i,values:s})},r._constructFieldGroupsEnterprise=function(e,t){const n=t.fieldGroups;return e.map((e=>{const i=n.find((t=>t.name===e.name));if(i){const n=i.contingencies.map((n=>{const i=n.id,r=n.isRetired||!1,o=this._getSubtypeEnterprise(n.subtypeCode),s={};for(let a=0;a<e.fields.length;a++){const i=e.fields[a];let r=n.values[a];if("number"==typeof r||"string"==typeof r){const e=this._getDomain(o,i),n=this.layer.getField(i);if("string"===n?.type)r=t.stringDictionary[r];else if("date"===n?.type){const e=new Date(`${r}+00:00`);r=e.getTime()}const a=e.codedValues.find((e=>e.code===r)),u=new y({codedValue:a,objectType:"code"});s[i]=u}else if("object"==typeof r){const e=r.minValue,t=r.maxValue,n=new y({minValue:e,maxValue:t,objectType:"range"});s[i]=n}else if(r){const e=new y({objectType:"any"});s[i]=e}else{const e=new y({objectType:"null"});s[i]=e}}return new p({id:i,isRetired:r,subtype:o,values:s})}));return new h({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:n})}return null})).filter(o.isSome)},r._fetchEnterpriseContingentValues=function(){var t=e._asyncToGenerator((function*(e,t,i){return n(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...i}).then((e=>e.data.contingentValueSets?.[0]))}));function i(e,n,i){return t.apply(this,arguments)}return i}(),r._fetchAGOLContingentValues=function(){var t=e._asyncToGenerator((function*(e,t,i){return n(`${e}/${t}/contingentValues`,{responseType:"json",query:{f:"json"},...i}).then((e=>e.data))}));function i(e,n,i){return t.apply(this,arguments)}return i}(),r._getSubtypeEnterprise=function(e){const t=this.layer.sourceJSON;let n;if(t.subtypes){const i=t.subtypes.find((t=>t.code===e));n=m.fromJSON(i)}return n||null},r._getSubtypeAGOL=function(e){const t=this.layer.sourceJSON;let n;if(t.subtypes){const i=t.subtypes.find((t=>t.name===e));n=m.fromJSON(i)}return n||null},r._getDomain=function(e,t){const n=e?e.domains?.[t]:this.layer.getFieldDomain(t);return"inherited"===n?.type?this.layer.getFieldDomain(t):n},e._createClass(i,[{key:"subtypeFieldName",get:function(){const{layer:e}=this;return"subtype-group"===e.type?e.subtypeField:e.typeIdField}}]),i}(i.JSONSupportMixin(r));t.__decorate([s.property({constructOnly:!0})],V.prototype,"layer",void 0),t.__decorate([s.property({constructOnly:!0})],V.prototype,"request",void 0),t.__decorate([s.property({type:[h]})],V.prototype,"fieldGroups",void 0),t.__decorate([s.property({constructOnly:!0})],V.prototype,"fieldGroupDefinitions",void 0),t.__decorate([s.property()],V.prototype,"subtypeFieldName",null),V=g=t.__decorate([l.subclass("esri.layers.support.LayerContingentValuesCache")],V);return V}));
