/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../request","../../core/JSONSupport","../../core/Loadable","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/arrayUtils","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","./arcgisLayerUrl","./Contingency","./ContingencyConstraintViolation","./ContingentValue","./ContingentValuesResult","./FieldGroup","./Subtype"],(function(e,n,t,i,r,o,s,a,u,l,c,p,f,d,y,h,m,g){"use strict";var V;let b=V=function(n){function i(e){var i;return(i=n.call(this,e)||this).request=t,i.fieldGroups=null,i.fieldGroupDefinitions=null,i}e._inheritsLoose(i,n);var r=i.prototype;return r.initialize=function(){},i.createLoadedLayerContingentValuesCache=function(){var n=e._asyncToGenerator((function*(e){yield e.load();const n=e.sourceJSON.hasContingentValuesDefinition;if(n)return new V({layer:e}).load();if(void 0===n){const n=p.parse(e.url);if(o.isNone(n))return null;const t=n.url.path;if((yield V._staticFetchEnterpriseFeatureRoot(t)).supportsQueryDataElements){const n=e.layerId.toString(),i=yield V._staticFetchEnterpriseFieldGroup(t,n);if(i){const n=i.map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names})));return new V({layer:e,fieldGroupDefinitions:n}).load()}}}return null}));function t(e){return n.apply(this,arguments)}return t}(),r.load=function(){var n=e._asyncToGenerator((function*(e){const n=this.layer.load(e).then((()=>this._initializeContingentValues(this.fieldGroupDefinitions,e)));return this.addResolvingPromise(n),this}));function t(e){return n.apply(this,arguments)}return t}(),r.validateContingencyConstraints=function(e,n){const t=this.layer.typeIdField,i=Object.keys(e),r=[],o=[];for(const s of this.fieldGroups){const a=s.isEditingRestrictive?"error":"warning";if(n&&!s.fields.some((e=>n.includes(e))))continue;if(!s.fields.every((e=>i.includes(e)))){o.push(new d({fieldGroup:s,type:a}));continue}let u=!1;const l=e[t],c=s.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===l));for(const n of c){let t=!0;for(const i in n.values){const r=n.values[i];if("any"!==r.objectType)if("null"===r.objectType){if(null!=e[i]){t=!1;break}}else if("code"===r.objectType){if(e[i]!==r.codedValue.code){t=!1;break}}else if("range"===r.objectType){const n=e[i];if(n<r.minValue||n>r.maxValue){t=!1;break}}}if(t){u=!0;break}}u||r.push(new d({fieldGroup:s,type:a}))}return{invalid:r,incomplete:o}},r.getContingentValues=function(e,n,t=!1){const i=e[this.layer.typeIdField],r={};let o=[];const s=this.fieldGroups.filter((e=>e.fields.includes(n)));o.push(new y({objectType:"any"}));for(const a of s){let s=[];const u=a.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===i));let l=!1;const c={};for(const t of u){let i,r=!0;for(const o in t.values){const s=t.values[o];if(n!==o){if(void 0!==e[o]&&"any"!==s.objectType)if("null"===s.objectType)null!==e[o]&&(r=!1);else if("code"===s.objectType)e[o]!==s.codedValue.code&&(r=!1);else if("range"===s.objectType){const n=e[o];(n<s.minValue||n>s.maxValue)&&(r=!1)}}else i=s,l=l||"range"===s.objectType}if(i&&r){if("any"===i.objectType){s.length=0,s.push(i);break}const e=this._generateKey(i);c[e]||s.push(i),c[e]=!0}}l&&(s=this._joinRange(s)),r[a.name]=s,o=t?this._filterIntersection(o,s):null}return 1===s.length&&(o=[]),new h({contingentValuesAllGroups:o,contingentValuesByFieldGroup:r})},r._generateKey=function(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}},r._joinRange=function(e){let n,t;e.sort(((e,n)=>"null"===e.objectType?-1:"null"===n.objectType?1:e.minValue-n.minValue));const i=[];for(const r of e)"null"!==r.objectType?void 0!==n?t<r.minValue?(i.push(new y({objectType:"range",minValue:n,maxValue:t})),n=r.minValue,t=r.maxValue):t<r.maxValue&&(t=r.maxValue):(n=r.minValue,t=r.maxValue):i.push(r);return i.push(new y({objectType:"range",minValue:n,maxValue:t})),i},r._filterIntersection=function(e,n){var t,i;if(0===e.length||0===n.length)return[];if("any"===e[0].objectType)return n;if("any"===n[0].objectType)return e;const r="range"===e[0].objectType||"range"===(null==(t=e[1])?void 0:t.objectType),o="range"===n[0].objectType||"range"===(null==(i=n[1])?void 0:i.objectType);return r||o?this._intersectRanges(e,n):this._intersectValues(e,n)},r._intersectRanges=function(e,n){const t=[];let i,r=0;for(const o of e)for(;r<n.length;r++){const e=n[r];if("null"===o.objectType&&"null"===e.objectType)t.push(new y({objectType:"null"}));else{if("null"===o.objectType)break;if("null"===e.objectType)continue}if(o.maxValue<e.minValue)break;if(o.maxValue===e.minValue){t.push(new y({objectType:"range",minValue:o.maxValue,maxValue:e.minValue}));break}if(!(o.minValue>e.maxValue))if(o.minValue!==e.maxValue){if(i=o.minValue>e.minValue?o.minValue:e.minValue,o.maxValue<e.maxValue){t.push(new y({objectType:"range",minValue:i,maxValue:o.maxValue}));break}t.push(new y({objectType:"range",minValue:i,maxValue:e.maxValue}))}else t.push(new y({objectType:"range",minValue:o.minValue,maxValue:e.maxValue}))}return t},r._intersectValues=function(e,n){const t=[];for(const i of e)n.some((e=>{if(i.objectType===e.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===e.codedValue.code&&i.codedValue.name===e.codedValue.name}return!1}))&&t.push(i);return t},i._staticFetchEnterpriseFeatureRoot=function(){var n=e._asyncToGenerator((function*(e,n){return t(e,{responseType:"json",query:{f:"json"},...n}).then((e=>e.data))}));function i(e,t){return n.apply(this,arguments)}return i}(),i._staticFetchEnterpriseFieldGroup=function(){var n=e._asyncToGenerator((function*(e,n,i){return t(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([n]),f:"json"},...i}).then((e=>{var n;return null==(n=e.data.layerDataElements)?void 0:n[0].dataElement.fieldGroups}))}));function i(e,t,i){return n.apply(this,arguments)}return i}(),r._initializeContingentValues=function(){var n=e._asyncToGenerator((function*(e,n){const t=e||(yield this._fetchFieldGroupDefs(n));if(0===t.length)return void(this.fieldGroups=[]);const i=yield this._fetchContingentValues(t,n);this.fieldGroups=i}));function t(e,t){return n.apply(this,arguments)}return t}(),r._fetchFieldGroupDefs=function(){var n=e._asyncToGenerator((function*(n){var t=this;const i=this.layer.sourceJSON,r=this.layer.layerId.toString(),s=o.unwrap(p.parse(this.layer.url)).url.path;if(i.hasContingentValuesDefinition){return(yield this._fetchAGOLFieldGroup(s,r,n)).map((e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))})))}return void 0!==i.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(s,n).then(function(){var i=e._asyncToGenerator((function*(e){if(e.supportsQueryDataElements){return(yield t._fetchEnterpriseFieldGroup(s,r,n)).map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map((e=>t.layer.fieldsIndex.normalizeFieldName(e)))})))}return[]}));return function(e){return i.apply(this,arguments)}}())}));function t(e){return n.apply(this,arguments)}return t}(),r._fetchAGOLFieldGroup=function(){var n=e._asyncToGenerator((function*(e,n,i){return t(`${e}/${n}/fieldgroups`,{responseType:"json",query:{f:"json"},...i}).then((e=>e.data.fieldGroups))}));function i(e,t,i){return n.apply(this,arguments)}return i}(),r._fetchEnterpriseFieldGroup=function(){var n=e._asyncToGenerator((function*(e,n,t){return V._staticFetchEnterpriseFieldGroup(e,n,t)}));function t(e,t,i){return n.apply(this,arguments)}return t}(),r._fetchEnterpriseFeatureRoot=function(){var n=e._asyncToGenerator((function*(e,n){return V._staticFetchEnterpriseFeatureRoot(e,n)}));function t(e,t){return n.apply(this,arguments)}return t}(),r._fetchContingentValues=function(){var n=e._asyncToGenerator((function*(e,n){const t=this.layer.sourceJSON,i=this.layer.layerId.toString(),r=o.unwrap(p.parse(this.layer.url)).url.path;if(t.hasContingentValuesDefinition){const t=yield this._fetchAGOLContingentValues(r,i,n);return this._constructFieldGroupsAGOL(e,t)}const s=yield this._fetchEnterpriseContingentValues(r,i,n);return this._constructFieldGroupsEnterprise(e,s)}));function t(e,t){return n.apply(this,arguments)}return t}(),r._constructFieldGroupsAGOL=function(e,n){return e.map((e=>{const t=n.contingentValuesDefinition.fieldGroups.find((n=>n.name===e.name));if(t){let i=[];return i=n.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,n,t.subTypes):this._parseAGOLFieldGroup(e,n,t.contingentValues),new m({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:i})}return null})).filter((e=>null!==e))},r._parseAGOLFieldGroupSubtype=function(e,n,t){let i=[];return t.forEach((t=>{const r=this._getSubtypeAGOL(t.name);i=i.concat(this._parseAGOLFieldGroup(e,n,t.contingentValues,r))})),i},r._parseAGOLFieldGroup=function(e,n,t,i=null){const r=[];for(const o of t){const t=this._parseAGOLContingency(o,e,n,i);r.push(t)}return r},r._parseAGOLContingency=function(e,n,t,i){const r=e.id,o=!!e.retired&&1===e.retired,s={};for(let a=0,u=0;a<n.fields.length;a++){const r=n.fields[a],o=t.typeCodes[e.types[a]];if("Code"===o){let n=e.values[u];u++;const o=this._getDomain(i,r);if("string"===this.layer.getField(r).type){const e=t.stringDicts.find((e=>e.domain===o.name));e&&(n=e.entries[n])}const a=o.codedValues.find((e=>e.code===n)),l=new y({codedValue:a,objectType:"code"});s[r]=l}else if("Range"===o){const n=e.values[u];u++;const t=n.range[0],i=n.range[1],o=new y({minValue:t,maxValue:i,objectType:"range"});s[r]=o}else if("Any"===o){const e=new y({objectType:"any"});s[r]=e}else{const e=new y({objectType:"null"});s[r]=e}}return new f({id:r,isRetired:o,subtype:i,values:s})},r._constructFieldGroupsEnterprise=function(e,n){const t=n.fieldGroups;return e.map((e=>{const i=t.find((n=>n.name===e.name));if(i){const t=i.contingencies.map((t=>{const i=t.id,r=t.isRetired||!1,o=this._getSubtypeEnterprise(t.subtypeCode),s={};for(let a=0;a<e.fields.length;a++){const i=e.fields[a];let r=t.values[a];if("number"==typeof r||"string"==typeof r){const e=this._getDomain(o,i),t=this.layer.getField(i);if("string"===t.type)r=n.stringDictionary[r];else if("date"===t.type){const e=new Date(`${r}+00:00`);r=e.getTime()}const a=e.codedValues.find((e=>e.code===r)),u=new y({codedValue:a,objectType:"code"});s[i]=u}else if("object"==typeof r){const e=r.minValue,n=r.maxValue,t=new y({minValue:e,maxValue:n,objectType:"range"});s[i]=t}else if(r){const e=new y({objectType:"any"});s[i]=e}else{const e=new y({objectType:"null"});s[i]=e}}return new f({id:i,isRetired:r,subtype:o,values:s})}));return new m({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:t})}return null})).filter((e=>null!==e))},r._fetchEnterpriseContingentValues=function(){var n=e._asyncToGenerator((function*(e,n,i){return t(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([n]),f:"json"},...i}).then((e=>{var n;return null==(n=e.data.contingentValueSets)?void 0:n[0]}))}));function i(e,t,i){return n.apply(this,arguments)}return i}(),r._fetchAGOLContingentValues=function(){var n=e._asyncToGenerator((function*(e,n,i){return t(`${e}/${n}/contingentValues`,{responseType:"json",query:{f:"json"},...i}).then((e=>e.data))}));function i(e,t,i){return n.apply(this,arguments)}return i}(),r._getSubtypeEnterprise=function(e){const n=this.layer.sourceJSON;let t;if(n.subtypes){const i=n.subtypes.find((n=>n.code===e));t=g.fromJSON(i)}return t||null},r._getSubtypeAGOL=function(e){const n=this.layer.sourceJSON;let t;if(n.subtypes){const i=n.subtypes.find((n=>n.name===e));t=g.fromJSON(i)}return t||null},r._getDomain=function(e,n){const t=e?e.domains[n]:this.layer.getFieldDomain(n);return"inherited"===t.type?this.layer.getFieldDomain(n):t},i}(i.JSONSupportMixin(r));n.__decorate([s.property({constructOnly:!0})],b.prototype,"layer",void 0),n.__decorate([s.property({constructOnly:!0})],b.prototype,"request",void 0),n.__decorate([s.property({type:[m]})],b.prototype,"fieldGroups",void 0),n.__decorate([s.property()],b.prototype,"fieldGroupDefinitions",void 0),b=V=n.__decorate([c.subclass("esri.layers.support.LayerContingentValuesCache")],b);return b}));
