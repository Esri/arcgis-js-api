/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../core/Logger","../../core/Error","../../support/arcadeOnDemand","./fieldUtils","../../intl/date","../../intl/number","./FieldsIndex","./labelUtils"],(function(e,t,r,n,a,l,i,s,o,u){"use strict";const c=r.getLogger("esri.layers.support.labelFormatUtils"),d={type:"simple",evaluate:()=>null},p={getAttribute:(e,t)=>e.field(t)};function f(e,t){if(null==e)return"";const r=t.domain;if(r)if("codedValue"===r.type||"coded-value"===r.type){const t=e;for(const e of r.codedValues)if(e.code===t)return e.name}else if("range"===r.type){const t=+e,n="range"in r?r.range[0]:r.minValue,a="range"in r?r.range[1]:r.maxValue;if(n<=t&&t<=a)return r.name}let n=e;return"date"===t.type||"esriFieldTypeDate"===t.type?n=i.formatDate(n,i.convertDateFormatToIntlOptions("short-date")):l.isNumericField(t)&&(n=s.formatNumber(+n)),n||""}t.createLabelFunction=async function(t,r,i){if(!t||!t.symbol)return d;const s=t.where,m=u.getLabelExpression(t),g=s?await new Promise((function(t,r){e(["../../core/sql/WhereClause"],t,r)})):null;let b;if("arcade"===m.type){const e=await a.createLabelExpression(m.expression,i,r);b={type:"arcade",evaluate(t){try{const r=e.evaluate({$feature:"attributes"in t?e.repurposeFeature(t):e.repurposeAdapter(t)});if(null!=r)return r.toString()}catch(e){c.error(new n("bad-arcade-expression","Encountered an error when evaluating label expression for feature",{feature:t,expression:m}))}return null},needsHydrationToEvaluate:()=>null==u.getSingleFieldArcadeExpression(m.expression)}}else b={type:"simple",evaluate:e=>m.expression.replace(/{[^}]*}/g,(t=>{const n=t.slice(1,-1),a=l.getField(r,n);if(!a)return t;let i=null;if("attributes"in e){e&&e.attributes&&(i=e.attributes[a.name])}else i=e.field(a.name);return null==i?"":f(i,a)}))};if(s){let e;try{e=g.WhereClause.create(s,new o(r))}catch(e){return d}const t=b.evaluate;b.evaluate=r=>{const n="attributes"in r?void 0:p;return e.testFeature(r,n)?t(r):null}}return b},t.formatField=f,Object.defineProperty(t,"__esModule",{value:!0})}));
