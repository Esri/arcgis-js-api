/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/Logger","../../intl/date","../../intl/number","./fieldUtils","./labelUtils","../../support/arcadeOnDemand"],(function(e,t,r,n,a,l,i,u,o,s){"use strict";const c=a.getLogger("esri.layers.support.labelFormatUtils"),p={type:"simple",evaluate:()=>null},d={getAttribute:(e,t)=>e.field(t)};function f(e,t,r){return g.apply(this,arguments)}function g(){return(g=r._asyncToGenerator((function*(t,r,a){if(!t||!t.symbol)return p;const l=t.where,i=o.getLabelExpression(t),u=l?yield new Promise(((t,r)=>e(["../../core/sql/WhereClause"],t,r))):null;let f;if("arcade"===i.type){const e=yield s.createLabelExpression(i.expression,a,r);f={type:"arcade",evaluate(t){try{const r=e.evaluate({$feature:"attributes"in t?e.repurposeFeature(t):t});if(null!=r)return r.toString()}catch(r){c.error(new n("bad-arcade-expression","Encountered an error when evaluating label expression for feature",{feature:t,expression:i}))}return null},needsHydrationToEvaluate:()=>null==o.getSingleFieldArcadeExpression(i.expression)}}else f={type:"simple",evaluate:e=>i.expression.replace(/{[^}]*}/g,(t=>{const n=t.slice(1,-1),a=r.get(n);if(!a)return t;let l=null;if("attributes"in e){e&&e.attributes&&(l=e.attributes[a.name])}else l=e.field(a.name);return null==l?"":m(l,a)}))};if(l){let e;try{e=u.WhereClause.create(l,r)}catch(g){return p}const t=f.evaluate;f.evaluate=r=>{const n="attributes"in r?void 0:d;return e.testFeature(r,n)?t(r):null}}return f}))).apply(this,arguments)}function m(e,t){if(null==e)return"";const r=t.domain;if(r)if("codedValue"===r.type||"coded-value"===r.type){const t=e;for(const e of r.codedValues)if(e.code===t)return e.name}else if("range"===r.type){const t=+e,n="range"in r?r.range[0]:r.minValue,a="range"in r?r.range[1]:r.maxValue;if(n<=t&&t<=a)return r.name}let n=e;return"date"===t.type||"esriFieldTypeDate"===t.type?n=l.formatDate(n,l.convertDateFormatToIntlOptions("short-date")):u.isNumericField(t)&&(n=i.formatNumber(+n)),n||""}t.createLabelFunction=f,t.formatField=m,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
