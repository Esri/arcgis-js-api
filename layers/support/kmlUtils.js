/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/lang","../../config","../../core/urlUtils","../../geometry/SpatialReference","../../geometry/support/boundsUtils","../../PopupTemplate","../../kernel","../../request","../../renderers/support/jsonUtils","../../tasks/support/FeatureSet","../../geometry/support/aaBoundingBox"],(function(e,t,o,r,n,s,i,a,l,u,f,p){"use strict";const y={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function c(e){const o=e.folders||[],r=o.slice(),n=new Map,s=new Map,i=new Map,a=new Map,l=new Map,u={esriGeometryPoint:s,esriGeometryPolyline:i,esriGeometryPolygon:a};(e.featureCollection&&e.featureCollection.layers||[]).forEach((e=>{const o=t.clone(e);o.featureSet.features=[];const r=e.featureSet.geometryType;n.set(r,o);const l=e.layerDefinition.objectIdField;"esriGeometryPoint"===r?g(s,l,e.featureSet.features):"esriGeometryPolyline"===r?g(i,l,e.featureSet.features):"esriGeometryPolygon"===r&&g(a,l,e.featureSet.features)})),e.groundOverlays&&e.groundOverlays.forEach((e=>{l.set(e.id,e)})),o.forEach((t=>{t.networkLinkIds.forEach((o=>{const n=h(o,t.id,e.networkLinks);n&&r.push(n)}))})),r.forEach((e=>{e.featureInfos&&(e.points=t.clone(n.get("esriGeometryPoint")),e.polylines=t.clone(n.get("esriGeometryPolyline")),e.polygons=t.clone(n.get("esriGeometryPolygon")),e.mapImages=[],e.featureInfos.map((t=>{switch(t.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const o=u[t.type].get(t.id);o&&e[y[t.type]].featureSet.features.push(o);break}case"GroundOverlay":{const o=l.get(t.id);o&&e.mapImages.push(o);break}}})),e.fullExtent=G([e]))}));const f=G(r);return{folders:o,sublayers:r,extent:f}}function d(e,t,n,s){const i=a.id&&a.id.findCredential(e);e=r.addQueryParameters(e,{token:i&&i.token});const u=o.kmlServiceUrl;return l(u,{query:{url:e,model:"simple",folders:"",refresh:0!==n||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:s})}function m(e,t,o=null,r=[]){const n=[],s={},i=t.sublayers,a=t.folders.map((e=>e.id));return i.forEach((t=>{const i=new e;if(o?i.read(t,o):i.read(t),r.length&&a.indexOf(i.id)>-1&&(i.visible=-1!==r.indexOf(i.id)),s[t.id]=i,null!=t.parentFolderId&&-1!==t.parentFolderId){const e=s[t.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers.unshift(i)}else n.unshift(i)})),n}function g(e,t,o){o.forEach((o=>{e.set(o.attributes[t],o)}))}function S(e,t){let o;return t.some((t=>t.id===e&&(o=t,!0))),o}function h(e,t,o){const r=S(e,o);return r&&(r.parentFolderId=t,r.networkLink=r),r}async function I(e){const t=f.fromJSON(e.featureSet).features,o=e.layerDefinition,r=u.fromJSON(o.drawingInfo.renderer),n=i.fromJSON(e.popupInfo),s=[];for(const i of t){const e=await r.getSymbolAsync(i);i.symbol=e,i.popupTemplate=n,i.visible=!0,s.push(i)}return s}function G(e){const t=p.create(),o=p.create(p.NEGATIVE_INFINITY);for(const r of e){if(r.polygons&&r.polygons.featureSet&&r.polygons.featureSet.features)for(const e of r.polygons.featureSet.features)s.getBoundsXYZ(t,e.geometry),p.expandWithAABB(o,t);if(r.polylines&&r.polylines.featureSet&&r.polylines.featureSet.features)for(const e of r.polylines.featureSet.features)s.getBoundsXYZ(t,e.geometry),p.expandWithAABB(o,t);if(r.points&&r.points.featureSet&&r.points.featureSet.features)for(const e of r.points.featureSet.features)s.getBoundsXYZ(t,e.geometry),p.expandWithAABB(o,t);if(r.mapImages)for(const e of r.mapImages)s.getBoundsXYZ(t,e.extent),p.expandWithAABB(o,t)}return p.equals(o,p.NEGATIVE_INFINITY)?null:{xmin:o[0],ymin:o[1],zmin:o[2],xmax:o[3],ymax:o[4],zmax:o[5],spatialReference:n.WGS84}}e.computeExtent=G,e.fetchService=d,e.getGraphics=I,e.parseKML=c,e.sublayersFromJSON=m,Object.defineProperty(e,"__esModule",{value:!0})}));
