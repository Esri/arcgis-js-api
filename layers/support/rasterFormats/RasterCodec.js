/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","../../../chunks/TiffDecoder","../../../chunks/LercCodec","./Lzw","../../../chunks/Zlib","./Raw","./utils"],(function(t,e,i,a,r,n,s,o,h,l,d,c){"use strict";var p=function(t){var e,i,a,r,n,s;function o(t){var e,i,a,r,n,s,o,h,l,d,c,p,u;for(this.data=t,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},n=null;;){switch(e=this.readUInt32(),h=function(){var t,e;for(e=[],t=0;t<4;++t)e.push(String.fromCharCode(this.data[this.pos++]));return e}.call(this).join(""),h){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(e);break;case"fcTL":n&&this.animation.frames.push(n),this.pos+=4,n={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},r=this.readUInt16(),a=this.readUInt16()||100,n.delay=1e3*r/a,n.disposeOp=this.data[this.pos++],n.blendOp=this.data[this.pos++],n.data=[];break;case"IDAT":case"fdAT":for("fdAT"===h&&(this.pos+=4,e-=4),t=(null!=n?n.data:void 0)||this.imgData,c=0;0<=e?c<e:c>e;0<=e?++c:--c)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(e),(l=255-this.transparency.indexed.length)>0)for(p=0;0<=l?p<l:p>l;0<=l?++p:--p)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(e)[0];break;case 2:this.transparency.rgb=this.read(e)}break;case"tEXt":s=(d=this.read(e)).indexOf(0),o=String.fromCharCode.apply(String,d.slice(0,s)),this.text[o]=String.fromCharCode.apply(String,d.slice(s+1));break;case"IEND":return n&&this.animation.frames.push(n),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(u=this.colorType)||6===u,i=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*i,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=e}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return o.load=function(t,e,i){var a;return"function"==typeof e&&(i=e),(a=new XMLHttpRequest).open("GET",t,!0),a.responseType="arraybuffer",a.onload=function(){var t;return t=new o(new Uint8Array(a.response||a.mozResponseArrayBuffer)),"function"==typeof(null!=e?e.getContext:void 0)&&t.render(e),"function"==typeof i?i(t):void 0},a.send(null)},i=1,a=2,e=0,o.prototype.read=function(t){var e,i;for(i=[],e=0;0<=t?e<t:e>t;0<=t?++e:--e)i.push(this.data[this.pos++]);return i},o.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.decodePixels=function(t){var e,i,a,r,n,s,o,h,d,c,p,u,f,g,m,w,y,x,b,k,C,D,T;if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);for(t=(t=new l.Zlib(t)).getBytes(),w=(u=this.pixelBitlength/8)*this.width,f=new Uint8Array(w*this.height),s=t.length,m=0,g=0,i=0;g<s;){switch(t[g++]){case 0:for(r=b=0;b<w;r=b+=1)f[i++]=t[g++];break;case 1:for(r=k=0;k<w;r=k+=1)e=t[g++],n=r<u?0:f[i-u],f[i++]=(e+n)%256;break;case 2:for(r=C=0;C<w;r=C+=1)e=t[g++],a=(r-r%u)/u,y=m&&f[(m-1)*w+a*u+r%u],f[i++]=(y+e)%256;break;case 3:for(r=D=0;D<w;r=D+=1)e=t[g++],a=(r-r%u)/u,n=r<u?0:f[i-u],y=m&&f[(m-1)*w+a*u+r%u],f[i++]=(e+Math.floor((n+y)/2))%256;break;case 4:for(r=T=0;T<w;r=T+=1)e=t[g++],a=(r-r%u)/u,n=r<u?0:f[i-u],0===m?y=x=0:(y=f[(m-1)*w+a*u+r%u],x=a&&f[(m-1)*w+(a-1)*u+r%u]),o=n+y-x,h=Math.abs(o-n),c=Math.abs(o-y),p=Math.abs(o-x),d=h<=c&&h<=p?n:c<=p?y:x,f[i++]=(e+d)%256;break;default:throw new Error("Invalid filter algorithm: "+t[g-1])}m++}return f},o.prototype.decodePalette=function(){var t,e,i,a,r,n,s,o,h;for(i=this.palette,n=this.transparency.indexed||[],r=new Uint8Array((n.length||0)+i.length),a=0,t=0,e=s=0,o=i.length;s<o;e=s+=3)r[a++]=i[e],r[a++]=i[e+1],r[a++]=i[e+2],r[a++]=null!=(h=n[t++])?h:255;return r},o.prototype.copyToImageData=function(t,e){var i,a,r,n,s,o,h,l,d,c,p;if(a=this.colors,d=null,i=this.hasAlphaChannel,this.palette.length&&(d=null!=(p=this._decodedPalette)?p:this._decodedPalette=this.decodePalette(),a=4,i=!0),l=(r=t.data||t).length,s=d||e,n=o=0,1===a)for(;n<l;)h=d?4*e[n/4]:o,c=s[h++],r[n++]=c,r[n++]=c,r[n++]=c,r[n++]=i?s[h++]:this.transparency.grayscale&&this.transparency.grayscale===c?0:255,o=h;else for(;n<l;)h=d?4*e[n/4]:o,r[n++]=s[h++],r[n++]=s[h++],r[n++]=s[h++],r[n++]=i?s[h++]:this.transparency.rgb&&this.transparency.rgb[1]===s[h-3]&&this.transparency.rgb[3]===s[h-2]&&this.transparency.rgb[5]===s[h-1]?0:255,o=h},o.prototype.decode=function(){var t;return t=new Uint8Array(this.width*this.height*4),this.copyToImageData(t,this.decodePixels()),t},n=t.document&&t.document.createElement("canvas"),s=n&&n.getContext("2d"),r=function(t){var e;return s.width=t.width,s.height=t.height,s.clearRect(0,0,t.width,t.height),s.putImageData(t,0,0),(e=new Image).src=n.toDataURL(),e},o.prototype.decodeFrames=function(t){var e,i,a,n,s,o,h,l;if(this.animation){for(l=[],i=s=0,o=(h=this.animation.frames).length;s<o;i=++s)e=h[i],a=t.createImageData(e.width,e.height),n=this.decodePixels(new Uint8Array(e.data)),this.copyToImageData(a,n),e.imageData=a,l.push(e.image=r(a));return l}},o.prototype.renderFrame=function(t,r){var n,s,o;return n=(s=this.animation.frames)[r],o=s[r-1],0===r&&t.clearRect(0,0,this.width,this.height),(null!=o?o.disposeOp:void 0)===i?t.clearRect(o.xOffset,o.yOffset,o.width,o.height):(null!=o?o.disposeOp:void 0)===a&&t.putImageData(o.imageData,o.xOffset,o.yOffset),n.blendOp===e&&t.clearRect(n.xOffset,n.yOffset,n.width,n.height),t.drawImage(n.image,n.xOffset,n.yOffset)},o.prototype.animate=function(t){var e,i,a,r,n,s,o=this;return i=0,s=this.animation,r=s.numFrames,a=s.frames,n=s.numPlays,(e=function(){var s,h;if(s=i++%r,h=a[s],o.renderFrame(t,s),r>1&&i/r<n)return o.animation._timeout=setTimeout(e,h.delay)})()},o.prototype.stopAnimation=function(){var t;return clearTimeout(null!=(t=this.animation)?t._timeout:void 0)},o.prototype.render=function(t){var e,i;return t._png&&t._png.stopAnimation(),t._png=this,t.width=this.width,t.height=this.height,e=t.getContext("2d"),this.animation?(this.decodeFrames(e),this.animate(e)):(i=e.createImageData(this.width,this.height),this.copyToImageData(i,this.decodePixels()),e.putImageData(i,0,0))},o}(self);const u=new Set(["jpg","png","bmp","gif"]);function f(t,e){if(!c.isPlatformLittleEndian)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");const{width:r,height:n,pixelType:s}=e,h=A(s),l=h.pixelTypeCtor,d=null==e.noDataValue?h.noDataValue:e.noDataValue;let p,u,f=0,g=0;const m=t.byteLength-10;for(;g<m;){const e=o.decode(t,{inputOffset:g,encodedMaskData:p,returnMask:0===f,returnEncodedMask:0===f,returnFileInfo:!0,pixelType:l,noDataValue:d});if(r&&n&&(e.width!==r||e.height!==n))throw new i("rasterCoded:decode","lerc decoded result has width or height different from specified in options");if(g=e.fileInfo.eofOffset,0===f&&(p=e.encodedMaskData,u=new a({width:e.width,height:e.height,pixels:[],pixelType:s,mask:e.maskData,statistics:[]})),f++,u.addData({pixels:e.pixelData,statistics:{minValue:e.minValue,maxValue:e.maxValue,noDataValue:e.noDataValue}}),m-g>10){const e=String.fromCharCode.apply(null,new Uint8Array(t,g,10));g+=e.indexOf("CntZ")>-1?e.indexOf("CntZ"):0}}return u}function g(t,e){if(!c.isPlatformLittleEndian)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");let r,n,o,h=0,l=e.offset||0,d=0;const p=e.eof||t.byteLength-10,u=[],{width:f,height:g}=e;let m=0;for(;l<p;){var w;if(n=s.Lerc2Codec.decode(t,{inputOffset:l,maskData:r,returnFileInfo:!0}),f&&g&&(n.width!==f||n.height!==g))throw new i("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");if(l=n.fileInfo.eofOffset,r=n.maskData,0===h&&(d=n.fileInfo.numValidPixel,o=new a({width:n.width,height:n.height,pixels:[],pixelType:n.fileInfo.pixelType,mask:r,statistics:[]})),n.fileInfo.mask&&n.fileInfo.mask.numBytes>0&&m++,r&&u.push(r),n.dimCount>1&&(null==(w=n.pixelData)?void 0:w.length)===n.width*n.height*n.dimCount){var y,x,b,k;n.pixelData=n.pixelData.slice(-n.width*n.height);const t=null==(y=n.dimStats)||null==(x=y.minValues)?void 0:x[n.dimCount-1],e=null==(b=n.dimStats)||null==(k=b.maxValues)?void 0:k[n.dimCount-1];null!=t&&null!=e&&(n.minValue=t,n.maxValue=e)}if(h++,o.addData({pixels:n.pixelData,statistics:{minValue:n.minValue,maxValue:n.maxValue}}),p-l>10){const e=String.fromCharCode.apply(null,new Uint8Array(t,l,10));l+=e.indexOf("Lerc")>-1?e.indexOf("Lerc"):0}}let C=0,D=0,T=0;if(m>1){for(T=o.width*o.height,r=new Uint8Array(T),r.set(u[0]),C=1;C<u.length;C++){const t=u[C];for(D=0;D<T;D++)r[D]=r[D]&t[D]}for(d=0,D=0;D<T;D++)d+=r[D];o.mask=r}return o.validPixelCount=d,o}function m(t,e){const i=s.decode(t,e.pyramidLevel||0),r=new a({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return r.updateStatistics(),r}function w(t,e){const i=s.decodeTileOrStrip(t,e.customOptions),r=new a({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return r.updateStatistics(),r}function y(t,e){const i=e.pixelType||"u8",r=a.getPixelArrayConstructor(i),n="u8"===i?t:new r(t.buffer),s=[],o=e.planes||1;if(1===o)s.push(n);else for(let a=0;a<o;a++){const i=(e.width||1)*(e.height||t.length),h=new r(i);for(let t=0;t<i;t++)h[t]=n[t*o+a];s.push(h)}const h=new a({width:e.width||1,height:e.height||t.length,pixels:s,pixelType:i,statistics:null});return h.updateStatistics(),h}function x(t,e){return y(new l.Zlib(new Uint8Array(t)).getBytes(),e)}function b(t,e){return y(h.decode(t,e.offset,e.eof,!e.isInputBigEndian),e)}function k(t,e,i){const{pixelTypeCtor:r}=A(e.pixelType),n=(0,d.decode)(t,{width:e.width,height:e.height,pixelType:r,format:i}),s=new a({width:e.width,height:e.height,pixels:n.pixels,pixelType:e.pixelType,mask:n.mask,statistics:null});return s.updateStatistics(),s}function C(t){const e=n.decode(t),i=new a({width:e.width,height:e.height,pixels:e.pixels,pixelType:"U8",mask:e.mask,statistics:null});return i.updateStatistics(),i}function D(t,e){const i=new Uint8Array(t),r=new p(i),{width:n,height:s}=e,o=n*s,h=r.decode();let l,d=0,c=0;const u=new Uint8Array(o);for(d=0;d<o;d++)u[d]=h[4*d+3];const f=new a({width:n,height:s,pixels:[],pixelType:"U8",mask:u,statistics:[]});for(d=0;d<3;d++){for(l=new Uint8Array(o),c=0;c<o;c++)l[c]=h[4*c+d];f.addData({pixels:l})}return f.updateStatistics(),f}function T(t,e,i,a){return I.apply(this,arguments)}function I(){return(I=e._asyncToGenerator((function*(t,e,i,n){const s=new r,o={applyJpegMask:!1,format:e,...i},h=yield s.decode(t,o,n),l=new a(h);return l.updateStatistics(),l}))).apply(this,arguments)}function v(t){if(null==t)throw new i("rasterCodec:decode","parameter encodeddata is required.");const e=new Uint8Array(t,0,10);let a="";return 255===e[0]&&216===e[1]?a="jpg":137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]?a="png":67===e[0]&&110===e[1]&&116===e[2]&&90===e[3]&&73===e[4]&&109===e[5]&&97===e[6]&&103===e[7]&&101===e[8]&&32===e[9]?a="lerc":76===e[0]&&101===e[1]&&114===e[2]&&99===e[3]&&50===e[4]&&32===e[5]?a="lerc2":73===e[0]&&73===e[1]&&42===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&42===e[3]||73===e[0]&&73===e[1]&&43===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&43===e[3]?a="tiff":71===e[0]&&73===e[1]&&70===e[2]?a="gif":66===e[0]&&77===e[1]?a="bmp":String.fromCharCode.apply(null,e).toLowerCase().indexOf("error")>-1&&(a="error"),a}function U(t){let e=null;switch(t){case"lerc":e=f;break;case"lerc2":e=g;break;case"jpg":e=C;break;case"png":e=D;break;case"bsq":case"bip":e=(e,i)=>k(e,i,t);break;case"tiff":e=m;break;case"deflate":e=x;break;case"lzw":e=b;break;case"error":e=()=>{throw new i("rasterCodec:decode","input data contains error")};break;default:e=()=>{throw new i("rasterCodec:decode","unsupported raster format")}}return e}function A(t){let e=null,i=null;switch(t?t.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":i=255,e=Uint8Array;break;case"u16":i=i||65535,e=Uint16Array;break;case"u32":i=i||2**32-1,e=Uint32Array;break;case"s8":i=i||-128,e=Int8Array;break;case"s16":i=i||-32768,e=Int16Array;break;case"s32":i=i||0-2**31,e=Int32Array;break;default:e=Float32Array}return{pixelTypeCtor:e,noDataValue:i}}function O(t,e=1){if(!t)return;const{pixels:i,width:r,height:n,mask:s}=t;if(!i||0===i.length)return;const o=i.length,h=r-1,l=n-1,d=[];let c,p,u,f,g,m,w;const y=a.getPixelArrayConstructor(t.pixelType);if(0===e){for(c=0;c<o;c++){for(g=i[c],m=new y(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)m[p*h+u]=g[f+u];d.push(m)}if(s)for(w=new Uint8Array(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)w[p*h+u]=s[f+u]}else{for(c=0;c<o;c++){for(g=i[c],m=new y(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)m[p*h+u]=(g[f+u]+g[f+u+1]+g[f+r+u]+g[f+r+u+1])/4;d.push(m)}if(s)for(w=new Uint8Array(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)w[p*h+u]=Math.min.apply(null,[s[f+u],s[f+u+1],s[f+r+u],s[f+r+u+1]])}t.width=h,t.height=l,t.mask=w,t.pixels=d}function P(t){let e=v(t);return"lerc2"===e?e="lerc":"error"===e&&(e=""),e}function L(t){return S.apply(this,arguments)}function S(){return(S=e._asyncToGenerator((function*(t,e={},a){if(null==t)throw new i("rasterCodec:decode","missing encodeddata parameter.");let r,n,s=e.format&&e.format.toLowerCase();if(!("bsq"!==s&&"bip"!==s||null!=e.width&&null!=e.height))throw new i("rasterCodec:decode","requires width and height in options parameter.");return"tiff"===s&&e.customOptions?w(t,e):((!s||"bsq"!==s&&"bip"!==s&&"deflate"!==s&&"lzw"!==s)&&(s=v(t)),e.useCanvas&&u.has(s)?n=yield T(t,s,e,a):(r=U(s),e.isPoint&&((e={...e}).width++,e.height++),n=r(t,e),e.isPoint&&O(n)),n)}))).apply(this,arguments)}t.decode=L,t.decodeLerc2=g,t.getFormat=P,Object.defineProperty(t,"__esModule",{value:!0})}));
