/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/maybe","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","./Lerc","./Lzw","./pixelRangeUtils","../../../chunks/Zlib","./Raw","./TiffDecoder","./utils"],(function(t,e,i,a,r,s,n,o,h,c,l,p,d,u){"use strict";var f=function(t){var e,i,a,r,s,n;function o(t){var e,i,a,r,s,n,o,h,c,l,p,d,u;for(this.data=t,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},s=null;;){switch(e=this.readUInt32(),h=function(){var t,e;for(e=[],t=0;t<4;++t)e.push(String.fromCharCode(this.data[this.pos++]));return e}.call(this).join(""),h){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(e);break;case"fcTL":s&&this.animation.frames.push(s),this.pos+=4,s={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},r=this.readUInt16(),a=this.readUInt16()||100,s.delay=1e3*r/a,s.disposeOp=this.data[this.pos++],s.blendOp=this.data[this.pos++],s.data=[];break;case"IDAT":case"fdAT":for("fdAT"===h&&(this.pos+=4,e-=4),t=(null!=s?s.data:void 0)||this.imgData,p=0;0<=e?p<e:p>e;0<=e?++p:--p)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(e),(c=255-this.transparency.indexed.length)>0)for(d=0;0<=c?d<c:d>c;0<=c?++d:--d)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(e)[0];break;case 2:this.transparency.rgb=this.read(e)}break;case"tEXt":n=(l=this.read(e)).indexOf(0),o=String.fromCharCode.apply(String,l.slice(0,n)),this.text[o]=String.fromCharCode.apply(String,l.slice(n+1));break;case"IEND":return s&&this.animation.frames.push(s),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(u=this.colorType)||6===u,i=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*i,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=e}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return o.load=function(t,e,i){var a;return"function"==typeof e&&(i=e),(a=new XMLHttpRequest).open("GET",t,!0),a.responseType="arraybuffer",a.onload=function(){var t;return t=new o(new Uint8Array(a.response||a.mozResponseArrayBuffer)),"function"==typeof(null!=e?e.getContext:void 0)&&t.render(e),"function"==typeof i?i(t):void 0},a.send(null)},i=1,a=2,e=0,o.prototype.read=function(t){var e,i;for(i=[],e=0;0<=t?e<t:e>t;0<=t?++e:--e)i.push(this.data[this.pos++]);return i},o.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.decodePixels=function(t){var e,i,a,r,s,n,o,h,c,p,d,u,f,y,g,w,m,b,x,k,T,I,v;if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);for(t=(t=new l.Zlib(t)).getBytes(),w=(u=this.pixelBitlength/8)*this.width,f=new Uint8Array(w*this.height),n=t.length,g=0,y=0,i=0;y<n;){switch(t[y++]){case 0:for(r=x=0;x<w;r=x+=1)f[i++]=t[y++];break;case 1:for(r=k=0;k<w;r=k+=1)e=t[y++],s=r<u?0:f[i-u],f[i++]=(e+s)%256;break;case 2:for(r=T=0;T<w;r=T+=1)e=t[y++],a=(r-r%u)/u,m=g&&f[(g-1)*w+a*u+r%u],f[i++]=(m+e)%256;break;case 3:for(r=I=0;I<w;r=I+=1)e=t[y++],a=(r-r%u)/u,s=r<u?0:f[i-u],m=g&&f[(g-1)*w+a*u+r%u],f[i++]=(e+Math.floor((s+m)/2))%256;break;case 4:for(r=v=0;v<w;r=v+=1)e=t[y++],a=(r-r%u)/u,s=r<u?0:f[i-u],0===g?m=b=0:(m=f[(g-1)*w+a*u+r%u],b=a&&f[(g-1)*w+(a-1)*u+r%u]),o=s+m-b,h=Math.abs(o-s),p=Math.abs(o-m),d=Math.abs(o-b),c=h<=p&&h<=d?s:p<=d?m:b,f[i++]=(e+c)%256;break;default:throw new Error("Invalid filter algorithm: "+t[y-1])}g++}return f},o.prototype.decodePalette=function(){var t,e,i,a,r,s,n,o,h;for(i=this.palette,s=this.transparency.indexed||[],r=new Uint8Array((s.length||0)+i.length),a=0,i.length,t=0,e=n=0,o=i.length;n<o;e=n+=3)r[a++]=i[e],r[a++]=i[e+1],r[a++]=i[e+2],r[a++]=null!=(h=s[t++])?h:255;return r},o.prototype.copyToImageData=function(t,e){var i,a,r,s,n,o,h,c,l,p,d;if(a=this.colors,l=null,i=this.hasAlphaChannel,this.palette.length&&(l=null!=(d=this._decodedPalette)?d:this._decodedPalette=this.decodePalette(),a=4,i=!0),c=(r=t.data||t).length,n=l||e,s=o=0,1===a)for(;s<c;)h=l?4*e[s/4]:o,p=n[h++],r[s++]=p,r[s++]=p,r[s++]=p,r[s++]=i?n[h++]:this.transparency.grayscale&&this.transparency.grayscale===p?0:255,o=h;else for(;s<c;)h=l?4*e[s/4]:o,r[s++]=n[h++],r[s++]=n[h++],r[s++]=n[h++],r[s++]=i?n[h++]:this.transparency.rgb&&this.transparency.rgb[1]===n[h-3]&&this.transparency.rgb[3]===n[h-2]&&this.transparency.rgb[5]===n[h-1]?0:255,o=h},o.prototype.decode=function(){var t;return t=new Uint8Array(this.width*this.height*4),this.copyToImageData(t,this.decodePixels()),t},s=t.document&&t.document.createElement("canvas"),n=s&&s.getContext("2d"),r=function(t){var e;return n.width=t.width,n.height=t.height,n.clearRect(0,0,t.width,t.height),n.putImageData(t,0,0),(e=new Image).src=s.toDataURL(),e},o.prototype.decodeFrames=function(t){var e,i,a,s,n,o,h,c;if(this.animation){for(c=[],i=n=0,o=(h=this.animation.frames).length;n<o;i=++n)e=h[i],a=t.createImageData(e.width,e.height),s=this.decodePixels(new Uint8Array(e.data)),this.copyToImageData(a,s),e.imageData=a,c.push(e.image=r(a));return c}},o.prototype.renderFrame=function(t,r){var s,n,o;return s=(n=this.animation.frames)[r],o=n[r-1],0===r&&t.clearRect(0,0,this.width,this.height),(null!=o?o.disposeOp:void 0)===i?t.clearRect(o.xOffset,o.yOffset,o.width,o.height):(null!=o?o.disposeOp:void 0)===a&&t.putImageData(o.imageData,o.xOffset,o.yOffset),s.blendOp===e&&t.clearRect(s.xOffset,s.yOffset,s.width,s.height),t.drawImage(s.image,s.xOffset,s.yOffset)},o.prototype.animate=function(t){var e,i,a,r,s,n,o=this;return i=0,n=this.animation,r=n.numFrames,a=n.frames,s=n.numPlays,(e=function(){var n,h;if(n=i++%r,h=a[n],o.renderFrame(t,n),r>1&&i/r<s)return o.animation._timeout=setTimeout(e,h.delay)})()},o.prototype.stopAnimation=function(){var t;return clearTimeout(null!=(t=this.animation)?t._timeout:void 0)},o.prototype.render=function(t){var e,i;return t._png&&t._png.stopAnimation(),t._png=this,t.width=this.width,t.height=this.height,e=t.getContext("2d"),this.animation?(this.decodeFrames(e),this.animate(e)):(i=e.createImageData(this.width,this.height),this.copyToImageData(i,this.decodePixels()),e.putImageData(i,0,0))},o}(self);const y=new Set(["jpg","png","bmp","gif"]);function g(t,e){return w.apply(this,arguments)}function w(){return(w=e._asyncToGenerator((function*(t,e){if(!u.isPlatformLittleEndian)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");yield o.load();const{offset:a}=e,{width:s,height:n,pixelType:h,statistics:c,depthCount:l,noDataValues:p,bandMasks:d,pixels:f,mask:y}=o.decode(t,{inputOffset:a,returnInterleaved:e.returnInterleaved});return new r({width:s,height:n,pixelType:h.toLowerCase(),pixels:f,mask:y,statistics:c,bandMasks:d,depthCount:l,noDataValues:p})}))).apply(this,arguments)}function m(t,e){return b.apply(this,arguments)}function b(){return(b=e._asyncToGenerator((function*(t,e){const i=yield d.decode(t,{...e,noDataValue:null});a.assertIsSome(i);const s=new r({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return s.updateStatistics(),s}))).apply(this,arguments)}function x(t,e){return k.apply(this,arguments)}function k(){return(k=e._asyncToGenerator((function*(t,e){const i=yield d.decodeTileOrStrip(t,e.customOptions),a=new r({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return a.updateStatistics(),a}))).apply(this,arguments)}function T(t,e){const i=e.pixelType||"u8",a=r.getPixelArrayConstructor(i),s="u8"===i?t:new a(t.buffer),n=[],o=e.planes||1;if(1===o)n.push(s);else for(let r=0;r<o;r++){const i=(e.width||1)*(e.height||t.length),h=new a(i);for(let t=0;t<i;t++)h[t]=s[t*o+r];n.push(h)}const h=new r({width:e.width||1,height:e.height||t.length,pixels:n,pixelType:i,statistics:null});return h.updateStatistics(),h}function I(t,e){return T(new l.Zlib(new Uint8Array(t)).getBytes(),e)}function v(t,e){return T(h.decode(t,e.offset,e.eof,!e.isInputBigEndian),e)}function C(t,e,i){const{pixelTypeCtor:a}=M(e.pixelType),s=(0,p.decode)(t,{width:e.width,height:e.height,pixelType:a,format:i}),n=new r({width:e.width,height:e.height,pixels:s.pixels,pixelType:e.pixelType,mask:s.mask,statistics:null});return n.updateStatistics(),n}function U(t,e){const i=n.decode(t,e.hasNoZlibMask??void 0),a=new r({width:i.width,height:i.height,pixels:i.pixels,pixelType:"U8",mask:i.mask,statistics:null});return a.updateStatistics(),a}function A(t,e){const i=new Uint8Array(t),a=new f(i),{width:s,height:n}=e,o=s*n,h=a.decode();let c,l=0,p=0;const d=new Uint8Array(o);for(l=0;l<o;l++)d[l]=h[4*l+3];const u=new r({width:s,height:n,pixels:[],pixelType:"U8",mask:d,statistics:[]});for(l=0;l<3;l++){for(c=new Uint8Array(o),p=0;p<o;p++)c[p]=h[4*p+l];u.addData({pixels:c})}return u.updateStatistics(),u}function D(t,e,i,a){return O.apply(this,arguments)}function O(){return(O=e._asyncToGenerator((function*(t,e,i,a){const n=new s,o={applyJpegMask:!1,format:e,...i},h=yield n.decode(t,o,a),c=new r(h);return c.updateStatistics(),c}))).apply(this,arguments)}function P(t){if(null==t)throw new i("rasterCodec:decode","parameter encodeddata is required.");const e=new Uint8Array(t,0,10);let a="";return 255===e[0]&&216===e[1]?a="jpg":137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]?a="png":67===e[0]&&110===e[1]&&116===e[2]&&90===e[3]&&73===e[4]&&109===e[5]&&97===e[6]&&103===e[7]&&101===e[8]&&32===e[9]?a="lerc":76===e[0]&&101===e[1]&&114===e[2]&&99===e[3]&&50===e[4]&&32===e[5]?a="lerc2":73===e[0]&&73===e[1]&&42===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&42===e[3]||73===e[0]&&73===e[1]&&43===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&43===e[3]?a="tiff":71===e[0]&&73===e[1]&&70===e[2]?a="gif":66===e[0]&&77===e[1]?a="bmp":String.fromCharCode.apply(null,e).toLowerCase().includes("error")&&(a="error"),a}function S(t){let e=null;switch(t){case"lerc":case"lerc2":e=g;break;case"jpg":e=U;break;case"png":e=A;break;case"bsq":case"bip":e=(e,i)=>C(e,i,t);break;case"tiff":e=m;break;case"deflate":e=I;break;case"lzw":e=v;break;case"error":e=()=>{throw new i("rasterCodec:decode","input data contains error")};break;default:e=()=>{throw new i("rasterCodec:decode","unsupported raster format")}}return e}function M(t){let e=null,i=null;switch(t?t.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":i=255,e=Uint8Array;break;case"u16":i=i||65535,e=Uint16Array;break;case"u32":i=i||2**32-1,e=Uint32Array;break;case"s8":i=i||-128,e=Int8Array;break;case"s16":i=i||-32768,e=Int16Array;break;case"s32":i=i||0-2**31,e=Int32Array;break;default:e=Float32Array}return{pixelTypeCtor:e,noDataValue:i}}function L(t,e=1){if(!t)return;const{pixels:i,width:s,height:n,mask:o}=t;if(!i||0===i.length)return;const h=i.length,c=s-1,l=n-1,p=[];let d,u,f,y,g,w,m=null;const b=r.getPixelArrayConstructor(t.pixelType);if(0===e){for(d=0;d<h;d++){for(g=i[d],w=new b(c*l),u=0;u<l;u++)for(y=u*s,f=0;f<c;f++)w[u*c+f]=g[y+f];p.push(w)}if(a.isSome(o))for(m=new Uint8Array(c*l),u=0;u<l;u++)for(y=u*s,f=0;f<c;f++)m[u*c+f]=o[y+f]}else{for(d=0;d<h;d++){for(g=i[d],w=new b(c*l),u=0;u<l;u++)for(y=u*s,f=0;f<c;f++)w[u*c+f]=(g[y+f]+g[y+f+1]+g[y+s+f]+g[y+s+f+1])/4;p.push(w)}if(o)for(m=new Uint8Array(c*l),u=0;u<l;u++)for(y=u*s,f=0;f<c;f++)m[u*c+f]=Math.min.apply(null,[o[y+f],o[y+f+1],o[y+s+f],o[y+s+f+1]])}t.width=c,t.height=l,t.mask=m,t.pixels=p}function _(t){let e=P(t);return"lerc2"===e?e="lerc":"error"===e&&(e=""),e}function R(t){return E.apply(this,arguments)}function E(){return(E=e._asyncToGenerator((function*(t,e={},a){if(null==t)throw new i("rasterCodec:decode","missing encodeddata parameter.");let r=e.format&&e.format.toLowerCase();if(!("bsq"!==r&&"bip"!==r||null!=e.width&&null!=e.height))throw new i("rasterCodec:decode","requires width and height in options parameter.");if("tiff"===r&&e.customOptions)return x(t,e);if((!r||"bsq"!==r&&"bip"!==r&&"deflate"!==r&&"lzw"!==r)&&(r=P(t)),e.useCanvas&&y.has(r))return D(t,r,e,a);const s=S(r);e.isPoint&&(null!=(e={...e}).width&&e.width++,null!=e.height&&e.height++);const n=yield s(t,e);return n?("jpg"!==r&&null!=e.noDataValue&&1===n.depthCount&&c.convertNoDataToMask(n,e.noDataValue,{customFloatTolerance:e.tolerance}),e.isPoint&&L(n),n):n}))).apply(this,arguments)}t.decode=R,t.getFormat=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
