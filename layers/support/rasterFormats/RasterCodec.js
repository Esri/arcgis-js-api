/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","../../../chunks/TiffDecoder","../../../chunks/LercCodec","../../../chunks/Zlib","./Raw","./utils"],(function(t,e,i,a,r,s,n,o,h,l,d){"use strict";var c=function(t){var e,i,a,r,s,n;function o(t){var e,i,a,r,s,n,o,h,l,d,c,p,u;for(this.data=t,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},s=null;;){switch(e=this.readUInt32(),h=function(){var t,e;for(e=[],t=0;t<4;++t)e.push(String.fromCharCode(this.data[this.pos++]));return e}.call(this).join("")){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(e);break;case"fcTL":s&&this.animation.frames.push(s),this.pos+=4,s={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},r=this.readUInt16(),a=this.readUInt16()||100,s.delay=1e3*r/a,s.disposeOp=this.data[this.pos++],s.blendOp=this.data[this.pos++],s.data=[];break;case"IDAT":case"fdAT":for("fdAT"===h&&(this.pos+=4,e-=4),t=(null!=s?s.data:void 0)||this.imgData,c=0;0<=e?c<e:c>e;0<=e?++c:--c)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(e),(l=255-this.transparency.indexed.length)>0)for(p=0;0<=l?p<l:p>l;0<=l?++p:--p)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(e)[0];break;case 2:this.transparency.rgb=this.read(e)}break;case"tEXt":n=(d=this.read(e)).indexOf(0),o=String.fromCharCode.apply(String,d.slice(0,n)),this.text[o]=String.fromCharCode.apply(String,d.slice(n+1));break;case"IEND":return s&&this.animation.frames.push(s),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(u=this.colorType)||6===u,i=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*i,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=e}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return o.load=function(t,e,i){var a;return"function"==typeof e&&(i=e),(a=new XMLHttpRequest).open("GET",t,!0),a.responseType="arraybuffer",a.onload=function(){var t;return t=new o(new Uint8Array(a.response||a.mozResponseArrayBuffer)),"function"==typeof(null!=e?e.getContext:void 0)&&t.render(e),"function"==typeof i?i(t):void 0},a.send(null)},i=1,a=2,e=0,o.prototype.read=function(t){var e,i;for(i=[],e=0;0<=t?e<t:e>t;0<=t?++e:--e)i.push(this.data[this.pos++]);return i},o.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.decodePixels=function(t){var e,i,a,r,s,n,o,l,d,c,p,u,f,m,g,y,w,x,b,k,C,D,I;if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);for(t=(t=new h.Zlib(t)).getBytes(),y=(u=this.pixelBitlength/8)*this.width,f=new Uint8Array(y*this.height),n=t.length,g=0,m=0,i=0;m<n;){switch(t[m++]){case 0:for(r=b=0;b<y;r=b+=1)f[i++]=t[m++];break;case 1:for(r=k=0;k<y;r=k+=1)e=t[m++],s=r<u?0:f[i-u],f[i++]=(e+s)%256;break;case 2:for(r=C=0;C<y;r=C+=1)e=t[m++],a=(r-r%u)/u,w=g&&f[(g-1)*y+a*u+r%u],f[i++]=(w+e)%256;break;case 3:for(r=D=0;D<y;r=D+=1)e=t[m++],a=(r-r%u)/u,s=r<u?0:f[i-u],w=g&&f[(g-1)*y+a*u+r%u],f[i++]=(e+Math.floor((s+w)/2))%256;break;case 4:for(r=I=0;I<y;r=I+=1)e=t[m++],a=(r-r%u)/u,s=r<u?0:f[i-u],0===g?w=x=0:(w=f[(g-1)*y+a*u+r%u],x=a&&f[(g-1)*y+(a-1)*u+r%u]),o=s+w-x,l=Math.abs(o-s),c=Math.abs(o-w),p=Math.abs(o-x),d=l<=c&&l<=p?s:c<=p?w:x,f[i++]=(e+d)%256;break;default:throw new Error("Invalid filter algorithm: "+t[m-1])}g++}return f},o.prototype.decodePalette=function(){var t,e,i,a,r,s,n,o,h;for(i=this.palette,s=this.transparency.indexed||[],r=new Uint8Array((s.length||0)+i.length),a=0,i.length,t=0,e=n=0,o=i.length;n<o;e=n+=3)r[a++]=i[e],r[a++]=i[e+1],r[a++]=i[e+2],r[a++]=null!=(h=s[t++])?h:255;return r},o.prototype.copyToImageData=function(t,e){var i,a,r,s,n,o,h,l,d,c,p;if(a=this.colors,d=null,i=this.hasAlphaChannel,this.palette.length&&(d=null!=(p=this._decodedPalette)?p:this._decodedPalette=this.decodePalette(),a=4,i=!0),l=(r=t.data||t).length,n=d||e,s=o=0,1===a)for(;s<l;)h=d?4*e[s/4]:o,c=n[h++],r[s++]=c,r[s++]=c,r[s++]=c,r[s++]=i?n[h++]:this.transparency.grayscale&&this.transparency.grayscale===c?0:255,o=h;else for(;s<l;)h=d?4*e[s/4]:o,r[s++]=n[h++],r[s++]=n[h++],r[s++]=n[h++],r[s++]=i?n[h++]:this.transparency.rgb&&this.transparency.rgb[1]===n[h-3]&&this.transparency.rgb[3]===n[h-2]&&this.transparency.rgb[5]===n[h-1]?0:255,o=h},o.prototype.decode=function(){var t;return t=new Uint8Array(this.width*this.height*4),this.copyToImageData(t,this.decodePixels()),t},s=t.document&&t.document.createElement("canvas"),n=s&&s.getContext("2d"),r=function(t){var e;return n.width=t.width,n.height=t.height,n.clearRect(0,0,t.width,t.height),n.putImageData(t,0,0),(e=new Image).src=s.toDataURL(),e},o.prototype.decodeFrames=function(t){var e,i,a,s,n,o,h,l;if(this.animation){for(l=[],i=n=0,o=(h=this.animation.frames).length;n<o;i=++n)e=h[i],a=t.createImageData(e.width,e.height),s=this.decodePixels(new Uint8Array(e.data)),this.copyToImageData(a,s),e.imageData=a,l.push(e.image=r(a));return l}},o.prototype.renderFrame=function(t,r){var s,n,o;return s=(n=this.animation.frames)[r],o=n[r-1],0===r&&t.clearRect(0,0,this.width,this.height),(null!=o?o.disposeOp:void 0)===i?t.clearRect(o.xOffset,o.yOffset,o.width,o.height):(null!=o?o.disposeOp:void 0)===a&&t.putImageData(o.imageData,o.xOffset,o.yOffset),s.blendOp===e&&t.clearRect(s.xOffset,s.yOffset,s.width,s.height),t.drawImage(s.image,s.xOffset,s.yOffset)},o.prototype.animate=function(t){var e,i,a,r,s,n,o=this;return i=0,n=this.animation,r=n.numFrames,a=n.frames,s=n.numPlays,(e=function(){var n,h;if(n=i++%r,h=a[n],o.renderFrame(t,n),r>1&&i/r<s)return o.animation._timeout=setTimeout(e,h.delay)})()},o.prototype.stopAnimation=function(){var t;return clearTimeout(null!=(t=this.animation)?t._timeout:void 0)},o.prototype.render=function(t){var e,i;return t._png&&t._png.stopAnimation(),t._png=this,t.width=this.width,t.height=this.height,e=t.getContext("2d"),this.animation?(this.decodeFrames(e),this.animate(e)):(i=e.createImageData(this.width,this.height),this.copyToImageData(i,this.decodePixels()),e.putImageData(i,0,0))},o}(self);const p=new Set(["jpg","png","bmp","gif"]);function u(t,e){if(!d.isPlatformLittleEndian)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");const{width:r,height:s,pixelType:n}=e,h=I(n),l=h.pixelTypeCtor,c=null==e.noDataValue?h.noDataValue:e.noDataValue;let p,u,f=0,m=0;const g=t.byteLength-10;for(;m<g;){const e=o.decode(t,{inputOffset:m,encodedMaskData:p,returnMask:0===f,returnEncodedMask:0===f,returnFileInfo:!0,pixelType:l,noDataValue:c});if(r&&s&&(e.width!==r||e.height!==s))throw new i("rasterCoded:decode","lerc decoded result has width or height different from specified in options");if(m=e.fileInfo.eofOffset,0===f&&(p=e.encodedMaskData,u=new a({width:e.width,height:e.height,pixels:[],pixelType:n,mask:e.maskData,statistics:[]})),f++,u.addData({pixels:e.pixelData,statistics:{minValue:e.minValue,maxValue:e.maxValue,noDataValue:e.noDataValue}}),g-m>10){const e=String.fromCharCode.apply(null,new Uint8Array(t,m,10));m+=e.indexOf("CntZ")>-1?e.indexOf("CntZ"):0}}return u}function f(t,e){if(!d.isPlatformLittleEndian)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");let r,s,o,h=0,l=e.offset||0,c=0;const p=e.eof||t.byteLength-10,u=[],{width:f,height:m}=e;let g=0;for(;l<p;){var y;if(s=n.Lerc2Codec.decode(t,{inputOffset:l,maskData:r,returnFileInfo:!0}),f&&m&&(s.width!==f||s.height!==m))throw new i("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");if(l=s.fileInfo.eofOffset,r=s.maskData,0===h&&(c=s.fileInfo.numValidPixel,o=new a({width:s.width,height:s.height,pixels:[],pixelType:s.fileInfo.pixelType,mask:r,statistics:[]})),s.fileInfo.mask&&s.fileInfo.mask.numBytes>0&&g++,r&&u.push(r),s.dimCount>1&&(null==(y=s.pixelData)?void 0:y.length)===s.width*s.height*s.dimCount){var w,x,b,k;s.pixelData=s.pixelData.slice(-s.width*s.height);const t=null==(w=s.dimStats)||null==(x=w.minValues)?void 0:x[s.dimCount-1],e=null==(b=s.dimStats)||null==(k=b.maxValues)?void 0:k[s.dimCount-1];null!=t&&null!=e&&(s.minValue=t,s.maxValue=e)}if(h++,o.addData({pixels:s.pixelData,statistics:{minValue:s.minValue,maxValue:s.maxValue}}),p-l>10){const e=String.fromCharCode.apply(null,new Uint8Array(t,l,10));l+=e.indexOf("Lerc")>-1?e.indexOf("Lerc"):0}}let C=0,D=0,I=0;if(g>1){for(I=o.width*o.height,r=new Uint8Array(I),r.set(u[0]),C=1;C<u.length;C++){const t=u[C];for(D=0;D<I;D++)r[D]=r[D]&t[D]}for(c=0,D=0;D<I;D++)c+=r[D];o.mask=r}return o.validPixelCount=c,o}function m(t,e){const i=n.decode(t,e.pyramidLevel||0),r=new a({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return r.updateStatistics(),r}function g(t,e){const i=n.decodeTileOrStrip(t,e.customOptions),r=new a({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return r.updateStatistics(),r}function y(t,e,i){const{pixelTypeCtor:r}=I(e.pixelType),s=(0,l.decode)(t,{width:e.width,height:e.height,pixelType:r,format:i}),n=new a({width:e.width,height:e.height,pixels:s.pixels,pixelType:e.pixelType,mask:s.mask,statistics:null});return n.updateStatistics(),n}function w(t){const e=s.decode(t),i=new a({width:e.width,height:e.height,pixels:e.pixels,pixelType:"U8",mask:e.mask,statistics:null});return i.updateStatistics(),i}function x(t,e){const i=new Uint8Array(t),r=new c(i),{width:s,height:n}=e,o=s*n,h=r.decode();let l,d=0,p=0;const u=new Uint8Array(o);for(d=0;d<o;d++)u[d]=h[4*d+3];const f=new a({width:s,height:n,pixels:[],pixelType:"U8",mask:u,statistics:[]});for(d=0;d<3;d++){for(l=new Uint8Array(o),p=0;p<o;p++)l[p]=h[4*p+d];f.addData({pixels:l})}return f.updateStatistics(),f}function b(t,e,i,a){return k.apply(this,arguments)}function k(){return(k=e._asyncToGenerator((function*(t,e,i,s){const n=new r,o={applyJpegMask:!1,format:e,...i},h=yield n.decode(t,o,s),l=new a(h);return l.updateStatistics(),l}))).apply(this,arguments)}function C(t){if(null==t)throw new i("rasterCodec:decode","parameter encodeddata is required.");const e=new Uint8Array(t,0,10);let a="";return 255===e[0]&&216===e[1]?a="jpg":137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]?a="png":67===e[0]&&110===e[1]&&116===e[2]&&90===e[3]&&73===e[4]&&109===e[5]&&97===e[6]&&103===e[7]&&101===e[8]&&32===e[9]?a="lerc":76===e[0]&&101===e[1]&&114===e[2]&&99===e[3]&&50===e[4]&&32===e[5]?a="lerc2":73===e[0]&&73===e[1]&&42===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&42===e[3]||73===e[0]&&73===e[1]&&43===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&43===e[3]?a="tiff":71===e[0]&&73===e[1]&&70===e[2]?a="gif":66===e[0]&&77===e[1]?a="bmp":String.fromCharCode.apply(null,e).toLowerCase().indexOf("error")>-1&&(a="error"),a}function D(t){let e=null;switch(t){case"lerc":e=u;break;case"lerc2":e=f;break;case"jpg":e=w;break;case"png":e=x;break;case"bsq":case"bip":e=(e,i)=>y(e,i,t);break;case"tiff":e=m;break;case"error":e=()=>{throw new i("rasterCodec:decode","input data contains error")};break;default:e=()=>{throw new i("rasterCodec:decode","unsupported raster format")}}return e}function I(t){let e=null,i=null;switch(t?t.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":i=255,e=Uint8Array;break;case"u16":i=i||65535,e=Uint16Array;break;case"u32":i=i||2**32-1,e=Uint32Array;break;case"s8":i=i||-128,e=Int8Array;break;case"s16":i=i||-32768,e=Int16Array;break;case"s32":i=i||0-2**31,e=Int32Array;break;default:e=Float32Array}return{pixelTypeCtor:e,noDataValue:i}}function T(t,e=1){if(!t)return;const{pixels:i,width:r,height:s,mask:n}=t;if(!i||0===i.length)return;const o=i.length,h=r-1,l=s-1,d=[];let c,p,u,f,m,g,y;const w=a.getPixelArrayConstructor(t.pixelType);if(0===e){for(c=0;c<o;c++){for(m=i[c],g=new w(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)g[p*h+u]=m[f+u];d.push(g)}if(n)for(y=new Uint8Array(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)y[p*h+u]=n[f+u]}else{for(c=0;c<o;c++){for(m=i[c],g=new w(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)g[p*h+u]=(m[f+u]+m[f+u+1]+m[f+r+u]+m[f+r+u+1])/4;d.push(g)}if(n)for(y=new Uint8Array(h*l),p=0;p<l;p++)for(f=p*r,u=0;u<h;u++)y[p*h+u]=Math.min.apply(null,[n[f+u],n[f+u+1],n[f+r+u],n[f+r+u+1]])}t.width=h,t.height=l,t.mask=y,t.pixels=d}function v(t){let e=C(t);return"lerc2"===e?e="lerc":"error"===e&&(e=""),e}function U(t){return A.apply(this,arguments)}function A(){return(A=e._asyncToGenerator((function*(t,e={},a){if(null==t)throw new i("rasterCodec:decode","missing encodeddata parameter.");let r,s,n=e.format&&e.format.toLowerCase();if(!("bsq"!==n&&"bip"!==n||null!=e.width&&null!=e.height))throw new i("rasterCodec:decode","requires width and height in options parameter.");return"tiff"===n&&e.customOptions?g(t,e):((!n||"bsq"!==n&&"bip"!==n)&&(n=C(t)),e.useCanvas&&p.has(n)?s=yield b(t,n,e,a):(r=D(n),e.isPoint&&((e={...e}).width++,e.height++),s=r(t,e),e.isPoint&&T(s)),s)}))).apply(this,arguments)}t.decode=U,t.decodeLerc2=f,t.getFormat=v,Object.defineProperty(t,"__esModule",{value:!0})}));
