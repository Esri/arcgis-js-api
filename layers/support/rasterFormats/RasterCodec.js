/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","./Lerc","./Lzw","../../../chunks/Zlib","./Raw","./TiffDecoder","./utils"],(function(t,e,i,a,r,s,n,o,h,c,l,p){"use strict";var d=function(t){var e,i,a,r,s,n;function o(t){var e,i,a,r,s,n,o,h,c,l,p,d,u;for(this.data=t,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},s=null;;){switch(e=this.readUInt32(),h=function(){var t,e;for(e=[],t=0;t<4;++t)e.push(String.fromCharCode(this.data[this.pos++]));return e}.call(this).join(""),h){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(e);break;case"fcTL":s&&this.animation.frames.push(s),this.pos+=4,s={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},r=this.readUInt16(),a=this.readUInt16()||100,s.delay=1e3*r/a,s.disposeOp=this.data[this.pos++],s.blendOp=this.data[this.pos++],s.data=[];break;case"IDAT":case"fdAT":for("fdAT"===h&&(this.pos+=4,e-=4),t=(null!=s?s.data:void 0)||this.imgData,p=0;0<=e?p<e:p>e;0<=e?++p:--p)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(e),(c=255-this.transparency.indexed.length)>0)for(d=0;0<=c?d<c:d>c;0<=c?++d:--d)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(e)[0];break;case 2:this.transparency.rgb=this.read(e)}break;case"tEXt":n=(l=this.read(e)).indexOf(0),o=String.fromCharCode.apply(String,l.slice(0,n)),this.text[o]=String.fromCharCode.apply(String,l.slice(n+1));break;case"IEND":return s&&this.animation.frames.push(s),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(u=this.colorType)||6===u,i=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*i,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=e}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return o.load=function(t,e,i){var a;return"function"==typeof e&&(i=e),(a=new XMLHttpRequest).open("GET",t,!0),a.responseType="arraybuffer",a.onload=function(){var t;return t=new o(new Uint8Array(a.response||a.mozResponseArrayBuffer)),"function"==typeof(null!=e?e.getContext:void 0)&&t.render(e),"function"==typeof i?i(t):void 0},a.send(null)},i=1,a=2,e=0,o.prototype.read=function(t){var e,i;for(i=[],e=0;0<=t?e<t:e>t;0<=t?++e:--e)i.push(this.data[this.pos++]);return i},o.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},o.prototype.decodePixels=function(t){var e,i,a,r,s,n,o,c,l,p,d,u,f,y,g,w,m,x,b,k,T,U,v;if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);for(t=(t=new h.Zlib(t)).getBytes(),w=(u=this.pixelBitlength/8)*this.width,f=new Uint8Array(w*this.height),n=t.length,g=0,y=0,i=0;y<n;){switch(t[y++]){case 0:for(r=b=0;b<w;r=b+=1)f[i++]=t[y++];break;case 1:for(r=k=0;k<w;r=k+=1)e=t[y++],s=r<u?0:f[i-u],f[i++]=(e+s)%256;break;case 2:for(r=T=0;T<w;r=T+=1)e=t[y++],a=(r-r%u)/u,m=g&&f[(g-1)*w+a*u+r%u],f[i++]=(m+e)%256;break;case 3:for(r=U=0;U<w;r=U+=1)e=t[y++],a=(r-r%u)/u,s=r<u?0:f[i-u],m=g&&f[(g-1)*w+a*u+r%u],f[i++]=(e+Math.floor((s+m)/2))%256;break;case 4:for(r=v=0;v<w;r=v+=1)e=t[y++],a=(r-r%u)/u,s=r<u?0:f[i-u],0===g?m=x=0:(m=f[(g-1)*w+a*u+r%u],x=a&&f[(g-1)*w+(a-1)*u+r%u]),o=s+m-x,c=Math.abs(o-s),p=Math.abs(o-m),d=Math.abs(o-x),l=c<=p&&c<=d?s:p<=d?m:x,f[i++]=(e+l)%256;break;default:throw new Error("Invalid filter algorithm: "+t[y-1])}g++}return f},o.prototype.decodePalette=function(){var t,e,i,a,r,s,n,o,h;for(i=this.palette,s=this.transparency.indexed||[],r=new Uint8Array((s.length||0)+i.length),a=0,t=0,e=n=0,o=i.length;n<o;e=n+=3)r[a++]=i[e],r[a++]=i[e+1],r[a++]=i[e+2],r[a++]=null!=(h=s[t++])?h:255;return r},o.prototype.copyToImageData=function(t,e){var i,a,r,s,n,o,h,c,l,p,d;if(a=this.colors,l=null,i=this.hasAlphaChannel,this.palette.length&&(l=null!=(d=this._decodedPalette)?d:this._decodedPalette=this.decodePalette(),a=4,i=!0),c=(r=t.data||t).length,n=l||e,s=o=0,1===a)for(;s<c;)h=l?4*e[s/4]:o,p=n[h++],r[s++]=p,r[s++]=p,r[s++]=p,r[s++]=i?n[h++]:this.transparency.grayscale&&this.transparency.grayscale===p?0:255,o=h;else for(;s<c;)h=l?4*e[s/4]:o,r[s++]=n[h++],r[s++]=n[h++],r[s++]=n[h++],r[s++]=i?n[h++]:this.transparency.rgb&&this.transparency.rgb[1]===n[h-3]&&this.transparency.rgb[3]===n[h-2]&&this.transparency.rgb[5]===n[h-1]?0:255,o=h},o.prototype.decode=function(){var t;return t=new Uint8Array(this.width*this.height*4),this.copyToImageData(t,this.decodePixels()),t},s=t.document&&t.document.createElement("canvas"),n=s&&s.getContext("2d"),r=function(t){var e;return n.width=t.width,n.height=t.height,n.clearRect(0,0,t.width,t.height),n.putImageData(t,0,0),(e=new Image).src=s.toDataURL(),e},o.prototype.decodeFrames=function(t){var e,i,a,s,n,o,h,c;if(this.animation){for(c=[],i=n=0,o=(h=this.animation.frames).length;n<o;i=++n)e=h[i],a=t.createImageData(e.width,e.height),s=this.decodePixels(new Uint8Array(e.data)),this.copyToImageData(a,s),e.imageData=a,c.push(e.image=r(a));return c}},o.prototype.renderFrame=function(t,r){var s,n,o;return s=(n=this.animation.frames)[r],o=n[r-1],0===r&&t.clearRect(0,0,this.width,this.height),(null!=o?o.disposeOp:void 0)===i?t.clearRect(o.xOffset,o.yOffset,o.width,o.height):(null!=o?o.disposeOp:void 0)===a&&t.putImageData(o.imageData,o.xOffset,o.yOffset),s.blendOp===e&&t.clearRect(s.xOffset,s.yOffset,s.width,s.height),t.drawImage(s.image,s.xOffset,s.yOffset)},o.prototype.animate=function(t){var e,i,a,r,s,n,o=this;return i=0,n=this.animation,r=n.numFrames,a=n.frames,s=n.numPlays,(e=function(){var n,h;if(n=i++%r,h=a[n],o.renderFrame(t,n),r>1&&i/r<s)return o.animation._timeout=setTimeout(e,h.delay)})()},o.prototype.stopAnimation=function(){var t;return clearTimeout(null!=(t=this.animation)?t._timeout:void 0)},o.prototype.render=function(t){var e,i;return t._png&&t._png.stopAnimation(),t._png=this,t.width=this.width,t.height=this.height,e=t.getContext("2d"),this.animation?(this.decodeFrames(e),this.animate(e)):(i=e.createImageData(this.width,this.height),this.copyToImageData(i,this.decodePixels()),e.putImageData(i,0,0))},o}(self);const u=new Set(["jpg","png","bmp","gif"]),f=new Set(["S8","U8","S16","U16","S32","U32","F32","F64"]);function y(t,e){return g.apply(this,arguments)}function g(){return(g=e._asyncToGenerator((function*(t,e){var r;if(!p.isPlatformLittleEndian)throw new i("rasterCoded:decode","lerc decoder is not supported on big endian platform");yield n.load();const{offset:s,noDataValue:o}=e;let h=null==(r=e.pixelType)?void 0:r.toUpperCase();h&&!f.has(h)&&(h=null);const{width:c,height:l,pixelType:d,statistics:u,pixels:y,mask:g}=n.decode(t,{inputOffset:s,noDataValue:o,pixelType:h});return new a({width:c,height:l,pixelType:d.toLowerCase(),pixels:y,mask:g,statistics:u})}))).apply(this,arguments)}function w(t,e){return m.apply(this,arguments)}function m(){return(m=e._asyncToGenerator((function*(t,e){const i=yield l.decode(t,e.pyramidLevel||0),r=new a({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return r.updateStatistics(),r}))).apply(this,arguments)}function x(t,e){return b.apply(this,arguments)}function b(){return(b=e._asyncToGenerator((function*(t,e){const i=yield l.decodeTileOrStrip(t,e.customOptions),r=new a({width:i.width,height:i.height,pixels:i.pixels,pixelType:i.pixelType.toLowerCase(),mask:i.mask,statistics:null});return r.updateStatistics(),r}))).apply(this,arguments)}function k(t,e){const i=e.pixelType||"u8",r=a.getPixelArrayConstructor(i),s="u8"===i?t:new r(t.buffer),n=[],o=e.planes||1;if(1===o)n.push(s);else for(let a=0;a<o;a++){const i=(e.width||1)*(e.height||t.length),h=new r(i);for(let t=0;t<i;t++)h[t]=s[t*o+a];n.push(h)}const h=new a({width:e.width||1,height:e.height||t.length,pixels:n,pixelType:i,statistics:null});return h.updateStatistics(),h}function T(t,e){return k(new h.Zlib(new Uint8Array(t)).getBytes(),e)}function U(t,e){return k(o.decode(t,e.offset,e.eof,!e.isInputBigEndian),e)}function v(t,e,i){const{pixelTypeCtor:r}=P(e.pixelType),s=(0,c.decode)(t,{width:e.width,height:e.height,pixelType:r,format:i}),n=new a({width:e.width,height:e.height,pixels:s.pixels,pixelType:e.pixelType,mask:s.mask,statistics:null});return n.updateStatistics(),n}function I(t){const e=s.decode(t),i=new a({width:e.width,height:e.height,pixels:e.pixels,pixelType:"U8",mask:e.mask,statistics:null});return i.updateStatistics(),i}function C(t,e){const i=new Uint8Array(t),r=new d(i),{width:s,height:n}=e,o=s*n,h=r.decode();let c,l=0,p=0;const u=new Uint8Array(o);for(l=0;l<o;l++)u[l]=h[4*l+3];const f=new a({width:s,height:n,pixels:[],pixelType:"U8",mask:u,statistics:[]});for(l=0;l<3;l++){for(c=new Uint8Array(o),p=0;p<o;p++)c[p]=h[4*p+l];f.addData({pixels:c})}return f.updateStatistics(),f}function A(t,e,i,a){return D.apply(this,arguments)}function D(){return(D=e._asyncToGenerator((function*(t,e,i,s){const n=new r,o={applyJpegMask:!1,format:e,...i},h=yield n.decode(t,o,s),c=new a(h);return c.updateStatistics(),c}))).apply(this,arguments)}function S(t){if(null==t)throw new i("rasterCodec:decode","parameter encodeddata is required.");const e=new Uint8Array(t,0,10);let a="";return 255===e[0]&&216===e[1]?a="jpg":137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]?a="png":67===e[0]&&110===e[1]&&116===e[2]&&90===e[3]&&73===e[4]&&109===e[5]&&97===e[6]&&103===e[7]&&101===e[8]&&32===e[9]?a="lerc":76===e[0]&&101===e[1]&&114===e[2]&&99===e[3]&&50===e[4]&&32===e[5]?a="lerc2":73===e[0]&&73===e[1]&&42===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&42===e[3]||73===e[0]&&73===e[1]&&43===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&43===e[3]?a="tiff":71===e[0]&&73===e[1]&&70===e[2]?a="gif":66===e[0]&&77===e[1]?a="bmp":String.fromCharCode.apply(null,e).toLowerCase().indexOf("error")>-1&&(a="error"),a}function O(t){let e=null;switch(t){case"lerc":case"lerc2":e=y;break;case"jpg":e=I;break;case"png":e=C;break;case"bsq":case"bip":e=(e,i)=>v(e,i,t);break;case"tiff":e=w;break;case"deflate":e=T;break;case"lzw":e=U;break;case"error":e=()=>{throw new i("rasterCodec:decode","input data contains error")};break;default:e=()=>{throw new i("rasterCodec:decode","unsupported raster format")}}return e}function P(t){let e=null,i=null;switch(t?t.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":i=255,e=Uint8Array;break;case"u16":i=i||65535,e=Uint16Array;break;case"u32":i=i||2**32-1,e=Uint32Array;break;case"s8":i=i||-128,e=Int8Array;break;case"s16":i=i||-32768,e=Int16Array;break;case"s32":i=i||0-2**31,e=Int32Array;break;default:e=Float32Array}return{pixelTypeCtor:e,noDataValue:i}}function L(t,e=1){if(!t)return;const{pixels:i,width:r,height:s,mask:n}=t;if(!i||0===i.length)return;const o=i.length,h=r-1,c=s-1,l=[];let p,d,u,f,y,g,w;const m=a.getPixelArrayConstructor(t.pixelType);if(0===e){for(p=0;p<o;p++){for(y=i[p],g=new m(h*c),d=0;d<c;d++)for(f=d*r,u=0;u<h;u++)g[d*h+u]=y[f+u];l.push(g)}if(n)for(w=new Uint8Array(h*c),d=0;d<c;d++)for(f=d*r,u=0;u<h;u++)w[d*h+u]=n[f+u]}else{for(p=0;p<o;p++){for(y=i[p],g=new m(h*c),d=0;d<c;d++)for(f=d*r,u=0;u<h;u++)g[d*h+u]=(y[f+u]+y[f+u+1]+y[f+r+u]+y[f+r+u+1])/4;l.push(g)}if(n)for(w=new Uint8Array(h*c),d=0;d<c;d++)for(f=d*r,u=0;u<h;u++)w[d*h+u]=Math.min.apply(null,[n[f+u],n[f+u+1],n[f+r+u],n[f+r+u+1]])}t.width=h,t.height=c,t.mask=w,t.pixels=l}function _(t){let e=S(t);return"lerc2"===e?e="lerc":"error"===e&&(e=""),e}function M(t){return R.apply(this,arguments)}function R(){return(R=e._asyncToGenerator((function*(t,e={},a){if(null==t)throw new i("rasterCodec:decode","missing encodeddata parameter.");let r,s,n=e.format&&e.format.toLowerCase();if(!("bsq"!==n&&"bip"!==n||null!=e.width&&null!=e.height))throw new i("rasterCodec:decode","requires width and height in options parameter.");return"tiff"===n&&e.customOptions?x(t,e):((!n||"bsq"!==n&&"bip"!==n&&"deflate"!==n&&"lzw"!==n)&&(n=S(t)),e.useCanvas&&u.has(n)?s=yield A(t,n,e,a):(r=O(n),e.isPoint&&((e={...e}).width++,e.height++),s=yield r(t,e),e.isPoint&&L(s)),s)}))).apply(this,arguments)}t.decode=M,t.getFormat=_,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
