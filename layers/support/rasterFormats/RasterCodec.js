// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Error","../../../core/SetUtils","../PixelBlock","./ImageCanvasDecoder","./JpgPlus","./Lerc2Codec","./LercCodec","./Png","./Raw","./TiffDecoder"],(function(e,t,r,a,i,n,o,s,d,l,c,h,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decode=t.getFormat=void 0;var f,p,w=i.SetFromValues(["jpg","png","bmp","gif"]),g=(f=new ArrayBuffer(4),p=new Uint8Array(f),new Uint32Array(f)[0]=1,1===p[0]);function m(e,t){if(!g)throw new a("rasterCoded:decode","lerc decoder is not supported on big endian platform");for(var r,i,o=t.width,s=t.height,d=t.pixelType,c=A(d),h=c.pixelTypeCtor,u=null==t.noDataValue?c.noDataValue:t.noDataValue,f=0,p=0,w=e.byteLength-10;p<w;){var m=l.decode(e,{inputOffset:p,encodedMaskData:r,returnMask:0===f,returnEncodedMask:0===f,returnFileInfo:!0,pixelType:h,noDataValue:u});if(o&&s&&(m.width!==o||m.height!==s))throw new a("rasterCoded:decode","lerc decoded result has width or height different from specified in options");if(p=m.fileInfo.eofOffset,0===f&&(r=m.encodedMaskData,i=new n({width:m.width,height:m.height,pixels:[],pixelType:d,mask:m.maskData,statistics:[]})),f++,i.addData({pixels:m.pixelData,statistics:{minValue:m.minValue,maxValue:m.maxValue,noDataValue:m.noDataValue}}),w-p>10){var x=String.fromCharCode.apply(null,new Uint8Array(e,p,10));p=p+x.indexOf("CntZ")>-1?x.indexOf("CntZ"):0}}return i}function x(e,t){if(!g)throw new a("rasterCoded:decode","lerc decoder is not supported on big endian platform");for(var r,i,o,s=0,l=0,c=0,h=e.byteLength-10,u=[],f=t.width,p=t.height;l<h;){if(i=d.decode(e,{inputOffset:l,maskData:r,returnFileInfo:!0}),f&&p&&(i.width!==f||i.height!==p))throw new a("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");if(l=i.fileInfo.eofOffset,0===s&&(c=i.fileInfo.numValidPixel,r=i.maskData,o=new n({width:i.width,height:i.height,pixels:[],pixelType:i.fileInfo.pixelType,mask:i.maskData,statistics:[]})),i.fileInfo.mask&&i.fileInfo.mask.numBytes>0&&u.push(i.maskData),s++,o.addData({pixels:i.pixelData,statistics:{minValue:i.minValue,maxValue:i.maxValue}}),h-l>10){var w=String.fromCharCode.apply(null,new Uint8Array(e,l,10));l+=w.indexOf("Lerc")>-1?w.indexOf("Lerc"):0}}var m=0,x=0,y=0;if(u.length>1){for(y=o.width*o.height,(r=new Uint8Array(y)).set(u[0]),m=1;m<u.length;m++){var k=u[m];for(x=0;x<y;x++)r[x]=r[x]&k[x]}for(c=0,x=0;x<y;x++)c+=r[x];o.mask=r}return o.validPixelCount=c,o}function y(e){var t=u.decode(e),r=new n({width:t.width,height:t.height,pixels:t.pixels,pixelType:t.pixelType.toLowerCase(),mask:t.mask,statistics:null});return r.updateStatistics(),r}function k(e,t){var r=u.decodeTileOrStrip(e,t.customOptions),a=new n({width:r.width,height:r.height,pixels:r.pixels,pixelType:r.pixelType.toLowerCase(),mask:r.mask,statistics:null});return a.updateStatistics(),a}function v(e){var t=s.decode(e),r=new n({width:t.width,height:t.height,pixels:t.pixels,pixelType:"U8",mask:t.mask,statistics:null});return r.updateStatistics(),r}function C(e,t){var r,a=new Uint8Array(e),i=new c(a),o=t.width,s=t.height,d=o*s,l=i.decode(),h=0,u=0,f=new Uint8Array(d);for(h=0;h<d;h++)f[h]=l[4*h+3];var p=new n({width:o,height:s,pixels:[],pixelType:"U8",mask:f,statistics:[]});for(h=0;h<3;h++){for(r=new Uint8Array(d),u=0;u<d;u++)r[u]=l[4*u+h];p.addData({pixels:r})}return p.updateStatistics(),p}function b(e,t,a,i){return r.__awaiter(this,void 0,void 0,(function(){var s,d,l,c;return r.__generator(this,(function(h){switch(h.label){case 0:return s=new o,d=r.__assign({applyJpegMask:!1,format:t},a),[4,s.decode(e,d,i)];case 1:return l=h.sent(),(c=new n(l)).updateStatistics(),[2,c]}}))}))}function D(e){if(null==e)throw new a("rasterCodec:decode","parameter encodeddata is required.");var t=new Uint8Array(e,0,10),r="";return 255===t[0]&&216===t[1]?r="jpg":137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]?r="png":67===t[0]&&110===t[1]&&116===t[2]&&90===t[3]&&73===t[4]&&109===t[5]&&97===t[6]&&103===t[7]&&101===t[8]&&32===t[9]?r="lerc":76===t[0]&&101===t[1]&&114===t[2]&&99===t[3]&&50===t[4]&&32===t[5]?r="lerc2":73===t[0]&&73===t[1]&&42===t[2]&&0===t[3]||77===t[0]&&77===t[1]&&0===t[2]&&42===t[3]?r="tiff":71===t[0]&&73===t[1]&&70===t[2]?r="gif":66===t[0]&&77===t[1]?r="bmp":String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1&&(r="error"),r}function T(e){var t=null;switch(e){case"lerc":t=m;break;case"lerc2":t=x;break;case"jpg":t=v;break;case"png":t=C;break;case"bsq":case"bip":t=function(t,r){return function(e,t,r){var a=A(t.pixelType).pixelTypeCtor,i=(0,h.decode)(e,{width:t.width,height:t.height,pixelType:a,format:r}),o=new n({width:t.width,height:t.height,pixels:i.pixels,pixelType:t.pixelType,mask:i.mask,statistics:null});return o.updateStatistics(),o}(t,r,e)};break;case"tiff":t=y;break;case"error":t=function(){throw new a("rasterCodec:decode","input data contains error")};break;default:t=function(){throw new a("rasterCodec:decode","unsupported raster format")}}return t}function A(e){var t=null,r=null;switch(e?e.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":r=Math.pow(2,8)-1,t=Uint8Array;break;case"u16":r=r||Math.pow(2,16)-1,t=Uint16Array;break;case"u32":r=r||Math.pow(2,32)-1,t=Uint32Array;break;case"s8":r=r||0-Math.pow(2,7),t=Int8Array;break;case"s16":r=r||0-Math.pow(2,15),t=Int16Array;break;case"s32":r=r||0-Math.pow(2,31),t=Int32Array;break;default:t=Float32Array}return{pixelTypeCtor:t,noDataValue:r}}t.getFormat=function(e){var t=D(e);return"lerc2"===t?t="lerc":"error"===t&&(t=""),t},t.decode=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var o,s,d;return r.__generator(this,(function(l){switch(l.label){case 0:if(null==e)throw new a("rasterCodec:decode","missing encodeddata parameter.");if(null==t||null==t.width||null==t.height)throw new a("rasterCodec:decode","requires width and height in options parameter.");return"tiff"===(o=t.format&&t.format.toLowerCase())&&t.customOptions?[2,k(e,t)]:((!o||"bsq"!==o&&"bip"!==o)&&(o=D(e)),t.useCanvas&&w.has(o)?[4,b(e,o,t,i)]:[3,2]);case 1:return d=l.sent(),[3,3];case 2:s=T(o),t.isPoint&&((t=r.__assign({},t)).width++,t.height++),d=s(e,t),t.isPoint&&function(e,t){if(void 0===t&&(t=1),e){var r=e.pixels,a=e.width,i=e.height,o=e.mask;if(r&&0!==r.length){var s,d,l,c,h,u,f,p=r.length,w=a-1,g=i-1,m=[],x=n.getPixelArrayConstructor(e.pixelType);if(0===t){for(s=0;s<p;s++){for(h=r[s],u=new x(w*g),d=0;d<g;d++)for(c=d*a,l=0;l<w;l++)u[d*w+l]=h[c+l];m.push(u)}if(o)for(f=new Uint8Array(w*g),d=0;d<g;d++)for(c=d*a,l=0;l<w;l++)f[d*w+l]=o[c+l]}else{for(s=0;s<p;s++){for(h=r[s],u=new x(w*g),d=0;d<g;d++)for(c=d*a,l=0;l<w;l++)u[d*w+l]=(h[c+l]+h[c+l+1]+h[c+a+l]+h[c+a+l+1])/4;m.push(u)}if(o)for(f=new Uint8Array(w*g),d=0;d<g;d++)for(c=d*a,l=0;l<w;l++)f[d*w+l]=Math.min.apply(null,[o[c+l],o[c+l+1],o[c+a+l],o[c+a+l+1]])}e.width=w,e.height=g,e.mask=f,e.pixels=m}}}(d),l.label=3;case 3:return[2,d]}}))}))}}));