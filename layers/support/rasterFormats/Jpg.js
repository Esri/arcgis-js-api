// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define([],(function(){"use strict";var e=function(){function e(e){this.message="JPEG error: "+e}return e.prototype=new Error,e.prototype.name="JpegError",e.constructor=e,e}();return function(){if(!self||!self.Uint8ClampedArray)return null;var n=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]);function r(){this.decodeTransform=null,this.colorTransform=-1}function o(e,n){for(var r,o,a=0,t=[],i=16;i>0&&!e[i-1];)i--;t.push({children:[],index:0});var s,c=t[0];for(r=0;r<i;r++){for(o=0;o<e[r];o++){for((c=t.pop()).children[c.index]=n[a];c.index>0;)c=t.pop();for(c.index++,t.push(c);t.length<=r;)t.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s;a++}r+1<i&&(t.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s)}return t[0].children}function a(e,n,r){return 64*((e.blocksPerLine+1)*n+r)}function t(r,o,t,i,s,f,l,u,h){var v=t.mcusPerLine,m=t.progressive,d=o,b=0,p=0;function k(){if(p>0)return p--,b>>p&1;if(255===(b=r[o++])){var n=r[o++];if(n)throw new e("unexpected marker "+(b<<8|n).toString(16))}return p=7,b>>>7}function g(n){for(var r=n;;){if("number"==typeof(r=r[k()]))return r;if("object"!=typeof r)throw new e("invalid huffman sequence")}}function C(e){for(var n=0;e>0;)n=n<<1|k(),e--;return n}function w(e){if(1===e)return 1===k()?1:-1;var n=C(e);return n>=1<<e-1?n:n+(-1<<e)+1}var y=0;var D,T=0;function x(e,n,r,o,t){var i=r%v;n(e,a(e,(r/v|0)*e.v+o,i*e.h+t))}function P(e,n,r){n(e,a(e,r/e.blocksPerLine|0,r%e.blocksPerLine))}var L,A,_,U,z,I,M=i.length;I=m?0===f?0===u?function(e,n){var r=g(e.huffmanTableDC),o=0===r?0:w(r)<<h;e.blockData[n]=e.pred+=o}:function(e,n){e.blockData[n]|=k()<<h}:0===u?function(e,r){if(y>0)y--;else for(var o=f,a=l;o<=a;){var t=g(e.huffmanTableAC),i=15&t,s=t>>4;if(0!==i){var c=n[o+=s];e.blockData[r+c]=w(i)*(1<<h),o++}else{if(s<15){y=C(s)+(1<<s)-1;break}o+=16}}}:function(r,o){for(var a,t,i=f,s=l,c=0;i<=s;){var u=n[i];switch(T){case 0:if(c=(t=g(r.huffmanTableAC))>>4,0===(a=15&t))c<15?(y=C(c)+(1<<c),T=4):(c=16,T=1);else{if(1!==a)throw new e("invalid ACn encoding");D=w(a),T=c?2:3}continue;case 1:case 2:r.blockData[o+u]?r.blockData[o+u]+=k()<<h:0===--c&&(T=2===T?3:0);break;case 3:r.blockData[o+u]?r.blockData[o+u]+=k()<<h:(r.blockData[o+u]=D<<h,T=0);break;case 4:r.blockData[o+u]&&(r.blockData[o+u]+=k()<<h)}i++}4===T&&0===--y&&(T=0)}:function(e,r){var o=g(e.huffmanTableDC),a=0===o?0:w(o);e.blockData[r]=e.pred+=a;for(var t=1;t<64;){var i=g(e.huffmanTableAC),s=15&i,c=i>>4;if(0!==s){var f=n[t+=c];e.blockData[r+f]=w(s),t++}else{if(c<15)break;t+=16}}};var Y,q,S,R,H=0;for(q=1===M?i[0].blocksPerLine*i[0].blocksPerColumn:v*t.mcusPerColumn;H<q;){var E=s?Math.min(q-H,s):q;for(A=0;A<M;A++)i[A].pred=0;if(y=0,1===M)for(L=i[0],z=0;z<E;z++)P(L,I,H),H++;else for(z=0;z<E;z++){for(A=0;A<M;A++)for(S=(L=i[A]).h,R=L.v,_=0;_<R;_++)for(U=0;U<S;U++)x(L,I,H,_,U);H++}p=0,(Y=c(r,o))&&Y.invalid&&(console.log("decodeScan - unexpected MCU data, next marker is: "+Y.invalid),o=Y.offset);var V=Y&&Y.marker;if(!V||V<=65280)throw new e("marker was not found");if(!(V>=65488&&V<=65495))break;o+=2}return(Y=c(r,o))&&Y.invalid&&(console.log("decodeScan - unexpected Scan data, next marker is: "+Y.invalid),o=Y.offset),o-d}function i(n,r,o){var a,t,i,s,c,f,l,u,h,v,m,d,b,p,k,g,C,w=n.quantizationTable,y=n.blockData;if(!w)throw new e("missing required Quantization Table.");for(var D=0;D<64;D+=8)h=y[r+D],v=y[r+D+1],m=y[r+D+2],d=y[r+D+3],b=y[r+D+4],p=y[r+D+5],k=y[r+D+6],g=y[r+D+7],h*=w[D],0!=(v|m|d|b|p|k|g)?(v*=w[D+1],m*=w[D+2],d*=w[D+3],b*=w[D+4],p*=w[D+5],t=(a=(a=5793*h+128>>8)+(t=5793*b+128>>8)+1>>1)-t,C=3784*(i=m)+1567*(s=k*=w[D+6])+128>>8,i=1567*i-3784*s+128>>8,l=(c=(c=2896*(v-(g*=w[D+7]))+128>>8)+(l=p<<4)+1>>1)-l,f=(u=(u=2896*(v+g)+128>>8)+(f=d<<4)+1>>1)-f,s=(a=a+(s=C)+1>>1)-s,i=(t=t+i+1>>1)-i,C=2276*c+3406*u+2048>>12,c=3406*c-2276*u+2048>>12,u=C,C=799*f+4017*l+2048>>12,f=4017*f-799*l+2048>>12,l=C,o[D]=a+u,o[D+7]=a-u,o[D+1]=t+l,o[D+6]=t-l,o[D+2]=i+f,o[D+5]=i-f,o[D+3]=s+c,o[D+4]=s-c):(C=5793*h+512>>10,o[D]=C,o[D+1]=C,o[D+2]=C,o[D+3]=C,o[D+4]=C,o[D+5]=C,o[D+6]=C,o[D+7]=C);for(var T=0;T<8;++T)h=o[T],0!=((v=o[T+8])|(m=o[T+16])|(d=o[T+24])|(b=o[T+32])|(p=o[T+40])|(k=o[T+48])|(g=o[T+56]))?(t=(a=4112+((a=5793*h+2048>>12)+(t=5793*b+2048>>12)+1>>1))-t,C=3784*(i=m)+1567*(s=k)+2048>>12,i=1567*i-3784*s+2048>>12,s=C,l=(c=(c=2896*(v-g)+2048>>12)+(l=p)+1>>1)-l,f=(u=(u=2896*(v+g)+2048>>12)+(f=d)+1>>1)-f,C=2276*c+3406*u+2048>>12,c=3406*c-2276*u+2048>>12,u=C,C=799*f+4017*l+2048>>12,f=4017*f-799*l+2048>>12,h=(h=(a=a+s+1>>1)+u)<16?0:h>=4080?255:h>>4,v=(v=(t=t+i+1>>1)+(l=C))<16?0:v>=4080?255:v>>4,m=(m=(i=t-i)+f)<16?0:m>=4080?255:m>>4,d=(d=(s=a-s)+c)<16?0:d>=4080?255:d>>4,b=(b=s-c)<16?0:b>=4080?255:b>>4,p=(p=i-f)<16?0:p>=4080?255:p>>4,k=(k=t-l)<16?0:k>=4080?255:k>>4,g=(g=a-u)<16?0:g>=4080?255:g>>4,y[r+T]=h,y[r+T+8]=v,y[r+T+16]=m,y[r+T+24]=d,y[r+T+32]=b,y[r+T+40]=p,y[r+T+48]=k,y[r+T+56]=g):(C=(C=5793*h+8192>>14)<-2040?0:C>=2024?255:C+2056>>4,y[r+T]=C,y[r+T+8]=C,y[r+T+16]=C,y[r+T+24]=C,y[r+T+32]=C,y[r+T+40]=C,y[r+T+48]=C,y[r+T+56]=C)}function s(e,n){for(var r=n.blocksPerLine,o=n.blocksPerColumn,t=new Int16Array(64),s=0;s<o;s++)for(var c=0;c<r;c++){i(n,a(n,s,c),t)}return n.blockData}function c(e,n,r){function o(n){return e[n]<<8|e[n+1]}var a=e.length-1,t=r<n?r:n;if(n>=a)return null;var i=o(n);if(i>=65472&&i<=65534)return{invalid:null,marker:i,offset:n};for(var s=o(t);!(s>=65472&&s<=65534);){if(++t>=a)return null;s=o(t)}return{invalid:i.toString(16),marker:s,offset:t}}return r.prototype={parse:function(r){function a(){var e=r[h]<<8|r[h+1];return h+=2,e}function i(){var e=a(),n=h+e-2,o=c(r,n,h);o&&o.invalid&&(console.log("readDataBlock - incorrect length, next marker is: "+o.invalid),n=o.offset);var t=r.subarray(h,n);return h+=t.length,t}function f(e){for(var n=Math.ceil(e.samplesPerLine/8/e.maxH),r=Math.ceil(e.scanLines/8/e.maxV),o=0;o<e.components.length;o++){H=e.components[o];var a=Math.ceil(Math.ceil(e.samplesPerLine/8)*H.h/e.maxH),t=Math.ceil(Math.ceil(e.scanLines/8)*H.v/e.maxV),i=n*H.h,s=64*(r*H.v)*(i+1);H.blockData=new Int16Array(s),H.blocksPerLine=a,H.blocksPerColumn=t}e.mcusPerLine=n,e.mcusPerColumn=r}var l,u,h=0,v=null,m=null,d=[],b=[],p=[],k=a();if(65496!==k)throw new e("SOI not found");for(k=a();65497!==k;){var g,C,w;switch(k){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var y=i();65504===k&&74===y[0]&&70===y[1]&&73===y[2]&&70===y[3]&&0===y[4]&&(v={version:{major:y[5],minor:y[6]},densityUnits:y[7],xDensity:y[8]<<8|y[9],yDensity:y[10]<<8|y[11],thumbWidth:y[12],thumbHeight:y[13],thumbData:y.subarray(14,14+3*y[12]*y[13])}),65518===k&&65===y[0]&&100===y[1]&&111===y[2]&&98===y[3]&&101===y[4]&&(m={version:y[5]<<8|y[6],flags0:y[7]<<8|y[8],flags1:y[9]<<8|y[10],transformCode:y[11]});break;case 65499:for(var D=a()+h-2;h<D;){var T=r[h++],x=new Uint16Array(64);if(T>>4==0)for(C=0;C<64;C++)x[n[C]]=r[h++];else{if(T>>4!=1)throw new e("DQT - invalid table spec");for(C=0;C<64;C++)x[n[C]]=a()}d[15&T]=x}break;case 65472:case 65473:case 65474:if(l)throw new e("Only single frame JPEGs supported");a(),(l={}).extended=65473===k,l.progressive=65474===k,l.precision=r[h++],l.scanLines=a(),l.samplesPerLine=a(),l.components=[],l.componentIds={};var P,L=r[h++],A=0,_=0;for(g=0;g<L;g++){P=r[h];var U=r[h+1]>>4,z=15&r[h+1];A<U&&(A=U),_<z&&(_=z);var I=r[h+2];w=l.components.push({h:U,v:z,quantizationId:I,quantizationTable:null}),l.componentIds[P]=w-1,h+=3}l.maxH=A,l.maxV=_,f(l);break;case 65476:var M=a();for(g=2;g<M;){var Y=r[h++],q=new Uint8Array(16),S=0;for(C=0;C<16;C++,h++)S+=q[C]=r[h];var R=new Uint8Array(S);for(C=0;C<S;C++,h++)R[C]=r[h];g+=17+S,(Y>>4==0?p:b)[15&Y]=o(q,R)}break;case 65501:a(),u=a();break;case 65498:a();var H,E=r[h++],V=[];for(g=0;g<E;g++){var j=l.componentIds[r[h++]];H=l.components[j];var B=r[h++];H.huffmanTableDC=p[B>>4],H.huffmanTableAC=b[15&B],V.push(H)}var J=r[h++],N=r[h++],G=r[h++],O=t(r,h,l,V,u,J,N,G>>4,15&G);h+=O;break;case 65535:255!==r[h]&&h--;break;default:if(255===r[h-3]&&r[h-2]>=192&&r[h-2]<=254){h-=3;break}throw new e("unknown marker "+k.toString(16))}k=a()}for(this.width=l.samplesPerLine,this.height=l.scanLines,this.jfif=v,this.eof=h,this.adobe=m,this.components=[],g=0;g<l.components.length;g++){var Q=d[(H=l.components[g]).quantizationId];Q&&(H.quantizationTable=Q),this.components.push({output:s(0,H),scaleX:H.h/l.maxH,scaleY:H.v/l.maxV,blocksPerLine:H.blocksPerLine,blocksPerColumn:H.blocksPerColumn})}this.numComponents=this.components.length},_getLinearizedBlockData:function(e,n){var r,o,a,t,i,s,c,f,l,u,h,v=this.width/e,m=this.height/n,d=0,b=this.components.length,p=e*n*b,k=new Uint8ClampedArray(p),g=new Uint32Array(e);for(c=0;c<b;c++){for(o=(r=this.components[c]).scaleX*v,a=r.scaleY*m,d=c,h=r.output,t=r.blocksPerLine+1<<3,i=0;i<e;i++)f=0|i*o,g[i]=(4294967288&f)<<3|7&f;for(s=0;s<n;s++)for(u=t*(4294967288&(f=0|s*a))|(7&f)<<3,i=0;i<e;i++)k[d]=h[u+g[i]],d+=b}var C=this.decodeTransform;if(C)for(c=0;c<p;)for(f=0,l=0;f<b;f++,c++,l+=2)k[c]=(k[c]*C[l]>>8)+C[l+1];return k},_isColorConversionNeeded:function(){return this.adobe?!!this.adobe.transformCode:3===this.numComponents?0!==this.colorTransform:1===this.colorTransform},_convertYccToRgb:function(e){for(var n,r,o,a=0,t=e.length;a<t;a+=3)n=e[a],r=e[a+1],o=e[a+2],e[a]=n-179.456+1.402*o,e[a+1]=n+135.459-.344*r-.714*o,e[a+2]=n-226.816+1.772*r;return e},_convertYcckToRgb:function(e){for(var n,r,o,a,t=0,i=0,s=e.length;i<s;i+=4)n=e[i],r=e[i+1],o=e[i+2],a=e[i+3],e[t++]=r*(-660635669420364e-19*r+.000437130475926232*o-54080610064599e-18*n+.00048449797120281*a-.154362151871126)-122.67195406894+o*(-.000957964378445773*o+.000817076911346625*n-.00477271405408747*a+1.53380253221734)+n*(.000961250184130688*n-.00266257332283933*a+.48357088451265)+a*(-.000336197177618394*a+.484791561490776),e[t++]=107.268039397724+r*(219927104525741e-19*r-.000640992018297945*o+.000659397001245577*n+.000426105652938837*a-.176491792462875)+o*(-.000778269941513683*o+.00130872261408275*n+.000770482631801132*a-.151051492775562)+n*(.00126935368114843*n-.00265090189010898*a+.25802910206845)+a*(-.000318913117588328*a-.213742400323665),e[t++]=r*(-.000570115196973677*r-263409051004589e-19*o+.0020741088115012*n-.00288260236853442*a+.814272968359295)-20.810012546947+o*(-153496057440975e-19*o-.000132689043961446*n+.000560833691242812*a-.195152027534049)+n*(.00174418132927582*n-.00255243321439347*a+.116935020465145)+a*(-.000343531996510555*a+.24165260232407);return e},_convertYcckToCmyk:function(e){for(var n,r,o,a=0,t=e.length;a<t;a+=4)n=e[a],r=e[a+1],o=e[a+2],e[a]=434.456-n-1.402*o,e[a+1]=119.541-n+.344*r+.714*o,e[a+2]=481.816-n-1.772*r;return e},_convertCmykToRgb:function(e){for(var n,r,o,a,t=0,i=0,s=e.length;i<s;i+=4)n=e[i]*(1/255),r=e[i+1]*(1/255),o=e[i+2]*(1/255),a=e[i+3]*(1/255),e[t++]=255+n*(-4.387332384609988*n+54.48615194189176*r+18.82290502165302*o+212.25662451639585*a-285.2331026137004)+r*(1.7149763477362134*r-5.6096736904047315*o-17.873870861415444*a-5.497006427196366)+o*(-2.5217340131683033*o-21.248923337353073*a+17.5119270841813)-a*(21.86122147463605*a+189.48180835922747),e[t++]=255+n*(8.841041422036149*n+60.118027045597366*r+6.871425592049007*o+31.159100130055922*a-79.2970844816548)+r*(-15.310361306967817*r+17.575251261109482*o+131.35250912493976*a-190.9453302588951)+o*(4.444339102852739*o+9.8632861493405*a-24.86741582555878)-a*(20.737325471181034*a+187.80453709719578),e[t++]=255+n*(.8842522430003296*n+8.078677503112928*r+30.89978309703729*o-.23883238689178934*a-14.183576799673286)+r*(10.49593273432072*r+63.02378494754052*o+50.606957656360734*a-112.23884253719248)+o*(.03296041114873217*o+115.60384449646641*a-193.58209356861505)-a*(22.33816807309886*a+180.12613974708367);return e},getData:function(n,r,o){if(this.numComponents>4)throw new e("Unsupported color mode");var a=this._getLinearizedBlockData(n,r);if(1===this.numComponents&&o){for(var t=a.length,i=new Uint8ClampedArray(3*t),s=0,c=0;c<t;c++){var f=a[c];i[s++]=f,i[s++]=f,i[s++]=f}return i}if(3===this.numComponents&&this._isColorConversionNeeded())return this._convertYccToRgb(a);if(4===this.numComponents){if(this._isColorConversionNeeded())return o?this._convertYcckToRgb(a):this._convertYcckToCmyk(a);if(o)return this._convertCmykToRgb(a)}return a}},r}()}));