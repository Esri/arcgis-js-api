/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/Zlib","../../../chunks/Jpg","../rasterDatasets/byteStreamUtils","./Lzw","./TiffTags","./utils"],(function(e,t,n,i,a,s,l){"use strict";const r=[0,1,1,2,4,8,1,1,2,4,8,4,8,-1,-1,-1,8,8,8],o=4294967296;function f(e,t){let n="unknown";return 3===e?n="f32":1===e?1===t?n="u1":2===t?n="u2":4===t?n="u4":t<=8?n="u8":t<=16?n="u16":t<=32&&(n="u32"):2===e&&(t<=8?n="s8":t<=16?n="s16":t<=32&&(n="s32")),n}function u(e){let t=null;switch(e?e.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":t=Uint8Array;break;case"u16":t=Uint16Array;break;case"u32":t=Uint32Array;break;case"s8":t=Int8Array;break;case"s16":t=Int16Array;break;case"s32":t=Int32Array;break;default:t=Float32Array}return t}function c(e,t){return{x:t[0]*e.x+t[1]*e.y+t[2],y:t[3]*e.x+t[4]*e.y+t[5]}}function h(e,t){const n=e.get(t);return n&&n.values}function g(e,t){const n=e.get(t);return n&&n.values[0]}function d(e,t,n,i=0,a=s.TIFF_TAGS,l=4){const r=8===l,o=r?m(new DataView(e,n,8),0,t):new DataView(e,n,2).getUint16(0,t),f=4+2*l,u=r?8:2,c=u+o*f;if(n+c>e.byteLength)return{success:!1,ifd:null,nextIFD:null,requiredBufferSize:c};const h=n+c+4<=e.byteLength?M(new DataView(e,n+c,8===l?8:4),0,t,8===l):null,g=n+u,d=new Map;let p,w,I,T,E,A,S;for(let m=0;m<o;m++){w=new DataView(e,g+f*m,f),I=w.getUint16(0,t),E=w.getUint16(2,t),T=s.getTagName(I,a);const n=[];2===l?(A=w.getUint16(4,t),S=w.getUint16(6,t)):4===l?(A=w.getUint32(4,t),S=w.getUint32(8,t)):8===l&&(A=M(w,4,t,!0),S=M(w,12,t,!0),n.push(w.getUint32(12,t)),n.push(w.getUint32(16,t))),p={id:I,type:E,valueCount:A,valueOffset:S,valueOffsets:n,values:null},y(e,t,p,i,!1,l),d.set(T,p)}return{success:!0,ifd:d,nextIFD:h,requiredBufferSize:c}}const p=function(e,i,s,r,o){const c=l.isPlatformLittleEndian===i,h=g(s,"BITSPERSAMPLE"),d=f(g(s,"SAMPLEFORMAT")||1,h),p=g(s,"COMPRESSION")||1,w=u(d);let I,T,E,y,A,S,m;if(1===p)E=e.slice(r,r+o),y=new Uint8Array(E);else if(8===p||32946===p)y=new Uint8Array(e,r,o),S=new t.Zlib(y),m=S.getBytes(),E=new ArrayBuffer(m.length),y=new Uint8Array(E),y.set(m);else if(6===p){y=new Uint8Array(e,r,o);const t=new n.Jpg;t.parse(y);const i=t.getData(t.width,t.height,!0);E=new ArrayBuffer(i.length),y=new Uint8Array(E),y.set(i)}else 5===p&&(y=a.decode(e,r,o,i),E=y.buffer);if("u8"===d||"s8"===d||c)T=new w(E);else{switch(E=new ArrayBuffer(y.length),A=new Uint8Array(E),d){case"u16":case"s16":for(I=0;I<y.length;I+=2)A[I]=y[I+1],A[I+1]=y[I];break;case"u32":case"s32":case"f32":for(I=0;I<y.length;I+=4)A[I]=y[I+3],A[I+1]=y[I+2],A[I+2]=y[I+1],A[I+3]=y[I]}T=new w(E)}return T},w=function(e,t,n){const i=h(n,"TILEOFFSETS");if(void 0===i)return null;const a=h(n,"TILEBYTECOUNTS"),s=t.tileWidth,l=t.tileHeight,{width:r,height:o,pixelType:f,isBSQ:c}=t,g=t.planes,d=r*o,w=h(n,"BITSPERSAMPLE")[0],I=u(f),T=[];for(let u=0;u<g;u++)T.push(new I(d));let E,y,A,S,m,b,M,x,O,D,U,P,L;const N=Math.ceil(r/s);if(w%8==0)for(E=0;E<i.length;E++)for(b=Math.floor(E/N)*l,M=E%N*s,x=b*r+M,A=p(e,t.littleEndian,n,i[E],a[E]),D=0,O=x,P=Math.min(s,r-M),U=Math.min(l,o-b),y=0;y<g;y++)if(L=T[y],c)for(S=0;S<U;S++)for(O=x+S*r,D=s*l*y+S*s,m=0;m<P;m++,O++,D++)L[O]=A[D];else for(S=0;S<U;S++)for(O=x+S*r,D=S*s*g+y,m=0;m<P;m++,O++,D+=g)L[O]=A[D];return{width:r,height:o,pixelType:f,pixels:T}},I=function(e,i,s){const r=l.isPlatformLittleEndian===i.littleEndian,o=h(s,"STRIPOFFSETS");if(void 0===o)return null;const{width:f,height:c,pixelType:g}=i,d=i.planes,p=f*c,w=h(s,"BITSPERSAMPLE")[0],I=u(g),T=new I(p*d),E=h(s,"STRIPBYTECOUNTS"),y=h(s,"ROWSPERSTRIP")[0],A=h(s,"COMPRESSION")?h(s,"COMPRESSION")[0]:1;let S,m,b,M,x,O,D,U,P,L,N,k=y;if(w%8==0)for(S=0;S<o.length;S++){if(x=S*(y*f)*d,k=(S+1)*y>c?c-S*y:y,"u8"===g||"s8"===g||r){if(8===A||32946===A)D=new Uint8Array(e,o[S],E[S]),L=new t.Zlib(D),N=L.getBytes(),O=new ArrayBuffer(N.length),D=new Uint8Array(O),D.set(N),D.length!==k*f*d*w/8&&console.log("strip byte counts is different than expected");else if(6===A){D=new Uint8Array(e,o[S],E[S]);const t=new n.Jpg;t.parse(D);const i=t.getData(t.width,t.height,!0);O=new ArrayBuffer(i.length),D=new Uint8Array(O),D.set(i)}else 5===A?(D=a.decode(e,o[S],E[S],i.littleEndian),O=D.buffer):1===A&&(E[S]!==k*f*d*w/8&&console.log("strip byte counts is different than expected"),O=e.slice(o[S],o[S]+E[S]));M=new I(O)}else{switch(6===A||8===A||32946===A?(D=new Uint8Array(e,o[S],E[S]),L=new t.Zlib(D),D=L.getBytes(),O=new ArrayBuffer(D.length),U=new Uint8Array(O),D.length!==k*f*d*w/8&&console.log("strip byte counts is different than expected")):1===A&&(E[S]!==k*f*d*w/8&&console.log("strip byte counts is different than expected"),O=new ArrayBuffer(E[S]),D=new Uint8Array(e,o[S],E[S]),U=new Uint8Array(O)),g){case"u16":case"s16":for(b=0;b<D.length;b+=2)U[b]=D[b+1],U[b+1]=D[b];break;case"u32":case"s32":case"f32":for(b=0;b<D.length;b+=4)U[b]=D[b+3],U[b+1]=D[b+2],U[b+2]=D[b+1],U[b+3]=D[b]}M=new I(O)}T.set(M,x)}const G=[];if(1===d)G.push(T);else for(S=0;S<d;S++){for(P=new I(p),m=0;m<p;m++)P[m]=T[m*d+S];G.push(P)}return{width:f,height:c,pixelType:g,pixels:G}},T=function(e,t,n){if(!(e&&e.length>0&&t&&n))return null;let i,a,s;const l=e[0].length,r=e.length,o=new Uint8Array(l);for(let f=0;f<r;f++)if(i=e[f],a=t[f],s=n[f],0===f)for(let e=0;e<l;e++)o[e]=i[e]<a||i[e]>s?0:1;else for(let e=0;e<l;e++)o[e]&&(o[e]=i[e]<a||i[e]>s?0:1);return o},E=function(e){if(!e)return null;const t=e.match(/<Item(.*?)Item>/gi);if(!t||0===t.length)return null;const n=new Map;let i,a,s,l,r;for(let I=0;I<t.length;I++)i=t[I],a=i.slice("<Item ".length,i.indexOf(">")),l=i.indexOf("sample="),l>-1&&(r=i.slice(l+'sample="'.length,i.indexOf('"',l+'sample="'.length))),l=i.indexOf("name="),l>-1&&(a=i.slice(l+'name="'.length,i.indexOf('"',l+'name="'.length))),a&&(s=i.slice(i.indexOf(">")+1,i.indexOf("</Item>")).trim(),null!=r?n.has(a)?n.get(a)[r]=s:n.set(a,[s]):n.set(a,s)),r=null;const o=n.get("STATISTICS_MINIMUM"),f=n.get("STATISTICS_MAXIMUM"),u=n.get("STATISTICS_MEAN"),c=n.get("STATISTICS_STDDEV");let h=null;if(o&&f){h=[];for(let e=0;e<o.length;e++)h.push({min:parseFloat(o[e]),max:parseFloat(f[e]),avg:u&&parseFloat(u[e]),stddev:c&&parseFloat(c[e])})}const g=n.get("BandName"),d=n.get("WavelengthMin"),p=n.get("WavelengthMax");let w=null;if(g){w=[];for(let e=0;e<g.length;e++)w.push({BandName:g[e],WavelengthMin:d&&parseFloat(d[e]),WavelengthMax:p&&parseFloat(p[e])})}return{statistics:h,bandProperties:w,dataType:n.get("DataType"),rawMetadata:n}};function y(e,t,n,i=0,a=!1,s=4){if(n.values)return!0;const l=n.type,f=n.valueCount;let u=n.valueOffset,c=[];const h=r[l],g=8*h,d=f*h,p=f*r[l]*8;let w,I;const T=8===s?64:32,E=n.valueOffsets;if(p>T){if(d>(a?e.byteLength:e?e.byteLength-u+i:0))return n.offlineOffsetSize=[u,d],n.values=null,!1}if(p<=T){if(!t)if(T<=32)u>>>=32-p;else{const e=null!=E&&E.length?E[0]:u>>>0,t=null!=E&&E.length?E[1]:Math.round((u-e)/o);p<=32?(u=e>>>32-p,E[0]=u):(u=e*2**(32-p)+(t>>>32-p),E[0]=e,E[1]=t>>>32-p)}if(1===f&&g===T)c=[u];else if(64===T){const e=null!=E&&E.length?E[0]:u>>>0,t=null!=E&&E.length?E[1]:Math.round((u-e)/o);let n=e,i=32;for(I=1;I<=f;I++){const e=32-g*I%32;if(i<g){const a=n<<e>>>32-i,s=t<<32-i>>>32-i;n=t,c.push(a+s*2**(g-i)),i-=32-(g-i)}else c.push(n<<e>>>32-g),i-=g;0===i&&(i=32,n=t)}}else for(I=1;I<=f;I++){const e=32-g*I;c.push(u<<e>>>32-g)}}else{u-=i,a&&(u=0);for(let n=u;n<u+d;n+=h){switch(l){case 1:case 2:w=new DataView(e,n,1).getUint8(0);break;case 3:w=new DataView(e,n,2).getUint16(0,t);break;case 4:w=new DataView(e,n,4).getUint32(0,t);break;case 5:w=new DataView(e,n,4).getUint32(0,t)/new DataView(e,n+4,4).getUint32(0,t);break;case 6:w=new DataView(e,n,1).getInt8(0);break;case 7:w=new DataView(e,n,1).getUint8(0);break;case 8:w=new DataView(e,n,2).getInt16(0,t);break;case 9:w=new DataView(e,n,4).getInt32(0,t);break;case 10:w=new DataView(e,n,4).getInt32(0,t)/new DataView(e,n+4,4).getInt32(0,t);break;case 11:w=new DataView(e,n,4).getFloat32(0,t);break;case 12:w=new DataView(e,n,8).getFloat64(0,t);break;case 16:case 18:w=m(new DataView(e,n,8),0,t);break;case 17:w=b(new DataView(e,n,8),0,t);break;default:w=null}c.push(w)}}if(2===l){let e="";const t=c;for(c=[],I=0;I<t.length;I++)0===t[I]&&""!==e?(c.push(e),e=""):e+=String.fromCharCode(t[I]);""===e&&0!==c.length||c.push(e)}return n.values=c,!0}function A(e){const t=e[0],n=g(t,"TILEWIDTH"),i=g(t,"TILELENGTH"),a=g(t,"IMAGEWIDTH"),s=g(t,"IMAGELENGTH"),l=g(t,"BITSPERSAMPLE"),r=g(t,"SAMPLESPERPIXEL"),o=g(t,"SAMPLEFORMAT")||1,u=f(o,l),d=!!h(t,"PLANARCONFIGURATION")&&2===h(t,"PLANARCONFIGURATION")[0],p=h(t,"GDAL_NODATA");let w;null!=p&&("string"==typeof p[0]?(w=p.map((e=>parseFloat(e))),w.some((e=>isNaN(e)))&&(w=null)):"number"==typeof p[0]&&(w=p));const I=g(t,"COMPRESSION")||1;let T;switch(I){case 1:T="NONE";break;case 2:case 3:case 4:case 32771:T="CCITT";break;case 5:T="LZW";break;case 6:case 7:T="JPEG";break;case 32773:T="PACKBITS";break;case 8:case 32946:T="DEFLATE";break;case 34712:T="JPEG2000";break;default:T=String(I)}let y=!0,A="";1!==I&&5!==I&&6!==I&&8!==I&&32946!==I&&(y=!1,A+="unsupported tag compression "+I),o>3&&(y=!1,A+="unsupported tag sampleFormat "+o),l%8!=0&&(y=!1,A+="unsupported tag bitsPerSample "+l);const S=g(t,"GEOASCIIPARAMS");let m;if(S){const e=S.split("|").filter((e=>e.indexOf("ESRI PE String = ")>-1))[0],t=e?e.replace("ESRI PE String = ",""):"";m=0===t.indexOf("PROJCS")||0===t.indexOf("GEOGCS")?{wkid:null,wkt:t}:null}const b=h(t,"GEOTIEPOINTS"),M=h(t,"GEOPIXELSCALE"),x=h(t,"GEOTRANSMATRIX"),O=t.has("GEOKEYDIRECTORY")?t.get("GEOKEYDIRECTORY").data:null;let U,P,L=!1;if(O){L=2===g(O,"GTRasterTypeGeoKey");const e=g(O,"GTModelTypeGeoKey");if(2===e){const e=g(O,"GeographicTypeGeoKey");e>=1024&&e<=32766&&(m={wkid:e})}else if(1===e){const e=g(O,"ProjectedCSTypeGeoKey");e>=1024&&e<=32766&&(m={wkid:e})}}if(M&&b&&b.length>=6?(U=[M[0],0,b[3]-b[0]*M[0],0,-Math.abs(M[1]),b[4]-b[1]*M[1]],L&&(U[2]-=.5*U[0]+.5*U[1],U[5]-=.5*U[3]+.5*U[4])):x&&16===x.length&&(U=L?[x[0],x[1],x[3]-.5*x[0],x[4],x[5],x[7]-.5*x[5]]:[x[0],x[1],x[3],x[4],x[5],x[7]]),U){const e=[{x:0,y:s},{x:0,y:0},{x:a,y:s},{x:a,y:0}];let t,n=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(let a=0;a<e.length;a++)t=c(e[a],U),n=t.x>n?n:t.x,l=t.x<l?l:t.x,i=t.y>i?i:t.y,r=t.y<r?r:t.y;P={xmin:n,xmax:l,ymin:i,ymax:r,spatialReference:m}}const N=e.filter((e=>1===g(e,"NEWSUBFILETYPE")));let k,G,F,R,C;N.length>0&&(k=Math.round(Math.log(a/g(N[0],"IMAGEWIDTH"))/Math.LN2),G=Math.round(Math.log(a/g(N[N.length-1],"IMAGEWIDTH"))/Math.LN2),F=g(N[N.length-1],"TILEWIDTH"),R=g(N[N.length-1],"TILEHEIGHT")),F=G>0?F||n:null,R=G>0?R||i:null,n&&(C=[{maxCol:Math.ceil(a/n)-1,maxRow:Math.ceil(s/i)-1,minRow:0,minCol:0}],N.forEach((e=>{C.push({maxCol:Math.ceil(g(e,"IMAGEWIDTH")/g(e,"TILEWIDTH"))-1,maxRow:Math.ceil(g(e,"IMAGELENGTH")/g(e,"TILELENGTH"))-1,minRow:0,minCol:0})})));const v=g(e[0],"GDAL_METADATA"),B=E(v);return A+=" "+D({width:a,height:s,tileWidth:n,tileHeight:i,planes:r,ifds:e}),{width:a,height:s,tileWidth:n,tileHeight:i,planes:r,isBSQ:d,pixelType:u,compression:T,noData:w,isSupported:y,message:A,extent:P,affine:M?null:U,firstPyramidLevel:k,maximumPyramidLevel:G,pyramidBlockWidth:F,pyramidBlockHeight:R,tileBoundary:C,metadata:B}}function S(e){const{littleEndian:t,isBigTiff:n,firstIFD:i}=x(e);let a=i;const l=[];do{const i=O(e,t,a,0,s.TIFF_TAGS,n?8:4);if(!i.success)break;l.push(i.ifd),a=i.nextIFD}while(a>0);return{...A(l),littleEndian:t,isBigTiff:n,ifds:l}}function m(e,t,n){const i=e.getUint32(t,n),a=e.getUint32(t+4,n);return n?a*o+i:i*o+a}function b(e,t,n){let i=n?e.getInt32(t,n):e.getUint32(t,n),a=n?e.getUint32(t+4,n):e.getInt32(t+4,n);const s=(n?i:a)>=0?1:-1;n?i*=s:a*=s;return s*(n?a*o+i:i*o+a)}function M(e,t,n,i){return i?m(e,t,n):e.getUint32(t,n)}function x(e){const t=new DataView(e,0,16),n=t.getUint16(0,!1);let i=null;if(18761===n)i=!0;else{if(19789!==n)throw"unexpected endianess byte";i=!1}const a=t.getUint16(2,i);if(42!==a&&43!==a)throw"unexpected tiff identifier";let s=4;const l=43===a;if(l){const e=t.getUint16(s,i);if(s+=2,8!==e)throw"unsupported bigtiff version";if(0!==t.getUint16(s,i))throw"unsupported bigtiff version";s+=2}return{littleEndian:i,isBigTiff:l,firstIFD:M(t,s,i,l)}}function O(e,t,n,a=0,l=s.TIFF_TAGS,r=4){const o=d(e,t,n,a,l,r);let f;const u=o.ifd;if(u){if(s.ifdTags.forEach(((n,i)=>{u.has(i)&&(f=u.get(i),f.data=d(e,t,f.valueOffset-a,a,n).ifd)})),u.has("GEOKEYDIRECTORY")){f=u.get("GEOKEYDIRECTORY");const n=f.values;if(n&&n.length>4){const i=n[0]+"."+n[1]+"."+n[2];f.data=d(e,t,f.valueOffset+6-a,a,s.GEO_KEYS,2).ifd,f.data&&f.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[i]})}}if(u.has("XMP")){f=u.get("XMP");const e=f.values;"number"==typeof e[0]&&7===f.type&&(f.values=[i.bytesToUTF8(new Uint8Array(e))])}}return o}function D(e){const{width:t,height:n,tileHeight:i,tileWidth:a}=e,s=e.planes,l=a?a*i:t*n,r=h(e.ifds[0],"BITSPERSAMPLE")[0];let o="";return l*s>2**30/(r>8?r/8:1)&&(o=a?"tiled tiff exceeding 1 gigabits per tile is not supported":"scanline tiff exceeding 1 gigabits is not supported"),o}function U(e,t){const{headerInfo:n,ifd:i}=t,a=p(e,n.littleEndian,i,t.offset||0,t.size||e.byteLength),{pixelType:s,isBSQ:l,planes:r}=n,o=u(s),f=a.length/r;let c;const h=[];for(let u=0;u<r;u++){if(c=new o(f),l)c=a.slice(f*u,f*(u+1));else for(let e=0;e<f;e++)c[e]=a[e*r+u];h.push(c)}const d=g(i,"TILEWIDTH"),w=g(i,"TILELENGTH"),I=n.noData?n.noData[0]:null,E=n.metadata?n.metadata.statistics:null,y=E?E.map((e=>e.min)):null,A=E?E.map((e=>e.max)):null;let S,m;if(null!=I)if(S=new Uint8Array(f),Math.abs(I)>1e24)for(m=0;m<f;m++)Math.abs((h[0][m]-I)/I)<1e-6?S[m]=0:S[m]=1;else for(m=0;m<f;m++)h[0][m]===I?S[m]=0:S[m]=1;else y&&A&&t.applyMinMaxConstraint&&(S=T(h,y,A));return{pixelType:s,width:d,height:w,pixels:h,mask:S,noDataValue:I}}function P(e,t){t=t||S(e);const{ifds:n,noData:i}=t;if(0===n.length)throw"no valid image file directory";const a=D(t);if(a)throw a;let s,l;const r=n[0],o=i?i[0]:null;if(l=t.tileWidth?w(e,t,r):I(e,t,r),null!==o){if(l.mask=new Uint8Array(l.width*l.height),Math.abs(o)>1e24)for(s=0;s<l.width*l.height;s++)Math.abs((l.pixels[0][s]-o)/o)<1e-6?l.mask[s]=0:l.mask[s]=1;else for(s=0;s<l.width*l.height;s++)l.pixels[0][s]===o?l.mask[s]=0:l.mask[s]=1;l.noDataValue=o}return l}e.decode=P,e.decodeTileOrStrip=U,e.getImageInfo=A,e.parseFieldValues=y,e.parseHeader=S,e.parseIFD=O,e.parseSignature=x,Object.defineProperty(e,"__esModule",{value:!0})}));
