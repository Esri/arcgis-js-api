/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/Zlib","../../../chunks/Jpg","../rasterDatasets/byteStreamUtils","./Lzw","./TiffTags","./utils"],(function(e,t,n,a,i,s,l){"use strict";const r=[0,1,1,2,4,8,1,1,2,4,8,4,8,-1,-1,-1,8,8,8],o=4294967296;function f(e,t){let n="unknown";return 3===e?n="f32":1===e?1===t?n="u1":2===t?n="u2":4===t?n="u4":t<=8?n="u8":t<=16?n="u16":t<=32&&(n="u32"):2===e&&(t<=8?n="s8":t<=16?n="s16":t<=32&&(n="s32")),n}function u(e){let t=null;switch(e?e.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":t=Uint8Array;break;case"u16":t=Uint16Array;break;case"u32":t=Uint32Array;break;case"s8":t=Int8Array;break;case"s16":t=Int16Array;break;case"s32":t=Int32Array;break;default:t=Float32Array}return t}function c(e,t){return{x:t[0]*e.x+t[1]*e.y+t[2],y:t[3]*e.x+t[4]*e.y+t[5]}}function h(e,t){const n=e.get(t);return n&&n.values}function g(e,t){const n=e.get(t);return n&&n.values[0]}function w(e,t,n,a=0,i=s.TIFF_TAGS,l=4){const r=8===l,o=r?E(new DataView(e,n,8),0,t):new DataView(e,n,2).getUint16(0,t),f=4+2*l,u=r?8:2,c=u+o*f;if(n+c>e.byteLength)return{success:!1,ifd:null,nextIFD:null,requiredBufferSize:c};const h=n+c+4<=e.byteLength?A(new DataView(e,n+c,8===l?8:4),0,t,8===l):null,g=n+u,w=new Map;let d,I,T,y,S,m,M;for(let n=0;n<o;n++)I=new DataView(e,g+f*n,f),T=I.getUint16(0,t),S=I.getUint16(2,t),y=s.getTagName(T,i),2===l?(m=I.getUint16(4,t),M=I.getUint16(6,t)):4===l?(m=I.getUint32(4,t),M=I.getUint32(8,t)):8===l&&(m=A(I,4,t,!0),M=A(I,12,t,!0)),d={id:T,type:S,valueCount:m,valueOffset:M,values:null},p(e,t,d,a,!1,l),w.set(y,d);return{success:!0,ifd:w,nextIFD:h,requiredBufferSize:c}}const d=function(e,a,s,r,o){const c=l.isPlatformLittleEndian===a,h=g(s,"BITSPERSAMPLE"),w=f(g(s,"SAMPLEFORMAT")||1,h),d=g(s,"COMPRESSION")||1,p=u(w);let I,T,E,y,A,S,m;if(1===d)E=e.slice(r,r+o),y=new Uint8Array(E);else if(8===d||32946===d)y=new Uint8Array(e,r,o),S=new t.Zlib(y),m=S.getBytes(),E=new ArrayBuffer(m.length),y=new Uint8Array(E),y.set(m);else if(6===d){y=new Uint8Array(e,r,o);const t=new n.Jpg;t.parse(y);const a=t.getData(t.width,t.height,!0);E=new ArrayBuffer(a.length),y=new Uint8Array(E),y.set(a)}else 5===d&&(y=i.decode(e,r,o,a),E=y.buffer);if("u8"===w||"s8"===w||c)T=new p(E);else{switch(E=new ArrayBuffer(y.length),A=new Uint8Array(E),w){case"u16":case"s16":for(I=0;I<y.length;I+=2)A[I]=y[I+1],A[I+1]=y[I];break;case"u32":case"s32":case"f32":for(I=0;I<y.length;I+=4)A[I]=y[I+3],A[I+1]=y[I+2],A[I+2]=y[I+1],A[I+3]=y[I]}T=new p(E)}return T};function p(e,t,n,a=0,i=!1,s=4){if(n.values)return!0;const l=n.type,f=n.valueCount;let u=n.valueOffset,c=[];const h=r[l],g=8*h,w=f*h,d=f*r[l]*8;let p,I;const T=8===s?64:32;if(d>T){if(w>(i?e.byteLength:e?e.byteLength-u+a:0))return n.offlineOffsetSize=[u,w],n.values=null,!1}if(d<=T)if(t||(u>>>=32-d),1===f)c=[u];else if(64===T){const e=u>>>0,t=Math.round((u-e)/o);let n=e,a=32;for(I=1;I<=f;I++){const e=32-g*I%32;if(a<g){const i=n<<e>>>32-a,s=t<<32-a>>>32-a;n=t,c.push(i+s*Math.pow(2,g-a)),a-=32-(g-a)}else c.push(n<<e>>>32-g),a-=g;0===a&&(a=32,n=t)}}else for(I=1;I<=f;I++){const e=32-g*I;c.push(u<<e>>>32-g)}else{u-=a,i&&(u=0);for(let n=u;n<u+w;n+=h){switch(l){case 1:case 2:p=new DataView(e,n,1).getUint8(0);break;case 3:p=new DataView(e,n,2).getUint16(0,t);break;case 4:p=new DataView(e,n,4).getUint32(0,t);break;case 5:p=new DataView(e,n,4).getUint32(0,t)/new DataView(e,n+4,4).getUint32(0,t);break;case 6:p=new DataView(e,n,1).getInt8(0);break;case 7:p=new DataView(e,n,1).getUint8(0);break;case 8:p=new DataView(e,n,2).getInt16(0,t);break;case 9:p=new DataView(e,n,4).getInt32(0,t);break;case 10:p=new DataView(e,n,4).getInt32(0,t)/new DataView(e,n+4,4).getInt32(0,t);break;case 11:p=new DataView(e,n,4).getFloat32(0,t);break;case 12:p=new DataView(e,n,8).getFloat64(0,t);break;case 16:case 18:p=E(new DataView(e,n,8),0,t);break;case 17:p=y(new DataView(e,n,8),0,t);break;default:p=null}c.push(p)}}if(2===l){let e="";const t=c;for(c=[],I=0;I<t.length;I++)0===t[I]&&""!==e?(c.push(e),e=""):e+=String.fromCharCode(t[I]);""===e&&0!==c.length||c.push(e)}return n.values=c,!0}function I(e){const t=e[0],n=g(t,"TILEWIDTH"),a=g(t,"TILELENGTH"),i=g(t,"IMAGEWIDTH"),s=g(t,"IMAGELENGTH"),l=g(t,"BITSPERSAMPLE"),r=g(t,"SAMPLESPERPIXEL"),o=g(t,"SAMPLEFORMAT")||1,u=f(o,l),w=!!h(t,"PLANARCONFIGURATION")&&2===h(t,"PLANARCONFIGURATION")[0],d=h(t,"GDAL_NODATA");let p;null!=d&&("string"==typeof d[0]?(p=d.map((e=>parseFloat(e))),p.some((e=>isNaN(e)))&&(p=null)):"number"==typeof d[0]&&(p=d));const I=g(t,"COMPRESSION")||1;let T;switch(I){case 1:T="NONE";break;case 2:case 3:case 4:case 32771:T="CCITT";break;case 5:T="LZW";break;case 6:case 7:T="JPEG";break;case 32773:T="PACKBITS";break;case 8:case 32946:T="DEFLATE";break;case 34712:T="JPEG2000";break;default:T=String(I)}let E=!0,y="";1!==I&&5!==I&&6!==I&&8!==I&&32946!==I&&(E=!1,y+="unsupported tag compression "+I),o>3&&(E=!1,y+="unsupported tag sampleFormat "+o),l%8!=0&&(E=!1,y+="unsupported tag bitsPerSample "+l);const A=g(t,"GEOASCIIPARAMS");let S;if(A){const e=A.split("|").filter((e=>e.indexOf("ESRI PE String = ")>-1))[0],t=e?e.replace("ESRI PE String = ",""):"";S=0===t.indexOf("PROJCS")||0===t.indexOf("GEOGCS")?{wkid:null,wkt:t}:null}const m=h(t,"GEOTIEPOINTS"),M=h(t,"GEOPIXELSCALE"),b=h(t,"GEOTRANSMATRIX"),x=t.has("GEOKEYDIRECTORY")?t.get("GEOKEYDIRECTORY").data:null;let O,D,U=!1;if(x){U=2===g(x,"GTRasterTypeGeoKey");const e=g(x,"GTModelTypeGeoKey");if(2===e){const e=g(x,"GeographicTypeGeoKey");e>=1024&&e<=32766&&(S={wkid:e})}else if(1===e){const e=g(x,"ProjectedCSTypeGeoKey");e>=1024&&e<=32766&&(S={wkid:e})}}if(M&&m&&m.length>=6?(O=[M[0],0,m[3]-m[0]*M[0],0,-Math.abs(M[1]),m[4]-m[1]*M[1]],U&&(O[2]-=.5*O[0]+.5*O[1],O[5]-=.5*O[3]+.5*O[4])):b&&16===b.length&&(O=[b[0],b[1],b[3],b[4],b[5],b[7]]),O){const e=[{x:0,y:s},{x:0,y:0},{x:i,y:s},{x:i,y:0}];let t,n=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(let i=0;i<e.length;i++)t=c(e[i],O),n=t.x>n?n:t.x,l=t.x<l?l:t.x,a=t.y>a?a:t.y,r=t.y<r?r:t.y;D={xmin:n,xmax:l,ymin:a,ymax:r,spatialReference:S}}const N=e.filter((e=>1===g(e,"NEWSUBFILETYPE")));let L,P,k,G,F;N.length>0&&(L=Math.round(Math.log(i/g(N[0],"IMAGEWIDTH"))/Math.LN2),P=Math.round(Math.log(i/g(N[N.length-1],"IMAGEWIDTH"))/Math.LN2),k=g(N[N.length-1],"TILEWIDTH"),G=g(N[N.length-1],"TILEHEIGHT")),k=P>0?k||n:null,G=P>0?G||a:null,n&&(F=[{maxCol:Math.ceil(i/n)-1,maxRow:Math.ceil(s/a)-1,minRow:0,minCol:0}],N.forEach((e=>{F.push({maxCol:Math.ceil(g(e,"IMAGEWIDTH")/g(e,"TILEWIDTH"))-1,maxRow:Math.ceil(g(e,"IMAGELENGTH")/g(e,"TILELENGTH"))-1,minRow:0,minCol:0})})));const R=function(e){if(!e)return null;const t=e.match(/<Item(.*?)Item>/gi);if(!t||0===t.length)return null;const n=new Map;let a,i,s,l,r;for(let e=0;e<t.length;e++)a=t[e],i=a.slice("<Item ".length,a.indexOf(">")),l=a.indexOf("sample="),l>-1&&(r=a.slice(l+'sample="'.length,a.indexOf('"',l+'sample="'.length))),l=a.indexOf("name="),l>-1&&(i=a.slice(l+'name="'.length,a.indexOf('"',l+'name="'.length))),i&&(s=a.slice(a.indexOf(">")+1,a.indexOf("</Item>")).trim(),null!=r?n.has(i)?n.get(i)[r]=s:n.set(i,[s]):n.set(i,s)),r=null;const o=n.get("STATISTICS_MINIMUM"),f=n.get("STATISTICS_MAXIMUM"),u=n.get("STATISTICS_MEAN"),c=n.get("STATISTICS_STDDEV");let h=null;if(o&&f){h=[];for(let e=0;e<o.length;e++)h.push({min:parseFloat(o[e]),max:parseFloat(f[e]),avg:u&&parseFloat(u[e]),stddev:c&&parseFloat(c[e])})}const g=n.get("BandName"),w=n.get("WavelengthMin"),d=n.get("WavelengthMax");let p=null;if(g){p=[];for(let e=0;e<g.length;e++)p.push({BandName:g[e],WavelengthMin:w&&parseFloat(w[e]),WavelengthMax:d&&parseFloat(d[e])})}return{statistics:h,bandProperties:p,dataType:n.get("DataType"),rawMetadata:n}}(g(e[0],"GDAL_METADATA"));return{width:i,height:s,tileWidth:n,tileHeight:a,planes:r,isBSQ:w,pixelType:u,compression:T,noData:p,isSupported:E,message:y,extent:D,firstPyramidLevel:L,maximumPyramidLevel:P,pyramidBlockWidth:k,pyramidBlockHeight:G,tileBoundary:F,metadata:R}}function T(e){const{littleEndian:t,isBigTiff:n,firstIFD:a}=S(e);let i=a;const l=[];do{const a=m(e,t,i,0,s.TIFF_TAGS,n?8:4);if(!a.success)break;l.push(a.ifd),i=a.nextIFD}while(i>0);return{...I(l),littleEndian:t,isBigTiff:n,ifds:l}}function E(e,t,n){const a=e.getUint32(t,n),i=e.getUint32(t+4,n);return n?i*o+a:a*o+i}function y(e,t,n){let a=n?e.getInt32(t,n):e.getUint32(t,n),i=n?e.getUint32(t+4,n):e.getInt32(t+4,n);const s=(n?a:i)>=0?1:-1;n?a*=s:i*=s;return s*(n?i*o+a:a*o+i)}function A(e,t,n,a){return a?E(e,t,n):e.getUint32(t,n)}function S(e){const t=new DataView(e,0,16),n=t.getUint16(0,!1);let a=null;if(18761===n)a=!0;else{if(19789!==n)throw"unexpected endianess byte";a=!1}const i=t.getUint16(2,a);if(42!==i&&43!==i)throw"unexpected tiff identifier";let s=4;const l=43===i;if(l){const e=t.getUint16(s,a);if(s+=2,8!==e)throw"unsupported bigtiff version";if(0!==t.getUint16(s,a))throw"unsupported bigtiff version";s+=2}return{littleEndian:a,isBigTiff:l,firstIFD:A(t,s,a,l)}}function m(e,t,n,i=0,l=s.TIFF_TAGS,r=4){const o=w(e,t,n,i,l,r);let f;const u=o.ifd;if(u){if(s.ifdTags.forEach(((n,a)=>{u.has(a)&&(f=u.get(a),f.data=w(e,t,f.valueOffset-i,i,n).ifd)})),u.has("GEOKEYDIRECTORY")){f=u.get("GEOKEYDIRECTORY");const n=f.values;if(n&&n.length>4){const a=n[0]+"."+n[1]+"."+n[2];f.data=w(e,t,f.valueOffset+6-i,i,s.GEO_KEYS,2).ifd,f.data&&f.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[a]})}}if(u.has("XMP")){f=u.get("XMP");const e=f.values;"number"==typeof e[0]&&7===f.type&&(f.values=[a.bytesToUTF8(new Uint8Array(e))])}}return o}e.decode=function(e,a){a=a||T(e);const{ifds:i,noData:s}=a;if(0===i.length)throw"no valid image file directory";let r,o;const f=i[0],c=s?s[0]:null;if(o=a.tileWidth?function(e,t,n){const a=h(n,"TILEOFFSETS");if(void 0===a)return null;const i=h(n,"TILEBYTECOUNTS"),s=t.tileWidth,l=t.tileHeight,{width:r,height:o,pixelType:f,isBSQ:c}=t,g=t.planes,w=r*o,p=h(n,"BITSPERSAMPLE")[0],I=u(f),T=[];for(let e=0;e<g;e++)T.push(new I(w));let E,y,A,S,m,M,b,x,O,D,U,N,L;const P=Math.ceil(r/s);if(p%8==0)for(E=0;E<a.length;E++)for(M=Math.floor(E/P)*l,b=E%P*s,x=M*r+b,A=d(e,t.littleEndian,n,a[E],i[E]),D=0,O=x,N=Math.min(s,r-b),U=Math.min(l,o-M),y=0;y<g;y++)if(L=T[y],c)for(S=0;S<U;S++)for(O=x+S*r,D=s*l*y+S*s,m=0;m<N;m++,O++,D++)L[O]=A[D];else for(S=0;S<U;S++)for(O=x+S*r,D=S*s*g+y,m=0;m<N;m++,O++,D+=g)L[O]=A[D];return{width:r,height:o,pixelType:f,pixels:T}}(e,a,f):function(e,a,i){const s=l.isPlatformLittleEndian===a.littleEndian,r=h(i,"STRIPOFFSETS");if(void 0===r)return null;const{width:o,height:f,pixelType:c}=a,g=a.planes,w=o*f,d=h(i,"BITSPERSAMPLE")[0],p=u(c),I=new p(w*g),T=h(i,"STRIPBYTECOUNTS"),E=h(i,"ROWSPERSTRIP")[0],y=h(i,"COMPRESSION")?h(i,"COMPRESSION")[0]:1;let A,S,m,M,b,x,O,D,U,N,L,P=E;if(d%8==0)for(A=0;A<r.length;A++){if(b=A*(E*o)*g,P=(A+1)*E>f?f-A*E:E,"u8"===c||"s8"===c||s){if(8===y||32946===y)O=new Uint8Array(e,r[A],T[A]),N=new t.Zlib(O),L=N.getBytes(),x=new ArrayBuffer(L.length),O=new Uint8Array(x),O.set(L),O.length!==P*o*g*d/8&&console.log("strip byte counts is different than expected");else if(6===y){O=new Uint8Array(e,r[A],T[A]);const t=new n.Jpg;t.parse(O);const a=t.getData(t.width,t.height,!0);x=new ArrayBuffer(a.length),O=new Uint8Array(x),O.set(a)}else 1===y&&(T[A]!==P*o*g*d/8&&console.log("strip byte counts is different than expected"),x=e.slice(r[A],r[A]+T[A]));M=new p(x)}else{switch(6===y||8===y||32946===y?(O=new Uint8Array(e,r[A],T[A]),N=new t.Zlib(O),O=N.getBytes(),x=new ArrayBuffer(O.length),D=new Uint8Array(x),O.length!==P*o*g*d/8&&console.log("strip byte counts is different than expected")):1===y&&(T[A]!==P*o*g*d/8&&console.log("strip byte counts is different than expected"),x=new ArrayBuffer(T[A]),O=new Uint8Array(e,r[A],T[A]),D=new Uint8Array(x)),c){case"u16":case"s16":for(m=0;m<O.length;m+=2)D[m]=O[m+1],D[m+1]=O[m];break;case"u32":case"s32":case"f32":for(m=0;m<O.length;m+=4)D[m]=O[m+3],D[m+1]=O[m+2],D[m+2]=O[m+1],D[m+3]=O[m]}M=new p(x)}I.set(M,b)}const k=[];if(1===g)k.push(I);else for(A=0;A<g;A++){for(U=new p(w),S=0;S<w;S++)U[S]=I[S*g+A];k.push(U)}return{width:o,height:f,pixelType:c,pixels:k}}(e,a,f),null!==c){if(o.mask=new Uint8Array(o.width*o.height),Math.abs(c)>1e24)for(r=0;r<o.width*o.height;r++)Math.abs((o.pixels[0][r]-c)/c)<1e-6?o.mask[r]=0:o.mask[r]=1;else for(r=0;r<o.width*o.height;r++)o.pixels[0][r]===c?o.mask[r]=0:o.mask[r]=1;o.noDataValue=c}return o},e.decodeTileOrStrip=function(e,t){const{headerInfo:n,ifd:a}=t,i=d(e,n.littleEndian,a,t.offset||0,t.size||e.byteLength),{pixelType:s,isBSQ:l,planes:r}=n,o=u(s),f=i.length/r;let c;const h=[];for(let e=0;e<r;e++){if(c=new o(f),l)c=i.slice(f*e,f*(e+1));else for(let t=0;t<f;t++)c[t]=i[t*r+e];h.push(c)}const w=g(a,"TILEWIDTH"),p=g(a,"TILELENGTH"),I=n.noData?n.noData[0]:null,T=n.metadata?n.metadata.statistics:null,E=T?T.map((e=>e.min)):null,y=T?T.map((e=>e.max)):null;let A,S;if(null!=I)if(A=new Uint8Array(f),Math.abs(I)>1e24)for(S=0;S<f;S++)Math.abs((h[0][S]-I)/I)<1e-6?A[S]=0:A[S]=1;else for(S=0;S<f;S++)h[0][S]===I?A[S]=0:A[S]=1;else E&&y&&t.applyMinMaxConstraint&&(A=function(e,t,n){if(!(e&&e.length>0&&t&&n))return null;let a,i,s;const l=e[0].length,r=e.length,o=new Uint8Array(l);for(let f=0;f<r;f++)if(a=e[f],i=t[f],s=n[f],0===f)for(let e=0;e<l;e++)o[e]=a[e]<i||a[e]>s?0:1;else for(let e=0;e<l;e++)o[e]&&(o[e]=a[e]<i||a[e]>s?0:1);return o}(h,E,y));return{pixelType:s,width:w,height:p,pixels:h,mask:A,noDataValue:I}},e.getImageInfo=I,e.parseFieldValues=p,e.parseHeader=T,e.parseIFD=m,e.parseSignature=S,Object.defineProperty(e,"__esModule",{value:!0})}));
