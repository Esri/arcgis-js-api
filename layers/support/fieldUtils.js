/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../core/object","../../core/maybe","../../core/Error","./domains","../../support/arcadeOnDemand"],(function(e,n,i,t,r,l,o){"use strict";const a=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],s=["field","normalizationField"];function u(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(d(a,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)d(s,e,n)}function d(e,n,t){if(e)for(const r of e){const e=i.getDeepValue(r,n),l=e&&"function"!=typeof e&&I(t,e);l&&i.setDeepValue(r,l.name,n)}}function c(e,n){if(null!=e&&null!=n)if("startField"in e){const i=I(n,e.startField),t=I(n,e.endField);e.startField=i&&i.name||null,e.endField=t&&t.name||null}else{const i=I(n,e.startTimeField),t=I(n,e.endTimeField);e.startTimeField=i&&i.name||null,e.endTimeField=t&&t.name||null}}const f=new Set;function m(e,n){return e&&n?(f.clear(),F(f,e,n),Array.from(f).sort()):[]}function F(e,n,i){if(i)if(n&&n.length)if(i.includes("*"))for(const{name:t}of n)e.add(t);else for(const t of i)g(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)e.add(n)}}function g(e,n,i){if(n&&n.length){const t=I(n,i);t&&e.add(t.name)}else"string"==typeof i&&e.add(i)}function p(e,n){return t.isNone(n)||t.isNone(e)?[]:n.includes("*")?e.map((e=>e.name)):n}function y(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=m(e,n);return t.length/e.length>=i?["*"]:t}function I(e,n){if("string"!=typeof n)return null;if(null!=e){n=n.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===n)return i}return null}function b(e,n){if(!e||!n||"string"!=typeof n)return!1;n=n.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===n)return!0;return!1}async function T(e,n,i){if(!i)return;const{arcadeUtils:t}=await o.loadArcade(),r=t.extractFieldNames(i);for(const l of r)g(e,n,l)}function V({displayField:e,fields:n}){return e||(n&&n.length?E(n,"name-or-title")||E(n,"unique-identifier")||E(n,"type-or-category")||h(n):null)}function h(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.indexOf("name")>-1||e.indexOf("title")>-1)return n.name}return null}function E(e,n){for(const i of e)if(i&&i.valueType&&i.valueType===n)return i.name;return null}async function N(e){if(!e)return[];const n=new Set;return await S(n,e),Array.from(n).sort()}async function S(e,n){if(!n)return;const{fields:t}=n,r=i.getDeepValue("elevationInfo.featureExpressionInfo",n);return r?r.collectRequiredFields(e,t):void 0}async function w(e,n,i){i.outStatistic.onStatisticValueExpression?T(e,n,i.outStatistic.onStatisticValueExpression):e.add(i.outStatistic.onStatisticField)}async function v(e,n,i){n&&i&&"cluster"===i.type&&i.fields&&await Promise.all(i.fields.map((i=>w(e,n.fields,i))))}async function x(n,i,l){if(i&&(i.timeInfo&&t.isSome(l)&&l.timeExtent&&F(n,i.fields,[i.timeInfo.startField,i.timeInfo.endField]),i.floorInfo&&F(n,i.fields,[i.floorInfo.floorField]),t.isSome(l)&&t.isSome(l.where)&&l.where&&"1=1"!==l.where)){const t=(await new Promise((function(n,i){e(["../../core/sql/WhereClause"],n,i)}))).WhereClause.create(l.where,i.fieldsIndex);if(!t.isStandardized)throw new r("fieldUtils:collectFilterFields","Where clause is not standardized");F(n,i.fields,t.fieldNames)}}async function D(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?m(e.fields,[e.trackIdField,n.startField,n.endField]):[]}function A(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;return n?m(e.fields,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function L(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?m(e.fields,[n.shapeAreaField,n.shapeLengthField]):[]}async function R(e){if(!e)return[];const n=new Set;return await _(n,e),Array.from(n).sort()}async function _(e,n){const{labelingInfo:i,fields:t}=n;i&&i.length&&await Promise.all(i.map((n=>O(e,t,n))))}async function O(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)await T(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{g(e,n,i.slice(1,-1))}))}const l=/['"]+/g;if(r){const i=r.split(" ");3===i.length&&g(e,n,i[0].replace(l,"")),7===i.length&&(g(e,n,i[0].replace(l,"")),g(e,n,i[4].replace(l,"")))}}function $(e){const n=e.defaultValue;return void 0!==n&&q(e,n)?n:e.nullable?null:void 0}function U(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function C(e){return null===e||U(e)}const k="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function z(e){return null===e||k(e)}function P(e){return null!=e&&"string"==typeof e}function M(e){return null===e||P(e)}function G(){return!0}function q(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?z:k;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?C:U;break;case"string":case"esriFieldTypeString":i=e.nullable?M:P;break;default:i=G}return 1===arguments.length?i:i(n)}const W=["integer","small-integer","single","double"],Y=new Set([...W,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function j(e){return null!=e&&Y.has(e.type)}function J(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function X(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function H(e,n){return null===K(e,n)}function B(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function K(e,i){return e.nullable&&null===i?null:j(e)&&!Q(e.type,Number(i))?n.NumericRangeValidationError.OUT_OF_RANGE:q(e,i)?e.domain?l.validateDomainValue(e.domain,i):null:n.TypeValidationError.INVALID_TYPE}function Q(e,n){const i="string"==typeof e?ee(e):e;return!!i&&(i.isInteger?k(n)&&n>=i.min&&n<=i.max:n>=i.min&&n<=i.max)}function Z(e){const n=l.getDomainRange(e.domain);return n||(j(e)?ee(e.type):void 0)}function ee(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return ie;case"esriFieldTypeInteger":case"integer":return te;case"esriFieldTypeSingle":case"single":return re;case"esriFieldTypeDouble":case"double":return le}}function ne(e){if(!U(e))return null;if(k(e)){if(e>=ie.min&&e<=ie.max)return"esriFieldTypeSmallInteger";if(e>=te.min&&e<=te.max)return"esriFieldTypeInteger"}return e>=re.min&&e<=re.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}(n.NumericRangeValidationError||(n.NumericRangeValidationError={})).OUT_OF_RANGE="numeric-range-validation-error::out-of-range",(n.TypeValidationError||(n.TypeValidationError={})).INVALID_TYPE="type-validation-error::invalid-type";const ie={min:-32768,max:32767,isInteger:!0},te={min:-2147483648,max:2147483647,isInteger:!0},re={min:-34e37,max:12e37,isInteger:!1},le={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function oe(e,i,t){switch(e){case l.DomainValidationError.INVALID_CODED_VALUE:return`Value ${t} is not in the coded domain - field: ${i.name}, domain: ${JSON.stringify(i.domain)}`;case l.DomainValidationError.VALUE_OUT_OF_RANGE:return`Value ${t} is out of the range of valid values - field: ${i.name}, domain: ${JSON.stringify(i.domain)}`;case n.TypeValidationError.INVALID_TYPE:return`Value ${t} is not a valid value for the field type - field: ${i.name}, type: ${i.type}, nullable: ${i.nullable}`;case n.NumericRangeValidationError.OUT_OF_RANGE:{const{min:e,max:n}=ee(i.type);return`Value ${t} is out of range for the number type - field: ${i.name}, type: ${i.type}, value range is ${e} to ${n}`}}}function ae(e,n){return!se(e,n,null)}function se(e,n,i){if(!n||!n.attributes||!e){if(t.isSome(i))for(const n of e)i.add(n);return!0}const r=n.attributes;let l=!1;for(const o of e)if(!(o in r)){if(l=!0,!t.isSome(i))break;i.add(o)}return l}async function ue(e,n){const i=new Set;for(const t of n)await T(i,e.fields,t);return Array.from(i).sort()}n.collectArcadeFieldNames=T,n.collectElevationFields=S,n.collectFeatureReductionFields=v,n.collectField=g,n.collectFields=F,n.collectFilterFields=x,n.collectLabelingFields=_,n.doubleRange=le,n.featureHasFields=ae,n.fixFields=m,n.fixRendererFields=u,n.fixTimeInfoFields=c,n.getDisplayFieldName=V,n.getElevationFields=N,n.getExpressionFields=ue,n.getFeatureEditFields=A,n.getFeatureGeometryFields=L,n.getField=I,n.getFieldDefaultValue=$,n.getFieldRange=Z,n.getLabelingFields=R,n.getNumericTypeForValue=ne,n.getTimeFields=D,n.hasField=b,n.integerRange=te,n.isDateField=X,n.isNumberInRange=Q,n.isNumericField=j,n.isStringField=J,n.isValidFieldValue=H,n.isValueMatchingFieldType=q,n.numericTypes=W,n.packFields=y,n.populateMissingFields=se,n.rendererFields=a,n.sanitizeNullFieldValue=B,n.singleRange=re,n.smallIntegerRange=ie,n.unpackFieldNames=p,n.validateFieldValue=K,n.validationErrorToString=oe,n.visualVariableFields=s,Object.defineProperty(n,"__esModule",{value:!0})}));
