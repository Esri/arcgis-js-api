/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","../../core/object","./domainUtils","../../support/arcadeOnDemand"],(function(e,n,i,t,r,l,o,a){"use strict";const s=/^([0-9])/,u=/[^A-Za-z0-9_\u0080-\uffff]/g,d=/_{2,}/g,c=/^_/,f=/_$/;function p(e){return e?e.trim().replace(u,"_").replace(d,"_").replace(c,"").replace(f,"").replace(s,"F$1"):null}const y=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],m=["field","normalizationField"];function g(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(F(y,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)F(m,e,n)}function F(e,n,i){if(e)for(const t of e){const e=l.getDeepValue(t,n),r=e&&"function"!=typeof e&&i.get(e);r&&l.setDeepValue(t,r.name,n)}}function h(e,n){if(null!=e&&n?.fields?.length)if("startField"in e){const i=n.get(e.startField),t=n.get(e.endField);e.startField=i?.name??null,e.endField=t?.name??null}else{const i=n.get(e.startTimeField),t=n.get(e.endTimeField);e.startTimeField=i?.name??null,e.endTimeField=t?.name??null}}const I=new Set;function T(e,n){return e&&n?(I.clear(),x(I,e,n),Array.from(I).sort()):[]}function x(e,n,i){if(i)if(n?.fields?.length)if(i.includes("*"))for(const{name:t}of n.fields)e.add(t);else for(const t of i)b(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)null!=n&&e.add(n)}}function b(e,n,i){if("string"==typeof i)if(n){const t=n.get(i);t&&e.add(t.name)}else e.add(i)}function V(e,n){return r.isNone(n)||r.isNone(e)?[]:n.includes("*")?(e.fields??[]).map((e=>e.name)):n}function _(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=T(e,n);return t.length/e.fields.length>=i?["*"]:t}function E(e,n,i){return N.apply(this,arguments)}function N(){return(N=i._asyncToGenerator((function*(e,n,i){if(!i)return;const{arcadeUtils:t}=yield a.loadArcade(),r=t.extractFieldNames(i,n?.fields?.map((e=>e.name)));for(const l of r)b(e,n,l)}))).apply(this,arguments)}function v(e,n,i){return S.apply(this,arguments)}function S(){return(S=i._asyncToGenerator((function*(n,i,r){if(r&&"1=1"!==r){const l=(yield new Promise(((n,i)=>e(["../../core/sql/WhereClause"],n,i)))).WhereClause.create(r,i);if(!l.isStandardized)throw new t("fieldUtils:collectFilterFields","Where clause is not standardized",{where:r});x(n,i,l.fieldNames)}}))).apply(this,arguments)}function A({displayField:e,fields:n}){return e||(n&&n.length?G(n,"name-or-title")||G(n,"unique-identifier")||G(n,"type-or-category")||D(n):null)}function D(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.includes("name")||e.includes("title"))return n.name}return null}function G(e,n){for(const i of e)if(i&&i.valueType&&i.valueType===n)return i.name;return null}function R(e){return w.apply(this,arguments)}function w(){return(w=i._asyncToGenerator((function*(e){if(!e)return[];const n=new Set;return yield $(n,e),Array.from(n).sort()}))).apply(this,arguments)}function $(e,n){return L.apply(this,arguments)}function L(){return(L=i._asyncToGenerator((function*(e,n){if(!n)return;const i=l.getDeepValue("elevationInfo.featureExpressionInfo",n);return i?i.collectRequiredFields(e,n.fieldsIndex):void 0}))).apply(this,arguments)}function O(e,n,i){i.onStatisticExpression?E(e,n,i.onStatisticExpression.expression):e.add(i.onStatisticField)}function P(e,n,i){return U.apply(this,arguments)}function U(){return U=i._asyncToGenerator((function*(e,n,t){if(!n||!t||!("fields"in t))return;const r=[],l=t.popupTemplate;r.push(z(e,n,l)),t.fields&&r.push(...t.fields.map(function(){var t=i._asyncToGenerator((function*(i){return O(e,n.fieldsIndex,i)}));return function(e){return t.apply(this,arguments)}}())),yield Promise.all(r)})),U.apply(this,arguments)}function z(e,n,i){return k.apply(this,arguments)}function k(){return(k=i._asyncToGenerator((function*(e,n,i){const t=[];i?.expressionInfos&&t.push(...i.expressionInfos.map((i=>E(e,n.fieldsIndex,i.expression))));const r=i?.content;if(Array.isArray(r))for(const l of r)"expression"===l.type&&l.expressionInfo&&t.push(E(e,n.fieldsIndex,l.expressionInfo.expression));yield Promise.all(t)}))).apply(this,arguments)}function M(e,n,i){return C.apply(this,arguments)}function C(){return(C=i._asyncToGenerator((function*(e,n,i){n&&(n.timeInfo&&r.isSome(i)&&i.timeExtent&&x(e,n.fieldsIndex,[n.timeInfo.startField,n.timeInfo.endField]),n.floorInfo&&x(e,n.fieldsIndex,[n.floorInfo.floorField]),r.isSome(i)&&r.isSome(i.where)&&(yield v(e,n.fieldsIndex,i.where)))}))).apply(this,arguments)}function q(e,n,i){return W.apply(this,arguments)}function W(){return(W=i._asyncToGenerator((function*(e,n,i){n&&i&&(yield Promise.all(i.map((i=>Y(e,n,i)))))}))).apply(this,arguments)}function Y(e,n,i){return j.apply(this,arguments)}function j(){return(j=i._asyncToGenerator((function*(e,n,i){n&&i&&(i.valueExpression?yield E(e,n.fieldsIndex,i.valueExpression):i.field&&b(e,n.fieldsIndex,i.field))}))).apply(this,arguments)}function B(e){return H.apply(this,arguments)}function H(){return(H=i._asyncToGenerator((function*(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?T(e.fieldsIndex,[e.trackIdField,n.startField,n.endField]):[]}))).apply(this,arguments)}function J(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;return n?T(e.fieldsIndex,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function X(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?T(e.fieldsIndex,[n.shapeAreaField,n.shapeLengthField]):[]}function Z(e){return K.apply(this,arguments)}function K(){return(K=i._asyncToGenerator((function*(e){if(!e)return[];const n=new Set;return yield Q(n,e),Array.from(n).sort()}))).apply(this,arguments)}function Q(e,n){return ee.apply(this,arguments)}function ee(){return(ee=i._asyncToGenerator((function*(e,n){const{labelingInfo:i,fieldsIndex:t}=n;i&&i.length&&(yield Promise.all(i.map((n=>ne(e,t,n)))))}))).apply(this,arguments)}function ne(e,n,i){return ie.apply(this,arguments)}function ie(){return(ie=i._asyncToGenerator((function*(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)yield E(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{b(e,n,i.slice(1,-1))}))}yield v(e,n,r)}))).apply(this,arguments)}function te(e){const n=e.defaultValue;return void 0!==n&&ce(e,n)?n:e.nullable?null:void 0}function re(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function le(e){return null===e||re(e)}const oe="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function ae(e){return null===e||oe(e)}function se(e){return null!=e&&"string"==typeof e}function ue(e){return null===e||se(e)}function de(){return!0}function ce(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?ae:oe;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?le:re;break;case"string":case"esriFieldTypeString":i=e.nullable?ue:se;break;default:i=de}return 1===arguments.length?i:i(n)}const fe=["integer","small-integer","single","double"],pe=new Set([...fe,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function ye(e){return null!=e&&pe.has(e.type)}function me(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function ge(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function Fe(e,n){return null===Ie(e,n)}function he(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function Ie(e,i){return e.nullable&&null===i?null:ye(e)&&!Te(e.type,Number(i))?n.NumericRangeValidationError.OUT_OF_RANGE:ce(e,i)?e.domain?o.validateDomainValue(e.domain,i):null:n.TypeValidationError.INVALID_TYPE}function Te(e,n){const i="string"==typeof e?be(e):e;if(!i)return!1;const t=i.min,r=i.max;return i.isInteger?oe(n)&&n>=t&&n<=r:n>=t&&n<=r}function xe(e){const n=o.getDomainRange(e.domain);return n||(ye(e)?be(e.type):void 0)}function be(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return _e;case"esriFieldTypeInteger":case"integer":return Ee;case"esriFieldTypeSingle":case"single":return Ne;case"esriFieldTypeDouble":case"double":return ve}}function Ve(e){if(!re(e))return null;if(oe(e)){if(e>=_e.min&&e<=_e.max)return"esriFieldTypeSmallInteger";if(e>=Ee.min&&e<=Ee.max)return"esriFieldTypeInteger"}return e>=Ne.min&&e<=Ne.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}n.NumericRangeValidationError=void 0,(n.NumericRangeValidationError||(n.NumericRangeValidationError={})).OUT_OF_RANGE="numeric-range-validation-error::out-of-range",n.TypeValidationError=void 0,(n.TypeValidationError||(n.TypeValidationError={})).INVALID_TYPE="type-validation-error::invalid-type";const _e={min:-32768,max:32767,isInteger:!0},Ee={min:-2147483648,max:2147483647,isInteger:!0},Ne={min:-34e37,max:12e37,isInteger:!1},ve={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function Se(e,i,t){switch(e){case o.DomainValidationError.INVALID_CODED_VALUE:return`Value ${t} is not in the coded domain - field: ${i.name}, domain: ${JSON.stringify(i.domain)}`;case o.DomainValidationError.VALUE_OUT_OF_RANGE:return`Value ${t} is out of the range of valid values - field: ${i.name}, domain: ${JSON.stringify(i.domain)}`;case n.TypeValidationError.INVALID_TYPE:return`Value ${t} is not a valid value for the field type - field: ${i.name}, type: ${i.type}, nullable: ${i.nullable}`;case n.NumericRangeValidationError.OUT_OF_RANGE:{const{min:e,max:n}=be(i.type);return`Value ${t} is out of range for the number type - field: ${i.name}, type: ${i.type}, value range is ${e} to ${n}`}}}function Ae(e,n){return!De(e,n,null)}function De(e,n,i){if(!n||!n.attributes||!e){if(r.isSome(i))for(const n of e??[])i.add(n);return!0}const t=n.attributes;let l=!1;for(const o of e)if(!(o in t)){if(l=!0,!r.isSome(i))break;i.add(o)}return l}function Ge(e,n){return Re.apply(this,arguments)}function Re(){return(Re=i._asyncToGenerator((function*(e,n){const i=new Set;for(const t of n)yield E(i,e.fieldsIndex,t);return Array.from(i).sort()}))).apply(this,arguments)}function we(e){return["raster.itempixelvalue","raster.servicepixelvalue"].some((n=>e.toLowerCase().startsWith(n)))}n.collectArcadeFieldNames=E,n.collectElevationFields=$,n.collectFeatureReductionFields=P,n.collectField=b,n.collectFields=x,n.collectFilterFields=M,n.collectLabelingFields=Q,n.collectOrderByInfos=q,n.collectPopupTemplateFields=z,n.doubleRange=ve,n.featureHasFields=Ae,n.fixFields=T,n.fixRendererFields=g,n.fixTimeInfoFields=h,n.getDisplayFieldName=A,n.getElevationFields=R,n.getExpressionFields=Ge,n.getFeatureEditFields=J,n.getFeatureGeometryFields=X,n.getFieldDefaultValue=te,n.getFieldRange=xe,n.getLabelingFields=Z,n.getNumericTypeForValue=Ve,n.getTimeFields=B,n.integerRange=Ee,n.isDateField=ge,n.isNumberInRange=Te,n.isNumericField=ye,n.isRasterPixelValueField=we,n.isStringField=me,n.isValidFieldValue=Fe,n.isValueMatchingFieldType=ce,n.normalizeFieldName=p,n.numericTypes=fe,n.packFields=_,n.populateMissingFields=De,n.rendererFields=y,n.sanitizeNullFieldValue=he,n.singleRange=Ne,n.smallIntegerRange=_e,n.unpackFieldNames=V,n.validateFieldValue=Ie,n.validationErrorToString=Se,n.visualVariableFields=m,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
