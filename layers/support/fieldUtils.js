// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","@dojo/framework/shim/array","../../core/Error","../../core/maybe","../../core/object","../../core/promiseUtils","../../core/SetUtils","./domains","../../support/arcadeOnDemand","@dojo/framework/shim/Promise"],(function(e,i,n,r,t,l,a,s,o,u,d){"use strict";function c(e,i,n){if(e)for(var r=0,t=e;r<t.length;r++){var l=t[r],s=a.getDeepValue(l,i),o=s&&"function"!=typeof s&&v(n,s);o&&a.setDeepValue(l,o.name,i)}}Object.defineProperty(i,"__esModule",{value:!0}),i.getExpressionFields=i.populateMissingFields=i.featureHasFields=i.validationErrorToString=i.doubleRange=i.singleRange=i.integerRange=i.smallIntegerRange=i.getNumericTypeForValue=i.getFieldRange=i.isNumberInRange=i.validateFieldValue=i.sanitizeNullFieldValue=i.TypeValidationError=i.NumericRangeValidationError=i.isValidFieldValue=i.isDateField=i.isStringField=i.isNumericField=i.numericTypes=i.isValueMatchingFieldType=i.getFieldDefaultValue=i.collectLabelingFields=i.getLabelingFields=i.getFeatureGeometryFields=i.getFeatureEditFields=i.getTimeFields=i.collectFilterFields=i.collectFeatureReductionFields=i.collectElevationFields=i.getElevationFields=i.getDisplayFieldName=i.collectArcadeFieldNames=i.hasField=i.getField=i.packFields=i.unpackFieldNames=i.collectField=i.collectFields=i.fixFields=i.fixTimeInfoFields=i.fixRendererFields=i.visualVariableFields=i.rendererFields=void 0,i.rendererFields=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],i.visualVariableFields=["field","normalizationField"],i.fixRendererFields=function(e,n){if(null!=e&&null!=n)for(var r=0,t=Array.isArray(e)?e:[e];r<t.length;r++){var l=t[r];if(c(i.rendererFields,l,n),"visualVariables"in l&&l.visualVariables)for(var a=0,s=l.visualVariables;a<s.length;a++){var o=s[a];c(i.visualVariableFields,o,n)}}},i.fixTimeInfoFields=function(e,i){if(null!=e&&null!=i)if("startField"in e){var n=v(i,e.startField),r=v(i,e.endField);e.startField=n&&n.name||null,e.endField=r&&r.name||null}else{var t=v(i,e.startTimeField),l=v(i,e.endTimeField);e.startTimeField=t&&t.name||null,e.endTimeField=l&&l.name||null}};var f=new Set;function g(e,i){return e&&i?(f.clear(),F(f,e,i),o.valuesOfSet(f).sort()):[]}function F(e,i,n){if(n)if(i&&i.length)if(r.includes(n,"*"))for(var t=0,l=i;t<l.length;t++){var a=l[t].name;e.add(a)}else for(var s=0,o=n;s<o.length;s++){m(e,i,c=o[s])}else{if(r.includes(n,"*"))return e.clear(),void e.add("*");for(var u=0,d=n;u<d.length;u++){var c=d[u];e.add(c)}}}function m(e,i,n){if(i&&i.length){var r=v(i,n);r&&e.add(r.name)}else"string"==typeof n&&e.add(n)}function v(e,i){if("string"!=typeof i)return null;if(null!=e){i=i.toLowerCase();for(var n=0,r=e;n<r.length;n++){var t=r[n];if(t&&t.name.toLowerCase()===i)return t}}return null}function p(e,i,r){return n.__awaiter(this,void 0,void 0,(function(){var t,l,a,s,o;return n.__generator(this,(function(n){switch(n.label){case 0:return r?[4,d.loadArcade()]:[2];case 1:for(t=n.sent().arcadeUtils,l=t.extractFieldNames(r),a=0,s=l;a<s.length;a++)o=s[a],m(e,i,o);return[2]}}))}))}function h(e,i){for(var n=0,r=e;n<r.length;n++){var t=r[n];if(t&&t.valueType&&t.valueType===i)return t.name}return null}function y(e,i){return n.__awaiter(this,void 0,void 0,(function(){var r,t;return n.__generator(this,(function(n){return i?(r=i.fields,(t=a.getDeepValue("elevationInfo.featureExpressionInfo",i))?[2,t.collectRequiredFields(e,r)]:[2]):[2]}))}))}function b(e,i){return n.__awaiter(this,void 0,void 0,(function(){var r,t;return n.__generator(this,(function(l){switch(l.label){case 0:return r=i.labelingInfo,t=i.fields,r&&r.length?[4,s.all(r.map((function(i){return function(e,i,r){return n.__awaiter(this,void 0,void 0,(function(){var t,l,a,s,o;return n.__generator(this,(function(n){switch(n.label){case 0:return r?(t=r.getLabelExpression(),l=r.where,"arcade"!==t.type?[3,2]:[4,p(e,i,t.expression)]):[2];case 1:return n.sent(),[3,3];case 2:(a=t.expression.match(/{[^}]*}/g))&&a.forEach((function(n){m(e,i,n.slice(1,-1))})),n.label=3;case 3:return s=/['"]+/g,l&&(3===(o=l.split(" ")).length&&m(e,i,o[0].replace(s,"")),7===o.length&&(m(e,i,o[0].replace(s,"")),m(e,i,o[4].replace(s,"")))),[2]}}))}))}(e,t,i)})))]:[2];case 1:return l.sent(),[2]}}))}))}function _(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function T(e){return null===e||_(e)}i.fixFields=g,i.collectFields=F,i.collectField=m,i.unpackFieldNames=function(e,i){return i&&e?r.includes(i,"*")?e.map((function(e){return e.name})):i:[]},i.packFields=function(e,i,n){if(void 0===n&&(n=1),!i||!e)return[];if(r.includes(i,"*"))return["*"];var t=g(e,i);return t.length/e.length>=n?["*"]:t},i.getField=v,i.hasField=function(e,i){if(!e||!i||"string"!=typeof i)return!1;i=i.toLowerCase();for(var n=0,r=e;n<r.length;n++){var t=r[n];if(t&&t.name.toLowerCase()===i)return!0}return!1},i.collectArcadeFieldNames=p,i.getDisplayFieldName=function(e){var i=e.displayField,n=e.fields;return i||(n&&n.length?h(n,"name-or-title")||h(n,"unique-identifier")||h(n,"type-or-category")||function(e){for(var i=0,n=e;i<n.length;i++){var r=n[i];if(r&&r.name){var t=r.name.toLowerCase();if(t.indexOf("name")>-1||t.indexOf("title")>-1)return r.name}}return null}(n):null)},i.getElevationFields=function(e){return n.__awaiter(this,void 0,void 0,(function(){var i;return n.__generator(this,(function(n){switch(n.label){case 0:return e?[4,y(i=new Set,e)]:[2,[]];case 1:return n.sent(),[2,o.valuesOfSet(i).sort()]}}))}))},i.collectElevationFields=y,i.collectFeatureReductionFields=function(e,i,r){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(t){switch(t.label){case 0:return i&&r&&"cluster"===r.type&&r.fields?[4,s.all(r.fields.map((function(r){return function(e,i,r){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(n){return r.outStatistic.onStatisticValueExpression?p(e,i,r.outStatistic.onStatisticValueExpression):e.add(r.outStatistic.onStatisticField),[2]}))}))}(e,i.fields,r)})))]:[2];case 1:return t.sent(),[2]}}))}))},i.collectFilterFields=function(i,r,l){return n.__awaiter(this,void 0,void 0,(function(){var a,s;return n.__generator(this,(function(n){switch(n.label){case 0:return r&&l&&(l.where&&"1=1"!==l.where||l.timeExtent)?(r.timeInfo&&l.timeExtent&&F(i,r.fields,[r.timeInfo.startField,r.timeInfo.endField]),l.where?[4,new Promise((function(i,n){e(["../../core/sql/WhereClause"],i,n)}))]:[3,2]):[2];case 1:if(a=n.sent(),!(s=a.WhereClause.create(l.where,r.fieldsIndex)).isStandardized)throw new t("fieldUtils:collectFilterFields","Where clause is not standardized");F(i,r.fields,s.fieldNames),n.label=2;case 2:return[2]}}))}))},i.getTimeFields=function(e){return n.__awaiter(this,void 0,void 0,(function(){var i;return n.__generator(this,(function(n){return e&&(i="timeInfo"in e&&e.timeInfo)?[2,g(e.fields,[e.trackIdField,i.startField,i.endField])]:[2,[]]}))}))},i.getFeatureEditFields=function(e){if(!e)return[];var i="editFieldsInfo"in e&&e.editFieldsInfo;return i?g(e.fields,[i&&i.creatorField,i&&i.creationDateField,i&&i.editorField,i&&i.editDateField]):[]},i.getFeatureGeometryFields=function(e){if(!e)return[];var i="geometryProperties"in e&&e.geometryProperties;return i?g(e.fields,[i&&i.shapeAreaFieldName,i&&i.shapeLengthFieldName]):[]},i.getLabelingFields=function(e){return n.__awaiter(this,void 0,void 0,(function(){var i;return n.__generator(this,(function(n){switch(n.label){case 0:return e?[4,b(i=new Set,e)]:[2,[]];case 1:return n.sent(),[2,o.valuesOfSet(i).sort()]}}))}))},i.collectLabelingFields=b,i.getFieldDefaultValue=function(e){var i=e.defaultValue;return void 0!==i&&S(e,i)?i:e.nullable?null:void 0};var I="isInteger"in Number?Number.isInteger:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};function V(e){return null===e||I(e)}function w(e){return null!=e&&"string"==typeof e}function N(e){return null===e||w(e)}function E(){return!0}function S(e,i){var n;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":n=e.nullable?V:I;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":n=e.nullable?T:_;break;case"string":case"esriFieldTypeString":n=e.nullable?N:w;break;default:n=E}return 1===arguments.length?n:n(i)}i.isValueMatchingFieldType=S,i.numericTypes=["integer","small-integer","single","double"];var R,x,D=o.SetFromValues(n.__spreadArrays(i.numericTypes,["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]));function A(e){return null!=e&&D.has(e.type)}function L(e,i){return e.nullable&&null===i?null:A(e)&&!O(e.type,Number(i))?R.OUT_OF_RANGE:S(e,i)?e.domain?u.validateDomainValue(e.domain,i):null:x.INVALID_TYPE}function O(e,i){var n="string"==typeof e?U(e):e;return!!n&&(n.isInteger?I(i)&&i>=n.min&&i<=n.max:i>=n.min&&i<=n.max)}function U(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return i.smallIntegerRange;case"esriFieldTypeInteger":case"integer":return i.integerRange;case"esriFieldTypeSingle":case"single":return i.singleRange;case"esriFieldTypeDouble":case"double":return i.doubleRange}}function k(e,i,n){if(!i||!i.attributes||!e){if(l.isSome(n))for(var r=0,t=e;r<t.length;r++){var a=t[r];n.add(a)}return!0}for(var s=i.attributes,o=!1,u=0,d=e;u<d.length;u++){if(!((a=d[u])in s)){if(o=!0,!l.isSome(n))break;n.add(a)}}return o}i.isNumericField=A,i.isStringField=function(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)},i.isDateField=function(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)},i.isValidFieldValue=function(e,i){return null===L(e,i)},function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(R=i.NumericRangeValidationError||(i.NumericRangeValidationError={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(x=i.TypeValidationError||(i.TypeValidationError={})),i.sanitizeNullFieldValue=function(e){return null==e||"number"==typeof e&&isNaN(e)?null:e},i.validateFieldValue=L,i.isNumberInRange=O,i.getFieldRange=function(e){var i=u.getDomainRange(e.domain);return i||(A(e)?U(e.type):void 0)},i.getNumericTypeForValue=function(e){if(!_(e))return null;if(I(e)){if(e>=i.smallIntegerRange.min&&e<=i.smallIntegerRange.max)return"esriFieldTypeSmallInteger";if(e>=i.integerRange.min&&e<=i.integerRange.max)return"esriFieldTypeInteger"}return e>=i.singleRange.min&&e<=i.singleRange.max?"esriFieldTypeSingle":"esriFieldTypeDouble"},i.smallIntegerRange={min:-32768,max:32767,isInteger:!0},i.integerRange={min:-2147483648,max:2147483647,isInteger:!0},i.singleRange={min:-34e37,max:12e37,isInteger:!1},i.doubleRange={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1},i.validationErrorToString=function(e,i,n){switch(e){case u.DomainValidationError.INVALID_CODED_VALUE:return"Value "+n+" is not in the coded domain - field: "+i.name+", domain: "+JSON.stringify(i.domain);case u.DomainValidationError.VALUE_OUT_OF_RANGE:return"Value "+n+" is out of the range of valid values - field: "+i.name+", domain: "+JSON.stringify(i.domain);case x.INVALID_TYPE:return"Value "+n+" is not a valid value for the field type - field: "+i.name+", type: "+i.type+", nullable: "+i.nullable;case R.OUT_OF_RANGE:var r=U(i.type),t=r.min,l=r.max;return"Value "+n+" is out of range for the number type - field: "+i.name+", type: "+i.type+", value range is "+t+" to "+l}},i.featureHasFields=function(e,i){return!k(e,i,null)},i.populateMissingFields=k,i.getExpressionFields=function(e,i){return n.__awaiter(this,void 0,void 0,(function(){var r,t,l,a;return n.__generator(this,(function(n){switch(n.label){case 0:r=new Set,t=0,l=i,n.label=1;case 1:return t<l.length?(a=l[t],[4,p(r,e.fields,a)]):[3,4];case 2:n.sent(),n.label=3;case 3:return t++,[3,1];case 4:return[2,o.valuesOfSet(r).sort()]}}))}))}}));