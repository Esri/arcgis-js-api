/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/subclass","../../core/urlUtils","../../core/uuid","../../portal/support/resourceExtension","../../core/Accessor","../../core/Handles","./commonProperties","./wmsUtils"],(function(e,t,r,s,a,n,l,o,i,c,p,y,u,d){"use strict";const h={visible:"visibleSublayers"},_=[102100,3857,102113,900913],f=[3395,54004];let m=function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._layerHandles=new y,e.extent=null,e._scale=null,e.view=null,e}return e._inheritsLoose(r,t),r.prototype.toJSON=function(){const{extent:e,layer:t,layers:r}=this,{imageFormat:s,imageTransparency:a,spatialReferences:n,version:l}=t;let{wkid:o}=this;n&&-1===n.indexOf(o)&&e.spatialReference.latestWkid&&(o=e.spatialReference.latestWkid);const{xmin:i,ymin:c,xmax:p,ymax:y}=e,u={bbox:"1.3.0"===t.version&&d.coordsReversed(o)?`${c},${i},${y},${p}`:`${i},${c},${p},${y}`,format:s,request:"GetMap",service:"WMS",styles:"",transparent:a,version:l};return isNaN(o)||("1.3.0"===l?u.crs="EPSG:"+o:u.srs="EPSG:"+o),{...u,layers:r}},e._createClass(r,[{key:"layer",set:function(e){this._get("layer")!==e&&(this._set("layer",e),this._layerHandles&&(this._layerHandles.removeAll(),this._layerHandles=null),e&&(this._layerHandles||(this._layerHandles=new y),this._layerHandles.add([e.sublayers.on("change",(()=>this.notifyChange("visibleSublayers"))),e.on("wms-sublayer-update",(e=>this.notifyChange(h[e.propertyName])))])))}},{key:"layers",get:function(){const{visibleSublayers:e}=this;return e.filter((e=>e.name)).map((e=>e.name)).join(",")}},{key:"scale",get:function(){return null!=this._scale?this._scale:this.view&&this.view.scale||0},set:function(e){this.view||(this._scale=e,this.notifyChange("scale"))}},{key:"version",get:function(){return(this._get("version")||0)+1}},{key:"visibleSublayers",get:function(){const{layer:e,scale:t}=this,{sublayers:r}=e,s=[],a=e=>{const{minScale:r,maxScale:n,sublayers:l,visible:o}=e;o&&(0===t||(0===r||t<=r)&&(0===n||t>=n))&&(l?l.forEach(a):s.unshift(e))};return null==r||r.forEach(a),s}},{key:"wkid",get:function(){const{extent:e,layer:t}=this,r=t.spatialReferences;let s=e.spatialReference&&e.spatialReference.wkid;r&&-1===r.indexOf(s)&&e.spatialReference.latestWkid&&(s=e.spatialReference.latestWkid);const a=_.some((e=>e===s));if(!r)return s;if(a){const e=[];r.forEach((t=>{_.indexOf(t)>-1&&e.push(t)})),e.length||r.forEach((t=>{f.indexOf(t)>-1&&e.push(t)})),s=e.length>0?e[0]:_[0]}return s}}]),r}(p);return t.__decorate([n.property()],m.prototype,"extent",void 0),t.__decorate([n.property()],m.prototype,"layer",null),t.__decorate([n.property({readOnly:!0,dependsOn:["visibleSublayers"]})],m.prototype,"layers",null),t.__decorate([n.property({type:Number,dependsOn:["view.scale"]})],m.prototype,"scale",null),t.__decorate([n.property(u.combinedViewLayerTimeExtentProperty)],m.prototype,"timeExtent",void 0),t.__decorate([n.property({type:Number,dependsOn:["layers","layer.imageTransparency","timeExtent"],readOnly:!0})],m.prototype,"version",null),t.__decorate([n.property()],m.prototype,"view",void 0),t.__decorate([n.property({readOnly:!0,dependsOn:["layer.sublayers","scale"]})],m.prototype,"visibleSublayers",null),t.__decorate([n.property({dependsOn:[],autoTracked:!1})],m.prototype,"wkid",null),m=t.__decorate([l.subclass("esri.layers.support.ExportWMSImageParameters")],m),m}));
