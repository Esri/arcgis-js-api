/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../config.js";import r from"../../request.js";import{throwIfAborted as t}from"../../core/promiseUtils.js";import{removeTrailingSlash as s,getOrigin as o,isProtocolRelative as l,isAbsolute as n,join as i,normalize as u,removeFile as c,getAppBaseUrl as a,addQueryParameters as f}from"../../core/urlUtils.js";import p from"../../views/2d/engine/vectorTiles/style/VectorTileSource.js";const y=e.defaults&&e.defaults.io.corsEnabledServers;async function m(e,r){const t={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[s,o]="string"==typeof e?[e,null]:[null,e.jsonUrl];await S(t,"esri",e,o,r);const l={layerDefinition:t.validatedSource,url:s,serviceUrl:t.sourceUrl,style:t.style,styleUrl:t.styleUrl,spriteUrl:t.style.sprite&&h(t.styleBase,t.style.sprite),spriteFormat:t.spriteFormat,glyphsUrl:t.style.glyphs&&h(t.styleBase,t.style.glyphs),sourceNameToSource:t.sourceNameToSource,primarySourceName:t.primarySourceName};return d(l.spriteUrl),d(l.glyphsUrl),l}function d(e){if(!e)return;const r=o(e);y&&!y.includes(r)&&y.push(r)}function h(...e){let r;for(let t=0;t<e.length;++t)if(l(e[t])){if(r){const s=r.split("://")[0];r=s+":"+e[t].trim()}}else r=n(e[t])?e[t]:i(r,e[t]);return s(r)}async function S(e,s,o,l,n){let i,c,a;if(t(n),"string"==typeof o){const e=u(o);d(e),a=await r(e,{...n,responseType:"json",query:{f:"json",...n?.query}}),a.ssl&&(i&&(i=i.replace(/^http:/i,"https:")),c&&(c=c.replace(/^http:/i,"https:"))),i=e,c=e}else a={data:o},i=o.jsonUrl||null,c=l;const f=a.data;if(U(f))return e.styleUrl=i||null,x(e,f,c,n);if(w(f))return e.sourceUrl?g(e,f,c,!1,s,n):(e.sourceUrl=i||null,g(e,f,c,!0,s,n));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function U(e){return!!e.sources}function w(e){return!U(e)}async function x(e,r,t,s){const o=t?c(t):a();e.styleBase=o,e.style=r,e.styleUrl&&d(e.styleUrl),r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const l=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?await S(e,"esri",h(o,t.url),void 0,s):l.push(S(e,"esri",t,o,s))}for(const n of Object.keys(r.sources))"esri"!==n&&"vector"===r.sources[n].type&&(r.sources[n].url?l.push(S(e,n,h(o,r.sources[n].url),void 0,s)):r.sources[n].tiles&&l.push(S(e,n,r.sources[n],o,s)));await Promise.all(l)}async function g(e,r,t,o,l,n){const i=t?s(t)+"/":a(),u=v(r,i),c=new p(l,f(i,n?.query),u);if(!o&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(c))return;null!=c.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(c.fullExtent):r.fullExtent=c.fullExtent.clone()),r.tileInfo.lods.length<c.tileInfo.lods.length&&(r.tileInfo=c.tileInfo)}if(o?(e.sourceBase=i,e.source=r,e.validatedSource=u,e.primarySourceName=l,e.sourceUrl&&d(e.sourceUrl)):d(i),e.sourceNameToSource[l]=c,!e.style){if(null==r.defaultStyles)throw new Error;return"string"==typeof r.defaultStyles?S(e,"",h(i,r.defaultStyles,"root.json"),void 0,n):S(e,"",r.defaultStyles,h(i,"root.json"),n)}}function v(e,r){if(e.hasOwnProperty("tileInfo"))return e;const t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},s=512;let o=78271.51696400007,l=295828763.7957775;const n=[],i=e.hasOwnProperty("minzoom")?+e.minzoom:0,u=e.hasOwnProperty("maxzoom")?+e.maxzoom:22;for(let c=0;c<=u;c++)c>=i&&n.push({level:c,scale:l,resolution:o}),o/=2,l/=2;for(const c of e.tiles)d(h(r,c));return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:s,cols:s,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:n,spatialReference:{wkid:102100}}}}export{m as loadMetadata};
