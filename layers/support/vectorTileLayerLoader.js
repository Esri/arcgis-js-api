/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../config","../../core/urlUtils","../../core/promiseUtils","../../request","../../views/2d/engine/vectorTiles/style/VectorTileSource"],(function(e,r,t,s,l,o){"use strict";const i=r.defaults&&r.defaults.io.corsEnabledServers;async function n(e,r){const s={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[l,o]="string"==typeof e?[e,null]:[null,e.jsonUrl],i=l?t.urlToObject(l):null;await c(s,"esri",e,o,r);const n={layerDefinition:s.validatedSource,url:l,parsedUrl:i,serviceUrl:s.sourceUrl,style:s.style,styleUrl:s.styleUrl,spriteUrl:s.style.sprite&&a(s.styleBase,s.style.sprite),spriteFormat:s.spriteFormat,glyphsUrl:s.style.glyphs&&a(s.styleBase,s.style.glyphs),sourceNameToSource:s.sourceNameToSource,primarySourceName:s.primarySourceName};return u(n.spriteUrl),u(n.glyphsUrl),n}function u(e){if(!e)return;const r=t.getOrigin(e);i&&-1===i.indexOf(r)&&i.push(r)}function a(...e){let r;for(let s=0;s<e.length;++s)if(t.isProtocolRelative(e[s])){if(r){const t=r.split("://")[0];r=t+":"+e[s].trim()}}else r=t.isAbsolute(e[s])?e[s]:t.join(r,e[s]);return t.removeTrailingSlash(r)}async function c(e,r,o,i,n){let a,c,d;if(s.throwIfAborted(n),"string"==typeof o){const e=t.normalize(o);u(e);const r=t.urlToObject(e);d=await l(r.path,{query:{f:"json"},responseType:"json",...n}),a=e,c=e}else d={data:o},a=o.jsonUrl||null,c=i;const h=d.data;return d.ssl&&(a&&(a=a.replace(/^http:/i,"https:")),c&&(c=c.replace(/^http:/i,"https:"))),f(h)?(e.styleUrl=a||null,y(e,h,c,n)):p(h)?e.sourceUrl?m(e,h,c,!1,r,n):(e.sourceUrl=a||null,m(e,h,c,!0,r,n)):Promise.reject("You must specify the URL or the JSON for a service or for a style.")}function f(e){return!!e.sources}function p(e){return!f(e)}async function y(e,r,s,l){const o=s?t.removeFile(s):t.appBaseUrl;e.styleBase=o,e.style=r,e.styleUrl&&u(e.styleUrl),r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const i=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?await c(e,"esri",a(o,t.url),void 0,l):i.push(c(e,"esri",t,o,l))}for(const t of Object.keys(r.sources))"esri"!==t&&"vector"===r.sources[t].type&&(r.sources[t].url?i.push(c(e,t,a(o,r.sources[t].url),void 0,l)):r.sources[t].tiles&&i.push(c(e,t,r.sources[t],o,l)));await Promise.all(i)}async function m(e,r,s,l,i,n){const f=s?t.removeTrailingSlash(s)+"/":t.appBaseUrl,p=d(r,f),y=new o(i,f,p);if(!l&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(y))return Promise.resolve();null!=y.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(y.fullExtent):r.fullExtent=y.fullExtent.clone()),r.tileInfo.lods.length<y.tileInfo.lods.length&&(r.tileInfo=y.tileInfo)}if(l?(e.sourceBase=f,e.source=r,e.validatedSource=p,e.primarySourceName=i,e.sourceUrl&&u(e.sourceUrl)):u(f),e.sourceNameToSource[i]=y,!e.style)return null==r.defaultStyles?Promise.reject():"string"==typeof r.defaultStyles?c(e,"",a(f,r.defaultStyles,"root.json"),void 0,n):c(e,"",r.defaultStyles,a(f,"root.json"),n)}function d(e,r){if(e.hasOwnProperty("tileInfo"))return e;const t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},s=512;let l=78271.51696400007,o=295828763.7957775;const i=[],n=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,c=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22;for(let u=0;u<=c;u++)u>=n&&i.push({level:u,scale:o,resolution:l}),l/=2,o/=2;for(const f of e.tiles)u(a(r,f));return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:s,cols:s,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:i,spatialReference:{wkid:102100}}}}e.loadMetadata=n,Object.defineProperty(e,"__esModule",{value:!0})}));
