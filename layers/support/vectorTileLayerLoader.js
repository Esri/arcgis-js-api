/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../config","../../core/urlUtils","../../core/promiseUtils","../../request","../../views/2d/engine/vectorTiles/style/VectorTileSource"],(function(e,r,t,l,s,o){"use strict";const n=r.defaults&&r.defaults.io.corsEnabledServers;function i(e){if(!e)return;const r=t.getOrigin(e);n&&-1===n.indexOf(r)&&n.push(r)}function u(...e){let r;for(let l=0;l<e.length;++l)if(t.isProtocolRelative(e[l])){if(r){const t=r.split("://")[0];r=t+":"+e[l].trim()}}else r=t.isAbsolute(e[l])?e[l]:t.join(r,e[l]);return t.removeTrailingSlash(r)}async function a(e,r,o,n,p){let y,m,d;if(l.throwIfAborted(p),"string"==typeof o){const e=t.normalize(o);i(e);const r=t.urlToObject(e);d=await s(r.path,{query:{f:"json"},responseType:"json",...p}),y=e,m=e}else d={data:o},y=o.jsonUrl||null,m=n;const h=d.data;return d.ssl&&(y&&(y=y.replace(/^http:/i,"https:")),m&&(m=m.replace(/^http:/i,"https:"))),c(h)?(e.styleUrl=y||null,async function(e,r,s,o){const n=s?t.removeFile(s):t.appBaseUrl;e.styleBase=n,e.style=r,e.styleUrl&&i(e.styleUrl);r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const c=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?await a(e,"esri",u(n,t.url),void 0,o):c.push(a(e,"esri",t,n,o))}for(const t of Object.keys(r.sources))"esri"!==t&&"vector"===r.sources[t].type&&(r.sources[t].url?c.push(a(e,t,u(n,r.sources[t].url),void 0,o)):c.push(a(e,t,r.sources[t],n,o)));await l.all(c)}(e,h,m,p)):c(h)?l.reject("You must specify the URL or the JSON for a service or for a style."):e.sourceUrl?f(e,h,m,!1,r,p):(e.sourceUrl=y||null,f(e,h,m,!0,r,p))}function c(e){return!!e.sources}async function f(e,r,s,n,c,f){const p=s?t.removeTrailingSlash(s)+"/":t.appBaseUrl,y=function(e,r){if(e.hasOwnProperty("tileInfo"))return e;const t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},l=512;let s=78271.51696400007,o=295828763.7957775;const n=[],a=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,c=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22;for(let e=0;e<=c;e++)e>=a&&n.push({level:e,scale:o,resolution:s}),s/=2,o/=2;for(const t of e.tiles)i(u(r,t));return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:l,cols:l,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:n,spatialReference:{wkid:102100}}}}(r,p),m=new o(c,p,y);if(!n&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(m))return l.resolve();null!=m.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(m.fullExtent):r.fullExtent=m.fullExtent.clone()),r.tileInfo.lods.length<m.tileInfo.lods.length&&(r.tileInfo=m.tileInfo)}if(n?(e.sourceBase=p,e.source=r,e.validatedSource=y,e.primarySourceName=c,e.sourceUrl&&i(e.sourceUrl)):i(p),e.sourceNameToSource[c]=m,!e.style)return null==r.defaultStyles?l.reject():"string"==typeof r.defaultStyles?a(e,"",u(p,r.defaultStyles,"root.json"),void 0,f):a(e,"",r.defaultStyles,u(p,"root.json"),f)}e.loadMetadata=async function(e,r){const l={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[s,o]="string"==typeof e?[e,null]:[null,e.jsonUrl],n=s?t.urlToObject(s):null;await a(l,"esri",e,o,r);const c={layerDefinition:l.validatedSource,url:s,parsedUrl:n,serviceUrl:l.sourceUrl,style:l.style,styleUrl:l.styleUrl,spriteUrl:l.style.sprite&&u(l.styleBase,l.style.sprite),spriteFormat:l.spriteFormat,glyphsUrl:l.style.glyphs&&u(l.styleBase,l.style.glyphs),sourceNameToSource:l.sourceNameToSource,primarySourceName:l.primarySourceName};return i(c.spriteUrl),i(c.glyphsUrl),c},Object.defineProperty(e,"__esModule",{value:!0})}));
