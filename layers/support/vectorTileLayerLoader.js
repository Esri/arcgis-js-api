/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../config","../../request","../../core/promiseUtils","../../core/urlUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],(function(e,r,t,l,s,o,n){"use strict";const i=t.defaults&&t.defaults.io.corsEnabledServers;function u(e,r){return a.apply(this,arguments)}function a(){return(a=r._asyncToGenerator((function*(e,r){const t={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[l,s]="string"==typeof e?[e,null]:[null,e.jsonUrl],n=l?o.urlToObject(l):null;yield f(t,"esri",e,s,r);const i={layerDefinition:t.validatedSource,url:l,parsedUrl:n,serviceUrl:t.sourceUrl,style:t.style,styleUrl:t.styleUrl,spriteUrl:t.style.sprite&&p(t.styleBase,t.style.sprite),spriteFormat:t.spriteFormat,glyphsUrl:t.style.glyphs&&p(t.styleBase,t.style.glyphs),sourceNameToSource:t.sourceNameToSource,primarySourceName:t.primarySourceName};return c(i.spriteUrl),c(i.glyphsUrl),i}))).apply(this,arguments)}function c(e){if(!e)return;const r=o.getOrigin(e);i&&-1===i.indexOf(r)&&i.push(r)}function p(...e){let r;for(let t=0;t<e.length;++t)if(o.isProtocolRelative(e[t])){if(r){const l=r.split("://")[0];r=l+":"+e[t].trim()}}else r=o.isAbsolute(e[t])?e[t]:o.join(r,e[t]);return o.removeTrailingSlash(r)}function f(e,r,t,l,s){return y.apply(this,arguments)}function y(){return(y=r._asyncToGenerator((function*(e,r,t,n,i){let u,a,p;if(s.throwIfAborted(i),"string"==typeof t){const e=o.normalize(t);c(e);const r=o.urlToObject(e);p=yield l(r.path,{query:{f:"json"},responseType:"json",...i}),u=e,a=e}else p={data:t},u=t.jsonUrl||null,a=n;const f=p.data;return p.ssl&&(u&&(u=u.replace(/^http:/i,"https:")),a&&(a=a.replace(/^http:/i,"https:"))),m(f)?(e.styleUrl=u||null,h(e,f,a,i)):d(f)?e.sourceUrl?U(e,f,a,!1,r,i):(e.sourceUrl=u||null,U(e,f,a,!0,r,i)):Promise.reject("You must specify the URL or the JSON for a service or for a style.")}))).apply(this,arguments)}function m(e){return!!e.sources}function d(e){return!m(e)}function h(e,r,t,l){return S.apply(this,arguments)}function S(){return(S=r._asyncToGenerator((function*(e,r,t,l){const s=t?o.removeFile(t):o.appBaseUrl;e.styleBase=s,e.style=r,e.styleUrl&&c(e.styleUrl),r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const n=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?yield f(e,"esri",p(s,t.url),void 0,l):n.push(f(e,"esri",t,s,l))}for(const o of Object.keys(r.sources))"esri"!==o&&"vector"===r.sources[o].type&&(r.sources[o].url?n.push(f(e,o,p(s,r.sources[o].url),void 0,l)):r.sources[o].tiles&&n.push(f(e,o,r.sources[o],s,l)));yield Promise.all(n)}))).apply(this,arguments)}function U(e,r,t,l,s,o){return g.apply(this,arguments)}function g(){return(g=r._asyncToGenerator((function*(e,r,t,l,s,i){const u=t?o.removeTrailingSlash(t)+"/":o.appBaseUrl,a=v(r,u),y=new n(s,u,a);if(!l&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(y))return Promise.resolve();null!=y.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(y.fullExtent):r.fullExtent=y.fullExtent.clone()),r.tileInfo.lods.length<y.tileInfo.lods.length&&(r.tileInfo=y.tileInfo)}if(l?(e.sourceBase=u,e.source=r,e.validatedSource=a,e.primarySourceName=s,e.sourceUrl&&c(e.sourceUrl)):c(u),e.sourceNameToSource[s]=y,!e.style)return null==r.defaultStyles?Promise.reject():"string"==typeof r.defaultStyles?f(e,"",p(u,r.defaultStyles,"root.json"),void 0,i):f(e,"",r.defaultStyles,p(u,"root.json"),i)}))).apply(this,arguments)}function v(e,r){if(e.hasOwnProperty("tileInfo"))return e;const t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},l=512;let s=78271.51696400007,o=295828763.7957775;const n=[],i=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,u=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22;for(let a=0;a<=u;a++)a>=i&&n.push({level:a,scale:o,resolution:s}),s/=2,o/=2;for(const a of e.tiles)c(p(r,a));return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:l,cols:l,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:n,spatialReference:{wkid:102100}}}}e.loadMetadata=u,Object.defineProperty(e,"__esModule",{value:!0})}));
