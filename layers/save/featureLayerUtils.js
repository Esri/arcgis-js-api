/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/arrayUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/originUtils","../FeatureLayer","../support/arcgisLayerUrl","../support/fetchService","../support/layerUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils"],(function(e,t,r,a,o,n,l,i,s,u,y,p,d,c,f,m){"use strict";const h=o.getLogger("esri.layers.FeatureLayer"),v="Feature Service";function w(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function b(e,t){if(t.type!==v)throw new a("feature-layer:portal-item-wrong-type",w(e,`should have portal item of type "${v}"`))}function T(e){return S.apply(this,arguments)}function S(){return(S=t._asyncToGenerator((function*(e){if(yield e.load(),p.isFeatureCollectionLayer(e))throw new a("feature-layer:save",w(e,"using an in-memory source cannot be saved to a portal item"))}))).apply(this,arguments)}function I(e,t){let r=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:t,details:r})=>new a(e,t,r)));if(t?.ignoreUnsupported&&(r=r.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),r.length>0)throw new a("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}function g(e,t,r){return K.apply(this,arguments)}function K(){return(K=t._asyncToGenerator((function*(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&(yield e.beforeSave());const a=e.write({},t);return I(t,r),a}))).apply(this,arguments)}function _(e){const{layer:t,layerJSON:r}=e;return t.isTable?{layers:[],tables:[r]}:{layers:[r],tables:[]}}function G(e){m.addTypeKeyword(e,m.TypeKeyword.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function O(e){const t=e.portalItem;if(!t)throw h.error("save: requires the portalItem property to be set"),new a("feature-layer:portal-item-not-set",w(e,"requires the portalItem property to be set"));if(!t.loaded)throw new a("feature-layer:portal-item-not-loaded",w(e,"cannot be saved to a portal item that does not exist or is inaccessible"));b(e,t)}function F(e,t){return L.apply(this,arguments)}function L(){return(L=t._asyncToGenerator((function*(e,t){return/\/\d+\/?$/.test(e.url??"")?_(t[0]):P(e,t)}))).apply(this,arguments)}function P(e,t){return A.apply(this,arguments)}function A(){return(A=t._asyncToGenerator((function*(e,t){const{layer:{url:r,customParameters:a,apiKey:o}}=t[0];let n=yield e.fetchData("json");n&&null!=n.layers&&null!=n.tables||(n=yield N(n,{url:r??"",customParameters:a,apiKey:o},t.map((e=>e.layer.layerId))));for(const l of t)U(l.layer,l.layerJSON,n);return n}))).apply(this,arguments)}function N(e,t,r){return E.apply(this,arguments)}function E(){return(E=t._asyncToGenerator((function*(e,t,r){var a,o;e||(e={}),(a=e).layers||(a.layers=[]),(o=e).tables||(o.tables=[]);const{url:n,customParameters:l,apiKey:i}=t,{serviceJSON:s,layersJSON:u}=yield y.fetchFeatureService(n,{customParameters:l,apiKey:i}),p=J(e.layers,s.layers,r),d=J(e.tables,s.tables,r);e.layers=p.itemResources,e.tables=d.itemResources;const c=[...p.added,...d.added],f=u?[...u.layers,...u.tables]:[];return yield x(e,c,n,f),e}))).apply(this,arguments)}function J(e,t,a){const o=r.difference(e,t,((e,t)=>e.id===t.id));e=e.filter((e=>!o.removed.some((t=>t.id===e.id))));const n=o.added.map((({id:e})=>({id:e})));return n.forEach((({id:t})=>{e.push({id:t})})),{itemResources:e,added:n.filter((({id:e})=>!a.includes(e)))}}function x(e,t,r,a){return $.apply(this,arguments)}function $(){return($=t._asyncToGenerator((function*(e,t,r,a){const o=t.map((({id:e})=>new s({url:r,layerId:e,sourceJSON:a.find((({id:t})=>t===e))})));yield l.eachAlways(o.map((e=>e.load()))),o.forEach((t=>{const{layerId:r,loaded:a,defaultPopupTemplate:o}=t;if(!a||n.isNone(o))return;U(t,{id:r,popupInfo:o.toJSON()},e)}))}))).apply(this,arguments)}function U(e,t,r){e.isTable?R(r.tables,t):R(r.layers,t)}function R(e,t){if(!e)return;const r=e.findIndex((({id:e})=>e===t.id));-1===r?e.push(t):e[r]=t}function D(e){const{portalItem:t}=e;return p.isFeatureServiceLayer(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===v}function W(e){return j.apply(this,arguments)}function j(){return(j=t._asyncToGenerator((function*(e){if(!e?.length)throw new a("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");yield Promise.all(e.map((e=>e.load())));for(const o of e)if(!D(o))throw new a("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${w(o,"does not conform")}`,{layer:o});const t=e.map((e=>e.portalItem.id));if(new Set(t).size>1)throw new a("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const r=e.map((e=>e.layerId));if(new Set(r).size!==r.length)throw new a("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}))).apply(this,arguments)}function C(e,t){var r,a;let o=c.from(t);return o.id&&(o=o.clone(),o.id=null),(r=o).type??(r.type=v),(a=o).portal??(a.portal=d.getDefault()),b(e,o),o}function M(e,t){return q.apply(this,arguments)}function q(){return(q=t._asyncToGenerator((function*(e,t){const{url:r,layerId:a,title:o,fullExtent:l,isTable:i}=e,s=u.parse(r),y=n.isSome(s)&&"FeatureServer"===s.serverType;t.url=y?r:`${r}/${a}`,t.title||(t.title=o),t.extent=null,!i&&n.isSome(l)&&(t.extent=yield m.getWGS84ExtentForItem(l)),m.removeTypeKeyword(t,m.TypeKeyword.METADATA),m.removeTypeKeyword(t,m.TypeKeyword.MULTI_LAYER),m.addTypeKeyword(t,m.TypeKeyword.SINGLE_LAYER),i&&m.addTypeKeyword(t,m.TypeKeyword.TABLE),G(t)}))).apply(this,arguments)}function z(e,t,r){return B.apply(this,arguments)}function B(){return(B=t._asyncToGenerator((function*(e,t,r){const a=e.portal;yield a?.signIn(),yield a?.user?.addItem({item:e,data:t,folder:r?.folder})}))).apply(this,arguments)}const Y=l.debounce(k);function k(e,t){return H.apply(this,arguments)}function H(){return(H=t._asyncToGenerator((function*(e,t){yield T(e),O(e);const r=e.portalItem,a=f.createForItemWrite(r),o=yield g(e,a,t),n=yield F(r,[{layer:e,layerJSON:o}]);return G(r),yield r.update({data:n}),i.updateOrigins(a),r}))).apply(this,arguments)}const Q=function(){var e=t._asyncToGenerator((function*(e,t){yield W(e);const r=e[0].portalItem,a=f.createForItemWrite(r),o=yield Promise.all(e.map((e=>g(e,a,t)))),n=yield F(r,e.map(((e,t)=>({layer:e,layerJSON:o[t]}))));return G(r),yield r.update({data:n}),yield Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),i.updateOrigins(a),r.clone()}));return function(t,r){return e.apply(this,arguments)}}(),V=l.debounce(Q),X=l.debounce(Z);function Z(e,t,r){return ee.apply(this,arguments)}function ee(){return(ee=t._asyncToGenerator((function*(e,t,r){yield T(e);const a=C(e,t),o=f.createForItemWrite(a),n=_({layer:e,layerJSON:yield g(e,o,r)});return yield M(e,a),yield z(a,n,r),e.portalItem=a,i.updateOrigins(o),a}))).apply(this,arguments)}e.save=Y,e.saveAll=V,e.saveAs=X,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
