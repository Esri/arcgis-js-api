// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["require","dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/sniff","../config","../kernel","../request","../urlUtils","../SpatialReference","../geometry/Extent","./DynamicMapServiceLayer","./WMSLayerInfo","dojo/query"],function(e,t,i,s,a,r,n,h,l,o,g,u,f,c){var p=i([f],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],version:null,constructor:function(t,i){var a=o.urlToObject(t);a.query&&(a.query.version||a.query.Version||a.query.VERSION)&&(this.version=a.query.version||a.query.Version||a.query.VERSION),t=this._stripParameters(t,["version","service","request","bbox","format","height","width","layers","srs","crs","styles","transparent","bgcolor","exceptions","time","elevation","sld","wfs"]),this.url=t,this._url=o.urlToObject(t),this._getCapabilitiesURL=t,this._initLayer=s.hitch(this,this._initLayer),this._parseCapabilities=s.hitch(this,this._parseCapabilities),this._getCapabilitiesError=s.hitch(this,this._getCapabilitiesError),i?(this.imageFormat=this._getImageFormat(i.format),this.imageTransparency=i.transparent!==!1,this.visibleLayers=i.visibleLayers?i.visibleLayers:[],this.version=i.version||this.version,i.resourceInfo?this._readResourceInfo(i.resourceInfo):this._getCapabilities()):(this.imageFormat="image/png",this.imageTransparency=!0,this.visibleLayers=[],this._getCapabilities()),this._blankImageURL=e.toUrl("../images/pixel.png")},setVisibleLayers:function(e){e=this._checkVisibleLayersList(e),this.visibleLayers=e?e:[],this.refresh(!0)},setImageFormat:function(e){this.imageFormat=this._getImageFormat(e),this.refresh(!0)},setImageTransparency:function(e){this.imageTransparency=e,this.refresh(!0)},getImageUrl:function(e,t,i,s){if(!this.visibleLayers||0===this.visibleLayers.length)return void s(this._blankImageURL);var r=e.spatialReference.wkid;if(-1===a.indexOf(this.spatialReferences,r)&&e.spatialReference.latestWkid&&(r=e.spatialReference.latestWkid),a.some(this._WEB_MERCATOR,function(e){return e==r})){var n=a.filter(this.spatialReferences,function(e){return a.some(this._WEB_MERCATOR,function(t){return t==e})},this);0===n.length&&(n=a.filter(this.spatialReferences,function(e){return a.some(this._WORLD_MERCATOR,function(t){return t==e})},this)),r=n.length>0?n[0]:this._WEB_MERCATOR[0]}var h=a.filter(this.spatialReferences,function(e){return e!==r});this.spatialReferences=h,this.spatialReferences.unshift(r);var l=e.xmin,g=e.xmax,u=e.ymin,f=e.ymax,c={};c.SERVICE="WMS",c.REQUEST="GetMap",c.FORMAT=this.imageFormat,c.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE",c.STYLES="",c.VERSION=this.version,c.LAYERS=this.visibleLayers?this.visibleLayers.toString():null,c.WIDTH=t,c.HEIGHT=i,this.maxWidth<t&&(c.WIDTH=this.maxWidth),this.maxHeight<i&&(c.HEIGHT=this.maxHeight);var p=r?r:0/0;isNaN(p)||("1.3.0"==this.version?c.CRS="EPSG:"+p:c.SRS="EPSG:"+p),c.BBOX="1.3.0"==this.version&&this._useLatLong(p)?u+","+l+","+f+","+g:l+","+u+","+g+","+f;var _,m=this.getMapURL;m+=-1==m.indexOf("?")?"?":"";for(_ in c)c.hasOwnProperty(_)&&(m+="?"==m.substring(m.length-1,m.length)?"":"&",m+=_+"="+c[_]);s(o.addProxy(m))},_initLayer:function(){this.spatialReference=new g(this.extent.spatialReference),this.initialExtent=new u(this.extent),this.fullExtent=new u(this.extent),this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);var e=s.hitch(this,function(){this.loaded=!0,this.onLoad(this);var e=this._loadCallback;e&&(delete this._loadCallback,e(this))});if(r("chrome")){var t=n.defaults.io,i="with-credentials"===t.useCors?o.canUseXhr(this.getMapURL,!0):-1,a=i>-1?t.corsEnabledServers[i]:null;a&&a.withCredentials?l({url:this.getMapURL,handleAs:"text",content:{SERVICE:"WMS",REQUEST:"GetMap"}}).addBoth(function(){e()}):e()}else e()},_readResourceInfo:function(e){return e.extent?e.layerInfos?(this.extent=e.extent,this.allExtents[0]=e.extent,this.layerInfos=e.layerInfos,this.description=e.description?e.description:"",this.copyright=e.copyright?e.copyright:"",this.title=e.title?e.title:"",this.getMapURL=e.getMapURL?e.getMapURL:this._getCapabilitiesURL,this.version=e.version?e.version:"1.3.0",this.maxWidth=e.maxWidth?e.maxWidth:5e3,this.maxHeight=e.maxHeight?e.maxHeight:5e3,this.spatialReferences=e.spatialReferences?e.spatialReferences:[],this.imageFormat=this._getImageFormat(e.format),this.setScaleRange(e.minScale,e.maxScale),void this._initLayer()):void this._errorHandler(new Error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo")):void this._errorHandler(new Error("esri.layers.WMSLayer: Unable to find the 'extent' property in resourceInfo."))},_getCapabilities:function(){var e=this._url.query?this._url.query:{};e.SERVICE="WMS",e.REQUEST="GetCapabilities",this.version&&(e.VERSION=this.version);var t,i=this._url.path+"?";for(t in e)e.hasOwnProperty(t)&&(i+="?"==i.substring(i.length-1,i.length)?"":"&",i+=t+"="+e[t]);l({url:i,handleAs:"xml",headers:{"Content-Type":null},load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:!1})},_parseCapabilities:function(e){if(!e)return void this._errorHandler(new Error("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)"));this.version=this._getAttributeValue("WMS_Capabilities","version",e,null),this.version||(this.version=this._getAttributeValue("WMT_MS_Capabilities","version",e,"1.3.0"));var i=this._getTag("Service",e);this.title=this._getTagValue("Title",i,""),this.title||(this.title=this._getTagValue("Name",i,"")),this.copyright=this._getTagValue("AccessConstraints",i,""),this.description=this._getTagValue("Abstract",i,""),this.maxWidth=parseInt(this._getTagValue("MaxWidth",i,5e3),10),this.maxHeight=parseInt(this._getTagValue("MaxHeight",i,5e3),10);var s=this._getTag("Layer",e);if(!s)return void this._errorHandler(new Error("esri.layers.WMSLayer: Response does not contain any layers."));var r=this._getLayerInfo(s),n=0,h=null,l=this._getTag("Capability",e);if(a.forEach(l.childNodes,function(e){"Layer"==e.nodeName&&(0===n?h=e:1===n?(r.name&&(r.name="",r.subLayers=[],r.subLayers.push(this._getLayerInfo(h))),r.subLayers.push(this._getLayerInfo(e))):r.subLayers.push(this._getLayerInfo(e)),n++)},this),r&&(this.layerInfos=r.subLayers,this.layerInfos&&0!==this.layerInfos.length||(this.layerInfos=[r]),this.extent=r.extent,this.extent||(r.extent=new u(this.layerInfos[0].extent.toJson()),this.extent=r.extent),this.allExtents=r.allExtents,this.allExtents&&this.allExtents.length||(r.allExtents=[],a.forEach(this.layerInfos[0].allExtents,function(e,t){e&&(r.allExtents[t]=new u(e.toJson()))}),this.allExtents=r.allExtents),this.spatialReferences=r.spatialReferences,!this.spatialReferences.length&&this.layerInfos.length>0)){var o;for(o=0;o<this.layerInfos.length;o++){var g=this.layerInfos[o];if(this.spatialReferences=this.layerInfos[0].spatialReferences,this.spatialReferences.length)break;if(g.subLayers&&g.subLayers.length>0){var f;for(f=0;f<g.subLayers.length;f++){var c=g.subLayers[f];if(this.spatialReferences=c.spatialReferences,this.spatialReferences.length)break}}if(this.spatialReferences.length)break}}this.getMapURL=this._getCapabilitiesURL;var p=t.query("DCPType",this._getTag("GetMap",e));if(p&&p.length>0){var _=t.query("HTTP",p[0]);if(_&&_.length>0){var m=t.query("Get",_[0]);if(m&&m.length>0){var y=this._getAttributeValue("OnlineResource","xlink:href",m[0],null);y&&(y.indexOf("&")==y.length-1&&(y=y.substring(0,y.length-1)),this.getMapURL=this._stripParameters(y,["service","request"]))}}}this.getMapFormats=[],0===t.query("Operation",e).length?a.forEach(t.query("Format",this._getTag("GetMap",e)),function(e){this.getMapFormats.push(e.text?e.text:e.textContent)},this):a.forEach(t.query("Operation",e),function(e){"GetMap"==e.getAttribute("name")&&a.forEach(t.query("Format",e),function(e){this.getMapFormats.push(e.text?e.text:e.textContent)},this)},this),a.some(this.getMapFormats,function(e){return e.indexOf(this.imageFormat)>-1},this)||(this.imageFormat=this.getMapFormats[0]),this._initLayer()},_getCapabilitiesError:function(e){e&&e.message&&(e.message="GetCapabilities request for "+this._getCapabilitiesURL+" failed. ("+e.message+")"),this._errorHandler(e)},_getLayerInfo:function(e){if(!e)return null;var t=new c;t.name="",t.title="",t.description="",t.allExtents=[],t.spatialReferences=[],t.subLayers=[];var i=this._getTag("LatLonBoundingBox",e);i&&(t.allExtents[0]=this._getExtent(i,4326));var s,r=this._getTag("EX_GeographicBoundingBox",e);r&&(s=new u(0,0,0,0,new g({wkid:4326})),s.xmin=parseFloat(this._getTagValue("westBoundLongitude",r,0)),s.ymin=parseFloat(this._getTagValue("southBoundLatitude",r,0)),s.xmax=parseFloat(this._getTagValue("eastBoundLongitude",r,0)),s.ymax=parseFloat(this._getTagValue("northBoundLatitude",r,0)),t.allExtents[0]=s),i||r||(s=new u(-180,-90,180,90,new g({wkid:4326})),t.allExtents[0]=s),t.extent=t.allExtents[0];var n=a.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)>-1?"SRS":"CRS";return a.forEach(e.childNodes,function(e){if("Name"==e.nodeName)t.name=(e.text?e.text:e.textContent)||"";else if("Title"==e.nodeName)t.title=(e.text?e.text:e.textContent)||"";else if("Abstract"==e.nodeName)t.description=(e.text?e.text:e.textContent)||"";else if("BoundingBox"==e.nodeName){var i,s=e.getAttribute(n);if(s&&0===s.indexOf("EPSG:")){if(i=parseInt(s.substring(5),10),0!==i&&!isNaN(i)){var r;r="1.3.0"==this.version?this._getExtent(e,i,this._useLatLong(i)):this._getExtent(e,i),t.allExtents[i]=r,t.extent||(t.extent=r)}}else s&&0===s.indexOf("CRS:")?(i=parseInt(s.substring(4),10),0===i||isNaN(i)||(this._CRS_TO_EPSG[i]&&(i=this._CRS_TO_EPSG[i]),t.allExtents[i]=this._getExtent(e,i))):(i=parseInt(s,10),0===i||isNaN(i)||(t.allExtents[i]=this._getExtent(e,i)))}else if(e.nodeName==n){var h=e.text?e.text:e.textContent,l=h.split(" ");a.forEach(l,function(e){e=e.indexOf(":")>-1?parseInt(e.split(":")[1],10):parseInt(e,10),0===e||isNaN(e)||(this._CRS_TO_EPSG[e]&&(e=this._CRS_TO_EPSG[e]),-1==a.indexOf(t.spatialReferences,e)&&t.spatialReferences.push(e))},this)}else if("Style"!=e.nodeName||t.legendURL)"Layer"===e.nodeName&&t.subLayers.push(this._getLayerInfo(e));else{var o=this._getTag("LegendURL",e);if(o){var g=this._getTag("OnlineResource",o);g&&(t.legendURL=g.getAttribute("xlink:href"))}}},this),t.title=t.title||t.name,t},_getImageFormat:function(e){var t=e?e.toLowerCase():"";switch(t){case"jpg":return"image/jpeg";case"bmp":return"image/bmp";case"gif":return"image/gif";case"svg":return"image/svg+xml";default:return"image/png"}},getImageFormat:function(){var e=this.imageFormat?this.imageFormat.toLowerCase():"";switch(e){case"image/jpeg":return"jpg";case"image/bmp":return"bmp";case"image/gif":return"gif";case"image/svg+xml":return"svg";default:return"png"}},_getExtent:function(e,t,i){var s;if(e){s=new u;var a=parseFloat(e.getAttribute("minx")),r=parseFloat(e.getAttribute("miny")),n=parseFloat(e.getAttribute("maxx")),h=parseFloat(e.getAttribute("maxy"));i?(s.xmin=isNaN(r)?-1*Number.MAX_VALUE:r,s.ymin=isNaN(a)?-1*Number.MAX_VALUE:a,s.xmax=isNaN(h)?Number.MAX_VALUE:h,s.ymax=isNaN(n)?Number.MAX_VALUE:n):(s.xmin=isNaN(a)?-1*Number.MAX_VALUE:a,s.ymin=isNaN(r)?-1*Number.MAX_VALUE:r,s.xmax=isNaN(n)?Number.MAX_VALUE:n,s.ymax=isNaN(h)?Number.MAX_VALUE:h),s.spatialReference=new g({wkid:t})}return s},_useLatLong:function(e){var t,i;for(i=0;i<this._REVERSED_LAT_LONG_RANGES.length;i++){var s=this._REVERSED_LAT_LONG_RANGES[i];if(e>=s[0]&&e<=s[1]){t=!0;break}}return t},_getTag:function(e,i){var s=t.query(e,i);return s&&s.length>0?s[0]:null},_getTagValue:function(e,i,s){var a=t.query(e,i);return a&&a.length>0?a[0].text?a[0].text:a[0].textContent:s},_getAttributeValue:function(e,i,s,a){var r=t.query(e,s);return r&&r.length>0?r[0].getAttribute(i):a},_checkVisibleLayersList:function(e){if(e&&e.length>0&&this.layerInfos&&this.layerInfos.length>0&&"number"==typeof e[0]){var t=[];a.forEach(e,function(e){e<this.layerInfos.length&&t.push(this.layerInfos[e].name)},this),e=t}return e},_stripParameters:function(e,t){var i,s=o.urlToObject(e),r=[];for(i in s.query)s.query.hasOwnProperty(i)&&-1===a.indexOf(t,i.toLowerCase())&&r.push(i+"="+s.query[i]);return s.path+(r.length?"?"+r.join("&"):"")}});return r("extend-esri")&&s.setObject("layers.WMSLayer",p,h),p});