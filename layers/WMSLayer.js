// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/sniff","../config","../graphic","../kernel","../request","../urlUtils","../dijit/PopupTemplate","../SpatialReference","../geometry/Extent","../geometry/Point","./DynamicMapServiceLayer","./WMSLayerInfo","dojo/query"],function(e,t,i,s,r,a,n,h,o,l,u,g,f,c,m,_,p){var y=i([_],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],version:null,constructor:function(t,i){var r=u.urlToObject(t);r.query&&(r.query.version||r.query.Version||r.query.VERSION)&&(this.version=r.query.version||r.query.Version||r.query.VERSION),t=this._stripParameters(t,["version","service","request","bbox","format","height","width","layers","srs","crs","styles","transparent","bgcolor","exceptions","time","elevation","sld","wfs"]),this.url=t,this._url=u.urlToObject(t),this._getCapabilitiesURL=t,this._initLayer=s.hitch(this,this._initLayer),this._parseCapabilities=s.hitch(this,this._parseCapabilities),this._getCapabilitiesError=s.hitch(this,this._getCapabilitiesError),i?(this.customParameters=i.customParameters,this.customLayerParameters=i.customLayerParameters,this.imageFormat=this._getImageFormat(i.format),this.imageTransparency=i.transparent!==!1,this.visibleLayers=i.visibleLayers?i.visibleLayers:[],this.version=i.version||this.version,i.resourceInfo?this._readResourceInfo(i.resourceInfo):this._getCapabilities()):(this.imageFormat="image/png",this.imageTransparency=!0,this.visibleLayers=[],this._getCapabilities()),this._blankImageURL=e.toUrl("../images/pixel.png"),this.extentProcessor=this._createExtentProcessor(0),this._createChildLayer()},setVisibleLayers:function(e){e=this._checkVisibleLayersList(e),this.visibleLayers=e?e:[],this.refresh(!0)},setImageFormat:function(e){this.imageFormat=this._getImageFormat(e),this.refresh(!0)},setImageTransparency:function(e){this.imageTransparency=e,this.refresh(!0)},setCustomParameters:function(e,t){this.customParameters=e,this.customLayerParameters=t,this.refresh(!0)},refresh:function(){this.inherited(arguments),this._childLayer&&this._childLayer.refresh.apply(this._childLayer,arguments)},getImageUrl:function(e,t,i,s){if(!this.visibleLayers||0===this.visibleLayers.length)return void s(this._blankImageURL);var r=this._getImageParams(e,t,i);r=this._mixinCustomLayerParameters(r);var a,n=this.getMapURL;n+=-1===n.indexOf("?")?"?":"";for(a in r)r.hasOwnProperty(a)&&(n+="?"===n.substring(n.length-1,n.length)?"":"&",n+=a+"="+r[a]);s(u.addProxy(n))},_setMap:function(e,t,i){var s=this.inherited(arguments);return e.wrapAround180?this._childLayer&&(this.suspended&&this._childLayer.suspend(),this._childLayer._setMap(e,s)):(this.extentProcessor=null,this._childLayer=null),s},_unsetMap:function(e,t){this._childLayer&&this._childLayer._unsetMap(e,this._div),this.inherited(arguments)},onSuspend:function(){this.inherited(arguments),this._childLayer&&this._childLayer.suspend()},onResume:function(){this.inherited(arguments),this._childLayer&&this._childLayer.resume()},_createChildLayer:function(){this._childLayer=new _(null,{extentProcessor:this._createExtentProcessor(1)}),this._childLayer._isChildLayer=!0,this._childLayer.getImageUrl=s.hitch(this,this.getImageUrl),this._childLayer.loaded=!0},_createExtentProcessor:function(e){return s.hitch(this,this._extentProcessor,e)},_extentProcessor:function(e,t){var i=t.extent,s=t.width,r=0;if(i){var a=i.getWidth()/s,n=i.bisect(),h=n.extents,o=h[e];if(o){var l=n.marginLeft/a;r=0===e?l:l+h[0].getWidth()/a,s=Math.ceil(o.getWidth()/a),r=Math.ceil(r)}i=o}return{extent:i,width:s,marginLeft:r}},_getImageParams:function(e,t,i){var s=e.spatialReference.wkid;if(-1===r.indexOf(this.spatialReferences,s)&&e.spatialReference.latestWkid&&(s=e.spatialReference.latestWkid),r.some(this._WEB_MERCATOR,function(e){return e==s})){var a=r.filter(this.spatialReferences,function(e){return r.some(this._WEB_MERCATOR,function(t){return t==e})},this);0===a.length&&(a=r.filter(this.spatialReferences,function(e){return r.some(this._WORLD_MERCATOR,function(t){return t==e})},this)),s=a.length>0?a[0]:this._WEB_MERCATOR[0]}var n=r.filter(this.spatialReferences,function(e){return e!==s});this.spatialReferences=n,this.spatialReferences.unshift(s);var h=e.xmin,o=e.xmax,l=e.ymin,u=e.ymax,g={};g.SERVICE="WMS",g.REQUEST="GetMap",g.FORMAT=this.imageFormat,g.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE",g.STYLES="",g.VERSION=this.version,g.LAYERS=this.visibleLayers?this.visibleLayers.toString():null,g.WIDTH=t,g.HEIGHT=i,this.maxWidth<t&&(g.WIDTH=this.maxWidth),this.maxHeight<i&&(g.HEIGHT=this.maxHeight);var f=s?s:NaN;return isNaN(f)||("1.3.0"==this.version?g.CRS="EPSG:"+f:g.SRS="EPSG:"+f),"1.3.0"==this.version&&this._useLatLong(f)?g.BBOX=l+","+h+","+u+","+o:g.BBOX=h+","+l+","+o+","+u,g},_initLayer:function(e,t){this.spatialReference=new f(this.extent.spatialReference),this.initialExtent=new c(this.extent),this.fullExtent=new c(this.extent),this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);var i=s.hitch(this,function(){this.loaded=!0,this.onLoad(this);var e=this._loadCallback;e&&(delete this._loadCallback,e(this))});if(a("chrome")){var r=n.defaults.io,h="with-credentials"===r.useCors?u.canUseXhr(this.getMapURL,!0):-1,o=h>-1?r.corsEnabledServers[h]:null;o&&o.withCredentials?l({url:this.getMapURL,handleAs:"text",content:{SERVICE:"WMS",REQUEST:"GetMap"}}).addBoth(function(){i()}):i()}else i()},_readResourceInfo:function(e){return e.extent?e.layerInfos?(this.extent=e.extent,this.allExtents[0]=e.extent,this.layerInfos=e.layerInfos,this.description=e.description?e.description:"",this.copyright=e.copyright?e.copyright:"",this.title=e.title?e.title:"",this.getMapURL=e.getMapURL?e.getMapURL:this._getCapabilitiesURL,this.getFeatureInfoURL=e.getFeatureInfoURL,this.featureInfoFormat=e.featureInfoFormat,this.version=e.version?e.version:"1.3.0",this.maxWidth=e.maxWidth?e.maxWidth:5e3,this.maxHeight=e.maxHeight?e.maxHeight:5e3,this.spatialReferences=e.spatialReferences?e.spatialReferences:[],this.imageFormat=this._getImageFormat(e.format),this.setScaleRange(e.minScale,e.maxScale),this.customLayerParameters=e.customLayerParameters||this.customLayerParameters,this.customParameters=e.customParameters||this.customParameters,void this._initLayer()):void this._errorHandler(new Error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo")):void this._errorHandler(new Error("esri.layers.WMSLayer: Unable to find the 'extent' property in resourceInfo."))},_getCapabilities:function(){var e=this._url.query?this._url.query:{};e.SERVICE="WMS",e.REQUEST="GetCapabilities",this.version&&(e.VERSION=this.version),e=this._mixinCustomParameters(e);var t,i=this._url.path+"?";for(t in e)e.hasOwnProperty(t)&&(i+="?"==i.substring(i.length-1,i.length)?"":"&",i+=t+"="+e[t]);l({url:i,handleAs:"xml",headers:{"Content-Type":null},load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:!1})},_parseCapabilities:function(e){if(!e)return void this._errorHandler(new Error("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)"));var i=this;this.version=this._getAttributeValue("WMS_Capabilities","version",e,null),this.version||(this.version=this._getAttributeValue("WMT_MS_Capabilities","version",e,"1.3.0"));var s=this._getTag("Service",e);this.title=this._getTagValue("Title",s,""),this.title||(this.title=this._getTagValue("Name",s,"")),this.copyright=this._getTagValue("AccessConstraints",s,""),this.description=this._getTagValue("Abstract",s,""),this.maxWidth=parseInt(this._getTagValue("MaxWidth",s,5e3),10),this.maxHeight=parseInt(this._getTagValue("MaxHeight",s,5e3),10);var a=this._getTag("Layer",e);if(!a)return void this._errorHandler(new Error("esri.layers.WMSLayer: Response does not contain any layers."));var n=this._getLayerInfo(a),h=0,o=null,l=this._getTag("Capability",e);if(r.forEach(l.childNodes,function(e){"Layer"==e.nodeName&&(0===h?o=e:1===h?(n.name&&(n.name="",n.subLayers=[],n.subLayers.push(this._getLayerInfo(o))),n.subLayers.push(this._getLayerInfo(e))):n.subLayers.push(this._getLayerInfo(e)),h++)},this),n&&(this.layerInfos=n.subLayers,this.layerInfos&&0!==this.layerInfos.length||(this.layerInfos=[n]),this.extent=n.extent,this.extent||(n.extent=new c(this.layerInfos[0].extent.toJson()),this.extent=n.extent),this.allExtents=n.allExtents,this.allExtents&&this.allExtents.length||(n.allExtents=[],r.forEach(this.layerInfos[0].allExtents,function(e,t){e&&(n.allExtents[t]=new c(e.toJson()))}),this.allExtents=n.allExtents),this.spatialReferences=n.spatialReferences,!this.spatialReferences.length&&this.layerInfos.length>0)){var u,g=function(e){var t;for(t=0;t<e.subLayers.length;t++){var i=e.subLayers[t],s=i.spatialReferences;if(!s.length&&i.subLayers&&i.subLayers.length>0&&(s=g(i)),s.length)return s}return[]};for(u=0;u<this.layerInfos.length;u++){var f=this.layerInfos[u];if(this.spatialReferences=this.layerInfos[0].spatialReferences,!this.spatialReferences.length&&f.subLayers&&f.subLayers.length>0&&(this.spatialReferences=g(f)),this.spatialReferences.length)break}}var m=function(s){var r=t.query("DCPType",i._getTag(s,e));if(r&&r.length>0){var a=t.query("HTTP",r[0]);if(a&&a.length>0){var n=t.query("Get",a[0]);if(n&&n.length>0){var h=i._getAttributeValue("OnlineResource","xlink:href",n[0],null);if(h)return h.indexOf("&")===h.length-1&&(h=h.substring(0,h.length-1)),i._stripParameters(h,["service","request"])}}}return null},_=function(s){var a=[];return 0===t.query("Operation",e).length?r.forEach(t.query("Format",i._getTag(s,e)),function(e){a.push(e.text?e.text:e.textContent)}):r.forEach(t.query("Operation",e),function(e){e.getAttribute("name")===s&&r.forEach(t.query("Format",e),function(e){a.push(e.text?e.text:e.textContent)})}),a};if(this.getMapURL=m("GetMap")||this._getCapabilitiesURL,this.getMapFormats=_("GetMap"),r.some(this.getMapFormats,function(e){return e.indexOf(this.imageFormat)>-1},this)||(this.imageFormat=this.getMapFormats[0]),this.getFeatureInfoURL=m("GetFeatureInfo"),this.getFeatureInfoURL&&(this.getFeatureInfoFormats=_("GetFeatureInfo"),r.indexOf(this.getFeatureInfoFormats,"text/html")>-1?this.featureInfoFormat="text/html":r.indexOf(this.getFeatureInfoFormats,"text/plain")>-1&&(this.featureInfoFormat="text/plain")),!this.featureInfoFormat){var p=function(e){if(e&&(e.queryable=!1,e.subLayers))for(var t=0;t<e.subLayers.length;t++)p(e.subLayers[t])};p(n)}this._initLayer()},_getCapabilitiesError:function(e){e&&e.message&&(e.message="GetCapabilities request for "+this._getCapabilitiesURL+" failed. ("+e.message+")"),this._errorHandler(e)},_getLayerInfo:function(e){if(!e)return null;var t=new p;t.name="",t.title="",t.description="",t.allExtents=[],t.spatialReferences=[],t.queryable="1"===e.getAttribute("queryable"),t.subLayers=[];var i=this._getTag("LatLonBoundingBox",e);i&&(t.allExtents[0]=this._getExtent(i,4326));var s,a=this._getTag("EX_GeographicBoundingBox",e);a&&(s=new c(0,0,0,0,new f({wkid:4326})),s.xmin=parseFloat(this._getTagValue("westBoundLongitude",a,0)),s.ymin=parseFloat(this._getTagValue("southBoundLatitude",a,0)),s.xmax=parseFloat(this._getTagValue("eastBoundLongitude",a,0)),s.ymax=parseFloat(this._getTagValue("northBoundLatitude",a,0)),t.allExtents[0]=s),i||a||(s=new c(-180,-90,180,90,new f({wkid:4326})),t.allExtents[0]=s),t.extent=t.allExtents[0];var n=r.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)>-1?"SRS":"CRS";return r.forEach(e.childNodes,function(e){if("Name"==e.nodeName)t.name=(e.text?e.text:e.textContent)||"";else if("Title"==e.nodeName)t.title=(e.text?e.text:e.textContent)||"";else if("Abstract"==e.nodeName)t.description=(e.text?e.text:e.textContent)||"";else if("BoundingBox"==e.nodeName){var i,s=e.getAttribute(n);if(s&&0===s.indexOf("EPSG:")){if(i=parseInt(s.substring(5),10),0!==i&&!isNaN(i)){var a;a="1.3.0"==this.version?this._getExtent(e,i,this._useLatLong(i)):this._getExtent(e,i),t.allExtents[i]=a,t.extent||(t.extent=a)}}else s&&0===s.indexOf("CRS:")?(i=parseInt(s.substring(4),10),0===i||isNaN(i)||(this._CRS_TO_EPSG[i]&&(i=this._CRS_TO_EPSG[i]),t.allExtents[i]=this._getExtent(e,i))):(i=parseInt(s,10),0===i||isNaN(i)||(t.allExtents[i]=this._getExtent(e,i)))}else if(e.nodeName==n){var h=e.text?e.text:e.textContent,o=h.split(" ");r.forEach(o,function(e){e=e.indexOf(":")>-1?parseInt(e.split(":")[1],10):parseInt(e,10),0===e||isNaN(e)||(this._CRS_TO_EPSG[e]&&(e=this._CRS_TO_EPSG[e]),-1==r.indexOf(t.spatialReferences,e)&&t.spatialReferences.push(e))},this)}else if("Style"!=e.nodeName||t.legendURL)"Layer"===e.nodeName&&t.subLayers.push(this._getLayerInfo(e));else{var l=this._getTag("LegendURL",e);if(l){var u=this._getTag("OnlineResource",l);u&&(t.legendURL=u.getAttribute("xlink:href"))}}},this),t.title=t.title||t.name,t},_getImageFormat:function(e){var t=e?e.toLowerCase():"";switch(t){case"jpg":return"image/jpeg";case"bmp":return"image/bmp";case"gif":return"image/gif";case"svg":return"image/svg+xml";default:return"image/png"}},getImageFormat:function(){var e=this.imageFormat?this.imageFormat.toLowerCase():"";switch(e){case"image/jpeg":return"jpg";case"image/bmp":return"bmp";case"image/gif":return"gif";case"image/svg+xml":return"svg";default:return"png"}},_getExtent:function(e,t,i){var s;if(e){s=new c;var r=parseFloat(e.getAttribute("minx")),a=parseFloat(e.getAttribute("miny")),n=parseFloat(e.getAttribute("maxx")),h=parseFloat(e.getAttribute("maxy"));i?(s.xmin=isNaN(a)?-1*Number.MAX_VALUE:a,s.ymin=isNaN(r)?-1*Number.MAX_VALUE:r,s.xmax=isNaN(h)?Number.MAX_VALUE:h,s.ymax=isNaN(n)?Number.MAX_VALUE:n):(s.xmin=isNaN(r)?-1*Number.MAX_VALUE:r,s.ymin=isNaN(a)?-1*Number.MAX_VALUE:a,s.xmax=isNaN(n)?Number.MAX_VALUE:n,s.ymax=isNaN(h)?Number.MAX_VALUE:h),s.spatialReference=new f({wkid:t})}return s},_useLatLong:function(e){var t,i;for(i=0;i<this._REVERSED_LAT_LONG_RANGES.length;i++){var s=this._REVERSED_LAT_LONG_RANGES[i];if(e>=s[0]&&e<=s[1]){t=!0;break}}return t},_getTag:function(e,i){var s=t.query(e,i);return s&&s.length>0?s[0]:null},_getTagValue:function(e,i,s){var r=t.query(e,i);return r&&r.length>0?r[0].text?r[0].text:r[0].textContent:s},_getAttributeValue:function(e,i,s,r){var a=t.query(e,s);return a&&a.length>0?a[0].getAttribute(i):r},_checkVisibleLayersList:function(e){if(e&&e.length>0&&this.layerInfos&&this.layerInfos.length>0&&"number"==typeof e[0]){var t=[];r.forEach(e,function(e){e<this.layerInfos.length&&t.push(this.layerInfos[e].name)},this),e=t}return e},_stripParameters:function(e,t){var i,s=u.urlToObject(e),a=[];for(i in s.query)s.query.hasOwnProperty(i)&&-1===r.indexOf(t,i.toLowerCase())&&a.push(i+"="+s.query[i]);return s.path+(a.length?"?"+a.join("&"):"")},_getPopupGraphic:function(t,i){var s=this.visibleLayers;if(!s||0===s.length)return null;var a=this._popupGraphic;if(!a){var n=new g({title:this.title||"",description:'<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%;"><iframe src="{QUERY_URL}" width="250" height="147" frameborder="0" marginwidth="0" marginheight="0" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;background:url(\''+e.toUrl("../dijit/images/loading-throb.gif")+"') transparent center no-repeat;\" onload=\"(event.target || event.srcElement).style.background = 'none';\"></iframe></div>"});a=this._popupGraphic=new h(null,null,{},n),a._layer=this}var o=function(e){var t=[];if(e&&(e.queryable&&e.showPopup&&e.name&&t.push(e.name),e.subLayers))for(var i=0;i<e.subLayers.length;i++){var s=o(e.subLayers[i]);s.length&&(t=t.concat(s))}return t},l=o({subLayers:this.layerInfos});if(l=r.filter(l,function(e){return r.indexOf(s,e)>-1}),l.length){var u=this.getFeatureInfoURL,f=this._getImageParams(t.extent,t.width,t.height);f=this._mixinCustomLayerParameters(f),f.REQUEST="GetFeatureInfo",f.INFO_FORMAT=this.featureInfoFormat,f.QUERY_LAYERS=l.join(),f.FEATURE_COUNT=25,"1.3.0"===this.version?(f.I=Math.round(i.x),f.J=Math.round(i.y)):(f.X=Math.round(i.x),f.Y=Math.round(i.y)),u+=-1===u.indexOf("?")?"?":"";for(var c in f)f.hasOwnProperty(c)&&(u+="?"===u.substring(u.length-1,u.length)?"":"&",u+=c+"="+f[c]);return a.attributes.QUERY_URL=u,a}return null},_mixinCustomParameters:function(e){if(this.customParameters)for(var t in this.customParameters)e[t]=encodeURIComponent(this.customParameters[t]);return e},_mixinCustomLayerParameters:function(e){if(this.customLayerParameters||this.customParameters){var t=s.clone(this.customParameters||{});s.mixin(t,this.customLayerParameters||{});for(var i in t)"styles"===i.toLowerCase()&&delete e.STYLES,e[i]=encodeURIComponent(t[i])}return e}});return a("extend-esri")&&s.setObject("layers.WMSLayer",y,o),y});