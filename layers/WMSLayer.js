/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../config","../Graphic","../PopupTemplate","../request","../core/Collection","../core/CollectionFlattener","../core/jsonMap","../core/lang","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/write","../geometry/Extent","../geometry/SpatialReference","../geometry/support/scaleUtils","../geometry/support/spatialReferenceUtils","./Layer","./mixins/BlendLayer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./ogc/crsUtils","./support/arcgisLayerUrl","./support/commonProperties","./support/ExportWMSImageParameters","./support/imageBitmapUtils","./support/WMSSublayer","./support/wmsUtils"],(function(e,t,r,o,a,n,i,s,l,p,u,c,y,m,d,f,g,h,_,b,S,v,w,x,I,F,P,E,O,R,L,T,M,U,j,W,N,C,q){"use strict";const $=new l.JSONMap({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});function B(e){return"text/html"===e}function k(e){return"text/plain"===e}let G=function(t){function i(...r){var o;return(o=t.call(this,...r)||this).allSublayers=new s({getCollections:()=>[o.sublayers],getChildrenFunction:e=>e.sublayers}),o.customParameters=null,o.customLayerParameters=null,o.copyright=null,o.description=null,o.dimensions=null,o.fullExtent=null,o.fullExtents=null,o.featureInfoFormats=null,o.featureInfoUrl=null,o.fetchFeatureInfoFunction=null,o.imageFormat=null,o.imageMaxHeight=2048,o.imageMaxWidth=2048,o.imageTransparency=!0,o.legendEnabled=!0,o.mapUrl=null,o.isReference=null,o.operationalLayerType="WMS",o.spatialReference=null,o.spatialReferences=null,o.sublayers=null,o.type="wms",o.url=null,o.version=null,o.addHandles([m.on((()=>o.sublayers),"after-add",(({item:t})=>{t.parent=t.layer=e._assertThisInitialized(o)}),m.sync),m.on((()=>o.sublayers),"after-remove",(({item:e})=>{e.layer=e.parent=null}),m.sync),m.watch((()=>o.sublayers),((t,r)=>{if(r)for(const e of r)e.layer=e.parent=null;if(t)for(const a of t)a.parent=a.layer=e._assertThisInitialized(o)}),m.sync)]),o}e._inheritsLoose(i,t);var l=i.prototype;return l.normalizeCtorArgs=function(e,t){return"string"==typeof e?{url:e,...t}:e},l.load=function(e){const t=u.isSome(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},e).catch(y.throwIfAbortError).then((()=>this._fetchService(t)))),Promise.resolve(this)},l.readFullExtentFromItemOrMap=function(e,t){const r=t.extent;return r?new v({xmin:r[0][0],ymin:r[0][1],xmax:r[1][0],ymax:r[1][1]}):null},l.writeFullExtent=function(e,t){t.extent=[[e.xmin,e.ymin],[e.xmax,e.ymax]]},l.readImageFormat=function(e,t){const r=t.supportedImageFormatTypes;return r&&r.includes("image/png")?"image/png":r&&r[0]},l.readSpatialReferenceFromItemOrDocument=function(e,t){return new w(t.spatialReferences[0])},l.writeSpatialReferences=function(e,t){const r=this.spatialReference?.wkid;e&&r?(t.spatialReferences=e.filter((e=>e!==r)),t.spatialReferences.unshift(r)):t.spatialReferences=e},l.readSublayersFromItemOrMap=function(e,t,r){return A(t.layers,r,t.visibleLayers)},l.readSublayers=function(e,t,r){return A(t.layers,r)},l.writeSublayers=function(e,t,r,o){t.layers=[];const a=new Map,n=e.flatten((({sublayers:e})=>e??[]));for(const i of n)if("number"==typeof i.parent?.id){const e=a.get(i.parent.id);null!=e?e.push(i.id):a.set(i.parent.id,[i.id])}for(const i of n){const e={sublayer:i,...o},r=i.write({parentLayerId:"number"==typeof i.parent?.id?i.parent.id:-1},e);if(a.has(i.id)&&(r.sublayerIds=a.get(i.id)),!i.sublayers&&i.name){const r=i.write({},e);delete r.id,t.layers.push(r)}}t.visibleLayers=n.filter((({visible:e,sublayers:t})=>e&&!t)).map((({name:e})=>e)).toArray()},l.createExportImageParameters=function(e,t,r,o){const a=o?.pixelRatio??1,n=x.getScale({extent:e,width:t})*a,i=new W.ExportWMSImageParameters({layer:this,scale:n}),{xmin:s,ymin:l,xmax:p,ymax:u,spatialReference:c}=e,y=q.normalizeWKID(c,this.spatialReferences),m="1.3.0"===this.version&&M.isAxesOrderReversedForWkid(y)?`${l},${s},${u},${p}`:`${s},${l},${p},${u}`,d=i.toJSON();return{bbox:m,["1.3.0"===this.version?"crs":"srs"]:null==y||isNaN(y)?void 0:"EPSG:"+y,...d}},l.fetchImage=function(){var t=e._asyncToGenerator((function*(e,t,r,o){const a=this.mapUrl,i=this.createExportImageParameters(e,t,r,o);if(!i.layers){const e=document.createElement("canvas");return e.width=t,e.height=r,e}const s=o?.timeExtent?.start,l=o?.timeExtent?.end,p=u.isSome(s)&&u.isSome(l)?s.getTime()===l.getTime()?q.toISOString(s):`${q.toISOString(s)}/${q.toISOString(l)}`:void 0,c={responseType:"image",query:this._mixCustomParameters({width:t,height:r,...i,time:p,...this.refreshParameters}),signal:o?.signal};return n(a??"",c).then((e=>e.data))}));function r(e,r,o,a){return t.apply(this,arguments)}return r}(),l.fetchImageBitmap=function(){var t=e._asyncToGenerator((function*(e,t,r,o){const a=this.mapUrl??"",i=this.createExportImageParameters(e,t,r,o);if(!i.layers){const e=document.createElement("canvas");return e.width=t,e.height=r,e}const s=o?.timeExtent?.start,l=o?.timeExtent?.end,p=u.isSome(s)&&u.isSome(l)?s.getTime()===l.getTime()?q.toISOString(s):`${q.toISOString(s)}/${q.toISOString(l)}`:void 0,c={responseType:"blob",query:this._mixCustomParameters({width:t,height:r,...i,time:p,...this.refreshParameters}),signal:o?.signal},{data:y}=yield n(a,c);return N.createBitmap(y,a)}));function r(e,r,o,a){return t.apply(this,arguments)}return r}(),l.fetchFeatureInfo=function(e,t,r,o,a){const n=x.getScale({extent:e,width:t}),i=new W.ExportWMSImageParameters({layer:this,scale:n}),s=q.getPopupLayers(i.visibleSublayers);if(u.isNone(this.featureInfoUrl)||u.isNone(s))return Promise.resolve([]);if(u.isNone(this.fetchFeatureInfoFunction)&&u.isNone(this.featureInfoFormat))return Promise.resolve([]);const l="1.3.0"===this.version?{I:o,J:a}:{x:o,y:a},p={query_layers:s,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:t,height:r,...l},c={...this.createExportImageParameters(e,t,r),...p},y=this._mixCustomParameters(c);return u.isSome(this.fetchFeatureInfoFunction)?this.fetchFeatureInfoFunction(y):this._defaultFetchFeatureInfoFunction(d.addQueryParameters(this.featureInfoUrl,y))},l.findSublayerById=function(e){return this.allSublayers.find((t=>t.id===e))},l.findSublayerByName=function(e){return this.allSublayers.find((t=>t.name===e))},l.serviceSupportsSpatialReference=function(e){return U.isWmsServer(this.url)||null!=this.spatialReferences&&this.spatialReferences.some((t=>{const r=900913===t?w.WebMercator:new w({wkid:t});return I.equals(r,e)}))},l._defaultFetchFeatureInfoFunction=function(e){const t=document.createElement("iframe");t.src=d.addProxy(e),t.style.border="none",t.style.margin="0",t.style.width="100%",t.setAttribute("sandbox","");const r=new a({title:this.title,content:t}),n=new o({sourceLayer:this,popupTemplate:r});return Promise.resolve([n])},l._fetchService=function(){var t=e._asyncToGenerator((function*(e){if(!this.resourceInfo){const{path:t,query:r}=this.parsedUrl??{};r?.service&&(r.SERVICE=r.service,delete r.service),r?.request&&(r.REQUEST=r.request,delete r.request);const{data:o}=yield n(t??"",{query:{SERVICE:"WMS",REQUEST:"GetCapabilities",...r,...this.customParameters},responseType:"xml",signal:e});this.resourceInfo=q.parseCapabilities(o)}if(this.parsedUrl){const e=new d.Url(this.parsedUrl.path),{httpsDomains:t}=r.request;"https"!==e.scheme||e.port&&"443"!==e.port||!e.host||t.includes(e.host)||t.push(e.host)}this.read(this.resourceInfo,{origin:"service"})}));function o(e){return t.apply(this,arguments)}return o}(),l._mixCustomParameters=function(e){if(!this.customLayerParameters&&!this.customParameters)return e;const t={...this.customParameters,...this.customLayerParameters};for(const r in t)e[r.toLowerCase()]=t[r];return e},e._createClass(i,[{key:"featureInfoFormat",get:function(){return u.isNone(this.featureInfoFormats)?null:this.featureInfoFormats.find(B)??this.featureInfoFormats.find(k)??null},set:function(e){u.isSome(e)?(B(e)||k(e))&&this._override("featureInfoFormat",e):(this.revert("featureInfoFormat","service"),this._clearOverride("featureInfoFormat"))}}]),i}(P.BlendLayer(T.TemporalLayer(R.RefreshableLayer(L.ScaleRangeLayer(E.OperationalLayer(O.PortalLayer(c.MultiOriginJSONMixin(F))))))));function H(e,t){return e.some((e=>{for(const r in e)if(S.willPropertyWrite(e,r,null,t))return!0;return!1}))}function A(e,t,r){e=e??[];const o=new Map;e.every((e=>null==e.id))&&(e=p.clone(e)).forEach(((e,t)=>e.id=t));for(const n of e){const e=new C;e.read(n,t),r&&!r.includes(e.name)&&(e.visible=!1),o.set(e.id,e)}const a=[];for(const n of e){const e=null!=n.id?o.get(n.id):null;if(e)if(null!=n.parentLayerId&&n.parentLayerId>=0){const t=o.get(n.parentLayerId);if(!t)continue;t.sublayers||(t.sublayers=new i),t.sublayers.push(e)}else a.push(e)}return a}t.__decorate([f.property({readOnly:!0})],G.prototype,"allSublayers",void 0),t.__decorate([f.property({json:{type:Object,write:!0}})],G.prototype,"customParameters",void 0),t.__decorate([f.property({json:{type:Object,write:!0}})],G.prototype,"customLayerParameters",void 0),t.__decorate([f.property({type:String,json:{write:!0}})],G.prototype,"copyright",void 0),t.__decorate([f.property()],G.prototype,"description",void 0),t.__decorate([f.property({readOnly:!0})],G.prototype,"dimensions",void 0),t.__decorate([f.property({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{"web-document":{write:{ignoreOrigin:!0}},"portal-item":{write:{ignoreOrigin:!0}}}}})],G.prototype,"fullExtent",void 0),t.__decorate([h.reader(["web-document","portal-item"],"fullExtent",["extent"])],G.prototype,"readFullExtentFromItemOrMap",null),t.__decorate([b.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],G.prototype,"writeFullExtent",null),t.__decorate([f.property()],G.prototype,"fullExtents",void 0),t.__decorate([f.property({type:String,json:{write:{ignoreOrigin:!0}}})],G.prototype,"featureInfoFormat",null),t.__decorate([f.property({type:[String],readOnly:!0})],G.prototype,"featureInfoFormats",void 0),t.__decorate([f.property({type:String,json:{write:{ignoreOrigin:!0}}})],G.prototype,"featureInfoUrl",void 0),t.__decorate([f.property()],G.prototype,"fetchFeatureInfoFunction",void 0),t.__decorate([f.property({type:String,json:{origins:{"web-document":{default:"image/png",type:$.jsonValues,read:{reader:$.read,source:"format"},write:{writer:$.write,target:"format"}}}}})],G.prototype,"imageFormat",void 0),t.__decorate([h.reader("imageFormat",["supportedImageFormatTypes"])],G.prototype,"readImageFormat",null),t.__decorate([f.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],G.prototype,"imageMaxHeight",void 0),t.__decorate([f.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],G.prototype,"imageMaxWidth",void 0),t.__decorate([f.property()],G.prototype,"imageTransparency",void 0),t.__decorate([f.property(j.legendEnabled)],G.prototype,"legendEnabled",void 0),t.__decorate([f.property({type:["show","hide","hide-children"]})],G.prototype,"listMode",void 0),t.__decorate([f.property({type:String,json:{write:{ignoreOrigin:!0}}})],G.prototype,"mapUrl",void 0),t.__decorate([f.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],G.prototype,"isReference",void 0),t.__decorate([f.property({type:["WMS"]})],G.prototype,"operationalLayerType",void 0),t.__decorate([f.property()],G.prototype,"resourceInfo",void 0),t.__decorate([f.property({type:w,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],G.prototype,"spatialReference",void 0),t.__decorate([h.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],G.prototype,"readSpatialReferenceFromItemOrDocument",null),t.__decorate([f.property({type:[g.Integer],json:{read:!1,origins:{service:{read:!0},"web-document":{read:!1,write:{ignoreOrigin:!0}},"portal-item":{read:!1,write:{ignoreOrigin:!0}}}}})],G.prototype,"spatialReferences",void 0),t.__decorate([b.writer(["web-document","portal-item"],"spatialReferences")],G.prototype,"writeSpatialReferences",null),t.__decorate([f.property({type:i.ofType(C),json:{write:{target:"layers",overridePolicy(e,t,r){if(H(this.allSublayers,r))return{ignoreOrigin:!0}}}}})],G.prototype,"sublayers",void 0),t.__decorate([h.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],G.prototype,"readSublayersFromItemOrMap",null),t.__decorate([h.reader("service","sublayers",["layers"])],G.prototype,"readSublayers",null),t.__decorate([b.writer("sublayers",{layers:{type:[C]},visibleLayers:{type:[String]}})],G.prototype,"writeSublayers",null),t.__decorate([f.property({json:{read:!1},readOnly:!0,value:"wms"})],G.prototype,"type",void 0),t.__decorate([f.property(j.url)],G.prototype,"url",void 0),t.__decorate([f.property({type:String,json:{write:{ignoreOrigin:!0}}})],G.prototype,"version",void 0),G=t.__decorate([_.subclass("esri.layers.WMSLayer")],G);return G}));
