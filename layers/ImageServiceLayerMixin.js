define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/json","dojo/_base/config","dojo/_base/connect","dojo/has","dojo/io-query","../kernel","../config","../lang","../request","../deferredUtils","../urlUtils","../geometry/Extent","../geometry/Point","../geometry/Polygon","./MosaicRule","./RasterFunction","./DimensionalDefinition","./Raster","./PixelBlock","./pixelFilters/VectorFieldPixelFilter","./rasterFormats/ImageCanvasDecoder","./TimeInfo","./Field","../graphic","../tasks/ImageServiceIdentifyTask","../tasks/ImageServiceIdentifyParameters"],function(e,t,i,a,s,n,r,l,o,h,u,c,d,m,f,p,g,_,b,v,x,D,R,y,T,I,w,F,P,V){var C=e(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0},constructor:function(e,t){this.useMapTime=t&&t.hasOwnProperty("useMapTime")?!!t.useMapTime:!0},_initialize:function(e,i){this._url=f.urlToObject(e),this.raster=new D(e),this.infoTemplate=i&&i.infoTemplate;var a=i&&i.imageServiceParameters;this.format=a&&a.format,this.compressionTolerance=a&&a.compressionTolerance?a.compressionTolerance:.01,this.interpolation=a?a.interpolation:null,this.compressionQuality=a?a.compressionQuality:null,this.bandIds=a?a.bandIds:null,this.mosaicRule=a?a.mosaicRule:null,this.renderingRule=a?a.renderingRule:null,this.useMapDimensionValue=i&&i.hasOwnProperty("useMapDimensionValue")?!!i.useMapDimensionValue:!0,this.activeMapDimensions=i&&i.activeMapDimensions,this._params=t.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},a?a.toJson():{}),this.pixelFilter=i&&i.pixelFilter,this.pixelData=null,this.originalPixelData=null,this.hasDataChanged=!0,this._requestDataHandler=t.hitch(this,this._requestDataHandler),this._requestDataErrorHandler=t.hitch(this,this._requestDataErrorHandler),this._rasterReadPromise=null,this._initLayer=t.hitch(this,this._initLayer),this._queryVisibleRastersHandler=t.hitch(this,this._queryVisibleRastersHandler),this._visibleRasters=[],this._rasterAttributeTableFields=[],this._rasterAttributeTableFeatures=[],this._loadCallback=i&&i.loadCallback;var s=i&&i.resourceInfo;s?this._initLayer(s):d({url:this._url.path,content:t.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}),this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(e){if(null!==e&&void 0!==e){this._findCredential();var i=this.credential&&this.credential.ssl||e&&e._ssl;i&&this._useSSL();var a=this.minScale,s=this.maxScale;t.mixin(this,e),this.minScale=a,this.maxScale=s,this.initialExtent=this.fullExtent=this.extent=new p(e.extent),this.spatialReference=this.initialExtent.spatialReference,this.pixelSizeX=parseFloat(this.pixelSizeX),this.pixelSizeY=parseFloat(this.pixelSizeY);var n,r,l=this.minValues,o=this.maxValues,h=this.meanValues,u=this.stdvValues,d=this.bands=[];for(n=0,r=this.bandCount;r>n;n++)d[n]={min:l[n],max:o[n],mean:h[n],stddev:u[n]};var m=this.timeInfo;this.timeInfo=m&&m.timeExtent?new I(m):null;var f=this.fields=[],g=e.fields;if(g)for(n=0;n<g.length;n++)f.push(new w(g[n]));if(this.version=e.currentVersion,!this.version){var _;_="fields"in e||"objectIdField"in e||"timeInfo"in e?10:9.3,this.version=_}c.isDefined(e.minScale)&&!this._hasMin&&this.setMinScale(e.minScale),c.isDefined(e.maxScale)&&!this._hasMax&&this.setMaxScale(e.maxScale);var v={};if(e.defaultMosaicMethod?(v.method=e.defaultMosaicMethod,v.operation=e.mosaicOperator,v.sortField=e.sortField,v.sortValue=e.sortValue):v.method=b.METHOD_NONE,this.defaultMosaicRule=new b(v),this.defaultMosaicRule.ascending=!0,this._setDefaultRenderingRule(!0),this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0),this.version>10&&this.hasRasterAttributeTable){var x=this.getRasterAttributeTable();x.then(t.hitch(this,function(e){e&&e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=t.clone(e.features)),e&&e.fields&&e.fields.length>0&&(this._rasterAttributeTableFields=t.clone(e.fields))}))}this._isVectorData()&&!c.isDefined(this.pixelFilter)&&(this.vectorFieldPixelFilter=new y,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===this.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,this.getKeyProperties().then(t.hitch(this,this._setFlowRepresentation))),this.loaded=!0,this.onLoad(this);var D=this._loadCallback;D&&(delete this._loadCallback,D(this))}},getKeyProperties:function(){var e=this._url.path+"/keyProperties",t=new i(m._dfdCanceller);if(this.version>10)t._pendingDfd=d({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then(function(e){t.callback(e)},function(e){t.errback(e)});else{var a=new Error("Layer does not have key properties");a.log=n.isDebug,t.errback(a)}return t},getRasterAttributeTable:function(){var e=this._url.path+"/rasterAttributeTable",t=new i(m._dfdCanceller);if(this.version>10&&this.hasRasterAttributeTable)t._pendingDfd=d({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then(function(e){t.callback(e)},function(e){t.errback(e)});else{var a=new Error("Layer does not support raster attribute table");a.log=n.isDebug,t.errback(a)}return t},_getRasterAttributeTableFeatures:function(){var e=new i;if(this._rasterAttributeTableFeatures&&this._rasterAttributeTableFeatures.length>0)return e.resolve(this._rasterAttributeTableFeatures),e;if(this.version>10&&this.hasRasterAttributeTable){var a=this.getRasterAttributeTable();return a.then(t.hitch(this,function(e){e&&e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=t.clone(e.features))})),a}return e.resolve(this._rasterAttributeTableFeatures),e},getCustomRasterFields:function(e){var i=e?e.rasterAttributeTableFieldPrefix:"",s={name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeString"},n={name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeString"},r=this.fields?t.clone(this.fields):[],l=r.length;if(r[l]=n,(this.capabilities&&this.capabilities.toLowerCase().indexOf("catalog")>-1||this.fields&&this.fields.length>0)&&(r[l+1]=s),c.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var o={name:"Raster.Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},h={name:"Raster.Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"};r[l+2]=o,r[l+3]=h}if(this._rasterAttributeTableFields&&this._rasterAttributeTableFields.length>0){var u=a.filter(this._rasterAttributeTableFields,function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()}),d=a.map(u,function(e){var a=t.clone(e);return a.name=i+e.name,a});r=r.concat(d)}return r},_prepareGetImageParameters:function(e,i,a,n){n=c.isDefined(n)?n:this._params;var r=e.spatialReference.wkid||s.toJson(e.spatialReference.toJson(!1));delete n._ts,t.mixin(n,{bbox:e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,imageSR:r,bboxSR:r,size:i+","+a},this.disableClientCaching?{_ts:(new Date).getTime()}:{}),delete n.compressionTolerance,n.format&&"LERC"===n.format.toUpperCase()&&(n.compressionTolerance=this.compressionTolerance),n.token=this._getToken()},getImageUrl:function(e,i,a,s,n){n=c.isDefined(n)?n:this._params,this._prepareGetImageParameters(e,i,a,n);var r=t.clone(n);this._cleanupRequestParams(r);var l=this._url.path+"/exportImage?",h=f.addProxy(l+o.objectToQuery(t.mixin(r,{f:"image"}))),m=r.token;h.length>u.defaults.io.postLength||this.useMapImage?this._jsonRequest=d({url:l,content:t.mixin(r,{f:"json"}),callbackParamName:"callback",load:function(e){var t=e.href;m&&(t+=-1===t.indexOf("?")?"?token="+m:"&token="+m),s(f.addProxy(t))},error:this._errorHandler}):s(h)},onRenderingChange:function(){},onMosaicRuleChange:function(){},setInterpolation:function(e,t){this.interpolation=this._params.interpolation=e,t||this.refresh(!0)},setCompressionQuality:function(e,t){this.compressionQuality=this._params.compressionQuality=e,t||this.refresh(!0)},setCompressionTolerance:function(e,t){this.compressionTolerance=e,t||this.refresh(!0)},setBandIds:function(e,t){var i=!1;this.bandIds!==e&&(i=!0),this.bandIds=e,this._params.bandIds=e.join(","),i&&!t&&this.onRenderingChange(),t||this.refresh(!0)},setDefaultBandIds:function(e){this.bandIds=this._params.bandIds=null,e||this.refresh(!0)},setDisableClientCaching:function(e){this.disableClientCaching=e},setMosaicRule:function(e,t){var i=!1;this.mosaicRule!==e&&(i=!0),this.mosaicRule=e,this._params.mosaicRule=s.toJson(e.toJson()),i&&!t&&this.onMosaicRuleChange(),t||this.refresh(!0)},setRenderingRule:function(e,t){var i=!1;this.renderingRule!==e&&(i=!0),this.renderingRule=e,this._params.renderingRule=e?s.toJson(e.toJson()):null,i&&!t&&this.onRenderingChange(),t||this.refresh(!0)},setImageFormat:function(e,t){this.format=this._params.format=e,t||this.refresh(!0)},setInfoTemplate:function(e){this.infoTemplate=e},setDefinitionExpression:function(e,t){var i=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?i=this.defaultMosaicRule.toJson():i.method=b.METHOD_NONE),i.where=e;var a=new b(i);return this.setMosaicRule(a,t),this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(e){this.pixelFilter=e},getPixelData:function(e){if(e){var t=this._useBrowserDecoding();return t&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData}return this.pixelData},redraw:function(){this.hasDataChanged=!1,this._setPixelData(this.originalPixelData)},queryVisibleRasters:function(e,t,a,s){var n=this._map,r=m._fixDfd(new i(m._dfdCanceller));this._visibleRasters=[];var l,o,h,u=!0;if(this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&this.infoTemplate.info.fieldInfos.length>0)for(u=!1,h=this.infoTemplate.info,l=0;l<h.fieldInfos.length;l++)if(o=h.fieldInfos[l],o&&"raster.servicepixelvalue"!==o.fieldName.toLowerCase()&&(o.visible||h.title&&h.title.toLowerCase().indexOf(o.fieldName.toLowerCase())>-1)){u=!0;break}var c=new V;if(c.geometry=e.geometry,c.returnGeometry=this._map.spatialReference.equals(this.spatialReference),c.returnCatalogItems=u,c.timeExtent=e.timeExtent,c.mosaicRule=this.mosaicRule?this.mosaicRule:null,c.renderingRule=this.renderingRule?this.renderingRule:null,n){var d=(n.extent.xmax-n.extent.xmin)/(2*n.width),f=(n.extent.ymax-n.extent.ymin)/(2*n.height),p=n.extent.spatialReference,_=new g(d,f,p);c.pixelSize=_}var b=this,v=new P(this.url),x=r._pendingDfd=v.execute(c);return x.addCallbacks(function(e){b._queryVisibleRastersHandler(e,t,a,s,r)},function(e){b._resolve([e],null,s,r,!0)}),r},_queryVisibleRastersHandler:function(e,i,n,r,l){function o(){var e,s,r,o,d,m,g,_,b,v,D=this.getCustomRasterFields(i),y=this._getDomainFields(D),T=i?i.returnDomainValues:!1,I=i&&i.rasterAttributeTableFieldPrefix,w=this._getRasterAttributeTableFeatures();w.then(t.hitch(this,function(i){for(e=0;e<u.length;e++){if(P=u[e],s=P.attributes[x],P.setInfoTemplate(this.infoTemplate),P._layer=this,f){if(r=f,h&&h.length>=e&&(o=h[e],r=o.replace(/ /gi,", ")),P.attributes["Raster.ItemPixelValue"]=r,P.attributes["Raster.ServicePixelValue"]=f,this.pixelFilter){v=r.replace(" ","").split(",");var D=new R({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});a.forEach(v,function(e){D.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})}),this.pixelFilter({pixelBlock:D,extent:new p(0,0,0,0,this._map.spatialReference)}),("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)&&(P.attributes["Raster.Magnitude"]=D.pixels[0][0],P.attributes["Raster.Direction"]=D.pixels[1][0])}if(i&&i.length>0&&(d=a.filter(i,function(e){return e&&e.attributes?e.attributes.hasOwnProperty("Value")?e.attributes.Value==r:e.attributes.VALUE==r:void 0}),d.length>0&&(m=t.clone(d[0]),I&&m))){b={};for(g in m.attributes)m.attributes.hasOwnProperty(g)&&(_=I+g,b[_]=m.attributes[g]);m.attributes=b,P.attributes=t.mixin(P.attributes,m.attributes)}}T&&y&&y.length>0&&a.forEach(y,function(e){if(e){var t=P.attributes[e.name];if(c.isDefined(t)){var i=this._getDomainValue(e.domain,t);c.isDefined(i)&&(P.attributes[e.name]=i)}}},this),M.push(P),this._visibleRasters.push(P)}this._resolve([M,null,!0],null,n,l)}))}var h,u,m,f=e.value,g=0,b=0,v=this,x=this.objectIdField;if(e.catalogItems){var D,y,T=0,I=e.catalogItems.features.length,w=0;for(u=new Array(I),h=new Array(I),m=new Array(I),g=0;I>g;g++)e.properties.Values[g].toLowerCase().indexOf("nodata")>-1&&w++;for(D=I-w,g=0;I>g;g++)y=e.properties.Values[g].toLowerCase().indexOf("nodata")>-1?D++:T++,u[y]=e.catalogItems.features[g],h[y]=e.properties.Values[g],m[y]=u[y].attributes[x]}this._visibleRasters=[];var P,V=f.toLowerCase().indexOf("nodata")>-1;if(f&&!u&&!V){x="ObjectId",u=[];var C={};C.ObjectId=0,P=new F(new p(this.fullExtent),null,C),u.push(P)}var M=[];return u?void(!this._map.spatialReference.equals(this.spatialReference)&&m&&m.length>0?d({url:this._url.path+"/query",content:{f:"json",objectIds:m.join(","),returnGeometry:!0,outSR:s.toJson(v._map.spatialReference.toJson()),outFields:x},handleAs:"json",callbackParamName:"callback",load:function(e){if(0===e.features.length)return void v._resolve([M,null,null],null,n,l);for(g=0;g<e.features.length;g++)for(b=0;b<u.length;b++)u[b].attributes[x]==e.features[g].attributes[x]&&(u[b].geometry=new _(e.features[g].geometry),u[b].geometry.setSpatialReference(v._map.spatialReference));o.call(v)},error:function(){v._resolve([M,null,null],null,n,l)}}):o.call(this)):void this._resolve([M,null,null],null,n,l)},getVisibleRasters:function(){var e,t=this._visibleRasters,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},_getDomainFields:function(e){if(e){var t=[];return a.forEach(e,function(e){if(e.domain){var i={};i.name=e.name,i.domain=e.domain,t.push(i)}}),t}},_getDomainValue:function(e,t){if(e&&e.codedValues){var i;return a.some(e.codedValues,function(e){return e.code===t?(i=e.name,!0):!1}),i}},_requestData:function(e,i,a){this._rasterReadPromise&&this._rasterReadPromise.cancel();var s=t.clone(e),n=s._normalize(!0);this._prepareGetImageParameters(n,i,a);var r=t.clone(this._params);this._cleanupRequestParams(r),r.extent=s;var l=this._useBrowserDecoding(),o=null;l&&(o=new T({ctx:this._context}));var h={imageServiceParameters:r,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:o?t.hitch(o,"decode"):null};this._rasterReadPromise=this.raster.read(h,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(e){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=e,this.hasDataChanged=!0,this._setPixelData(e))},_setPixelData:function(e){var t=this._clonePixelData(e);this.pixelFilter&&this.pixelFilter(t),this.pixelData=t,this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_drawPixelData:function(){},_requestDataErrorHandler:function(){},_clonePixelData:function(e){if(null===e||void 0===e)return e;var i={};e.extent&&(i.extent=t.clone(e.extent));var a=e.pixelBlock;return null===a||void 0===a?i:(i.pixelBlock=a.clone(),i)},_getPixelBlockFromCanvas:function(e,t,i){var a,s,n,r=e.getImageData(0,0,t,i).data,l=t*i,o=0,h=0,u=new Uint8Array(l),c=new Uint8Array(l),d=new Uint8Array(l),m=new Uint8Array(l),f=1/0,p=1/0,g=1/0,_=-1/0,b=-1/0,v=-1/0;for(o=0;l>o;o++)a=r[h++],s=r[h++],n=r[h++],f=a>f?f:a,_=_>a?_:a,p=s>p?p:s,b=b>s?b:s,g=n>g?g:n,v=v>n?v:n,u[o]=a,c[o]=s,d[o]=n,m[o]=1&r[h++];var x=new R({width:t,height:i,pixels:[u,c,d],pixelType:"U8",mask:m,statistics:[{minValue:f,maxValue:_},{minValue:p,maxValue:b},{minValue:g,maxValue:v}]});return x},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"==this.format.toLowerCase()||this.format.toLowerCase().indexOf("png")>-1)},getMultidimensionalInfo:function(){var e=this._url.path+"/multiDimensionalInfo",a=new i(m._dfdCanceller);if(this._multidimensionalInfo)return a.resolve(this._multidimensionalInfo),a;if(this.version>=10.3&&this.hasMultidimensions)a._pendingDfd=d({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),a._pendingDfd.then(t.hitch(this,function(e){this._multidimensionalInfo=e.multidimensionalInfo,a.callback(e.multidimensionalInfo)}),function(e){a.errback(e)});else{var s=new Error("Layer does not support multidimensional info");s.log=n.isDebug,a.errback(s)}return a},getDefaultMultidimensionalDefinition:function(){var e,a,s,n,r=[],l=new i(m._dfdCanceller);return this._defaultMultidimensionalDefinition?(l.resolve(this._defaultMultidimensionalDefinition),l):(l._pendingDfd=this.getMultidimensionalInfo(),l._pendingDfd.then(t.hitch(this,function(t){e=t,a=e.variables[0].name,s=e.variables[0].dimensions;for(n in s)s.hasOwnProperty(n)&&r.push(s[n].hasRanges&&1==s[n].hasRanges?new x({variableName:a,dimensionName:s[n].name,isSlice:!1,values:[s[n].values[0]]}):new x({variableName:a,dimensionName:s[n].name,isSlice:!0,values:[s[n].extent[0]]}));this._defaultMultidimensionalDefinition=r,l.callback(r)}),function(e){l.errback(e)}),l)},_setDefaultMultidimensionalDefinition:function(e){var i,a={};this.getDefaultMultidimensionalDefinition().then(t.hitch(this,function(s){i=s,i.length>0&&(this.mosaicRule?(a=t.clone(this.mosaicRule),a.multidimensionalDefinition=i):this.defaultMosaicRule?(a=t.clone(this.defaultMosaicRule),a.multidimensionalDefinition=i):a=new b({multidimensionalDefinition:i}),this.setMosaicRule(a,e))}))},_setDefaultRenderingRule:function(e){var t={};if(!this.renderingRule&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"None"!=this.rasterFunctionInfos[0].name)t.rasterFunction=this.rasterFunctionInfos[0].name;else if(!this.renderingRule&&"esri.layers.ArcGISImageServiceVectorLayer"==this.declaredClass&&this.version>10.3){var i="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;t.rasterFunction="Resample",t.rasterFunctionArguments={ResamplingType:i,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}}}t.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new v(t),this.setRenderingRule(this.defaultRenderingRule,e))},_cleanupRequestParams:function(e){if(!e)return e;if(e.time&&e.mosaicRule){var t=new b(s.fromJson(e.mosaicRule));if(t&&t.multidimensionalDefinition&&t.multidimensionalDefinition.length>0){var i=a.filter(t.multidimensionalDefinition,function(e){return"StdTime"!==e.dimensionName});t.multidimensionalDefinition=i,e.mosaicRule=s.toJson(t.toJson())}}var n,r=["displayOnPan","drawMode","styling","id","opacity","visible","resourceInfo","useMapDimensionValue","extent"];for(n in r)e.hasOwnProperty(r[n])&&delete e[r[n]];return e},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific "===this.serviceDataType},_isVectorData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType},_createPixelData:function(e){var t=new R({width:2,height:2,pixels:e,pixelType:this.pixelType,statistics:e}),i=this.fullExtent.getCenter(),a=new p(i.x,i.y,i.x+this.pixelSizeX,i.y+this.pixelSizeY,this.spatialReference),s={pixelBlock:t,extent:a};return s},_resolve:function(e,t,i,a,s){t&&this[t].apply(this,e),i&&i.apply(null,e),a&&m._resDfd(a,e,s)},_toggleTime:function(){var e=this._map;this.timeInfo&&this.useMapTime&&e&&!this.suspended?(this._timeConnect||(this._timeConnect=r.connect(e,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(e.timeExtent)):(r.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},setUseMapTime:function(e,t){this.useMapTime=e,this._toggleTime(),!t&&this._map&&this.refresh(!0)},_setTime:function(e){this._params&&(this._params.time=e?e.toJson().join(","):null)},_onTimeExtentChangeHandler:function(e){this.suspended||(this._setTime(e),this.refresh(!0))}});return l("extend-esri")&&t.setObject("layers.ImageServiceLayerMixin",C,h),C});