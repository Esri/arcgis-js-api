// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/json","dojo/_base/config","dojo/_base/connect","dojo/has","dojo/io-query","dojo/DeferredList","dojo/debounce","../kernel","../config","../lang","../request","../deferredUtils","../urlUtils","../geometry/Extent","../geometry/Point","../geometry/Polygon","../renderers/colorRampUtils","./MosaicRule","./RasterFunction","./DimensionalDefinition","./Raster","./PixelBlock","./pixelFilters/VectorFieldPixelFilter","./rasterFormats/ImageCanvasDecoder","./TimeInfo","./Field","../graphic","../tasks/ImageServiceIdentifyTask","../tasks/ImageServiceIdentifyParameters"],(function(e,i,t,n,r,s,a,l,o,u,h,c,d,f,m,g,p,R,_,v,b,T,x,y,F,I,D,C,w,P,V,S,A){var k=e(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_rasterFunctionServiceInfoProps:["bandCount","pixelType","hasRasterAttributeTable","hasColormap","hasHistograms","minValues","maxValues","meanValues","stdvValues","serviceDataType"],_pixelTypeRanges:{U1:[0,1],U2:[0,3],U4:[0,15],U8:[0,255],S8:[-128,127],U16:[0,65535],S16:[-32768,32767]},_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0,"spatial-reference-change":!0,"renderer-change":!0},_cachedVariableStats:{},_cachedVariableHistogram:{},constructor:function(e,i){this.useMapTime=!i||!i.hasOwnProperty("useMapTime")||!!i.useMapTime},_initialize:function(e,t){this._url=p.urlToObject(e),this.raster=new F(this._url.path),this._rasterFunctionTemplateInfos={},this._rasterFunctionTemplatePromise={},this._customRenderingRuleId={},this.infoTemplate=t&&t.infoTemplate;var n=t&&t.imageServiceParameters;this.format=n&&n.format,this.compressionTolerance=n&&n.compressionTolerance?n.compressionTolerance:.01,this.interpolation=n?n.interpolation:null,this.compressionQuality=n?n.compressionQuality:null,this.bandIds=n?n.bandIds:null,this.mosaicRule=n?n.mosaicRule:null,this.renderingRule=n?n.renderingRule:null,this.renderer=n?n.renderer:null,this.useMapDimensionValue=!t||!t.hasOwnProperty("useMapDimensionValue")||!!t.useMapDimensionValue,this.hasImageFilter=t&&t.hasImageFilter,this.activeMapDimensions=t&&t.activeMapDimensions,this._params=i.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},n?n.toJson():{}),this.pixelFilter=t&&t.pixelFilter,this.pixelData=null,this.originalPixelData=null,this.hasDataChanged=!0,this._requestDataHandler=i.hitch(this,this._requestDataHandler),this._requestDataErrorHandler=i.hitch(this,this._requestDataErrorHandler),this._rasterReadPromise=null,this._initLayer=i.hitch(this,this._initLayer),this._queryVisibleRastersHandler=i.hitch(this,this._queryVisibleRastersHandler),this._visibleRasters=[],this._rasterAttributeTableFields=[],this._rasterAttributeTableFeatures=[],this._renderingRuleAttributeTable={},this._renderingRuleColormap={},this._useRenderingRuleAttributeTable=!1,this._loadCallback=t&&t.loadCallback,n&&n.renderer&&(n.renderer.outputUnit||n.renderer.inputUnit)&&(this.vectorFieldPixelFilter=new D,this.vectorFieldPixelFilter.setUnits(n.renderer.inputUnit,n.renderer.outputUnit));var r=t&&t.resourceInfo;r?this._initLayer(r):m({url:this._url.path,content:i.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}),this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(e,t){if(null!=e){this._findCredential(),(this.credential&&this.credential.ssl||e&&e._ssl)&&this._useSSL();var r=this.minScale,s=this.maxScale;i.mixin(this,e),this.minScale=r,this.maxScale=s,this.initialExtent=this.fullExtent=this.extent=new R(e.extent),this.spatialReference=this.initialExtent.spatialReference,this.pixelSizeX=parseFloat(this.pixelSizeX),this.pixelSizeY=parseFloat(this.pixelSizeY);var a,l,o=this.minValues,u=this.maxValues,h=this.meanValues,c=this.stdvValues,d=this.bands=[];for(a=0,l=this.bandCount;a<l;a++)d[a]={min:o[a],max:u[a],mean:h[a],stddev:c[a]};var m=this.timeInfo;this.timeInfo=m&&m.timeExtent?new w(m):null;var g,p=this.fields=[],_=e.fields;if(_)for(a=0;a<_.length;a++)p.push(new P(_[a]));if(this._updateInfoTemplateFields(this.fields),this.version=e.currentVersion,!this.version)g="fields"in e||"objectIdField"in e||"timeInfo"in e?10:9.3,this.version=g;f.isDefined(e.minScale)&&!this._hasMin&&"Raster"!==e.cacheType&&this.setMinScale(e.minScale),f.isDefined(e.maxScale)&&!this._hasMax&&"Raster"!==e.cacheType&&this.setMaxScale(e.maxScale);var v={};if(e.defaultMosaicMethod?(v.method=e.defaultMosaicMethod,v.operation=e.mosaicOperator,v.sortField=e.sortField,v.sortValue=e.sortValue):v.method=T.METHOD_NONE,this.defaultMosaicRule=new T(v),this.defaultMosaicRule.ascending=!0,this._useRenderingRuleAttributeTable=this.version>10&&"esriImageServiceDataTypeThematic"===this.serviceDataType,this._setDefaultRenderingRule(!0),this._getRenderingRuleAttributeTableAndColormap(),this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0),this.version>10&&this.hasRasterAttributeTable)this.getRasterAttributeTable().then(i.hitch(this,(function(e){e&&(e.features&&e.fields&&(this.rasterAttributeTable=i.clone(e)),e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=i.clone(e.features)),e.fields&&e.fields.length>0&&(this._rasterAttributeTableFields=i.clone(e.fields)),this.renderingRule||!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh())})));this._initVectorPixelFilter(),this.bandIds||2!==this.bandCount||this.renderingRule||"esri.layers.ArcGISImageServiceLayer"!==this.declaredClass||this.setBandIds([0,0,0],!0),!(this.version>=10.3&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length)||this._url.query&&this._url.query.raster||this.getRasterFunctionInfos().then(i.hitch(this,(function(e){if(e&&e.length){this.rasterFunctionInfos=e;var i,t=[];n.forEach(e,(function(e){if(e){var n=e.functionType;i=i||1===n||2===n,t.push(e.name)}}),this),this._hasItemLevelRFT=i,this._rasterFunctionNames=t,i&&(this._initVectorPixelFilter(),this.refresh())}}))),this.loaded=!0,this._setDefaultFilter(),this.onLoad(this);var b=this._loadCallback;b&&(delete this._loadCallback,b(this))}},_updateInfoTemplateFields:function(e){var i,t,n,r;if(e&&!(e.length<1)&&(this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&!(this.infoTemplate.info.fieldInfos.length<1)))for(r=this.infoTemplate.info.fieldInfos,i=0;i<e.length;i++)for(n=e[i],t=0;t<r.length;t++)if(r[t].fieldName.toLowerCase()===n.name.toLowerCase()&&r[t].fieldName!==n.name){r[t].fieldName=n.name;break}},getKeyProperties:function(e){var i=this._url.path+"/keyProperties",n=new t(g._dfdCanceller),a={f:"json"};if(e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson())),this.version>10)n._pendingDfd=m({url:i,content:a,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then((function(e){n.callback(e)}),(function(e){n.errback(e)}));else{var l=new Error("Layer does not have key properties");l.log=!!s.isDebug,n.errback(l)}return n},getRasterAttributeTable:function(e){var i=this._url.path+"/rasterAttributeTable",n=new t(g._dfdCanceller),a={f:"json"},l=this.hasRasterAttributeTable;if(e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson()),l=!0),!this.loaded||this.version>10&&l)n._pendingDfd=m({url:i,content:a,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then((function(e){n.callback(e)}),(function(e){n.errback(e)}));else{var o=new Error("Layer does not support raster attribute table");o.log=!!s.isDebug,n.errback(o)}return n},getRenderingRuleAttributeTable:function(e){var n=new t(g._dfdCanceller);if(!e||!e.renderingRule){var r=new Error("Rendering rule is not specified");return n.errback(r),n}var s=e.renderingRule,a=this._getRenderingRuleId(s);return this._renderingRuleAttributeTable&&a&&this._renderingRuleAttributeTable.hasOwnProperty(a)?n.resolve(this._renderingRuleAttributeTable[a]):n=this.getRasterAttributeTable({renderingRule:s}).then(i.hitch(this,(function(e){var t;return e&&e.features&&e.features.length&&e.fields&&e.fields.length&&(t={features:i.clone(e.features),fields:i.clone(e.fields)},a&&(this._renderingRuleAttributeTable[a]=t)),t}))),n},_initVectorPixelFilter:function(){var e,t;if(this._hasItemLevelRFT&&this.renderingRule&&(e=this._getItemLevelRenderingRule(this.renderingRule)),t=e||this.renderingRule)return this.getRenderingRuleServiceInfo(t).then(i.hitch(this,(function(e){e&&(!this._isVectorData(e)&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass||f.isDefined(this.pixelFilter)||(this.vectorFieldPixelFilter=this.vectorFieldPixelFilter||new D,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===e.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,this.getKeyProperties().then(i.hitch(this,this._setFlowRepresentation)),this._applyVectorResamplingType(e.serviceDataType)))})))},_applyVectorResamplingType:function(e){if(e){var i=this.renderingRule;if(i&&"Resample"===i.functionName)(i.functionArguments||{}).ResamplingType="esriImageServiceDataTypeVector-UV"===e?7:10,this.setRenderingRule(new x(i.toJson()))}},_getRasterAttributeTableFeatures:function(){var e=new t;if(this._rasterAttributeTableFeatures&&this._rasterAttributeTableFeatures.length>0)return e.resolve(this._rasterAttributeTableFeatures),e;if(this.version>10&&this.hasRasterAttributeTable){var n=this.getRasterAttributeTable();return n.then(i.hitch(this,(function(e){e&&e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=i.clone(e.features))}))),n}return e.resolve(this._rasterAttributeTableFeatures),e},_getRenderingRuleAttributeTableFeatures:function(e){var i=e&&e.renderingRule;if(!i){var n=new t,r=new Error("Rendering rule is not specified");return n.errback(r),n}return this.getRenderingRuleAttributeTable({renderingRule:i}).then((function(e){return e&&e.features}))},_getRenderingRuleAttributeTableAndColormap:function(){this.renderingRule&&this.getRenderingRuleServiceInfo(this.renderingRule).then(i.hitch(this,(function(e){e.hasRasterAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:this.renderingRule}).then(i.hitch(this,(function(){!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh()}))),e.hasColormap&&this.getRenderingRuleColormap({renderingRule:this.renderingRule}).then(i.hitch(this,(function(){this.renderer&&"esri.renderer.ColormapRenderer"===this.renderer.declaredClass&&this.refresh()})))})))},getCustomRasterFields:function(e){var t=e?e.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix,r=this.version>=10.3?"esriFieldTypeDouble":"esriFieldTypeString",s={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:r},a={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:r},l={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},o=this.fields?i.clone(this.fields):[],u=o.length;if(o[u]=a,this.version>=10.4&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRenderingRuleAProcessingTemplate({functionName:"none"}))&&(u++,o[u]=l),(this.capabilities&&this.capabilities.toLowerCase().indexOf("catalog")>-1||this.fields&&this.fields.length>0)&&(u++,o[u]=s),f.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var h={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},c={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"};u++,o[u]=h,u++,o[u]=c}var d=this._rasterAttributeTableFields,m=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);if(m&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(m)&&(d=this._renderingRuleAttributeTable[m].fields),d&&d.length>0){var g=n.filter(d,(function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()})),p=n.map(g,(function(e){var n=i.clone(e);return n.name=t+e.name,n}));o=o.concat(p)}var R=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;return this.version>=10.4&&this.rasterFunctionInfos&&n.forEach(this.rasterFunctionInfos,(function(e){if(e&&e.name&&"none"!==e.name.toLowerCase()){var i={name:R+e.name.replace(/ /gi,"_"),alias:e.name,domain:null,editable:!1,type:"esriFieldTypeDouble"};o.push(i)}})),o},_applyTimeToMultidimensionalCRF:function(e,t){var n=this._isTimeSupportedOnCRF();if(n&&(!e||!e.multidimensionalDefinition))return e;var r=this.timeInfo&&this.timeInfo.startTimeField;if((t=t||this._params.time)&&r&&this._isMultidimensionalCRF()){(e=i.clone(e||this.defaultMosaicRule)||new T).multidimensionalDefinition=e.multidimensionalDefinition||[];var s=e.multidimensionalDefinition.filter((function(e){return e.dimensionName===r})),a=t.split(",").map((function(e){return parseInt(e,10)}));if(2===a.length&&a[0]===a[1]&&(a.length=1),s.length>0)n?e.multidimensionalDefinition.forEach((function(e){e.dimensionName===r&&(e.declaredClass?(e.dimensionName=null,e.isSlice=null,e.values=null):(delete e.dimensionName,delete e.isSlice,delete e.values))})):e.multidimensionalDefinition.forEach((function(e){e.dimensionName===r&&(e.isSlice=1===a.length,e.values=1===a.length?a:[a])}));else if(!n){e.multidimensionalDefinition.some((function(e){return null!=e.variableName&&null==e.dimensionName}))?e.multidimensionalDefinition.forEach((function(e){null!=e.variableName&&null==e.dimensionName&&(e.dimensionName=r,e.isSlice=1===a.length,e.values=1===a.length?a:[a])})):e.multidimensionalDefinition.push(new y({variableName:"",dimensionName:r,isSlice:1===a.length,values:1===a.length?a:[a]}))}this._cleanupMultidimensionalDefinition(e)}return e},_prepareGetImageParameters:function(e,t,n,s){if(s=f.isDefined(s)?s:this._params,this.renderer||this._hasItemLevelRFT&&this.renderingRule){var a=this.getExportImageRenderingRule();s.renderingRule=a?r.toJson(a.toJson()):null}var l=this.getExportImageMosaicRule(s);s.mosaicRule=l?r.toJson(l.toJson()):null;var o=e.spatialReference.wkid||r.toJson(e.spatialReference.toJson(!1));delete s._ts,i.mixin(s,{bbox:e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,imageSR:o,bboxSR:o,size:t+","+n},this.disableClientCaching?{_ts:(new Date).getTime()}:{}),delete s.compressionTolerance,s.format&&"LERC"===s.format.toUpperCase()&&(s.compressionTolerance=this.compressionTolerance),s.token=this._getToken()},getImageUrl:function(e,t,n,r,s){s=f.isDefined(s)?s:this._params,this._prepareGetImageParameters(e,t,n,s);var a=i.clone(s);this._cleanupRequestParams(a);var l=this._url.path+"/exportImage?",u=p.addProxy(l+o.objectToQuery(i.mixin(a,{f:"image"}))),h=a.token;u.length>d.defaults.io.postLength||this.useMapImage?this._jsonRequest=m({url:l,content:i.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(e,i){var t=e.href;h&&(t+=-1===t.indexOf("?")?"?token="+h:"&token="+h),r(p.addProxy(t))},error:this._errorHandler}):r(u)},onRenderingChange:function(){},onMosaicRuleChange:function(){},onRendererChange:function(){},setInterpolation:function(e,i){this.interpolation=this._params.interpolation=e,i||this.refresh(!0)},setCompressionQuality:function(e,i){this.compressionQuality=this._params.compressionQuality=e,i||this.refresh(!0)},setCompressionTolerance:function(e,i){this.compressionTolerance=e,i||this.refresh(!0)},setBandIds:function(e,i){var t=!1;this.bandIds!==e&&(t=!0),this.bandIds=e,this._params.bandIds=e?e.join(","):null,t&&!i&&this.onRenderingChange(),i||this.refresh(!0)},setDefaultBandIds:function(e){this.bandIds=this._params.bandIds=null,e||this.refresh(!0)},setDisableClientCaching:function(e){this.disableClientCaching=e},setMosaicRule:function(e,i){var t=!1;this.mosaicRule!==e&&(t=!0),this.mosaicRule=e,this._params.mosaicRule=r.toJson(e.toJson()),t&&!i&&this.onMosaicRuleChange(),i||this.refresh(!0)},getRasterFunctionInfos:function(){if(!(this.version<10.3)&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length){var e=this._url.path+"/rasterFunctionInfos";return m({url:e,content:{f:"json"},handleAs:"json",load:function(e){return e&&e.rasterFunctionInfos}})}console.log("Layer doesn't support /rasterFunctionInfos resource.")},setRenderingRule:function(e,i){var t=!1;this.renderingRule!==e&&(t=!0),this.renderingRule=e,this._params.renderingRule=e?r.toJson(e.toJson()):null,this._useRenderingRuleAttributeTable?this.getRenderingRuleAttributeTable({renderingRule:e}):"esri.layers.RasterXLayer"!==this.declaredClass&&this._getRenderingRuleAttributeTableAndColormap(),t&&this.onRenderingChange(),this._setDefaultFilter(),i||this.refresh(!0)},setImageFormat:function(e,i){this.format=this._params.format=e,this._setDefaultFilter(),i||this.refresh(!0)},setInfoTemplate:function(e){this.infoTemplate=e,this._updateInfoTemplateFields(this.fields)},setDefinitionExpression:function(e,i){var t=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?t=this.defaultMosaicRule.toJson():t.method=T.METHOD_NONE),t.where=e;var n=new T(t);return this.setMosaicRule(n,i),this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(e){this.pixelFilter=e,this._isDefaultPixelFilter=!1},getPixelData:function(e){return e?(this._useBrowserDecoding()&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData):this.pixelData},getExportImageRenderingRule:function(){var e;return this._hasItemLevelRFT&&this.renderingRule&&(e=this._getServiceLevelRenderingRule(this.renderingRule)),e=e||this.renderingRule,this._isItemLevelRasterFunction(this.renderingRule)&&(e=void 0),this._combineRenderingRule(this._convertRendererToRenderingRule(this.renderer),e)},getExportImageMosaicRule:function(){var e,i=this.mosaicRule;return this._hasItemLevelRFT&&this.renderingRule&&(e=this._getItemLevelRenderingRule(this.renderingRule)),e&&((i=i||this.defaultMosaicRule||new T).itemRenderingRule=e),i=this._applyTimeToMultidimensionalCRF(i)},redraw:function(){this.hasDataChanged=!1,this._setPixelData(this.originalPixelData)},getHistograms:function(e){var n=e.variableName,r=e.renderingRule||this.renderingRule||this.defaultRenderingRule,a=(r=r&&"none"!==r.functionName.toLowerCase()?r.toJson():null)?r.functionName:"",l=new t(g._dfdCanceller);if((n||""===n)&&this._cachedVariableHistogram[n]&&this._cachedVariableHistogram[n][a])return l.resolve(this._cachedVariableHistogram[n][a]),l;if(this.hasHistograms){var o={f:"json"};n&&(o.variable=n),r&&this.version>10.9&&(o.renderingRule=JSON.stringify(r)),l._pendingDfd=m({url:this._url.path+"/histograms",content:o,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(i.hitch(this,(function(e){(n||""===n)&&(this._cachedVariableHistogram[n]=this._cachedVariableHistogram[n]||{},this._cachedVariableHistogram[n][a]=e),l.callback(e)})),(function(e){l.errback(e)}))}else{var u=new Error("Layer does not have histograms.");u.log=!!s.isDebug,l.errback(u)}return l},computeHistograms:function(e){var n=new t(g._dfdCanceller);if(this.currentVersion>=10.1){var r=(e=e||{}).geometry||this.fullExtent,a=(e.geometry||this.fullExtent).toJson(),l="extent"===r.type?"esriGeometryEnvelope":"esriGeometryPolygon",o=e.renderingRule||this.renderingRule||this.defaultRenderingRule;o=o?o.toJson():null;var u=e.mosaicRule||this.mosaicRule||this.defaultMosaicRule;u=u?u.toJson():null;var h=e.pixelSize||{x:this.pixelSizeX,y:this.pixelSizeY};n._pendingDfd=m({url:this._url.path+"/computeHistograms",content:i.mixin({f:"json",geometry:JSON.stringify(a),geometryType:l,renderingRule:JSON.stringify(o),mosaicRule:JSON.stringify(u),pixelSize:JSON.stringify(h),callbackParamName:"callback"}),handleAs:"json"}),n._pendingDfd.then((function(e){n.callback(e)}),(function(e){n.errback(e)}))}else{var c=new Error("Layer doesn't support computeHistograms.");c.log=!!s.isDebug,n.errback(c)}return n},getRenderingRuleServiceInfo:function(e,r){var s=new g._fixDfd(new t(g._dfdCanceller));if(!e){var a=new Error("Rendering rule is not specified");return s.errback(a),s}function l(e){return e.name&&e.arguments&&e.function&&e.hasOwnProperty("functionType")}if(l(e))"ClipFunction"===e.function.type&&(e=this._handleClipFunctionInRenderingRule(e));else{var o=this._getRenderingRuleId(e);if(o){if(this._rasterFunctionTemplateInfos[o])return s.resolve(this._rasterFunctionTemplateInfos[o]),s;if(this._rasterFunctionTemplatePromise[o])return s=this._rasterFunctionTemplatePromise[o]}}return s=m({url:this._url.path,content:i.mixin(i.mixin({f:"json",renderingRule:JSON.stringify(e.toJson())},this._url.query)),callbackParamName:"callback",load:i.hitch(this,(function(i){var t={};return n.forEach(this._rasterFunctionServiceInfoProps,(function(e){t[e]=i[e]})),l(e)||(this._rasterFunctionTemplateInfos[o]=t),t})),error:r||this._errorHandler}),o&&!this._rasterFunctionTemplatePromise[o]&&(this._rasterFunctionTemplatePromise[o]=s),s},queryVisibleRasters:function(e,r,s,a){var l,o=this._map,u=g._fixDfd(new t(g._dfdCanceller));this._visibleRasters=[];var h,c,d=!0,f=!0,m=null,p=this.infoTemplate?this.infoTemplate.info:null,R=p?i.clone(this.infoTemplate.info.fieldInfos):null;if(r=r||{},p&&this.infoTemplate.info.mediaInfos&&this.infoTemplate.info.mediaInfos.length){var v=[];n.forEach(this.infoTemplate.info.mediaInfos,(function(e){var i=e&&e.value&&e.value.fields||[];v=v.concat(i)})),v.length&&n.forEach(R,(function(e){e&&v.indexOf(e.fieldName)>-1&&(e.visible=!0)}))}var b=function(e){var i=p&&p.title&&p.title.toLowerCase().indexOf(e.toLowerCase())>-1,t=p&&p.description&&p.description.toLowerCase().indexOf(e.toLowerCase())>-1;return i||t};if(R&&R.length>0)for(d=!1,h=0;h<R.length;h++)if((c=R[h])&&c.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(c.visible||b(c.fieldName))){d=!0;break}this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("returnTopmostRaster")&&(m=this.infoTemplate.info.layerOptions.returnTopmostRaster?1:null),R&&R.length>0&&(f=!1,n.some(R,(function(e){if(e&&e.fieldName.toLowerCase()===this._rasterFieldPrefix.toLowerCase()+"itempixelvalue"&&e.visible)return f=!0,!0}),this),b(this._rasterFieldPrefix.toLowerCase()+"itempixelvalue")&&(f=!0));var T=this._removeVisualizationStretchFunction(this.renderingRule),y=T&&T.functionName,F=[];if(this.version>=10.4){var I=!1;if(this.rasterFunctionInfos&&R){var D=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;n.forEach(this.rasterFunctionInfos,(function(e){var i=D+e.name.replace(/ /gi,"_");n.some(R,(function(e){return e.visible&&e.fieldName===i}))&&(I=I||y&&y===e.name,F.push(new x({rasterFunction:e.name})))}))}T&&!I&&F.push(T)}var C=new A;if(C.geometry=e.geometry,C.returnGeometry=this._map.spatialReference.equals(this.spatialReference),C.returnCatalogItems=d,C.timeExtent=this.timeInfo?e.timeExtent:null,C.returnPixelValues=f,C.maxItemCount=m||e.maxItemCount,this._params.time&&this.mosaicRule?(l=i.clone(this.mosaicRule),l=this._filterOutTimeDimension(l),C.mosaicRule=l):C.mosaicRule=this.mosaicRule||null,this._isMultidimensionalCRF()&&C.timeExtent&&(C.mosaicRule=this._applyTimeToMultidimensionalCRF(C.mosaicRule,C.timeExtent.toJson().join(",")),this._isTimeSupportedOnCRF()||delete C.timeExtent),C.renderingRule=this.version<10.4&&T||null,C.renderingRules=F||null,this.version<10.8&&(C.returnPixelValues=void 0,C.maxItemCount=void 0),o){var w=(o.extent.xmax-o.extent.xmin)/o.width,P=(o.extent.ymax-o.extent.ymin)/o.height,V=o.extent.spatialReference,k=new _(w,P,V);C.pixelSize=k}r.requestParams=C;var N=this,M=new S(this.url);return(u._pendingDfd=M.execute(C)).addCallbacks((function(e){N._queryVisibleRastersHandler(e,r,s,a,u)}),(function(e){N._resolve([e],null,a,u,!0)})),u},_queryVisibleRastersHandler:function(e,t,s,a,l){var o,u,h,c,d,g,p=e.value,_=e.value,b=0,T=0,x=this,y=this.objectIdField,F=[],D=t.requestParams.renderingRules,C=e.processedValues,w=this.renderingRule&&r.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());if(D&&C&&D.length===C.length){var P=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;n.forEach(D,(function(e,i){if(e.functionName){var t={name:P+e.functionName.replace(/ /gi,"_"),value:C[i].replace(/ /gi,"").split(",")};F.push(t),w&&w===r.toJson(e.toJson())&&(p=C[i])}}))}if(c=!(this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords"))||this.infoTemplate.info.layerOptions.showNoDataRecords,e.catalogItems){var S,A,k=0,N=e.catalogItems.features.length,M=0;if(u=new Array(N),o=new Array(N),h=new Array(N),e.properties&&e.properties.Values){var L=e.properties.Values.length;for(b=0;b<L;b++)e.properties.Values[b].toLowerCase().indexOf("nodata")>-1&&M++;for(S=L-M,b=0;b<L;b++)d=!0,e.properties.Values[b].toLowerCase().indexOf("nodata")>-1?(A=S++,c||(d=!1,u.length--,o.length--,h.length--)):A=k++,d&&(u[A]=e.catalogItems.features[b],o[A]=e.properties.Values[b],h[A]=u[A].attributes[y])}else{for(b=0;b<N;b++)u[b]=e.catalogItems.features[b],h[b]=u[b].attributes[y];o=null}}this._visibleRasters=[];var E=p.toLowerCase().indexOf("nodata")>-1;if(E&&!c&&(u=[],o=[],h=[]),p&&!u&&!E){y="ObjectId",u=[];var j={ObjectId:0};g=new V(new R(this.fullExtent),null,j),u.push(g)}var O=[];function J(){var e,r,a,h,c,d,m,v,b,T,x=this.getCustomRasterFields(t),D=this._getDomainFields(x),C=!!t&&t.returnDomainValues,w=t&&t.rasterAttributeTableFieldPrefix,P=this._getRenderingRuleId(this.renderingRule),V=P&&this._rasterFunctionTemplateInfos[P];this.renderingRule&&(this._useRenderingRuleAttributeTable||V)?(b=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),this.hasRasterAttributeTable||(T=p)):b=this._getRasterAttributeTableFeatures(),b.then(i.hitch(this,(function(t){for(e=0;e<u.length;e++){if(g=u[e],g.attributes[y],g.setInfoTemplate(this.infoTemplate),g._layer=this,p){if(v=p.replace(/ /gi,"").split(","),r=p,a=v,o&&o.length>=e&&(r=o[e].replace(/ /gi,", "),a=o[e].split(" ")),g.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=a,g.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=v,_&&(g.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=_.replace(/ /gi,"").split(",")),this.pixelFilter){var b=new I({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});n.forEach(a,(function(e){b.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})})),this.pixelFilter({pixelBlock:b,extent:new R(0,0,0,0,this._map.spatialReference)}),"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(g.attributes[this._rasterFieldPrefix+"Magnitude"]=b.pixels[0][0],g.attributes[this._rasterFieldPrefix+"Direction"]=b.pixels[1][0])}var x;if(n.forEach(F,(function(e){g.attributes[e.name]=e.value})),x=this.fields.length>0?T||r:T||_,t&&t.length>0&&(h=n.filter(t,(function(e){if(e&&e.attributes)return e.attributes.hasOwnProperty("Value")?e.attributes.Value==x:e.attributes.VALUE==x}))).length>0&&(c=i.clone(h[0]),w&&c)){for(d in m={},c.attributes)c.attributes.hasOwnProperty(d)&&(m[w+d]=c.attributes[d]);c.attributes=m,g.attributes=i.mixin(g.attributes,c.attributes)}}C&&D&&D.length>0&&n.forEach(D,(function(e){if(e){var i=g.attributes[e.name];if(f.isDefined(i)){var t=this._getDomainValue(e.domain,i);f.isDefined(t)&&(g.attributes[e.name]=t)}}}),this),O.push(g),this._visibleRasters.push(g)}this._resolve([O,null,!0],null,s,l)})))}u?!this._map.spatialReference.equals(this.spatialReference)&&h&&h.length>0?m({url:this._url.path+"/query",content:{f:"json",objectIds:h.join(","),returnGeometry:!0,outSR:r.toJson(x._map.spatialReference.toJson()),outFields:y},handleAs:"json",callbackParamName:"callback",load:function(e){if(0!==e.features.length){for(b=0;b<e.features.length;b++)for(T=0;T<u.length;T++)u[T].attributes[y]==e.features[b].attributes[y]&&(u[T].geometry=new v(e.features[b].geometry),u[T].geometry.setSpatialReference(x._map.spatialReference));J.call(x)}else x._resolve([O,null,null],null,s,l)},error:function(e){x._resolve([O,null,null],null,s,l)}}):J.call(this):this._resolve([O,null,null],null,s,l)},getVisibleRasters:function(){var e,i=this._visibleRasters,t=[];for(e in i)i.hasOwnProperty(e)&&t.push(i[e]);return t},_getDomainFields:function(e){if(e){var i=[];return n.forEach(e,(function(e){if(e.domain){var t={};t.name=e.name,t.domain=e.domain,i.push(t)}})),i}},_getDomainValue:function(e,i){var t;if(e&&e.codedValues)return n.some(e.codedValues,(function(e){return e.code===i&&(t=e.name,!0)})),t},_requestData:function(e,t,n){this._rasterReadPromise&&this._rasterReadPromise.cancel();var r=i.clone(e),s=r._normalize(!0);this._prepareGetImageParameters(s,t,n);var a=i.clone(this._params);this._cleanupRequestParams(a),a.extent=r,a.format=a.format||(this.version>=10.3?"lerc":"jpgpng"),"lerc"===a.format.toLowerCase()&&!a.lercVersion&&this.version>=10.5&&(a.lercVersion=2),this._params.time&&this._isMultidimensionalCRF()&&!this._isTimeSupportedOnCRF()&&delete a.time;var l=null;this._useBrowserDecoding()&&(l=new C({ctx:this._context}));var o={imageServiceParameters:a,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:l?i.hitch(l,"decode"):null};this._rasterReadPromise=this.raster.read(o,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(e){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=e,this.hasDataChanged=!0,this._setPixelData(e))},_setPixelData:function(e){var i=this._clonePixelData(e);this.pixelFilter&&this.pixelFilter(i),this.pixelData=i,this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(e){if(null==e)return e;var t={};e.extent&&(t.extent=i.clone(e.extent));var n=e.pixelBlock;return null==n?t:(t.pixelBlock=n.clone(),t)},_setDefaultFilter:function(){},_getPixelBlockFromCanvas:function(e,i,t){var n,r,s,a=e.getImageData(0,0,i,t).data,l=i*t,o=0,u=0,h=new Uint8Array(l),c=new Uint8Array(l),d=new Uint8Array(l),f=new Uint8Array(l),m=1/0,g=1/0,p=1/0,R=-1/0,_=-1/0,v=-1/0;for(o=0;o<l;o++)m=m<(n=a[u++])?m:n,R=R>n?R:n,g=g<(r=a[u++])?g:r,_=_>r?_:r,p=p<(s=a[u++])?p:s,v=v>s?v:s,h[o]=n,c[o]=r,d[o]=s,f[o]=1&a[u++];return new I({width:i,height:t,pixels:[h,c,d],pixelType:"U8",mask:f,statistics:[{minValue:m,maxValue:R},{minValue:g,maxValue:_},{minValue:p,maxValue:v}]})},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||this.format.toLowerCase().indexOf("png")>-1)},getMultidimensionalInfo:function(){var e=this._url.path+"/multiDimensionalInfo",n=new t(g._dfdCanceller);if(this._multidimensionalInfo)return n.resolve(this._multidimensionalInfo),n;if(!this.loaded||this.version>=10.3&&this.hasMultidimensions)n._pendingDfd=m({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(i.hitch(this,(function(e){this._multidimensionalInfo=e.multidimensionalInfo,n.callback(e.multidimensionalInfo)})),(function(e){n.errback(e)}));else{var r=new Error("Layer does not support multidimensional info");r.log=!!s.isDebug,n.errback(r)}return n},getStatistics:function(e){var n=new t(g._dfdCanceller);if(e&&this._cachedVariableStats[e])n.resolve(this._cachedVariableStats[e]);else{var r={f:"json"};e&&(r.variable=e),n._pendingDfd=m({url:this._url.path+"/statistics",content:r,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(i.hitch(this,(function(i){var t=i.statistics||i.statitsics,r=[];t&&t[0]&&null!=t[0].min?t.forEach((function(e){r.push([e.min,e.max,e.mean,e.standardDeviation])})):r=this.minValues&&this.minValues.length?this.minValues.map(function(e,i){return[e,this.maxValues[i],this.meanValues[i],this.stdvValues[i]]}.bind(this)):t,e&&(this._cachedVariableStats[e]=r),n.callback(r)})),(function(e){n.errback(e)}))}return n},getDefaultMultidimensionalDefinition:function(){var e=new t(g._dfdCanceller);return this._defaultMultidimensionalDefinition?(e.resolve(i.clone(this._defaultMultidimensionalDefinition)),e):(e._pendingDfd=this.getMultidimensionalInfo(),e._pendingDfd.then(i.hitch(this,(function(i){var t=this._getDefaultMultidimensionalDefinition(i);e.callback(t)})),(function(i){e.errback(i)})),e)},_getDefaultMultidimensionalDefinition:function(e,t,n){var r,s,a=[],l=this.defaultVariable||this.raster&&this.raster.defaultVariable;for(s in variableName=l||"",dimensions=variableName.length?e.variables.filter((function(e){return e.name===variableName}))[0].dimensions:e.variables[0].dimensions,n&&(variableName=l||e.variables[0].name),dimensions)dimensions.hasOwnProperty(s)&&(t||"StdTime"!==dimensions[s].name)&&(r=dimensions[s],a.push(new y({variableName:variableName,dimensionName:r.name,isSlice:!r.hasRanges,values:[this._getDefaultDimensionValue(r)]})));return this._defaultMultidimensionalDefinition=a,i.clone(a)},_getDefaultDimensionValue:function(e){if(e&&e.values&&e.values.length){var i,t,n,r,s=1/0;if(e.hasRanges)return e.values[0];if(e.name&&"stdz"===e.name.toLowerCase()){for(r=0;r<e.values.length&&(n=e.values[r],(t=Math.abs(n-0))<s&&(s=t,i=n),0!==t);r++);return i}return e.extent[0]}},_setDefaultMultidimensionalDefinition:function(e){var t,n={};this.getDefaultMultidimensionalDefinition().then(i.hitch(this,(function(r){(t=r).length>0&&(this.mosaicRule?(n=i.clone(this.mosaicRule)).multidimensionalDefinition=t:this.defaultMosaicRule?(n=i.clone(this.defaultMosaicRule)).multidimensionalDefinition=t:n=new T({multidimensionalDefinition:t}),this.setMosaicRule(n,e))})))},_setDefaultRenderingRule:function(e){var i={},t=this.renderingRule;if(!t&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&!this.bandIds&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())i.rasterFunction=this.rasterFunctionInfos[0].name;else if("esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&this.version>10.3&&(!t||"Resample"!==t.functionName)){var n="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;i.rasterFunction="Resample",i.rasterFunctionArguments={ResamplingType:n,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}},t&&(i.rasterFunctionArguments.Raster=t.toJson())}i.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new x(i),this.setRenderingRule(this.defaultRenderingRule,e))},_cleanupRequestParams:function(e){if(!e)return e;if(e.time&&e.mosaicRule){var i=new T(r.fromJson(e.mosaicRule));i=this._filterOutTimeDimension(i),e.mosaicRule=r.toJson(i.toJson())}var t,n=["displayOnPan","drawMode","styling","id","opacity","visible","resourceInfo","useMapDimensionValue","extent","renderer"];for(t in n)e.hasOwnProperty(n[t])&&delete e[n[t]];return e},_filterOutTimeDimension:function(e){if(this._isMultidimensionalCRF())return e;if(e&&e.multidimensionalDefinition&&e.multidimensionalDefinition.length>0){var i=n.filter(e.multidimensionalDefinition,(function(e){return"StdTime"!==e.dimensionName}));e.multidimensionalDefinition=i}return e},_removeVisualizationStretchFunction:function(e){var i=e&&e.functionName;if(!i||"stretch"!==i.toLowerCase())return e;var t=e.functionArguments.Raster;if(t&&t.functionName&&n.some(this.rasterFunctionInfos,(function(e){return t.functionName===e.name})))return t;return e},_isMultidimensionalCRF:function(){return this.version>=10.71&&this.hasMultidimensions&&this.timeInfo&&!(this.objectIdField&&this.fields&&this.fields.length>1)},_isTimeSupportedOnCRF:function(){return this.version>=10.8},_cleanupMultidimensionalDefinition:function(e){e&&e.multidimensionalDefinition&&(e.multidimensionalDefinition=e.multidimensionalDefinition.filter((function(e){return!(!e.variableName&&!e.dimensionName)})),0===e.multidimensionalDefinition.length&&(e.multidimensionalDefinition=null))},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType||this.hasMultidimensions},_isVectorData:function(e){var i=(e=e||this)&&e.serviceDataType;return"esriImageServiceDataTypeVector-UV"===i||"esriImageServiceDataTypeVector-MagDir"===i},_isRenderingRuleAProcessingTemplate:function(e){var i=e&&e.functionName;return!(!i||e.functionArguments)&&n.some(i&&(this.rasterFunctionInfos||[]),(function(e){return e&&e.name&&e.name.toLowerCase()===i.toLowerCase()}))},_getRenderingRuleId:function(e){var i=e&&e.functionName;if(i){if(this._isRenderingRuleAProcessingTemplate(e))return i;var t=this._customRenderingRuleId[i];if(t){if(t!==e){for(var n in this._customRenderingRuleId)if(this._customRenderingRuleId[n]===e)return n;for(var r=0;this._customRenderingRuleId[s];)r+=1;var s=i+r;this._customRenderingRuleId[s]=e}}else this._customRenderingRuleId[i]=e;return i}},_createPixelData:function(e){var i=new I({width:2,height:2,pixels:e,pixelType:this.pixelType,statistics:e}),t=this.fullExtent.getCenter();return{pixelBlock:i,extent:new R(t.x,t.y,t.x+this.pixelSizeX,t.y+this.pixelSizeY,this.spatialReference)}},_convertRendererToRenderingRule:function(e){var i=e&&e.declaredClass;if(!i||"esri.renderer.UniqueValueRenderer"!==i&&"esri.renderer.ClassBreaksRenderer"!==i&&"esri.renderer.StretchRenderer"!==i&&"esri.renderer.ShadedReliefRenderer"!==i&&"esri.renderer.ColormapRenderer"!==i)return null;var t=null;return"esri.renderer.StretchRenderer"===i?t=e.toRenderingRule({convertToColormap:this.version<10.6}):"esri.renderer.ClassBreaksRenderer"===i?t=this._convertClassifyRenderer(e):"esri.renderer.UniqueValueRenderer"===i?t=this._convertUniqueValueRenderer(e):"esri.renderer.ShadedReliefRenderer"===i?t=this._convertShadedReliefRenderer(e):"esri.renderer.ColormapRenderer"===i&&(t=this._convertColormapRenderer(e)),t},_getValueField:function(e){var i,t;if(e&&e.length)return n.some(e,(function(e){if((t=e.name)&&"value"===t.toLowerCase())return i=t,!0})),i},_convertColormapRenderer:function(e){var i=new x;i.functionName="Colormap",i.functionArguments={};var t=e.colormapInfos.map((function(e){return[e.value].concat(e.color)}));return i.functionArguments.Colormap=t,i},_convertShadedReliefRenderer:function(e){var i=new x;i.functionName="Hillshade";var t="traditional"===e.hillshadeType?0:1,n="none"===e.scalingType?1:3,r={HillshadeType:t,SlopeType:n,ZFactor:e.zFactor};return 0===t&&(r.Azimuth=e.azimuth,r.Altitude=e.altitude),3===n&&(r.PSPower=e.pixelSizePower,r.PSZFactor=e.pixelSizeFactor),i.functionArguments=r,i.variableName="Raster",e.colorRamp&&(i.functionName="ShadedRelief",r.Colormap=b.convertColorRampToColormap(e.colorRamp,256)),i},_convertClassifyRenderer:function(e){var i,t,r,s,a,l,o,u,h=[],c=[],d=[],f=[],m=this.renderingRule&&this._getRenderingRuleId(this.renderingRule),g=this.hasRasterAttributeTable;if(m&&(g=this._rasterFunctionTemplateInfos[m]?this._rasterFunctionTemplateInfos[m].hasRasterAttributeTable:this.hasRasterAttributeTable,s=this._renderingRuleAttributeTable[m],u=this._rasterFunctionTemplateInfos[m]),r=s&&s.features?s.features:this._rasterAttributeTableFeatures,a=s&&s.fields?s.fields:this._rasterAttributeTableFields,l=this._getValueField(a),g&&r){n.forEach(e.infos,(function(i,t){var s,a=i.symbol.color;a.a&&n.forEach(r,(function(n){((s=n.attributes[e.attributeField])>=i.minValue&&s<i.maxValue||t===e.infos.length-1&&s>=i.minValue)&&f.push([n.attributes[l],a.r,a.g,a.b])}),this)}),this),o=u&&u.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(f,o);var p=new x;p.functionName="Colormap",p.functionArguments={},p.functionArguments.Colormap=f,p.variableName="Raster",i=p}else{n.forEach(e.infos,(function(e,i){(t=e.symbol&&e.symbol.color).a?(0===i?h.push.call(h,e.minValue,e.maxValue+1e-4):h.push.call(h,e.minValue+1e-4,e.maxValue+1e-4),c.push(i),f.push([i,t.r,t.g,t.b])):d.push(e.minValue,e.maxValue)})),o=u&&u.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(f,o);var R=new x;R.functionName="Remap",R.functionArguments={InputRanges:h,OutputValues:c,NoDataRanges:d},R.variableName="Raster";var _=new x;_.functionName="Colormap",_.functionArguments={Colormap:f,Raster:R},i=_}return i},_convertUniqueValueRenderer:function(e){var i,t,r,s,a,l,o=[],u=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);u&&(this._rasterFunctionTemplateInfos[u]?this._rasterFunctionTemplateInfos[u].hasRasterAttributeTable:this.hasRasterAttributeTable,t=this._renderingRuleAttributeTable[u],l=this._rasterFunctionTemplateInfos[u]),i=t&&t.features?t.features:this._rasterAttributeTableFeatures,s=t&&t.fields?t.fields:this._rasterAttributeTableFields,r=s&&s.length?this._getValueField(s):"Value",n.forEach(e.infos,(function(t){var s=t.symbol.color;s.a&&(e.attributeField.toLowerCase()!==r.toLowerCase()&&i.length?n.forEach(i,(function(i){i.attributes[e.attributeField]==t.value&&o.push([i.attributes[r],s.r,s.g,s.b])}),this):o.push([t.value,s.r,s.g,s.b]))}),this),a=l&&l.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(o,a);var h=new x;return h.functionName="Colormap",h.functionArguments={},h.functionArguments.Colormap=o,h.variableName="Raster",h},_adjustColormapToPixelTypeRange:function(e,i){var t=this._pixelTypeRanges[i];return t&&e.push([Math.floor(t[0]-1),0,0,0],[Math.ceil(t[1]+1),0,0,0]),e},_combineRenderingRule:function(e,t){if(!e||!t)return e||t;var n=function(e){var i=e.Raster;return i=i&&"esri.layers.RasterFunction"===i.declaredClass?n(i.functionArguments):e},r=i.clone(e);"none"!==t.functionName.toLocaleLowerCase()&&(n(r.functionArguments).Raster=t);return r},_isItemLevelRasterFunction:function(e){var i=e&&e.functionName;if(!i||!this._hasItemLevelRFT)return!1;var t=!1;return n.some(this.rasterFunctionInfos,(function(e){if(e&&e.name===i)return 1!==e.functionType&&2!==e.functionType||(t=!0),!0})),t},_getServiceLevelRenderingRule:function(e){if(!this._hasItemLevelRFT||!e)return e;for(var i,t=new x(e.toJson()),n=t,r=n.functionArguments;;){if(!((i=r&&r.Raster)&&i.functionArguments&&i.functionArguments.Raster)){this._isItemLevelRasterFunction(i)&&delete r.Raster;break}r=(n=i).functionArguments}return t},_getItemLevelRenderingRule:function(e){if(!this._hasItemLevelRFT||!e)return null;if(this._isItemLevelRasterFunction(e))return e;for(var i,t=new x(e.toJson()),n=t.functionArguments;;){if(!((i=n&&n.Raster)&&i.functionArguments&&i.functionArguments.Raster)){if(this._isItemLevelRasterFunction(i))return i;break}n=(t=i).functionArguments}},_resolve:function(e,i,t,n,r){i&&this[i].apply(this,e),t&&t.apply(null,e),n&&g._resDfd(n,e,r)},_toggleTime:function(){var e=this._map;this.timeInfo&&this.useMapTime&&e&&!this.suspended?(this._timeConnect||(this._timeConnect=a.connect(e,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(e.timeExtent)):(a.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},setUseMapTime:function(e,i){this.useMapTime=e,this._toggleTime(),!i&&this._map&&this.refresh(!0)},_setTime:function(e){this._params&&(this._params.time=e?e.toJson().join(","):null)},onResume:function(){(this._isScientificData()||this.timeInfo)&&(this._originalGetImageUrl=this._originalGetImageUrl||this.getImageUrl.bind(this),this.getImageUrl=h(this._originalGetImageUrl,200),this._debounceGetImageTimer&&clearTimeout(this._debounceGetImageTimer),this._debounceGetImageTimer=setTimeout(function(){this.getImageUrl=this._originalGetImageUrl}.bind(this),5e3)),this.inherited(arguments)},_onTimeExtentChangeHandler:function(e){this.suspended||(this._setTime(e),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()},getColormap:function(e){var i=this._url.path+"/colormap",n=new t(g._dfdCanceller),a={f:"json"};if(e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson())),this.hasColormap)n._pendingDfd=m({url:i,content:a,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then((function(e){n.callback(e)}),(function(e){n.errback(e)}));else{var l=new Error("Layer does not support colormap");l.log=!!s.isDebug,n.errback(l)}return n},getRenderingRuleColormap:function(e){var n=new t(g._dfdCanceller);if(!e||!e.renderingRule){var r=new Error("Rendering rule is not specified");return n.errback(r),n}var s=e.renderingRule,a=this._getRenderingRuleId(s);return this._renderingRuleColormap&&a&&this._renderingRuleColormap.hasOwnProperty(a)?n.resolve(this._renderingRuleColormap[a]):n=this.getColormap({renderingRule:s}).then(i.hitch(this,(function(e){var i=e&&e.colormap;return a&&(this._renderingRuleColormap[a]=i),i}))),n},_handleClipFunctionInRenderingRule:function(e){var t=i.clone(e),n=t.arguments,r=n.ClippingRaster&&n.ClippingRaster.value,s=n.ClippingGeometry&&n.ClippingGeometry.value,a=n.Extent&&n.Extent.value;if(!r&&!s&&!a){var l=this._map.extent.toJson();t.arguments.Extent.value=l,t.functionArguments.Extent.value=l,t._isTemplate&&(t._templateJson.arguments.Extent.value=l)}return t}});return l("extend-esri")&&i.setObject("layers.ImageServiceLayerMixin",k,c),k}));