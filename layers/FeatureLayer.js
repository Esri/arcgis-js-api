// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.37/esri/copyright.txt for details.

define(["require","module","dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/Deferred","dojo/date/locale","dojo/io-query","dojo/dom-construct","dojo/i18n","dojo/when","dojo/global","dojo/promise/all","../sniff","../kernel","../lang","../request","../config","../deferredUtils","../promiseList","../SpatialReference","../urlUtils","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/jsonUtils","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/jsonUtils","../support/expressionUtils","../arcadeProfiles/labelingProfile","../tasks/QueryTask","../tasks/query","../tasks/FeatureSet","../tasks/StatisticDefinition","../geometry/Extent","../geometry/jsonUtils","../geometry/normalizeUtils","../geometry/scaleUtils","./GraphicsLayer","./Field","./TimeInfo","./TimeReference","./FeatureType","./FeatureTemplate","./FeatureSubtype","./FeatureEditResult","./LabelClass","./support/domainUtils","./SnapshotMode","./OnDemandMode","./SelectionMode","./StreamMode","./GridLayout","./TrackManager","./HeatmapManager","./clustering/ClusterManager","dojo/i18n!../nls/jsapi","dojo/has!extend-esri?./agscommon"],(function(e,t,i,s,n,r,a,o,l,u,h,d,c,f,p,_,m,y,g,b,F,v,S,x,M,C,O,E,I,D,T,A,R,w,P,L,k,U,z,j,q,G,Q,N,H,V,B,W,J,X,$,Z,Y,K,ee,te,ie,se,ne,re){var ae=b.defaults,oe=!!_("esri-pbf"),le=!!_("esri-featurelayer-pbf"),ue=i(G,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reSQLCurrentTimestamp:/current_timestamp|current_date|current_time/i,reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4e3,maxRecordCountForAuto:2e3,maxVertexCountForAuto:25e4,generalizeForScale:4e3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(e,t){this._preventInit||this._initFeatureLayer(e,t)},_initFeatureLayer:function(e,t){t=t||{},this._tileWidth=t.tileWidth||512,this._tileHeight=t.tileHeight||512,this.i18n=re,this._featureReduction=this._featureReduction||t.featureReduction,this._featureReductionEnabled=null==t.featureReductionEnabled||t.featureReductionEnabled,this._featureUpdatesCheckEnabled=null==t.featureUpdatesCheckEnabled||t.featureUpdatesCheckEnabled,this.showLabels=null==t.showLabels||t.showLabels,this._outFields=t.outFields,this._defnExpr=t.definitionExpression,this._loadCallback=t.loadCallback,this._trackIdField=t.trackIdField,this.objectIdField=t.objectIdField;var i=null!=t.resolution,s=null!=t.maxAllowableOffset;this._maxOffset=this._optMaxOffset=i||s?i?t.resolution:t.maxAllowableOffset:this.maxAllowableOffset,this.quantize=null==t.quantize||t.quantize,this._optEditable=t.editable,this._optAutoGen=t.autoGeneralize,this.editSummaryCallback=t.editSummaryCallback,this.userId=t.userId,this.userIsAdmin=t.userIsAdmin,this.useMapTime=!t.hasOwnProperty("useMapTime")||!!t.useMapTime,this.source=t.source,this.gdbVersion=t.gdbVersion,this.orderByFields=t.orderByFields,this.maxPointCountForAuto=null!=t.maxPointCountForAuto?t.maxPointCountForAuto:this.maxPointCountForAuto,this.maxRecordCountForAuto=null!=t.maxRecordCountForAuto?t.maxRecordCountForAuto:this.maxRecordCountForAuto,this.maxVertexCountForAuto=null!=t.maxVertexCountForAuto?t.maxVertexCountForAuto:this.maxVertexCountForAuto,this.generalizeForScale=null!=t.generalizeForScale?t.generalizeForScale:this.generalizeForScale,this.queryPagination=this._optQueryPagination=null==t.queryPagination||t.queryPagination,this.multipatchOption=t.multipatchOption,this.subtypeSublayerInfo=t.subtypeSublayerInfo,this._selectedFeatures={},this._newFeatures=[],this._deletedFeatures={},this._ulid=this._getUniqueId();var r=y.isDefined(t.mode)?t.mode:ue.MODE_ONDEMAND;switch(this._isStream&&(r=ue.MODE_STREAM),this.mode=r,r){case ue.MODE_SNAPSHOT:this.currentMode=ue.MODE_SNAPSHOT,this._mode=new Z(this);break;case ue.MODE_ONDEMAND:case ue.MODE_AUTO:this.currentMode=ue.MODE_ONDEMAND,this._mode=new Y(this),this.latticeTiling=t.latticeTiling;break;case ue.MODE_SELECTION:this.currentMode=ue.MODE_SELECTION,this._mode=new K(this),this._isSelOnly=!0;break;case ue.MODE_STREAM:this.currentMode=ue.MODE_STREAM,this._mode=new ee(this),this._isStream=!0}if(this._initLayer=n.hitch(this,this._initLayer),this._selectHandler=n.hitch(this,this._selectHandler),this._editable=!1,n.isObject(e)&&e.layerDefinition){var o=e;return this._collection=!0,this.mode=this._isStream?ue.MODE_STREAM:ue.MODE_SNAPSHOT,this._isStream||this._outFields||(this._outFields=["*"]),this._initLayer(o),this}if(this.source){var l={source:this.source.toJson()};this._url.query=n.mixin(this._url.query,{layer:a.toJson(l)})}this.gdbVersion&&(this._url.query=n.mixin(this._url.query,{gdbVersion:this.gdbVersion})),this._task=new w(this.url,{source:this.source,gdbVersion:this.gdbVersion});var u=this._url.path;this._fserver=!1,-1!==u.search(/\/FeatureServer\//i)&&(this._fserver=!0),this._checkFeatureLimit();var h=t.resourceInfo;h?this._initLayer(h):g({url:u,content:n.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}),this.registerConnectEvents()},_initLayer:function(e,t){if(e||t){this._json=e;var i,s=this.subtypeSublayerInfo;if(this._findCredential(),(this.credential&&this.credential.ssl||e&&e._ssl)&&(this._useSSL(),this._task._useSSL()),this._collection&&(this._isStream||(this.currentMode=ue.MODE_SNAPSHOT,this._mode=new Z(this)),this._featureSet=e.featureSet,this._nextId=e.nextObjectId,e=e.layerDefinition),this.version=e.currentVersion,!this.version)i="capabilities"in e||"drawingInfo"in e||"hasAttachments"in e||"htmlPopupType"in e||"relationships"in e||"timeInfo"in e||"typeIdField"in e||"types"in e?10:9.3,this.version=i;if(this.geometryType=e.geometryType,e.bandCount&&e.fields&&e.fields.length>1&&(this.geometryType="esriGeometryPolygon",this._isImageService=!0),"string"!=typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint"),e.hasOwnProperty("capabilities")){var o=this.capabilities=e.capabilities;o&&-1!==o.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);y.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1),this._isImageService&&(this._editable=!1),this._json=a.toJson(this._json),this.isEditable()?this._setMaxOffset(null):this._canAutoGeneralize()&&(this._autoGeneralize=y.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===ue.MODE_ONDEMAND||this.mode===ue.MODE_AUTO,delete this._optAutoGen);var l=e.effectiveMinScale||e.minScale,u=e.effectiveMaxScale||e.maxScale;!this._hasMin&&l&&this.setMinScale(l),!this._hasMax&&u&&this.setMaxScale(u),this.layerId=e.id,this.name=s&&s.title||e.name,this.description=e.description,this.copyright=e.copyrightText,this.type=e.type,this.displayField=e.displayField,this.defaultDefinitionExpression=e.definitionExpression||(e.isView?e.viewDefinitionQuery:e.definitionQuery),this.fullExtent=new U(e.extent),this.initialExtent=new U(this.fullExtent.toJson()),this.fullExtent.spatialReference&&(this.spatialReference=new S(this.fullExtent.spatialReference.toJson())),this.defaultVisibility=e.defaultVisibility,this.editingInfo=e.editingInfo,this.supportsLastEditDate=!(!this.editingInfo||null==this.editingInfo.lastEditDate),"esriGeometryPoint"!==this.geometryType&&"esriGeometryMultipoint"!==this.geometryType||(this.latticeTiling=!1),this.hasM=e.hasM||!1,this.hasZ=e.hasZ||!1,this.indexedFields=e.indexedFields,this.indexes=e.indexes,this.maxRecordCount=e.maxRecordCount,this.canModifyLayer=e.canModifyLayer,this.supportsStatistics=e.supportsStatistics,this.supportsAdvancedQueries=!this._collection&&e.supportsAdvancedQueries,this.supportsCalculate=e.supportsCalculate,this.supportsASyncCalculate=e.supportsASyncCalculate,this.supportsAttachmentsByUploadId=e.supportsAttachmentsByUploadId,this.supportsCoordinatesQuantization=e.supportsCoordinatesQuantization,this.supportsQuantizationEditMode=e.supportsQuantizationEditMode,this.supportsFieldDescription=e.supportsFieldDescriptionProperty,this.supportsFormatPBF=!!e.supportedQueryFormats&&-1!==r.map(e.supportedQueryFormats.toLowerCase().split(","),n.trim).indexOf("pbf"),this.quantize=this.quantize&&this.supportsCoordinatesQuantization,this.hasLabels=e.hasLabels,this.canScaleSymbols=e.canScaleSymbols,this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=e.supportsRollbackOnFailure,this.syncCanReturnChanges=e.syncCanReturnChanges,this.isDataVersioned=e.isDataVersioned,this.editFieldsInfo=e.editFieldsInfo,this.ownershipBasedAccessControlForFeatures=e.ownershipBasedAccessControlForFeatures,this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField),this.relationships=e.relationships,this.allowGeometryUpdates=!y.isDefined(e.allowGeometryUpdates)||e.allowGeometryUpdates,this.allowUpdateWithoutMValues=!!e.allowUpdateWithoutMValues,this.enableZDefaults=!!e.enableZDefaults,this.zDefault=y.isDefined(e.zDefault)?e.zDefault:null,this.advancedQueryCapabilities=e.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries},this.geometryProperties=e.hasGeometryProperties&&e.geometryProperties||null,this.url&&(this.advancedQueryCapabilities.supportsPagination=this.advancedQueryCapabilities.supportsPagination&&(this.reHostedFS.test(this.url)||this.version>10.3)),this.queryPagination=this._optQueryPagination&&this.advancedQueryCapabilities.supportsPagination,this.useStandardizedQueries=e.useStandardizedQueries,this.tileMaxRecordCount=e.tileMaxRecordCount,this.standardMaxRecordCount=e.standardMaxRecordCount;var h=e.dateFieldsTimeReference;h&&(this.dateFieldsTimeReference=new H(h)),this._setMaxOffset(this._maxOffset,!0),this._isTable="Table"===this.type;var d,c=e.fields;if(this._createFields(c),!this.objectIdField){if(this.objectIdField=e.objectIdField,!this.objectIdField)for(c=e.fields,d=0;d<c.length;d++){var f=c[d];if("esriFieldTypeOID"===f.type){this.objectIdField=f.name;break}}this.objectIdField||this._isStream||console.debug("esri.layers.FeatureLayer: "+y.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!y.isDefined(this._nextId)){var p=this.objectIdField,m=-1;if(this._collection&&p){var g,b,F=this._featureSet,x=F&&F.features,A=x?x.length:0;for(d=0;d<A;d++)(g=(b=x[d].attributes)&&b[p])>m&&(m=g)}this._nextId=m+1}this.globalIdField=e.globalIdField;var R,w=this.typeIdField=e.typeIdField;w&&(R=!this._getField(w)&&this._getField(w,!0))&&(this.typeIdField=R.name),this.visibilityField=e.visibilityField;var P=e.defaultSymbol;P&&(this.defaultSymbol=E.fromJson(P));var k,z,j,q=this.types=[],G=e.types,Q=this.editFieldsInfo,J=Q&&Q.creatorField,$=Q&&Q.editorField,Y=J||$,K=[];if(G)for(d=0;d<G.length;d++)z=(k=new V(G[d])).templates,Y&&z&&z.length&&(K=K.concat(z)),q.push(k);var ee,te=e.templates,ie=this.templates=[];if(te)for(d=0;d<te.length;d++)ee=new B(te[d]),Y&&K.push(ee),ie.push(ee);for(d=0;d<K.length;d++)(j=n.getObject("prototype.attributes",!1,K[d]))&&(J&&delete j[J],$&&delete j[$]);var se=e.subtypeField;if(se){var ne=this.getField(se);this.subtypeField=ne?ne.name:null}this.defaultSubtypeCode=e.defaultSubtypeCode,this.subtypes=r.map(e.subtypes,(function(e){return new W(e)})),this._applySTSublayerInfo(s);var re=e.timeInfo;re&&(this.timeInfo=new N(re),this._startTimeField=re.startTimeField,this._endTimeField=re.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?re.trackIdField=this._trackIdField:this._trackIdField=re.trackIdField),this.hasAttachments=!(this._collection||!e.hasAttachments),this.htmlPopupType=e.htmlPopupType;var ae,oe=e.drawingInfo,le=oe&&oe.labelingInfo;if(le&&!this.labelingInfo&&(this.labelingInfo=r.map(le,(function(e){return new X(e)})),this._fixLabelExpr()),!this.renderer)if(oe&&oe.renderer){if(ae=oe.renderer,this.setRenderer(T.fromJson(ae,{geometryType:this.geometryType})),"classBreaks"===ae.type&&this.renderer.setMaxInclusive(!0),!this._collection){var he=ae.type,de=[];switch(ae=this.renderer,he){case"simple":de.push(ae.symbol);break;case"uniqueValue":case"classBreaks":de.push(ae.defaultSymbol),de=de.concat(r.map(ae.infos,(function(e){return e.symbol})))}de=r.filter(de,y.isDefined);var ce=this._url.path+"/images/",fe=this._getToken();r.forEach(de,(function(e){var t=e.url;t&&(-1===t.search(/https?\:/)&&-1===t.indexOf("data:")&&(e.url=ce+t),fe&&-1!==e.url.search(/https?\:/)&&(e.url+="?token="+fe))}))}}else if(P)(G=this.types).length>0?(ae=new D(this.defaultSymbol,this.typeIdField),r.forEach(G,(function(e){ae.addValue(e.id,e.symbol)}))):ae=new I(this.defaultSymbol),this.setRenderer(ae);else if(!this._isTable){var pe;switch(this.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":pe=new M;break;case"esriGeometryPolyline":pe=new C;break;case"esriGeometryPolygon":pe=new O;break;default:this.hasXYFootprint()&&(pe=new O)}this.setRenderer(pe?new I(pe):null)}var _e=oe&&oe.transparency||0;!this.hasOwnProperty("opacity")&&_e>0&&(this.opacity=1-_e/100),(_("ie")||_("trident")>=7||_("safari"))&&this.isEditable()&&this.version<10.02&&(this._ts=!0),this.statistics=e.statistics,this._fixRendererFields(),this._updateRequiredFieldsFromLabelingInfo(),this._checkFields(),this._updateCaps();var me=function(){null==this._maxOffset||this._isFractionalOffsetAllowed()||this._setMaxOffset(this._maxOffset),this.loaded=!0,this.setFeatureReduction(this.getFeatureReduction()),this.currentMode!==ue.MODE_SNAPSHOT&&(this.queryPagination=!1),this.onLoad(this);var e=this._loadCallback;e&&(delete this._loadCallback,e(this))},ye=[];if(this._collection){var ge=this._featureSet;this._featureSet=null,this._mode._drawFeatures(new L(ge)),this._fcAdded=!0}else ye.push(this._forceIdentity()),this._limitPromise&&ye.push(this._limitPromise);ye.push(this._evalArcadeSupport()),ye.length?v(ye).then(n.hitch(this,(function(){me.call(this)}))):me.call(this)}},_applySTSublayerInfo:function(e){e&&this.subtypeField&&(this.subtypeCode=e.subtypeCode,this._applySTSublayerDefinitionExpression(e),this._filterSubtypes(e),this._applySTTemplates(e),this._applySTFieldOverrides(e))},_applySTSublayerDefinitionExpression:function(e){var t=[],i=this.getDefinitionExpression();i&&t.push(i);var s=e.layerDefinition&&e.layerDefinition.definitionExpression;s&&t.push(s),t.length>1&&(t=r.map(t,(function(e){return"("+e+")"}))),this.setDefinitionExpression(t.length?t.join(" AND "):null)},_applySTTemplates:function(e){var t=e.layerDefinition&&e.layerDefinition.templates;t&&(this.templates=r.map(t,(function(e){return new B(e)})))},_filterSubtypes:function(){this.subtypes&&(this.subtypes=r.filter(this.subtypes,(function(e){return e.code===this.subtypeCode}),this))},_applySTFieldOverrides:function(e){var t=e.layerDefinition&&e.layerDefinition.fieldOverrides;if(t){this.fields=r.filter(this.fields,(function(e){return r.some(t,(function(t){return t.name===e.name}))}));var i=this.getSubtypeByCode(this.subtypeCode).domains;this.fields.forEach((function(e){var s=r.filter(t,(function(t){return t.name===e.name}))[0];if(s.alias&&(e.alias=s.alias),!1!==s.editable&&e.name!==this.subtypeField||(e.editable=!1),i){var n=i[e.name];n&&"inherited"!==n.type&&(e.domain=$.fromJson(n.toJson()))}}),this)}},setShowLabels:function(e){var t=this.showLabels;this.showLabels=e,t!==this.showLabels&&(this._evalSurfaceType(),this.onShowLabelsChange())},onShowLabelsChange:function(){},onRendererChange:function(e){this.inherited(arguments);var t=this._map;if(this._ager=!!(e&&e.observationAger&&e.observationRenderer),e&&"colors"in e&&"blurRadius"in e&&"maxPixelIntensity"in e)this._evalSurfaceType(!0),"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&t&&(this._heatmapManager=new se(this),this._heatmapManager.initialize(t));else if(this.renderer&&this.renderer.getRendererInfo){var i=this.renderer.rendererInfos,s=r.some(i,(function(e){return e.renderer&&"colors"in e.renderer&&"blurRadius"in e.renderer}));s||(this._heatmapManager=null)}else this._heatmapManager=null;if(this.timeInfo&&t&&(e&&(e.latestObservationRenderer||e.trackRenderer)?this._trackManager||(this._trackManager=new ie(this),this._trackManager.initialize(t),this._childLayer=this._trackManager.container,this._mode._applyTimeFilter()):this._trackManager&&!this._isStream&&(this._trackManager.destroy(),this._trackManager=null)),e){var n=[],a=r.filter([e,e.observationRenderer,e.latestObservationRenderer,e.trackRenderer],y.isDefined),o=function(e){return null!=e&&"function"!=typeof e&&e},l=function(e){var t=o(e.attributeField),i=o(e.attributeField2),s=o(e.attributeField3);!1!==t&&n.push(t),!1!==i&&n.push(i),!1!==s&&n.push(s)};r.forEach(a,l),this._requiredFields=n}else this._requiredFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._requiredFields),this._collection&&(this._typesDirty=!0))},setFeatureReduction:function(e){e&&(null!=(e=n.mixin({},e)).clusterSize&&null==e.clusterRadius&&(e.clusterRadius=e.clusterSize),delete e.clusterSize),this.loaded?this._isFeatureReductionSupported(e)?this._featureReduction=e:(this._featureReduction=null,e&&console.log("Clustering is not supported for this layer: "+this.url)):this._featureReduction=e,this._evalFeatureReduction(this._featureReduction)},hasFeatureReduction:function(){return!!this._featureReduction},getFeatureReduction:function(){var e=this._featureReduction;if(e){e=n.mixin({},e);var t=this._clusterManager,i=t&&t.aggregationInfo;i&&(e.clusterRadius=i.clusterRadius,e.infoTemplate=i.infoTemplate)}return e},isFeatureReductionActive:function(){var e=this._clusterManager;return!!(e&&e.isClusteringEnabled()&&e.isClusteringActive())},isFeatureReductionEnabled:function(){return this._featureReductionEnabled},enableFeatureReduction:function(){this._featureReductionEnabled||(this._featureReductionEnabled=!0,this._evalFeatureReduction(this._featureReduction))},disableFeatureReduction:function(){this._featureReductionEnabled&&(this._featureReductionEnabled=!1,this._evalFeatureReduction(this._featureReduction))},isFeatureReductionApplied:function(){return this.hasFeatureReduction()&&this.isFeatureReductionEnabled()&&this._canCluster(this.getFeatureReduction())},getAggregateGraphics:function(){return this._clusterManager?this._clusterManager.getAggregateGraphics():[]},getChildGraphics:function(e){return this._clusterManager?this._clusterManager.getFeaturesInCluster(e):[]},getSingleGraphics:function(){return this._clusterManager?this._clusterManager.getSingleGraphics():[]},getFeatureReductionRenderer:function(){return this.isFeatureReductionActive()?this._clusterManager.getClusterRenderer():null},getFeatureReductionLayer:function(){return this._clusterManager?this._clusterManager.container:null},getFeatureReductionField:function(e){var t,i=this._clusterManager?this._clusterManager.getClusterFields():null;return e=e?e.toLowerCase():"",r.some(i,(function(i){return e===i.name.toLowerCase()&&(t=i),!!t})),t},_isFeatureReductionSupported:function(e){return e&&"cluster"===e.type&&"esriGeometryPoint"===this.geometryType&&(this._collection||this._isStream||this._optQueryPagination&&this.advancedQueryCapabilities.supportsPagination)},_isReductionCompatibleRenderer:function(e){var t=e&&e.declaredClass||"";return(t=t.toLowerCase()).indexOf("simplerenderer")>-1||t.indexOf("classbreaksrenderer")>-1||t.indexOf("uniquevaluerenderer")>-1},_evalFeatureReduction:function(e){this.loaded&&this.getMap()&&(e=e||this.getFeatureReduction(),this._evalModeFromFReduction(e),e&&this.isFeatureReductionEnabled()?this._canCluster(e)?this._clusterManager?this._updateClusterManager(e):(this._clusterManager=this._createClusterManager(e),this.onFeatureReductionChange()):(console.log("Clustering is supported only for point layers where map spatial reference is WGS84 or Web Mercator"),this._destroyClusterManager()):this._destroyClusterManager())},_canCluster:function(e){var t=this._map;if(!t)return!1;var i=t.spatialReference;return this._isFeatureReductionSupported(e)&&this._isReductionCompatibleRenderer(this.renderer)&&(i.isWebMercator()||4326===i.wkid)},_createClusterManager:function(e){var t=new ne({layer:this,aggregationInfo:e});return this._clusterHandles=[t.on("renderer-change",n.hitch(this,(function(){this.onFeatureReductionRendererChange()})))],t.initialize(this._map),t},_updateClusterManager:function(e){var t=this._clusterManager;t&&t.setAggregationInfo(e)},_destroyClusterManager:function(e){r.forEach(this._clusterHandles,(function(e){e.remove()})),this._clusterHandles=null,this._clusterManager&&(this._clusterManager.destroy(e),this._clusterManager=null,this.onFeatureReductionChange())},redraw:function(){this.inherited(arguments),this._clusterManager&&this._clusterManager.redraw(),this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(e){this.inherited(arguments);var t=this._getRenderer();this._ager=!!(t&&t.observationAger&&t.observationRenderer),this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(t&&t.trackRenderer),e&&this._evalFeatureReduction()},_graphicVisibilityChanged:function(e){this._clusterManager?this._clusterManager.toggleFeatureVisibility(e):this._heatmapManager&&this._heatmapManager.redraw()},setWebGLFetchOptions:function(e){this._hasOnDemandDrillMode()&&(null!=(e=e||{}).maxDrillLevel&&(this._mode.maxDrillLevel=e.maxDrillLevel),null!=e.maxRecordCountFactor&&(this._mode.maxRecordCountFactor=e.maxRecordCountFactor),null!=e.enablePBFQuery&&(this._mode.enablePBFQuery=e.enablePBFQuery))},_isWebGLCompatible:function(){return this.loaded&&!this.isEditable()&&!this.isFeatureReductionApplied()&&(!this.labelingInfo||!1===this.showLabels)&&!this._isGeometryOperationsUsed()&&this._isRendererSupportedInWebGL()&&this.supportsCoordinatesQuantization&&("esriGeometryPolygon"!==this.geometryType||this.advancedQueryCapabilities.supportsReturningGeometryCentroid)&&this.currentMode===ue.MODE_ONDEMAND&&(!this._preSurfaceChangeState||this._preSurfaceChangeState.currentMode===ue.MODE_ONDEMAND)},_isRendererSupportedInWebGL:function(){if(!this.renderer)return!1;var e=this.renderer,t=e.declaredClass?e.declaredClass.toLowerCase():"";return(t.indexOf("simplerenderer")>-1||t.indexOf("classbreaksrenderer")>-1||t.indexOf("uniquevaluerenderer")>-1)&&this._hasWebGLCompatibleSymbols(e)&&this._hasWebGLCompatibleVVs(e)},_hasWebGLCompatibleSymbols:function(e){var t=this._getAllSymbolsInRenderer(e);return!(this._hasSLSWithMarker(t)||this._hasIncompatibleSMSStyles(t)||this._hasGIFMarker(t))},_hasWebGLCompatibleVVs:function(e){return!r.some(e&&e.visualVariables,(function(e){var t=e.type;return!("colorInfo"!==t&&"opacityInfo"!==t||!e.stops||!(e.stops.length>8))||!!("sizeInfo"===t&&(e.field||e.valueExpression&&"$view.scale"!==e.valueExpression||e.expression&&"view.scale"!==e.expression)&&e.stops&&e.stops.length>6)}))},_hasSLSWithMarker:function(e){return r.some(e,(function(e){return e&&"simplelinesymbol"===e.type&&!!e.marker}))},_hasIncompatibleSMSStyles:function(e){var t=void 0===_("ie")&&7==_("trident");return r.some(e,(function(e){return e&&"simplemarkersymbol"===e.type&&("triangle"===e.style||"path"===e.style&&t)}))},_hasGIFMarker:function(e){var t=/\.gif$/,i=/^image\/gif$/;return r.some(e,(function(e){return!(!e||"picturemarkersymbol"!==e.type)&&(t.test(e.url)||i.test(e.contentType))}))},_getAllSymbolsInRenderer:function(e){var t=[];return e&&(t.push(e.symbol),t.push(e.defaultSymbol),r.forEach(e.infos,(function(e){t.push(e.symbol)})),t=r.filter(t,(function(e){return!!e}))),t},_setMap:function(e){var t=this.inherited(arguments),i=this._mode,s=this;return i&&e.loaded&&i.initialize(e),this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase()),this._addHandle=this.on("graphic-node-add",(function(e){var t=e.graphic.attributes,i=t&&t[s.objectIdField],n=s._selectedFeatures[i];n&&n.attr("data-selected","")})),t},_unsetMap:function(e){this._suspendImpl(!0),this._destroyClusterManager(!1),this._trackManager&&(this._trackManager.destroy(),this._trackManager=null),s.disconnect(this._zoomConnect),s.disconnect(this._addHandle),this._zoomConnect=this._addHandle=null,this.inherited("_unsetMap",arguments)},onAttach:function(){this._evalModeFromSurface()},onRefreshTick:function(){this.isFeatureUpdatesCheckActive()&&this._evalFeatureUpdates()},refresh:function(e){if(this._needsRefresh||!e||!e.scheduled||!this.isFeatureUpdatesCheckActive()){this._needsRefresh=!1;var t=this._mode;t&&t.refresh()}},setFeatureUpdatesCheckEnabled:function(e){this._featureUpdatesCheckEnabled=e},isFeatureUpdatesCheckEnabled:function(){return!!this._featureUpdatesCheckEnabled},isFeatureUpdatesCheckActive:function(){return this.supportsLastEditDate&&this.isFeatureUpdatesCheckEnabled()&&!!this.refreshInterval&&!!n.getObject("onFeatureUpdatesResult.after",!1,this)},hasFeatureUpdates:function(){var e=new o;return this.supportsLastEditDate?(this._fetchMetadataPromise&&!this._fetchMetadataPromise.isFulfilled()||(this._fetchMetadataPromise=g({url:this._url.path,content:n.mixin({f:"json"},this._url.query),callbackParamName:"callback"}).then(n.hitch(this,(function(e){var t=e.editingInfo.lastEditDate,i=this.editingInfo.lastEditDate!==t;return this.editingInfo.lastEditDate=t,i})))),this._fetchMetadataPromise.then((function(t){e.isFulfilled()||e.resolve(t)})).otherwise((function(t){e.isFulfilled()||e.reject(t)})),e.promise):(e.reject(new Error("FeatureLayer does not support supportsLastEditDate")),e.promise)},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return r.filter(this._getOutFields(),(function(e){return"*"===e||!!this._getField(e)}),this)},getField:function(e){return this._getField(e,!0)},isOutField:function(e){var t=this.getField(e);if(!t)return!1;var i=this.getOutFields();return r.indexOf(i,"*")>-1||r.indexOf(i,t.name)>-1},getFieldLabel:function(e){var t=this.infoTemplate,i=t&&t.getFieldInfo&&t.getFieldInfo(e),s=n.isFunction(e)?null:this.getField(e),r=i||s,a="";return r&&(a=i&&i.label||s&&s.alias||r.name||r.fieldName),a},getDomain:function(e,t){var i,s,n=t&&t.feature,a=n&&this.typeIdField&&n.attributes&&n.attributes[this.typeIdField];return null!=a&&r.some(this.types,(function(t){return t.id==a&&((i=t.domains&&t.domains[e])&&"inherited"===i.type&&(i=this._getLayerDomain(e),s=!0),!0)}),this),s||i||(i=this._getLayerDomain(e)),i},_getLayerDomain:function(e){this._createFieldsIndex();var t,i=this._fieldsIndex;if(i){var s=(i=i.caseSensitive).get(e);return s?s.domain:null}return r.some(this.fields,(function(i){return i.name===e&&(t=i.domain),!!t})),t},getType:function(e){var t=e&&this.typeIdField&&e.attributes&&e.attributes[this.typeIdField];return this.getTypeById(t)},getTypeById:function(e){var t;return r.some(this.types,(function(i){return i.id==e&&(t=i),!!t})),t},getSubtypeByCode:function(e){var t;return r.some(this.subtypes,(function(i){return i.code==e&&(t=i),!!t})),t},setEditable:function(e){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(this._isImageService)return this;if(!this.loaded)return this._optEditable=e,this;var t=this._editable;return this._editable=e,this._updateCaps(),t!==e&&this.onCapabilitiesChange(),this},getEditCapabilities:function(e){if(!this.loaded||!this.isEditable())return{canCreate:!1,canUpdate:!1,canDelete:!1,canUpdateGeometry:!1};var t,i=e&&e.feature,s=e&&e.userId||this.getUserId(),a=r.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],n.trim),o=r.indexOf(a,"editing")>-1,l=o&&r.indexOf(a,"create")>-1,u=o&&r.indexOf(a,"update")>-1,h=o&&r.indexOf(a,"delete")>-1,d=this.ownershipBasedAccessControlForFeatures,c=this.editFieldsInfo,f=c&&c.creatorField,p=c&&c.realm,_=i&&i.attributes,m=_&&f?_[f]:void 0,y=!!this.userIsAdmin,g=!d||y||!(!d.allowOthersToUpdate&&!d.allowUpdateToOthers),b=!d||y||!(!d.allowOthersToDelete&&!d.allowDeleteToOthers),F=!d||y||!d.hasOwnProperty("allowAnonymousToUpdate")||d.allowAnonymousToUpdate,v=!d||y||!d.hasOwnProperty("allowAnonymousToDelete")||d.allowAnonymousToDelete;if(s&&p&&(s=s+"@"+p),(y||o&&!(l||u||h))&&(l=u=h=!0),t={canCreate:l,canUpdate:u,canDelete:h,canUpdateGeometry:y||this.allowGeometryUpdates},s||(t.canUpdate=t.canUpdate&&F,t.canDelete=t.canDelete&&v),null===m)t.canUpdate=t.canUpdate&&g,t.canDelete=t.canDelete&&b;else{if(""===m)return t;if(m){if(s.toLowerCase()===m.toLowerCase())return t;t.canUpdate=t.canUpdate&&g,t.canDelete=t.canDelete&&b}}return t},getUserId:function(){var e;return this.loaded&&(e=this.credential&&this.credential.userId||this.userId||""),e},setUserIsAdmin:function(e){this.userIsAdmin=e},setEditSummaryCallback:function(e){this.editSummaryCallback=e},getEditSummary:function(e,t,i){i=y.isDefined(i)?i:(new Date).getTime();var s="",r=this.getEditInfo(e,t,i),a=t&&t.callback||this.editSummaryCallback;if(a&&(r=a(e,r)||""),n.isString(r))s=r;else{if(r){var o=r.action,l=r.userId,u=r.timeValue,h=0;o&&h++,l&&h++,y.isDefined(u)&&h++,h>1&&(s=("edit"===o?"edit":"create")+(l?"User":"")+(y.isDefined(u)?r.displayPattern:""))}s=s&&y.substitute(r,this.i18n.layers.FeatureLayer[s])}return s},getEditInfo:function(e,t,i){if(this.loaded){i=y.isDefined(i)?i:(new Date).getTime();var s,n=t&&t.action||"last",r=this.editFieldsInfo,a=r&&r.creatorField,o=r&&r.creationDateField,l=r&&r.editorField,u=r&&r.editDateField,h=(r&&r.realm,e&&e.attributes),d=h&&a?h[a]:void 0,c=h&&o?h[o]:null,f=h&&l?h[l]:void 0,p=h&&u?h[u]:null,_=this._getEditData(d,c,i),m=this._getEditData(f,p,i);switch(n){case"creation":s=_;break;case"edit":s=m;break;case"last":s=m||_}return s&&(s.action=s===m?"edit":"creation"),s}},_getEditData:function(e,t,i){var s,n,r;if(y.isDefined(t)&&(r=(n=i-t)<0?"Full":n<6e4?"Seconds":n<12e4?"Minute":n<36e5?"Minutes":n<72e5?"Hour":n<864e5?"Hours":n<6048e5?"WeekDay":"Full"),(void 0!==e||r)&&((s=s||{}).userId=e,r)){var a=l.format,o=new Date(t);s.minutes=Math.floor(n/6e4),s.hours=Math.floor(n/36e5),s.weekDay=a(o,{datePattern:"EEEE",selector:"date"}),s.formattedDate=a(o,{selector:"date"}),s.formattedTime=a(o,{selector:"time"}),s.displayPattern=r,s.timeValue=t}return s},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},isQueryable:function(){var e=r.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],n.trim);return this._isStream||this.userIsAdmin||this._collection||-1!==r.indexOf(e,"query")||-1!==r.indexOf(e,"catalog")},setResolution:function(e){return this.setMaxAllowableOffset(e)},setMaxAllowableOffset:function(e){return this.isEditable()||(this._optMaxOffset=e,this._setMaxOffset(e,!0)),this},_resetMaxAllowableOffset:function(){this.setMaxAllowableOffset(this._optMaxOffset),this._prevScale=null,this._refreshMaxAllowableOffset()},_refreshMaxAllowableOffset:function(){this._calcMaxOffsetForAutoSnapshot(),this._updateMaxOffset(),this._needsRefresh=!1},getResolution:function(){return this.getMaxAllowableOffset()},getMaxAllowableOffset:function(){var e=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:e},_setMaxOffset:function(e,t){return null==e?(delete this._maxOffset,delete this._quantizationParameters,this):(this.quantize&&this.supportsCoordinatesQuantization?("esriGeometryPolyline"===this.geometryType?this._maxOffset=e:delete this._maxOffset,this._quantizationParameters=e?{mode:"view",originPosition:"upperLeft",tolerance:e,extent:this.fullExtent}:null):(this._isFractionalOffsetAllowed()&&t||(e=Math.floor(e)),isNaN(e)||0===e?delete this._maxOffset:this._maxOffset=e,delete this._quantizationParameters),this)},_isFractionalOffsetAllowed:function(){return null==this.version||this.version>=10.1||navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(e){return e=(e=e&&e.split("-"))&&e[0]&&e[0].toLowerCase(),-1!==r.indexOf(this._langsWithDot,e)},_langsWithDot:["ar","en","et","fr","he","ja","ko","th","vi","zh"],setAutoGeneralize:function(e){return this.loaded?this._canAutoGeneralize()&&(this._autoGeneralize=e,e?(this._isAutoSnapshotMode()&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)):this._optAutoGen=e,this},_canAutoGeneralize:function(){return!this.isEditable()&&this.mode!==ue.MODE_SNAPSHOT},setGDBVersion:function(e){return this._collection||e===this.gdbVersion||!e&&!this.gdbVersion||(this.gdbVersion=e,this._task.gdbVersion=e,this._url.query=n.mixin(this._url.query,{gdbVersion:e}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange()),this},hasAllFeatures:function(){return!this._mode||this._mode.hasAllFeatures()},hasUpdateError:function(){return!!this._mode&&this._mode.hasUpdateError()},setDefinitionExpression:function(e){if(this._defnExpr=e,!this._hasPendingLimitQuery()){var t=this._checkFeatureLimit();t?this._evalModeAndApplyDefnExpr(t):this._applyDefnExpr()}return this},_applyDefnExpr:function(){var e=this._mode;e&&e.propertyChangeHandler(1)},_evalModeAndApplyDefnExpr:function(e){e.then(n.hitch(this,(function(e){e&&(e instanceof Error||!e.modeChanged)&&this._applyDefnExpr()})))},getDefinitionExpression:function(){return this._defnExpr},hasDefinitionExpressionWithCurrentTimestamp:function(){return this.reSQLCurrentTimestamp.test(this.getDefinitionExpression())},setTimeDefinition:function(e){if(this._isSnapshotMode()){this._timeDefn=e;var t=this._mode;t&&t.propertyChangeHandler(2)}else console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id = "+this.id+", Layer URL = "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(e,t){this._timeOffset=e,this._timeOffsetUnits=t;var i=this._mode;return i&&i.propertyChangeHandler(0),this},setUseMapTime:function(e){this.useMapTime=e,this._toggleTime(!this.suspended);var t=this._mode;t&&t.propertyChangeHandler(0)},selectFeatures:function(e,t,i,s){t=t||ue.SELECTION_NEW,this._hasPartialSelectedFeatures=!1,this._hasSelectionError=!1;var n,r=this._getShallowClone(e),a=this._map,l=this,u=F._fixDfd(new o(F._dfdCanceller));if(r.outFields=this.getOutFields(),r.returnGeometry=!0,r.multipatchOption=this.multipatchOption,a&&(r.outSpatialReference=new S(a.spatialReference.toJson())),!this._applyQueryFilters(r,!0))return n={features:[]},this._selectHandler(n,t,i,s,u),u;var h=this._canDoClientSideQuery(r);if(h)return u._pendingDfd=c(this._doQuery(r,h)),u._pendingDfd.then((function(e){n={features:e},l._selectHandler(n,t,i,s,u)})),u;if(this._collection){var d=new Error("FeatureLayer::selectFeatures - "+this.invalidParams);return this._resolve([d],null,s,u,!0),u}if(this.loaded&&!this.isQueryable()){var f=new Error("Layer does not support query capability.");return this._resolve([f],null,s,u,!0),u}var p=this;this._ts&&(r._ts=(new Date).getTime());var _=this._canFetchPBFForQuery(r);this._enableEditModeQuantization(r,_);var m=_?{format:"pbf"}:null;return(u._pendingDfd=this._task.execute(r,null,null,m)).addCallbacks((function(e){p._selectHandler(e,t,i,s,u)}),(function(e){p._hasPartialSelectedFeatures=!0,p._hasSelectionError=!0,p._resolve([e],null,s,u,!0)})),u},getSelectedFeatures:function(){var e,t=this._selectedFeatures,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},clearSelection:function(e){var t,i=this._selectedFeatures,s=this._mode;for(t in i)i.hasOwnProperty(t)&&(this._unSelectFeatureIIf(t,s),s._removeFeatureIIf(t));return this._selectedFeatures={},this._isSelOnly&&s._applyTimeFilter(!0),e||this.onSelectionClear(),this},setSelectionSymbol:function(e){if(this._selectionSymbol=e,e){var t,i=this._selectedFeatures;for(t in i)i.hasOwnProperty(t)&&i[t].setSymbol(e)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(e){e?(this.labelingInfo=e,this._fixLabelExpr()):delete this.labelingInfo,this._collection&&(this._typesDirty=!0),this._evalSurfaceType(),this.onLabelingInfoChange()},_fixLabelExpr:function(){var e,t=/\[([^\[\]]+)\]/gi,i=this,s=function(e,t){var s=i._getField(t,!0);return"["+(s&&s.name||t)+"]"};r.forEach(this.labelingInfo,(function(i){(e=i.labelExpression)&&(i.labelExpression=e.replace(t,s))}))},_updateRequiredFieldsFromLabelingInfo:function(){var e=this.labelingInfo,t=[];r.forEach(e,(function(e){var i,s,n=e.labelExpressionInfo;if(e.labelExpression){var a=/[\[\]]/gi;i=e.labelExpression.match(/\[[^\[\]]+\]/gi),(s=r.map(i,(function(e){return e.replace(a,"")})))&&(t=t.concat(s))}if(n){if(n.value){var o=/[\{\}]/gi;i=n.value.match(/\{[^\{\}]+\}/gi),(s=r.map(i,(function(e){return e.replace(o,"")})))&&(t=t.concat(s))}n.expression&&(t=t.concat(A.extractFieldNames(n.expression)))}})),t=r.map(t,(function(e){var t=this.getField(e);return t?t.name:e}),this),this._requiredFields&&(this._requiredFields=this._requiredFields.concat(t))},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(e,t,i,s,a,o){var l=o.assembly,u=o.dfd;this._applyNormalized(e,l&&l[0]),this._applyNormalized(t,l&&l[1]),this.onBeforeApplyEdits(e,t,i);var h,d={},c=this.objectIdField,f={f:"json"},p=!1;if(this._collection){var _={};return _.addResults=e?r.map(e,(function(){return p=!0,{objectId:this._nextId++,success:!0}}),this):null,_.updateResults=t?r.map(t,(function(e){p=!0;var t=e.attributes[c];return d[t]=e,{objectId:t,success:!0}}),this):null,_.deleteResults=i?r.map(i,(function(e){return p=!0,{objectId:e.attributes[c],success:!0}}),this):null,void(p?this._editHandler(_,e,d,s,a,u):this._resolve([_.addResults,_.updateResults,_.deleteResults],null,s,u))}if(e&&e.length>0&&(f.adds=this._convertFeaturesToJson(e,0,1),p=!0),t&&t.length>0){for(h=0;h<t.length;h++){var m=t[h];d[m.attributes[c]]=m}f.updates=this._convertFeaturesToJson(t,0,0,1),p=!0}if(i&&i.length>0){var y=[];for(h=0;h<i.length;h++)y.push(i[h].attributes[c]);f.deletes=y.join(","),p=!0}if(p){var b=this;return g({url:this._url.path+"/applyEdits",content:n.mixin(f,this._url.query),callbackParamName:"callback",load:function(t){b._editHandler(t,e,d,s,a,u)},error:function(e){b._resolve([e],null,a,u,!0)}},{usePost:!0})}this._resolve([],null,s,u)},queryFeatures:function(e,t,i,s){return this._query("execute","onQueryFeaturesComplete",e,t,i,s)},queryRelatedFeatures:function(e,t,i){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",e,t,i)},queryIds:function(e,t,i,s){return this._query("executeForIds","onQueryIdsComplete",e,t,i,s)},queryCount:function(e,t,i,s){return this._query("executeForCount","onQueryCountComplete",e,t,i,s)},queryExtent:function(e,t,i,s){return this._query("executeForExtent","onQueryExtentComplete",e,t,i,s)},queryAttachmentInfos:function(e,t,i){var s=this._url.path+"/"+e+"/attachments",a=new o(F._dfdCanceller),l=this;return s=x.normalize(s),a._pendingDfd=g({url:s,content:n.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(i){var n,o=i.attachmentInfos;r.forEach(o,(function(t){n=u.objectToQuery({gdbVersion:l._url.query&&l._url.query.gdbVersion,layer:l._url.query&&l._url.query.layer,token:l._getToken()}),t.url=s+"/"+t.id+(n?"?"+n:""),t.objectId=e})),l._resolve([o],"onQueryAttachmentInfosComplete",t,a)},error:function(e){l._resolve([e],null,i,a,!0)}}),a},addAttachment:function(e,t,i,s){return this._sendAttachment("add",e,t,i,s)},updateAttachment:function(e,t,i,s,n){return i.appendChild(h.create("input",{type:"hidden",name:"attachmentId",value:t})),this._sendAttachment("update",e,i,s,n)},deleteAttachments:function(e,t,i,s){var a=this._url.path+"/"+e+"/deleteAttachments",l=new o(F._dfdCanceller),u=this,h={f:"json",attachmentIds:t.join(",")};return l._pendingDfd=g({url:a,content:n.mixin(h,this._url.query),callbackParamName:"callback",load:n.hitch(this,(function(t){var s=t.deleteAttachmentResults;s=r.map(s,(function(t){var i=new J(t);return i.attachmentId=i.objectId,i.objectId=e,i})),u._resolve([s],"onDeleteAttachmentsComplete",i,l)})),error:function(e){u._resolve([e],null,s,l,!0)}},{usePost:!0}),l},addType:function(e){var t=this.types;if(t){if(r.some(t,(function(t){return t.id==e.id})))return!1;t.push(e)}else this.types=[e];return this._typesDirty=!0,!0},deleteType:function(e){if(this._collection){var t=this.types;if(t){var i=-1;if(r.some(t,(function(t,s){return t.id==e&&(i=s,!0)})),i>-1)return this._typesDirty=!0,t.splice(i,1)[0]}}},toJson:function(){var e=this._cloneJson();if(e){var t=(e=e.layerDefinition?e:{layerDefinition:e}).layerDefinition,i=this._collection;this._updateLayerDefinition(t);var s=null;if(i&&!this._fcAdded||(s={geometryType:t.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)}),e.featureSet=n.mixin({},e.featureSet||{},s),e.featureSet.transform){var r=e.featureSet.transform;delete e.featureSet.transform,(s=new L(e.featureSet)).quantize(r),e.featureSet=s.toJson()}return i&&(e.nextObjectId=this._nextId,t.capabilities=this.capabilities),e}},getLayerDefinition:function(){var e=this._cloneJson(),t=e?e.layerDefinition||e:null;return t&&this._updateLayerDefinition(t),t},getFeatureCollectionLayer:function(e){var t=new o,i=this.getLayerDefinition();if(!i)return t.reject(new Error("layerDefinition not available")),t.promise;e=e||[];var s=new ue({layerDefinition:i,featureSet:{geometryType:i.geometryType,features:r.map(e,(function(e){return e.toJson()}))}}),n=s.on("load",(function(){n.remove(),a.remove(),t.resolve(s)})),a=s.on("error",(function(){s.loaded||(n.remove(),a.remove(),t.reject(s.loadError))}));return t.promise},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},onFeatureReductionRendererChange:function(){},onFeatureReductionChange:function(){},onFeatureUpdatesResult:function(){},_cloneJson:function(){var e=this._json;return n.isString(e)?a.fromJson(e):n.clone(e)},_updateLayerDefinition:function(e){if(this._collection&&this._typesDirty){e.types=r.map(this.types||[],(function(e){return e.toJson()}));var t=this.renderer,i=this.labelingInfo,s=e.drawingInfo;!t&&!i||s||(s=e.drawingInfo={}),s&&t&&-1===t.declaredClass.indexOf("TemporalRenderer")&&(s.renderer=t.toJson()),i&&(s.labelingInfo=r.map(i,(function(e){return e.toJson()})))}},_evalFeatureUpdates:function(){this._featureUpdatesPromise&&!this._featureUpdatesPromise.isFulfilled()||(this._featureUpdatesPromise=this.hasFeatureUpdates().otherwise((function(e){return!(e&&"cancel"===e.dojoType)})).always(n.hitch(this,(function(e){this._featureUpdatesPromise=null,this.onFeatureUpdatesResult({hasUpdates:e})}))))},_evalRefresh:function(e){(e.hasUpdates||this.hasDefinitionExpressionWithCurrentTimestamp())&&this.refresh()},_evalArcadeSupport:function(){var e=new o;return setTimeout(n.hitch(this,(function(){this._initializeArcadeEngine().always((function(){e.resolve()}))})),0),e.promise},_initializeArcadeEngine:function(){var e=[],t=this.infoTemplate;t&&t.initializeArcadeEngine&&e.push(t.initializeArcadeEngine());var i=this.renderer;i&&i.initializeArcadeEngine&&e.push(i.initializeArcadeEngine());var s=[];return r.forEach(this.labelingInfo,(function(e){var t=e.labelExpressionInfo;t&&t.expression&&s.push(t.expression)})),e.push(R.initialize(s)),v(e)},_isGeometryOperationsUsed:function(){var e=this.infoTemplate,t=this.renderer,i=this.labelingInfo;return!!(e&&e.hasGeometryOperations&&e.hasGeometryOperations())||(!!(t&&t.hasGeometryOperations&&t.hasGeometryOperations())||!!r.some(i,(function(e){var t=e.labelExpressionInfo&&e.labelExpressionInfo.expression;return A.hasGeometryOperations(t)})))},_forceIdentity:function(){var e,t=new o,i=this,s=this._url&&this._url.path,n=s&&s.toLowerCase().indexOf("/rest/services"),r=this.editFieldsInfo,a=r&&(r.creatorField||r.editorField);return(this.userIsAdmin||a)&&!this._getToken()&&n>-1&&m.id?(e=s.substring(0,n)+"/rest/info",g({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then((function(e){if(e.owningSystemUrl)return m.id.checkSignInStatus(e.owningSystemUrl+"/sharing")})).then((function(e){if(e)return m.id.getCredential(s)})).then((function(e){e&&i._findCredential()})).always((function(){t.resolve()}))):t.resolve(),t.promise},_isSnapshotMode:function(){return!!this._mode&&this._mode.isInstanceOf(Z)},_isOnDemandMode:function(){return!!this._mode&&this._mode.isInstanceOf(Y)},_isAutoSnapshotMode:function(){return this._isAutoModeEnabled()&&this.currentMode===ue.MODE_SNAPSHOT},_getMaxFeaturesForAutoSnapshotMode:function(){var e,t=this.geometryType;return"esriGeometryPolyline"===t||"esriGeometryPolygon"===t||"esriGeometryMultipoint"===t||this.hasXYFootprint()?e=this.maxRecordCountForAuto:"esriGeometryPoint"===t&&(e=this.maxPointCountForAuto),e},getLastExceedsLimitResult:function(){return this._lastExceedsLimitResult},_canUseSnapshotMode:function(e){var t=e&&e.features&&e.features[0],i=t&&t.attributes&&t.attributes.exceedslimit;return this._lastExceedsLimitResult=i,!(this.mode!==ue.MODE_AUTO||this.isEditable()||0!==i||!(this._isPaginationAllowed()||this.maxRecordCount>=this._getMaxFeaturesForAutoSnapshotMode()))},_evalModeFromFLimit:function(e){this._canUseSnapshotMode(e)?this._enableAutoSnapshotMode():this._enableAutoOnDemandMode()},_enableAutoSnapshotMode:function(){var e=ue.MODE_SNAPSHOT;if(!this.isFeatureReductionApplied())return this._preSurfaceChangeState?(this._updatePreSurfaceChangeState(e),void this._evalSurfaceType(!0)):void(this.currentMode!==e&&this._setFetchMode(ue.MODE_AUTO,e));this._updatePreFReductionState(e)},_enableAutoOnDemandMode:function(){var e=ue.MODE_ONDEMAND;this.isFeatureReductionApplied()?this._updatePreFReductionState(e):this._preSurfaceChangeState?this._updatePreSurfaceChangeState(e):this.currentMode!==e&&(this._setFetchMode(ue.MODE_AUTO,e),this._evalSurfaceType())},_evalModeFromFReduction:function(e){this.loaded&&(e&&this.isFeatureReductionEnabled()&&this._canCluster(e)?this._enableFReductionMode():this._disableFReductionMode())},_enableFReductionMode:function(){if(this._evalSurfaceType(!0),!this._preFReductionState){var e=this.currentMode;e!==ue.MODE_SNAPSHOT&&e!==ue.MODE_STREAM&&e!==ue.MODE_SELECTION&&(this._preFReductionState={mode:this.mode,currentMode:this.currentMode},this._setFetchMode(this.mode===ue.MODE_AUTO?ue.MODE_AUTO:ue.MODE_SNAPSHOT,ue.MODE_SNAPSHOT))}},_disableFReductionMode:function(){var e=this._preFReductionState;this._preFReductionState=null,!e||e.mode===this.mode&&e.currentMode===this.currentMode||(this._setFetchMode(e.mode,e.currentMode),this._evalSurfaceType())},_updatePreFReductionState:function(e){this._preFReductionState=this._preFReductionState||{},this._preFReductionState.mode=ue.MODE_AUTO,this._preFReductionState.currentMode=e},_evalModeFromSurface:function(){this.hasWebGLSurface()?this._enableWebGLSurfaceMode():this._disableWebGLSurfaceMode()},_enableWebGLSurfaceMode:function(){this._preSurfaceChangeState||(this._preSurfaceChangeState={mode:this.mode,currentMode:this.currentMode},this._setFetchMode(this.mode===ue.MODE_AUTO?ue.MODE_AUTO:ue.MODE_ONDEMAND,ue.MODE_ONDEMAND,this.webglDeps.OnDemandDrillMode))},_disableWebGLSurfaceMode:function(){var e=this._preSurfaceChangeState;e&&(this._preSurfaceChangeState=null,this._setFetchMode(e.mode,e.currentMode))},_updatePreSurfaceChangeState:function(e){this._preSurfaceChangeState=this._preSurfaceChangeState||{},this._preSurfaceChangeState.mode=ue.MODE_AUTO,this._preSurfaceChangeState.currentMode=e},_setFetchMode:function(e,t,i){this.clearSelection(),this._mode.suspend(),this._mode.destroy(),this.mode=e,this.currentMode=t,i=i||this._getModeConstructor(t),this._mode=new i(this),this.queryPagination=(t!==ue.MODE_ONDEMAND||-1!==i.prototype.declaredClass.toLowerCase().indexOf("ondemanddrillmode"))&&this._isPaginationAllowed();var s=this.getMap();s&&s.loaded&&(this._resetMaxAllowableOffset(),this._mode.initialize(s),this._mode.startup())},_isPaginationAllowed:function(){return!(!this._optQueryPagination||this.loaded&&!this.advancedQueryCapabilities.supportsPagination)},_getModeConstructor:function(e){var t;return e===ue.MODE_SNAPSHOT?t=Z:e===ue.MODE_ONDEMAND&&(t=Y),t},_hasOnDemandDrillMode:function(){var e=this._mode,t=e&&e.declaredClass;return!!(t&&t.toLowerCase().indexOf("ondemanddrillmode")>-1)},_checkFeatureLimit:function(){this._limitPromise&&(this._limitPromise.cancel(),this._limitPromise=null);var e=this._queryLimit();return e&&(this._lastExceedsLimitResult=null,this._limitPromise=e.then(n.hitch(this,(function(e){var t=this.currentMode;return this._evalModeFromFLimit(e),{modeChanged:this.currentMode!==t}}))).always(n.hitch(this,(function(e){return this._limitPromise=null,e})))),this._limitPromise},_hasPendingLimitQuery:function(){return!!this._exceedsLimitTimer},_queryLimit:function(){if(this._isAutoModeEnabled()){var e,t,i=new o((function(){clearTimeout(e),e=null,t&&!t.isFulfilled()&&t.cancel(),t=null}));return this._exceedsLimitTimer=e=setTimeout(n.hitch(this,(function(){this._exceedsLimitTimer=null;var e=new P,s=new k;s.statisticType="exceedslimit",s.maxPointCount=this.maxPointCountForAuto,s.maxRecordCount=this.maxRecordCountForAuto,s.maxVertexCount=this.maxVertexCountForAuto,s.outStatisticFieldName="exceedslimit",e.outStatistics=[s],t=this.queryFeatures(e).promise.then((function(e){i.resolve(e)})).otherwise((function(e){i.reject(e)}))})),0),i.promise}},_isAutoModeEnabled:function(){return this.mode===ue.MODE_AUTO&&this.reHostedFS.test(this.url)},_updateCaps:function(){var e,t,i,s=this._editable,a=n.trim(this.capabilities||""),o=r.map(a?a.split(","):[],n.trim),l=r.map(a?a.toLowerCase().split(","):[],n.trim),u=r.indexOf(l,"editing"),h={Create:r.indexOf(l,"create"),Update:r.indexOf(l,"update"),Delete:r.indexOf(l,"delete")};if(s&&-1===u)o.push("Editing");else if(!s&&u>-1){for(e in i=[u],h)h[e]>-1&&i.push(h[e]);for(i.sort(),t=i.length-1;t>=0;t--)o.splice(i[t],1)}this.capabilities=o.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments),this._suspendImpl()},_suspendImpl:function(e){this._toggleTime(!1),this._refreshHandle&&(this._refreshHandle.remove(),this._refreshHandle=null);var t=this._mode;t&&(t.suspend(),e&&t.destroy())},onResume:function(e){this.inherited(arguments),this._toggleTime(!0),this._refreshHandle=this.on("feature-updates-result",n.hitch(this,this._evalRefresh));var t=this._map,i=this._getRenderer();if(e.firstOccurrence){this._fixRendererFields(),this._updateRequiredFieldsFromLabelingInfo(),this._checkFields(),this.clearSelection(),this._evalFeatureReduction(),this.timeInfo&&!this._trackManager&&(this._trackIdField||i&&(i.latestObservationRenderer||i.trackRenderer))&&(this._trackManager=new ie(this),this._trackManager.initialize(t),this._childLayer=this._trackManager.container),i&&"colors"in i&&"blurRadius"in i&&"maxPixelIntensity"in i&&("esriGeometryPoint"!=this.geometryType||this._heatmapManager||(this._heatmapManager=new se(this),this._heatmapManager.initialize(t))),this._zoomConnect=s.connect(t,"onZoomEnd",this,this._zoomEndHandler),this._refreshMaxAllowableOffset();var r=this._mode;r&&(r._init||r.initialize(t),r.startup())}else this._zoomEndHandler(),this._mode&&this._mode.resume()},_zoomEndHandler:function(){var e=this._map;this._updateMaxOffset(),this._prevScale=e.getScale(),!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var e=this._map;if(e&&e.loaded&&this._autoGeneralize)if(this._isAutoSnapshotMode()){var t=this.getMaxAllowableOffset();this._setMaxOffset(this._getMaxOffsetForScale(),!0),this._needsRefresh||(this._needsRefresh=t!=this.getMaxAllowableOffset())}else this._setMaxOffset(e.extent.getWidth()/e.width,!e.extent.spatialReference.isWebMercator())},_getMaxOffsetForScale:function(){if(this._map){var e=this._map.getScale(),t=this._calculatedScale,i=this._calcMaxOffset,s=this._prevScale;return e>=t&&(null==s||s<t)?i:e<t&&(null==s||s>=t)?null:this.getMaxAllowableOffset()}},_calcMaxOffsetForAutoSnapshot:function(){var e=this._map;if(e&&this._canAutoGeneralize()&&this._isAutoSnapshotMode()&&this._autoGeneralize&&null==this.getMaxAllowableOffset()){var t=this.generalizeForScale;t=this.maxScale?this.maxScale:this.minScale?Math.min(t,this.minScale):Math.min(t,q.getScale(e,this.initialExtent)),this._calculatedScale=t,this._calcMaxOffset=e.extent.getWidth()/e.width/e.getScale()*t}else this._calculatedScale=this._calcMaxOffset=void 0},_toggleTime:function(e){var t=this._map;e&&this.timeInfo&&this.useMapTime&&t?(this._mapTimeExtent=t.timeExtent,this._timeConnect||(this._timeConnect=s.connect(t,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,s.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(e){this._mapTimeExtent=e;var t=this._mode;t&&t.propertyChangeHandler(0)},_getOffsettedTE:function(e){var t=this._timeOffset,i=this._timeOffsetUnits;return e&&t&&i?e.offset(-1*t,i):e},_getTimeOverlap:function(e,t){return e&&t?e.intersection(t):e||t},_getTimeFilter:function(e){var t,i=this.getTimeDefinition();if(i&&!(t=this._getTimeOverlap(i,null)))return[!1];if(e){if(!(e=t?this._getTimeOverlap(e,t):e))return[!1]}else e=t;return[!0,e]},_getAttributeFilter:function(e){var t=[],i=this.getDefinitionExpression();return i&&t.push(i),e&&t.push(e),this.subtypeField&&this.subtypeCode&&t.push(this.subtypeField+" = "+this.subtypeCode),t.length>1&&(t=r.map(t,(function(e){return"("+e+")"}))),t.length?t.join(" AND "):null},_applyQueryFilters:function(e,t){if(e.where=this._getAttributeFilter(e.where),e.returnGeometry&&null==e.maxAllowableOffset&&!e.quantizationParameters&&(e.maxAllowableOffset=this._maxOffset,e.quantizationParameters=this._quantizationParameters),t&&this.supportsAdvancedQueries&&(e.orderByFields=e.orderByFields||this.getOrderByFields()),this.timeInfo){var i=this._getTimeFilter(e.timeExtent);if(!i[0])return!1;e.timeExtent=i[1]}return!0},_add:function(e){var t=this._selectionSymbol,i=e.attributes,s=this.visibilityField;return t&&this._isSelOnly&&e.setSymbol(t),s&&i&&i.hasOwnProperty(s)&&e[i[s]?"show":"hide"](),this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(e,t){var i,s=[],n=this._map;if((this._collection||!this._isTable&&n)&&!(e.text||e.where&&e.where!==this.getDefinitionExpression()||e.orderByFields&&e.orderByFields.length&&(i=this.getOrderByFields()||[])&&e.orderByFields.join()!==i.join()||e.outStatistics||e.returnDistinctValues)){var a=this._isSnapshotMode(),o=this._isSelOnly,l=a?null:t?this._getExtentOfTiles(n.extent):n.extent,u=e.geometry;if(u){if(o||e.spatialRelationship!==P.SPATIAL_REL_INTERSECTS||"extent"!==u.type||!a&&!l.contains(u))return;s.push(1)}var h=e.objectIds;if(h)if(a)s.push(2);else{var d,c=h.length,f=this._mode,p=0;for(d=0;d<c;d++)f._getFeature(h[d])&&p++;if(p!==c)return;s.push(2)}if(this.timeInfo){var _=e.timeExtent,m=this._mapTimeExtent;if(a)_&&s.push(3);else if(o){if(_)return}else if(m)if(-1!==r.indexOf(s,2))_&&s.push(3);else{if(-1===r.indexOf(s,1))return;_==m&&s.push(3)}else if(s.length>0)_&&s.push(3);else if(_)return}return s.length>0?s:null}},_getAbsMid:function(i){return e.toAbsMid?e.toAbsMid(i):t.id.replace(/\/[^\/]*$/gi,"/")+i},_doQuery:function(e,t,i){var s=[],a=this.objectIdField,l=this,u=new o,h=new o,d=this.graphics;if(-1!==r.indexOf(t,1)){var c,f=this.spatialIndex||this._map&&this._map.spatialIndex,p=e.geometry._normalize(null,!0);if(null==f&&ae.autoSpatialIndexing)c=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(n.hitch(this,n.partial(this._getFromIndex,p,f)),(function(e){h.resolve(n.hitch(this,n.partial(this._filterByExtent,d,p)))}));else f&&(c=this._getFromIndex(p,f));c?c.then((function(e){for(var t=0;t<e.length;t++)e[t].results&&(s=s.concat(e[t].results));h.resolve(s)})).otherwise((function(e){h.reject(e)})):h.resolve(this._filterByExtent(d,p))}else h.resolve(d);return h.then((function(n){if(s=n,-1!==r.indexOf(t,2)){var o=e.objectIds;s=r.filter(s,(function(e){return r.indexOf(o,e.attributes[a])>-1}))}if(-1!==r.indexOf(t,3)&&l.timeInfo){var h=e.timeExtent,d=l._filterByTime(s,h.startTime,h.endTime);s=d.match}i&&(s=r.map(s,(function(e){return e.attributes[a]}),this)),u.resolve(s)})),u},_getFromIndex:function(e,t){t=t||this.spatialIndex||this._map.spatialIndex,e instanceof Array||(e=[e]);var i=this.id;return p(r.map(e,(function(e){return t.intersects(e,i)})))},_filterByExtent:function(e,t){for(var i=[],s=0,n=e.length;s<n;s++){var r=e[s],a=r.geometry;a&&(this.normalization&&t.length?(t[0].intersects(a)||t[1].intersects(a))&&i.push(r):t.intersects(a)&&i.push(r))}return i},_filterByTime:function(e,t,i){var s,n=this._startTimeField,r=this._endTimeField;this._twoTimeFields||(s=n||r);var a,o,l,u=y.isDefined,h=[],d=[],c=e.length;if(t=t?t.getTime():-1/0,i=i?i.getTime():1/0,s)for(a=0;a<c;a++){var f=(l=(o=e[a]).attributes)[s];f>=t&&f<=i?h.push(o):d.push(o)}else for(a=0;a<c;a++){var p=(l=(o=e[a]).attributes)[n],_=l[r];p=u(p)?p:-1/0,_=u(_)?_:1/0,p>=t&&p<=i||_>=t&&_<=i||t>=p&&i<=_?h.push(o):d.push(o)}return{match:h,noMatch:d}},_getSizeVariables:function(e){return e&&r.filter(e.getVisualVariablesForType("sizeInfo",!1),(function(e){return!(!e.field&&!e.valueExpression)}))},_needClientSideSorting:function(e){return this._collection?!(!e||!e.length):r.some(e,(function(e){return!!e.valueExpression}))},_sortFeatures:function(e){var t=this.renderer,i=this._getSizeVariables(t);if(e&&e.length>1&&this._needClientSideSorting(i)){var s=i[0],n=this;e.sort((function(e,i){e._layer||(e._layer=n),i._layer||(i._layer=n);var r=t._getDataValue(e,s,"sizeInfo"),a=t._getDataValue(i,s,"sizeInfo");return null==r?-1:null==a?1:a-r}))}return e},_resolve:function(e,t,i,s,n){t&&this[t].apply(this,e),i&&i.apply(null,e),s&&F._resDfd(s,e,n)},_getShallowClone:function(e){var t,i=new P;for(t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i},_canFetchPBF:function(){return!!(oe&&le&&this.supportsFormatPBF)},_canFetchPBFForQuery:function(e){return!(!this._canFetchPBF()||!this._isCacheHintEnabled(e)&&this._isAutoSnapshotMode()||!(e.quantizationParameters||!this.isEditable()&&this.supportsQuantizationEditMode)||e.outStatistics)},_enableEditModeQuantization:function(e,t){e&&t&&!e.quantizationParameters&&(e.quantizationParameters={mode:"edit"})},_enableCacheHint:function(e,t){var i=this.advancedQueryCapabilities;i&&i.supportsQueryWithCacheHint?null==e.cacheHint&&(e.cacheHint=!0):i&&i.supportsQueryWithResultType&&this.reHostedFS.test(this.url)&&(e.resultType||(e.resultType=t||"coherent"))},_isCacheHintSupported:function(){var e=this.advancedQueryCapabilities;return!!e&&!!(e.supportsQueryWithCacheHint||e.supportsQueryWithResultType&&this.reHostedFS.test(this.url))},_isCacheHintEnabled:function(e){var t=this.advancedQueryCapabilities;return!(!e||!t)&&!!(t.supportsQueryWithCacheHint&&e.cacheHint||t.supportsQueryWithResultType&&this.reHostedFS.test(this.url)&&("coherent"===e.resultType||"tile"===e.resultType))},_query:function(e,t,i,s,n,a){var l,u,h,d=this,f=this._map,p=a&&a.snapToTiles,_=new o(F._dfdCanceller),m=i;if("executeRelationshipQuery"!==e){m=this._getShallowClone(i);var y,g=this.getOutFields();if(m.outFields||(m.outFields=g),m.outFields&&m.outFields.length&&(u=!(r.indexOf(g,"*")>-1)&&!r.every(m.outFields,(function(e){return r.indexOf(g,e)>-1}))),m.returnGeometry=i.hasOwnProperty("returnGeometry")?i.returnGeometry:!i.outStatistics,m.returnGeometry&&(m.multipatchOption=this.multipatchOption,null!=m.maxAllowableOffset||m.quantizationParameters)){var b=null!=m.maxAllowableOffset?m.maxAllowableOffset:m.quantizationParameters.tolerance;null!=b&&b!==this.getMaxAllowableOffset()&&(h=!0)}if(f){var v=f&&f.spatialReference,x=m.outSpatialReference;x?l=!x.equals(v):m.outSpatialReference=new S(v.toJson())}if(p){var M=m.geometry;M&&"extent"===M.type&&(m.geometry=this._getExtentOfTiles(M),M!==m.geometry&&this._enableCacheHint(m))}if(!this._applyQueryFilters(m,"execute"===e&&!m.outStatistics)){switch(e){case"execute":y=new L({features:[]});break;case"executeForIds":y=[];break;case"executeForCount":y=0;break;case"executeForExtent":y={}}return this._resolve([y],t,s,_),_}var C="executeForExtent"!==e&&!l&&!u&&!h&&this._canDoClientSideQuery(m,p);if(C)return _._pendingDfd=c(this._doQuery(m,C,"executeForIds"===e||"executeForCount"===e)),_._pendingDfd.then((function(i){switch(e){case"execute":(y=new L).features=i;break;case"executeForIds":y=i;break;case"executeForCount":y=i.length}d._resolve([y],t,s,_)})),_}if(this._collection){var O=new Error("FeatureLayer::_query - "+this.invalidParams);return this._resolve([O],null,n,_,!0),_}if(this.loaded&&!this.isQueryable()){var E=new Error("Layer does not support query capability.");return this._resolve([E],null,n,_,!0),_}this._ts&&(m._ts=(new Date).getTime());var I="execute"===e&&this._canFetchPBFForQuery(m);this._enableEditModeQuantization(m,I);var D=I?{format:"pbf"}:null;return(_._pendingDfd=this._task[e](m,null,null,D)).addCallbacks((function(i){!function(i,n){var r,a;if("execute"===e||"executeRelationshipQuery"===e)if("execute"===e){for(a=(r=i.features).length-1;a>=0;a--)if(r[a]._layer=d,!n&&!d._isTable){var o=d._mode,l=d.objectIdField,u=r[a].attributes[l],h=o._getFeature(u);h&&r.splice(a,1,h)}}else for(var c in i)if(i.hasOwnProperty(c))for(a=(r=i[c].features).length-1;a>=0;a--)r[a]._layer=d;d._resolve([i],t,s,_)}(i,!!m.outStatistics||l||u||h)}),(function(e){d._resolve([e],null,n,_,!0)})),_},_getExtentOfTiles:function(e){var t=this._isOnDemandMode()&&this._mode._gridLayer||te.createFromFeatureLayer({layer:this}),i=this.getMap(),s=i&&i.getTargetExtent(e);return t&&s&&t.getExtentOfIntersectingCells(s)||e},_convertFeaturesToJson:function(e,t,i,s){var o,l,u=[],h=this._selectionSymbol,d=this.visibilityField,c=this.objectIdField;for(this.loaded&&(i||s)&&(l=r.filter(this.fields,(function(e){return!1===e.editable&&(!s||e.name!==c)}))),o=0;o<e.length;o++){var f=e[o],p={},_=f.geometry,m=f.attributes,y=f.symbol;!_||s&&this.loaded&&!this.allowGeometryUpdates||(p.geometry=_.toJson()),d?(p.attributes=m=n.mixin({},m),m[d]=f.visible?1:0):m&&(p.attributes=n.mixin({},m)),p.attributes&&l&&l.length&&r.forEach(l,(function(e){delete p.attributes[e.name]})),y&&y!==h&&(p.symbol=y.toJson()),u.push(p)}return t?u:a.toJson(u)},_selectHandler:function(e,t,i,s,n){var r;switch(t){case ue.SELECTION_NEW:this.clearSelection(!0),r=!0;break;case ue.SELECTION_ADD:r=!0;break;case ue.SELECTION_SUBTRACT:r=!1}var a,o,l,u=e.features,h=this._mode,d=[],c=this.objectIdField;if(r)for(a=0;a<u.length;a++){l=(o=u[a]).attributes[c];var f=h._addFeatureIIf(l,o);d.push(f),this._selectFeatureIIf(l,f,h)}else for(a=0;a<u.length;a++){l=(o=u[a]).attributes[c],this._unSelectFeatureIIf(l,h);var p=h._removeFeatureIIf(l);d.push(p||o)}this._isSelOnly&&h._applyTimeFilter(!0),this._isImageService&&this.version<10.7&&void 0===e.exceededTransferLimit&&(e.exceededTransferLimit=u.length===this.maxRecordCount),this._hasPartialSelectedFeatures=!!e.exceededTransferLimit,this._resolve([d,t,e.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",i,n),e.exceededTransferLimit&&this.onQueryLimitExceeded()},_selectFeatureIIf:function(e,t,i){var s=this._selectedFeatures,n=s[e];return n||(i._incRefCount(e),s[e]=t,this._isTable||(this._setSelectSymbol(t),t.attr("data-selected",""))),n||t},_unSelectFeatureIIf:function(e,t){var i=this._selectedFeatures[e];return i&&(t._decRefCount(e),delete this._selectedFeatures[e],this._isTable||(this._setUnSelectSymbol(i),i.attr("data-selected"))),i},_setSelectSymbol:function(e){var t=this._selectionSymbol;t&&!this._isSelOnly&&e.setSymbol(t)},_setUnSelectSymbol:function(e){var t=this._selectionSymbol;t&&!this._isSelOnly&&t===e.symbol&&e.setSymbol(null,!0)},_getOutFields:function(){var e=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._requiredFields).concat(this.dataAttributes);e=r.filter(e,(function(e,t,i){return!!e&&r.indexOf(i,e)===t}));var t=n.clone(this._outFields);return t?-1!==r.indexOf(t,"*")?t:(r.forEach(e,(function(e){-1===r.indexOf(t,e)&&t.push(e)})),t):e},_checkFields:function(e){var t=e||this._getOutFields();(r.forEach(t,(function(e){"*"!==e&&(this._getField(e)||console.debug("esri.layers.FeatureLayer: "+y.substitute({url:this.url,field:e},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))}),this),e||this._isTable||this._fserver||this._collection||this._isStream)||(r.some(this.fields,(function(e){return!(!e||"esriFieldTypeGeometry"!==e.type)}))||console.debug("esri.layers.FeatureLayer: "+y.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixFieldCase:function(e,t,i){var s,r=e&&e[t];return r&&!n.isFunction(r)&&((s=!this._getField(r)&&this._getField(r,!0))&&(r=e[t]=s.name),i&&i.push(r)),r},_fixRendererFields:function(){var e=this.renderer;if(this._orderBy=null,this._requiredFields=[],e&&this.fields.length>0){var t,i=[],s=r.filter([e,e.observationRenderer,e.latestObservationRenderer,e.trackRenderer],y.isDefined),a=[].concat(s);r.forEach(s,(function(e){r.forEach(e.rendererInfos,(function(e){e.renderer&&a.push(e.renderer)}))})),r.forEach(a,(function(e){this._fixFieldCase(e,"attributeField",i),this._fixFieldCase(e,"attributeField2",i),this._fixFieldCase(e,"attributeField3",i),this._fixFieldCase(e.rotationInfo,"field",i),(t=this._fixFieldCase(e.sizeInfo,"field",i))&&(this._orderBy||(this._orderBy=[t+" DESC"])),this._fixFieldCase(e.sizeInfo,"normalizationField",i),this._fixFieldCase(e.colorInfo,"field",i),this._fixFieldCase(e.colorInfo,"normalizationField",i),this._fixFieldCase(e.field,"field",i),this._fixFieldCase(e.opacityInfo,"field",i),this._fixFieldCase(e.opacityInfo,"normalizationField",i),r.forEach(e.visualVariables,(function(e){t=this._fixFieldCase(e,"field",i),"sizeInfo"===e.type&&t&&!this._orderBy&&(this._orderBy=[t+" DESC"]),this._fixFieldCase(e,"normalizationField",i)}),this);var s=r.map(e.getFieldsUsedInExpressions(),(function(e){var t=this.getField(e);return t?t.name:e}),this);i=i.concat(s),this._orderBy||!e.addBreak||n.isFunction(e.attributeField)||!e.backgroundFillSymbol&&!this._hasSizeDiff(e)||(this._orderBy=[e.attributeField+" DESC"])}),this),this._requiredFields=r.filter(i,y.isDefined)}},_hasSizeDiff:function(e){var t,i,s=Number.MAX_VALUE,n=-Number.MAX_VALUE;return r.forEach(e.infos,(function(e){if(i=e.symbol){switch(t=0,i.type){case"simplemarkersymbol":t=i.size;break;case"picturemarkersymbol":t=(i.width+i.height)/2;break;case"simplelinesymbol":case"cartographiclinesymbol":t=i.width;break;case"simplefillsymbol":case"picturefillsymbol":t=i.outline&&i.outline.width}t&&(s=Math.min(s,t),n=Math.max(n,t))}})),s!==Number.MAX_VALUE&&n!==-Number.MAX_VALUE&&Math.abs(n-s)>1},getOrderByFields:function(){var e=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&e?r.filter(e,(function(e){return e=e.split(" ")[0],!!this._getField(e,!0)}),this):null},_createFields:function(e){var t,i=e?e.length:0,s=[];for(t=0;t<i;t++)s.push(new Q(e[t]));this.fields=s},_createFieldsIndex:function(){if(this._fieldsIndexDirty){var e,t=this.fields,i=t?t.length:0;if(i>50&&this._canUseFieldsIndex()){for(var s=new Map,n=new Map,r=0;r<i;r++){var a=t[r];s.set(a.name,a),n.set(a.name.toLowerCase(),a)}e={caseSensitive:s,caseInsensitive:n}}this._fieldsIndex=e,this._fieldsIndexDirty=!1}},_canUseFieldsIndex:function(){var e=f.Map;return!("function"!=typeof f.Proxy||"function"!=typeof f.Proxy.revocable||"function"!=typeof e||!e.prototype||"function"!=typeof e.prototype.set)},_getField:function(e,t){var i=this.fields;if(!i||0===i.length)return null;t&&(e=e.toLowerCase()),this._createFieldsIndex();var s,n=this._fieldsIndex;return n?(n=t?n.caseInsensitive:n.caseSensitive).get(e):(r.some(i,(function(i){var n=!1;return(n=t?!(!i||i.name.toLowerCase()!==e):!(!i||i.name!==e))&&(s=i),n})),s)},_getDateOpts:function(){if(!this._dtOpts){var e=r.map(r.filter(this.fields,(function(e){return!(!e||"esriFieldTypeDate"!==e.type)})),(function(e){return e.name}));this._dtOpts={properties:e}}return this._dtOpts},_applyNormalized:function(e,t){e&&t&&r.forEach(e,(function(e,i){e&&t[i]&&e.setGeometry(t[i])}))},_editHandler:function(e,t,i,s,a,o){var l,u,h,d,c,f=e.addResults,p=e.updateResults,_=e.deleteResults,m=this.objectIdField,y=this._mode,g=this._isTable,b=this.editFieldsInfo,F=this.getOutFields()||[],v=b&&b.creatorField,S=b&&b.creationDateField,x=b&&b.editorField,M=b&&b.editDateField,C=b&&b.realm;-1===r.indexOf(F,"*")&&(v&&-1===r.indexOf(F,v)&&(v=null),S&&-1===r.indexOf(F,S)&&(S=null),x&&-1===r.indexOf(F,x)&&(x=null),M&&-1===r.indexOf(F,M)&&(M=null));var O=S||M?(new Date).getTime():null,E=v||x?this.getUserId():void 0;if(E&&C&&(E=E+"@"+C),f){var I=this.globalIdField;for(l=0;l<f.length;l++)if(f[l]=new J(f[l]),!g&&(u=f[l]).success){h=u.objectId;var D=(d=t[l])._graphicsLayer;D&&D!==this&&D.remove(d),(c=d.attributes||{})[m]=h;var T=u.globalId;I&&T&&(c[I]=T),v&&(c[v]=E),x&&(c[x]=E),S&&(c[S]=O),M&&(c[M]=O),d.setAttributes(c),y._init&&y.drawFeature(d)}}if(p)for(l=0;l<p.length;l++)if(p[l]=new J(p[l]),!g&&(u=p[l]).success){d=i[h=u.objectId];var A=y._getFeature(h);A&&(A.geometry!==d.geometry&&d.geometry&&A.setGeometry(z.fromJson(d.geometry.toJson())),A.attributes!==d.attributes&&d.attributes&&A.setAttributes(n.mixin(A.attributes,d.attributes)),this._repaint(A,h)),c=(d=A||d).attributes||{},x&&(c[x]=E),M&&(c[M]=O),d.setAttributes(c)}if(_){var R=[];for(l=0;l<_.length;l++)_[l]=new J(_[l]),g||(u=_[l]).success&&(h=u.objectId,(d=y._getFeature(h))&&(this._unSelectFeatureIIf(h,y)&&R.push(d),d._count=0,y._removeFeatureIIf(h)));R.length>0&&this.onSelectionComplete(R,ue.SELECTION_SUBTRACT)}this._resolve([f,p,_],"onEditsComplete",s,o)},_sendAttachment:function(e,t,i,s,r){var a="add"===e?"addAttachment":"updateAttachment",o=this._url.path+"/"+t+"/"+a,l=this;return g({url:o,form:i,content:n.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback((function(i){var n="add"===e?"onAddAttachmentComplete":"onUpdateAttachmentComplete",r=new J(i["add"===e?"addAttachmentResult":"updateAttachmentResult"]);return r.attachmentId=r.objectId,r.objectId=t,l._resolve([r],n,s),r})).addErrback((function(e){l._resolve([e],null,r,null,!0)}))},_repaint:function(e,t,i){(t=y.isDefined(t)?t:e.attributes[this.objectIdField])in this._selectedFeatures&&this._selectionSymbol||e.setSymbol(e.symbol,i)},_getKind:function(e){var t=this._trackManager;return t&&t.isLatestObservation(e)?1:0}});return n.mixin(ue,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"}),j._createWrappers(ue),Object.defineProperty(ue.prototype,"graphics",{get:function(){return this._hasOnDemandDrillMode()?this._mode.graphics:this._graphicsVal},set:function(e){this._graphicsVal=e}}),Object.defineProperty(ue.prototype,"name",{get:function(){return this.arcgisProps&&this.arcgisProps.title?this.arcgisProps.title:this._name},set:function(e){this._name=e,this.loaded&&this.arcgisProps&&(this.arcgisProps.title=null)}}),Object.defineProperty(ue.prototype,"fields",{get:function(){return this._fields},set:function(e){e&&this._canUseFieldsIndex()&&(e=new Proxy(e,{set:n.hitch(this,(function(e,t,i){if(t)if("length"===t)this._fieldsIndexDirty=!0;else{var s=Number(t);"number"!=typeof s||isNaN(s)||(this._fieldsIndexDirty=!0)}return e[t]=i,!0}))})),this._fields=e,this._fieldsIndexDirty=!0}}),_("extend-esri")&&n.setObject("layers.FeatureLayer",ue,m),ue}));