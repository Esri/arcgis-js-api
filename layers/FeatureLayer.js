// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["require","module","dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/Deferred","dojo/date/locale","dojo/sniff","dojo/io-query","dojo/dom-construct","dojo/i18n","dojo/when","dojo/promise/all","../kernel","../lang","../request","../config","../deferredUtils","../SpatialReference","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/jsonUtils","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/jsonUtils","../tasks/QueryTask","../tasks/query","../tasks/FeatureSet","../tasks/StatisticDefinition","../geometry/Extent","../geometry/jsonUtils","../geometry/normalizeUtils","../geometry/scaleUtils","./GraphicsLayer","./Field","./TimeInfo","./FeatureType","./FeatureTemplate","./FeatureEditResult","./LabelClass","./SnapshotMode","./OnDemandMode","./SelectionMode","./StreamMode","./TrackManager","./HeatmapManager","dojo/i18n!../nls/jsapi","dojo/has!extend-esri?./agscommon"],function(e,t,i,s,r,n,a,o,l,h,u,d,c,f,m,_,p,y,g,b,F,v,x,S,O,I,C,E,T,w,M,A,D,k,P,R,L,j,q,z,U,N,G,H,B,Q,V,J,W,X){var Y=g.defaults,$=i(L,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4e3,maxRecordCountForAuto:2e3,maxVertexCountForAuto:25e4,generalizeForScale:4e3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(e,t){this._preventInit||this._initFeatureLayer(e,t)},_initFeatureLayer:function(e,t){this.i18n=X,t=t||{},this.showLabels=null!=t.showLabels?t.showLabels:!0,this._outFields=t.outFields,this._defnExpr=t.definitionExpression,this._loadCallback=t.loadCallback;var i=t._usePatch;this._usePatch=null===i||void 0===i?!0:i,this._trackIdField=t.trackIdField,this.objectIdField=t.objectIdField,this._maxOffset=null!=t.maxAllowableOffset?t.maxAllowableOffset:this.maxAllowableOffset,this.quantize=null!=t.quantize?t.quantize:!0,this._optEditable=t.editable,this._optAutoGen=t.autoGeneralize,this.editSummaryCallback=t.editSummaryCallback,this.userId=t.userId,this.userIsAdmin=t.userIsAdmin,this.useMapTime=t.hasOwnProperty("useMapTime")?!!t.useMapTime:!0,this.source=t.source,this.gdbVersion=t.gdbVersion,this.orderByFields=t.orderByFields,this.maxPointCountForAuto=null!=t.maxPointCountForAuto?t.maxPointCountForAuto:this.maxPointCountForAuto,this.maxRecordCountForAuto=null!=t.maxRecordCountForAuto?t.maxRecordCountForAuto:this.maxRecordCountForAuto,this.maxVertexCountForAuto=null!=t.maxVertexCountForAuto?t.maxVertexCountForAuto:this.maxVertexCountForAuto,this.generalizeForScale=null!=t.generalizeForScale?t.generalizeForScale:this.generalizeForScale,this.queryPagination=null!=t.queryPagination?t.queryPagination:this.url?this.reHostedFS.test(this.url):!1,this.multipatchOption=t.multipatchOption,this._selectedFeatures={},this._selectedFeaturesArr=[],this._newFeatures=[],this._deletedFeatures={},this._ulid=this._getUniqueId();var s=$,n=this.mode=p.isDefined(t.mode)?t.mode:s.MODE_ONDEMAND;switch(this._isStream&&(n=s.MODE_STREAM,this.mode=s.MODE_STREAM),n){case s.MODE_SNAPSHOT:this.currentMode=s.MODE_SNAPSHOT,this._mode=new H(this),this._isSnapshot=!0;break;case s.MODE_ONDEMAND:case s.MODE_AUTO:this.currentMode=s.MODE_ONDEMAND,this._tileWidth=t.tileWidth||512,this._tileHeight=t.tileHeight||512,this._mode=new B(this),this.latticeTiling=t.latticeTiling;break;case s.MODE_SELECTION:this.currentMode=s.MODE_SELECTION,this._mode=new Q(this),this._isSelOnly=!0;break;case s.MODE_STREAM:this.currentMode=s.MODE_STREAM,this._mode=new V(this),this._isStream=!0}if(this._initLayer=r.hitch(this,this._initLayer),this._selectHandler=r.hitch(this,this._selectHandler),this._editable=!1,r.isObject(e)&&e.layerDefinition){var o=e;return this._collection=!0,this.mode=this._isStream?s.MODE_STREAM:s.MODE_SNAPSHOT,this._initLayer(o),this}this._task=new T(this.url,{source:this.source,gdbVersion:this.gdbVersion});var l=this._url.path;this._fserver=!1,-1!==l.search(/\/FeatureServer\//i)&&(this._fserver=!0),this.mode===s.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();var h=t.resourceInfo;if(h)this._initLayer(h);else{if(this.source){var u={source:this.source.toJson()};this._url.query=r.mixin(this._url.query,{layer:a.toJson(u)})}this.gdbVersion&&(this._url.query=r.mixin(this._url.query,{gdbVersion:this.gdbVersion})),y({url:l,content:r.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler})}this.registerConnectEvents()},_initLayer:function(e,t){if(e||t){this._json=e,this._findCredential();var i=this.credential&&this.credential.ssl||e&&e._ssl;if(i&&(this._useSSL(),this._task._useSSL()),this.version=e.currentVersion,!this.version){var s;s="capabilities"in e||"drawingInfo"in e||"hasAttachments"in e||"htmlPopupType"in e||"relationships"in e||"timeInfo"in e||"typeIdField"in e||"types"in e?10:9.3,this.version=s}if(this._collection&&(this._isStream||(this.currentMode=$.MODE_SNAPSHOT,this._mode=new H(this)),this._isSnapshot=!0,this._featureSet=e.featureSet,this._nextId=e.nextObjectId,e=e.layerDefinition),this.geometryType=e.geometryType,"string"!=typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint"),e.hasOwnProperty("capabilities")){var o=this.capabilities=e.capabilities;this._editable=o&&-1!==o.toLowerCase().indexOf("editing")?!0:!1}else this._collection||(this._editable=this._fserver);p.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1),this._json=a.toJson(this._json),this.isEditable()?this._setMaxOffset(null):this.mode===$.MODE_SNAPSHOT||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryPolygon"!==this.geometryType&&!this.hasXYFootprint()||(this._autoGeneralize=p.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===$.MODE_ONDEMAND||this.mode===$.MODE_AUTO,delete this._optAutoGen);var l=e.effectiveMinScale||e.minScale,u=e.effectiveMaxScale||e.maxScale;!this._hasMin&&l&&this.setMinScale(l),!this._hasMax&&u&&this.setMaxScale(u),this.layerId=e.id,this.name=e.name,this.description=e.description,this.copyright=e.copyrightText,this.type=e.type,this.displayField=e.displayField,this.defaultDefinitionExpression=e.definitionExpression,this.fullExtent=new D(e.extent),this.initialExtent=new D(this.fullExtent.toJson()),this.fullExtent.spatialReference&&(this.spatialReference=new F(this.fullExtent.spatialReference.toJson())),this.defaultVisibility=e.defaultVisibility,("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)&&(this.latticeTiling=!1),this.hasM=e.hasM||!1,this.hasZ=e.hasZ||!1,this.indexedFields=e.indexedFields,this.maxRecordCount=e.maxRecordCount,this.canModifyLayer=e.canModifyLayer,this.supportsStatistics=e.supportsStatistics,this.supportsAdvancedQueries=this._collection?!1:e.supportsAdvancedQueries,this.supportsCalculate=e.supportsCalculate,this.supportsAttachmentsByUploadId=e.supportsAttachmentsByUploadId,this.supportsCoordinatesQuantization=e.supportsCoordinatesQuantization,this.quantize=this.quantize&&this.supportsCoordinatesQuantization,this.hasLabels=e.hasLabels,this.canScaleSymbols=e.canScaleSymbols,this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=e.supportsRollbackOnFailure,this.syncCanReturnChanges=e.syncCanReturnChanges,this.isDataVersioned=e.isDataVersioned,this.editFieldsInfo=e.editFieldsInfo,this.ownershipBasedAccessControlForFeatures=e.ownershipBasedAccessControlForFeatures,this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField),this.relationships=e.relationships,this.allowGeometryUpdates=p.isDefined(e.allowGeometryUpdates)?e.allowGeometryUpdates:!0,this.advancedQueryCapabilities=e.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries},this._setMaxOffset(this._maxOffset,!0),this._isTable="Table"===this.type;var d,c=this.fields=[],f=e.fields;for(d=0;d<f.length;d++)c.push(new j(f[d]));if(!this.objectIdField){if(this.objectIdField=e.objectIdField,!this.objectIdField)for(f=e.fields,d=0;d<f.length;d++){var m=f[d];if("esriFieldTypeOID"===m.type){this.objectIdField=m.name;break}}this.objectIdField||this._isStream||console.debug("esri.layers.FeatureLayer: "+p.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!p.isDefined(this._nextId)){var _=this.objectIdField,y=-1;if(this._collection&&_){var g,b,T=this._featureSet,w=T&&T.features,A=w?w.length:0;for(d=0;A>d;d++)b=w[d].attributes,g=b&&b[_],g>y&&(y=g)}this._nextId=y+1}this.globalIdField=e.globalIdField;var k,P=this.typeIdField=e.typeIdField;P&&(k=!this._getField(P)&&this._getField(P,!0),k&&(this.typeIdField=k.name)),this.visibilityField=e.visibilityField;var R=e.defaultSymbol;R&&(this.defaultSymbol=O.fromJson(R));var L,N,B,Q=this.types=[],V=e.types,J=this.editFieldsInfo,W=J&&J.creatorField,X=J&&J.editorField,Y=W||X,Z=[];if(V)for(d=0;d<V.length;d++)L=new z(V[d]),N=L.templates,Y&&N&&N.length&&(Z=Z.concat(N)),Q.push(L);var K,et=e.templates,tt=this.templates=[];if(et)for(d=0;d<et.length;d++)K=new U(et[d]),Y&&Z.push(K),tt.push(K);for(d=0;d<Z.length;d++)B=r.getObject("prototype.attributes",!1,Z[d]),B&&(W&&delete B[W],X&&delete B[X]);var it=e.timeInfo;it&&(this.timeInfo=new q(it),this._startTimeField=it.startTimeField,this._endTimeField=it.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?it.trackIdField=this._trackIdField:this._trackIdField=it.trackIdField),this.hasAttachments=!this._collection&&e.hasAttachments?!0:!1,this.htmlPopupType=e.htmlPopupType;var st,rt=e.drawingInfo,nt=rt&&rt.labelingInfo;if(nt&&!this.labelingInfo&&(this.labelingInfo=n.map(nt,function(e){return new G(e)}),this._fixLabelExpr()),!this.renderer)if(rt&&rt.renderer){if(st=rt.renderer,this.setRenderer(E.fromJson(st)),"classBreaks"===st.type&&this.renderer.setMaxInclusive(!0),!this._collection){var at=st.type,ot=[];switch(st=this.renderer,at){case"simple":ot.push(st.symbol);break;case"uniqueValue":case"classBreaks":ot.push(st.defaultSymbol),ot=ot.concat(n.map(st.infos,function(e){return e.symbol}))}ot=n.filter(ot,p.isDefined);var lt=this._url.path+"/images/",ht=this._getToken();n.forEach(ot,function(e){var t=e.url;t&&(-1===t.search(/https?\:/)&&-1===t.indexOf("data:")&&(e.url=lt+t),ht&&-1!==e.url.search(/https?\:/)&&(e.url+="?token="+ht))})}}else if(R)V=this.types,V.length>0?(st=new C(this.defaultSymbol,this.typeIdField),n.forEach(V,function(e){st.addValue(e.id,e.symbol)})):st=new I(this.defaultSymbol),this.setRenderer(st);else if(!this._isTable){var ut;switch(this.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":ut=new v;break;case"esriGeometryPolyline":ut=new x;break;case"esriGeometryPolygon":ut=new S;break;default:this.hasXYFootprint()&&(ut=new S)}this.setRenderer(ut?new I(ut):null)}var dt=rt&&rt.transparency||0;!this.hasOwnProperty("opacity")&&dt>0&&(this.opacity=1-dt/100),(h("ie")||h("trident")>=7||h("safari"))&&this.isEditable()&&this.version<10.02&&(this._ts=!0),this.statistics=e.statistics,this._fixRendererFields(),this._checkFields(),this._updateCaps();var ct=function(){this.currentMode!==$.MODE_SNAPSHOT&&(this.queryPagination=!1),null==this._maxOffset||this._isFractionalOffsetAllowed()||this._setMaxOffset(this._maxOffset),this.loaded=!0,this.onLoad(this);var e=this._loadCallback;e&&(delete this._loadCallback,e(this))};if(this._collection){var ft=this._featureSet;this._featureSet=null,this._mode._drawFeatures(new M(ft)),this._fcAdded=!0,ct.call(this)}else this._forceIdentity(this._limitPromise?function(){var e=this;this._limitPromise.then(function(t){e._checkMode(t)}),this._limitPromise.always(function(){e._limitPromise=null,ct.call(e)})}:ct)}},setShowLabels:function(e){this.showLabels=e,this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(e){this.inherited(arguments);var t=this._map;if(this._ager=!!(e&&e.observationAger&&e.observationRenderer),e&&"colors"in e&&"blurRadius"in e&&"maxPixelIntensity"in e)"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&t&&(this._heatmapManager=new W(this),this._heatmapManager.initialize(t));else if(this.renderer&&this.renderer.getRendererInfo){var i=this.renderer.rendererInfos,s=n.some(i,function(e){return e.renderer&&"colors"in e.renderer&&"blurRadius"in e.renderer});s||(this._heatmapManager=null)}else this._heatmapManager=null;if(e){var r=[],a=n.filter([e,e.observationRenderer,e.latestObservationRenderer,e.trackRenderer],p.isDefined),o=function(e){return null!=e&&"function"!=typeof e&&e},l=function(e){var t=o(e.attributeField),i=o(e.attributeField2),s=o(e.attributeField3);t!==!1&&r.push(t),i!==!1&&r.push(i),s!==!1&&r.push(s)};n.forEach(a,l),this._rendererFields=r}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments),this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var e=this._getRenderer();this._ager=!!(e&&e.observationAger&&e.observationRenderer),this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(e&&e.trackRenderer)},_setMap:function(e){var t=this.inherited(arguments),i=this._mode,s=this;return i&&i.initialize(e),this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase()),this._addHandle=this.on("graphic-node-add",function(e){var t=e.graphic.attributes,i=t&&t[s.objectIdField],r=s._selectedFeatures[i];r&&r.attr("data-selected","")}),t},_unsetMap:function(){var e=this._mode;e&&e.suspend(),this._trackManager&&(this._trackManager.destroy(),this._trackManager=null),s.disconnect(this._zoomConnect),s.disconnect(this._addHandle),this._zoomConnect=this._addHandle=null,this._toggleTime(!1),this.inherited("_unsetMap",arguments)},refresh:function(){this._needsRefresh=!1;var e=this._mode;e&&e.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return n.filter(this._getOutFields(),function(e){return"*"===e||!!this._getField(e)},this)},getField:function(e){return this._getField(e,!0)},getDomain:function(e,t){var i,s,r=t&&t.feature,a=r&&this.typeIdField&&r.attributes&&r.attributes[this.typeIdField];return null!=a&&n.some(this.types,function(t){return t.id==a?(i=t.domains&&t.domains[e],i&&"inherited"===i.type&&(i=this._getLayerDomain(e),s=!0),!0):!1},this),s||i||(i=this._getLayerDomain(e)),i},_getLayerDomain:function(e){var t;return n.some(this.fields,function(i){return i.name===e&&(t=i.domain),!!t}),t},getType:function(e){var t,i=e&&this.typeIdField&&e.attributes&&e.attributes[this.typeIdField];return n.some(this.types,function(e){return e.id==i&&(t=e),!!t}),t},setEditable:function(e){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=e,this;var t=this._editable;return this._editable=e,this._updateCaps(),t!==e&&this.onCapabilitiesChange(),this},getEditCapabilities:function(e){var t={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return t;var i,s=e&&e.feature,a=e&&e.userId,o=n.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],r.trim),l=n.indexOf(o,"editing")>-1,h=l&&n.indexOf(o,"create")>-1,u=l&&n.indexOf(o,"update")>-1,d=l&&n.indexOf(o,"delete")>-1,c=this.ownershipBasedAccessControlForFeatures,f=this.editFieldsInfo,m=f&&f.creatorField,_=f&&f.realm,p=s&&s.attributes,y=p&&m?p[m]:void 0,g=!!this.userIsAdmin,b=!c||g||!(!c.allowOthersToUpdate&&!c.allowUpdateToOthers),F=!c||g||!(!c.allowOthersToDelete&&!c.allowDeleteToOthers);if((g||l&&!(h||u||d))&&(h=u=d=!0),i={canCreate:h,canUpdate:u,canDelete:d},null===y)i.canUpdate=u&&b,i.canDelete=d&&F;else{if(""===y)return i;if(y){if(a=a||this.getUserId(),a&&_&&(a=a+"@"+_),a.toLowerCase()===y.toLowerCase())return i;i.canUpdate=u&&b,i.canDelete=d&&F}}return i},getUserId:function(){var e;return this.loaded&&(e=this.credential&&this.credential.userId||this.userId||""),e},setUserIsAdmin:function(e){this.userIsAdmin=e},setEditSummaryCallback:function(e){this.editSummaryCallback=e},getEditSummary:function(e,t,i){i=p.isDefined(i)?i:(new Date).getTime();var s="",n=this.getEditInfo(e,t,i),a=t&&t.callback||this.editSummaryCallback;if(a&&(n=a(e,n)||""),r.isString(n))s=n;else{if(n){var o=n.action,l=n.userId,h=n.timeValue,u=0;o&&u++,l&&u++,p.isDefined(h)&&u++,u>1&&(s=("edit"===o?"edit":"create")+(l?"User":"")+(p.isDefined(h)?n.displayPattern:""))}s=s&&p.substitute(n,this.i18n.layers.FeatureLayer[s])}return s},getEditInfo:function(e,t,i){if(this.loaded){i=p.isDefined(i)?i:(new Date).getTime();var s,r=t&&t.action||"last",n=this.editFieldsInfo,a=n&&n.creatorField,o=n&&n.creationDateField,l=n&&n.editorField,h=n&&n.editDateField,u=(n&&n.realm,e&&e.attributes),d=u&&a?u[a]:void 0,c=u&&o?u[o]:null,f=u&&l?u[l]:void 0,m=u&&h?u[h]:null,_=this._getEditData(d,c,i),y=this._getEditData(f,m,i);switch(r){case"creation":s=_;break;case"edit":s=y;break;case"last":s=y||_}return s&&(s.action=s===y?"edit":"creation"),s}},_getEditData:function(e,t,i){var s,r,n,a=6e4,o=36e5,h=2*o,u=24*o,d=7*u;if(p.isDefined(t)&&(r=i-t,n=0>r?"Full":a>r?"Seconds":2*a>r?"Minute":o>r?"Minutes":h>r?"Hour":u>r?"Hours":d>r?"WeekDay":"Full"),(void 0!==e||n)&&(s=s||{},s.userId=e,n)){var c=l.format,f=new Date(t);s.minutes=Math.floor(r/a),s.hours=Math.floor(r/o),s.weekDay=c(f,{datePattern:"EEEE",selector:"date"}),s.formattedDate=c(f,{selector:"date"}),s.formattedTime=c(f,{selector:"time"}),s.displayPattern=n,s.timeValue=t}return s},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(e){return this.isEditable()||this._setMaxOffset(e,!0),this},getMaxAllowableOffset:function(){var e=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:e},_setMaxOffset:function(e,t){return null==e?(delete this._maxOffset,delete this._quantizationParameters,this):(this.quantize&&this.supportsCoordinatesQuantization?("esriGeometryPolyline"===this.geometryType?this._maxOffset=e:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:e,extent:this.fullExtent}):(this._isFractionalOffsetAllowed()&&t||(e=Math.floor(e)),isNaN(e)||0===e?delete this._maxOffset:this._maxOffset=e,delete this._quantizationParameters),this)},_isFractionalOffsetAllowed:function(){return null==this.version||this.version>=10.1||navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(e){return e=e&&e.split("-"),e=e&&e[0]&&e[0].toLowerCase(),-1!==n.indexOf(this._langsWithDot,e)},_langsWithDot:["ar","en","et","fr","he","ja","ko","th","vi","zh"],setAutoGeneralize:function(e){return this.loaded?this.isEditable()||this.mode===$.MODE_SNAPSHOT||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryPolygon"!==this.geometryType&&!this.hasXYFootprint()||(this._autoGeneralize=e,e?(this._autoSnapshot&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)):this._optAutoGen=e,this},setGDBVersion:function(e){return this._collection||e===this.gdbVersion||!e&&!this.gdbVersion||(this.gdbVersion=e,this._task.gdbVersion=e,this._url.query=r.mixin(this._url.query,{gdbVersion:e}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange()),this},setDefinitionExpression:function(e){this._defnExpr=e;var t=this._mode;return t&&t.propertyChangeHandler(1),this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(e){if(this._isSnapshot){this._timeDefn=e;var t=this._mode;t&&t.propertyChangeHandler(2)}else console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id = "+this.id+", Layer URL = "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(e,t){this._timeOffset=e,this._timeOffsetUnits=t;var i=this._mode;return i&&i.propertyChangeHandler(0),this},setUseMapTime:function(e){this.useMapTime=e,this._toggleTime(!this.suspended);var t=this._mode;t&&t.propertyChangeHandler(0)},selectFeatures:function(e,t,i,s){t=t||$.SELECTION_NEW;var r,n=this._getShallowClone(e),a=this._map,l=this,h=b._fixDfd(new o(b._dfdCanceller));if(n.outFields=this.getOutFields(),n.returnGeometry=!0,n.multipatchOption=this.multipatchOption,a&&(n.outSpatialReference=new F(a.spatialReference.toJson())),!this._applyQueryFilters(n,!0))return r={features:[]},this._selectHandler(r,t,i,s,h),h;var u=this._canDoClientSideQuery(n);if(u)return h._pendingDfd=f(this._doQuery(n,u)),h._pendingDfd.then(function(e){r={features:e},l._selectHandler(r,t,i,s,h)}),h;if(this._collection){var d=new Error("FeatureLayer::selectFeatures - "+this.invalidParams);return this._resolve([d],null,s,h,!0),h}var c=this;this._ts&&(n._ts=(new Date).getTime());var m=h._pendingDfd=this._task.execute(n);return m.addCallbacks(function(e){c._selectHandler(e,t,i,s,h)},function(e){c._resolve([e],null,s,h,!0)}),h},getSelectedFeatures:function(){var e,t=this._selectedFeatures,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},clearSelection:function(e){var t,i=this._selectedFeatures,s=this._mode;for(t in i)i.hasOwnProperty(t)&&(this._unSelectFeatureIIf(t,s),s._removeFeatureIIf(t));return this._selectedFeatures={},this._isSelOnly&&s._applyTimeFilter(!0),e||this.onSelectionClear(),this},setSelectionSymbol:function(e){if(this._selectionSymbol=e,e){var t,i=this._selectedFeatures;for(t in i)i.hasOwnProperty(t)&&i[t].setSymbol(e)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(e){e?(this.labelingInfo=e,this._fixLabelExpr()):delete this.labelingInfo,this._collection&&(this._typesDirty=!0),this.onLabelingInfoChange()},_fixLabelExpr:function(){var e,t=/\[([^\[\]]+)\]/gi,i=this,s=function(e,t){var s=i._getField(t,!0);return"["+(s&&s.name||t)+"]"};n.forEach(this.labelingInfo,function(i){e=i.labelExpression,e&&(i.labelExpression=e.replace(t,s))})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(e,t,i,s,a,o){var l=o.assembly,h=o.dfd;this._applyNormalized(e,l&&l[0]),this._applyNormalized(t,l&&l[1]),this.onBeforeApplyEdits(e,t,i);var u,d={},c=this.objectIdField,f={f:"json"},m=!1;if(this._collection){var _={};return _.addResults=e?n.map(e,function(){return m=!0,{objectId:this._nextId++,success:!0}},this):null,_.updateResults=t?n.map(t,function(e){m=!0;var t=e.attributes[c];return d[t]=e,{objectId:t,success:!0}},this):null,_.deleteResults=i?n.map(i,function(e){return m=!0,{objectId:e.attributes[c],success:!0}},this):null,void(m?this._editHandler(_,e,d,s,a,h):this._resolve([_.addResults,_.updateResults,_.deleteResults],null,s,h))}if(e&&e.length>0&&(f.adds=this._convertFeaturesToJson(e,0,1),m=!0),t&&t.length>0){for(u=0;u<t.length;u++){var p=t[u];d[p.attributes[c]]=p}f.updates=this._convertFeaturesToJson(t,0,0,1),m=!0}if(i&&i.length>0){var g=[];for(u=0;u<i.length;u++)g.push(i[u].attributes[c]);f.deletes=g.join(","),m=!0}if(m){var b=this;return y({url:this._url.path+"/applyEdits",content:r.mixin(f,this._url.query),callbackParamName:"callback",load:function(t){b._editHandler(t,e,d,s,a,h)},error:function(e){b._resolve([e],null,a,h,!0)}},{usePost:!0})}this._resolve([],null,s,h)},queryFeatures:function(e,t,i){return this._query("execute","onQueryFeaturesComplete",e,t,i)},queryRelatedFeatures:function(e,t,i){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",e,t,i)},queryIds:function(e,t,i){return this._query("executeForIds","onQueryIdsComplete",e,t,i)},queryCount:function(e,t,i){return this._query("executeForCount","onQueryCountComplete",e,t,i)},queryExtent:function(e,t,i){return this._query("executeForExtent","onQueryExtentComplete",e,t,i)},queryAttachmentInfos:function(e,t,i){var s=this._url.path+"/"+e+"/attachments",a=new o(b._dfdCanceller),l=this;return a._pendingDfd=y({url:s,content:r.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(i){var r,o=i.attachmentInfos;n.forEach(o,function(t){r=u.objectToQuery({gdbVersion:l._url.query&&l._url.query.gdbVersion,layer:l._url.query&&l._url.query.layer,token:l._getToken()}),t.url=s+"/"+t.id+(r?"?"+r:""),t.objectId=e}),l._resolve([o],"onQueryAttachmentInfosComplete",t,a)},error:function(e){l._resolve([e],null,i,a,!0)}}),a},addAttachment:function(e,t,i,s){return this._sendAttachment("add",e,t,i,s)},updateAttachment:function(e,t,i,s,r){return i.appendChild(d.create("input",{type:"hidden",name:"attachmentId",value:t})),this._sendAttachment("update",e,i,s,r)},deleteAttachments:function(e,t,i,s){var a=this._url.path+"/"+e+"/deleteAttachments",l=new o(b._dfdCanceller),h=this,u={f:"json",attachmentIds:t.join(",")};return l._pendingDfd=y({url:a,content:r.mixin(u,this._url.query),callbackParamName:"callback",load:r.hitch(this,function(t){var s=t.deleteAttachmentResults;s=n.map(s,function(t){var i=new N(t);return i.attachmentId=i.objectId,i.objectId=e,i}),h._resolve([s],"onDeleteAttachmentsComplete",i,l)}),error:function(e){h._resolve([e],null,s,l,!0)}},{usePost:!0}),l},addType:function(e){var t=this.types;if(t){var i=n.some(t,function(t){return t.id==e.id?!0:!1});if(i)return!1;t.push(e)}else this.types=[e];return this._typesDirty=!0,!0},deleteType:function(e){if(this._collection){var t=this.types;if(t){var i=-1;if(n.some(t,function(t,s){return t.id==e?(i=s,!0):!1}),i>-1)return this._typesDirty=!0,t.splice(i,1)[0]}}},toJson:function(){var e=this._json,t=r.isString(e)?a.fromJson(e):r.clone(e);if(t){t=t.layerDefinition?t:{layerDefinition:t};var i=t.layerDefinition,s=this._collection;if(s&&this._typesDirty){i.types=n.map(this.types||[],function(e){return e.toJson()});var o=this.renderer,l=this.labelingInfo,h=i.drawingInfo;!o&&!l||h||(h=i.drawingInfo={}),h&&o&&-1===o.declaredClass.indexOf("TemporalRenderer")&&(h.renderer=o.toJson()),l&&(h.labelingInfo=n.map(l,function(e){return e.toJson()}))}var u=null;if((!s||this._fcAdded)&&(u={geometryType:i.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)}),t.featureSet=r.mixin({},t.featureSet||{},u),t.featureSet.transform){var d=t.featureSet.transform;delete t.featureSet.transform,u=new M(t.featureSet),u.quantize(d),t.featureSet=u.toJson()}return s&&(t.nextObjectId=this._nextId,i.capabilities=this.capabilities),t}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(e){function t(e){var t=["allowOthersToUpdate","allowOthersToDelete","allowOthersToQuery"];return e&&n.some(t,function(t){return e.hasOwnProperty(t)&&!e[t]})}var i,s=this,r=this._url&&this._url.path,a=r&&r.toLowerCase().indexOf("/rest/services");(this.userIsAdmin||t(this.ownershipBasedAccessControlForFeatures))&&!this._getToken()&&a>-1&&_.id?(i=r.substring(0,a)+"/rest/info",y({url:i,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(e){return e.owningSystemUrl?_.id.checkSignInStatus(e.owningSystemUrl+"/sharing"):void 0}).then(function(e){return e?_.id.getCredential(r):void 0}).then(function(e){e&&s._findCredential()}).always(function(){e.call(s)})):e.call(this)},_checkMode:function(e){var t=this.geometryType,i=this.maxRecordCount,s=e&&e.features&&e.features[0],r=s&&s.attributes&&s.attributes.exceedslimit;this.mode===$.MODE_AUTO&&!this.isEditable()&&0===r&&(this.queryPagination||("esriGeometryPolyline"===t||"esriGeometryPolygon"===t||"esriGeometryMultipoint"===t||this.hasXYFootprint())&&i>=this.maxRecordCountForAuto||"esriGeometryPoint"===t&&i>=this.maxPointCountForAuto)&&(this.currentMode=$.MODE_SNAPSHOT,this._mode=new H(this),this._isSnapshot=this._autoSnapshot=!0)},_queryLimit:function(){var e=this,t=new o;this._limitPromise=t.promise,setTimeout(function(){var i=new w,s=new A;s.statisticType="exceedslimit",s.maxPointCount=e.maxPointCountForAuto,s.maxRecordCount=e.maxRecordCountForAuto,s.maxVertexCount=e.maxVertexCountForAuto,s.outStatisticFieldName="exceedslimit",i.outStatistics=[s],e.queryFeatures(i).promise.then(function(e){t.resolve(e)},function(e){t.reject(e)})},0)},_updateCaps:function(){var e,t,i,s=this._editable,a=r.trim(this.capabilities||""),o=n.map(a?a.split(","):[],r.trim),l=n.map(a?a.toLowerCase().split(","):[],r.trim),h=n.indexOf(l,"editing"),u={Create:n.indexOf(l,"create"),Update:n.indexOf(l,"update"),Delete:n.indexOf(l,"delete")};if(s&&-1===h)o.push("Editing");else if(!s&&h>-1){i=[h];for(e in u)u[e]>-1&&i.push(u[e]);for(i.sort(),t=i.length-1;t>=0;t--)o.splice(i[t],1)}this.capabilities=o.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments),this._toggleTime(!1);var e=this._mode;e&&e.suspend()},onResume:function(e){this.inherited(arguments),this._toggleTime(!0);var t=this._mode,i=this._map,r=this._getRenderer();if(e.firstOccurrence){if(this._fixRendererFields(),this._checkFields(),this.clearSelection(),this.timeInfo&&!this._trackManager&&(this._trackIdField||r&&(r.latestObservationRenderer||r.trackRenderer))&&(this._trackManager=new J(this),this._trackManager.initialize(i)),r&&"colors"in r&&"blurRadius"in r&&"maxPixelIntensity"in r&&("esriGeometryPoint"!=this.geometryType||this._heatmapManager||(this._heatmapManager=new W(this),this._heatmapManager.initialize(i))),this._autoSnapshot&&this._autoGeneralize&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.isEditable()&&null==this.getMaxAllowableOffset()){var n=this.generalizeForScale;n=this.maxScale?this.maxScale:this.minScale?Math.min(n,this.minScale):Math.min(n,R.getScale(i,this.initialExtent)),this._calculatedScale=n,this._calcMaxOffset=i.extent.getWidth()/i.width/i.getScale()*n}this._zoomConnect=s.connect(i,"onZoomEnd",this,this._zoomEndHandler),this._updateMaxOffset(),this._needsRefresh=!1,t&&t.startup()}else this._zoomEndHandler(),t&&t.resume()},_zoomEndHandler:function(){var e=this._map;this._updateMaxOffset(),this._prevScale=e.getScale(),!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var e=this._map;if(e&&e.loaded&&this._autoGeneralize)if(this._autoSnapshot){var t=this.getMaxAllowableOffset();this._setMaxOffset(this._getMaxOffsetForScale(),!0),this._needsRefresh||(this._needsRefresh=t!=this.getMaxAllowableOffset())}else this._setMaxOffset(e.extent.getWidth()/e.width,!e.extent.spatialReference.isWebMercator())},_getMaxOffsetForScale:function(){if(this._map){var e,t=this._map.getScale(),i=this._calculatedScale,s=this._calcMaxOffset,r=this._prevScale;return e=t>=i&&(null==r||i>r)?s:i>t&&(null==r||r>=i)?null:this.getMaxAllowableOffset()}},_toggleTime:function(e){var t=this._map;
e&&this.timeInfo&&this.useMapTime&&t?(this._mapTimeExtent=t.timeExtent,this._timeConnect||(this._timeConnect=s.connect(t,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,s.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(e){this._mapTimeExtent=e;var t=this._mode;t&&t.propertyChangeHandler(0)},_getOffsettedTE:function(e){var t=this._timeOffset,i=this._timeOffsetUnits;return e&&t&&i?e.offset(-1*t,i):e},_getTimeOverlap:function(e,t){return e&&t?e.intersection(t):e||t},_getTimeFilter:function(e){var t,i=this.getTimeDefinition(),s=null;if((i||s)&&(t=this._getTimeOverlap(i,s),!t))return[!1];if(e){if(e=t?this._getTimeOverlap(e,t):e,!e)return[!1]}else e=t;return[!0,e]},_getAttributeFilter:function(e){var t=this.getDefinitionExpression();return e=e?t?"("+t+") AND ("+e+")":e:t},_applyQueryFilters:function(e,t){if(e.where=this._getAttributeFilter(e.where),e.maxAllowableOffset||(e.maxAllowableOffset=this._maxOffset),e.quantizationParameters=this._quantizationParameters,t&&this.supportsAdvancedQueries&&(e.orderByFields=e.orderByFields||this.getOrderByFields()),this.timeInfo){var i=this._getTimeFilter(e.timeExtent);if(!i[0])return!1;e.timeExtent=i[1]}return!0},_add:function(e){var t=this._selectionSymbol,i=e.attributes,s=this.visibilityField;return t&&this._isSelOnly&&e.setSymbol(t),s&&i&&i.hasOwnProperty(s)&&e[i[s]?"show":"hide"](),this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(e){var t=[],i=this._map;if(!this._isTable&&(i||this._collection)&&!(e.text||e.where&&e.where!==this.getDefinitionExpression()||e.orderByFields&&e.orderByFields.length||e.outStatistics||e.returnDistinctValues)){var s=this._isSnapshot,r=this._isSelOnly,a=e.geometry;if(a){if(r||e.spatialRelationship!==w.SPATIAL_REL_INTERSECTS||"extent"!==a.type||!s&&!i.extent.contains(a))return;t.push(1)}var o=e.objectIds;if(o)if(s)t.push(2);else{var l,h=o.length,u=this._mode,d=0;for(l=0;h>l;l++)u._getFeature(o[l])&&d++;if(d!==h)return;t.push(2)}if(this.timeInfo){var c=e.timeExtent,f=this._mapTimeExtent;if(s)c&&t.push(3);else if(r){if(c)return}else if(f)if(-1!==n.indexOf(t,2))c&&t.push(3);else{if(-1===n.indexOf(t,1))return;c==f&&t.push(3)}else if(t.length>0)c&&t.push(3);else if(c)return}return t.length>0?t:null}},_getAbsMid:function(i){return e.toAbsMid?e.toAbsMid(i):t.id.replace(/\/[^\/]*$/gi,"/")+i},_doQuery:function(e,t,i){var s=[],a=this.objectIdField,l=this,h=new o,u=new o,d=this.graphics;if(-1!==n.indexOf(t,1)){var c,f=this.spatialIndex||this._map&&this._map.spatialIndex,m=e.geometry._normalize(null,!0);if(null==f&&Y.autoSpatialIndexing){var _=this._map||this;c=_.addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(r.hitch(this,r.partial(this._getFromIndex,m,f)),function(){u.resolve(r.hitch(this,r.partial(this._filterByExtent,d,m)))})}else f&&(c=this._getFromIndex(m,f));c?c.then(function(e){for(var t=0;t<e.length;t++)e[t].results&&(s=s.concat(e[t].results));u.resolve(s)}).otherwise(function(e){u.reject(e)}):u.resolve(this._filterByExtent(d,m))}else u.resolve(d);return u.then(function(r){if(s=r,-1!==n.indexOf(t,2)){var o=e.objectIds;s=n.filter(s,function(e){return n.indexOf(o,e.attributes[a])>-1})}if(-1!==n.indexOf(t,3)&&l.timeInfo){var u=e.timeExtent,d=l._filterByTime(s,u.startTime,u.endTime);s=d.match}i&&(s=n.map(s,function(e){return e.attributes[a]},this)),h.resolve(s)}),h},_getFromIndex:function(e,t){t=t||this.spatialIndex||this._map.spatialIndex,e instanceof Array||(e=[e]);var i=this.id,s=m(n.map(e,function(e){return t.intersects(e,i)}));return s},_filterByExtent:function(e,t){for(var i=[],s=0,r=e.length;r>s;s++){var n=e[s],a=n.geometry;a&&(this.normalization&&t.length?(t[0].intersects(a)||t[1].intersects(a))&&i.push(n):t.intersects(a)&&i.push(n))}return i},_filterByTime:function(e,t,i){var s,r=this._startTimeField,n=this._endTimeField;this._twoTimeFields||(s=r||n);var a,o,l,h=p.isDefined,u=[],d=[],c=e.length;if(t=t?t.getTime():-1/0,i=i?i.getTime():1/0,s)for(a=0;c>a;a++){o=e[a],l=o.attributes;var f=l[s];f>=t&&i>=f?u.push(o):d.push(o)}else for(a=0;c>a;a++){o=e[a],l=o.attributes;var m=l[r],_=l[n];m=h(m)?m:-1/0,_=h(_)?_:1/0,m>=t&&i>=m||_>=t&&i>=_||t>=m&&_>=i?u.push(o):d.push(o)}return{match:u,noMatch:d}},_resolve:function(e,t,i,s,r){t&&this[t].apply(this,e),i&&i.apply(null,e),s&&b._resDfd(s,e,r)},_getShallowClone:function(e){var t,i=new w;for(t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i},_query:function(e,t,i,s,r){var n,a=this,l=this._map,h=new o(b._dfdCanceller),u=i,d=function(i,r){if("execute"===e||"executeRelationshipQuery"===e){var n,o,l;if("execute"===e){for(n=i.features,o=n.length,l=o-1;l>=0;l--)if(n[l]._layer=a,!r&&!a._isTable){var u=a._mode,d=a.objectIdField,c=n[l].attributes[d],f=u._getFeature(c);f&&n.splice(l,1,f)}}else for(var m in i)if(i.hasOwnProperty(m))for(n=i[m].features,o=n.length,l=o-1;l>=0;l--)n[l]._layer=a}a._resolve([i],t,s,h)};if("executeRelationshipQuery"!==e){u=this._getShallowClone(i),u.outFields||(u.outFields=this.getOutFields()),u.returnGeometry=i.hasOwnProperty("returnGeometry")?i.returnGeometry:!i.outStatistics,u.returnGeometry&&(u.multipatchOption=this.multipatchOption);var c;if(l){var m=l&&l.spatialReference,_=u.outSpatialReference;_?n=!_.equals(m):u.outSpatialReference=new F(m.toJson())}if(!this._applyQueryFilters(u,"execute"===e&&!u.outStatistics)){switch(e){case"execute":c=new M({features:[]});break;case"executeForIds":c=[];break;case"executeForCount":c=0;break;case"executeForExtent":c={}}return this._resolve([c],t,s,h),h}var p="executeForExtent"!==e&&!n&&this._canDoClientSideQuery(u);if(p)return h._pendingDfd=f(this._doQuery(u,p,"executeForIds"===e||"executeForCount"===e)),h._pendingDfd.then(function(i){switch(e){case"execute":c=new M,c.features=i;break;case"executeForIds":c=i;break;case"executeForCount":c=i.length}a._resolve([c],t,s,h)}),h}if(this._collection){var y=new Error("FeatureLayer::_query - "+this.invalidParams);return this._resolve([y],null,r,h,!0),h}this._ts&&(u._ts=(new Date).getTime());var g=h._pendingDfd=this._task[e](u);return g.addCallbacks(function(e){d(e,!!u.outStatistics||n)},function(e){a._resolve([e],null,r,h,!0)}),h},_convertFeaturesToJson:function(e,t,i,s){var o,l,h=[],u=this._selectionSymbol,d=this.visibilityField,c=this.objectIdField;for(this.loaded&&(i||s)&&(l=n.filter(this.fields,function(e){return e.editable===!1&&(!s||e.name!==c)})),o=0;o<e.length;o++){var f=e[o],m={},_=f.geometry,p=f.attributes,y=f.symbol;!_||s&&this.loaded&&!this.allowGeometryUpdates||(m.geometry=_.toJson()),d?(m.attributes=p=r.mixin({},p),p[d]=f.visible?1:0):p&&(m.attributes=r.mixin({},p)),m.attributes&&l&&l.length&&n.forEach(l,function(e){delete m.attributes[e.name]}),y&&y!==u&&(m.symbol=y.toJson()),h.push(m)}return t?h:a.toJson(h)},_selectHandler:function(e,t,i,s,r){var n,a=$;switch(t){case a.SELECTION_NEW:this.clearSelection(!0),n=!0;break;case a.SELECTION_ADD:n=!0;break;case a.SELECTION_SUBTRACT:n=!1}var o,l,h,u=e.features,d=this._mode,c=[],f=this.objectIdField;if(n)for(o=0;o<u.length;o++){l=u[o],h=l.attributes[f];var m=d._addFeatureIIf(h,l);c.push(m),this._selectFeatureIIf(h,m,d)}else for(o=0;o<u.length;o++){l=u[o],h=l.attributes[f],this._unSelectFeatureIIf(h,d);var _=d._removeFeatureIIf(h);c.push(_||l)}this._isSelOnly&&d._applyTimeFilter(!0),this._resolve([c,t,e.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",i,r),e.exceededTransferLimit&&this.onQueryLimitExceeded()},_selectFeatureIIf:function(e,t,i){var s=this._selectedFeatures,r=s[e];return r||(i._incRefCount(e),s[e]=t,this._isTable||(this._setSelectSymbol(t),t.attr("data-selected",""))),r||t},_unSelectFeatureIIf:function(e,t){var i=this._selectedFeatures[e];return i&&(t._decRefCount(e),delete this._selectedFeatures[e],this._isTable||(this._setUnSelectSymbol(i),i.attr("data-selected"))),i},_isSelected:function(){},_setSelectSymbol:function(e){var t=this._selectionSymbol;t&&!this._isSelOnly&&e.setSymbol(t)},_setUnSelectSymbol:function(e){var t=this._selectionSymbol;t&&!this._isSelOnly&&t===e.symbol&&e.setSymbol(null,!0)},_getOutFields:function(){var e=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes);e=n.filter(e,function(e,t,i){return!!e&&n.indexOf(i,e)===t});var t=r.clone(this._outFields);return t?-1!==n.indexOf(t,"*")?t:(n.forEach(e,function(e){-1===n.indexOf(t,e)&&t.push(e)}),t):e},_checkFields:function(e){var t=e||this._getOutFields();if(n.forEach(t,function(e){"*"!==e&&(this._getField(e)||console.debug("esri.layers.FeatureLayer: "+p.substitute({url:this.url,field:e},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this),!(e||this._isTable||this._fserver||this._collection||this._isStream)){var i=n.some(this.fields,function(e){return e&&"esriFieldTypeGeometry"===e.type?!0:!1});i||console.debug("esri.layers.FeatureLayer: "+p.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]"))}},_fixFieldCase:function(e,t,i){var s,n=e&&e[t];return n&&!r.isFunction(n)&&(s=!this._getField(n)&&this._getField(n,!0),s&&(n=e[t]=s.name),i&&i.push(n)),n},_fixRendererFields:function(){var e=this.renderer;if(this._orderBy=null,e&&this.fields.length>0){var t,i=[],s=n.filter([e,e.observationRenderer,e.latestObservationRenderer,e.trackRenderer],p.isDefined),a=[].concat(s);n.forEach(s,function(e){n.forEach(e.rendererInfos,function(e){e.renderer&&a.push(e.renderer)})}),n.forEach(a,function(e){this._fixFieldCase(e,"attributeField",i),this._fixFieldCase(e,"attributeField2",i),this._fixFieldCase(e,"attributeField3",i),this._fixFieldCase(e.rotationInfo,"field",i),t=this._fixFieldCase(e.sizeInfo,"field",i),t&&(this._orderBy||(this._orderBy=[t+" DESC"])),this._fixFieldCase(e.sizeInfo,"normalizationField",i),this._fixFieldCase(e.colorInfo,"field",i),this._fixFieldCase(e.colorInfo,"normalizationField",i),this._fixFieldCase(e.field,"field",i),this._fixFieldCase(e.opacityInfo,"field",i),this._fixFieldCase(e.opacityInfo,"normalizationField",i),n.forEach(e.visualVariables,function(e){t=this._fixFieldCase(e,"field",i),"sizeInfo"===e.type&&t&&!this._orderBy&&(this._orderBy=[t+" DESC"]),this._fixFieldCase(e,"normalizationField",i)},this),this._orderBy||!e.addBreak||r.isFunction(e.attributeField)||!e.backgroundFillSymbol&&!this._hasSizeDiff(e)||(this._orderBy=[e.attributeField+" DESC"])},this),this._rendererFields=n.filter(i,p.isDefined)}},_hasSizeDiff:function(e){var t,i,s=Number.MAX_VALUE,r=-Number.MAX_VALUE;return n.forEach(e.infos,function(e){if(i=e.symbol){switch(t=0,i.type){case"simplemarkersymbol":t=i.size;break;case"picturemarkersymbol":t=(i.width+i.height)/2;break;case"simplelinesymbol":case"cartographiclinesymbol":t=i.width;break;case"simplefillsymbol":case"picturefillsymbol":t=i.outline&&i.outline.width}t&&(s=Math.min(s,t),r=Math.max(r,t))}}),s!==Number.MAX_VALUE&&r!==-Number.MAX_VALUE&&Math.abs(r-s)>1},getOrderByFields:function(){var e=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&e?n.filter(e,function(e){return e=e.split(" ")[0],!!this._getField(e,!0)},this):null},_getField:function(e,t){var i=this.fields;if(!i||0===i.length)return null;var s;return t&&(e=e.toLowerCase()),n.some(i,function(i){var r=!1;return r=t?i&&i.name.toLowerCase()===e?!0:!1:i&&i.name===e?!0:!1,r&&(s=i),r}),s},_getDateOpts:function(){if(!this._dtOpts){var e=n.map(n.filter(this.fields,function(e){return!(!e||"esriFieldTypeDate"!==e.type)}),function(e){return e.name});this._dtOpts={properties:e}}return this._dtOpts},_applyNormalized:function(e,t){e&&t&&n.forEach(e,function(e,i){e&&t[i]&&e.setGeometry(t[i])})},_editHandler:function(e,t,i,s,a,o){var l,h,u,d,c,f=e.addResults,m=e.updateResults,_=e.deleteResults,p=this.objectIdField,y=this._mode,g=this._isTable,b=this.editFieldsInfo,F=this.getOutFields()||[],v=b&&b.creatorField,x=b&&b.creationDateField,S=b&&b.editorField,O=b&&b.editDateField,I=b&&b.realm;-1===n.indexOf(F,"*")&&(v&&-1===n.indexOf(F,v)&&(v=null),x&&-1===n.indexOf(F,x)&&(x=null),S&&-1===n.indexOf(F,S)&&(S=null),O&&-1===n.indexOf(F,O)&&(O=null));var C=x||O?(new Date).getTime():null,E=v||S?this.getUserId():void 0;if(E&&I&&(E=E+"@"+I),f)for(l=0;l<f.length;l++)if(f[l]=new N(f[l]),!g&&(h=f[l],h.success)){u=h.objectId,d=t[l];var T=d._graphicsLayer;T&&T!==this&&T.remove(d),c=d.attributes||{},c[p]=u,v&&(c[v]=E),S&&(c[S]=E),x&&(c[x]=C),O&&(c[O]=C),d.setAttributes(c),y._init&&y.drawFeature(d)}if(m)for(l=0;l<m.length;l++)if(m[l]=new N(m[l]),!g&&(h=m[l],h.success)){u=h.objectId,d=i[u];var w=y._getFeature(u);w&&(w.geometry!==d.geometry&&d.geometry&&w.setGeometry(k.fromJson(d.geometry.toJson())),w.attributes!==d.attributes&&d.attributes&&w.setAttributes(r.mixin(w.attributes,d.attributes)),this._repaint(w,u)),d=w||d,c=d.attributes||{},S&&(c[S]=E),O&&(c[O]=C),d.setAttributes(c)}if(_){var M=[];for(l=0;l<_.length;l++)_[l]=new N(_[l]),g||(h=_[l],h.success&&(u=h.objectId,d=y._getFeature(u),d&&(this._unSelectFeatureIIf(u,y)&&M.push(d),d._count=0,y._removeFeatureIIf(u))));M.length>0&&this.onSelectionComplete(M,$.SELECTION_SUBTRACT)}this._resolve([f,m,_],"onEditsComplete",s,o)},_sendAttachment:function(e,t,i,s,n){var a="add"===e?"addAttachment":"updateAttachment",o=this._url.path+"/"+t+"/"+a,l=this,h=y({url:o,form:i,content:r.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(i){var r="add"===e?"addAttachmentResult":"updateAttachmentResult",n="add"===e?"onAddAttachmentComplete":"onUpdateAttachmentComplete",a=new N(i[r]);return a.attachmentId=a.objectId,a.objectId=t,l._resolve([a],n,s),a}).addErrback(function(e){l._resolve([e],null,n,null,!0)});return h},_repaint:function(e,t,i){t=p.isDefined(t)?t:e.attributes[this.objectIdField],t in this._selectedFeatures&&this._selectionSymbol||e.setSymbol(e.symbol,i)},_getKind:function(e){var t=this._trackManager;return t&&t.isLatestObservation(e)?1:0}});return r.mixin($,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"}),P._createWrappers($),h("extend-esri")&&r.setObject("layers.FeatureLayer",$,_),$});