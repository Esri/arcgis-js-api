// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../PopupTemplate","../renderers","../renderers","../request","../symbols","../core/Collection","../core/Error","../core/Handles","../core/jsonMap","../core/Logger","../core/maybe","../core/MultiOriginJSONSupport","../core/object","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators","../core/accessorSupport/extensions/serializableProperty/reader","../form/FormTemplate","../geometry/Extent","../geometry/HeightModelInfo","../geometry/SpatialReference","./Layer","./graphics/sources/MemorySource","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/arcgisLayerUrl","./support/commonProperties","./support/FeatureIndex","./support/FeatureReduction","./support/FeatureReductionCluster","./support/FeatureReductionSelection","./support/featureReductionUtils","./support/FeatureTemplate","./support/FeatureType","./support/fieldProperties","./support/FieldsIndex","./support/fieldUtils","./support/LabelClass","./support/labelingInfo","./support/Relationship","./support/TimeInfo","./support/source/DataLayerSource","../renderers/support/styleUtils","../support/popupUtils","../tasks/support/AttachmentQuery","../tasks/support/FeatureSet","../tasks/support/Query","../tasks/support/RelationshipQuery","@dojo/framework/shim/Promise"],(function(e,t,r,o,i,n,a,s,p,l,u,d,c,y,f,h,m,_,b,v,g,w,S,F,I,x,D,T,O,R,M,E,A,C,j,L,P,Q,q,V,U,G,z,B,k,N,W,Z,J,H,K,$,X,Y,ee,te){"use strict";var re=new d.default({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),oe={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"},ie="FeatureLayer",ne=c.getLogger("esri.layers.FeatureLayer");function ae(e){return e&&e instanceof p}function se(e,t,r){return!!(e&&e.hasOwnProperty(t)?e[t]:r)}function pe(e,t,r){return e&&e.hasOwnProperty(t)?e[t]:r}var le=z.defineFieldProperties(),ue=function(t){function d(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var o=t.apply(this,e)||this;return o._handles=new u,o.capabilities=null,o.copyright=null,o.displayField=null,o.definitionExpression=null,o.dynamicDataSource=null,o.editFieldsInfo=null,o.editingEnabled=!0,o.editingInfo=null,o.elevationInfo=null,o.featureReduction=null,o.fields=null,o.formTemplate=null,o.fullExtent=null,o.gdbVersion=null,o.geometryProperties=null,o.geometryType=null,o.hasM=void 0,o.hasZ=void 0,o.heightModelInfo=null,o.historicMoment=null,o.isTable=!1,o.labelsVisible=!0,o.labelingInfo=null,o.layerId=void 0,o.legendEnabled=!0,o.minScale=0,o.maxScale=0,o.globalIdField=null,o.objectIdField=null,o.outFields=null,o.path=null,o.popupEnabled=!0,o.popupTemplate=null,o.relationships=null,o.sourceJSON=null,o.returnM=void 0,o.returnZ=void 0,o.screenSizePerspectiveEnabled=!0,o.serviceDefinitionExpression=null,o.spatialReference=F.WGS84,o.templates=null,o.timeInfo=null,o.title=null,o.sublayerTitleMode="item-title",o.trackIdField=null,o.type="feature",o.typeIdField=null,o.types=null,o.indexes=new(p.ofType(L.FeatureIndex)),o.userIsAdmin=!1,o.version=void 0,o.visible=!0,o}return r.__extends(d,t),d.prototype.destroy=function(){var e;null===(e=this.source)||void 0===e||e.destroy(),this._handles&&(this._handles.destroy(),this._handles=null)},d.prototype.normalizeCtorArgs=function(e,t){return"string"==typeof e?r.__assign({url:e},t):e},d.prototype.load=function(e){var t=this,o=y.isSome(e)?e.signal:null;if(!(this.portalItem&&this.portalItem.loaded&&this.source)){var i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},e).catch((function(e){return e})).then((function(){return r.__awaiter(t,void 0,void 0,(function(){var e,t;return r.__generator(this,(function(r){switch(r.label){case 0:return this.url&&null==this.layerId&&/FeatureServer|MapServer\/*$/i.test(this.url)?[4,this._fetchFirstLayerId(o)]:[3,2];case 1:null!=(e=r.sent())&&(this.layerId=e),r.label=2;case 2:if(!this.url&&!this._hasMemorySource())throw new l("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return t=this._initLayerProperties,[4,this.createGraphicsSource(o)];case 3:return[2,t.apply(this,[r.sent()])]}}))}))}));return this.addResolvingPromise(i),m.resolve(this)}this.addResolvingPromise(this.createGraphicsSource(o).then((function(e){return t._initLayerProperties(e)})))},d.prototype.readCapabilities=function(e,t){return t=t.layerDefinition||t,{attachment:this._readAttachmentCapabilities(t.attachmentProperties),data:this._readDataCapabilities(t),metadata:this._readMetadataCapabilities(t),operations:this._readOperationsCapabilities(t.capabilities||e,t),query:this._readQueryCapabilities(t),queryRelated:this._readQueryRelatedCapabilities(t),editing:this._readEditingCapabilities(t)}},Object.defineProperty(d.prototype,"createQueryVersion",{get:function(){return this.definitionExpression,this.dynamicDataSource,this.timeExtent,this.timeOffset,this.geometryType,this.gdbVersion,this.historicMoment,this.returnZ,this.capabilities,this.returnM,(this._get("createQueryVersion")||0)+1},enumerable:!1,configurable:!0}),d.prototype.readEditingEnabled=function(e,t){return!t.layerDefinition||"Query"!==t.layerDefinition.capabilities},d.prototype.writeEditingEnabled=function(e,t){e||h.setDeepValue("layerDefinition.capabilities","Query",t)},d.prototype.readEditingInfo=function(e,t){var r=t.editingInfo;return r?{lastEditDate:null!=r.lastEditDate?new Date(r.lastEditDate):null}:null},d.prototype.readFeatureReduction=function(e,t){return V.read(e,t)},d.prototype.writeWebSceneFeatureReduction=function(e,t,r,o){V.writeTarget(e,t,"layerDefinition.featureReduction",o)},Object.defineProperty(d.prototype,"fieldsIndex",{get:function(){return new B(this.fields||[])},enumerable:!1,configurable:!0}),d.prototype.readIsTable=function(e,t){return"Table"===(t=t&&t.layerDefinition||t).type||!t.geometryType},Object.defineProperty(d.prototype,"hasService",{get:function(){return!this._hasMemorySource()},enumerable:!1,configurable:!0}),d.prototype.readMinScale=function(e,t){return t.effectiveMinScale||e||0},d.prototype.readMaxScale=function(e,t){return t.effectiveMaxScale||e||0},d.prototype.readGlobalIdFieldFromService=function(e,t){if((t=t.layerDefinition||t).globalIdField)return t.globalIdField;if(t.fields)for(var r=0,o=t.fields;r<o.length;r++){var i=o[r];if("esriFieldTypeGlobalID"===i.type)return i.name}},d.prototype.readObjectIdFieldFromService=function(e,t){if((t=t.layerDefinition||t).objectIdField)return t.objectIdField;if(t.fields)for(var r=0,o=t.fields;r<o.length;r++){var i=o[r];if("esriFieldTypeOID"===i.type)return i.name}},Object.defineProperty(d.prototype,"parsedUrl",{get:function(){var e=this.url?_.urlToObject(this.url):null;return null!=e&&(null!=this.dynamicDataSource?e.path=_.join(e.path,"dynamicLayer"):null!=this.layerId&&(e.path=_.join(e.path,this.layerId.toString()))),e},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"defaultPopupTemplate",{get:function(){return this.createPopupTemplate()},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"renderer",{set:function(e){k.fixRendererFields(e,this.fields),this._set("renderer",e)},enumerable:!1,configurable:!0}),d.prototype.readRenderer=function(e,t,r){var o=(t=t.layerDefinition||t).drawingInfo&&t.drawingInfo.renderer||void 0;if(o){var a=n.read(o,t,r)||void 0;return a||ne.error("Failed to create renderer",{rendererDefinition:t.drawingInfo.renderer,layer:this,context:r}),a}if(t.defaultSymbol)return t.types&&t.types.length?new i.UniqueValueRenderer({defaultSymbol:de(t.defaultSymbol,t,r),field:t.typeIdField,uniqueValueInfos:t.types.map((function(e){return{id:e.id,symbol:de(e.symbol,e,r)}}))}):new i.SimpleRenderer({symbol:de(t.defaultSymbol,t,r)})},Object.defineProperty(d.prototype,"source",{set:function(e){var t=this._get("source");t!==e&&(ae(t)&&this._resetMemorySource(t),ae(e)&&this._initMemorySource(e),this._set("source",e))},enumerable:!1,configurable:!0}),d.prototype.castSource=function(e){return e?Array.isArray(e)||e instanceof p?new x.default({layer:this,items:e}):e:null},d.prototype.readSource=function(e,t){var r=Y.fromJSON(t.featureSet);return new x.default({layer:this,items:r&&r.features||[]})},d.prototype.readServiceDefinitionExpression=function(e,t){return t.definitionQuery||t.definitionExpression},d.prototype.readTemplates=function(e,t){var r=t.editFieldsInfo,o=r&&r.creatorField,i=r&&r.editorField;return e=e&&e.map((function(e){return U.fromJSON(e)})),this._fixTemplates(e,o),this._fixTemplates(e,i),e},d.prototype.readTitle=function(e,t){var r=t.layerDefinition&&t.layerDefinition.name||t.name,o=t.title||t.layerDefinition&&t.layerDefinition.title;if(r){var i=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?C.titleFromUrlAndName(this.url,r):r;var n=r||this.url&&C.parse(this.url).title;if(!n)return;return"item-title-and-service-name"===this.sublayerTitleMode&&i&&i!==n&&(n=i+" - "+n),C.cleanTitle(n)}if("item-title"===this.sublayerTitleMode&&o)return o},d.prototype.readTitleFromWebMap=function(e,t){return t.title||t.layerDefinition&&t.layerDefinition.name},d.prototype.readTypeIdField=function(e,t){var r=(t=t.layerDefinition||t).typeIdField;if(r){var o=k.getField(t.fields,r);o&&(r=o.name)}return r},d.prototype.readTypes=function(e,t){var r=this;e=(t=t.layerDefinition||t).types;var o=t.editFieldsInfo,i=o&&o.creatorField,n=o&&o.editorField;return e&&e.map((function(e){return e=G.fromJSON(e),r._fixTemplates(e.templates,i),r._fixTemplates(e.templates,n),e}))},Object.defineProperty(d.prototype,"url",{set:function(e){var t=C.sanitizeUrlWithLayerId(this,e,ne);this._set("url",t.url),null!=t.layerId&&this._set("layerId",t.layerId)},enumerable:!1,configurable:!0}),d.prototype.writeUrl=function(e,t,r,o){C.writeUrlWithLayerId(this,e,null,t,o)},d.prototype.readVersion=function(e,t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3},d.prototype.readVisible=function(e,t){return t.layerDefinition&&null!=t.layerDefinition.defaultVisibility?!!t.layerDefinition.defaultVisibility:null!=t.visibility?!!t.visibility:void 0},d.prototype.addAttachment=function(e,t){var r=this;return this.load().then((function(){return r._checkAttachmentSupport(e)})).then((function(){if(!("addAttachment"in r.source))throw new l(ie,"Layer source does not support addAttachment capability");return r.source.addAttachment(e,t)}))},d.prototype.updateAttachment=function(e,t,r){var o=this;return this.load().then((function(){return o._checkAttachmentSupport(e)})).then((function(){if(!("updateAttachment"in o.source))throw new l(ie,"Layer source does not support updateAttachment capability");return o.source.updateAttachment(e,t,r)}))},d.prototype.applyEdits=function(t,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(t,r){e(["./graphics/editingSupport"],t,r)}))];case 1:return[2,r.sent().applyEdits(this,t,o)]}}))}))},d.prototype.on=function(e,r){return t.prototype.on.call(this,e,r)},d.prototype.createPopupTemplate=function(e){return $.createPopupTemplate(this,e)},d.prototype.createGraphicsSource=function(t){return r.__awaiter(this,void 0,void 0,(function(){var o,i;return r.__generator(this,(function(r){switch(r.label){case 0:return this._hasMemorySource()?(this.emit("graphics-source-create",{graphicsSource:this.source}),[2,this.source.load({signal:t})]):[4,new Promise((function(t,r){e(["./graphics/sources/FeatureLayerSource"],t,r)}))];case 1:return o=r.sent(),m.throwIfAborted(t),[4,new o.default({layer:this}).load({signal:t})];case 2:return i=r.sent(),this.emit("graphics-source-create",{graphicsSource:i}),[2,i]}}))}))},d.prototype.createQuery=function(){var e=new ee,t=this.get("capabilities.data");e.dynamicDataSource=this.dynamicDataSource,e.gdbVersion=this.gdbVersion,e.historicMoment=this.historicMoment,e.returnGeometry=!0,t&&(t.supportsZ&&null!=this.returnZ&&(e.returnZ=this.returnZ),t.supportsM&&null!=this.returnM&&(e.returnM=this.returnM)),e.outFields=["*"],e.where=this.definitionExpression||"1=1";var r=this.timeOffset,o=this.timeExtent;return e.timeExtent=null!=r&&null!=o?o.offset(-r.value,r.unit):o||null,e.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null,e},d.prototype.deleteAttachments=function(e,t){var r=this;return this.load().then((function(){return r._checkAttachmentSupport(e)})).then((function(){if(!("deleteAttachments"in r.source))throw new l(ie,"Layer source does not support deleteAttachments capability");return r.source.deleteAttachments(e,t)}))},d.prototype.getFeatureType=function(e){var t=this.typeIdField,r=this.types;if(!t||!e)return null;var o=e.attributes?e.attributes[t]:void 0;if(null==o)return null;var i=null;return r.some((function(e){var t=e.id;return null!=t&&(t.toString()===o.toString()&&(i=e),!!i)})),i},d.prototype.getFieldDomain=function(e,t){var r=t&&t.feature,o=this.getFeatureType(r);if(o){var i=o.domains&&o.domains[e];if(i&&"inherited"!==i.type)return i}return this._getLayerDomain(e)},d.prototype.getField=function(e){return this.fieldsIndex.get(e)},d.prototype.queryAttachments=function(e,t){var r=this;return e=X.from(e),this.load().then((function(){if(!r.get("capabilities.data.supportsAttachment"))throw new l(ie,"this layer doesn't support attachments");var t=e.attachmentTypes,o=e.objectIds,i=e.globalIds,n=e.num,a=e.size,s=e.start,p=e.where;if(!r.get("capabilities.operations.supportsQueryAttachments")){var u=o&&o.length>1,d=t&&t.length,c=i&&i.length,y=a&&a.length;if(u||d||c||y||n||s||p)throw new l(ie,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",e)}if(!(o&&o.length||p))throw new l(ie,"'objectIds' or 'where' are required to perform attachment query",e);if(!("queryAttachments"in r.source))throw new l(ie,"Layer source does not support queryAttachments capability",e);return r.source.queryAttachments(e)}))},d.prototype.queryFeatures=function(e,t){var r=this;return this.load().then((function(){return r.source.queryFeatures(ee.from(e)||r.createQuery(),t)})).then((function(e){if(e&&e.features)for(var t=0,o=e.features;t<o.length;t++){var i=o[t];i.layer=i.sourceLayer=r}return e}))},d.prototype.queryObjectIds=function(e,t){var r=this;return this.load().then((function(){if(r.source.queryObjectIds)return r.source.queryObjectIds(ee.from(e)||r.createQuery(),t);throw new l(ie,"Layer source does not support queryObjectIds capability")}))},d.prototype.queryFeatureCount=function(e,t){var r=this;return this.load().then((function(){if(r.source.queryFeatureCount)return r.source.queryFeatureCount(ee.from(e)||r.createQuery(),t);throw new l(ie,"Layer source does not support queryFeatureCount capability")}))},d.prototype.queryExtent=function(e,t){var r=this;return this.load().then((function(){if(r.source.queryExtent)return r.source.queryExtent(ee.from(e)||r.createQuery(),t);throw new l(ie,"Layer source does not support queryExtent capability")}))},d.prototype.queryRelatedFeatures=function(e,t){var r=this;return this.load().then((function(){if("queryRelatedFeatures"in r.source)return r.source.queryRelatedFeatures(te.from(e),t);throw new l(ie,"Layer source does not support queryRelatedFeatures capability")}))},d.prototype.queryRelatedFeaturesCount=function(e,t){var r=this;return this.load().then((function(){if("queryRelatedFeaturesCount"in r.source)return r.source.queryRelatedFeaturesCount(te.from(e),t);throw new l(ie,"Layer source does not support queryRelatedFeaturesCount capability")}))},d.prototype.read=function(e,r){var o=e.featureCollection;if(o){var i=o.layers;i&&1===i.length&&(t.prototype.read.call(this,i[0],r),null!=o.showLegend&&t.prototype.read.call(this,{showLegend:o.showLegend},r))}t.prototype.read.call(this,e,r),r&&"service"===r.origin&&this.revert(["objectIdField","fields","timeInfo","spatialReference"],"service")},d.prototype.write=function(e,r){if(r){var o=r.origin,i=r.layerContainerType,n=r.messages;if(this.isTable){if("web-scene"===o||"web-map"===o&&"tables"!==i)return n&&n.push(new l("layer:unsupported","Layer ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot be written to web scenes and web maps",{layer:this})),null;if(this._hasMemorySource())return n&&n.push(new l("layer:unsupported","Layer ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using an in-memory Table source cannot be written to web scenes and web maps",{layer:this})),null}else if(this.loaded&&"web-map"===o&&"tables"===i)return n&&n.push(new l("layer:unsupported","Layer ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a non-table source cannot be written to tables in web maps",{layer:this})),null}return t.prototype.write.call(this,e,r)},d.prototype._checkAttachmentSupport=function(e){var t=e.attributes,r=this.objectIdField;return this.get("capabilities.data.supportsAttachment")?e?t?t[r]?void 0:m.reject(new l(ie,"feature is missing the identifying attribute "+r)):m.reject(new l(ie,"'attributes' are required on a feature to query attachments")):m.reject(new l(ie,"A feature is required to add/delete/update attachments")):m.reject(new l(ie,"this layer doesn't support attachments"))},d.prototype._getLayerDomain=function(e){var t=this.fieldsIndex.get(e);return t?t.domain:null},d.prototype._fetchFirstLayerId=function(e){return a(this.url,{query:{f:"json"},responseType:"json",signal:e}).then((function(e){var t=e.data;if(t)return Array.isArray(t.layers)&&t.layers.length>0?t.layers[0].id:Array.isArray(t.tables)&&t.tables.length>0?t.tables[0].id:void 0}))},d.prototype._initLayerProperties=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return this._set("source",e),e.sourceJSON&&(this.sourceJSON=e.sourceJSON,this.read(e.sourceJSON,{origin:"service",url:this.parsedUrl})),this._verifySource(),this._verifyFields(),k.fixRendererFields(this.renderer,this.fields),k.fixTimeInfoFields(this.timeInfo,this.fields),[2,K.loadStyleRenderer(this,{origin:"service"})]}))}))},d.prototype._verifyFields=function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||-1!==e.search(/\/FeatureServer\//i)||this.fields&&this.fields.some((function(e){return"geometry"===e.type}))||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},d.prototype._fixTemplates=function(e,t){e&&e.forEach((function(e){var r=e.prototype&&e.prototype.attributes;r&&t&&delete r[t]}))},d.prototype._verifySource=function(){if(this._hasMemorySource()){if(this.url)throw new l("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new l("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")},d.prototype._initMemorySource=function(e){var t=this;e.forEach((function(e){e.layer=t,e.sourceLayer=t})),this._handles.add([e.on("after-add",(function(e){e.item.layer=t,e.item.sourceLayer=t})),e.on("after-remove",(function(e){e.item.layer=null,e.item.sourceLayer=null}))],"fl-source")},d.prototype._resetMemorySource=function(e){e.forEach((function(e){e.layer=null,e.sourceLayer=null})),this._handles.remove("fl-source")},d.prototype._hasMemorySource=function(){return!(this.url||!this.source)},d.prototype._readAttachmentCapabilities=function(e){var t={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1};return e&&Array.isArray(e)&&e.forEach((function(e){var r=oe[e.name];r&&(t[r]=!!e.isEnabled)})),t},d.prototype._readDataCapabilities=function(e){return{isVersioned:se(e,"isDataVersioned",!1),supportsAttachment:se(e,"hasAttachments",!1),supportsM:se(e,"hasM",!1),supportsZ:se(e,"hasZ",!1)}},d.prototype._readMetadataCapabilities=function(e){return{supportsAdvancedFieldProperties:se(e,"supportsFieldDescriptionProperty",!1)}},d.prototype._readOperationsCapabilities=function(e,t){var r=e?e.toLowerCase().split(",").map((function(e){return e.trim()})):[],o=-1!==r.indexOf("editing"),i=o&&-1!==r.indexOf("create"),n=o&&-1!==r.indexOf("delete"),a=o&&-1!==r.indexOf("update");return o&&!(i||n||a)&&(i=n=a=!0),{supportsCalculate:se(t,"supportsCalculate",!1),supportsTruncate:se(t,"supportsTruncate",!1),supportsValidateSql:se(t,"supportsValidateSql",!1),supportsAdd:i,supportsDelete:n,supportsEditing:o,supportsQuery:-1!==r.indexOf("query"),supportsQueryAttachments:se(t.advancedQueryCapabilities,"supportsQueryAttachments",!1),supportsResizeAttachments:se(t,"supportsAttachmentsResizing",!1),supportsSync:-1!==r.indexOf("sync"),supportsUpdate:a,supportsExceedsLimitStatistics:se(t,"supportsExceedsLimitStatistics",!1)}},d.prototype._readQueryCapabilities=function(e){var t=e.advancedQueryCapabilities,r=e.ownershipBasedAccessControlForFeatures,o=e.archivingInfo,i=(e.supportedQueryFormats||"").split(",").reduce((function(e,t){var r=t.toLowerCase().trim();return r&&e.add(r),e}),new Set);return{supportsStatistics:se(t,"supportsStatistics",e.supportsStatistics),supportsPercentileStatistics:se(t,"supportsPercentileStatistics",!1),supportsCentroid:se(t,"supportsReturningGeometryCentroid",!1),supportsDistance:se(t,"supportsQueryWithDistance",!1),supportsDistinct:se(t,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:se(t,"supportsReturningQueryExtent",!1),supportsGeometryProperties:se(t,"supportsReturningGeometryProperties",!1),supportsHavingClause:se(t,"supportsHavingClause",!1),supportsOrderBy:se(t,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:se(t,"supportsPagination",!1),supportsQuantization:se(e,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:se(e,"supportsQuantizationEditMode",!1),supportsQueryGeometry:se(e,"supportsReturningQueryGeometry",!1),supportsResultType:se(t,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:se(t,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:se(t,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:se(e,"useStandardizedQueries",!1),supportsQueryByOthers:se(r,"allowOthersToQuery",!0),supportsHistoricMoment:se(o,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:i.has("pbf"),supportsDisjointSpatialRelationship:se(t,"supportsDisjointSpatialRel",!1),supportsCacheHint:se(t,"supportsQueryWithCacheHint",!1),maxRecordCountFactor:pe(e,"maxRecordCountFactor",void 0),maxRecordCount:pe(e,"maxRecordCount",void 0),standardMaxRecordCount:pe(e,"standardMaxRecordCount",void 0),tileMaxRecordCount:pe(e,"tileMaxRecordCount",void 0)}},d.prototype._readQueryRelatedCapabilities=function(e){var t=e.advancedQueryCapabilities,r=se(t,"supportsAdvancedQueryRelated",!1);return{supportsPagination:se(t,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r}},d.prototype._readEditingCapabilities=function(e){var t=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:se(e,"allowGeometryUpdates",!0),supportsGlobalId:se(e,"supportsApplyEditsWithGlobalIds",!1),supportsRollbackOnFailure:se(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:se(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:se(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:se(t,"allowAnonymousToDelete",!0),supportsDeleteByOthers:se(t,"allowOthersToDelete",!0),supportsUpdateByAnonymous:se(t,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:se(t,"allowOthersToUpdate",!0)}},r.__decorate([b.property({readOnly:!0,json:{read:!1}})],d.prototype,"capabilities",void 0),r.__decorate([b.reader("service","capabilities",["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"])],d.prototype,"readCapabilities",null),r.__decorate([b.property({readOnly:!0,dependsOn:["definitionExpression","dynamicDataSource","timeExtent","timeOffset","geometryType","gdbVersion","historicMoment","returnZ","capabilities","returnM"]})],d.prototype,"createQueryVersion",null),r.__decorate([b.property({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],d.prototype,"copyright",void 0),r.__decorate([b.property({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],d.prototype,"displayField",void 0),r.__decorate([b.property({type:String,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],d.prototype,"definitionExpression",void 0),r.__decorate([b.property({types:s.symbolTypes,readOnly:!0})],d.prototype,"defaultSymbol",void 0),r.__decorate([b.property({type:H.DataLayerSource})],d.prototype,"dynamicDataSource",void 0),r.__decorate([b.property({readOnly:!0})],d.prototype,"editFieldsInfo",void 0),r.__decorate([b.property({type:Boolean})],d.prototype,"editingEnabled",void 0),r.__decorate([b.reader(["portal-item","web-map","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],d.prototype,"readEditingEnabled",null),r.__decorate([b.writer(["portal-item","web-map","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],d.prototype,"writeEditingEnabled",null),r.__decorate([b.property({readOnly:!0})],d.prototype,"editingInfo",void 0),r.__decorate([b.reader("editingInfo")],d.prototype,"readEditingInfo",null),r.__decorate([b.property(j.elevationInfo)],d.prototype,"elevationInfo",void 0),r.__decorate([b.property({types:{key:"type",base:P.default,typeMap:{selection:q,cluster:Q}},json:{write:{target:"layerDefinition.featureReduction"}}})],d.prototype,"featureReduction",void 0),r.__decorate([b.reader("featureReduction",["layerDefinition.featureReduction"])],d.prototype,"readFeatureReduction",null),r.__decorate([b.writer("web-scene","featureReduction",{"layerDefinition.featureReduction":{types:V.webSceneFeatureReductionTypes}})],d.prototype,"writeWebSceneFeatureReduction",null),r.__decorate([b.property(r.__assign(r.__assign({},le.fields),{json:{origins:{service:{read:!0}},read:{source:"layerDefinition.fields"}}}))],d.prototype,"fields",void 0),r.__decorate([b.property({readOnly:!0,dependsOn:["fields"]})],d.prototype,"fieldsIndex",null),r.__decorate([b.property({type:g,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],d.prototype,"formTemplate",void 0),r.__decorate([b.property({type:w,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],d.prototype,"fullExtent",void 0),r.__decorate([b.property()],d.prototype,"gdbVersion",void 0),r.__decorate([b.property({readOnly:!0})],d.prototype,"geometryProperties",void 0),r.__decorate([b.property({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:re.read}},read:{source:"layerDefinition.geometryType",reader:re.read}}})],d.prototype,"geometryType",void 0),r.__decorate([b.property({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],d.prototype,"hasM",void 0),r.__decorate([b.property({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],d.prototype,"hasZ",void 0),r.__decorate([b.property({readOnly:!0,type:S})],d.prototype,"heightModelInfo",void 0),r.__decorate([b.property({type:Date})],d.prototype,"historicMoment",void 0),r.__decorate([b.property({json:{origins:{service:{read:!1},"portal-item":{read:!1}}}})],d.prototype,"id",void 0),r.__decorate([b.property({readOnly:!0})],d.prototype,"isTable",void 0),r.__decorate([b.reader("service","isTable",["type","geometryType"]),b.reader("isTable",["layerDefinition.type","layerDefinition.geometryType"])],d.prototype,"readIsTable",null),r.__decorate([b.property({dependsOn:["loaded","url","source"],readOnly:!0})],d.prototype,"hasService",null),r.__decorate([b.property(j.labelsVisible)],d.prototype,"labelsVisible",void 0),r.__decorate([b.property({type:[N],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:W.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:W.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],d.prototype,"labelingInfo",void 0),r.__decorate([b.property(j.opacityDrawingInfo)],d.prototype,"opacity",void 0),r.__decorate([b.property({type:Number,json:{origins:{service:{read:{source:"id"}}},read:!1}})],d.prototype,"layerId",void 0),r.__decorate([b.property(j.legendEnabled)],d.prototype,"legendEnabled",void 0),r.__decorate([b.property({type:["show","hide"]})],d.prototype,"listMode",void 0),r.__decorate([b.property({type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}})],d.prototype,"minScale",void 0),r.__decorate([b.reader("service","minScale",["minScale","effectiveMinScale"])],d.prototype,"readMinScale",null),r.__decorate([b.property({type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}})],d.prototype,"maxScale",void 0),r.__decorate([b.reader("service","maxScale",["maxScale","effectiveMaxScale"])],d.prototype,"readMaxScale",null),r.__decorate([b.property({type:String})],d.prototype,"globalIdField",void 0),r.__decorate([b.reader("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"]),b.reader("service","globalIdField",["globalIdField","fields"])],d.prototype,"readGlobalIdFieldFromService",null),r.__decorate([b.property({type:String})],d.prototype,"objectIdField",void 0),r.__decorate([b.reader("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),b.reader("service","objectIdField",["objectIdField","fields"])],d.prototype,"readObjectIdFieldFromService",null),r.__decorate([b.property({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],d.prototype,"operationalLayerType",void 0),r.__decorate([b.property(le.outFields)],d.prototype,"outFields",void 0),r.__decorate([b.property({readOnly:!0,dependsOn:["layerId","dynamicDataSource"]})],d.prototype,"parsedUrl",null),r.__decorate([b.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],d.prototype,"path",void 0),r.__decorate([b.property(j.popupEnabled)],d.prototype,"popupEnabled",void 0),r.__decorate([b.property({type:o,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],d.prototype,"popupTemplate",void 0),r.__decorate([b.property({readOnly:!0,dependsOn:["fields","title"]})],d.prototype,"defaultPopupTemplate",null),r.__decorate([b.property({type:[Z],readOnly:!0})],d.prototype,"relationships",void 0),r.__decorate([b.property({types:i.rendererTypes,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:i.webSceneRendererTypes,write:{target:"layerDefinition.drawingInfo.renderer",writer:n.write}}},write:{target:"layerDefinition.drawingInfo.renderer",writer:n.write}}})],d.prototype,"renderer",null),r.__decorate([b.reader("service","renderer",["drawingInfo.renderer","defaultSymbol","type"]),b.reader("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol","layerDefinition.type"])],d.prototype,"readRenderer",null),r.__decorate([b.property()],d.prototype,"sourceJSON",void 0),r.__decorate([b.property({type:Boolean})],d.prototype,"returnM",void 0),r.__decorate([b.property({type:Boolean})],d.prototype,"returnZ",void 0),r.__decorate([b.property(j.screenSizePerspectiveEnabled)],d.prototype,"screenSizePerspectiveEnabled",void 0),r.__decorate([b.property()],d.prototype,"source",null),r.__decorate([b.cast("source")],d.prototype,"castSource",null),r.__decorate([b.reader("portal-item","source",["featureSet"]),b.reader("web-map","source",["featureSet"])],d.prototype,"readSource",null),r.__decorate([b.property({readOnly:!0})],d.prototype,"serviceDefinitionExpression",void 0),r.__decorate([b.reader("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],d.prototype,"readServiceDefinitionExpression",null),r.__decorate([b.property({type:F,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],d.prototype,"spatialReference",void 0),r.__decorate([b.property({type:[U]})],d.prototype,"templates",void 0),r.__decorate([b.reader("templates",["editFieldsInfo","creatorField","editorField","templates"])],d.prototype,"readTemplates",null),r.__decorate([b.property({type:J})],d.prototype,"timeInfo",void 0),r.__decorate([b.property()],d.prototype,"title",void 0),r.__decorate([b.reader("service","title",["name"]),b.reader("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],d.prototype,"readTitle",null),r.__decorate([b.reader("web-map","title",["layerDefinition.name","title"])],d.prototype,"readTitleFromWebMap",null),r.__decorate([b.property({type:String})],d.prototype,"sublayerTitleMode",void 0),r.__decorate([b.property({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],d.prototype,"trackIdField",void 0),r.__decorate([b.property({json:{read:!1}})],d.prototype,"type",void 0),r.__decorate([b.property({type:String})],d.prototype,"typeIdField",void 0),r.__decorate([b.reader("service","typeIdField"),b.reader("typeIdField",["layerDefinition.typeIdField"])],d.prototype,"readTypeIdField",null),r.__decorate([b.property({type:[G]})],d.prototype,"types",void 0),r.__decorate([b.reader("service","types",["types"]),b.reader("types",["layerDefinition.types"])],d.prototype,"readTypes",null),r.__decorate([b.property({type:p.ofType(L.FeatureIndex),readOnly:!0})],d.prototype,"indexes",void 0),r.__decorate([b.property(j.url)],d.prototype,"url",null),r.__decorate([b.writer("url")],d.prototype,"writeUrl",null),r.__decorate([b.property({readOnly:!0})],d.prototype,"userIsAdmin",void 0),r.__decorate([b.property({json:{origins:{service:{read:!0}},read:!1}})],d.prototype,"version",void 0),r.__decorate([b.reader("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],d.prototype,"readVersion",null),r.__decorate([b.property({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],d.prototype,"visible",void 0),r.__decorate([b.reader("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],d.prototype,"readVisible",null),d=r.__decorate([b.subclass("esri.layers.FeatureLayer")],d)}(T.BlendLayer(A.TemporalLayer(E.ScaleRangeLayer(M.RefreshableLayer(D.ArcGISService(O.OperationalLayer(R.PortalLayer(f.MultiOriginJSONMixin(I))))))))),de=v.createTypeReader({types:s.symbolTypesRenderer});return ue}));