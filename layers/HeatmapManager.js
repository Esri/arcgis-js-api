// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/_base/array","require","../kernel","../sniff","../geometry/Point","../geometry/webMercatorUtils","./MapImage","../renderers/HeatmapRenderer","../tasks/query","dojo/_base/fx"],function(e,t,r,a,i,n,s,o,h,u,l,d,c){function m(){}function g(e){var t=e.geometry,r=e.attributes,a=e.layer;return{geometry:t,attributes:r,getLayer:function(){return a}}}var p=e(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(e){this.sourceLayer=e,this._hndls=[]},initialize:function(e){this.map=e;var r=this.sourceLayer,a=r.renderer;r.setDrawMode(!1),this.imageLayer=e._getMapImageLyr();var n=this;this.heatmapRenderer=a instanceof l?a:(a.getRendererInfoByZoom(e.getZoom())||a.getRendererInfoByScale(e.getScale())).renderer,this._setupDraw=this._setupDraw.bind(this),this.recalculateHeatmap=this.recalculateHeatmap.bind(this),this._removeRenderer=this._removeRenderer.bind(this),this._handleRendererChange=this._handleRendererChange.bind(this),this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange),this._handleOpacityChange=this._handleOpacityChange.bind(this),this._reprojectFeature=this._reprojectFeature.bind(this),i(["../workers/heatmapCalculator"],function(e){n._calculator=new e(t.mixin({width:n.map.width,height:n.map.height},n._getOptions())),n._setupRenderer(),n.heatmapRenderer.getStats=e.calculateStats,n.heatmapRenderer.getHistogramData=e.getHistogramData})},destroy:function(){this._removeHandlers(),this._rendererChangeHandle&&this._rendererChangeHandle.remove(),this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(e){var t=e.renderer,r=t instanceof l;this.heatmapRenderer?r?this.heatmapRenderer=t:this._removeRenderer(e):r&&(this.heatmapRenderer=t,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(e){var t=e.opacity,r=this._getImageBySourceId(this.sourceLayer.id);r&&r.setOpacity(t)},_setupRenderer:function(){var e=this._hndls,t=this.sourceLayer,i=this.map,n=this;t._originalDraw=t._draw,t._draw=m,t._div.clear(),clearTimeout(this._resetTimer),this._resetTimer=setTimeout(this._resetGraphics.bind(this),250),e.push(t.on("update-end",this._setupDraw)),e.push(t.on("suspend",function(e){var t=n._getImageBySourceId(n.sourceLayer.id);t&&t.hide()})),e.push(t.on("resume",function(e){var t=n._getImageBySourceId(n.sourceLayer.id);t&&t.show()})),e.push(r.after(t,"redraw",this._setupDraw)),e.push(i.on("layer-remove",function(e){if(e.layer==t){var r=n._getImageBySourceId(n.sourceLayer.id);r&&n.imageLayer.removeImage(r),n._removeRenderer({target:t})}})),t._collection&&e.push(t.on("graphic-add",function(e){n._reprojectFeature(e.graphic),n._setupDraw()})),1!==t.mode&&(e.push(i.on("resize, pan-end",this._setupDraw)),e.push(i.on("zoom-end",this._setupDraw))),e.push(t.on("opacity-change",this._handleOpacityChange)),this.imageLayer.suspended&&this.imageLayer.resume(),t.graphics&&t.graphics.length&&(t.graphics[0].geometry&&!i.spatialReference.equals(t.graphics[0].geometry.spatialReference)&&a.forEach(t.graphics,function(e){this._reprojectFeature(e)}.bind(this)),this._setupDraw())},_setupDraw:function(){if(!this._drawTimer){var e=this;this._drawTimer=setTimeout(function(){clearTimeout(e._drawTimer),e._drawTimer=null,e.sourceLayer._getRenderer().isInstanceOf(l)&&e.recalculateHeatmap()},16)}},_removeRenderer:function(e){var t=e.target;t._draw=t._originalDraw,delete t._originalDraw,t.setDrawMode(!0),this._removeHandlers(),this._hndls=[];var r=this._getImageBySourceId(this.sourceLayer.id);r&&this.imageLayer.removeImage(r),clearTimeout(this._drawTimer),clearTimeout(this._resetTimer),this._drawTimer=this._resetTimer=null,t.renderer!=e.renderer&&t.renderer.getRendererInfo?this.heatmapRenderer=null:(this.destroy(),t.renderer&&t.renderer.getRendererInfo&&t.redraw())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(e){if(e&&e.geometry){var t=e.geometry,r=this.map.spatialReference,a=t.spatialReference;if(!r.equals(a)){var i=h.project(t,r);null==i?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):e.geometry=i}}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var e=this.sourceLayer,r=this.map,a=this.heatmapRenderer,i=this.map.extent,n=this.map.width,s=this.map.height,o=this._calculator,h=this,l=function(l){var d=h._getScreenPoints(l.features,r,e),c=o.calculateImageData(t.mixin({screenPoints:d,mapinfo:{extent:[i.xmin,i.ymin,i.xmax,i.ymax],resolution:r.getResolution()},width:n,height:s},h._getOptions())),m=a.getSymbol(g({geometry:r.extent,attributes:{size:[n,s],imageData:c},layer:e})),p=new u({extent:r.extent,href:m.url,opacity:0,sourceId:e.id});h._swapMapImages(p,h._getImageBySourceId(e.id)),e.suspended&&p.hide()},c={geometry:r.extent,timeExtent:e.useMapTime?r.timeExtent:void 0,spatialRelationship:d.SPATIAL_REL_INTERSECTS};null!=e._canDoClientSideQuery(c)?e.queryFeatures(c,l):l({features:e.graphics})},_getScreenPoints:function(e,t,r){var i,n,s,h=[],u=e.length,l=0,d=0,c=new o(t.extent.xmin,t.extent.ymax,t.spatialReference),m=t.toScreen(c),g=m.x,p=m.y,_=t.getResolution(),y=t.extent.getCacheValue("_parts");for(y&&(s=a.map(y,function(e){return r._intersects(t,e.extent)[0]}));u--;)i=e[u],i.geometry&&i.visible&&(n={x:Math.ceil((i.geometry.x-c.x)/_+g),y:Math.floor((c.y-i.geometry.y)/_-p),attributes:i.attributes},s&&(d=s.length>1&&n.x<-s[0]?s[1]:s[0],n.x+=d),h[l++]=n);return h},_getImageBySourceId:function(e){var t=this.imageLayer.getImages();return t=a.filter(t,function(t){return t.sourceId==e}),t.length?t[t.length-1]:void 0},_swapMapImages:function(e,t){function r(){a.removeImage(t)}var a=this.imageLayer,i=this.sourceLayer,n=i.opacity;a.addImage(e),c.anim(e._node,{opacity:n},null,null,function(){e.opacity=n}),null!=t&&c.anim(t._node,{opacity:0},null,null,r)},_removeHandlers:function(){if(null!=this._hndls)for(var e=this._hndls.length;e--;)this._hndls[e].remove()},_getOptions:function(){var e=this.heatmapRenderer;return{blurRadius:e.blurRadius,gradient:e.gradient,maxPixelIntensity:e.maxPixelIntensity,minPixelIntensity:e.minPixelIntensity,field:e.field,fieldOffset:e.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer),this._resetTimer=null;for(var e,t=this.sourceLayer.graphics,r=t.length;r--;)e=t[r],e._shape=e._offsets=void 0}});return s("extend-esri")&&t.setObject("layers.HeatmapManager",p,n),p});