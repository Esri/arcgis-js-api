// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/_base/array","require","../kernel","../sniff","../geometry/Point","../geometry/webMercatorUtils","./MapImage","../renderers/HeatmapRenderer","../tasks/query","dojo/_base/fx"],(function(e,r,t,a,i,n,s,o,h,d,l,u,c){var m=e(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(e){this.sourceLayer=e,this._hndls=[]},initialize:function(e){this.map=e;var t=this.sourceLayer,a=t.renderer;t.setDrawMode(!1),this.imageLayer=e._getMapImageLyr();var n=this;this.heatmapRenderer=a instanceof l?a:(a.getRendererInfoByZoom(e.getZoom())||a.getRendererInfoByScale(e.getScale())).renderer,this.redraw=this.redraw.bind(this),this.recalculateHeatmap=this.recalculateHeatmap.bind(this),this._removeRenderer=this._removeRenderer.bind(this),this._handleRendererChange=this._handleRendererChange.bind(this),this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange),this._handleOpacityChange=this._handleOpacityChange.bind(this),this._reprojectFeature=this._reprojectFeature.bind(this),i(["../workers/heatmapCalculator"],(function(e){n._calculator=new e(r.mixin({width:n.map.width,height:n.map.height},n._getOptions())),n._setupRenderer(),n.heatmapRenderer.getStats=e.calculateStats,n.heatmapRenderer.getHistogramData=e.getHistogramData}))},destroy:function(){this._removeHandlers(),this._rendererChangeHandle&&this._rendererChangeHandle.remove(),this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(e){var r=e.renderer,t=r instanceof l;this.heatmapRenderer?t?this.heatmapRenderer=r:this._removeRenderer(e):t&&(this.heatmapRenderer=r,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(e){var r=e.opacity,t=this._getImageBySourceId(this.sourceLayer.id);t&&t.setOpacity(r)},_setupRenderer:function(){var e=this._hndls,r=this.sourceLayer,i=this.map,n=this;r._originalDraw=r._draw,r._draw=g,r._div.clear(),clearTimeout(this._resetTimer),this._resetTimer=setTimeout(this._resetGraphics.bind(this),250),e.push(r.on("update-end",this.redraw)),e.push(r.on("suspend",(function(e){var r=n._getImageBySourceId(n.sourceLayer.id);r&&r.hide()}))),e.push(r.on("resume",(function(e){var r=n._getImageBySourceId(n.sourceLayer.id);r&&r.show()}))),e.push(t.after(r,"redraw",this.redraw)),e.push(i.on("layer-remove",(function(e){if(e.layer==r){var t=n._getImageBySourceId(n.sourceLayer.id);t&&n.imageLayer.removeImage(t),n._removeRenderer({target:r})}}))),r._collection&&e.push(r.on("graphic-add",(function(e){n._reprojectFeature(e.graphic),n.redraw()}))),1!==r.mode&&(e.push(i.on("resize, pan-end",this.redraw)),e.push(i.on("zoom-end",this.redraw))),e.push(r.on("opacity-change",this._handleOpacityChange)),this.imageLayer.suspended&&this.imageLayer.resume(),r.graphics&&r.graphics.length&&(r.graphics[0].geometry&&!i.spatialReference.equals(r.graphics[0].geometry.spatialReference)&&a.forEach(r.graphics,function(e){this._reprojectFeature(e)}.bind(this)),this.redraw())},redraw:function(){if(!this._drawTimer){var e=this;this._drawTimer=setTimeout((function(){clearTimeout(e._drawTimer),e._drawTimer=null,e.sourceLayer._getRenderer().isInstanceOf(l)&&e.recalculateHeatmap()}),16)}},_removeRenderer:function(e){var r=e.target;r._draw=r._originalDraw,delete r._originalDraw,r.setDrawMode(!0),this._removeHandlers(),this._hndls=[];var t=this._getImageBySourceId(this.sourceLayer.id);t&&this.imageLayer.removeImage(t),clearTimeout(this._drawTimer),clearTimeout(this._resetTimer),this._drawTimer=this._resetTimer=null,r.renderer!=e.renderer&&r.renderer.getRendererInfo?this.heatmapRenderer=null:(this.destroy(),r.renderer&&r.renderer.getRendererInfo&&r.redraw())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(e){if(e&&e.geometry){var r=e.geometry,t=this.map.spatialReference,a=r.spatialReference;if(!t.equals(a)){var i=h.project(r,t);null==i?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):e.geometry=i}}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var e=this.sourceLayer,t=this.map,a=this.heatmapRenderer,i=this.map.extent,n=this.map.width,s=this.map.height,o=this._calculator,h=this,l=function(l){var u=h._getScreenPoints(l.features,t,e),c=o.calculateImageData(r.mixin({screenPoints:u,mapinfo:{extent:[i.xmin,i.ymin,i.xmax,i.ymax],resolution:t.getResolution()},width:n,height:s},h._getOptions())),m=a.getSymbol(function(e){var r=e.geometry,t=e.attributes,a=e.layer;return{geometry:r,attributes:t,getLayer:function(){return a}}}({geometry:t.extent,attributes:{size:[n,s],imageData:c},layer:e})),g=new d({extent:t.extent,href:m.url,opacity:0,sourceId:e.id});h._swapMapImages(g,h._getImageBySourceId(e.id)),e.suspended&&g.hide()},c={geometry:t.extent,timeExtent:e.useMapTime?t.timeExtent:void 0,spatialRelationship:u.SPATIAL_REL_INTERSECTS};null!=e._canDoClientSideQuery(c)?e.queryFeatures(c,l):l({features:e.graphics})},_getScreenPoints:function(e,r,t){var i,n,s,h=[],d=e.length,l=0,u=0,c=new o(r.extent.xmin,r.extent.ymax,r.spatialReference),m=r.toScreen(c),g=m.x,p=m.y,_=r.getResolution(),y=r.extent.getCacheValue("_parts");for(y&&(s=a.map(y,(function(e){return t._intersects(r,e.extent)[0]})));d--;)(i=e[d]).geometry&&i.visible&&(n={x:Math.ceil((i.geometry.x-c.x)/_+g),y:Math.floor((c.y-i.geometry.y)/_-p),attributes:i.attributes},s&&(u=s.length>1&&n.x<-s[0]?s[1]:s[0],n.x+=u),h[l++]=n);return h},_getImageBySourceId:function(e){var r=this.imageLayer.getImages();return(r=a.filter(r,(function(r){return r.sourceId==e}))).length?r[r.length-1]:void 0},_swapMapImages:function(e,r){var t=this.imageLayer,a=this.sourceLayer.opacity;t.addImage(e),c.anim(e._node,{opacity:a},null,null,(function(){e.opacity=a})),null!=r&&c.anim(r._node,{opacity:0},null,null,(function(){t.removeImage(r)}))},_removeHandlers:function(){if(null!=this._hndls)for(var e=this._hndls.length;e--;)this._hndls[e].remove()},_getOptions:function(){var e=this.heatmapRenderer;return{blurRadius:e.blurRadius,gradient:e.gradient,maxPixelIntensity:e.maxPixelIntensity,minPixelIntensity:e.minPixelIntensity,field:e.field,fieldOffset:e.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer),this._resetTimer=null;for(var e,r=this.sourceLayer.graphics,t=r.length;t--;)(e=r[t])._shape=e._offsets=void 0}});function g(){}return s("extend-esri")&&r.setObject("layers.HeatmapManager",m,n),m}));