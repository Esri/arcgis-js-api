// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../geometry","../PopupTemplate","../renderers","../core/MultiOriginJSONSupport","../core/accessorSupport/decorators","./Layer","./graphics/sources/OGCFeatureSource","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/FeatureReduction","./support/FeatureReductionCluster","./support/FeatureReductionSelection","./support/FeatureType","./support/Field","./support/FieldsIndex","./support/fieldUtils","./support/LabelClass","../support/popupUtils","../symbols/support/ElevationInfo","../tasks/support/Query","@dojo/framework/shim/Promise"],(function(e,t,r,o,p,i,n,s,l,u,d,a,y,c,f,v,_,h,m,g,b,O,S,F){return function(e){function t(t){var r=e.call(this,t)||this;return r.collectionId=null,r.copyright=null,r.definitionExpression=null,r.displayField=null,r.elevationInfo=null,r.featureReduction=null,r.fullExtent=null,r.geometryType=null,r.hasZ=void 0,r.labelingInfo=null,r.labelsVisible=!0,r.legendEnabled=!0,r.mediaType="application/json",r.objectIdField=null,r.popupEnabled=!0,r.popupTemplate=null,r.screenSizePerspectiveEnabled=!0,r.source=null,r.spatialReference=o.SpatialReference.WGS84,r.type="ogc-feature",r.typeIdField=null,r.types=null,r.url=null,r}return r.__extends(t,e),t.prototype.load=function(e){var t=this,r=new u.default({layer:this});return this._set("source",r),this.addResolvingPromise(r.load(e).then((function(){var e=t.source.layerDefinition,r=e.geometryType,p=e.hasZ,i=e.objectIdField;t.set({geometryType:o.typeKebabDictionary.fromJSON(r),hasZ:p,objectIdField:i}),g.fixRendererFields(t.renderer,t.fields),g.fixTimeInfoFields(t.timeInfo,t.fields)}))),this.when()},Object.defineProperty(t.prototype,"capabilities",{get:function(){return{attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!!this.hasZ},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsQuery:!0,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1},query:{maxRecordCount:1e4,maxRecordCountFactor:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsStandardizedQueriesOnly:!1,supportsStatistics:!1,supportsSqlExpression:!1,tileMaxRecordCount:void 0},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1}}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultPopupTemplate",{get:function(){return this.createPopupTemplate()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"description",{get:function(){var e,t,r;return null!==(r=null===(t=null===(e=this.source)||void 0===e?void 0:e.collection)||void 0===t?void 0:t.description)&&void 0!==r?r:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fields",{get:function(){var e,t,r,o=null===(t=null===(e=this.source)||void 0===e?void 0:e.layerDefinition)||void 0===t?void 0:t.fields;return null!==(r=null==o?void 0:o.map((function(e){return h.fromJSON(e)})))&&void 0!==r?r:null},set:function(e){e?this._override("fields",e):this._clearOverride("fields")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fieldsIndex",{get:function(){return new m(this.fields)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){var e,t,r,o=null===(r=null===(t=null===(e=this.source)||void 0===e?void 0:e.layerDefinition)||void 0===t?void 0:t.drawingInfo)||void 0===r?void 0:r.renderer;return o?i.read(o,null,{origin:"service"}):null},set:function(e){e?(g.fixRendererFields(e,this.fields),this._override("renderer",e)):this._clearOverride("renderer")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spatialReferences",{get:function(){var e,t;return null===(t=null===(e=this.source)||void 0===e?void 0:e.collection)||void 0===t?void 0:t.crs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){var e,t;return null===(t=null===(e=this.source)||void 0===e?void 0:e.collection)||void 0===t?void 0:t.title},set:function(e){e?this._override("title",e):this._clearOverride("title")},enumerable:!0,configurable:!0}),t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)},t.prototype.createPopupTemplate=function(e){return O.createPopupTemplate(this,e)},t.prototype.createQuery=function(){return new F},t.prototype.getField=function(e){return this.fieldsIndex.get(e)},t.prototype.getFieldDomain=function(e,t){var r,o,p=this,i=!1,n=null===(r=null==t?void 0:t.feature)||void 0===r?void 0:r.attributes,s=this.typeIdField&&(null==n?void 0:n[this.typeIdField]);return null!=s&&this.types&&(i=this.types.some((function(t){var r;return t.id==s&&("inherited"===(null==(o=null===(r=t.domains)||void 0===r?void 0:r[e])?void 0:o.type)&&(o=p._getLayerDomain(e)),!0)}))),i||o||(o=this._getLayerDomain(e)),o},t.prototype.queryFeatures=function(e,t){var r=this;return this.load().then((function(){return r.source.queryFeatures(F.from(e)||r.createQuery(),t)})).then((function(e){var t;return null===(t=null==e?void 0:e.features)||void 0===t||t.forEach((function(e){e.layer=e.sourceLayer=r})),e}))},t.prototype._getLayerDomain=function(e){if(!this.fields)return null;for(var t=0,r=this.fields;t<r.length;t++){var o=r[t];if(o.name===e&&o.domain)return o.domain}return null},r.__decorate([s.property({readOnly:!0,dependsOn:["hasZ"]})],t.prototype,"capabilities",null),r.__decorate([s.property({type:String})],t.prototype,"collectionId",void 0),r.__decorate([s.property({type:String})],t.prototype,"copyright",void 0),r.__decorate([s.property({readOnly:!0,dependsOn:["fields","title"]})],t.prototype,"defaultPopupTemplate",null),r.__decorate([s.property({type:String})],t.prototype,"definitionExpression",void 0),r.__decorate([s.property({dependsOn:["source.collection"],readOnly:!0,type:String})],t.prototype,"description",null),r.__decorate([s.property({type:String})],t.prototype,"displayField",void 0),r.__decorate([s.property({type:S})],t.prototype,"elevationInfo",void 0),r.__decorate([s.property({types:{key:"type",base:c.default,typeMap:{selection:v,cluster:f}}})],t.prototype,"featureReduction",void 0),r.__decorate([s.property({dependsOn:["source.layerDefinition"],type:[h]})],t.prototype,"fields",null),r.__decorate([s.property({readOnly:!0,dependsOn:["fields"]})],t.prototype,"fieldsIndex",null),r.__decorate([s.property({type:o.Extent,aliasOf:"source.fullExtent"})],t.prototype,"fullExtent",void 0),r.__decorate([s.property({type:["point","polygon","polyline","multipoint"]})],t.prototype,"geometryType",void 0),r.__decorate([s.property({type:Boolean})],t.prototype,"hasZ",void 0),r.__decorate([s.property({type:String})],t.prototype,"id",void 0),r.__decorate([s.property({type:[b]})],t.prototype,"labelingInfo",void 0),r.__decorate([s.property({type:Boolean})],t.prototype,"labelsVisible",void 0),r.__decorate([s.property({type:Boolean})],t.prototype,"legendEnabled",void 0),r.__decorate([s.property({type:["show","hide"]})],t.prototype,"listMode",void 0),r.__decorate([s.property({type:String})],t.prototype,"mediaType",void 0),r.__decorate([s.property({type:String})],t.prototype,"objectIdField",void 0),r.__decorate([s.property({type:Boolean})],t.prototype,"popupEnabled",void 0),r.__decorate([s.property({type:p})],t.prototype,"popupTemplate",void 0),r.__decorate([s.property({dependsOn:["source.layerDefinition"],types:i.rendererTypes})],t.prototype,"renderer",null),r.__decorate([s.property({type:Boolean})],t.prototype,"screenSizePerspectiveEnabled",void 0),r.__decorate([s.property({readOnly:!0})],t.prototype,"source",void 0),r.__decorate([s.property({type:o.SpatialReference,readOnly:!0})],t.prototype,"spatialReference",void 0),r.__decorate([s.property({dependsOn:["source.collection"],readOnly:!0,type:[String]})],t.prototype,"spatialReferences",null),r.__decorate([s.property({dependsOn:["source.collection"]})],t.prototype,"title",null),r.__decorate([s.property({readOnly:!0})],t.prototype,"type",void 0),r.__decorate([s.property({type:String,readOnly:!0})],t.prototype,"typeIdField",void 0),r.__decorate([s.property({type:[_]})],t.prototype,"types",void 0),r.__decorate([s.property({type:String})],t.prototype,"url",void 0),t=r.__decorate([s.subclass("esri.layers.OGCFeatureLayer")],t)}(y.TemporalLayer(a.ScaleRangeLayer(d.RefreshableLayer(n.MultiOriginJSONMixin(l)))))}));