// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/_base/window","dojo/dom-attr","dojo/dom-construct","dojo/dom-style","dojo/dom","dojox/gfx","dojox/gfx/matrix","./gfxSniff!esri-svg?dojox/gfx/filters","./layer","./support/webglUtils","./support/WebGLSurface","../kernel","../lang","../sniff","../Color","../domUtils","../symbols/MarkerSymbol","../symbols/SimpleMarkerSymbol","../symbols/utils","../geometry/Point","../geometry/ScreenPoint","../geometry/Extent","../geometry/mathUtils","../geometry/screenUtils","../PluginTarget","./gfxSniff!esri-svg?dojox/gfx/svgext"],(function(e,t,i,n,s,r,a,o,h,c,l,_,u,d,p,f,g,v,m,y,S,b,x,w,E,M,P,T,G,L,C){var k,I=-1!==_.renderer.toLowerCase().indexOf("svg"),R=-1!==_.renderer.toLowerCase().indexOf("canvas"),H=R?"canvas-2d":_.renderer,D=y("ie")<9,O=10===y("ie"),A=void 0===y("ie")&&7==y("trident"),F=O||A,N=y("esri-touch"),W=!!y("chrome"),V=f.isWebGLEnabled(),z=I&&y("esri-will-change"),j=V||R;var B=t(null,{declaredClass:"esri.layers._GraphicsContainer",_setMap:function(e,t){var i,s=this._connects=[];if(this._map=e,this._useWillChange=this._useGlobalTransform="css-transforms"===e.navigationMode&&z,j)i=h.create("div",{style:{position:"absolute",overflow:"visible"}},t),this._surface={getEventSource:function(){return i}},R&&(s.push(n.connect(i,"onmousedown",this,this._canvasDownHandler)),s.push(n.connect(i,"onmouseup",this,this._canvasUpHandler)),s.push(n.connect(i,"onclick",this,this._canvasClickHandler))),V&&(this._webglSurface=new g({map:e,node:i}));else{var r=this._surface=_.createSurface(t,e.width,e.height);i=r.getEventSource(),this._useWillChange&&c.set(i,"will-change","transform"),c.set(i=D?i.parentNode:i,{overflow:"visible",position:"absolute"})}return s.push(n.connect(e,"onResize",this,"_onResizeHandler")),this._useGlobalTransform&&(s.push(n.connect(e,"onPan",this,"_onPanHandler")),s.push(n.connect(e,"onPanEnd",this,"_onPanEndHandler")),s.push(n.connect(e,"onExtentChange",this,"_onExtentChangeHandler"))),i},_reorderLayer:function(e,t,i){var n=t.getEventSource();j&&"svg"===e.surfaceType&&(n=n.parentNode),h.place(n,this._surface.getEventSource(),i)},_onPanHandler:function(e,t){var i=this._map.__visibleRect,n=i.x+t.x,s=i.y+t.y;this._panDx=n,this._panDy=s,j||c.set(this._surface.getEventSource(),v._css.names.transform,v._css.translate(n,s))},_onPanEndHandler:function(e,t){var i=this._map.__visibleRect,n=i.x,s=i.y;this._panDx=n,this._panDy=s,j||c.set(this._surface.getEventSource(),v._css.names.transform,v._css.translate(n,s))},_onExtentChangeHandler:function(e,t,i,n){if(i){if(this._panDx=0,this._panDy=0,j)return;c.set(this._surface.getEventSource(),v._css.names.transform,v._css.translate(0,0))}},_getTransform:function(){return{dx:this._panDx||0,dy:this._panDy||0}},_onResizeHandler:function(e,t,i){var n,s=this._surface.getEventSource(),a=this._map;D&&c.set(s=s.parentNode,{width:t+"px",height:i+"px",clip:"rect(0px "+t+"px "+i+"px 0px)"}),o.set(s,"width",t),o.set(s,"height",i),this._surface.declaredClass||r.forEach(s.childNodes,(function(e){o.set(e,"width",t),o.set(e,"height",i)})),a.loaded&&(a.graphics.suspended||(a.graphics._resized=!0),r.forEach(a.graphicsLayerIds,(function(e){(n=a.getLayer(e)).suspended||(n._resized=!0,n._childLayer&&(n._childLayer._resized=!0)),n._updateSVGFilters(null,null,t,i)})),a.graphics._updateSVGFilters(null,null,t,i),a._labels&&a._labels._updateSVGFilters(null,null,t,i))},_cleanUp:function(){r.forEach(this._connects,n.disconnect,n),this._map=this._surface=null},_processEvent:function(e){var t=this._map;e.screenPoint=new P(e.pageX-t.position.x,e.pageY-t.position.y),e.mapPoint=t.toMap(e.screenPoint)},_canvasDownHandler:function(e){this._processEvent(e),this._downPt=e.screenPoint.x+","+e.screenPoint.y},_canvasUpHandler:function(e){this._processEvent(e),this._upPt=e.screenPoint.x+","+e.screenPoint.y},_tolerance:15,_isPrimaryMatch:function(e,t,i,n){if(!e.visible||!t)return!1;var s,a=t.getTransformedBoundingBox();return a?(delete(s=new T(a[0].x,a[0].y,a[2].x,a[2].y)).spatialReference,N?s.intersects(i):s.contains(n)):r.some(t.children||[],(function(e){return a=e.getTransformedBoundingBox(),delete(s=new T(a[0].x,a[0].y,a[2].x,a[2].y)).spatialReference,N?s.intersects(i):s.contains(n)}))},_canvasClickHandler:function(e){if(this._downPt&&this._upPt&&this._downPt===this._upPt){this._processEvent(e);var t=this._map,i=r.map(t.graphicsLayerIds,(function(e){return t.getLayer(e)}));i.push(t.graphics),i.reverse(),i=r.filter(i,(function(e){return e.loaded&&!e.hasWebGLSurface()&&e._mouseEvents&&!e.suspended&&(!m.isDefined(e.opacity)||e.opacity>0)}));var n,s=e.screenPoint,a=this._tolerance,o=s.x-a,h=s.y+a,c=s.x+a,l=s.y-a,_=new T(o,l,c,h),u=t.toMap(new P(o,h)),d=t.toMap(new P(c,l)),p=u.spatialReference._getInfo(),f=new T(T.prototype._normalizeX(u.x,p).x,u.y,T.prototype._normalizeX(d.x,p).x,d.y,u.spatialReference);if(delete _.spatialReference,r.some(i,(function(e){var t,i=r.filter(e.graphics,(function(e){return this._isPrimaryMatch(e,e.getDojoShape(),_,s)||!(!e._bgShape||!this._isPrimaryMatch(e,e._bgShape,_,s))}),this);if((i.reverse(),i.length>0)&&(r.some(i,(function(e){return!(!e.geometry||!f.intersects(e.geometry))&&(t=e,!0)})),t))return n=t,!0;return!1}),this),n){var g=n.getLayer();g&&(e.graphic=n,g.onClick(e))}}}});k=t(p,{declaredClass:"esri.layers._GraphicsLayer",managedSuspension:!0,surfaceType:H,webglEnabled:V,renderer:null,_eventMap:{"graphic-add":["graphic"],"graphic-remove":["graphic"],"renderer-change":["renderer"]},_suspendGraphics:!1,constructor:function(e){e=e||{},(s.isString(e)||s.isObject(e)&&(e.layerDefinition||e.query))&&(e=arguments[1]),this._params=s.mixin({displayOnPan:!0,drawMode:!0,styling:!0},e);var t=this._params.dataAttributes;"string"==typeof t&&(t=[t]),this.styling=!I||this._params.styling,this.dataAttributes=t,this.infoTemplate=e&&e.infoTemplate,this.graphics=[],this._draw=s.hitch(this,this._draw),this._refresh=s.hitch(this,this._refresh),this._acquireSVGMarker=s.hitch(this,this._acquireSVGMarker),this._evalSurfaceType=s.hitch(this,this._evalSurfaceType),this._setSurfaceType=s.hitch(this,this._setSurfaceType),this.setWebGLEnabled(null!=this._params.webglEnabled?this._params.webglEnabled:this.webglEnabled),this.registerConnectEvents()},getNode:function(){return this._div&&this._div.getEventSource()},setDrawMode:function(e){this._params.drawMode=e},suspendGraphics:function(e){this._suspendGraphics=e,r.forEach(this.graphics,(function(t){t._suspended=e}))},setWebGLEnabled:function(e){e=e||!1;var t=this.webglEnabled;this.webglEnabled=e&&V,t!==this.webglEnabled&&(this._evalSurfaceType(),this.onWebGLEnabledChange())},hasWebGLSurface:function(){return"webgl"===this.surfaceType},_getSurfaceType:function(e){return e&&"webgl"===e.surfaceType?"webgl":H},_evalSurfaceType:function(e){V&&(e?this._setSurfaceType():null==this._evalSurfaceTimerHandle&&(this._evalSurfaceTimerHandle=setTimeout(this._setSurfaceType,0)))},_hasPendingSurfaceEval:function(){return!!this._evalSurfaceTimerHandle},_setSurfaceType:function(){clearTimeout(this._evalSurfaceTimerHandle),this._evalSurfaceTimerHandle=null;var e=this._canUseWebGLSurface()?"webgl":H;this.surfaceType!==e?(this.surfaceType=e,this._handleSurfaceChange(),this.onSurfaceChange()):this._pendingRedraw&&this._redraw()},_handleSurfaceChange:function(){this._cancelWebGLDepsLoad(),this._webglDepsPromise=this._prepareToAttach(this._map),this._webglDepsPromise.always(s.hitch(this,(function(e){this._webglDepsPromise=null,e&&"cancel"===e.dojoType||this._evalSurface()})))},_cancelWebGLDepsLoad:function(){this._webglDepsPromise&&!this._webglDepsPromise.isFulfilled()&&this._webglDepsPromise.cancel(),this._webglDepsPromise=null},_evalSurface:function(){var e=this._map,t=this._div;e&&t&&this._getSurfaceType(t)!==this.surfaceType&&(e._detachGraphicsLayer(this),e._attachGraphicsLayer(this))},_canUseWebGLSurface:function(e){return e=e||this._map,this.webglEnabled&&(!e||e.webglEnabled&&(e.ownsWebGLContext(this)||e.isWebGLContextAvailable()))&&this._params.drawMode&&this._isWebGLCompatible()},_isWebGLCompatible:function(){return!1},_prepareToAttach:function(t){var n=new i;return!this.webglDeps&&this._canUseWebGLSurface(t)?e(["./support/webglDeps"],s.hitch(this,(function(e){this.webglDeps=e,n.isFulfilled()||n.resolve()}))):n.resolve(),n.promise},_setMap:function(e,t){if(this.inherited(arguments),this._map=e,this._evalSurfaceType(!0),this._webglChangeMapHandle=e.on("webgl-enabled-change",s.hitch(this,(function(){this._evalSurfaceType()}))),this._wrap=e.wrapAround180,this._srInfo=e.spatialReference._getInfo(),this._svgFilters={},this._lineMarkers={},this.hasWebGLSurface())e.acquireWebGLContext(this),this._div=e._gc._webglSurface.createRenderer(this.webglDeps.WebGLRenderer,e.width,e.height,this);else{if("svg"===this.surfaceType)if(j){var i=(t=_.createSurface(t.getEventSource(),e.width,e.height)).getEventSource();c.set(i,{position:"absolute",overflow:"visible",pointerEvents:"none"}),e._gc._useWillChange&&c.set(i,"will-change","transform"),this._div=t.createGroup(),c.set(this._div.getEventSource(),"pointer-events","auto")}else this._div=t.createGroup();else t=_.createSurface(t.getEventSource(),e.width,e.height),c.set(t.rawNode,"position","absolute"),this._div=t.createGroup(),this._renderProto=this._div.constructor.prototype._render,this._div._render=s.hitch(this,this._canvasRender);this._bgGroup=this._div.createGroup()}return this._div.getEventSource().id=this.id+"_layer",this._initOpacity(),this._div},_unsetMap:function(e,t){e.releaseWebGLContext(this),"webgl"===this._div.surfaceType?e._gc._webglSurface.destroyRenderer(this._div):(r.forEach(this.graphics,(function(e){e._shape=null})),"svg"===this.surfaceType?j?(t=this._div.parent,this._div.clear(),t.remove(this._div),h.destroy(this._div.getEventSource()),h.destroy(t.getEventSource())):(this._div.clear(),t.remove(this._div),h.destroy(this._div.getEventSource())):((t=this._div.getParent())._parent={},h.destroy(t.rawNode),t.destroy())),this._map=this._div=this._svgFilters=this._lineMarkers=null,this._pendingRedraw=!1,clearTimeout(this._wakeTimer),this._wakeTimer=null,clearTimeout(this._evalSurfaceTimerHandle),this._evalSurfaceTimerHandle=null,this._webglChangeMapHandle&&this._webglChangeMapHandle.remove(),this._cancelWebGLDepsLoad(),this._disableDrawConnectors(),this.inherited(arguments)},_initOpacity:function(){var e=this.opacity;m.isDefined(e)&&e<1&&this.setOpacity(e,!0)},_onZoomStartHandler:function(){this.hasWebGLSurface()||b.hide(this._div.getEventSource())},_onExtentChangeHandler:function(e,t,i,n){if(clearTimeout(this._wakeTimer),this._wakeTimer=null,i){var s=this._map.__visibleRect,r=this._div;this._evalSDRenderer(),this._refresh(!0),this._params._child||this._updateTransform(r,s.x,s.y,!0),this._renderProto&&r.surface.pendingRender?this._dirty=!0:this.suspended||b.show(r.getEventSource())}else this._resized&&(this._resized=!1,this._refresh(!1));this.graphics.length>0&&this.onUpdate()},_canvasRender:function(){var e=this._div;return this._dirty&&(delete this._dirty,this.suspended||b.show(e.getEventSource())),this._renderProto.apply(e,arguments)},_refresh:function(e){if(!this.hasWebGLSurface()){var t,i=this.graphics,n=i.length,s=this._draw;for(t=0;t<n;t++)s(i[t],e)}},refresh:function(){this._refresh(!0)},_redraw:function(){this._pendingRedraw=!1,this.hasWebGLSurface()?this._div&&this._div.redraw():this._refresh(!0)},redraw:function(){this._hasPendingSurfaceEval()?this._pendingRedraw=!0:this._redraw()},hasLocalNavigationTransform:function(){return!(this._map&&this._map._gc._useGlobalTransform)},getNavigationTransform:function(){var e={dx:0,dy:0};return this._map&&(this.hasLocalNavigationTransform()?this._div&&!this.hasWebGLSurface()&&(e=this._div.getTransform()):e=this._map._gc._getTransform()),e},_onPanHandler:function(e,t){this._panDx=t.x,this._panDy=t.y;var i=this._map.__visibleRect;this._updateTransform(this._div,i.x+t.x,i.y+t.y),A&&this._updateSVGMarkers()},_onPanEndUpdateHandler:function(e,t){var i=this._map.__visibleRect;this._params._child||t.x===this._panDx&&t.y===this._panDy?(this._updateSVGFilters(-i.x,-i.y),this._updateSVGMarkers()):this._updateTransform(this._div,i.x,i.y,!0),this._refresh(!1),this.graphics.length&&this.onUpdate()},_onPanStartHandler:function(){b.hide(this._div.getEventSource())},_onPanEndHandler:function(){var e=this._map.__visibleRect,t=this._div;this._updateTransform(t,e.x,e.y,!0),this._refresh(!1),this._renderProto&&t.surface.pendingRender?this._dirty=!0:b.show(t.getEventSource()),this.graphics.length&&this.onUpdate()},_updateTransform:function(e,t,i,n){this.hasWebGLSurface()||(this.hasLocalNavigationTransform()?e.setTransform(u.translate({x:t,y:i})):j&&c.set(this._div.parent.getEventSource(),v._css.names.transform,v._css.translate(t,i)),n&&(this._updateSVGFilters(-t,-i),this._updateSVGMarkers()))},onSuspend:function(){this.inherited(arguments),b.hide(this._div.getEventSource()),clearTimeout(this._wakeTimer),this._wakeTimer=null,this._disableDrawConnectors()},onResume:function(e){this.inherited(arguments),e.firstOccurrence&&this._evalSDRenderer(),this._enableDrawConnectors(),this._wakeTimer=this._wakeTimer||setTimeout(s.hitch(this,(function(){this.suspended||this._map.__zooming||this._onExtentChangeHandler(null,null,!0)})),0)},_enableDrawConnectors:function(){var e=this._map,t=n.connect;this._disableDrawConnectors(),this._params.displayOnPan?(this._params._child||(this._onPanHandler_connect=t(e,"onPan",this,"_onPanHandler")),this._onPanEndHandler_connect=t(e,"onPanEnd",this,"_onPanEndUpdateHandler")):(this._onPanStartHandler_connect=t(e,"onPanStart",this,"_onPanStartHandler"),this._onPanEndHandler_connect=t(e,"onPanEnd",this,"_onPanEndHandler")),this._onZoomStartHandler_connect=t(e,"onZoomStart",this,"_onZoomStartHandler"),this._onExtentChangeHandler_connect=t(e,"onExtentChange",this,"_onExtentChangeHandler")},_disableDrawConnectors:function(){var e=n.disconnect;e(this._onExtentChangeHandler_connect),e(this._onZoomStartHandler_connect),e(this._onPanHandler_connect),e(this._onPanStartHandler_connect),e(this._onPanEndHandler_connect),this._onExtentChangeHandler_connect=this._onZoomStartHandler_connect=this._onPanHandler_connect=this._onPanStartHandler_connect=this._onPanEndHandler_connect=null},_updateExtent:function(e){var t=e.geometry;if(t){if(!(e._extent=t.getExtent())){var i,n;if("esri.geometry.Point"===t.declaredClass)i=t.x,n=t.y;else{if("esri.geometry.Multipoint"!==t.declaredClass)return void(e._extent=null);i=t.points[0][0],n=t.points[0][1]}e._extent=new T(i,n,i,n,t.spatialReference)}}else e._extent=null},_intersects:function(e,t,i){var n=e.spatialReference,s=t.spatialReference,a=n&&s&&!n.equals(s)&&n._canProject(s)&&4326===s.wkid;if(this._wrap&&!i){var o,h,c,l,_,u,d,p,f,g,v=[],m=e._getFrameWidth(),y=this._srInfo,S=e._clip?e._getAvailExtent():e.extent,b=[],x=t._partwise;if(a&&(S=e.geographicExtent,y=s._getInfo()),h=S._getParts(y),x&&x.length)for(o=[],c=0,u=x.length;c<u;c++)o=o.concat(x[c]._getParts(y));else o=t._getParts(y);for(c=0,u=o.length;c<u;c++)for(f=o[c],l=0,d=h.length;l<d;l++)if((g=h[l]).extent.intersects(f.extent))for(_=0,p=f.frameIds.length;_<p;_++)v.push((g.frameIds[0]-f.frameIds[_])*m);for(c=0,u=v.length;c<u;c++)_=v[c],r.indexOf(v,_)===c&&b.push(_);return b.length?b:null}return(a?e.geographicExtent:e.extent).intersects(t)?[0]:null},_defaultMarker:{type:"simplemarkersymbol",style:"square",size:1,xoffset:0,yoffset:0,angle:0},_draw:function(e,t){if(!this.hasWebGLSurface()&&this._params.drawMode&&this._map&&!this.suspended&&!this._map.__zooming&&!this._resized)try{var i,n,s,r=e._extent,a=!I||this.styling,o=I&&this.dataAttributes,h=e.getDojoShape();if(!e._suspended&&e.visible&&r&&(i=this._intersects(this._map,r,e.geometry._originOnly))&&(n=a?this._getSymbol(e):this._defaultMarker)){if(e._offsets&&e._offsets.join(",")===i.join(",")?s=!0:e._offsets=i,!h||t||!s){var c=e.geometry.type,l={graphic:e},_=e._bgShape,u=a&&!e.symbol?this._getRenderer(e):null,d=u&&u.backgroundFillSymbol;if("point"===c)this._isInvalidShape(n,h)&&this._removeShape(e),e._shape=this._drawPoint(this._div,e.geometry,n,e.getDojoShape(),i,u,e),a&&this._symbolizePoint(e.getDojoShape(),n,u,e);else if("multipoint"===c)this._drawMarkers(e,n,i,u),a&&this._symbolizeMarkers(e,n,u);else{var p,f,g,v,m=n;if(a&&(m=(p="simplemarkersymbol"===n.type||"picturemarkersymbol"===n.type||"textsymbol"===n.type?n:null)?d:n),a&&m&&m.type.indexOf("fillsymbol")>-1&&(v=!(!(f=this._bgGroup)||!p)),_&&!v&&this._removeBgShape(e),m&&(!v&&(this._isInvalidShape(m,e._shape)||e._shape&&e._shape._isCentroidMarker)&&this._removeShape(e,!1),(g=this._drawShape(e,i,f||this._div,v?_:e.getDojoShape()))&&(g._isCentroidMarker=!1),a&&this._symbolizeShape(g,m,u,m===d,e),e[v?"_bgShape":"_shape"]=g),p){(this._isInvalidShape(p,e._shape)||e._shape&&!e._shape._isCentroidMarker)&&this._removeShape(e,!1);var y=e.geometry.getCentroid();(g=y&&this._drawPoint(this._div,y,p,e._shape,i,u,e))&&(g._isCentroidMarker=!0,this._symbolizePoint(g,p,u,e)),e._shape=g}}R||(e._bgShape&&this._initNode(e,e._bgShape,e._bgShape!==_,l,o),e._shape&&this._initNode(e,e._shape,e._shape!==h,l,o)),e._applyDataAttrs(),l.node=e.getNode(),this.onGraphicDraw(l)}}else h&&this._removeShape(e)}catch(t){this._errorHandler(t,e)}},_initNode:function(e,t,i,n,s){var r=t&&t.getNode();r&&(r.e_graphic=e,this._addDataAttrs(e,s,r),i&&(n.node=r,this.onGraphicNodeAdd(n)))},_removeShape:function(e,t,i){var n=e.getDojoShape(),s=n&&n.getNode();n&&!i&&(n.removeShape(),n.destroy()),e._shape=e._offsets=null,!1!==t&&this._removeBgShape(e,i),s&&(s.e_graphic=null,R||this.onGraphicNodeRemove({graphic:e,node:s}))},_removeBgShape:function(e,t){var i=e._bgShape,n=i&&i.getNode();i&&!t&&(i.removeShape(),i.destroy()),e._bgShape=null,n&&(n.e_graphic=null,R||this.onGraphicNodeRemove({graphic:e,node:n}))},_addDataAttrs:function(e,t,i){var n,s,r,a=e.attributes,o=t?t.length:0,h=this._getRenderer(e);if(i&&a){for(s=0;s<o;s++)(n=t[s])&&e.attr("data-"+n,a[n]);!this.styling&&h&&(h.getBreakIndex?(r=h.getBreakIndex(e),e.attr("data-class-break",-1!==r?r:null)):h.getUniqueValueInfo&&(r=h.getUniqueValueInfo(e),e.attr("data-unique-value",r?r.value:null)))}},_drawShape:function(e,t,i,n){var s,r,a,o,h,c,l=e.geometry,_=l.type,u=this._map,d=u.extent,p=u.width,f=u.height,g=u.__visibleRect,v=[],m="extent"===_;if("rect"===_||m)(o={x:0,y:0,spatialReference:l.spatialReference}).x=m?l.xmin:l.x,o.y=m?l.ymax:l.y,h=L.toScreenPoint(d,p,f,o),o.x=m?l.xmax:l.x+l.width,o.y=m?l.ymin:l.y+l.height,c=L.toScreenPoint(d,p,f,o),0===(a={x:h.x-g.x+t[0],y:h.y-g.y,width:Math.abs(c.x-h.x),height:Math.abs(c.y-h.y)}).width&&(a.width=1),0===a.height&&(a.height=1),n=this._drawRect(i,n,a);else if("polyline"===_||"polygon"===_){for(s=0,r=t.length;s<r;s++)v=v.concat(L._toScreenPath(d,p,f,l,-g.x+t[s],-g.y));n=this._drawPath(i,n,v),this._rendererLimits&&("polyline"===_?this._clipPolyline(n,l):this._clipPolygon(n,l))}return n},_drawRect:function(e,t,i){return t?t.setShape(i):e.createRect(i)},_drawImage:function(e,t,i){return t?t.setShape(i):e.createImage(i)},_drawCircle:function(e,t,i){return t?t.setShape(i):e.createCircle(i)},_drawPath:D?function(e,t,i,n){if(i=n?i:i.join(" "),t)return t.setShape(i);var s=e.createObject(n?_.Path:_.EsriPath,i);return e._overrideSize(s.getEventSource()),s}:function(e,t,i,n){return i=n?i:i.join(" "),t?t.setShape(i):e.createPath(i)},_drawText:function(e,t,i){return t?t.setShape(i):e.createText(i)},_evalSDRenderer:function(e){var t,i=this._map,n=this.renderer,s=this._rndForScale;i&&i.loaded&&n&&n.getRendererInfo&&(t="zoom"===n.rangeType?n.getRendererInfoByZoom(i.getZoom()):n.getRendererInfoByScale(i.getScale())),this._rndForScale=t&&t.renderer,e||this._rndForScale==s||this.emit("renderer-change",{renderer:this._rndForScale})},_getRenderer:function(e){var t=this._rndForScale||this.renderer;return e&&t&&t.getObservationRenderer&&(t=t.getObservationRenderer(e)),t},_getSymbol:function(e){var t=this._getRenderer();return e.symbol||t&&t.getSymbol(e)},_getVariable:function(e,t,i){var n,s;return e&&(s=(n=e.getVisualVariablesForType(t,i))&&n[0]),s},_applyOpacity:function(e,t,i,n){var s=t.getOpacity(n,{opacityInfo:i});return null!=s&&((e=new S(e)).a=s),e},_symbolizeShape:function(e,t,i,n,r){var a,o,h=t.getStroke(),c=t.getFill(),l=t.type,_=-1!==l.indexOf("linesymbol"),u=-1!==l.indexOf("fillsymbol")?null:this._getVariable(i,"sizeInfo",!1),d=this._getVariable(i,"colorInfo",!1),p=this._getVariable(i,"opacityInfo",!1),f=_?"none"!==t.style:t.outline&&"none"!==t.outline.style,g=_?null:this._getVariable(i,"sizeInfo","outline"),v=n?g:g||u,m=v?i.getSize(r,{sizeInfo:v,resolution:this._map.getResolutionInMeters(),scale:this._map.getScale()}):null;n&&(d=p=null),(d||p)&&"picturefillsymbol"!==l&&(_?(a=h&&h.color,d&&(a=i.getColor(r,{colorInfo:d})||a),a&&p&&(a=this._applyOpacity(a,i,p,r))):c&&c.toCss&&(o=c,d&&(o=i.getColor(r,{colorInfo:d})||o),o&&p&&(o=this._applyOpacity(o,i,p,r)))),e.setStroke(!f||null==m&&!a?h:s.mixin({},h,null!=m?{width:m}:null,a&&{color:a})).setFill(o||c),_&&E.applyLineMarker(e,t,a,this._acquireSVGMarker)},_smsToPath:D?function(e,t,i,n,s,r,a,o,h){switch(t){case e.STYLE_SQUARE:return["M",s+","+a,"L",r+","+a,r+","+o,s+","+o,"X","E"];case e.STYLE_CROSS:return["M",i+","+a,"L",i+","+o,"M",s+","+n,"L",r+","+n,"E"];case e.STYLE_X:return["M",s+","+a,"L",r+","+o,"M",s+","+o,"L",r+","+a,"E"];case e.STYLE_DIAMOND:return["M",i+","+a,"L",r+","+n,i+","+o,s+","+n,"X","E"];case e.STYLE_TARGET:return["M",s+","+a,"L",r+","+a,r+","+o,s+","+o,s+","+a,"M",s-h+","+n,"L",s+","+n,"M",i+","+(a-h),"L",i+","+a,"M",r+h+","+n,"L",r+","+n,"M",i+","+(o+h),"L",i+","+o,"E"]}}:function(e,t,i,n,s,r,a,o,h){switch(t){case e.STYLE_SQUARE:return["M",s+","+a,r+","+a,r+","+o,s+","+o,"Z"];case e.STYLE_TRIANGLE:return["M",i+","+a,r+","+o,s+","+o,"Z"];case e.STYLE_CROSS:return["M",i+","+a,i+","+o,"M",s+","+n,r+","+n];case e.STYLE_X:return["M",s+","+a,r+","+o,"M",s+","+o,r+","+a];case e.STYLE_DIAMOND:return["M",i+","+a,r+","+n,i+","+o,s+","+n,"Z"];case e.STYLE_TARGET:var c=["M",s+","+a,r+","+a,r+","+o,s+","+o,s+","+a];return h&&c.push("M",s-h+","+n,s+","+n,"M",i+","+(a-h),i+","+a,"M",r+h+","+n,r+","+n,"M",i+","+(o+h),i+","+o),c}},_pathStyles:{square:1,cross:1,x:1,diamond:1,target:1},_typeMaps:{picturemarkersymbol:"image",picturefillsymbol:"path",simplefillsymbol:"path",simplelinesymbol:"path",cartographiclinesymbol:"path",textsymbol:"text"},_isInvalidShape:function(e,t){var i=t&&t.shape&&t.shape.type,n=e&&e.type,s=e&&e.style;return"rect"===i&&(i="path"),n&&(s=this._typeMaps[n]||s),this._pathStyles[s]&&(s="path"),"shieldlabelsymbol"===n||!(!i||!s||i===s)},_reArialFont:/\s*(^|,)\s*arial\s*(,|$)\s*/i,_fallbackFont:"Arial",_drawPoint:function(e,t,i,n,s,r,a){var o,h,c,l,_=i.type,d=this._map,p=d.__visibleRect,f=L.toScreenPoint(d.extent,d.width,d.height,t).offset(-p.x+s[0],-p.y),g=f.x,v=f.y,m=[],y=this._getVariable(r,"rotationInfo",!1),S=y?r.getRotationAngle(a,{rotationInfo:y}):null,b=this._getVariable(r,"sizeInfo",!1),x=null!=a.size?a.size:b&&r.getSize(a,{sizeInfo:b,shape:i.style,resolution:d.getResolutionInMeters(),scale:d.getScale()});if(S&&m.push(u.rotategAt(S,f)),0===i.xoffset&&0===i.yoffset||(l=u.translate(i.xoffset,-i.yoffset),m.push(l)),0!==i.angle&&m.push(u.rotategAt(i.angle,f)),"simplemarkersymbol"===_){var E,M=i.style,P=Math.round;switch(null!=x?l&&(null!=l.dx&&(l.dx=x*(l.dx/i.size)),null!=l.dy&&(l.dy=x*(l.dy/i.size))):x=i.size,M){case w.STYLE_SQUARE:case w.STYLE_TRIANGLE:case w.STYLE_CROSS:case w.STYLE_X:case w.STYLE_DIAMOND:E=isNaN(x)?16:x/2,o=this._drawPath(e,n,this._smsToPath(w,M,g,v,P(g-E),P(g+E),P(v-E),P(v+E)));break;case w.STYLE_TARGET:var T=i._targetWidth/2,G=i._targetHeight/2;o=this._drawPath(e,n,this._smsToPath(w,M,g,v,P(g-T),P(g+T),P(v-G),P(v+G),i._spikeSize));break;case w.STYLE_PATH:var C=(o=this._drawPath(e,n,i.path,!0)).getBoundingBox(),k=this._getScaleMatrix(C,x);1===k.xx&&1===k.yy||m.push(u.scaleAt(k.xx,k.yy,f)),m.push(u.translate(-(C.x+C.width/2)+g,-(C.y+C.height/2)+v));break;default:E=isNaN(x)?16:x/2,o=this._drawCircle(e,n,{cx:g,cy:v,r:E})}}else if("shieldlabelsymbol"===_){h=i.width,c=i.height;var H=e.createGroup(),D=e.createImage({x:g-h/2,y:v-c/2,width:h,height:c,src:i.url});if(H.add(D),null!=i.font){var O=g,A=v+.2*i.getHeight(),F=e.createText({type:"text",text:i.text,x:O,y:A,align:"middle",decoration:i.decoration,rotated:i.rotated,kerning:i.kerning});F.setFont(i.font),F.setFill(i.color),H.add(F)}o=H}else if("picturemarkersymbol"===_){if(null==x?(h=i.width,c=i.height):(h=(c=x)*(i.width/i.height),l&&(null!=l.dx&&(l.dx=h*(l.dx/i.width)),null!=l.dy&&(l.dy=c*(l.dy/i.height)))),o=this._drawImage(e,n,{x:g-h/2,y:v-c/2,width:h,height:c,src:i.url}),I)if(B=o.getNode()){var N=this._getVariable(r,"opacityInfo",!1),W=N?r.getOpacity(a,{opacityInfo:N}):null;null!=W?B.setAttribute("opacity",W):B.setAttribute("opacity",1)}}else if("textsymbol"===_){var V=i.font;if(V){var z=null!=x,j=V.family&&!this._reArialFont.test(V.family);(z||j||R)&&(V=new V.constructor(V.toJson())),z&&V.setSize(x),R&&(V.size=V.size+"px"),j&&V.setFamily(V.family+","+this._fallbackFont)}if(o=this._drawText(e,n,{type:"text",text:i.text,x:g,y:v,align:i.getSVGAlign(),decoration:i.decoration||V&&V.decoration,rotated:i.rotated,kerning:i.kerning}),V&&o.setFont(V),I){var B=o.getNode(),U=i.getSVGBaseline(),Y=i.getSVGBaselineShift();B&&(B.setAttribute("dominant-baseline",U),Y&&B.setAttribute("baseline-shift",Y),this._applyHalo(o,i.haloColor,i.haloSize))}}return o.setTransform(u.multiply(m)),o._wrapOffsets=s,o},_acquireSVGMarker:function(e,t,i,n){var s=this._getSVGMarkerId(t,n),r=this._getSVGMarker(s);return r||(r=E.createSVGMarker(t,s,i,n),this._div.getParent().defNode.appendChild(r),this._lineMarkers[s]=r),r},_getSVGMarkerId:function(e,t){return"marker_"+this._map.id+"_"+e.r+"_"+e.g+"_"+e.b+"_"+t},_getSVGMarker:function(e){return this._lineMarkers[e]},_updateSVGMarkers:function(){if(I&&F){var e=this._lineMarkers;for(var t in e){var i=e[t];i.setAttribute("id",t+"_temp"),i.setAttribute("id",t)}}},_applyHalo:function(e,t,i){var n=t&&i?this._getHaloId(t,i):null;e.setFilter(t&&i?y("webkit")||y("ff")?this._getDilateFilter(t,i,n):this._getOffsetFilter(t,i,n):null)},_getDilateFilter:function(e,t,i){var n=this._getSVGFilter(i);return n||(n=this._createSVGFilter({id:i},[d.feMorphology({operator:"dilate",radius:t,result:"dilated"}),d.feFlood({"flood-color":e.toCss(!0)}),d.feComposite({in2:"dilated",operator:"in",result:"composite"}),d.feMerge("composite","SourceGraphic")])),n},_getOffsetFilter:function(e,t,i){var n=this._getSVGFilter(i);if(!n){var s,r=e.toCss(!0),a=this._offsetPrimitives,o=a.length,h=[],c=[];for(s=0;s<o;s++){var l=a[s],_="offset"+l.dir,u="composite"+l.dir;c.push(u),h.push(d.feOffset({dx:l.dx*t,dy:l.dy*t,in:"SourceAlpha",result:_}),d.feFlood({"flood-color":r}),d.feComposite({in2:_,operator:"in",result:u}))}c.push("SourceGraphic"),h.push(d.feMerge.apply(d.feMerge,c)),n=this._createSVGFilter({id:i},h)}return n},_offsetPrimitives:[{dir:"L",dx:-1,dy:0},{dir:"TL",dx:-1,dy:-1},{dir:"T",dx:0,dy:-1},{dir:"TR",dx:1,dy:-1},{dir:"R",dx:1,dy:0},{dir:"BR",dx:1,dy:1},{dir:"B",dx:0,dy:1},{dir:"BL",dx:-1,dy:1}],_getHaloId:function(e,t){return"halo_"+this._map.id+"_"+this.id+"_"+e.r+"_"+e.g+"_"+e.b+"_"+e.a+"_"+t},_getSVGFilter:function(e){return this._svgFilters[e]},_createSVGFilter:function(e,t){var i=d.createFilter(e,t),n=this._map,s=n.__visibleRect;return i.x=-s.x,i.y=-s.y,i.width=n.width,i.height=n.height,this._svgFilters[e.id]=i,i},_updateSVGFilters:function(e,t,i,n){var s,r,a,o=this._svgFilters;for(r in o)(s=o[r])&&((a=l.byId(r))&&(null!=e&&a.setAttribute("x",e),null!=t&&a.setAttribute("y",t),null!=i&&a.setAttribute("width",i),null!=n&&a.setAttribute("height",n)),null!=e&&(s.x=e),null!=t&&(s.y=t),null!=i&&(s.width=i),null!=n&&(s.height=n))},_getScaleMatrix:function(e,t){var i=e.width/e.height,n=1,s=1;return isNaN(t)||(i>1?(n=t/e.width,s=t/i/e.height):(s=t/e.height,n=t*i/e.width)),{xx:n,yy:s}},_symbolizePoint:function(e,t,i,n){var r=t.type,a=t.style;if("shieldlabelsymbol"!==r&&"picturemarkersymbol"!==r){var o=t.getStroke(),h=t.getFill(),c=a===w.STYLE_X||a===w.STYLE_CROSS,l=o&&o.color,_=c?l:h;if(i){var u=this._getVariable(i,"colorInfo",!1),d=this._getVariable(i,"opacityInfo",!1);u&&(_=i.getColor(n,{colorInfo:u})||_),_&&d&&(_=this._applyOpacity(_,i,d,n)),_&&(c?_!==l&&((o=o?s.mixin({},o):{}).color=_):_!==h&&(h=_))}"textsymbol"===r?e.setFill(h):"simplemarkersymbol"===r&&e.setFill(h).setStroke(o)}},_drawMarkers:function(e,t,i,n){var s,r,a,o=e.geometry,h=o.points,c=e.getDojoShape()||this._div.createGroup(),l=h.length,_=[],u=0,d=i?i.length:0;for(c.children[0]&&this._isInvalidShape(t,c.children[0])&&c.clear(),r=0;r<l;r++)for(s=h[r],a=0;a<d;a++)_[0]=i[a],this._drawPoint(c,{x:s[0],y:s[1],spatialReference:o.spatialReference},t,c.children[u++],_,n,e);var p=c.children.length;if(l*i.length<p)for(r=p-1;r>=l*i.length;r--)c.children[r].removeShape();e._shape=c},_symbolizeMarkers:function(e,t,i){var n,s=e.getDojoShape().children,r=s.length;for(n=0;n<r;n++)this._symbolizePoint(s[n],t,i,e)},_errorHandler:function(e,t){t&&(e.message="Unable to draw graphic (geometry:"+(t.geometry?t.geometry.declaredClass:null)+", symbol:"+(t.symbol?t.symbol.declaredClass:null)+"): "+e.message),this.inherited(arguments)},_rendererLimits:function(){var e,t,i;if(D?(e=1e5,t=-1e5,i=1e5):y("chrome")&&y("chrome")<6&&(e=8150,t=-1e4,i=1e4),e)return{clipLimit:e,rangeMin:t,rangeMax:i,clipBBox:[-e,-e,e,e],clipSegments:[[[-e,-e],[e,-e]],[[e,-e],[e,e]],[[e,e],[-e,e]],[[-e,e],[-e,-e]]]}}(),_clipPolyline:function(e,t){var i=this._getCorners(e,t),n=i.tl,s=i.br,a=this._rendererLimits,o=a.rangeMin,h=a.rangeMax,c=a.clipBBox,l=a.clipSegments,_=this._isPointWithinRange,u=this._isPointWithinBBox,d=this._getClipperIntersection,p=this._getPlaneIndex;if(!_(n,o,h)||!_(s,o,h)){D&&this._createSegments(e);var f=[];r.forEach(e.segments,(function(e){var t,i=e.args,n=i.length,s=[];for(t=0;t<n;t+=2){var r=[i[t],i[t+1]],a=[i[t+2],i[t+3]],o=u(r,c);if(o^u(a,c)){var h=d([r,a],l);h&&(o?(t?s.push(h[1]):s.push(r,h[1]),f.push(s),s=[]):s.push(h[1],a))}else if(o)t?s.push(a):s.push(r,a);else{var _=p(r,c),g=p(a,c);if(-1===_||-1===g||_===g)continue;var v=d([r,a],l,!0);if(v.length>0){v[_]||(_=v[_[0]]?_[0]:_[1]),v[g]||(g=v[g[0]]?g[0]:g[1]);var m=v[_],y=v[g];m&&s.push(m),y&&(s.push(y),f.push(s),s=[])}}}f.push(s)})),e.setShape(this._getPathStringFromPaths(f))}},_clipPolygon:function(e,t){var i=this._getCorners(e,t),n=i.tl,a=i.br,o=this._rendererLimits,h=o.clipLimit,c=o.rangeMin,l=o.rangeMax,_=o.clipBBox,u=o.clipSegments,d=this._isPointWithinRange,p=this._isPointWithinBBox,f=this._getClipperIntersection,g=this._getPlaneIndex,v=G._pointLineDistance;if(!d(n,c,l)||!d(a,c,l)){D&&this._createSegments(e);var m=r.filter(e.segments,(function(e){return e.args&&e.args.length})),y=r.map(m,(function(e){var t,i=e.args,n=i.length,a=[],o=[];for(t=0;t<n;t+=2){var c=[i[t],i[t+1]],l=[i[t+2],i[t+3]];if(t===n-2){a.push(c);break}var d,m=p(c,_),y=p(l,_);if(a.push(c),m^y){if(d=f([c,l],u)){var S=d[1];S[m?"inOut":"outIn"]=!0,a.push(S),o.push([m?"INOUT":"OUTIN",a.length-1,d[0]])}}else if(!m){var b=g(c,_),x=g(l,_);if(-1===b||-1===x||b===x)continue;if((d=f([c,l],u,!0)).length>0){d[b]||(b=d[b[0]]?b[0]:b[1]),d[x]||(x=d[x[0]]?x[0]:x[1]);var w=d[b],E=d[x];w&&(w.outIn=!0,a.push(w),o.push(["OUTIN",a.length-1,b])),E&&(E.inOut=!0,a.push(E),o.push(["INOUT",a.length-1,x]))}else if(s.isArray(b)&&s.isArray(x)){var M=b.concat(x);if(M.sort(),"0123"===M.join("")){var P=[];b[0]+b[1]===3?P.push([h,-h],[-h,h]):P.push([-h,-h],[h,h]);var T=v(P[0],[c,l]),G=v(P[1],[c,l]);a.push(T<G?P[0]:P[1])}}}}var L=_[0],C=_[1],k=_[2],I=_[3];r.forEach(a,(function(e){e[0]<L&&(e[1]>=C&&e[1]<=I?e[0]=L:(e[0]=L,e[1]=e[1]<C?C:I))})),r.forEach(a,(function(e){e[1]<C&&(e[0]>=L&&e[0]<=k?e[1]=C:(e[1]=C,e[0]=e[0]<L?L:k))})),r.forEach(a,(function(e){e[0]>k&&(e[1]>=C&&e[1]<=I?e[0]=k:(e[0]=k,e[1]=e[1]<C?C:I))})),r.forEach(a,(function(e){e[1]>I&&(e[0]>=L&&e[0]<=k?e[1]=I:(e[1]=I,e[0]=e[0]<L?L:k))}));var R,H,D=0;if((n=o.length)>0)do{if(R=o[D],H=o[(D+1)%n],R[2]===H[2]&&"INOUT"===R[0]&&"OUTIN"===H[0]){var O,A=R[1],F=H[1];if(A<F)for(O=A+1;O<F;O++)a[O][2]=!0;else if(A>F){for(O=A+1;O<a.length;O++)a[O][2]=!0;for(O=0;O<F;O++)a[O][2]=!0}}D=(D+1)%n}while(0!==D);var N,W=a[0],V=a[a.length-1];for(W[2]&&(V[2]=!0,r.some(o,(function(e){return 1===e[1]&&(a.splice(a.length-1,0,s.clone(a[1])),!0)}))),a=r.filter(a,(function(e){return!e[2]})),D=0;D<a.length-1;D++)N=a[D],(H=a[D+1])&&N[0]===H[0]&&N[1]===H[1]&&(H.outIn?N.outIn=!0:H.inOut&&(N.inOut=!0),a.splice(D+1,1));var z=Math.abs,j=[];for(D=0;D<a.length-1;D++){var B=(R=a[D])[0],U=R[1],Y=z(B)===h,q=z(U)===h,Z=(H=a[D+1])[0],X=H[1],Q=z(Z)===h,J=z(X)===h;Y&&J?j.push([D+1,[B,X]]):q&&Q&&j.push([D+1,[Z,U]])}for(D=j.length-1;D>=0;D--){var $=j[D],K=a[$[0]-1];N=a[$[0]],K.outIn||K.inOut||N.outIn||N.inOut||a.splice($[0],0,$[1])}return W=a[0],V=a[a.length-1],W[0]===V[0]&&W[1]===V[1]||a.push(W),a}));e.setShape(this._getPathStringFromPaths(y))}},_getCorners:function(e,t){if(D){var i=this._map,n=t.getExtent(),s=n.spatialReference;return{tl:i.toScreen(new M(n.xmin,n.ymax,s)),br:i.toScreen(new M(n.xmax,n.ymin,s))}}var r=e.getTransformedBoundingBox();return{tl:r[0],br:r[2]}},_createSegments:function(e){e.shape.path=e.vmlPath,e.segmented=!1,e._confirmSegmented();var t=e.segments;t.length>1&&(e.segments=r.filter(t,(function(e,t,i){var n=i[t+1];return!("M"!==e.action||!n||"L"!==n.action)&&(e.args=e.args.concat(n.args),!0)})))},_getPathStringFromPaths:function(e){return D?(e=r.map(e,(function(e){return"m "+r.map(e,(function(e,t){return(1===t?"l ":"")+e.join(",")})).join(" ")}))).push("e"):e=r.map(e,(function(e){return"M "+r.map(e,(function(e){return e.join(",")})).join(" ")})),e.join(" ")},_isPointWithinBBox:function(e,t){var i=t[0],n=t[1],s=t[2],r=t[3],a=e[0],o=e[1];return a>i&&a<s&&o>n&&o<r},_isPointWithinRange:function(e,t,i){var n=e.x,s=e.y;return!(n<t||s<t||n>i||s>i)},_getClipperIntersection:function(e,t,i){var n,s=G._getLineIntersection2,r=Math.round,a={length:0};for(n=0;n<4;n++){var o=s(e,t[n]);if(o){if(o[0]=r(o[0]),o[1]=r(o[1]),!i)return[n,o];a[n]=o,a.length++}}return i?a:null},_getPlaneIndex:function(e,t){var i=e[0],n=e[1],s=t[0],r=t[1],a=t[2],o=t[3];return i<=s?n>=r&&n<=o?3:n<r?[0,3]:[2,3]:n<=r?i>=s&&i<=a?0:i<s?[3,0]:[1,0]:i>=a?n>=r&&n<=o?1:n<r?[0,1]:[2,1]:n>=o?i>=s&&i<=a?2:i<s?[3,2]:[1,2]:-1},onGraphicAdd:function(){},onGraphicRemove:function(){},onGraphicNodeAdd:function(){},onGraphicNodeRemove:function(){},onGraphicDraw:function(){},onGraphicsClear:function(){},onRendererChange:function(){},onOpacityChange:function(){},onInfoTemplateChange:function(){},onSurfaceChange:function(){},onWebGLEnabledChange:function(){},setInfoTemplate:function(e){this.infoTemplate=e,this._evalSurfaceType(),this.onInfoTemplateChange()},add:function(e,t){return e._graphicsLayer===this?e:(e._suspended=this._suspendGraphics,t||this.graphics.push(e),e._graphicsLayer=this,e._sourceLayer||(e._layer&&"esri.layers.GraphicsLayer"!==e._layer.declaredClass?e._sourceLayer=e._layer:"esri.layers.GraphicsLayer"!==this.declaredClass&&(e._sourceLayer=this)),e._layer=this,this.hasWebGLSurface()||(this._updateExtent(e),this._draw(e)),t||this.onGraphicAdd(e),e)},remove:function(e,t,i){if(!t&&!i){var n,s=this.graphics;if(-1===(n=r.indexOf(s,e)))return null;!function(e,t){if(!W||W>=64)return e.splice(t,1);var i=e.length;if(i){for(;t<i;)e[t]=e[t+1],t++;e.length--}}(s,n)}return this.hasWebGLSurface()||e.getDojoShape()&&this._removeShape(e,null,i),e._shape=e._graphicsLayer=null,this.onGraphicRemove(e),e},clear:function(){var e,t=arguments[1],i=this.graphics,n=i.length,s=!D;for(e=n-1;e>=0;e--)this.remove(i[e],null,s);this.graphics=[],this.hasWebGLSurface()||this._destroyAllNodes(),t||this.onGraphicsClear()},_destroyAllNodes:function(){var e;!D&&this._div&&(this._childLayer&&(e=this._childLayer.getNode())&&e.parentNode&&e.parentNode.removeChild(e),this._bgGroup.clear(),this._div.clear(),this._bgGroup=this._div.createGroup(),e&&this._div.getEventSource().appendChild(e),this._initOpacity())},clearNodes:function(){if(!this.hasWebGLSurface()){var e,t=this.graphics,i=t.length;for(e=0;e<i;e++)this._removeShape(t[e],!0,!0);this._destroyAllNodes()}},_graphicVisibilityChanged:function(e){},_setIEOpacity:function(e,t){var i=e&&e.getNode();if(i){var n=e.strokeStyle,s=i.stroke;n&&s&&(s.opacity=n.color.a*t);var r=e.fillStyle,a=i.fill;r&&a&&("tile"===a.type?c.set(i,"opacity",t):a.opacity=r.a*t)}},setOpacity:function(e,t){if(t||this.opacity!=e){var i=this._div;i&&!this.hasWebGLSurface()&&(D?(r.forEach(this.graphics,(function(t){this._setIEOpacity(t._shape,e),this._setIEOpacity(t._bgShape,e)}),this),i._esriIeOpacity=e,this._bgGroup._esriIeOpacity=e):"canvas-2d"===this.surfaceType?c.set(i.getEventSource(),"opacity",e):i.getEventSource().setAttribute("opacity",e)),this.opacity=e,t||this.onOpacityChange(e)}},setRenderer:function(e){this.renderer=e,this._evalSDRenderer(!0),this._evalSurfaceType(),this.emit("renderer-change",{renderer:this._rndForScale||e})}});var U=t([k,C],{declaredClass:"esri.layers.GraphicsLayer",constructor:function(){this._processEvent=s.hitch(this,this._processEvent),this._initLayer()},_initLayer:function(){this.loaded=!0,this.onLoad(this)},_setMap:function(){var e=this.inherited("_setMap",arguments);return this.enableMouseEvents(),e},_unsetMap:function(){this.disableMouseEvents(),this.inherited("_unsetMap",arguments)},_processEvent:function(e){var t,i=this._map,n=e.target;for(e.screenPoint=new P(e.pageX-i.position.x,e.pageY-i.position.y),e.mapPoint=i.toMap(e.screenPoint);n&&!(t=n.e_graphic);)n=n.parentNode;if(t)return e.graphic=t,e},_onMouseOverHandler:function(e){this._processEvent(e)&&this.onMouseOver(e)},_onMouseMoveHandler:function(e){this._processEvent(e)&&this.onMouseMove(e)},_onMouseDragHandler:function(e){this._processEvent(e)&&this.onMouseDrag(e)},_onMouseOutHandler:function(e){this._processEvent(e)&&this.onMouseOut(e)},_onMouseDownHandler:function(e){this._downGr=this._downPt=null,this._processEvent(e)&&(n.disconnect(this._onmousemove_connect),n.disconnect(this._onmousedrag_connect),this._onmousedrag_connect=n.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseDragHandler"),this._downGr=e.graphic,this._downPt=e.screenPoint.x+","+e.screenPoint.y,this.onMouseDown(e))},_onMouseUpHandler:function(e){this._upGr=this._upPt=null,this._processEvent(e)&&(n.disconnect(this._onmousedrag_connect),n.disconnect(this._onmousemove_connect),this._onmousemove_connect=n.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseMoveHandler"),this._upGr=e.graphic,this._upPt=e.screenPoint.x+","+e.screenPoint.y,this.onMouseUp(e))},_onClickHandler:function(e){if(this._processEvent(e)){var t=this._downGr,i=this._upGr;t&&i&&t===i&&this._downPt===this._upPt&&(D&&(v._ieGraphic=e.graphic),this.onClick(e))}},_onDblClickHandler:function(e){this._processEvent(e)&&this.onDblClick(e)},onMouseOver:function(){},onMouseMove:function(){},onMouseDrag:function(){},onMouseOut:function(){},onMouseDown:function(){},onMouseUp:function(){},onClick:function(){},onDblClick:function(){},enableMouseEvents:function(){if(!this._mouseEvents){var e=n.connect,t=this._div.getEventSource();R||(this._onmouseover_connect=e(t,"onmouseover",this,"_onMouseOverHandler"),this._onmousemove_connect=e(t,"onmousemove",this,"_onMouseMoveHandler"),this._onmouseout_connect=e(t,"onmouseout",this,"_onMouseOutHandler"),this._onmousedown_connect=e(t,"onmousedown",this,"_onMouseDownHandler"),this._onmouseup_connect=e(t,"onmouseup",this,"_onMouseUpHandler"),this._onclick_connect=e(t,"onclick",this,"_onClickHandler"),this._ondblclick_connect=e(t,"ondblclick",this,"_onDblClickHandler")),this._mouseEvents=!0}},disableMouseEvents:function(){if(this._mouseEvents){var e=n.disconnect;e(this._onmouseover_connect),e(this._onmousemove_connect),e(this._onmousedrag_connect),e(this._onmouseout_connect),e(this._onmousedown_connect),e(this._onmouseup_connect),e(this._onclick_connect),e(this._ondblclick_connect),this._mouseEvents=!1}}});return U._GraphicsContainer=B,U._GraphicsLayer=k,y("extend-esri")&&(s.setObject("layers.GraphicsLayer",U,v),s.setObject("layers._GraphicsContainer",B,v),s.setObject("layers._GraphicsLayer",k,v)),U}));
