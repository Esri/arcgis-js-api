// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/dom-attr","dojo/dom-construct","dojo/dom-style","dojox/gfx","dojox/gfx/matrix","./layer","../kernel","../lang","../sniff","../Color","../domUtils","../symbols/MarkerSymbol","../symbols/SimpleMarkerSymbol","../geometry/Point","../geometry/ScreenPoint","../geometry/Extent","../geometry/mathUtils","../geometry/screenUtils","../PluginTarget"],function(e,t,n,i,r,s,o,a,h,c,l,_,u,d,p,g,f,m,v,y,S,x,b){var w,E=-1!==a.renderer.toLowerCase().indexOf("svg"),P=-1!==a.renderer.toLowerCase().indexOf("canvas"),M=u("ie")<9,I=u("esri-touch"),R=e(null,{declaredClass:"esri.layers._GraphicsContainer",_setMap:function(e,n){var i,r=this._connects=[];if(this._map=e,P)i=s.create("div",{style:"overflow: visible; position: absolute;"},n),this._surface={getEventSource:function(){return i}},r.push(t.connect(i,"onmousedown",this,this._canvasDownHandler)),r.push(t.connect(i,"onmouseup",this,this._canvasUpHandler)),r.push(t.connect(i,"onclick",this,this._canvasClickHandler)),w.prototype._canvas=!0;else{var h=this._surface=a.createSurface(n,e.width,e.height);i=h.getEventSource(),o.set(i=M?i.parentNode:i,{overflow:"visible",position:"absolute"})}return r.push(t.connect(e,"onResize",this,"_onResizeHandler")),i},_onResizeHandler:function(e,t,n){var s,a=this._surface.getEventSource(),h=this._map;M&&o.set(a=a.parentNode,{width:t+"px",height:n+"px",clip:"rect(0px "+t+"px "+n+"px 0px)"}),r.set(a,"width",t),r.set(a,"height",n),this._surface.declaredClass||i.forEach(a.childNodes,function(e){r.set(e,"width",t),r.set(e,"height",n)}),h.loaded&&(h.graphics.suspended||(h.graphics._resized=!0),i.forEach(h.graphicsLayerIds,function(e){s=h.getLayer(e),s.suspended||(s._resized=!0)}))},_cleanUp:function(){i.forEach(this._connects,t.disconnect,t),this._map=this._surface=null},_processEvent:function(e){var t=this._map;e.screenPoint=new v(e.pageX-t.position.x,e.pageY-t.position.y),e.mapPoint=t.toMap(e.screenPoint)},_canvasDownHandler:function(e){this._processEvent(e),this._downPt=e.screenPoint.x+","+e.screenPoint.y},_canvasUpHandler:function(e){this._processEvent(e),this._upPt=e.screenPoint.x+","+e.screenPoint.y},_tolerance:15,_isPrimaryMatch:function(e,t,n,r){if(!e.visible||!t)return!1;var s,o=t.getTransformedBoundingBox();return o?(s=new y(o[0].x,o[0].y,o[2].x,o[2].y),delete s.spatialReference,I?s.intersects(n):s.contains(r)):i.some(t.children||[],function(e){return o=e.getTransformedBoundingBox(),s=new y(o[0].x,o[0].y,o[2].x,o[2].y),delete s.spatialReference,I?s.intersects(n):s.contains(r)})},_canvasClickHandler:function(e){if(this._downPt&&this._upPt&&this._downPt===this._upPt){this._processEvent(e);var t=this._map,n=i.map(t.graphicsLayerIds,function(e){return t.getLayer(e)});n.push(t.graphics),n.reverse(),n=i.filter(n,function(e){return e.loaded&&e._mouseEvents&&!e.suspended&&(!_.isDefined(e.opacity)||e.opacity>0)});var r,s=e.screenPoint,o=this._tolerance,a=s.x-o,h=s.y+o,c=s.x+o,l=s.y-o,u=new y(a,l,c,h),d=t.toMap(new v(a,h)),p=t.toMap(new v(c,l)),g=d.spatialReference._getInfo(),f=new y(y.prototype._normalizeX(d.x,g).x,d.y,y.prototype._normalizeX(p.x,g).x,p.y,d.spatialReference);if(delete u.spatialReference,i.some(n,function(e){var t=i.filter(e.graphics,function(e){return this._isPrimaryMatch(e,e.getDojoShape(),u,s)||!(!e._bgShape||!this._isPrimaryMatch(e,e._bgShape,u,s))},this);if(t.reverse(),t.length>0){var n;if(i.some(t,function(e){return e.geometry&&f.intersects(e.geometry)?(n=e,!0):!1}),n)return r=n,!0}return!1},this),r){var m=r.getLayer();m&&(e.graphic=r,m.onClick(e))}}}});w=e(c,{declaredClass:"esri.layers._GraphicsLayer",managedSuspension:!0,surfaceType:P?"canvas-2d":a.renderer,_eventMap:{"graphic-add":["graphic"],"graphic-remove":["graphic"],"renderer-change":["renderer"]},constructor:function(e){e&&(n.isString(e)||n.isObject(e)&&(e.layerDefinition||e.query))&&(e=arguments[1]),this._params=n.mixin({displayOnPan:!0,drawMode:!0,styling:!0},e||{});var t=this._params.dataAttributes;"string"==typeof t&&(t=[t]),this.styling=E?this._params.styling:!0,this.dataAttributes=t,this.infoTemplate=e&&e.infoTemplate,this.graphics=[],this._draw=n.hitch(this,this._draw),this._refresh=n.hitch(this,this._refresh),this.registerConnectEvents()},getNode:function(){return this._div&&this._div.getEventSource()},setDrawMode:function(e){this._params.drawMode=e},renderer:null,_setMap:function(e,t){this.inherited(arguments),this._map=e,this._wrap=e.wrapAround180,this._srInfo=e.spatialReference._getInfo(),this._canvas?(t=a.createSurface(t.getEventSource(),e.width,e.height),o.set(t.rawNode,"position","absolute"),this._div=t.createGroup(),this._renderProto=this._div.constructor.prototype._render,this._div._render=n.hitch(this,this._canvasRender)):this._div=t.createGroup(),this._bgGroup=this._div.createGroup(),this._div.getEventSource().id=this.id+"_layer";var i=this.opacity;return _.isDefined(i)&&1>i&&this.setOpacity(i,!0),this._div},_unsetMap:function(e,t){i.forEach(this.graphics,function(e){e._shape=null}),this._canvas?(t=this._div.getParent(),t._parent={},s.destroy(t.rawNode),t.destroy()):(this._div.clear(),t.remove(this._div),s.destroy(this._div.getEventSource())),this._map=this._div=null,clearTimeout(this._wakeTimer),this._wakeTimer=null,this._disableDrawConnectors(),this.inherited(arguments)},_onZoomStartHandler:function(){p.hide(this._div.getEventSource())},_onExtentChangeHandler:function(e,t,n){if(clearTimeout(this._wakeTimer),this._wakeTimer=null,n){var i=this._map.__visibleRect,r=this._div;this._evalSDRenderer(),this._refresh(!0),r.setTransform(h.translate({x:i.x,y:i.y})),this._renderProto&&r.surface.pendingRender?this._dirty=!0:this.suspended||p.show(r.getEventSource())}else this._resized&&(this._refresh(!1),this._resized=!1);this.graphics.length>0&&this.onUpdate()},_canvasRender:function(){var e=this._div;return this._dirty&&(delete this._dirty,this.suspended||p.show(e.getEventSource())),this._renderProto.apply(e,arguments)},_refresh:function(e){var t,n=this.graphics,i=n.length,r=this._draw;for(t=0;i>t;t++)r(n[t],e)},refresh:function(){this._refresh(!0)},redraw:function(){this._refresh(!0)},_onPanHandler:function(e,t){this._panDx=t.x,this._panDy=t.y;var n=this._map.__visibleRect;this._div.setTransform(h.translate({x:n.x+t.x,y:n.y+t.y}))},_onPanEndUpdateHandler:function(e,t){if(!this._params._child&&(t.x!==this._panDx||t.y!==this._panDy)){var n=this._map.__visibleRect;this._div.setTransform(h.translate({x:n.x,y:n.y}))}this._refresh(!1),this.graphics.length&&this.onUpdate()},_onPanStartHandler:function(){p.hide(this._div.getEventSource())},_onPanEndHandler:function(){var e=this._map.__visibleRect,t=this._div;t.setTransform(h.translate({x:e.x,y:e.y})),this._refresh(!1),this._renderProto&&t.surface.pendingRender?this._dirty=!0:p.show(t.getEventSource()),this.graphics.length&&this.onUpdate()},onSuspend:function(){this.inherited(arguments),p.hide(this._div.getEventSource()),clearTimeout(this._wakeTimer),this._wakeTimer=null,this._disableDrawConnectors()},onResume:function(e){this.inherited(arguments),e.firstOccurrence&&this._evalSDRenderer(),this._enableDrawConnectors(),this._wakeTimer=this._wakeTimer||setTimeout(n.hitch(this,function(){this.suspended||this._onExtentChangeHandler(null,null,!0)}),0)},_enableDrawConnectors:function(){var e=this._map,n=t.connect;this._disableDrawConnectors(),this._params.displayOnPan?(this._params._child||(this._onPanHandler_connect=n(e,"onPan",this,"_onPanHandler")),this._onPanEndHandler_connect=n(e,"onPanEnd",this,"_onPanEndUpdateHandler")):(this._onPanStartHandler_connect=n(e,"onPanStart",this,"_onPanStartHandler"),this._onPanEndHandler_connect=n(e,"onPanEnd",this,"_onPanEndHandler")),this._onZoomStartHandler_connect=n(e,"onZoomStart",this,"_onZoomStartHandler"),this._onExtentChangeHandler_connect=n(e,"onExtentChange",this,"_onExtentChangeHandler")},_disableDrawConnectors:function(){var e=t.disconnect;e(this._onExtentChangeHandler_connect),e(this._onZoomStartHandler_connect),e(this._onPanHandler_connect),e(this._onPanStartHandler_connect),e(this._onPanEndHandler_connect),this._onExtentChangeHandler_connect=this._onZoomStartHandler_connect=this._onPanHandler_connect=this._onPanStartHandler_connect=this._onPanEndHandler_connect=null},_updateExtent:function(e){var t=e.geometry;if(!t)return void(e._extent=null);var n=e._extent=t.getExtent();if(!n){var i,r;if("esri.geometry.Point"===t.declaredClass)i=t.x,r=t.y;else{if("esri.geometry.Multipoint"!==t.declaredClass)return void(e._extent=null);i=t.points[0][0],r=t.points[0][1]}e._extent=new y(i,r,i,r,t.spatialReference)}},_intersects:function(e,t,n){var r=e.spatialReference,s=t.spatialReference,o=r&&s&&!r.equals(s)&&r._canProject(s)&&4326===s.wkid;if(this._wrap&&!n){var a,h,c,l,_,u,d,p,g,f,m=[],v=e._getFrameWidth(),y=this._srInfo,S=e._clip?e._getAvailExtent():e.extent,x=[],b=t._partwise;if(o&&(S=e.geographicExtent,y=s._getInfo()),h=S._getParts(y),b&&b.length)for(a=[],c=0,u=b.length;u>c;c++)a=a.concat(b[c]._getParts(y));else a=t._getParts(y);for(c=0,u=a.length;u>c;c++)for(g=a[c],l=0,d=h.length;d>l;l++)if(f=h[l],f.extent.intersects(g.extent))for(_=0,p=g.frameIds.length;p>_;_++)m.push((f.frameIds[0]-g.frameIds[_])*v);for(c=0,u=m.length;u>c;c++)_=m[c],i.indexOf(m,_)===c&&x.push(_);return x.length?x:null}return(o?e.geographicExtent:e.extent).intersects(t)?[0]:null},_defaultMarker:{type:"simplemarkersymbol",style:"square",size:1,xoffset:0,yoffset:0,angle:0},_draw:function(e,t){if(this._params.drawMode&&this._map&&!this.suspended)try{var n,i,r,s=e._extent,o=!E||this.styling,a=E&&this.dataAttributes,h=e.getDojoShape();if(e.visible&&s&&(n=this._intersects(this._map,s,e.geometry._originOnly))&&(i=o?this._getSymbol(e):this._defaultMarker)){if(e._offsets&&e._offsets.join(",")===n.join(",")?r=!0:e._offsets=n,!h||t||!r){var c=e.geometry.type,l={graphic:e},_=e._bgShape,u=o&&!e.symbol?this._getRenderer(e):null,d=u&&u.backgroundFillSymbol;if("point"===c)this._isInvalidShape(i,h)&&this._removeShape(e),e._shape=this._drawPoint(this._div,e.geometry,i,e.getDojoShape(),n,u,e),o&&this._symbolizePoint(e.getDojoShape(),i,u,e);else if("multipoint"===c)this._drawMarkers(e,i,n,u),o&&this._symbolizeMarkers(e,i,u);else{var p,g,f,m=i;if(o&&(p="simplemarkersymbol"===i.type||"picturemarkersymbol"===i.type||"textsymbol"===i.type?i:null,m=p?d:i),m&&m===d&&(g=this._bgGroup),_&&!g&&this._removeBgShape(e),m&&(!g&&this._isInvalidShape(m,e._shape)&&this._removeShape(e,!1),f=this._drawShape(e,n,g||this._div,g?_:e.getDojoShape()),o&&this._symbolizeShape(f,m,u,!!d,e),e[g?"_bgShape":"_shape"]=f),p){this._isInvalidShape(p,e._shape)&&this._removeShape(e,!1);var v=e.geometry.getCentroid();f=v&&this._drawPoint(this._div,v,p,e._shape,n,u,e),f&&this._symbolizePoint(f,p,u,e),e._shape=f}}P||(e._bgShape&&this._initNode(e,e._bgShape,e._bgShape!==_,l,a),e._shape&&this._initNode(e,e._shape,e._shape!==h,l,a)),l.node=e.getNode(),this.onGraphicDraw(l)}}else h&&this._removeShape(e)}catch(y){this._errorHandler(y,e)}},_initNode:function(e,t,n,i,r){var s=t&&t.getNode();s&&(s.e_graphic=e,this._addDataAttrs(e,r,s),n&&(i.node=s,this.onGraphicNodeAdd(i)))},_removeShape:function(e,t){var n=e.getDojoShape(),i=n&&n.getNode();n&&(n.removeShape(),n.destroy()),e._shape=e._offsets=null,t!==!1&&this._removeBgShape(e),i&&(i.e_graphic=null,P||this.onGraphicNodeRemove({graphic:e,node:i}))},_removeBgShape:function(e){var t=e._bgShape,n=t&&t.getNode();t&&(t.removeShape(),t.destroy(),e._bgShape=null),n&&(n.e_graphic=null,P||this.onGraphicNodeRemove({graphic:e,node:n}))},_addDataAttrs:function(e,t,n){var i,r,s,o=e.attributes,a=t?t.length:0,h=this._getRenderer(e);if(n&&o){for(r=0;a>r;r++)i=t[r],i&&e.attr("data-"+i,o[i]);!this.styling&&h&&(h.getBreakIndex?(s=h.getBreakIndex(e),e.attr("data-class-break",-1!==s?s:null)):h.getUniqueValueInfo&&(s=h.getUniqueValueInfo(e),e.attr("data-unique-value",s?s.value:null)))}},_drawShape:function(e,t,n,i){var r,s,o,a,h,c,l=e.geometry,_=l.type,u=this._map,d=u.extent,p=u.width,g=u.height,f=u.__visibleRect,m=[],v="extent"===_;if("rect"===_||v)a={x:0,y:0,spatialReference:l.spatialReference},a.x=v?l.xmin:l.x,a.y=v?l.ymax:l.y,h=x.toScreenPoint(d,p,g,a),a.x=v?l.xmax:l.x+l.width,a.y=v?l.ymin:l.y+l.height,c=x.toScreenPoint(d,p,g,a),o={x:h.x-f.x+t[0],y:h.y-f.y,width:Math.abs(c.x-h.x),height:Math.abs(c.y-h.y)},0===o.width&&(o.width=1),0===o.height&&(o.height=1),i=this._drawRect(n,i,o);else if("polyline"===_||"polygon"===_){for(r=0,s=t.length;s>r;r++)m=m.concat(x._toScreenPath(d,p,g,l,-f.x+t[r],-f.y));i=this._drawPath(n,i,m),this._rendererLimits&&("polyline"===_?this._clipPolyline(i,l):this._clipPolygon(i,l))}return i},_drawRect:function(e,t,n){return t?t.setShape(n):e.createRect(n)},_drawImage:function(e,t,n){return t?t.setShape(n):e.createImage(n)},_drawCircle:function(e,t,n){return t?t.setShape(n):e.createCircle(n)},_drawPath:function(){return M?function(e,t,n,i){if(n=i?n:n.join(" "),t)return t.setShape(n);var r=e.createObject(i?a.Path:a.EsriPath,n);return e._overrideSize(r.getEventSource()),r}:function(e,t,n,i){return n=i?n:n.join(" "),t?t.setShape(n):e.createPath(n)}}(),_drawText:function(e,t,n){return t?t.setShape(n):e.createText(n)},_evalSDRenderer:function(e){var t,n=this._map,i=this.renderer,r=this._rndForScale;n&&n.loaded&&i&&i.getRendererInfo&&(t="zoom"===i.rangeType?i.getRendererInfoByZoom(n.getZoom()):i.getRendererInfoByScale(n.getScale())),this._rndForScale=t&&t.renderer,e||this._rndForScale==r||this.emit("renderer-change",{renderer:this._rndForScale})},_getRenderer:function(e){var t=this._rndForScale||this.renderer;return e&&t&&t.getObservationRenderer&&(t=t.getObservationRenderer(e)),t},_getSymbol:function(e){var t=this._getRenderer();return e.symbol||t&&t.getSymbol(e)},_getVariable:function(e,t,n){var i,r;return e&&(i=e.getVisualVariablesForType(t,n),r=i&&i[0]),r},_applyOpacity:function(e,t,n,i){var r=t.getOpacity(i,{opacityInfo:n});return null!=r&&(e=new d(e),e.a=r),e},_symbolizeShape:function(e,t,i,r,s){var o,a,h=t.getStroke(),c=t.getFill(),l=t.type,_=this._getVariable(i,"sizeInfo",!1),u=this._getVariable(i,"colorInfo",!1),d=this._getVariable(i,"opacityInfo",!1),p=-1!==l.indexOf("linesymbol"),g=p?"none"!==t.style:t.outline&&"none"!==t.outline.style,f=p?null:this._getVariable(i,"sizeInfo","outline"),m=r?f:f||_,v=m?i.getSize(s,{sizeInfo:m,resolution:this._map.getResolutionInMeters(),scale:this._map.getScale()}):null;r&&(u=d=null),(u||d)&&"picturefillsymbol"!==l&&(p?(o=h&&h.color,u&&(o=i.getColor(s,{colorInfo:u})||o),o&&d&&(o=this._applyOpacity(o,i,d,s))):c&&c.toCss&&(a=c,u&&(a=i.getColor(s,{colorInfo:u})||a),a&&d&&(a=this._applyOpacity(a,i,d,s)))),e.setStroke(!g||null==v&&!o?h:n.mixin({},h,null!=v?{width:v}:null,o&&{color:o})).setFill(a||c)},_smsToPath:function(){return M?function(e,t,n,i,r,s,o,a,h){switch(t){case e.STYLE_SQUARE:return["M",r+","+o,"L",s+","+o,s+","+a,r+","+a,"X","E"];case e.STYLE_CROSS:return["M",n+","+o,"L",n+","+a,"M",r+","+i,"L",s+","+i,"E"];case e.STYLE_X:return["M",r+","+o,"L",s+","+a,"M",r+","+a,"L",s+","+o,"E"];case e.STYLE_DIAMOND:return["M",n+","+o,"L",s+","+i,n+","+a,r+","+i,"X","E"];case e.STYLE_TARGET:return["M",r+","+o,"L",s+","+o,s+","+a,r+","+a,r+","+o,"M",r-h+","+i,"L",r+","+i,"M",n+","+(o-h),"L",n+","+o,"M",s+h+","+i,"L",s+","+i,"M",n+","+(a+h),"L",n+","+a,"E"]}}:function(e,t,n,i,r,s,o,a,h){switch(t){case e.STYLE_SQUARE:return["M",r+","+o,s+","+o,s+","+a,r+","+a,"Z"];case e.STYLE_CROSS:return["M",n+","+o,n+","+a,"M",r+","+i,s+","+i];case e.STYLE_X:return["M",r+","+o,s+","+a,"M",r+","+a,s+","+o];case e.STYLE_DIAMOND:return["M",n+","+o,s+","+i,n+","+a,r+","+i,"Z"];case e.STYLE_TARGET:return["M",r+","+o,s+","+o,s+","+a,r+","+a,r+","+o,"M",r-h+","+i,r+","+i,"M",n+","+(o-h),n+","+o,"M",s+h+","+i,s+","+i,"M",n+","+(a+h),n+","+a]}}}(),_pathStyles:{square:1,cross:1,x:1,diamond:1,target:1},_typeMaps:{picturemarkersymbol:"image",picturefillsymbol:"path",simplefillsymbol:"path",simplelinesymbol:"path",cartographiclinesymbol:"path",textsymbol:"text"},_isInvalidShape:function(e,t){var n=t&&t.shape&&t.shape.type,i=e&&e.type,r=e&&e.style;return"rect"===n&&(n="path"),i&&(r=this._typeMaps[i]||r),this._pathStyles[r]&&(r="path"),"shieldlabelsymbol"===i?!0:!(!n||!r||n===r)},_drawPoint:function(e,t,n,i,r,s,o){var a,c,l,_,u=n.type,d=this._map,p=d.__visibleRect,g=x.toScreenPoint(d.extent,d.width,d.height,t).offset(-p.x+r[0],-p.y),m=g.x,v=g.y,y=[],S=s&&s.rotationInfo?s.getRotationAngle(o):null,b=this._getVariable(s,"sizeInfo",!1),w=b?s.getSize(o,{sizeInfo:b,shape:n.style,resolution:d.getResolutionInMeters(),scale:d.getScale()}):null;if(S&&y.push(h.rotategAt(S,g)),(0!==n.xoffset||0!==n.yoffset)&&(_=h.translate(n.xoffset,-n.yoffset),y.push(_)),0!==n.angle&&y.push(h.rotategAt(n.angle,g)),"simplemarkersymbol"===u){var P,M=n.style,I=Math.round;switch(w=null!=w?w:n.size,M){case f.STYLE_SQUARE:case f.STYLE_CROSS:case f.STYLE_X:case f.STYLE_DIAMOND:P=isNaN(w)?16:w/2,a=this._drawPath(e,i,this._smsToPath(f,M,m,v,I(m-P),I(m+P),I(v-P),I(v+P)));break;case f.STYLE_TARGET:var R=n._targetWidth/2,T=n._targetHeight/2;a=this._drawPath(e,i,this._smsToPath(f,M,m,v,I(m-R),I(m+R),I(v-T),I(v+T),n._spikeSize));break;case f.STYLE_PATH:a=this._drawPath(e,i,n.path,!0);var k=a.getBoundingBox(),C=this._getScaleMatrix(k,w);(1!==C.xx||1!==C.yy)&&y.push(h.scaleAt(C.xx,C.yy,g)),y.push(h.translate(-(k.x+k.width/2)+m,-(k.y+k.height/2)+v));break;default:P=isNaN(w)?16:w/2,a=this._drawCircle(e,i,{cx:m,cy:v,r:P})}}else if("shieldlabelsymbol"===u){c=n.width,l=n.height;var H=e.createGroup(),O=e.createImage({x:m-c/2,y:v-l/2,width:c,height:l,src:n.url});if(H.add(O),null!=n.font){var L=m,D=v+.2*n.getHeight(),G=e.createText({type:"text",text:n.text,x:L,y:D,align:"middle",decoration:n.decoration,rotated:n.rotated,kerning:n.kerning});G.setFont(n.font),G.setFill(n.color),H.add(G)}a=H}else if("picturemarkersymbol"===u){if(null==w?(c=n.width,l=n.height):(l=w,c=l*(n.width/n.height),_&&(null!=_.dx&&(_.dx=c*(_.dx/n.width)),null!=_.dy&&(_.dy=l*(_.dy/n.height)))),a=this._drawImage(e,i,{x:m-c/2,y:v-l/2,width:c,height:l,src:n.url}),E){var N=a.getNode();if(N){var j=this._getVariable(s,"opacityInfo",!1),A=j?s.getOpacity(o,{opacityInfo:j}):null;null!=A?N.setAttribute("opacity",A):N.setAttribute("opacity",1)}}}else if("textsymbol"===u){var z=n.font;if(null!=w&&z&&(z=new z.constructor(z.toJson()),z.setSize(w)),a=this._drawText(e,i,{type:"text",text:n.text,x:m,y:v,align:n.getSVGAlign(),decoration:n.decoration||z&&z.decoration,rotated:n.rotated,kerning:n.kerning}),z&&a.setFont(z),E){var N=a.getNode(),B=n.getSVGBaseline(),U=n.getSVGBaselineShift();N&&(N.setAttribute("dominant-baseline",B),U&&N.setAttribute("baseline-shift",U))}}return a.setTransform(h.multiply(y)),a._wrapOffsets=r,a},_getScaleMatrix:function(e,t){var n=e.width/e.height,i=1,r=1;return isNaN(t)||(n>1?(i=t/e.width,r=t/n/e.height):(r=t/e.height,i=t*n/e.width)),{xx:i,yy:r}},_symbolizePoint:function(e,t,i,r){var s=t.type,o=t.style;if("shieldlabelsymbol"!==s&&"picturemarkersymbol"!==s){var a=t.getStroke(),h=t.getFill(),c=o===f.STYLE_X||o===f.STYLE_CROSS,l=a&&a.color,_=c?l:h;if(i){var u=this._getVariable(i,"colorInfo",!1),d=this._getVariable(i,"opacityInfo",!1);u&&(_=i.getColor(r,{colorInfo:u})||_),_&&d&&(_=this._applyOpacity(_,i,d,r)),_&&(c?_!==l&&(a=a?n.mixin({},a):{},a.color=_):_!==h&&(h=_))}"textsymbol"===s?e.setFill(h):"simplemarkersymbol"===s&&e.setFill(h).setStroke(a)}},_drawMarkers:function(e,t,n,i){var r,s,o,a=e.geometry,h=a.points,c=e.getDojoShape()||this._div.createGroup(),l=h.length,_=[],u=0,d=n?n.length:0;for(c.children[0]&&this._isInvalidShape(t,c.children[0])&&c.clear(),s=0;l>s;s++)for(r=h[s],o=0;d>o;o++)_[0]=n[o],this._drawPoint(c,{x:r[0],y:r[1],spatialReference:a.spatialReference},t,c.children[u++],_,i,e);var p=c.children.length;if(l*n.length<p)for(s=p-1;s>=l*n.length;s--)c.children[s].removeShape();e._shape=c},_symbolizeMarkers:function(e,t,n){var i,r=e.getDojoShape(),s=r.children,o=s.length;for(i=0;o>i;i++)this._symbolizePoint(s[i],t,n,e)},_errorHandler:function(e,t){var n="Unable to draw graphic ";e.message=t?n+"(geometry:"+(t.geometry?t.geometry.declaredClass:null)+", symbol:"+(t.symbol?t.symbol.declaredClass:null)+"): "+e.message:n+"(null): "+e.message,this.inherited(arguments)},_rendererLimits:function(){var e,t,n;if(u("ff")?(e=16125,t=-32250,n=32250):M?(e=1e5,t=-1e5,n=1e5):u("chrome")&&u("chrome")<6&&(e=8150,t=-1e4,n=1e4),e){var i,r;return i=[-e,-e,e,e],r=[[[-e,-e],[e,-e]],[[e,-e],[e,e]],[[e,e],[-e,e]],[[-e,e],[-e,-e]]],{clipLimit:e,rangeMin:t,rangeMax:n,clipBBox:i,clipSegments:r}}}(),_clipPolyline:function(e,t){var n=this._getCorners(e,t),r=n.tl,s=n.br,o=this._rendererLimits,a=o.rangeMin,h=o.rangeMax,c=o.clipBBox,l=o.clipSegments,_=this._isPointWithinRange,u=this._isPointWithinBBox,d=this._getClipperIntersection,p=this._getPlaneIndex;if(!_(r,a,h)||!_(s,a,h)){M&&this._createSegments(e);var g=[];i.forEach(e.segments,function(e){var t,n=e.args,i=n.length,r=[];for(t=0;i>t;t+=2){var s=[n[t],n[t+1]],o=[n[t+2],n[t+3]],a=u(s,c),h=u(o,c);if(a^h){var _=d([s,o],l);_&&(a?(t?r.push(_[1]):r.push(s,_[1]),g.push(r),r=[]):r.push(_[1],o))}else if(a)t?r.push(o):r.push(s,o);else{var f=p(s,c),m=p(o,c);if(-1===f||-1===m||f===m)continue;var v=d([s,o],l,!0);if(v.length>0){v[f]||(f=v[f[0]]?f[0]:f[1]),v[m]||(m=v[m[0]]?m[0]:m[1]);var y=v[f],S=v[m];y&&r.push(y),S&&(r.push(S),g.push(r),r=[])}}}g.push(r)}),e.setShape(this._getPathStringFromPaths(g))}},_clipPolygon:function(e,t){var r=this._getCorners(e,t),s=r.tl,o=r.br,a=this._rendererLimits,h=a.clipLimit,c=a.rangeMin,l=a.rangeMax,_=a.clipBBox,u=a.clipSegments,d=this._isPointWithinRange,p=this._isPointWithinBBox,g=this._getClipperIntersection,f=this._getPlaneIndex,m=S._pointLineDistance;if(!d(s,c,l)||!d(o,c,l)){M&&this._createSegments(e);var v=i.map(e.segments,function(e){var t,r=e.args,s=r.length,o=[],a=[];for(t=0;s>t;t+=2){var c=[r[t],r[t+1]],l=[r[t+2],r[t+3]];if(t===s-2){o.push(c);break}var d,v=p(c,_),y=p(l,_);if(o.push(c),v^y){if(d=g([c,l],u)){var S=d[1];S[v?"inOut":"outIn"]=!0,o.push(S),a.push([v?"INOUT":"OUTIN",o.length-1,d[0]])}}else if(!v){var x=f(c,_),b=f(l,_);if(-1===x||-1===b||x===b)continue;if(d=g([c,l],u,!0),d.length>0){d[x]||(x=d[x[0]]?x[0]:x[1]),d[b]||(b=d[b[0]]?b[0]:b[1]);var w=d[x],E=d[b];w&&(w.outIn=!0,o.push(w),a.push(["OUTIN",o.length-1,x])),E&&(E.inOut=!0,o.push(E),a.push(["INOUT",o.length-1,b]))}else if(n.isArray(x)&&n.isArray(b)){var P=x.concat(b);if(P.sort(),"0123"===P.join("")){var M=[];x[0]+x[1]===3?M.push([h,-h],[-h,h]):M.push([-h,-h],[h,h]);var I=m(M[0],[c,l]),R=m(M[1],[c,l]);o.push(R>I?M[0]:M[1])}}}}var T=_[0],k=_[1],C=_[2],H=_[3];i.forEach(o,function(e){e[0]<T&&(e[1]>=k&&e[1]<=H?e[0]=T:(e[0]=T,e[1]=e[1]<k?k:H))}),i.forEach(o,function(e){e[1]<k&&(e[0]>=T&&e[0]<=C?e[1]=k:(e[1]=k,e[0]=e[0]<T?T:C))}),i.forEach(o,function(e){e[0]>C&&(e[1]>=k&&e[1]<=H?e[0]=C:(e[0]=C,e[1]=e[1]<k?k:H))}),i.forEach(o,function(e){e[1]>H&&(e[0]>=T&&e[0]<=C?e[1]=H:(e[1]=H,e[0]=e[0]<T?T:C))});var O,L,D=0;if(s=a.length,s>0)do{if(O=a[D],L=a[(D+1)%s],O[2]===L[2]&&"INOUT"===O[0]&&"OUTIN"===L[0]){var G,N=O[1],j=L[1];if(j>N)for(G=N+1;j>G;G++)o[G][2]=!0;else if(N>j){for(G=N+1;G<o.length;G++)o[G][2]=!0;for(G=0;j>G;G++)o[G][2]=!0}}D=(D+1)%s}while(0!==D);var A,z=o[0],B=o[o.length-1];for(z[2]&&(B[2]=!0,i.some(a,function(e){return 1===e[1]?(o.splice(o.length-1,0,n.clone(o[1])),!0):!1})),o=i.filter(o,function(e){return e[2]?!1:!0}),D=0;D<o.length-1;D++)A=o[D],L=o[D+1],L&&A[0]===L[0]&&A[1]===L[1]&&(L.outIn?A.outIn=!0:L.inOut&&(A.inOut=!0),o.splice(D+1,1));var U=Math.abs,F=[];for(D=0;D<o.length-1;D++){O=o[D];var Y=O[0],V=O[1],X=U(Y)===h,Z=U(V)===h;L=o[D+1];var W=L[0],q=L[1],Q=U(W)===h,J=U(q)===h;X&&J?F.push([D+1,[Y,q]]):Z&&Q&&F.push([D+1,[W,V]])}for(D=F.length-1;D>=0;D--){var K=F[D],$=o[K[0]-1];A=o[K[0]],$.outIn||$.inOut||A.outIn||A.inOut||o.splice(K[0],0,K[1])}return z=o[0],B=o[o.length-1],(z[0]!==B[0]||z[1]!==B[1])&&o.push(z),o});e.setShape(this._getPathStringFromPaths(v))}},_getCorners:function(e,t){if(M){var n=this._map,i=t.getExtent(),r=i.spatialReference,s=n.toScreen(new m(i.xmin,i.ymax,r)),o=n.toScreen(new m(i.xmax,i.ymin,r));return{tl:s,br:o}}var a=e.getTransformedBoundingBox();return{tl:a[0],br:a[2]}},_createSegments:function(e){e.shape.path=e.vmlPath,e.segmented=!1,e._confirmSegmented();var t=e.segments;t.length>1&&(e.segments=i.filter(t,function(e,t,n){var i=n[t+1];return"M"===e.action&&i&&"L"===i.action?(e.args=e.args.concat(i.args),!0):!1}))},_getPathStringFromPaths:function(e){return M?(e=i.map(e,function(e){var t=i.map(e,function(e,t){return(1===t?"l ":"")+e.join(",")});return"m "+t.join(" ")}),e.push("e")):e=i.map(e,function(e){var t=i.map(e,function(e){return e.join(",")});return"M "+t.join(" ")}),e.join(" ")},_isPointWithinBBox:function(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=e[0],a=e[1];return o>n&&r>o&&a>i&&s>a?!0:!1},_isPointWithinRange:function(e,t,n){var i=e.x,r=e.y;return t>i||t>r||i>n||r>n?!1:!0},_getClipperIntersection:function(e,t,n){var i,r=S._getLineIntersection2,s=Math.round,o={length:0};for(i=0;4>i;i++){var a=r(e,t[i]);if(a){if(a[0]=s(a[0]),a[1]=s(a[1]),!n)return[i,a];o[i]=a,o.length++}}return n?o:null},_getPlaneIndex:function(e,t){var n=e[0],i=e[1],r=t[0],s=t[1],o=t[2],a=t[3];return r>=n?i>=s&&a>=i?3:s>i?[0,3]:[2,3]:s>=i?n>=r&&o>=n?0:r>n?[3,0]:[1,0]:n>=o?i>=s&&a>=i?1:s>i?[0,1]:[2,1]:i>=a?n>=r&&o>=n?2:r>n?[3,2]:[1,2]:-1},onGraphicAdd:function(){},onGraphicRemove:function(){},onGraphicNodeAdd:function(){},onGraphicNodeRemove:function(){},onGraphicDraw:function(){},onGraphicsClear:function(){},onRendererChange:function(){},onOpacityChange:function(){},setInfoTemplate:function(e){this.infoTemplate=e},add:function(e,t){return e._graphicsLayer===this?e:(t||this.graphics.push(e),e._graphicsLayer=this,e._layer=this,this._updateExtent(e),this._draw(e),t||this.onGraphicAdd(e),e)},remove:function(e,t){if(!t){var n,r=this.graphics;if(-1===(n=i.indexOf(r,e)))return null;e=this.graphics.splice(n,1)[0]}return e.getDojoShape()&&this._removeShape(e),e._shape=e._graphicsLayer=null,this.onGraphicRemove(e),e},clear:function(){for(var e=arguments[1],t=this.graphics;t.length>0;)this.remove(t[0]);e||this.onGraphicsClear()},_setIEOpacity:function(e,t){var n=e&&e.getNode();if(n){var i=e.strokeStyle,r=n.stroke;i&&r&&(r.opacity=i.color.a*t);var s=e.fillStyle,a=n.fill;s&&a&&("tile"===a.type?o.set(n,"opacity",t):a.opacity=s.a*t)}},setOpacity:function(e,t){if(t||this.opacity!=e){var n=this._div;n&&(M?(i.forEach(this.graphics,function(t){this._setIEOpacity(t._shape,e),this._setIEOpacity(t._bgShape,e)},this),n._esriIeOpacity=e,this._bgGroup._esriIeOpacity=e):this._canvas?o.set(n.getEventSource(),"opacity",e):n.getEventSource().setAttribute("opacity",e)),this.opacity=e,t||this.onOpacityChange(e)}},setRenderer:function(e){this.renderer=e,this._evalSDRenderer(!0),this.emit("renderer-change",{renderer:this._rndForScale||e})}});var T=e([w,b],{declaredClass:"esri.layers.GraphicsLayer",constructor:function(){this.enableMouseEvents=n.hitch(this,this.enableMouseEvents),this.disableMouseEvents=n.hitch(this,this.disableMouseEvents),this._processEvent=n.hitch(this,this._processEvent),this._initLayer()},_initLayer:function(){this.loaded=!0,this.onLoad(this)},_setMap:function(){var e=this.inherited("_setMap",arguments);return this.enableMouseEvents(),e},_unsetMap:function(){this.disableMouseEvents(),this.inherited("_unsetMap",arguments)},_processEvent:function(e){var t,n=this._map,i=e.target;for(e.screenPoint=new v(e.pageX-n.position.x,e.pageY-n.position.y),e.mapPoint=n.toMap(e.screenPoint);i&&!(t=i.e_graphic);)i=i.parentNode;return t?(e.graphic=t,e):void 0},_onMouseOverHandler:function(e){this._processEvent(e)&&this.onMouseOver(e)},_onMouseMoveHandler:function(e){this._processEvent(e)&&this.onMouseMove(e)},_onMouseDragHandler:function(e){this._processEvent(e)&&this.onMouseDrag(e)},_onMouseOutHandler:function(e){this._processEvent(e)&&this.onMouseOut(e)},_onMouseDownHandler:function(e){this._downGr=this._downPt=null,this._processEvent(e)&&(t.disconnect(this._onmousemove_connect),t.disconnect(this._onmousedrag_connect),this._onmousedrag_connect=t.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseDragHandler"),this._downGr=e.graphic,this._downPt=e.screenPoint.x+","+e.screenPoint.y,this.onMouseDown(e))},_onMouseUpHandler:function(e){this._upGr=this._upPt=null,this._processEvent(e)&&(t.disconnect(this._onmousedrag_connect),t.disconnect(this._onmousemove_connect),this._onmousemove_connect=t.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseMoveHandler"),this._upGr=e.graphic,this._upPt=e.screenPoint.x+","+e.screenPoint.y,this.onMouseUp(e))},_onClickHandler:function(e){if(this._processEvent(e)){var t=this._downGr,n=this._upGr;t&&n&&t===n&&this._downPt===this._upPt&&(M&&(l._ieGraphic=e.graphic),this.onClick(e))}},_onDblClickHandler:function(e){this._processEvent(e)&&this.onDblClick(e)},onMouseOver:function(){},onMouseMove:function(){},onMouseDrag:function(){},onMouseOut:function(){},onMouseDown:function(){},onMouseUp:function(){},onClick:function(){},onDblClick:function(){},enableMouseEvents:function(){if(!this._mouseEvents){var e=t.connect,n=this._div.getEventSource();P||(this._onmouseover_connect=e(n,"onmouseover",this,"_onMouseOverHandler"),this._onmousemove_connect=e(n,"onmousemove",this,"_onMouseMoveHandler"),this._onmouseout_connect=e(n,"onmouseout",this,"_onMouseOutHandler"),this._onmousedown_connect=e(n,"onmousedown",this,"_onMouseDownHandler"),this._onmouseup_connect=e(n,"onmouseup",this,"_onMouseUpHandler"),this._onclick_connect=e(n,"onclick",this,"_onClickHandler"),this._ondblclick_connect=e(n,"ondblclick",this,"_onDblClickHandler")),this._mouseEvents=!0}},disableMouseEvents:function(){if(this._mouseEvents){var e=t.disconnect;e(this._onmouseover_connect),e(this._onmousemove_connect),e(this._onmousedrag_connect),e(this._onmouseout_connect),e(this._onmousedown_connect),e(this._onmouseup_connect),e(this._onclick_connect),e(this._ondblclick_connect),this._mouseEvents=!1}}});return T._GraphicsContainer=R,T._GraphicsLayer=w,u("extend-esri")&&(n.setObject("layers.GraphicsLayer",T,l),n.setObject("layers._GraphicsContainer",R,l),n.setObject("layers._GraphicsLayer",w,l)),T});