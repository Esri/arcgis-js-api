/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/Error","../core/HandleOwner","../core/Handles","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/sql","../core/urlUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/PropertyOrigin","./Layer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/EditBusLayer","./mixins/FeatureLayerBase","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/arcgisLayerUrl","./support/commonProperties","./support/featureLayerUtils","./support/fieldProperties","./support/fieldUtils","./support/Subtype","./support/SubtypeSublayer","./support/TimeInfo","./support/versionUtils","../rest/support/Query"],(function(e,r,t,n,o,i,s,a,u,l,p,c,y,d,h,f,m,b,_,g,v,S,w,L,T,F,x,I,P,G,O,C,E,q,A,j,M,R,U,$,B){"use strict";const N=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),Q="SubtypeGroupLayer",k="esri.layers.SubtypeGroupLayer";function H(e,r){return new o("layer:unsupported",`Layer (${e.title}, ${e.id}) of type '${e.declaredClass}' ${r}`,{layer:e})}const D=A.defineFieldProperties();let J=function(t){function i(...e){var r;return(r=t.call(this,...e)||this)._handles=new s,r._sublayersCollectionChanged=!1,r.fields=null,r.fieldsIndex=null,r.outFields=null,r.subtypes=null,r.sublayers=new(n.ofType(R)),r.timeInfo=null,r.title="Layer",r.type="subtype-group",r.addHandles(p.watch((()=>r.sublayers),((e,t)=>r._handleSublayersChange(e,t)),p.sync)),r}r._inheritsLoose(i,t);var u=i.prototype;return u.destroy=function(){this.source?.destroy(),this._handles=a.destroyMaybe(this._handles)},u.normalizeCtorArgs=function(e,r){return"string"==typeof e?{url:e,...r}:e},u.load=function(e){var t=this;const n=a.isSome(e)?e.signal:null,i=this.loadFromPortal({supportedTypes:["Feature Service"]},e).catch(l.throwIfAbortError).then(r._asyncToGenerator((function*(){if(!t.url)throw new o("subtype-grouplayer:missing-url-or-source","SubtypeGroupLayer must be created with either a url or a portal item");if(null==t.layerId)throw new o("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");return t._initLayerProperties(yield t.createGraphicsSource(n))}))).then((()=>this.finishLoadEditablePortalLayer(e)));return this.addResolvingPromise(i),Promise.resolve(this)},u.readTitleFromService=function(e,{name:r}){return this.url?C.titleFromUrlAndName(this.url,r):r},u.addAttachment=function(){var e=r._asyncToGenerator((function*(e,r){return q.addAttachment(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.updateAttachment=function(){var e=r._asyncToGenerator((function*(e,r,t){return q.updateAttachment(this,e,r,t,Q)}));function t(r,t,n){return e.apply(this,arguments)}return t}(),u.applyEdits=function(){var e=r._asyncToGenerator((function*(e,r){return q.applyEdits(this,e,r)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.on=function(e,r){return t.prototype.on.call(this,e,r)},u.createGraphicsSource=function(){var t=r._asyncToGenerator((function*(r){const{default:t}=yield l.whenOrAbort(new Promise(((r,t)=>e(["./graphics/sources/FeatureLayerSource"],(e=>r(N(e))),t))),r);return new t({layer:this}).load({signal:r})}));function n(e){return t.apply(this,arguments)}return n}(),u.createQuery=function(){const e=q.createQuery(this),r=this.sublayers.map((e=>e.subtypeCode));return e.where=c.sqlAnd(`${this.subtypeField} IN (${r.join(",")})`,this.definitionExpression),e},u.deleteAttachments=function(){var e=r._asyncToGenerator((function*(e,r){return q.deleteAttachments(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.fetchRecomputedExtents=function(){var e=r._asyncToGenerator((function*(e){return q.fetchRecomputedExtents(this,e,Q)}));function t(r){return e.apply(this,arguments)}return t}(),u.getFieldDomain=function(e,r){return this._getLayerDomain(e)},u.getField=function(e){return this.fieldsIndex.get(e)},u.queryAttachments=function(){var e=r._asyncToGenerator((function*(e,r){return q.queryAttachments(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.queryFeatures=function(){var e=r._asyncToGenerator((function*(e,r){const t=yield this.load(),n=B.from(e)??t.createQuery(),o=a.unwrapOr(n.outFields,[]);o.includes(this.subtypeField)||(o.push(this.subtypeField),n.outFields=o);const i=yield t.source.queryFeatures(n,r);if(i?.features)for(const s of i.features)s.layer=this._findSublayerForFeature(s),s.sourceLayer=this;return i}));function t(r,t){return e.apply(this,arguments)}return t}(),u.queryObjectIds=function(){var e=r._asyncToGenerator((function*(e,r){return q.queryObjectIds(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.queryFeatureCount=function(){var e=r._asyncToGenerator((function*(e,r){return q.queryFeatureCount(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.queryExtent=function(){var e=r._asyncToGenerator((function*(e,r){return q.queryExtent(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.queryRelatedFeatures=function(){var e=r._asyncToGenerator((function*(e,r){return q.queryRelatedFeatures(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.queryRelatedFeaturesCount=function(){var e=r._asyncToGenerator((function*(e,r){return q.queryRelatedFeaturesCount(this,e,r,Q)}));function t(r,t){return e.apply(this,arguments)}return t}(),u.write=function(e,r){const{origin:n,layerContainerType:i,messages:s}=r;if(this.isTable){if("web-scene"===n||"web-map"===n&&"tables"!==i)return s?.push(H(this,"using a table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&"web-map"===n&&"tables"===i)return s?.push(H(this,"using a non-table source cannot be written to tables in web maps")),null;return this.sublayers?.length?t.prototype.write.call(this,e,r):(s?.push(new o("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)},u.serviceSupportsSpatialReference=function(e){return!!this.loaded&&$.serviceSupportsSpatialReference(this,e)},u._findSublayerForFeature=function(e){const r=this.fieldsIndex.get(this.subtypeField),t=e.attributes[r.name];return this.sublayers.find((e=>e.subtypeCode===t))},u._getLayerDomain=function(e){const r=this.fieldsIndex.get(e);return r?r.domain:null},u._initLayerProperties=function(){var e=r._asyncToGenerator((function*(e){this._set("source",e);const{sourceJSON:r}=e;if(r&&(this.sourceJSON=r,this.read(r,{origin:"service",url:this.parsedUrl})),this.isTable)throw new o("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new o("subtype-grouplayer:missing-subtypes","SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields(),j.fixTimeInfoFields(this.timeInfo,this.fieldsIndex)}));function t(r){return e.apply(this,arguments)}return t}(),u.hasDataChanged=function(){var e=r._asyncToGenerator((function*(){return q.hasDataChanged(this)}));function t(){return e.apply(this,arguments)}return t}(),u._verifyFields=function(){const e=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||-1!==e.search(/\/FeatureServer\//i)||this.fields?.some((e=>"geometry"===e.type))||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},u._handleSublayersChange=function(e,r){r&&(r.forEach((e=>{e.parent=null})),this.handles.remove("sublayers-owner")),e&&(e.forEach((e=>{e.parent=this})),this._sublayersCollectionChanged=!1,this.handles.add([e.on("after-add",(({item:e})=>{e.parent=this})),e.on("after-remove",(({item:e})=>{e.parent=null})),e.on("after-changes",(()=>{this._sublayersCollectionChanged=!0}))],"sublayers-owner"))},r._createClass(i,[{key:"createQueryVersion",get:function(){return this.commitProperty("definitionExpression"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")??0)+1}},{key:"editingEnabled",get:function(){return this.loaded&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}},{key:"parsedUrl",get:function(){const e=y.urlToObject(this.url);return null!=e&&null!=this.layerId&&(e.path=y.join(e.path,this.layerId.toString())),e}},{key:"source",set:function(e){this._get("source")!==e&&this._set("source",e)}}]),i}(F.FeatureLayerBase(T.EditBusLayer(w.BlendLayer(O.TemporalLayer(G.ScaleRangeLayer(P.RefreshableLayer(S.ArcGISService(x.OperationalLayer(I.PortalLayer(u.MultiOriginJSONMixin(L.CustomParametersMixin(v.APIKeyMixin(i.HandleOwnerMixin(g))))))))))))));t.__decorate([d.property({readOnly:!0})],J.prototype,"createQueryVersion",null),t.__decorate([d.property({type:Boolean,readOnly:!0})],J.prototype,"editingEnabled",null),t.__decorate([d.property({...D.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],J.prototype,"fields",void 0),t.__decorate([d.property(D.fieldsIndex)],J.prototype,"fieldsIndex",void 0),t.__decorate([d.property(E.id)],J.prototype,"id",void 0),t.__decorate([d.property({type:["show","hide","hide-children"]})],J.prototype,"listMode",void 0),t.__decorate([d.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"]})],J.prototype,"operationalLayerType",void 0),t.__decorate([d.property(D.outFields)],J.prototype,"outFields",void 0),t.__decorate([d.property({readOnly:!0})],J.prototype,"parsedUrl",null),t.__decorate([d.property()],J.prototype,"source",null),t.__decorate([d.property({type:[M],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],J.prototype,"subtypes",void 0),t.__decorate([d.property({type:n.ofType(R),json:{origins:{service:{read:{source:"subtypes",reader:(e,r,t)=>{const o=e.map((({code:e})=>{const n=new R({subtypeCode:e});return n.read(r,t),n}));return new(n.ofType(R))(o)}}}},name:"layers",write:{overridePolicy(e,r,t){const n=this.originOf("sublayers"),o=_.OriginId.PORTAL_ITEM;let i=!0;if(_.nameToId(n)===o&&_.nameToId(t.origin)>o){const r=e.some((e=>e.hasUserOverrides()));i=this._sublayersCollectionChanged||r}return{enabled:i,ignoreOrigin:!0}}}}})],J.prototype,"sublayers",void 0),t.__decorate([d.property({type:U})],J.prototype,"timeInfo",void 0),t.__decorate([d.property({json:{origins:{"portal-item":{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],J.prototype,"title",void 0),t.__decorate([m.reader("service","title",["name"])],J.prototype,"readTitleFromService",null),t.__decorate([d.property({json:{read:!1}})],J.prototype,"type",void 0),J=t.__decorate([b.subclass(k)],J);return J}));
