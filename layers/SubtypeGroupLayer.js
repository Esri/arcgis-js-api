/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/Error","../core/HandleOwner","../core/Handles","../core/loadAll","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/sql","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/PropertyOrigin","./Layer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/EditBusLayer","./mixins/FeatureLayerBase","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/arcgisLayerUrl","./support/commonProperties","./support/featureLayerUtils","./support/fieldProperties","./support/fieldUtils","./support/Subtype","./support/SubtypeSublayer","./support/TimeInfo","./support/versionUtils","../rest/support/Query"],(function(e,t,r,n,i,o,s,a,u,l,p,c,y,d,h,f,b,m,_,g,v,L,S,w,T,F,I,x,O,P,C,G,E,A,q,M,U,j,R,k,$,N){"use strict";const B=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),Q="SubtypeGroupLayer",H="esri.layers.SubtypeGroupLayer";function D(e,t){return new i("layer:unsupported",`Layer (${e.title}, ${e.id}) of type '${e.declaredClass}' ${t}`,{layer:e})}const J=M.defineFieldProperties();let V=function(r){function o(...e){var t;return(t=r.call(this,...e)||this)._handles=new s,t._sublayersCollectionChanged=!1,t._sublayerLookup=new Map,t.fields=null,t.fieldsIndex=null,t.outFields=null,t.subtypes=null,t.sublayers=new(n.ofType(R)),t.timeInfo=null,t.title="Layer",t.type="subtype-group",t.addHandles(c.watch((()=>t.sublayers),((e,r)=>t._handleSublayersChange(e,r)),c.sync)),t}t._inheritsLoose(o,r);var l=o.prototype;return l.destroy=function(){this.source?.destroy(),this._handles=u.destroyMaybe(this._handles)},l.normalizeCtorArgs=function(e,t){return"string"==typeof e?{url:e,...t}:e},l.load=function(e){var r=this;const n=u.isSome(e)?e.signal:null,o=this.loadFromPortal({supportedTypes:["Feature Service"]},e).catch(p.throwIfAbortError).then(t._asyncToGenerator((function*(){if(!r.url)throw new i("subtype-grouplayer:missing-url-or-source","SubtypeGroupLayer must be created with either a url or a portal item");if(null==r.layerId)throw new i("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");return r._initLayerProperties(yield r.createGraphicsSource(n))}))).then((()=>this._setUserPrivileges(this.serviceItemId,e))).then((()=>q.ensureLayerCredential(this,e)));return this.addResolvingPromise(o),Promise.resolve(this)},l.readTitleFromService=function(e,{name:t}){return this.url?E.titleFromUrlAndName(this.url,t):t},l.addAttachment=function(){var e=t._asyncToGenerator((function*(e,t){return q.addAttachment(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.updateAttachment=function(){var e=t._asyncToGenerator((function*(e,t,r){return q.updateAttachment(this,e,t,r,Q)}));function r(t,r,n){return e.apply(this,arguments)}return r}(),l.applyEdits=function(){var e=t._asyncToGenerator((function*(e,t){return q.applyEdits(this,e,t)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.on=function(e,t){return r.prototype.on.call(this,e,t)},l.createGraphicsSource=function(){var r=t._asyncToGenerator((function*(t){const{default:r}=yield p.whenOrAbort(new Promise(((t,r)=>e(["./graphics/sources/FeatureLayerSource"],(e=>t(B(e))),r))),t);return new r({layer:this}).load({signal:t})}));function n(e){return r.apply(this,arguments)}return n}(),l.createQuery=function(){const e=q.createQuery(this),t=this.sublayers.map((e=>e.subtypeCode));return e.where=y.sqlAnd(`${this.subtypeField} IN (${t.join(",")})`,this.definitionExpression),e},l.deleteAttachments=function(){var e=t._asyncToGenerator((function*(e,t){return q.deleteAttachments(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.fetchRecomputedExtents=function(){var e=t._asyncToGenerator((function*(e){return q.fetchRecomputedExtents(this,e,Q)}));function r(t){return e.apply(this,arguments)}return r}(),l.getFieldDomain=function(e,t){return this._getLayerDomain(e)},l.getField=function(e){return this.fieldsIndex.get(e)},l.findSublayerForFeature=function(e){const t=this.fieldsIndex.get(this.subtypeField),r=e.attributes[t.name];return this._sublayerLookup.get(r)},l.loadAll=function(){return a.loadAll(this,(e=>{e(this.sublayers)}))},l.queryAttachments=function(){var e=t._asyncToGenerator((function*(e,t){return q.queryAttachments(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.queryFeatures=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this.load(),n=N.from(e)??r.createQuery(),i=u.unwrapOr(n.outFields,[]);i.includes(this.subtypeField)||(i.push(this.subtypeField),n.outFields=i);const o=yield r.source.queryFeatures(n,t);if(o?.features)for(const s of o.features)s.layer=s.sourceLayer=this.findSublayerForFeature(s);return o}));function r(t,r){return e.apply(this,arguments)}return r}(),l.queryObjectIds=function(){var e=t._asyncToGenerator((function*(e,t){return q.queryObjectIds(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.queryFeatureCount=function(){var e=t._asyncToGenerator((function*(e,t){return q.queryFeatureCount(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.queryExtent=function(){var e=t._asyncToGenerator((function*(e,t){return q.queryExtent(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.queryRelatedFeatures=function(){var e=t._asyncToGenerator((function*(e,t){return q.queryRelatedFeatures(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.queryRelatedFeaturesCount=function(){var e=t._asyncToGenerator((function*(e,t){return q.queryRelatedFeaturesCount(this,e,t,Q)}));function r(t,r){return e.apply(this,arguments)}return r}(),l.write=function(e,t){const{origin:n,layerContainerType:o,messages:s}=t;if(this.isTable){if("web-scene"===n||"web-map"===n&&"tables"!==o)return s?.push(D(this,"using a table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&"web-map"===n&&"tables"===o)return s?.push(D(this,"using a non-table source cannot be written to tables in web maps")),null;return this.sublayers?.length?r.prototype.write.call(this,e,t):(s?.push(new i("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)},l.serviceSupportsSpatialReference=function(e){return!!this.loaded&&$.serviceSupportsSpatialReference(this,e)},l._getLayerDomain=function(e){const t=this.fieldsIndex.get(e);return t?t.domain:null},l._initLayerProperties=function(){var e=t._asyncToGenerator((function*(e){this._set("source",e);const{sourceJSON:t}=e;if(t&&(this.sourceJSON=t,this.read(t,{origin:"service",url:this.parsedUrl})),this.isTable)throw new i("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new i("subtype-grouplayer:missing-subtypes","SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields(),U.fixTimeInfoFields(this.timeInfo,this.fieldsIndex)}));function r(t){return e.apply(this,arguments)}return r}(),l.hasDataChanged=function(){var e=t._asyncToGenerator((function*(){return q.hasDataChanged(this)}));function r(){return e.apply(this,arguments)}return r}(),l._verifyFields=function(){const e=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||-1!==e.search(/\/FeatureServer\//i)||this.fields?.some((e=>"geometry"===e.type))||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},l._handleSublayersChange=function(e,t){t&&(t.forEach((e=>{e.parent=null})),this.handles.remove("sublayers-owner"),this._sublayerLookup.clear()),e&&(e.forEach((e=>{e.parent=this,this._sublayerLookup.set(e.subtypeCode,e)})),this._sublayersCollectionChanged=!1,this.handles.add([e.on("after-add",(({item:e})=>{e.parent=this,this._sublayerLookup.set(e.subtypeCode,e)})),e.on("after-remove",(({item:e})=>{e.parent=null,this._sublayerLookup.delete(e.subtypeCode)})),e.on("after-changes",(()=>{this._sublayersCollectionChanged=!0}))],"sublayers-owner"))},t._createClass(o,[{key:"createQueryVersion",get:function(){return this.commitProperty("definitionExpression"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")??0)+1}},{key:"editingEnabled",get:function(){return this.loaded&&null!=this.capabilities&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}},{key:"effectiveEditingEnabled",get:function(){return q.computeEffectiveEditingEnabled(this)}},{key:"parsedUrl",get:function(){const e=d.urlToObject(this.url);return null!=e&&null!=this.layerId&&(e.path=d.join(e.path,this.layerId.toString())),e}},{key:"source",set:function(e){this._get("source")!==e&&this._set("source",e)}}]),o}(I.FeatureLayerBase(F.EditBusLayer(w.BlendLayer(G.TemporalLayer(C.ScaleRangeLayer(P.RefreshableLayer(S.ArcGISService(x.OperationalLayer(O.PortalLayer(l.MultiOriginJSONMixin(T.CustomParametersMixin(L.APIKeyMixin(o.HandleOwnerMixin(v))))))))))))));r.__decorate([h.property({readOnly:!0})],V.prototype,"createQueryVersion",null),r.__decorate([h.property({readOnly:!0})],V.prototype,"editingEnabled",null),r.__decorate([h.property({readOnly:!0})],V.prototype,"effectiveEditingEnabled",null),r.__decorate([h.property({...J.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],V.prototype,"fields",void 0),r.__decorate([h.property(J.fieldsIndex)],V.prototype,"fieldsIndex",void 0),r.__decorate([h.property(A.id)],V.prototype,"id",void 0),r.__decorate([h.property({type:["show","hide","hide-children"]})],V.prototype,"listMode",void 0),r.__decorate([h.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"]})],V.prototype,"operationalLayerType",void 0),r.__decorate([h.property(J.outFields)],V.prototype,"outFields",void 0),r.__decorate([h.property({readOnly:!0})],V.prototype,"parsedUrl",null),r.__decorate([h.property()],V.prototype,"source",null),r.__decorate([h.property({type:[j],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],V.prototype,"subtypes",void 0),r.__decorate([h.property({type:n.ofType(R),json:{origins:{service:{read:{source:"subtypes",reader:(e,t,r)=>{const i=e.map((({code:e})=>{const n=new R({subtypeCode:e});return n.read(t,r),n}));return new(n.ofType(R))(i)}}}},name:"layers",write:{overridePolicy(e,t,r){const n=this.originOf("sublayers"),i=g.OriginId.PORTAL_ITEM;let o=!0;if(g.nameToId(n)===i&&g.nameToId(r.origin)>i){const t=e.some((e=>e.hasUserOverrides()));o=this._sublayersCollectionChanged||t}return{enabled:o,ignoreOrigin:!0}}}}})],V.prototype,"sublayers",void 0),r.__decorate([h.property({type:k})],V.prototype,"timeInfo",void 0),r.__decorate([h.property({json:{origins:{"portal-item":{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],V.prototype,"title",void 0),r.__decorate([m.reader("service","title",["name"])],V.prototype,"readTitleFromService",null),r.__decorate([h.property({json:{read:!1}})],V.prototype,"type",void 0),V=r.__decorate([_.subclass(H)],V);return V}));
