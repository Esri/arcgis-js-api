/* Copyright 2014 Mozilla Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

define([],function(){"use strict";var e=function(){function e(){}function n(e,n){for(var r,o,a=0,t=[],i=16;i>0&&!e[i-1];)i--;t.push({children:[],index:0});var c,s=t[0];for(r=0;i>r;r++){for(o=0;o<e[r];o++){for(s=t.pop(),s.children[s.index]=n[a];s.index>0;)s=t.pop();for(s.index++,t.push(s);t.length<=r;)t.push(c={children:[],index:0}),s.children[s.index]=c.children,s=c;a++}i>r+1&&(t.push(c={children:[],index:0}),s.children[s.index]=c.children,s=c)}return t[0].children}function r(e,n,r){return 64*((e.blocksPerLine+1)*n+r)}function o(e,n,o,a,t,i,s,f,u){function l(){if(I>0)return I--,H>>I&1;if(H=e[n++],255===H){var r=e[n++];if(r)throw"unexpected marker: "+(H<<8|r).toString(16)}return I=7,H>>>7}function h(e){for(var n=e;;){if(n=n[l()],"number"==typeof n)return n;if("object"!=typeof n)throw"invalid huffman sequence"}}function v(e){for(var n=0;e>0;)n=n<<1|l(),e--;return n}function m(e){if(1===e)return 1===l()?1:-1;var n=v(e);return n>=1<<e-1?n:n+(-1<<e)+1}function b(e,n){var r=h(e.huffmanTableDC),o=0===r?0:m(r);e.blockData[n]=e.pred+=o;for(var a=1;64>a;){var t=h(e.huffmanTableAC),i=15&t,s=t>>4;if(0!==i){a+=s;var f=c[a];e.blockData[n+f]=m(i),a++}else{if(15>s)break;a+=16}}}function k(e,n){var r=h(e.huffmanTableDC),o=0===r?0:m(r)<<u;e.blockData[n]=e.pred+=o}function p(e,n){e.blockData[n]|=l()<<u}function d(e,n){if(M>0)return void M--;for(var r=i,o=s;o>=r;){var a=h(e.huffmanTableAC),t=15&a,f=a>>4;if(0!==t){r+=f;var l=c[r];e.blockData[n+l]=m(t)*(1<<u),r++}else{if(15>f){M=v(f)+(1<<f)-1;break}r+=16}}}function g(e,n){for(var r,o,a=i,t=s,f=0;t>=a;){var b=c[a];switch(R){case 0:if(o=h(e.huffmanTableAC),r=15&o,f=o>>4,0===r)15>f?(M=v(f)+(1<<f),R=4):(f=16,R=1);else{if(1!==r)throw"invalid ACn encoding";P=m(r),R=f?2:3}continue;case 1:case 2:e.blockData[n+b]?e.blockData[n+b]+=l()<<u:(f--,0===f&&(R=2===R?3:0));break;case 3:e.blockData[n+b]?e.blockData[n+b]+=l()<<u:(e.blockData[n+b]=P<<u,R=0);break;case 4:e.blockData[n+b]&&(e.blockData[n+b]+=l()<<u)}a++}4===R&&(M--,0===M&&(R=0))}function C(e,n,o,a,t){var i=o/_|0,c=o%_,s=i*e.v+a,f=c*e.h+t,u=r(e,s,f);n(e,u)}function D(e,n,o){var a=o/e.blocksPerLine|0,t=o%e.blocksPerLine,i=r(e,a,t);n(e,i)}var P,w,L,y,x,T,A,_=(o.precision,o.samplesPerLine,o.scanLines,o.mcusPerLine),U=o.progressive,Y=(o.maxH,o.maxV,n),H=0,I=0,M=0,R=0,V=a.length;A=U?0===i?0===f?k:p:0===f?d:g:b;var z,j,q=0;j=1===V?a[0].blocksPerLine*a[0].blocksPerColumn:_*o.mcusPerColumn,t||(t=j);for(var S,B;j>q;){for(L=0;V>L;L++)a[L].pred=0;if(M=0,1===V)for(w=a[0],T=0;t>T;T++)D(w,A,q),q++;else for(T=0;t>T;T++){for(L=0;V>L;L++)for(w=a[L],S=w.h,B=w.v,y=0;B>y;y++)for(x=0;S>x;x++)C(w,A,q,y,x);q++}if(I=0,z=e[n]<<8|e[n+1],65280>=z)throw"marker was not found";if(!(z>=65488&&65495>=z))break;n+=2}return n-Y}function a(e,n,r){for(var o,a,t,i,c,k,p,d,g,C,D,P,w,L,y,x,T,A=e.quantizationTable,_=e.blockData,U=0;64>U;U+=8)g=_[n+U],C=_[n+U+1],D=_[n+U+2],P=_[n+U+3],w=_[n+U+4],L=_[n+U+5],y=_[n+U+6],x=_[n+U+7],g*=A[U],0!==(C|D|P|w|L|y|x)?(C*=A[U+1],D*=A[U+2],P*=A[U+3],w*=A[U+4],L*=A[U+5],y*=A[U+6],x*=A[U+7],o=m*g+128>>8,a=m*w+128>>8,t=D,i=y,c=b*(C-x)+128>>8,d=b*(C+x)+128>>8,k=P<<4,p=L<<4,o=o+a+1>>1,a=o-a,T=t*v+i*h+128>>8,t=t*h-i*v+128>>8,i=T,c=c+p+1>>1,p=c-p,d=d+k+1>>1,k=d-k,o=o+i+1>>1,i=o-i,a=a+t+1>>1,t=a-t,T=c*l+d*u+2048>>12,c=c*u-d*l+2048>>12,d=T,T=k*f+p*s+2048>>12,k=k*s-p*f+2048>>12,p=T,r[U]=o+d,r[U+7]=o-d,r[U+1]=a+p,r[U+6]=a-p,r[U+2]=t+k,r[U+5]=t-k,r[U+3]=i+c,r[U+4]=i-c):(T=m*g+512>>10,r[U]=T,r[U+1]=T,r[U+2]=T,r[U+3]=T,r[U+4]=T,r[U+5]=T,r[U+6]=T,r[U+7]=T);for(var Y=0;8>Y;++Y)g=r[Y],C=r[Y+8],D=r[Y+16],P=r[Y+24],w=r[Y+32],L=r[Y+40],y=r[Y+48],x=r[Y+56],0!==(C|D|P|w|L|y|x)?(o=m*g+2048>>12,a=m*w+2048>>12,t=D,i=y,c=b*(C-x)+2048>>12,d=b*(C+x)+2048>>12,k=P,p=L,o=(o+a+1>>1)+4112,a=o-a,T=t*v+i*h+2048>>12,t=t*h-i*v+2048>>12,i=T,c=c+p+1>>1,p=c-p,d=d+k+1>>1,k=d-k,o=o+i+1>>1,i=o-i,a=a+t+1>>1,t=a-t,T=c*l+d*u+2048>>12,c=c*u-d*l+2048>>12,d=T,T=k*f+p*s+2048>>12,k=k*s-p*f+2048>>12,p=T,g=o+d,x=o-d,C=a+p,y=a-p,D=t+k,L=t-k,P=i+c,w=i-c,g=16>g?0:g>=4080?255:g>>4,C=16>C?0:C>=4080?255:C>>4,D=16>D?0:D>=4080?255:D>>4,P=16>P?0:P>=4080?255:P>>4,w=16>w?0:w>=4080?255:w>>4,L=16>L?0:L>=4080?255:L>>4,y=16>y?0:y>=4080?255:y>>4,x=16>x?0:x>=4080?255:x>>4,_[n+Y]=g,_[n+Y+8]=C,_[n+Y+16]=D,_[n+Y+24]=P,_[n+Y+32]=w,_[n+Y+40]=L,_[n+Y+48]=y,_[n+Y+56]=x):(T=m*g+8192>>14,T=-2040>T?0:T>=2024?255:T+2056>>4,_[n+Y]=T,_[n+Y+8]=T,_[n+Y+16]=T,_[n+Y+24]=T,_[n+Y+32]=T,_[n+Y+40]=T,_[n+Y+48]=T,_[n+Y+56]=T)}function t(e,n){for(var o=n.blocksPerLine,t=n.blocksPerColumn,i=new Int16Array(64),c=0;t>c;c++)for(var s=0;o>s;s++){var f=r(n,c,s);a(n,f,i)}return n.blockData}function i(e){return 0>=e?0:e>=255?255:e}var c=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),s=4017,f=799,u=3406,l=2276,h=1567,v=3784,m=5793,b=2896;return e.prototype={parse:function(e){function r(){var n=e[u]<<8|e[u+1];return u+=2,n}function a(){var n=r(),o=e.subarray(u,u+n-2);return u+=o.length,o}function i(e){for(var n=Math.ceil(e.samplesPerLine/8/e.maxH),r=Math.ceil(e.scanLines/8/e.maxV),o=0;o<e.components.length;o++){j=e.components[o];var a=Math.ceil(Math.ceil(e.samplesPerLine/8)*j.h/e.maxH),t=Math.ceil(Math.ceil(e.scanLines/8)*j.v/e.maxV),i=n*j.h,c=r*j.v,s=64*c*(i+1);j.blockData=new Int16Array(s),j.blocksPerLine=a,j.blocksPerColumn=t}e.mcusPerLine=n,e.mcusPerColumn=r}var s,f,u=0,l=(e.length,null),h=null,v=[],m=[],b=[],k=r();if(65496!==k)throw"SOI not found";for(k=r();65497!==k;){var p,d,g;switch(k){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var C=a();65504===k&&74===C[0]&&70===C[1]&&73===C[2]&&70===C[3]&&0===C[4]&&(l={version:{major:C[5],minor:C[6]},densityUnits:C[7],xDensity:C[8]<<8|C[9],yDensity:C[10]<<8|C[11],thumbWidth:C[12],thumbHeight:C[13],thumbData:C.subarray(14,14+3*C[12]*C[13])}),65518===k&&65===C[0]&&100===C[1]&&111===C[2]&&98===C[3]&&101===C[4]&&(h={version:C[5]<<8|C[6],flags0:C[7]<<8|C[8],flags1:C[9]<<8|C[10],transformCode:C[11]});break;case 65499:for(var D,P=r(),w=P+u-2;w>u;){var L=e[u++],y=new Uint16Array(64);if(L>>4===0)for(d=0;64>d;d++)D=c[d],y[D]=e[u++];else{if(L>>4!==1)throw"DQT: invalid table spec";for(d=0;64>d;d++)D=c[d],y[D]=r()}v[15&L]=y}break;case 65472:case 65473:case 65474:if(s)throw"Only single frame JPEGs supported";r(),s={},s.extended=65473===k,s.progressive=65474===k,s.precision=e[u++],s.scanLines=r(),s.samplesPerLine=r(),s.components=[],s.componentIds={};var x,T=e[u++],A=0,_=0;for(p=0;T>p;p++){x=e[u];var U=e[u+1]>>4,Y=15&e[u+1];U>A&&(A=U),Y>_&&(_=Y);var H=e[u+2];g=s.components.push({h:U,v:Y,quantizationTable:v[H]}),s.componentIds[x]=g-1,u+=3}s.maxH=A,s.maxV=_,i(s);break;case 65476:var I=r();for(p=2;I>p;){var M=e[u++],R=new Uint8Array(16),V=0;for(d=0;16>d;d++,u++)V+=R[d]=e[u];var z=new Uint8Array(V);for(d=0;V>d;d++,u++)z[d]=e[u];p+=17+V,(M>>4===0?b:m)[15&M]=n(R,z)}break;case 65501:r(),f=r();break;case 65498:var j,q=(r(),e[u++]),S=[];for(p=0;q>p;p++){var B=s.componentIds[e[u++]];j=s.components[B];var E=e[u++];j.huffmanTableDC=b[E>>4],j.huffmanTableAC=m[15&E],S.push(j)}var G=e[u++],J=e[u++],N=e[u++],O=o(e,u,s,S,f,G,J,N>>4,15&N);u+=O;break;case 65535:255!==e[u]&&u--;break;default:if(255===e[u-3]&&e[u-2]>=192&&e[u-2]<=254){u-=3;break}throw"unknown JPEG marker "+k.toString(16)}k=r()}for(this.width=s.samplesPerLine,this.height=s.scanLines,this.jfif=l,this.eof=u,this.adobe=h,this.components=[],p=0;p<s.components.length;p++)j=s.components[p],this.components.push({output:t(s,j),scaleX:j.h/s.maxH,scaleY:j.v/s.maxV,blocksPerLine:j.blocksPerLine,blocksPerColumn:j.blocksPerColumn});this.numComponents=this.components.length},_getLinearizedBlockData:function(e,n){var r,o,a,t,i,c,s,f,u,l,h,v=this.width/e,m=this.height/n,b=0,k=this.components.length,p=e*n*k,d=new Uint8Array(p),g=new Uint32Array(e),C=4294967288;for(s=0;k>s;s++){for(r=this.components[s],o=r.scaleX*v,a=r.scaleY*m,b=s,h=r.output,t=r.blocksPerLine+1<<3,i=0;e>i;i++)f=0|i*o,g[i]=(f&C)<<3|7&f;for(c=0;n>c;c++)for(f=0|c*a,l=t*(f&C)|(7&f)<<3,i=0;e>i;i++)d[b]=h[l+g[i]],b+=k}var D=this.decodeTransform;if(D)for(s=0;p>s;)for(f=0,u=0;k>f;f++,s++,u+=2)d[s]=(d[s]*D[u]>>8)+D[u+1];return d},_isColorConversionNeeded:function(){return this.adobe&&this.adobe.transformCode?!0:3===this.numComponents?!0:!1},_convertYccToRgb:function(e){for(var n,r,o,a=0,t=e.length;t>a;a+=3)n=e[a],r=e[a+1],o=e[a+2],e[a]=i(n-179.456+1.402*o),e[a+1]=i(n+135.459-.344*r-.714*o),e[a+2]=i(n-226.816+1.772*r);return e},_convertYcckToRgb:function(e){for(var n,r,o,a,t=0,c=0,s=e.length;s>c;c+=4){n=e[c],r=e[c+1],o=e[c+2],a=e[c+3];var f=-122.67195406894+r*(-660635669420364e-19*r+.000437130475926232*o-54080610064599e-18*n+.00048449797120281*a-.154362151871126)+o*(-.000957964378445773*o+.000817076911346625*n-.00477271405408747*a+1.53380253221734)+n*(.000961250184130688*n-.00266257332283933*a+.48357088451265)+a*(-.000336197177618394*a+.484791561490776),u=107.268039397724+r*(219927104525741e-19*r-.000640992018297945*o+.000659397001245577*n+.000426105652938837*a-.176491792462875)+o*(-.000778269941513683*o+.00130872261408275*n+.000770482631801132*a-.151051492775562)+n*(.00126935368114843*n-.00265090189010898*a+.25802910206845)+a*(-.000318913117588328*a-.213742400323665),l=-20.810012546947+r*(-.000570115196973677*r-263409051004589e-19*o+.0020741088115012*n-.00288260236853442*a+.814272968359295)+o*(-153496057440975e-19*o-.000132689043961446*n+.000560833691242812*a-.195152027534049)+n*(.00174418132927582*n-.00255243321439347*a+.116935020465145)+a*(-.000343531996510555*a+.24165260232407);e[t++]=i(f),e[t++]=i(u),e[t++]=i(l)}return e},_convertYcckToCmyk:function(e){for(var n,r,o,a=0,t=e.length;t>a;a+=4)n=e[a],r=e[a+1],o=e[a+2],e[a]=i(434.456-n-1.402*o),e[a+1]=i(119.541-n+.344*r+.714*o),e[a+2]=i(481.816-n-1.772*r);return e},_convertCmykToRgb:function(e){for(var n,r,o,a,t=0,i=-16581375,c=1/255/255,s=0,f=e.length;f>s;s+=4){n=e[s],r=e[s+1],o=e[s+2],a=e[s+3];var u=n*(-4.387332384609988*n+54.48615194189176*r+18.82290502165302*o+212.25662451639585*a-72734.4411664936)+r*(1.7149763477362134*r-5.6096736904047315*o-17.873870861415444*a-1401.7366389350734)+o*(-2.5217340131683033*o-21.248923337353073*a+4465.541406466231)-a*(21.86122147463605*a+48317.86113160301),l=n*(8.841041422036149*n+60.118027045597366*r+6.871425592049007*o+31.159100130055922*a-20220.756542821975)+r*(-15.310361306967817*r+17.575251261109482*o+131.35250912493976*a-48691.05921601825)+o*(4.444339102852739*o+9.8632861493405*a-6341.191035517494)-a*(20.737325471181034*a+47890.15695978492),h=n*(.8842522430003296*n+8.078677503112928*r+30.89978309703729*o-.23883238689178934*a-3616.812083916688)+r*(10.49593273432072*r+63.02378494754052*o+50.606957656360734*a-28620.90484698408)+o*(.03296041114873217*o+115.60384449646641*a-49363.43385999684)-a*(22.33816807309886*a+45932.16563550634);e[t++]=u>=0?255:i>=u?0:255+u*c|0,e[t++]=l>=0?255:i>=l?0:255+l*c|0,e[t++]=h>=0?255:i>=h?0:255+h*c|0}return e},getData:function(e,n,r){if(this.numComponents>4)throw"Unsupported color mode";var o=this._getLinearizedBlockData(e,n);if(3===this.numComponents)return this._convertYccToRgb(o);if(4===this.numComponents){if(this._isColorConversionNeeded())return r?this._convertYcckToRgb(o):this._convertYcckToCmyk(o);if(r)return this._convertCmykToRgb(o)}return o}},e}();return e});