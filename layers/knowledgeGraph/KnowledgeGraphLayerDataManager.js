/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/Logger","../../core/maybe","../../core/sql","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/accessorSupport/decorators/subclass","../../geohash/geohashUtils","../../geometry/Polygon","../../geometry/projection","../../geometry/support/spatialReferenceUtils","./SessionMemoryStorage","../../rest/knowledgeGraphService","../../rest/knowledgeGraph/GraphQueryStreaming","../../rest/support/Query"],(function(e,t,n,r,o,a,i,s,p,l,d,c,y,h,m,u,g,f,w,T){"use strict";const b="ESRI__ID",D="ESRI__ORIGIN_ID",M="ESRI__DESTINATION_ID",I="ESRI__LAYOUT_GEOMETRY",_=12,E=a.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");e.KnowledgeGraphLayerDataManager=function(e){function n(t){var n;(n=e.call(this,t)||this).inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},n.entityTypeNames=new Set,n.relationshipTypeNames=new Set,n.geographicLookup=new Map,n.sublayerCaches=new Map,n._processingCacheUpdatesLookup=new Map,n._memberIdTypeLookup=new Map;const r=new Map;return t.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&(r.set(e.name,"entity"),n._processingCacheUpdatesLookup.set(e.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||n.entityTypeNames.add(e.name),e.properties?.forEach((t=>{t.geometryType&&"esriGeometryNull"!==t.geometryType&&n.geographicLookup.set(e.name,{name:t.name?t.name:"",geometryType:t.geometryType})})))})),t.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&(r.set(e.name,"relationship"),n._processingCacheUpdatesLookup.set(e.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||n.relationshipTypeNames.add(e.name),e.properties?.forEach((t=>{t.geometryType&&"esriGeometryNull"!==t.geometryType&&n.geographicLookup.set(e.name,{name:t.name?t.name:"",geometryType:t.geometryType})})))})),t.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,o)=>{if("entity"===r.get(o))n.entityTypeNames.add(o);else{if("relationship"!==r.get(o))return E.warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void t.inclusionModeDefinition?.namedTypeDefinitions.delete(o);n.relationshipTypeNames.add(o)}const a=new Map;e.members?.forEach((e=>{n._memberIdTypeLookup.set(e.id,o);const t=n.getById(e.id);t&&a.set(e.id,t)})),n.sublayerCaches.set(o,a)})),n}t._inheritsLoose(n,e);var r=n.prototype;return r.addToLayerInclusionSet=function(){var e=t._asyncToGenerator((function*(e,t=!1){e.forEach(((e,t)=>{if(!this.inclusionModeDefinition)throw new o("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);if(n.useAllData)throw new o("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");n.members||(n.members=new Map),n.members.set(t,{id:t}),this._memberIdTypeLookup.set(t,e)}}else{const n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),this._memberIdTypeLookup.set(t,e)}})),t&&(yield this.refreshCacheContent(Array.from(e.keys())))}));function n(t){return e.apply(this,arguments)}return n}(),r.getById=function(e){return g.getInstance().readFromStoreById(e)},r.getData=function(){var e=t._asyncToGenerator((function*(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new T({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name?t.objectType.name:""),o=i.unwrap(r.outFields),a=i.unwrap(r.geometry);let s="",p="";a&&a.extent&&(s=y.encodeGeohash(a.extent.ymin,a.extent.xmin,_),p=y.encodeGeohash(a.extent.ymax,a.extent.xmax,_)),o&&1===o.length&&o[0]===b&&"1=1"===i.unwrap(r.where)||(yield Promise.all(n||[]));const l=this.sublayerCaches.has(t.objectType.name?t.objectType.name:"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],d=[];return l.forEach((n=>{if(n.geometry=e.linkChartDiagramLookup.get(n.attributes[t.objectIdField]),n.attributes[I]=n.geometry,s&&p){const r=e.linkChartGeohashLookup.get(n.attributes[t.objectIdField]);r?r>=s&&r<=p&&d.push(n):d.push(n)}else d.push(n)})),d}return this.retrieveDataFromService(r,t,n)}));function n(t,n,r){return e.apply(this,arguments)}return n}(),r.refreshCacheContent=function(){var e=t._asyncToGenerator((function*(e,n,r){var a=this;const i=g.getInstance(),s=[],p=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this._memberIdTypeLookup.has(e)){const t=this._memberIdTypeLookup.get(e);p.has(t)?p.get(t)?.push(e):p.set(t,[e])}})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?p.set(t,null):e.members&&e.members.forEach((e=>{p.has(t)&&null!==p.get(t)?p.get(t)?.push(e.id):p.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&p.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&p.set(e.name,null)})));for(const[d,c]of p){const e=new Promise((e=>{const s=function(){var e=t._asyncToGenerator((function*(){const e=new Set,t=[];let s,p="",y=!1;if(n||l.get(d)?.properties?.forEach((t=>{t.name&&e.add(t.name)})),r&&a.geographicLookup.has(d)){const t=a.geographicLookup.get(d)?.name;t&&e.add(t)}if(a.entityTypeNames.has(d))p=`MATCH (n:${d}) ${c?"WHERE id(n) IN $ids ":""}return ID(n)`,e.forEach((e=>{p+=`, n.${e}`,t.push(e)}));else{if(!a.relationshipTypeNames.has(d))throw new o("knowledge-graph:layer-data-manager",`The graph type of ${d} could not be determined.  Was this type set in the KG data model?`);y=!0,p=`MATCH ()-[n:${d}]->() ${c?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`}s=new w(c?{openCypherQuery:p,bindParameters:{ids:c}}:{openCypherQuery:p});const h=(yield f.executeQueryStreaming(a.knowledgeGraph,s)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=yield h.read();if(e)break;const r=[];for(let a=0;a<n.length;a++){const e=n[a];let o=0,i=0;const s={properties:{}};for(s.id=e[o],o++,i++,y&&(s.originId=e[o],o++,i++,s.destinationId=e[o],o++,i++);o<e.length;o++)s.properties[t[o-i]]=e[o];r.push(s)}const o=i.writeToStore(r,b,a.geographicLookup.get(d)?.name);a.sublayerCaches.has(d)||a.sublayerCaches.set(d,new Map);const s=a.sublayerCaches.get(d);o.forEach((e=>{s?.set(e.attributes[b],e)}))}}));return function(){return e.apply(this,arguments)}}();s().then((()=>{e(null)}))}));s.push(e),this._processingCacheUpdatesLookup.get(d)?.push(e)}yield Promise.all(s)}));function n(t,n,r){return e.apply(this,arguments)}return n}(),r.removeFromLayer=function(e){const t=new Set;e.forEach((e=>{this._memberIdTypeLookup.get(e)&&t.add(this._memberIdTypeLookup.get(e)),this._memberIdTypeLookup.delete(e),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((t=>{t.members?.has(e)&&t.members.delete(e)}))})),t.forEach((t=>{this.sublayerCaches.get(t)?.forEach(((n,r)=>{e.includes(r)&&this.sublayerCaches.get(t)?.delete(r)}))}))},r.retrieveDataFromService=function(){var e=t._asyncToGenerator((function*(e,t,n){const r=g.getInstance(),o=new Set,a=[];let p,l="",d=[],c=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);const y="relationship"===t.graphType;if(!this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)if(i.isSome(e.objectIds)&&c&&c.length>0){const t=i.unwrap(e.objectIds);e.objectIds=c.filter((e=>t.includes(e)))}else if(i.isSome(e.objectIds))c=i.unwrap(e.objectIds);else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=c}if(i.isSome(e.outFields)){const n=i.unwrap(e.outFields);n.includes("*")?t.fields.forEach((e=>{o.add(e.name)})):n.forEach((e=>{e!==b&&e!==t.geometryFieldName&&o.add(e)}))}if(i.isSome(e.geometry)){const n=i.unwrap(e.geometry);let r;if(n?.extent?.spatialReference&&!n.spatialReference?.isWGS84?(yield m.initializeProjection(n.extent.spatialReference,u.WGS84),r=m.project(n.extent,u.WGS84)):r=n.extent,i.isSome(e.where)&&"1=1"!==i.unwrap(e.where)){const n=yield s.parseWhereClause(i.unwrap(e.where).toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&o.add(e.name)}))}l=y?`Match ()-[n:${t.objectType.name}]-() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,i.unwrap(e).returnGeometry&&t.geometryFieldName&&o.add(t.geometryFieldName),o.forEach((e=>{l+=`, n.${e}`,a.push(e)})),p=new w({openCypherQuery:l,bindParameters:{param_filter_geom:new h({rings:[[[r.xmin,r.ymin],[r.xmin,r.ymax],[r.xmax,r.ymax],[r.xmax,r.ymin],[r.xmin,r.ymin]]]})}})}else{let n="";if(i.isSome(e.where)&&"1=1"!==i.unwrap(e.where)){const r=yield s.parseWhereClause(i.unwrap(e.where),t.fieldsIndex);t.fields.forEach((e=>{r.fieldNames.includes(e.name)&&o.add(e.name)}));const a=["column-reference","string","number","binary-expression"],p=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let l=!1;const d=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&a.includes(e.left.type)&&a.includes(e.right.type)&&p.includes(e.operator))return`${d(e.left)} ${e.operator} ${d(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return l=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return l=!0,"";{let n=e.right.value;"%"===n.charAt(0)&&(n=n.slice(1)),"%"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),t+=`'${n.toLowerCase()}')`}return t}return l=!0,""};n=d(r.parseTree),l&&(n="")}let r="";r=y?`Match ()-[n:${t.objectType.name}]-()`:`Match (n:${t.objectType.name})`;let l=!1;c&&(l=!0,r+=" WHERE ID(n) IN $ids"),n&&(r+=l?" AND":" WHERE",r+=` ${n}`),r+=" return ID(n)",y&&(r+=", id(startNode(n)), id(endNode(n))"),i.unwrap(e).returnGeometry&&t.geometryFieldName&&o.add(t.geometryFieldName),o.forEach((e=>{r+=`, n.${e}`,a.push(e)})),p=new w(c?{openCypherQuery:r,bindParameters:{ids:c}}:{openCypherQuery:r})}const T=(yield f.executeQueryStreaming(t.parentCompositeLayer.dataManager.knowledgeGraph,p,n)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=yield T.read();if(e)break;const o=[];for(let t=0;t<n.length;t++){const e=n[t];let r=0,i=0;const s={properties:{}};for(s.id=e[r],r++,i++,y&&(s.originId=e[r],r++,i++,s.destinationId=e[r],r++,i++);r<e.length;r++)s.properties[a[r-i]]=e[r];o.push(s)}d=d.concat(r.writeToStore(o,b,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return d}));function n(t,n,r){return e.apply(this,arguments)}return n}(),n}(r),n.__decorate([p.property()],e.KnowledgeGraphLayerDataManager.prototype,"knowledgeGraph",void 0),n.__decorate([p.property()],e.KnowledgeGraphLayerDataManager.prototype,"inclusionModeDefinition",void 0),n.__decorate([p.property()],e.KnowledgeGraphLayerDataManager.prototype,"entityTypeNames",void 0),n.__decorate([p.property()],e.KnowledgeGraphLayerDataManager.prototype,"relationshipTypeNames",void 0),n.__decorate([p.property()],e.KnowledgeGraphLayerDataManager.prototype,"geographicLookup",void 0),n.__decorate([p.property()],e.KnowledgeGraphLayerDataManager.prototype,"sublayerCaches",void 0),e.KnowledgeGraphLayerDataManager=n.__decorate([c.subclass("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],e.KnowledgeGraphLayerDataManager),e.GEOHASH_ENCODING_PRECISION=_,e.MOCK_DESTINATION_ID_FIELD_NAME=M,e.MOCK_LAYOUT_GEOMETRY_FIELD_NAME=I,e.MOCK_OID_FIELD_NAME=b,e.MOCK_ORIGIN_ID_FIELD_NAME=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
