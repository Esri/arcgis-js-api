define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/has","dojo/io-query","../kernel","../urlUtils","../SpatialReference","./TiledMapServiceLayer","./ArcGISMapServiceLayer","./TileInfo","./TimeInfo","./TileMap"],function(e,r,i,s,t,a,n,o,l,c,h,_,d,f,p){var g=r([h,_],{declaredClass:"esri.layers.ArcGISTiledMapServiceLayer",_agolAttrs:["Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Elevation/World_Hillshade","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Ocean_Basemap","Reference/World_Boundaries_and_Places","Reference/World_Boundaries_and_Places_Alternate","Reference/World_Transportation","World_Imagery","World_Street_Map","World_Topo_Map"],_isReference:!1,_referenceLayers:["Canvas/World_Dark_Gray_Reference","Canvas/World_Light_Gray_Reference","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Boundaries_and_Places_Alternate","Reference/World_Reference_Overlay","Reference/World_Transportation"],constructor:function(r,t){t&&(t.roundrobin&&(e.deprecated(this.declaredClass+" : Constructor option 'roundrobin' deprecated. Use option 'tileServers'."),t.tileServers=t.roundrobin),this._setTileServers(t.tileServers),this._loadCallback=t.loadCallback),this._params=i.mixin({},this._url.query);var a=["servicesdev.arcgisonline.com/arcgis/rest/services","services.arcgisonline.com/arcgis/rest/services","servicesqa.arcgisonline.com/arcgis/rest/services"],n=s.some(a,function(e){return r.toLowerCase().indexOf(e.toLowerCase())>-1});n?(this.resampling=!(t&&t.resampling===!1),this.resampling&&(this.tileMap=new p(this))):this.resampling=t&&null!=t.resampling?t.resampling:void 0,this._initLayer=i.hitch(this,this._initLayer);var o=t&&t.resourceInfo;o?this._initLayer(o):(this._load=i.hitch(this,this._load),this._load())},_TILE_FORMATS:{PNG:"png",PNG8:"png",PNG24:"png",PNG32:"png",JPG:"jpg",JPEG:"jpg",GIF:"gif"},_setTileServers:function(e){if(e&&e.length>0){this.tileServers=e;var r,i=e.length;for(r=0;i>r;r++)e[r]=l.urlToObject(e[r]).path}},_initLayer:function(e){this.inherited(arguments),this.resourceInfo=t.toJson(e),this.tileInfo=new d(e.tileInfo),this.resampling=null==this.resampling?!!e.resampling:this.resampling,!this.spatialReference&&this.tileInfo.spatialReference&&(this.spatialReference=new c(this.tileInfo.spatialReference.toJson())),this.isPNG32="PNG24"===this.tileInfo.format||"PNG32"===this.tileInfo.format,e.timeInfo&&(this.timeInfo=new f(e.timeInfo));var r=this._url.path,i=this._loadCallback,s="file:"===window.location.protocol?"http:":window.location.protocol,a=r.match(/^https?\:\/\/(server|services)\.arcgisonline\.com\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/mapserver/i),n=a&&a[2];if(!this.tileServers)if(e.tileServers)this._setTileServers(e.tileServers);else{var o=-1!==r.search(/^https?\:\/\/server\.arcgisonline\.com/i),l=-1!==r.search(/^https?\:\/\/services\.arcgisonline\.com/i);(o||l)&&this._setTileServers([r,r.replace(o?/server\.arcgisonline/i:/services\.arcgisonline/i,o?"services.arcgisonline":"server.arcgisonline")])}if(n){n=n.toLowerCase();var h,_;for(h=0;h<this._agolAttrs.length;h++)if(_=this._agolAttrs[h],_.toLowerCase()===n){this.hasAttributionData=!0,this.attributionDataUrl=this.attributionDataUrl||s+"//static.arcgis.com/attribution/"+_;break}for(h=0;h<this._referenceLayers.length;h++)if(_=this._referenceLayers[h],_.toLowerCase()===n){this._isReference=!0;break}}this.loaded=!0,this.onLoad(this),i&&(delete this._loadCallback,i(this))},getTileUrl:function(e,r,i){var s=this.tileServers,t=this._getToken(),a=this._url.query,o=(s?s[r%s.length]:this._url.path)+"/tile/"+e+"/"+r+"/"+i;return this.resampling&&!this.tileMap&&(o+="?blankTile=false"),a&&(o+=this.resampling&&!this.tileMap?"&"+n.objectToQuery(a):"?"+n.objectToQuery(a)),!t||a&&a.token||(o+=(-1===o.indexOf("?")?"?":"&")+"token="+t),o=this.addTimestampToURL(o),l.addProxy(o)}});return a("extend-esri")&&i.setObject("layers.ArcGISTiledMapServiceLayer",g,o),g});