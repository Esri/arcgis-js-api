/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/CollectionFlattener","../core/Error","../core/lang","../core/loadAll","../core/Logger","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/has","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/SpatialReference","./Layer","./buildingSublayers/BuildingComponentSublayer","./buildingSublayers/BuildingGroupSublayer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./support/BuildingFilter","./support/BuildingSummaryStatistics","./support/commonProperties","./support/FetchAssociatedFeatureLayer"],(function(e,r,t,i,o,s,a,n,l,u,y,c,p,d,h,b,v,f,S,g,_,m,w,O,I,L,T,x,A,F,B){"use strict";const E=n.getLogger("esri.layers.BuildingSceneLayer"),P=t.ofType(x),j=s.clone(_.sublayersProperty);j.json.origins["web-scene"]={type:[g],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}},j.json.origins["portal-item"]={type:[g],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}};let K=function(r){function t(e){var t;return(t=r.call(this,e)||this).operationalLayerType="BuildingSceneLayer",t.allSublayers=new i({getCollections:()=>[t.sublayers],getChildrenFunction:e=>"building-group"===e.type?e.sublayers:null}),t.sublayers=null,t.sublayerOverrides=null,t.filters=new P,t.activeFilterId=null,t.summaryStatistics=null,t.outFields=null,t.type="building-scene",t}e._inheritsLoose(t,r);var n=t.prototype;return n.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e},n.destroy=function(){this.allSublayers.destroy()},n.readSublayers=function(e,r,t){const i=_.readSublayers(e,r,t);return _.forEachSublayer(i,(e=>e.layer=this)),this.sublayerOverrides&&(this.applySublayerOverrides(i,this.sublayerOverrides),this.sublayerOverrides=null),i},n.applySublayerOverrides=function(e,{overrides:r,context:t}){_.forEachSublayer(e,(e=>e.read(r.get(e.id),t)))},n.readSublayerOverrides=function(e,r){const t=new Map;for(const i of e)null!=i&&"object"==typeof i&&"number"==typeof i.id?t.set(i.id,i):r.messages.push(new o("building-scene-layer:invalid-sublayer-override","Invalid value for sublayer override. Not an object or no id specified.",{value:i}));return{overrides:t,context:r}},n.writeSublayerOverrides=function(e,r,t){const i=[];_.forEachSublayer(this.sublayers,(e=>{const r=e.write({},t);Object.keys(r).length>1&&i.push(r)})),i.length>0&&(r.sublayers=i)},n.writeUnappliedOverrides=function(e,r){r.sublayers=[],e.overrides.forEach((e=>{r.sublayers.push(s.clone(e))}))},n.write=function(e,t){return e=r.prototype.write.call(this,e,t),!t||"web-scene"!==t.origin&&"portal-item"!==t.origin||(this.sublayers?this.writeSublayerOverrides(this.sublayers,e,t):this.sublayerOverrides&&this.writeUnappliedOverrides(this.sublayerOverrides,e)),e},n.read=function(e,t){if(r.prototype.read.call(this,e,t),t&&("web-scene"===t.origin||"portal-item"===t.origin)&&null!=e&&Array.isArray(e.sublayers)){const r=this.readSublayerOverrides(e.sublayers,t);this.sublayers?this.applySublayerOverrides(this.sublayers,r):this.sublayerOverrides=r}},n.readSummaryStatistics=function(e,r){if("string"==typeof r.statisticsHRef){const e=c.join(this.parsedUrl.path,r.statisticsHRef);return new A({url:e})}return null},n.load=function(e){const r=l.isSome(e)?e.signal:null,t=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(y.throwIfAbortError).then((()=>this._fetchService(r))).then((()=>this._fetchAssociatedFeatureService(r)));return this.addResolvingPromise(t),Promise.resolve(this)},n.loadAll=function(){return a.loadAll(this,(e=>{_.forEachSublayer(this.sublayers,(r=>{"building-group"!==r.type&&e(r)})),this.summaryStatistics&&e(this.summaryStatistics)}))},n.saveAs=function(){var r=e._asyncToGenerator((function*(e,r){return this._debouncedSaveOperations(1,{...r,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"},e)}));function t(e,t){return r.apply(this,arguments)}return t}(),n.save=function(){var r=e._asyncToGenerator((function*(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"};return this._debouncedSaveOperations(0,e)}));function t(){return r.apply(this,arguments)}return t}(),n.validateLayer=function(e){if(!e.layerType||"Building"!==e.layerType)throw new o("buildingscenelayer:layer-type-not-supported","BuildingSceneLayer does not support this layer type",{layerType:e.layerType})},n._getTypeKeywords=function(){return["Building"]},n._validateElevationInfo=function(){const e=this.elevationInfo;e&&("absolute-height"!==e.mode&&E.warn(".elevationInfo=","Building scene layers only support absolute-height elevation mode"),e.featureExpressionInfo&&"0"!==e.featureExpressionInfo.expression&&E.warn(".elevationInfo=","Building scene layers do not support featureExpressionInfo"))},n._fetchAssociatedFeatureService=function(){var r=e._asyncToGenerator((function*(e){const r=new B.FetchAssociatedFeatureLayer(this.parsedUrl,this.portalItem,this.apiKey,e);try{this.associatedFeatureServiceItem=yield r.fetchPortalItem()}catch(t){E.warn("Associated feature service item could not be loaded",t)}}));function t(e){return r.apply(this,arguments)}return t}(),e._createClass(t,[{key:"elevationInfo",set:function(e){this._set("elevationInfo",e),this._validateElevationInfo()}}]),t}(T.SceneService(w.ArcGISService(O.OperationalLayer(I.PortalLayer(L.ScaleRangeLayer(u.MultiOriginJSONMixin(m.APIKeyMixin(S))))))));return r.__decorate([p.property({type:["BuildingSceneLayer"]})],K.prototype,"operationalLayerType",void 0),r.__decorate([p.property({readOnly:!0})],K.prototype,"allSublayers",void 0),r.__decorate([p.property(j)],K.prototype,"sublayers",void 0),r.__decorate([b.reader("service","sublayers")],K.prototype,"readSublayers",null),r.__decorate([p.property({type:P,nonNullable:!0,json:{write:!0}})],K.prototype,"filters",void 0),r.__decorate([p.property({type:String,json:{write:!0}})],K.prototype,"activeFilterId",void 0),r.__decorate([p.property({readOnly:!0,type:A})],K.prototype,"summaryStatistics",void 0),r.__decorate([b.reader("summaryStatistics",["statisticsHRef"])],K.prototype,"readSummaryStatistics",null),r.__decorate([p.property({type:[String],json:{read:!1}})],K.prototype,"outFields",void 0),r.__decorate([p.property(F.sceneLayerFullExtent)],K.prototype,"fullExtent",void 0),r.__decorate([p.property({type:["show","hide","hide-children"]})],K.prototype,"listMode",void 0),r.__decorate([p.property(F.readOnlyService(f))],K.prototype,"spatialReference",void 0),r.__decorate([p.property(F.elevationInfo)],K.prototype,"elevationInfo",null),r.__decorate([p.property({json:{read:!1},readOnly:!0})],K.prototype,"type",void 0),r.__decorate([p.property()],K.prototype,"associatedFeatureServiceItem",void 0),K=r.__decorate([v.subclass("esri.layers.BuildingSceneLayer")],K),K}));
