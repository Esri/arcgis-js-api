// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/config","dojo/json","dojo/sniff","../kernel","../Evented","../request","../geometry/Extent","../SpatialReference","../deferredUtils","./PixelBlock","./rasterFormats/LercCodec"],function(e,t,a,i,r,n,o,s,l,d,h,c,p,u,f,m){var g,x,w,v=t(d,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:["U1","U2","U4","U8","U16","U32","S8","S16","S32","F32"],validFormats:["lerc","jpeg","jpg","jpgpng","png","png8","png24","png32","bip","bsq"],_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(e){if(!e)throw"Image Service URL is not defined";this.imageServiceUrl=e,this.registerConnectEvents(),this._loadRasterFormatModules()},read:function(e,t,o){var l=this,d=new i(u._dfdCanceller);if(s("ie")<10)throw"This browser is not supported.";if(!e.imageServiceParameters)throw"Insufficient parameters to read data";var c=a.clone(e.imageServiceParameters),p=e.pixelType;r.some(this.validPixelTypes,function(e){return e===p})||(c.pixelType="F32"),r.some(this.validFormats,function(e){return e.toLowerCase()===c.format.toLowerCase()})||(c.format="lerc");var f,m=e.decodeFunc;return this._prepareGetImageParameters(c),d._pendingDfd=h({url:this.imageServiceUrl+"/exportImage",handleAs:"arraybuffer",content:a.mixin(c,{f:"image"}),load:function(e){var a=c.format.toUpperCase();if("BSQ"!==a&&"BIP"!==a&&(a=l._getFormat(e)),"ERROR"===a){var i=new Error(String.fromCharCode.apply(null,new Uint8Array(e)));return i.log=n.isDebug,void l._resolve([i],null,o,d,!0)}if((void 0===m||null===m)&&(m=l._getFormatDecoderDfd(a)),m){var r=m(e,{width:c.width,height:c.height,planes:null,pixelType:p,noDataValue:c.noData});r.then(function(e){f={pixelBlock:e,extent:c.extent},l._resolve([f,c],"onRasterReadComplete",t,d)},function(e){l._resolve([e],null,o,d,!0)})}else{var i=new Error("Format '"+c.format+"' is not supported.");i.log=n.isDebug,l._resolve([i],null,o,d,!0)}},error:function(e){l._resolve([e],null,o,d,!0)}}),d.promise},onRasterReadComplete:function(){},_prepareGetImageParameters:function(e){if(e.size&&e.bbox){var t=e.size.split(",");if(e.width=parseFloat(t[0]),e.height=parseFloat(t[1]),!e.extent){var i=e.bbox.split(",");e.extent=new c(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]),new p(e.bboxSR))}}else{if(!e.width||Math.floor(e.width)!==e.width||!e.height||Math.floor(e.height)!==e.height)throw"Incorrect Image Dimensions";if(!e.extent||"esri.geometry.Extent"!==e.extent.declaredClass)throw"Incorrect extent";var r=e.extent,n=r.spatialReference.wkid||o.toJson(r.spatialReference.toJson());delete e._ts,a.mixin(e,{bbox:r.xmin+","+r.ymin+","+r.xmax+","+r.ymax,imageSR:n,bboxSR:n,size:e.width+","+e.height},e.disableClientCaching?{_ts:(new Date).getTime()}:{})}},_adjustExtent:function(e,t,a){var i=e.ymax-e.ymin,r=e.xmax-e.xmin;return a>=t?(i=r*t/a,e.ymax=e.ymin+i):(r=i*a/t,e.xmax=e.xmin+r),e},_resolve:function(e,t,a,i,r){t&&this[t].apply(this,e),a&&a.apply(null,e),i&&u._resDfd(i,e,r)},_getFormatDecoderDfd:function(e){var t=null;switch(e){case"LERC":t=this._decodeLerc;break;case"JPEG":t=this._decodeJpeg;break;case"PNG":t=this._decodePng;break;case"BSQ":t=this._decodeBsq;break;case"BIP":t=this._decodeBip}t=a.hitch(this,t);var r=function(e,a){var r=new i;try{var n=t(e,a);r.resolve(n)}catch(o){r.reject(o)}return r};return r},_getFormat:function(e){var t=new Uint8Array(e,0,10),a="";return 255===t[0]&&216===t[1]?a="JPEG":137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]?a="PNG":67===t[0]&&110===t[1]&&116===t[2]&&90===t[3]&&73===t[4]&&109===t[5]&&97===t[6]&&103===t[7]&&101===t[8]&&32===t[9]?a="LERC":String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1&&(a="ERROR"),a},_validateDecodeParams:function(e){if(!e.height||Math.floor(e.height)!==e.height)throw"Height not provided.";if(!e.width||Math.floor(e.width)!==e.width)throw"Width not provided."},_decodeJpeg:function(e,t){if(!g)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(t);var a=new g,i=a.decode(e);if(!b(i,t))throw"The decoded image dimensions are incorrect.";var r,n,o=[];for(r=0;r<i.pixels.length;r++)n=i.pixels[r],o.push(this._calculateBandStatistics(n));var s=new f({width:i.width,height:i.height,pixels:i.pixels,pixelType:"U8",mask:i.mask,statistics:o});return s},_decodePng:function(e,t){if(!x)throw"The png decoder module is not loaded.";this._validateDecodeParams(t);var a=new Uint8Array(e),i=new x(a),r=new Uint8Array(t.width*t.height*4);i.copyToImageData(r,i.decodePixels());var n,o=0,s=0,l=new Uint8Array(t.width*t.height);for(o=0;o<t.width*t.height;o++)l[o]=r[4*o+3];var d=new f({width:t.width,height:t.height,pixels:[],pixelType:"U8",mask:l,statistics:[]});for(o=0;3>o;o++){for(n=new Uint8Array(t.width*t.height),s=0;s<t.width*t.height;s++)n[s]=r[4*s+o];d.addData({pixels:n,statistics:this._calculateBandStatistics(n)})}return d},_decodeBsq:function(e,t){if(!w)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(t),_=t.noDataValue,t.pixelType=D(t.pixelType);var a,i=w.decodeBSQ(e,{bandCount:t.planes,width:t.width,height:t.height,pixelType:y,noDataValue:_}),r=[],n=null;for(a=0;a<i.pixels.length;a++)n=i.pixels[a],r.push(this._calculateBandStatistics(n));var o=new f({width:t.width,height:t.height,pixels:i.pixels,pixelType:t.pixelType,mask:i.maskData,statistics:r});return o},_decodeBip:function(e,t){this._validateDecodeParams(t),_=t.noDataValue,t.pixelType=D(t.pixelType);var a,i=w.decodeBIP(e,{bandCount:t.planes,width:t.width,height:t.height,pixelType:y,noDataValue:_}),r=[],n=null;for(a=0;a<i.pixels.length;a++)n=i.pixels[a],r.push(this._calculateBandStatistics(n));var o=new f({width:t.width,height:t.height,pixels:i.pixels,pixelType:t.pixelType,mask:i.maskData,statistics:r});return o},_decodeLerc:function(e,t){this._validateDecodeParams(t),_=t.noDataValue,t.pixelType=D(t.pixelType);for(var a,i,r=0,n=0,o=e.byteLength-10;o>n;){var s=m.decode(e,{inputOffset:n,encodedMaskData:a,returnMask:0===r?!0:!1,returnEncodedMask:0===r?!0:!1,returnFileInfo:!0,pixelType:y,noDataValue:_});if(n=s.fileInfo.eofOffset,0===r&&(a=s.encodedMaskData,i=new f({width:t.width,height:t.height,pixels:[],pixelType:t.pixelType,mask:s.maskData,statistics:[]})),r++,!b(s,t))throw"The decoded image dimensions are incorrect";i.addData({pixels:s.pixelData,statistics:{minValue:s.minValue,maxValue:s.maxValue,noDataValue:s.noDataValue}})}return i},_calculateBandStatistics:function(e){var t,a=1/0,i=-1/0,r=e.length,n=0;for(t=0;r>t;t++)n=e[t],a=a>n?n:a,i=n>i?n:i;return{minValue:a,maxValue:i}},_loadRasterFormatModules:function(){s("ie")<10||e(["./rasterFormats/JpgPlus","./rasterFormats/Png","./rasterFormats/Raw"],function(e,t,a){g=e,x=t,w=a})}}),y=null,_=null,D=function(e){return"U1"===e||"U2"===e||"U4"===e||"U8"===e?(e="U8",_=Math.pow(2,8)-1,y=Uint8Array,e):"U16"===e?(_=_||Math.pow(2,16)-1,y=Uint16Array,e):"U32"===e?(_=_||Math.pow(2,32)-1,y=Uint32Array,e):"S8"===e?(_=_||0-Math.pow(2,7),y=Int8Array,e):"S16"===e?(_=_||0-Math.pow(2,15),y=Int16Array,e):"S32"===e?(_=_||0-Math.pow(2,31),y=Int32Array,e):(y=Float32Array,e)},b=function(e,t){return e.height!==t.height||e.width!==t.width?!1:!0};return s("extend-esri")&&a.setObject("layers.Raster",v,l),v});