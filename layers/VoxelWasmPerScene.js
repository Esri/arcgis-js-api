/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../request","../core/Logger","../core/mathUtils","../core/promiseUtils","../core/watchUtils","../chunks/vec3","../chunks/vec3f64","../libs/vxl/VxlModule","../views/3d/webgl-engine/lib/intersectorUtils"],(function(t,e,i,s,r,n,a,o,l,h){"use strict";const c=i.getLogger(" esri.layers.VoxelWasmPerScene");return function(){function i(t){this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=4,this._rctx=null,this._renderTargetToRestore=null,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=t,this.initialize()}var d=i.prototype;return d.dbg=function(t,e){this._dbgFlags.has(t)&&(4===t?c.error(e):c.warn(e))},d.removeRenderPlugin=function(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1},d.initialize=function(){this.dbg(1,"--initialize--"),this._readyWatchHandle=n.init(this._view,"ready",(t=>{t&&"local"===this._view.viewingMode?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())})),this._qualityWatchHandle=n.init(this._view,"qualityProfile",(t=>{this.dbg(3,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this.toWasmQuality(t))}))},d.initializeRenderContext=function(t){this.dbg(1,"--initializeRenderContext--");const e=t.renderContext.rctx;"webgl2"===e.webglVersion?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this.initializeWasm(e.gl)):this.dbg(4,"WebGL 1 context only!")},d.uninitializeRenderContext=function(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")},d.restoreFramebuffer=function(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!!!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const e=this._renderTargetToRestore.viewport;this._rctx.setViewport(e.x,e.y,e.width,e.height)},d.bindPreviousDepthToSlot=function(t,e){const i=!!this._rctx,s=!!this._renderTargetToRestore;if(!i||!s)return 0;const r=this._renderTargetToRestore.fbo.depthStencilTexture;return r?(0===e?this._rctx.bindTexture(null,t,!0):this._rctx.bindTexture(r,t,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)},d.setBlendState=function(t,e,i,s){this._rctx?(this._rctx.setBlendingEnabled(1===t),this._rctx.setBlendFunction(e,i),this._rctx.setBlendEquation(s)):this.dbg(4,"setBlendState callback has no rendering context!")},d.setFrontFace=function(t){this._rctx?this._rctx.setFrontFace(t):this.dbg(4,"setFrontFace callback has no rendering context!")},d.setDepthStencilStateFunction=function(t,e,i){this._rctx?(this._rctx.setDepthFunction(i),this._rctx.setDepthTestEnabled(1===t),this._rctx.setDepthWriteEnabled(1===e),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")},d.setRasterizerState=function(t){if(this._rctx)switch(t){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")},d.setViewport=function(t,e,i,s){this._rctx?this._rctx.setViewport(t,e,i,s):this.dbg(4,"setViewport callback has no rendering context!")},d.syncRequestsResponses=function(){this._layers.forEach(((t,i)=>{const s=[];t.responses.forEach(((t,e)=>{s.push(e),this.dbg(2,"responding for requestID:"+e+" size:"+t.size),this._vxl.respond(i,e,t)}));const n=t.responses;for(const e of s)n.delete(e);const a=this._vxl.get_new_requests(i),o=t.abortController.signal;for(const l in a){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const i=a[l],s={responseType:"array-buffer",signal:o};this.dbg(2,"making requestID:"+l+" url:"+i.url),e(i.url,s).then((e=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+l);let s=0;if(e.data.byteLength>0){s=this._vxl._malloc(e.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,s,e.data.byteLength),i=new Uint8Array(e.data);for(let s=0;s<e.data.byteLength;++s)t[s]=i[s]}n.set(+l,{type:i.type,ptr:s,size:e.data.byteLength,success:!0})})).catch((e=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),r.isAbortError(e)||(this.dbg(4,"requestID:"+l+" failed"),n.set(+l,{type:i.type,ptr:0,size:0,success:!1}))}))}}))},d.updateWasmCamera=function(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)},d.isUpdating=function(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0},d.setEnabled=function(t,e){this._layers.forEach(((i,s)=>{i.layerView===t&&(this._vxl.set_enabled(s,e?1:0),this._renderPluginContext.requestRender())}))},d.addVoxelLayer=function(t){if(!this._vxl){const e={layerView:t,resolveCallback:"",rejectCallback:""},i=new Promise(((t,i)=>{e.resolveCallback=t,e.rejectCallback=i}));return this._newLayers.push(e),i}const e=this._addVoxelLayer(t);return e<0?Promise.reject(-1):Promise.resolve(e)},d.removeVoxelLayer=function(t){if(!this._vxl){const e=this._newLayers.findIndex((e=>t===e.layerView));e>=0&&(this._newLayers[e].resolveCallback(-1),this._newLayers.splice(e,1));const i=this._newLayers.length;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}let e=-1;this._layers.forEach(((i,s)=>{i.layerView===t&&(e=s,i.abortController.abort(),this._vxl.remove_layer(e))})),e>=0&&this._layers.delete(e);const i=this._layers.size;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i},d._addVoxelLayer=function(t){const e=t.layer;let i=-1;const s=e.layerData;if(s&&s.data.byteLength>0){const t=this._vxl._malloc(s.data.byteLength),r=new Uint8Array(this._vxl.HEAPU8.buffer,t,s.data.byteLength),n=new Uint8Array(s.data);for(let e=0;e<s.data.byteLength;++e)r[e]=n[e];const a=32662===this._view.spatialReference.wkid&&e.spatialReference.isWGS84?111319.49079327357:1;i=this._vxl.add_layer(e.serviceRoot,t,s.data.byteLength,a,a),this._vxl._free(t)}if(i>=0){const e=r.createAbortController();return this._layers.set(i,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:e}),i}return-1},d.prepareRender=function(t){if(!this._vxl)return;const e=t.viewForward,i=t.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],e[0],e[1],e[2]);const s=this._vxl.cull();this.dbg(2,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=0===this._newLayers.length},d.render=function(t){if(!this._vxl)return!1;for(const i of this._newLayers){const t=this._addVoxelLayer(i.layerView);-1===t?i.rejectCallback(-1):i.resolveCallback(t)}if(this._newLayers=[],t.pass!==this._renderPass)return!1;if(t.slot!==this._renderSlot)return!1;if(0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!0;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this.syncRequestsResponses(),this._vxl.begin_frame();const e=this._renderTargetToRestore.viewport;return e.width===this._viewportWidth&&e.height===this._viewportHeight||(this._viewportWidth=e.width,this._viewportHeight=e.height,this._vxl.set_viewport(e.width,e.height)),0===e.x&&0===e.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0},d.queryDepthRange=function(t){this.dbg(1,"--queryDepthRange--");const e=t.viewForward,i=t.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],e[0],e[1],e[2]),this._vxl.cull();const s={near:5,far:1e4};return s.near=this._vxl.get_near(),s.far=this._vxl.get_far(),s},d.destroy=function(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null),this._qualityWatchHandle&&(this._qualityWatchHandle.remove(),this._qualityWatchHandle=null),this._vxl&&(this._vxl.uninitialize_voxel_wasm(),this._vxl=null)},d.initializeWasm=function(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=l.loadVoxelWASM(t).then((t=>{if(this._vxl=t,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const e=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),i=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),s=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),r=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),n=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),a=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),o=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(e,i,s,r,n,a,o),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const t of this._newLayers)t.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)},d.intersect=function(t,e,i,s,r){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(r[0]<0||r[0]>t.camera.viewport[2]||r[1]<0||r[1]>t.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=t.camera.viewForward,a=t.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],n[0],n[1],n[2]),this.updateWasmCamera(t.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(t,e,i,s,r):this.intersectObject(t,e,i,s,r),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()},d.intersectObject=function(t,e,i,r,n){const l=this._vxl.pick_object(n[0],n[1]);if(l.success){const n=o.create();a.sub(n,r,i),a.normalize(n,n);const c=a.distance(i,r),d=o.create();a.set(d,l.worldX,l.worldY,l.worldZ);const u=o.create();a.sub(u,d,i);const _=o.create();a.scale(_,n,a.dot(u,n));const g=o.create();a.add(g,i,_);const x=a.distance(i,g),v=s.clamp(x/c,0,1),y=t=>{t.intersector="Voxel",t.dist=v,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},f=t.results.min;(null==f.dist||v<f.dist)&&(null==e||e(i,r,v))&&y(f);const b=t.results.max;if(0!==t.options.store&&(null==b.dist||v>b.dist)&&(null==e||e(i,r,v))&&y(b),2===t.options.store){const e=new h.IntersectorResult(t.ray);y(e),t.results.all.push(e)}}},d.intersectDepth=function(t,e,i,r,n){const l=this._vxl.pick_depth(n[0],n[1]);if(l.success){const n=o.create();a.sub(n,r,i),a.normalize(n,n);const c=a.distance(i,r),d=o.create();a.set(d,l.worldX,l.worldY,l.worldZ);const u=o.create();a.sub(u,d,i);const _=o.create();a.scale(_,n,a.dot(u,n));const g=o.create();a.add(g,i,_);const x=a.distance(i,g),v=s.clamp(x/c,0,1),y=t=>{t.intersector="Voxel",t.dist=v,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},f=t.results.min;(null==f.dist||v<f.dist)&&(null==e||e(i,r,v))&&y(f);const b=t.results.max;if(0!==t.options.store&&(null==b.dist||v>b.dist)&&(null==e||e(i,r,v))&&y(b),2===t.options.store){const e=new h.IntersectorResult(t.ray);y(e),t.results.all.push(e)}}},d.toWasmQuality=function(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}},t._createClass(i,[{key:"canRender",get:function(){return!!this._vxl&&"local"===this._view.viewingMode}},{key:"type",get:function(){return"external"}},{key:"isGround",get:function(){return!1}},{key:"slicePlane",get:function(){return!1}},{key:"intersectionHandlerId",get:function(){return"unj"}}]),i}()}));
