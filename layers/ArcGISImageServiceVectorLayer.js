define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/json","dojo/sniff","../kernel","../lang","./GraphicsLayer","./ImageServiceLayerMixin","../renderers/VectorFieldRenderer","../geometry/Point","../geometry/Extent","../graphic","dojox/gfx"],function(e,i,t,r,n,s,a,l,o,h,m,u,d,x){var c=e([l,o],{declaredClass:"esri.layers.ArcGISImageServiceVectorLayer",constructor:function(e,t){this.symbolTileSize=t&&t.symbolTileSize?t.symbolTileSize:50,this._minMag=null,this._maxMag=null;var r=t&&t.rendererStyle?t.rendererStyle:h.STYLE_SINGLE_ARROW;this.setVectorRendererStyle(r);var n=i.clone(this._params);delete n.imageServiceParameters,delete n.pixelFilter,delete n.rendererStyle,delete n.symbolTileSize,this._initialize(e,t),this.geometryType="esriGeometryPoint",this.symbolTileSizeUnits="Pixels",i.mixin(this._params,n)},getField:function(e){return this._getField(e,!0)},setVectorRendererStyle:function(e){this.rendererStyle=e,this._updateVectorFieldRenderer(),this.useDefaultRenderer=!0},setRenderer:function(){this.useDefaultRenderer=!1,this.inherited(arguments)},getFlowRepresentation:function(){return this._vectorFlowRepresentation},onRendererChange:function(){},onResume:function(){this.inherited(arguments),this._toggleTime()},onSuspend:function(){this.inherited(arguments),this._toggleTime()},_refresh:function(){if(n("ie")<10)return void this.onError(new Error("Unable to refresh. This layer is not supported in the current browser."));if(this.hasMultidimensions===!1)return void this.onError(new Error("Unable to refresh. This layer does not have multi-dimensional info."));this.setImageFormat("LERC",!0);var e=this.fullExtent.xmin,t=this.fullExtent.ymax,r=i.clone(this._map.extent),s=this._map.width*(1/this.symbolTileSize);s=s?Math.ceil(s):50;var a=this._map.height*(1/this.symbolTileSize);a=Math.ceil(a?a:s*((r.ymax-r.ymin)/(r.xmax-r.xmin)));var l=(r.xmax-r.xmin)/s,o=(r.ymax-r.ymin)/a;r.xmin=e+Math.floor((r.xmin-e)/l)*l,r.xmax=e+Math.ceil((r.xmax-e)/l)*l,r.ymin=t+Math.floor((r.ymin-t)/o)*o,r.ymax=t+Math.ceil((r.ymax-t)/o)*o,this._requestData(r,s,a)},_drawPixelData:function(){if(this.clear(),this.pixelData){var e=this.pixelData.pixelBlock,i=this.pixelData.extent,t=this.pixelData.locations,n=a.isDefined(e.mask)&&e.mask.length>0;if(e&&i&&t){if(this.useDefaultRenderer&&this.renderer&&(!a.isDefined(this._minMag)||!a.isDefined(this._maxMag))){var s=this._getServiceMinMaxStats();s?(this._minMag=s.min,this._maxMag=s.max):(this._minMag=e.statistics[0].minValue,this._maxMag=e.statistics[0].maxValue);var l={type:"sizeInfo",minSize:x.px2pt(.2*this.symbolTileSize),maxSize:x.px2pt(.8*this.symbolTileSize),minDataValue:this._minMag,maxDataValue:this._maxMag},o=[];o.push(l),o.push({type:"colorInfo"}),this.renderer.setVisualVariables(o)}var h,c,p,f=0,g=0,y=0,_=i.spatialReference?i.spatialReference._getInfo():null;for(f=0;f<e.height;f++)for(g=0;g<e.width;g++,y++)if(h=t[y],(!n||e.mask[y])&&h&&2===h.length){c=new m(h[0],h[1],i.spatialReference),_&&(c.x=u.prototype._normalizeX(c.x,_).x);var S={Magnitude:e.pixels[0][y],Direction:e.pixels[1][y],Location:r.toJson(c.toJson())};p=new d(c,null,S),this.add(p)}}}},_getServiceMinMaxStats:function(){if(!a.isDefined(this.minValues)||!a.isDefined(this.maxValues)||this.minValues.length<2||this.maxValues.length<2)return null;var e=this.minValues[0],i=this.maxValues[0],t=this.minValues[1],r=this.maxValues[1];if(this.pixelFilter&&e&&i&&t&&r){var n=[];n.push([e,i]),n.push([t,r]);var s=this._createPixelData(n);this.pixelFilter(s),s&&s.pixelBlock&&s.pixelBlock.pixels&&s.pixelBlock.pixels.length>0&&(e=s.pixelBlock.pixels[0][0],i=s.pixelBlock.pixels[0][1])}return e&&i?{min:e,max:i}:null},_updateVectorFieldRenderer:function(){var e={type:"sizeInfo",minSize:x.px2pt(.2*this.symbolTileSize),maxSize:x.px2pt(.8*this.symbolTileSize),minDataValue:this._minMag,maxDataValue:this._maxMag},i=[];i.push(e);var t=new h({style:this.rendererStyle,visualVariables:i,flowRepresentation:this._vectorFlowRepresentation});this.setRenderer(t)},_getField:function(e,i){if(a.isDefined(e)){if(i&&(e=e.toLowerCase()),"magnitude"!==e&&"direction"!==e)return null;var t={name:e,alias:e,domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"};return t}},_requestDataErrorHandler:function(e){"CancelError"!==e.name&&(this.clear(),this.onError(e))},_setFlowRepresentation:function(e){e&&this.renderer&&a.isDefined(e.FlowDirection)&&(this._vectorFlowRepresentation="oceanographic"===e.FlowDirection.toLowerCase()?this.renderer.FLOW_TO:this.renderer.FLOW_FROM),this.renderer&&(this.renderer.flowRepresentation=this._vectorFlowRepresentation)}});return n("extend-esri")&&i.setObject("layers.ArcGISImageServiceVectorLayer",c,s),c});