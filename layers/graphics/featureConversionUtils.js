// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],(function(e,r,t,n,o,u,i,a){"use strict";function s(e,r){return e?r?4:3:r?3:2}Object.defineProperty(r,"__esModule",{value:!0}),r.deltaDecodeGeometry=r.deltaEncodeGeometry=r.getQuantizedArea=r.getSignedQuantizedRingArea=r.removeCollinearVectices=r.removeZMValues=r.unquantizeOptimizedGeometry=r.getQuantizedBoundsOptimizedGeometry=r.getBoundsOptimizedGeometry=r.generalizeOptimizedGeometry=r.quantizeOptimizedGeometry=r.quantizeOptimizedFeatureSet=r.unquantizeOptimizedFeatureSet=r.convertFromFeatureSet=r.convertToFeatureSet=r.convertToFeatures=r.convertToGeometry=r.convertFromGeometry=r.convertToFeature=r.convertFromGraphics=r.convertFromFeatures=r.convertFromFeature=r.convertFromNestedArray=r.convertFromPolygon=r.convertToPolygon=r.convertFromPolyline=r.convertFromPolylineFeatures=r.convertToPolyline=r.convertFromMultipoint=r.convertFromMultipointFeatures=r.convertToMultipoint=r.convertToMultipointFeatures=r.convertFromPoint=r.convertFromPointFeatures=r.convertToPoint=r.unquantizeY=r.unquantizeX=r.quantizeY=r.quantizeX=void 0;var l=n.getLogger("esri.tasks.support.optimizedFeatureSet"),c={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},d=function(e,r,t,n,o,u){e[t]=o,e[t+1]=u},h=function(e,r,t,n,o,u){e[t]=o,e[t+1]=u,e[t+2]=r[n+2]},g=function(e,r,t,n,o,u){e[t]=o,e[t+1]=u,e[t+2]=r[n+3]},f=function(e,r,t,n,o,u){e[t]=o,e[t+1]=u,e[t+2]=r[n+2],e[t+3]=r[n+3]};function m(e,r,t,n){if(e){if(t)return r&&n?f:h;if(r&&n)return g}else if(r&&n)return h;return d}function v(e,r){var t=e.scale,n=e.translate;return Math.round((r-n[0])/t[0])}function y(e,r){var t=e.scale,n=e.translate;return Math.round((n[1]-r)/t[1])}function p(e,r){var t=e.scale,n=e.translate;return r*t[0]+n[0]}function F(e,r){var t=e.scale;return e.translate[1]-r*t[1]}function G(e){var r=e.coords;return{x:r[0],y:r[1]}}function z(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e}function M(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2]}}function T(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.z,e}function I(e){var r=e.coords;return{x:r[0],y:r[1],m:r[2]}}function b(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.m,e}function P(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2],m:r[3]}}function N(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.z,e.coords[3]=r.m,e}function w(e,r){return e&&r?N:e?T:r?b:z}function q(e,r,t,n,o){for(var i=w(t,n),s=0,l=r;s<l.length;s++){var c=l[s],d=c.geometry,h=c.attributes,g=void 0;d&&(g=i(new a.default,d)),e.push(new u.default(g,h,null,h[o]))}return e}function O(e,r,t,n){for(var o=0,u=r;o<u.length;o++){var i=u[o],a=i.geometry,s=i.attributes,l=void 0;a&&(l=x(a,t,n)),e.push({attributes:s,geometry:l})}return e}function x(e,r,t){if(!e)return null;for(var n=s(r,t),o=[],u=0;u<e.coords.length;u+=n){for(var i=[],a=0;a<n;a++)i.push(e.coords[u+a]);o.push(i)}return r?t?{points:o,hasZ:r,hasM:t}:{points:o,hasZ:r}:t?{points:o,hasM:t}:{points:o}}function S(e,r,t,n,o){for(var i=s(t,n),l=0,c=r;l<c.length;l++){var d=c[l],h=d.geometry,g=d.attributes,f=void 0;h&&(f=Z(new a.default,h,i)),e.push(new u.default(f,g,null,g[o]))}return e}function Z(e,r,t){void 0===t&&(t=s(r.hasZ,r.hasM)),e.lengths[0]=r.points.length;for(var n=e.coords,o=0,u=0,i=r.points;u<i.length;u++)for(var a=i[u],l=0;l<t;l++)n[o++]=a[l];return e}function k(e,r,t){if(!e)return null;for(var n=s(r,t),o=e.coords,u=[],i=0,a=0,l=e.lengths;a<l.length;a++){for(var c=l[a],d=[],h=0;h<c;h++){for(var g=[],f=0;f<n;f++)g.push(o[i++]);d.push(g)}u.push(d)}return r?t?{paths:u,hasZ:r,hasM:t}:{paths:u,hasZ:r}:t?{paths:u,hasM:t}:{paths:u}}function E(e,r,t,n,o){for(var i=s(t,n),l=0,c=r;l<c.length;l++){var d=c[l],h=d.geometry,g=d.attributes,f=void 0;h&&(f=A(new a.default,h,i)),e.push(new u.default(f,g,null,g[o]))}return e}function A(e,r,t){void 0===t&&(t=s(r.hasZ,r.hasM));for(var n=e.lengths,o=e.coords,u=0,i=0,a=r.paths;i<a.length;i++){for(var l=a[i],c=0,d=l;c<d.length;c++)for(var h=d[c],g=0;g<t;g++)o[u++]=h[g];n.push(l.length)}return e}function V(e,r,t){if(!e)return null;for(var n=s(r,t),o=e.coords,u=[],i=0,a=0,l=e.lengths;a<l.length;a++){for(var c=l[a],d=[],h=0;h<c;h++){for(var g=[],f=0;f<n;f++)g.push(o[i++]);d.push(g)}u.push(d)}return r?t?{rings:u,hasZ:r,hasM:t}:{rings:u,hasZ:r}:t?{rings:u,hasM:t}:{rings:u}}function Y(e,r,t,n,o){for(var i=0,s=r;i<s.length;i++){var l=s[i],c=l.geometry,d=l.centroid,h=l.attributes,g=void 0;c&&(g=j(new a.default,c,t,n)),d?e.push(new u.default(g,h,z(new a.default,d),h[o])):e.push(new u.default(g,h,null,h[o]))}return e}function j(e,r,t,n){return void 0===t&&(t=r.hasZ),void 0===n&&(n=r.hasM),_(e,r.rings,t,n),e}function _(e,r,t,n){var o=s(t,n),u=e.lengths,i=e.coords,a=0;u.length=i.length=0;for(var l=0,c=r;l<c.length;l++){for(var d=c[l],h=0,g=d;h<g.length;h++)for(var f=g[h],m=0;m<o;m++)i[a++]=f[m];u.push(d.length)}return e}r.quantizeX=v,r.quantizeY=y,r.unquantizeX=p,r.unquantizeY=F,r.convertToPoint=function(e,r,t){return e?r?t?P(e):M(e):t?I(e):G(e):null},r.convertFromPointFeatures=q,r.convertFromPoint=function(e,r,t){return void 0===t&&(t=w(null!=r.z,null!=r.m)),t(e,r)},r.convertToMultipointFeatures=O,r.convertToMultipoint=x,r.convertFromMultipointFeatures=S,r.convertFromMultipoint=Z,r.convertToPolyline=k,r.convertFromPolylineFeatures=E,r.convertFromPolyline=A,r.convertToPolygon=V,r.convertFromPolygon=j,r.convertFromNestedArray=_;var L=[],Q=[];function R(e,r,n,o,i,a){if(e.length=0,!n){for(var s=0,c=r;s<c.length;s++){var d=c[s],h=d.attributes[a];e.push(new u.default(null,d.attributes,null,h))}return e}switch(n){case"esriGeometryPoint":return q(e,r,o,i,a);case"esriGeometryMultipoint":return S(e,r,o,i,a);case"esriGeometryPolyline":return E(e,r,o,i,a);case"esriGeometryPolygon":return Y(e,r,o,i,a);default:l.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'")),e.length=0}return e}function U(e,r,n,o){var u=e&&("coords"in e?e:e.geometry);if(!u)return null;switch(r){case"esriGeometryPoint":var i=G;return n&&o?i=P:n?i=M:o&&(i=I),i(u);case"esriGeometryMultipoint":return x(u,n,o);case"esriGeometryPolyline":return k(u,n,o);case"esriGeometryPolygon":return V(u,n,o);default:return void l.error("convertToGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+r+"'"))}}function B(e,r,n,o,u){switch(e.length=0,n){case"esriGeometryPoint":return function(e,r,t,n){var o=G;t&&n?o=P:t?o=M:n&&(o=I);for(var u=0,i=r;u<i.length;u++){var a=i[u],s=a.geometry,l=a.attributes,c=s?o(s):null;e.push({attributes:l,geometry:c})}return e}(e,r,o,u);case"esriGeometryMultipoint":return O(e,r,o,u);case"esriGeometryPolyline":return function(e,r,t,n){for(var o=0,u=r;o<u.length;o++){var i=u[o],a=i.geometry,s=i.attributes,l=void 0;a&&(l=k(a,t,n)),e.push({attributes:s,geometry:l})}return e}(e,r,o,u);case"esriGeometryPolygon":return function(e,r,t,n){for(var o=0,u=r;o<u.length;o++){var i=u[o],a=i.geometry,s=i.attributes,l=i.centroid,c=void 0;if(a&&(c=V(a,t,n)),l){var d=G(l);e.push({attributes:s,centroid:d,geometry:c})}else e.push({attributes:s,geometry:c})}return e}(e,r,o,u);default:l.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'"))}return e}function X(e,r,t,n,o,u,i,a){if(void 0===i&&(i=t),void 0===a&&(a=n),e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var l,d,h,g,f=c[o],p=r.coords,F=r.lengths,G=s(t,n),z=s(t&&i,n&&a),M=m(t,n,i,a);if(!F.length)return M(e.coords,p,0,0,v(u,p[0]),y(u,p[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=G,e;for(var T=0,I=0,b=I,P=0,N=F;P<N.length;P++){var w=N[P];if(!(w<f)){var q=0;I=b,h=l=v(u,p[T]),g=d=y(u,p[T+1]),M(e.coords,p,I,T,h,g),q++,T+=G,I+=z;for(var O=1;O<w;O++,T+=G)h=v(u,p[T]),g=y(u,p[T+1]),h===l&&g===d||(M(e.coords,p,I,T,h-l,g-d),I+=z,q++,l=h,d=g);q>=f&&(e.lengths.push(q),b=I)}}return e.coords.length=b,e.coords.length?e:null}function C(e,r,t,n){var o=e[r],u=e[r+1],i=e[t],a=e[t+1],s=e[n],l=e[n+1],c=i,d=a,h=s-c,g=l-d;if(0!==h||0!==g){var f=((o-c)*h+(u-d)*g)/(h*h+g*g);f>1?(c=s,d=l):f>0&&(c+=h*f,d+=g*f)}return(h=o-c)*h+(g=u-d)*g}function D(e,r,t,n,o,u,i){for(var a,s=n,l=0,c=u+t;c<i;c+=t)(a=C(r,c,u,i))>s&&(l=c,s=a);s>n&&(l-u>t&&D(e,r,t,n,o,u,l),o(e,r,e.length,l,r[l],r[l+1]),i-l>t&&D(e,r,t,n,o,l,i))}function H(e,r,t,n,o){var u=r.coords,i=r.lengths,a=t?n?f:h:n?h:d,l=s(t,n);if(!u.length)return e!==r&&(e.lengths.length=0,e.coords.length=0),e;if(!i.length)return a(e.coords,u,0,0,p(o,u[0]),F(o,u[1])),e!==r&&(e.lengths.length=0,e.coords.length=l),e;for(var c=o.scale,g=c[0],m=c[1],v=0,y=0;y<i.length;y++){var G=i[y];e.lengths[y]=G;var z=p(o,u[v]),M=F(o,u[v+1]);a(e.coords,u,v,v,z,M),v+=l;for(var T=1;T<G;T++,v+=l)z+=u[v]*g,M-=u[v+1]*m,a(e.coords,u,v,v,z,M)}return e!==r&&(e.lengths.length=i.length,e.coords.length=u.length),e}function J(e,r,t,n){for(var o=0,u=e[n*r],i=e[n*(r+1)],a=1;a<t;a++){var s=u+e[n*(r+a)],l=i+e[n*(r+a)+1],c=(s-u)*(l+i);u=s,i=l,o+=c}return.5*o}r.convertFromFeature=function(e,r,t,n,o){L[0]=e;var u=R(Q,L,r,t,n,o)[0];return L.length=Q.length=0,u},r.convertFromFeatures=R,r.convertFromGraphics=function(e,r,n,o,u,i){var a=e.length;switch(n){case"esriGeometryPoint":q(e,r,o,u,i);break;case"esriGeometryMultipoint":S(e,r,o,u,i);break;case"esriGeometryPolyline":E(e,r,o,u,i);break;case"esriGeometryPolygon":Y(e,r,o,u,i);break;default:l.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'"))}for(var s=0;s<r.length;s++)e[s+a].geometryType=n,e[s+a].insertAfter=r[s].insertAfter,e[s+a].groupId=r[s].groupId;return e},r.convertToFeature=function(e,r,t,n){Q[0]=e,B(L,Q,r,t,n);var o=L[0];return L.length=Q.length=0,o},r.convertFromGeometry=function(e,r,n){if(!e)return null;var u=new a.default;return"hasZ"in e&&null==r&&(r=e.hasZ),"hasM"in e&&null==n&&(n=e.hasM),o.isPoint(e)?w(null!=r?r:null!=e.z,null!=n?n:null!=e.m)(u,e):o.isPolygon(e)?j(u,e,r,n):o.isPolyline(e)?A(u,e,s(r,n)):o.isMultipoint(e)?Z(u,e,s(r,n)):void l.error("convertFromGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+e+"'"))},r.convertToGeometry=U,r.convertToFeatures=B,r.convertToFeatureSet=function(e){var r=e.objectIdFieldName,t=e.spatialReference,n=e.transform,o=e.fields,u=e.hasM,i=e.hasZ,a=e.features,s=e.geometryType,l=e.exceededTransferLimit,c=e.uniqueIdField,d=e.queryGeometry,h=e.queryGeometryType,g={features:B([],a,s,i,u),fields:o,geometryType:s,objectIdFieldName:r,spatialReference:t,uniqueIdField:c,queryGeometry:U(d,h,!1,!1)};return n&&(g.transform=n),l&&(g.exceededTransferLimit=l),u&&(g.hasM=u),i&&(g.hasZ=i),g},r.convertFromFeatureSet=function(e,r){var n=new i.default,o=e.hasM,u=e.hasZ,a=e.features,s=e.objectIdFieldName,c=e.spatialReference,d=e.geometryType,h=e.exceededTransferLimit,g=e.transform;return n.fields=e.fields,n.geometryType=d,n.objectIdFieldName=s||r,n.spatialReference=c,n.objectIdFieldName?(a&&R(n.features,a,d,u,o,n.objectIdFieldName),h&&(n.exceededTransferLimit=h),o&&(n.hasM=o),u&&(n.hasZ=u),g&&(n.transform=g),n):(l.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)},r.unquantizeOptimizedFeatureSet=function(e){var r=e.transform,t=e.features,n=e.hasM,o=e.hasZ;if(!r)return e;for(var u=0,i=t;u<i.length;u++){var a=i[u];a.geometry&&H(a.geometry,a.geometry,n,o,r),a.centroid&&H(a.centroid,a.centroid,n,o,r)}return e.transform=null,e},r.quantizeOptimizedFeatureSet=function(e,r){var t=r.geometryType,n=r.features,o=r.hasM,u=r.hasZ;if(!e)return r;for(var i=0;i<n.length;i++){var s=n[i],l=s.weakClone();l.geometry=new a.default,X(l.geometry,s.geometry,o,u,t,e),s.centroid&&(l.centroid=new a.default,X(l.centroid,s.centroid,o,u,"esriGeometryPoint",e)),n[i]=l}return r.transform=e,r},r.quantizeOptimizedGeometry=X,r.generalizeOptimizedGeometry=function(e,r,t,n,o,u,i,a){if(void 0===i&&(i=t),void 0===a&&(a=n),e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var l=c[o],d=r.coords,h=r.lengths,g=s(t,n),f=s(t&&i,n&&a),v=m(t,n,i,a);if(!h.length)return v(e.coords,d,0,0,d[0],d[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;for(var y=0,p=u*u,F=0,G=h;F<G.length;F++){var z=G[F];if(z<l)y+=z*g;else{var M=e.coords.length/f,T=y,I=y+(z-1)*g;v(e.coords,d,e.coords.length,T,d[T],d[T+1]),D(e.coords,d,g,p,v,T,I),v(e.coords,d,e.coords.length,I,d[I],d[I+1]);var b=e.coords.length/f-M;b>=l?e.lengths.push(b):e.coords.length=M*f,y+=z*g}}return e.coords.length?e:null},r.getBoundsOptimizedGeometry=function(e,r,t,n){if(!r||!r.coords||!r.coords.length)return null;var o=s(t,n),u=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(r&&r.coords)for(var c=r.coords,d=0;d<c.length;d+=o){var h=c[d],g=c[d+1];u=Math.min(u,h),a=Math.max(a,h),i=Math.min(i,g),l=Math.max(l,g)}return e[0]=u,e[1]=i,e[2]=a,e[3]=l,e},r.getQuantizedBoundsOptimizedGeometry=function(e,r,t,n){for(var o=s(t,n),u=r.lengths,i=r.coords,a=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,d=Number.NEGATIVE_INFINITY,h=0,g=0,f=u;g<f.length;g++){var m=f[g],v=i[h],y=i[h+1];a=Math.min(v,a),l=Math.min(y,l),c=Math.max(v,c),d=Math.max(y,d),h+=o;for(var p=1;p<m;p++,h+=o){var F=i[h],G=i[h+1];v+=F,y+=G,F<0&&(a=Math.min(a,v)),F>0&&(c=Math.max(c,v)),G<0?l=Math.min(l,y):G>0&&(d=Math.max(d,y))}}return e[0]=a,e[1]=l,e[2]=c,e[3]=d,e},r.unquantizeOptimizedGeometry=H,r.removeZMValues=function(e,r,t,n,o,u){var i,a=s(t,n),l=m(t,n,o,u),c=r.coords;e.coords.length=0,e.lengths.length=0,(i=e.lengths).push.apply(i,r.lengths);for(var d=0;d<c.length;d+=a)l(e.coords,c,e.coords.length,d,c[d],c[d+1]);return e},r.removeCollinearVectices=function(e,r,t,n,o){if(!r||!r.coords||!r.coords.length)return null;for(var u=c[t],i=r.coords,a=r.lengths,l=m(n,o,n,o),d=s(n,o),h=0,g=0,f=0,v=0,y=0,p=a;y<p.length;y++){var F=p[y];g=v,l(e.coords,i,g,h,i[h],i[h+1]);var G=i[h+=d],z=i[h+1],M=G,T=z,I=z/G;g+=d,l(e.coords,i,g,h,M,T),h+=d;for(var b=2;b<F;b++){G=i[h];var P=(z=i[h+1])/G,N=I===P||!isFinite(I)&&!isFinite(P),w=N&&isFinite(P)?I>=0&&P>=0||I<=0&&P<=0:T>=0&&z>=0||T<=0&&z<=0;N&&w?(M+=G,T+=z):(M=G,T=z,g+=d),l(e.coords,i,g,h,M,T),h+=d,I=P}var q=((g+=d)-v)/d;q>=u&&(e.lengths[f]=q,v=g,f++)}return e.coords.length>v&&(e.coords.length=v),e.lengths.length>f&&(e.lengths.length=f),e.coords.length&&e.lengths.length?e:null},r.getSignedQuantizedRingArea=J,r.getQuantizedArea=function(e,r){for(var t=e.coords,n=e.lengths,o=0,u=0,i=0;i<n.length;i++){u+=J(t,o,n[i],r),o+=i}return Math.abs(u)},r.deltaEncodeGeometry=function(e,r){for(var t=e.clone(),n=e.coords,o=e.lengths,u=0,i=0;i<o.length;i++){for(var a=o[i],s=n[r*u],l=n[r*u+1],c=1;c<a;c++){var d=n[r*(u+c)],h=n[r*(u+c)+1],g=d-s,f=h-l;t.coords[r*(u+c)]=g,t.coords[r*(u+c)+1]=f,s=d,l=h}u+=a}return t},r.deltaDecodeGeometry=function(e,r){for(var t=e.clone(),n=e.coords,o=e.lengths,u=0,i=0;i<o.length;i++){for(var a=o[i],s=n[r*u],l=n[r*u+1],c=1;c<a;c++){var d=s+n[r*(u+c)],h=l+n[r*(u+c)+1];t.coords[r*(u+c)]=d,t.coords[r*(u+c)+1]=h,s=d,l=h}u+=a}return t}}));