/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/Logger","../../core/maybe","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],(function(e,t,o,n,r,s,i,u,c,l){"use strict";function a(e,t){return e?t?4:3:t?3:2}const f=o.getLogger("esri.layers.graphics.featureConversionUtils"),m={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},d=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s},h=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+2]},g=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+3]},y=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+2],e[o+3]=t[n+3]};function p(e,t,o,n){if(e){if(o)return t&&n?y:h;if(t&&n)return g}else if(t&&n)return h;return d}function F({scale:e,translate:t},o){return Math.round((o-t[0])/e[0])}function I({scale:e,translate:t},o){return Math.round((t[1]-o)/e[1])}function b(e,t){return N(e,t,0)}function M(e,t){return N(e,-t,1)}function N({scale:e,translate:t},o,n){return o*e[n]+t[n]}function G(e,t,o){return e?t?o?O(e):w(e):o?P(e):T(e):null}function T(e){const t=e.coords;return{x:t[0],y:t[1]}}function v(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function w(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function P(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function S(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function O(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function x(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function Z(e,t,o,r){let s=T;o&&r?s=O:o?s=w:r&&(s=P);for(const i of t){const{geometry:t,attributes:o}=i,r=n.isSome(t)?s(t):null;e.push({attributes:o,geometry:r})}return e}function k(e,t){return e&&t?x:e?z:t?S:v}function q(e,t,o,r,s){const i=k(o,r);for(const{geometry:c,attributes:a}of t){const t=n.isSome(c)?i(new l,c):null;e.push(new u.OptimizedFeature(t,a,null,s?a[s]:void 0))}return e}function E(e,t,o=k(null!=t.z,null!=t.m)){return o(e,t)}function V(e,t,o,r){for(const{geometry:s,attributes:i}of t)e.push({attributes:i,geometry:n.isSome(s)?j(s,o,r):null});return e}function j(e,t,o){if(n.isNone(e))return null;const r=a(t,o),s=[];for(let n=0;n<e.coords.length;n+=r){const t=[];for(let o=0;o<r;o++)t.push(e.coords[n+o]);s.push(t)}return t?o?{points:s,hasZ:t,hasM:o}:{points:s,hasZ:t}:o?{points:s,hasM:o}:{points:s}}function Y(e,t,o,r,s){const i=a(o,r);for(const{geometry:c,attributes:a}of t){const t=n.isSome(c)?A(new l,c,i):null;e.push(new u.OptimizedFeature(t,a,null,s?a[s]:void 0))}return e}function A(e,t,o=a(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const n=e.coords;let r=0;for(const s of t.points)for(let e=0;e<o;e++)n[r++]=s[e];return e}function _(e,t,o,r){for(const{geometry:s,attributes:i}of t)e.push({attributes:i,geometry:n.isSome(s)?L(s,o,r):null});return e}function L(e,t,o){if(!e)return null;const n=a(t,o),{coords:r,lengths:s}=e,i=[];let u=0;for(const c of s){const e=[];for(let t=0;t<c;t++){const t=[];for(let e=0;e<n;e++)t.push(r[u++]);e.push(t)}i.push(e)}return t?o?{paths:i,hasZ:t,hasM:o}:{paths:i,hasZ:t}:o?{paths:i,hasM:o}:{paths:i}}function R(e,t,o,r,s){const i=a(o,r);for(const{geometry:c,attributes:a}of t){const t=n.isSome(c)?U(new l,c,i):null;e.push(new u.OptimizedFeature(t,a,null,s?a[s]:void 0))}return e}function U(e,t,o=a(t.hasZ,t.hasM)){const{lengths:n,coords:r}=e;let s=0;for(const i of t.paths){for(const e of i)for(let t=0;t<o;t++)r[s++]=e[t];n.push(i.length)}return e}function B(e,t,o,r){for(const{geometry:s,attributes:i,centroid:u}of t){const t=n.isSome(s)?$(s,o,r):null;if(n.isSome(u)){const o=T(u);e.push({attributes:i,centroid:o,geometry:t})}else e.push({attributes:i,geometry:t})}return e}function $(e,t,o){if(!e)return null;const n=a(t,o),{coords:r,lengths:s}=e,i=[];let u=0;for(const c of s){const e=[];for(let t=0;t<c;t++){const t=[];for(let e=0;e<n;e++)t.push(r[u++]);e.push(t)}i.push(e)}return t?o?{rings:i,hasZ:t,hasM:o}:{rings:i,hasZ:t}:o?{rings:i,hasM:o}:{rings:i}}function C(e,t,o,r,s){for(const{geometry:i,centroid:c,attributes:a}of t){const t=n.isSome(i)?Q(new l,i,o,r):null,f=s?a[s]:void 0;n.isSome(c)?e.push(new u.OptimizedFeature(t,a,v(new l,c),f)):e.push(new u.OptimizedFeature(t,a,null,f))}return e}function Q(e,t,o=t.hasZ,n=t.hasM){return X(e,t.rings,o,n),e}function X(e,t,o,n){const r=a(o,n),{lengths:s,coords:i}=e;let u=0;Ne(e);for(const c of t){for(const e of c)for(let t=0;t<r;t++)i[u++]=e[t];s.push(c.length)}return e}const D=[],H=[];function J(e,t,o,n,r){D[0]=e;const[s]=K(H,D,t,o,n,r);return Ge(D),Ge(H),s}function K(e,o,n,r,s,i){if(Ge(e),!n){for(const t of o){const o=i?t.attributes[i]:void 0;e.push(new u.OptimizedFeature(null,t.attributes,null,o))}return e}switch(n){case"esriGeometryPoint":return q(e,o,r,s,i);case"esriGeometryMultipoint":return Y(e,o,r,s,i);case"esriGeometryPolyline":return R(e,o,r,s,i);case"esriGeometryPolygon":return C(e,o,r,s,i);default:f.error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`)),Ge(e)}return e}function W(e,o,n,r,s,i){const u=e.length;switch(n){case"esriGeometryPoint":q(e,o,r,s,i);break;case"esriGeometryMultipoint":Y(e,o,r,s,i);break;case"esriGeometryPolyline":R(e,o,r,s,i);break;case"esriGeometryPolygon":C(e,o,r,s,i);break;default:f.error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`))}for(let t=0;t<o.length;t++)e[t+u].geometryType=n,e[t+u].insertAfter=o[t].insertAfter,e[t+u].groupId=o[t].groupId;return e}function ee(e,t,o,n){H[0]=e,re(D,H,t,o,n);const r=D[0];return Ge(D),Ge(H),r}function te(e,o,r){if(n.isNone(e))return null;const s=new l;if("hasZ"in e&&null==o&&(o=e.hasZ),"hasM"in e&&null==r&&(r=e.hasM),i.isPoint(e)){return k(null!=o?o:null!=e.z,null!=r?r:null!=e.m)(s,e)}return i.isPolygon(e)?Q(s,e,o,r):i.isPolyline(e)?U(s,e,a(o,r)):i.isMultipoint(e)?A(s,e,a(o,r)):void f.error("convertFromGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${e}'`))}function oe(e,o,r,s){const i=e&&("coords"in e?e:e.geometry);if(n.isNone(i))return null;switch(o){case"esriGeometryPoint":{let e=T;return r&&s?e=O:r?e=w:s&&(e=P),e(i)}case"esriGeometryMultipoint":return j(i,r,s);case"esriGeometryPolyline":return L(i,r,s);case"esriGeometryPolygon":return $(i,r,s);default:return f.error("convertToGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${o}'`)),null}}function ne(e,t){for(const o of t)e.push({attributes:o.attributes});return e}function re(e,o,r,s,i){if(Ge(e),n.isNone(r))return ne(e,o);switch(r){case"esriGeometryPoint":return Z(e,o,s,i);case"esriGeometryMultipoint":return V(e,o,s,i);case"esriGeometryPolyline":return _(e,o,s,i);case"esriGeometryPolygon":return B(e,o,s,i);default:f.error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${r}'`))}return e}function se(e){const{objectIdFieldName:t,spatialReference:o,transform:n,fields:r,hasM:s,hasZ:i,features:u,geometryType:c,exceededTransferLimit:l,uniqueIdField:a,queryGeometry:f,queryGeometryType:m}=e,d={features:re([],u,c,i,s),fields:r,geometryType:c,objectIdFieldName:t,spatialReference:o,uniqueIdField:a,queryGeometry:oe(f,m,!1,!1)};return n&&(d.transform=n),l&&(d.exceededTransferLimit=l),s&&(d.hasM=s),i&&(d.hasZ=i),d}function ie(e,o){const n=new c,{hasM:r,hasZ:s,features:i,objectIdFieldName:u,spatialReference:l,geometryType:a,exceededTransferLimit:m,transform:d,fields:h}=e;return h&&(n.fields=h),n.geometryType=a??null,n.objectIdFieldName=u??o??null,n.spatialReference=l??null,n.objectIdFieldName?(i&&K(n.features,i,a,s,r,n.objectIdFieldName),m&&(n.exceededTransferLimit=m),r&&(n.hasM=r),s&&(n.hasZ=s),d&&(n.transform=d),n):(f.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function ue(e){const{transform:t,features:o,hasM:r,hasZ:s}=e;if(!t)return e;for(const i of o)n.isSome(i.geometry)&&ge(i.geometry,i.geometry,r,s,t),n.isSome(i.centroid)&&ge(i.centroid,i.centroid,r,s,t);return e.transform=null,e}function ce(e,t){const{geometryType:o,features:n,hasM:r,hasZ:s}=t;if(!e)return t;for(let i=0;i<n.length;i++){const t=n[i],u=t.weakClone();u.geometry=new l,le(u.geometry,t.geometry,r,s,o,e),t.centroid&&(u.centroid=new l,le(u.centroid,t.centroid,r,s,"esriGeometryPoint",e)),n[i]=u}return t.transform=e,t}function le(e,t,o,r,s,i,u=o,c=r){if(Ne(e),n.isNone(t)||!t.coords.length)return null;const l=m[s],{coords:f,lengths:d}=t,h=a(o,r),g=a(o&&u,r&&c),y=p(o,r,u,c);if(!d.length)return y(e.coords,f,0,0,F(i,f[0]),I(i,f[1])),Ne(e,h,0),e;let b,M,N,G,T=0,v=0,w=v;for(const n of d){if(n<l)continue;let t=0;v=w,N=b=F(i,f[T]),G=M=I(i,f[T+1]),y(e.coords,f,v,T,N,G),t++,T+=h,v+=g;for(let o=1;o<n;o++,T+=h)N=F(i,f[T]),G=I(i,f[T+1]),N===b&&G===M||(y(e.coords,f,v,T,N-b,G-M),v+=g,t++,b=N,M=G);t>=l&&(e.lengths.push(t),w=v)}return Ge(e.coords,w),e.coords.length?e:null}function ae(e,t,o,n,r,s,i=o,u=n){if(Ne(e),!t||!t.coords.length)return null;const c=m[r],{coords:l,lengths:f}=t,d=a(o,n),h=a(o&&i,n&&u),g=p(o,n,i,u);if(!f.length)return g(e.coords,l,0,0,l[0],l[1]),Ne(e,d,0),e;let y=0;const F=s*s;for(const a of f){if(a<c){y+=a*d;continue}const t=e.coords.length/h,o=y,n=y+(a-1)*d;g(e.coords,l,e.coords.length,o,l[o],l[o+1]),me(e.coords,l,d,F,g,o,n),g(e.coords,l,e.coords.length,n,l[n],l[n+1]);const r=e.coords.length/h-t;r>=c?e.lengths.push(r):Ge(e.coords,t*h),y+=a*d}return e.coords.length?e:null}function fe(e,t,o,n){const r=e[t],s=e[t+1],i=e[o],u=e[o+1],c=e[n],l=e[n+1];let a=i,f=u,m=c-a,d=l-f;if(0!==m||0!==d){const e=((r-a)*m+(s-f)*d)/(m*m+d*d);e>1?(a=c,f=l):e>0&&(a+=m*e,f+=d*e)}return m=r-a,d=s-f,m*m+d*d}function me(e,t,o,n,r,s,i){let u,c=n,l=0;for(let a=s+o;a<i;a+=o)u=fe(t,a,s,i),u>c&&(l=a,c=u);c>n&&(l-s>o&&me(e,t,o,n,r,s,l),r(e,t,e.length,l,t[l],t[l+1]),i-l>o&&me(e,t,o,n,r,l,i))}function de(e,t,o,i){if(n.isNone(t)||!t.coords||!t.coords.length)return null;const u=a(o,i);let c=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,m=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=u){const o=e[t],n=e[t+1];c=Math.min(c,o),f=Math.max(f,o),l=Math.min(l,n),m=Math.max(m,n)}}return r.is(e)?r.fromRectValues(e,c,l,f,m):s.fromValues(c,l,f,m,e),e}function he(e,t,o,n){const r=a(o,n),{lengths:s,coords:i}=t;let u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY,m=0;for(const a of s){let e=i[m],t=i[m+1];u=Math.min(e,u),c=Math.min(t,c),l=Math.max(e,l),f=Math.max(t,f),m+=r;for(let o=1;o<a;o++,m+=r){const o=i[m],n=i[m+1];e+=o,t+=n,o<0&&(u=Math.min(u,e)),o>0&&(l=Math.max(l,e)),n<0?c=Math.min(c,t):n>0&&(f=Math.max(f,t))}}return e[0]=u,e[1]=c,e[2]=l,e[3]=f,e}function ge(e,t,o,r,s){const{coords:i,lengths:u}=t,c=a(o,r);if(!i.length)return e!==t&&Ne(e),e;n.assertIsSome(s);const{originPosition:l,scale:f,translate:m}=s,d=Te;d.originPosition=l;const h=d.scale;h[0]=f[0]??1,h[1]=-(f[1]??1),h[2]=f[2]??1,h[3]=f[3]??1;const g=d.translate;if(g[0]=m[0]??0,g[1]=m[1]??0,g[2]=m[2]??0,g[3]=m[3]??0,!u.length){for(let t=0;t<c;++t)e.coords[t]=N(d,i[t],t);return e!==t&&Ne(e,c,0),e}let y=0;for(let n=0;n<u.length;n++){const t=u[n];e.lengths[n]=t;for(let n=0;n<c;++n)e.coords[y+n]=N(d,i[y+n],n);let o=e.coords[y],r=e.coords[y+1];y+=c;for(let n=1;n<t;n++,y+=c){o+=i[y]*h[0],r+=i[y+1]*h[1],e.coords[y]=o,e.coords[y+1]=r;for(let t=2;t<c;++t)e.coords[y+t]=N(d,i[y+t],t)}}return e!==t&&Ne(e,i.length,u.length),e}function ye(e,t,o,n,r,s){if(Ne(e),e.lengths.push(...t.lengths),o===r&&n===s)for(let i=0;i<t.coords.length;i++)e.coords.push(t.coords[i]);else{const i=a(o,n),u=p(o,n,r,s),c=t.coords;for(let t=0;t<c.length;t+=i)u(e.coords,c,e.coords.length,t,c[t],c[t+1])}return e}function pe(e,t,o,n,r){if(!t||!t.coords||!t.coords.length)return null;const s=m[o],{coords:i,lengths:u}=t,c=p(n,r,n,r),l=a(n,r);let f=0,d=0,h=0,g=0;for(const a of u){d=g,c(e.coords,i,d,f,i[f],i[f+1]),f+=l;let t=i[f],o=i[f+1],n=t,r=o,u=o/t;d+=l,c(e.coords,i,d,f,n,r),f+=l;for(let s=2;s<a;s++){t=i[f],o=i[f+1];const s=o/t,a=u===s||!isFinite(u)&&!isFinite(s),m=a&&isFinite(s)?u>=0&&s>=0||u<=0&&s<=0:r>=0&&o>=0||r<=0&&o<=0;a&&m?(n+=t,r+=o):(n=t,r=o,d+=l),c(e.coords,i,d,f,n,r),f+=l,u=s}d+=l;const m=(d-g)/l;m>=s&&(e.lengths[h]=m,g=d,h++)}return e.coords.length>g&&(e.coords.length=g),e.lengths.length>h&&(e.lengths.length=h),e.coords.length&&e.lengths.length?e:null}function Fe(e,t,o,n){let r=0,s=e[n*t],i=e[n*(t+1)];for(let u=1;u<o;u++){const o=s+e[n*(t+u)],c=i+e[n*(t+u)+1],l=(o-s)*(c+i);s=o,i=c,r+=l}return.5*r}function Ie(e,t){const{coords:o,lengths:n}=e;let r=0,s=0;for(let i=0;i<n.length;i++){const e=n[i];s+=Fe(o,r,e,t),r+=e}return Math.abs(s)}function be(e,t){const o=e.clone(),n=e.coords,r=e.lengths;let s=0;for(let i=0;i<r.length;i++){const e=r[i];let u=n[t*s],c=n[t*s+1];for(let r=1;r<e;r++){const e=n[t*(s+r)],i=n[t*(s+r)+1],l=e-u,a=i-c;o.coords[t*(s+r)]=l,o.coords[t*(s+r)+1]=a,u=e,c=i}s+=e}return o}function Me(e,t){if(n.isNone(e))return null;const o=e.clone(),r=e.coords,s=e.lengths;let i=0;for(let n=0;n<s.length;n++){const e=s[n];let u=r[t*i],c=r[t*i+1];for(let n=1;n<e;n++){const e=u+r[t*(i+n)],s=c+r[t*(i+n)+1];o.coords[t*(i+n)]=e,o.coords[t*(i+n)+1]=s,u=e,c=s}i+=e}return o}function Ne(e,t=0,o=0){Ge(e.lengths,o),Ge(e.coords,t)}function Ge(e,t=0){e.length!==t&&(e.length=t)}const Te={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};e.convertFromFeature=J,e.convertFromFeatureSet=ie,e.convertFromFeatures=K,e.convertFromGeometry=te,e.convertFromGraphics=W,e.convertFromMultipoint=A,e.convertFromMultipointFeatures=Y,e.convertFromNestedArray=X,e.convertFromPoint=E,e.convertFromPointFeatures=q,e.convertFromPolygon=Q,e.convertFromPolyline=U,e.convertFromPolylineFeatures=R,e.convertToFeature=ee,e.convertToFeatureSet=se,e.convertToFeatures=re,e.convertToGeometry=oe,e.convertToMultipoint=j,e.convertToMultipointFeatures=V,e.convertToPoint=G,e.convertToPolygon=$,e.convertToPolyline=L,e.deltaDecodeGeometry=Me,e.deltaEncodeGeometry=be,e.generalizeOptimizedGeometry=ae,e.getBoundsOptimizedGeometry=de,e.getQuantizedArea=Ie,e.getQuantizedBoundsOptimizedGeometry=he,e.getSignedQuantizedRingArea=Fe,e.quantizeOptimizedFeatureSet=ce,e.quantizeOptimizedGeometry=le,e.quantizeX=F,e.quantizeY=I,e.removeCollinearVectices=pe,e.removeZMValues=ye,e.unquantizeOptimizedFeatureSet=ue,e.unquantizeOptimizedGeometry=ge,e.unquantizeValue=N,e.unquantizeX=b,e.unquantizeY=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
