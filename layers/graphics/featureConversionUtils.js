/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/Logger","../../core/Error","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],(function(e,t,n,o,r,s,c){"use strict";function l(e,t){return e?t?4:3:t?3:2}const u=t.getLogger("esri.tasks.support.optimizedFeatureSet"),i={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},a=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s},h=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+2]},f=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+3]},g=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+2],e[n+3]=t[o+3]};function d(e,t,n,o){if(e){if(n)return t&&o?g:h;if(t&&o)return f}else if(t&&o)return h;return a}function m({scale:e,translate:t},n){return Math.round((n-t[0])/e[0])}function y({scale:e,translate:t},n){return Math.round((t[1]-n)/e[1])}function p({scale:e,translate:t},n){return n*e[0]+t[0]}function F({scale:e,translate:t},n){return t[1]-n*e[1]}function I(e){const t=e.coords;return{x:t[0],y:t[1]}}function M(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function b(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function G(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function T(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function N(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function w(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function v(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function P(e,t){return e&&t?v:e?G:t?N:M}function z(e,t,n,o,s){const l=P(n,o);for(const n of t){const{geometry:t,attributes:o}=n;let u;t&&(u=l(new c,t)),e.push(new r(u,o,null,o[s]))}return e}function x(e,t,n,o){for(const r of t){const{geometry:t,attributes:s}=r;let c;t&&(c=Z(t,n,o)),e.push({attributes:s,geometry:c})}return e}function Z(e,t,n){if(!e)return null;const o=l(t,n),r=[];for(let t=0;t<e.coords.length;t+=o){const n=[];for(let r=0;r<o;r++)n.push(e.coords[t+r]);r.push(n)}return t?n?{points:r,hasZ:t,hasM:n}:{points:r,hasZ:t}:n?{points:r,hasM:n}:{points:r}}function k(e,t,n,o,s){const u=l(n,o);for(const n of t){const t=n.geometry,o=n.attributes;let l;t&&(l=O(new c,t,u)),e.push(new r(l,o,null,o[s]))}return e}function O(e,t,n=l(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const o=e.coords;let r=0;for(const e of t.points)for(let t=0;t<n;t++)o[r++]=e[t];return e}function E(e,t,n){if(!e)return null;const o=l(t,n),{coords:r,lengths:s}=e,c=[];let u=0;for(const e of s){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<o;t++)e.push(r[u++]);t.push(e)}c.push(t)}return t?n?{paths:c,hasZ:t,hasM:n}:{paths:c,hasZ:t}:n?{paths:c,hasM:n}:{paths:c}}function S(e,t,n,o,s){const u=l(n,o);for(const n of t){const t=n.geometry,o=n.attributes;let l;t&&(l=q(new c,t,u)),e.push(new r(l,o,null,o[s]))}return e}function q(e,t,n=l(t.hasZ,t.hasM)){const{lengths:o,coords:r}=e;let s=0;for(const e of t.paths){for(const t of e)for(let e=0;e<n;e++)r[s++]=t[e];o.push(e.length)}return e}function j(e,t,n){if(!e)return null;const o=l(t,n),{coords:r,lengths:s}=e,c=[];let u=0;for(const e of s){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<o;t++)e.push(r[u++]);t.push(e)}c.push(t)}return t?n?{rings:c,hasZ:t,hasM:n}:{rings:c,hasZ:t}:n?{rings:c,hasM:n}:{rings:c}}function V(e,t,n,o,s){for(const l of t){const t=l.geometry,u=l.centroid,i=l.attributes;let a;t&&(a=Y(new c,t,n,o)),u?e.push(new r(a,i,M(new c,u),i[s])):e.push(new r(a,i,null,i[s]))}return e}function Y(e,t,n=t.hasZ,o=t.hasM){return _(e,t.rings,n,o),e}function _(e,t,n,o){const r=l(n,o),{lengths:s,coords:c}=e;let u=0;s.length=c.length=0;for(const e of t){for(const t of e)for(let e=0;e<r;e++)c[u++]=t[e];s.push(e.length)}return e}const A=[],L=[];function U(e,t,o,s,c,l){if(e.length=0,!o){for(const n of t){const t=n.attributes[l];e.push(new r(null,n.attributes,null,t))}return e}switch(o){case"esriGeometryPoint":return z(e,t,s,c,l);case"esriGeometryMultipoint":return k(e,t,s,c,l);case"esriGeometryPolyline":return S(e,t,s,c,l);case"esriGeometryPolygon":return V(e,t,s,c,l);default:u.error("convertToFeatureSet:unknown-geometry",new n(`Unable to parse unknown geometry type '${o}'`)),e.length=0}return e}function R(e,t,o,r){const s=e&&("coords"in e?e:e.geometry);if(!s)return null;switch(t){case"esriGeometryPoint":{let e=I;return o&&r?e=w:o?e=b:r&&(e=T),e(s)}case"esriGeometryMultipoint":return Z(s,o,r);case"esriGeometryPolyline":return E(s,o,r);case"esriGeometryPolygon":return j(s,o,r);default:return void u.error("convertToGeometry:unknown-geometry",new n(`Unable to parse unknown geometry type '${t}'`))}}function $(e,t,o,r,s){switch(e.length=0,o){case"esriGeometryPoint":return function(e,t,n,o){let r=I;n&&o?r=w:n?r=b:o&&(r=T);for(const n of t){const{geometry:t,attributes:o}=n,s=t?r(t):null;e.push({attributes:o,geometry:s})}return e}(e,t,r,s);case"esriGeometryMultipoint":return x(e,t,r,s);case"esriGeometryPolyline":return function(e,t,n,o){for(const r of t){const{geometry:t,attributes:s}=r;let c;t&&(c=E(t,n,o)),e.push({attributes:s,geometry:c})}return e}(e,t,r,s);case"esriGeometryPolygon":return function(e,t,n,o){for(const r of t){const{geometry:t,attributes:s,centroid:c}=r;let l;if(t&&(l=j(t,n,o)),c){const t=I(c);e.push({attributes:s,centroid:t,geometry:l})}else e.push({attributes:s,geometry:l})}return e}(e,t,r,s);default:u.error("convertToFeatureSet:unknown-geometry",new n(`Unable to parse unknown geometry type '${o}'`))}return e}function Q(e,t,n,o,r,s,c=n,u=o){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const a=i[r],{coords:h,lengths:f}=t,g=l(n,o),p=l(n&&c,o&&u),F=d(n,o,c,u);if(!f.length)return F(e.coords,h,0,0,m(s,h[0]),y(s,h[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;let I,M,b,G,T=0,N=0,w=N;for(const t of f){if(t<a)continue;let n=0;N=w,b=I=m(s,h[T]),G=M=y(s,h[T+1]),F(e.coords,h,N,T,b,G),n++,T+=g,N+=p;for(let o=1;o<t;o++,T+=g)b=m(s,h[T]),G=y(s,h[T+1]),b===I&&G===M||(F(e.coords,h,N,T,b-I,G-M),N+=p,n++,I=b,M=G);n>=a&&(e.lengths.push(n),w=N)}return e.coords.length=w,e.coords.length?e:null}function B(e,t,n,o){const r=e[t],s=e[t+1],c=e[n],l=e[n+1],u=e[o],i=e[o+1];let a=c,h=l,f=u-a,g=i-h;if(0!==f||0!==g){const e=((r-a)*f+(s-h)*g)/(f*f+g*g);e>1?(a=u,h=i):e>0&&(a+=f*e,h+=g*e)}return f=r-a,g=s-h,f*f+g*g}function C(e,t,n,o,r,s,c){let l,u=o,i=0;for(let e=s+n;e<c;e+=n)l=B(t,e,s,c),l>u&&(i=e,u=l);u>o&&(i-s>n&&C(e,t,n,o,r,s,i),r(e,t,e.length,i,t[i],t[i+1]),c-i>n&&C(e,t,n,o,r,i,c))}function X(e,t,n,o,r){const{coords:s,lengths:c}=t,u=n?o?g:h:o?h:a,i=l(n,o);if(!s.length)return e!==t&&(e.lengths.length=0,e.coords.length=0),e;if(!c.length)return u(e.coords,s,0,0,p(r,s[0]),F(r,s[1])),e!==t&&(e.lengths.length=0,e.coords.length=i),e;const[f,d]=r.scale;let m=0;for(let t=0;t<c.length;t++){const n=c[t];e.lengths[t]=n;let o=p(r,s[m]),l=F(r,s[m+1]);u(e.coords,s,m,m,o,l),m+=i;for(let t=1;t<n;t++,m+=i)o+=s[m]*f,l-=s[m+1]*d,u(e.coords,s,m,m,o,l)}return e!==t&&(e.lengths.length=c.length,e.coords.length=s.length),e}function D(e,t,n,o){let r=0,s=e[o*t],c=e[o*(t+1)];for(let l=1;l<n;l++){const n=s+e[o*(t+l)],u=c+e[o*(t+l)+1],i=(n-s)*(u+c);s=n,c=u,r+=i}return.5*r}e.convertFromFeature=function(e,t,n,o,r){A[0]=e;const[s]=U(L,A,t,n,o,r);return A.length=L.length=0,s},e.convertFromFeatureSet=function(e,t){const o=new s,{hasM:r,hasZ:c,features:l,objectIdFieldName:i,spatialReference:a,geometryType:h,exceededTransferLimit:f,transform:g,fields:d}=e;return d&&(o.fields=d),o.geometryType=h,o.objectIdFieldName=i||t,o.spatialReference=a,o.objectIdFieldName?(l&&U(o.features,l,h,c,r,o.objectIdFieldName),f&&(o.exceededTransferLimit=f),r&&(o.hasM=r),c&&(o.hasZ=c),g&&(o.transform=g),o):(u.error(new n("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),o)},e.convertFromFeatures=U,e.convertFromGeometry=function(e,t,r){if(!e)return null;const s=new c;if("hasZ"in e&&null==t&&(t=e.hasZ),"hasM"in e&&null==r&&(r=e.hasM),o.isPoint(e)){return P(null!=t?t:null!=e.z,null!=r?r:null!=e.m)(s,e)}return o.isPolygon(e)?Y(s,e,t,r):o.isPolyline(e)?q(s,e,l(t,r)):o.isMultipoint(e)?O(s,e,l(t,r)):void u.error("convertFromGeometry:unknown-geometry",new n(`Unable to parse unknown geometry type '${e}'`))},e.convertFromGraphics=function(e,t,o,r,s,c){const l=e.length;switch(o){case"esriGeometryPoint":z(e,t,r,s,c);break;case"esriGeometryMultipoint":k(e,t,r,s,c);break;case"esriGeometryPolyline":S(e,t,r,s,c);break;case"esriGeometryPolygon":V(e,t,r,s,c);break;default:u.error("convertToFeatureSet:unknown-geometry",new n(`Unable to parse unknown geometry type '${o}'`))}for(let n=0;n<t.length;n++)e[n+l].geometryType=o,e[n+l].insertAfter=t[n].insertAfter,e[n+l].groupId=t[n].groupId;return e},e.convertFromMultipoint=O,e.convertFromMultipointFeatures=k,e.convertFromNestedArray=_,e.convertFromPoint=function(e,t,n=P(null!=t.z,null!=t.m)){return n(e,t)},e.convertFromPointFeatures=z,e.convertFromPolygon=Y,e.convertFromPolyline=q,e.convertFromPolylineFeatures=S,e.convertToFeature=function(e,t,n,o){L[0]=e,$(A,L,t,n,o);const r=A[0];return A.length=L.length=0,r},e.convertToFeatureSet=function(e){const{objectIdFieldName:t,spatialReference:n,transform:o,fields:r,hasM:s,hasZ:c,features:l,geometryType:u,exceededTransferLimit:i,uniqueIdField:a,queryGeometry:h,queryGeometryType:f}=e,g={features:$([],l,u,c,s),fields:r,geometryType:u,objectIdFieldName:t,spatialReference:n,uniqueIdField:a,queryGeometry:R(h,f,!1,!1)};return o&&(g.transform=o),i&&(g.exceededTransferLimit=i),s&&(g.hasM=s),c&&(g.hasZ=c),g},e.convertToFeatures=$,e.convertToGeometry=R,e.convertToMultipoint=Z,e.convertToMultipointFeatures=x,e.convertToPoint=function(e,t,n){return e?t?n?w(e):b(e):n?T(e):I(e):null},e.convertToPolygon=j,e.convertToPolyline=E,e.deltaDecodeGeometry=function(e,t){const n=e.clone(),o=e.coords,r=e.lengths;let s=0;for(let e=0;e<r.length;e++){const c=r[e];let l=o[t*s],u=o[t*s+1];for(let e=1;e<c;e++){const r=l+o[t*(s+e)],c=u+o[t*(s+e)+1];n.coords[t*(s+e)]=r,n.coords[t*(s+e)+1]=c,l=r,u=c}s+=c}return n},e.deltaEncodeGeometry=function(e,t){const n=e.clone(),o=e.coords,r=e.lengths;let s=0;for(let e=0;e<r.length;e++){const c=r[e];let l=o[t*s],u=o[t*s+1];for(let e=1;e<c;e++){const r=o[t*(s+e)],c=o[t*(s+e)+1],i=r-l,a=c-u;n.coords[t*(s+e)]=i,n.coords[t*(s+e)+1]=a,l=r,u=c}s+=c}return n},e.generalizeOptimizedGeometry=function(e,t,n,o,r,s,c=n,u=o){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const a=i[r],{coords:h,lengths:f}=t,g=l(n,o),m=l(n&&c,o&&u),y=d(n,o,c,u);if(!f.length)return y(e.coords,h,0,0,h[0],h[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;let p=0;const F=s*s;for(const t of f){if(t<a){p+=t*g;continue}const n=e.coords.length/m,o=p,r=p+(t-1)*g;y(e.coords,h,e.coords.length,o,h[o],h[o+1]),C(e.coords,h,g,F,y,o,r),y(e.coords,h,e.coords.length,r,h[r],h[r+1]);const s=e.coords.length/m-n;s>=a?e.lengths.push(s):e.coords.length=n*m,p+=t*g}return e.coords.length?e:null},e.getBoundsOptimizedGeometry=function(e,t,n,o){if(!t||!t.coords||!t.coords.length)return null;const r=l(n,o);let s=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=r){const n=e[t],o=e[t+1];s=Math.min(s,n),u=Math.max(u,n),c=Math.min(c,o),i=Math.max(i,o)}}return e[0]=s,e[1]=c,e[2]=u,e[3]=i,e},e.getQuantizedArea=function(e,t){const{coords:n,lengths:o}=e;let r=0,s=0;for(let e=0;e<o.length;e++){s+=D(n,r,o[e],t),r+=e}return Math.abs(s)},e.getQuantizedBoundsOptimizedGeometry=function(e,t,n,o){const r=l(n,o),{lengths:s,coords:c}=t;let u=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,f=0;for(const e of s){let t=c[f],n=c[f+1];u=Math.min(t,u),i=Math.min(n,i),a=Math.max(t,a),h=Math.max(n,h),f+=r;for(let o=1;o<e;o++,f+=r){const e=c[f],o=c[f+1];t+=e,n+=o,e<0&&(u=Math.min(u,t)),e>0&&(a=Math.max(a,t)),o<0?i=Math.min(i,n):o>0&&(h=Math.max(h,n))}}return e[0]=u,e[1]=i,e[2]=a,e[3]=h,e},e.getSignedQuantizedRingArea=D,e.quantizeOptimizedFeatureSet=function(e,t){const{geometryType:n,features:o,hasM:r,hasZ:s}=t;if(!e)return t;for(let t=0;t<o.length;t++){const l=o[t],u=l.weakClone();u.geometry=new c,Q(u.geometry,l.geometry,r,s,n,e),l.centroid&&(u.centroid=new c,Q(u.centroid,l.centroid,r,s,"esriGeometryPoint",e)),o[t]=u}return t.transform=e,t},e.quantizeOptimizedGeometry=Q,e.quantizeX=m,e.quantizeY=y,e.removeCollinearVectices=function(e,t,n,o,r){if(!t||!t.coords||!t.coords.length)return null;const s=i[n],{coords:c,lengths:u}=t,a=d(o,r,o,r),h=l(o,r);let f=0,g=0,m=0,y=0;for(const t of u){g=y,a(e.coords,c,g,f,c[f],c[f+1]),f+=h;let n=c[f],o=c[f+1],r=n,l=o,u=o/n;g+=h,a(e.coords,c,g,f,r,l),f+=h;for(let s=2;s<t;s++){n=c[f],o=c[f+1];const t=o/n,s=u===t||!isFinite(u)&&!isFinite(t),i=s&&isFinite(t)?u>=0&&t>=0||u<=0&&t<=0:l>=0&&o>=0||l<=0&&o<=0;s&&i?(r+=n,l+=o):(r=n,l=o,g+=h),a(e.coords,c,g,f,r,l),f+=h,u=t}g+=h;const i=(g-y)/h;i>=s&&(e.lengths[m]=i,y=g,m++)}return e.coords.length>y&&(e.coords.length=y),e.lengths.length>m&&(e.lengths.length=m),e.coords.length&&e.lengths.length?e:null},e.removeZMValues=function(e,t,n,o,r,s){const c=l(n,o),u=d(n,o,r,s),i=t.coords;e.coords.length=0,e.lengths.length=0,e.lengths.push(...t.lengths);for(let t=0;t<i.length;t+=c)u(e.coords,i,e.coords.length,t,i[t],i[t+1]);return e},e.unquantizeOptimizedFeatureSet=function(e){const{transform:t,features:n,hasM:o,hasZ:r}=e;if(!t)return e;for(const e of n)e.geometry&&X(e.geometry,e.geometry,o,r,t),e.centroid&&X(e.centroid,e.centroid,o,r,t);return e.transform=null,e},e.unquantizeOptimizedGeometry=X,e.unquantizeX=p,e.unquantizeY=F,Object.defineProperty(e,"__esModule",{value:!0})}));
