// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../geometry","../../Graphic","../../core/compilerUtils","../../core/has","../../core/lang","../../core/maybe","../../core/typedArrayUtil","../../geometry/SpatialReference","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/jsonUtils","../../geometry/support/quantizationUtils","../support/Field","./dehydratedFeatureComparison"],function(e,t,r,a,n,i,s,o,l,u,h,c,p,m,y,f){function d(e){return o.isSome(e.geometry)}function g(e){return r.isFeatureGeometryType(e.type)}function b(e){return"point"===e.type}function x(e){var t=r.featureGeometryTypeKebabDictionary.fromJSON(e.geometryType),a=u.fromJSON(e.spatialReference),i=e.transform,s=e.features.map(function(r){var s=v(r,t,a,e.objectIdFieldName),o=s.geometry;if(o&&i)switch(o.type){case"point":s.geometry=m.hydratePoint(i,o,o,o.hasZ,o.hasM);break;case"multipoint":s.geometry=m.hydrateMultipoint(i,o,o,o.hasZ,o.hasM);break;case"polygon":s.geometry=m.hydratePolygon(i,o,o,o.hasZ,o.hasM);break;case"polyline":s.geometry=m.hydratePolyline(i,o,o,o.hasZ,o.hasM);break;default:n.neverReached(o)}return s});return{geometryType:t,features:s,spatialReference:a,fields:e.fields?e.fields.map(function(e){return y.fromJSON(e)}):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function v(e,t,r,n){return{uid:a.generateUID(),objectId:n&&e.attributes?e.attributes[n]:null,attributes:e.attributes,geometry:Z(e.geometry,t,r),visible:!0}}function Z(e,t,r){if(!e)return null;switch(t){case"point":var a=e,n={x:a.x,y:a.y,z:a.z,m:a.m,hasZ:null!=a.z,hasM:null!=a.m,type:"point",spatialReference:r};return n;case"polyline":var i=e,n={paths:i.paths,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polyline",spatialReference:r};return n;case"polygon":var s=e,n={rings:s.rings,hasZ:!!s.hasZ,hasM:!!s.hasM,type:"polygon",spatialReference:r};return n;case"multipoint":var o=e,n={points:o.points,hasZ:!!o.hasZ,hasM:!!o.hasM,type:"multipoint",spatialReference:r};return n}}function M(e,t,r,a){return{x:e,y:t,z:r,hasZ:null!=r,hasM:!1,spatialReference:a,type:"point"}}function A(e){return"declaredClass"in e}function R(e){return"declaredClass"in e}function z(e){return"declaredClass"in e}function N(e,t){if(!e||z(e))return e;var r=new a({layer:t,sourceLayer:t});return r.visible=e.visible,r.symbol=s.clone(e.symbol),r.attributes=s.clone(e.attributes),r.geometry=k(e.geometry),r}function k(e){return o.isNone(e)?null:A(e)?e:p.fromJSON(w(e))}function F(e,t){if(!e)return null;var r;if(R(e)){if(null==t)return e.clone();if(R(t))return t.copy(e)}return null!=t?(r=t,r.x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=null,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=null,r.hasM=!1)):(r=M(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r}function S(e){if(!e)return 0;var t=32;for(var r in e)if(e.hasOwnProperty(r)){var a=e[r];switch(typeof a){case"string":t+=V(a);break;default:case"number":t+=16}}return t}function j(e){if(o.isNone(e))return 0;var t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":for(var r=0,a=2+(e.hasZ?1:0)+(e.hasM?1:0),i="polyline"===e.type?e.paths:e.rings,s=0,u=i;s<u.length;s++){r+=u[s].length}t+=8*r*a+64,t+=128*r,t+=34,t+=32*(i.length+1);break;case"multipoint":var h=2+(e.hasZ?1:0)+(e.hasM?1:0),c=e.points.length;t+=8*c*h+64,t+=128*c,t+=34,t+=32;break;case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=l.estimateSize(e.vertexAttributes.position),t+=l.estimateSize(e.vertexAttributes.normal),t+=l.estimateSize(e.vertexAttributes.uv),t+=l.estimateSize(e.vertexAttributes.tangent);break;default:n.neverReached(e)}return t}function I(e){var t=32;return t+=S(e.attributes),t+=3,t+=8+j(e.geometry)}function O(e){if(o.isNone(e))return 0;switch(e.type){case"point":return 1;case"polyline":for(var t=0,r=0,a=e.paths;r<a.length;r++){t+=a[r].length}return t;case"polygon":for(var t=0,i=0,s=e.rings;i<s.length;i++){t+=s[i].length}return t;case"multipoint":return e.points.length;case"extent":return 2;case"mesh":var l=e.vertexAttributes&&e.vertexAttributes.position;return l?l.length/3:0;default:return void n.neverReached(e)}}function P(e){if(!e)return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(var t=0,r=e.paths;t<r.length;t++){if(r[t].length>0)return!0}return!1;case"polygon":for(var a=0,i=e.rings;a<i.length;a++){if(i[a].length>0)return!0}return!1;case"multipoint":return e.points.length>0;case"mesh":return e.vertexAttributes&&e.vertexAttributes.position&&e.vertexAttributes.position.length>0;default:return void n.neverReached(e)}}function w(e){var t=e.spatialReference.toJSON();switch(e.type){case"point":return{x:e.x,y:e.y,z:e.z,m:e.m,spatialReference:t};case"polygon":var r=e.rings,a=e.hasZ,i=e.hasM;return{rings:G(r),hasZ:a,hasM:i,spatialReference:t};case"polyline":var s=e.paths,a=e.hasZ,i=e.hasM;return{paths:G(s),hasZ:a,hasM:i,spatialReference:t};case"extent":var o=e.xmin,l=e.xmax,u=e.ymin,h=e.ymax,c=e.zmin,p=e.zmax,m=e.mmin,y=e.mmax,a=e.hasZ,i=e.hasM;return{xmin:o,xmax:l,ymin:u,ymax:h,zmin:c,zmax:p,mmin:m,mmax:y,hasZ:a,hasM:i,spatialReference:t};case"multipoint":var f=e.points,a=e.hasZ,i=e.hasM;return{points:J(f)?B(f):f,hasZ:a,hasM:i,spatialReference:t};default:return void n.neverReached(e)}}function G(e){return T(e)?e.map(function(e){return B(e)}):e}function B(e){return e.map(function(e){return l.toArray(e)})}function T(e){for(var t=0,r=e;t<r.length;t++){var a=r[t];if(0!==a.length)return J(a)}return!1}function J(e){return e.length&&(l.isFloat32Array(e[0])||l.isFloat64Array(e[0]))}function C(e,t){switch(h.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(var r=0;r<e.paths.length;r++)h.expandWithNestedArray(t,e.paths[r],e.hasZ);break;case"polygon":for(var r=0;r<e.rings.length;r++)h.expandWithNestedArray(t,e.rings[r],e.hasZ);break;case"multipoint":h.expandWithNestedArray(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax);break;default:n.neverReached(e)}}function W(e,t){C(e,_),h.expand(t,_)}function D(e,t){switch(c.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(var r=0;r<e.paths.length;r++)c.expandWithNestedArray(t,e.paths[r]);break;case"polygon":for(var r=0;r<e.rings.length;r++)c.expandWithNestedArray(t,e.rings[r]);break;case"multipoint":c.expandWithNestedArray(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax;break;default:n.neverReached(e)}}function U(e,t){D(e,K),c.expand(t,K)}function q(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}Object.defineProperty(t,"__esModule",{value:!0}),t.equals=f.equals;var L=function(){function e(e,t,r){this.uid=e,this.geometry=t,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}return e}();t.DehydratedFeatureClass=L,t.hasGeometry=d,t.isFeatureGeometry=g;var H=function(){function e(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}return e}();t.DehydratedFeatureSetClass=H,t.isPoint=b,t.fromFeatureSetJSON=x,t.fromJSONGeometry=Z,t.makeDehydratedPoint=M,t.isHydratedGeometry=A,t.isHydratedPoint=R,t.isHydratedGraphic=z,t.hydrateGraphic=N,t.hydrateGeometry=k,t.clonePoint=F;var V=i("esri-text-decoder")?function(e){return 32+e.length}:function(e){return 32*e.length};t.estimateAttributesObjectSize=S,t.estimateGeometryObjectSize=j,t.estimateSize=I,t.numVertices=O,t.hasVertices=P,t.computeAABB=C,t.expandAABB=W,t.computeAABR=D,t.expandAABR=U,t.getObjectId=q;var _=h.create(),K=c.create()});