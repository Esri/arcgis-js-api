// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","./StreamConnection","../../../../tasks/operations/zscale"],(function(e,t,o,n,r,s,c,i,a,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketConnection=t.ReadyState=void 0;var d,l=r.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(d=t.ReadyState||(t.ReadyState={}));var f=function(e){function t(t){var o=e.call(this)||this;o.errorString=null;var n=t.geometryType,r=t.spatialReference,s=t.sourceSpatialReference;return o._config=t,o._featureZScaler=u.getGeometryZScaler(n,s,r),o._open(),o}return o.__extends(t,e),t.prototype._open=function(){return o.__awaiter(this,void 0,void 0,(function(){return o.__generator(this,(function(e){switch(e.label){case 0:return[4,this._tryCreateWebSocket()];case 1:return e.sent(),this.destroyed?[3,3]:[4,this._handshake()];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},t.prototype.destroy=function(){s.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null},Object.defineProperty(t.prototype,"connectionStatus",{get:function(){if(s.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case d.CONNECTING:case d.OPEN:return"connected";case d.CLOSING:case d.CLOSED:return"disconnected"}},enumerable:!1,configurable:!0}),t.prototype._tryCreateWebSocket=function(e,t,r){return void 0===e&&(e=this._config.source.path),void 0===t&&(t=1e3),void 0===r&&(r=0),o.__awaiter(this,void 0,void 0,(function(){var s,i,a;return o.__generator(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,4]),this.destroyed?[2]:(s=this,[4,this._createWebSocket(e)]);case 1:return s._websocket=o.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return i=o.sent(),a=t/1e3,this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(l.error(new n("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),this.destroy(),[2]):(l.error(new n("websocket-connection","Failed to connect. Attempting to reconnect in "+a+"s",i)),[4,c.after(t)]);case 3:return o.sent(),[2,this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),r+1)];case 4:return[2]}}))}))},t.prototype._createWebSocket=function(e){var t=this,o=new WebSocket(e),n=c.create((function(e,t){o.onopen=function(){return e(o)},o.onclose=function(e){return t(e)}}));return n.then((function(){if(t.destroyed)return o.onclose=function(){},void o.close();o.onclose=function(e){return t._onClose(e)},o.onerror=function(e){return t._onError(e)},o.onmessage=function(e){return t._onMessage(e)}})),n},t.prototype._handshake=function(e){return void 0===e&&(e=1e4),o.__awaiter(this,void 0,void 0,(function(){var t,r,i,a,u,d,f,p=this;return o.__generator(this,(function(o){return t=this._websocket,s.isNone(t)?[2]:(r=c.createResolver(),i=t.onmessage,a=this._config,u=a.filter,d=a.outFields,f=a.spatialReference,r.timeout(e),t.onmessage=function(e){var o,s=null;try{s=JSON.parse(e.data)}catch(e){}s&&"object"==typeof s||(l.error(new n("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),r.reject(),p.destroy()),(null===(o=s.spatialReference)||void 0===o?void 0:o.wkid)!==(null==f?void 0:f.wkid)&&(l.error(new n("websocket-connection","Protocol violation. Handshake failed - expected wkid of "+f.wkid,e.data)),r.reject(),p.destroy()),"json"!==s.format&&(l.error(new n("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),r.reject(),p.destroy()),u&&s.filter!==u&&l.error(new n("websocket-connection","Tried to set filter, but server doesn't support it")),d&&s.outFields!==d&&l.error(new n("websocket-connection","Tried to set outFields, but server doesn't support it")),t.onmessage=i,r.resolve()},t.send(JSON.stringify({filter:u,outFields:d,format:"json",spatialReference:{wkid:f.wkid}})),[2,r.promise])}))}))},t.prototype._onMessage=function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new n("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(var o=0,r=t.features;o<r.length;o++){var s=r[o];this._featureZScaler&&this._featureZScaler(s.geometry),this.onFeature(s)}}catch(e){return l.error(new n("websocket-connection","Failed to parse message",e)),void this.destroy()}},t.prototype._onError=function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),l.error("websocket-connection",t)},t.prototype._onClose=function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&l.error("websocket-connection","WebSocket closed unexpectedly with error code "+e.code),this.destroyed||this._open()},o.__decorate([i.property()],t.prototype,"connectionStatus",null),o.__decorate([i.property()],t.prototype,"errorString",void 0),t=o.__decorate([i.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],t)}(a.default);t.WebSocketConnection=f}));