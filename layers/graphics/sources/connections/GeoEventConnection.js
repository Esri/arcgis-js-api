/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/Error","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../core/promiseUtils","../../../../geometry/SpatialReference","../../../../geometry/support/jsonUtils","../../../../geometry","../../../../request","../../../../tasks/support/Query","../../../../tasks/operations/query","./WebSocketConnection"],(function(e,t,r,n,o,i,s,c,a,u,f,l,d,h,y,_,p,g,m,w,S){"use strict";function v(e){return Object.freeze({__proto__:null,default:e})}const F=i.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),b={maxQueryDepth:5,maxRecordCountFactor:3};let q=function(r){function n(e){return r.call(this,{...b,...e})||this}t._inheritsLoose(n,r);var i=n.prototype;return i._open=async function(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||F.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=await this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:r,outFields:n}=this._config;this.destroyed||this._setFilter(r,n)},i._onMessage=function(e){let t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void F.error(new u("geoevent-connection","Failed to parse message",e))}this.onFeature(t)},i._fetchServiceDefinition=async function(e){const t=g(e.path,{query:{f:"json"},responseType:"json"}),r=(await t).data;return this._serviceDefinition=r,r},i._fetchWebSocketUrl=async function(e,t){const r=e[0],{urls:n,token:o}=r;return`${this._inferWebSocketBaseUrl(n)}/subscribe?outSR=${t.wkid}${o?"&token="+o:""}`},i._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf("wss"))return t;return F.error(new u("geoevent-connection","Unable to infer WebSocket url",e)),null},i._setFilter=async function(e,t){const r=this._websocket;if(o.isNone(r)||o.isNone(e)&&o.isNone(t))return;const n=JSON.stringify({filter:this._serializeFilter(e,t)});let i=!1;const s=h.createResolver();return r.onmessage=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(F.error(new u("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString",`Could not set service filter - ${t.error}`),s.reject(t.error)),r.onmessage=this._onMessage.bind(this),i=!0,s.resolve())},r.send(n),setTimeout((()=>{i||(this.destroyed||this._websocket!==r||F.error(new u("geoevent-connection","Server timed out when setting filter")),s.reject())}),1e4),s.promise},i._serializeFilter=function(e,t){const r={};if(o.isNone(e)&&o.isNone(t))return r;if(o.isSome(e)&&e.geometry)try{const t=_.fromJSON(e.geometry);if("extent"!==t.type)throw new u(`Expected extent but found type ${t.type}`);r.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(e){F.error(new u("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return o.isSome(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),o.isSome(t)&&(r.outFields=t.join(",")),r},i._enrich=function(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return F.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:n,geometry:o}=this._relatedFeatures.get(r);for(const t in n)e.attributes[t]=n[t];return o&&(e.geometry=o),e.geometry||e.centroid||F.error(new u("geoevent-connection","Found malformed feature - no geometry found",e)),e},i._queryBuddyServices=async function(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),n=this._queryArchive(t);await r;const o=await n;if(!o)return;for(const e of o.features)this.onFeature(this._enrich(e))}catch(e){F.error(new u("geoevent-connection","Encountered an error when querying buddy services",{error:e}))}},i._queryRelatedFeatures=async function(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)},i._queryArchive=async function(e){if(e)return this._queryBuddy(e.featuresUrl)},i._queryBuddy=async function(t){const r=new((await new Promise((function(t,r){e(["../../../FeatureLayer"],(function(e){t(v(e))}),r)}))).default)({url:t}),{capabilities:n}=await r.load(),i=n.query.supportsMaxRecordCountFactor,s=n.query.supportsPagination,c=n.query.supportsCentroid,a=this._config.maxRecordCountFactor,u=r.capabilities.query.maxRecordCount,f=i?u*a:u,l=new m;if(l.outFields=o.unwrapOr(this._config.outFields,["*"]),l.where=o.unwrapOr(o.get(this._config.filter,"where"),"1=1"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=y.fromJSON(this._config.spatialReference),c&&(l.returnCentroid=!0),i&&(l.maxRecordCountFactor=a),s)return l.num=f,r.destroy(),this._queryPages(t,l);const d=await w.executeQuery(t,l,this._config.sourceSpatialReference);return r.destroy(),d.data},i._queryPages=async function(e,t,r=[],n=0){t.start=o.isSome(t.num)?n*t.num:null;const{data:i}=await w.executeQuery(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&n<this._config.maxQueryDepth?(i.features.forEach((e=>r.push(e))),this._queryPages(e,t,r,n+1)):(r.forEach((e=>i.features.push(e))),i)},i._addRelatedFeatures=function(e){const t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField;for(const e of r){const r=e.attributes[n];t.set(r,e)}this._relatedFeatures=t},n}(S.WebSocketConnection);return q=r.__decorate([a.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],q),q}));
