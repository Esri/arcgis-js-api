/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../geometry","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/set","../../../../core/accessorSupport/decorators/subclass","./WebSocketConnection","../../../../rest/query/operations/query","../../../../rest/support/Query","../../../../geometry/support/jsonUtils","../../../../geometry/SpatialReference"],(function(e,t,r,n,o,i,s,c,u,a,f,l,d,y,h,p,_,g,m,v){"use strict";const S=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),b=s.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),F=1e4,w={maxQueryDepth:5,maxRecordCountFactor:3};let q=function(r){function n(e){return r.call(this,{...w,...e})||this}t._inheritsLoose(n,r);var s=n.prototype;return s._open=function(){var e=t._asyncToGenerator((function*(){const e=yield this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||b.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),yield this._buddyServicesQuery,yield this._tryCreateWebSocket(t);const{filter:r,outFields:n}=this._config;this.destroyed||this._setFilter(r,n)}));function r(){return e.apply(this,arguments)}return r}(),s._onMessage=function(e){let t;try{t=this._enrich(JSON.parse(e.data)),c.isSome(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(r){return void b.error(new i("geoevent-connection","Failed to parse message",r))}this.onFeature(t)},s._fetchServiceDefinition=function(){var e=t._asyncToGenerator((function*(e){const t={f:"json",...this._config.customParameters},r=o(e.path,{query:t,responseType:"json"}),n=(yield r).data;return this._serviceDefinition=n,n}));function r(t){return e.apply(this,arguments)}return r}(),s._fetchWebSocketUrl=function(e,t){const r=e[0],{urls:n,token:o}=r,i=this._inferWebSocketBaseUrl(n);return a.addQueryParameters(`${i}/subscribe`,{outSR:""+t.wkid,token:o})},s._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf("wss"))return t;return b.error(new i("geoevent-connection","Unable to infer WebSocket url",e)),null},s._setFilter=function(){var e=t._asyncToGenerator((function*(e,t){const r=this._websocket;if(c.isNone(r)||c.isNone(e)&&c.isNone(t))return;const n=JSON.stringify({filter:this._serializeFilter(e,t)});let o=!1;const s=u.createResolver(),a=()=>{o||(this.destroyed||this._websocket!==r||b.error(new i("geoevent-connection","Server timed out when setting filter")),s.reject())},f=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(b.error(new i("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString",`Could not set service filter - ${t.error}`),s.reject(t.error)),r.onmessage=this._onMessage.bind(this),o=!0,s.resolve())};return r.onmessage=f,r.send(n),setTimeout(a,F),s.promise}));function r(t,r){return e.apply(this,arguments)}return r}(),s._serializeFilter=function(e,t){const r={};if(c.isNone(e)&&c.isNone(t))return r;if(c.isSome(e)&&e.geometry)try{const t=m.fromJSON(e.geometry);if("extent"!==t.type)throw new i(`Expected extent but found type ${t.type}`);r.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(n){b.error(new i("geoevent-connection","Encountered an error when setting connection geometryDefinition",n))}return c.isSome(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),c.isSome(t)&&(r.outFields=t.join(",")),r},s._enrich=function(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return b.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:n,geometry:o}=this._relatedFeatures.get(r);for(const i in n)e.attributes[i]=n[i];return o&&(e.geometry=o),e.geometry||e.centroid||b.error(new i("geoevent-connection","Found malformed feature - no geometry found",e)),e},s._queryBuddyServices=function(){var e=t._asyncToGenerator((function*(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),n=this._queryArchive(t);yield r;const o=yield n;if(!o)return;for(const i of o.features)this.onFeature(this._enrich(i))}catch(e){b.error(new i("geoevent-connection","Encountered an error when querying buddy services",{error:e}))}}));function r(){return e.apply(this,arguments)}return r}(),s._queryRelatedFeatures=function(){var e=t._asyncToGenerator((function*(e){if(!e)return;const t=yield this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}));function r(t){return e.apply(this,arguments)}return r}(),s._queryArchive=function(){var e=t._asyncToGenerator((function*(e){if(e)return this._queryBuddy(e.featuresUrl)}));function r(t){return e.apply(this,arguments)}return r}(),s._queryBuddy=function(){var r=t._asyncToGenerator((function*(t){const r=new((yield new Promise(((t,r)=>e(["../../../FeatureLayer"],(e=>t(S(e))),r)))).default)({url:t}),{capabilities:n}=yield r.load(),o=n.query.supportsMaxRecordCountFactor,i=n.query.supportsPagination,s=n.query.supportsCentroid,u=this._config.maxRecordCountFactor,a=r.capabilities.query.maxRecordCount,f=o?a*u:a,l=new g;if(l.outFields=c.unwrapOr(this._config.outFields,["*"]),l.where=c.unwrapOr(c.get(this._config.filter,"where"),"1=1"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=v.fromJSON(this._config.spatialReference),s&&(l.returnCentroid=!0),o&&(l.maxRecordCountFactor=u),i)return l.num=f,r.destroy(),this._queryPages(t,l);const d=yield _.executeQuery(t,l,this._config.sourceSpatialReference);return r.destroy(),d.data}));function n(e){return r.apply(this,arguments)}return n}(),s._queryPages=function(){var e=t._asyncToGenerator((function*(e,t,r=[],n=0){t.start=c.isSome(t.num)?n*t.num:null;const{data:o}=yield _.executeQuery(e,t,this._config.sourceSpatialReference);return o.exceededTransferLimit&&n<this._config.maxQueryDepth?(o.features.forEach((e=>r.push(e))),this._queryPages(e,t,r,n+1)):(r.forEach((e=>o.features.push(e))),o)}));function r(t,r){return e.apply(this,arguments)}return r}(),s._addRelatedFeatures=function(e){const t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField;for(const o of r){const e=o.attributes[n];t.set(e,o)}this._relatedFeatures=t},n}(p.WebSocketConnection);q=r.__decorate([h.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],q);return q}));
