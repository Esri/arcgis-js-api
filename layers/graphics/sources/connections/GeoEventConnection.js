// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../geometry","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../FeatureLayer","./WebSocketConnection","../../../../tasks/operations/query","../../../../tasks/support/Query"],(function(e,t,r,n,i,o,s,a,u,c,f,d,h,_){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=s.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),y={maxQueryDepth:5,maxRecordCountFactor:3},p=function(e){function t(t){return e.call(this,r.__assign(r.__assign({},y),t))||this}return r.__extends(t,e),t.prototype._open=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._fetchServiceDefinition(this._config.source)];case 1:return(e=r.sent()).timeInfo.trackIdField||l.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),[4,this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference)];case 2:return t=r.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return r.sent(),[4,this._tryCreateWebSocket(t)];case 4:return r.sent(),n=this._config,i=n.filter,o=n.outFields,this.destroyed||this._setFilter(i,o),[2]}}))}))},t.prototype._onMessage=function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void l.error(new o("geoevent-connection","Failed to parse message",e))}this.onFeature(t)},t.prototype._fetchServiceDefinition=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t={f:"json"},[4,i(e.path,{query:t,responseType:"json"})];case 1:return n=r.sent(),o=n.data,this._serviceDefinition=o,[2,o]}}))}))},t.prototype._fetchWebSocketUrl=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,o;return r.__generator(this,(function(r){return n=e[0],i=n.urls,o=n.token,[2,this._inferWebSocketBaseUrl(i)+"/subscribe?outSR="+t.wkid+(o?"&token="+o:"")]}))}))},t.prototype._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(var t=0,r=e;t<r.length;t++){var n=r[t];if(-1!==n.indexOf("wss"))return n}return l.error(new o("geoevent-connection","Unable to infer WebSocket url",e)),null},t.prototype._setFilter=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,s,c,f,d,h=this;return r.__generator(this,(function(r){return n=this._websocket,a.isNone(n)||a.isNone(e)&&a.isNone(t)?[2]:(i=JSON.stringify({filter:this._serializeFilter(e,t)}),s=!1,c=u.createResolver(),f=function(){s||(h.destroyed||h._websocket!==n||l.error(new o("geoevent-connection","Server timed out when setting filter")),c.reject())},d=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(l.error(new o("geoevent-connection","Failed to set service filter",t.error)),h._set("errorString","Could not set service filter - "+t.error),c.reject(t.error)),n.onmessage=h._onMessage.bind(h),s=!0,c.resolve())},n.onmessage=d,n.send(i),setTimeout(f,1e4),[2,c.promise])}))}))},t.prototype._serializeFilter=function(e,t){var r={};if(a.isNone(e)&&a.isNone(t))return r;if(a.isSome(e)&&e.geometry)try{var i=n.fromJSON(e.geometry);if("extent"!==i.type)throw new o("Expected extent but found type "+i.type);r.geometry=JSON.stringify(i.shiftCentralMeridian())}catch(e){l.error(new o("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return a.isSome(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),a.isSome(t)&&(r.outFields=t.join(",")),r},t.prototype._enrich=function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return l.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),i=n.attributes,s=n.geometry;for(var a in i)e.attributes[a]=i[a];return s&&(e.geometry=s),e.geometry||e.centroid||l.error(new o("geoevent-connection","Found malformed feature - no geometry found",e)),e},t.prototype._queryBuddyServices=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,n,i,s,a,u,c,f,d;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),e=this._serviceDefinition,t=e.relatedFeatures,n=e.keepLatestArchive,i=this._queryRelatedFeatures(t),s=this._queryArchive(n),[4,i];case 1:return r.sent(),[4,s];case 2:if(!(a=r.sent()))return[2];for(u=0,c=a.features;u<c.length;u++)f=c[u],this.onFeature(this._enrich(f));return[3,4];case 3:return d=r.sent(),l.error(new o("geoevent-connection","Encountered an error when querying buddy services",{error:d})),[3,4];case 4:return[2]}}))}))},t.prototype._queryRelatedFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return e?[4,this._queryBuddy(e.featuresUrl)]:[2];case 1:return t=r.sent(),this._addRelatedFeatures(t),[2]}}))}))},t.prototype._queryArchive=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e?[2,this._queryBuddy(e.featuresUrl)]:[2,void 0]}))}))},t.prototype._queryBuddy=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,o,s,u,c,d,l,y,p;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,(t=new f({url:e})).load()];case 1:return i=r.sent().capabilities,o=i.query.supportsMaxRecordCountFactor,s=i.query.supportsPagination,u=i.query.supportsCentroid,c=this._config.maxRecordCountFactor,d=t.capabilities.query.maxRecordCount,l=o?d*c:d,(y=new _).outFields=a.unwrapOr(this._config.outFields,["*"]),y.where=a.unwrapOr(a.get(this._config.filter,"where"),"1=1"),y.returnGeometry=!0,y.returnExceededLimitFeatures=!0,y.outSpatialReference=n.SpatialReference.fromJSON(this._config.spatialReference),u&&(y.returnCentroid=!0),o&&(y.maxRecordCountFactor=c),s?(y.num=l,t.destroy(),[2,this._queryPages(e,y)]):[4,h.executeQuery(e,y,this._config.sourceSpatialReference)];case 2:return p=r.sent(),t.destroy(),[2,p.data]}}))}))},t.prototype._queryPages=function(e,t,n,i){return void 0===n&&(n=[]),void 0===i&&(i=0),r.__awaiter(this,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return t.start=i*t.num,[4,h.executeQuery(e,t,this._config.sourceSpatialReference)];case 1:return(o=r.sent().data).exceededTransferLimit&&i<this._config.maxQueryDepth?(o.features.forEach((function(e){return n.push(e)})),[2,this._queryPages(e,t,n,i+1)]):(n.forEach((function(e){return o.features.push(e)})),[2,o])}}))}))},t.prototype._addRelatedFeatures=function(e){for(var t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField,i=0,o=r;i<o.length;i++){var s=o[i],a=s.attributes[n];t.set(a,s)}this._relatedFeatures=t},t=r.__decorate([c.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],t)}(d.WebSocketConnection);t.default=p}));