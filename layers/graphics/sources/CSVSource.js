/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/has","../../../core/Loadable","../../../core/maybe","../../../core/promiseUtils","../../../core/workers/workers","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../rest/support/FeatureSet","../../../geometry/Extent"],(function(e,t,o,n,r,i,s,u,c,a,l,p,d,y){"use strict";let f=function(t){function o(o){var n;return(n=t.call(this,o)||this).type="csv",n.refresh=s.debounce(function(){var t=e._asyncToGenerator((function*(e){yield n.load();const{extent:t,timeExtent:o}=yield n._connection.invoke("refresh",e);return n.sourceJSON.extent=t,o&&(n.sourceJSON.timeInfo.timeExtent=[o.start,o.end]),{dataChanged:!0,updates:{extent:n.sourceJSON.extent,timeInfo:n.sourceJSON.timeInfo}}}));return function(e){return t.apply(this,arguments)}}()),n}e._inheritsLoose(o,t);var r=o.prototype;return r.load=function(e){const t=i.isSome(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)},r.destroy=function(){var e;null==(e=this._connection)||e.close(),this._connection=null},r.openPorts=function(){var t=e._asyncToGenerator((function*(){return yield this.load(),this._connection.openPorts()}));function o(){return t.apply(this,arguments)}return o}(),r.queryFeatures=function(){var t=e._asyncToGenerator((function*(e,t={}){yield this.load(t);const o=yield this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return d.fromJSON(o)}));function o(e){return t.apply(this,arguments)}return o}(),r.queryFeaturesJSON=function(){var t=e._asyncToGenerator((function*(e,t={}){return yield this.load(t),this._connection.invoke("queryFeatures",e?e.toJSON():null,t)}));function o(e){return t.apply(this,arguments)}return o}(),r.queryFeatureCount=function(){var t=e._asyncToGenerator((function*(e,t={}){return yield this.load(t),this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)}));function o(e){return t.apply(this,arguments)}return o}(),r.queryObjectIds=function(){var t=e._asyncToGenerator((function*(e,t={}){return yield this.load(t),this._connection.invoke("queryObjectIds",e?e.toJSON():null,t)}));function o(e){return t.apply(this,arguments)}return o}(),r.queryExtent=function(){var t=e._asyncToGenerator((function*(e,t={}){yield this.load(t);const o=yield this._connection.invoke("queryExtent",e?e.toJSON():null,t);return{count:o.count,extent:y.fromJSON(o.extent)}}));function o(e){return t.apply(this,arguments)}return o}(),r.querySnapping=function(){var t=e._asyncToGenerator((function*(e,t={}){return yield this.load(t),this._connection.invoke("querySnapping",e,t)}));function o(e){return t.apply(this,arguments)}return o}(),r._startWorker=function(){var t=e._asyncToGenerator((function*(e){this._connection=yield u.open("CSVSourceWorker",{strategy:n("feature-layers-workers")?"dedicated":"local",signal:e});const{url:t,delimiter:o,fields:r,latitudeField:i,longitudeField:s,spatialReference:c,timeInfo:a}=this.loadOptions,l=yield this._connection.invoke("load",{url:t,customParameters:this.customParameters,parsingOptions:{delimiter:o,fields:null==r?void 0:r.map((e=>e.toJSON())),latitudeField:i,longitudeField:s,spatialReference:null==c?void 0:c.toJSON(),timeInfo:null==a?void 0:a.toJSON()}},{signal:e});this.locationInfo=l.locationInfo,this.sourceJSON=l.layerDefinition,this.delimiter=l.delimiter}));function o(e){return t.apply(this,arguments)}return o}(),o}(r);t.__decorate([c.property()],f.prototype,"type",void 0),t.__decorate([c.property()],f.prototype,"loadOptions",void 0),t.__decorate([c.property()],f.prototype,"customParameters",void 0),t.__decorate([c.property()],f.prototype,"locationInfo",void 0),t.__decorate([c.property()],f.prototype,"sourceJSON",void 0),t.__decorate([c.property()],f.prototype,"delimiter",void 0),f=t.__decorate([p.subclass("esri.layers.graphics.sources.CSVSource")],f);return f}));
