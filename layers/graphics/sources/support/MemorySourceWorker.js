/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../core/Error","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/jsonUtils","../../../support/fieldUtils","../../../support/fieldType","../../featureConversionUtils","../../../support/FieldsIndex","../../objectIdUtils","./clientSideDefaults","../../data/projectionSupport","../../data/FeatureStore","../../data/QueryEngine","./sourceUtils"],(function(e,t,i,n,s,r,a,u,l,o,d,c,p){"use strict";const f=t.WGS84,y={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:t.WGS84},m={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}};function h(e){return i.isPoint(e)?null!=e.z:!!e.hasZ}function g(e){return i.isPoint(e)?null!=e.m:!!e.hasM}return function(){function t(){this._queryEngine=null,this._nextObjectId=null}var F=t.prototype;return F.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFields=this._fieldsIndex=this._createDefaultAttributes=null},F.load=async function(t){const i=[],{features:r}=t,p=this._inferLayerProperties(r,t.fields),h=t.fields||[],g=null!=t.hasM?t.hasM:p.hasM,F=null!=t.hasZ?t.hasZ:p.hasZ,b=!t.spatialReference&&!p.spatialReference,I=b?f:t.spatialReference||p.spatialReference,E=b?y:null,_=t.geometryType||p.geometryType,j=!_;let T=t.objectIdField||p.objectIdField,x=t.timeInfo;if(!j&&(b&&i.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!_))throw new e("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!T)throw new e("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(p.objectIdField&&T!==p.objectIdField&&(i.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${T}" doesn't match the field name "${p.objectIdField}", found in the provided fields`}),T=p.objectIdField),T&&!p.objectIdField){let e=null;h.some((t=>t.name===T&&(e=t,!0)))?(e.type="esriFieldTypeOID",e.editable=!1,e.nullable=!1):h.unshift({alias:T,name:T,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const n of h){if(null==n.name&&(n.name=n.alias),null==n.alias&&(n.alias=n.name),!n.name)throw new e("feature-layer:invalid-field-name","field name is missing",{field:n});if(n.name===T&&(n.type="esriFieldTypeOID"),-1===s.kebabDict.jsonValues.indexOf(n.type))throw new e("feature-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n})}const R={};this._requiredFields=[];for(const e of h)if("esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type){e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable;const t=n.getFieldDefaultValue(e);e.nullable||void 0!==t?R[e.name]=t:this._requiredFields.push(e)}if(this._fieldsIndex=new a(h),this._createDefaultAttributes=l.createDefaultAttributesFunction(R,T),x){if(x.startTimeField){const e=this._fieldsIndex.get(x.startTimeField);e?(x.startTimeField=e.name,e.type="esriFieldTypeDate"):x.startTimeField=null}if(x.endTimeField){const e=this._fieldsIndex.get(x.endTimeField);e?(x.endTimeField=e.name,e.type="esriFieldTypeDate"):x.endTimeField=null}if(x.trackIdField){const e=this._fieldsIndex.get(x.trackIdField);e?x.trackIdField=e.name:(x.trackIdField=null,i.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:x}}))}x.startTimeField||x.endTimeField||(i.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:x}}),x=null)}const q={warnings:i,featureErrors:[],layerDefinition:{...m,drawingInfo:l.createDrawingInfo(_),templates:l.createDefaultTemplate(R),extent:E,geometryType:_,objectIdField:T,fields:h,hasZ:!!F,hasM:!!g,timeInfo:x},assignedObjectIds:{}};if(this._queryEngine=new c.default({fields:h,geometryType:_,hasM:g,hasZ:F,objectIdField:T,spatialReference:I,featureStore:new d({geometryType:_,hasM:g,hasZ:F}),timeInfo:x,cacheSpatialQueries:!0}),!r||!r.length)return this._nextObjectId=u.initialObjectId,q;const S=u.findLastObjectIdFromFeatures(T,r);return this._nextObjectId=S+1,await o.checkProjectionSupport(r,I),this._loadInitialFeatures(q,r)},F.applyEdits=async function(e){const{spatialReference:t,geometryType:i}=this._queryEngine;return await Promise.all([p.loadGeometryEngineForSimplify(t,i),o.checkProjectionSupport(e.adds,t),o.checkProjectionSupport(e.updates,t)]),this._applyEdits(e)},F.queryFeatures=function(e,t={}){return this._queryEngine.executeQuery(e,t.signal)},F.queryFeatureCount=function(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)},F.queryObjectIds=function(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)},F.queryExtent=function(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)},F.querySnapping=function(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)},F._inferLayerProperties=function(e,t){let n,s,r=null,a=null,u=null;for(const l of e){const e=l.geometry;if(e&&(r||(r=i.getJsonType(e)),a||(a=e.spatialReference),null==n&&(n=h(e)),null==s&&(s=g(e)),r&&a&&null!=n&&null!=s))break}if(t&&t.length){let e=null;t.some((t=>{const i="esriFieldTypeOID"===t.type,n=!t.type&&t.name&&"objectid"===t.name.toLowerCase();return e=t,i||n}))&&(u=e.name)}return{geometryType:r,spatialReference:a,objectIdField:u,hasM:s,hasZ:n}},F._loadInitialFeatures=function(e,t){const{geometryType:n,hasM:s,hasZ:a,objectIdField:u,spatialReference:l,featureStore:d}=this._queryEngine,c=[];for(const r of t){if(null!=r.uid&&(e.assignedObjectIds[r.uid]=-1),r.geometry&&n!==i.getJsonType(r.geometry)){e.featureErrors.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),s=p.mixAttributes(this._fieldsIndex,this._requiredFields,t,r.attributes,!0,e.warnings);s?e.featureErrors.push(s):(this._assignObjectId(t,r.attributes,!0),r.attributes=t,null!=r.uid&&(e.assignedObjectIds[r.uid]=r.attributes[u]),r.geometry&&(r.geometry=o.project(r.geometry,r.geometry.spatialReference,l)),c.push(r))}if(d.addMany(r.convertFromFeatures([],c,n,a,s,u)),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){const{start:t,end:i}=this._queryEngine.timeExtent;e.layerDefinition.timeInfo.timeExtent=[t,i]}return e},F._applyEdits=function(e){const{adds:t,updates:i,deletes:n}=e,s={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(s,t),i&&i.length&&this._applyUpdateEdits(s,i),n&&n.length){for(const e of n)s.deleteResults.push(p.createFeatureEditSuccessResult(e));this._queryEngine.featureStore.removeManyById(n)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:s}},F._applyAddEdits=function(e,t){const{addResults:n}=e,{geometryType:s,hasM:a,hasZ:u,objectIdField:l,spatialReference:d,featureStore:c}=this._queryEngine,f=[];for(const r of t){if(r.geometry&&s!==i.getJsonType(r.geometry)){n.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),a=p.mixAttributes(this._fieldsIndex,this._requiredFields,t,r.attributes);if(a)n.push(a);else{if(this._assignObjectId(t,r.attributes),r.attributes=t,null!=r.uid){const t=r.attributes[l];e.uidToObjectId[r.uid]=t}r.geometry&&(r.geometry=o.project(p.simplify(r.geometry,d),r.geometry.spatialReference,d)),f.push(r),n.push(p.createFeatureEditSuccessResult(r.attributes[l]))}}c.addMany(r.convertFromFeatures([],f,s,u,a,l))},F._applyUpdateEdits=function({updateResults:e},t){const{geometryType:n,hasM:s,hasZ:a,objectIdField:u,spatialReference:l,featureStore:d}=this._queryEngine;for(const c of t){const{attributes:t,geometry:f}=c,y=t&&t[u];if(null==y){e.push(p.createFeatureEditErrorResult(`Identifier field ${u} missing`));continue}if(!d.has(y)){e.push(p.createFeatureEditErrorResult(`Feature with object id ${y} missing`));continue}const m=r.convertToFeature(d.getFeature(y),n,a,s);if(f){if(n!==i.getJsonType(f)){e.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}m.geometry=o.project(p.simplify(f,l),f.spatialReference,l)}if(t){const i=p.mixAttributes(this._fieldsIndex,this._requiredFields,m.attributes,t);if(i){e.push(i);continue}}d.add(r.convertFromFeature(m,n,a,s,u)),e.push(p.createFeatureEditSuccessResult(y))}},F._assignObjectId=function(e,t,i=!1){const n=this._queryEngine.objectIdField;i&&t&&isFinite(t[n])?e[n]=t[n]:e[n]=this._nextObjectId++},t}()}));
