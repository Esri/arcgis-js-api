/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../../core/Error","../../../../core/promiseUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/jsonUtils","../../../support/fieldUtils","../../../support/fieldType","../../featureConversionUtils","../../../support/FieldsIndex","../../data/projectionSupport","./clientSideDefaults","../../data/FeatureStore","../../data/QueryEngine","./sourceUtils"],(function(e,t,i,s,n,r,a,u,l,o,d,c,p){"use strict";const f=i.WGS84,y={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:i.WGS84},m={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}};function h(e){return s.isPoint(e)?null!=e.z:!!e.hasZ}function g(e){return s.isPoint(e)?null!=e.m:!!e.hasM}return function(){function i(){this._queryEngine=null,this._nextObjectId=null}var F=i.prototype;return F.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFields=this._fieldsIndex=this._createDefaultAttributes=null},F.load=async function(t){const i=[],{features:s}=t,a=this._inferLayerProperties(s,t.fields),p=t.fields||[],h=null!=t.hasM?t.hasM:a.hasM,g=null!=t.hasZ?t.hasZ:a.hasZ,F=!t.spatialReference&&!a.spatialReference,b=F?f:t.spatialReference||a.spatialReference,I=F?y:null,E=t.geometryType||a.geometryType,_=!E;let j=t.objectIdField||a.objectIdField,T=t.timeInfo;if(!_&&(F&&i.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!E))throw new e("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!j)throw new e("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(a.objectIdField&&j!==a.objectIdField&&(i.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${j}" doesn't match the field name "${a.objectIdField}", found in the provided fields`}),j=a.objectIdField),j&&!a.objectIdField){let e=null;p.some((t=>t.name===j&&(e=t,!0)))?(e.type="esriFieldTypeOID",e.editable=!1,e.nullable=!1):p.unshift({alias:j,name:j,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const t of p){if(null==t.name&&(t.name=t.alias),null==t.alias&&(t.alias=t.name),!t.name)throw new e("feature-layer:invalid-field-name","field name is missing",{field:t});if(t.name===j&&(t.type="esriFieldTypeOID"),-1===r.kebabDict.jsonValues.indexOf(t.type))throw new e("feature-layer:invalid-field-type",`invalid type for field "${t.name}"`,{field:t})}const x={};this._requiredFields=[];for(const e of p)if("esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type){e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable;const t=n.getFieldDefaultValue(e);e.nullable||void 0!==t?x[e.name]=t:this._requiredFields.push(e)}if(this._fieldsIndex=new u(p),this._createDefaultAttributes=o.createDefaultAttributesFunction(x,j),T){if(T.startTimeField){const e=this._fieldsIndex.get(T.startTimeField);e?(T.startTimeField=e.name,e.type="esriFieldTypeDate"):T.startTimeField=null}if(T.endTimeField){const e=this._fieldsIndex.get(T.endTimeField);e?(T.endTimeField=e.name,e.type="esriFieldTypeDate"):T.endTimeField=null}if(T.trackIdField){const e=this._fieldsIndex.get(T.trackIdField);e?T.trackIdField=e.name:(T.trackIdField=null,i.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:T}}))}T.startTimeField||T.endTimeField||(i.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:T}}),T=null)}const R={warnings:i,featureErrors:[],layerDefinition:{...m,drawingInfo:o.createDrawingInfo(E),templates:o.createDefaultTemplate(x),extent:I,geometryType:E,objectIdField:j,fields:p,hasZ:!!g,hasM:!!h,timeInfo:T},assignedObjectIds:{}};if(this._queryEngine=new c.default({fields:p,geometryType:E,hasM:h,hasZ:g,objectIdField:j,spatialReference:b,featureStore:new d({geometryType:E,hasM:h,hasZ:g}),timeInfo:T}),!s||!s.length)return this._nextObjectId=1,R;const q=s.reduce(((e,t)=>{const i=t.attributes&&t.attributes[j];return null==i||isNaN(i)||!isFinite(i)?e:Math.max(e,i)}),0);return this._nextObjectId=1+q,await l.checkProjectionSupport(s,b),this._loadInitialFeatures(R,s)},F.applyEdits=async function(e){const{spatialReference:i,geometryType:s}=this._queryEngine;return await t.all([p.loadGeometryEngineForSimplify(i,s),l.checkProjectionSupport(e.adds,i),l.checkProjectionSupport(e.updates,i)]),this._applyEdits(e)},F.queryFeatures=async function(e,t={}){return this._queryEngine.executeQuery(e,t.signal)},F.queryFeatureCount=async function(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)},F.queryObjectIds=async function(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)},F.queryExtent=async function(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)},F._inferLayerProperties=function(e,t){let i,n,r=null,a=null,u=null;for(const t of e){const e=t.geometry;if(e&&(r||(r=s.getJsonType(e)),a||(a=e.spatialReference),null==i&&(i=h(e)),null==n&&(n=g(e)),r&&a&&null!=i&&null!=n))break}if(t&&t.length){let e=null;t.some((t=>{const i="esriFieldTypeOID"===t.type,s=!t.type&&t.name&&"objectid"===t.name.toLowerCase();return e=t,i||s}))&&(u=e.name)}return{geometryType:r,spatialReference:a,objectIdField:u,hasM:n,hasZ:i}},F._loadInitialFeatures=function(e,t){const{geometryType:i,hasM:n,hasZ:r,objectIdField:u,spatialReference:o,featureStore:d}=this._queryEngine,c=[];for(const n of t){if(null!=n.uid&&(e.assignedObjectIds[n.uid]=-1),n.geometry&&i!==s.getJsonType(n.geometry)){e.featureErrors.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),r=p.mixAttributes(this._fieldsIndex,this._requiredFields,t,n.attributes,!0,e.warnings);r?e.featureErrors.push(r):(this._assignObjectId(t,n.attributes,!0),n.attributes=t,null!=n.uid&&(e.assignedObjectIds[n.uid]=n.attributes[u]),n.geometry&&(n.geometry=l.project(n.geometry,n.geometry.spatialReference,o)),c.push(n))}if(d.addMany(a.convertFromFeatures([],c,i,r,n,u)),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){const{start:t,end:i}=this._queryEngine.timeExtent;e.layerDefinition.timeInfo.timeExtent=[t,i]}return e},F._applyEdits=function(e){const{adds:t,updates:i,deletes:s}=e,n={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(n,t),i&&i.length&&this._applyUpdateEdits(n,i),s&&s.length){for(const e of s)n.deleteResults.push(p.createFeatureEditSuccessResult(e));this._queryEngine.featureStore.removeManyById(s)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:n}},F._applyAddEdits=function(e,t){const{addResults:i}=e,{geometryType:n,hasM:r,hasZ:u,objectIdField:o,spatialReference:d,featureStore:c}=this._queryEngine,f=[];for(const r of t){if(r.geometry&&n!==s.getJsonType(r.geometry)){i.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),a=p.mixAttributes(this._fieldsIndex,this._requiredFields,t,r.attributes);if(a)i.push(a);else{if(this._assignObjectId(t,r.attributes),r.attributes=t,null!=r.uid){const t=r.attributes[o];e.uidToObjectId[r.uid]=t}r.geometry&&(r.geometry=l.project(p.simplify(r.geometry,d),r.geometry.spatialReference,d)),f.push(r),i.push(p.createFeatureEditSuccessResult(r.attributes[o]))}}c.addMany(a.convertFromFeatures([],f,n,u,r,o))},F._applyUpdateEdits=function({updateResults:e},t){const{geometryType:i,hasM:n,hasZ:r,objectIdField:u,spatialReference:o,featureStore:d}=this._queryEngine;for(const c of t){const{attributes:t,geometry:f}=c,y=t&&t[u];if(null==y){e.push(p.createFeatureEditErrorResult(`Identifier field ${u} missing`));continue}if(!d.has(y)){e.push(p.createFeatureEditErrorResult(`Feature with object id ${y} missing`));continue}const m=a.convertToFeature(d.getFeature(y),i,r,n);if(f){if(i!==s.getJsonType(f)){e.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}m.geometry=l.project(p.simplify(f,o),f.spatialReference,o)}if(t){const i=p.mixAttributes(this._fieldsIndex,this._requiredFields,m.attributes,t);if(i){e.push(i);continue}}d.add(a.convertFromFeature(m,i,r,n,u)),e.push(p.createFeatureEditSuccessResult(y))}},F._assignObjectId=function(e,t,i=!1){const s=this._queryEngine.objectIdField;i&&t&&isFinite(t[s])?e[s]=t[s]:e[s]=this._nextObjectId++},i}()}));
