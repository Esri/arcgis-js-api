/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../geometry/projection","../../../../geometry/geometryAdapters/json","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/webMercatorUtils","../../OptimizedFeature","../../OptimizedGeometry","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","../csv/csv","./clientSideDefaults","../../../support/FieldsIndex","../../../support/fieldUtils","../../../../geometry/SpatialReference"],(function(e,t,n,i,r,o,s,a,l,u,c,d,f,p,y,h,m,_,g,F,I,T){"use strict";const E=g.createDrawingInfo("esriGeometryPoint"),w=["csv"],N=[0,0];let v=function(e,t){this.x=e,this.y=t},x=function(){function t(){var t=this;this._queryEngine=null,this._snapshotFeatures=function(){var n=e._asyncToGenerator((function*(e){const n=yield t._fetch(e);return t._createFeatures(n)}));return function(e){return n.apply(this,arguments)}}()}var F=t.prototype;return F.destroy=function(){this._queryEngine?.destroy(),this._queryEngine=null},F.load=function(){var t=e._asyncToGenerator((function*(e,t={}){this._loadOptions=e;const[n]=yield Promise.all([this._fetch(t.signal),this._checkProjection(e?.parsingOptions?.spatialReference)]),i=S(n,e);this._locationInfo=i.locationInfo,this._delimiter=i.delimiter,this._queryEngine=this._createQueryEngine(i);const r=yield this._createFeatures(n);if(this._queryEngine.featureStore.addMany(r),i.layerDefinition.extent=this._queryEngine.fullExtent,i.layerDefinition.timeInfo){const{start:e,end:t}=this._queryEngine.timeExtent;i.layerDefinition.timeInfo.timeExtent=[e,t]}return i}));function n(e){return t.apply(this,arguments)}return n}(),F.applyEdits=function(){var t=e._asyncToGenerator((function*(){throw new r("csv-layer:editing-not-supported","applyEdits() is not supported on CSVLayer")}));function n(){return t.apply(this,arguments)}return n}(),F.queryFeatures=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}));function n(){return t.apply(this,arguments)}return n}(),F.queryFeatureCount=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}));function n(){return t.apply(this,arguments)}return n}(),F.queryObjectIds=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}));function n(){return t.apply(this,arguments)}return n}(),F.queryExtent=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}));function n(){return t.apply(this,arguments)}return n}(),F.querySnapping=function(){var t=e._asyncToGenerator((function*(e,t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}));function n(e){return t.apply(this,arguments)}return n}(),F.refresh=function(){var t=e._asyncToGenerator((function*(e){return this._loadOptions.customParameters=e,this._snapshotTask?.abort(),this._snapshotTask=i.createTask(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),s.isAbortError(e)||o.getLogger("esri.layers.CSVLayer").error(new r("csv-layer:refresh","An error occurred during refresh",{error:e}))})),yield this._waitSnapshotComplete(),{extent:this._queryEngine.fullExtent,timeExtent:this._queryEngine.timeExtent}}));function n(e){return t.apply(this,arguments)}return n}(),F._waitSnapshotComplete=function(){var t=e._asyncToGenerator((function*(){if(this._snapshotTask&&!this._snapshotTask.finished){try{yield this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}));function n(){return t.apply(this,arguments)}return n}(),F._fetch=function(){var t=e._asyncToGenerator((function*(e){const{url:t,customParameters:i}=this._loadOptions;if(!t)throw new r("csv-layer:invalid-source","url not defined");const o=a.urlToObject(t);return(yield n(o.path,{query:{...o.query,...i},responseType:"text",signal:e})).data}));function i(e){return t.apply(this,arguments)}return i}(),F._createQueryEngine=function(e){const{objectIdField:t,fields:n,extent:i,timeInfo:r}=e.layerDefinition,o=new y({geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1});return new m.QueryEngine({fields:n,geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1,timeInfo:r,objectIdField:t,spatialReference:i.spatialReference||{wkid:4326},cacheSpatialQueries:!0,featureStore:o})},F._createFeatures=function(){var t=e._asyncToGenerator((function*(e){const{latitudeFieldName:t,longitudeFieldName:n}=this._locationInfo,{objectIdField:i,fieldsIndex:r,spatialReference:o}=this._queryEngine;let s=[];const a=[],y=r.fields.filter((e=>e.name!==i)).map((e=>e.name));let h=0;const m={};for(const l of r.fields)if("esriFieldTypeOID"!==l.type&&"esriFieldTypeGlobalID"!==l.type){const e=I.getFieldDefaultValue(l);void 0!==e&&(m[l.name]=e)}const F=_.parseRows(e,y,this._delimiter,g.createDefaultAttributesFunction(m,i));for(const l of F){const e=this._parseCoordinateValue(l[t]),o=this._parseCoordinateValue(l[n]);if(null!=o&&null!=e&&!isNaN(e)&&!isNaN(o)){l[t]=e,l[n]=o;for(const e in l)if(e!==t&&e!==n)if(r.isDateField(e)){const t=new Date(l[e]);l[e]=_.isValidDate(t,l[e])?t.getTime():null}else if(r.isNumericField(e)){const t=_.parseNumber(l[e]);isNaN(t)?l[e]=null:l[e]=t}l[i]=h,h++,s.push(new v(o,e)),a.push(l)}}if(!c.equals({wkid:4326},o))if(c.isWebMercator(o))for(const l of s)[l.x,l.y]=d.lngLatToXY(l.x,l.y,N);else s=l.projectMany(u.jsonAdapter,s,T.WGS84,o,null,null);const E=[];for(let l=0;l<s.length;l++){const{x:e,y:t}=s[l],n=a[l];n[i]=l+1,E.push(new f.OptimizedFeature(new p([],[e,t]),n,null,n[i]))}return E}));function n(e){return t.apply(this,arguments)}return n}(),F._parseCoordinateValue=function(e){if(null==e||""===e)return null;let t=_.parseNumber(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t},F._checkProjection=function(){var t=e._asyncToGenerator((function*(e){try{yield h.checkProjectionSupport(c.WGS84,e)}catch{throw new r("csv-layer:projection-not-supported","Projection not supported")}}));function n(e){return t.apply(this,arguments)}return n}(),t}();function S(e,t){const n=t.parsingOptions||{},i={delimiter:n.delimiter,layerDefinition:null,locationInfo:{latitudeFieldName:n.latitudeField,longitudeFieldName:n.longitudeField}},o=i.layerDefinition={name:a.getFilename(t.url,w)||"csv",drawingInfo:E,geometryType:"esriGeometryPoint",objectIdField:null,fields:[],timeInfo:n.timeInfo,extent:{xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:n.spatialReference||{wkid:102100}}},s=_.readRows(e),l=s.next().value?.trim(),u=s.next().value?.trim();if(!l)throw new r("csv-layer:empty-csv","CSV is empty",{csv:e});const{delimiter:c,locationInfo:d}=_.inferDelimiterAndLocationInfo(l,u,n);if(!c)throw new r("csv-layer:invalid-delimiter","Unable to detect the delimiter from CSV",{firstLine:l,secondLine:u,parsingOptions:n});if(!d)throw new r("csv-layer:location-fields-not-found","Unable to identify latitude and longitude fields from the CSV file",{firstLine:l,secondLine:u,parsingOptions:n});i.locationInfo=d,i.delimiter=c;const{names:f,aliases:p}=_.extractFieldNamesAndAliasesFromRow(l,c),y=_.inferFields(e,i.delimiter,f,p,i.locationInfo);if(n.fields?.length){const e=new F(n.fields);for(const t of y){const n=e.get(t.name);n&&Object.assign(t,n)}}if(!y.some((e=>"esriFieldTypeOID"===e.type&&(o.objectIdField=e.name,!0)))){const e={name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1};o.objectIdField=e.name,y.unshift(e)}o.fields=y;const h=new F(o.fields);if(i.locationInfo&&(i.locationInfo.latitudeFieldName=h.get(i.locationInfo.latitudeFieldName).name,i.locationInfo.longitudeFieldName=h.get(i.locationInfo.longitudeFieldName).name),o.timeInfo){const e=o.timeInfo;if(e.startTimeField){const t=h.get(e.startTimeField);t?(e.startTimeField=t.name,t.type="esriFieldTypeDate"):e.startTimeField=null}if(e.endTimeField){const t=h.get(e.endTimeField);t?(e.endTimeField=t.name,t.type="esriFieldTypeDate"):e.endTimeField=null}if(e.trackIdField){const t=h.get(e.trackIdField);e.trackIdField=t?t.name:null}e.startTimeField||e.endTimeField||(o.timeInfo=null)}return i}return x}));
