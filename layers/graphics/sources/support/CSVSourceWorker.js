// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../geometry","../../../../request","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/number","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../geometry/projection","../../../../geometry/geometryAdapters/json","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/webMercatorUtils","../../OptimizedFeature","../../OptimizedGeometry","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","../csv/csv","./clientSideDefaults","../../../support/FieldsIndex"],(function(e,t,i,r,n,a,o,l,u,s,d,f,c,p,m,y,g,h,v,_,F,I,N){Object.defineProperty(t,"__esModule",{value:!0});var b=I.createDrawingInfo("esriGeometryPoint"),w=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"];t.csvLatitudeFieldNames=["lat","latitude","y","ycenter","latitude83","latdecdeg","point-y"],t.csvLongitudeFieldNames=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","point-x"];var x,T,E,D,j=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i,q=[0,0],S=function(e,t){this.x=e,this.y=t},O=(x=u._parseInfo(),T=new RegExp("^"+x.regexp+"$"),E=new RegExp("["+x.group+"\\s\\xa0]","g"),D=x.factor,function(e){var t=T.exec(e);if(x.factor=D,!t)return NaN;var i=t[1];if(!t[1]){if(!t[2])return NaN;i=t[2],x.factor*=-1}return+(i=i.replace(E,"").replace(x.decimal,"."))*x.factor}),R="isInteger"in Number?Number.isInteger:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},k=function(){function e(){this._fieldsIndex=null,this._queryEngine=null}return e.prototype.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=null,this._fieldsIndex=null},e.prototype.load=function(e,t){return void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){var r,n,a,o,l;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,s.all([this._fetch(e.url,t),this._checkProjection(t&&e.parsing&&e.parsing.spatialReference)])];case 1:return r=i.sent()[0],n=this._parse(r,e.parsing),this._queryEngine=this._createQueryEngine(r,n),n.layerDefinition.extent=this._queryEngine.fullExtent,n.layerDefinition.timeInfo&&(a=this._queryEngine.timeExtent,o=a.start,l=a.end,n.layerDefinition.timeInfo.timeExtent=[o,l]),[2,n]}}))}))},e.prototype.applyEdits=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){throw new a("csv-source:editing-not-supported","applyEdits() is not supported on CSVLayer")}))}))},e.prototype.queryFeatures=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQuery(e,t.signal)]}))}))},e.prototype.queryFeatureCount=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQueryForCount(e,t.signal)]}))}))},e.prototype.queryObjectIds=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQueryForIds(e,t.signal)]}))}))},e.prototype.queryExtent=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQueryForExtent(e,t.signal)]}))}))},e.prototype._fetch=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r;return i.__generator(this,(function(i){switch(i.label){case 0:if(!e)throw new a("csv-source:invalid-source","url not defined");return r=d.urlToObject(e),[4,n(r.path,{query:r.query,responseType:"text",signal:t.signal})];case 1:return[2,i.sent().data]}}))}))},e.prototype._parse=function(e,t){void 0===t&&(t={});var i={columnDelimiter:t.columnDelimiter,layerDefinition:null,locationInfo:{latitudeFieldName:t.latitudeField,longitudeFieldName:t.longitudeField}},r=F.readRows(e),n=r.next().value;if(!n)throw new a("csv","CSV is empty",{csv:e});if(n=n.trim(),!t.columnDelimiter){var o=F.inferDelimiter(n);if(!o)throw new a("csv-source:invalid-delimiter","Unable to detect the delimiter from CSV");i.columnDelimiter=o}var u=n.split(i.columnDelimiter),s=i.layerDefinition={name:"csv",drawingInfo:b,geometryType:"esriGeometryPoint",objectIdField:null,fields:[],timeInfo:t.timeInfo,extent:{xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:t.spatialReference||{wkid:102100}}};if(!t.latitudeField||!t.longitudeField){var d=this._inferLocationInfo(u);if(!t.longitudeField&&!d.longitudeFieldName||!t.latitudeField&&!d.latitudeFieldName)throw new a("csv","Unable to identify latitudeField and/or longitudeField from CSV");i.locationInfo={longitudeFieldName:t.longitudeField||d.longitudeFieldName,latitudeFieldName:t.latitudeField||d.latitudeFieldName}}var f=this._inferFields(r,i.columnDelimiter,u,i.locationInfo);if(t.fields&&t.fields.length){for(var c=new Map,p=0,m=t.fields;p<m.length;p++){var y=m[p];c.set(y.name.toLowerCase(),y)}for(var g=0,h=f;g<h.length;g++){y=h[g];var v=c.get(y.name.toLowerCase());if(v){var _=y.name;l.mixin(y,v),y.name=_}}}if(s.fields=f,!s.fields.some((function(e){return"esriFieldTypeOID"===e.type&&(s.objectIdField=e.name,!0)}))){y={name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1};s.objectIdField=y.name,s.fields.unshift(y)}if(this._fieldsIndex=new N(s.fields),s.timeInfo){var I=s.timeInfo;if(I.startTimeField){var w=this._fieldsIndex.get(I.startTimeField);w?(I.startTimeField=w.name,w.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){var x=this._fieldsIndex.get(I.endTimeField);x?(I.endTimeField=x.name,x.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){var T=this._fieldsIndex.get(I.trackIdField);I.trackIdField=T?T.name:null}I.startTimeField||I.endTimeField||(s.timeInfo=null)}return i},e.prototype._inferLocationInfo=function(e){var i=null,r=null;return e.forEach((function(e){var n=e.toLowerCase();-1===t.csvLatitudeFieldNames.indexOf(n)||r||(r=e),-1===t.csvLongitudeFieldNames.indexOf(n)||i||(i=e)})),{longitudeFieldName:i,latitudeFieldName:r}},e.prototype._inferFields=function(e,t,i,r){var n=[],a=F.parseRows(e,i,t),o=[];e:for(;o.length<10;){var l=a.next(),u=l.value;if(l.done)break e;o.push(u)}for(var s=function(e){if(e===r.longitudeFieldName||e===r.latitudeFieldName)n.push({name:e,type:"esriFieldTypeDouble",alias:e});else{var t=o.map((function(t){return t[e]})),i=d._inferFieldType(t),a={name:e,type:null,alias:e};switch(i){case"integer":a.type="esriFieldTypeInteger";break;case"double":a.type="esriFieldTypeDouble";break;case"date":a.type="esriFieldTypeDate",a.length=36;break;default:a.type="esriFieldTypeString",a.length=255}n.push(a)}},d=this,f=0,c=i;f<c.length;f++){s(c[f])}return n},e.prototype._inferFieldType=function(e){var t=this;if(!e.length)return"string";var i=/[^+-.,0-9]/;return e.map((function(e){var r=!1;if(""!==e){if(i.test(e))r=!0;else{var n=O(e);if(!isNaN(n))return/[.,]/.test(e)?"double":!R(n)||n>214783647||n<-214783648?"double":"integer";if(-1===e.indexOf("E"))r=!0;else{if(n=Number(e),!isNaN(n))return"double";if(-1===e.indexOf(","))r=!0;else{if(e=e.replace(",","."),n=Number(e),!isNaN(n))return"double";r=!0}}}if(r){if(!/^[-]?\d*[.,]?\d*$/.test(e)){var a=new Date(e);return t._isValidDate(a,e)?"date":"string"}return"string"}return"string"}})).reduce((function(e,t){return void 0===e?t:e===t?t:"string"===e||"string"===t?"string":"double"===e||"double"===t?"double":void 0}))},e.prototype._isValidDate=function(e,t){if(!e||"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime()))return!1;var i=!0;if(o("chrome")&&/\d+\W*$/.test(t)){var r=t.match(/[a-zA-Z]{2,}/);if(r){for(var n=!1,a=0;!n&&a<=r.length;)n=!j.test(r[a]),a++;i=!n}}return i},e.prototype._createQueryEngine=function(e,t){for(var i,n=t.locationInfo,a=n.latitudeFieldName,o=n.longitudeFieldName,l=t.layerDefinition,u=l.objectIdField,s=l.fields,d=l.extent,v=l.timeInfo,I=[],N=[],b=new Set,x=new Set,T=[],E=0,D=s;E<D.length;E++){var j=D[E],R=j.name,k=j.type;"esriFieldTypeDate"===k?b.add(R):w.indexOf(k)>-1&&x.add(R),R!==u&&T.push(R)}var C=0,V=F.readRows(e);V.next();var L=F.parseRows(V,T,t.columnDelimiter);e:for(;;){var P=L.next(),M=P.value;if(P.done)break e;var G=this._parseCoordinateValue(M[a]),Q=this._parseCoordinateValue(M[o]);if(null!=Q&&null!=G&&!isNaN(G)&&!isNaN(Q)){for(var U in M[a]=G,M[o]=Q,M)if(U!==a&&U!==o)if(b.has(U)){var A=new Date(M[U]);M[U]=this._isValidDate(A,M[U])?A.getTime():null}else if(x.has(U)){var Y=O(M[U]);isNaN(Y)?M[U]=null:M[U]=Y}M[u]=C,C++,I.push(new S(Q,G)),N.push(M)}}if(!p.equals({wkid:4326},d.spatialReference))if(p.isWebMercator(d.spatialReference))for(var W=0,$=I;W<$.length;W++){var z=$[W];i=m.lngLatToXY(z.x,z.y,q),z.x=i[0],z.y=i[1]}else I=f.projectMany(c.jsonAdapter,I,r.SpatialReference.WGS84,d.spatialReference,null);for(var Z=new h.default({geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1}),B=new _.default({fields:t.layerDefinition.fields,geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1,timeInfo:v,objectIdField:u,spatialReference:d.spatialReference||{wkid:4326},cacheSpatialQueries:!0,featureStore:Z}),J=[],X=0;X<I.length;X++){var H=I[X],K=H.x,ee=H.y,te=N[X];te[u]=X+1,J.push(new y.default(new g.default([],[K,ee]),te,null,te[u]))}return Z.addMany(J),B},e.prototype._parseCoordinateValue=function(e){if(null==e||""===e)return null;var t=O(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t},e.prototype._checkProjection=function(e){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,v.checkProjectionSupport(p.WGS84,e)];case 1:return t.sent(),[3,3];case 2:throw t.sent(),new a("csv-layer","Projection not supported");case 3:return[2]}}))}))},e}();t.default=k}));