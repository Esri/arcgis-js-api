/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Error","../../../../core/has","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../support/source/DataLayerSource","../../../../rest/utils","../../../../rest/query/executeForCount","../../../../rest/query/executeForExtent","../../../../rest/query/executeForIds","../../../../rest/query/executeQueryJSON","../../../../rest/query/executeQueryPBF","../../../../rest/support/FeatureSet","../../../../rest/support/Query"],(function(e,t,r,o,n,u,s,i,a,c,p,l,y,d,f,h,m,S,F,b,_,x){"use strict";const D=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let O=function(r){function o(e){var t;return(t=r.call(this,e)||this).dynamicDataSource=null,t.fieldsIndex=null,t.gdbVersion=null,t.infoFor3D=null,t.pbfSupported=!1,t.queryAttachmentsSupported=!1,t.sourceSpatialReference=null,t.url=null,t}t._inheritsLoose(o,r);var c=o.prototype;return c.execute=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this.executeJSON(e,t);return this.featureSetFromJSON(e,r,t)}));function r(t,r){return e.apply(this,arguments)}return r}(),c.executeJSON=function(){var e=t._asyncToGenerator((function*(e,t){const r=this._normalizeQuery(e),o=null!=e.outStatistics?.[0],n=u("featurelayer-pbf-statistics"),s=!o||n;let i;if(this.pbfSupported&&s)try{i=yield b.executeRawQueryPBF(this.url,r,t)}catch(a){if("query:parsing-pbf"!==a.name)throw a;this.pbfSupported=!1}return this.pbfSupported&&s||(i=yield F.executeRawQueryJSON(this.url,r,t)),this._normalizeFields(i.fields),i}));function r(t,r){return e.apply(this,arguments)}return r}(),c.featureSetFromJSON=function(){var r=t._asyncToGenerator((function*(t,r,o){if(!this._queryIs3DObjectFormat(t)||s.isNone(this.infoFor3D)||!r.assetMaps||!r.features||!r.features.length)return _.fromJSON(r);const{meshFeatureSetFromJSON:n}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/support/meshFeatureSet"],t,r))),o);return n(t,this.infoFor3D,r)}));function o(e,t,o){return r.apply(this,arguments)}return o}(),c.executeForCount=function(e,t){return h.executeForCount(this.url,this._normalizeQuery(e),t)},c.executeForExtent=function(e,t){return m.executeForExtent(this.url,this._normalizeQuery(e),t)},c.executeForIds=function(e,t){return S.executeForIds(this.url,this._normalizeQuery(e),t)},c.executeRelationshipQuery=function(){var r=t._asyncToGenerator((function*(t,r){const[{default:o},{executeRelationshipQuery:n}]=yield i.whenOrAbort(Promise.all([new Promise(((t,r)=>e(["../../../../rest/support/RelationshipQuery"],(e=>t(D(e))),r))),new Promise(((t,r)=>e(["../../../../rest/query/executeRelationshipQuery"],t,r)))]),r);return t=o.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),n(this.url,t,r)}));function o(e,t){return r.apply(this,arguments)}return o}(),c.executeRelationshipQueryForCount=function(){var r=t._asyncToGenerator((function*(t,r){const[{default:o},{executeRelationshipQueryForCount:n}]=yield i.whenOrAbort(Promise.all([new Promise(((t,r)=>e(["../../../../rest/support/RelationshipQuery"],(e=>t(D(e))),r))),new Promise(((t,r)=>e(["../../../../rest/query/executeRelationshipQuery"],t,r)))]),r);return t=o.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),n(this.url,t,r)}));function o(e,t){return r.apply(this,arguments)}return o}(),c.executeAttachmentQuery=function(){var r=t._asyncToGenerator((function*(t,r){const{executeAttachmentQuery:o,fetchAttachments:n,processAttachmentQueryResult:u}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/operations/queryAttachments"],t,r))),r),s=f.parseUrl(this.url);return u(s,yield this.queryAttachmentsSupported?o(s,t,r):n(s,t,r))}));function o(e,t){return r.apply(this,arguments)}return o}(),c.executeTopFeaturesQuery=function(){var r=t._asyncToGenerator((function*(t,r){const{executeTopFeaturesQuery:o}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeTopFeaturesQuery"],t,r))),r);return o(this.parsedUrl,t,this.sourceSpatialReference,r)}));function o(e,t){return r.apply(this,arguments)}return o}(),c.executeForTopIds=function(){var r=t._asyncToGenerator((function*(t,r){const{executeForTopIds:o}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeForTopIds"],t,r))),r);return o(this.parsedUrl,t,r)}));function o(e,t){return r.apply(this,arguments)}return o}(),c.executeForTopExtents=function(){var r=t._asyncToGenerator((function*(t,r){const{executeForTopExtents:o}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeForTopExtents"],t,r))),r);return o(this.parsedUrl,t,r)}));function o(e,t){return r.apply(this,arguments)}return o}(),c.executeForTopCount=function(){var r=t._asyncToGenerator((function*(t,r){const{executeForTopCount:o}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeForTopCount"],t,r))),r);return o(this.parsedUrl,t,r)}));function o(e,t){return r.apply(this,arguments)}return o}(),c._normalizeQuery=function(e){let t=x.from(e);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?d.DataLayerSource.from(e.dynamicDataSource):this.dynamicDataSource),s.isSome(this.infoFor3D)&&this._queryIs3DObjectFormat(e)){t=t===e?t.clone():t,t.formatOf3DObjects=null;for(const e of this.infoFor3D.queryFormats){if("3D_glb"===e){t.formatOf3DObjects=e;break}"3D_gltf"!==e||t.formatOf3DObjects||(t.formatOf3DObjects=e)}if(!t.formatOf3DObjects)throw new n("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(s.isNone(t.outFields)||!t.outFields.includes("*")){t=t===e?t.clone():t,s.isNone(t.outFields)&&(t.outFields=[]);const{originX:r,originY:o,originZ:n,translationX:u,translationY:i,translationZ:a,scaleX:c,scaleY:p,scaleZ:l,rotationX:y,rotationY:d,rotationZ:f,rotationDeg:h}=this.infoFor3D.transformFieldRoles;t.outFields.push(r,o,n,u,i,a,c,p,l,y,d,f,h)}}return t},c._normalizeFields=function(e){if(s.isSome(this.fieldsIndex)&&s.isSome(e))for(const t of e){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}},c._queryIs3DObjectFormat=function(e){return s.isSome(this.infoFor3D)&&!0===e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics},t._createClass(o,[{key:"parsedUrl",get:function(){return a.urlToObject(this.url)}}]),o}(o);r.__decorate([c.property({type:d.DataLayerSource})],O.prototype,"dynamicDataSource",void 0),r.__decorate([c.property()],O.prototype,"fieldsIndex",void 0),r.__decorate([c.property()],O.prototype,"gdbVersion",void 0),r.__decorate([c.property()],O.prototype,"infoFor3D",void 0),r.__decorate([c.property({readOnly:!0})],O.prototype,"parsedUrl",null),r.__decorate([c.property()],O.prototype,"pbfSupported",void 0),r.__decorate([c.property()],O.prototype,"queryAttachmentsSupported",void 0),r.__decorate([c.property()],O.prototype,"sourceSpatialReference",void 0),r.__decorate([c.property({type:String})],O.prototype,"url",void 0),O=r.__decorate([y.subclass("esri.tasks.QueryTask")],O);return O}));
