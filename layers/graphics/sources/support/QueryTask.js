/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/has","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/arrayUtils","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../support/source/DataLayerSource","../../../../rest/query/executeQueryJSON","../../../../rest/query/executeQueryPBF","../../../../rest/support/FeatureSet","../../../../rest/support/Query","../../../../rest/query/executeAttachmentQuery","../../../../rest/query/executeForCount","../../../../rest/query/executeForExtent","../../../../rest/query/executeForIds","../../../../rest/query/executeRelationshipQuery","../../../../rest/query/executeTopFeaturesQuery","../../../../rest/query/executeForTopIds","../../../../rest/query/executeForTopExtents","../../../../rest/query/executeForTopCount","../../../../rest/support/RelationshipQuery","../../../../tasks/Task"],(function(e,t,r,o,s,n,i,u,a,c,p,l,y,f,d,h,m,F,x,S,D,O,b,_,q,g,Q){"use strict";let T=function(r){function u(e){var t;return(t=r.call(this,e)||this).dynamicDataSource=null,t.fieldsIndex=null,t.format="json",t.gdbVersion=null,t.infoFor3D=null,t.sourceSpatialReference=null,t}t._inheritsLoose(u,r);var a=u.prototype;return a.execute=function(){var e=t._asyncToGenerator((function*(e,t){const r=yield this.executeJSON(e,t);return this.featureSetFromJSON(e,r,t)}));function r(t,r){return e.apply(this,arguments)}return r}(),a.executeJSON=function(){var e=t._asyncToGenerator((function*(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e),n=null!=e.outStatistics?.[0],i=s("featurelayer-pbf-statistics"),u=!n||i;let a;if("pbf"===this.format&&u)try{a=yield f.executeRawQueryPBF(this.url,o,r)}catch(c){if("query:parsing-pbf"!==c.name)throw c;this.format="json"}return"json"!==this.format&&u||(a=yield y.executeRawQueryJSON(this.url,o,r)),this._normalizeFields(a.fields),a}));function r(t,r){return e.apply(this,arguments)}return r}(),a.featureSetFromJSON=function(){var r=t._asyncToGenerator((function*(t,r,o){if(!this._queryIs3DObjectFormat(t)||n.isNone(this.infoFor3D)||!r.assetMaps||!r.features||!r.features.length)return d.fromJSON(r);const{meshFeatureSetFromJSON:s}=yield i.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/support/meshFeatureSet"],t,r))),o);return s(t,this.infoFor3D,r)}));function o(e,t,o){return r.apply(this,arguments)}return o}(),a.executeForCount=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return F.executeForCount(this.url,o,r)},a.executeForExtent=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return x.executeForExtent(this.url,o,r)},a.executeForIds=function(e,t){const r={...this.requestOptions,...t},o=this._normalizeQuery(e);return S.executeForIds(this.url,o,r)},a.executeRelationshipQuery=function(e,t){e=g.from(e);const r={...this.requestOptions,...t};return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),D.executeRelationshipQuery(this.url,e,r)},a.executeRelationshipQueryForCount=function(e,t){e=g.from(e);const r={...this.requestOptions,...t};return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),D.executeRelationshipQueryForCount(this.url,e,r)},a.executeAttachmentQuery=function(e,t){const r={...this.requestOptions,...t};return m.executeAttachmentQuery(this.url,e,r)},a.executeTopFeaturesQuery=function(e,t){const r={...this.requestOptions,...t};return O.executeTopFeaturesQuery(this.parsedUrl,e,this.sourceSpatialReference,r)},a.executeForTopIds=function(e,t){const r={...this.requestOptions,...t};return b.executeForTopIds(this.parsedUrl,e,r)},a.executeForTopExtents=function(e,t){const r={...this.requestOptions,...t};return _.executeForTopExtents(this.parsedUrl,e,r)},a.executeForTopCount=function(e,t){const r={...this.requestOptions,...t};return q.executeForTopCount(this.parsedUrl,e,r)},a._normalizeQuery=function(e){let t=h.from(e);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?l.DataLayerSource.from(e.dynamicDataSource):this.dynamicDataSource),n.isSome(this.infoFor3D)&&this._queryIs3DObjectFormat(e)){t=t===e?t.clone():t,t.formatOf3DObjects=null;for(const e of this.infoFor3D.queryFormats){if("3D_glb"===e){t.formatOf3DObjects=e;break}"3D_gltf"!==e||t.formatOf3DObjects||(t.formatOf3DObjects=e)}if(!t.formatOf3DObjects)throw new o("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(n.isNone(t.outFields)||!t.outFields.includes("*")){t=t===e?t.clone():t,n.isNone(t.outFields)&&(t.outFields=[]);const{originX:r,originY:o,originZ:s,translationX:i,translationY:u,translationZ:a,scaleX:c,scaleY:p,scaleZ:l,rotationX:y,rotationY:f,rotationZ:d,rotationDeg:h}=this.infoFor3D.transformFieldRoles;t.outFields.push(r,o,s,i,u,a,c,p,l,y,f,d,h)}}return t},a._normalizeFields=function(e){if(n.isSome(this.fieldsIndex)&&n.isSome(e))for(const t of e){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}},a._queryIs3DObjectFormat=function(e){return n.isSome(this.infoFor3D)&&e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics},u}(Q);r.__decorate([u.property({type:l.DataLayerSource})],T.prototype,"dynamicDataSource",void 0),r.__decorate([u.property()],T.prototype,"fieldsIndex",void 0),r.__decorate([u.property()],T.prototype,"format",void 0),r.__decorate([u.property()],T.prototype,"gdbVersion",void 0),r.__decorate([u.property()],T.prototype,"infoFor3D",void 0),r.__decorate([u.property()],T.prototype,"sourceSpatialReference",void 0),T=r.__decorate([p.subclass("esri.tasks.QueryTask")],T);return T}));
