/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/has","../../../core/Loadable","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/workers/workers","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","./support/clientSideDefaults","../../../rest/support/FeatureSet","../../../geometry/Extent","../../../geometry/Polygon","../../../geometry/support/typeUtils"],(function(e,t,r,o,n,s,i,u,a,c,l,d,p,h,y,f,S,_,m,g){"use strict";const O=u.getLogger("esri.layers.graphics.sources.GeoJSONSource");e.GeoJSONSource=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).type="geojson",r.refresh=c.debounce(function(){var e=t._asyncToGenerator((function*(e){yield r.load();const{extent:t,timeExtent:o}=yield r._connection.invoke("refresh",e);return r.sourceJSON.extent=t,o&&(r.sourceJSON.timeInfo.timeExtent=[o.start,o.end]),{dataChanged:!0,updates:{extent:r.sourceJSON.extent,timeInfo:r.sourceJSON.timeInfo}}}));return function(t){return e.apply(this,arguments)}}()),r}t._inheritsLoose(r,e);var o=r.prototype;return o.load=function(e){const t=a.isSome(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)},o.destroy=function(){var e;null==(e=this._connection)||e.close(),this._connection=null},o.applyEdits=function(e){return this.load().then((()=>this._applyEdits(e)))},o.openPorts=function(){return this.load().then((()=>this._connection.openPorts()))},o.queryFeatures=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryFeatures",e?e.toJSON():null,t))).then((e=>S.fromJSON(e)))},o.queryFeaturesJSON=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryFeatures",e?e.toJSON():null,t)))},o.queryFeatureCount=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)))},o.queryObjectIds=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,t)))},o.queryExtent=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryExtent",e?e.toJSON():null,t))).then((e=>({count:e.count,extent:_.fromJSON(e.extent)})))},o.querySnapping=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("querySnapping",e,t)))},o._applyEdits=function(e){if(!this._connection)throw new n("geojson-layer-source:edit-failure","Memory source not loaded");const t=this.layer.objectIdField,r=[],o=[],s=[];if(e.addFeatures)for(const n of e.addFeatures)r.push(this._serializeFeature(n));if(e.deleteFeatures)for(const n of e.deleteFeatures)"objectId"in n&&null!=n.objectId?o.push(n.objectId):"attributes"in n&&null!=n.attributes[t]&&o.push(n.attributes[t]);if(e.updateFeatures)for(const n of e.updateFeatures)s.push(this._serializeFeature(n));return this._connection.invoke("applyEdits",{adds:r,updates:s,deletes:o}).then((({extent:e,timeExtent:t,featureEditResults:r})=>(this.sourceJSON.extent=e,t&&(this.sourceJSON.timeInfo.timeExtent=[t.start,t.end]),this._createEditsResult(r))))},o._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}},o._createFeatureEditResult=function(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new n("geojson-layer-source:edit-failure",t.description,{code:t.code}):null}},o._serializeFeature=function(e){const{attributes:t}=e,r=this._geometryForSerialization(e);return r?{geometry:r.toJSON(),attributes:t}:{attributes:t}},o._geometryForSerialization=function(e){const{geometry:t}=e;return a.isNone(t)?null:"mesh"===t.type||"extent"===t.type?m.fromExtent(t.extent):t},o._startWorker=function(){var e=t._asyncToGenerator((function*(e){this._connection=yield l.open("GeoJSONSourceWorker",{strategy:s("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:t,spatialReference:r,hasZ:o,geometryType:n,objectIdField:i,url:u,timeInfo:a,customParameters:c}=this.layer,d="defaults"===this.layer.originOf("spatialReference"),p={url:u,customParameters:c,fields:t&&t.map((e=>e.toJSON())),geometryType:g.featureGeometryTypeKebabDictionary.toJSON(n),hasZ:o,objectIdField:i,timeInfo:a?a.toJSON():null,spatialReference:d?null:r&&r.toJSON()},h=yield this._connection.invoke("load",p,{signal:e});for(const s of h.warnings)O.warn(s.message,{layer:this.layer,warning:s});h.featureErrors.length&&O.warn(`Encountered ${h.featureErrors.length} validation errors while loading features`,h.featureErrors),this.sourceJSON=h.layerDefinition,this.capabilities=f.createCapabilities(this.sourceJSON.hasZ,!0)}));function r(t){return e.apply(this,arguments)}return r}(),r}(i),r.__decorate([d.property()],e.GeoJSONSource.prototype,"capabilities",void 0),r.__decorate([d.property()],e.GeoJSONSource.prototype,"type",void 0),r.__decorate([d.property({constructOnly:!0})],e.GeoJSONSource.prototype,"layer",void 0),r.__decorate([d.property()],e.GeoJSONSource.prototype,"sourceJSON",void 0),e.GeoJSONSource=r.__decorate([y.subclass("esri.layers.graphics.sources.GeoJSONSource")],e.GeoJSONSource);const N=e.GeoJSONSource;e.default=N,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
