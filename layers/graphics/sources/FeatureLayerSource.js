// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../request","../../../core/Accessor","../../../core/Error","../../../core/Loadable","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators","../../../tasks/QueryTask","../../../tasks/operations/queryAttachments"],function(e,t,r,a,n,u,o,s,i,c,l,d,p,h,y,f,m){Object.defineProperty(t,"__esModule",{value:!0});var F=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="feature-layer",t}return r(t,e),t.prototype.load=function(e){var t=d.isSome(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),this.when()},Object.defineProperty(t.prototype,"queryTask",{get:function(){var e=this.layer,t=e.parsedUrl,r=e.dynamicDataSource,a=e.gdbVersion;return new f({url:null!=r?t.path+"?"+h.objectToQuery(t.query):t.path,gdbVersion:a})},enumerable:!0,configurable:!0}),t.prototype.addAttachment=function(e,t){var r=this;return this.load().then(function(){var a=e.attributes[r.layer.objectIdField],u=r.layer.parsedUrl.path+"/"+a+"/addAttachment",o=n({f:"json"},r.layer.parsedUrl.query),i=r._getFormDataForAttachment(t,o);return s(u,{body:i}).then(function(e){return r._createFeatureEditResult(e.data.addAttachmentResult)}).catch(function(e){return p.reject(r._createAttachmentErrorResult(a,e))})})},t.prototype.updateAttachment=function(e,t,r){var a=this;return this.load().then(function(){var u=e.attributes[a.layer.objectIdField],o=a.layer.parsedUrl.path+"/"+u+"/updateAttachment",i=n({f:"json"},a.layer.parsedUrl.query,{attachmentId:t}),c=a._getFormDataForAttachment(r,i);return s(o,{body:c}).then(function(e){return a._createFeatureEditResult(e.data.updateAttachmentResult)}).catch(function(e){return p.reject(a._createAttachmentErrorResult(u,e))})})},t.prototype.applyEdits=function(e){var t=this;return this.load().then(function(){var r=e.addFeatures.map(t._serializeFeature,t),a=e.updateFeatures.map(t._serializeFeature,t),n=t._getFeatureIds(e.deleteFeatures),u={f:"json",adds:r.length?JSON.stringify(r):null,updates:a.length?JSON.stringify(a):null,deletes:n.length?n.join(","):null};return s(t.layer.parsedUrl.path+"/applyEdits",{query:u,method:"post",responseType:"json"})}).then(function(e){return t._createEditsResult(e)})},t.prototype.deleteAttachments=function(e,t){var r=this;return this.load().then(function(){var a=e.attributes[r.layer.objectIdField],u=r.layer.parsedUrl.path+"/"+a+"/deleteAttachments";return s(u,{query:n({f:"json"},r.layer.parsedUrl.query,{attachmentIds:t.join(",")}),method:"post",responseType:"json"}).then(function(e){return e.data.deleteAttachmentResults.map(r._createFeatureEditResult)}).catch(function(e){return p.reject(r._createAttachmentErrorResult(a,e))})})},t.prototype.queryAttachments=function(e,t){var r=this;void 0===t&&(t={});var a=this.layer.parsedUrl,u=a.path;return this.load().then(function(){var o=n({},t,{query:n({},a.query,{f:"json"}),responseType:"json"});if(!r.layer.get("capabilities.operations.supportsQueryAttachments")){for(var i=e.objectIds,c=[],l=0,d=i;l<d.length;l++){var h=d[l],y=u+"/"+h+"/attachments";c.push(s(y,o))}return p.all(c).then(function(e){return i.map(function(t,r){return{parentObjectId:t,attachmentInfos:e[r].data.attachmentInfos}})}).then(function(e){return m.processAttachmentQueryResult(e,u)})}return r.queryTask.executeAttachmentQuery(e,o)})},t.prototype.queryFeatures=function(e,t){var r=this;return this.load().then(function(){return r.queryTask.execute(e,t)})},t.prototype.queryFeaturesJSON=function(e,t){var r=this;return this.load().then(function(){return r.queryTask.executeJSON(e,t)})},t.prototype.queryObjectIds=function(e,t){var r=this;return this.load().then(function(){return r.queryTask.executeForIds(e,t)})},t.prototype.queryFeatureCount=function(e,t){var r=this;return this.load().then(function(){return r.queryTask.executeForCount(e,t)})},t.prototype.queryExtent=function(e,t){var r=this;return this.load().then(function(){return r.queryTask.executeForExtent(e,t)})},t.prototype.queryRelatedFeatures=function(e,t){var r=this;return this.load().then(function(){return r.queryTask.executeRelationshipQuery(e,t)})},t.prototype._fetchService=function(e){return o(this,void 0,void 0,function(){var t,r;return u(this,function(a){switch(a.label){case 0:return t=this.layer.resourceInfo,t?(this.layerDefinition=t,[2]):[4,s(this.layer.parsedUrl.path,{query:n({f:"json"},this.layer.parsedUrl.query),responseType:"json",signal:e})];case 1:return r=a.sent().data,this.layerDefinition=r,[2]}})})},t.prototype._serializeFeature=function(e){var t=e.geometry,r=e.attributes;return d.isNone(t)?{attributes:r}:"mesh"===t.type||"extent"===t.type?null:{geometry:t.toJSON(),attributes:r}},t.prototype._getFeatureIds=function(e){var t=e[0];return t?"objectId"in t?this._getIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]},t.prototype._getIdsFromFeatures=function(e){var t=this.layer.objectIdField;return e.map(function(e){return e.attributes&&e.attributes[t]})},t.prototype._getIdsFromFeatureIdentifier=function(e){return e.map(function(e){return e.objectId})},t.prototype._createEditsResult=function(e){var t=e.data;return{addFeatureResults:t.addResults?t.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:t.updateResults?t.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:t.deleteResults?t.deleteResults.map(this._createFeatureEditResult,this):[]}},t.prototype._createFeatureEditResult=function(e){var t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new c("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},t.prototype._createAttachmentErrorResult=function(e,t){var r=t.details.messages&&t.details.messages[0]||t.message,a=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new c("feature-layer-source:attachment-failure",r,{code:a})}},t.prototype._getFormDataForAttachment=function(e,t){var r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(var a in t){var n=t[a];null!=n&&(r.set?r.set(a,n):r.append(a,n))}return r},a([y.property()],t.prototype,"type",void 0),a([y.property({constructOnly:!0})],t.prototype,"layer",void 0),a([y.property({readOnly:!0,dependsOn:["layer.parsedUrl","layer.gdbVersion","layer.dynamicDataSource"]})],t.prototype,"queryTask",null),t=a([y.subclass("esri.layers.graphics.sources.FeatureLayerSource")],t)}(y.declared(i,l));t.default=F});