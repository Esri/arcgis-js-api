/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../kernel","../../../request","../../../TimeExtent","../../../core/Error","../../../core/has","../../../core/jsonMap","../../../core/Loadable","../../../core/maybe","../../../core/object","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/support/jsonUtils","../assetEditingSupport","./support/clientSideDefaults","./support/QueryTask","../../support/arcgisLayerUrl","../../../rest/query/operations/editsZScale","../../../geometry/SpatialReference"],(function(e,t,r,s,a,n,o,i,u,l,d,c,p,y,h,f,m,g,_,R,F,b,q,I,S,T,E){"use strict";const O=new l.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"});function v(e){return A.apply(this,arguments)}function A(){return(A=e._asyncToGenerator((function*(e){if("string"==typeof e){const t=h.dataComponents(e);return t||{data:e}}return new Promise(((t,r)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(h.dataComponents(s.result)),s.onerror=e=>r(e)}))}))).apply(this,arguments)}const G=new Set(["Feature Layer","Table"]),N=new l.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let w=function(t){function r(){var r;return(r=t.apply(this,arguments)||this).type="feature-layer",r.refresh=y.debounce(e._asyncToGenerator((function*(){yield r.load();const e=r.sourceJSON.editingInfo?.lastEditDate;if(null==e)return{dataChanged:!0,updates:{}};try{yield r._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const t=e!==r.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:t,updates:t?{editingInfo:r.sourceJSON.editingInfo,extent:r.sourceJSON.extent}:null}}))),r}e._inheritsLoose(r,t);var l=r.prototype;return l.load=function(e){const t=c.isSome(e)?e.signal:null,r=this.layer.sourceJSON;return this.addResolvingPromise(this._fetchService(r,t)),Promise.resolve(this)},l.addAttachment=function(){var t=e._asyncToGenerator((function*(e,t){yield this.load();const r=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+r+"/addAttachment",a=this._getLayerRequestOptions(),o=this._getFormDataForAttachment(t,a.query);try{const e=yield n(s,{body:o});return this._createFeatureEditResult(e.data.addAttachmentResult)}catch(i){throw this._createAttachmentErrorResult(r,i)}}));function r(e,r){return t.apply(this,arguments)}return r}(),l.updateAttachment=function(){var t=e._asyncToGenerator((function*(e,t,r){yield this.load();const s=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+"/"+s+"/updateAttachment",o=this._getLayerRequestOptions({query:{attachmentId:t}}),i=this._getFormDataForAttachment(r,o.query);try{const e=yield n(a,{body:i});return this._createFeatureEditResult(e.data.updateAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(s,u)}}));function r(e,r,s){return t.apply(this,arguments)}return r}(),l.applyEdits=function(){var t=e._asyncToGenerator((function*(e,t){yield this.load();const r=this.layer.infoFor3D,s=c.isSome(r),o=s||(t?.globalIdUsed??!1),i=e.addFeatures?.map((e=>this._serializeFeature(e,r))).filter(c.isSome)??[],u=e.updateFeatures?.map((e=>this._serializeFeature(e,r))).filter(c.isSome)??[],l=this._getFeatureIds(e.deleteFeatures,o);T.unapplyEditsZUnitScaling(i,u,this.layer.spatialReference);const d=[],p=[],y=[...e.deleteAttachments??[]];for(const a of e.addAttachments??[])d.push(yield this._serializeAttachment(a));for(const a of e.updateAttachments??[])p.push(yield this._serializeAttachment(a));const h=d.length||p.length||y.length?{adds:d,updates:p,deletes:y}:null;let f,m=null;if(s){m=new Map;const t=[];for(const s of e.addAssets??[])t.push(this._serializeAssetMapEditAndUploadAssets(s,m));const r=yield Promise.all(t);f=r.length?{adds:r,updates:[],deletes:[]}:void 0}const g={gdbVersion:t?.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:t?.rollbackOnFailureEnabled,useGlobalIds:o,returnEditMoment:t?.returnEditMoment,usePreviousEditMoment:t?.usePreviousEditMoment,sessionId:t?.sessionId};t?.returnServiceEditsOption?(g.edits=JSON.stringify([{id:this.layer.layerId,adds:i,updates:u,deletes:l,attachments:h,assetMaps:c.unwrap(f)}]),g.returnServiceEditsOption=O.toJSON(t?.returnServiceEditsOption),g.returnServiceEditsInSourceSR=t?.returnServiceEditsInSourceSR):(g.adds=i.length?JSON.stringify(i):null,g.updates=u.length?JSON.stringify(u):null,g.deletes=l.length?o?JSON.stringify(l):l.join(","):null,g.attachments=h&&JSON.stringify(h),g.assetMaps=c.isSome(f)?JSON.stringify(f):void 0);const _=this._getLayerRequestOptions({method:"post",query:g}),R=t?.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path,F=yield n(R+"/applyEdits",_);if(!this.layer.capabilities.operations?.supportsEditing&&this.layer.effectiveCapabilities?.operations?.supportsEditing){const e=a.id?.findCredential(this.layer.url);yield e?.refreshToken()}if(s&&null!=F.data&&null!=F.data.assetMaps){const e=F.data,t=this.layer.objectIdField,r=[];for(const n of e.addResults)n.success&&r.push(n.objectId);for(const n of e.updateResults)n.success&&r.push(n.objectId);const s=this._createRequestQueryOptions(),a=yield n(R+"/query",{...s,query:{f:"json",formatOf3DObjects:"3D_glb",where:`OBJECTID IN (${r.join(",")})`,outFields:`${t}`}});if(a&&a.data&&a.data.assetMaps&&c.isSome(m)){const e=a.data.assetMaps;for(const t of e){const e=m.get(t.parentGlobalId).geometry;c.isSome(e)&&"mesh"===e.type&&e.updateExternalSource({source:[{name:t.assetName,source:t.assetName}],extent:e.extent})}}}return this._createEditsResult(F)}));function r(e,r){return t.apply(this,arguments)}return r}(),l.deleteAttachments=function(){var t=e._asyncToGenerator((function*(e,t){yield this.load();const r=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+r+"/deleteAttachments";try{return(yield n(s,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(a){throw this._createAttachmentErrorResult(r,a)}}));function r(e,r){return t.apply(this,arguments)}return r}(),l.fetchRecomputedExtents=function(t={}){var r=this;const s=t.signal;return this.load({signal:s}).then(e._asyncToGenerator((function*(){const e=r._getLayerRequestOptions({...t,query:{returnUpdates:!0}}),{layerId:s,url:a}=r.layer,{data:i}=yield n(`${a}/${s}`,e),{id:u,extent:l,fullExtent:d,timeExtent:c}=i,p=l||d;return{id:u,fullExtent:p&&R.fromJSON(p),timeExtent:c&&o.fromJSON({start:c[0],end:c[1]})}})))},l.queryAttachments=function(){var t=e._asyncToGenerator((function*(e,t={}){yield this.load();const r=this._getLayerRequestOptions(t);return this.queryTask.executeAttachmentQuery(e,r)}));function r(e){return t.apply(this,arguments)}return r}(),l.queryFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.execute(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryFeaturesJSON=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeJSON(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryObjectIds=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForIds(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryFeatureCount=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForCount(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryExtent=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForExtent(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryRelatedFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryRelatedFeaturesCount=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryTopFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeTopFeaturesQuery(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryTopObjectIds=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForTopIds(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryTopExtents=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForTopExtents(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.queryTopCount=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForTopCount(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),l.fetchPublishingStatus=function(){var t=e._asyncToGenerator((function*(){if(!S.isHostedAgolService(this.layer.url))return"unavailable";const e=h.join(this.layer.url,"status"),t=yield n(e,{query:{f:"json"}});return N.fromJSON(t.data.status)}));function r(){return t.apply(this,arguments)}return r}(),l._createRequestQueryOptions=function(e){const t={...this.layer.customParameters,token:this.layer.apiKey,...e?.query};return this.layer.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t},l._fetchService=function(){var t=e._asyncToGenerator((function*(e,t){if(!e){const{data:r}=yield n(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:u("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:t}));e=r}this.sourceJSON=this._patchServiceJSON(e);const r=e.type;if(!G.has(r))throw new i("feature-layer-source:unsupported-type",`Source type "${r}" is not supported`)}));function r(e,r){return t.apply(this,arguments)}return r}(),l._patchServiceJSON=function(e){if("Table"!==e.type&&e.geometryType&&!e?.drawingInfo?.renderer&&!e.defaultSymbol){const t=q.createDrawingInfo(e.geometryType).renderer;p.setDeepValue("drawingInfo.renderer",t,e)}return"esriGeometryMultiPatch"===e.geometryType&&e.infoFor3D&&(e.geometryType="mesh"),e},l._serializeFeature=function(e,t){const{geometry:r,attributes:s}=e;if(c.isSome(t)&&c.isSome(e.geometry)&&"mesh"===e.geometry.type){const r={...s},a=e.geometry,n=a.origin,o=a.transform;if(r[t.transformFieldRoles.originX]=n.x,r[t.transformFieldRoles.originY]=n.y,r[t.transformFieldRoles.originZ]=n.z,c.isSome(o)){const e=o.translation,s=o.scale,a=o.rotation;r[t.transformFieldRoles.translationX]=e[0],r[t.transformFieldRoles.translationY]=-e[2],r[t.transformFieldRoles.translationZ]=e[1],r[t.transformFieldRoles.scaleX]=s[0],r[t.transformFieldRoles.scaleY]=s[1],r[t.transformFieldRoles.scaleZ]=s[2],r[t.transformFieldRoles.rotationX]=a[0],r[t.transformFieldRoles.rotationY]=a[2],r[t.transformFieldRoles.rotationZ]=a[1],r[t.transformFieldRoles.rotationDeg]=a[3]}return{geometry:null,attributes:r}}return c.isNone(r)?{attributes:s}:"mesh"===r.type||"extent"===r.type?null:{geometry:r.toJSON(),attributes:s}},l._serializeAttachment=function(){var t=e._asyncToGenerator((function*(e){const{feature:t,attachment:r}=e,{globalId:s,name:a,contentType:n,data:o,uploadId:i}=r,u={globalId:s,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(u.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),i)u.uploadId=i;else if(o){const e=yield v(o);e&&(u.contentType=e.mediaType,u.data=e.data),o instanceof File&&(u.name=o.name)}return a&&(u.name=a),n&&(u.contentType=n),u}));function r(e){return t.apply(this,arguments)}return r}(),l._serializeAssetMapEditAndUploadAssets=function(){var t=e._asyncToGenerator((function*(e,t){const r=this.layer.url;let s=null;try{const t=new Blob([e.data],{type:e.mimeType}),a=new FormData;a.append("f","json"),a.append("file",t,`${e.assetName}`);const o={body:a,method:"post",responseType:"json"},{data:u}=yield n(`${r}/uploads/upload`,o);if(!u.success)throw new i("feature-layer-source:upload-failure","Expected upload to be successfull.");s={assetType:e.assetType,assetUploadId:u.item.itemID}}catch(p){s=null}if(c.isNone(s)){const t=yield v(new Blob([e.data]));if(!t.isBase64)throw new i("feature-layer-source:uploadAssets-failure","Expected gltf data in base64 format after conversion.");s={assetType:e.assetType,assetData:t.data}}if(c.isNone(s))throw new i("feature-layer-source:uploadAssets-failure","Unable to prepare uploadAsset request options.");const a={method:"post",query:{f:"json",assets:JSON.stringify([s])},responseType:"json"},o=yield n(h.join(this.layer.parsedUrl.path,"uploadAssets"),a);if(1!==o.data.uploadResults.length||!o.data.uploadResults[0].success)throw new i("feature-layer-source:uploadAssets-failure","Bad response.");const u=o.data.uploadResults[0].assetHash,l=[];e.flags&b.AssetMapEditFlags.PROJECT_VERTICES&&l.push("PROJECT_VERTICES");const d={globalId:e.assetMapGlobalId,parentGlobalId:e.featureGlobalId,assetName:e.assetName,assetHash:u,flags:l};return t.set(e.featureGlobalId,e.feature),d}));function r(e,r){return t.apply(this,arguments)}return r}(),l._getFeatureIds=function(e,t){const r=e?.[0];return r?this._canUseGlobalIds(t,e)?this._getGlobalIdsFromFeatureIdentifier(e):"objectId"in r?this._getObjectIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]},l._getIdsFromFeatures=function(e){const t=this.layer.objectIdField;return e.map((e=>e.attributes&&e.attributes[t]))},l._canUseGlobalIds=function(e,t){return e&&"globalId"in t[0]},l._getObjectIdsFromFeatureIdentifier=function(e){return e.map((e=>e.objectId))},l._getGlobalIdsFromFeatureIdentifier=function(e){return e.map((e=>e.globalId))},l._createEditsResult=function(e){const t=e.data,{layerId:r}=this.layer,s=[];let a=null;if(Array.isArray(t))for(const i of t)s.push({id:i.id,editedFeatures:i.editedFeatures}),i.id===r&&(a={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment});else a=t;const n=a?.attachments,o={addFeatureResults:a?.addResults?.map(this._createFeatureEditResult,this)??[],updateFeatureResults:a?.updateResults?.map(this._createFeatureEditResult,this)??[],deleteFeatureResults:a?.deleteResults?.map(this._createFeatureEditResult,this)??[],addAttachmentResults:n&&n.addResults?n.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:n&&n.updateResults?n.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:n&&n.deleteResults?n.deleteResults.map(this._createFeatureEditResult,this):[]};if(a?.editMoment&&(o.editMoment=a.editMoment),s.length>0){o.editedFeatureResults=[];for(const e of s){const{editedFeatures:t}=e,r=t?.spatialReference?new E(t.spatialReference):null;o.editedFeatureResults.push({layerId:e.id,editedFeatures:{adds:t?.adds?.map((e=>this._createEditedFeature(e,r)))||[],updates:t?.updates?.map((e=>({original:this._createEditedFeature(e[0],r),current:this._createEditedFeature(e[1],r)})))||[],deletes:t?.deletes?.map((e=>this._createEditedFeature(e,r)))||[],spatialReference:r}})}}return o},l._createEditedFeature=function(e,t){return new s({attributes:e.attributes,geometry:F.fromJSON({...e.geometry,spatialReference:t})})},l._createFeatureEditResult=function(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new i("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},l._createAttachmentErrorResult=function(e,t){const r=t.details.messages&&t.details.messages[0]||t.message,s=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new i("feature-layer-source:attachment-failure",r,{code:s})}},l._getFormDataForAttachment=function(e,t){const r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(const s in t){const e=t[s];null!=e&&(r.set?r.set(s,e):r.append(s,e))}return r},l._getLayerRequestOptions=function(e={}){const{parsedUrl:t,gdbVersion:r,dynamicDataSource:s}=this.layer;return{...e,query:{gdbVersion:r,layer:s?JSON.stringify({source:s}):void 0,...t.query,f:"json",...this._createRequestQueryOptions(e)},responseType:"json"}},e._createClass(r,[{key:"queryTask",get:function(){const{capabilities:e,parsedUrl:t,dynamicDataSource:r,infoFor3D:s,gdbVersion:a,spatialReference:n,fieldsIndex:o}=this.layer,i=u("featurelayer-pbf")&&e?.query.supportsFormatPBF&&c.isNone(s),l=e?.operations?.supportsQueryAttachments??!1;return new I({url:t.path,pbfSupported:i,fieldsIndex:o,infoFor3D:s,dynamicDataSource:r,gdbVersion:a,sourceSpatialReference:n,queryAttachmentsSupported:l})}}]),r}(d);t.__decorate([f.property()],w.prototype,"type",void 0),t.__decorate([f.property({constructOnly:!0})],w.prototype,"layer",void 0),t.__decorate([f.property({readOnly:!0})],w.prototype,"queryTask",null),w=t.__decorate([_.subclass("esri.layers.graphics.sources.FeatureLayerSource")],w);return w}));
