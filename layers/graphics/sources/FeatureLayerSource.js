/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../request","../../../TimeExtent","../../../core/Error","../../../core/has","../../../core/jsonMap","../../../core/Loadable","../../../core/maybe","../../../core/object","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/support/jsonUtils","../assetEditingSupport","./support/clientSideDefaults","./support/QueryTask","../../support/arcgisLayerUrl","../../../rest/query/operations/editsZScale","../../../rest/query/operations/queryAttachments","../../../geometry/SpatialReference"],(function(e,t,r,s,a,n,o,i,u,l,d,c,p,y,h,f,m,g,R,_,F,b,I,q,S,T,O){"use strict";const E=new u.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"});function v(e){return A.apply(this,arguments)}function A(){return(A=e._asyncToGenerator((function*(e){if("string"==typeof e){const t=y.dataComponents(e);return t||{data:e}}return new Promise(((t,r)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(y.dataComponents(s.result)),s.onerror=e=>r(e)}))}))).apply(this,arguments)}const G=new Set(["Feature Layer","Table"]),j=new u.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let N=function(t){function r(){var r;return(r=t.apply(this,arguments)||this).type="feature-layer",r.refresh=p.debounce(e._asyncToGenerator((function*(){yield r.load();const e=r.sourceJSON.editingInfo?.lastEditDate;if(null==e)return{dataChanged:!0,updates:{}};try{yield r._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const t=e!==r.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:t,updates:t?{editingInfo:r.sourceJSON.editingInfo,extent:r.sourceJSON.extent}:null}}))),r}e._inheritsLoose(r,t);var u=r.prototype;return u.load=function(e){const t=d.isSome(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(this.layer.sourceJSON,t)),Promise.resolve(this)},u.addAttachment=function(){var t=e._asyncToGenerator((function*(e,t){yield this.load();const r=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+r+"/addAttachment",n=this._getLayerRequestOptions(),o=this._getFormDataForAttachment(t,n.query);try{const e=yield a(s,{body:o});return this._createFeatureEditResult(e.data.addAttachmentResult)}catch(i){throw this._createAttachmentErrorResult(r,i)}}));function r(e,r){return t.apply(this,arguments)}return r}(),u.updateAttachment=function(){var t=e._asyncToGenerator((function*(e,t,r){yield this.load();const s=e.attributes[this.layer.objectIdField],n=this.layer.parsedUrl.path+"/"+s+"/updateAttachment",o=this._getLayerRequestOptions({query:{attachmentId:t}}),i=this._getFormDataForAttachment(r,o.query);try{const e=yield a(n,{body:i});return this._createFeatureEditResult(e.data.updateAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(s,u)}}));function r(e,r,s){return t.apply(this,arguments)}return r}(),u.applyEdits=function(){var t=e._asyncToGenerator((function*(e,t){yield this.load();const r=this.layer.infoFor3D,s=d.isSome(r),n=s||t?.globalIdUsed,o=e.addFeatures.map((e=>this._serializeFeature(e,r))),i=e.updateFeatures.map((e=>this._serializeFeature(e,r))),u=this._getFeatureIds(e.deleteFeatures,n);S.unapplyEditsZUnitScaling(o,i,this.layer.spatialReference);const l=[],c=[],p=[...e.deleteAttachments];for(const a of e.addAttachments)l.push(yield this._serializeAttachment(a));for(const a of e.updateAttachments)c.push(yield this._serializeAttachment(a));const y=l.length||c.length||p.length?{adds:l,updates:c,deletes:p}:null;let h,f=null;if(s){f=new Map;const t=[];for(const s of e.addAssets)t.push(this._serializeAssetMapEditAndUploadAssets(s,f));const r=yield Promise.all(t);h=r.length?{adds:r,updates:[],deletes:[]}:void 0}const m={gdbVersion:t?.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:t?.rollbackOnFailureEnabled,useGlobalIds:n,returnEditMoment:t?.returnEditMoment,usePreviousEditMoment:t?.usePreviousEditMoment,sessionId:t?.sessionId};t?.returnServiceEditsOption?(m.edits=JSON.stringify([{id:this.layer.layerId,adds:o,updates:i,deletes:u,attachments:y,assetMaps:d.unwrap(h)}]),m.returnServiceEditsOption=E.toJSON(t?.returnServiceEditsOption),m.returnServiceEditsInSourceSR=t?.returnServiceEditsInSourceSR):(m.adds=o.length?JSON.stringify(o):null,m.updates=i.length?JSON.stringify(i):null,m.deletes=u.length?n?JSON.stringify(u):u.join(","):null,m.attachments=y&&JSON.stringify(y),m.assetMaps=d.isSome(h)?JSON.stringify(h):void 0);const g=this._getLayerRequestOptions({method:"post",query:m}),R=t?.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path,_=yield a(R+"/applyEdits",g);if(s&&null!=_.data&&null!=_.data.assetMaps){const e=_.data,t=this.layer.objectIdField,r=[];for(const a of e.addResults)a.success&&r.push(a.objectId);for(const a of e.updateResults)a.success&&r.push(a.objectId);const s=this._createRequestQueryOptions(),n=yield a(R+"/query",{...s,query:{f:"json",formatOf3DObjects:"3D_glb",where:`OBJECTID IN (${r.join(",")})`,outFields:`${t}`}});if(n&&n.data&&n.data.assetMaps&&d.isSome(f)){const e=n.data.assetMaps;for(const t of e){const e=f.get(t.parentGlobalId).geometry;d.isSome(e)&&"mesh"===e.type&&e.updateExternalSource({source:[{name:t.assetName,source:t.assetName}],extent:e.extent})}}}return this._createEditsResult(_)}));function r(e,r){return t.apply(this,arguments)}return r}(),u.deleteAttachments=function(){var t=e._asyncToGenerator((function*(e,t){yield this.load();const r=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+r+"/deleteAttachments";try{return(yield a(s,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(n){throw this._createAttachmentErrorResult(r,n)}}));function r(e,r){return t.apply(this,arguments)}return r}(),u.fetchRecomputedExtents=function(t={}){var r=this;const s=t.signal;return this.load({signal:s}).then(e._asyncToGenerator((function*(){const e=r._getLayerRequestOptions({...t,query:{returnUpdates:!0}}),{layerId:s,url:o}=r.layer,{data:i}=yield a(`${o}/${s}`,e),{id:u,extent:l,fullExtent:d,timeExtent:c}=i,p=l||d;return{id:u,fullExtent:p&&R.fromJSON(p),timeExtent:c&&n.fromJSON({start:c[0],end:c[1]})}})))},u.queryAttachments=function(){var t=e._asyncToGenerator((function*(e,t={}){const{parsedUrl:r}=this.layer,s=r.path;yield this.load();const n=this._getLayerRequestOptions(t);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const{objectIds:t}=e,r=[];for(const e of t){const t=s+"/"+e+"/attachments";r.push(a(t,n))}return Promise.all(r).then((e=>t.map(((t,r)=>({parentObjectId:t,attachmentInfos:e[r].data.attachmentInfos}))))).then((e=>T.processAttachmentQueryResult(e,s)))}return this.queryTask.executeAttachmentQuery(e,n)}));function r(e){return t.apply(this,arguments)}return r}(),u.queryFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.execute(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryFeaturesJSON=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeJSON(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryObjectIds=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForIds(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryFeatureCount=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForCount(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryExtent=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForExtent(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryRelatedFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryRelatedFeaturesCount=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryTopFeatures=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeTopFeaturesQuery(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryTopObjectIds=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForTopIds(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryTopExtents=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForTopExtents(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.queryTopCount=function(){var t=e._asyncToGenerator((function*(e,t){return yield this.load(),this.queryTask.executeForTopCount(e,{...t,query:this._createRequestQueryOptions(t)})}));function r(e,r){return t.apply(this,arguments)}return r}(),u.fetchPublishingStatus=function(){var t=e._asyncToGenerator((function*(){if(!q.isHostedAgolService(this.layer.url))return"unavailable";const e=y.join(this.layer.url,"status"),t=yield a(e,{query:{f:"json"}});return j.fromJSON(t.data.status)}));function r(){return t.apply(this,arguments)}return r}(),u._createRequestQueryOptions=function(e){const t={...this.layer.customParameters,token:this.layer.apiKey,...e?.query};return this.layer.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t},u._fetchService=function(){var t=e._asyncToGenerator((function*(e,t){if(!e){const{data:r}=yield a(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:i("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:t}));e=r}this.sourceJSON=this._patchServiceJSON(e);const r=e.type;if(!G.has(r))throw new o("feature-layer-source:unsupported-type",`Source type "${r}" is not supported`)}));function r(e,r){return t.apply(this,arguments)}return r}(),u._patchServiceJSON=function(e){if("Table"!==e.type&&e.geometryType&&!e?.drawingInfo?.renderer&&!e.defaultSymbol){const t=b.createDrawingInfo(e.geometryType).renderer;c.setDeepValue("drawingInfo.renderer",t,e)}return"esriGeometryMultiPatch"===e.geometryType&&e.infoFor3D&&(e.geometryType="mesh"),e},u._serializeFeature=function(e,t){const{geometry:r,attributes:s}=e;if(d.isSome(t)&&d.isSome(e.geometry)&&"mesh"===e.geometry.type){const r={...s},a=e.geometry,n=a.origin,o=a.transform;if(r[t.transformFieldRoles.originX]=n.x,r[t.transformFieldRoles.originY]=n.y,r[t.transformFieldRoles.originZ]=n.z,d.isSome(o)){const e=o.translation,s=o.scale,a=o.rotation;r[t.transformFieldRoles.translationX]=e[0],r[t.transformFieldRoles.translationY]=e[1],r[t.transformFieldRoles.translationZ]=e[2],r[t.transformFieldRoles.scaleX]=s[0],r[t.transformFieldRoles.scaleY]=s[1],r[t.transformFieldRoles.scaleZ]=s[2],r[t.transformFieldRoles.rotationX]=a[0],r[t.transformFieldRoles.rotationY]=a[1],r[t.transformFieldRoles.rotationZ]=a[2],r[t.transformFieldRoles.rotationDeg]=a[3]}return{geometry:null,attributes:r}}return d.isNone(r)?{attributes:s}:"mesh"===r.type||"extent"===r.type?null:{geometry:r.toJSON(),attributes:s}},u._serializeAttachment=function(){var t=e._asyncToGenerator((function*(e){const{feature:t,attachment:r}=e,{globalId:s,name:a,contentType:n,data:o,uploadId:i}=r,u={globalId:s,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(u.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),i)u.uploadId=i;else if(o){const e=yield v(o);u.contentType=e.mediaType,u.data=e.data,o instanceof File&&(u.name=o.name)}return a&&(u.name=a),n&&(u.contentType=n),u}));function r(e){return t.apply(this,arguments)}return r}(),u._serializeAssetMapEditAndUploadAssets=function(){var t=e._asyncToGenerator((function*(e,t){const r=this.layer.url;let s=null;try{const t=new Blob([e.data],{type:e.mimeType}),n=new FormData;n.append("f","json"),n.append("file",t,`${e.assetName}`);const i={body:n,method:"post",responseType:"json"},{data:u}=yield a(`${r}/uploads/upload`,i);if(!u.success)throw new o("feature-layer-source:upload-failure","Expected upload to be successfull.");s={assetType:e.assetType,assetUploadId:u.item.itemID}}catch(p){s=null}if(d.isNone(s)){const t=yield v(new Blob([e.data]));if(!t.isBase64)throw new o("feature-layer-source:uploadAssets-failure","Expected gltf data in base64 format after conversion.");s={assetType:e.assetType,assetData:t.data}}if(d.isNone(s))throw new o("feature-layer-source:uploadAssets-failure","Unable to prepare uploadAsset request options.");const n={method:"post",query:{f:"json",assets:JSON.stringify([s])},responseType:"json"},i=yield a(y.join(this.layer.parsedUrl.path,"uploadAssets"),n);if(1!==i.data.uploadResults.length||!i.data.uploadResults[0].success)throw new o("feature-layer-source:uploadAssets-failure","Bad response.");const u=i.data.uploadResults[0].assetHash,l=[];e.flags&F.AssetMapEditFlags.PROJECT_VERTICES&&l.push("PROJECT_VERTICES");const c={globalId:e.assetMapGlobalId,parentGlobalId:e.featureGlobalId,assetName:e.assetName,assetHash:u,flags:l};return t.set(e.featureGlobalId,e.feature),c}));function r(e,r){return t.apply(this,arguments)}return r}(),u._getFeatureIds=function(e,t){const r=e[0];return r?this._canUseGlobalIds(t,e)?this._getGlobalIdsFromFeatureIdentifier(e):"objectId"in r?this._getObjectIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]},u._getIdsFromFeatures=function(e){const t=this.layer.objectIdField;return e.map((e=>e.attributes&&e.attributes[t]))},u._canUseGlobalIds=function(e,t){return e&&"globalId"in t[0]},u._getObjectIdsFromFeatureIdentifier=function(e){return e.map((e=>e.objectId))},u._getGlobalIdsFromFeatureIdentifier=function(e){return e.map((e=>e.globalId))},u._createEditsResult=function(e){const t=e.data,{layerId:r}=this.layer,s=[];let a=null;if(Array.isArray(t))for(const i of t)s.push({id:i.id,editedFeatures:i.editedFeatures}),i.id===r&&(a={addResults:i.addResults,updateResults:i.updateResults,deleteResults:i.deleteResults,attachments:i.attachments,editMoment:i.editMoment});else a=t;const n=a?.attachments,o={addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:n&&n.addResults?n.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:n&&n.updateResults?n.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:n&&n.deleteResults?n.deleteResults.map(this._createFeatureEditResult,this):[]};if(a.editMoment&&(o.editMoment=a.editMoment),s.length>0){o.editedFeatureResults=[];for(const e of s){const{adds:t,updates:r,deletes:s,spatialReference:a}=e.editedFeatures,n=a?new O(a):null;o.editedFeatureResults.push({layerId:e.id,editedFeatures:{adds:t?.map((e=>this._createEditedFeature(e,n)))||[],updates:r?.map((e=>({original:this._createEditedFeature(e[0],n),current:this._createEditedFeature(e[1],n)})))||[],deletes:s?.map((e=>this._createEditedFeature(e,n)))||[],spatialReference:n}})}}return o},u._createEditedFeature=function(e,t){return new s({attributes:e.attributes,geometry:_.fromJSON({...e.geometry,spatialReference:t})})},u._createFeatureEditResult=function(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new o("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},u._createAttachmentErrorResult=function(e,t){const r=t.details.messages&&t.details.messages[0]||t.message,s=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new o("feature-layer-source:attachment-failure",r,{code:s})}},u._getFormDataForAttachment=function(e,t){const r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(const s in t){const e=t[s];null!=e&&(r.set?r.set(s,e):r.append(s,e))}return r},u._getLayerRequestOptions=function(e={}){const{parsedUrl:t,gdbVersion:r,dynamicDataSource:s}=this.layer;return{...e,query:{gdbVersion:r,layer:s?JSON.stringify({source:s}):void 0,...t.query,f:"json",...this._createRequestQueryOptions(e)},responseType:"json"}},e._createClass(r,[{key:"queryTask",get:function(){const{capabilities:{query:{supportsFormatPBF:e}},parsedUrl:t,dynamicDataSource:r,infoFor3D:s,gdbVersion:a,spatialReference:n,fieldsIndex:o}=this.layer,u=i("featurelayer-pbf")&&e&&d.isNone(s)?"pbf":"json";return new I({url:t.path,format:u,fieldsIndex:o,infoFor3D:s,dynamicDataSource:r,gdbVersion:a,sourceSpatialReference:n})}}]),r}(l);t.__decorate([h.property()],N.prototype,"type",void 0),t.__decorate([h.property({constructOnly:!0})],N.prototype,"layer",void 0),t.__decorate([h.property({readOnly:!0})],N.prototype,"queryTask",null),N=t.__decorate([g.subclass("esri.layers.graphics.sources.FeatureLayerSource")],N);return N}));
