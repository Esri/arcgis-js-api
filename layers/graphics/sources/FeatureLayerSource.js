// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../request","../../../core/Error","../../../core/Loadable","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/accessorSupport/decorators","../../../tasks/QueryTask","../../../tasks/operations/queryAttachments","../../../tasks/operations/zscale"],(function(e,t,r,a,n,s,u,o,i,l,d,c,p){function h(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return"string"==typeof e?[2,i.dataComponents(e)||{data:e}]:[2,o.create((function(t,r){var a=new FileReader;a.readAsDataURL(e),a.onload=function(){return t(i.dataComponents(a.result))},a.onerror=function(e){return r(e)}}))]}))}))}Object.defineProperty(t,"__esModule",{value:!0});var y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="feature-layer",t}return r.__extends(t,e),t.prototype.load=function(e){var t=u.isSome(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),o.resolve(this)},Object.defineProperty(t.prototype,"queryTask",{get:function(){var e=this.layer,t=e.parsedUrl,r=e.dynamicDataSource,a=e.gdbVersion,n=e.spatialReference;return new d({url:null!=r?t.path+"?"+i.objectToQuery(t.query):t.path,gdbVersion:a,sourceSpatialReference:n})},enumerable:!0,configurable:!0}),t.prototype.addAttachment=function(e,t){var n=this;return this.load().then((function(){var s=e.attributes[n.layer.objectIdField],u=n.layer.parsedUrl.path+"/"+s+"/addAttachment",o=r.__assign(r.__assign({f:"json"},n.layer.parsedUrl.query),{gdbVersion:n.layer.gdbVersion}),i=n._getFormDataForAttachment(t,o);return a(u,{body:i}).then((function(e){return n._createFeatureEditResult(e.data.addAttachmentResult)})).catch((function(e){throw n._createAttachmentErrorResult(s,e)}))}))},t.prototype.updateAttachment=function(e,t,n){var s=this;return this.load().then((function(){var u=e.attributes[s.layer.objectIdField],o=s.layer.parsedUrl.path+"/"+u+"/updateAttachment",i=r.__assign(r.__assign({f:"json"},s.layer.parsedUrl.query),{gdbVersion:s.layer.gdbVersion,attachmentId:t}),l=s._getFormDataForAttachment(n,i);return a(o,{body:l}).then((function(e){return s._createFeatureEditResult(e.data.updateAttachmentResult)})).catch((function(e){throw s._createAttachmentErrorResult(u,e)}))}))},t.prototype.applyEdits=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,s,u,o,i,l,d,c,h,y,f,m,_,g,b,F,v,R;return r.__generator(this,(function(I){switch(I.label){case 0:return[4,this.load()];case 1:I.sent(),n=e.addFeatures.map(this._serializeFeature,this),s=e.updateFeatures.map(this._serializeFeature,this),u=this._getFeatureIds(e.deleteFeatures),p.unapplyEditsZUnitScaling(n,s,this.layer.spatialReference),o=[],i=[],l=r.__spreadArrays(e.deleteAttachments),d=0,c=e.addAttachments,I.label=2;case 2:return d<c.length?(_=c[d],y=(h=o).push,[4,this._serializeAttachment(_)]):[3,5];case 3:y.apply(h,[I.sent()]),I.label=4;case 4:return d++,[3,2];case 5:f=0,m=e.updateAttachments,I.label=6;case 6:return f<m.length?(_=m[f],b=(g=i).push,[4,this._serializeAttachment(_)]):[3,9];case 7:b.apply(g,[I.sent()]),I.label=8;case 8:return f++,[3,6];case 9:return F=o.length||i.length||l.length?{adds:o,updates:i,deletes:l}:null,v={f:"json",adds:n.length?JSON.stringify(n):null,updates:s.length?JSON.stringify(s):null,deletes:u.length?u.join(","):null,gdbVersion:t&&t.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:t&&t.rollbackOnFailureEnabled,useGlobalIds:t&&t.globalIdUsed,attachments:F&&JSON.stringify(F)},[4,a(this.layer.parsedUrl.path+"/applyEdits",{query:v,method:"post",responseType:"json"})];case 10:return R=I.sent(),[2,this._createEditsResult(R)]}}))}))},t.prototype.deleteAttachments=function(e,t){var n=this;return this.load().then((function(){var s=e.attributes[n.layer.objectIdField],u=n.layer.parsedUrl.path+"/"+s+"/deleteAttachments";return a(u,{query:r.__assign(r.__assign({f:"json"},n.layer.parsedUrl.query),{gdbVersion:n.layer.gdbVersion,attachmentIds:t.join(",")}),method:"post",responseType:"json"}).then((function(e){return e.data.deleteAttachmentResults.map(n._createFeatureEditResult)})).catch((function(e){throw n._createAttachmentErrorResult(s,e)}))}))},t.prototype.queryAttachments=function(e,t){var n=this;void 0===t&&(t={});var s=this.layer.parsedUrl,u=s.path;return this.load().then((function(){var i=r.__assign(r.__assign({},t),{query:r.__assign(r.__assign({},s.query),{gdbVersion:n.layer.gdbVersion,f:"json"}),responseType:"json"});if(!n.layer.get("capabilities.operations.supportsQueryAttachments")){for(var l=e.objectIds,d=[],p=0,h=l;p<h.length;p++){var y=h[p],f=u+"/"+y+"/attachments";d.push(a(f,i))}return o.all(d).then((function(e){return l.map((function(t,r){return{parentObjectId:t,attachmentInfos:e[r].data.attachmentInfos}}))})).then((function(e){return c.processAttachmentQueryResult(e,u)}))}return n.queryTask.executeAttachmentQuery(e,i)}))},t.prototype.queryFeatures=function(e,t){var r=this;return this.load().then((function(){return r.queryTask.execute(e,t)}))},t.prototype.queryFeaturesJSON=function(e,t){var r=this;return this.load().then((function(){return r.queryTask.executeJSON(e,t)}))},t.prototype.queryObjectIds=function(e,t){var r=this;return this.load().then((function(){return r.queryTask.executeForIds(e,t)}))},t.prototype.queryFeatureCount=function(e,t){var r=this;return this.load().then((function(){return r.queryTask.executeForCount(e,t)}))},t.prototype.queryExtent=function(e,t){var r=this;return this.load().then((function(){return r.queryTask.executeForExtent(e,t)}))},t.prototype.queryRelatedFeatures=function(e,t){var r=this;return this.load().then((function(){return r.queryTask.executeRelationshipQuery(e,t)}))},t.prototype._fetchService=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(s){switch(s.label){case 0:return(t=this.layer.sourceJSON)?(this.sourceJSON=t,[2]):[4,a(this.layer.parsedUrl.path,{query:r.__assign({f:"json"},this.layer.parsedUrl.query),responseType:"json",signal:e})];case 1:return n=s.sent().data,this.sourceJSON=n,[2]}}))}))},t.prototype._serializeFeature=function(e){var t=e.geometry,r=e.attributes;return u.isNone(t)?{attributes:r}:"mesh"===t.type||"extent"===t.type?null:{geometry:t.toJSON(),attributes:r}},t.prototype._serializeAttachment=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,n,s,u,o,i,l,d;return r.__generator(this,(function(r){switch(r.label){case 0:return t=e.feature,a=e.attachment,n=a.globalId,s=a.name,u=a.contentType,o=a.data,i=a.uploadId,l={globalId:n,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null},t&&(l.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),i?(l.uploadId=i,[3,3]):[3,1];case 1:return o?[4,h(o)]:[3,3];case 2:d=r.sent(),l.contentType=d.mediaType,l.data=d.data,o instanceof File&&(l.name=o.name),r.label=3;case 3:return s&&(l.name=s),u&&(l.contentType=u),[2,l]}}))}))},t.prototype._getFeatureIds=function(e){var t=e[0];return t?"objectId"in t?this._getIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]},t.prototype._getIdsFromFeatures=function(e){var t=this.layer.objectIdField;return e.map((function(e){return e.attributes&&e.attributes[t]}))},t.prototype._getIdsFromFeatureIdentifier=function(e){return e.map((function(e){return e.objectId}))},t.prototype._createEditsResult=function(e){var t=e.data,r=e.data&&e.data.attachments;return{addFeatureResults:t.addResults?t.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:t.updateResults?t.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:t.deleteResults?t.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:r&&r.addResults?r.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:r&&r.updateResults?r.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:r&&r.deleteResults?r.deleteResults.map(this._createFeatureEditResult,this):[]}},t.prototype._createFeatureEditResult=function(e){var t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new n("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},t.prototype._createAttachmentErrorResult=function(e,t){var r=t.details.messages&&t.details.messages[0]||t.message,a=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new n("feature-layer-source:attachment-failure",r,{code:a})}},t.prototype._getFormDataForAttachment=function(e,t){var r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(var a in t){var n=t[a];null!=n&&(r.set?r.set(a,n):r.append(a,n))}return r},r.__decorate([l.property()],t.prototype,"type",void 0),r.__decorate([l.property({constructOnly:!0})],t.prototype,"layer",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["layer.parsedUrl","layer.gdbVersion","layer.dynamicDataSource"]})],t.prototype,"queryTask",null),t=r.__decorate([l.subclass("esri.layers.graphics.sources.FeatureLayerSource")],t)}(s);t.default=y}));