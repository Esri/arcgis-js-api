/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/Loadable","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../ogc/ogcFeatureUtils","../../../rest/support/FeatureSet","../../../geometry/SpatialReference","../../../geometry/support/typeUtils"],(function(e,t,r,o,s,i,n,p,a,u,c,l,d,f,y,m){"use strict";e.OGCFeatureSource=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).featureDefinition=null,t.type="ogc-feature",t}t._inheritsLoose(r,e);var o=r.prototype;return o.load=function(e){return this.addResolvingPromise(this._loadOGCServices(this.layer,e)),this.when()},o.getFeatureDefinition=function(){const{featureDefinition:{collection:e,layerDefinition:t,spatialReference:r,supportedCrs:o},layer:{apiKey:s,capabilities:i,customParameters:n}}=this;return{capabilities:i,collection:e,layerDefinition:t,queryParameters:{apiKey:s,customParameters:n},spatialReference:r,supportedCrs:o}},o.queryExtent=function(e,t={}){return null},o.queryFeatureCount=function(e,t={}){return null},o.queryFeatures=function(e,t={}){return this.queryFeaturesJSON(e,t).then((e=>f.fromJSON(e)))},o.queryFeaturesJSON=function(e,t={}){const r=this.getFeatureDefinition();return this.load(t).then((()=>d.queryFeatureSetJSON(r,e,t)))},o.queryObjectIds=function(e,t={}){return null},o.serviceSupportsSpatialReference=function(e){return!(!e.isWGS84&&!e.isWebMercator)||!!this.featureDefinition.supportedCrs[e.wkid]},o._conformsToType=function(e,t){var r;const o=new RegExp(`^${t}$`,"i");return null!=(r=e.conformsTo.some((e=>o.test(e))))&&r},o._getCapabilities=function(e,t){var r,o,s,i,p,a,u;const c=n.isSome(t)?null==(r=t.components)?void 0:r.parameters:null;return{attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1},query:{maxRecordCount:null!=(o=null!=(s=null==c||null==(i=c.limit)||null==(p=i.schema)?void 0:p.maximum)?s:null==c||null==(a=c.limitFeatures)||null==(u=a.schema)?void 0:u.maximum)?o:5e3,maxRecordCountFactor:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,tileMaxRecordCount:void 0},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1}}},o._getExtent=function(e){var t;const r=null==(t=e.extent)?void 0:t.spatial;if(!r)return null;const o=r.bbox[0],s=4===o.length,i=o[0],n=o[1],p=s?void 0:o[2];return{xmin:i,ymin:n,xmax:s?o[2]:o[3],ymax:s?o[3]:o[4],zmin:p,zmax:s?void 0:o[5],spatialReference:y.WGS84.toJSON()}},o._getStorageSpatialReference=function(e){var t;const r=null!=(t=e.storageCrs)?t:d.crsDefault,o=d.getSpatialReferenceWkid(r);return n.isNone(o)?y.WGS84:new y({wkid:o})},o._getSupportedSpatialReferences=function(e,t){var r;const o="#/crs",s=null!=(r=e.crs)?r:[d.crsDefault],i=s.includes(o)?s.filter((e=>e!==o)).concat(t.crs):s,n=/^http:\/\/www\.opengis.net\/def\/crs\/epsg\/.*\/3785$/i;return i.filter((e=>!n.test(e)))},o._loadOGCServices=function(){var e=t._asyncToGenerator((function*(e,t){const r=n.isSome(t)?t.signal:null,{apiKey:o,collectionId:i,customParameters:p,fields:a,geometryType:u,hasZ:c,objectIdField:l,timeInfo:f,url:y}=e,S={fields:null==a?void 0:a.map((e=>e.toJSON())),geometryType:m.typeKebabDictionary.toJSON(u),hasZ:c,objectIdField:l,timeInfo:null==f?void 0:f.toJSON()},g={apiKey:o,customParameters:p,signal:r},h=yield d.getServerLandingPage(y,g),[v,C]=yield Promise.all([d.getServerConformance(h,g),d.getServerCollections(h,g)]);if(!this._conformsToType(v,"http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/geojson"))throw new s("ogc-feature-layer:no-geojson-support","Server does not support geojson");const O=C.collections.find((e=>e.id===i));if(!O)throw new s("ogc-feature-layer:collection-not-found","Server does not contain the named collection");const R=this._conformsToType(v,"http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/oas30")?yield d.getServerOpenApi(h,g):null,F=yield d.getCollectionDefinition(O,S,g),x=this._getCapabilities(F.hasZ,R),_=this._getExtent(O),b=this._getStorageSpatialReference(O).toJSON(),D=this._getSupportedSpatialReferences(O,C),w=new RegExp(`^${d.crsPrefix}`,"i"),G={};for(const s of D){const e=d.getSpatialReferenceWkid(s);n.isSome(e)&&(G[e]||(G[e]=s.replace(w,"")))}F.extent=_,this.featureDefinition={capabilities:x,collection:O,layerDefinition:F,queryParameters:{},spatialReference:b,supportedCrs:G}}));function r(t,r){return e.apply(this,arguments)}return r}(),r}(i),r.__decorate([p.property()],e.OGCFeatureSource.prototype,"featureDefinition",void 0),r.__decorate([p.property({constructOnly:!0})],e.OGCFeatureSource.prototype,"layer",void 0),r.__decorate([p.property()],e.OGCFeatureSource.prototype,"type",void 0),e.OGCFeatureSource=r.__decorate([l.subclass("esri.layers.graphics.sources.OGCFeatureSource")],e.OGCFeatureSource);const S=e.OGCFeatureSource;e.default=S,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
