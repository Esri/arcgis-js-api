/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../core/Collection","../../../core/Error","../../../core/has","../../../core/Loadable","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/workers/workers","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/shared","../../../core/accessorSupport/decorators/subclass","../../../rest/query/operations/queryZScale","../../../rest/query/operations/zscale","../../../rest/support/FeatureSet","../../../geometry/Extent","../../../geometry/Polygon","../../../geometry/support/typeUtils"],(function(e,t,r,o,n,i,s,a,u,l,c,p,d,y,h,f,m,g,_,S,b,T,G){"use strict";let F=0;const M=l.getLogger("esri.layers.graphics.sources.MemorySource");e.MemorySource=function(e){function r(t){var r;return(r=e.call(this,t)||this)._idToClientGraphic=null,r.type="memory",r}t._inheritsLoose(r,e);var o=r.prototype;return o.load=function(e){const t=c.isSome(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)},o.destroy=function(){var e;null==(e=this._connection)||e.close(),this._connection=null},o.applyEdits=function(e){return this.load().then((()=>this._applyEdits(e)))},o.openPorts=function(){return this.load().then((()=>this._connection.openPorts()))},o.queryFeatures=function(){var e=t._asyncToGenerator((function*(e,t={}){yield this.load(t);const r=yield this._connection.invoke("queryFeatures",e?e.toJSON():null,t);g.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,r);const o=S.fromJSON(r);if(!this._requiresClientGraphicMapping())return o;const n=this.layer.objectIdField;for(const i of o.features){const e=i.attributes[n],t=this._idToClientGraphic.get(e);t&&(i.geometry=t.geometry)}return o.geometryType=this.layer.geometryType,o}));function r(t){return e.apply(this,arguments)}return r}(),o.queryFeaturesJSON=function(){var e=t._asyncToGenerator((function*(e,t={}){if(this._requiresClientGraphicMapping())throw new s("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");yield this.load(t);const r=yield this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return g.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,r),r}));function r(t){return e.apply(this,arguments)}return r}(),o.queryFeatureCount=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)))},o.queryObjectIds=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,t)))},o.queryExtent=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryExtent",e?e.toJSON():null,t))).then((e=>({count:e.count,extent:b.fromJSON(e.extent)})))},o.querySnapping=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("querySnapping",e,t)))},o._applyEdits=function(){var e=t._asyncToGenerator((function*(e){if(!this._connection)throw new s("feature-layer-source:edit-failure","Memory source not loaded");const t=this.layer.objectIdField;let r=null;const o=[],n=[];yield Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const i=e=>"objectId"in e&&null!=e.objectId?e.objectId:"attributes"in e&&null!=e.attributes[t]?e.attributes[t]:null;if(e.addFeatures&&(r=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const s of e.deleteFeatures){const e=i(s);null!=e&&o.push(e)}const a=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures)for(const s of e.updateFeatures)if(n.push(this._serializeFeature(s)),a){const e=i(s);null!=e&&a.set(e,s)}_.unapplyEditsZUnitScaling(r?r.features:null,n,this.layer.spatialReference);const{fullExtent:u,featureEditResults:l}=yield this._connection.invoke("applyEdits",{adds:r?r.features:[],updates:n,deletes:o});return this.fullExtent=u,r&&r.finish(l.uidToObjectId),this._updateClientGraphicIds(a,l),this._createEditsResult(l)}));function r(t){return e.apply(this,arguments)}return r}(),o._prepareClientMapping=function(){var e=t._asyncToGenerator((function*(e,t){if("mesh"!==this.layerOrSourceGeometryType||c.isNone(e))return;const r=[];for(const{geometry:o}of e)!c.isSome(o)||"mesh"!==o.type||o.hasExtent||o.loaded||r.push(o.load({signal:t}));r.length&&(yield Promise.all(r))}));function r(t,r){return e.apply(this,arguments)}return r}(),o._updateClientGraphicIds=function(e,t){if(this._idToClientGraphic){if(e)for(const r of t.updateResults){if(!r.success)continue;const t=e.get(r.objectId);null!=t&&this._addIdToClientGraphic(t)}for(const e of t.deleteResults)e.success&&this._idToClientGraphic.delete(e.objectId)}},o._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}},o._createFeatureEditResult=function(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new s("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},o._prepareAddFeatures=function(e){const t=new Map,r=new Array(e.length);let o=null;for(let i=0;i<e.length;i++){const n=e[i],s=this._serializeFeature(n);!o&&c.isSome(n.geometry)&&(o=n.geometry.type),r[i]=s,t.set(`${s.uid}`,n)}const n=this;return{features:r,inferredGeometryType:o,finish(e){const r=n.sourceJSON.objectIdField;for(const o in e){const i=e[o],s=t.get(o);s&&(s.attributes||(s.attributes={}),-1===i?delete s.attributes[r]:s.attributes[r]=i,n._addIdToClientGraphic(s))}}}},o._addIdToClientGraphic=function(e){if(!this._idToClientGraphic)return;const t=this.sourceJSON.objectIdField,r=e.attributes&&e.attributes[t];null!=r&&this._idToClientGraphic.set(r,e)},o._requiresClientGraphicMapping=function(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)},o._geometryRequiresClientGraphicMapping=function(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)},o._geometryTypeRequiresClientGraphicMapping=function(e){return"mesh"===e||"multipatch"===e||"extent"===e},o._serializeFeature=function(e){const{attributes:t}=e,r=this._geometryForSerialization(e),o=(F++).toString();return r?{uid:o,geometry:r.toJSON(),attributes:t}:{uid:o,attributes:t}},o._geometryForSerialization=function(e){const{geometry:t}=e;if(c.isNone(t))return null;if(this._geometryRequiresClientGraphicMapping(t)){return t.extent?T.fromExtent(t.extent):null}return t},o._startWorker=function(){var e=t._asyncToGenerator((function*(e){this._connection=yield d.open("MemorySourceWorker",{strategy:a("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:t,spatialReference:r,objectIdField:o,hasM:n,hasZ:i,timeInfo:s}=this.layer,u="defaults"===this.layer.originOf("spatialReference");yield this._prepareClientMapping(this.items,e);const l=this._prepareAddFeatures(this.items);this.on("before-changes",(e=>{M.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),e.preventDefault()}));const c={features:l.features,fields:t&&t.map((e=>e.toJSON())),geometryType:G.typeKebabDictionary.toJSON(this.workerGeometryType),hasM:"mesh"!==this.layerOrSourceGeometryType&&n,hasZ:"mesh"===this.layerOrSourceGeometryType||i,objectIdField:o,spatialReference:u?null:r&&r.toJSON(),timeInfo:s?s.toJSON():null},p=yield this._connection.invoke("load",c,{signal:e});for(const a of p.warnings)M.warn(a.message,{layer:this.layer,warning:a});p.featureErrors.length&&M.warn(`Encountered ${p.featureErrors.length} validation errors while loading features`,p.featureErrors);const y=p.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(l.inferredGeometryType)&&(y.geometryType=G.typeKebabDictionary.toJSON(l.inferredGeometryType)),this.sourceJSON=y,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),l.finish(p.assignedObjectIds)}));function r(t){return e.apply(this,arguments)}return r}(),t._createClass(r,[{key:"workerGeometryType",get:function(){var e;const t=null==(e=this.layer)?void 0:e.geometryType;return t?this._geometryTypeRequiresClientGraphicMapping(t)?"polygon":t:null}},{key:"layerOrSourceGeometryType",get:function(){var e,t,r;return null!=(e=null==(t=this.layer)?void 0:t.geometryType)?e:null==(r=this.sourceJSON)?void 0:r.geometryType}}]),r}(u.LoadableMixin(p.EsriPromiseMixin(i))),r.__decorate([f.shared({Type:n,ensureType:h.ensureType(n)})],e.MemorySource.prototype,"itemType",void 0),r.__decorate([y.property()],e.MemorySource.prototype,"type",void 0),r.__decorate([y.property({constructOnly:!0})],e.MemorySource.prototype,"layer",void 0),r.__decorate([y.property({readOnly:!0})],e.MemorySource.prototype,"workerGeometryType",null),r.__decorate([y.property()],e.MemorySource.prototype,"sourceJSON",void 0),e.MemorySource=r.__decorate([m.subclass("esri.layers.graphics.sources.MemorySource")],e.MemorySource);var R=e.MemorySource;e.default=R,Object.defineProperty(e,"__esModule",{value:!0})}));
