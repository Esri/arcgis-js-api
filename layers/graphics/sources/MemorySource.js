/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/shared","../../../core/accessorSupport/decorators/subclass","../../../core/Error","../../../core/urlUtils","../../../core/uuid","../../../portal/support/resourceExtension","../../../core/promiseUtils","../../../geometry/Extent","../../../geometry/Polygon","../../../geometry/support/typeUtils","../../../geometry","../../../core/Collection","../../../core/Promise","../../../core/Loadable","../../../Graphic","../../../core/workers/workers","../../../tasks/operations/zscale","../../../tasks/operations/queryZScale","../../../tasks/support/FeatureSet"],(function(e,t,r,o,i,s,n,a,u,c,l,p,d,y,h,f,m,g,_,S,b,T,F,R,M,G,O){"use strict";let C=0;const w=s.getLogger("esri.layers.graphics.sources.MemorySource");e.MemorySource=function(e){function r(t){var r;return(r=e.call(this,t)||this)._idToClientGraphic=null,r.type="memory",r}t._inheritsLoose(r,e);var s=r.prototype;return s.load=function(e){const t=i.isSome(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),h.resolve(this)},s.destroy=function(){var e;null==(e=this._connection)||e.close(),this._connection=null},s.applyEdits=function(e){return this.load().then((()=>this._applyEdits(e)))},s.openPorts=function(){return this.load().then((()=>this._connection.openPorts()))},s.queryFeatures=async function(e,t={}){await this.load(t);const r=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);G.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,r);const o=O.fromJSON(r);if(!this._requiresClientGraphicMapping())return o;const i=this.layer.objectIdField;for(const e of o.features){const t=e.attributes[i],r=this._idToClientGraphic.get(t);r&&(e.geometry=r.geometry)}return o.geometryType=this.layer.geometryType,o},s.queryFeaturesJSON=async function(e,t={}){if(this._requiresClientGraphicMapping())return h.reject(new l("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)"));await this.load(t);const r=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return G.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,r),r},s.queryFeatureCount=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)))},s.queryObjectIds=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,t)))},s.queryExtent=function(e,t={}){return this.load(t).then((()=>this._connection.invoke("queryExtent",e?e.toJSON():null,t))).then((e=>({count:e.count,extent:f.fromJSON(e.extent)})))},s._applyEdits=function(e){if(!this._connection)throw new l("feature-layer-source:edit-failure","Memory source not loaded");const t=this.layer.objectIdField;let r=null;const o=[],i=[],s=e=>"objectId"in e&&null!=e.objectId?e.objectId:"attributes"in e&&null!=e.attributes[t]?e.attributes[t]:null;if(e.addFeatures&&(r=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const t of e.deleteFeatures){const e=s(t);null!=e&&o.push(e)}const n=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures)for(const t of e.updateFeatures)if(i.push(this._serializeFeature(t)),n){const e=s(t);null!=e&&n.set(e,t)}return M.unapplyEditsZUnitScaling(r?r.features:null,i,this.layer.spatialReference),this._connection.invoke("applyEdits",{adds:r?r.features:[],updates:i,deletes:o}).then((({fullExtent:e,featureEditResults:t})=>{if(this.fullExtent=e,r&&r.finish(t.uidToObjectId),this._idToClientGraphic){if(n)for(const e of t.updateResults){if(!e.success)continue;const t=n.get(e.objectId);null!=t&&this._addIdToClientGraphic(t)}for(const e of t.deleteResults)e.success&&this._idToClientGraphic.delete(e.objectId)}return this._createEditsResult(t)}))},s._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}},s._createFeatureEditResult=function(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new l("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},s._prepareAddFeatures=function(e){const t=new Map,r=new Array(e.length);let o=null;for(let s=0;s<e.length;s++){const n=e[s],a=this._serializeFeature(n);!o&&i.isSome(n.geometry)&&(o=n.geometry.type),r[s]=a,t.set(`${a.uid}`,n)}const s=this;return{features:r,inferredGeometryType:o,finish(e){const r=s.sourceJSON.objectIdField;for(const o in e){const i=e[o],n=t.get(o);n&&(n.attributes||(n.attributes={}),-1===i?delete n.attributes[r]:n.attributes[r]=i,s._addIdToClientGraphic(n))}}}},s._addIdToClientGraphic=function(e){if(!this._idToClientGraphic)return;const t=this.sourceJSON.objectIdField,r=e.attributes&&e.attributes[t];null!=r&&this._idToClientGraphic.set(r,e)},s._requiresClientGraphicMapping=function(){const e=this.layer.geometryType||this.sourceJSON.geometryType;return this._geometryTypeRequiresClientGraphicMapping(e)},s._geometryRequiresClientGraphicMapping=function(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)},s._geometryTypeRequiresClientGraphicMapping=function(e){return"mesh"===e||"multipatch"===e||"extent"===e},s._serializeFeature=function(e){const{attributes:t}=e,r=this._geometryForSerialization(e),o=(C++).toString();return r?{uid:o,geometry:r.toJSON(),attributes:t}:{uid:o,attributes:t}},s._geometryForSerialization=function(e){const{geometry:t}=e;if(i.isNone(t))return null;if(this._geometryRequiresClientGraphicMapping(t)){return t.extent?m.fromExtent(t.extent):null}return t},s._startWorker=async function(e){this._connection=await R.open("MemorySourceWorker",{strategy:o("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:t,spatialReference:r,objectIdField:i,hasM:s,hasZ:n,timeInfo:a}=this.layer,u="defaults"===this.layer.originOf("spatialReference"),c=this._prepareAddFeatures(this.items);this.on("before-changes",(e=>{w.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),e.preventDefault()}));const l={features:c.features,fields:t&&t.map((e=>e.toJSON())),geometryType:g.typeKebabDictionary.toJSON(this.workerGeometryType),hasM:s,hasZ:n,objectIdField:i,spatialReference:u?null:r&&r.toJSON(),timeInfo:a?a.toJSON():null},p=await this._connection.invoke("load",l,{signal:e});for(const e of p.warnings)w.warn(e.message,{layer:this.layer,warning:e});p.featureErrors.length&&w.warn(`Encountered ${p.featureErrors.length} validation errors while loading features`,p.featureErrors);const d=p.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(c.inferredGeometryType)&&(d.geometryType=g.typeKebabDictionary.toJSON(c.inferredGeometryType)),"mesh"!==d.geometryType&&"mesh"!==this.layer.geometryType||(d.hasZ=!0),this.sourceJSON=d,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),c.finish(p.assignedObjectIds)},t._createClass(r,[{key:"workerGeometryType",get:function(){const e=this.layer&&this.layer.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null}}]),r}(T.LoadableMixin(b.EsriPromiseMixin(S))),r.__decorate([u.shared({Type:F,ensureType:n.ensureType(F)})],e.MemorySource.prototype,"itemType",void 0),r.__decorate([a.property()],e.MemorySource.prototype,"type",void 0),r.__decorate([a.property({constructOnly:!0})],e.MemorySource.prototype,"layer",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:["layer.geometryType"]})],e.MemorySource.prototype,"workerGeometryType",null),r.__decorate([a.property()],e.MemorySource.prototype,"sourceJSON",void 0),e.MemorySource=r.__decorate([c.subclass("esri.layers.graphics.sources.MemorySource")],e.MemorySource);var E=e.MemorySource;e.default=E,Object.defineProperty(e,"__esModule",{value:!0})}));
