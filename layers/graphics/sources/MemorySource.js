// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../geometry","../../../Graphic","../../../core/Collection","../../../core/Error","../../../core/has","../../../core/Loadable","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/accessorSupport/ensureType","../../../tasks/operations/zscale","../../../tasks/support/FeatureSet"],(function(e,t,r,i,o,n,a,s,u,l,p,c,d,y,h,f,g,_){Object.defineProperty(t,"__esModule",{value:!0});var m=0,v=l.getLogger("esri.layers.graphics.sources.MemorySource"),b=function(e){function t(t){var r=e.call(this,t)||this;return r._idToClientGraphic=null,r.type="memory",r}return r.__extends(t,e),t.prototype.load=function(e){var t=p.isSome(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),d.resolve(this)},Object.defineProperty(t.prototype,"workerGeometryType",{get:function(){var e=this.layer&&this.layer.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null},enumerable:!0,configurable:!0}),t.prototype.applyEdits=function(e){var t=this;return this.load().then((function(){return t._applyEdits(e)}))},t.prototype.openPorts=function(){var e=this;return this.load().then((function(){return e._connection.openPorts()}))},t.prototype.queryFeatures=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var i,o,n,a,s,u,l,p;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.load(t)];case 1:return r.sent(),[4,this._connection.invoke("queryFeatures",e?e.toJSON():null,t)];case 2:if(i=r.sent(),g.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,i),o=_.fromJSON(i),!this._requiresClientGraphicMapping())return[2,o];for(n=this.layer.objectIdField,a=0,s=o.features;a<s.length;a++)u=s[a],l=u.attributes[n],(p=this._idToClientGraphic.get(l))&&(u.geometry=p.geometry);return o.geometryType=this.layer.geometryType,[2,o]}}))}))},t.prototype.queryFeaturesJSON=function(e,t){return void 0===t&&(t={}),r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return this._requiresClientGraphicMapping()?[2,d.reject(new a("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)"))]:[4,this.load(t)];case 1:return r.sent(),[4,this._connection.invoke("queryFeatures",e?e.toJSON():null,t)];case 2:return i=r.sent(),g.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,i),[2,i]}}))}))},t.prototype.queryFeatureCount=function(e,t){var r=this;return void 0===t&&(t={}),this.load(t).then((function(){return r._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)}))},t.prototype.queryObjectIds=function(e,t){var r=this;return void 0===t&&(t={}),this.load(t).then((function(){return r._connection.invoke("queryObjectIds",e?e.toJSON():null,t)}))},t.prototype.queryExtent=function(e,t){var r=this;return void 0===t&&(t={}),this.load(t).then((function(){return r._connection.invoke("queryExtent",e?e.toJSON():null,t)})).then((function(e){return{count:e.count,extent:i.Extent.fromJSON(e.extent)}}))},t.prototype._applyEdits=function(e){var t=this;if(!this._connection)throw new a("feature-layer-source:edit-failure","Memory source not loaded");var r=this.layer.objectIdField,i=null,o=[],n=[],s=function(e){return"objectId"in e&&null!=e.objectId?e.objectId:"attributes"in e&&null!=e.attributes[r]?e.attributes[r]:null};if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(var u=0,l=e.deleteFeatures;u<l.length;u++){null!=(y=s(h=l[u]))&&o.push(y)}var p=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures)for(var c=0,d=e.updateFeatures;c<d.length;c++){var y,h=d[c];if(n.push(this._serializeFeature(h)),p)null!=(y=s(h))&&p.set(y,h)}return g.unapplyEditsZUnitScaling(i?i.features:null,n,this.layer.spatialReference),this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:n,deletes:o}).then((function(e){var r=e.fullExtent,o=e.featureEditResults;if(t.fullExtent=r,i&&i.finish(o.uidToObjectId),t._idToClientGraphic){if(p)for(var n=0,a=o.updateResults;n<a.length;n++){var s=a[n];if(s.success){var u=p.get(s.objectId);null!=u&&t._addIdToClientGraphic(u)}}for(var l=0,c=o.deleteResults;l<c.length;l++){var d=c[l];d.success&&t._idToClientGraphic.delete(d.objectId)}}return t._createEditsResult(o)}))},t.prototype._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}},t.prototype._createFeatureEditResult=function(e){var t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new a("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},t.prototype._prepareAddFeatures=function(e){for(var t=new Map,r=new Array(e.length),i=null,o=0;o<e.length;o++){var n=e[o],a=this._serializeFeature(n);!i&&p.isSome(n.geometry)&&(i=n.geometry.type),r[o]=a,t.set(""+a.uid,n)}var s=this;return{features:r,inferredGeometryType:i,finish:function(e){var r=s.sourceJSON.objectIdField;for(var i in e){var o=e[i],n=t.get(i);n&&(n.attributes||(n.attributes={}),-1===o?delete n.attributes[r]:n.attributes[r]=o,s._addIdToClientGraphic(n))}}}},t.prototype._addIdToClientGraphic=function(e){if(this._idToClientGraphic){var t=this.sourceJSON.objectIdField,r=e.attributes&&e.attributes[t];null!=r&&this._idToClientGraphic.set(r,e)}},t.prototype._requiresClientGraphicMapping=function(){var e=this.layer.geometryType||this.sourceJSON.geometryType;return this._geometryTypeRequiresClientGraphicMapping(e)},t.prototype._geometryRequiresClientGraphicMapping=function(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)},t.prototype._geometryTypeRequiresClientGraphicMapping=function(e){return"mesh"===e||"multipatch"===e||"extent"===e},t.prototype._serializeFeature=function(e){var t=e.attributes,r=this._geometryForSerialization(e),i=(m++).toString();return r?{uid:i,geometry:r.toJSON(),attributes:t}:{uid:i,attributes:t}},t.prototype._geometryForSerialization=function(e){var t=e.geometry;return p.isNone(t)?null:this._geometryRequiresClientGraphicMapping(t)?i.Polygon.fromExtent(t.extent):t},t.prototype._startWorker=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,o,n,a,u,l,p,c,d,h,f,g,_,m,b,S;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this,[4,y.open("MemorySourceWorker",{strategy:s("esri-workers-for-memory-layers")?"dedicated":"local",signal:e})];case 1:return t._connection=r.sent(),o=this.layer,n=o.fields,a=o.spatialReference,u=o.objectIdField,l=o.hasM,p=o.hasZ,c=o.timeInfo,d="defaults"===this.layer.originOf("spatialReference"),h=this._prepareAddFeatures(this.items),this.on("before-changes",(function(e){v.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),e.preventDefault()})),f={features:h.features,fields:n&&n.map((function(e){return e.toJSON()})),geometryType:i.typeKebabDictionary.toJSON(this.workerGeometryType),hasM:l,hasZ:p,objectIdField:u,spatialReference:d?null:a&&a.toJSON(),timeInfo:c?c.toJSON():null},[4,this._connection.invoke("load",f,{signal:e})];case 2:for(g=r.sent(),_=0,m=g.warnings;_<m.length;_++)b=m[_],v.warn(b.message,{layer:this.layer,warning:b});return g.featureErrors.length&&v.warn("Encountered "+g.featureErrors.length+" validation errors while loading features",g.featureErrors),S=g.layerDefinition,this._geometryTypeRequiresClientGraphicMapping(h.inferredGeometryType)&&(S.geometryType=i.typeKebabDictionary.toJSON(h.inferredGeometryType)),this.sourceJSON=S,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),h.finish(g.assignedObjectIds),[2]}}))}))},r.__decorate([h.shared({Type:o,ensureType:f.ensureType(o)})],t.prototype,"itemType",void 0),r.__decorate([h.property()],t.prototype,"type",void 0),r.__decorate([h.property({constructOnly:!0})],t.prototype,"layer",void 0),r.__decorate([h.property({readOnly:!0,dependsOn:["layer.geometryType"]})],t.prototype,"workerGeometryType",null),r.__decorate([h.property()],t.prototype,"sourceJSON",void 0),t=r.__decorate([h.subclass("esri.layers.graphics.sources.MemorySource")],t)}(u.LoadableMixin(c.EsriPromiseMixin(n)));t.MemorySource=b,t.default=b}));