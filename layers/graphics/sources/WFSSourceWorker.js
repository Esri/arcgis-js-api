/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/asyncUtils","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","../data/FeatureStore","../data/projectionSupport","../data/QueryEngine","./geojson/geojson","./support/sourceUtils","../../ogc/wfsUtils","../../support/FieldsIndex"],(function(e,t,r,n,o,i,s,a,u,c,p,y,l,h,f){"use strict";let d=function(){function d(){var t=this;this._queryEngine=null,this._customParameters=null,this._snapshotFeatures=function(){var r=e._asyncToGenerator((function*(e){const{objectIdField:r}=t._queryEngine,n=yield h.getFeature(t._getFeatureUrl??"",t._featureType.typeName,t._getFeatureOutputFormat,{customParameters:t._customParameters,dateFields:t._queryEngine.fieldsIndex.dateFields.map((e=>e.name)),signal:e});yield y.validateGeoJSON(n),i.throwIfAborted(e);const u=y.createOptimizedFeatures(n,{geometryType:t._queryEngine.geometryType,hasZ:!1,objectIdField:r});if(!s.equals(t._queryEngine.spatialReference,s.WGS84))for(const i of u)o.isSome(i.geometry)&&(i.geometry=a.convertFromGeometry(c.project(a.convertToGeometry(i.geometry,t._queryEngine.geometryType,!1,!1),s.WGS84,t._queryEngine.spatialReference)));let p=1;for(const o of u){const e={};l.mixAttributes(t._fieldsIndex,e,o.attributes,!0),o.attributes=e,null==o.attributes[r]&&(o.objectId=o.attributes[r]=p++)}return u}));return function(e){return r.apply(this,arguments)}}()}var _=d.prototype;return _.destroy=function(){this._queryEngine?.destroy(),this._queryEngine=null},_.load=function(){var t=e._asyncToGenerator((function*(e,t){const{getFeatureUrl:r,getFeatureOutputFormat:n,spatialReference:s,fields:a,geometryType:c,featureType:y,objectIdField:l,customParameters:h}=e;this._featureType=y,this._customParameters=h,this._getFeatureUrl=r,this._getFeatureOutputFormat=n,this._fieldsIndex=new f(a),yield this._checkProjection(s),i.throwIfAborted(t),this._queryEngine=new p.QueryEngine({fields:a,geometryType:c,hasM:!1,hasZ:!1,objectIdField:l,spatialReference:s,timeInfo:null,featureStore:new u({geometryType:c,hasM:!1,hasZ:!1})});const d=yield this._snapshotFeatures(o.unwrap(t.signal));return this._queryEngine.featureStore.addMany(d),{extent:(yield this._queryEngine.fetchRecomputedExtents()).fullExtent}}));function r(e,r){return t.apply(this,arguments)}return r}(),_.applyEdits=function(){var t=e._asyncToGenerator((function*(){throw new r("wfs-source:editing-not-supported","applyEdits() is not supported on WFSLayer")}));function n(){return t.apply(this,arguments)}return n}(),_.queryFeatures=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}));function r(){return t.apply(this,arguments)}return r}(),_.queryFeatureCount=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}));function r(){return t.apply(this,arguments)}return r}(),_.queryObjectIds=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}));function r(){return t.apply(this,arguments)}return r}(),_.queryExtent=function(){var t=e._asyncToGenerator((function*(e={},t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}));function r(){return t.apply(this,arguments)}return r}(),_.querySnapping=function(){var t=e._asyncToGenerator((function*(e,t={}){return yield this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}));function r(e){return t.apply(this,arguments)}return r}(),_.refresh=function(){var o=e._asyncToGenerator((function*(e){return this._customParameters=e,this._snapshotTask?.abort(),this._snapshotTask=t.createTask(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),i.isAbortError(e)||n.getLogger("esri.layers.WFSLayer").error(new r("wfs-layer:getfeature-error","An error occurred during the GetFeature request",{error:e}))})),yield this._waitSnapshotComplete(),{extent:(yield this._queryEngine.fetchRecomputedExtents()).fullExtent}}));function s(e){return o.apply(this,arguments)}return s}(),_._waitSnapshotComplete=function(){var t=e._asyncToGenerator((function*(){if(this._snapshotTask&&!this._snapshotTask.finished){try{yield this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}));function r(){return t.apply(this,arguments)}return r}(),_._checkProjection=function(){var t=e._asyncToGenerator((function*(e){try{yield c.checkProjectionSupport(s.WGS84,e)}catch{throw new r("unsupported-projection","Projection not supported",{spatialReference:e})}}));function n(e){return t.apply(this,arguments)}return n}(),d}();return d}));
