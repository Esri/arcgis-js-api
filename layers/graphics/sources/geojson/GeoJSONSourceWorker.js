// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../request","../../../../core/Error","../../../../core/promiseUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../featureConversionUtils","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","./geojson","../support/clientSideDefaults","../support/sourceUtils","../../../support/FieldsIndex","../../../support/fieldType","../../../support/fieldUtils"],(function(e,t,i,r,n,s,a,o,u,l,d,p,c,y,f,h,g,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var _={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}},F=function(){function e(){this._queryEngine=null}return e.prototype.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFields=this._fieldsIndex=this._createDefaultAttributes=null},e.prototype.load=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,s,a,f,F,b,I,v,E,j,T,q,x,w,R,D,S,O,k,Q,A,G,P,C,Z,M;return i.__generator(this,(function(U){switch(U.label){case 0:return t=[],[4,this._checkProjection(e.spatialReference)];case 1:return U.sent(),s=null,e.url?[4,r(e.url,{responseType:"json"})]:[3,4];case 2:return a=U.sent(),s=a.data,[4,c.validateGeoJSON(s)];case 3:U.sent(),U.label=4;case 4:if(f=c.inferLayerProperties(s,{geometryType:e.geometryType}),F=e.fields||f.fields||[],b=null!=e.hasZ?e.hasZ:f.hasZ,I=f.geometryType,v=e.objectIdField||("number"===f.objectIdFieldType?f.objectIdFieldName:"OBJECTID")||"OBJECTID",E=e.spatialReference||o.WGS84,j=e.timeInfo,!I)throw new n("geojson-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");for("string"===f.objectIdFieldType&&t.push({name:"geojson-layer:unsupported-id-type",message:"Feature ids are of type string and can't be honored."}),F===f.fields&&f.unknownFields.length>0&&t.push({name:"geojson-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:f.unknownFields}}),v&&(T=null,F.some((function(e){return e.name===v&&(T=e,!0)}))?(T.type="esriFieldTypeOID",T.editable=!1,T.nullable=!1):F.unshift({alias:v,name:v,type:"esriFieldTypeOID",editable:!1,nullable:!1})),q=0,x=F;q<x.length;q++){if(null==(S=x[q]).name&&(S.name=S.alias),null==S.alias&&(S.alias=S.name),!S.name)throw new n("geojson-layer:invalid-field-name","field name is missing",{field:S});if(S.name===v&&(S.type="esriFieldTypeOID"),-1===g.kebabDict.jsonValues.indexOf(S.type))throw new n("geojson-layer:invalid-field-type",'invalid type for field "'+S.name+'"',{field:S})}for(w={},this._requiredFields=[],R=0,D=F;R<D.length;R++)"esriFieldTypeOID"!==(S=D[R]).type&&"esriFieldTypeGlobalID"!==S.type&&(S.editable=null==S.editable||!!S.editable,S.nullable=null==S.nullable||!!S.nullable,O=m.getFieldDefaultValue(S),S.nullable||void 0!==O?w[S.name]=O:this._requiredFields.push(S));if(this._fieldsIndex=new h(F),j&&(j.startTimeField&&((k=this._fieldsIndex.get(j.startTimeField))?(j.startTimeField=k.name,k.type="esriFieldTypeDate"):j.startTimeField=null),j.endTimeField&&((Q=this._fieldsIndex.get(j.endTimeField))?(j.endTimeField=Q.name,Q.type="esriFieldTypeDate"):j.endTimeField=null),j.trackIdField&&((A=this._fieldsIndex.get(j.trackIdField))?j.trackIdField=A.name:(j.trackIdField=null,t.push({name:"geojson-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:j}}))),j.startTimeField||j.endTimeField||(t.push({name:"geojson-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:j}}),j=null)),G={warnings:t,featureErrors:[],layerDefinition:i.__assign(i.__assign({},_),{drawingInfo:y.createDrawingInfo(I),templates:y.createDefaultTemplate(w),extent:null,geometryType:I,objectIdField:v,fields:F,hasZ:!!b,timeInfo:j})},this._queryEngine=new p.default({fields:F,geometryType:I,hasM:!1,hasZ:b,objectIdField:v,spatialReference:E,timeInfo:j,featureStore:new l.default({geometryType:I,hasM:!1,hasZ:b})}),this._createDefaultAttributes=y.createDefaultAttributesFunction(w,v),this._nextObjectId=f.maxObjectId+1,P=c.createOptimizedFeatures(s,{geometryType:I,hasZ:b,objectIdFieldName:"number"===f.objectIdFieldType?v:null}),!o.equals(E,o.WGS84))for(C=0,Z=P;C<Z.length;C++)(M=Z[C]).geometry&&(M.geometry=u.convertFromGeometry(d.project(u.convertToGeometry(M.geometry,I,b,!1),o.WGS84,E)));return this._loadInitialFeatures(G,P),[2,G]}}))}))},e.prototype.applyEdits=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,n;return i.__generator(this,(function(i){switch(i.label){case 0:return t=this._queryEngine,r=t.spatialReference,n=t.geometryType,[4,s.all([f.loadGeometryEngineForSimplify(r,n),d.checkProjectionSupport(e.adds,r),d.checkProjectionSupport(e.updates,r)])];case 1:return i.sent(),[2,this._applyEdits(e)]}}))}))},e.prototype.queryFeatures=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQuery(e,t.signal)]}))}))},e.prototype.queryFeatureCount=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQueryForCount(e,t.signal)]}))}))},e.prototype.queryObjectIds=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQueryForIds(e,t.signal)]}))}))},e.prototype.queryExtent=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){return[2,this._queryEngine.executeQueryForExtent(e,t.signal)]}))}))},e.prototype._loadInitialFeatures=function(e,t){for(var i=this._queryEngine,r=i.featureStore,n=i.objectIdField,s=[],a=0,o=t;a<o.length;a++){var u=o[a],l=this._createDefaultAttributes(),d=f.mixAttributes(this._fieldsIndex,this._requiredFields,l,u.attributes,!0,e.warnings);d?e.featureErrors.push(d):(this._assignObjectId(l,u.attributes,!0),u.attributes=l,u.objectId=l[n],s.push(u))}if(r.addMany(s),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){var p=this._queryEngine.timeExtent,c=p.start,y=p.end;e.layerDefinition.timeInfo.timeExtent=[c,y]}return e},e.prototype._applyEdits=function(e){var t=e.adds,i=e.updates,r=e.deletes,n={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(n,t),i&&i.length&&this._applyUpdateEdits(n,i),r&&r.length){for(var s=0,a=r;s<a.length;s++){var o=a[s];n.deleteResults.push(f.createFeatureEditSuccessResult(o))}this._queryEngine.featureStore.removeManyById(r)}return{fullExtent:this._queryEngine.fullExtent,timeExtent:this._queryEngine.timeExtent,featureEditResults:n}},e.prototype._applyAddEdits=function(e,t){for(var i=e.addResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,o=r.hasZ,l=r.objectIdField,p=r.spatialReference,c=r.featureStore,y=[],h=0,g=t;h<g.length;h++){var m=g[h];if(m.geometry&&n!==a.getJsonType(m.geometry))i.push(f.createFeatureEditErrorResult("Incorrect geometry type."));else{var _=this._createDefaultAttributes(),F=f.mixAttributes(this._fieldsIndex,this._requiredFields,_,m.attributes);if(F)i.push(F);else{if(this._assignObjectId(_,m.attributes),m.attributes=_,null!=m.uid){var b=m.attributes[l];e.uidToObjectId[m.uid]=b}m.geometry&&(m.geometry=d.project(f.simplify(m.geometry,p),m.geometry.spatialReference,p)),y.push(m),i.push(f.createFeatureEditSuccessResult(m.attributes[l]))}}}c.addMany(u.convertFromFeatures([],y,n,o,s,l))},e.prototype._applyUpdateEdits=function(e,t){for(var i=e.updateResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,o=r.hasZ,l=r.objectIdField,p=r.spatialReference,c=r.featureStore,y=0,h=t;y<h.length;y++){var g=h[y],m=g.attributes,_=g.geometry,F=m&&m[l];if(null!=F)if(c.has(F)){var b=u.convertToFeature(c.getFeature(F),n,o,s);if(_){if(n!==a.getJsonType(_)){i.push(f.createFeatureEditErrorResult("Incorrect geometry type."));continue}b.geometry=d.project(f.simplify(_,p),_.spatialReference,p)}if(m){var I=f.mixAttributes(this._fieldsIndex,this._requiredFields,b.attributes,m);if(I){i.push(I);continue}}c.add(u.convertFromFeature(b,n,o,s,l)),i.push(f.createFeatureEditSuccessResult(F))}else i.push(f.createFeatureEditErrorResult("Feature with object id "+F+" missing"));else i.push(f.createFeatureEditErrorResult("Identifier field "+l+" missing"))}},e.prototype._assignObjectId=function(e,t,i){void 0===i&&(i=!1);var r=this._queryEngine.objectIdField;i&&isFinite(t[r])?e[r]=t[r]:e[r]=this._nextObjectId++},e.prototype._checkProjection=function(e){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,d.checkProjectionSupport(o.WGS84,e)];case 1:return t.sent(),[3,3];case 2:throw t.sent(),new n("geojson-layer","Projection not supported");case 3:return[2]}}))}))},e}();t.default=F}));