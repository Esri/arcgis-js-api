/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../request","../../../../core/Error","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../featureConversionUtils","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","./geojson","../support/clientSideDefaults","../support/sourceUtils","../../../support/FieldsIndex","../../../support/fieldType","../../../support/fieldUtils"],(function(e,t,i,n,r,s,o,a,u,l,d,p,c,y,f){"use strict";const m={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}};return function(){function h(){this._queryEngine=null}var g=h.prototype;return g.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFields=this._fieldsIndex=this._createDefaultAttributes=null},g.load=function(){var n=e._asyncToGenerator((function*(e){const n=[];yield this._checkProjection(e.spatialReference);let p=null;if(e.url){p=(yield t(e.url,{responseType:"json"})).data,yield l.validateGeoJSON(p)}const h=l.inferLayerProperties(p,{geometryType:e.geometryType}),g=e.fields||h.fields||[],F=null!=e.hasZ?e.hasZ:h.hasZ,b=h.geometryType,I=e.objectIdField||("number"===h.objectIdFieldType?h.objectIdFieldName:"OBJECTID")||"OBJECTID",E=e.spatialReference||r.WGS84;let _=e.timeInfo;if(!b)throw new i("geojson-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if("string"===h.objectIdFieldType&&n.push({name:"geojson-layer:unsupported-id-type",message:"Feature ids are of type string and can't be honored."}),g===h.fields&&h.unknownFields.length>0&&n.push({name:"geojson-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:h.unknownFields}}),I){let e=null;g.some((t=>t.name===I&&(e=t,!0)))?(e.type="esriFieldTypeOID",e.editable=!1,e.nullable=!1):g.unshift({alias:I,name:I,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const t of g){if(null==t.name&&(t.name=t.alias),null==t.alias&&(t.alias=t.name),!t.name)throw new i("geojson-layer:invalid-field-name","field name is missing",{field:t});if(t.name===I&&(t.type="esriFieldTypeOID"),-1===y.kebabDict.jsonValues.indexOf(t.type))throw new i("geojson-layer:invalid-field-type",`invalid type for field "${t.name}"`,{field:t})}const T={};this._requiredFields=[];for(const t of g)if("esriFieldTypeOID"!==t.type&&"esriFieldTypeGlobalID"!==t.type){t.editable=null==t.editable||!!t.editable,t.nullable=null==t.nullable||!!t.nullable;const e=f.getFieldDefaultValue(t);t.nullable||void 0!==e?T[t.name]=e:this._requiredFields.push(t)}if(this._fieldsIndex=new c(g),_){if(_.startTimeField){const e=this._fieldsIndex.get(_.startTimeField);e?(_.startTimeField=e.name,e.type="esriFieldTypeDate"):_.startTimeField=null}if(_.endTimeField){const e=this._fieldsIndex.get(_.endTimeField);e?(_.endTimeField=e.name,e.type="esriFieldTypeDate"):_.endTimeField=null}if(_.trackIdField){const e=this._fieldsIndex.get(_.trackIdField);e?_.trackIdField=e.name:(_.trackIdField=null,n.push({name:"geojson-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:_}}))}_.startTimeField||_.endTimeField||(n.push({name:"geojson-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:_}}),_=null)}const j={warnings:n,featureErrors:[],layerDefinition:{...m,drawingInfo:d.createDrawingInfo(b),templates:d.createDefaultTemplate(T),extent:null,geometryType:b,objectIdField:I,fields:g,hasZ:!!F,timeInfo:_}};this._queryEngine=new u.default({fields:g,geometryType:b,hasM:!1,hasZ:F,objectIdField:I,spatialReference:E,timeInfo:_,featureStore:new o({geometryType:b,hasM:!1,hasZ:F}),cacheSpatialQueries:!0}),this._createDefaultAttributes=d.createDefaultAttributesFunction(T,I),this._nextObjectId=h.maxObjectId+1;const q=l.createOptimizedFeatures(p,{geometryType:b,hasZ:F,objectIdField:"number"===h.objectIdFieldType?I:null});if(!r.equals(E,r.WGS84))for(const t of q)t.geometry&&(t.geometry=s.convertFromGeometry(a.project(s.convertToGeometry(t.geometry,b,F,!1),r.WGS84,E)));return this._loadInitialFeatures(j,q),j}));function p(e){return n.apply(this,arguments)}return p}(),g.applyEdits=function(){var t=e._asyncToGenerator((function*(e){const{spatialReference:t,geometryType:i}=this._queryEngine;return yield Promise.all([p.loadGeometryEngineForSimplify(t,i),a.checkProjectionSupport(e.adds,t),a.checkProjectionSupport(e.updates,t)]),this._applyEdits(e)}));function i(e){return t.apply(this,arguments)}return i}(),g.queryFeatures=function(e={},t={}){return this._queryEngine.executeQuery(e,t.signal)},g.queryFeatureCount=function(e={},t={}){return this._queryEngine.executeQueryForCount(e,t.signal)},g.queryObjectIds=function(e={},t={}){return this._queryEngine.executeQueryForIds(e,t.signal)},g.queryExtent=function(e={},t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)},g.querySnapping=function(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)},g._loadInitialFeatures=function(e,t){const{featureStore:i,objectIdField:n}=this._queryEngine,r=[];for(const s of t){const t=this._createDefaultAttributes(),i=p.mixAttributes(this._fieldsIndex,t,s.attributes,this._requiredFields,!0,e.warnings);i?e.featureErrors.push(i):(this._assignObjectId(t,s.attributes,!0),s.attributes=t,s.objectId=t[n],r.push(s))}if(i.addMany(r),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){const{start:t,end:i}=this._queryEngine.timeExtent;e.layerDefinition.timeInfo.timeExtent=[t,i]}return e},g._applyEdits=function(e){const{adds:t,updates:i,deletes:n}=e,r={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(r,t),i&&i.length&&this._applyUpdateEdits(r,i),n&&n.length){for(const e of n)r.deleteResults.push(p.createFeatureEditSuccessResult(e));this._queryEngine.featureStore.removeManyById(n)}return{fullExtent:this._queryEngine.fullExtent,timeExtent:this._queryEngine.timeExtent,featureEditResults:r}},g._applyAddEdits=function(e,t){const{addResults:i}=e,{geometryType:r,hasM:o,hasZ:u,objectIdField:l,spatialReference:d,featureStore:c}=this._queryEngine,y=[];for(const s of t){if(s.geometry&&r!==n.getJsonType(s.geometry)){i.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),o=p.mixAttributes(this._fieldsIndex,t,s.attributes,this._requiredFields);if(o)i.push(o);else{if(this._assignObjectId(t,s.attributes),s.attributes=t,null!=s.uid){const t=s.attributes[l];e.uidToObjectId[s.uid]=t}s.geometry&&(s.geometry=a.project(p.simplify(s.geometry,d),s.geometry.spatialReference,d)),y.push(s),i.push(p.createFeatureEditSuccessResult(s.attributes[l]))}}c.addMany(s.convertFromFeatures([],y,r,u,o,l))},g._applyUpdateEdits=function({updateResults:e},t){const{geometryType:i,hasM:r,hasZ:o,objectIdField:u,spatialReference:l,featureStore:d}=this._queryEngine;for(const c of t){const{attributes:t,geometry:y}=c,f=t&&t[u];if(null==f){e.push(p.createFeatureEditErrorResult(`Identifier field ${u} missing`));continue}if(!d.has(f)){e.push(p.createFeatureEditErrorResult(`Feature with object id ${f} missing`));continue}const m=s.convertToFeature(d.getFeature(f),i,o,r);if(y){if(i!==n.getJsonType(y)){e.push(p.createFeatureEditErrorResult("Incorrect geometry type."));continue}m.geometry=a.project(p.simplify(y,l),y.spatialReference,l)}if(t){const i=p.mixAttributes(this._fieldsIndex,m.attributes,t,this._requiredFields);if(i){e.push(i);continue}}d.add(s.convertFromFeature(m,i,o,r,u)),e.push(p.createFeatureEditSuccessResult(f))}},g._assignObjectId=function(e,t,i=!1){const n=this._queryEngine.objectIdField;i&&isFinite(t[n])?e[n]=t[n]:e[n]=this._nextObjectId++},g._checkProjection=function(){var t=e._asyncToGenerator((function*(e){try{yield a.checkProjectionSupport(r.WGS84,e)}catch{throw new i("geojson-layer","Projection not supported")}}));function n(e){return t.apply(this,arguments)}return n}(),h}()}));
