// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/Error","../../OptimizedFeature","../../OptimizedGeometry"],(function(e,r,t,n,o,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.createOptimizedFeatures=r.inferLayerProperties=r.validateGeoJSON=void 0;var i={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function u(e){var r,n,o;return t.__generator(this,(function(t){switch(t.label){case 0:switch(e.type){case"Feature":return[3,1];case"FeatureCollection":return[3,3]}return[3,7];case 1:return[4,e];case 2:return t.sent(),[3,7];case 3:r=0,n=e.features,t.label=4;case 4:return r<n.length?(o=n[r])?[4,o]:[3,6]:[3,7];case 5:t.sent(),t.label=6;case 6:return r++,[3,4];case 7:return[2]}}))}function s(e,r){var n,u,s,l,c,y,v,h;return void 0===r&&(r={}),t.__generator(this,(function(t){switch(t.label){case 0:n=r.geometryType,u=r.objectIdFieldName,t.label=1;case 1:return s=e.next(),l=s.value,s.done?[2]:(c=l.geometry,y=l.properties,v=l.id,c&&i[c.type]!==n?[3,1]:(h=y||{},u&&null!=v&&!h[u]&&(h[u]=v),[4,new o.default(c?function(e,r,t){switch(r.type){case"LineString":return function(e,r,t){return p(e,r.coordinates,t),e}(e,r,t);case"MultiLineString":return function(e,r,t){for(var n=0,o=r.coordinates;n<o.length;n++){var a=o[n];p(e,a,t)}return e}(e,r,t);case"MultiPoint":return function(e,r,t){return p(e,r.coordinates,t),e}(e,r,t);case"MultiPolygon":return function(e,r,t){for(var n=0,o=r.coordinates;n<o.length;n++){var a=o[n];f(e,a[0],t);for(var i=1;i<a.length;i++)d(e,a[i],t)}return e}(e,r,t);case"Point":return function(e,r,t){return g(e,r.coordinates,t),e}(e,r,t);case"Polygon":return function(e,r,t){var n=r.coordinates;f(e,n[0],t);for(var o=1;o<n.length;o++)d(e,n[o],t);return e}(e,r,t)}}(new a.default,c,r):null,h)]));case 2:return t.sent(),[3,1];case 3:return[2]}}))}function l(e){for(var r=0,t=0;t<e.length;t++){var n=e[t],o=e[(t+1)%e.length];r+=n[0]*o[1]-o[0]*n[1]}return r<=0}function c(e){var r=e[0],t=e[e.length-1];return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]||e.push(r),e}function f(e,r,t){var n=c(r);l(n)?p(e,n,t):y(e,n,t)}function d(e,r,t){var n=c(r);l(n)?y(e,n,t):p(e,n,t)}function p(e,r,t){for(var n=0,o=r;n<o.length;n++){g(e,o[n],t)}e.lengths.push(r.length)}function y(e,r,t){for(var n=r.length-1;n>=0;n--)g(e,r[n],t);e.lengths.push(r.length)}function g(e,r,t){var n=r[0],o=r[1],a=r[2];e.coords.push(n,o),t.hasZ&&e.coords.push(a||0)}function v(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}r.validateGeoJSON=function(e){if(!e)throw new n("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new n("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});var r=e.crs;if(r){var t="string"==typeof r?r:"name"===r.type?r.properties.name:null,o=new RegExp(".*(CRS84H?|4326)$","i");if(!t||!o.test(t))throw new n("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:r})}},r.inferLayerProperties=function(e,r){void 0===r&&(r={});for(var n=u(e),o=[],a=new Set,s=new Set,l=!1,c=Number.NEGATIVE_INFINITY,f=null,d=!1,p=void 0,y=r.geometryType,g=void 0===y?null:y,h=!1,m=function(){var e,r,u=n.next(),y=u.value;if(u.done){var m=f&&1===f.length&&f[0]||null;if(m)for(var b=0,w=o;b<w.length;b++){var P=w[b];P.name===m&&(P.type="esriFieldTypeOID")}return{value:{fields:o,geometryType:g,hasZ:l,maxObjectId:Math.max(0,c),objectIdFieldName:m,objectIdFieldType:p,unknownFields:(e=s,r=[],e.forEach((function(e){return r.push(e)})),r)}}}var F=y.geometry,S=y.properties,_=y.id;if(F&&(g||(g=i[F.type]),i[F.type]!==g))return"continue";if(!l){var j=function(e){var r,n,o,a,i,u,s,l,c;return t.__generator(this,(function(f){switch(f.label){case 0:if(!e)return[2,null];switch(e.type){case"Point":return[3,1];case"LineString":case"MultiPoint":return[3,3];case"MultiLineString":case"Polygon":return[3,5];case"MultiPolygon":return[3,10]}return[3,17];case 1:return[4,e.coordinates];case 2:return f.sent(),[3,17];case 3:return[5,t.__values(e.coordinates)];case 4:return f.sent(),[3,17];case 5:r=0,n=e.coordinates,f.label=6;case 6:return r<n.length?(o=n[r],[5,t.__values(o)]):[3,9];case 7:f.sent(),f.label=8;case 8:return r++,[3,6];case 9:return[3,17];case 10:a=0,i=e.coordinates,f.label=11;case 11:if(!(a<i.length))return[3,16];u=i[a],s=0,l=u,f.label=12;case 12:return s<l.length?(c=l[s],[5,t.__values(c)]):[3,15];case 13:f.sent(),f.label=14;case 14:return s++,[3,12];case 15:return a++,[3,11];case 16:return[3,17];case 17:return[2]}}))}(F);l=function(e){for(;;){var r=e.next(),t=r.value;if(r.done)return!1;if(t.length>2)return!0}}(j)}if(d||(d=null!=_)&&"number"===(p=typeof _)&&(f=Object.keys(S).filter((function(e){return S[e]===_}))),d&&"number"===p&&null!=_&&(c=Math.max(c,_),f.length>1?f=f.filter((function(e){return S[e]===_})):1===f.length&&(f=S[f[0]]===_?f:[])),!h&&S){var G=!0;for(var M in S)if(!a.has(M)){var O=S[M];if(null!=O){var N=v(O);"unknown"!==N?(s.delete(M),a.add(M),o.push({name:M,alias:M,type:N})):s.add(M)}else G=!1,s.add(M)}h=G}};;){var b=m();if("object"==typeof b)return b.value}},r.createOptimizedFeatures=function(e,r){return function(e){for(var r=[];;){var t=e.next(),n=t.value;if(t.done)return r;r.push(n)}}(s(u(e),r))}}));