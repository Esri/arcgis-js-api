// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/compilerUtils","../../../core/Error","../../../core/Handles","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../support/arcgisLayerUrl","../../../portal/support/geometryServiceUtils","../../../tasks/support/StatisticDefinition","../../../views/3d/layers/support/FeatureTileFetcher3D","../../../views/3d/layers/support/FeatureTileFetcher3DDebugger","../../../views/3d/support/debugFlags","../../../views/support/WatchUpdatingTracking"],(function(e,t,r,i,a,n,o,s,c,l,u,p,h,d,m,f,y,g,v,F,x,b,_){"use strict";var T=u.getLogger("esri.layers.graphics.controllers.FeatureTileController3D"),E=function(e){function t(t){var r=e.call(this,t)||this;return r.type="feature-tile-3d",r.watchUpdatingTracking=new _.WatchUpdatingTracking,r.serviceDataExtent=null,r.serviceDataCount=i.constants.NO_SERVICE_DATA_COUNT,r.vertexLimitExceeded=!1,r.displayFeatureLimit=null,r.suspended=!1,r.tileFetcher=null,r.handles=new c,r.fetchDataInfoPromise=null,r.fetchDataInfoAbortController=null,r.lifeCycleAbortController=d.createAbortController(),r}var i;return r.__extends(t,e),i=t,Object.defineProperty(t.prototype,"extent",{set:function(e){if(!e||e.spatialReference.equals(this.layerView.view.spatialReference)){var t=this._get("extent");if(t!==e&&!(t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("extent",r)}}else T.error("#extent=","extent needs to be in the same spatial reference as the view")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.tileFetcher&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.updatingTotal:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.updatingRemaining:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"expectedFeatureDiff",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.expectedFeatureDiff:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"memoryForUnusedFeatures",{get:function(){return this.tileFetcher?this.tileFetcher.memoryForUnusedFeatures:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!(!this.tileFetcher||!this.tileFetcher.maximumNumberOfFeaturesExceeded)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"filteredDataExtent",{get:function(){return this.extent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){return this.displayFeatureLimit?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&(null==e?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasMaximumNumberOfFeaturesOverride",{get:function(){return this._isOverridden("maximumNumberOfFeatures")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(this.serviceDataCount===i.constants.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var e=this.layerView,t=e.layer,r=e.view,a=r&&r.featureTiles,n=a&&a.tilingScheme;if(t&&t.minScale&&this.serviceDataExtent&&n){var o=this.approximateExtentSizeAtScale(t.minScale,n);if((this.serviceDataExtent.width/o+this.serviceDataExtent.height/o)/2>i.constants.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxTotalSnapshotVertices",{get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&this.tileFetcher&&this.tileFetcher.totalVertices||0;return Math.max(e,t)},enumerable:!1,configurable:!0}),t.prototype.approximateExtentSizeAtScale=function(e,t){var r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),a=t.levels[0];return i*((a.tileSize[0]/(a.scale/e)+a.tileSize[1]/(a.scale/e))/2)},Object.defineProperty(t.prototype,"tileDescriptors",{get:function(){return"snapshot"===this.mode?new n([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}},enumerable:!1,configurable:!0}),t.prototype.initialize=function(){var e=this;this.watchUpdatingTracking.add(this,"vertexLimitInfo",(function(){return e.watchUpdatingTracking.addPromise(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))})),this.watchUpdatingTracking.add(this,"mode",(function(){return e.modeChanged()}),2),this.addResolvingPromise(d.resolve().then((function(){return e.verifyCapabilities()})).then((function(){return e.watchUpdatingTracking.addPromise(e.fetchServiceDataInfo())})).then((function(){return e.initializeTileFetcher()})))},t.prototype.verifyCapabilities=function(){var e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery"))throw new s("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})},t.prototype.destroy=function(){this.cancelFetchServiceDataInfo(),this.tileFetcher&&(this.tileFetcher.destroy(),this.tileFetcher=null),this.handles&&(this.handles.destroy(),this.handles=null),this.tilesHandle&&(this.tilesHandle.remove(),this.tilesHandle=null),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)},t.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.tileFetcher&&this.tileFetcher.suspend())},t.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.tileFetcher&&this.tileFetcher.resume())},t.prototype.restart=function(){var e=this,t=function(){e.tileFetcher&&e.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(t,t))},t.prototype.refetch=function(){var e=this,t=function(){e.tileFetcher&&e.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(t,t))},t.prototype.initializeTileFetcher=function(){var e=this,t=this.layerView.view;if(t){var r=m.whenOnce(t.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(r),r.then((function(){var r=e,i=r.layerView,a=r.tileDescriptors,n=i.layer;e.tileFetcher=new F.FeatureTileFetcher3D({context:e.context,filterExtent:e.filteredDataExtent,tileDescriptors:a,features:e.graphics}),e.suspended?e.tileFetcher.suspend():e.tileFetcher.resume();var o=e.layerView.view.resourceController;o&&(e.handles.add(o.memoryController.events.on("quality-changed",(function(t){e.tileFetcher.memoryFactor=t}))),e.tileFetcher.memoryFactor=o.memoryController.memoryFactor);var s="polygon"===e.context.geometryType?"polygonLodFactor":"polyline"===e.context.geometryType?"polylineLodFactor":null;s&&e.handles.add(m.init(e.layerView.view,"qualitySettings.graphics3D."+s,(function(t){e.tileFetcher.lodFactor=t||1})));e.watchUpdatingTracking.add(n,"createQueryVersion",(function(){return e.dataFilterChanged()})),e.watchUpdatingTracking.add(i,"availableFields",(function(t,r){return e.availableFieldsChanged(r,t)})),e.watchUpdatingTracking.add(i,"requiredFields",(function(t,r){return e.requiredFieldsChanged(r,t)})),e.handles.add([n.on("apply-edits",(function(t){return e.applyEdits(t)})),e.watch("filteredDataExtent",(function(t){return e.tileFetcher.filterExtent=t}),!0),e.watch("tileDescriptors",(function(t){return e.tileFetcher.tileDescriptors=t}),!0),m.init(e,"maximumNumberOfFeatures",(function(t){e.tileFetcher.maximumNumberOfFeatures=t,e.tileFetcher.useTileCount=e.serviceDataCount>t}),!0),m.init(e,"serviceDataCount",(function(t){return e.tileFetcher.useTileCount=t>e.maximumNumberOfFeatures}),!0),m.init(b,"FEATURE_TILE_FETCH_SHOW_TILES",(function(r){r&&e.tileFetcher&&!e.tileFetcher.debugger?(e.tileFetcher.debugger=new x.FeatureTileFetcher3DDebugger(e.tileFetcher,t.featureTiles.tilingScheme.toTileInfo(),t),e.tileFetcher.debugger.update()):!r&&e.tileFetcher&&e.tileFetcher.debugger&&(e.tileFetcher.debugger.destroy(),e.tileFetcher.debugger=null)}))]),e.supportsExceedsLimitQuery||e.watchUpdatingTracking.add(e,"maxTotalSnapshotVertices",(function(){return e.watchUpdatingTracking.addPromise(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))}))})).catch((function(){}))}},t.prototype.modeChanged=function(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:T.warn("Unhandled feature layer mode "+this.mode);case"snapshot":this.tilesHandle&&(this.tilesHandle.remove(),this.tilesHandle=null)}},t.prototype.dataFilterChanged=function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()},t.prototype.applyEdits=function(e){var t=this;this.tileFetcher.applyEdits(e).then((function(e){e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t.watchUpdatingTracking.addPromise(t.updateServiceDataExtent(t.lifeCycleAbortController.signal))}))},t.prototype.availableFieldsChanged=function(e,t){this.tileFetcher&&O(this.tileFetcher.availableFields,t)&&this.refetch()},t.prototype.requiredFieldsChanged=function(e,t){this.tileFetcher&&O(this.tileFetcher.availableFields,t)&&this.restart()},t.prototype.createVertexLimitExceededQuery=function(e){var t=this.layerView.layer,r=t.createQuery();return r.outStatistics=[new v({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(r.cacheHint=!0),r},t.prototype.createDataInfoQuery=function(){var e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t},t.prototype.fullExtentIsAccurate=function(){var e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return y.isHostedAgolService(e.url);case"csv":case"geojson":case"ogc-feature":return!0;default:return void o.neverReached(e)}},t.prototype.updateServiceDataExtent=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.tryUpdateServiceDataExtent(e)];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),d.isAbortError(t)||this._set("serviceDataExtent",l.clone(this.layerView.fullExtentInLocalViewSpatialReference)),[3,3];case 3:return[2]}}))}))},t.prototype.tryUpdateServiceDataExtent=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,a,n,o,s,c,u,p,h,d,m;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.layerView,a=t.layer,n=a.capabilities.query.supportsExtent,o=l.clone(t.fullExtentInLocalViewSpatialReference),s=a.fullExtent,c=this.fullExtentIsAccurate(),u=this.serviceDataCount,n&&u<=i.constants.MAX_FEATURE_COUNT_FOR_EXTENT&&(!o||!c)&&"queryExtent"in a?(p=this.createDataInfoQuery(),[4,a.queryExtent(p,{timeout:i.constants.QUERY_EXTENT_TIMEOUT,signal:e})]):[3,2];case 1:return h=r.sent(),this._set("serviceDataExtent",h.extent),[3,6];case 2:return o?(this._set("serviceDataExtent",o),[3,6]):[3,3];case 3:return s?(d="portalItem"in a?a.portalItem:null,[4,g.projectGeometry(s,t.view.spatialReference,d,e)]):[3,5];case 4:return m=r.sent(),this._set("serviceDataExtent",m),[3,6];case 5:this._set("serviceDataExtent",null),r.label=6;case 6:return[2]}}))}))},t.prototype.updateServiceDataCount=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return"queryFeatureCount"in(t=this.layerView.layer)?[4,a.result(t.queryFeatureCount(this.createDataInfoQuery(),{timeout:i.constants.QUERY_STATISTICS_TIMEOUT,signal:e}))]:(o=i.constants.NO_SERVICE_DATA_COUNT,this._set("serviceDataCount",o),[2]);case 1:if(!0===(n=r.sent()).ok)this._set("serviceDataCount",n.value);else{if(d.isAbortError(n.error))throw n.error;o=i.constants.NO_SERVICE_DATA_COUNT,this._set("serviceDataCount",o)}return[2]}}))}))},Object.defineProperty(t.prototype,"vertexLimitInfo",{get:function(){if(!this.displayFeatureLimit||!this.displayFeatureLimit.maximumSymbolComplexity)return null;var e=this.displayFeatureLimit,t=e.maximumSymbolComplexity,r=e.maximumTotalNumberOfPrimitives,i=t.primitivesPerCoordinate,a=t.primitivesPerFeature,n=this._get("vertexLimitInfo");return p.isNone(n)||n.maximumTotalNumberOfPrimitives!==r||n.primitivesPerCoordinate!==i||n.primitivesPerFeature!==a?{primitivesPerCoordinate:i,primitivesPerFeature:a,maximumTotalNumberOfPrimitives:r}:n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportsExceedsLimitQuery",{get:function(){var e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"minimumNumberOfVerticesForGeometry",{get:function(){var e=this.layerView.layer.geometryType;switch(e){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return o.neverReached(e),0}},enumerable:!1,configurable:!0}),t.prototype.updateVertexLimitExceeded=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,o,s,c,l,u,h,m,f,y,g,v,F,x;return r.__generator(this,(function(r){switch(r.label){case 0:return n=p.isSome(this.vertexLimitInfo)&&this.vertexLimitInfo.primitivesPerFeature<=0,o=this.minimumNumberOfVerticesForGeometry>1,s=this.layerView.layer,c=this.supportsExceedsLimitQuery,p.isNone(this.vertexLimitInfo)||!n&&!o?(this._set("vertexLimitExceeded",!1),[2]):(l=this.vertexLimitInfo,u=l.primitivesPerFeature,h=l.primitivesPerCoordinate,m=l.maximumTotalNumberOfPrimitives,0!==u&&p.isSome(e)?[4,e]:[3,2]);case 1:r.sent(),r.label=2;case 2:return f=this.serviceDataCount,g=f!==i.constants.NO_SERVICE_DATA_COUNT,y=g?Math.ceil((m-f*u)/(h||1)):Math.ceil(m/(h||1)),o&&(y=Math.min(y,w)),g&&this.minimumNumberOfVerticesForGeometry*f>y?(this._set("vertexLimitExceeded",!0),[2]):c?[4,a.result(s.queryFeatures(this.createVertexLimitExceededQuery(y),{timeout:i.constants.QUERY_STATISTICS_TIMEOUT,signal:t}))]:(this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>y),[2]);case 3:if(!1===(v=r.sent()).ok){if(d.isAbortError(v.error))throw v.error;return this._set("vertexLimitExceeded",!1),[2]}return F=v.value,(x=F.features[0])&&x.attributes?this._set("vertexLimitExceeded",!!x.attributes.exceedslimit):this._set("vertexLimitExceeded",!1),[2]}}))}))},t.prototype.fetchServiceDataInfo=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,a,n,o=this;return r.__generator(this,(function(r){return this.cancelFetchServiceDataInfo(),e=d.createAbortController(),t=e.signal,i=this.updateServiceDataCount(t),a=d.eachAlways([i,this.updateVertexLimitExceeded(i,t)]),n=a.then((function(){return o.updateServiceDataExtent(t)})).catch((function(e){d.isAbortError(e)||T.error("#fetchServiceDataInfo()",e)})).then((function(){n===o.fetchDataInfoPromise&&(o.fetchDataInfoPromise=null,o.fetchDataInfoAbortController=null),e=null})),e&&(this.fetchDataInfoPromise=n),this.fetchDataInfoAbortController=e,[2,a.then((function(){}),(function(){}))]}))}))},t.prototype.cancelFetchServiceDataInfo=function(){var e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())},Object.defineProperty(t.prototype,"debug",{get:function(){return{storedFeatures:this.tileFetcher?this.tileFetcher.storedFeatures:0,totalFeatures:this.tileFetcher?this.tileFetcher.totalFeatures:0,totalVertices:this.tileFetcher?this.tileFetcher.totalVertices:0}},enumerable:!1,configurable:!0}),r.__decorate([f.property({readOnly:!0})],t.prototype,"type",void 0),r.__decorate([f.property({constructOnly:!0})],t.prototype,"graphics",void 0),r.__decorate([f.property({constructOnly:!0})],t.prototype,"layerView",void 0),r.__decorate([f.property({constructOnly:!0})],t.prototype,"context",void 0),r.__decorate([f.property()],t.prototype,"extent",null),r.__decorate([f.property({dependsOn:["tileFetcher.updating","mode","layerView.view.featureTiles.updating","fetchDataInfoPromise","watchUpdatingTracking.updating"]})],t.prototype,"updating",null),r.__decorate([f.property({readOnly:!0})],t.prototype,"watchUpdatingTracking",void 0),r.__decorate([f.property({dependsOn:["updating","tileFetcher.updatingTotal"]})],t.prototype,"updatingTotal",null),r.__decorate([f.property({dependsOn:["updating","tileFetcher.updatingRemaining"]})],t.prototype,"updatingRemaining",null),r.__decorate([f.property({dependsOn:["updating","tileFetcher.expectedFeatureDiff"]})],t.prototype,"expectedFeatureDiff",null),r.__decorate([f.property({dependsOn:["tileFetcher.memoryForUnusedFeatures"]})],t.prototype,"memoryForUnusedFeatures",null),r.__decorate([f.property({dependsOn:["tileFetcher.maximumNumberOfFeaturesExceeded"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([f.property({readOnly:!0})],t.prototype,"serviceDataExtent",void 0),r.__decorate([f.property({readOnly:!0})],t.prototype,"serviceDataCount",void 0),r.__decorate([f.property({readOnly:!0})],t.prototype,"vertexLimitExceeded",void 0),r.__decorate([f.property({readOnly:!0,dependsOn:["extent"]})],t.prototype,"filteredDataExtent",null),r.__decorate([f.property()],t.prototype,"displayFeatureLimit",void 0),r.__decorate([f.property({type:Number,dependsOn:["displayFeatureLimit"]})],t.prototype,"maximumNumberOfFeatures",null),r.__decorate([f.property({readOnly:!0,dependsOn:["serviceDataCount","displayFeatureLimit","maximumNumberOfFeatures","vertexLimitExceeded","serviceDataExtent","layerView.layer.minScale","layerView.view.featureTiles.tilingScheme"]})],t.prototype,"mode",null),r.__decorate([f.property({readOnly:!0,dependsOn:["mode","tileFetcher.totalVertices"]})],t.prototype,"maxTotalSnapshotVertices",null),r.__decorate([f.property({readOnly:!0,dependsOn:["mode"]})],t.prototype,"tileDescriptors",null),r.__decorate([f.property()],t.prototype,"tileFetcher",void 0),r.__decorate([f.property()],t.prototype,"fetchDataInfoPromise",void 0),r.__decorate([f.property({readOnly:!0,dependsOn:["displayFeatureLimit"]})],t.prototype,"vertexLimitInfo",null),t=i=r.__decorate([f.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],t)}(h.EsriPromiseMixin(i)),w=5e6;function O(e,t){if(!t)return!1;for(var r=0,i=t;r<i.length;r++){var a=i[r];if(!e.has(a))return!0}return!1}return function(e){!function(e){e.NO_SERVICE_DATA_COUNT=1/0,e.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,e.reset=function(){e.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,e.QUERY_STATISTICS_TIMEOUT=12e3,e.QUERY_EXTENT_TIMEOUT=1e4}}(e.constants||(e.constants={}))}(E||(E={})),E.constants.reset(),E}));