/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/has","../../../core/Error","../../../core/Handles","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../support/arcgisLayerUrl","../../../portal/support/geometryServiceUtils","../../../rest/support/StatisticDefinition","../../../views/3d/layers/support/FeatureTileFetcher3D","../../../views/3d/layers/support/FeatureTileFetcher3DDebugger","../../../views/3d/support/debugFlags","../../../views/support/WatchUpdatingTracking"],(function(e,t,i,r,a,s,o,n,l,c,u,h,d,p,m,y,f,F,_,g,T,C,v,x,D){"use strict";const E=u.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");e.FeatureTileController3D=function(i){function r(t){var r;return(r=i.call(this,t)||this).type="feature-tile-3d",r.watchUpdatingTracking=new D.WatchUpdatingTracking,r.serviceDataExtent=null,r.serviceDataCount=e.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT,r.vertexLimitExceeded=!1,r.displayFeatureLimit=null,r.suspended=!1,r.tileFetcher=null,r.handles=new l,r.fetchDataInfoPromise=null,r.fetchDataInfoAbortController=null,r.lifeCycleAbortController=new AbortController,r}t._inheritsLoose(r,i);var o=r.prototype;return o._approximateExtentSizeAtScale=function(e,t){const i=this.layerView.view,r=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),a=t.levels[0];return r*((a.tileSize[0]/(a.scale/e)+a.tileSize[1]/(a.scale/e))/2)},o.initialize=function(){this.watchUpdatingTracking.add((()=>this.vertexLimitInfo),(()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))),this.watchUpdatingTracking.add((()=>this.mode),(()=>this._modeChanged()),m.initial),this.addResolvingPromise(Promise.resolve().then((()=>this._verifyCapabilities())).then((()=>this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo()))).then((()=>this._initializeTileFetcher())))},o._verifyCapabilities=function(){const e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==e.type)throw new n("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})},o.destroy=function(){this._cancelFetchServiceDataInfo(),this.tileFetcher=h.destroyMaybe(this.tileFetcher),this.handles=h.destroyMaybe(this.handles),this.tilesHandle=h.removeMaybe(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)},o.suspend=function(){this.suspended||(this.suspended=!0,h.isSome(this.tileFetcher)&&this.tileFetcher.suspend())},o.resume=function(){this.suspended&&(this.suspended=!1,h.isSome(this.tileFetcher)&&this.tileFetcher.resume())},o.restart=function(){const e=()=>{h.isSome(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(e,e))},o.refetch=function(){const e=()=>{h.isSome(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(e,e))},o._initializeTileFetcher=function(){const e=this.layerView.view;if(!e)return;const t=m.whenOnce((()=>{var t;return null==(t=e.featureTiles)?void 0:t.tilingScheme}),this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(t),t.then((()=>{const{layerView:t,tileDescriptors:i}=this,r=t.layer,a=new C.FeatureTileFetcher3D({context:this.context,filterExtent:this.extent,tileDescriptors:i,features:this.graphics});this.tileFetcher=a,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const s=this.layerView.view.resourceController;s&&(this.handles.add(s.memoryController.events.on("quality-changed",(e=>{a.memoryFactor=e}))),this.tileFetcher.memoryFactor=s.memoryController.memoryFactor);const o="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;o&&this.handles.add(m.watch((()=>{var e,t,i;return null==(e=this.layerView.view)||null==(t=e.qualitySettings)||null==(i=t.graphics3D)?void 0:i[o]}),(e=>a.lodFactor=e||1),m.initial));const n=e=>{a.maximumNumberOfFeatures=e,a.useTileCount=this.serviceDataCount>e},l=e=>a.useTileCount=e>this.maximumNumberOfFeatures;"ogc-feature"!==r.type&&this.watchUpdatingTracking.add((()=>r.createQueryVersion),(()=>this._dataFilterChanged())),this.watchUpdatingTracking.add((()=>t.availableFields),((e,t)=>this._availableFieldsChanged(t,e))),this.watchUpdatingTracking.add((()=>t.requiredFields),((e,t)=>this._requiredFieldsChanged(t,e))),this.handles.add([r.on("apply-edits",(e=>this._applyEdits(e))),this.watch("extent",(e=>a.filterExtent=e),!0),this.watch("tileDescriptors",(e=>a.tileDescriptors=e),!0),m.watch((()=>this.maximumNumberOfFeatures),n,m.syncAndInitial),m.watch((()=>this.serviceDataCount),l,m.syncAndInitial),m.watch((()=>x.FEATURE_TILE_FETCH_SHOW_TILES),(t=>{t&&a&&!a.debugger?(a.debugger=new v.FeatureTileFetcher3DDebugger(a,e.featureTiles.tilingScheme.toTileInfo(),e),a.debugger.update()):!t&&this.tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)}),m.syncAndInitial)]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add((()=>this.maxTotalSnapshotVertices),(()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))))})).catch((()=>{}))},o._modeChanged=function(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:E.warn("Unhandled feature layer mode "+this.mode);case"snapshot":h.isSome(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}},o._dataFilterChanged=function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()},o._applyEdits=function(e){h.isNone(this.tileFetcher)||this.tileFetcher.applyEdits(e).then((e=>{e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this.lifeCycleAbortController.signal))})).catch((e=>{if(!p.isAbortError(e))throw e}))},o._availableFieldsChanged=function(e,t){h.isSome(this.tileFetcher)&&I(this.tileFetcher.availableFields,t)&&this.refetch()},o._requiredFieldsChanged=function(e,t){h.isSome(this.tileFetcher)&&I(this.tileFetcher.availableFields,t)&&this.restart()},o._createVertexLimitExceededQuery=function(e){const t=this.layerView.layer,i=t.createQuery();return i.outStatistics=[new T({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(i.cacheHint=!0),i},o._createDataInfoQuery=function(){const e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t},o._fullExtentIsAccurate=function(){const e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return _.isHostedAgolService(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}},o._updateServiceDataExtent=function(){var e=t._asyncToGenerator((function*(e){try{yield this._tryUpdateServiceDataExtent(e)}catch(t){p.isAbortError(t)||this._set("serviceDataExtent",c.clone(this.layerView.fullExtentInLocalViewSpatialReference))}}));function i(t){return e.apply(this,arguments)}return i}(),o._tryUpdateServiceDataExtent=function(){var i=t._asyncToGenerator((function*(t){const i=this.layerView,r=i.layer,a=r.capabilities.query.supportsExtent,s=c.clone(i.fullExtentInLocalViewSpatialReference),o=r.fullExtent,n=this._fullExtentIsAccurate(),l=this.serviceDataCount;if(a&&l<=e.FeatureTileController3DConstants.MAX_FEATURE_COUNT_FOR_EXTENT&&(!s||!n)&&"queryExtent"in r){const i=this._createDataInfoQuery(),a=yield r.queryExtent(i,{timeout:e.FeatureTileController3DConstants.QUERY_EXTENT_TIMEOUT,signal:t});this._set("serviceDataExtent",a.extent)}else if(s)this._set("serviceDataExtent",s);else if(h.isSome(o)){const e="portalItem"in r?r.portalItem:null,a=yield g.projectGeometry(o,i.view.spatialReference,e,t);this._set("serviceDataExtent",a)}else this._set("serviceDataExtent",null)}));function r(e){return i.apply(this,arguments)}return r}(),o._updateServiceDataCount=function(){var i=t._asyncToGenerator((function*(t){const i=this.layerView.layer;if(!("queryFeatureCount"in i))return void this._set("serviceDataCount",e.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT);const r=yield a.result(i.queryFeatureCount(this._createDataInfoQuery(),{timeout:e.FeatureTileController3DConstants.QUERY_STATISTICS_TIMEOUT,signal:t}));if(!0===r.ok)this._set("serviceDataCount",r.value);else{if(p.isAbortError(r.error))throw r.error;this._set("serviceDataCount",e.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT)}}));function r(e){return i.apply(this,arguments)}return r}(),o._updateVertexLimitExceeded=function(){var i=t._asyncToGenerator((function*(t,i){const r=this.vertexLimitInfo;if(h.isNone(r))return void this._set("vertexLimitExceeded",!1);const s=r.primitivesPerFeature<=0,o=this.minimumNumberOfVerticesForGeometry>1;if(!s&&!o)return void this._set("vertexLimitExceeded",!1);const{primitivesPerFeature:n,primitivesPerCoordinate:l,maximumTotalNumberOfPrimitives:c}=r;let u;0!==n&&h.isSome(t)&&(yield t);const d=this.serviceDataCount,m=d!==e.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT;if(u=m?Math.ceil((c-d*n)/(l||1)):Math.ceil(c/(l||1)),o&&(u=Math.min(u,O)),m&&this.minimumNumberOfVerticesForGeometry*d>u)return void this._set("vertexLimitExceeded",!0);if(!this.supportsExceedsLimitQuery)return void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>u);const y=yield a.result(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(u),{timeout:e.FeatureTileController3DConstants.QUERY_STATISTICS_TIMEOUT,signal:i}));if(!1===y.ok){if(p.isAbortError(y.error))throw y.error;return void this._set("vertexLimitExceeded",!1)}const f=y.value.features[0];f&&f.attributes?this._set("vertexLimitExceeded",!!f.attributes.exceedslimit):this._set("vertexLimitExceeded",!1)}));function r(e,t){return i.apply(this,arguments)}return r}(),o._fetchServiceDataInfo=function(){var e=t._asyncToGenerator((function*(){this._cancelFetchServiceDataInfo();let e=new AbortController;const t=e.signal,i=this._updateServiceDataCount(t),r=p.eachAlways([i,this._updateVertexLimitExceeded(i,t)]),a=r.then((()=>this._updateServiceDataExtent(t))).catch((e=>{p.isAbortError(e)||E.error("#fetchServiceDataInfo()",e)})).then((()=>{a===this.fetchDataInfoPromise&&(this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null),e=null}));return e&&(this.fetchDataInfoPromise=a),this.fetchDataInfoAbortController=e,r.then((()=>{}),(()=>{}))}));function i(){return e.apply(this,arguments)}return i}(),o._cancelFetchServiceDataInfo=function(){const e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())},t._createClass(r,[{key:"extent",set:function(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void E.error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e)return;if(t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("extent",i)}},{key:"updating",get:function(){return!!(h.isSome(this.tileFetcher)&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&h.isSome(this.tileFetcher)?this.tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&h.isSome(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&h.isSome(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return h.isSome(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!h.isSome(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return h.isSome(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&(null==e?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var t,i;const r=this.layerView.layer;if("feature"===r.type&&h.isSome(r.infoFor3D))return"snapshot";if(!1===(null==(t=this.layerView.view.qualitySettings)||null==(i=t.graphics3D)?void 0:i.snapshotAvailable)||this.serviceDataCount===e.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const a=this.layerView.view,s=a&&a.featureTiles,o=s&&s.tilingScheme;if(r&&r.minScale&&this.serviceDataExtent&&o){const t=this._approximateExtentSizeAtScale(r.minScale,o);if((this.serviceDataExtent.width/t+this.serviceDataExtent.height/t)/2>e.FeatureTileController3DConstants.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){const e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&h.isSome(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new s([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new s}},{key:"test",get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}},{key:"vertexLimitInfo",get:function(){if(h.isNone(this.displayFeatureLimit)||h.isNone(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:e,maximumTotalNumberOfPrimitives:t}=this.displayFeatureLimit,{primitivesPerCoordinate:i,primitivesPerFeature:r}=e,a=this._get("vertexLimitInfo");return h.isNone(a)||a.maximumTotalNumberOfPrimitives!==t||a.primitivesPerCoordinate!==i||a.primitivesPerFeature!==r?{primitivesPerCoordinate:i,primitivesPerFeature:r,maximumTotalNumberOfPrimitives:t}:a}},{key:"supportsExceedsLimitQuery",get:function(){const e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}},{key:"minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}},{key:"debug",get:function(){return{storedFeatures:h.isSome(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:h.isSome(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:h.isSome(this.tileFetcher)?this.tileFetcher.totalVertices:0}}}]),r}(d.EsriPromiseMixin(r)),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"type",void 0),i.__decorate([y.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"graphics",void 0),i.__decorate([y.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"layerView",void 0),i.__decorate([y.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"context",void 0),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"extent",null),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"updating",null),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"watchUpdatingTracking",void 0),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"updatingTotal",null),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"updatingRemaining",null),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"expectedFeatureDiff",null),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"memoryForUnusedFeatures",null),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"maximumNumberOfFeaturesExceeded",null),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"serviceDataExtent",void 0),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"serviceDataCount",void 0),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"vertexLimitExceeded",void 0),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"displayFeatureLimit",void 0),i.__decorate([y.property({type:Number})],e.FeatureTileController3D.prototype,"maximumNumberOfFeatures",null),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"mode",null),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"maxTotalSnapshotVertices",null),i.__decorate([y.property({readOnly:!0,dependsOn:["mode"]})],e.FeatureTileController3D.prototype,"tileDescriptors",null),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"tileFetcher",void 0),i.__decorate([y.property()],e.FeatureTileController3D.prototype,"fetchDataInfoPromise",void 0),i.__decorate([y.property({readOnly:!0})],e.FeatureTileController3D.prototype,"vertexLimitInfo",null),e.FeatureTileController3D=i.__decorate([F.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],e.FeatureTileController3D);const S=1e4,w=12e3,b=1e4,O=5e6;function I(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}e.FeatureTileController3DConstants=void 0,function(e){function t(){e.MAX_FEATURE_COUNT_FOR_EXTENT=S,e.QUERY_STATISTICS_TIMEOUT=w,e.QUERY_EXTENT_TIMEOUT=b}e.NO_SERVICE_DATA_COUNT=1/0,e.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,e.reset=t}(e.FeatureTileController3DConstants||(e.FeatureTileController3DConstants={})),e.FeatureTileController3DConstants.reset(),Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
