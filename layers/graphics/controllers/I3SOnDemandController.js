// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/Accessor","../../../core/arrayUtils","../../../core/Handles","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/PooledArray","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../dehydratedFeatures","../../support/PromiseQueue","../../../views/3d/layers/i3s/I3SFrameTask","../../../views/3d/layers/i3s/I3SIndex","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SStreamDataController","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/support/debugFlags","../../../views/3d/support/debugUtils","../../../views/3d/support/extentUtils","../../../views/3d/support/projectionUtils","../../../views/support/layerViewUtils","../../../views/support/Scheduler"],(function(e,t,i,r,o,a,n,s,d,l,u,h,c,p,_,f,y,g,m,b,v,x,w,N,S,D,C,L,V,I,P,O,A){"use strict";var F,U=s.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),M=function(e){function t(t){var i=e.call(this,t)||this;return i.screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingProgress=1,i.leafsReached=!1,i.scaleVisibilityEnabled=!0,i.uncompressedTextureDownsamplingEnabled=!1,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._invisibleDirty=!1,i._newLoadingNodes=new l({deallocator:null}),i._loadedNodeScales=new Map,i._modificationsNodeFilteringArray=new l,i._downloadingCount=0,i._loadingNodes=new Map,i._updatingNodes=new Map,i._progressMaxNumNodes=1,i._poi=f.vec3f64.create(),i._requiredAttributes=new Array,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i._disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new a,i._idleQueue=new b.default,i._elevationUpdateNodes=new l({deallocator:null}),i._errorCount=0,i}return i.__extends(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"streamDataController",{get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new S.default(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return D.getVertexCrs(this.layer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return D.getIndexCrs(this.layer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){if(d.isSome(this._index)){var e=this._index.rootNode;if(d.isSome(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0},enumerable:!1,configurable:!0}),t.prototype.initialize=function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new w(this.layerView);var t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=n("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var i=h.all([this.layer.when(),this.layerView.when()]).then((function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var i=e.layerView.view;e._setClippingArea(i.clippingArea),e._centerOnSurface=i.pointsOfInterest.centerOnSurfaceFrequent;var r=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",(function(){return e._pointOfInterestChanged()})),r.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),c.init(e.layerView,"suspended",(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},o=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=o):e._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(i,o)})),v.addTask(e.layerView.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),i.state.watch("camera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return d.isSome(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new C(e.crsIndex,i.renderCoordsHelper,i.state.camera,e._clippingArea,i.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new x.I3SIndex(t,e.streamDataController,e._viewportQueries,U,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e.layerView.isNodeReloading(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.streamDataController.busy}),(function(t){return e.layerView.computeVisibilityObb?e.layerView.computeVisibilityObb(t):null}));var o=d.isSome(e.layer.modifications)&&e.layer.modifications&&e.layer.modifications.length>0;e._index.imModificationsChanged(o)}}));this._tmpPoint=m.makeDehydratedPoint(0,0,0,this.crsIndex),this.addResolvingPromise(i),this.when((function(){return e._startNodeLoading()}))},t.prototype.updateNodeModificationStatus=function(e){var t=this,i=this._index,r=this.layerView;d.isSome(i)&&r&&r.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forEachSimple((function(e){var r=i.getNode(e);d.isSome(r)&&t._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)},t.prototype.destroy=function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,q.prune(),d.isSome(F)&&(F.remove(),F=null)},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var r=B(e,i),o=B(t,i);return r>=0&&o>=0?{index:r,name:t[o].name,field:t[o],attributeStorageInfo:e[r]}:null})).filter((function(e){return null!=e&&e.name!==i}))},t.prototype._requiredFieldsChange=function(){var e=this._getRequiredAttributes();T(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._setClippingArea=function(e){var t=y.create();I.projectToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._camPos&&(this._calculatePointOfInterest(this._poi),d.isSome(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(this._poi),d.isSome(this._index)&&(this._index.progressiveLoadPenalty=E.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,i=f.vec3f64.create();_.vec3.subtract(i,t,this._camPos);var r=this.layerView.view.renderCoordsHelper,o=f.vec3f64.create();r.worldUpAtPosition(t,o);var a=_.vec3.angle(o,i)-.5*Math.PI;_.vec3.lerp(e,this._camPos,t,Math.max(0,Math.min(1,a/(.5*Math.PI)))),L.SHOW_POI?(d.isNone(F)&&(F=new V.GraphicsHandle(this.layerView.view.graphics,"blue")),F.showPoint(e,this.layerView.view.renderSpatialReference)):d.isSome(F)&&F.remove()},t.prototype.updateClippingArea=function(e){this._setClippingArea(e),d.isSome(this._viewportQueries)&&d.isSome(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype.updateElevationChanged=function(e,t){var i=this,r=this._index;if(!d.isNone(r)){var o=r.rootNode;if(!d.isNone(o)){var a=this._elevationUpdateNodes;a.clear(),D.findIntersectingNodes(e,t,o,this.crsIndex,r,(function(e){return a.push(e.index)})),a.forEachSimple((function(e){r.invalidateBoundingVolumeCache(e),e===o.index&&i.notifyChange("rootNodeVisible")})),a.length&&this.restartNodeLoading()}}},t.prototype.getParentIndex=function(e){return d.isSome(this._index)&&this._index.getParentIndex(e)},t.prototype._elevationInfoChanged=function(){d.isSome(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype._updateScaleHandles=function(){var e=this;this._handles.remove("scale-bounds"),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),"scale-bounds")},t.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()},t.prototype._scaleUpdateHandler=function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()},t.prototype._updateScaleInBoundingRect=function(e,t,i){var r=this,o=this._index;if(!d.isNone(o)){var a=o.rootNode;!d.isNone(a)&&P.boundingRectToBoundingRect(t,i,G,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,i){var a=o.getNode(i);d.isSome(a)&&g.containsPoint(G,a.mbs)&&r._loadedNodeScales.set(i,e)}))}},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()},t.prototype.schedule=function(e,t){return this._idleQueue.push((function(){return h.throwIfAborted(e),t()}))},t.prototype.reschedule=function(e,t){return this._idleQueue.unshift((function(){return h.throwIfAborted(e),t()}))},Object.defineProperty(t.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"areScaleBoundsActive",{get:function(){var e=O.extractSafeScaleBounds(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return d.isNone(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"indexDepth",{get:function(){return d.isSome(this._index)?this._index.maxLevel:0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"disableMemCache",{set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e},enumerable:!1,configurable:!0}),t.prototype._frame=function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||d.isNone(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?U.error("Error during processing: "+e):50===this._errorCount&&U.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var i=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!d.isNone(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}},t.prototype._processIndex=function(e){var t=this;if(d.isNone(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(o.keysOfMap(this._loadingNodes),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||i===this._get("leafsReached")||this._set("leafsReached",i)}return this._index.load()},t.prototype._prefetchIndex=function(){return!(d.isNone(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D&&!d.isNone(this._index)&&!d.isNone(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.getFeatureEstimate();if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var o=this.lod,a=this._index.checkFeatureTarget(t,o);a!==o&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processCache=function(e){var t=this._index;if(d.isNone(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),r=t.getParent(i);d.isSome(r)&&(!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r));r=t.getParent(r.index))if(this._enableFromGPUCache(r,0)){e.madeProgress();break}return e.hasProgressed},t.prototype._processNodes=function(e,t){if(d.isNone(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){var o=this._index.getNode(r.update.pop());d.isSome(o)&&(this._updateLoadedNode(o),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;o=this._index.getNode(r.add.back());if(d.isNone(o)||2!==o.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(o),e.madeProgress()}return e.hasProgressed},t.prototype._cancelAllNodes=function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()},t.prototype._cancelNode=function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))},t.prototype._hasNodeLoadToken=function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&!this.streamDataController.busy},t.prototype._evaluateUpdating=function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?.5:1;else{var i=(d.isSome(this._index)?this._index.getIndexMissing():0)+3*(d.isSome(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}e!==this.updating&&this._set("updating",e),t!==this.updatingProgress&&this._set("updatingProgress",t)},t.prototype._updateViewData=function(){if(this._cameraDirty&&!d.isNone(this._index)&&!d.isNone(this._viewportQueries)){var e=this.layerView.view,t=e.state.camera;this._camPos=f.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=E.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)},enumerable:!1,configurable:!0}),t.prototype.isGeometryVisible=function(e){return d.isSome(this._index)&&this._index.isGeometryVisible(e.index)},t.prototype.updateVisibility=function(e){d.isSome(this._index)&&this._index.invalidateNodeVisibilityCache(e)},t.prototype.updateBoundingVolume=function(e){d.isSome(this._index)&&this._index.invalidateBoundingVolumeCache(e)},t.prototype.invalidateGeometryVisibility=function(e){d.isSome(this._index)&&this._index.invalidateGeometryVisibility(e)},t.prototype.invalidateVisibilityObbs=function(){d.isSome(this._index)&&this._index.invalidateVisibilityObbs()},t.prototype.modificationsChanged=function(){if(d.isSome(this._index)){var e=d.isSome(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!!d.isSome(this._index)&&this._index.isGeometryVisible(e.index))},t.prototype._shouldDropNode=function(e){if(d.isNone(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.childrenEmpty(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t},t.prototype._startNodeLoading=function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||null==this.streamDataController||d.isNone(t)||d.isNone(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i=N.TextureFormat.Normal;this.layerView.useCompressedTextures?i=N.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(i=N.TextureFormat.Downsampled);var r={textureFormat:i,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new N(this.layer,this.streamDataController,U,this._defaultGeometrySchema,this._requiredAttributes,r),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())},t.prototype._removeInvisibleNodes=function(e){var t=this,i=this._index;if(d.isNone(i)||d.isNone(this._viewportQueries))return!1;q.clear(),this.layerView.getLoadedNodeIndices(q);var r=0===this._viewportQueries.maxDistance,o=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return q.filterInPlace((function(e){var r=i.getNode(e);return d.isNone(r)||!i.isGeometryVisible(e)||o(r)||!t._isNodeInScaleBounds(r)})),q.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(q,e),!(r&&this.lodDropFactor<1)&&(0===q.length||(q.clear(),!1))},t.prototype.markNodeToRemove=function(e){q.push(e)},t.prototype.removeMarkedNodes=function(){this._removeNodes(q,A.noBudget)},t.prototype._removeNodes=function(e,t){e.length>0&&d.isSome(this._index)&&this._index.requestUpdate();for(var i=e.length;e.length>0&&!t.done;)this.layerView.removeNode(e.pop()),t.madeProgress();if(this._loadedNodeScales.size>0)for(var r=e.length;r<i;r++){var o=e.data[r];this._loadedNodeScales.delete(o)}},t.prototype._needsUpdate=function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,i=h.createAbortController();this._updatingNodes.set(e.index,i),(T(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?h.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(r){return t.schedule(i.signal,(function(){return t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r})}))})).catch((function(i){h.isAbortError(i)||t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}})})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()},t.prototype._loadNode=function(e){var t=this;if(this._loadingNodes.has(e.index))U.error("already loading node "+e.index);else{var i=h.createAbortController();this._loadingNodes.set(e.index,i);var r=function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then(r).catch((function(e){if(r(),!h.isAbortError(e))throw e}))}},t.prototype._loadAndAddNode=function(e,t){var i=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,d.isSome(i._index)&&i._index.updates.add.push(e.index))})).catch((function(t){if(!h.isAbortError(t))throw e.cacheState=1,t}))},t.prototype._enableFromGPUCache=function(e,t){if(this._disableMemCache||d.isNone(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)},t.prototype._loadCachedGPUData=function(e){var t=this.layerView.loadCachedGPUData(e);return d.isSome(t)&&Q(t.attributeInfo)&&T(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:null},t.prototype._nodeAdded=function(){d.isSome(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype._loadCached=function(e,t){var i=this;if(this._enableFromGPUCache(e,1))return h.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule(t,(function(){return r.loadCachedNodeData(e,t,(function(t,r){return i._nodeLoader.loadTextures(e,t,r)}))})).then((function(o){if(d.isNone(o))return!1;var a=i._requiredAttributes;return Q(o)&&T(o.loadedAttributes,a)?i.reschedule(t,(function(){return r.addCachedNodeData(e,o,o,t)})).then((function(){return i._nodeAdded(),!0})):i.reschedule(t,(function(){return i._nodeLoader.loadAttributes(e,a,t)})).then((function(n){return i.reschedule(t,(function(){return r.addCachedNodeData(e,o,{loadedAttributes:a,attributeData:n},t)}))})).then((function(){return i._nodeAdded(),!0}))})):h.resolve(!1)},t.prototype._loadUncached=function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(r){return i._downloadingCount--,i.schedule(t,(function(){return i.layerView.addNode(e,r,t)}))})).then((function(){i._nodeAdded(),e.cacheState=2})).catch((function(t){if(!h.isAbortError(t))throw U.error("Failed to load node '"+e.id+"': "+t),e.failed=!0,d.isSome(i._index)&&i._index.requestUpdate(),t}))},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&d.isSome(this._index)&&this._index.resetFailedNodes())},t.prototype._getScale=function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t},t.prototype._isNodeInScaleBounds=function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=O.extractSafeScaleBounds(this.layer),r=i.minScale,o=i.maxScale;return O.scaleBoundsPredicate(t,r,o)},t.prototype.updateStats=function(e){e.index=d.isSome(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),d.isSome(this._index)&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){d.isSome(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}},enumerable:!1,configurable:!0}),i.__decorate([p.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),i.__decorate([p.property({readOnly:!0})],t.prototype,"isGraphics3D",null),i.__decorate([p.property({readOnly:!0})],t.prototype,"streamDataController",null),i.__decorate([p.property({readOnly:!0})],t.prototype,"crsVertex",null),i.__decorate([p.property({readOnly:!0})],t.prototype,"crsIndex",null),i.__decorate([p.property()],t.prototype,"_camPos",void 0),i.__decorate([p.property()],t.prototype,"screenSizeFactor",void 0),i.__decorate([p.property()],t.prototype,"featureTarget",void 0),i.__decorate([p.property()],t.prototype,"fixedFeatureTarget",void 0),i.__decorate([p.property()],t.prototype,"layerView",void 0),i.__decorate([p.property()],t.prototype,"layer",void 0),i.__decorate([p.property({readOnly:!0})],t.prototype,"updating",void 0),i.__decorate([p.property({readOnly:!0})],t.prototype,"updatingProgress",void 0),i.__decorate([p.property({readOnly:!0})],t.prototype,"leafsReached",void 0),i.__decorate([p.property({constructOnly:!0})],t.prototype,"scaleVisibilityEnabled",void 0),i.__decorate([p.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),i.__decorate([p.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),t=i.__decorate([p.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(u.EsriPromiseMixin(r)),q=new l({deallocator:null});function T(e,t){return d.isSome(e)&&e.length===t.length&&e.every((function(e){return B(t,e.name)>=0}))}function B(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var E={factorIM:.2,factor3dObject:.05,distancePenalty:10};function Q(e){return d.isSome(e)&&d.isSome(e.loadedAttributes)&&d.isSome(e.attributeData)}var G=g.create();return M}));