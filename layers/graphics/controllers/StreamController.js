// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../../../core/declare","dojo/_base/lang","dojo/promise/all","dojo/Deferred","../../../core/Accessoire","../../../core/HandleRegistry","../../../core/AccessoirePromise","../../../core/Evented","../../../core/promiseUtils","../../support/StreamPurger","../../../Graphic","../../../geometry/support/jsonUtils","../../../tasks/support/Query"],function(e,t,i,r,n,s,o,a,h,l,c,u,d){var f=e([n,o,a],{declaredClass:"esri.layers.graphics.controllers.StreamController",classMetadata:{properties:{layer:{}}},constructor:function(){this._addFeatures=t.hitch(this,this._addFeatures),this._handleMessage=t.hitch(this,this._handleMessage),this._handleRegistry=new s,this._nextId=0,this._socketConnector=null,this._filter={geometry:null,where:null}},initialize:function(){var e=new r,t=i([this.layer,this.layerView]);return t.then(function(){this.source=this.layer.source,this.graphics=this.graphics||this.layer.graphics,this._filter.geometry=this.layer.geometryDefinition||null,this._filter.where=this.layer.definitionExpression||null;var t=new l(this);t.then(function(){this.purger=t,this._handleRegistry.add(this.watch("layer.requestedDefinitionExpression",function(e){var t={where:e};this._filterValid(t)&&this._filterChanged(t)&&this._setFilter(t)})),this._handleRegistry.add(this.watch("layer.requestedGeometryDefinition",function(e){var t={geometry:e};this._filterValid(t)&&this._filterChanged(t)&&this._setFilter(t)})),this._makeConnection()}.bind(this),function(t){this.addResolvingPromise(e.promise),e.reject(t)})}.bind(this)),e.promise},destroy:function(){this._socketConnector&&(this._disconnect(),this._socketConnector=null),this._gfxColHdl&&(this._gfxColHdl.remove(),this._gfxColHdl=null),this.purger&&(this.purger.destroy(),this.purger=null),this.graphics=null,this._handleRegistry&&(this._handleRegistry.destroy(),this._handleRegistry=null)},graphics:null,_gfxColHdl:null,_graphicsSetter:function(e){var i=this.graphics;return i===e?i:(this._gfxColHdl&&(this._gfxColHdl.remove(),this._gfxColHdl=null,i.forEach(function(e){e.layer=null})),e&&(e.forEach(function(e){e.layer=this.layer},this),this._gfxColHdl=e.on("change",t.hitch(this,function(e){var t,i,r;for(r=e.added,t=0;i=r[t];t++)i.layer=this.layer;for(r=e.removed,t=0;i=r[t];t++)i.layer=null}))),e)},_definitionExpressionSetter:function(e){var t=this._filter.where,i={definitionExpression:e};return this._filterValid(i)&&this._filterChanged(i)?void this._setFilter(i):t},_definitionExpressionGetter:function(){return this._filter.where},_geometryDefinitionSetter:function(e){var t=this._filter.geometry,i={geometryDefinition:e};return this._filterValid(i)&&this._filterChanged(i)?void this._setFilter(i):t},currentSocketUrl:null,_geometryDefinitionGetter:function(){return this._filter.geometry},connect:function(){this._connect()},disconnect:function(){this._disconnect()},_makeConnection:function(){return this._handleRegistry.remove("websocket"),this._addBuddiedServiceFeatures(!0).then(function(){return this._addBuddiedServiceFeatures(!1)}.bind(this),function(e){return h.reject(new Error("Error fetching related features. Layer cannot be created"))}.bind(this)).then(function(e){var t=this.layerView.view.spatialReference;return this.source.createWebSocketConnector(t)}.bind(this)).then(function(e){this._socketConnector=e,this._handleRegistry.add(e.on("connect",function(){this.emit("connect")}.bind(this)),"websocket"),this._handleRegistry.add(e.on("disconnect",function(e){this.emit("disconnect",e)}.bind(this)),"websocket"),this._handleRegistry.add(e.on("attempt-reconnect",function(e){this.emit("attempt-reconnect",e)}.bind(this)),"websocket"),this._handleRegistry.add(e.on("message",function(e){this._handleMessage(e)}.bind(this)),"websocket"),this._handleRegistry.add(e.watch("currentSocketUrl",function(e){this.currentSocketUrl=e}.bind(this)),"websocket"),e.connect()}.bind(this)).otherwise(function(e){this.emit("error",e)}.bind(this))},_connect:function(){this._socketConnector&&this._socketConnector.connect()},_disconnect:function(){this._socketConnector&&this._socketConnector.disconnect()},_handleMessage:function(e){var t,i=JSON.parse(e);this.emit("message",i),i.hasOwnProperty("filter")?this._handleFilterMessage(i):(t=i instanceof Array?i:[i],this._addFeatures(t))},_addFeatures:function(e){if(e){for(var t=this.layer.objectIdField,i=[],r=0,n=e.length;n>r;r++){var s,o=e[r];if(!o.attributes||!o.attributes[t]&&0!==o.attributes[t]){if(!o.geometry)continue;o.attributes=o.attributes||{},o.attributes[t]=this._nextId++}s=o.declaredClass?o:c.fromJSON(o),i.push(s)}this.purger.addMany(i)}},_filterChanged:function(e){var t,i=!1,r=!1;return t=e?this.source.makeFilter(e):{geometry:null,where:null},t.hasOwnProperty("geometry")&&(i=t.geometry?!t.geometry.equals(this._filter.geometry):t.geometry!==this._filter.geometry),t.hasOwnProperty("where")&&(r=t.where!==this._filter.where),i||r},_filterValid:function(e){var t=!0;return e&&(e.hasOwnProperty("geometryDefinition")&&e.geometryDefinition&&(e.geometryDefinition.type&&"extent"===e.geometryDefinition.type||(t=!1)),t&&e.hasOwnProperty("definitionExpression")&&e.definitionExpression&&"string"!=typeof e.definitionExpression&&(t=!1)),t},_setFilter:function(e){var t=this.source.makeFilter(e);t.geometry&&"string"!=typeof t&&(t.geometry=JSON.stringify(t.geometry.toJSON()));var i={filter:t||null};this._socketConnector.send(i)},_handleFilterMessage:function(e){var t,i,r;e.error?(i=new Error(e.error.join(",")),this.emit("filter-change",{filter:e.filter,error:i})):(t={where:e.filter.where?e.filter.where:null,geometry:e.filter.geometry?e.filter.geometry:null,outFields:e.filter.outFields?e.filter.outFields:null},r=t.geometry,r&&("string"==typeof r&&(r=JSON.parse(r)),r=u.fromJSON(r)),this._filter.geometry=r,this._filter.where=t.where,this.notifyChange("definitionExpression"),this.notifyChange("geometryDefinition"),this.emit("filter-change",{filter:this._filter}))},_addBuddiedServiceFeatures:function(e){var t,i,r;if(e){if(!this.source.relatedFeaturesInfo)return h.resolve();t=this.source.relatedFeaturesQueryTask,i=this.source.relatedLayerDefinition,r=this._createQuery(i,!0)}else{if(!this.source.latestUrl)return h.resolve();t=this.source.latestQueryTask,i=this.source.archivedLayerDefinition,r=this._createQuery(i,!1)}var n=i.advancedQueryCapabilities||{},s=!!n.supportsPagination;return s&&(r.num=i.maxRecordCount),this._query({query:r,queryTask:t}).then(function(e){return e&&this._addFeatures(e.features),h.resolve()}.bind(this),function(e){return h.reject(e)},function(e){e&&this._addFeatures(e.features)}.bind(this))},_query:function(e){var t=e.query,i=e.queryTask,n=new r;t.num&&(t.start=0);var s=function(e){(e||0===e)&&(t.start=e),i.execute(t).then(o,function(e){console.log("error performing query: ",e),n.reject(e)})},o=function(e){e.exceededTransferLimit&&t.num?(s(t.start+t.num),n.progress(e)):n.resolve(e)};return s(t.start),n.promise},_createQuery:function(e,t){var i=this.layer,r=this.layerView,n=i.outFields.slice(0),s=i.definitionExpression||"1=1";if(t){var o=this._getFieldsNotShared(e,this.layer.fields);n=this._removeInvalidOutfields(o,n),"1=1"!==s&&this._checkForInvalidFieldInWhere(o,s)&&(s="1=1")}return n=this._addObjectIdFieldToOutfields(e,n),new d({where:s,geometry:i.geometryDefinition,outFields:n,outSpatialReference:r.view.spatialReference,returnGeometry:!0})},_addObjectIdFieldToOutfields:function(e,t){if(t=t||["*"],"*"!==t[0]){var i=this._getObjectIdFieldName(e);if(i){var r=t.some(function(e){return e.toLowerCase()===i.toLowerCase()});r||t.push(i)}}return t},_removeInvalidOutfields:function(e,t){if(t=t||["*"],"*"!==t[0])var i=e.join(",").toLowerCase(),r=t.filter(function(e){var t=new RegExp("\\s*"+e+"\\b","i");return t.test(i)?void 0:e});return r&&0!==r.length?r:["*"]},_checkForInvalidFieldInWhere:function(e,t){return t&&"1=1"!==t?e.some(function(e){var i=new RegExp("\\s*"+e+"\\b","i");return i.test(t)}):!1},_getObjectIdFieldName:function(e){var t=null;return e.fields.some(function(e){return"esriFieldTypeOID"===e.type?(t=e.name,!0):!1}),t},_getFieldsNotShared:function(e,t){var i=e.fields.map(function(e){return e.name}).join(",").toLowerCase(),r=[];return t.forEach(function(e){var t=e.name.toLowerCase();-1===i.indexOf(t+",")&&r.push(t)}),r}});return f});