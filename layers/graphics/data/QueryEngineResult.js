/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils","../../support/fieldUtils","../../../smartMapping/statistics/support/utils","../../../support/arcadeOnDemand"],(function(e,t,s,i,r,n,o,a,u,l,c,d,f){"use strict";function h(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function m(e,t,s){return(s?e>t:e<t)?-1:(s?e<t:e>t)?1:0}function p(e,t,s){return s?t-e:e-t}function y(e,t,s,i){if(s&&"esriFieldTypeDate"===s.type){const s=new Date(e).getTime(),r=new Date(t).getTime();if(!isNaN(s)&&!isNaN(r))return p(s,r,i)}if("number"==typeof e&&"number"==typeof t)return p(e,t,i);if("string"==typeof e&&"string"==typeof t){const r=e.toUpperCase(),n=t.toUpperCase();return!s||"esriFieldTypeGUID"!==s.type&&"esriFieldTypeGlobalID"!==s.type?m(r,n,i):m(h(r),h(n),i)}return i?1:-1}function g(e,t,s,i,r,n){const o=r-s,a=n-i,u=o*o+a*a,l=(e-s)*o+(t-i)*a,c=Math.min(1,Math.max(0,l/u));return{x:s+o*c,y:i+a*c}}function I(e,t){return e?t?4:3:t?3:2}return function(){function h(e,t,s){this.items=e,this.queryGeometry=t,this.definitionExpression=s.definitionExpression,this.geometryType=s.geometryType,this.hasM=s.hasM,this.hasZ=s.hasZ,this.objectIdField=s.objectIdField,this.spatialReference=s.spatialReference,this.fieldsIndex=s.fieldsIndex,this.timeInfo=s.timeInfo,this.featureAdapter=s.featureAdapter,this.aggregateAdapter=s.aggregateAdapter}var m=h.prototype;return m.createQueryResponseForCount=function(e){const t=new n(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);const{groupByFieldsForStatistics:s,having:i}=e;if(!!!(null==s?void 0:s.length))return 1;const r=new Map,o=new Map,a=new Set,u=e.outStatistics;for(const n of u){const{statisticType:e}=n,u="exceedslimit"!==e?n.onStatisticField:void 0;if(!o.has(u)){const e=[];for(const i of s){const s=this._getAttributeValues(t,i,r);e.push(s)}o.set(u,this._calculateUniqueValues(e))}const l=o.get(u);for(const s in l){const{data:e,items:r}=l[s],n=e.join(",");i&&!t.validateItems(r,i)||a.add(n)}}return a.size},m.createQueryResponse=function(e){let t;if(e.outStatistics){t=e.outStatistics.some((e=>"exceedslimit"===e.statisticType))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e)}else t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(i.isValid(e.outSR)&&!i.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=l.cleanFromGeometryEngine({spatialReference:e.outSR,...a.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR)}):t.queryGeometry=l.cleanFromGeometryEngine({spatialReference:e.outSR,...this.queryGeometry})),t},m.createSnappingResponse=function(e,t){const s=this.featureAdapter,i=I(this.hasZ,this.hasM),{x:r,y:n}=e.point,o="number"==typeof e.distance?e.distance:e.distance.x,a="number"==typeof e.distance?e.distance:e.distance.y,u={candidates:[]},l="esriGeometryPolygon"===this.geometryType,c=this.getPointCreator(e.point,this.spatialReference,t);for(const d of this.items){const t=s.getGeometry(d);if(!t)continue;const{coords:f,lengths:h}=t;if(1&e.types){let e=0;for(let t=0;t<h.length;t++){const l=h[t];for(let t=0;t<l;t++,e+=i){const h=f[e],m=f[e+1];if(t!==l-1){const t=f[e+i],l=f[e+i+1],{x:p,y}=g(r,n,h,m,t,l),I=(r-p)/o,b=(n-y)/a,x=I*I+b*b;x<=1&&u.candidates.push({type:"edge",objectId:s.getObjectId(d),distance:Math.sqrt(x),target:c(p,y),start:c(h,m),end:c(t,l)})}}}}if(2&e.types){const e=l?f.length-i:f.length;for(let t=0;t<e;t+=i){const e=f[t],i=f[t+1],l=(r-e)/o,h=(n-i)/a,m=l*l+h*h;m<=1&&u.candidates.push({type:"vertex",objectId:s.getObjectId(d),distance:Math.sqrt(m),target:c(e,i)})}}}return u.candidates.sort(((e,t)=>e.distance-t.distance)),u},m.getPointCreator=function(e,s,r){const n=t.isSome(r)&&!i.equals(s,r)?e=>a.project(e,s,r):e=>e;return null!=e.z&&null!=e.m?(t,s)=>n({x:t,y:s,z:e.z,m:e.m}):null!=e.z?(t,s)=>n({x:t,y:s,z:e.z}):null!=e.m?(t,s)=>n({x:t,y:s,m:e.m}):(e,t)=>n({x:e,y:t})},m.executeAttributesQuery=function(e){const t=o.getWhereClause(e.where,this.fieldsIndex);if(!t)return Promise.resolve(this);if(t.isStandardized){let s=0;const i=[];for(const e of this.items)t.testFeature(e,this.featureAdapter)&&(i[s++]=e);const r=new h(i,this.queryGeometry,this);return r.definitionExpression=e.where,Promise.resolve(r)}return Promise.reject(new TypeError("Where clause is not standardized"))},m.executeAggregateIdsQuery=function(e){if(!e.aggregateIds||!e.aggregateIds.length||t.isNone(this.aggregateAdapter))return Promise.resolve(this);const s=new Set;for(const t of e.aggregateIds){this.aggregateAdapter.getFeatureObjectIds(t).forEach((e=>s.add(e)))}const i=this.featureAdapter.getObjectId;return Promise.resolve(new h(this.items.filter((e=>s.has(i(e)))),this.queryGeometry,this))},m.executeObjectIdsQuery=function(e){if(!e.objectIds||!e.objectIds.length)return Promise.resolve(this);const t=new Set(e.objectIds),s=this.featureAdapter.getObjectId;return Promise.resolve(new h(this.items.filter((e=>t.has(s(e)))),this.queryGeometry,this))},m.executeTimeQuery=function(e){const s=u.getTimeOperator(this.timeInfo,e.timeExtent,this.featureAdapter);if(!t.isSome(s))return Promise.resolve(this);const i=this.items.filter(s);return Promise.resolve(new h(i,this.queryGeometry,this))},m.filterLatest=function(){const{trackIdField:e,startTimeField:t,endTimeField:s}=this.timeInfo,i=s||t,r=new Map,n=this.featureAdapter.getAttribute;for(const a of this.items){const t=n(a,e),s=n(a,i),o=r.get(t);(!o||s>n(o,i))&&r.set(t,a)}const o=Array.from(r.values());return Promise.resolve(new h(o,this.queryGeometry,this))},m.project=function(){var t=e._asyncToGenerator((function*(e){if(!e||i.equals(this.spatialReference,e))return this;const t=this.featureAdapter;return new h((yield a.projectMany(this.items.map((e=>l.getGeometry(this.geometryType,this.hasZ,this.hasM,t.getGeometry(e)))),this.spatialReference,e)).map(((e,s)=>t.cloneWithGeometry(this.items[s],r.convertFromGeometry(e,this.hasZ,this.hasM)))),this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:e,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})}));function s(e){return t.apply(this,arguments)}return s}(),m.createSummaryStatisticsResponse=function(){var t=e._asyncToGenerator((function*(e,t){const{field:s,normalizationField:i,normalizationType:r,normalizationTotal:o,minValue:a,maxValue:u}=t,l=new n(e,this.featureAdapter,this.fieldsIndex),f=this.fieldsIndex.isDateField(s),h=t.valueExpression?yield this._getAttributeExpressionValues(l,t.valueExpression,t.viewInfoParams):this._getAttributeNormalizedValues(l,{field:s,normalizationField:i,normalizationType:r,normalizationTotal:o}),m=d.isNullCountSupported({normalizationType:r,normalizationField:i,minValue:a,maxValue:u}),p=c.isStringField(this.fieldsIndex.get(s))?d.calculateStringStatistics({values:h,supportsNullCount:m}):d.calculateStatistics({values:h,minValue:a,maxValue:u,useSampleStdDev:!r,supportsNullCount:m});return d.processStatsResult(p,f)}));function s(e,s){return t.apply(this,arguments)}return s}(),m._sortFeatures=function(e,t,s){if(e.length>1&&t&&t.length)for(const i of t.reverse()){const t=i.split(" "),r=t[0],n=this.fieldsIndex.get(r),o=t[1]&&"desc"===t[1].toLowerCase();e.sort(((e,t)=>y(s(e,r,n),s(t,r,n),n,o)))}},m._createFeatureQueryResponse=function(e){const t=this.items,{geometryType:i,hasM:r,hasZ:n,objectIdField:o,spatialReference:a}=this,{outFields:u,outSR:c,quantizationParameters:d,resultRecordCount:f,resultOffset:h,returnZ:m,returnM:p}=e,y=null!=f&&t.length>(h||0)+f,g=u&&(u.indexOf("*")>-1?[...this.fieldsIndex.fields]:u.map((e=>this.fieldsIndex.get(e))));return{exceededTransferLimit:y,features:this._createFeatures(e,t),fields:g,geometryType:i,hasM:r&&p,hasZ:n&&m,objectIdFieldName:o,spatialReference:l.cleanFromGeometryEngine(c||a),transform:d&&s.toQuantizationTransform(d)||null}},m._createFeatures=function(e,t){const i=new n(e,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:o}=this,{orderByFields:a,quantizationParameters:u,returnGeometry:c,returnCentroid:d,maxAllowableOffset:f,resultOffset:h,resultRecordCount:m,returnZ:p=!1,returnM:y=!1}=e,g=o&&p,I=r&&y;let b=[],x=0;const F=[...t];if(this._sortFeatures(F,a,((e,t,s)=>i.getFieldValue(e,t,s))),c||d){const e=s.toQuantizationTransform(u);if(c&&!d)for(const t of F)b[x++]={attributes:i.getAttributes(t),geometry:l.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),f,e,g,I)};else if(!c&&d)for(const t of F)b[x++]={attributes:i.getAttributes(t),centroid:l.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of F)b[x++]={attributes:i.getAttributes(t),centroid:l.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e),geometry:l.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),f,e,g,I)}}else for(const s of F){const e=i.getAttributes(s);e&&(b[x++]={attributes:e})}const T=h||0;if(null!=m){const e=T+m;b=b.slice(T,Math.min(b.length,e))}return b},m._createExceedsLimitQueryResponse=function(e){let t=!1,s=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY;for(const n of e.outStatistics)if("exceedslimit"===n.statisticType){s=null!=n.maxPointCount?n.maxPointCount:Number.POSITIVE_INFINITY,i=null!=n.maxRecordCount?n.maxRecordCount:Number.POSITIVE_INFINITY,r=null!=n.maxVertexCount?n.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)t=this.items.length>s;else if(this.items.length>i)t=!0;else{const e=this.hasZ?this.hasM?4:3:this.hasM?3:2,s=this.featureAdapter;t=this.items.reduce(((e,t)=>{const i=s.getGeometry(t);return e+(i&&i.coords.length||0)}),0)/e>r}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},m._createStatisticsQueryResponse=function(e){const t={attributes:{}},s=[],i=new Map,r=new Map,o=new Map,a=new Map,u=new n(e,this.featureAdapter,this.fieldsIndex),l=e.outStatistics,{groupByFieldsForStatistics:c,having:d,orderByFields:f}=e,h=c&&c.length,m=!!h,p=m&&c[0],y=m&&!this.fieldsIndex.get(p);for(const n of l){const{outStatisticFieldName:e,statisticType:l}=n,f=n,g="exceedslimit"!==l?n.onStatisticField:void 0,I="percentile_disc"===l||"percentile_cont"===l,b=m&&1===h&&(g===p||y)&&"count"===l;if(m){if(!o.has(g)){const e=[];for(const t of c){const s=this._getAttributeValues(u,t,i);e.push(s)}o.set(g,this._calculateUniqueValues(e,u.returnDistinctValues))}const t=o.get(g);for(const s in t){const{count:r,data:n,items:o,itemPositions:l}=t[s],h=n.join(",");if(!d||u.validateItems(o,d)){const t=a.get(h)||{attributes:{}};let s=null;if(b)s=r;else{const e=this._getAttributeValues(u,g,i),t=l.map((t=>e[t]));s=I&&"statisticParameters"in f?this._getPercentileValue(f,t):this._getStatisticValue(f,t)}t.attributes[e]=s,c.forEach(((e,s)=>t.attributes[this.fieldsIndex.get(e)?e:`EXPR_${s+1}`]=n[s])),a.set(h,t)}}}else{const s=this._getAttributeValues(u,g,i);t.attributes[e]=I&&"statisticParameters"in f?this._getPercentileValue(f,s):this._getStatisticValue(f,s,r)}s.push({name:e,alias:e,type:"esriFieldTypeDouble"})}const g=m?Array.from(a.values()):[t];return this._sortFeatures(g,f,((e,t)=>e.attributes[t])),{fields:s,features:g}},m._getStatisticValue=function(e,t,s){const{onStatisticField:i,statisticType:r}=e;let n=null;n=null!=s&&s.has(i)?s.get(i):c.isStringField(this.fieldsIndex.get(i))?d.calculateStringStatistics({values:t}):d.calculateStatistics({values:t,minValue:null,maxValue:null,useSampleStdDev:!0}),s&&s.set(i,n);return n["var"===r?"variance":r]},m._getPercentileValue=function(e,t){const{onStatisticField:s,statisticParameters:i,statisticType:r}=e,{value:n,orderBy:o}=i,a="desc"===o,u=this.fieldsIndex.get(s),l=[...t].filter((e=>null!=e)).sort(((e,t)=>y(e,t,u,a)));return this._calculatePercentile(l,n,"percentile_disc"===r)},m._getAttributeValues=function(e,t,s){if(s.has(t))return s.get(t);const i=this.fieldsIndex.get(t),r=this.items.map((s=>e.getFieldValue(s,t,i)));return s.set(t,r),r},m._getAttributeNormalizedValues=function(e,t){return this.items.map((s=>e.getNormalizedValue(s,{field:t.field,fieldInfo:this.fieldsIndex.get(t.field),normalizationField:t.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(t.normalizationField),normalizationType:t.normalizationType,normalizationTotal:t.normalizationTotal})))},m._getAttributeExpressionValues=function(){var t=e._asyncToGenerator((function*(e,t,s){const{arcadeUtils:i}=yield f.loadArcade(),r=i.createFunction(t),n=s&&i.getViewInfo(s);return this.items.map((t=>e.getExpressionValue(t,{compiledFunc:r,viewInfo:n},i)))}));function s(e,s,i){return t.apply(this,arguments)}return s}(),m._calculateUniqueValues=function(e,t){const s={},i=this.items,r=i.length;for(let n=0;n<r;n++){const r=i[n],o=[];for(const t of e)o.push(t[n]);const a=o.join(",");t?null==s[a]&&(s[a]={count:1,data:o,items:[r],itemPositions:[n]}):null==s[a]?s[a]={count:1,data:o,items:[r],itemPositions:[n]}:(s[a].count++,s[a].items.push(r),s[a].itemPositions.push(n))}return s},m._calculatePercentile=function(e,t,s){if(0===e.length)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];const i=(e.length-1)*t,r=Math.floor(i),n=r+1,o=i%1,a=e[r],u=e[n];return n>=e.length||s||"string"==typeof a||"string"==typeof u?a:a*(1-o)+u*o},e._createClass(h,[{key:"size",get:function(){return this.items.length}}]),h}()}));
