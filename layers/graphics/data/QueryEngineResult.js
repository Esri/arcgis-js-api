/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./projectionSupport","../../../geometry/support/quantizationUtils","./attributeSupport","./AttributesBuilder","../../../chunks/spatialQuerySupport","./timeSupport"],(function(e,t,s,i,r,n,o,a,u,c,l){"use strict";function h(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function f(e,t,s){return(s?e>t:e<t)?-1:(s?e<t:e>t)?1:0}function d(e,t,s){return s?t-e:e-t}function m(e,t,s,i){if(s&&"esriFieldTypeDate"===s.type){const s=new Date(e).getTime(),r=new Date(t).getTime();if(!isNaN(s)&&!isNaN(r))return d(s,r,i)}if("number"==typeof e&&"number"==typeof t)return d(e,t,i);if("string"==typeof e&&"string"==typeof t){const r=e.toUpperCase(),n=t.toUpperCase();return!s||"esriFieldTypeGUID"!==s.type&&"esriFieldTypeGlobalID"!==s.type?f(r,n,i):f(h(r),h(n),i)}return i?1:-1}return function(){function h(e,t,s){this.items=e,this.queryGeometry=t,this.definitionExpression=s.definitionExpression,this.geometryType=s.geometryType,this.hasM=s.hasM,this.hasZ=s.hasZ,this.objectIdField=s.objectIdField,this.spatialReference=s.spatialReference,this.fieldsIndex=s.fieldsIndex,this.timeInfo=s.timeInfo,this.featureAdapter=s.featureAdapter,this.aggregateAdapter=s.aggregateAdapter}var f=h.prototype;return f.createQueryResponseForCount=function(e){const t=new u(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);const{groupByFieldsForStatistics:s,having:i}=e;if(!!!(null==s?void 0:s.length))return 1;const r=new Map,n=new Map,o=new Set,a=e.outStatistics;for(const e of a){const{statisticType:a}=e,u="exceedslimit"!==a?e.onStatisticField:void 0;if(!n.has(u)){const e=[];for(const i of s){const s=this._getAttributeValues(t,i,r);e.push(s)}n.set(u,this._calculateUniqueValues(e))}const c=n.get(u);for(const e in c){const{data:s,items:r}=c[e],n=s.join(",");i&&!t.validateItems(r,i)||o.add(n)}}return o.size},f.createQueryResponse=function(e){let t;if(e.outStatistics){t=e.outStatistics.some((e=>"exceedslimit"===e.statisticType))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e)}else t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(i.isValid(e.outSR)&&!i.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=c.cleanFromGeometryEngine({spatialReference:e.outSR,...n.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR)}):t.queryGeometry=c.cleanFromGeometryEngine({spatialReference:e.outSR,...this.queryGeometry})),t},f.executeAttributesQuery=function(e){const t=a.getWhereClause(e.where,this.fieldsIndex);if(!t)return s.resolve(this);if(t.isStandardized){let i=0;const r=[];for(const e of this.items)t.testFeature(e,this.featureAdapter)&&(r[i++]=e);const n=new h(r,this.queryGeometry,this);return n.definitionExpression=e.where,s.resolve(n)}return s.reject(new TypeError("Where clause is not standardized"))},f.executeAggregateIdsQuery=function(e){if(!e.aggregateIds||!e.aggregateIds.length||t.isNone(this.aggregateAdapter))return s.resolve(this);const i=new Set;for(const t of e.aggregateIds){this.aggregateAdapter.getFeatureObjectIds(t).forEach((e=>i.add(e)))}const r=this.featureAdapter.getObjectId;return s.resolve(new h(this.items.filter((e=>i.has(r(e)))),this.queryGeometry,this))},f.executeObjectIdsQuery=function(e){if(!e.objectIds||!e.objectIds.length)return s.resolve(this);const t=new Set(e.objectIds),i=this.featureAdapter.getObjectId;return s.resolve(new h(this.items.filter((e=>t.has(i(e)))),this.queryGeometry,this))},f.executeTimeQuery=function(e){const i=l.getTimeOperator(this.timeInfo,e.timeExtent,this.featureAdapter);if(!t.isSome(i))return s.resolve(this);const r=this.items.filter(i);return s.resolve(new h(r,this.queryGeometry,this))},f.filterLatest=function(){const{trackIdField:e,startTimeField:t,endTimeField:i}=this.timeInfo,r=i||t,n=new Map,o=this.featureAdapter.getAttribute;for(const t of this.items){const s=o(t,e),i=o(t,r),a=n.get(s);(!a||i>o(a,r))&&n.set(s,t)}const a=Array.from(n.values());return s.resolve(new h(a,this.queryGeometry,this))},f.project=async function(e){if(!e||i.equals(this.spatialReference,e))return this;const t=this.featureAdapter;return new h((await n.projectMany(this.items.map((e=>c.getGeometry(this.geometryType,this.hasZ,this.hasM,t.getGeometry(e)))),this.spatialReference,e)).map(((e,s)=>t.cloneWithGeometry(this.items[s],r.convertFromGeometry(e,this.hasZ,this.hasM)))),this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:e,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})},f._sortFeatures=function(e,t,s){if(e.length>1&&t&&t.length)for(const i of t.reverse()){const t=i.split(" "),r=t[0],n=this.fieldsIndex.get(r),o=t[1]&&"desc"===t[1].toLowerCase();e.sort(((e,t)=>m(s(e,r,n),s(t,r,n),n,o)))}},f._createFeatureQueryResponse=function(e){const t=this.items,{geometryType:s,hasM:i,hasZ:r,objectIdField:n,spatialReference:a}=this,{outFields:u,outSR:l,quantizationParameters:h,resultRecordCount:f,resultOffset:d,returnZ:m,returnM:p}=e,g=null!=f&&t.length>(d||0)+f,y=u&&(u.indexOf("*")>-1?[...this.fieldsIndex.fields]:u.map((e=>this.fieldsIndex.get(e))));return{exceededTransferLimit:g,features:this._createFeatures(e,t),fields:y,geometryType:s,hasM:i&&p,hasZ:r&&m,objectIdFieldName:n,spatialReference:c.cleanFromGeometryEngine(l||a),transform:h&&o.toQuantizationTransform(h)||null}},f._createFeatures=function(e,t){const s=new u(e,this.featureAdapter,this.fieldsIndex),{hasM:i,hasZ:r}=this,{orderByFields:n,quantizationParameters:a,returnGeometry:l,returnCentroid:h,maxAllowableOffset:f,resultOffset:d,resultRecordCount:m,returnZ:p=!1,returnM:g=!1}=e,y=r&&p,I=i&&g;let b=[],F=0;const T=[...t];if(this._sortFeatures(T,n,((e,t,i)=>s.getFieldValue(e,t,i))),l||h){const e=o.toQuantizationTransform(a);if(l&&!h)for(const t of T)b[F++]={attributes:s.getAttributes(t),geometry:c.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),f,e,y,I)};else if(!l&&h)for(const t of T)b[F++]={attributes:s.getAttributes(t),centroid:c.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of T)b[F++]={attributes:s.getAttributes(t),centroid:c.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e),geometry:c.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),f,e,y,I)}}else for(const e of T){const t=s.getAttributes(e);t&&(b[F++]={attributes:t})}const x=d||0;if(null!=m){const e=x+m;b=b.slice(x,Math.min(b.length,e))}return b},f._createExceedsLimitQueryResponse=function(e){let t=!1,s=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY;for(const t of e.outStatistics)if("exceedslimit"===t.statisticType){s=null!=t.maxPointCount?t.maxPointCount:Number.POSITIVE_INFINITY,i=null!=t.maxRecordCount?t.maxRecordCount:Number.POSITIVE_INFINITY,r=null!=t.maxVertexCount?t.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)t=this.items.length>s;else if(this.items.length>i)t=!0;else{const e=this.hasZ?this.hasM?4:3:this.hasM?3:2,s=this.featureAdapter;t=this.items.reduce(((e,t)=>{const i=s.getGeometry(t);return e+(i&&i.coords.length||0)}),0)/e>r}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},f._createStatisticsQueryResponse=function(e){const t={attributes:{}},s=[],i=new Map,r=new Map,n=new Map,o=new Map,a=new u(e,this.featureAdapter,this.fieldsIndex),c=e.outStatistics,{groupByFieldsForStatistics:l,having:h,orderByFields:f}=e,d=l&&l.length,m=!!d,p=m&&l[0],g=m&&!this.fieldsIndex.get(p);for(const e of c){const{outStatisticFieldName:u,statisticType:c}=e,f=e,y="exceedslimit"!==c?e.onStatisticField:void 0,I="percentile_disc"===c||"percentile_cont"===c,b=m&&1===d&&(y===p||g)&&"count"===c;if(m){if(!n.has(y)){const e=[];for(const t of l){const s=this._getAttributeValues(a,t,i);e.push(s)}n.set(y,this._calculateUniqueValues(e))}const e=n.get(y);for(const t in e){const{count:s,data:r,items:n,itemPositions:c}=e[t],d=r.join(",");if(!h||a.validateItems(n,h)){const e=o.get(d)||{attributes:{}};let t=null;if(b)t=s;else{const e=this._getAttributeValues(a,y,i),s=c.map((t=>e[t]));t=I&&"statisticParameters"in f?this._getPercentileValue(f,s):this._getStatisticValue(f,s)}e.attributes[u]=t,l.forEach(((t,s)=>e.attributes[this.fieldsIndex.get(t)?t:`EXPR_${s+1}`]=r[s])),o.set(d,e)}}}else{const e=this._getAttributeValues(a,y,i);t.attributes[u]=I&&"statisticParameters"in f?this._getPercentileValue(f,e):this._getStatisticValue(f,e,r)}s.push({name:u,alias:u,type:"esriFieldTypeDouble"})}const y=m?Array.from(o.values()):[t];return this._sortFeatures(y,f,((e,t)=>e.attributes[t])),{fields:s,features:y}},f._getStatisticValue=function(e,t,s){const{onStatisticField:i,statisticType:r}=e,n=s&&s.has(i)?s.get(i):this._calculateStatistics(t);s&&s.set(i,n);return n["var"===r?"variance":r]},f._getPercentileValue=function(e,t){const{onStatisticField:s,statisticParameters:i,statisticType:r}=e,{value:n,orderBy:o}=i,a="desc"===o,u=this.fieldsIndex.get(s),c=[...t].filter((e=>null!=e)).sort(((e,t)=>m(e,t,u,a)));return this._calculatePercentile(c,n,"percentile_disc"===r)},f._getAttributeValues=function(e,t,s){if(s.has(t))return s.get(t);const i=this.fieldsIndex.get(t),r=this.items.map((s=>e.getFieldValue(s,t,i)));return s.set(t,r),r},f._calculateStatistics=function(e){let t=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,i=null,r=null,n=null,o=null;const a=[];let u=0;for(const r of e)"string"==typeof r?u++:null==r||isNaN(r)||(i+=r,t=Math.min(t,r),s=Math.max(s,r),a.push(r),u++);if(u){r=i/u;let e=0;for(const t of a)e+=Math.pow(t-r,2);o=u>1?e/(u-1):0,n=Math.sqrt(o)}else t=null,s=null;return{avg:r,count:u,max:s,min:t,stddev:n,sum:i,variance:o}},f._calculateUniqueValues=function(e){const t={},s=this.items,i=s.length;for(let r=0;r<i;r++){const i=s[r],n=[];for(const t of e)n.push(t[r]);const o=n.join(",");null==t[o]?t[o]={count:1,data:n,items:[i],itemPositions:[r]}:(t[o].count++,t[o].items.push(i),t[o].itemPositions.push(r))}return t},f._calculatePercentile=function(e,t,s){if(0===e.length)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];const i=(e.length-1)*t,r=Math.floor(i),n=r+1,o=i%1,a=e[r],u=e[n];return n>=e.length||s||"string"==typeof a||"string"==typeof u?a:a*(1-o)+u*o},e._createClass(h,[{key:"size",get:function(){return this.items.length}}]),h}()}));
