/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../geometry/support/centroid","../../../geometry/support/extentUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils","../../support/fieldUtils","../../../statistics/utils","../../../support/arcadeOnDemand"],(function(e,t,i,s,n,r,a,o,l,u,c,d,m,f,h,p,g){"use strict";let y=function(){function y(e,t,i){this.items=e,this.queryGeometry=t,this.definitionExpression=i.definitionExpression,this.geometryType=i.geometryType,this.hasM=i.hasM,this.hasZ=i.hasZ,this.objectIdField=i.objectIdField,this.spatialReference=i.spatialReference,this.fieldsIndex=i.fieldsIndex,this.timeInfo=i.timeInfo,this.featureAdapter=i.featureAdapter,this.aggregateAdapter=i.aggregateAdapter}var T=y.prototype;return T.createQueryResponseForCount=function(e){const t=new u(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);const{groupByFieldsForStatistics:i,having:s}=e;if(!!!(null==i?void 0:i.length))return 1;const n=new Map,r=new Map,a=new Set,o=e.outStatistics;for(const l of o){const{statisticType:e}=l,o="exceedslimit"!==e?l.onStatisticField:void 0;if(!r.has(o)){const e=[];for(const s of i){const i=this._getAttributeValues(t,s,n);e.push(i)}r.set(o,this._calculateUniqueValues(e,t.returnDistinctValues))}const u=r.get(o);for(const i in u){const{data:e,items:n}=u[i],r=e.join(",");s&&!t.validateItems(n,s)||a.add(r)}}return a.size},T.createQueryResponse=function(){var e=i._asyncToGenerator((function*(e){let t;if(e.outStatistics){t=e.outStatistics.some((e=>"exceedslimit"===e.statisticType))?this._createExceedsLimitQueryResponse(e):yield this._createStatisticsQueryResponse(e)}else t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(o.isValid(e.outSR)&&!o.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=f.cleanFromGeometryEngine({spatialReference:e.outSR,...d.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR)}):t.queryGeometry=f.cleanFromGeometryEngine({spatialReference:e.outSR,...this.queryGeometry})),t}));function t(t){return e.apply(this,arguments)}return t}(),T.createSnappingResponse=function(e,i){const n=this.featureAdapter,r=I(this.hasZ,this.hasM),{x:a,y:o}=e.point,l="number"==typeof e.distance?e.distance:e.distance.x,u="number"==typeof e.distance?e.distance:e.distance.y,c={candidates:[]},d="esriGeometryPolygon"===this.geometryType,m=this._getPointCreator(e.point,this.spatialReference,i);for(const f of this.items){const i=n.getGeometry(f);if(s.isNone(i))continue;const{coords:h,lengths:p}=i;if(e.types&t.SnappingTypes.EDGE){let e=0;for(let t=0;t<p.length;t++){const i=p[t];for(let t=0;t<i;t++,e+=r){const s=h[e],d=h[e+1];if(t!==i-1){const t=h[e+r],i=h[e+r+1],{x:p,y:g}=x(a,o,s,d,t,i),y=(a-p)/l,I=(o-g)/u,T=y*y+I*I;T<=1&&c.candidates.push({type:"edge",objectId:n.getObjectId(f),distance:Math.sqrt(T),target:m(p,g),start:m(s,d),end:m(t,i)})}}}}if(e.types&t.SnappingTypes.VERTEX){const e=d?h.length-r:h.length;for(let t=0;t<e;t+=r){const e=h[t],i=h[t+1],s=(a-e)/l,r=(o-i)/u,d=s*s+r*r;d<=1&&c.candidates.push({type:"vertex",objectId:n.getObjectId(f),distance:Math.sqrt(d),target:m(e,i)})}}}return c.candidates.sort(((e,t)=>e.distance-t.distance)),c},T._getPointCreator=function(e,t,i){const n=s.isSome(i)&&!o.equals(t,i)?e=>d.project(e,t,i):e=>e;return null!=e.z&&null!=e.m?(t,i)=>n({x:t,y:i,z:e.z,m:e.m}):null!=e.z?(t,i)=>n({x:t,y:i,z:e.z}):null!=e.m?(t,i)=>n({x:t,y:i,m:e.m}):(e,t)=>n({x:e,y:t})},T.executeAttributesQuery=function(e){const t=c.getWhereClause(e.where,this.fieldsIndex);if(!t)return Promise.resolve(this);if(t.isStandardized){let i=0;const s=[];for(const e of this.items)t.testFeature(e,this.featureAdapter)&&(s[i++]=e);const n=new y(s,this.queryGeometry,this);return n.definitionExpression=e.where,Promise.resolve(n)}return Promise.reject(new TypeError("Where clause is not standardized"))},T.executeAggregateIdsQuery=function(e){if(!e.aggregateIds||!e.aggregateIds.length||s.isNone(this.aggregateAdapter))return Promise.resolve(this);const t=new Set;for(const s of e.aggregateIds){this.aggregateAdapter.getFeatureObjectIds(s).forEach((e=>t.add(e)))}const i=this.featureAdapter.getObjectId;return Promise.resolve(new y(this.items.filter((e=>t.has(i(e)))),this.queryGeometry,this))},T.executeObjectIdsQuery=function(e){if(!e.objectIds||!e.objectIds.length)return Promise.resolve(this);const t=new Set(e.objectIds),i=this.featureAdapter.getObjectId;return Promise.resolve(new y(this.items.filter((e=>t.has(i(e)))),this.queryGeometry,this))},T.executeTimeQuery=function(e){const t=m.getTimeOperator(this.timeInfo,e.timeExtent,this.featureAdapter);if(!s.isSome(t))return Promise.resolve(this);const i=this.items.filter(t);return Promise.resolve(new y(i,this.queryGeometry,this))},T.filterLatest=function(){const{trackIdField:e,startTimeField:t,endTimeField:i}=this.timeInfo,s=i||t,n=new Map,r=this.featureAdapter.getAttribute;for(const o of this.items){const t=r(o,e),i=r(o,s),a=n.get(t);(!a||i>r(a,s))&&n.set(t,o)}const a=Array.from(n.values());return Promise.resolve(new y(a,this.queryGeometry,this))},T.project=function(){var e=i._asyncToGenerator((function*(e){if(!e||o.equals(this.spatialReference,e))return this;const t=this.featureAdapter;return new y((yield d.projectMany(this.items.map((e=>f.getGeometry(this.geometryType,this.hasZ,this.hasM,t.getGeometry(e)))),this.spatialReference,e)).map(((e,i)=>t.cloneWithGeometry(this.items[i],l.convertFromGeometry(e,this.hasZ,this.hasM)))),this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:e,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})}));function t(t){return e.apply(this,arguments)}return t}(),T.createSummaryStatisticsResponse=function(){var e=i._asyncToGenerator((function*(e,t){const{field:i,valueExpression:s,normalizationField:n,normalizationType:r,normalizationTotal:a,minValue:o,maxValue:l,scale:u}=t,c=this.fieldsIndex.isDateField(i),d=yield this._getDataValues(e,{field:i,valueExpression:s,normalizationField:n,normalizationType:r,normalizationTotal:a,scale:u}),m=p.isNullCountSupported({normalizationType:r,normalizationField:n,minValue:o,maxValue:l}),f=this.fieldsIndex.get(i),g={value:.5,fieldType:null==f?void 0:f.type},y=h.isStringField(f)?p.calculateStringStatistics({values:d,supportsNullCount:m,percentileParams:g}):p.calculateStatistics({values:d,minValue:o,maxValue:l,useSampleStdDev:!r,supportsNullCount:m,percentileParams:g});return p.processSummaryStatisticsResult(y,c)}));function t(t,i){return e.apply(this,arguments)}return t}(),T.createUniqueValuesResponse=function(){var e=i._asyncToGenerator((function*(e,t){const{field:i,valueExpression:s,domain:n,returnAllCodedValues:r,scale:a}=t,o=yield this._getDataValues(e,{field:i,valueExpression:s,scale:a}),l=p.calculateUniqueValuesCount(o);return p.createUVResult(l,n,r)}));function t(t,i){return e.apply(this,arguments)}return t}(),T.createClassBreaksResponse=function(){var e=i._asyncToGenerator((function*(e,t){const{field:i,valueExpression:s,normalizationField:n,normalizationType:r,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:l,minValue:u,maxValue:c,numClasses:d,scale:m}=t,f=yield this._getDataValues(e,{field:i,valueExpression:s,normalizationField:n,normalizationType:r,normalizationTotal:a,scale:m}),h=p.calculateClassBreaks(f,{field:i,normalizationField:n,normalizationType:r,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:l,minValue:u,maxValue:c,numClasses:d});return p.resolveCBResult(h,o)}));function t(t,i){return e.apply(this,arguments)}return t}(),T.createHistogramResponse=function(){var e=i._asyncToGenerator((function*(e,t){const{field:i,valueExpression:s,normalizationField:n,normalizationType:r,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:l,minValue:u,maxValue:c,numBins:d,scale:m}=t,f=yield this._getDataValues(e,{field:i,valueExpression:s,normalizationField:n,normalizationType:r,normalizationTotal:a,scale:m});return p.calculateHistogram(f,{field:i,normalizationField:n,normalizationType:r,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:l,minValue:u,maxValue:c,numBins:d})}));function t(t,i){return e.apply(this,arguments)}return t}(),T._sortFeatures=function(e,t,i){if(e.length>1&&t&&t.length)for(const s of t.reverse()){const t=s.split(" "),n=t[0],r=this.fieldsIndex.get(n),a=t[1]&&"desc"===t[1].toLowerCase(),o=p.getAttributeComparator(null==r?void 0:r.type,a);e.sort(((e,t)=>{const s=i(e,n,r),a=i(t,n,r);return o(s,a)}))}},T._createFeatureQueryResponse=function(e){const t=this.items,{geometryType:i,hasM:s,hasZ:n,objectIdField:r,spatialReference:o}=this,{outFields:l,outSR:u,quantizationParameters:c,resultRecordCount:d,resultOffset:m,returnZ:h,returnM:p}=e,g=null!=d&&t.length>(m||0)+d,y=l&&(l.includes("*")?[...this.fieldsIndex.fields]:l.map((e=>this.fieldsIndex.get(e))));return{exceededTransferLimit:g,features:this._createFeatures(e,t),fields:y,geometryType:i,hasM:s&&p,hasZ:n&&h,objectIdFieldName:r,spatialReference:f.cleanFromGeometryEngine(u||o),transform:c&&a.toQuantizationTransform(c)||null}},T._createFeatures=function(e,t){const i=new u(e,this.featureAdapter,this.fieldsIndex),{hasM:s,hasZ:n}=this,{orderByFields:r,quantizationParameters:o,returnGeometry:l,returnCentroid:c,maxAllowableOffset:d,resultOffset:m,resultRecordCount:h,returnZ:p=!1,returnM:g=!1}=e,y=n&&p,x=s&&g;let I=[],T=0;const v=[...t];if(this._sortFeatures(v,r,((e,t,s)=>i.getFieldValue(e,t,s))),l||c){const e=a.toQuantizationTransform(o);if(l&&!c)for(const t of v)I[T++]={attributes:i.getAttributes(t),geometry:f.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),d,e,y,x)};else if(!l&&c)for(const t of v)I[T++]={attributes:i.getAttributes(t),centroid:f.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of v)I[T++]={attributes:i.getAttributes(t),centroid:f.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e),geometry:f.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),d,e,y,x)}}else for(const a of v){const e=i.getAttributes(a);e&&(I[T++]={attributes:e})}const S=m||0;if(null!=h){const e=S+h;I=I.slice(S,Math.min(I.length,e))}return I},T._createExceedsLimitQueryResponse=function(e){let t=!1,i=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY;for(const s of e.outStatistics)if("exceedslimit"===s.statisticType){i=null!=s.maxPointCount?s.maxPointCount:Number.POSITIVE_INFINITY,n=null!=s.maxRecordCount?s.maxRecordCount:Number.POSITIVE_INFINITY,r=null!=s.maxVertexCount?s.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)t=this.items.length>i;else if(this.items.length>n)t=!0;else{const e=this.hasZ?this.hasM?4:3:this.hasM?3:2,i=this.featureAdapter;t=this.items.reduce(((e,t)=>{const n=i.getGeometry(t);return e+(s.isSome(n)&&n.coords.length||0)}),0)/e>r}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},T._createStatisticsQueryResponse=function(){var e=i._asyncToGenerator((function*(e){const t={attributes:{}},i=[],s=new Map,n=new Map,r=new Map,a=new Map,o=new u(e,this.featureAdapter,this.fieldsIndex),l=e.outStatistics,{groupByFieldsForStatistics:c,having:d,orderByFields:m}=e,f=c&&c.length,h=!!f,p=h&&c[0],g=h&&!this.fieldsIndex.get(p);for(const u of l){const{outStatisticFieldName:e,statisticType:l}=u,m=u,y="exceedslimit"!==l?u.onStatisticField:void 0,x="percentile_disc"===l||"percentile_cont"===l,I="EnvelopeAggregate"===l||"CentroidAggregate"===l||"ConvexHullAggregate"===l,T=h&&1===f&&(y===p||g)&&"count"===l;if(h){if(!r.has(y)){const e=[];for(const t of c){const i=this._getAttributeValues(o,t,s);e.push(i)}r.set(y,this._calculateUniqueValues(e,o.returnDistinctValues))}const t=r.get(y);for(const i in t){const{count:n,data:r,items:l,itemPositions:u}=t[i],f=r.join(",");if(!d||o.validateItems(l,d)){const t=a.get(f)||{attributes:{}};if(I){t.aggregateGeometries||(t.aggregateGeometries={});const{aggregateGeometries:e,outStatisticFieldName:i}=yield this._getAggregateGeometry(m,l);t.aggregateGeometries[i]=e}else{let i=null;if(T)i=n;else{const e=this._getAttributeValues(o,y,s),t=u.map((t=>e[t]));i=x&&"statisticParameters"in m?this._getPercentileValue(m,t):this._getStatisticValue(m,t,null,o.returnDistinctValues)}t.attributes[e]=i}c.forEach(((e,i)=>t.attributes[this.fieldsIndex.get(e)?e:`EXPR_${i+1}`]=r[i])),a.set(f,t)}}}else if(I){t.aggregateGeometries||(t.aggregateGeometries={});const{aggregateGeometries:e,outStatisticFieldName:i}=yield this._getAggregateGeometry(m,this.items);t.aggregateGeometries[i]=e}else{const i=this._getAttributeValues(o,y,s);t.attributes[e]=x&&"statisticParameters"in m?this._getPercentileValue(m,i):this._getStatisticValue(m,i,n,o.returnDistinctValues)}i.push({name:e,alias:e,type:"esriFieldTypeDouble"})}const y=h?Array.from(a.values()):[t];return this._sortFeatures(y,m,((e,t)=>e.attributes[t])),{fields:i,features:y}}));function t(t){return e.apply(this,arguments)}return t}(),T._getAggregateGeometry=function(){var t=i._asyncToGenerator((function*(t,i){const s=yield new Promise(((t,i)=>e(["../../../geometry/geometryEngineJSON"],t,i))),{statisticType:a,outStatisticFieldName:o}=t,{featureAdapter:l,spatialReference:u,geometryType:c,hasZ:d,hasM:m}=this,h=i.map((e=>f.getGeometry(c,d,m,l.getGeometry(e)))),p=s.convexHull(u,h,!0)[0],g={aggregateGeometries:null,outStatisticFieldName:null};if("EnvelopeAggregate"===a){const e=p?r.getPolygonExtent(p):r.getGeometryExtent(s.union(u,h));g.aggregateGeometries={...e,spatialReference:u},g.outStatisticFieldName=o||"extent"}else if("CentroidAggregate"===a){const e=p?n.polygonCentroid(p):n.extentCentroid(r.getGeometryExtent(s.union(u,h)));g.aggregateGeometries={x:e[0],y:e[1],spatialReference:u},g.outStatisticFieldName=o||"centroid"}else"ConvexHullAggregate"===a&&(g.aggregateGeometries=p,g.outStatisticFieldName=o||"convexHull");return g}));function s(e,i){return t.apply(this,arguments)}return s}(),T._getStatisticValue=function(e,t,i,s){const{onStatisticField:n,statisticType:r}=e;let a=null;a=null!=i&&i.has(n)?i.get(n):h.isStringField(this.fieldsIndex.get(n))?p.calculateStringStatistics({values:t,returnDistinct:s}):p.calculateStatistics({values:t,minValue:null,maxValue:null,useSampleStdDev:!0}),i&&i.set(n,a);return a["var"===r?"variance":r]},T._getPercentileValue=function(e,t){const{onStatisticField:i,statisticParameters:s,statisticType:n}=e,{value:r,orderBy:a}=s,o=this.fieldsIndex.get(i),l={value:r,orderBy:a,fieldType:null==o?void 0:o.type,isDiscrete:"percentile_disc"===n};return p.calculatePercentile(t,l)},T._getAttributeValues=function(e,t,i){if(i.has(t))return i.get(t);const s=this.fieldsIndex.get(t),n=this.items.map((i=>e.getFieldValue(i,t,s)));return i.set(t,n),n},T._getAttributeNormalizedValues=function(e,t){return this.items.map((i=>e.getNormalizedValue(i,{field:t.field,fieldInfo:this.fieldsIndex.get(t.field),normalizationField:t.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(t.normalizationField),normalizationType:t.normalizationType,normalizationTotal:t.normalizationTotal})))},T._getAttributeExpressionValues=function(){var e=i._asyncToGenerator((function*(e,t,i){const{arcadeUtils:s}=yield g.loadArcade(),n=s.createFunction(t),r=i&&s.getViewInfo(i);return this.items.map((t=>e.getExpressionValue(t,{compiledFunc:n,viewInfo:r},s)))}));function t(t,i,s){return e.apply(this,arguments)}return t}(),T._calculateUniqueValues=function(e,t){const i={},s=this.items,n=s.length;for(let r=0;r<n;r++){const n=s[r],a=[];for(const t of e)a.push(t[r]);const o=a.join(",");t?null==i[o]&&(i[o]={count:1,data:a,items:[n],itemPositions:[r]}):null==i[o]?i[o]={count:1,data:a,items:[n],itemPositions:[r]}:(i[o].count++,i[o].items.push(n),i[o].itemPositions.push(r))}return i},T._getDataValues=function(){var e=i._asyncToGenerator((function*(e,t){const i=new u(e,this.featureAdapter,this.fieldsIndex),{valueExpression:s,field:n,normalizationField:r,normalizationType:a,normalizationTotal:o,scale:l}=t,c=s?{viewingMode:"map",scale:l,spatialReference:e.outSR||this.spatialReference}:null;return s?this._getAttributeExpressionValues(i,s,c):this._getAttributeNormalizedValues(i,{field:n,normalizationField:r,normalizationType:a,normalizationTotal:o})}));function t(t,i){return e.apply(this,arguments)}return t}(),i._createClass(y,[{key:"size",get:function(){return this.items.length}}]),y}();function x(e,t,i,s,n,r){const a=n-i,o=r-s,l=a*a+o*o,u=(e-i)*a+(t-s)*o,c=Math.min(1,Math.max(0,u/l));return{x:i+a*c,y:s+o*c}}function I(e,t){return e?t?4:3:t?3:2}var T;t.SnappingTypes=void 0,(T=t.SnappingTypes||(t.SnappingTypes={}))[T.NONE=0]="NONE",T[T.EDGE=1]="EDGE",T[T.VERTEX=2]="VERTEX",t.default=y,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
