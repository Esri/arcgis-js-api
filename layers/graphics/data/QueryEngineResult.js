// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../core/MapUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/SetUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils"],(function(e,t,r,i,s,n,a,u,o,l,h,f,c,p,d){"use strict";function m(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function y(e,t,r){return(r?e>t:e<t)?-1:(r?e<t:e>t)?1:0}function g(e,t,r){return r?t-e:e-t}function v(e,t,r,i){if(r&&"esriFieldTypeDate"===r.type){var s=new Date(e).getTime(),n=new Date(t).getTime();if(!isNaN(s)&&!isNaN(n))return g(s,n,i)}if("number"==typeof e&&"number"==typeof t)return g(e,t,i);if("string"==typeof e&&"string"==typeof t){s=e.toUpperCase(),n=t.toUpperCase();return!r||"esriFieldTypeGUID"!==r.type&&"esriFieldTypeGlobalID"!==r.type?y(s,n,i):y(m(s),m(n),i)}return i?1:-1}Object.defineProperty(t,"__esModule",{value:!0});var I=function(){function e(e,t,r){this.items=e,this.queryGeometry=t,this.definitionExpression=r.definitionExpression,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.fieldsIndex=r.fieldsIndex,this.timeInfo=r.timeInfo,this.featureAdapter=r.featureAdapter}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!1,configurable:!0}),e.prototype.createQueryResponseForCount=function(e){var t=new h.default(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);var r=e.groupByFieldsForStatistics,i=e.having;if(!!!(null==r?void 0:r.length))return 1;for(var s=new Map,n=new Map,a=new Set,u=0,o=e.outStatistics;u<o.length;u++){var l=o[u],f="exceedslimit"!==l.statisticType?l.onStatisticField:void 0;if(!n.has(f)){for(var c=[],p=0,d=r;p<d.length;p++){var m=d[p],y=this._getAttributeValues(t,m,s);c.push(y)}n.set(f,this._calculateUniqueValues(c))}var g=n.get(f);for(var v in g){var I=g[v],b=I.data,_=I.items,F=b.join(",");i&&!t.validateItems(_,i)||a.add(F)}}return a.size},e.prototype.createQueryResponse=function(e){var t;e.outStatistics?t=e.outStatistics.some((function(e){return"exceedslimit"===e.statisticType}))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(o.isValid(e.outSR)&&!o.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=d.cleanFromGeometryEngine(r.__assign({spatialReference:e.outSR},c.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=d.cleanFromGeometryEngine(r.__assign({spatialReference:e.outSR},this.queryGeometry))),t},e.prototype.executeAttributesQuery=function(t){var r=f.getWhereClause(t.where,this.fieldsIndex);if(!r)return n.resolve(this);if(r.isStandardized){for(var i=0,s=[],a=0,u=this.items;a<u.length;a++){var o=u[a];r.testFeature(o,this.featureAdapter)&&(s[i++]=o)}var l=new e(s,this.queryGeometry,this);return l.definitionExpression=t.where,n.resolve(l)}return n.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(t){if(!t.objectIds||!t.objectIds.length)return n.resolve(this);var r=a.SetFromValues(t.objectIds),i=this.featureAdapter.getObjectId;return n.resolve(new e(this.items.filter((function(e){return r.has(i(e))})),this.queryGeometry,this))},e.prototype.executeTimeQuery=function(t){var r=p.getTimeOperator(this.timeInfo,t.timeExtent,this.featureAdapter);if(!s.isSome(r))return n.resolve(this);var i=this.items.filter(r);return n.resolve(new e(i,this.queryGeometry,this))},e.prototype.filterLatest=function(){for(var t=this.timeInfo,r=t.trackIdField,s=t.startTimeField,a=t.endTimeField||s,u=new Map,o=this.featureAdapter.getAttribute,l=0,h=this.items;l<h.length;l++){var f=h[l],c=o(f,r),p=o(f,a),d=u.get(c);(!d||p>o(d,a))&&u.set(c,f)}var m=i.valuesOfMap(u);return n.resolve(new e(m,this.queryGeometry,this))},e.prototype.project=function(t){return r.__awaiter(this,void 0,void 0,(function(){var i,s,n=this;return r.__generator(this,(function(r){switch(r.label){case 0:return!t||o.equals(this.spatialReference,t)?[2,this]:(i=this.featureAdapter,[4,c.projectMany(this.items.map((function(e){return d.getGeometry(n.geometryType,n.hasZ,n.hasM,i.getGeometry(e))})),this.spatialReference,t)]);case 1:return s=r.sent(),[2,new e(s.map((function(e,t){return i.cloneWithGeometry(n.items[t],l.convertFromGeometry(e,n.hasZ,n.hasM))})),this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:t,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}}))}))},e.prototype._sortFeatures=function(e,t,r){if(e.length>1&&t&&t.length)for(var i=function(t){var i=t.split(" "),n=i[0],a=s.fieldsIndex.get(n),u=i[1]&&"desc"===i[1].toLowerCase();e.sort((function(e,t){return v(r(e,n,a),r(t,n,a),a,u)}))},s=this,n=0,a=t.reverse();n<a.length;n++){i(a[n])}},e.prototype._createFeatureQueryResponse=function(e){var t=this,i=this.items,s=this,n=s.geometryType,a=s.hasM,o=s.hasZ,l=s.objectIdField,h=s.spatialReference,f=e.outFields,c=e.outSR,p=e.quantizationParameters,m=e.resultRecordCount,y=e.resultOffset,g=e.returnZ,v=e.returnM,I=null!=m&&i.length>(y||0)+m,b=f&&(f.indexOf("*")>-1?r.__spreadArrays(this.fieldsIndex.fields):f.map((function(e){return t.fieldsIndex.get(e)})));return{exceededTransferLimit:I,features:this._createFeatures(e,i),fields:b,geometryType:n,hasM:a&&v,hasZ:o&&g,objectIdFieldName:l,spatialReference:d.cleanFromGeometryEngine(c||h),transform:p&&u.toQuantizationTransform(p)||null}},e.prototype._createFeatures=function(e,t){var i=new h.default(e,this.featureAdapter,this.fieldsIndex),s=this.hasM,n=this.hasZ,a=e.orderByFields,o=e.quantizationParameters,l=e.returnGeometry,f=e.returnCentroid,c=e.maxAllowableOffset,p=e.resultOffset,m=e.resultRecordCount,y=e.returnZ,g=void 0!==y&&y,v=e.returnM,I=n&&g,b=s&&(void 0!==v&&v),_=[],F=0,T=r.__spreadArrays(t);if(this._sortFeatures(T,a,(function(e,t,r){return i.getFieldValue(e,t,r)})),l||f){var x=u.toQuantizationTransform(o);if(l&&!f)for(var S=0,A=T;S<A.length;S++){P=A[S];_[F++]={attributes:i.getAttributes(P),geometry:d.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(P),c,x,I,b)}}else if(!l&&f)for(var N=0,M=T;N<M.length;N++){P=M[N];_[F++]={attributes:i.getAttributes(P),centroid:d.transformCentroid(this,this.featureAdapter.getCentroid(P,this),x)}}else for(var R=0,G=T;R<G.length;R++){P=G[R];_[F++]={attributes:i.getAttributes(P),centroid:d.transformCentroid(this,this.featureAdapter.getCentroid(P,this),x),geometry:d.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(P),c,x,I,b)}}}else for(var V=0,w=T;V<w.length;V++){var P=w[V],q=i.getAttributes(P);q&&(_[F++]={attributes:q})}var E=p||0;if(null!=m){var j=E+m;_=_.slice(E,Math.min(_.length,j))}return _},e.prototype._createExceedsLimitQueryResponse=function(e){for(var t=!1,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,n=0,a=e.outStatistics;n<a.length;n++){var u=a[n];if("exceedslimit"===u.statisticType){r=null!=u.maxPointCount?u.maxPointCount:Number.POSITIVE_INFINITY,i=null!=u.maxRecordCount?u.maxRecordCount:Number.POSITIVE_INFINITY,s=null!=u.maxVertexCount?u.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)t=this.items.length>r;else if(this.items.length>i)t=!0;else{var o=this.hasZ?this.hasM?4:3:this.hasM?3:2,l=this.featureAdapter;t=this.items.reduce((function(e,t){var r=l.getGeometry(t);return e+(r&&r.coords.length||0)}),0)/o>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},e.prototype._createStatisticsQueryResponse=function(e){for(var t=this,r={attributes:{}},s=[],n=new Map,a=new Map,u=new Map,o=new Map,l=new h.default(e,this.featureAdapter,this.fieldsIndex),f=e.outStatistics,c=e.groupByFieldsForStatistics,p=e.having,d=e.orderByFields,m=c&&c.length,y=!!m,g=y&&c[0],v=y&&!this.fieldsIndex.get(g),I=0,b=f;I<b.length;I++){var _=b[I],F=_.outStatisticFieldName,T=_.statisticType,x=_,S="exceedslimit"!==T?_.onStatisticField:void 0,A="percentile_disc"===T||"percentile_cont"===T,N=y&&1===m&&(S===g||v)&&"count"===T;if(y){if(!u.has(S)){for(var M=[],R=0,G=c;R<G.length;R++){var V=G[R],w=this._getAttributeValues(l,V,n);M.push(w)}u.set(S,this._calculateUniqueValues(M))}var P=u.get(S),q=function(e){var r=P[e],i=r.count,s=r.data,a=r.items,u=r.itemPositions,h=s.join(",");if(!p||l.validateItems(a,p)){var f=o.get(h)||{attributes:{}},d=null;if(N)d=i;else{var m=E._getAttributeValues(l,S,n),y=u.map((function(e){return m[e]}));d=A&&"statisticParameters"in x?E._getPercentileValue(x,y):E._getStatisticValue(x,y)}f.attributes[F]=d,c.forEach((function(e,r){return f.attributes[t.fieldsIndex.get(e)?e:"EXPR_"+(r+1)]=s[r]})),o.set(h,f)}},E=this;for(var j in P)q(j)}else{w=this._getAttributeValues(l,S,n);r.attributes[F]=A&&"statisticParameters"in x?this._getPercentileValue(x,w):this._getStatisticValue(x,w,a)}s.push({name:F,alias:F,type:"esriFieldTypeDouble"})}var C=y?i.valuesOfMap(o):[r];return this._sortFeatures(C,d,(function(e,t){return e.attributes[t]})),{fields:s,features:C}},e.prototype._getStatisticValue=function(e,t,r){var i=e.onStatisticField,s=e.statisticType,n=r&&r.has(i)?r.get(i):this._calculateStatistics(t);return r&&r.set(i,n),n["var"===s?"variance":s]},e.prototype._getPercentileValue=function(e,t){var i=e.onStatisticField,s=e.statisticParameters,n=e.statisticType,a=s.value,u="desc"===s.orderBy,o=this.fieldsIndex.get(i),l=r.__spreadArrays(t).filter((function(e){return null!=e})).sort((function(e,t){return v(e,t,o,u)}));return this._calculatePercentile(l,a,"percentile_disc"===n)},e.prototype._getAttributeValues=function(e,t,r){if(r.has(t))return r.get(t);var i=this.fieldsIndex.get(t),s=this.items.map((function(r){return e.getFieldValue(r,t,i)}));return r.set(t,s),s},e.prototype._calculateStatistics=function(e){for(var t=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,i=null,s=null,n=null,a=null,u=[],o=0,l=0,h=e;l<h.length;l++){"string"==typeof(d=h[l])?o++:null==d||isNaN(d)||(i+=d,t=Math.min(t,d),r=Math.max(r,d),u.push(d),o++)}if(o){s=i/o;for(var f=0,c=0,p=u;c<p.length;c++){var d=p[c];f+=Math.pow(d-s,2)}a=o>1?f/(o-1):0,n=Math.sqrt(a)}else t=null,r=null;return{avg:s,count:o,max:r,min:t,stddev:n,sum:i,variance:a}},e.prototype._calculateUniqueValues=function(e){for(var t={},r=this.items,i=r.length,s=0;s<i;s++){for(var n=r[s],a=[],u=0,o=e;u<o.length;u++){var l=o[u];a.push(l[s])}var h=a.join(",");null==t[h]?t[h]={count:1,data:a,items:[n],itemPositions:[s]}:(t[h].count++,t[h].items.push(n),t[h].itemPositions.push(s))}return t},e.prototype._calculatePercentile=function(e,t,r){if(0===e.length)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];var i=(e.length-1)*t,s=Math.floor(i),n=s+1,a=i%1,u=e[s],o=e[n];return n>=e.length||r||"string"==typeof u||"string"==typeof o?u:u*(1-a)+o*a},e}();t.default=I}));