/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/arrayUtils","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/MemCache","../../../core/unitUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./timeSupport","./utils","../../support/FieldsIndex","../../../support/arcadeOnDemand","../../../views/support/Scheduler"],(function(e,t,i,r,n,s,a,o,u,c,l,h,y,f,d,p,m,g,_,S,x,R,Q,E,F){"use strict";function T(e){return e.every((e=>"exceedslimit"!==e.statisticType))}const I="feature-store:unsupported-query";let v=function(e,t=null,i,r,n){this.attributes=e,this.geometry=i,this.centroid=r,this.filterFlags=n,this.groupId=-1,this.displayId=t};const w=new a.MemCacheStorage(2e6);let G=0,b=function(){function e(e){this.capabilities={query:g.queryCapabilities},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new a.MemCache(G+++"$$",w)),this.fieldsIndex=new Q(e.fields),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}var v=e.prototype;return v.destroy=function(){this._frameTask=s.removeMaybe(this._frameTask),this.clearCache(),s.destroyMaybe(this._geometryQueryCache),this._changeHandle=s.removeMaybe(this._changeHandle),s.destroyMaybe(this.fieldsIndex)},v.clearCache=function(){this._geometryQueryCache?.clear(),this._allItems=null,this._timeExtent=null},v.executeQuery=function(){var e=t._asyncToGenerator((function*(e,t){try{return(yield this._executeQuery(e,{},t)).createQueryResponse()}catch(i){if(i!==R.QUERY_ENGINE_EMPTY_RESULT)throw i;return new _.QueryEngineResult([],e,this).createQueryResponse()}}));function i(t,i){return e.apply(this,arguments)}return i}(),v.executeQueryForCount=function(){var e=t._asyncToGenerator((function*(e={},t){try{return(yield this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null},t)).createQueryResponseForCount()}catch(i){if(i!==R.QUERY_ENGINE_EMPTY_RESULT)throw i;return 0}}));function i(){return e.apply(this,arguments)}return i}(),v.executeQueryForExtent=function(){var e=t._asyncToGenerator((function*(e,t){const i=e.outSR;try{const r=yield this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},t),n=r.size;if(!n)return{count:0,extent:null};u.set(N,u.NEGATIVE_INFINITY),this.featureStore.forEachBounds(r.items,(e=>u.expandWithAABB(N,e)),A);const s={xmin:N[0],ymin:N[1],xmax:N[3],ymax:N[4],spatialReference:R.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(N[2])&&isFinite(N[5])&&(s.zmin=N[2],s.zmax=N[5]);const a=m.project(s,r.spatialReference,i);if(a.spatialReference=R.cleanFromGeometryEngine(i||this.spatialReference),a.xmax-a.xmin==0){const e=o.getMetersPerUnitForSR(a.spatialReference);a.xmin-=e,a.xmax+=e}if(a.ymax-a.ymin==0){const e=o.getMetersPerUnitForSR(a.spatialReference);a.ymin-=e,a.ymax+=e}if(this.hasZ&&null!=a.zmin&&null!=a.zmax&&a.zmax-a.zmin==0){const e=o.getMetersPerUnitForSR(a.spatialReference);a.zmin-=e,a.zmax+=e}return{count:n,extent:a}}catch(r){if(r===R.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw r}}));function i(t,i){return e.apply(this,arguments)}return i}(),v.executeQueryForIds=function(){var e=t._asyncToGenerator((function*(e,t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}));function i(t,i){return e.apply(this,arguments)}return i}(),v.executeQueryForIdSet=function(){var e=t._asyncToGenerator((function*(e,t){try{const i=yield this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},t),r=i.items,n=new Set;return yield this._reschedule((()=>{for(const e of r)n.add(i.featureAdapter.getObjectId(e))}),t),n}catch(i){if(i===R.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw i}}));function i(t,i){return e.apply(this,arguments)}return i}(),v.executeQueryForSnapping=function(){var e=t._asyncToGenerator((function*(e,t){const{point:i,distance:r,types:n}=e;if(n===_.SnappingTypes.NONE)return{candidates:[]};const a=yield this._reschedule((()=>this._checkQuerySupport(e.query)),t),o=!f.equals(i.spatialReference,this.spatialReference);o&&(yield m.checkProjectionSupport(i.spatialReference,this.spatialReference));const u="number"==typeof r?r:r.x,c="number"==typeof r?r:r.y,l={xmin:i.x-u,xmax:i.x+u,ymin:i.y-c,ymax:i.y+c,spatialReference:i.spatialReference},d=o?m.project(l,this.spatialReference):l;if(!d)return{candidates:[]};const p=(yield y.normalizeCentralMeridian(h.fromJSON(i),null,{signal:t}))[0],g=(yield y.normalizeCentralMeridian(h.fromJSON(d),null,{signal:t}))[0];if(s.isNone(p)||s.isNone(g))return{candidates:[]};const S=new _.QueryEngineResult(this._searchFeatures(this._getQueryBBoxes(g.toJSON())),a,this);yield this._reschedule((()=>this._executeObjectIdsQuery(S)),t),yield this._reschedule((()=>this._executeTimeQuery(S)),t),yield this._reschedule((()=>this._executeAttributesQuery(S)),t);const x=p.toJSON(),R=o?m.project(x,this.spatialReference):x,Q=o?Math.max(d.xmax-d.xmin,d.ymax-d.ymin)/2:r;return S.createSnappingResponse({...e,point:R,distance:Q},i.spatialReference)}));function i(t,i){return e.apply(this,arguments)}return i}(),v.executeQueryForLatestObservations=function(){var e=t._asyncToGenerator((function*(e,t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new r(I,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});try{const i=yield this._executeQuery(e,{},t);return yield this._reschedule((()=>this._filterLatest(i)),t),i.createQueryResponse()}catch(i){if(i!==R.QUERY_ENGINE_EMPTY_RESULT)throw i;return new _.QueryEngineResult([],e,this).createQueryResponse()}}));function i(t,i){return e.apply(this,arguments)}return i}(),v.executeQueryForSummaryStatistics=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,normalizationField:n,valueExpression:s}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,normalizationField:n,valueExpression:s},i)).createSummaryStatisticsResponse(t)}));function i(){return e.apply(this,arguments)}return i}(),v.executeQueryForUniqueValues=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,field2:n,field3:s,valueExpression:a}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,field2:n,field3:s,valueExpression:a},i)).createUniqueValuesResponse(t)}));function i(){return e.apply(this,arguments)}return i}(),v.executeQueryForClassBreaks=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,normalizationField:n,valueExpression:s}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,normalizationField:n,valueExpression:s},i)).createClassBreaksResponse(t)}));function i(){return e.apply(this,arguments)}return i}(),v.executeQueryForHistogram=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,normalizationField:n,valueExpression:s}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,normalizationField:n,valueExpression:s},i)).createHistogramResponse(t)}));function i(){return e.apply(this,arguments)}return i}(),v._schedule=function(){var e=t._asyncToGenerator((function*(e,t){return s.isSome(this._frameTask)?this._frameTask.schedule(e,t):e(F.noBudget)}));function i(t,i){return e.apply(this,arguments)}return i}(),v._reschedule=function(){var e=t._asyncToGenerator((function*(e,t){return s.isSome(this._frameTask)?this._frameTask.reschedule(e,t):e(F.noBudget)}));function i(t,i){return e.apply(this,arguments)}return i}(),v._getAll=function(e){return s.isNone(this._allItems)&&(this._allItems=this.featureStore.toArray()),new _.QueryEngineResult(this._allItems,e,this)},v._executeQuery=function(){var e=t._asyncToGenerator((function*(e,t,i){e=n.clone(e),e=yield this._schedule((()=>R.normalizeQuery(e,this.definitionExpression,this.spatialReference)),i),e=yield this._reschedule((()=>this._checkQuerySupport(e)),i),e={...e,...t};const r=yield this._reschedule((()=>this._executeSceneFilterQuery(e,i)),i),s=yield this._reschedule((()=>this._executeGeometryQuery(e,r,i)),i);return yield this._reschedule((()=>this._executeAggregateIdsQuery(s)),i),yield this._reschedule((()=>this._executeObjectIdsQuery(s)),i),yield this._reschedule((()=>this._executeTimeQuery(s)),i),yield this._reschedule((()=>this._executeAttributesQuery(s)),i),s}));function i(t,i,r){return e.apply(this,arguments)}return i}(),v._executeSceneFilterQuery=function(){var e=t._asyncToGenerator((function*(e,i){var r=this;if(s.isNone(e.sceneFilter))return null;const{outSR:n,returnGeometry:a,returnCentroid:o}=e,u=this.featureStore.featureSpatialReference,c=e.sceneFilter.geometry,l=s.isNone(u)||f.equals(u,c.spatialReference)?c:m.project(c,u);if(!l)return null;const h=a||o,y=f.isValid(n)&&!f.equals(this.spatialReference,n)&&h?function(){var e=t._asyncToGenerator((function*(e){return r._project(e,n)}));return function(t){return e.apply(this,arguments)}}():e=>e,d=this.featureAdapter,p=this._searchFeatures(this._getQueryBBoxes(l));if("disjoint"===e.sceneFilter.spatialRelationship){if(!p.length)return null;const n=new Set;for(const e of p)n.add(d.getObjectId(e));const s=yield this._reschedule((()=>this.featureStore.toArray()),i),a=yield this._reschedule(t._asyncToGenerator((function*(){const t=yield S.getSpatialQueryOperator("esriSpatialRelDisjoint",l,r.geometryType,r.hasZ,r.hasM),a=e=>!n.has(d.getObjectId(e))||t(d.getGeometry(e)),o=yield r._runSpatialFilter(s,a,i);return new _.QueryEngineResult(o,e,r)})),i);return y(a)}if(!p.length)return new _.QueryEngineResult([],e,this);if(this._canExecuteSinglePass(l,e))return y(new _.QueryEngineResult(p,e,this));const g=yield S.getSpatialQueryOperator("esriSpatialRelContains",l,this.geometryType,this.hasZ,this.hasM),x=yield this._runSpatialFilter(p,(e=>g(d.getGeometry(e))),i);return y(new _.QueryEngineResult(x,e,this))}));function i(t,i){return e.apply(this,arguments)}return i}(),v._executeGeometryQuery=function(){var e=t._asyncToGenerator((function*(e,r,n){var a=this;if(s.isSome(r)&&0===r.items.length)return r;e=s.isSome(r)?r.query:e;const{geometry:o,outSR:u,spatialRel:c,returnGeometry:l,returnCentroid:h}=e,y=this.featureStore.featureSpatialReference,d=!o||s.isNone(y)||f.equals(y,o.spatialReference)?o:m.project(o,y),p=l||h,g=f.isValid(u)&&!f.equals(this.spatialReference,u),x=this._geometryQueryCache&&s.isNone(r)?g&&p?JSON.stringify({originalFilterGeometry:o,spatialRelationship:c,outSpatialReference:u}):JSON.stringify({originalFilterGeometry:o,spatialRelationship:c}):null,R=x?this._geometryQueryCache.get(x):null;if(s.isSome(R))return new _.QueryEngineResult(R,e,this);const Q=function(){var e=t._asyncToGenerator((function*(e){return g&&p&&(yield a._project(e,u)),x&&a._geometryQueryCache.put(x,e.items,e.items.length+1),e}));return function(t){return e.apply(this,arguments)}}();if(!d)return Q(s.isSome(r)?r:this._getAll(e));const E=this.featureAdapter;let F=this._searchFeatures(this._getQueryBBoxes(o));if("esriSpatialRelDisjoint"===c){if(!F.length)return Q(s.isSome(r)?r:this._getAll(e));const i=new Set;for(const e of F)i.add(E.getObjectId(e));const o=s.isSome(r)?r.items:yield this._reschedule((()=>this.featureStore.toArray()),n),u=yield this._reschedule(t._asyncToGenerator((function*(){const t=yield S.getSpatialQueryOperator(c,d,a.geometryType,a.hasZ,a.hasM),r=e=>!i.has(E.getObjectId(e))||t(E.getGeometry(e)),s=yield a._runSpatialFilter(o,r,n);return new _.QueryEngineResult(s,e,a)})),n);return Q(u)}if(s.isSome(r)){const e=new i.PositionHint;F=F.filter((t=>i.indexOf(r.items,t,r.items.length,e)>=0))}if(!F.length){const t=new _.QueryEngineResult([],e,this);return x&&this._geometryQueryCache.put(x,t.items,1),t}if(this._canExecuteSinglePass(d,e))return Q(new _.QueryEngineResult(F,e,this));const T=yield S.getSpatialQueryOperator(c,d,this.geometryType,this.hasZ,this.hasM),I=yield this._runSpatialFilter(F,(e=>T(E.getGeometry(e))),n);return Q(new _.QueryEngineResult(I,e,this))}));function r(t,i,r){return e.apply(this,arguments)}return r}(),v._executeAggregateIdsQuery=function(e){if(0===e.items.length||!e.query.aggregateIds||!e.query.aggregateIds.length||s.isNone(this.aggregateAdapter))return;const t=new Set;for(const r of e.query.aggregateIds){this.aggregateAdapter.getFeatureObjectIds(r).forEach((e=>t.add(e)))}const i=this.featureAdapter.getObjectId;e.items=e.items.filter((e=>t.has(i(e))))},v._executeObjectIdsQuery=function(e){if(0===e.items.length||!e.query.objectIds||!e.query.objectIds.length)return;const t=new Set(e.query.objectIds),i=this.featureAdapter.getObjectId;e.items=e.items.filter((e=>t.has(i(e))))},v._executeTimeQuery=function(e){if(0===e.items.length)return;const t=x.getTimeOperator(this.timeInfo,e.query.timeExtent,this.featureAdapter);s.isNone(t)||(e.items=e.items.filter(t))},v._executeAttributesQuery=function(e){if(0===e.items.length)return;const t=p.getWhereClause(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter((e=>t.testFeature(e,this.featureAdapter)))}},v._runSpatialFilter=function(){var e=t._asyncToGenerator((function*(e,i,r){var n=this;if(!i)return e;if(s.isNone(this._frameTask))return e.filter((e=>i(e)));let a=0;const o=new Array,u=function(){var s=t._asyncToGenerator((function*(t){for(;a<e.length;){const s=e[a++];i(s)&&(o.push(s),t.madeProgress()),t.done&&(yield n._reschedule((e=>u(e)),r))}}));return function(e){return s.apply(this,arguments)}}();return this._reschedule((e=>u(e)),r).then((()=>o))}));function i(t,i,r){return e.apply(this,arguments)}return i}(),v._filterLatest=function(e){const{trackIdField:t,startTimeField:i,endTimeField:r}=this.timeInfo,n=r||i,s=new Map,a=this.featureAdapter.getAttribute;for(const o of e.items){const e=a(o,t),i=a(o,n),r=s.get(e);(!r||i>a(r,n))&&s.set(e,o)}e.items=Array.from(s.values())},v._canExecuteSinglePass=function(e,t){const{spatialRel:i}=t;return S.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===i||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===i||"esriSpatialRelContains"===i||"esriSpatialRelWithin"===i))},v._project=function(){var e=t._asyncToGenerator((function*(e,t){if(!t||f.equals(this.spatialReference,t))return e;const i=this.featureAdapter,r=yield m.projectMany(e.items.map((e=>R.getGeometry(this.geometryType,this.hasZ,this.hasM,i.getGeometry(e)))),this.spatialReference,t);return e.items=r.map(((t,r)=>i.cloneWithGeometry(e.items[r],d.convertFromGeometry(t,this.hasZ,this.hasM)))),e}));function i(t,i){return e.apply(this,arguments)}return i}(),v._getQueryBBoxes=function(e){if(S.canQueryWithRBush(e)){if(h.isExtent(e))return[c.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(h.isPolygon(e))return e.rings.map((e=>c.fromValues(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[l.getBoundsXY(c.create(),e)]},v._searchFeatures=function(e){for(const i of e)this.featureStore.forEachInBounds(i,(e=>M.add(e)));const t=Array.from(M.values());return M.clear(),t},v._checkStatisticsSupport=function(){var e=t._asyncToGenerator((function*(e,t){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new r(I,"Unsupported query options",{query:e});return this._checkAttributesQuerySupport(e),Promise.all([this._checkStatisticsParamsSupport(t),S.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),m.checkProjectionSupport(this.spatialReference,e.outSR)]).then((()=>e))}));function i(t,i){return e.apply(this,arguments)}return i}(),v._checkStatisticsParamsSupport=function(){var e=t._asyncToGenerator((function*(e){let t=[];if(e.valueExpression){const{arcadeUtils:i}=yield E.loadArcade();t=i.extractFieldNames(e.valueExpression)}if(e.field&&t.push(e.field),e.field2&&t.push(e.field2),e.field3&&t.push(e.field3),e.normalizationField&&t.push(e.normalizationField),!t.length)throw new r(I,"params should have at least a field or valueExpression",{params:e});p.validateFields(this.fieldsIndex,t,"params contains missing fields")}));function i(t){return e.apply(this,arguments)}return i}(),v._checkQuerySupport=function(){var e=t._asyncToGenerator((function*(e){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new r(I,"Unsupported query options",{query:e});return this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),Promise.all([S.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),m.checkProjectionSupport(this.spatialReference,e.outSR)]).then((()=>e))}));function i(t){return e.apply(this,arguments)}return i}(),v._checkAttributesQuerySupport=function(e){const{outFields:t,orderByFields:i,returnDistinctValues:n,outStatistics:s}=e,a=s?s.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())).filter(Boolean):[];if(i&&i.length>0){const e=" asc",t=" desc",r=i.map((i=>{const r=i.toLowerCase();return r.includes(e)?r.split(e)[0]:r.includes(t)?r.split(t)[0]:i})).filter((e=>!a.includes(e)));p.validateFields(this.fieldsIndex,r,"orderByFields contains missing fields")}if(t&&t.length>0)p.validateFields(this.fieldsIndex,t,"outFields contains missing fields");else if(n)throw new r(I,"outFields should be specified for returnDistinctValues",{query:e});p.validateWhere(this.fieldsIndex,e.where)},v._checkStatisticsQuerySupport=function(e){const{outStatistics:t,groupByFieldsForStatistics:i,having:n}=e,s=i&&i.length,a=t&&t.length;if(n){if(!s||!a)throw new r(I,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});p.validateHaving(this.fieldsIndex,n,t)}if(a){if(!T(t))return;const n=t.map((e=>e.onStatisticField)).filter(Boolean);p.validateFields(this.fieldsIndex,n,"onStatisticFields contains missing fields"),s&&p.validateFields(this.fieldsIndex,i,"groupByFieldsForStatistics contains missing fields");for(const i of t){const{onStatisticField:t,statisticType:n}=i;if(("percentile_disc"===n||"percentile_cont"===n)&&"statisticParameters"in i){const{statisticParameters:t}=i;if(!t)throw new r(I,"statisticParamters should be set for percentile type",{definition:i,query:e})}else if("count"!==n&&t&&p.hasInvalidFieldType(t,this.fieldsIndex))throw new r(I,"outStatistics contains non-numeric fields",{definition:i,query:e})}}},v._getQueryEngineResultForStats=function(){var e=t._asyncToGenerator((function*(e,t,i){e=n.clone(e);try{e=yield this._schedule((()=>R.normalizeQuery(e,this.definitionExpression,this.spatialReference)),i),e=yield this._reschedule((()=>this._checkStatisticsSupport(e,t)),i);const r=yield this._reschedule((()=>this._executeSceneFilterQuery(e,i)),i),n=yield this._reschedule((()=>this._executeGeometryQuery(e,r,i)),i);return yield this._reschedule((()=>this._executeAggregateIdsQuery(n)),i),yield this._reschedule((()=>this._executeObjectIdsQuery(n)),i),yield this._reschedule((()=>this._executeTimeQuery(n)),i),yield this._reschedule((()=>this._executeAttributesQuery(n)),i),n}catch(r){if(r!==R.QUERY_ENGINE_EMPTY_RESULT)throw r;return new _.QueryEngineResult([],e,this)}}));function i(t,i,r){return e.apply(this,arguments)}return i}(),t._createClass(e,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const e=this.featureStore.fullBounds;return s.isNone(e)?null:{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:R.cleanFromGeometryEngine(this.spatialReference)}}},{key:"timeExtent",get:function(){return this.timeInfo?(this._timeExtent||(this._timeExtent=x.getTimeExtent(this.timeInfo,this.featureStore)),this._timeExtent):null}}]),e}();const A=u.create(),N=u.create(),M=new Set;e.Feature=v,e.QueryEngine=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
