/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/MemCache","../../../core/unitUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./timeSupport","./utils","../../support/FieldsIndex","../../../support/arcadeOnDemand","../../../views/support/Scheduler"],(function(e,t,i,r,s,n,u,a,o,c,l,h,y,d,p,f,m,_,x,g,S,Q,R){"use strict";function E(e){return e.every((e=>"exceedslimit"!==e.statisticType))}const F="feature-store:unsupported-query";let T=function(e,t=null,i,r,s){this.attributes=e,this.geometry=i,this.centroid=r,this.filterFlags=s,this.groupId=-1,this.displayId=t};const I=new Set,v=new n.MemCacheStorage(2e6);let G=0,w=function(){function e(e){this.capabilities={query:f.queryCapabilities},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new n.MemCache(G+++"$$",v)),this.fieldsIndex=new S(e.fields),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}var T=e.prototype;return T.destroy=function(){this._frameTask=s.removeMaybe(this._frameTask),this.clearCache(),s.destroyMaybe(this._geometryQueryCache),this._changeHandle=s.removeMaybe(this._changeHandle),s.destroyMaybe(this.fieldsIndex)},T.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null},T.executeQuery=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);try{s=yield this._schedule((()=>g.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t)}catch(n){if(n!==g.QUERY_ENGINE_EMPTY_RESULT)throw n;i=new m.default([],null,this)}return i.createQueryResponse(s)}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForCount=function(){var e=t._asyncToGenerator((function*(e={},t){let i=r.clone(e);i.returnGeometry=!1,i.returnCentroid=!1,i.outSR=null;try{i=yield this._schedule((()=>g.normalizeQuery(i,this.definitionExpression,this.spatialReference)),t),i=yield this._reschedule((()=>this._checkQuerySupport(i)),t);let e=yield this._reschedule((()=>this._executeGeometryQuery(i,t)),t);return e=yield this._reschedule((()=>e.executeAggregateIdsQuery(i)),t),e=yield this._reschedule((()=>e.executeObjectIdsQuery(i)),t),e=yield this._reschedule((()=>e.executeTimeQuery(i)),t),e=yield this._reschedule((()=>e.executeAttributesQuery(i)),t),e.createQueryResponseForCount(i)}catch(s){if(s!==g.QUERY_ENGINE_EMPTY_RESULT)throw s;return 0}}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForExtent=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);const n=s.outSR;try{s=yield this._schedule((()=>g.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),s.returnGeometry=!0,s.returnCentroid=!1,s.outSR=null,i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t);const e=i.size;if(!e)return{count:e,extent:null};a.set(k,a.NEGATIVE_INFINITY),this.featureStore.forEachBounds(i.items,(e=>a.expandWithAABB(k,e)),b);const r={xmin:k[0],ymin:k[1],xmax:k[3],ymax:k[4],spatialReference:g.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(k[2])&&isFinite(k[5])&&(r.zmin=k[2],r.zmax=k[5]);const o=p.project(r,i.spatialReference,n);if(o.spatialReference=g.cleanFromGeometryEngine(n||this.spatialReference),o.xmax-o.xmin==0){const e=u.getMetersPerUnitForSR(o.spatialReference);o.xmin-=e,o.xmax+=e}if(o.ymax-o.ymin==0){const e=u.getMetersPerUnitForSR(o.spatialReference);o.ymin-=e,o.ymax+=e}if(this.hasZ&&null!=o.zmin&&null!=o.zmax&&o.zmax-o.zmin==0){const e=u.getMetersPerUnitForSR(o.spatialReference);o.zmin-=e,o.zmax+=e}return{count:e,extent:o}}catch(o){if(o===g.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw o}}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForIds=function(){var e=t._asyncToGenerator((function*(e={},t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForIdSet=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);s.returnGeometry=!1,s.returnCentroid=!1,s.outSR=null;try{s=yield this._schedule((()=>g.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t);const e=i.items,r=new Set;return yield this._reschedule((()=>{for(const t of e)r.add(i.featureAdapter.getObjectId(t))}),t),r}catch(n){if(n===g.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw n}}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForSnapping=function(){var e=t._asyncToGenerator((function*(e,t){const{point:i,distance:r,types:n}=e;if(n===m.SnappingTypes.NONE)return{candidates:[]};const u=yield this._reschedule((()=>this._checkQuerySupport(e.query)),t),a=!y.equals(i.spatialReference,this.spatialReference);a&&(yield p.checkProjectionSupport(i.spatialReference,this.spatialReference));const o="number"==typeof r?r:r.x,c="number"==typeof r?r:r.y,d={xmin:i.x-o,xmax:i.x+o,ymin:i.y-c,ymax:i.y+c,spatialReference:i.spatialReference},f=a?p.project(d,this.spatialReference):d;if(!f)return{candidates:[]};const _=(yield h.normalizeCentralMeridian(l.fromJSON(i),null,{signal:t}))[0],x=(yield h.normalizeCentralMeridian(l.fromJSON(f),null,{signal:t}))[0];if(s.isNone(_)||s.isNone(x))return{candidates:[]};let g=new m.default(this._searchFeatures(this._getQueryBBoxes(x.toJSON())),null,this);g=yield this._reschedule((()=>g.executeObjectIdsQuery(u)),t),g=yield this._reschedule((()=>g.executeTimeQuery(u)),t),g=yield this._reschedule((()=>g.executeAttributesQuery(u)),t);const S=_.toJSON(),Q=a?p.project(S,this.spatialReference):S,R=a?Math.max(f.xmax-f.xmin,f.ymax-f.ymin)/2:r;return g.createSnappingResponse({...e,point:Q,distance:R},i.spatialReference)}));function i(t,i){return e.apply(this,arguments)}return i}(),T.executeQueryForLatestObservations=function(){var e=t._asyncToGenerator((function*(e={},t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new i(F,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});let s,n=r.clone(e);try{n=yield this._schedule((()=>g.normalizeQuery(n,this.definitionExpression,this.spatialReference)),t),n=yield this._reschedule((()=>this._checkQuerySupport(n)),t),s=yield this._reschedule((()=>this._executeGeometryQuery(n,t)),t),s=yield this._reschedule((()=>s.executeAggregateIdsQuery(n)),t),s=yield this._reschedule((()=>s.executeObjectIdsQuery(n)),t),s=yield this._reschedule((()=>s.executeTimeQuery(n)),t),s=yield this._reschedule((()=>s.executeAttributesQuery(n)),t),s=yield this._reschedule((()=>s.filterLatest()),t)}catch(u){if(u!==g.QUERY_ENGINE_EMPTY_RESULT)throw u;s=new m.default([],null,this)}return s.createQueryResponse(n)}));function s(){return e.apply(this,arguments)}return s}(),T.executeQueryForSummaryStatistics=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,normalizationField:s,valueExpression:n}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,normalizationField:s,valueExpression:n},i)).createSummaryStatisticsResponse(e,t)}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForUniqueValues=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,valueExpression:s}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,valueExpression:s},i)).createUniqueValuesResponse(e,t)}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForClassBreaks=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,normalizationField:s,valueExpression:n}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,normalizationField:s,valueExpression:n},i)).createClassBreaksResponse(e,t)}));function i(){return e.apply(this,arguments)}return i}(),T.executeQueryForHistogram=function(){var e=t._asyncToGenerator((function*(e={},t,i){const{field:r,normalizationField:s,valueExpression:n}=t;return(yield this._getQueryEngineResultForStats(e,{field:r,normalizationField:s,valueExpression:n},i)).createHistogramResponse(e,t)}));function i(){return e.apply(this,arguments)}return i}(),T._schedule=function(){var e=t._asyncToGenerator((function*(e,t){return s.isSome(this._frameTask)?this._frameTask.schedule(e,t):e(R.noBudget)}));function i(t,i){return e.apply(this,arguments)}return i}(),T._reschedule=function(){var e=t._asyncToGenerator((function*(e,t){return s.isSome(this._frameTask)?this._frameTask.reschedule(e,t):e(R.noBudget)}));function i(t,i){return e.apply(this,arguments)}return i}(),T._getAll=function(){if(!this._allItems){const e=[];this.featureStore.forEach((t=>e.push(t))),this._allItems=new m.default(e,null,this)}return this._allItems},T._executeGeometryQuery=function(){var e=t._asyncToGenerator((function*(e,i){var r=this;const{geometry:n,outSR:u,spatialRel:a,returnGeometry:o,returnCentroid:c}=e,l=this.featureStore.featureSpatialReference,h=n&&l&&l!==n.spatialReference?p.project(n,l):n,d=o||c,f=y.isValid(u)&&!y.equals(this.spatialReference,u),x=this._geometryQueryCache?f&&d?JSON.stringify({originalFilterGeometry:n,spatialRelationship:a,outSpatialReference:u}):JSON.stringify({originalFilterGeometry:n,spatialRelationship:a}):null;if(x){const e=this._geometryQueryCache.get(x);if(!s.isUndefined(e))return e}const g=function(){var e=t._asyncToGenerator((function*(e){if(f&&d){const t=yield e.project(u);return x&&r._geometryQueryCache.put(x,t,t.size||1),t}return x&&r._geometryQueryCache.put(x,e,e.size||1),e}));return function(t){return e.apply(this,arguments)}}();if(!h)return g(this._getAll());const S=this.featureAdapter;if("esriSpatialRelDisjoint"===a){const e=this._searchFeatures(this._getQueryBBoxes(n));if(!e.length)return g(this._getAll());let s,u;const o=new Set;for(const t of e)o.add(S.getObjectId(t));yield this._reschedule((()=>{let e=0;s=new Array(o.size),this.featureStore.forEach((t=>s[e++]=t)),u=o}),i);const c=yield this._reschedule(t._asyncToGenerator((function*(){const e=yield _.getSpatialQueryOperator(a,h,r.geometryType,r.hasZ,r.hasM),t=t=>!u.has(S.getObjectId(t))||e(S.getGeometry(t));return new m.default(yield r._runSpatialFilter(s,t,i),n,r)})),i);return g(c)}const Q=this._searchFeatures(this._getQueryBBoxes(n));if(!Q.length){const e=new m.default([],n,this);return x&&this._geometryQueryCache.put(x,e,e.size||1),e}if(this._canExecuteSoloPass(h,e))return g(new m.default(Q,n,this));const R=yield _.getSpatialQueryOperator(a,h,this.geometryType,this.hasZ,this.hasM),E=yield this._runSpatialFilter(Q,(e=>R(S.getGeometry(e))),i);return g(new m.default(E,n,this))}));function i(t,i){return e.apply(this,arguments)}return i}(),T._runSpatialFilter=function(){var e=t._asyncToGenerator((function*(e,i,r){var n=this;if(!i)return e;if(s.isNone(this._frameTask))return e.filter((e=>i(e)));let u=0;const a=new Array,o=function(){var s=t._asyncToGenerator((function*(t){for(;u<e.length;){const s=e[u++];i(s)&&(a.push(s),t.madeProgress()),t.done&&(yield n._reschedule((e=>o(e)),r))}}));return function(e){return s.apply(this,arguments)}}();return this._reschedule((e=>o(e)),r).then((()=>a))}));function i(t,i,r){return e.apply(this,arguments)}return i}(),T._canExecuteSoloPass=function(e,t){const{geometryType:i}=this,{spatialRel:r}=t;return _.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===i&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r||"esriSpatialRelWithin"===r))},T._getQueryBBoxes=function(e){if(_.canQueryWithRBush(e)){if(l.isExtent(e))return[o.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(l.isPolygon(e))return e.rings.map((e=>o.fromValues(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[c.getBoundsXY(o.create(),e)]},T._searchFeatures=function(e){for(const r of e)this.featureStore.forEachInBounds(r,(e=>{I.add(e)}));const t=new Array(I.size);let i=0;return I.forEach((e=>t[i++]=e)),I.clear(),t},T._checkStatisticsSupport=function(){var e=t._asyncToGenerator((function*(e,t){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new i(F,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsParamsSupport(t),_.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),p.checkProjectionSupport(this.spatialReference,e.outSR)]).then((()=>e))}));function r(t,i){return e.apply(this,arguments)}return r}(),T._checkStatisticsParamsSupport=function(){var e=t._asyncToGenerator((function*(e){let t=[];if(e.valueExpression){const{arcadeUtils:i}=yield Q.loadArcade();t=i.extractFieldNames(e.valueExpression)}if(e.field&&t.push(e.field),e.normalizationField&&t.push(e.normalizationField),!t.length)throw new i(F,"params should have at least a field or valueExpression",{params:e});d.validateFields(this.fieldsIndex,t,"params contains missing fields")}));function r(t){return e.apply(this,arguments)}return r}(),T._checkQuerySupport=function(){var e=t._asyncToGenerator((function*(e){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new i(F,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),_.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),p.checkProjectionSupport(this.spatialReference,e.outSR)]).then((()=>e))}));function r(t){return e.apply(this,arguments)}return r}(),T._checkAttributesQuerySupport=function(e){const{outFields:t,orderByFields:r,returnDistinctValues:s,outStatistics:n}=e,u=n?n.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())).filter(Boolean):[];if(r&&r.length>0){const e=" asc",t=" desc",i=r.map((i=>{const r=i.toLowerCase();return r.indexOf(e)>-1?r.split(e)[0]:r.indexOf(t)>-1?r.split(t)[0]:i})).filter((e=>-1===u.indexOf(e)));d.validateFields(this.fieldsIndex,i,"orderByFields contains missing fields")}if(t&&t.length>0)d.validateFields(this.fieldsIndex,t,"outFields contains missing fields");else if(s)throw new i(F,"outFields should be specified for returnDistinctValues",{query:e});d.validateWhere(this.fieldsIndex,e.where)},T._checkStatisticsQuerySupport=function(){var e=t._asyncToGenerator((function*(e){const{outStatistics:t,groupByFieldsForStatistics:r,having:s}=e,n=r&&r.length,u=t&&t.length;if(s){if(!n||!u)throw new i(F,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});d.validateHaving(this.fieldsIndex,s,t)}if(u){if(!E(t))return;const s=t.map((e=>e.onStatisticField)).filter(Boolean);d.validateFields(this.fieldsIndex,s,"onStatisticFields contains missing fields"),n&&d.validateFields(this.fieldsIndex,r,"groupByFieldsForStatistics contains missing fields");for(const r of t){const{onStatisticField:t,statisticType:s}=r;if(("percentile_disc"===s||"percentile_cont"===s)&&"statisticParameters"in r){const{statisticParameters:t}=r;if(!t)throw new i(F,"statisticParamters should be set for percentile type",{definition:r,query:e})}else if("count"!==s&&t&&d.hasInvalidFieldType(t,this.fieldsIndex))throw new i(F,"outStatistics contains non-numeric fields",{definition:r,query:e})}}}));function r(t){return e.apply(this,arguments)}return r}(),T._getQueryEngineResultForStats=function(){var e=t._asyncToGenerator((function*(e={},t,i){let s;e=r.clone(e);try{e=yield this._schedule((()=>g.normalizeQuery(e,this.definitionExpression,this.spatialReference)),i),e=yield this._reschedule((()=>this._checkStatisticsSupport(e,t)),i),s=yield this._reschedule((()=>this._executeGeometryQuery(e,i)),i),s=yield this._reschedule((()=>s.executeAggregateIdsQuery(e)),i),s=yield this._reschedule((()=>s.executeObjectIdsQuery(e)),i),s=yield this._reschedule((()=>s.executeTimeQuery(e)),i),s=yield this._reschedule((()=>s.executeAttributesQuery(e)),i)}catch(n){if(n!==g.QUERY_ENGINE_EMPTY_RESULT)throw n;s=new m.default([],null,this)}return s}));function i(){return e.apply(this,arguments)}return i}(),t._createClass(e,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:g.cleanFromGeometryEngine(this.spatialReference)}:null}},{key:"timeExtent",get:function(){return this.timeInfo?(this._timeExtent||(this._timeExtent=x.getTimeExtent(this.timeInfo,this.featureStore)),this._timeExtent):null}}]),e}();const b=a.create(),k=a.create();e.Feature=T,e.default=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
