/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/MemCache","../../../core/unitUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./timeSupport","./utils","../../support/FieldsIndex","../../support/PromiseQueue","../../../smartMapping/support/utils"],(function(e,t,i,r,s,n,u,a,o,c,l,h,y,d,p,f,m,_,g,x,S,Q,R){"use strict";function E(e){return e.every((e=>"exceedslimit"!==e.statisticType))}const I="feature-store:unsupported-query";let F=function(e,t=null,i,r,s){this.attributes=e,this.geometry=i,this.centroid=r,this.filterFlags=s,this.groupId=-1,this.displayId=t};const T=new Set,w=new n.MemCacheStorage(2e6);let v=0,G=function(){function e(e){this.capabilities={query:f.queryCapabilities},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new n.MemCache(v+++"$$",w)),this.fieldsIndex=new S(e.fields),e.scheduler&&e.priority&&(this._frameQueue=new Q,this._frameTask=e.scheduler.registerTask(e.priority,this))}var F=e.prototype;return F.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()},F.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null},F.executeQuery=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);try{s=yield this._schedule((()=>x.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t)}catch(n){if(n!==x.QUERY_ENGINE_EMPTY_RESULT)throw n;i=new m([],null,this)}return i.createQueryResponse(s)}));function i(){return e.apply(this,arguments)}return i}(),F.executeQueryForCount=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);s.returnGeometry=!1,s.returnCentroid=!1,s.outSR=null;try{s=yield this._schedule((()=>x.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t)}catch(n){if(n!==x.QUERY_ENGINE_EMPTY_RESULT)throw n;return 0}return i.createQueryResponseForCount(s)}));function i(){return e.apply(this,arguments)}return i}(),F.executeQueryForExtent=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);const n=s.outSR;try{s=yield this._schedule((()=>x.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),s.returnGeometry=!0,s.returnCentroid=!1,s.outSR=null,i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t);const e=i.size;if(!e)return{count:e,extent:null};a.set(k,a.NEGATIVE_INFINITY),this.featureStore.forEachBounds(i.items,(e=>a.expandWithAABB(k,e)),b);const r={xmin:k[0],ymin:k[1],xmax:k[3],ymax:k[4],spatialReference:x.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(k[2])&&isFinite(k[5])&&(r.zmin=k[2],r.zmax=k[5]);const o=p.project(r,i.spatialReference,n);if(o.spatialReference=x.cleanFromGeometryEngine(n||this.spatialReference),o.xmax-o.xmin==0){const e=u.getMetersPerUnitForSR(o.spatialReference);o.xmin-=e,o.xmax+=e}if(o.ymax-o.ymin==0){const e=u.getMetersPerUnitForSR(o.spatialReference);o.ymin-=e,o.ymax+=e}if(this.hasZ&&null!=o.zmin&&null!=o.zmax&&o.zmax-o.zmin==0){const e=u.getMetersPerUnitForSR(o.spatialReference);o.zmin-=e,o.zmax+=e}return{count:e,extent:o}}catch(o){if(o===x.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw o}}));function i(){return e.apply(this,arguments)}return i}(),F.executeQueryForIds=function(){var e=t._asyncToGenerator((function*(e={},t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}));function i(){return e.apply(this,arguments)}return i}(),F.executeQueryForIdSet=function(){var e=t._asyncToGenerator((function*(e={},t){let i,s=r.clone(e);s.returnGeometry=!1,s.returnCentroid=!1,s.outSR=null;try{s=yield this._schedule((()=>x.normalizeQuery(s,this.definitionExpression,this.spatialReference)),t),s=yield this._reschedule((()=>this._checkQuerySupport(s)),t),i=yield this._reschedule((()=>this._executeGeometryQuery(s,t)),t),i=yield this._reschedule((()=>i.executeAggregateIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeObjectIdsQuery(s)),t),i=yield this._reschedule((()=>i.executeTimeQuery(s)),t),i=yield this._reschedule((()=>i.executeAttributesQuery(s)),t);const e=i.items,r=new Set;return yield this._reschedule((()=>{for(const t of e)r.add(i.featureAdapter.getObjectId(t))}),t),r}catch(n){if(n===x.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw n}}));function i(){return e.apply(this,arguments)}return i}(),F.executeQueryForSnapping=function(){var e=t._asyncToGenerator((function*(e,t){const{point:i,distance:r,types:n}=e;if(0===n)return{candidates:[]};const u=yield this._reschedule((()=>this._checkQuerySupport(e.query)),t),a=!y.equals(i.spatialReference,this.spatialReference);a&&(yield p.checkProjectionSupport(i.spatialReference,this.spatialReference));const o="number"==typeof r?r:r.x,c="number"==typeof r?r:r.y,d={xmin:i.x-o,xmax:i.x+o,ymin:i.y-c,ymax:i.y+c,spatialReference:i.spatialReference},f=a?p.project(d,this.spatialReference):d;if(!f)return{candidates:[]};const _=(yield h.normalizeCentralMeridian(l.fromJSON(i),null,{signal:t}))[0],g=(yield h.normalizeCentralMeridian(l.fromJSON(f),null,{signal:t}))[0];if(s.isNone(_)||s.isNone(g))return{candidates:[]};let x=new m(this._searchFeatures(this._getQueryBBoxes(g.toJSON())),null,this);x=yield this._reschedule((()=>x.executeObjectIdsQuery(u)),t),x=yield this._reschedule((()=>x.executeTimeQuery(u)),t),x=yield this._reschedule((()=>x.executeAttributesQuery(u)),t);const S=_.toJSON(),Q=a?p.project(S,this.spatialReference):S,R=a?Math.max(f.xmax-f.xmin,f.ymax-f.ymin)/2:r;return x.createSnappingResponse({...e,point:Q,distance:R},i.spatialReference)}));function i(t,i){return e.apply(this,arguments)}return i}(),F.executeQueryForLatestObservations=function(){var e=t._asyncToGenerator((function*(e={},t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new i(I,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});let s,n=r.clone(e);try{n=yield this._schedule((()=>x.normalizeQuery(n,this.definitionExpression,this.spatialReference)),t),n=yield this._reschedule((()=>this._checkQuerySupport(n)),t),s=yield this._reschedule((()=>this._executeGeometryQuery(n,t)),t),s=yield this._reschedule((()=>s.executeAggregateIdsQuery(n)),t),s=yield this._reschedule((()=>s.executeObjectIdsQuery(n)),t),s=yield this._reschedule((()=>s.executeTimeQuery(n)),t),s=yield this._reschedule((()=>s.executeAttributesQuery(n)),t),s=yield this._reschedule((()=>s.filterLatest()),t)}catch(u){if(u!==x.QUERY_ENGINE_EMPTY_RESULT)throw u;s=new m([],null,this)}return s.createQueryResponse(n)}));function s(){return e.apply(this,arguments)}return s}(),F.executeQueryForSummaryStatistics=function(){var e=t._asyncToGenerator((function*(e={},t,i){let s;e=r.clone(e);try{e=yield this._schedule((()=>x.normalizeQuery(e,this.definitionExpression,this.spatialReference)),i),e=yield this._reschedule((()=>this._checkSummaryStatisticsSupport(e,t)),i),s=yield this._reschedule((()=>this._executeGeometryQuery(e,i)),i),s=yield this._reschedule((()=>s.executeAggregateIdsQuery(e)),i),s=yield this._reschedule((()=>s.executeObjectIdsQuery(e)),i),s=yield this._reschedule((()=>s.executeTimeQuery(e)),i),s=yield this._reschedule((()=>s.executeAttributesQuery(e)),i)}catch(n){if(n!==x.QUERY_ENGINE_EMPTY_RESULT)throw n;s=new m([],null,this)}return s.createSummaryStatisticsResponse(e,t)}));function i(){return e.apply(this,arguments)}return i}(),F._schedule=function(){var e=t._asyncToGenerator((function*(e,t){return this._frameQueue?this._frameQueue.push(e,t):e()}));function i(t,i){return e.apply(this,arguments)}return i}(),F._reschedule=function(){var e=t._asyncToGenerator((function*(e,t){return this._frameQueue?this._frameQueue.unshift(e,t):e()}));function i(t,i){return e.apply(this,arguments)}return i}(),F.runTask=function(e){for(this._budget=e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null},F._getAll=function(){if(!this._allItems){const e=[];this.featureStore.forEach((t=>e.push(t))),this._allItems=new m(e,null,this)}return this._allItems},F._executeGeometryQuery=function(){var e=t._asyncToGenerator((function*(e,i){var r=this;const{geometry:n,outSR:u,spatialRel:a,returnGeometry:o,returnCentroid:c}=e,l=o||c,h=y.isValid(u)&&!y.equals(this.spatialReference,u),d=this._geometryQueryCache?h&&l?JSON.stringify({geometry:n,spatialRelationship:a,outSpatialReference:u}):JSON.stringify({geometry:n,spatialRelationship:a}):null;if(d){const e=this._geometryQueryCache.get(d);if(!s.isUndefined(e))return e}const p=function(){var e=t._asyncToGenerator((function*(e){if(h&&l){const t=yield e.project(u);return d&&r._geometryQueryCache.put(d,t,t.size||1),t}return d&&r._geometryQueryCache.put(d,e,e.size||1),e}));return function(t){return e.apply(this,arguments)}}();if(!n)return p(this._getAll());const f=this.featureAdapter;if("esriSpatialRelDisjoint"===a){const e=this._searchFeatures(this._getQueryBBoxes(n));if(!e.length)return p(this._getAll());let s,u;const o=new Set;for(const t of e)o.add(f.getObjectId(t));yield this._reschedule((()=>{let e=0;s=new Array(o.size),this.featureStore.forEach((t=>s[e++]=t)),u=o}),i);const c=yield this._reschedule(t._asyncToGenerator((function*(){const e=yield _.getSpatialQueryOperator(a,n,r.geometryType,r.hasZ,r.hasM),t=t=>!u.has(f.getObjectId(t))||e(f.getGeometry(t));return new m(yield r._runSpatialFilter(s,t,i),n,r)})),i);return p(c)}const g=this._searchFeatures(this._getQueryBBoxes(n));if(!g.length){const e=new m([],n,this);return d&&this._geometryQueryCache.put(d,e,e.size||1),e}if(this._canExecuteSoloPass(n,e))return p(new m(g,n,this));const x=yield _.getSpatialQueryOperator(a,n,this.geometryType,this.hasZ,this.hasM),S=yield this._runSpatialFilter(g,(e=>x(f.getGeometry(e))),i);return p(new m(S,n,this))}));function i(t,i){return e.apply(this,arguments)}return i}(),F._runSpatialFilter=function(){var e=t._asyncToGenerator((function*(e,i,r){var s=this;if(!i)return e;if(!this._budget)return e.filter((e=>i(e)));let n=0;const u=new Array,a=function(){var o=t._asyncToGenerator((function*(){for(;n<e.length;){const t=e[n];i(t)&&u.push(t),s._budget.done&&(yield s._reschedule((()=>a()),r)),++n}}));return function(){return o.apply(this,arguments)}}();return this._reschedule((()=>a()),r).then((()=>u))}));function i(t,i,r){return e.apply(this,arguments)}return i}(),F._canExecuteSoloPass=function(e,t){const{geometryType:i}=this,{spatialRel:r}=t;return _.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===i&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r||"esriSpatialRelWithin"===r))},F._getQueryBBoxes=function(e){if(_.canQueryWithRBush(e)){if(l.isExtent(e))return[o.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(l.isPolygon(e))return e.rings.map((e=>o.fromValues(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[c.getBoundsXY(o.create(),e)]},F._searchFeatures=function(e){for(const r of e)this.featureStore.forEachInBounds(r,(e=>{T.add(e)}));const t=new Array(T.size);let i=0;return T.forEach((e=>t[i++]=e)),T.clear(),t},F._checkSummaryStatisticsSupport=function(){var e=t._asyncToGenerator((function*(e,t){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new i(I,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkSummaryStatisticsParamsSupport(t),_.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),p.checkProjectionSupport(this.spatialReference,e.outSR)]).then((()=>e))}));function r(t,i){return e.apply(this,arguments)}return r}(),F._checkSummaryStatisticsParamsSupport=function(){var e=t._asyncToGenerator((function*(e){const t=yield R.getFieldsList({field:e.field,normalizationField:e.normalizationField,valueExpression:e.valueExpression});if(!t.length)throw new i(I,"params should have atleast a field or valueExpression",{params:e});d.validateFields(this.fieldsIndex,t,"params contains missing fields")}));function r(t){return e.apply(this,arguments)}return r}(),F._checkQuerySupport=function(){var e=t._asyncToGenerator((function*(e){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new i(I,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),_.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),p.checkProjectionSupport(this.spatialReference,e.outSR)]).then((()=>e))}));function r(t){return e.apply(this,arguments)}return r}(),F._checkAttributesQuerySupport=function(e){const{outFields:t,orderByFields:r,returnDistinctValues:s,outStatistics:n}=e,u=n?n.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())):[];if(r&&r.length>0){const e=" asc",t=" desc",i=r.map((i=>{const r=i.toLowerCase();return r.indexOf(e)>-1?r.split(e)[0]:r.indexOf(t)>-1?r.split(t)[0]:i})).filter((e=>-1===u.indexOf(e)));d.validateFields(this.fieldsIndex,i,"orderByFields contains missing fields")}if(t&&t.length>0)d.validateFields(this.fieldsIndex,t,"outFields contains missing fields");else if(s)throw new i(I,"outFields should be specified for returnDistinctValues",{query:e});d.validateWhere(this.fieldsIndex,e.where)},F._checkStatisticsQuerySupport=function(){var e=t._asyncToGenerator((function*(e){const{outStatistics:t,groupByFieldsForStatistics:r,having:s}=e,n=r&&r.length,u=t&&t.length;if(s){if(!n||!u)throw new i(I,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});d.validateHaving(this.fieldsIndex,s,t)}if(u){if(!E(t))return;const s=t.map((e=>e.onStatisticField));d.validateFields(this.fieldsIndex,s,"onStatisticFields contains missing fields"),n&&d.validateFields(this.fieldsIndex,r,"groupByFieldsForStatistics contains missing fields");for(const r of t){const{onStatisticField:t,statisticType:s}=r;if(("percentile_disc"===s||"percentile_cont"===s)&&"statisticParameters"in r){const{statisticParameters:t}=r;if(!t)throw new i(I,"statisticParamters should be set for percentile type",{definition:r,query:e})}else if("count"!==s&&t&&d.hasInvalidFieldType(t,this.fieldsIndex))throw new i(I,"outStatistics contains non-numeric fields",{definition:r,query:e})}}}));function r(t){return e.apply(this,arguments)}return r}(),t._createClass(e,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:x.cleanFromGeometryEngine(this.spatialReference)}:null}},{key:"timeExtent",get:function(){return this.timeInfo?(this._timeExtent||(this._timeExtent=g.getTimeExtent(this.timeInfo,this.featureStore)),this._timeExtent):null}},{key:"running",get:function(){return this._frameQueue.length>0}}]),e}();const b=a.create(),k=a.create();e.Feature=F,e.default=G,Object.defineProperty(e,"__esModule",{value:!0})}));
