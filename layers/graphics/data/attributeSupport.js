/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","../../../core/sql/WhereClauseCache"],(function(e,i,s){"use strict";const n=new s.WhereClauseCache(50,500),t="feature-store:unsupported-query",r=" as ",a=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function o(e,i){return e?n.get(e,i):null}function l(e,s,n,r=!0){const a=[];for(const n of s)if("*"!==n&&!e.has(n))if(r){const s=d(n);try{const n=o(s,e);if(!n)throw new i(t,"invalid SQL expression",{where:s});if(!n.isStandardized)throw new i(t,"expression is not standard",{clause:n});l(e,n.fieldNames,"expression contains missing fields")}catch(e){const i=e&&e.details;if(i&&(i.clause||i.where))throw e;i&&i.missingFields?a.push(...i.missingFields):a.push(n)}}else a.push(n);if(a.length)throw new i(t,n,{missingFields:a})}function d(e){return e.split(r)[0]}e.getAliasFromFieldName=function(e){return e.split(r)[1]},e.getExpressionFromFieldName=d,e.getWhereClause=o,e.hasInvalidFieldType=function(e,i){const s=i.get(e);return!!s&&!a.has(s.type)},e.validateFields=l,e.validateHaving=function(e,s,r){if(!s)return!0;const a=n.get(s,e);if(!a)throw new i(t,"invalid SQL expression",{having:s});if(!a.isAggregate)throw new i(t,"having does not contain a valid aggregate function",{having:s});const o=a.fieldNames;if(l(e,o,"having contains missing fields"),!a.getExpressions().every((i=>{const{aggregateType:s,field:n}=i,t=e.has(n)&&e.get(n).name;return r.some((i=>{const{onStatisticField:n,statisticType:r}=i;return(e.has(n)&&e.get(n).name)===t&&r.toLowerCase().trim()===s}))})))throw new i(t,"expressions in having should also exist in outStatistics",{having:s});return!0},e.validateWhere=function(e,s){if(!s)return!0;const r=n.get(s,e);if(!r)throw new i(t,"invalid SQL expression",{where:s});if(!r.isStandardized)throw new i(t,"where clause is not standard",{where:s});return l(e,r.fieldNames,"where clause contains missing fields"),!0},Object.defineProperty(e,"__esModule",{value:!0})}));
