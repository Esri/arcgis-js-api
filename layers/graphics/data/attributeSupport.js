/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","../../../core/sql/WhereClauseCache"],(function(e,i,n){"use strict";const s=new n.WhereClauseCache(50,500),t="feature-store:unsupported-query",r=" as ",a=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function o(e,n){if(!n)return!0;const r=s.get(n,e);if(!r)throw new i(t,"invalid SQL expression",{where:n});if(!r.isStandardized)throw new i(t,"where clause is not standard",{where:n});return c(e,r.fieldNames,"where clause contains missing fields"),!0}function l(e,n,r){if(!n)return!0;const a=s.get(n,e);if(!a)throw new i(t,"invalid SQL expression",{having:n});if(!a.isAggregate)throw new i(t,"having does not contain a valid aggregate function",{having:n});const o=a.fieldNames;c(e,o,"having contains missing fields");if(!a.getExpressions().every((i=>{const{aggregateType:n,field:s}=i,t=e.get(s)?.name;return r.some((i=>{const{onStatisticField:s,statisticType:r}=i,a=e.get(s)?.name;return a===t&&r.toLowerCase().trim()===n}))})))throw new i(t,"expressions in having should also exist in outStatistics",{having:n});return!0}function d(e,i){return e?s.get(e,i):null}function c(e,n,s,r=!0){const a=[];for(const l of n)if("*"!==l&&!e.has(l))if(r){const n=u(l);try{const s=d(n,e);if(!s)throw new i(t,"invalid SQL expression",{where:n});if(!s.isStandardized)throw new i(t,"expression is not standard",{clause:s});c(e,s.fieldNames,"expression contains missing fields")}catch(o){const e=o&&o.details;if(e&&(e.clause||e.where))throw o;e&&e.missingFields?a.push(...e.missingFields):a.push(l)}}else a.push(l);if(a.length)throw new i(t,s,{missingFields:a})}function u(e){return e.split(r)[0]}function g(e){return e.split(r)[1]}function h(e,i){const n=i.get(e);return!!n&&!a.has(n.type)}e.getAliasFromFieldName=g,e.getExpressionFromFieldName=u,e.getWhereClause=d,e.hasInvalidFieldType=h,e.validateFields=c,e.validateHaving=l,e.validateWhere=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
