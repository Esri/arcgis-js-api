/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/mathUtils","../../../core/CircularArray"],(function(t,e,s,i){"use strict";const r="__esri_stream_id__",o="__esri_timestamp__",d=1e3;let n=function(){function t(t,e,s,i,o=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=i,this.store=t,this.objectIdField=e,this.purgeInterval=o,this._useGeneratedIds=this.objectIdField===r}var n=t.prototype;return n.add=function(t){if(this._useGeneratedIds){const e=this._nextId();t.attributes[this.objectIdField]=e,t.objectId=e}else t.objectId=t.attributes[this.objectIdField];if(this._addOrUpdated.set(t.objectId,t),this._maxAge=Math.max(this._maxAge,t.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return e.isNone(this._trackIdLessObservations)&&(this._trackIdLessObservations=new i(1e5)),void this._trackIdLessObservations.enqueue(t.objectId);const r=t.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){const t=e.isSome(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:d,o=s.clamp(t,0,d);this._trackIdToObservations.set(r,new i(o))}const o=this._trackIdToObservations.get(r).enqueue(t.objectId);e.isSome(o)&&(this._addOrUpdated.has(o)?this._addOrUpdated.delete(o):this._removed.push(o))},n.checkForUpdates=function(){const t=this._getToAdd(),s=this._getToRemove(),i=performance.now();i-this._lastPurge>=this.purgeInterval&&(this._purge(i),this._lastPurge=i);const r=[];if(e.isSome(s))for(const o of s){const t=this.store.removeById(o);e.isSome(t)&&r.push(t)}if(e.isSome(t))for(const e of t)e.attributes[o]=i,this.store.add(e);(t||r)&&this.store.update(t,r)},n._getToAdd=function(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach((s=>t[e++]=s)),this._addOrUpdated.clear(),t},n._getToRemove=function(){const t=this._removed;return this._removed.length?(this._removed=[],t):null},n._nextId=function(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t},n._purge=function(t){const s=this._purgeOptions;e.isSome(s)&&(this._purgeSomeByDisplayCount(s),this._purgeByAge(s),this._purgeByAgeReceived(t,s),this._purgeTracks())},n._purgeSomeByDisplayCount=function(t){if(!t.displayCount)return;let s=this.store.size;if(s>t.displayCount){if(this._timeInfo.trackIdField)for(const i of this._trackIdToObservations.values())if(s>t.displayCount&&i.size){const t=e.unwrap(i.dequeue());this._removed.push(t),s--}if(e.isSome(this._trackIdLessObservations)){let i=s-t.displayCount;for(;i-- >0;){const t=this._trackIdLessObservations.dequeue();e.isSome(t)&&this._removed.push(t)}}}},n._purgeByAge=function(t){var e;if(!t.age||null==(e=this._timeInfo)||!e.startTimeField)return;const s=60*t.age*1e3,i=this._maxAge-s;this.store.forEach((t=>{t.attributes[this._timeInfo.startTimeField]<i&&this._removed.push(t.objectId)}))},n._purgeByAgeReceived=function(t,e){if(!e.ageReceived)return;const s=t+60*e.ageReceived*1e3;this.store.forEach((t=>{t.attributes[o]<s&&this._removed.push(t.objectId)}))},n._purgeTracks=function(){this._trackIdToObservations.forEach(((t,e)=>{0===t.size&&this._trackIdToObservations.delete(e)}))},t}();t.DEFAULT_STREAM_ID_FIELD=r,t.ESRI_TIMESTAMP=o,t.default=n,Object.defineProperty(t,"__esModule",{value:!0})}));
