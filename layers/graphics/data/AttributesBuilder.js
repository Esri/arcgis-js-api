/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../../core/maybe","./attributeSupport"],(function(t,e){"use strict";return function(){function s(t,s,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues,this.fieldsIndex=i,this.featureAdapter=s;const a=t.outFields;if(a&&-1===a.indexOf("*")){this.outFields=a;let t=0;for(const s of a){const a=e.getExpressionFromFieldName(s),r=this.fieldsIndex.get(a),n=r?null:e.getWhereClause(a,i),u=r?r.name:e.getAliasFromFieldName(s)||"FIELD_EXP_"+t++;this._fieldDataCache.set(s,{alias:u,clause:n})}}}var i=s.prototype;return i.countDistinctValues=function(t){return this.returnDistinctValues?(t.forEach((t=>this.getAttributes(t))),this._returnDistinctMap.size):t.length},i.getAttributes=function(t){const e=this._processAttributesForOutFields(t);return this._processAttributesForDistinctValues(e)},i.getFieldValue=function(t,s,i){const a=i?i.name:s;let r=null;return this._fieldDataCache.has(a)?r=this._fieldDataCache.get(a).clause:i||(r=e.getWhereClause(s,this.fieldsIndex),this._fieldDataCache.set(a,{alias:a,clause:r})),i?this.featureAdapter.getAttribute(t,a):r.calculateValue(t,this.featureAdapter)},i.validateItem=function(t,s){return this._fieldDataCache.has(s)||this._fieldDataCache.set(s,{alias:s,clause:e.getWhereClause(s,this.fieldsIndex)}),this._fieldDataCache.get(s).clause.testFeature(t,this.featureAdapter)},i.validateItems=function(t,s){return this._fieldDataCache.has(s)||this._fieldDataCache.set(s,{alias:s,clause:e.getWhereClause(s,this.fieldsIndex)}),this._fieldDataCache.get(s).clause.testSet(t,this.featureAdapter)},i._processAttributesForOutFields=function(t){const e=this.outFields;if(!e||!e.length)return this.featureAdapter.getAttributes(t);const s={};for(const i of e){const{alias:e,clause:a}=this._fieldDataCache.get(i);s[e]=a?a.calculateValue(t,this.featureAdapter):this.featureAdapter.getAttribute(t,e)}return s},i._processAttributesForDistinctValues=function(e){if(t.isNone(e)||!this.returnDistinctValues)return e;const s=this.outFields,i=[];if(s)for(const t of s){const{alias:s}=this._fieldDataCache.get(t);i.push(e[s])}else for(const t in e)i.push(e[t]);const a=`${(s||["*"]).join(",")}=${i.join(",")}`;let r=this._returnDistinctMap.get(a)||0;return this._returnDistinctMap.set(a,++r),r>1?null:e},s}()}));
