/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../core/maybe","./attributeSupport","../../../statistics/utils"],(function(t,e,i){"use strict";return function(){function s(t,i,s){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues??!1,this.fieldsIndex=s,this.featureAdapter=i;const a=t.outFields;if(a&&!a.includes("*")){this.outFields=a;let t=0;for(const i of a){const a=e.getExpressionFromFieldName(i),l=this.fieldsIndex.get(a),n=l?null:e.getWhereClause(a,s),r=l?l.name:e.getAliasFromFieldName(i)||"FIELD_EXP_"+t++;this._fieldDataCache.set(i,{alias:r,clause:n})}}}var a=s.prototype;return a.countDistinctValues=function(t){return this.returnDistinctValues?(t.forEach((t=>this.getAttributes(t))),this._returnDistinctMap.size):t.length},a.getAttributes=function(t){const e=this._processAttributesForOutFields(t);return this._processAttributesForDistinctValues(e)},a.getFieldValue=function(t,i,s){const a=s?s.name:i;let l=null;return this._fieldDataCache.has(a)?l=this._fieldDataCache.get(a)?.clause:s||(l=e.getWhereClause(i,this.fieldsIndex),this._fieldDataCache.set(a,{alias:a,clause:l})),s?this.featureAdapter.getAttribute(t,a):l?.calculateValue(t,this.featureAdapter)},a.getDataValue=function(t,e){const s=e.normalizationType,a=e.normalizationTotal;let l=e.field&&this.getFieldValue(t,e.field,this.fieldsIndex.get(e.field));if(e.field2&&(l=`${i.processNullValue(l)}${e.fieldDelimiter}${i.processNullValue(this.getFieldValue(t,e.field2,this.fieldsIndex.get(e.field2)))}`,e.field3&&(l=`${l}${e.fieldDelimiter}${i.processNullValue(this.getFieldValue(t,e.field3,this.fieldsIndex.get(e.field3)))}`)),s&&Number.isFinite(l)){const n="field"===s&&e.normalizationField?this.getFieldValue(t,e.normalizationField,this.fieldsIndex.get(e.normalizationField)):null;l=i.getNormalizedValue(l,s,n,a)}return l},a.getExpressionValue=function(t,e,i,s){const a={attributes:this.featureAdapter.getAttributes(t),layer:{fields:this.fieldsIndex.fields}},l=s.createExecContext(a,i);return s.executeFunction(e,l)},a.getExpressionValues=function(t,e,i,s){const a={fields:this.fieldsIndex.fields};return t.map((t=>{const l={attributes:this.featureAdapter.getAttributes(t),layer:a},n=s.createExecContext(l,i);return s.executeFunction(e,n)}))},a.validateItem=function(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:e.getWhereClause(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testFeature(t,this.featureAdapter)??!1},a.validateItems=function(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:e.getWhereClause(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testSet(t,this.featureAdapter)??!1},a._processAttributesForOutFields=function(t){const e=this.outFields;if(!e||!e.length)return this.featureAdapter.getAttributes(t);const i={};for(const s of e){const{alias:e,clause:a}=this._fieldDataCache.get(s);i[e]=a?a.calculateValue(t,this.featureAdapter):this.featureAdapter.getAttribute(t,e)}return i},a._processAttributesForDistinctValues=function(e){if(t.isNone(e)||!this.returnDistinctValues)return e;const i=this.outFields,s=[];if(i)for(const t of i){const{alias:i}=this._fieldDataCache.get(t);s.push(e[i])}else for(const t in e)s.push(e[t]);const a=`${(i||["*"]).join(",")}=${s.join(",")}`;let l=this._returnDistinctMap.get(a)||0;return this._returnDistinctMap.set(a,++l),l>1?null:e},s}()}));
