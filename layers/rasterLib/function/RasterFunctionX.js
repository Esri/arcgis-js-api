// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/config","../raster/RasterInfo","../../../geometry/Extent","../../PixelBlock"],(function(t,e,r,n,s,i){return t(null,{functionName:null,functionArguments:null,pixelType:"Unknown",rasterInfo:null,constructor:function(t){t&&(this.pixelType=t.outputPixelType||t.OutputPixelType||this.pixelType,this.renderTexture=t.renderTexture,this._initFunction())},mixinIgnoreCase:function(t,e){var r,n,s,i=Object.keys(t),a=Object.keys(e),o=i.length;for(r=0;r<a.length;r++)if(null!=(s=e[a[r]]))for(n=0;n<o;n++)if(i[n].toLowerCase()===a[r].toLowerCase()){t[i[n]]=s;break}return t},bind:function(t){},setProcessingContext:function(t){if(!t)throw"cannot bind to layer without options";this.useWebGL=!!t.useWebGL,this._tileMode=!!t.tileMode,this._glSetting=t.glSetting,this._rawRasterInfo=t.rawRasterInfo,this._xformSetting=t.xformSetting||this._xformSetting,this.gl=this.useWebGL?this._glSetting.gl:null,this._glSetting&&(this._glSetting.pingpong=null,this._glSetting.branches=null);var e,r=this.functionArguments.raster,n=this.functionArguments.raster2,s=this.functionArguments.dem,i=this.functionArguments.fillRaster,a=this.functionArguments.rasters;if(r&&r.functionArguments&&r.setProcessingContext(t),n&&n.functionArguments&&n.setProcessingContext(t),s&&s.functionArguments&&s.setProcessingContext(t),i&&i.functionArguments&&i.setProcessingContext(t),a)for(e=0;e<a.length;e++)a[e]&&a[e].functionArguments&&a[e].setProcessingContext(t);this.bind()},updateBranchStructure:function(){var t=0,e=this.functionArguments;return e.raster&&e.raster.read&&e.raster.functionArguments&&(t+=e.raster.updateBranchStructure()),e.raster2&&e.raster2.read&&e.raster2.functionArguments&&(t+=e.raster2.updateBranchStructure(),e.raster2.isBranch=!0,e.raster&&e.raster.read&&(e.raster.isBranch=!0)),e.rasters&&(t=e.rasters.length,e.rasters.forEach((function(t){t.read&&t.functionArguments&&(t.isBranch=!0)}))),e.dem&&e.dem.read&&e.dem.functionArguments&&(t+=e.dem.updateBranchStructure()),1===t?0:t},read:function(t){var e=this.processRasterArgument(t);return this.useWebGL?this.readGL(e):this.read2D(e)},hasTilingEffects:function(){return!1},read2D:function(){},readGL:function(){},getSourceRasterInfo:function(){var t,e={};if(this.functionArguments.raster2)e.functionArguments.raster=this._bindRaster(this.functionArguments.raster),e.functionArguments.raster2=this._bindRaster(this.functionArguments.raster2);else if(this.functionArguments.rasters)for(e.rasters=[],t=0;t<this.functionArguments.rasters.length;t++)e.rasters[t]=this._bindRaster(this.functionArguments.rasters[t]);else e.raster=this._bindRaster(this.functionArguments.raster);return this.sourceRasterInfo=e,e},processRasterArgument:function(t){var e=this.bind();if(!0!==e)throw e;var r,n={};if(this.functionArguments.raster2)n.raster=this._readRaster(this.functionArguments.raster,t),n.raster2=this._readRaster(this.functionArguments.raster2,t);else if(this.functionArguments.rasters)for(n.rasters=[],r=0;r<this.functionArguments.rasters.length;r++)n.rasters[r]=this._readRaster(this.functionArguments.rasters[r],t);else n.raster=this._readRaster(this.functionArguments.raster,t);return n},toJson:function(){var t,r=this.functionArguments,n=r.raster,s=r.raster2,i=r.rasters,a=n?n.toJson?n.toJson():n:null,o=s?s.toJson?s.toJson():s:null;i&&i.length>0&&(t=i.map((function(t){return t.toJson?t.toJson():t})));var u=e.mixin({},this.functionArguments);return u.raster=a,u.raster2=o,u.rasters=t,u=this._fixRasterFunctionJson(u),{rasterFunction:this.functionName,rasterFunctionArguments:u,outputPixelType:this.pixelType}},_initFunction:function(t){},_getIntegerRange:function(t){var e;switch(t){case"U8":e=[0,255];break;case"U16":e=[0,65535];break;case"U32":e=[0,4294967295];break;case"S8":e=[-128,127];break;case"S16":e=[-32768,32767];break;case"S32":e=[-2147483648,2147483647]}return e},_calculatePixelType:function(t,e){return t&&"unknown"!==t.toLowerCase()?t:e},_clonePixelData:function(t){if(null==t)return t;var e={};t.extent&&(e.extent=new s(t.extent.xmin,t.extent.ymin,t.extent.xmax,t.extent.ymax,t.extent.spatialReference));var r=t.pixelBlock;return null==r?e:(e.pixelBlock=r.clone?r.clone():i.prototype.clone(r),e)},_readRaster:function(t,e){var r,n;if(null==t||"$$"===t)r=this._clonePixelData(e.src[Object.keys(e.src)[0]]);else if(t&&t.rasterInfo&&!t.functionArguments)r=this._clonePixelData(e.src[t._rasterId]);else if(isNaN(t))t.read&&(r=t.functionArguments?t.read(e):this._clonePixelData(e));else{var s=e.src?e.src[Object.keys(e.src)[0]]:e,i=s.pixelBlock;(n=new Float32Array(i.width*i.height)).fill(parseFloat(t)),(r=this._clonePixelData(s)).pixelBlock.pixels=[n],r.isConstant=!0}return r},_bindRaster:function(t){var e;return t&&"$$"!==t?isNaN(t)?t.rasterInfo?e=t.rasterInfo:t.bind&&t.bind()&&(e=t.rasterInfo):e={}:e=this._rawRasterInfo,e&&((e=e.clone?e.clone():new n(e)).bandCount=e.bandCount||3),e},_getOutputBand:function(t,e){var r;switch(t){case"U8":r=new Uint8Array(e);break;case"U16":r=new Uint16Array(e);break;case"U32":r=new Uint32Array(e);break;case"S8":r=new Int8Array(e);break;case"S16":r=new Int16Array(e);break;case"S32":r=new Int32Array(e);break;case"U32":r=new Uint32Array(e);break;case"F32":r=new Float32Array(e);break;case"F64":r=new Float64Array(e);break;default:r=new Float32Array(e)}return r},_clampBand:function(t,e,r){if(("F64"===e||"F32"===e)&&!r)return t;var n,s,i,a,o,u=this._getIntegerRange(e),c=t.length;if(u)for(o=u[1],a=u[0],n=this._getOutputBand(e,c),s=0;s<c;s++)i=t[s],n[s]=i>o?o:i<a?a:i;else n=t;return n},_performance:{start:function(){return this._start=self.performance&&self.performance.now()||new Date,this._start}.bind(this),elapsed:function(){return(self.performance&&self.performance.now()||new Date)-this._start}.bind(this)},_addPerformanceMetric:function(t){r.isDebug&&(self.rasterFunctionPerformance||(self.rasterFunctionPerformance=[]),self.rasterFunctionPerformance.push(t),self.rasterFunctionPerformance.length>50&&self.rasterFunctionPerformance.shift())},_fixRasterFunctionJson:function(t){var e;for(e in t)t.hasOwnProperty(e)&&(null==t[e]?delete t[e]:t[e]instanceof Object&&!t[e].sourceType&&this._fixRasterFunctionJson(t[e],!0));return t}})}));