// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.38/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/config","../raster/RasterInfo","../../../geometry/Extent","../../PixelBlock"],(function(t,e,n,r,s,i){return t(null,{functionName:null,functionArguments:null,pixelType:"Unknown",rasterInfo:null,constructor:function(t){t&&(this.pixelType=t.outputPixelType||t.OutputPixelType||this.pixelType,this.renderTexture=t.renderTexture,this._initFunction())},mixinIgnoreCase:function(t,e){var n,r,s,i=Object.keys(t),a=Object.keys(e),o=i.length;for(n=0;n<a.length;n++)if(null!=(s=e[a[n]]))for(r=0;r<o;r++)if(i[r].toLowerCase()===a[n].toLowerCase()){t[i[r]]=s;break}return t},bind:function(t){},setProcessingContext:function(t){if(!t)throw"cannot bind to layer without options";if(this.useWebGL=!!t.useWebGL,this._tileMode=!!t.tileMode,this._glSetting=t.glSetting,this._rawRasterInfo=t.rawRasterInfo,this._xformSetting=t.xformSetting||this._xformSetting,!this.useWebGL||this._glSetting&&this._glSetting.gl){this.gl=this.useWebGL?this._glSetting.gl:null,this._glSetting&&(this._glSetting.pingpong=null,this._glSetting.branches=null);var e,n=this.functionArguments.raster,r=this.functionArguments.raster2,s=this.functionArguments.dem,i=this.functionArguments.fillRaster,a=this.functionArguments.rasters;if(n&&n.functionArguments&&n.setProcessingContext(t),r&&r.functionArguments&&r.setProcessingContext(t),s&&s.functionArguments&&s.setProcessingContext(t),i&&i.functionArguments&&i.setProcessingContext(t),a)for(e=0;e<a.length;e++)a[e]&&a[e].functionArguments&&a[e].setProcessingContext(t);this.bind()}},updateBranchStructure:function(){var t=0,e=this.functionArguments;return e.raster&&e.raster.read&&e.raster.functionArguments&&(t+=e.raster.updateBranchStructure()),e.raster2&&e.raster2.read&&e.raster2.functionArguments&&(t+=e.raster2.updateBranchStructure(),e.raster2.isBranch=!0,e.raster&&e.raster.read&&(e.raster.isBranch=!0)),e.rasters&&(t=e.rasters.length,e.rasters.forEach((function(t){t.read&&t.functionArguments&&(t.isBranch=!0)}))),e.dem&&e.dem.read&&e.dem.functionArguments&&(t+=e.dem.updateBranchStructure()),1===t?0:t},read:function(t){var e=this.processRasterArgument(t);return this.useWebGL?this.readGL(e):this.read2D(e)},hasTilingEffects:function(){return!1},read2D:function(){},readGL:function(){},getSourceRasterInfo:function(){var t,e={};if(this.functionArguments.raster2)e.functionArguments.raster=this._bindRaster(this.functionArguments.raster),e.functionArguments.raster2=this._bindRaster(this.functionArguments.raster2);else if(this.functionArguments.rasters)for(e.rasters=[],t=0;t<this.functionArguments.rasters.length;t++)e.rasters[t]=this._bindRaster(this.functionArguments.rasters[t]);else e.raster=this._bindRaster(this.functionArguments.raster);return this.sourceRasterInfo=e,e},processRasterArgument:function(t){var e=this.bind();if(!0!==e)throw e;var n,r={};if(this.functionArguments.raster2)r.raster=this._readRaster(this.functionArguments.raster,t),r.raster2=this._readRaster(this.functionArguments.raster2,t);else if(this.functionArguments.rasters)for(r.rasters=[],n=0;n<this.functionArguments.rasters.length;n++)r.rasters[n]=this._readRaster(this.functionArguments.rasters[n],t);else r.raster=this._readRaster(this.functionArguments.raster,t);return r},toJson:function(){var t,n=this.functionArguments,r=n.raster,s=n.raster2,i=n.rasters,a=r?r.toJson?r.toJson():r:null,o=s?s.toJson?s.toJson():s:null;i&&i.length>0&&(t=i.map((function(t){return t.toJson?t.toJson():t})));var u=e.mixin({},this.functionArguments);return u.raster=a,u.raster2=o,u.rasters=t,u=this._fixRasterFunctionJson(u),{rasterFunction:this.functionName,rasterFunctionArguments:u,outputPixelType:this.pixelType}},_initFunction:function(t){},_getIntegerRange:function(t){var e;switch(t){case"U8":e=[0,255];break;case"U16":e=[0,65535];break;case"U32":e=[0,4294967295];break;case"S8":e=[-128,127];break;case"S16":e=[-32768,32767];break;case"S32":e=[-2147483648,2147483647]}return e},_calculatePixelType:function(t,e){return t&&"unknown"!==t.toLowerCase()?t:e},_clonePixelData:function(t){if(null==t)return t;var e={};t.extent&&(e.extent=new s(t.extent.xmin,t.extent.ymin,t.extent.xmax,t.extent.ymax,t.extent.spatialReference));var n=t.pixelBlock;return null==n?e:(e.pixelBlock=n.clone?n.clone():i.prototype.clone(n),e)},_readRaster:function(t,e){var n,r;if(null==t||"$$"===t)n=this._clonePixelData(e.src[Object.keys(e.src)[0]]);else if(t&&t.rasterInfo&&!t.functionArguments)n=this._clonePixelData(e.src[t._rasterId]);else if(isNaN(t))t.read&&(n=t.functionArguments?t.read(e):this._clonePixelData(e));else{var s=e.src?e.src[Object.keys(e.src)[0]]:e,i=s.pixelBlock;(r=new Float32Array(i.width*i.height)).fill(parseFloat(t)),(n=this._clonePixelData(s)).pixelBlock.pixels=[r],n.isConstant=!0}return n},_bindRaster:function(t){var e;return t&&"$$"!==t?isNaN(t)?t.rasterInfo?e=t.rasterInfo:t.bind&&t.bind()&&(e=t.rasterInfo):e={}:e=this._rawRasterInfo,e&&((e=e.clone?e.clone():new r(e)).bandCount=e.bandCount||3),e},_getOutputBand:function(t,e){var n;switch(t){case"U8":n=new Uint8Array(e);break;case"U16":n=new Uint16Array(e);break;case"U32":n=new Uint32Array(e);break;case"S8":n=new Int8Array(e);break;case"S16":n=new Int16Array(e);break;case"S32":n=new Int32Array(e);break;case"U32":n=new Uint32Array(e);break;case"F32":n=new Float32Array(e);break;case"F64":n=new Float64Array(e);break;default:n=new Float32Array(e)}return n},_clampBand:function(t,e,n){if(("F64"===e||"F32"===e)&&!n)return t;var r,s,i,a,o,u=this._getIntegerRange(e),c=t.length;if(u)for(o=u[1],a=u[0],r=this._getOutputBand(e,c),s=0;s<c;s++)i=t[s],r[s]=i>o?o:i<a?a:i;else r=t;return r},_performance:{start:function(){return this._start=self.performance&&self.performance.now()||new Date,this._start}.bind(this),elapsed:function(){return(self.performance&&self.performance.now()||new Date)-this._start}.bind(this)},_addPerformanceMetric:function(t){n.isDebug&&(self.rasterFunctionPerformance||(self.rasterFunctionPerformance=[]),self.rasterFunctionPerformance.push(t),self.rasterFunctionPerformance.length>50&&self.rasterFunctionPerformance.shift())},_fixRasterFunctionJson:function(t){var e;for(e in t)t.hasOwnProperty(e)&&(null==t[e]?delete t[e]:t[e]instanceof Object&&!t[e].sourceType&&this._fixRasterFunctionJson(t[e],!0));return t}})}));