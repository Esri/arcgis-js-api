// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","./RasterFunctionX","../../PixelBlock","./vertexShaders","./pixelShaders","./RasterFunctionWebGLMixin"],function(t,i,e,r,s,a,n){return t([e,n],{declaredClass:"esri.layers.rasterLib.function.StretchFunction",functionName:"Stretch",supportWebGL:!0,support2D:!0,constructor:function(t){var i={stretchType:0,min:0,max:255,numberOfStandardDeviations:2,statistics:null,histograms:null,dra:!1,minPercent:.25,maxPercent:.5,useGamma:!1,gamma:null,raster:null,computeGamma:!1};this.functionArguments=this.mixinIgnoreCase(i,t),this.functionArguments.statistics=this._convertStats(this.functionArguments.statistics),-1===[0,3,5,6].indexOf(this.functionArguments.stretchType)&&(console.error("The specific stretch type has not been implemented: "+this.functionArguments.stretchType),this.functionArguments.stretchType=5)},bind:function(t){var e=this.getSourceRasterInfo(t);return e.raster?(this.rasterInfo=i.mixin(e.raster,{bandCount:e.raster.bandCount,pixelType:this._calculatePixelType(this.pixelType,"U8"),statistics:null,histograms:null}),this.rasterInfo.keyProperties=this.rasterInfo.keyProperties||{},this.rasterInfo.keyProperties.DataType="Generic",!0):new Error("The raster input to stretch function is invalid.")},read2D:function(t){var i=t.raster;return this._stretch(i),i},hasTilingEffects:function(t){return t=t||this.functionArguments,!!(t.dra||t.raster&&"object"==typeof t.raster&&t.raster.dra)},_convertStats:function(t){return t?t.map(function(t){return t&&null!=t.min?[t.min,t.max,t.mean,t.stddev]:t}):null},_updateStatistisHistograms:function(t){var i=this.functionArguments;if(!(t&&t.pixelBlock&&t.pixelBlock.pixels))return this._statistics=i.statistics,this._histograms=i.histograms,this._gammaCorrection=this._getGammaCorrection(),void(this._statistics=this._convertStats(this._statistics));if(0!==i.stretchType){var e,r=t.pixelBlock,s=r.pixels,a=s.length,n=6===i.stretchType&&(i.dra||!i.histograms)||3===i.stretchType&&i.dra;if(n&&(r.statistics||r.calculateStatistics(),this._calculateStatisticsHistograms(t)),i.dra)if(r.statistics||r.calculateStatistics(),n)this._statistics=r.statistics,this._histograms=r.histograms;else{var o=r.statistics;for(this._statistics=[],e=0;e<a;e++)this._statistics[e]=[o[e].minValue,o[e].maxValue,0,0]}else this._statistics=i.statistics,this._histograms=i.histograms;this._statistics=this._convertStats(this._statistics),this._gammaCorrection=this._getGammaCorrection()}},_getGammaCorrection:function(){var t=this.functionArguments.gamma;if(t){var i,e=[];for(i=0;i<t.length;i++)t[i]>1?t[i]>2?e[i]=6.5+Math.pow(t[i]-2,2.5):e[i]=6.5+100*Math.pow(2-t[i],4):e[i]=1;return e}},_stretch:function(t){if(null!==t&&null!==t.pixelBlock&&null!==t.pixelBlock.pixels){if(0!==this.functionArguments.stretchType){this._updateStatistisHistograms(t);var i,e,r=t.pixelBlock,s=r.pixels,a=r.width*r.height,n=s.length;if(this._createLUT(t),null==this.LUT)return this._filterNoLUT(t);var o,u,h=this.LUT,f=this.LUTOffset;for(i=0;i<n;i++)for(u=h[i],e=0;e<a;e++)o=s[i][e],s[i][e]=u[o-f];t.pixelBlock.pixelType="U8"}}},_calculateStatisticsHistograms:function(t){var e,r,s,a,n,o,u,h,f,m,c,l,g,_,x,T,p,d=this.functionArguments,A=t.pixelBlock,v=A.pixelType,E=A.pixels,U=A.mask,F=E.length,R=function(t){d.min=-.5,d.max=255.5,this.size=256,i.mixin(this,t),this.counts=this.counts||new Uint32Array(this.size)},b=[];for(a=0;a<F;a++){if(o=new R,u=o.counts,f=E[a],"U8"===v)if(U)for(n=0;n<A.width*A.height;n++)U[n]&&u[f[n]]++;else for(n=0;n<A.width*A.height;n++)u[f[n]]++;else{if(e=A.statistics[a].minValue,r=A.statistics[a].maxValue,o.min=e,o.max=r,s=(r-e)/256,h=new Uint32Array(257),U)for(n=0;n<A.width*A.height;n++)U[n]&&h[Math.floor((f[n]-e)/s)]++;else for(n=0;n<A.width*A.height;n++)h[Math.floor((f[n]-e)/s)]++;for(n=0;n<255;n++)u[n]=h[n];u[255]=h[255]+h[256]}for(b.push(o),m=[],e=A.statistics[a].minValue,r=A.statistics[a].maxValue,c=0,l=0,x=0,n=0;n<o.size;n++)c+=u[n],l+=n*u[n];for(T=l/c,n=0;n<o.size;n++)x+=u[n]*Math.pow(n-T,2);p=Math.sqrt(x/(c-1)),g=(T+.5)*(o.max-o.min)/o.size+o.min,_=p*(o.max-o.min)/o.size,m.push(e),m.push(r),m.push(g),m.push(_),A.statistics[a]={min:e,minValue:e,max:r,maxValue:r,mean:g,stddev:_}}A.histograms=b},_getCutOffPoints:function(t){var i=this.functionArguments,e=999;t&&t.pixelBlock?e=t.pixelBlock.pixels.length:t&&t.texture&&(e=3);var r,s,a,n,o,u,h,f,m=Math.min(e,this._statistics.length),c=[],l=[];switch(i.stretchType){case 5:for(h=0;h<m;h++)c[h]=this._statistics[h][0],l[h]=this._statistics[h][1];break;case 3:for(h=0;h<m;h++)c[h]=this._statistics[h][2]-i.numberOfStandardDeviations*this._statistics[h][3],l[h]=this._statistics[h][2]+i.numberOfStandardDeviations*this._statistics[h][3],c[h]<this._statistics[h][0]&&(c[h]=this._statistics[h][0]),l[h]>this._statistics[h][1]&&(l[h]=this._statistics[h][1]);break;case 6:for(h=0;h<m;h++){for(r=this._histograms[h],n=new Uint32Array(r.size),a=r.counts,s=0,u=-.5===r.min&&(r.max-r.min)/a==1?.5:0,f=0;f<r.size;f++)s+=a[f],n[f]=s;for(o=i.minPercent*s/100,f=0;f<r.size;f++)if(n[f]>o){c[h]=r.min+(r.max-r.min)/r.size*(f+u);break}for(o=(1-i.maxPercent/100)*s,f=r.size-2;f>=0;f--)if(n[f]<o){l[h]=r.min+(r.max-r.min)/r.size*(f+2-u);break}}break;default:for(h=0;h<e;h++)c[h]=0,l[h]=255}return{minCutOff:c,maxCutOff:l}},_createLUT:function(t){var i=this.functionArguments,e=t.pixelBlock,r=e.pixelType;if("U8"===r||"U16"===r||"S8"===r||"S16"===r){if(this._LUTSignature){var s=this._computeLutSignature();if(s.length===this._LUTSignature.length&&!s.some(function(t,i){return t!==this._LUTSignature[i]}.bind(this)))return}var a,n,o,u,h,f=e.pixels,m=f.length,c=[],l=[],g=[],_=i.max,x=i.min,T=i.gamma,p=_-x,d=this._getCutOffPoints(t),A=d.minCutOff,v=d.maxCutOff,E=0,U=256;for("S8"===e.pixelType?E=-127:"S16"===e.pixelType&&(E=-32767),"U16"!==e.pixelType&&"S16"!==e.pixelType||(U=65536),a=0;a<m;a++)l[a]=v[a]-A[a],c[a]=p/(v[a]-A[a]);var F=this._gammaCorrection;if(i.useGamma){var R;for(a=0;a<m;a++){for(h=[],n=0;n<U;n++)o=n+E,R=(o-A[a])/l[a],u=1,T[a]>1&&(u-=Math.pow(1/p,R*F[a])),o<v[a]&&o>A[a]?h[n]=Math.floor(u*p*Math.pow(R,1/T[a]))+x:o>v[a]?h[n]=_:o<A[a]&&(h[n]=x);g[a]=h}}else for(a=0;a<m;a++){for(h=[],n=0;n<U;n++)o=n+E,o<A[a]?h[n]=x:o>v[a]?h[n]=_:h[n]=Math.floor((o-A[a])/l[a]*p)+x;g[a]=h}this.LUT=g,this.LUTOffset=E,this._LUTSignature=this._computeLutSignature()}},_computeLutSignature:function(){var t,i,e=this.functionArguments,r=[];if(r.push(e.stretchType),r.push(e.min),r.push(e.max),r.push(e.numberOfStandardDeviations),this._statistics)for(t=0;t<this._statistics.length;t++)for(i=0;i<this._statistics[t].length;i++)r.push(this._statistics[t][i]);if(r.push(e.dra?1:0),r.push(e.minPercent),r.push(e.maxPercent),e.gamma)for(t=0;t<this._statistics.length;t++)r.push(e.gamma[t]);return r.push(e.useGamma?1:0),r},_filterNoLUT:function(t){if(null!==t&&null!==t.pixelBlock&&null!==t.pixelBlock.pixels){var i,e,r,s,a,n=this.functionArguments,o=t.pixelBlock,u=o.pixels,h=o.mask,f=o.width*o.height,m=u.length,c=[],l=[],g=[],_=n.max,x=n.min,T=n.gamma,p=_-x,d=this._getCutOffPoints(t),A=d.minCutOff,v=d.maxCutOff;for(i=0;i<m;i++)l[i]=v[i]-A[i],c[i]=p/(v[i]-A[i]);if(n.useGamma&&null!==T&&T.length>=m)for(i=0;i<m;i++)T[i]>1?T[i]>2?g[i]=6.5+Math.pow(T[i]-2,2.5):g[i]=6.5+100*Math.pow(2-T[i],4):g[i]=1;if(n.useGamma)if(void 0!==h&&null!==h){for(e=0;e<f;e++)if(h[e])for(i=0;i<m;i++)r=u[i][e],a=(r-A[i])/l[i],s=1,T[i]>1&&(s-=Math.pow(1/p,a*g[i])),r<v[i]&&r>A[i]?u[i][e]=Math.floor(s*p*Math.pow(a,1/T[i]))+x:r>v[i]?u[i][e]=_:r<A[i]&&(u[i][e]=x)}else for(e=0;e<f;e++)for(i=0;i<m;i++)r=u[i][e],a=(r-A[i])/l[i],s=1,T[i]>1&&(s-=Math.pow(1/p,a*g[i])),r<v[i]&&r>A[i]?u[i][e]=Math.floor(s*p*Math.pow(a,1/T[i]))+x:r>v[i]?u[i][e]=_:r<A[i]&&(u[i][e]=x);else if(void 0!==h&&null!==h){for(e=0;e<f;e++)if(h[e])for(i=0;i<m;i++)r=u[i][e],r<v[i]&&r>A[i]?u[i][e]=Math.floor((r-A[i])/l[i]*p)+x:r>v[i]?u[i][e]=_:r<A[i]&&(u[i][e]=x)}else for(e=0;e<f;e++)for(i=0;i<m;i++)r=u[i][e],r<v[i]&&r>A[i]?u[i][e]=Math.floor((r-A[i])/l[i]*p)+x:r>v[i]?u[i][e]=_:r<A[i]&&(u[i][e]=x);return t.pixelBlock.pixelType="U8",t}},_computeGammaValues:function(t){var i,e,r=this._statistics.length,s=[];for(i=0;i<r;i++)e=this._statistics[i][2],"U8"!==t&&(e=255*(e-this._statistics[i][0])/(this._statistics[i][1]-this._statistics[i][0])),s.push(this._computeGammaValue(e));return s},_computeGammaValue:function(t){if(0!==t&&!(t>255||t<0)){var i=0;t>0&&150!=t&&t<255&&(i=t<=150?45*Math.cos(.01047*t):17*Math.sin(.021*t));var e=t+i,r=Math.log(t/255),s=Math.log(e/255);if(0!==s){var a=r/s;if(!isNaN(a))return Math.min(9.9,Math.max(.01,a))}}},readGL:function(t){return this._stretchGL(t.raster)},_stretchGL:function(t){this._performance.start();var i,e,s,n=this.renderTexture,o=this.sourceRasterInfo.raster.bandCount,u=t.pixelBlock,h=this.gl,f=h.drawingBufferWidth,m=h.drawingBufferHeight;if(!u&&this.functionArguments.dra){var c=new Float32Array(f*m*4),l=new Uint8Array(f*m),g=new Float32Array(f*m),_=new Float32Array(f*m),x=new Float32Array(f*m);for(h.checkFramebufferStatus(h.FRAMEBUFFER)==h.FRAMEBUFFER_COMPLETE&&h.readPixels(0,0,f,m,h.RGBA,h.FLOAT,c),i=0;i<f*m;i++)g[i]=c[4*i],_[i]=c[4*i+1],x[i]=c[4*i+2],l[i]=c[4*i+3];t.pixelBlock=new r({width:f,height:m,pixels:[g,_,x],mask:l}),t.pixelBlock.calculateStatistics()}if(!u&&this.functionArguments.dra&&this._useGPUStats)e=new Float32Array(o),s=new Float32Array(o);else{this._updateStatistisHistograms(t);var T=this._getCutOffPoints(t);e=new Float32Array(o),s=new Float32Array(o),e.set(T.minCutOff.slice(0,o)),s.set(T.maxCutOff.slice(0,o))}this._initializeProgram({fragment:a.stretch,fragmentName:"Stretch"});var p=this._setupTextureData(t),d=p;this.renderTexture=!1;var A=h.getUniformLocation(this.rasterProgram,"u_image");h.uniform1i(A,0),h.activeTexture(h.TEXTURE0);var v,E;if(this._performance.start(),!u&&this.functionArguments.dra&&this._useGPUStats){this._setUniforms({u_sourceDim:[f,m],u_bandCount:o}),1===o?v=this._readMinMax(p,2):(v=this._readMinMax(p,0),E=this._readMinMax(p,1));if(6===this.functionArguments.stretchType||3===this.functionArguments.stretchType&&this.functionArguments.dra){var U=this._readHistogram(v,E,t);e=U.minCutOff||e,s=U.minCutOff||s}}var F=this.functionArguments.max-this.functionArguments.min,R=new Float32Array(o);for(i=0;i<o;i++)R[i]=F/(s[i]-e[i]);this._initializeProgram({fragment:a.stretch,fragmentName:"Stretch"}),h.blendFunc(h.SRC_ALPHA,h.ZERO);var b=new Float32Array(3),w=new Float32Array(3);for(i=0;i<3;i++)b[i]=this.functionArguments.min,w[i]=this.functionArguments.max;var M=this.functionArguments.useGamma,y=this.functionArguments.gamma,L=this._gammaCorrection;if(this._setUniforms({u_sourceDim:[f,m],u_bandCount:o,u_minOutput:b,u_maxOutput:w,u_minCutOff:e,u_maxCutOff:s,u_factor:R,u_state:100,u_useGamma:M,u_gamma:y,u_scaled:!n,u_gammaCorrection:L,u_minMaxTexture:!(u||!this.functionArguments.dra||!this._useGPUStats)}),this.renderTexture=n,h.viewport(0,0,f,m),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,d.texture),!u&&this.functionArguments.dra&&this._useGPUStats){var P=h.getUniformLocation(this.rasterProgram,"u_image1");if(h.uniform1i(P,1),h.activeTexture(h.TEXTURE1),h.bindTexture(h.TEXTURE_2D,v.texture),o>1){var B=h.getUniformLocation(this.rasterProgram,"u_image2");h.uniform1i(B,2),h.activeTexture(h.TEXTURE2),h.bindTexture(h.TEXTURE_2D,E.texture)}}var S=this.bindFrameBuffer();return this._drawGL(),{extent:d.extent,texture:S.texture}},_readMinMax:function(t,i){var e=this.gl,r=t.width||e.drawingBufferWidth,s=t.height||e.drawingBufferHeight;this._setUniforms({u_state:i}),this.renderTexture=!1;var a,n,o,u,h=t.texture;for(e.activeTexture(e.TEXTURE0);r>1||s>1;)n=this._createTexture(),o=Math.max(Math.ceil(r/2),1),u=Math.max(Math.ceil(s/2),1),e.getExtension("OES_texture_float"),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,o,u,0,e.RGBA,e.FLOAT,null),a=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0),e.viewport(0,0,o,u),e.bindTexture(e.TEXTURE_2D,h),this._setUniforms({u_sourceDim:[r,s]}),r=o,s=u,this._drawGL(!0),h=n;var f=new Float32Array(r*s*4);return e.checkFramebufferStatus(e.FRAMEBUFFER)==e.FRAMEBUFFER_COMPLETE&&e.readPixels(0,0,r,s,e.RGBA,e.FLOAT,f),{texture:n,minmax:f}},_readHistogram:function(t,i,e){if(t)try{var r,n,o,u,h,f,m,c=this.gl,l=c.drawingBufferWidth,g=c.drawingBufferHeight;if(t.texture instanceof WebGLTexture)m=!0,u=[1,0,0,1],i?(h=t.minmax,f=i.minmax):(h=[t.minmax[0]],f=[t.minmax[1]]);else for(f=i,h=t,u=new Float32Array(f.length),r=0;r<f.length;r++)u[r]=256/(f[r]-h[r]);var _=new Float32Array(l*g);for(o=0;o<_.length;o++)_[o]=o;if(!this.histogramProgram){var x=s.getShader(c,s.histogram),T=a.getShader(c,a.constant);this.histogramProgram=this._loadProgram(x,T)}c.blendFunc(c.ONE,c.ONE),c.enable(c.BLEND),c.useProgram(this.histogramProgram);var p=c.getAttribLocation(this.histogramProgram,"a_pixelIndex"),d=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,d),c.bufferData(c.ARRAY_BUFFER,_,c.STATIC_DRAW),c.enableVertexAttribArray(p),c.vertexAttribPointer(p,1,c.FLOAT,!1,0,0);var A=this._setupHistTexture(e),v=this._createTexture();c.getExtension("OES_texture_float"),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,257,1,0,c.RGBA,c.FLOAT,null);var E=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,E),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,v,0);c.viewport(0,0,257,1);var U=c.getUniformLocation(this.histogramProgram,"u_image");c.uniform1i(U,0),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,A);var F=c.getUniformLocation(this.histogramProgram,"u_sourceDim");c.uniform2f(F,l,g);var R=c.getUniformLocation(this.histogramProgram,"u_bandCount");c.uniform1i(R,3);var b=c.getUniformLocation(this.histogramProgram,"u_halfPixel");c.uniform2f(b,.5/l,.5/g);var w=c.getUniformLocation(this.histogramProgram,"u_minMaxTexture");if(m){c.uniform1i(w,1);var M=c.getUniformLocation(this.histogramProgram,"u_image1");if(c.uniform1i(M,1),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,t.texture),i){var y=c.getUniformLocation(this.histogramProgram,"u_image2");c.uniform1i(y,2),c.activeTexture(c.TEXTURE2),c.bindTexture(c.TEXTURE_2D,i.texture)}}else{var L=c.getUniformLocation(this.histogramProgram,"u_mins");c.uniform4f(L,h[0],h[0],h[0],h[0]),c.uniform1i(w,0)}var P=c.getUniformLocation(this.histogramProgram,"u_color"),B=c.getUniformLocation(this.histogramProgram,"u_factors"),S=c.getUniformLocation(this.histogramProgram,"u_size");c.uniform1f(S,256);var O,C=[],G=[];c.uniform4fv(P,[1,0,0,1]),c.uniform4fv(B,[u[0],0,0,1]),c.drawArrays(c.POINTS,0,_.length);var k=this.sourceRasterInfo.raster.bandCount;if(k>1&&(c.uniform4fv(P,[0,1,0,1]),c.uniform4fv(B,[0,u[0],0,1]),c.drawArrays(c.POINTS,0,_.length),c.uniform4fv(P,[0,0,1,1]),c.uniform4fv(B,[0,0,u[0],1]),c.drawArrays(c.POINTS,0,_.length)),c.checkFramebufferStatus(c.FRAMEBUFFER)==c.FRAMEBUFFER_COMPLETE){O=new Float32Array(1028),c.readPixels(0,0,257,1,c.RGBA,c.FLOAT,O);var D,X=0,H=-.5===h[0]&&(f[0]-h[0])/256==1?.5:0;for(r=0;r<k;r++){D=new Float32Array(257);var I=new Float32Array(257);for(X=0,o=0;o<256;o++)X+=O[4*o+r],D[o]=X,I[o]=O[4*o+r];I[256]=O[1024+r],D[256]=X+O[1024+r];var z=this.functionArguments.minPercent*X/100;if(f){for(n=0;n<256;n++)if(D[n]>z){C[r]=h[0]+(f[0]-h[0])/256*(n+H);break}for(z=(1-this.functionArguments.maxPercent/100)*X,n=254;n>=0;n--)if(D[n]<z){G[r]=h[0]+(f[0]-h[0])/256*(n+2-H);break}}}}return{histogram:O,minCutOff:C,maxCutOff:G}}catch(t){return void console.debug("webgl filter exception: "+t.message)}},_setupHistTexture:function(t){if(t instanceof WebGLTexture)return t;var i=this.originalHistTexture=this._createTexture(),e=this.gl,r=t.pixelBlock,s=r.width,a=r.height;return e.getExtension("OES_texture_float"),this.rgbaFloatData=r.getAsRGBAFloat(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,s,a,0,e.RGBA,e.FLOAT,this.rgbaFloatData),i}})});