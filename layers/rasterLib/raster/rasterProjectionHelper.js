// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/sniff","../../../kernel","../../../WKIDUnitConversion","../../../geometry/Extent","../../../geometry/projection","../../../geometry/webMercatorUtils","../../../SpatialReference","../../../geometry/Point"],(function(e,r,o,s,n,t,i,a,l,c,d){var f={requirePE:function(e,r){return!(e.equals(r)||e._canProject(r))},load:function(){var e=new o;if(!this._loadPromise)if(a.isSupported())this._loadPromise=a.load();else{var s=new o;s.reject("projection engine is not supported on this version of the browser, please try with a modern browser"),this._loadPromise=s.promise}return this._loadPromise.isFulfilled()?this._loadPromise.isResolved()?e.resolve():this._loadPromise.isRejected()&&e.resolve():(this._pendingdfds=this._pendingdfds||[],this._pendingdfds.push(e),this._loadPromise.then(r.hitch(this,(function(){this._pendingdfds.forEach((function(e){e.isFulfilled()||e.resolve()}))})),r.hitch(this,(function(){this._pendingdfds.forEach((function(e){e.isFulfilled()||e.reject()}))})))),e.promise},computeError:function(e,r){var o=(e[0]+e[4]+e[4*r.rows]+e[4*r.rows+4])/4,s=(e[1]+e[5]+e[4*r.rows+1]+e[4*r.rows+5])/4;return[Math.abs(o-e[2*r.rows+2]),Math.abs(s-e[2*r.rows+3])]},project:function(e,r){if(!r||e.spatialReference.equals(r))return e;var o=a.isLoaded()?a:l;"esri.geometry.Extent"===e.declaredClass?e=new i(e.toJson()):"esri.geometry.Point"===e.declaredClass&&(e=new d(e.toJson())),r=new c(r.toJson());var s=o.project(e,r);return s&&"esri.geometry.Extent"===s.declaredClass?s=new i(s.toJson()):s&&"esri.geometry.Point"===s.declaredClass&&(s=new d(s.toJson())),s},projectResolution:function(e,r,o){var s=o.xmin+(o.xmax-o.xmin)/2,n=o.ymin+(o.ymax-o.ymin)/2,t=new i(s,n,s+e.x,n+e.y,e.spatialReference),a=this.project(t,r);return new d(a.xmax-a.xmin,a.ymax-a.ymin,r)},getProjectionOffsetGrid:function(e,r,o,s,n,t){null==t&&(t=[32,32]);var i,c,f,u,m,h,p,x=e.xmin,w=e.ymin,y=e.xmax,g=e.ymax,j=e.spatialReference,v=r.spatialReference,_=a.isLoaded()?a:l,P=n?-n:null,b=n,R=t[0]*o.x,E=t[1]*o.y,F={cols:Math.ceil((y-x)/R)+1,rows:Math.ceil((g-w)/E)+1},M=[];for(f=0;f<F.cols;f++)for(h=p,p=[],u=0;u<F.rows;u++){if(i=new d({x:x+R*f,y:w+E*u,spatialReference:j}),!(c=_.project(i,v)))return null;p.push(c),f>0&&null!=P&&c.x<h[u].x&&(c.x+=b-P,c.x<h[u].x&&(c.x+=b-P)),M.push((c.x-r.xmin)/(r.xmax-r.xmin)),M.push((c.y-r.ymin)/(r.ymax-r.ymin))}var C=this.computeError(M,F),J=new Float32Array((F.cols-1)*(F.rows-1)*2*6),W=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),q=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(f=0;f<F.cols-1;f++)for(u=0;u<F.rows-1;u++){var A=f*F.rows*2+2*u,L=M[A],k=M[A+1],D=M[A+2],H=M[A+3],O=M[A+=2*F.rows],S=M[A+1],U=M[A+2],z=M[A+3],G=0,I=12*(u*(F.cols-1)+f);for(m=0;m<3;m++)J[I++]=W[G++]*L+W[G++]*D+W[G++]*U;for(G=0,m=0;m<3;m++)J[I++]=W[G++]*k+W[G++]*H+W[G++]*z;for(G=0,m=0;m<3;m++)J[I++]=q[G++]*L+q[G++]*O+q[G++]*U;for(G=0,m=0;m<3;m++)J[I++]=q[G++]*k+q[G++]*S+q[G++]*z}return{offsets:M,error:C,coefficients:J,spacing:t,size:[F.cols-1,F.rows-1]}},getHalfWorldWidth:function(e){var r=e&&e.wkid;if(null!=r)return e.isWebMercator()&&(r=3857),null==t[r]?180:u[r]}};s("extend-esri")&&r.setObject("layers.rasterLib.raster.rasterProjectionHelper",f,n);var u={3395:20037508.342789244,3410:17334193.943686873,3832:3339584.723798206,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,8858:7396237.374497803,8859:2465412.4581659334,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53025:7276828.3848298555,53031:10384677.558821043,53034:20015086.79602057,53036:7389443.187332862,53037:2463147.729110953,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54025:7311399.09166516,54031:10396310.810074743,54034:20037508.342789244,54050:808820.9223376509,54053:1920897.3915568967,54079:20037508.342789244,54080:20037508.342789244,54099:13524439.768288724,54100:20037508.342789244,54101:20037508.342789244,102038:4297258.582585486,102299:5013965.117483125};return f}));