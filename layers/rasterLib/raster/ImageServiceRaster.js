// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.43/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/config","dojo/_base/json","dojo/sniff","dojo/DeferredList","dojo/when","../../../kernel","../../../Evented","../../../request","../../../geometry/Extent","../../../geometry/Point","../../../SpatialReference","../../../WKIDUnitConversion","../../../deferredUtils","../../../urlUtils","../../MosaicRule","../../ImageServiceParameters","../../PixelBlock","./RasterInfo","./BasicRaster","../../rasterFormats/rasterCodec","../tile/RasterTileInfo"],(function(e,i,t,n,a,s,r,o,l,c,u,m,f,h,d,p,v,g,I,_,b,x,y,R,P,k){var j=i([R],{declaredClass:"esri.layers.rasterLib.raster.ImageServiceRaster",sourceType:"ImageService",constructor:function(e){e&&(this._imageServiceParams=e.imageServiceParameters,this._commonReqParams=e._commonReqParams,this._imageServiceParams||(this._imageServiceParams={interpolation:e.interpolation,pixelType:e.pixelType,format:e.format||"lerc",compressionQuality:e.compressionQuality,bandIds:e.bandIds,noDataInterpretation:e.noDataInterpretation,adjustAspectRatio:e.adjustAspectRatio,mosaicRule:e.mosaicRule,renderingRule:e.interpolation}))},open:function(){var e=new n;if(this.serviceInfo&&this.rasterInfo)return this.loaded=!0,this._findCredential(),this.setFetchParameters(this._imageServiceParams),e.resolve(this),e.promise;var i=this.serviceInfo||this._generateServiceInfo(this._imageServiceParams&&this._imageServiceParams.renderingRule),a=t.hitch(this,(function(i){this._fixServiceInfo(i),this.serviceInfo=i,this._findCredential();var n=this._parseRasterInfo(i),a={};i.defaultMosaicMethod?(a.method=i.defaultMosaicMethod,a.operation=i.mosaicOperator,a.sortField=i.sortField,a.sortValue=i.sortValue):a.method=_.METHOD_NONE,this.serviceInfo.defaultMosaicRule=new _(a),this.serviceInfo.defaultMosaicRule.ascending=!0;var s=this._getColormap(this),r=this._getHistograms(this),o=this._getRasterAttributeTable(this),c=this._getKeyProperties(this),u=this._getMultidimensionalInfo(),m=this._getSlices();new l([s,r,o,c,u,m]).then(t.hitch(this,(function(i){i[0][0]&&(n.colormap=i[0][1]),i[1][0]&&(n.histograms=i[1][1]),i[2][0]&&(n.vat=i[2][1]),i[3][0]&&(n.keyProperties=i[3][1]),i[4][0]&&(n.multidimensionalInfo=i[4][1],n.multidimensionalInfo&&n.multidimensionalInfo.variables&&n.multidimensionalInfo.variables.forEach((function(e){e.statistics&&(e.statistics.forEach((function(e){e.stddev=e.standardDeviation})),n.statistics||e.statistics.length!==n.bandCount||(n.statistics=e.statistics)),!n.histograms&&e.histograms&&e.histograms.length===n.bandCount&&(n.histograms=e.histograms)}))),n.keyProperties=n.keyProperties||{},this._slices=i[5][0]?i[5][1]:null,n.keyProperties&&n.keyProperties.DataType&&(this.dataType=n.keyProperties.DataType),n.keyProperties&&n.keyProperties.DefaultVariable&&(this.defaultVariable=n.keyProperties.DefaultVariable),this.loaded=!0,this.rasterInfo=n,this.setFetchParameters(this._imageServiceParams),e.resolve(this)})))})),s=t.hitch(this,(function(i){this.loaded=!0,e.reject(i)}));return c(i,a,s),e.promise},setFetchParameters:function(e,i){if(i)this.imageServiceParams=e;else{var t=this.imageServiceParams;t&&e?Object.keys(e).forEach((function(i){t[i]=e[i]})):this.imageServiceParams=e}this._constructGetImageParams(),this._getRasterIdentifier(!0)},read:function(e){if(e.pixelBlock||e.texture){var i=new n;return i.resolve(e),i.promise}if(!1===e.virtual&&this.tileInfo&&!this.tileInfo.virtual)return this.readTile(e);if(this._slices){var a=this._getSliceId();if(null==a)return(i=new n).resolve(e),i.promise}var s=e.extent,o=s.spatialReference.wkid||r.toJson(s.spatialReference.toJson(!1)),l=e.timeExtent?e.timeExtent.toJson().join(","):null,c=this.url+"/exportImage",u={};this._slices&&(u.sliceid=a),this.disableClientCaching&&(u._ts=(new Date).getTime());var m=t.mixin({},this._commonReqParams,{bbox:s.xmin+","+s.ymin+","+s.xmax+","+s.ymax,imageSR:o,bboxSR:o,size:e.width+","+e.height,time:l},u),f={width:e.width,height:e.height,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:!1};return this._requestPixels({url:c,payload:m,decodeParams:f,tileOptions:e})},readTile:function(e){var i=this.tileBoundary&&this.tileBoundary[e.level];if(i&&(i.minRow>e.row||i.maxRow<e.row||i.minCol>e.col||i.maxCol<e.col)){var t=new n;return t.resolve(e),t.promise}if(this._slices){var a=this._getSliceId();if(null==a)return(t=new n).resolve(e),t.promise}var s=this.url+"/tile/"+e.level+"/"+e.row+"/"+e.col,r={width:this.tileInfo.cols,height:this.tileInfo.rows,planes:null,pixelType:null,format:null,decodeFunc:null,useWasm:!0,isPoint:"elevation"===e.tileType.toLowerCase()},o=this._slices?"sliceid="+a+"&":"";return o=this.disableClientCaching?"_ts= "+(new Date).getTime():o.replace(/&$/,""),this._requestPixels({url:s+(o.length>0?"?"+o:""),payload:{},decodeParams:r,tileOptions:e})},toJson:function(){return{url:this.url,tileInfo:this.tileInfo,rasterInfo:this.rasterInfo,serviceInfo:this.serviceInfo,sourceType:this.sourceType,_commonReqParams:this._commonReqParams,_rasterId:this._rasterId}},_getSliceId:function(){var e=t.clone(this._imageServiceParams.multidimensionalDefinition),i=t.clone(this._imageServiceParams.time);if(null==this._slices||null==i&&(null==e||0===e.length))return 0;var n=e||this.defaultMultidimensionalDefinition,a=n[0].variableName,s=null;if(null==(n=this._getAllDimensionDefinition(n,a).definition)||0===n.length)return null;if(i&&this.serviceInfo.timeInfo){var r;if(null==i[1]||i[1]===i[0])r=i[0];else{var o=this.serviceInfo.timeInfo.startTimeField,l=this.rasterInfo.multidimensionalInfo.variables.find((function(e){return e.name===a})).dimensions.find((function(e){return e.name===o})).values.filter((function(e){return Array.isArray(e)?Math.max(e[0],i[0])<Math.min(e[1],i[1]):e>=i[0]&&e<=i[1]}));r=l.sort((function(e,t){return e=Array.isArray(e)?e[1]:e,t=Array.isArray(t)?e[1]:t,Math.abs(i[1]-e)-Math.abs(i[1]-t)}))[0]||[i[1]]}if(!n.some((function(e){return e.dimensionName===o?(e.values[0]=r,!0):e.dimensionName?void 0:(e.dimensionName=o,e.isSlice=!0,e.values=[r],!0)}))){var c={variableName:a,dimensionName:o,isSlice:!0,values:[r]};n.push(c)}}for(var u=0;u<this._slices.length;u++){var m=this._slices[u].multidimensionalDefinition;if(m.length===n.length&&!m.some((function(e){var i=n.filter((function(i){return e.variableName===i.variableName&&i.dimensionName===e.dimensionName}))[0];return!i||(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(i.values[0])?i.values[0][0]:i.values[0])}))){s=u;break}}return s},_getAllDimensionDefinition:function(e,i){var t=e.map((function(e){return e.dimensionName})),n=!1;return this.rasterInfo.multidimensionalInfo.variables.forEach((function(a){a.name===i&&(a.dimensions.length===e.length&&t[0]||(a.dimensions.forEach((function(n){t.indexOf(n.name)<0&&(t[0]?e.push({variableName:i,dimensionName:n.name,values:[n.values[0]]}):(e[0].dimensionName=n.name,e[0].values=[n.values[0]],n[0]=n.name))})),n=!0))}),this),{defChanged:n,definition:e}},_generateServiceInfo:function(e){var i=this.url,t=new n(g._dfdCanceller);return t._pendingDfd=f({url:i,content:{f:"json",renderingRule:e?r.toJson(e.toJson()):null},handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then((function(e){t.callback(e)}),(function(e){t.errback(e)})),t},_fixServiceInfo:function(e){var i=e.spatialReference.wkid;e.tileInfo&&0===e.extent.xmin&&360===e.extent.xmax&&i&&null==v[i]&&(e.tileInfo.applyGCS360Transform=!0)},_parseRasterInfo:function(e){var i,t,n=new y;if(n.bandCount=e.bandCount,n.extent=new h(e.fullExtent),n.spatialReference=e.spatialReference,n.pixelType=e.pixelType,n.width=Math.floor((e.fullExtent.xmax-e.fullExtent.xmin)/e.pixelSizeX+.5),n.height=Math.floor((e.fullExtent.ymax-e.fullExtent.ymin)/e.pixelSizeY+.5),n.cellSize=new d({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:e.spatialReference}),e.minValues&&e.minValues.length>0&&e.maxValues&&e.stdvValues&&e.meanValues){for(i=[],t=0;t<e.minValues.length;t++)i.push({min:e.minValues[t],max:e.maxValues[t],mean:e.meanValues[t],stddev:e.stdvValues[t]});e.bandCount!==i.length&&(i=null)}if(this.dataType=e.serviceDataType?e.serviceDataType.replace("esriImageServiceDataType",""):"Generic",n.statistics=i,e.objectIdField&&e.fields&&(n.catalogInfo={objectIdField:e.objectIdField,fields:e.fields}),n.timeInfo=e.timeInfo,e.tileInfo){this.tileInfo=new k(e.tileInfo),this.tileInfo.tileType=e.cacheType||"Map",n.tileInfo=this.tileInfo;var a=n.extent,s=this.tileInfo.origin,r=this.tileInfo.cols,o=this.tileInfo.rows;this.tileBoundary=this.tileInfo.lods.map((function(e){return{minCol:Math.floor((a.xmin-s.x+.1*e.resolution)/r/e.resolution),maxCol:Math.floor((a.xmax-s.x-.1*e.resolution)/r/e.resolution),minRow:Math.floor((s.y-a.ymax+.1*e.resolution)/o/e.resolution),maxRow:Math.floor((s.y-a.ymin-.1*e.resolution)/o/e.resolution)}}))}return n},_getColormap:function(e){var i=this.url+"/colormap",t=new n(g._dfdCanceller),a=this.serviceInfo.hasColormap||this.rasterInfo&&this.rasterInfo.hasColormap;return this.serviceInfo.currentVersion>10&&a?(t._pendingDfd=f({url:i,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then((function(e){t.callback(e.colormap)}),(function(e){t.errback(e)}))):t.callback(null),t},_getHistograms:function(e){var i=this.url+"/histograms",t=new n(g._dfdCanceller),a={f:"json"},s=this.serviceInfo.hasHistograms||this.rasterInfo&&this.rasterInfo.hasHistograms;return e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson()),s=!0),this.serviceInfo.currentVersion>10&&s?(t._pendingDfd=f({url:i,content:a,handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then((function(e){t.callback(e.histograms)}),(function(e){t.errback(e)}))):t.callback(null),t},_getRasterAttributeTable:function(e){var i=this.url+"/rasterAttributeTable",t=new n(g._dfdCanceller),a={f:"json"},s=this.serviceInfo.hasRasterAttributeTable;return e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson()),s=!0),this.serviceInfo.currentVersion>10&&s?(t._pendingDfd=f({url:i,content:a,handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then((function(e){t.callback(e)}),(function(e){t.errback(e)}))):t.callback(null),t},_getKeyProperties:function(e){var i=this.url+"/keyProperties",t=new n(g._dfdCanceller),a={f:"json"};return e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson())),this.serviceInfo.currentVersion>10?(t._pendingDfd=f({url:i,content:a,handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then((function(e){t.callback(e)}),(function(e){t.errback(e)}))):t.callback(null),t},_getMultidimensionalInfo:function(){var e=this.url+"/multidimensionalInfo",i=new n(g._dfdCanceller);return this.serviceInfo.currentVersion>=10.3&&this.serviceInfo.hasMultidimensions?(i._pendingDfd=f({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),i._pendingDfd.then(t.hitch(this,(function(e){i.callback(e.multidimensionalInfo)})),(function(e){i.errback(e)}))):i.callback(null),i},_getSlices:function(){var e=this.url+"/slices",i=new n(g._dfdCanceller);return this.serviceInfo.hasMultidimensions?(i._pendingDfd=f({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),i._pendingDfd.then(t.hitch(this,(function(e){i.callback(e.slices)})),(function(e){i.errback(e)}))):i.callback(null),i},_initializationFailed:function(){},_constructGetImageParams:function(){var e=this.imageServiceParams||{},i=t.mixin({},this._query,{f:"image",interpolation:e.interpolation,pixelType:e.pixelType,format:e.format||"lerc",compressionQuality:e.compressionQuality,bandIds:e.bandIds?e.bandIds.join(","):null,noData:null!=e.noData?e.noData.join(","):null,noDataInterpretation:e.noDataInterpretation,adjustAspectRatio:null==e.adjustAspectRatio?null:e.adjustAspectRatio,mosaicRule:e.mosaicRule?r.toJson(e.mosaicRule.toJson()):null,renderingRule:e.renderingRule?r.toJson(e.renderingRule.toJson()):null,token:this.credential&&this.credential.token||null});"lerc"===i.format.toLowerCase()?(i.compressionTolerance=e.compressionTolerance,this.serviceInfo.currentVersion>=10.5&&(i.lercVersion=e.lercVersion||2)):"tiff"===i.format.toLowerCase()?i.compression=e.compression:["jpg","jpeg","jpg","jpgpng"].indexOf(i.format.toLowerCase())>-1&&(i.compression=e.compression),this._commonReqParams=i},_getRasterIdentifier:function(e){if(this._rasterId)return this._rasterId;var i=this.url.replace("http:","").replace("https:",""),t=[],n=this.imageServiceParams||{};t.push(i),t.push(n.interpolation),t.push(n.pixelType),t.push(n.compressionQuality),t.push(n.bandIds?n.bandIds.join(","):""),t.push(n.mosaicRule?r.toJson(n.mosaicRule.toJson()):""),t.push(n.renderingRule?r.toJson(n.renderingRule.toJson()):"");var a=t.join("|");return this._rasterId=this._computeSignature(a),this._rasterId},_wrapExtent:function(e){var i,t=e.spatialReference._getInfo();if(t){var n=t.valid[0],a=t.valid[1];(e.xmin<n-this.resolution.x||e.xmax>a+this.resolution.y)&&(i=new h((e.xmin-n)%(a-n),e.ymin,(e.xmax-a)%(a-n),e.ymax,e.spatialReference)).xmax<i.xmin&&(i=null)}return i||e}});return o("extend-esri")&&t.setObject("layers.rasterLib.raster.ImageServiceRaster",j,u),j}));