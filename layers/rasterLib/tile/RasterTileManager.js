// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.34/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","../DeferredList2","../../../geometry/Extent","../../../SpatialReference","../../../geometry/Point","../../PixelBlock","./RasterTileInfo","../raster/rasterProjectionHelper"],(function(t,e,i,s,l,r,n,a,o,h,c){var f=t(null,{declaredClass:"esri.layers.rasterLib.tile.RasterTileManager",count:null,fullBoundary:null,tileBoundary:null,tiles:null,resolution:null,virtual:!0,prefetchBufferSize:0,_progressiveGlobal:!1,_MAX_TILES:128,_defaultMatrixResolution:20,constructor:function(t){this.tiles=[],this.xformSetting={},this.mapSpatialReference=t&&t.mapSR,this.layer=t&&t.layer,this.identifiers=this.layer.raster.rasterFunction?this.layer.raster.getMemberRasters().map((function(t){return t._rasterId})):[this.layer.raster._rasterId];var e=t&&t.tileInfo;e&&this.setTileInfo(e)},setTileInfo:function(t){this.tileInfo=t,this.virtual=t.virtual,this.mapResolution=null,this.tiles.length=0,this.xformSetting.requireProjection=!this.virtual&&!this.mapSpatialReference.equals(this.tileInfo.spatialReference),this.xformSetting.requirePE=c.requirePE(this.mapSpatialReference,this.tileInfo.spatialReference),this.xformSetting.meshSize=this.xformSetting.requireProjection?[this._defaultMatrixResolution,this._defaultMatrixResolution]:[1,1],this.halfWorldWidth=c.getHalfWorldWidth(t.spatialReference)},updateResolution:function(t,i){if(!(this.mapResolution&&t&&this._resolutionEqual(this.mapResolution.x,t.x)&&this._resolutionEqual(this.mapResolution.y,t.y))){this.tiles.forEach(e.hitch(this,(function(t){t.fetch&&!t.fetch.isCanceled()&&t.fetch.cancel(),t.update&&!t.update.isCanceled()&&t.update.cancel()}))),this.tiles.length=0;var s,l,r,n=this.xformSetting.requireProjection;this.mapResolution=this.resolution=t,n&&(this.resolution=c.projectResolution(t,this.tileInfo.spatialReference,this.layer.projectedFullExtent||i)),this._resolution=this.resolution;var o=this.resolution;if(!this.tileInfo.virtual){var h=.75*Math.min(o.x,o.y)+.25*Math.max(o.x,o.y);if(h>=this.tileInfo.lods[0].resolution)l=this.tileInfo.lods[0],this.ooe=!0;else if(h<=this.tileInfo.lods[this.tileInfo.lods.length-1].resolution)l=this.tileInfo.lods[this.tileInfo.lods.length-1],this.ooe=!1;else{for(s=0;s<this.tileInfo.lods.length-1;s++)if(l=this.tileInfo.lods[s],r=this.tileInfo.lods[s+1],l.resolution>=h&&r.resolution<=h){l.resolution-h>h-r.resolution&&(l=r);break}this.ooe=!1}this.level=l&&l.level,this.resolution=new a({x:l.resolution,y:l.resolution,spatialReference:this.tileInfo.spatialReference}),o=this.resolution}var f=this.layer.raster.rasterInfo.extent,u=this.tileInfo.origin,x=this.tileInfo.cols,d=this.tileInfo.rows,m=Math.floor((f.xmin-u.x)/o.x/x),p=Math.floor((f.xmax-u.x-o.x)/o.x/x),y=Math.floor((u.y-f.ymax)/o.y/d),g=Math.floor((u.y-f.ymin-o.y)/o.y/d);this.fullBoundary={rowStart:y,rowEnd:g,colStart:m,colEnd:p};var _=this.halfWorldWidth;if(_){var w=Math.ceil(_/o.x/(x/2)),B=Math.round(x-(_-u.x)/o.x%x);B===x&&(B=0),this.fullBoundary.colRange=w,this.fullBoundary.paddingRight=B;var v=w*x*o.x+u.x-_,E=u.x+_,k=Math.round((v-E)/o.x);this.fullBoundary.paddingLeft=k}this.hasNewData=!0}},getXformGrid:function(){var t,e=this.mapExtent,i=this.layer._hasTilingEffects?this.extent:this.fullExtent,s=this.layer.getCurrentResolution(),l=JSON.stringify(e.toJson())+JSON.stringify(i.toJson());return this._cachedExtentString&&this._cachedExtentString===l||(this._cachedExtentString=l,t=c.getProjectionOffsetGrid(e,i,s,null,this.halfWorldWidth),this._xformGrid=t),t=this._xformGrid,this.xformSetting.meshSize=t&&t.size,t},getWrapTimes:function(t){var e=c.getHalfWorldWidth(t.spatialReference);if(!e)return 0;var i=t.xmin,s=t.xmax,l=this.normalizeCoordinate(i,e),r=this.normalizeCoordinate(s,e),n=2*e,a=Math.round((i-l)/n);return Math.round((s-r)/n)-a},normalizeCoordinate:function(t,e){if(!e)return 0;var i=2*e;if(t>0){for(;t>e;)t-=i;return t}for(;t<-e;)t+=i;return t},updateExtent:function(t,i){this.mapExtent=this.extent=t;var s=this.xformSetting.requireProjection;if(s){if(this.extent=c.project(t,this.tileInfo.spatialReference),!this.extent)return;this.extent.spatialReference=new n(this.extent.spatialReference.toJson())}this.updateResolution(i,t);var l=this.extent,a=this.tileInfo,o=a.cols,h=a.rows;i=this.resolution;var f=l,x=s?this.layer.raster.rasterInfo.extent:this.layer.raster.projectedFullExtent;this.ooe&&(f=this._getIntersect(l,x));var d=f.xmin,m=f.xmax,p=Math.floor((d-a.origin.x)/i.x/o)-this.prefetchBufferSize,y=Math.floor((m-a.origin.x)/i.x/o)+this.prefetchBufferSize,g=null,_=this.getWrapTimes(t),w=this.fullBoundary&&this.fullBoundary.colRange;_&&this.halfWorldWidth&&(y===p&&(g=p),y+=_*w);var B=this.halfWorldWidth&&this.tiles.length&&(_!==this.wrapTimes||g!==this._circlularColId);B&&(this._wrapSwitchCount=this._wrapSwitchCount?this._wrapSwitchCount+1:1),this.wrapTimes=_,this._circlularColId=g;var v,E,k,S,P=Math.floor((a.origin.y-f.ymax)/i.y/h)-this.prefetchBufferSize,T=Math.floor((a.origin.y-f.ymin)/i.y/h)+this.prefetchBufferSize;this.tileBoundary={rowStart:P,rowEnd:T,colStart:p,colEnd:y};var C=(T-P+1)*(y-p+1)>this._MAX_TILES||!this.virtual&&this._resolution.x>8*this.tileInfo.lods[0].resolution;if((C||_>2||B)&&(this.tiles.forEach(e.hitch(this,(function(t){t.fetch&&!t.fetch.isCanceled()&&t.fetch.cancel(),t.update&&!t.update.isCanceled()&&t.update.cancel()}))),this.tiles.length=0),!(C||_>2)){var M,R,I,W,D=this.tiles,b=!1;for(v=D.length-1;v>=0;v--)M=D[v].row,R=D[v].col,D[v].wrapCol,_&&w&&(p<0||y-this.prefetchBufferSize>w)&&(R=R>y?_*w+R:R<p?_*w+R:R),(M<P||M>T||R<p||R>y)&&(D[v].fetch&&!D[v].fetch.isCanceled()&&D[v].fetch.cancel(),D[v].update&&!D[v].update.isCanceled()&&D[v].update.cancel(),D.splice(v,1),b=!0);for(v=P;v<=T;v++)for(E=p;E<=y;E++)k=new r(a.origin.x+i.x*o*E,a.origin.y-i.y*h*(v+1),a.origin.x+i.x*o*(E+1),a.origin.y-i.y*h*v,l.spatialReference),I=_&&w?E>=0?E%w:w- -E%w:E,S=u(D,(function(t){return t.row===v&&t.col===I&&t.wrapCol===E})),W=x.xmax>=k.xmax?o:Math.round((x.xmax-k.xmin)/i.x),-1===S&&(D.push({row:v,col:I,wrapCol:E,cellsizeX:i.x,cellsizeY:i.y,width:o,height:h,actualWidth:W,extent:k,normalizedExtent:this._wrapExtent(k,I),pixelBlock:null,virtual:this.virtual,level:this.level,tileType:this.tileInfo.tileType||"Raster"}),b=!0);b&&this._sortTiles();var z=this.tileInfo.cols*(this.tileBoundary.colEnd-this.tileBoundary.colStart+1),G=this.tileInfo.rows*(this.tileBoundary.rowEnd-this.tileBoundary.rowStart+1);this.width=z,this.height=G,this.count=D.length;var L=Math.min.apply(null,D.map((function(t){return t.extent.xmin}))),j=Math.max.apply(null,D.map((function(t){return t.extent.xmax}))),q=Math.min.apply(null,D.map((function(t){return t.extent.ymin}))),F=Math.max.apply(null,D.map((function(t){return t.extent.ymax})));this.fullExtent=new r(L,q,j,F,l.spatialReference);var V=this.fullExtent;(this.layer.roaming||this.layer.useWebGL)&&(this.layer._hasTilingEffects?(this.xformSetting.offset=[0,0],this.xformSetting.scale=[1,1]):(b&&(this._tilesChanged=!0),this.ooe,this.xformSetting.offset=[(l.xmin-V.xmin)/(V.xmax-V.xmin),-(V.ymin-l.ymin)/(V.ymax-V.ymin)],this.xformSetting.scale=[(l.xmax-l.xmin)/(V.xmax-V.xmin),(l.ymax-l.ymin)/(V.ymax-V.ymin)]))}},fetchTiles:function(t){(this._tilesChanged||t)&&this._fetchTiles(t)},_fetchTiles:function(t){this._fetchCounter=0;var s=this.extent;this.fetchAllCompleted=t?new i:null,(this._tilesChanged||t&&this.layer._hasTilingEffects)&&this.tiles.forEach(e.hitch(this,(function(t){t.updateCompleted=!1})));var l={};!this.layer.roaming&&this.layer._hasTilingEffects&&t?(this.identifiers.forEach(function(t,e){l[t]={extent:this.extent,pixelBlock:new o({width:this.layer._map.width,height:this.layer._map.height,pixels:[],pixelType:"",mask:null,statistics:[]})}}.bind(this)),this.originalPixelData={extent:this.extent,src:l,isEmpty:!0}):this._tilesChanged&&(this.identifiers.forEach(function(t,e){l[t]={extent:this.fullExtent,pixelBlock:new o({width:128,height:128,pixels:[],pixelType:"",mask:null,statistics:[]})}}.bind(this)),this.originalPixelData={extent:this.fullExtent,src:l,isEmpty:!0}),this.tiles.forEach(e.hitch(this,(function(e){if(e.fetch)e.update||(e.update=this.updateTile(e));else{if(this._isTileOutSide(e,s))return void(e.updateCompleted=!0);this._requestTile(e)}this.layer.roaming&&this.layer.useWebGL?this._fillPixelData(e):e.src&&t&&(this.layer._hasTilingEffects||this.layer.useWebGL)&&(this._fillPixelData(e),this.layer._hasTilingEffects&&(e.updateCompleted=!0),e.processedPixelBlock=null,e.renderedPixelBlock=null)}))),0===this._fetchCounter&&(this._fetched=!0),this._tilesChanged=!1,t&&this._updateFetchStatus()},updateTile:function(t,l){var r=new i;return t.src||t.fetch?(s(t.src||t._fetched||t.fetch,e.hitch(this,(function(){var i=this.layer.tileMode&&this.layer._rasterHandler&&!(this.layer._hasTilingEffects||this.layer.useWebGL),s=this.layer._drawTile,n=this._validateRawPixelBlocks(t);if(this.layer._hasTilingEffects&&!this.layer.useWebGL&&(s=s&&(this._progressiveGlobal||l)),(l||!l&&n)&&(i||s||this.layer.roaming)){if(this.xformSetting.requireProjection&&this.layer.useWebGL&&(this.xformSetting.gridConfig=this.getXformGrid(),null==this.xformSetting.gridConfig))return r.cancel(),r.promise;this._processTile(t,l).then(e.hitch(this,(function(t){r.isCanceled()||this._renderTile(t,l).then(e.hitch(this,(function(t){this.hasNewData=!1,r.isCanceled()||r.resolve(t)})))})))}else l||n||(t.updateCompleted=!0),this.layer.useWebGL||this.layer._hasTilingEffects?r.resolve(this.originalPixelData):r.resolve()}))),r.promise):(r.resolve(t),r.promise)},setLayer:function(t){this.layer=t},fillupTiles:function(){this.tiles.forEach(e.hitch(this,(function(t){t.update&&t.updateCompleted&&!t.filled&&(t.updateCompleted=!1,this._fillPixelData(t),t.updateCompleted=!0)})))},_validateRawPixelBlocks:function(t){return t&&t.src&&!this.identifiers.some((function(e){return!(t.src[e].pixelBlock&&0!==t.src[e].pixelBlock.validPixelCount&&t.src[e].pixelBlock.pixels&&t.src[e].pixelBlock.pixels.length>0)}))},_wrapExtent:function(t,e){if(t){var i;if(this.halfWorldWidth){i=new r(null!=e?{xmin:this.tileInfo.origin.x+this.tileInfo.cols*e*this.resolution.x,ymin:t.ymin,xmax:this.tileInfo.origin.x+this.tileInfo.cols*(e+1)*this.resolution.x,ymax:t.ymax,spatialReference:t.spatialReference}:{xmin:t.xmin,ymin:t.ymin,xmax:t.xmax,ymax:t.ymax,spatialReference:t.spatialReference});var s=this.normalizeCoordinate(i.xmin,this.halfWorldWidth),l=s-i.xmin;Math.abs(l)>.01&&(i.xmin=s,i.xmax+=l)}return i||t}},_getIntersect:function(t,e){var i=Math.max(t.xmin,e.xmin),s=Math.max(t.ymin,e.ymin),l=Math.min(t.xmax,e.xmax),n=Math.min(t.ymax,e.ymax);return new r(i,s,l,n,t.spatialReference)},_isTileOutSide:function(t,e){var i,s,l,r,n=!1;if(t.virtual){var a=t.normalizedExtent;(e=e||(this.xformSetting.requireProjection?this.layer.raster.rasterInfo.extent:this.layer.raster.projectedFullExtent))?(i=a.xmin-this.prefetchBufferSize*this.tileInfo.cols*this.resolution.x,s=a.ymin-this.prefetchBufferSize*this.tileInfo.rows*this.resolution.y,l=a.xmax+this.prefetchBufferSize*this.tileInfo.cols*this.resolution.x,r=a.ymax+this.prefetchBufferSize*this.tileInfo.rows*this.resolution.y,n=l<=e.xmin||i>=e.xmax||r<=e.ymin||s>=e.ymax):n=!1}else n=t.level<0||t.row<this.fullBoundary.rowStart||t.row>this.fullBoundary.rowEnd||t.col<this.fullBoundary.colStart||t.col>this.fullBoundary.colEnd;return n},_resolutionEqual:function(t,e){return t===e||!!(t&&e&&Math.abs(t-e)<Math.abs(e/1e4))},_requestTile:function(t){var r,n=this.identifiers;if(this._isTileOutSide(t)){var a=new i;t.updateCompleted=!0,a.resolve(null),r=a.promise}else r=this.layer.raster.rasterFunction?new l(this.layer.raster.getMemberRasters().map((function(e){return e.read(t)}))):new l([this.layer.raster.read(t)]);t.fetch=r,this._fetchCounter++,s(t.src||t._fetched||r,e.hitch(this,(function(e){if(e&&e.some((function(t){return t[0]}))){var i={};e.forEach((function(t,e){i[n[e]]=t[0]&&t[1]?{extent:t[1].extent,pixelBlock:t[1].pixelBlock,width:t[1].width,height:t[1].height}:null})),t.src=i}else t.src=null;this._fetchCounter--,0===this._fetchCounter&&(this._fetched=!0),t._fetched=!0,this._updateFetchStatus()})),e.hitch(this,(function(){this._fetchCounter--,0===this._fetchCounter&&(this._fetched=!0),t._fetched=!0,this._updateFetchStatus()}))),t.update=this.updateTile(t)},_updateFetchStatus:function(){this.layer._drawTile&&this.fetchAllCompleted&&!this.fetchAllCompleted.isResolved()&&(this.tiles.some((function(t){return!t._fetched}))||(this.tiles.forEach(e.hitch(this,(function(t){this._fillPixelData(t)}))),this.fetchAllCompleted.resolve()))},_fillPixelData:function(t,i){if(t&&!t.updateCompleted)if(Math.abs(t.cellsizeX-this.resolution.x)>t.cellsizeX/10)t.updateCompleted=!0;else if(!1!==this._validateRawPixelBlocks(t)){var s,l,r,n=t.extent;if(this.layer.roaming||this.layer.useWebGL&&!this.layer._hasTilingEffects?(s=this.fullExtent,l=this.tileInfo.cols*(this.tileBoundary.colEnd-this.tileBoundary.colStart+1),r=this.tileInfo.rows*(this.tileBoundary.rowEnd-this.tileBoundary.rowStart+1),i?this.originalPixelData.renderedPixelBlock||(this.originalPixelData.renderedPixelBlock=new o({width:l,height:r,pixels:[],pixelType:"",mask:null,statistics:[]})):this.identifiers.forEach(e.hitch(this,(function(t){this.originalPixelData.src[t].pixelBlock.width=l,this.originalPixelData.src[t].pixelBlock.height=r})))):(s=this.extent,l=this.layer._map.width,r=this.layer._map.height,i?this.originalPixelData.renderedPixelBlock||(this.originalPixelData.renderedPixelBlock=new o({width:l,height:r,pixels:[],pixelType:"",mask:null,statistics:[]})):this.identifiers.forEach(e.hitch(this,(function(t){this.originalPixelData.src[t].pixelBlock.width=l,this.originalPixelData.src[t].pixelBlock.height=r})))),s.xmax<=n.xmin||s.xmin>=n.xmax||s.ymax<=n.ymin||s.ymin>=n.ymax)return null;this.originalPixelData.isEmpty=!1;var a=!1;this.identifiers.forEach(e.hitch(this,(function(e){t.src&&(this._fillPixelBlock(t.src[e],this.originalPixelData.src[e],{extent:s,width:l,height:r,normalizedExtent:t.normalizedExtent},!1),a=!0)}))),t.filled=a,this.hasNewData=!0}else t.updateCompleted=!0},_fillPixelBlock:function(t,e,i,s){var l=t.extent,r=i.extent,n=i.width,a=i.height;if(t.pixelBlock&&t.pixelBlock.pixels&&t.pixelBlock.pixels[0]){var o,h,c=(l.xmax-l.xmin)/t.width,f=Math.max(l.xmin,r.xmin),u=Math.min(l.xmax,r.xmax),x=Math.max(l.ymin,r.ymin),d=Math.min(l.ymax,r.ymax),m=Math.round((f-l.xmin)/c),p=t.width-Math.round(Math.abs(l.xmax-u)/c),y=Math.round(Math.abs(l.ymax-d)/c),g=t.height-Math.round((x-l.ymin)/c),_=this.halfWorldWidth,w=Math.round((f-r.xmin)/c),B=i.normalizedExtent;if(!(this.wrapTimes&&_&&l.xmin<-_)){this.wrapTimes&&_&&(l.xmin>_?(w-=this.fullBoundary.paddingLeft,o=this.normalizeCoordinate(l.xmin,_),h=this.normalizeCoordinate(l.xmax,_)):(o=l.xmin,h=l.xmax),B&&B.xmin<_&&B.xmax>_?p-=this.fullBoundary.paddingRight:o<_&&h>_&&(p-=this.fullBoundary.paddingRight));var v,E,k,S,P,T=Math.round(Math.abs(r.ymax-d)/c),C=t.pixelBlock.pixels.length,M=e.pixelBlock,R=t.width,I=M.mask||new Uint8Array(n*a),W=t.pixelBlock,D=W.mask,b=0;for(k=0;k<C;k++){for(S=W.pixels[k],P=M.pixels[k]||new S.constructor(n*a),v=y;v<g;v++)for(b=(T+v-y)*n+w,E=m;E<p;E++)P[b+E-m]=S[v*R+E];M.pixels[k]=P}if(D)for(v=y;v<g;v++)for(b=(T+v-y)*n+w,E=m;E<p;E++)I[b+E-m]=D[v*R+E];else for(v=y;v<g;v++)for(b=(T+v-y)*n+w,E=m;E<p;E++)I[b+E-m]=1;if(M.pixelType=M.pixelType||W.pixelType,M.mask=I,M.statistics&&M.statistics.length>0){if(W.statistics&&M.statistics)for(v=0;v<M.statistics.length;v++)M.statistics[v].minValue=Math.min(W.statistics[v].minValue,M.statistics[v].minValue),M.statistics[v].maxValue=Math.max(W.statistics[v].maxValue,M.statistics[v].maxValue)}else for(M.statistics=[],v=0;v<W.statistics.length;v++)M.statistics[v]={minValue:W.statistics[v].minValue,maxValue:W.statistics[v].maxValue}}}},_processTile:function(t,e){var s,l,r=new i,n=this.layer._hasTilingEffects,a=this.layer.useWebGL,o=n||a,h=this.layer.raster.rasterFunction&&t&&(n||a||!t.processedPixelBlock);if(e?s=t:(this._fillPixelData(t),s=o?this.originalPixelData:t),this.xformSetting.hasNewTexture=this.hasNewData,h)if(this.identifiers.forEach((function(t){0!==s.src[t].pixelBlock.pixels.length&&0!==s.src[t].pixelBlock.pixels[0].length||(l=!0)})),l)r.resolve({extent:s.extent,processedPixelBlock:s.src[this.identifiers[0]],pixelBlock:s.src[this.identifiers[0]]});else if(a)this.processedPixelData=this.layer.raster.rasterFunction.read(s),r.resolve(this.processedPixelData);else if(this.layer._rasterHandler)this.layer._rasterHandler.process({extent:s.extent,src:s.src}).then((function(e){n?(this.processedPixelData=e,r.resolve(this.processedPixelData)):(t.processedPixelBlock=e.pixelBlock,r.resolve(t))}));else{var c=this.layer.raster.rasterFunction.read(t);t.processedPixelBlock=c.pixelBlock,r.resolve(t)}else o?r.resolve(s.src[this.identifiers[0]]):(t.pixelBlock=s.src[this.identifiers[0]]&&s.src[this.identifiers[0]].pixelBlock,r.resolve(t));return r.promise},_renderTile:function(t){var e,s=new i,l=this.layer._hasTilingEffects,r=this.layer.useWebGL,n=Math.abs((t.extent.xmax-t.extent.xmin)/t.width-this.layer.getCurrentResolution().x)>this.resolution.x/10,a=this.layer.useWebGL&&(n||this._isTileOutSide(t,this.layer._map.extent));return this.xformSetting.hasNewTexture=this.hasNewData,this.layer._rasterRenderer&&t&&(t.texture||t.src||t.pixelBlock||t.processedPixelBlock)?(e=t,this.layer._rasterRenderer.interpolation=this.layer.interpolation,r&&!a?(this.layer.raster.rasterFunction&&this.layer.raster.rasterFunction.renderTexture||this.layer._rasterRenderer.draw(e),s.resolve(t)):this.layer._rasterHandler?this.layer._rasterHandler.render({extent:e.extent,pixelBlock:e.processedPixelBlock||e.pixelBlock}).then(function(e){l?(e.renderedPixelBlock=e.pixelBlock,s.resolve(e)):(t.renderedPixelBlock=e.pixelBlock,s.resolve(t))}.bind(this)):(t.renderedPixelBlock=this.layer._rasterRenderer.draw(t).pixelBlock,s.resolve(t))):(t.renderedPixelBlock=t.processedPixelBlock||t.pixelBlock,s.resolve(t)),s.promise},_sortTiles:function(){this.tiles.sort((function(t,e){return t.row<e.row||t.row==e.row&&t.col<e.col?-1:1}))}}),u=function(t,e){var i;for(i=0;i<t.length;i++)if(e(t[i]))return i;return-1};return f}));