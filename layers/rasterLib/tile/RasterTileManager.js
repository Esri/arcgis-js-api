// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.36/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","../DeferredList2","../../../geometry/Extent","../../../SpatialReference","../../../geometry/Point","../../PixelBlock","./RasterTileInfo","../raster/rasterProjectionHelper"],(function(t,e,i,s,l,r,a,n,o,h,f){var c=t(null,{declaredClass:"esri.layers.rasterLib.tile.RasterTileManager",count:null,fullBoundary:null,tileBoundary:null,tiles:null,resolution:null,virtual:!0,prefetchBufferSize:0,_progressiveGlobal:!1,_MAX_TILES:128,_defaultMatrixResolution:20,constructor:function(t){this.tiles=[],this.xformSetting={},this.mapSpatialReference=t&&t.mapSR,this.layer=t&&t.layer,this.identifiers=this.layer.raster.rasterFunction?this.layer.raster.getMemberRasters().map((function(t){return t._rasterId})):[this.layer.raster._rasterId];var e=t&&t.tileInfo;e&&this.setTileInfo(e)},setTileInfo:function(t){this.tileInfo=t,this.virtual=t.virtual,this.mapResolution=null,this.tiles.length=0,this.xformSetting.requireProjection=!this.virtual&&!this.mapSpatialReference.equals(this.tileInfo.spatialReference),this.xformSetting.requirePE=f.requirePE(this.mapSpatialReference,this.tileInfo.spatialReference),this.xformSetting.meshSize=this.xformSetting.requireProjection?[this._defaultMatrixResolution,this._defaultMatrixResolution]:[1,1],this.halfWorldWidth=f.getHalfWorldWidth(t.spatialReference)},updateResolution:function(t,i){if(!(this.mapResolution&&t&&this._resolutionEqual(this.mapResolution.x,t.x)&&this._resolutionEqual(this.mapResolution.y,t.y))){this.tiles.forEach(e.hitch(this,(function(t){t.fetch&&!t.fetch.isCanceled()&&t.fetch.cancel(),t.update&&!t.update.isCanceled()&&t.update.cancel()}))),this.tiles.length=0;var s,l,r,a=this.xformSetting.requireProjection;this.mapResolution=this.resolution=t,a&&(this.resolution=f.projectResolution(t,this.tileInfo.spatialReference,this.layer.projectedFullExtent||i)),this._resolution=this.resolution;var o=this.resolution;if(!this.tileInfo.virtual){var h=.75*Math.min(o.x,o.y)+.25*Math.max(o.x,o.y);if(h>=this.tileInfo.lods[0].resolution)l=this.tileInfo.lods[0],this.ooe=!0;else if(h<=this.tileInfo.lods[this.tileInfo.lods.length-1].resolution)l=this.tileInfo.lods[this.tileInfo.lods.length-1],this.ooe=!1;else{for(s=0;s<this.tileInfo.lods.length-1;s++)if(l=this.tileInfo.lods[s],r=this.tileInfo.lods[s+1],l.resolution>=h&&r.resolution<=h){l.resolution-h>h-r.resolution&&(l=r);break}this.ooe=!1}this.level=l&&l.level,this.resolution=new n({x:l.resolution,y:l.resolution,spatialReference:this.tileInfo.spatialReference}),o=this.resolution}var c=this.layer.raster.rasterInfo.extent,x=this.tileInfo.origin,u=this.tileInfo.cols,d=this.tileInfo.rows,m=Math.floor((c.xmin-x.x)/o.x/u),p=Math.floor((c.xmax-x.x-o.x)/o.x/u),y=Math.floor((x.y-c.ymax)/o.y/d),g=Math.floor((x.y-c.ymin-o.y)/o.y/d);this.fullBoundary={rowStart:y,rowEnd:g,colStart:m,colEnd:p};var _=this.halfWorldWidth;if(_){var w=Math.ceil(_/o.x/(u/2)),B=this.tileInfo.applyGCS360Transform?360:_,v=Math.round(u-(B-x.x)/o.x%u);v===u&&(v=0),this.fullBoundary.colRange=w,this.fullBoundary.paddingRight=v;var S=w*u*o.x+x.x-B,T=this.tileInfo.applyGCS360Transform?0:x.x+_,E=Math.round((S-T)/o.x);this.fullBoundary.paddingLeft=E}this.hasNewData=!0}},getXformGrid:function(){var t,e=this.mapExtent,i=this.layer._hasTilingEffects?this.extent:this.fullExtent,s=this.layer.getCurrentResolution(),l=JSON.stringify(e.toJson())+JSON.stringify(i.toJson());return this._datumTransformationInitialized||(this._datumTransformationInitialized=!0,this._datumTransformation=f.getDefaultDatumTransformationForDataset(this.layer.raster.rasterInfo.extent,e.spatialReference,!0)),this._cachedExtentString&&this._cachedExtentString===l||(this._cachedExtentString=l,t=f.getProjectionOffsetGrid(e,i,s,this.tileInfo.applyGCS360Transform,this.halfWorldWidth,this._datumTransformation),this._xformGrid=t),t=this._xformGrid,this.xformSetting.meshSize=t&&t.size,t},getWrapTimes:function(t){var e=f.getHalfWorldWidth(t.spatialReference);if(!e)return 0;var i=t.xmin,s=t.xmax,l=2*e,r=this.tileInfo.applyGCS360Transform?0:-e;return Math.floor((s-r)/l)-Math.floor((i-r)/l)},normalizeCoordinate:function(t,e){if(!e)return 0;var i=2*e;if(t>0){for(;t>e;)t-=i;return t}for(;t<-e;)t+=i;return t},updateExtent:function(t,i){this.mapExtent=this.extent=t;var s=this.xformSetting.requireProjection;if(s){if(this.extent=f.project(t,this.tileInfo.spatialReference,this.tileInfo.applyGCS360Transform),!this.extent)return;this.extent.spatialReference=new a(this.extent.spatialReference.toJson())}this.updateResolution(i,t);var l=this.extent,n=this.tileInfo,o=n.cols,h=n.rows;i=this.resolution;var c=l,u=s?this.layer.raster.rasterInfo.extent:this.layer.raster.projectedFullExtent;this.ooe&&(c=this._getIntersect(l,u));var d=c.xmin,m=c.xmax,p=Math.floor((d-n.origin.x)/i.x/o)-this.prefetchBufferSize,y=Math.floor((m-n.origin.x)/i.x/o)+this.prefetchBufferSize,g=null,_=this.getWrapTimes(t),w=this.fullBoundary&&this.fullBoundary.colRange;_&&this.halfWorldWidth&&(y===p&&(g=p),y+=_*w);var B=this.halfWorldWidth&&this.tiles.length&&(_!==this.wrapTimes||g!==this._circlularColId);B&&(this._wrapSwitchCount=this._wrapSwitchCount?this._wrapSwitchCount+1:1),this.wrapTimes=_,this._circlularColId=g;var v,S,T,E,k=Math.floor((n.origin.y-c.ymax)/i.y/h)-this.prefetchBufferSize,C=Math.floor((n.origin.y-c.ymin)/i.y/h)+this.prefetchBufferSize;this.tileBoundary={rowStart:k,rowEnd:C,colStart:p,colEnd:y};var I=(C-k+1)*(y-p+1)>this._MAX_TILES||!this.virtual&&this._resolution.x>8*this.tileInfo.lods[0].resolution;if((I||_>2||B)&&(this.tiles.forEach(e.hitch(this,(function(t){t.fetch&&!t.fetch.isCanceled()&&t.fetch.cancel(),t.update&&!t.update.isCanceled()&&t.update.cancel()}))),this.tiles.length=0),!(I||_>2)){var P,R,M,D,W=this.tiles,b=!1;for(v=W.length-1;v>=0;v--)P=W[v].row,W[v].col,R=W[v].wrapCol,(P<k||P>C||R<p||R>y)&&(W[v].fetch&&!W[v].fetch.isCanceled()&&W[v].fetch.cancel(),W[v].update&&!W[v].update.isCanceled()&&W[v].update.cancel(),W.splice(v,1),b=!0);for(v=k;v<=C;v++)for(S=p;S<=y;S++)T=new r(n.origin.x+i.x*o*S,n.origin.y-i.y*h*(v+1),n.origin.x+i.x*o*(S+1),n.origin.y-i.y*h*v,l.spatialReference),M=_&&w?S>=0?S%w:w- -S%w:S,E=x(W,(function(t){return t.row===v&&t.col===M&&t.wrapCol===S})),D=u.xmax>=T.xmax?o:Math.round((u.xmax-T.xmin)/i.x),-1===E&&(W.push({row:v,col:M,wrapCol:S,cellsizeX:i.x,cellsizeY:i.y,width:o,height:h,actualWidth:D,extent:T,normalizedExtent:this._wrapExtent(T,M),pixelBlock:null,virtual:this.virtual,level:this.level,tileType:this.tileInfo.tileType||"Raster"}),b=!0);b&&this._sortTiles();var z=this.tileInfo.cols*(this.tileBoundary.colEnd-this.tileBoundary.colStart+1),G=this.tileInfo.rows*(this.tileBoundary.rowEnd-this.tileBoundary.rowStart+1);this.width=z,this.height=G,this.count=W.length;var L=Math.min.apply(null,W.map((function(t){return t.extent.xmin}))),j=Math.max.apply(null,W.map((function(t){return t.extent.xmax}))),F=Math.min.apply(null,W.map((function(t){return t.extent.ymin}))),q=Math.max.apply(null,W.map((function(t){return t.extent.ymax})));this.fullExtent=new r(L,F,j,q,l.spatialReference);var V=this.fullExtent;(this.layer.roaming||this.layer.useWebGL)&&(this.layer._hasTilingEffects?(this.xformSetting.offset=[0,0],this.xformSetting.scale=[1,1]):(b&&(this._tilesChanged=!0),this.ooe,this.xformSetting.offset=[(l.xmin-V.xmin)/(V.xmax-V.xmin),-(V.ymin-l.ymin)/(V.ymax-V.ymin)],this.xformSetting.scale=[(l.xmax-l.xmin)/(V.xmax-V.xmin),(l.ymax-l.ymin)/(V.ymax-V.ymin)]))}},fetchTiles:function(t){(this._tilesChanged||t)&&this._fetchTiles(t)},_fetchTiles:function(t){this._fetchCounter=0;var s=this.extent;this.fetchAllCompleted=t?new i:null,(this._tilesChanged||t&&this.layer._hasTilingEffects)&&this.tiles.forEach(e.hitch(this,(function(t){t.updateCompleted=!1})));var l={};!this.layer.roaming&&this.layer._hasTilingEffects&&t?(this.identifiers.forEach(function(t,e){l[t]={extent:this.extent,pixelBlock:new o({width:this.layer._map.width,height:this.layer._map.height,pixels:[],pixelType:"",mask:null,statistics:[]})}}.bind(this)),this.originalPixelData={extent:this.extent,src:l,isEmpty:!0}):this._tilesChanged&&(this.identifiers.forEach(function(t,e){l[t]={extent:this.fullExtent,pixelBlock:new o({width:128,height:128,pixels:[],pixelType:"",mask:null,statistics:[]})}}.bind(this)),this.originalPixelData={extent:this.fullExtent,src:l,isEmpty:!0}),this.tiles.forEach(e.hitch(this,(function(e){if(e.fetch)e.update||(e.update=this.updateTile(e));else{if(this._isTileOutSide(e,s))return void(e.updateCompleted=!0);this._requestTile(e)}this.layer.roaming&&this.layer.useWebGL?this._fillPixelData(e):e.src&&t&&(this.layer._hasTilingEffects||this.layer.useWebGL)&&(this._fillPixelData(e),this.layer._hasTilingEffects&&(e.updateCompleted=!0),e.processedPixelBlock=null,e.renderedPixelBlock=null)}))),0===this._fetchCounter&&(this._fetched=!0),this._tilesChanged=!1,t&&this._updateFetchStatus()},updateTile:function(t,l){var r=new i;return t.src||t.fetch?(s(t.src||t._fetched||t.fetch,e.hitch(this,(function(){var i=this.layer.tileMode&&this.layer._rasterHandler&&!(this.layer._hasTilingEffects||this.layer.useWebGL),s=this.layer._drawTile,a=this._validateRawPixelBlocks(t);if(this.layer._hasTilingEffects&&!this.layer.useWebGL&&(s=s&&(this._progressiveGlobal||l)),(l||!l&&a)&&(i||s||this.layer.roaming)){if(this.xformSetting.requireProjection&&this.layer.useWebGL&&(this.xformSetting.gridConfig=this.getXformGrid(),null==this.xformSetting.gridConfig))return r.cancel(),r.promise;this._processTile(t,l).then(e.hitch(this,(function(t){r.isCanceled()||this._renderTile(t,l).then(e.hitch(this,(function(t){this.hasNewData=!1,r.isCanceled()||r.resolve(t)})))})))}else l||a||(t.updateCompleted=!0),this.layer.useWebGL||this.layer._hasTilingEffects?r.resolve(this.originalPixelData):r.resolve()}))),r.promise):(r.resolve(t),r.promise)},setLayer:function(t){this.layer=t},fillupTiles:function(){this.tiles.forEach(e.hitch(this,(function(t){t.update&&t.updateCompleted&&!t.filled&&(t.updateCompleted=!1,this._fillPixelData(t),t.updateCompleted=!0)})))},_validateRawPixelBlocks:function(t){return t&&t.src&&!this.identifiers.some((function(e){return!(t.src[e].pixelBlock&&0!==t.src[e].pixelBlock.validPixelCount&&t.src[e].pixelBlock.pixels&&t.src[e].pixelBlock.pixels.length>0)}))},_wrapExtent:function(t,e){if(t){if(this.tileInfo.applyGCS360Transform){var i=this.normalizeCoordinate(t.xmin,180);return i<0&&(i+=360),new r({xmin:i,ymin:t.ymin,xmax:t.xmax-t.xmin+i,ymax:t.ymax,spatialReference:t.spatialReference})}var s;if(this.halfWorldWidth){s=new r(null!=e?{xmin:this.tileInfo.origin.x+this.tileInfo.cols*e*this.resolution.x,ymin:t.ymin,xmax:this.tileInfo.origin.x+this.tileInfo.cols*(e+1)*this.resolution.x,ymax:t.ymax,spatialReference:t.spatialReference}:{xmin:t.xmin,ymin:t.ymin,xmax:t.xmax,ymax:t.ymax,spatialReference:t.spatialReference});var l=this.normalizeCoordinate(s.xmin,this.halfWorldWidth),a=l-s.xmin;Math.abs(a)>.01&&(s.xmin=l,s.xmax+=a)}return s||t}},_getIntersect:function(t,e){var i=Math.max(t.xmin,e.xmin),s=Math.max(t.ymin,e.ymin),l=Math.min(t.xmax,e.xmax),a=Math.min(t.ymax,e.ymax);return new r(i,s,l,a,t.spatialReference)},_isTileOutSide:function(t,e){var i,s,l,r,a=!1;if(t.virtual){var n=t.normalizedExtent;(e=e||(this.xformSetting.requireProjection?this.layer.raster.rasterInfo.extent:this.layer.raster.projectedFullExtent))?(i=n.xmin-this.prefetchBufferSize*this.tileInfo.cols*this.resolution.x,s=n.ymin-this.prefetchBufferSize*this.tileInfo.rows*this.resolution.y,l=n.xmax+this.prefetchBufferSize*this.tileInfo.cols*this.resolution.x,r=n.ymax+this.prefetchBufferSize*this.tileInfo.rows*this.resolution.y,a=l<=e.xmin||i>=e.xmax||r<=e.ymin||s>=e.ymax):a=!1}else a=t.level<0||t.row<this.fullBoundary.rowStart||t.row>this.fullBoundary.rowEnd||t.col<this.fullBoundary.colStart||t.col>this.fullBoundary.colEnd;return a},_resolutionEqual:function(t,e){return t===e||!!(t&&e&&Math.abs(t-e)<Math.abs(e/1e4))},_requestTile:function(t){var r,a=this.identifiers;if(this._isTileOutSide(t)){var n=new i;t.updateCompleted=!0,n.resolve(null),r=n.promise}else r=this.layer.raster.rasterFunction?new l(this.layer.raster.getMemberRasters().map((function(e){return e.read(t)}))):new l([this.layer.raster.read(t)]);t.fetch=r,this._fetchCounter++,s(t.src||t._fetched||r,e.hitch(this,(function(e){if(e&&e.some((function(t){return t[0]}))){var i={};e.forEach((function(t,e){i[a[e]]=t[0]&&t[1]?{extent:t[1].extent,pixelBlock:t[1].pixelBlock,width:t[1].width,height:t[1].height}:null})),t.src=i}else t.src=null;this._fetchCounter--,0===this._fetchCounter&&(this._fetched=!0),t._fetched=!0,this._updateFetchStatus()})),e.hitch(this,(function(){this._fetchCounter--,0===this._fetchCounter&&(this._fetched=!0),t._fetched=!0,this._updateFetchStatus()}))),t.update=this.updateTile(t)},_updateFetchStatus:function(){this.layer._drawTile&&this.fetchAllCompleted&&!this.fetchAllCompleted.isResolved()&&(this.tiles.some((function(t){return!t._fetched}))||(this.tiles.forEach(e.hitch(this,(function(t){this._fillPixelData(t)}))),this.fetchAllCompleted.resolve()))},_fillPixelData:function(t,i){if(t&&!t.updateCompleted)if(Math.abs(t.cellsizeX-this.resolution.x)>t.cellsizeX/10)t.updateCompleted=!0;else if(!1!==this._validateRawPixelBlocks(t)){var s,l,r,a=t.extent;if(this.layer.roaming||this.layer.useWebGL&&!this.layer._hasTilingEffects?(s=this.fullExtent,l=this.tileInfo.cols*(this.tileBoundary.colEnd-this.tileBoundary.colStart+1),r=this.tileInfo.rows*(this.tileBoundary.rowEnd-this.tileBoundary.rowStart+1),i?this.originalPixelData.renderedPixelBlock||(this.originalPixelData.renderedPixelBlock=new o({width:l,height:r,pixels:[],pixelType:"",mask:null,statistics:[]})):this.identifiers.forEach(e.hitch(this,(function(t){this.originalPixelData.src[t].pixelBlock.width=l,this.originalPixelData.src[t].pixelBlock.height=r})))):(s=this.extent,l=this.layer._map.width,r=this.layer._map.height,i?this.originalPixelData.renderedPixelBlock||(this.originalPixelData.renderedPixelBlock=new o({width:l,height:r,pixels:[],pixelType:"",mask:null,statistics:[]})):this.identifiers.forEach(e.hitch(this,(function(t){this.originalPixelData.src[t].pixelBlock.width=l,this.originalPixelData.src[t].pixelBlock.height=r})))),s.xmax<=a.xmin||s.xmin>=a.xmax||s.ymax<=a.ymin||s.ymin>=a.ymax)return null;this.originalPixelData.isEmpty=!1;var n=!1;this.identifiers.forEach(e.hitch(this,(function(e){t.src&&(this._fillPixelBlock(t.src[e],this.originalPixelData.src[e],{extent:s,width:l,height:r,normalizedExtent:t.normalizedExtent},!1),n=!0)}))),t.filled=n,this.hasNewData=!0}else t.updateCompleted=!0},_fillPixelBlock:function(t,e,i,s){var l=t.extent,r=i.extent,a=i.width,n=i.height;if(t.pixelBlock&&t.pixelBlock.pixels&&t.pixelBlock.pixels[0]){var o,h,f=(l.xmax-l.xmin)/t.width,c=Math.max(l.xmin,r.xmin),x=Math.min(l.xmax,r.xmax),u=Math.max(l.ymin,r.ymin),d=Math.min(l.ymax,r.ymax),m=Math.round((c-l.xmin)/f),p=t.width-Math.round(Math.abs(l.xmax-x)/f),y=Math.round(Math.abs(l.ymax-d)/f),g=t.height-Math.round((u-l.ymin)/f),_=this.halfWorldWidth,w=Math.round((c-r.xmin)/f),B=i.normalizedExtent;if(!(this.wrapTimes&&_&&l.xmin<-_)){this.wrapTimes&&_&&(this.tileInfo.applyGCS360Transform?l.xmin>360&&(w-=this.fullBoundary.paddingLeft):l.xmin>_?(w-=this.fullBoundary.paddingLeft,o=this.normalizeCoordinate(l.xmin,_),h=this.normalizeCoordinate(l.xmax,_)):(o=l.xmin,h=l.xmax),this.tileInfo.applyGCS360Transform?B&&B.xmin<360&&B.xmax>360&&(p-=this.fullBoundary.paddingRight):B&&B.xmin<_&&B.xmax>_?p-=this.fullBoundary.paddingRight:o<_&&h>_&&(p-=this.fullBoundary.paddingRight));var v,S,T,E,k,C=Math.round(Math.abs(r.ymax-d)/f),I=t.pixelBlock.pixels.length,P=e.pixelBlock,R=t.width,M=P.mask||new Uint8Array(a*n),D=t.pixelBlock,W=D.mask,b=0;for(T=0;T<I;T++){for(E=D.pixels[T],k=P.pixels[T]||new E.constructor(a*n),v=y;v<g;v++)for(b=(C+v-y)*a+w,S=m;S<p;S++)k[b+S-m]=E[v*R+S];P.pixels[T]=k}if(W)for(v=y;v<g;v++)for(b=(C+v-y)*a+w,S=m;S<p;S++)M[b+S-m]=W[v*R+S];else for(v=y;v<g;v++)for(b=(C+v-y)*a+w,S=m;S<p;S++)M[b+S-m]=1;if(P.pixelType=P.pixelType||D.pixelType,P.mask=M,P.statistics&&P.statistics.length>0){if(D.statistics&&P.statistics)for(v=0;v<P.statistics.length;v++)P.statistics[v].minValue=Math.min(D.statistics[v].minValue,P.statistics[v].minValue),P.statistics[v].maxValue=Math.max(D.statistics[v].maxValue,P.statistics[v].maxValue)}else for(P.statistics=[],v=0;v<D.statistics.length;v++)P.statistics[v]={minValue:D.statistics[v].minValue,maxValue:D.statistics[v].maxValue}}}},_processTile:function(t,e){var s,l,r=new i,a=this.layer._hasTilingEffects,n=this.layer.useWebGL,o=a||n,h=this.layer.raster.rasterFunction&&t&&(a||n||!t.processedPixelBlock);if(e?s=t:(this._fillPixelData(t),s=o?this.originalPixelData:t),this.xformSetting.hasNewTexture=this.hasNewData,h)if(this.identifiers.forEach((function(t){0!==s.src[t].pixelBlock.pixels.length&&0!==s.src[t].pixelBlock.pixels[0].length||(l=!0)})),l)r.resolve({extent:s.extent,processedPixelBlock:s.src[this.identifiers[0]],pixelBlock:s.src[this.identifiers[0]]});else if(n)this.processedPixelData=this.layer.raster.rasterFunction.read(s),r.resolve(this.processedPixelData);else if(this.layer._rasterHandler)this.layer._rasterHandler.process({extent:s.extent,src:s.src}).then((function(e){a?(this.processedPixelData=e,r.resolve(this.processedPixelData)):(t.processedPixelBlock=e.pixelBlock,r.resolve(t))}));else{var f=this.layer.raster.rasterFunction.read(t);t.processedPixelBlock=f.pixelBlock,r.resolve(t)}else o?r.resolve(s.src[this.identifiers[0]]):(t.pixelBlock=s.src[this.identifiers[0]]&&s.src[this.identifiers[0]].pixelBlock,r.resolve(t));return r.promise},_renderTile:function(t){var e,s=new i,l=this.layer._hasTilingEffects,r=this.layer.useWebGL,a=Math.abs((t.extent.xmax-t.extent.xmin)/t.width-this.layer.getCurrentResolution().x)>this.resolution.x/10,n=this.layer.useWebGL&&(a||this._isTileOutSide(t,this.layer._map.extent));return this.xformSetting.hasNewTexture=this.hasNewData,this.layer._rasterRenderer&&t&&(t.texture||t.src||t.pixelBlock||t.processedPixelBlock)?(e=t,this.layer._rasterRenderer.interpolation=this.layer.interpolation,r&&!n?(this.layer.raster.rasterFunction&&this.layer.raster.rasterFunction.renderTexture||this.layer._rasterRenderer.draw(e),s.resolve(t)):this.layer._rasterHandler?this.layer._rasterHandler.render({extent:e.extent,pixelBlock:e.processedPixelBlock||e.pixelBlock}).then(function(e){l?(e.renderedPixelBlock=e.pixelBlock,s.resolve(e)):(t.renderedPixelBlock=e.pixelBlock,s.resolve(t))}.bind(this)):(t.renderedPixelBlock=this.layer._rasterRenderer.draw(t).pixelBlock,s.resolve(t))):(t.renderedPixelBlock=t.processedPixelBlock||t.pixelBlock,s.resolve(t)),s.promise},_sortTiles:function(){this.tiles.sort((function(t,e){return t.row<e.row||t.row==e.row&&t.col<e.col?-1:1}))}}),x=function(t,e){var i;for(i=0;i<t.length;i++)if(e(t[i]))return i;return-1};return c}));