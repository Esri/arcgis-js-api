/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/global","../core/has","../core/maybe","../core/Logger","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/property","../core/jsonMap","../core/accessorSupport/decorators/reader","../core/accessorSupport/extensions/serializableProperty/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/Error","../core/urlUtils","../core/uuid","../portal/support/resourceExtension","../core/promiseUtils","../geometry/SpatialReference","../geometry/Extent","../geometry","./support/fieldUtils","../PopupTemplate","../request","../chunks/symbols","./Layer","../core/MultiOriginJSONSupport","../symbols/support/ElevationInfo","./support/commonProperties","./mixins/OperationalLayer","../renderers/Renderer","../renderers/ClassBreaksRenderer","../renderers/UniqueValueRenderer","../renderers/DictionaryRenderer","../renderers/DotDensityRenderer","../renderers/HeatmapRenderer","../renderers/SimpleRenderer","../renderers/support/types","../renderers/support/jsonUtils","./support/Field","./support/FieldsIndex","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/LabelClass","./support/featureReductionUtils","./support/labelingInfo","../renderers/support/styleUtils","../support/popupUtils","../tasks/support/Query","./support/PurgeOptions"],(function(e,r,t,o,i,n,p,a,s,l,d,c,y,u,f,m,g,_,b,h,S,w,v,I,R,T,x,F,L,O,P,D,k,j,E,U,G,N,J,A,M,W,q,z,V,B,C,H,Q,K,X,Y,Z,$){"use strict";const ee=n.getLogger("esri.layers.StreamLayer"),re=new s.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"});let te=function(r){function o(...e){var t;return(t=r.call(this,...e)||this).copyright=null,t.definitionExpression=null,t.displayField=null,t.elevationInfo=null,t.featureReduction=null,t.fields=null,t.geometryDefinition=null,t.geometryType=null,t.labelsVisible=!0,t.labelingInfo=null,t.legendEnabled=!0,t.maxReconnectionAttempts=0,t.maxReconnectionInterval=20,t.objectIdField=null,t.operationalLayerType="ArcGISStreamLayer",t.popupEnabled=!0,t.popupTemplate=null,t.purgeOptions=new $,t.screenSizePerspectiveEnabled=!0,t.sourceJSON=null,t.spatialReference=b.WGS84,t.type="stream",t.url=null,t.updateInterval=300,t.webSocketUrl=null,t}e._inheritsLoose(o,r);var n=o.prototype;return n.normalizeCtorArgs=function(e,r){return"string"==typeof e?{url:e,...r}:e},n.load=function(e){"WebSocket"in t||_.reject(new u("stream-layer:websocket-unsupported","WebSocket is not supported in this browser. StreamLayer will not have real-time connection with the stream service."));const r=i.isSome(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Stream Service"]},e).catch((e=>e)).then((()=>this._fetchService(r)))),_.resolve(this)},n.readFeatureReduction=function(e,r){return Q.read(e,r)},n.writeWebSceneFeatureReduction=function(e,r,t,o){Q.writeTarget(e,r,"layerDefinition.featureReduction",o)},n.readRenderer=function(e,r,t){const o=(r=r.layerDefinition||r).drawingInfo&&r.drawingInfo.renderer||void 0;if(o){const e=J.read(o,r,t)||void 0;return e||ee.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:t}),e}if(r.defaultSymbol)return r.types&&r.types.length?new k({defaultSymbol:oe(r.defaultSymbol,r,t),field:r.typeIdField,uniqueValueInfos:r.types.map((e=>({id:e.id,symbol:oe(e.symbol,e,t)})))}):new G({symbol:oe(r.defaultSymbol,r,t)})},n.writeRenderer=function(e,r,t,o){J.write(e,r,t,o)},n.writeWebSceneRenderer=function(e,r,t,o){J.write(e,r,"layerDefinition.drawingInfo.renderer",o)},n.createPopupTemplate=function(e){return Y.createPopupTemplate(this,e)},n.createQuery=function(){const e=new Z;return e.returnGeometry=!0,e.outFields=["*"],e.where=this.definitionExpression||"1=1",e},n.getFieldDomain=function(e,r){if(!this.fields)return null;let t=null;return this.fields.some((r=>(r.name===e&&(t=r.domain),!!t))),t},n.getField=function(e){return this.fieldsIndex.get(e)},n._fetchService=async function(e){var r;if(!!this.webSocketUrl){var t;if(null==(t=this.timeInfo)||!t.trackIdField)throw new u("stream-layer:missing-metadata","The stream layer trackIdField must be specified.");if(!this.objectIdField)throw new u("stream-layer:missing-metadata","The stream layer objectIdField must be specified.");if(!this.fields)throw new u("stream-layer:missing-metadata","The stream layer fields must be specified.");if(!this.geometryType)throw new u("stream-layer:missing-metadata","The stream layer geometryType must be specified.");this.url=this.webSocketUrl}else if(!this.sourceJSON){const{data:r}=await I(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query},responseType:"json",signal:e});this.sourceJSON=r}return this.sourceJSON={...null!=(r=this.sourceJSON)?r:{},objectIdField:"__esri_stream_id__"},this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl}),w.fixRendererFields(this.renderer,this.fields),w.fixTimeInfoFields(this.timeInfo,this.fields),X.loadStyleRenderer(this,{origin:"service"})},e._createClass(o,[{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"fieldsIndex",get:function(){return new M(this.fields)}},{key:"renderer",set:function(e){w.fixRendererFields(e,this.fields),this._set("renderer",e)}}]),o}(q.BlendLayer(C.TemporalLayer(B.ScaleRangeLayer(V.RefreshableLayer(W.ArcGISService(O.OperationalLayer(z.PortalLayer(x.MultiOriginJSONMixin(T)))))))));r.__decorate([a.property({type:String})],te.prototype,"copyright",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:["fields","title"]})],te.prototype,"defaultPopupTemplate",null),r.__decorate([a.property({type:String})],te.prototype,"definitionExpression",void 0),r.__decorate([a.property({type:String})],te.prototype,"displayField",void 0),r.__decorate([a.property({type:F})],te.prototype,"elevationInfo",void 0),r.__decorate([l.reader("featureReduction",["layerDefinition.featureReduction"])],te.prototype,"readFeatureReduction",null),r.__decorate([y.writer("web-scene","featureReduction",{"layerDefinition.featureReduction":{types:Q.webSceneFeatureReductionTypes}})],te.prototype,"writeWebSceneFeatureReduction",null),r.__decorate([a.property({type:[A]})],te.prototype,"fields",void 0),r.__decorate([a.property({readOnly:!0,dependsOn:["fields"]})],te.prototype,"fieldsIndex",null),r.__decorate([a.property({type:h})],te.prototype,"geometryDefinition",void 0),r.__decorate([a.property({type:["point","polygon","polyline","multipoint"],json:{read:{reader:re.read}}})],te.prototype,"geometryType",void 0),r.__decorate([a.property(L.labelsVisible)],te.prototype,"labelsVisible",void 0),r.__decorate([a.property({type:[H],json:{read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:K.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],te.prototype,"labelingInfo",void 0),r.__decorate([a.property(L.legendEnabled)],te.prototype,"legendEnabled",void 0),r.__decorate([a.property({type:["show","hide"]})],te.prototype,"listMode",void 0),r.__decorate([a.property({type:p.Integer})],te.prototype,"maxReconnectionAttempts",void 0),r.__decorate([a.property({type:p.Integer})],te.prototype,"maxReconnectionInterval",void 0),r.__decorate([a.property({type:String})],te.prototype,"objectIdField",void 0),r.__decorate([a.property({value:"ArcGISStreamLayer",type:["ArcGISStreamLayer"]})],te.prototype,"operationalLayerType",void 0),r.__decorate([a.property(L.popupEnabled)],te.prototype,"popupEnabled",void 0),r.__decorate([a.property({type:v,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],te.prototype,"popupTemplate",void 0),r.__decorate([a.property({type:$})],te.prototype,"purgeOptions",void 0),r.__decorate([a.property({types:N.rendererTypes,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}}},write:{target:"layerDefinition.drawingInfo.renderer"}}})],te.prototype,"renderer",null),r.__decorate([l.reader("service","renderer",["drawingInfo.renderer","defaultSymbol"]),l.reader("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],te.prototype,"readRenderer",null),r.__decorate([y.writer("renderer")],te.prototype,"writeRenderer",null),r.__decorate([y.writer("web-scene","renderer",{"layerDefinition.drawingInfo.renderer":{types:N.webSceneRendererTypes}})],te.prototype,"writeWebSceneRenderer",null),r.__decorate([a.property(L.screenSizePerspectiveEnabled)],te.prototype,"screenSizePerspectiveEnabled",void 0),r.__decorate([a.property({type:b,json:{origins:{service:{read:{source:"spatialReference"}}}}})],te.prototype,"spatialReference",void 0),r.__decorate([a.property({json:{read:!1}})],te.prototype,"type",void 0),r.__decorate([a.property(L.url)],te.prototype,"url",void 0),r.__decorate([a.property({type:Number})],te.prototype,"updateInterval",void 0),r.__decorate([a.property({type:String})],te.prototype,"webSocketUrl",void 0),te=r.__decorate([c.subclass("esri.layers.StreamLayer")],te);const oe=d.createTypeReader({types:R.symbolTypesRenderer});return te}));
