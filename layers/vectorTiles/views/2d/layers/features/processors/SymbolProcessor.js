// COPYRIGHT Â© 2021 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.36/esri/copyright.txt for details.

define(["require","exports","../../../../../renderers","../../../../../core/executeAsync","../../../../../core/MapPool","../../../../../core/promiseUtils","../../../../../core/SetPool","../../../../../renderers/support/jsonUtils","../../../engine/webgl/rendererInfoUtils","../../../engine/webgl/Utils","../../../engine/webgl/mesh/factories/WGLMeshFactory"],(function(e,t,r,n,i,o,s,a,c,l,u){function f(e,t){l.isMarkerSymbol(e)||l.isLineSymbol(e)?t.add(e):l.isFillSymbol(e)&&(t.add(e),function(e){return e.outline&&"none"!==e.outline.style}(e)&&t.add(e.outline))}function h(e,t){t.has(e)||t.set(e,new Set);for(var r=e.text,n=t.get(e),i=r.length,o=0;o<i;o++){var s=r.charCodeAt(o);n.add(s)}}Object.defineProperty(t,"__esModule",{value:!0});var d=function(){function e(e){this.type="symbol",this._symbolToMosaicItemMap=new Map,this._symbolToMosaicItemMap.clear(),this.configuration=e.configuration,this.service=e.service,this.spatialReference=e.spatialReference,this.tileRenderer=e.tileRenderer}return e.prototype.destroy=function(){this._symbolToMosaicItemMap.clear()},e.prototype.getMeshData=function(e,t){return t&&t.features&&0!==t.features.length?this._processFeatures(e,t.features).then((function(t){return{tileKey:e.id,data:t}})):o.resolve({tileKey:e.id,data:null})},e.prototype.setConfiguration=function(e){this.configuration=e,this.factory=this.renderer=this.rendererInfo=null},e.prototype.getFactory=function(){return this.factory||(this.factory=this._createFactory()),this.factory},e.prototype.getRenderer=function(){return this.renderer||(this.renderer=this._createRenderer()),this.renderer},e.prototype.getRendererInfo=function(){return this.rendererInfo||(this.rendererInfo=this._createRendererInfo()),this.rendererInfo},e.prototype._createFactory=function(){if(!this.configuration)return null;var e={fields:this.service.fields,typeIdField:this.service.typeIdField,types:this.service.types};return u.default.from(this.getRenderer(),e,this._symbolToMosaicItemMap,this.service.geometryType,this.service.objectIdField,this.spatialReference,this.configuration.devicePixelRatio)},e.prototype._createRenderer=function(){return this.configuration?a.fromJSON(this.configuration.renderer):null},e.prototype._createRendererInfo=function(){return this.configuration?c.createRendererInfo(a.fromJSON(this.configuration.renderer),this.spatialReference,{fields:this.service.fields}):null},e.prototype._processFeatures=function(e,t){var r=this;return t&&t.length?this._getMosaicItems(t).then((function(){return r._writeFeatures(e,t)})):o.resolve(null)},e.prototype._writeFeatures=function(e,t){var r=this,i=0,o=this.getFactory(),s=o.createMeshData(t.length),a={viewingMode:"",scale:e.scale};return n((function(){var e=t[i++],r=i===t.length;return o.write(s,e,a),r})).then((function(){return r._encodeDisplayData(s)}))},e.prototype._encodeDisplayData=function(e){var t={},r=new Array;return e.encode(t,r),t},e.prototype._getReturnCentroid=function(e){if("esriGeometryPolygon"!==this.service.geometryType)return!1;function t(e){if(!e)return!1;var t=e.type;return"simple-marker"===t||"picture-marker"===t||"text"===t}switch(e.type){case"simple":return t(e.symbol);case"unique-value":return t(e.defaultSymbol)||e.uniqueValueInfos.some((function(e){return t(e.symbol)}));case"class-breaks":return t(e.defaultSymbol)||e.classBreakInfos.some((function(e){return t(e.symbol)}));default:return!0}},e.prototype._getMosaicItems=function(e){for(var t=s.acquire(),n=i.acquire(),a=this.getRenderer(),c=0,u=a.getSymbols();c<u.length;c++){var d=u[c];l.isTextSymbol(d)?h(d,n):f(d,t)}if(a instanceof r.UniqueValueRenderer||a instanceof r.ClassBreaksRenderer){var y=a.backgroundFillSymbol;y&&f(y,t)}var p=this._symbolToMosaicItemMap,g=i.acquire(),m=[],v=0;return t.forEach((function(e){p.has(e.id)||(g.set(v,e),m.push({symbol:e.toJSON(),id:v}),v++)})),n.forEach((function(e,t){if(p.has(t.id)){var r=p.get(t.id).glyphMosaicItems,n=[];e.forEach((function(e){(r&&r.length<e||!r[e])&&(n[e]=e)})),n.length>0&&(g.set(v,t),m.push({symbol:t.toJSON(),id:v,glyphIds:n}),v++)}else{g.set(v,t);var i=[];e.forEach((function(e){return i.push(e)})),m.push({symbol:t.toJSON(),id:v,glyphIds:i}),v++}})),m.length>0?this.tileRenderer.getMaterialItems(m).then((function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t],o=g.get(n.id);if(o)if(l.isTextSymbol(o))if(p.has(o.id)){var s=p.get(o.id).glyphMosaicItems,a=n.mosaicItem.glyphMosaicItems;if(a)for(var c=0;c<a.length;c++)null!=a[c]&&(s[c]=a[c])}else p.set(o.id,n.mosaicItem);else p.set(o.id,n.mosaicItem)}i.release(g)})):(s.release(t),i.release(n),o.resolve())},e}();t.SymbolProcessor=d}));