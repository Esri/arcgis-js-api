// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.41/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix/mat2d","../../../../core/libs/gl-matrix/mat4","../../../../core/libs/gl-matrix/vec2","../DisplayObject","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./number","./Utils","./WGLBuffers","./WGLDisplayList","./WGLDisplayObject","../../tiling/enums","../../tiling/TileKey"],(function(t,e,r,a,i,s,o,l,n,d,u,p,y,h,f,c,m,D){function g(t,e){return t.sortKey-e.sortKey}return function(t){function e(e,r){var o=t.call(this)||this;return o.status=m.TileStatus.INITIALIZED,o._data=null,o.hlDisplayList=null,o._wglBuffers=null,o._dirtyMap=new n.default,o.coords=[0,0],o.bounds=[0,0,0,0],o.tileTransform={transform:Float32Array[16],screenTransform:Float32Array[16],displayCoord:Float32Array[2],screenCoord:Float32Array[2]},o._hasVisualVariables=!1,o._labelIndex=null,o.tileTransform.screenTransform=a.create(),o.tileTransform.transform=i.create(),o.tileTransform.displayCoord=s.create(),o.tileTransform.screenCoord=s.create(),o.key=D.pool.acquire(e),o.coords[0]=r[0],o.coords[1]=r[3],o.bounds=r,o}return r(e,t),Object.defineProperty(e.prototype,"iconGeometry",{get:function(){return this.getGeometry(u.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textGeometry",{get:function(){return this.getGeometry(u.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillGeometry",{get:function(){return this.getGeometry(u.WGLGeometryType.FILL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineGeometry",{get:function(){return this.getGeometry(u.WGLGeometryType.LINE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelGeometry",{get:function(){return this.getGeometry(u.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canDisplay",{get:function(){return!!this.attached&&!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.status===m.TileStatus.MODIFIED},set:function(t){t&&this.status===m.TileStatus.READY?this.setStatus(m.TileStatus.MODIFIED):t||this.status!==m.TileStatus.MODIFIED||this.setStatus(m.TileStatus.READY),this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasData",{get:function(){return this.status===m.TileStatus.MODIFIED||this.status===m.TileStatus.READY},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),e.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},e.prototype.getDisplayList=function(t){switch(t){case u.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._data.tileDisplayData.displayList}},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.setData=function(t,e,r){if(this._hasVisualVariables=e,!t||!t.tileDisplayData)return this.clear(),void this.setStatus(m.TileStatus.NO_DATA);this._dispRecStore=d.default.fromTileData(t,this._dirtyMap),this._data=t,t.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(r?m.TileStatus.MODIFIED:m.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(m.TileStatus.READY),this._dirtyMap.markAllDirty()},e.prototype.patchData=function(t,e){this._data||(this.setData(t.addOrUpdate,this._hasVisualVariables,e),t.addOrUpdate=null),this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=d.default.fromTileData(this._data,this._dirtyMap)),t.addOrUpdate.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(e?m.TileStatus.MODIFIED:m.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(m.TileStatus.READY)},e.prototype.commitChanges=function(t){this._data&&this.status===m.TileStatus.READY&&(this._wglBuffers||(this._wglBuffers=new h.default(t.context,this._hasVisualVariables)),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())},e.prototype.setVisibility=function(t,e){for(var r=this._data.tileBufferData.geometries.map((function(t){return{vertexFrom:void 0,vertexTo:void 0,geometry:t}})),a=0,i=t;a<i.length;a++)for(var s=i[a],o=0,l=this._data.tileDisplayData.displayObjectRegistry.get(s.id).displayRecords;o<l.length;o++){var n=l[o];if(null==e||e===n.geometryType){var d=(D=r[n.geometryType]).geometry.vertexBuffer[y.C_VBO_VISIBILITY];if(d){D.vertexFrom=null==D.vertexFrom?n.vertexFrom:Math.min(D.vertexFrom,n.vertexFrom),D.vertexTo=null==D.vertexTo?n.vertexFrom+n.vertexCount:Math.max(D.vertexTo,n.vertexFrom+n.vertexCount);for(var u=n.vertexFrom*d.stride/4,p=n.vertexCount*d.stride/4,h=0;h<p;++h)d.data[u+h]=s.visibility?4294967295:0}}}for(var f=!1,c=0;c<r.length;++c){var D;if(null!=(D=r[c]).vertexFrom&&null!=D.vertexTo){var g=D.vertexTo?D.vertexTo-D.vertexFrom:0;this.setStatus(m.TileStatus.MODIFIED),this._dirtyMap.markDirtyVertices(c,y.C_VBO_VISIBILITY,D.vertexFrom,g),f=!0}}f&&this.requestRender()},e.prototype.setVisibilityRange=function(t,e,r,a){for(var i=p.i8888to32(r,a,r,a),s=void 0,o=void 0,l=this._data.tileBufferData.geometries[u.WGLGeometryType.LABEL].vertexBuffer[y.C_VBO_VISIBILITY_RANGE],n=this._data.tileDisplayData.displayObjectRegistry.get(t),d=n.metrics[e],h=d.range.from,f=h+d.range.count,c=h;c<f;++c){var m=n.displayRecords[c];if(m.geometryType===u.WGLGeometryType.LABEL){s=null==s?m.vertexFrom:Math.min(s,m.vertexFrom),o=null==o?m.vertexFrom+m.vertexCount:Math.max(o,m.vertexFrom+m.vertexCount);for(var D=m.vertexFrom*l.stride/4,g=m.vertexCount*l.stride/4,_=0;_<g;++_)l.data[D+_]=i}}var v=o?o-s:0;this._dirtyMap.markDirtyVertices(u.WGLGeometryType.LABEL,y.C_VBO_VISIBILITY_RANGE,s,v)},e.prototype.setStatus=function(t){this.status=t,t!==m.TileStatus.READY&&t!==m.TileStatus.NO_DATA||(this.attached=!0)},e.prototype.clear=function(){this._data=null,this.setStatus(m.TileStatus.INVALID),this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},e.prototype.dispose=function(){this.clear()},e.prototype.attach=function(t){return this.canDisplay},e.prototype.detach=function(e){t.prototype.detach.call(this,e)},e.prototype.doRender=function(t){var e=this;this.attached&&(this.commitChanges(t),t.context.setStencilFunction(514,this.stencilRef,255),t.painter.getBrushes(t.drawPhase).forEach((function(r){return r.draw(t,e)})))},e.prototype.buildHLList=function(t){var e=this;this.hlDisplayList=new f;t.forEach((function(t){e._addToHLDisplayList(e.hlDisplayList,t)}))},e.prototype._addToHLDisplayList=function(t,e){if(this._data){var r=this._data.tileDisplayData.displayObjectRegistry.get(e);if(r){for(var a=[],i=0,s=r.displayRecords;i<s.length;i++){var o=s[i].copy();o.meshData=null,o.symbolLevel=0,o.zOrder=0,a.push(o)}a.sort(g),t.addToList(a)}}},e.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var t=0,e=this.displayObjects;t<e.length;t++){var r=e[t];this._insertIntoLabelIndex(r)}},e.prototype._insertIntoLabelIndex=function(t){var e=t.anchor;-1!==t.xBucket&&e&&this.labelIndex[t.yBucket][t.xBucket].push(t)},e.prototype._initLabelIndex=function(){for(var t=[],e=0;e<l.TILE_SIZE/l.COLLISION_BUCKET_SIZE;e++){t.push([]);for(var r=0;r<l.TILE_SIZE/l.COLLISION_BUCKET_SIZE;r++)t[e].push([])}return t},e.prototype._patchData=function(t){for(var e=!0,r=0,a=t.remove||[];r<a.length;r++){var i=a[r];if(p=this._data.tileDisplayData.displayObjectRegistry.get(i)){this._data.tileDisplayData.displayList.removeFromList(p.displayRecords);for(var s=0,o=p.displayRecords;s<o.length;s++){var l=o[s];this._dispRecStore.delete(l)}this._data.tileDisplayData.displayObjectRegistry.delete(i);var n=this._data.tileDisplayData.displayObjects.indexOf(p);this._data.tileDisplayData.displayObjects.splice(n,1)}}for(var d=0,u=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[];d<u.length;d++){var p,y=u[d];if(p=this._data.tileDisplayData.displayObjectRegistry.get(y.id)){for(var h=p.displayRecords.length,f=0;f<h;++f){var m=p.displayRecords[f],D=y.displayRecords[f];(f>=y.displayRecords.length||m.geometryType!==D.geometryType||m.symbolLevel!==D.symbolLevel||m.zOrder!==D.zOrder||m.materialInfo.materialKey!==D.materialInfo.materialKey)&&(this._dispRecStore.delete(p.displayRecords[f]),f<y.displayRecords.length&&(p.displayRecords[f]=void 0))}p.displayRecords.length=y.displayRecords.length}else p=new c(y.id),this._data.tileDisplayData.displayObjectRegistry.set(y.id,p),this._data.tileDisplayData.displayObjects.push(p);var g=y.displayRecords.length;for(f=0;f<g;++f){D=y.displayRecords[f];(m=p.displayRecords[f])?(m.meshData=D.meshData,m.materialInfo=D.materialInfo):((m=D.copy()).vertexFrom=void 0,m.indexFrom=void 0,p.displayRecords[f]=m);var _=D.geometryType,v=t.addOrUpdate.tileBufferData.geometries[_],b=v.vertexBuffer,I=v.indexBuffer;e=this._dispRecStore.setMeshData(m,D,b,I)&&e}}return e},e}(o)}));