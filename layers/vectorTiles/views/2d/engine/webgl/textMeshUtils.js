// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","./color","./enums","./Geometry","./MaterialInfoUtils","./MeshData","./number","./SymbolProperties","./TextShaping","./visualVariablesUtils","./WGLDisplayRecord"],(function(t,e,o,i,a,s,p,r,h,u,l,n,y){Object.defineProperty(e,"__esModule",{value:!0});var c=[],v=[],g=h.i8888to32(255,255,255,255);e.createTextDisplayRecords=function(t,e,x,f,M,m,d){v.length=0,c.length=0;var w=e.symbol,S=M.get(w);if(!S.glyphMosaicItems||0===S.glyphMosaicItems.length)return v;var N=S.glyphMosaicItems,P=w.text,z=24*m.offsetX,V=24*m.offsetY,I=m.hAnchor,T=m.vAnchor,U=new l([N],240,24,0,[z,V],I,T,.5).getShaping(P,!1);if(!U||0===U.length)return v;var b=e.vv,R=h.numTo32(x),D=U[0].glyphMosaicItem,A=p.createTextMaterialInfo(D,b,d).materialKeyInfo,G=0,C=0,F=0,L=0,O=A.vvColor||A.vvOpacity||A.vvRotation||A.vvSizeMinMaxValue||A.vvSizeScaleStops||A.vvSizeFieldStops||A.vvSizeUnitValue;if(O){var W=f.vvFields,X=W.rotation?f.getValue(t,W.rotation):0,_=W.opacity?f.getValue(t,W.opacity):0,j=W.color?f.getValue(t,W.color):0,q=W.size&&!A.vvSizeScaleStops?f.getValue(t,W.size):0;A.vvSizeUnitValue&&(q=n.getVisualVariableSizeValueRepresentationRatio(q,f.vvRanges.size.unitValue.valueRepresentation)),(null===q||isNaN(q))&&(q=NaN),(null===X||isNaN(X))&&(X=NaN),(null===j||isNaN(j))&&(j=NaN),(null===_||isNaN(_))&&(_=NaN),G=h.toUint32(q),C=h.toUint32(_),F=h.toUint32(X),L=h.toUint32(j)}var E,K,Y,k,B=[G,L,C,F],H=t.centroid||t.geometry,J=H.x,Q=H.y,Z=w.color&&i.copyAndPremultiply(w.color),$=w.haloColor&&i.copyAndPremultiply(w.haloColor),tt=Z&&h.i8888to32(Z[0],Z[1],Z[2],Z[3])||4294967295,et=$&&h.i8888to32($[0],$[1],$[2],$[3])||0,ot=[o.pt2px(w.xoffset),o.pt2px(w.yoffset)];J+=ot[0],Q+=ot[1];var it,at=w.font.size,st=10*(null!=w.haloSize?o.pt2px(o.toPt(w.haloSize)):0),pt=0,rt=-17;if(st>0){var ht=h.i1616to32(2*J+1,2*Q);for(it=0;it<U.length;it++){var ut=[],lt=[],nt=(Nt=U[it]).glyphMosaicItem;E=Math.round(nt.rect.x/4),K=Math.round(nt.rect.y/4),Y=E+Math.round(nt.rect.width/4),k=K+Math.round(nt.rect.height/4);var yt=Nt.x+pt+nt.metrics.left,ct=Nt.y+rt-nt.metrics.top,vt=new s.Point(yt-4,ct-4),gt=new s.Point(vt.x+nt.rect.width,vt.y+nt.rect.height),xt=new s.Point(vt.x,gt.y),ft=new s.Point(gt.x,vt.y);if(0!==m.angle){var Mt=Math.cos(m.angle),mt=Math.sin(m.angle);vt.rotate(Mt,mt),gt.rotate(Mt,mt),xt.rotate(Mt,mt),ft.rotate(Mt,mt)}var dt=p.createTextMaterialInfo(nt,b,d),wt=new r;ut.push(ht),ut.push(R),ut.push(et),ut.push(h.i1616to32(32*vt.x,32*vt.y)),ut.push(h.i8888to32(E,K,at,st)),O&&ut.push.apply(ut,B),ut.push(ht),ut.push(R),ut.push(et),ut.push(h.i1616to32(32*ft.x,32*ft.y)),ut.push(h.i8888to32(Y,K,at,st)),O&&ut.push.apply(ut,B),ut.push(ht),ut.push(R),ut.push(et),ut.push(h.i1616to32(32*xt.x,32*xt.y)),ut.push(h.i8888to32(E,k,at,st)),O&&ut.push.apply(ut,B),ut.push(ht),ut.push(R),ut.push(et),ut.push(h.i1616to32(32*gt.x,32*gt.y)),ut.push(h.i8888to32(Y,k,at,st)),O&&ut.push.apply(ut,B),lt.push(g),wt.update({geometry:ut,visibility:lt},4,[0,1,2,1,3,2]),(zt=new y(x,a.WGLGeometryType.TEXT,dt)).meshData=wt,v.push(zt)}}var St=h.i1616to32(2*J,2*Q);for(it=0;it<U.length;it++){ut=[],lt=[];var Nt,Pt=(Nt=U[it]).glyphMosaicItem;E=Math.round(Pt.rect.x/4),K=Math.round(Pt.rect.y/4),Y=E+Math.round(Pt.rect.width/4),k=K+Math.round(Pt.rect.height/4);yt=Nt.x+pt+Pt.metrics.left,ct=Nt.y+rt-Pt.metrics.top,vt=new s.Point(yt-4,ct-4),gt=new s.Point(vt.x+Pt.rect.width,vt.y+Pt.rect.height),xt=new s.Point(vt.x,gt.y),ft=new s.Point(gt.x,vt.y);if(0!==m.angle){Mt=Math.cos(m.angle),mt=Math.sin(m.angle);vt.rotate(Mt,mt),gt.rotate(Mt,mt),xt.rotate(Mt,mt),ft.rotate(Mt,mt)}var zt,Vt=p.createTextMaterialInfo(Pt,b,d);wt=new r;ut.push(St),ut.push(R),ut.push(tt),ut.push(h.i1616to32(32*vt.x,32*vt.y)),ut.push(h.i8888to32(E,K,at,st)),O&&ut.push.apply(ut,B),ut.push(St),ut.push(R),ut.push(tt),ut.push(h.i1616to32(32*ft.x,32*ft.y)),ut.push(h.i8888to32(Y,K,at,st)),O&&ut.push.apply(ut,B),ut.push(St),ut.push(R),ut.push(tt),ut.push(h.i1616to32(32*xt.x,32*xt.y)),ut.push(h.i8888to32(E,k,at,st)),O&&ut.push.apply(ut,B),ut.push(St),ut.push(R),ut.push(tt),ut.push(h.i1616to32(32*gt.x,32*gt.y)),ut.push(h.i8888to32(Y,k,at,st)),O&&ut.push.apply(ut,B),lt.push(g),wt.update({geometry:ut,visibility:lt},4,[0,1,2,1,3,2]),(zt=new y(x,d,Vt)).meshData=wt,v.push(zt)}return u.TextProperties.pool.release(m),v}}));
