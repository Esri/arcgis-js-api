// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","./color","./enums","./Geometry","./MaterialInfoUtils","./MeshData","./number","./SymbolProperties","./TextShaping","./visualVariablesUtils","./WGLDisplayRecord"],function(t,e,o,a,i,s,r,p,h,u,l,n,y){function c(t,e,c,m,d,w,S){g.length=0,v.length=0;var N=e.symbol,P=d.get(N);if(!P.glyphMosaicItems||0===P.glyphMosaicItems.length)return g;var z=P.glyphMosaicItems,V=N.text,I=24*w.offsetX,T=24*w.offsetY,U=w.hAnchor,b=w.vAnchor,R=new l([z],240,24,0,[I,T],U,b,.5),D=R.getShaping(V,!1);if(!D||0===D.length)return g;var A=e.vv,G=h.numTo32(c),C=D[0].glyphMosaicItem,F=r.createTextMaterialInfo(C,A,S),L=F.materialKeyInfo,O=0,W=0,X=0,_=0,j=L.vvColor||L.vvOpacity||L.vvRotation||L.vvSizeMinMaxValue||L.vvSizeScaleStops||L.vvSizeFieldStops||L.vvSizeUnitValue;if(j){var q=m.vvFields,E=q.rotation?m.getValue(t,q.rotation):0,K=q.opacity?m.getValue(t,q.opacity):0,Y=q.color?m.getValue(t,q.color):0,k=q.size&&!L.vvSizeScaleStops?m.getValue(t,q.size):0;L.vvSizeUnitValue&&(k=n.getVisualVariableSizeValueRepresentationRatio(k,m.vvRanges.size.unitValue.valueRepresentation)),(null===k||isNaN(k))&&(k=NaN),(null===E||isNaN(E))&&(E=NaN),(null===Y||isNaN(Y))&&(Y=NaN),(null===K||isNaN(K))&&(K=NaN),O=h.toUint32(k),W=h.toUint32(K),X=h.toUint32(E),_=h.toUint32(Y)}var B,H,J,Q,Z=[O,_,W,X],$=t.centroid||t.geometry,tt=$.x,et=$.y,ot=N.color&&a.copyAndPremultiply(N.color),at=N.haloColor&&a.copyAndPremultiply(N.haloColor),it=ot&&h.i8888to32(ot[0],ot[1],ot[2],ot[3])||4294967295,st=at&&h.i8888to32(at[0],at[1],at[2],at[3])||0,rt=[o.pt2px(N.xoffset),o.pt2px(N.yoffset)];tt+=rt[0],et+=rt[1];var pt,ht=N.font.size,ut=f*(null!=N.haloSize?o.pt2px(o.toPt(N.haloSize)):0),lt={x:0,y:-17};if(ut>0){var nt=h.i1616to32(2*tt+1,2*et);for(pt=0;pt<D.length;pt++){var yt=D[pt],ct=[],vt=[],gt=yt.glyphMosaicItem;B=Math.round(gt.rect.x/4),H=Math.round(gt.rect.y/4),J=B+Math.round(gt.rect.width/4),Q=H+Math.round(gt.rect.height/4);var xt=yt.x+lt.x+gt.metrics.left,ft=yt.y+lt.y-gt.metrics.top,Mt=new s.Point(xt-4,ft-4),mt=new s.Point(Mt.x+gt.rect.width,Mt.y+gt.rect.height),dt=new s.Point(Mt.x,mt.y),wt=new s.Point(mt.x,Mt.y);if(0!==w.angle){var St=Math.cos(w.angle),Nt=Math.sin(w.angle);Mt.rotate(St,Nt),mt.rotate(St,Nt),dt.rotate(St,Nt),wt.rotate(St,Nt)}var Pt=r.createTextMaterialInfo(gt,A,S),zt=new p;ct.push(nt),ct.push(G),ct.push(st),ct.push(h.i1616to32(x*Mt.x,x*Mt.y)),ct.push(h.i8888to32(B,H,ht,ut)),j&&ct.push.apply(ct,Z),ct.push(nt),ct.push(G),ct.push(st),ct.push(h.i1616to32(x*wt.x,x*wt.y)),ct.push(h.i8888to32(J,H,ht,ut)),j&&ct.push.apply(ct,Z),ct.push(nt),ct.push(G),ct.push(st),ct.push(h.i1616to32(x*dt.x,x*dt.y)),ct.push(h.i8888to32(B,Q,ht,ut)),j&&ct.push.apply(ct,Z),ct.push(nt),ct.push(G),ct.push(st),ct.push(h.i1616to32(x*mt.x,x*mt.y)),ct.push(h.i8888to32(J,Q,ht,ut)),j&&ct.push.apply(ct,Z),vt.push(M),zt.update({geometry:ct,visibility:vt},4,[0,1,2,1,3,2]);var Vt=new y(c,i.WGLGeometryType.TEXT,Pt);Vt.meshData=zt,g.push(Vt)}}var It=h.i1616to32(2*tt,2*et);for(pt=0;pt<D.length;pt++){var yt=D[pt],ct=[],vt=[],Tt=yt.glyphMosaicItem;B=Math.round(Tt.rect.x/4),H=Math.round(Tt.rect.y/4),J=B+Math.round(Tt.rect.width/4),Q=H+Math.round(Tt.rect.height/4);var xt=yt.x+lt.x+Tt.metrics.left,ft=yt.y+lt.y-Tt.metrics.top,Mt=new s.Point(xt-4,ft-4),mt=new s.Point(Mt.x+Tt.rect.width,Mt.y+Tt.rect.height),dt=new s.Point(Mt.x,mt.y),wt=new s.Point(mt.x,Mt.y);if(0!==w.angle){var St=Math.cos(w.angle),Nt=Math.sin(w.angle);Mt.rotate(St,Nt),mt.rotate(St,Nt),dt.rotate(St,Nt),wt.rotate(St,Nt)}var Ut=r.createTextMaterialInfo(Tt,A,S),zt=new p;ct.push(It),ct.push(G),ct.push(it),ct.push(h.i1616to32(x*Mt.x,x*Mt.y)),ct.push(h.i8888to32(B,H,ht,ut)),j&&ct.push.apply(ct,Z),ct.push(It),ct.push(G),ct.push(it),ct.push(h.i1616to32(x*wt.x,x*wt.y)),ct.push(h.i8888to32(J,H,ht,ut)),j&&ct.push.apply(ct,Z),ct.push(It),ct.push(G),ct.push(it),ct.push(h.i1616to32(x*dt.x,x*dt.y)),ct.push(h.i8888to32(B,Q,ht,ut)),j&&ct.push.apply(ct,Z),ct.push(It),ct.push(G),ct.push(it),ct.push(h.i1616to32(x*mt.x,x*mt.y)),ct.push(h.i8888to32(J,Q,ht,ut)),j&&ct.push.apply(ct,Z),vt.push(M),zt.update({geometry:ct,visibility:vt},4,[0,1,2,1,3,2]);var Vt=new y(c,S,Ut);Vt.meshData=zt,g.push(Vt)}return u.TextProperties.pool.release(w),g}Object.defineProperty(e,"__esModule",{value:!0});var v=[],g=[],x=32,f=10,M=h.i8888to32(255,255,255,255);e.createTextDisplayRecords=c});