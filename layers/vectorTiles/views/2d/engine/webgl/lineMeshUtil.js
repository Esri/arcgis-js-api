// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","./color","./LineTess","./MeshData","./number","./TileClipper","./Utils","./visualVariablesUtils"],function(e,i,t,r,o,a,n,s,l,v){function u(e,i,s,u,d,p,h){var b=null!=u?u.spriteMosaicItem:null,m=p.geometry,g=l.isPictureSymbol(h),R=!g&&h.color?r.copyAndPremultiply(h.color):[255,255,255,1],A=n.numTo32(e),P=1/d,U=Math.round(d*t.pt2px(h.width>0?.5*(h.width+P):0)),I=null!=b,_=s.vvColor||s.vvOpacity||s.vvSizeMinMaxValue||s.vvSizeScaleStops||s.vvSizeFieldStops||s.vvSizeUnitValue,D=0,F=0,O=0;if(_){var q=i.vvFields,L=q.opacity?i.getValue(p,q.opacity):0,k=q.color?i.getValue(p,q.color):0,j=q.size&&!s.vvSizeScaleStops?i.getValue(p,q.size):0;s.vvSizeUnitValue&&(j=v.getVisualVariableSizeValueRepresentationRatio(j,i.vvRanges.size.unitValue.valueRepresentation)),(null===j||isNaN(j))&&(j=NaN),(null===k||isNaN(k))&&(k=NaN),(null===L||isNaN(L))&&(L=NaN),V[0]=j,O=C[0],V[0]=L,D=C[0],V[0]=k,F=C[0]}var G=n.i8888to32(R[0],R[1],R[2],R[3]),W=[0,0],Y=[0,0];if(b){var B=b.rect.x,H=b.rect.y,K=b.width,Q=b.height;W[0]=B+1,W[1]=H+1,Y[0]=B+1+K,Y[1]=H+1+Q}for(var X=m.rings||m.paths,Z=[],$=X.length,ee=0,ie=!1;ee<$;){var te=X[ee],re=[];J.reset(2);var oe=te[0][0],ae=te[0][1];if(ie)J.moveTo(oe,ae);else{if(oe<-8||oe>520||ae<-8||ae>520){ie=!0;continue}re.push({x:oe,y:ae})}for(var ne=!1,se=te.length,le=1;le<se;++le)if(oe+=te[le][0],ae+=te[le][1],ie)J.lineTo(oe,ae);else{if(oe<-8||oe>520||ae<-8||ae>520){ne=!0;break}re.push({x:oe,y:ae})}if(ne)ie=!0;else{if(ie){var ve=J.resultWithStarts();if(ve)for(var ue=0,ce=ve;ue<ce.length;ue++){var de=ce[ue];Z.push(de)}}else Z.push({line:re,start:0});ee++,ie=!1}}for(var pe=0,fe=[],xe=[],ye=0,he=Z;ye<he.length;ye++){var be=he[ye],re=be.line,me=be.start;if(!(re.length<2)){var ge=re.length,Se=re[0],Me=re[ge-1],ze=Me.x-Se.x,Ve=Me.y-Se.y,Ce=ze*ze+Ve*Ve<w*w,Te=me%S,Ne=T[1],Ee=void 0,Re=_?{size:O,color:F,opacity:D}:null;for(Ee=0;Ee<ge;++Ee){var we=re[Ee],Ae=Ne===T[Ee%2]?T[(Ee+1)%2]:T[Ee%2];if(Ee<ge-1||!Ce||I?(c(Ae,Ee,re,ge,Ce,"round","round"),pe+=f(we.x,we.y,Te,G,W,Y,A,U,pe,Re,Ae,fe),!Ae.capCenter||Ce&&Ee===ge-1||y(Ae,xe),Ce&&0===Ee&&!I&&o.copyExtrudeVectors(N,Ae)):o.copyExtrudeVectors(Ae,N),Ee>0&&x(Ne,Ae,xe),Ee<ge-1){var Je=re[Ee+1],Pe=[Je.x-we.x,Je.y-we.y],Ue=o.length(Pe),Ie=[Pe[0]/Ue,Pe[1]/Ue],_e=Te+Ue;if(M&&_e>S){var De=(S-Te)/(_e-Te),Fe=we.x+(Je.x-we.x)*De,Oe=we.y+(Je.y-we.y)*De,qe=Ne;z.buttCap(qe,Ie,Ie),pe+=f(Fe,Oe,S,G,W,Y,e,U,pe,Re,qe,fe),z.bridge(E,Ae,qe),x(Ae,qe,xe),z.buttCap(qe,Ie,Ie),pe+=f(Fe,Oe,0,G,W,Y,e,U,pe,Re,qe,fe),Te=_e-S}else Te=_e,Ne=Ae}}}}var Le=new a;return Le.update({geometry:fe},pe,xe),Le}function c(e,i,t,r,a,n,s){var l=t[i],v=[void 0,void 0],u=[void 0,void 0];if(i>0&&i<r-1){var c=t[(i+r-1)%r],f=t[(i+1)%r];o.normalize(v,[l.x-c.x,l.y-c.y]),o.normalize(u,[f.x-l.x,f.y-l.y])}else if(0===i){var f=t[(i+1)%r];if(o.normalize(u,[f.x-l.x,f.y-l.y]),a){var x=t[r-2];o.normalize(v,[l.x-x.x,l.y-x.y])}else v=u}else{if(i!==r-1)return void console.error("Vertex index 'i' out of range.");var c=t[(i+r-1)%r];if(o.normalize(v,[l.x-c.x,l.y-c.y]),a){var y=t[1];o.normalize(u,[y.x-l.x,y.y-l.y])}else u=v}a||0!==i?a||i!==r-1?p(e,v,u,s):d(e,v,u,o.CapPosition.END,n):d(e,v,u,o.CapPosition.START,n)}function d(e,i,t,r,a){"butt"===a?z.buttCap(e,i,t):"round"===a?z.roundCap(e,i,t,r,o.getNumberOfSlices(Math.PI),r===o.CapPosition.START?-1:1):"square"===a?z.squareCap(e,i,t,r):(z.buttCap(e,i,t),console.error("Unknown cap type!"))}function p(e,i,t,r){var a=o.getRads(i,t);if(a>Math.PI-h)z.rectJoin(e,i,t);else if("miter"===r||a<b)a<h?z.fastMiterJoin(e,i,t):a<o.MITER_SAFE_RADS?z.miterJoin(e,i,t):z.bevelJoin(e,i,t,o.SYSTEM_MAG_LIMIT);else if("bevel"===r)z.bevelJoin(e,i,t,1);else if("round"===r){var n=o.getNumberOfSlices(a),s=a<g;s?n<2||a<m?z.bevelJoin(e,i,t,1):z.roundJoin(e,i,t,n):z.unitRoundJoin(e,i,t,n)}}function f(e,i,t,r,o,a,s,l,v,u,c,d){var p,f=0;for(p=0;p<c.vectors.count;++p){var x=c.vectors.items[p].vector[0],y=c.vectors.items[p].vector[1],h=c.vectors.items[p].texCoords[0],b=c.vectors.items[p].texCoords[1],m=c.vectors.items[p].direction[0],g=c.vectors.items[p].direction[1],S=v+f;++f,d.push(n.i1616to32(e,i),s,r,n.i8888to32(Math.round(A*x),Math.round(A*y),Math.round(A*h),Math.round(A*b)),n.i1616to32(t,A*l),n.i1616to32(o[0],o[1]),n.i1616to32(a[0],a[1]),n.i8888to32(Math.round(A*m),Math.round(A*g),0,0)),u&&d.push(u.size,u.color,u.opacity),c.vectors.items[p].base={index:S,point:[e,i]}}return f}function x(e,i,t){z.bridge(E,e,i);var r;for(r=0;r<E.count;++r){var o=E.items[r];t.push(o.v1.base.index,o.v2.base.index,o.v3.base.index)}}function y(e,i){z.pie(R,e);var t;for(t=0;t<R.count;++t){var r=R.items[t];i.push(r.v1.base.index,r.v2.base.index,r.v3.base.index)}}Object.defineProperty(i,"__esModule",{value:!0});var h=.05,b=.1,m=.5,g=2.3,S=65535,M=!0,z=new o.Tessellator({distanceAlongCorrection:!0}),V=new Float32Array(1),C=new Uint32Array(V.buffer),T=[o.allocExtrudeVectors(),o.allocExtrudeVectors()],N=o.allocExtrudeVectors(),E=o.allocTriangles(20),R=o.allocTriangles(20),w=.001,A=31,J=new s.TileClipper(0,0,0,1,8);J.setExtent(512),i.createLineMeshData=u});