// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.29/esri/copyright.txt for details.

define(["require","exports","../../../../arcade/Dictionary","../../../../arcade/Feature","../../../../core/Logger","../../../../core/screenUtils","../../../../support/arcadeUtils","./color","./enums","./SymbolProperties"],function(e,r,t,n,_,i,E,a,s,o){function u(e){return e.map(function(e){return e.name})}function T(e){for(var r={},t=0,n=e;t<n.length;t++){var _=n[t];r[_.name]=_.strideInBytes}return r}function C(e,t,n){switch(void 0===n&&(n=!1),e){case s.WGLGeometryType.MARKER:return t?r.C_ICON_STRIDE_SPEC_VV:n?r.C_ICON_STRIDE_SPEC_HEATMAP:r.C_ICON_STRIDE_SPEC;case s.WGLGeometryType.FILL:return t?r.C_FILL_STRIDE_SPEC_VV:r.C_FILL_STRIDE_SPEC;case s.WGLGeometryType.LINE:return t?r.C_LINE_STRIDE_SPEC_VV:r.C_LINE_STRIDE_SPEC;case s.WGLGeometryType.TEXT:return t?r.C_TEXT_STRIDE_SPEC_VV:r.C_TEXT_STRIDE_SPEC;case s.WGLGeometryType.LABEL:return r.C_LABEL_STRIDE_SPEC}return null}function V(e,t){switch(e){case s.WGLGeometryType.MARKER:return t?r.C_ICON_VERTEX_NAMES_VV:r.C_ICON_VERTEX_NAMES;case s.WGLGeometryType.FILL:return t?r.C_FILL_VERTEX_NAMES_VV:r.C_FILL_VERTEX_NAMES;case s.WGLGeometryType.LINE:return t?r.C_LINE_VERTEX_NAMES_VV:r.C_LINE_VERTEX_NAMES;case s.WGLGeometryType.TEXT:return t?r.C_TEXT_VERTEX_NAMES_VV:r.C_TEXT_VERTEX_NAMES;case s.WGLGeometryType.LABEL:return r.C_LABEL_VERTEX_NAMES}return null}function c(e){return l(e)?s.WGLGeometryType.MARKER:y(e)?s.WGLGeometryType.LINE:p(e)?s.WGLGeometryType.FILL:L(e)?s.WGLGeometryType.TEXT:s.WGLGeometryType.UNKNOWN}function I(e){switch(e){case"esriSMS":return"simple-marker";case"esriPMS":return"picture-marker";case"esriSLS":return"simple-line";case"esriPLS":return"picture-line";case"esriSFS":return"simple-fill";case"esriPFS":return"picture-fill";case"esriTS":return"text"}return e}function l(e){var r=I(e.type);if(r){switch(r){case"simple-marker":case"picture-marker":case"CIMPointSymbol":return!0}return!1}}function p(e){var r=I(e.type);if(r){switch(r){case"simple-fill":case"picture-fill":case"CIMPolygonSymbol":return!0}return!1}}function y(e){var r=I(e.type);if(r){switch(r){case"simple-line":case"picture-line":case"CIMLineSymbol":return!0}return!1}}function S(e){var r=I(e.type);if(r){switch(r){case"picture-marker":case"picture-line":case"picture-fill":return!0}return!1}return!1}function L(e){var r=I(e.type);if(r){switch(r){case"text":case"CIMTextSymbol":return!0}return!1}}function R(e){return o.TextProperties.pool.acquire(e.color?a.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?a.copyAndPremultiply(e.haloColor):[255,255,255,255],i.pt2px(e.haloSize),i.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)}function f(e,r){return!1}function m(e){return e&&e.length||0}function N(e,r){if(e.materialKey!==r.materialKey)return!1;if(m(e.texBindingInfo)!==m(r.texBindingInfo))return!1;if(m(e.materialParams)!==m(r.materialParams))return!1;for(var t=e.texBindingInfo.length,n=0;n<t;++n){var _=e.texBindingInfo[n],i=r.texBindingInfo[n];if(_.unit!==i.unit||_.pageId!==i.pageId||_.semantic!==i.semantic)return!1}for(var E=e.materialParams.length,n=0;n<E;++n){var a=e.materialParams[n],s=r.materialParams[n];if(a.name!==s.name||!f(a.value,s.value))return!1}return!0}function d(e,r,t){for(var n=0,_=e.length,i=0;i<_;++i)r&&(r[t+n]=e.charCodeAt(i)),++n;return r&&(r[t+n]=0),++n}function O(e,r,t){var n=0;e.s="";for(var _=!0;_;){var i=r[t+n];++n,0!==i?e.s+=String.fromCharCode(i):_=!1}return n}function v(e){return null!==e&&void 0!==e}function B(e){return"number"==typeof e}function X(e){return"string"==typeof e}function h(e){return null==e||X(e)}function F(e,r,t){return e+(r-e)*t}function A(e){switch(e){case"butt":return s.CapType.BUTT;case"round":return s.CapType.ROUND;case"square":return s.CapType.SQUARE;default:return b.error("Cannot interpret unknown cap: "+e),s.CapType.UNKNOWN}}function D(e){switch(e){case"miter":return s.JoinType.MITER;case"bevel":return s.JoinType.BEVEL;case"round":return s.JoinType.ROUND;default:return b.error("Cannot interpret unknown join: "+e),s.JoinType.UNKNOWN}}function M(e){switch(e){case"opacity":return s.VVType.OPACITY;case"color":return s.VVType.COLOR;case"rotation":return s.VVType.ROTATION;case"size":return s.VVType.SIZE;default:return b.error("Cannot interpret unknown vv: "+e),null}}function G(e,r){var _=e.valueExpression,i=e.spatialReference,a=e.layer,s=E.createFunction(_),o=new n;return function(e,n){o.repurposeFromGraphicLikeObject(e.geometry,e.attributes,a);var _=n&&new t({viewingMode:n.viewingMode,scale:n.scale}),u={$feature:o,$view:_||{}},T={vars:u,spatialReference:i},C=E.executeFunction(s,T);return r?r(C):C}}function g(e,r,t,n,_,i,E){for(var a in i)for(var s=i[a].stride,o=i[a].data,u=t[a].data,T=s*_.vertexCount/4,C=s*e/4,V=s*_.vertexFrom/4,c=0;c<T;++c)u[c+C]=o[c+V];for(var I=_.indexCount,c=0;c<I;++c)n[c+r]=E[c+_.indexFrom]-_.vertexFrom+e}function P(e,r,t){for(var n=[],_=0;_<5;++_){for(var i=V(_,e),E={},a=0,s=i;a<s.length;a++){var o=s[a];E[o]={data:t(_,o)}}n.push({data:r(_),buffers:E})}return n}Object.defineProperty(r,"__esModule",{value:!0});var b=_.getLogger("esri.views.2d.engine.webgl.Utils");r.C_HITTEST_SEARCH_SIZE=4,r.C_VBO_GEOMETRY="geometry",r.C_VBO_PERINSTANCE="per_instance",r.C_VBO_PERINSTANCE_VV="per_instance_vv",r.C_VBO_VISIBILITY="visibility",r.C_VBO_VISIBILITY_RANGE="visibilityRange",r.C_ICON_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:24,divisor:0}],r.C_ICON_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:40,divisor:0}],r.C_ICON_HEATMAP=[{name:r.C_VBO_GEOMETRY,strideInBytes:28,divisor:0}],r.C_FILL_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:24,divisor:0}],r.C_FILL_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:32,divisor:0}],r.C_LINE_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:32,divisor:0}],r.C_LINE_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:44,divisor:0}],r.C_TEXT_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:20,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_TEXT_VERTEX_DEF_VV=[{name:r.C_VBO_GEOMETRY,strideInBytes:36,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],r.C_LABEL_VERTEX_DEF=[{name:r.C_VBO_GEOMETRY,strideInBytes:20,divisor:0},{name:r.C_VBO_VISIBILITY,strideInBytes:1,divisor:0},{name:r.C_VBO_VISIBILITY_RANGE,strideInBytes:2,divisor:0}],r.C_ICON_VERTEX_NAMES=u(r.C_ICON_VERTEX_DEF),r.C_ICON_VERTEX_NAMES_VV=u(r.C_ICON_VERTEX_DEF_VV),r.C_FILL_VERTEX_NAMES=u(r.C_FILL_VERTEX_DEF),r.C_FILL_VERTEX_NAMES_VV=u(r.C_FILL_VERTEX_DEF_VV),r.C_LINE_VERTEX_NAMES=u(r.C_LINE_VERTEX_DEF),r.C_LINE_VERTEX_NAMES_VV=u(r.C_LINE_VERTEX_DEF_VV),r.C_TEXT_VERTEX_NAMES=u(r.C_TEXT_VERTEX_DEF),r.C_TEXT_VERTEX_NAMES_VV=u(r.C_TEXT_VERTEX_DEF_VV),r.C_LABEL_VERTEX_NAMES=u(r.C_LABEL_VERTEX_DEF),r.C_ICON_STRIDE_SPEC=T(r.C_ICON_VERTEX_DEF),r.C_ICON_STRIDE_SPEC_VV=T(r.C_ICON_VERTEX_DEF_VV),r.C_ICON_STRIDE_SPEC_HEATMAP=T(r.C_ICON_HEATMAP),r.C_FILL_STRIDE_SPEC=T(r.C_FILL_VERTEX_DEF),r.C_FILL_STRIDE_SPEC_VV=T(r.C_FILL_VERTEX_DEF_VV),r.C_LINE_STRIDE_SPEC=T(r.C_LINE_VERTEX_DEF),r.C_LINE_STRIDE_SPEC_VV=T(r.C_LINE_VERTEX_DEF_VV),r.C_TEXT_STRIDE_SPEC=T(r.C_TEXT_VERTEX_DEF),r.C_TEXT_STRIDE_SPEC_VV=T(r.C_TEXT_VERTEX_DEF_VV),r.C_LABEL_STRIDE_SPEC=T(r.C_LABEL_VERTEX_DEF),r.getStrides=C,r.getNamedBuffers=V,r.getSymbolGeometryType=c,r.normalizeSymbolType=I,r.isMarkerSymbol=l,r.isFillSymbol=p,r.isLineSymbol=y,r.isPictureSymbol=S,r.isTextSymbol=L,r.getTextProperties=R,r.isSameUniformValue=f,r.isSameMaterialInfo=N,r.serializeString=d,r.deserializeString=O,r.isDefined=v,r.isNumber=B,r.isString=X,r.isStringOrNull=h,r.lerp=F;var x=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(r)},e.prototype.getKeys=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();r.KeysGetter=x;var w=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(e)},e.prototype.getValues=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();r.ValuesGetter=w,r.getCapType=A,r.getJoinType=D,r.getVVType=M,r.createArcadeFunction=G,r.copyMeshData=g,r.C_VBO_INFO=(Y={},Y[r.C_VBO_GEOMETRY]=35044,Y[r.C_VBO_VISIBILITY]=35044,Y[r.C_VBO_VISIBILITY_RANGE]=35048,Y),r.createGeometryData=P;var Y});