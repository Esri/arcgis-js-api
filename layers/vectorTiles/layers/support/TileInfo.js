// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../core/JSONSupport","../../core/kebabDictionary","../../core/accessorSupport/decorators","../../core/accessorSupport/ensureType","../../geometry/support/aaBoundingRect","../../geometry/support/scaleUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","./LOD"],(function(e,t,r,o,i,l,n,s,p,a,c,u,f,y,h){var v=s({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc"});return function(e){function t(t){var r=e.call(this)||this;return r.dpi=96,r.format=null,r.origin=null,r.minScale=0,r.maxScale=0,r.size=null,r.spatialReference=null,r}return o(t,e),n=t,t.create=function(e){void 0===e&&(e={size:256,spatialReference:l.SpatialReference.WebMercator});var t=e.resolutionFactor||1,r=e.scales,o=e.size||256,i=e.spatialReference||l.SpatialReference.WebMercator,s=f.getInfo(i),p=s?new l.Point(s.origin[0],s.origin[1],i):new l.Point(0,0,i),a=1/(39.37*u.getMetersPerUnitForSR(i)*96),c=[];if(r)for(var y=0;y<r.length;y++){var h=(g=r[y])*a;c.push({level:y,scale:g,resolution:h})}else{var v=f.isGeographic(i)?512/o*147748799.285417:256/o*591657527.591555,d=Math.ceil(24/t);c.push({level:0,scale:v,resolution:v*a});for(y=1;y<d;y++){var g;h=(g=v/Math.pow(2,t))*a;c.push({level:y,scale:g,resolution:h}),v=g}}return new n({dpi:96,lods:c,origin:p,size:o,spatialReference:i})},Object.defineProperty(t.prototype,"isWrappable",{get:function(){var e=this.spatialReference,t=this.origin;if(e&&t){var r=f.getInfo(e);return e.isWrappable&&Math.abs(r.origin[0]-t.x)<=r.dx}return!1},enumerable:!0,configurable:!0}),t.prototype.readOrigin=function(e,t){return l.Point.fromJSON(r({spatialReference:t.spatialReference},e))},Object.defineProperty(t.prototype,"lods",{set:function(e){var t=this,r=0,o=0,i=[];this._levelToLOD={},e&&(r=-1/0,o=1/0,e.forEach((function(e){i.push(e.scale),r=e.scale>r?e.scale:r,o=e.scale<o?e.scale:o,t._levelToLOD[e.level]=e}))),this._set("scales",i),this._set("minScale",r),this._set("maxScale",o),this._set("lods",e),this._initializeUpsampleLevels()},enumerable:!0,configurable:!0}),t.prototype.readSize=function(e,t){return[t.cols,t.rows]},t.prototype.writeSize=function(e,t){t.cols=e[0],t.rows=e[0]},t.prototype.zoomToScale=function(e){var t=this.scales;if(e<=0)return t[0];if(e>=t.length)return t[t.length-1];var r=Math.round(e-.5),o=Math.round(e);return t[o]+(o-e)*(t[r]-t[o])},t.prototype.scaleToZoom=function(e){for(var t=this.scales,r=t.length-1,o=0;o<r;o++){var i=t[o],l=t[o+1];if(i<=e)return o;if(l===e)return o+1;if(i>e&&l<e)return o+1-(e-l)/(i-l)}return o},t.prototype.snapScale=function(e,t){void 0===t&&(t=.95);var r=this.scaleToZoom(e);return r%Math.floor(r)>=t?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))},t.prototype.tileAt=function(e,t,r,o){var i,l,n=this.lodAt(e);if(!n)return null;if("number"==typeof t)i=t,l=r;else if(f.equals(t.spatialReference,this.spatialReference))i=t.x,l=t.y,o=r;else{var s=y.project(t,this.spatialReference);if(!s)return null;i=s.x,l=s.y,o=r}var p=n.resolution*this.size[0],a=n.resolution*this.size[1];return o||(o={id:null,level:0,row:0,col:0,extent:c.create()}),o.level=e,o.row=Math.floor((this.origin.y-l)/a+.001),o.col=Math.floor((i-this.origin.x)/p+.001),this.updateTileInfo(o),o},t.prototype.updateTileInfo=function(e){var t=this.lodAt(e.level),r=t.resolution*this.size[0],o=t.resolution*this.size[1];e.id=e.level+"/"+e.row+"/"+e.col,e.extent||(e.extent=c.create()),e.extent[0]=this.origin.x+e.col*r,e.extent[1]=this.origin.y-(e.row+1)*o,e.extent[2]=e.extent[0]+r,e.extent[3]=e.extent[1]+o},t.prototype.upsampleTile=function(e){var t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)},t.prototype.getTileBounds=function(e,t){var r=this.lodAt(t.level).resolution,o=r*this.size[0],i=r*this.size[1];return e[0]=this.origin.x+t.col*o,e[1]=this.origin.y-(t.row+1)*i,e[2]=e[0]+o,e[3]=e[1]+i,e},t.prototype.lodAt=function(e){return this._levelToLOD&&this._levelToLOD[e]||null},t.prototype.clone=function(){return n.fromJSON(this.write({}))},t.prototype._initializeUpsampleLevels=function(){var e=this.lods;this._upsampleLevels=[];for(var t=null,r=0;r<e.length;r++){var o=e[r];this._upsampleLevels[o.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/o.resolution:0},t=o}},i([p.property({type:Number,json:{write:!0}})],t.prototype,"compressionQuality",void 0),i([p.property({type:Number,json:{write:!0}})],t.prototype,"dpi",void 0),i([p.property({type:String,json:{read:v.read,write:v.write}})],t.prototype,"format",void 0),i([p.property({readOnly:!0,dependsOn:["spatialReference","origin"]})],t.prototype,"isWrappable",null),i([p.property({type:l.Point,json:{write:!0}})],t.prototype,"origin",void 0),i([p.reader("origin")],t.prototype,"readOrigin",null),i([p.property({type:[h],value:null,json:{write:!0}})],t.prototype,"lods",null),i([p.property({readOnly:!0})],t.prototype,"minScale",void 0),i([p.property({readOnly:!0})],t.prototype,"maxScale",void 0),i([p.property({readOnly:!0})],t.prototype,"scales",void 0),i([p.property({cast:function(e){return Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]}})],t.prototype,"size",void 0),i([p.reader("size",["rows","cols"])],t.prototype,"readSize",null),i([p.writer("size",{cols:{type:a.Integer},rows:{type:a.Integer}})],t.prototype,"writeSize",null),i([p.property({type:l.SpatialReference,json:{write:!0}})],t.prototype,"spatialReference",void 0),t=n=i([p.subclass("esri.layers.support.TileInfo")],t);var n}(p.declared(n))}));