// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/pbf","../../layers/graphics/optimizedFeatures"],(function(e,r,t,a,s,n){Object.defineProperty(r,"__esModule",{value:!0});var E=a.getLogger("esri.tasks.operations.pbfQueryUtils"),T=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],i=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],o=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],c=["upperLeft","lowerLeft"];function u(e){return T[e]}function S(e){return c[e]}function l(e){if(e>=o.length){var r=new t("query:parsing-pbf","Error while parsing FeatureSet PBF payload. Unknown GeometryType");E.error(r)}return o[e]}function g(e){var r;!function(e){e[e.TYPE=1]="TYPE",e[e.LENGTHS=2]="LENGTHS",e[e.COORDS=3]="COORDS"}(r||(r={}));for(var t=new n.OptimizedGeometry,a=t.coords;e.next();)switch(e.tag()){case r.COORDS:for(var s=e.getUInt32(),E=e.pos()+s,T=0;e.pos()<E;)a[T++]=e.getSInt64();break;case r.TYPE:case r.LENGTHS:default:e.skip()}return t}function I(e){var r;!function(e){e[e.TYPE=1]="TYPE",e[e.LENGTHS=2]="LENGTHS",e[e.COORDS=3]="COORDS"}(r||(r={}));for(var t=new n.OptimizedGeometry,a=t.coords,s=t.lengths;e.next();)switch(e.tag()){case r.LENGTHS:for(var E=e.getUInt32(),T=e.pos()+E;e.pos()<T;)s.push(e.getUInt32());break;case r.COORDS:for(var i=e.getUInt32(),o=(T=e.pos()+i,0);e.pos()<T;)a[o++]=e.getSInt64();break;case r.TYPE:default:e.skip()}return t}function p(e){var r;for(!function(e){e[e.STRING=1]="STRING",e[e.FLOAT=2]="FLOAT",e[e.DOUBLE=3]="DOUBLE",e[e.SINT32=4]="SINT32",e[e.UINT32=5]="UINT32",e[e.INT64=6]="INT64",e[e.UINT64=7]="UINT64",e[e.SINT64=8]="SINT64",e[e.BOOL=9]="BOOL"}(r||(r={}));e.next();)switch(e.tag()){case r.STRING:return e.getString();case r.FLOAT:return e.getFloat();case r.DOUBLE:return e.getDouble();case r.SINT32:return e.getSInt32();case r.UINT32:return e.getUInt32();case r.INT64:return e.getInt64();case r.UINT64:return e.getUInt64();case r.SINT64:return e.getSInt64();case r.BOOL:return e.getBool();default:return e.skip(),null}return null}function A(e){var r;!function(e){e[e.NAME=1]="NAME",e[e.TYPE=2]="TYPE",e[e.ALIAS=3]="ALIAS",e[e.SQL_TYPE=4]="SQL_TYPE",e[e.DOMAIN=5]="DOMAIN",e[e.DEFAULT_VALUE=6]="DEFAULT_VALUE"}(r||(r={}));for(var t,a={type:u(0)};e.next();)switch(e.tag()){case r.NAME:a.name=e.getString();break;case r.TYPE:a.type=u(e.getEnum());break;case r.ALIAS:a.alias=e.getString();break;case r.SQL_TYPE:a.sqlType=(t=e.getEnum(),i[t]);break;case r.DOMAIN:case r.DEFAULT_VALUE:e.skip();break;default:e.skip()}return a}function N(e,r){var t;!function(e){e[e.ATTRIBUTES=1]="ATTRIBUTES",e[e.GEOMETRY=2]="GEOMETRY",e[e.CENTROID=4]="CENTROID"}(t||(t={}));for(var a=new n.OptimizedFeature,s=0;e.next();)switch(e.tag()){case t.ATTRIBUTES:var E=e.getMessage(),T=r[s++].name;a.attributes[T]=p(E);break;case t.GEOMETRY:a.geometry=I(e.getMessage());break;case t.CENTROID:a.centroid=g(e.getMessage());break;default:e.skip()}return a}function _(e){var r;!function(e){e[e.X=1]="X",e[e.Y=2]="Y",e[e.M=3]="M",e[e.Z=4]="Z"}(r||(r={}));for(var t=[0,0];e.next();)switch(e.tag()){case r.X:t[0]=e.getDouble();break;case r.Y:t[1]=e.getDouble();break;case r.M:case r.Z:t.push(e.getDouble());break;default:e.skip()}return t}function R(e){var r;!function(e){e[e.X=1]="X",e[e.Y=2]="Y",e[e.M=3]="M",e[e.Z=4]="Z"}(r||(r={}));for(var t=[0,0];e.next();)switch(e.tag()){case r.X:t[0]=e.getDouble();break;case r.Y:t[1]=e.getDouble();break;case r.M:case r.Z:t.push(e.getDouble());break;default:e.skip()}return t}function L(e){var r;!function(e){e[e.ORIGIN_POSTION=1]="ORIGIN_POSTION",e[e.SCALE=2]="SCALE",e[e.TRANSLATE=3]="TRANSLATE"}(r||(r={}));for(var t,a,s=S(0);e.next();)switch(e.tag()){case r.ORIGIN_POSTION:s=S(e.getEnum());break;case r.SCALE:t=_(e.getMessage());break;case r.TRANSLATE:a=R(e.getMessage());break;default:e.skip()}return{originPosition:s,scale:t,translate:a}}function f(e){var r;!function(e){e[e.AREA_FIELD_NAME=1]="AREA_FIELD_NAME",e[e.LENGTH_FIELD_NAME=2]="LENGTH_FIELD_NAME",e[e.UNITS=3]="UNITS"}(r||(r={}));for(var t={};e.next();)switch(e.tag()){case r.AREA_FIELD_NAME:t.shapeAreaFieldName=e.getString();break;case r.LENGTH_FIELD_NAME:t.shapeLengthFieldName=e.getString();break;case r.UNITS:t.units=e.getString();break;default:e.skip()}return t}function y(e){var r;!function(e){e[e.WKID=1]="WKID",e[e.LASTEST_WKID=2]="LASTEST_WKID",e[e.VCS_WKID=3]="VCS_WKID",e[e.LATEST_VCS_WKID=4]="LATEST_VCS_WKID",e[e.WKT=5]="WKT"}(r||(r={}));for(var t={};e.next();)switch(e.tag()){case r.WKID:t.wkid=e.getUInt32();break;case r.WKT:t.wkt=e.getString();break;case r.LASTEST_WKID:case r.VCS_WKID:case r.LATEST_VCS_WKID:default:e.skip()}return t}function D(e){var r;!function(e){e[e.OBJECT_ID_NAME=1]="OBJECT_ID_NAME",e[e.UNIQUE_ID_NAME=2]="UNIQUE_ID_NAME",e[e.GLOBAL_ID_NAME=3]="GLOBAL_ID_NAME",e[e.GEOHASH_NAME=4]="GEOHASH_NAME",e[e.GEOMETRY_PROPERTIES=5]="GEOMETRY_PROPERTIES",e[e.SERVER_GENS=6]="SERVER_GENS",e[e.GEOMETRY_TYPE=7]="GEOMETRY_TYPE",e[e.SPATIAL_REFERENCE=8]="SPATIAL_REFERENCE",e[e.EXCEEDED_TRANSFER_LIMIT=9]="EXCEEDED_TRANSFER_LIMIT",e[e.HAS_Z=10]="HAS_Z",e[e.HAS_M=11]="HAS_M",e[e.TRANSFORM=12]="TRANSFORM",e[e.FIELDS=13]="FIELDS",e[e.FEATURES=15]="FEATURES"}(r||(r={}));var t=new n.OptimizedFeatureSet;for(t.geometryType=l(0);e.next();)switch(e.tag()){case r.OBJECT_ID_NAME:t.objectIdFieldName=e.getString();break;case r.GLOBAL_ID_NAME:t.globalIdFieldName=e.getString();break;case r.GEOHASH_NAME:t.geohashFieldName=e.getString();break;case r.GEOMETRY_PROPERTIES:t.geometryProperties=f(e.getMessage());break;case r.GEOMETRY_TYPE:t.geometryType=l(e.getEnum());break;case r.SPATIAL_REFERENCE:t.spatialReference=y(e.getMessage());break;case r.HAS_Z:t.hasZ=e.getBool();break;case r.HAS_M:t.hasM=e.getBool();break;case r.TRANSFORM:var a=e.getMessage();t.transform=L(a);break;case r.EXCEEDED_TRANSFER_LIMIT:var s=e.getBool();t.exceededTransferLimit=s;break;case r.FIELDS:var E=e.getMessage();t.fields.push(A(E));break;case r.FEATURES:var T=e.getMessage();t.features.push(N(T,t.fields));break;case r.UNIQUE_ID_NAME:case r.SERVER_GENS:default:e.skip()}return t}function O(e){var r;!function(e){e[e.FEATURE_RESULT=1]="FEATURE_RESULT"}(r||(r={}));for(var t={};e.next();)switch(e.tag()){case r.FEATURE_RESULT:t.featureResult=D(e.getMessage());break;default:e.skip()}return t}r.parsePBFFeatureQuery=function(e){try{return function(e){var r;!function(e){e[e.QUERY_RESULT=2]="QUERY_RESULT"}(r||(r={}));for(var t=new s(new Uint8Array(e),new DataView(e)),a={};t.next();)switch(t.tag()){case r.QUERY_RESULT:a.queryResult=O(t.getMessage());break;default:t.skip()}return a}(e).queryResult.featureResult}catch(e){var r=new t("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});return E.error(r),new n.OptimizedFeatureSet}}}));