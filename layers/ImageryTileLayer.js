/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../PopupTemplate","../rasterRenderers","../core/Error","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","./Layer","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/ImageryTileMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/TemporalLayer","./support/commonProperties","./support/Field","./support/rasterEnums","./support/rasterDatasets/FunctionRaster","./support/rasterDatasets/RasterFactory","./support/rasterFunctions/rasterFunctionHelper","../support/popupUtils"],(function(e,r,t,o,i,a,s,n,l,p,d,u,c,y,h,m,f,g,_,v,b,S,T,w,P,R,O,I,L,x,N){"use strict";let F=function(r){function t(...e){var t;return(t=r.call(this,...e)||this).bandIds=null,t.interpolation=null,t.legendEnabled=!0,t.isReference=null,t.listMode="show",t.sourceJSON=null,t.version=null,t.title=null,t.type="imagery-tile",t.operationalLayerType="ArcGISTiledImageServiceLayer",t.popupEnabled=!0,t.popupTemplate=null,t.fields=null,t}e._inheritsLoose(t,r);var s=t.prototype;return s.normalizeCtorArgs=function(e,r){return"string"==typeof e?{url:e,...r}:e},s.load=function(e){const r=a.isSome(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(n.throwIfAbortError).then((()=>this._openRaster(r)))),Promise.resolve(this)},s.readRenderer=function(e,r,t){const i=r&&r.layerDefinition&&r.layerDefinition.drawingInfo&&r.layerDefinition.drawingInfo.renderer,a=o.read(i,t)||void 0;if(null!=a)return a},s.createPopupTemplate=function(e){return N.createPopupTemplate({fields:this.rasterFields,title:this.title},e)},s.write=function(e,t){const{raster:o}=this;if(this.loaded?"RasterTileServer"===o.datasetFormat&&("Raster"===o.tileType||"Map"===o.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return r.prototype.write.call(this,e,t);if(t&&t.messages){const e=`${t.origin}/${t.layerContainerType||"operational-layers"}`;t.messages.push(new i("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e}'`,{layer:this}))}return null},s._openRaster=function(){var r=e._asyncToGenerator((function*(e){if(this.raster)this.raster.rasterInfo||(yield this.raster.open()),this.url=this.raster.url;else{const r=yield L.open({url:this.url,sourceJSON:this.sourceJSON,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters},signal:e});if(this.rasterFunction){const e=x.create(this.rasterFunction.toJSON(),{raster:r}),t=new I({rasterFunction:e});yield t.open(),this.raster=t}else this.raster=r}const{rasterInfo:r}=this.raster;if(!r)throw new i("imagery-tile-layer:load","cannot load resources on "+this.url);if(this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON){const e="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:{...this.sourceJSON,minScale:0,maxScale:0};this.read(e,{origin:"service"})}null==this.title&&(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles(l.watch((()=>this.customParameters),(e=>{this.raster.ioConfig.customFetchParameters=e})))}));function t(e){return r.apply(this,arguments)}return t}(),e._createClass(t,[{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){let e=[new R({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})];const{rasterInfo:r}=this,{attributeTable:t}=r,o=a.isSome(t)?t.fields:null,i="Raster.";if(o){const r=o.filter((e=>"oid"!==e.type&&"value"!==e.name.toLowerCase())).map((e=>{const r=e.clone();return r.name=i+e.name,r}));e=e.concat(r)}const{dataType:s,multidimensionalInfo:n}=r;if(("vector-magdir"===s||"vector-uv"===s)&&a.isSome(n)){const r=n.variables[0].unit?.trim(),t="Magnitude"+(r?` (${r})`:"");e.push(new R({name:"Raster.Magnitude",alias:t,domain:null,editable:!1,type:"double"})),e.push(new R({name:"Raster.Direction",alias:"Direction (Â°)",domain:null,editable:!1,type:"double"}))}return e}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}}]),t}(f.BlendLayer(T.ScaleRangeLayer(v.OperationalLayer(b.PortalLayer(g.CustomParametersMixin(_.ImageryTileMixin(w.TemporalLayer(S.RefreshableLayer(s.MultiOriginJSONMixin(m))))))))));r.__decorate([p.property({type:[u.Integer],json:{write:{overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==this.bandIds?.join(",")}}}}})],F.prototype,"bandIds",void 0),r.__decorate([p.property({json:{write:{overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),c.enumeration(O.interpolationKebab)],F.prototype,"interpolation",void 0),r.__decorate([p.property({json:{write:!0}})],F.prototype,"multidimensionalDefinition",void 0),r.__decorate([p.property(P.legendEnabled)],F.prototype,"legendEnabled",void 0),r.__decorate([p.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],F.prototype,"isReference",void 0),r.__decorate([p.property({type:["show","hide"]})],F.prototype,"listMode",void 0),r.__decorate([p.property({json:{read:!0,write:!0}})],F.prototype,"blendMode",void 0),r.__decorate([p.property()],F.prototype,"sourceJSON",void 0),r.__decorate([p.property({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],F.prototype,"version",void 0),r.__decorate([p.property()],F.prototype,"title",void 0),r.__decorate([p.property({readOnly:!0,json:{read:!1}})],F.prototype,"type",void 0),r.__decorate([p.property({type:["ArcGISTiledImageServiceLayer"]})],F.prototype,"operationalLayerType",void 0),r.__decorate([p.property({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,r)=>!r.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer(e,r,t){r[t]=!e}}}})],F.prototype,"popupEnabled",void 0),r.__decorate([p.property({type:t,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],F.prototype,"popupTemplate",void 0),r.__decorate([p.property({readOnly:!0})],F.prototype,"defaultPopupTemplate",null),r.__decorate([p.property({readOnly:!0,type:[R]})],F.prototype,"fields",void 0),r.__decorate([p.property({readOnly:!0,type:[R]})],F.prototype,"rasterFields",null),r.__decorate([p.property({types:o.rasterRendererTypes,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){const e="raster-stretch"===this.renderer?.type&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!e}}},origins:{"web-scene":{types:o.websceneRasterRendererTypes,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type&&"flow"!==e.type})}}}}})],F.prototype,"renderer",null),r.__decorate([y.reader("renderer")],F.prototype,"readRenderer",null),F=r.__decorate([h.subclass("esri.layers.ImageryTileLayer")],F);return F}));
