// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//find copyright info according to AccessConstraints

define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/sniff","dojox/xml/parser","../kernel","../lang","../request","../WKIDUnitConversion","../SpatialReference","../geometry/Point","../geometry/Extent","../geometry/webMercatorUtils","./TiledMapServiceLayer","./TileInfo","./WMTSLayerInfo","dojo/query"],function(e,t,i,r,s,l,o,a,n,h,f,u,d,g,p,c,_){var y=t([p],{declaredClass:"esri.layers.WMTSLayer",copyright:null,extent:null,tileUrl:null,spatialReference:null,tileInfo:null,constructor:function(e,t){if(this.version="1.0.0",this.tileUr=this._url=e,this.serviceMode="RESTful",this._parseCapabilities=i.hitch(this,this._parseCapabilities),this._getCapabilitiesError=i.hitch(this,this._getCapabilitiesError),t||(t={}),t.serviceMode){if("KVP"!==t.serviceMode&&"RESTful"!==t.serviceMode)return void console.error("WMTS mode could only be 'KVP' or 'RESTful'");this.serviceMode=t.serviceMode}this.layerInfo=new _,t.layerInfo&&(this.layerInfo=t.layerInfo,this._identifier=t.layerInfo.identifier,this._tileMatrixSetId=t.layerInfo.tileMatrixSet,t.layerInfo.format&&(this.format="image/"+t.layerInfo.format),this._style=t.layerInfo.style,this.title=t.layerInfo.title,this._dimension=t.layerInfo.dimension),t.resourceInfo?(this.version=t.resourceInfo.version,t.resourceInfo.getTileUrl&&(this._url=this.tileUrl=t.resourceInfo.getTileUrl),this.copyright=t.resourceInfo.copyright,this.layerInfos=t.resourceInfo.layerInfos,this._parseResourceInfo(),this.loaded=!0,this.onLoad(this)):this._getCapabilities(),this._formatDictionary={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""}},setActiveLayer:function(e){this.setVisibleLayer(e)},setVisibleLayer:function(e){this._setActiveLayer(e),this.refresh(!0)},getTileUrl:function(e,t,i){e=this._levelToLevelValue[e];var r;return r=this.resourceUrls&&this.resourceUrls.length>0?this.resourceUrls[t%this.resourceUrls.length].template.replace(/\{Style\}/gi,this._style).replace(/\{TileMatrixSet\}/gi,this._tileMatrixSetId).replace(/\{TileMatrix\}/gi,e).replace(/\{TileRow\}/gi,t).replace(/\{TileCol\}/gi,i).replace(/\{dimensionValue\}/gi,this._dimension):this.UrlTemplate.replace(/\{level\}/gi,e).replace(/\{row\}/gi,t).replace(/\{col\}/gi,i),r=this.addTimestampToURL(r)},getTileUrlTemplate:function(e){var t,i=e.identifier,s=e.tileMatrixSet,l=e.format,o=e.style,a=e.dimension;if(i?t=r.filter(this.layers,function(e){return e.identifier===i})[0]:(t=this.layers[0],i=this.layers[0].identifier),!t)return console.error("couldn't find the layer "+i),void this.onError(new Error("couldn't find the layer "+i));if(l){if(-1===l.indexOf("image/")&&(l="image/"+l),-1===r.indexOf(t.formats,l))return console.error("The layer doesn't support the format of "+l),void this.onError(new Error("The layer doesn't support the format of "+l))}else l=t.formats[0],-1===l.indexOf("image/")&&(l="image/"+l);if(o){if(-1===r.indexOf(t.styles,o))return console.error("The layer doesn't support the style of "+o),void this.onError(new Error("The layer doesn't support the style of "+o))}else o=t.styles[0];if(!a&&t.dimensions)a=t.dimensions[0];else if(-1===r.indexOf(t.dimensions,a))return console.error("The layer doesn't support the dimension of "+a),void this.onError(new Error("The layer doesn't support the dimension of "+a));var n;if(s){if(n=r.filter(t.tileMatrixSetInfos,function(e){return e.tileMatrixSet===s})[0],!n)return console.error("The tileMatrixSetId "+s+" is not supported by the layer of "+i),void this.onError(new Error("The tileMatrixSetId "+s+" is not supported by the layer of "+i))}else n=r.filter(t.tileMatrixSetInfos,function(e){return"GoogleMapsCompatible"===e.tileMatrixSet})[0],n||(n=t.tileMatrixSetInfos[0]),s=n.tileMatrixSet;return this._getTileUrlTemplate(i,s,l,o,a)},_getTileUrlTemplate:function(e,t,i,r,s){var l;if(e||(e=this._identifier),t||(t=this._tileMatrixSetId),i||(i=this.format),r||""===r||(r=this._style),this.resourceUrls&&this.resourceUrls.length>0)return l=this.resourceUrls[0].template,l.indexOf(".xxx")===l.length-4&&(l=l.slice(0,l.length-4)),l=l.replace(/\{Style\}/gi,r),l=l.replace(/\{TileMatrixSet\}/gi,t),l=l.replace(/\{TileMatrix\}/gi,"{level}"),l=l.replace(/\{TileRow\}/gi,"{row}"),l=l.replace(/\{TileCol\}/gi,"{col}"),l=l.replace(/\{dimensionValue\}/gi,s);if("KVP"===this.serviceMode)l=this._url+"SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile&LAYER="+e+"&STYLE="+r+"&FORMAT="+i+"&TILEMATRIXSET="+t+"&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}";else if("RESTful"===this.serviceMode){var o="";this._formatDictionary[i.toLowerCase()]&&(o=this._formatDictionary[i.toLowerCase()]),l=this._url+e+"/"+r+"/"+t+"/{level}/{row}/{col}"+o}return l},_parseResourceInfo:function(){var e,t=this.layerInfos;for("KVP"===this.serviceMode&&(this._url+=this._url.indexOf("?")>-1?"":"?"),e=0;e<t.length;e++)if(!(this._identifier&&t[e].identifier!==this._identifier||this.title&&t[e].title!==this.title||this._tileMatrixSetId&&t[e].tileMatrixSet!==this._tileMatrixSetId||this.format&&"image/"+t[e].format!==this.format||this._style&&t[e].style!==this._style)){i.mixin(this,{description:t[e].description,tileInfo:t[e].tileInfo,spatialReference:t[e].tileInfo.spatialReference,fullExtent:t[e].fullExtent,initialExtent:t[e].initialExtent,_identifier:t[e].identifier,_tileMatrixSetId:t[e].tileMatrixSet,format:"image/"+t[e].format,_style:t[e].style});break}this._setActiveLayer(),this.UrlTemplate=this._getTileUrlTemplate(),this._levelToLevelValue=[],r.forEach(this.tileInfo.lods,function(e){this._levelToLevelValue[e.level]=e.levelValue?e.levelValue:e.level},this)},_getCapabilities:function(){var e;"KVP"===this.serviceMode?e=this._url.indexOf("?")>-1?this._url+"&request=GetCapabilities&service=WMTS&version="+this.version:this._url+"?request=GetCapabilities&service=WMTS&version="+this.version:"RESTful"===this.serviceMode&&(e=this._url+"/"+this.version+"/WMTSCapabilities.xml"),n({url:e,handleAs:"text",load:this._parseCapabilities,error:this._getCapabilitiesError})},_parseCapabilities:function(t){t=t.replace(/ows:/gi,"");var i=l.parse(t),s=e.query("Contents",i)[0];if(!s)return console.error("The WMTS capabilities XML is not valid"),void this.onError(new Error("The WMTS capabilities XML is not valid"));var o,a=e.query("OperationsMetadata",i)[0],n=e.query("[name='GetTile']",a)[0],h=this._url,f=e.query("Get",n);for(o=0;o<f.length;o++){var u=e.query("Constraint",f[o])[0];if(!u||this._getTagWithChildTagValue("AllowedValues","Value",this.serviceMode,u)){h=f[o].attributes[0].nodeValue;break}}-1===h.indexOf("/1.0.0/")&&"RESTful"===this.serviceMode&&(h+="/"),"KVP"===this.serviceMode&&(h+=h.indexOf("?")>-1?"":"?"),this._url=h,this.copyright=this._getTagValues("Capabilities>ServiceIdentification>AccessConstraints",i)[0];var d,g=e.query("Layer",s),p=[];this.layers=[],r.forEach(g,function(e){d=this._getTagValues("Identifier",e)[0],p.push(d),this.layers.push(this._getWMTSLayerInfo(d,e,s))},this),this._setActiveLayer(),this.loaded=!0,this.onLoad(this)},_setActiveLayer:function(e){if(e||(e={}),e.identifier&&(this._identifier=e.identifier),e.tileMatrixSet&&(this._tileMatrixSetId=e.tileMatrixSet),e.format&&(this.format=e.format),e.style&&(this._style=e.style),e.dimension&&(this._dimension=e.dimension),this.layers){var t;if(this._identifier?t=r.filter(this.layers,function(e){return e.identifier===this._identifier},this)[0]:(t=this.layers[0],this._identifier=this.layers[0].identifier),!t)return console.error("couldn't find the layer "+this._identifier),void this.onError(new Error("couldn't find the layer "+this._identifier));if(this.format){if(-1===this.format.indexOf("image/")&&(this.format="image/"+this.format),-1===r.indexOf(t.formats,this.format))return console.error("The layer doesn't support the format of "+this.format),void this.onError(new Error("The layer doesn't support the format of "+this.format))}else this.format=t.formats[0],-1===this.format.indexOf("image/")&&(this.format="image/"+this.format);if(this._style){if(-1===r.indexOf(t.styles,this._style))return console.error("The layer doesn't support the style of "+this._style),void this.onError(new Error("The layer doesn't support the style of "+this._style))}else this._style=t.styles[0];if(!this._dimension&&t.dimensions)this._dimension=t.dimensions[0];else if(-1===r.indexOf(t.dimensions,this._dimension))return console.error("The layer doesn't support the dimension of "+this._dimension),void this.onError(new Error("The layer doesn't support the dimension of "+this._dimension));var i;if(this._tileMatrixSetId){if(i=r.filter(t.tileMatrixSetInfos,function(e){return e.tileMatrixSet===this._tileMatrixSetId},this)[0],!i)return console.error("The tileMatrixSetId "+this._tileMatrixSetId+" is not supported by the layer of "+this._identifier),void this.onError(new Error("The tileMatrixSetId "+this._tileMatrixSetId+" is not supported by the layer of "+this._identifier))}else i=r.filter(t.tileMatrixSetInfos,function(e){return"GoogleMapsCompatible"===e.tileMatrixSet})[0],i||(i=t.tileMatrixSetInfos[0]),this._tileMatrixSetId=i.tileMatrixSet;this.description=t.description,this.title=t.title,this.spatialReference=i.tileInfo.spatialReference,this.tileInfo=i.tileInfo,this._levelToLevelValue=[],r.forEach(this.tileInfo.lods,function(e){this._levelToLevelValue[e.level]=e.levelValue?e.levelValue:e.level},this),102100===this.spatialReference.wkid||102113===this.spatialReference.wkid?this.fullExtent=this.initialExtent=g.geographicToWebMercator(t.gcsExtent):4326===this.spatialReference.wkid?this.fullExtent=this.initialExtent=t.gcsExtent:(this.fullExtent=i.fullExtent,this.initialExtent=i.initialExtent),this.resourceUrls=t.resourceUrls,this.UrlTemplate=this._getTileUrlTemplate(),this.layerInfo={identifier:this._identifier,tileMatrixSet:this._tileMatrixSetId,format:this.format,style:this._style,fullExtent:this.fullExtent,initialExtent:this.initialExtent,tileInfo:this.tileInfo,title:this.title,description:this.description}}},_getWMTSLayerInfo:function(t,i,s){var l,o=this._getTagValues("Abstract",i)[0],a=this._getTagValues("Title",i)[0],n=e.query("WGS84BoundingBox",i)[0],h=n?this._getTagValues("LowerCorner",n)[0].split(" "):["-180","-90"],u=n?this._getTagValues("UpperCorner",n)[0].split(" "):["180","90"],g=parseFloat(h[0]),p=parseFloat(h[1]),c=parseFloat(u[0]),_=parseFloat(u[1]),y=new d(g,p,c,_,new f({wkid:4326})),T=this._getTagValues("Identifier",e.query("Style",i)[0]),x=this._getTagValues("Identifier",e.query("Dimension",i)[0]),m=this._getTagValues("Value",e.query("Dimension",i)[0])||this._getTagValues("Default",e.query("Dimension",i)[0]),v=this._getTagValues("Format",i),M=this._getLayerMatrixInfos(i,s),I={identifier:t,tileMatrixSetInfos:M,formats:v,styles:T,title:a,description:o,gcsExtent:y,dimensions:m},E=e.query("ResourceURL",i),S=[];return r.forEach(E,function(e){l=e.getAttribute("template"),x&&m&&(l=l.replace("{"+x+"}","{dimensionValue}")),S.push({template:l,format:e.getAttribute("format"),resourceType:e.getAttribute("resourceType")})}),S&&S.length>0&&(I.resourceUrls=S),I},_getLayerMatrixInfos:function(e,t){var i,s=[];this._allMatrixInfos||(this._allMatrixInfos=[]);var l=this._getTagValues("TileMatrixSet",e);if(l&&0!==l.length)return r.forEach(l,function(r){var l;if(this._allMatrixInfos.length>0)for(i=0;i<this._allMatrixInfos.length;i++)if(this._allMatrixInfos[i].tileMatrixSet==r){l=this._allMatrixInfos[i];break}l||(l=this._getLayerMatrixInfo(r,e,t),this._allMatrixInfos.push(l)),s.push(l)},this),s},_getLayerMatrixInfo:function(t,i,r){var s,l,o,a,n,h,g=[],p=this._getTagWithChildTagValue("TileMatrixSetLink","TileMatrixSet",t,i),_=this._getTagValues("TileMatrix",p),y=this._getTagWithChildTagValue("TileMatrixSet","Identifier",t,r),T=this._getTagValues("SupportedCRS",y)[0];s=parseInt(T.split(":").pop(),10),(900913==s||3857==s)&&(s=102100);var x;T.toLowerCase().indexOf("crs84")>-1||T.toLowerCase().indexOf("crs:84")>-1?(s=4326,x=!0):T.toLowerCase().indexOf("crs83")>-1||T.toLowerCase().indexOf("crs:83")>-1?(s=4269,x=!0):(T.toLowerCase().indexOf("crs27")>-1||T.toLowerCase().indexOf("crs:27")>-1)&&(s=4267,x=!0);var m=new f({wkid:s}),v=e.query("TileMatrix",y)[0];l=parseInt(this._getTagValues("TileWidth",v)[0],10),o=parseInt(this._getTagValues("TileHeight",v)[0],10);var M=this._getTagValues("TopLeftCorner",v)[0].split(" "),I=M[0],E=M[1];if(I.split("E").length>1){var S=I.split("E");I=S[0]*Math.pow(10,S[1])}if(E.split("E").length>1){var V=E.split("E");E=V[0]*Math.pow(10,V[1])}I=parseFloat(I),E=parseFloat(E);var L=x&&4326===s&&90===I&&-180===E;for(a=0;a<this._flippingAxisForWkids.length;a++)if(T.split(":").pop()>=this._flippingAxisForWkids[a][0]&&T.split(":").pop()<=this._flippingAxisForWkids[a][1]||4326===s&&(!x||L)){4326===s&&I>90&&(I="90"),n=new u(E,I,m);break}if(a===this._flippingAxisForWkids.length&&(n=new u(I,E,m)),0===_.length){var w=e.query("TileMatrix",y);for(a=0;a<w.length;a++)h=this._getLodFromTileMatrix(w[a],s,a,t),g.push(h)}else for(a=0;a<_.length;a++){var b=this._getTagWithChildTagValue("TileMatrix","Identifier",_[a],y);h=this._getLodFromTileMatrix(b,s,a,t),g.push(h)}var C,R,U,q,O,W,A,F,k,j=e.query("BoundingBox",y)[0];if(j&&(C=this._getTagValues("LowerCorner",j)[0].split(" "),R=this._getTagValues("UpperCorner",j)[0].split(" ")),C&&C.length>1&&R&&R.length>1)U=parseFloat(C[0]),O=parseFloat(C[1]),q=parseFloat(R[0]),W=parseFloat(R[1]);else{var D=this._getTagValues("MatrixWidth",v)[0],P=this._getTagValues("MatrixHeight",v)[0];U=n.x,W=n.y,q=U+D*o*g[0].resolution,O=W-P*l*g[0].resolution}A=new d(U,O,q,W,m),F=k=A;var G=new c({dpi:90.71428571428571,spatialReference:m,format:this.format,rows:l,cols:o,origin:n,lods:g}),K={tileMatrixSet:t,fullExtent:F,initialExtent:k,tileInfo:G};return K},_getCapabilitiesError:function(e){console.error("Failed to get capabilities xml"),this.onError(e)},_getLodFromTileMatrix:function(e,t,i,r){var s=this._getTagValues("Identifier",e)[0],l=this._getTagValues("ScaleDenominator",e)[0];if(l.split("E").length>1){var o=l.split("E");l=o[0]*Math.pow(10,o[1])}else l=parseFloat(l);var n;n=a.isDefined(h[t])?h.values[h[t]]:"default028mm"===r?6370997*Math.PI/180:6378137*Math.PI/180;var f=7*l/25e3/n,u={level:i,levelValue:s,scale:l,resolution:f};return u},_getTag:function(t,i){var r=e.query(t,i);return r&&r.length>0?r[0]:null},_getTagValues:function(t,i){var l,o,a,n=[],h=t.split(">");if(l=e.query(h[0],i)[0],h.length>1){for(a=1;a<h.length-1;a++)l=e.query(h[a],l)[0];o=e.query(h[h.length-1],l)}else o=e.query(h[0],i);return o&&o.length>0&&r.forEach(o,function(e){n.push(s("ie")<9?e.childNodes.length?e.childNodes[0].nodeValue:"":e.textContent)}),n},_getAttributeValues:function(t,i,s){var l=e.query(t,s),o=[];return l&&l.length>0&&r.forEach(l,function(e){o.push(e.getAttribute(i))}),o},_getTagWithChildTagValue:function(t,i,r,l){var o,n,h=l.childNodes;for(n=0;n<h.length;n++)if(h[n].nodeName.indexOf(t)>-1&&(s("ie")<9?a.isDefined(e.query(i,h[n])[0])&&(o=e.query(i,h[n])[0].childNodes[0].nodeValue):a.isDefined(e.query(i,h[n])[0])&&(o=e.query(i,h[n])[0].textContent),o===r||r.split(":")&&o===r.split(":")[1]))return h[n]},_flippingAxisForWkids:[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700],[900913,900913]]});return s("extend-esri")&&i.setObject("layers.WMTSLayer",y,o),y});