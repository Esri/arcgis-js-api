/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../geometry","../core/Collection","../core/Error","../core/Logger","../core/promiseUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/accessorSupport/decorators/subclass","../geohash/geohashUtils","./Layer","./graphics/featureConversionUtils","./graphics/OptimizedGeometry","./knowledgeGraph/KnowledgeGraphLayerDataManager","./knowledgeGraph/KnowledgeGraphSubLayer","./mixins/BlendLayer","./mixins/ScaleRangeLayer","../libs/linkchartlayout/LinkChartLayout","../rest/knowledgeGraphService","../rest/knowledgeGraph/EntityType","../rest/knowledgeGraph/RelationshipType","../geometry/Extent","../geometry/Point","../geometry/Polyline"],(function(e,t,a,i,n,o,r,s,l,h,c,u,d,y,p,f,E,_,g,M,C,m,L,D,k,I){"use strict";let O=function(t){function a(e){var a;if((a=t.call(this,e)||this).dataPreloadedInLocalCache=!1,a.layers=new i,a.linkChartDiagramLookup=new Map,a.linkChartExtent=new D({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),a.linkChartGeohashLookup=new Map,a.sublayerIdsCache=new Map,a.tables=new i,a.type="link-chart",a._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new n("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");return a}e._inheritsLoose(a,t);var s=a.prototype;return s.normalizeCtorArgs=function(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}},s._initializeLayerProperties=function(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set,a=new Map;let i=[],r=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new n("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes?e.knowledgeGraph.dataModel.entityTypes:[],r=e.knowledgeGraph.dataModel.relationshipTypes?e.knowledgeGraph.dataModel.relationshipTypes:[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?(e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&a.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&a.set(e.name,e)})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((n,s)=>{if(!a.get(s))return o.getLogger(this.declaredClass).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);a.get(s)instanceof L||"strictOrigin"in a.get(s)?t.has(s)||(t.add(s),r.push(a.get(s))):a.get(s)instanceof m||"properties"in a.get(s)?t.has(s)||(t.add(s),i.push(a.get(s))):(o.getLogger(this.declaredClass).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}))):(i=e.knowledgeGraph.dataModel.entityTypes?e.knowledgeGraph.dataModel.entityTypes:[],r=e.knowledgeGraph.dataModel.relationshipTypes?e.knowledgeGraph.dataModel.relationshipTypes:[]);const s=new f.KnowledgeGraphLayerDataManager({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=r,this.dataManager=s},s.load=function(t){var a=this;return this.addResolvingPromise(new Promise((i=>{C.fetchKnowledgeGraph(this.url).then((n=>{if(this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((t=>{t.useAllData=!1,t.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof p?e.linkChartLocation:e.linkChartLocation?y.convertFromGeometry(e.linkChartLocation):null,this.linkChartDiagramLookup.set(e.id,t),t&&2===t.coords.length&&0===t.lengths.length?this.linkChartGeohashLookup.set(e.id,u.encodeGeohash(t.coords[1],t.coords[0],f.GEOHASH_ENCODING_PRECISION)):this.linkChartGeohashLookup.set(e.id,"")})),this.addResolvingPromise(this._initializeDiagram().then(e._asyncToGenerator((function*(){a.layers.forEach(function(){var t=e._asyncToGenerator((function*(e){yield e.refreshCachedQueryEngine()}));return function(e){return t.apply(this,arguments)}}()),a.tables.forEach(function(){var t=e._asyncToGenerator((function*(e){yield e.refreshCachedQueryEngine()}));return function(e){return t.apply(this,arguments)}}())}))))}));else{const i="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!0,i).then(e._asyncToGenerator((function*(){r.throwIfAborted(t);const i=[],n=[];a.loadLayerAssumingLocalCache(),a.dataManager.inclusionModeDefinition&&(a.dataManager.inclusionModeDefinition.generateAllSublayers=!1,a.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),yield a._initializeDiagram(),a.layers.forEach(function(){var t=e._asyncToGenerator((function*(t){n.push(t.refreshCachedQueryEngine()),i.push(new Promise((a=>{t.on("layerview-create",e._asyncToGenerator((function*(){a(null)})))})))}));return function(e){return t.apply(this,arguments)}}()),a.tables.forEach(function(){var t=e._asyncToGenerator((function*(e){n.push(e.refreshCachedQueryEngine())}));return function(e){return t.apply(this,arguments)}}()),yield Promise.all(n),Promise.all(i).then(e._asyncToGenerator((function*(){a.dataManager.refreshCacheContent().then(e._asyncToGenerator((function*(){a.layers.forEach((e=>{e.refreshCachedQueryEngine()})),a.tables.forEach((e=>{e.refreshCachedQueryEngine()}))})))})))}))))}i(null)}))}))),Promise.resolve(this)},s.loadLayerAssumingLocalCache=function(){this.memberEntityTypes.forEach((e=>{const t=new E({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberRelationshipTypes.forEach((e=>{const t=new E({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{e.members?.forEach((e=>{if(this.sublayerIdsCache.has(t)?this.sublayerIdsCache.get(t)?.push(e.id):this.sublayerIdsCache.set(t,[e.id]),e.linkChartLocation)if(e.linkChartLocation instanceof p)this.linkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,u.encodeGeohash(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],f.GEOHASH_ENCODING_PRECISION)):this.linkChartGeohashLookup.set(e.id,"");else{const t=y.convertFromGeometry(e.linkChartLocation);this.linkChartDiagramLookup.set(e.id,e.linkChartLocation?t:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,u.encodeGeohash(e.linkChartLocation.x,e.linkChartLocation.y,f.GEOHASH_ENCODING_PRECISION)):this.linkChartGeohashLookup.set(e.id,"")}}))})),Array.from(this.sublayerIdsCache.values()).forEach((e=>e.sort()))},s.calculateLinkChartLayout=function(){var t=e._asyncToGenerator((function*(e="RADIAL_TREE",t){const a=[],i=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{a.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{i.push({typeName:t,feature:e})}))})),this.linkChartDiagramLookup=new Map;const r=new Map,s=new Map,l=new Map,h=new Map,c=new Uint8Array(a.length),d=new Float64Array(a.length),p=new Float64Array(a.length),E=new Uint32Array(i.length),_=new Uint32Array(i.length),g=[],C=t?.geographicStrategy?t.geographicStrategy:"FORCE_DIRECTED",m=t?.xScaleFactor?t.xScaleFactor:1,L=t?.yScaleFactor?t.yScaleFactor:1,O=new D({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let T,b="FORCE_DIRECTED",G=0,A=0;switch(b="GEOGRAPHIC"===e?C:e,b){case"FORCE_DIRECTED":T=M.LCForceDirectedLayout.apply;break;case"COMMUNITY":T=M.LCCommunityLayout.apply;break;case"HIERARCHICAL":T=M.LCHierarchicalLayout.apply;break;case"RADIAL_TREE":T=M.LCRadialTreeLayout.apply;break;case"SMART_TREE":T=M.LCSmartTreeLayout.apply;break;default:T=M.LCSimpleLayout.apply}a.forEach((({typeName:a,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[f.MOCK_OID_FIELD_NAME])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)?c[G]=M.NodeFlag.IsGeographic:c[G]=M.NodeFlag.None;const n=t.lockedNodeLocations.get(i.attributes[f.MOCK_OID_FIELD_NAME]);d[G]=n.x,p[G]=n.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)){c[G]=M.NodeFlag.IsGeographic;let e=null;const t=i.attributes[this.dataManager.geographicLookup.get(a).name],n=this.dataManager.geographicLookup.get(a)?.geometryType;switch(n){case"esriGeometryPoint":d[G]=t?.x,p[G]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,e?.x&&e?.y?(d[G]=e?.x,p[G]=e?.y):c[G]=M.NodeFlag.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,e?.x&&e?.y?(d[G]=e?.x,p[G]=e?.y):c[G]=M.NodeFlag.IsMovable;break;default:c[G]=M.NodeFlag.IsMovable}d[G]||(d[G]=0),p[G]||(p[G]=0)}else c[G]=M.NodeFlag.IsMovable,d[G]=0,p[G]=0;h.set(i.attributes[f.MOCK_OID_FIELD_NAME],G),g[G]={feature:i,typeName:a},G++})),i.forEach((e=>{const t=h.get(e.feature.attributes[f.MOCK_ORIGIN_ID_FIELD_NAME]),a=h.get(e.feature.attributes[f.MOCK_DESTINATION_ID_FIELD_NAME]);void 0!==t&&void 0!==a?(E[A]=t,_[A]=a,A++):(o.getLogger(this.declaredClass).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members.  The diagram geometry will be set to null"),this.linkChartDiagramLookup.set(e.feature.attributes[f.MOCK_ORIGIN_ID_FIELD_NAME],null),this.linkChartGeohashLookup.set(e.feature.attributes[f.MOCK_ORIGIN_ID_FIELD_NAME],null))})),yield M.load();if(!T(c,d,p,E,_))throw new n("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let n=0;n<g.length;n++){if(p[n]>80&&(p[n]=80),p[n]<-80&&(p[n]=-80),c[n]===M.NodeFlag.IsMovable?g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]=new k(d[n]*m,p[n]*L):g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]=new k(d[n],p[n]),r.has(g[n].typeName)){r.get(g[n].typeName)?.set(g[n].feature.attributes[f.MOCK_OID_FIELD_NAME],g[n].feature)}else{const e=new Map;e.set(g[n].feature.attributes[f.MOCK_OID_FIELD_NAME],g[n].feature),r.set(g[n].typeName,e)}l.set(g[n].feature.attributes[f.MOCK_OID_FIELD_NAME],g[n].feature);const e=y.convertFromGeometry(g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]);this.linkChartDiagramLookup.set(g[n].feature.attributes[f.MOCK_OID_FIELD_NAME],g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]?e:null),this.linkChartGeohashLookup.set(g[n].feature.attributes[f.MOCK_OID_FIELD_NAME],u.encodeGeohash(g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].y,g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].x,f.GEOHASH_ENCODING_PRECISION)),g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].x<O.xmin&&(O.xmin=g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].x),g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].x>O.xmax&&(O.xmax=g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].x),g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].y<O.ymin&&(O.ymin=g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].y),g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].y>O.ymax&&(O.ymax=g[n].feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME].y)}return this.linkChartExtent.xmin=O.xmin,this.linkChartExtent.xmax=O.xmax,this.linkChartExtent.ymin=O.ymin,this.linkChartExtent.ymax=O.ymax,i.forEach((e=>{const t=g[h.get(e.feature.attributes[f.MOCK_ORIGIN_ID_FIELD_NAME])]?.feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME],a=g[h.get(e.feature.attributes[f.MOCK_DESTINATION_ID_FIELD_NAME])]?.feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME];if(!t||!a)return;const i=new I({paths:[[t.x,t.y],[a.x,a.y]]});if(e.feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]=i,s.has(e.typeName)){s.get(e.typeName)?.set(e.feature.attributes[f.MOCK_OID_FIELD_NAME],e.feature)}else{const t=new Map;t.set(e.feature.attributes[f.MOCK_OID_FIELD_NAME],e.feature),s.set(e.typeName,t)}l.set(e.feature.attributes[f.MOCK_OID_FIELD_NAME],e.feature);const n=y.convertFromGeometry(e.feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]);this.linkChartDiagramLookup.set(e.feature.attributes[f.MOCK_OID_FIELD_NAME],e.feature.attributes[f.MOCK_LAYOUT_GEOMETRY_FIELD_NAME]?n:null),this.linkChartGeohashLookup.set(e.feature.attributes[f.MOCK_OID_FIELD_NAME],"")})),{nodes:r,links:s,idMap:l}}));function a(){return t.apply(this,arguments)}return a}(),s.applyNewLinkChartLayout=function(){var t=e._asyncToGenerator((function*(e="RADIAL_TREE",t){const a=[];yield this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine())})),yield Promise.all(a),this.layers.forEach((e=>{e.emit("refresh",{dataChanged:!0})}))}));function a(){return t.apply(this,arguments)}return a}(),s.synchronizeInclusionListWithCache=function(){var t=e._asyncToGenerator((function*(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const a=Array.from(this.dataManager.sublayerCaches.get(t).keys());Array.from(e.members.keys()).filter((e=>!a.includes(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}));function a(){return t.apply(this,arguments)}return a}(),s._initializeDiagram=function(){var t=e._asyncToGenerator((function*(){if(this.defaultLinkChartConfig)if(this.defaultLinkChartConfig.doNotRecalculateLayout)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e=>{e?.members?.forEach((e=>{const t=e.linkChartLocation;let a;const i=e.id;if(!t)return;a="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]};const n=y.convertFromGeometry(a);this.linkChartDiagramLookup.set(i,n),this.linkChartGeohashLookup.set(i,u.encodeGeohash(a.x,a.y,f.GEOHASH_ENCODING_PRECISION)),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.linkChartDiagramLookup.get(e.attributes[f.MOCK_ORIGIN_ID_FIELD_NAME]),a=this.linkChartDiagramLookup.get(e.attributes[f.MOCK_DESTINATION_ID_FIELD_NAME]);if(t&&a){const i=y.convertFromGeometry(new I({paths:[[t.coords[0],t.coords[1]],[a.coords[0],a.coords[1]]]}));this.linkChartDiagramLookup.set(e.attributes[f.MOCK_OID_FIELD_NAME],i)}else this.linkChartDiagramLookup.set(e.attributes[f.MOCK_OID_FIELD_NAME],null);this.linkChartGeohashLookup.set(e.attributes[f.MOCK_OID_FIELD_NAME],"")}))}));else{const e=new Map;this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const a=t.linkChartLocation;let i;const n=t.id;a&&(i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(n,new k({x:i.x,y:i.y})))}))})),yield this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:e})}else yield this.calculateLinkChartLayout()}));function a(){return t.apply(this,arguments)}return a}(),a}(_.BlendLayer(g.ScaleRangeLayer(d)));t.__decorate([s.property()],O.prototype,"dataPreloadedInLocalCache",void 0),t.__decorate([s.property()],O.prototype,"defaultLinkChartConfig",void 0),t.__decorate([s.property()],O.prototype,"dataManager",void 0),t.__decorate([s.property()],O.prototype,"knowledgeGraph",void 0),t.__decorate([s.property()],O.prototype,"layers",void 0),t.__decorate([s.property()],O.prototype,"linkChartDiagramLookup",void 0),t.__decorate([s.property()],O.prototype,"linkChartExtent",void 0),t.__decorate([s.property()],O.prototype,"linkChartGeohashLookup",void 0),t.__decorate([s.property()],O.prototype,"memberEntityTypes",void 0),t.__decorate([s.property()],O.prototype,"memberRelationshipTypes",void 0),t.__decorate([s.property()],O.prototype,"sublayerIdsCache",void 0),t.__decorate([s.property()],O.prototype,"tables",void 0),t.__decorate([s.property({json:{read:!1}})],O.prototype,"type",void 0),O=t.__decorate([c.subclass("esri.layers.LinkChartLayer")],O);return O}));
