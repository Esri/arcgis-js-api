// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/config","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/url","dojo/_base/xhr","dojo/request/xhr","./core/request/script","dojo/request/iframe","dojo/dom-construct","dojo/io-query","./kernel","./config","./sniff","./lang","./urlUtils","./deferredUtils","./support/requestUtils"],(function(e,r,n,t,o,i,s,a,l,d,u,c,f,p,g,h,m,v,w){var k,_,b=null,C=p.defaults.io,x=["COM_0056","COM_0057","SB_0008"],D=0,y=/%[0-9A-F]{2}/i,O=((_=new t).resolve(),_.promise);function j(e){return((e=new i(e)).host+(e.port?":"+e.port:"")).toLowerCase()}function A(e){return this._xhr?this._xhr.getResponseHeader(e):null}function q(e,i,p,v){var _,b,x=!1,O=!1,j=!1;h.isDefined(i)&&(o.isObject(i)?(x=!!i.useProxy,O=!!i.usePost,j=!!i.returnProgress,_=i.crossOrigin):x=!!i),delete(e=o.mixin({},e))._credential,e._ssl&&(e.url=e.url.replace(/^http:/i,"https:")),g("ie")<10&&!y.test(e.url)&&(e.url=encodeURI(e.url));var A=e.content,q=e.url,E=p&&e.form,R=C;_=h.isDefined(_)?_:R.useCors,e.load=function(r){var t;return r&&(r.error?(t=o.mixin(new Error,r.error)).log=!!n.isDebug:"error"===r.status&&((t=o.mixin(new Error,r)).log=!!n.isDebug),t&&(e.failOk=!t.log,h.isDefined(t.httpCode)||(t.httpCode=t.code))),t||r},e.error=function(r,t){return t&&t.xhr&&t.xhr.abort(),r instanceof Error||(r=o.mixin(new Error,r)),r.log=!!n.isDebug,e.failOk=!r.log,R.errorHandler(r,t),r},e._token&&(e.content=e.content||{},e.content.token=e._token);var S,P=0;A&&q&&(P=(S=c.objectToQuery(A)).length+q.length+1,g("esri-url-encodes-apostrophe")&&(P=S.replace(/'/g,"%27").length+q.length+1)),e.timeout=h.isDefined(e.timeout)?e.timeout:R.timeout,e.handleAs=e.handleAs||"json";try{var U,L,T=_&&m.canUseXhr(e.url)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),F=m.hasSameOrigin(e.url,window.location.href)||T,I=!!(O||p||P>R.postLength),N=!(F||-1===e.handleAs.indexOf("json")||!e.callbackParamName||p),W=!(!(m.getProxyRule(e.url)||R.alwaysUseProxy||x)&&("image"===e.handleAs&&!i.allowImageDataAccess||N&&!I||F));if(p&&!g("esri-file-upload")&&!W&&T&&(W=!0),W)if(L=(U=m.getProxyUrl(q,_)).path,U._xo&&(T=!0),!I&&L.length+1+P>R.postLength&&(I=!0),e.url=L+"?"+q,I)e.content=o.mixin(U.query||{},A);else{var X=c.objectToQuery(o.mixin(U.query||{},A));X&&(e.url+="?"+X),e.content=null}if(!N||I||W){var B=e.headers;if(!T||B&&B.hasOwnProperty("X-Requested-With")||((B=e.headers=B||{})["X-Requested-With"]=null),p){var H,z,Q,M,$,J=e.callbackParamName||"callback.html",G=e.callbackElementName||"textarea",K=E.elements?E.elements.length:0;if(A=e.content)for(H in A.token&&m.isSecureProxyService(q)&&(q+=(-1===q.indexOf("?")?"?":"&")+"token="+A.token,e.url=W?L+"?"+q:q,delete A.token),A)if(Q=A[H],h.isDefined(Q)){for(z=null,M=0;M<K;M++)if(($=E.elements[M]).name===H){z=$;break}z?z.value=Q:v?E.append(H,Q):E.appendChild(u.create("input",{type:"hidden",name:H,value:Q}))}if(g("esri-file-upload")){r.forEach(E.elements,(function(e){e.name===J&&E.removeChild(e)}));var V=v?E:new FormData(E);if(g("safari")>=11&&"entries"in V&&"delete"in V){for(var Y=[],Z=V.entries(),ee=Z.next();!ee.done;){var re=ee.value;re[1]instanceof File&&""===re[1].name&&Y.push(re[0]),ee=Z.next()}Y.forEach((function(e){V.delete(e)}))}e.contentType=!1,e.postData=V,delete e.form}else E.enctype="multipart/form-data",g("ie")<9&&(E.encoding="multipart/form-data"),E.method="post",r.some(E.elements,(function(e){return e.name===J}))||E.appendChild(u.create("input",{type:"hidden",name:J,value:G})),-1===q.toLowerCase().indexOf("addattachment")&&-1===q.toLowerCase().indexOf("updateattachment")||(q+=(-1===q.indexOf("?")?"?":"&")+J+"="+G,e.url=W?L+"?"+q:q),delete e.content}if(T&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===C.useCors){var ne=W?L:q,te=m.canUseXhr(ne,!0),oe=te>-1?C.corsEnabledServers[te]:null;if(oe&&oe.hasOwnProperty("withCredentials"))oe.withCredentials&&(e.withCredentials=!0);else if(f.id){var ie=f.id.findServerInfo(ne);ie&&ie.webTierAuth&&(e.withCredentials=!0)}}e=k?k(e):e;var se=function(){if("image"===e.handleAs)return function(e,r){var n=c.objectToQuery(e.content);if(n&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+n),e.url.length>2e3){var i;if("data:"!==e.url.toLowerCase().slice(0,5))return(i=new t).reject(o.mixin(new Error,{message:"When using responseType 'image', URL length cannot exceed 2000 characters."})),i;if(e.url.length>3e6)return(i=new t).reject(o.mixin(new Error,{message:"When using responseType 'image', data URL length cannot exceed 3000000 characters."})),i}var s=new Image;r.allowImageDataAccess&&(e.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous");var a=!1,l=new t((function(e){a=!0,s.onload=s.onerror=s.onabort=null,s.src=""})),d=function(e){s.onload=s.onerror=s.onabort=null,a||l.reject(new Error("Unable to load the resource"))};return s.onload=function(){s.onload=s.onerror=s.onabort=null,a||l.resolve(this)},s.onerror=d,s.onabort=d,s.alt="",s.src=e.url,l}(e,i);if(I){if(p&&!g("esri-file-upload")){b=new t((function(){r.cancel()}));var r=d.post(e.url,e).then((function(e){b.resolve(e)})).otherwise((function(e){b.reject(e)}));return b.addCallback((function(r){return e.load(r)})),b.addErrback((function(r){return e.error(r)})),b}if(!W&&g("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+D++),j){e.uploadProgress=!0,e.data=e.postData,e.query=e.content,b=new t((function(){n.cancel()}));var n=a.post(e.url,e).then((function(e){b.resolve(e)}),(function(e){b.reject(e)}),(function(e){b.progress({transferType:e.transferType,loaded:e.loaded,total:e.total})}));return b.addCallback((function(r){return e.load(r)})),b.addErrback((function(r){return e.error(r)})),b}return s.post(e)}return s.get(e)};return e.withCredentials&&w.isNoCorsRequestRequired(q)?b=w.sendNoCorsRequest(q,A).addBoth((function(){var e=se();return b.ioArgs=e.ioArgs,e})):se()}(e=k?k(e):e).jsonp=e.callbackParamName,e.query=e.content,b=new t((function(){ae.cancel()}));var ae=l.get(e.url,e).then((function(e){b.resolve(e)})).otherwise((function(e){b.reject(e)}));return b.addCallback((function(r){return e.load(r)})),b.addErrback((function(r){return e.error(r)})),b}catch(r){return(b=new t).errback(e.error(r)),b}}function E(e){var r=C.corsStatus,o=m.canUseXhr(e,!0);o>-1&&C.corsEnabledServers.splice(o,1);var i=new t;return i.reject({log:!!n.isDebug}),r[j(e)]=i.promise,o}function R(e){var r=C.corsStatus;try{var n=j(e);if(C.corsDetection&&C.useCors&&g("esri-cors")&&e&&-1!==e.toLowerCase().indexOf("/rest/services")&&!m.hasSameOrigin(e,window.location.href)&&!m.canUseXhr(e)){if(r[n]&&!r[n].isCanceled())return r[n];var o=new t(v._dfdCanceller);r[n]=o.promise;var i=s.get({url:e.substring(0,e.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info",content:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*C.corsDetectionTimeout});return o._pendingDfd=i,i.then((function(r){r?(m.canUseXhr(e)||C.corsEnabledServers.push(n),o.resolve()):o.reject()}),(function(e){o.reject(e)})),o.promise}}catch(e){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return O}function S(e){k=e}function P(i,a,l,d){var u=l.form,c=d.disableIdentityLookup,p=d._preLookup,v=!1;if(g("esri-workers")&&!1!==C.useWorkers)if(!0===d.useWorkers||!0===C.useWorkers)v=!0;else if(d.workerOptions){var k=d.workerOptions;(k.callback||k.worker&&k.worker.worker instanceof Worker)&&(v=!0)}var _=u&&g("esri-file-upload")&&u instanceof FormData,D=u&&(u.elements?r.some(u.elements,(function(e){return"file"===e.type})):_),y=-1!==l.url.toLowerCase().indexOf("token=")||l.content&&l.content.token||D&&r.some(u.elements,(function(e){return"token"===e.name}))?1:0;if(!a){i.addCallback((function(e){if(e&&(/\/sharing\/rest\/accounts\/self/i.test(l.url)||/\/sharing\/rest\/portals\/self/i.test(l.url))){if(!y&&!l._token&&e.user&&e.user.username){C.webTierAuthServers.push(j(l.url));var r=C.corsEnabledServers,n=m.canUseXhr(l.url,!0),t={host:j(l.url),withCredentials:!0};if(-1===n)r.push(t);else{var o=r[n];o instanceof RegExp?(t.host=o,r.splice(n,1,t)):"object"==typeof o?o.withCredentials=!0:r.splice(n,1,t)}}Array.isArray(e.authorizedCrossOriginNoCorsDomains)&&w.registerNoCorsDomains(e.authorizedCrossOriginNoCorsDomains)}var i=l._credential;if(i){var s,a=f.id.findServerInfo(i.server),d=a&&a.owningSystemUrl;d&&(d=d.replace(/\/?$/,"/sharing"),(s=f.id.findCredential(d,i.userId))&&-1===f.id._getIdenticalSvcIdx(d,s)&&s.resources.splice(0,0,d))}})),i.addBoth((function(e){delete l._credential,!e||g("ie")&&e.nodeType||(e._ssl=l._ssl)}));var O=l.load,R=l.error;O&&i.addCallback((function(e){var r=i._pendingDfd,n=r&&r.ioArgs,t=n&&n.args;return O.call(t,e,n)})),R&&i.addErrback((function(e){var r=i._pendingDfd,n=r&&r.ioArgs,t=n&&n.args;return R.call(t,e,n)}))}if(f.id&&!y&&!l._token&&!f.id._isPublic(l.url)&&(!c||p)){var S=f.id.findCredential(l.url);S&&(l._token=S.token,l._ssl=S.ssl)}function U(e){if(e._pendingDfd=q(l,d,D,_),!e._pendingDfd){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs;var i=new Error("Deferred object is missing");return i.log=!!n.isDebug,e.errback(i),e._pendingDfd=null,e}e._pendingDfd.addCallback((function(r){if(!r)return r;var i=e._pendingDfd&&e._pendingDfd.ioArgs&&e._pendingDfd.ioArgs.xhr;if(!i)return r;var s=i.getResponseHeader("Content-Type");if(s&&-1===(s=s.toLowerCase()).indexOf("text/plain")&&-1===s.indexOf("application/json"))return r;var a;if(r instanceof ArrayBuffer&&r.byteLength<=750)a=new Blob([r]);else{if(!(r instanceof Blob&&r.size<=750))return r;a=r}var l=new t,d=new FileReader;return d.readAsText(a),d.onloadend=function(){var e;if(!d.error)try{var t=JSON.parse(d.result);t.error&&(e=t.error)}catch(i){}if(e){var i=o.mixin(new Error,e);i.log=!!n.isDebug,null==i.httpCode&&(i.httpCode=i.code),l.reject(i)}else l.resolve(r)},l.promise})).addCallback((function(r){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,d.returnFullResponse&&(r={data:r,_xhr:e.ioArgs&&e.ioArgs.xhr,getHeader:A}),e.callback(r),e._pendingDfd=null})).addErrback((function(n){var t,o,i;if(n&&(t=n.code,o=n.subcode,i=(i=n.messageCode)&&i.toUpperCase()),n&&403==t&&(4==o||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!l._ssl)return l._ssl=l._sslFromServer=!0,void P(e,!0,l,d)}else if(n&&415==n.status){if(E(l.url),!l._err415)return l._err415=1,void P(e,!0,l,d)}else if(f.id&&-1!==r.indexOf(f.id._errorCodes,t)&&!f.id._isPublic(l.url)&&!c&&(403!=t||-1===r.indexOf(x,i)&&(!h.isDefined(o)||2==o&&l._token)))return e._pendingDfd=f.id.getCredential(l.url,{token:l._token,error:n}),void e._pendingDfd.addCallback((function(r){l._token=r.token,l._credential=r,l._ssl=l._sslFromServer||r.ssl,P(e,!0,l,d)})).addErrback((function(r){e.errback(r),e._pendingDfd=null}));e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,e.isFulfilled()||e.errback(n),e._pendingDfd=null})).then(null,null,(function(r){e.progress(r)}))}return v?d.workerOptions&&d.workerOptions.worker?(b||(b=s),s=d.workerOptions.worker,U(i)):e(["./workers/RequestClient"],(function(e){if(b||(b=s),d.workerOptions){var r=d.workerOptions;s=e.getClient(r.callback,r.cbFunction)}else s=e.getClient();U(i)})):(b&&(s=b,b=null),U(i)),i}function U(e,r){e.url=m.fixUrl(e.url),r=r||{};var n=new t(v._dfdCanceller),o=R(e.url);return n._pendingDfd=o,o.always((function(t){t&&"cancel"===t.dojoType?n.reject(t):P(n,!1,e,r)})),n}return U._makeRequest=q,U._processRequest=P,U._disableCors=E,U._detectCors=R,U.setRequestPreCallback=S,g("extend-esri")&&(f.request=U,f._makeRequest=q,f._processRequest=P,f._disableCors=E,f._detectCors=R,f.setRequestPreCallback=S),U}));