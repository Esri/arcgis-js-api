// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","./config","./kernel","./core/Error","./core/global","./core/has","./core/lang","./core/maybe","./core/promiseUtils","./core/string","./core/urlUtils","./support/requestUtils","@dojo/framework/shim/Promise"],(function(e,r,t,n,s,a,o,i,u,c,l,d,h,p){"use strict";function f(e,r){return t.__awaiter(this,void 0,void 0,(function(){var n,s,a,o,u,d,p;return t.__generator(this,(function(f){switch(f.label){case 0:return n=h.isDataProtocol(e),(s=h.isBlobProtocol(e))||n||(e=h.normalize(e)),a={url:e,requestOptions:t.__assign({},c.unwrap(r))},(o=h.getInterceptor(e))?[4,P(o,a)]:[3,2];case 1:if(null!=(u=f.sent()))return[2,{data:u,getHeader:_,requestOptions:a.requestOptions,url:a.url}];o.after||o.error||(o=null),f.label=2;case 2:if(e=a.url,"image"===(r=a.requestOptions).responseType){if(i("host-webworker")||i("host-node"))throw q("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),a)}else if(n)throw q("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+r.responseType),a);if("head"===r.method){if(r.body)throw q("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),a);if(n||s)throw q("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),a)}return[4,O()];case 3:return f.sent(),m?[2,m.execute(e,r)]:(d=l.createAbortController(),l.onAbort(r,(function(){return d.abort()})),[4,E({controller:d,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:o,params:a,redoRequest:!1,useIdentity:b.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1})]);case 4:return p=f.sent(),o&&o.after&&o.after(p),[2,p]}}))}))}var m,b=n.request,g="FormData"in o,w=[499,498,403,401],y=["COM_0056","COM_0057","SB_0008"],v=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],_=function(){return null};function q(e,r,t,n){var s="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:_,ssl:!1};if(r instanceof a)return r.details?(r.details=u.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var i=n&&function(e){return n.headers.get(e)},c=n&&n.status,d=r.message;d&&(s=d),i&&(o.getHeader=i),o.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||c||0,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}return l.isAbortError(r)?l.createAbortError():new a(e,s,o)}function O(){return t.__awaiter(this,void 0,void 0,(function(){var r;return t.__generator(this,(function(t){switch(t.label){case 0:return i("host-webworker")?m?[3,2]:[4,new Promise((function(r,t){e(["./core/workers/request"],r,t)}))]:[3,3];case 1:m=t.sent(),t.label=2;case 2:return[3,6];case 3:return f._abortableFetch?[3,6]:i("esri-abortable-fetch")?(f._abortableFetch=o.fetch.bind(o),[3,6]):[3,4];case 4:return r=f,[4,new Promise((function(r,t){e(["whatwg-fetch"],r,t)}))];case 5:r._abortableFetch=t.sent().fetch,t.label=6;case 6:return[2]}}))}))}function T(){return t.__awaiter(this,void 0,void 0,(function(){return t.__generator(this,(function(r){switch(r.label){case 0:return s.id?[3,2]:[4,new Promise((function(r,t){e(["./identity/IdentityManager"],r,t)}))];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))}function k(e){return t.__awaiter(this,void 0,void 0,(function(){var r,n,a,i,u,c,d,h;return t.__generator(this,(function(t){switch(t.label){case 0:return r=e.params.url,n=e.params.requestOptions,a=e.controller.signal,i=n.body,u=null,c=null,d=null,g&&"HTMLFormElement"in o&&(i instanceof FormData?u=i:i instanceof HTMLFormElement&&(c=i,u=new FormData(c))),"string"==typeof i&&(d=i),e.fetchOptions={cache:n.cacheBust&&!f._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:n.headers||{},method:"head"===n.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:a},(u||d)&&(e.fetchOptions.body=u||d),"anonymous"===n.authMode&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||n.query&&n.query.token||u&&u.get&&u.get("token")||c&&c.elements.token),!e.useIdentity||e.hasToken||e.credentialToken||x(r)||l.isAborted(a)?[3,11]:(h=void 0,"immediate"!==n.authMode?[3,3]:[4,T()]);case 1:return t.sent(),[4,s.id.getCredential(r,{signal:a})];case 2:return h=t.sent(),e.credential=h,[3,10];case 3:return"no-prompt"!==n.authMode?[3,9]:[4,T()];case 4:t.sent(),t.label=5;case 5:return t.trys.push([5,7,,8]),[4,s.id.getCredential(r,{prompt:!1,signal:a})];case 6:return h=t.sent(),e.credential=h,[3,8];case 7:return t.sent(),[3,8];case 8:return[3,10];case 9:s.id&&(h=s.id.findCredential(r)),t.label=10;case 10:h&&(e.credentialToken=h.token,e.useSSL=!!h.ssl),t.label=11;case 11:return[2]}}))}))}function x(e){return v.some((function(r){return r.test(e)}))}function S(e){return t.__awaiter(this,void 0,void 0,(function(){var r,n,a,o,u,c,p,m,w,y,v,_,O,T,k,x,S,P,E,L,D,F;return t.__generator(this,(function(I){switch(I.label){case 0:if(r=e.params.url,n=e.params.requestOptions,a=e.fetchOptions,o=h.isBlobProtocol(r)||h.isDataProtocol(r),u=n.responseType||"json",c=o?0:null!=n.timeout?n.timeout:b.timeout,p=!1,!o){if(e.useSSL&&(r=h.toHTTPS(r)),n.cacheBust&&"default"===a.cache&&(r=h.addQueryParameter(r,"request.preventCache",Date.now())),m=t.__assign({},n.query),e.credentialToken&&(m.token=e.credentialToken),w=h.objectToQuery(m),i("esri-url-encodes-apostrophe")&&(w=w.replace(/'/g,"%27")),y=r.length+1+w.length,v=void 0,p="post"===n.method||!!n.body||y>b.maxUrlLength,(_=n.useProxy||!!h.getProxyRule(r))&&(O=h.getProxyUrl(r),v=O.path,!p&&v.length+1+y>b.maxUrlLength&&(p=!0),O.query&&(m=t.__assign(t.__assign({},O.query),m))),"HEAD"===a.method&&(p||_)){if(p){if(y>b.maxUrlLength)throw q("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw q("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(_)throw q("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}p?(a.method="POST",n.body?r=h.addQueryParameters(r,m):(a.body=h.objectToQuery(m),a.headers["Content-Type"]="application/x-www-form-urlencoded")):r=h.addQueryParameters(r,m),_&&(e.useProxy=!0,r=v+"?"+r),m.token&&g&&a.body instanceof FormData&&((T=a.body).set?T.set("token",m.token):T.append("token",m.token)),n.hasOwnProperty("withCredentials")?e.withCredentials=n.withCredentials:h.isTrustedServer(r)?e.withCredentials=!0:s.id&&(k=s.id.findServerInfo(r))&&k.webTierAuth&&(e.withCredentials=!0),e.withCredentials&&(a.credentials="include")}x=0,S=!1,c>0&&(x=setTimeout((function(){S=!0,e.controller.abort()}),c)),I.label=1;case 1:return I.trys.push([1,18,19,20]),"image"!==n.responseType||"default"!==a.cache||"GET"!==a.method||p||function(e){if(e)for(var r=0,t=Object.getOwnPropertyNames(e);r<t.length;r++){var n=t[r];if(e[n])return!0}return!1}(n.headers)||!o&&!e.useProxy&&b.proxyUrl&&(R=r,(A=h.getOrigin(R))&&!d.endsWith(A,".arcgis.com")&&-1===f._corsServers.indexOf(A)&&!h.isTrustedServer(A))?[3,3]:[4,U(r,e)];case 2:return E=I.sent(),[3,17];case 3:return[4,f._abortableFetch(r,a)];case 4:if(P=I.sent(),e.useProxy||function(e){if(!h.isBlobProtocol(e)&&!h.isDataProtocol(e)){var r=h.getOrigin(e);r&&-1===f._corsServers.indexOf(r)&&f._corsServers.push(r)}}(r),!P.ok||"HEAD"===a.method)return[3,17];switch(u){case"array-buffer":return[3,5];case"blob":case"image":return[3,7]}return[3,9];case 5:return[4,P.arrayBuffer()];case 6:return E=I.sent(),[3,11];case 7:return[4,P.blob()];case 8:return E=I.sent(),[3,11];case 9:return[4,P.text()];case 10:return E=I.sent(),[3,11];case 11:if(x&&(clearTimeout(x),x=0),"json"===u||"xml"===u||"document"===u)if(E)switch(u){case"json":E=JSON.parse(E);break;case"xml":E=C(E,"application/xml");break;case"document":E=C(E,"text/html")}else E=null;if(!E)return[3,17];if("array-buffer"!==u&&"blob"!==u)return[3,15];if(L=P.headers.get("Content-Type"),!(/application\/json|text\/plain/i.test(L)&&E["blob"===u?"size":"byteLength"]<=750))return[3,15];I.label=12;case 12:return I.trys.push([12,14,,15]),[4,new Response(E).json()];case 13:return(D=I.sent()).error&&(E=D),[3,15];case 14:return I.sent(),[3,15];case 15:return"image"===u&&E instanceof Blob?[4,U(URL.createObjectURL(E),e,!0)]:[3,17];case 16:E=I.sent(),I.label=17;case 17:return[3,20];case 18:if("AbortError"===(F=I.sent()).name){if(S)throw new Error("Timeout exceeded");throw l.createAbortError("Request canceled")}if(!(!P&&F instanceof TypeError&&b.proxyUrl)||n.body||"post"===n.method||"head"===n.method||e.useProxy)throw F;return(e.redoRequest=!0,h.addProxyRule({proxyUrl:b.proxyUrl,urlPrefix:h.removeFile(h.urlToObject(r).path)}),[3,20]);case 19:return x&&clearTimeout(x),[7];case 20:return[2,[P,E]]}var R,A}))}))}function P(e,r){return t.__awaiter(this,void 0,void 0,(function(){var n,s,o;return t.__generator(this,(function(i){switch(i.label){case 0:if(null!=e.responseData)return[2,e.responseData];if(e.headers&&(r.requestOptions.headers=t.__assign(t.__assign({},r.requestOptions.headers),e.headers)),e.query&&(r.requestOptions.query=t.__assign(t.__assign({},r.requestOptions.query),e.query)),!e.before)return[3,5];n=void 0,s=void 0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,e.before(r)];case 2:return s=i.sent(),[3,4];case 3:return o=i.sent(),n=q("request:interceptor",o,r),[3,4];case 4:if((s instanceof Error||s instanceof a)&&(n=q("request:interceptor",s,r)),n)throw e.error&&e.error(n),n;return[2,s];case 5:return[2]}}))}))}function C(e,r){var t;try{t=(new DOMParser).parseFromString(e,r)}catch(e){}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}function E(e){return t.__awaiter(this,void 0,void 0,(function(){var r,n,a,o,i,u,c,l,d,p,f;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,k(e)];case 1:t.sent(),t.label=2;case 2:t.trys.push([2,8,,9]),t.label=3;case 3:return[4,S(e)];case 4:f=t.sent(),r=f[0],n=f[1],t.label=5;case 5:return[4,L(e,r,n)];case 6:if(!t.sent())return[3,3];t.label=7;case 7:return[3,9];case 8:throw a=t.sent(),(o=q("request:server",a,e.params,r)).details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(o),o;case 9:return i=e.params.url,/\/sharing\/rest\/(accounts|portals)\/self/i.test(i)&&!e.hasToken&&!e.credentialToken&&n&&n.user&&n.user.username&&!h.isTrustedServer(i)&&(u=h.getOrigin(i,!0))&&b.trustedServers.push(u),(c=e.credential)&&s.id&&(l=s.id.findServerInfo(c.server),(d=l&&l.owningSystemUrl)&&(d=d.replace(/\/?$/,"/sharing"),(p=s.id.findCredential(d,c.userId))&&-1===s.id._getIdenticalSvcIdx(d,p)&&p.resources.unshift(d))),[2,{data:n,getHeader:r?function(e){return r.headers.get(e)}:_,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}]}}))}))}function L(e,r,n){return t.__awaiter(this,void 0,void 0,(function(){var a,o,i,c,l,d,h;return t.__generator(this,(function(t){switch(t.label){case 0:if(e.redoRequest)return e.redoRequest=!1,[2,!1];if(!r)return[2,!0];if(!r.ok)throw new Error("Unable to load "+r.url+" status: "+r.status);return n&&n.error&&(a=u.mixin(new Error,n.error)),a&&(o=Number(a.code),i=a.hasOwnProperty("subcode")?Number(a.subcode):null,c=(c=a.messageCode)&&c.toUpperCase()),l=e.params.requestOptions.authMode,403===o&&(4===i||a.message&&a.message.toLowerCase().indexOf("ssl")>-1&&-1===a.message.toLowerCase().indexOf("permission"))?e.useSSL?[3,6]:(e.useSSL=!0,[2,!1]):[3,1];case 1:return!e.useIdentity||"no-prompt"===l&&498!==o||-1===w.indexOf(o)||x(e.params.url)||!(403!==o||-1===y.indexOf(c)&&(null==i||2===i&&e.credentialToken))?[3,6]:[4,T()];case 2:t.sent(),t.label=3;case 3:return t.trys.push([3,5,,6]),[4,s.id.getCredential(e.params.url,{error:q("request:server",a,e.params),prompt:"no-prompt"!==l,signal:e.controller.signal,token:e.credentialToken})];case 4:return d=t.sent(),e.credential=d,e.credentialToken=d.token,e.useSSL=e.useSSL||d.ssl,[2,!1];case 5:return h=t.sent(),"no-prompt"===l?(e.credential=null,e.credentialToken=null,[2,!1]):(a=h,[3,6]);case 6:if(a)throw a;return[2,!0]}}))}))}function U(e,r,t){void 0===t&&(t=!1);var n=r.controller.signal,s=new Image;return r.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=e,p.loadImageAsync(s,e,t,n)}return f._abortableFetch=null,f._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],f}));