/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","./core/global","./core/has","./core/lang","./config","./core/maybe","./core/Error","./core/urlUtils","./core/promiseUtils","./kernel","./support/requestUtils"],(function(e,r,t,o,s,n,a,i,l,c,u){"use strict";function d(e){return Object.freeze({__proto__:null,default:e})}async function p(o,u){const d=i.isDataProtocol(o),y=i.isBlobProtocol(o);y||d||(o=i.normalize(o));const w={url:o,requestOptions:{...n.unwrap(u)}};let g=i.getInterceptor(o);if(g){const e=await async function(e,r){if(null!=e.responseData)return e.responseData;e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers});e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query});if(e.before){let t,o;try{o=await e.before(r)}catch(e){t=q("request:interceptor",e,r)}if((o instanceof Error||o instanceof a)&&(t=q("request:interceptor",o,r)),t)throw e.error&&e.error(t),t;return o}}(g,w);if(null!=e)return{data:e,getHeader:b,requestOptions:w.requestOptions,url:w.url};g.after||g.error||(g=null)}if(o=w.url,"image"===(u=w.requestOptions).responseType){if(t("host-webworker")||t("host-node"))throw q("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),w)}else if(d)throw q("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+u.responseType),w);if("head"===u.method){if(u.body)throw q("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),w);if(d||y)throw q("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),w)}if(await async function(){t("host-webworker")?h||(h=await new Promise((function(r,t){e(["./core/workers/request"],r,t)}))):p._abortableFetch||(p._abortableFetch=r.fetch.bind(r))}(),h)return h.execute(o,u);const S=l.createAbortController();l.onAbort(u,(()=>S.abort()));const v={controller:S,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:g,params:w,redoRequest:!1,useIdentity:f.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},P=await async function(e){let t,o;await async function(e){const t=e.params.url,o=e.params.requestOptions,n=e.controller.signal,a=o.body;let u=null,d=null,h=null;m&&"HTMLFormElement"in r&&(a instanceof FormData?u=a:a instanceof HTMLFormElement&&(d=a,u=new FormData(d)));"string"==typeof a&&(h=a);e.fetchOptions={cache:o.cacheBust&&!p._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:o.headers||{},method:"head"===o.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:n},(u||h)&&(e.fetchOptions.body=u||h);"anonymous"===o.authMode&&(e.useIdentity=!1);e.hasToken=!!(/token=/i.test(t)||o.query&&o.query.token||u&&u.get&&u.get("token")||d&&d.elements.token);const f=i.getOrigin(t,!0);f&&!e.hasToken&&s.apiKey&&f.endsWith(".arcgis.com")&&"elevation3d.arcgis.com"!==f&&"js.arcgis.com"!==f&&"jsdev.arcgis.com"!==f&&"jsqa.arcgis.com"!==f&&(o.query||(o.query={}),o.query.token=s.apiKey,e.hasToken=!0);if(e.useIdentity&&!e.hasToken&&!e.credentialToken&&!T(t)&&!l.isAborted(n)){let r;"immediate"===o.authMode?(await O(),r=await c.id.getCredential(t,{signal:n}),e.credential=r):"no-prompt"===o.authMode?(await O(),r=await c.id.getCredential(t,{prompt:!1,signal:n}).catch((()=>{})),e.credential=r):c.id&&(r=c.id.findCredential(t)),r&&(e.credentialToken=r.token,e.useSSL=!!r.ssl)}}(e);try{do{[t,o]=await k(e)}while(!await x(e,t,o))}catch(r){const o=q("request:server",r,e.params,t);throw o.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(o),o}const n=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)&&!e.hasToken&&!e.credentialToken&&o&&o.user&&o.user.username&&!i.isTrustedServer(n)){const e=i.getOrigin(n,!0);e&&f.trustedServers.push(e)}const a=e.credential;if(a&&c.id){const e=c.id.findServerInfo(a.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=c.id.findCredential(r,a.userId);e&&-1===c.id._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:o,getHeader:t?e=>t.headers.get(e):b,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}(v);return g&&g.after&&g.after(P),P}let h;const f=s.request,m="FormData"in r,y=[499,498,403,401],w=["COM_0056","COM_0057","SB_0008"],g=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],b=()=>null;function q(e,r,t,s){let n="Error";const i={url:t.url,requestOptions:t.requestOptions,getHeader:b,ssl:!1};if(r instanceof a)return r.details?(r.details=o.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=i,r;if(r){const e=s&&(e=>s.headers.get(e)),t=s&&s.status,o=r.message;o&&(n=o),e&&(i.getHeader=e),i.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,i.subCode=r.subcode,i.messageCode=r.messageCode,"string"==typeof r.details?i.messages=[r.details]:i.messages=r.details}return l.isAbortError(r)?l.createAbortError():new a(e,n,i)}async function O(){c.id||await new Promise((function(r,t){e(["./identity/IdentityManager"],(function(e){r(d(e))}),t)}))}function T(e){return g.some((r=>r.test(e)))}async function k(e){let r=e.params.url;const o=e.params.requestOptions,s=e.fetchOptions,n=i.isBlobProtocol(r)||i.isDataProtocol(r),a=o.responseType||"json",u=n?0:null!=o.timeout?o.timeout:f.timeout;let d=!1;if(!n){e.useSSL&&(r=i.toHTTPS(r)),o.cacheBust&&"default"===s.cache&&(r=i.addQueryParameter(r,"request.preventCache",Date.now()));let n={...o.query};e.credentialToken&&(n.token=e.credentialToken);let a=i.objectToQuery(n);t("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const l=r.length+1+a.length;let u;d="post"===o.method||!!o.body||l>f.maxUrlLength;const p=o.useProxy||!!i.getProxyRule(r);if(p){const e=i.getProxyUrl(r);u=e.path,!d&&u.length+1+l>f.maxUrlLength&&(d=!0),e.query&&(n={...e.query,...n})}if("HEAD"===s.method&&(d||p)){if(d){if(l>f.maxUrlLength)throw q("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw q("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(p)throw q("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(d?(s.method="POST",o.body?r=i.addQueryParameters(r,n):(s.body=i.objectToQuery(n),s.headers["Content-Type"]="application/x-www-form-urlencoded")):r=i.addQueryParameters(r,n),p&&(e.useProxy=!0,r=`${u}?${r}`),n.token&&m&&s.body instanceof FormData){const e=s.body;e.set?e.set("token",n.token):e.append("token",n.token)}if(o.hasOwnProperty("withCredentials"))e.withCredentials=o.withCredentials;else if(i.isTrustedServer(r))e.withCredentials=!0;else if(c.id){const t=c.id.findServerInfo(r);t&&t.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(s.credentials="include")}let h,y,w=0,g=!1;u>0&&(w=setTimeout((()=>{g=!0,e.controller.abort()}),u));try{if("image"!==o.responseType||"default"!==s.cache||"GET"!==s.method||d||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(o.headers)||!n&&!e.useProxy&&f.proxyUrl&&!function(e){const r=i.getOrigin(e);return!r||r.endsWith(".arcgis.com")||-1!==p._corsServers.indexOf(r)||i.isTrustedServer(r)}(r)){if(h=await p._abortableFetch(r,s),e.useProxy||function(e){if(i.isBlobProtocol(e)||i.isDataProtocol(e))return;const r=i.getOrigin(e);r&&-1===p._corsServers.indexOf(r)&&p._corsServers.push(r)}(r),h.ok&&"HEAD"!==s.method){switch(a){case"array-buffer":y=await h.arrayBuffer();break;case"blob":case"image":y=await h.blob();break;default:y=await h.text()}if(w&&(clearTimeout(w),w=0),"json"===a||"xml"===a||"document"===a)if(y)switch(a){case"json":y=JSON.parse(y);break;case"xml":y=S(y,"application/xml");break;case"document":y=S(y,"text/html")}else y=null;if(y){if("array-buffer"===a||"blob"===a){const e=h.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&y["blob"===a?"size":"byteLength"]<=750)try{const e=await new Response(y).json();e.error&&(y=e)}catch{}}"image"===a&&y instanceof Blob&&(y=await v(URL.createObjectURL(y),e,!0))}}}else y=await v(r,e)}catch(t){if("AbortError"===t.name){if(g)throw new Error("Timeout exceeded");throw l.createAbortError("Request canceled")}if(!(!h&&t instanceof TypeError&&f.proxyUrl)||o.body||"post"===o.method||"head"===o.method||e.useProxy)throw t;e.redoRequest=!0,i.addProxyRule({proxyUrl:f.proxyUrl,urlPrefix:i.removeFile(i.urlToObject(r).path)})}finally{w&&clearTimeout(w)}return[h,y]}function S(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}async function x(e,r,t){var s;if(e.redoRequest)return e.redoRequest=!1,!1;if(!r)return!0;if(!r.ok)throw new Error(`Unable to load ${r.url} status: ${r.status}`);let n,a,i,l;t&&t.error&&(n=o.mixin(new Error,t.error)),n&&(a=Number(n.code),i=n.hasOwnProperty("subcode")?Number(n.subcode):null,l=n.messageCode,l=l&&l.toUpperCase());const u=e.params.requestOptions.authMode,d=String(null==(s=e.params.requestOptions.query)?void 0:s.token);if(403===a&&(4===i||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(e.useIdentity&&("no-prompt"!==u||498===a)&&-1!==y.indexOf(a)&&!T(e.params.url)&&!d.startsWith("AAPK")&&(403!==a||-1===w.indexOf(l)&&(null==i||2===i&&e.credentialToken))){await O();try{const r=await c.id.getCredential(e.params.url,{error:q("request:server",n,e.params),prompt:"no-prompt"!==u,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(r){if("no-prompt"===u)return e.credential=null,e.credentialToken=null,!1;n=r}}if(n)throw n;return!0}function v(e,r,t=!1){const o=r.controller.signal,s=new Image;return r.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=e,u.loadImageAsync(s,e,t,o)}return p._abortableFetch=null,p._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],p}));
