/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","./chunks/_rollupPluginBabelHelpers","./config","./kernel","./core/Error","./core/has","./core/lang","./core/maybe","./core/promiseUtils","./core/urlUtils","./portal/support/urlUtils","./support/apiKeyUtils","./support/requestUtils"],(function(e,r,t,o,s,n,i,a,l,u,d,c,p){"use strict";const h=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function y(e,r){return f.apply(this,arguments)}function f(){return(f=r._asyncToGenerator((function*(e,r){const t=u.isDataProtocol(e),o=u.isBlobProtocol(e);o||t||(e=u.normalize(e));const s={url:e,requestOptions:{...a.unwrap(r)}};let i=u.getInterceptor(e);if(i){const e=yield I(i,s);if(null!=e)return{data:e,getHeader:S,requestOptions:s.requestOptions,url:s.url};i.after||i.error||(i=null)}if(e=s.url,"image"===(r=s.requestOptions).responseType){if(n("host-webworker")||n("host-node"))throw C("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),s)}else if(t)throw C("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+r.responseType),s);if("head"===r.method){if(r.body)throw C("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),s);if(t||o)throw C("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),s)}if(yield x(),m)return m.execute(e,r);const d=new AbortController;l.onAbort(r,(()=>d.abort()));const c={controller:d,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:i,params:s,redoRequest:!1,useIdentity:g.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},p=yield H(c);return i?.after?.(p),p}))).apply(this,arguments)}let m;const g=t.request,b="FormData"in globalThis,w=[499,498,403,401],T=["COM_0056","COM_0057","SB_0008"],q=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],S=()=>null,O=Symbol();function k(e){const r=u.getOrigin(e);r&&!y._corsServers.includes(r)&&y._corsServers.push(r)}function v(e){const r=u.getOrigin(e);return!r||r.endsWith(".arcgis.com")||y._corsServers.includes(r)||u.isTrustedServer(r)}function C(e,r,t,o){let n="Error";const a={url:t.url,requestOptions:t.requestOptions,getHeader:S,ssl:!1};if(r instanceof s)return r.details?(r.details=i.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=a,r;if(r){const e=o&&(e=>o.headers.get(e)),t=o&&o.status,s=r.message;s&&(n=s),e&&(a.getHeader=e),a.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,a.subCode=r.subcode,a.messageCode=r.messageCode,"string"==typeof r.details?a.messages=[r.details]:a.messages=r.details,a.raw=O in r?r[O]:r}return l.isAbortError(r)?l.createAbortError():new s(e,n,a)}function x(){return P.apply(this,arguments)}function P(){return(P=r._asyncToGenerator((function*(){n("host-webworker")?m||(m=yield new Promise(((r,t)=>e(["./core/workers/request"],r,t)))):y._abortableFetch||(y._abortableFetch=globalThis.fetch.bind(globalThis))}))).apply(this,arguments)}function E(){return _.apply(this,arguments)}function _(){return(_=r._asyncToGenerator((function*(){o.id||(yield new Promise(((r,t)=>e(["./identity/IdentityManager"],(e=>r(h(e))),t))))}))).apply(this,arguments)}function L(e){return U.apply(this,arguments)}function U(){return(U=r._asyncToGenerator((function*(e){const r=e.params.url,s=e.params.requestOptions,n=e.controller.signal,i=s.body;let a=null,u=null;if(b&&"HTMLFormElement"in globalThis&&(i instanceof FormData?a=i:i instanceof HTMLFormElement&&(a=new FormData(i))),"string"==typeof i&&(u=i),e.fetchOptions={cache:s.cacheBust&&!y._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:s.headers||{},method:"head"===s.method?"HEAD":"GET",mode:"cors",priority:g.priority,redirect:"follow",signal:n},(a||u)&&(e.fetchOptions.body=a||u),"anonymous"===s.authMode&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||s.query?.token||a?.get("token")),!e.hasToken&&t.apiKey&&c.supportsApiKey(r)&&(s.query||(s.query={}),s.query.token=t.apiKey,e.hasToken=!0),e.useIdentity&&!e.hasToken&&!e.credentialToken&&!A(r)&&!l.isAborted(n)){let t;"immediate"===s.authMode?(yield E(),t=yield o.id.getCredential(r,{signal:n}),e.credential=t):"no-prompt"===s.authMode?(yield E(),t=yield o.id.getCredential(r,{prompt:!1,signal:n}).catch((()=>{})),e.credential=t):o.id&&(t=o.id.findCredential(r)),t&&(e.credentialToken=t.token,e.useSSL=!!t.ssl)}}))).apply(this,arguments)}function A(e){return q.some((r=>r.test(e)))}function D(e){return R.apply(this,arguments)}function R(){return(R=r._asyncToGenerator((function*(e){let r=e.params.url;const t=e.params.requestOptions,s=e.fetchOptions??{},i=u.isBlobProtocol(r)||u.isDataProtocol(r),a=t.responseType||"json",c=i?0:null!=t.timeout?t.timeout:g.timeout;let h=!1;if(!i){e.useSSL&&(r=u.toHTTPS(r)),t.cacheBust&&"default"===s.cache&&(r=u.addQueryParameter(r,"request.preventCache",Date.now()));let i={...t.query};e.credentialToken&&(i.token=e.credentialToken);let a=u.objectToQuery(i);n("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const l=r.length+1+a.length;let c;h="delete"===t.method||"post"===t.method||"put"===t.method||!!t.body||l>g.maxUrlLength;const y=t.useProxy||!!u.getProxyRule(r);if(y){const e=u.getProxyUrl(r);c=e.path,!h&&c.length+1+l>g.maxUrlLength&&(h=!0),e.query&&(i={...e.query,...i})}if("HEAD"===s.method&&(h||y)){if(h){if(l>g.maxUrlLength)throw C("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw C("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(y)throw C("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(h?(s.method="delete"===t.method?"DELETE":"put"===t.method?"PUT":"POST",t.body?r=u.addQueryParameters(r,i):(s.body=u.objectToQuery(i),s.headers||(s.headers={}),s.headers["Content-Type"]="application/x-www-form-urlencoded")):r=u.addQueryParameters(r,i),y&&(e.useProxy=!0,r=`${c}?${r}`),i.token&&b&&s.body instanceof FormData&&!d.isSecureProxyService(r)&&s.body.set("token",i.token),t.hasOwnProperty("withCredentials"))e.withCredentials=t.withCredentials;else if(!u.hasSameOrigin(r,u.getAppUrl()))if(u.isTrustedServer(r))e.withCredentials=!0;else if(o.id){const t=o.id.findServerInfo(r);t&&t.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(s.credentials="include",p.isNoCorsRequestRequired(r)&&(yield p.sendNoCorsRequest(h?u.addQueryParameters(r,i):r)))}let f,m,w=0,T=!1;c>0&&(w=setTimeout((()=>{T=!0,e.controller.abort()}),c));try{if("native-request-init"===t.responseType)m=s,m.url=r;else if("image"!==t.responseType||"default"!==s.cache||"GET"!==s.method||h||M(t.headers)||!i&&!e.useProxy&&g.proxyUrl&&!v(r)){if(f=yield y._abortableFetch(r,s),e.useProxy||k(r),"native"===t.responseType)m=f;else if("HEAD"!==s.method)if(f.ok){switch(a){case"array-buffer":m=yield f.arrayBuffer();break;case"blob":case"image":m=yield f.blob();break;default:m=yield f.text()}if(w&&(clearTimeout(w),w=0),"json"===a||"xml"===a||"document"===a)if(m)switch(a){case"json":m=JSON.parse(m);break;case"xml":m=j(m,"application/xml");break;case"document":m=j(m,"text/html")}else m=null;if(m){if("array-buffer"===a||"blob"===a){const e=f.headers.get("Content-Type");if(e&&/application\/json|text\/plain/i.test(e)&&m["blob"===a?"size":"byteLength"]<=750)try{const e=yield new Response(m).json();e.error&&(m=e)}catch{}}"image"===a&&m instanceof Blob&&(m=yield Q(URL.createObjectURL(m),e,!0))}}else m=yield f.text()}else m=yield Q(r,e)}catch(q){if("AbortError"===q.name){if(T)throw new Error("Timeout exceeded");throw l.createAbortError("Request canceled")}if(!(!f&&q instanceof TypeError&&g.proxyUrl)||t.body||"delete"===t.method||"head"===t.method||"post"===t.method||"put"===t.method||e.useProxy||v(r))throw q;e.redoRequest=!0,u.addProxyRule({proxyUrl:g.proxyUrl,urlPrefix:u.getOrigin(r)??""})}finally{w&&clearTimeout(w)}return[f,m]}))).apply(this,arguments)}function I(e,r){return F.apply(this,arguments)}function F(){return(F=r._asyncToGenerator((function*(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let o,n;try{n=yield e.before(r)}catch(t){o=C("request:interceptor",t,r)}if((n instanceof Error||n instanceof s)&&(o=C("request:interceptor",n,r)),o)throw e.error&&e.error(o),o;return n}}))).apply(this,arguments)}function M(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}function j(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}function H(e){return N.apply(this,arguments)}function N(){return(N=r._asyncToGenerator((function*(e){let r,t;yield L(e);try{do{[r,t]=yield D(e)}while(!(yield G(e,r,t)))}catch(i){const t=C("request:server",i,e.params,r);throw t.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(t),t}const s=e.params.url;if(t&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(s)){if(!e.hasToken&&!e.credentialToken&&t.user?.username&&!u.isTrustedServer(s)){const e=u.getOrigin(s,!0);e&&g.trustedServers.push(e)}Array.isArray(t.authorizedCrossOriginNoCorsDomains)&&p.registerNoCorsDomains(t.authorizedCrossOriginNoCorsDomains)}const n=e.credential;if(n&&o.id){const e=o.id.findServerInfo(n.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=o.id.findCredential(r,n.userId);e&&-1===o.id._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:t,getHeader:r?e=>r?.headers.get(e):S,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}))).apply(this,arguments)}function G(e,r,t){return B.apply(this,arguments)}function B(){return(B=r._asyncToGenerator((function*(e,r,t){if(e.redoRequest)return e.redoRequest=!1,!1;const s=e.params.requestOptions;if(!r||"native"===s.responseType||"native-request-init"===s.responseType)return!0;let n,i;if(!r.ok)throw n=new Error(`Unable to load ${r.url} status: ${r.status}`),n[O]=t,n;t&&(t.error?n=t.error:"error"===t.status&&Array.isArray(t.messages)&&(n={...t},n[O]=t,n.details=t.messages));let a,l=null;n&&(i=Number(n.code),l=n.hasOwnProperty("subcode")?Number(n.subcode):null,a=n.messageCode,a=a&&a.toUpperCase());const u=s.authMode;if(403===i&&(4===l||n.message&&n.message.toLowerCase().includes("ssl")&&!n.message.toLowerCase().includes("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==u||498===i)&&void 0!==i&&w.includes(i)&&!A(e.params.url)&&(403!==i||a&&!T.includes(a)&&(null==l||2===l&&e.credentialToken))){yield E();try{const r=yield o.id.getCredential(e.params.url,{error:C("request:server",n,e.params),prompt:"no-prompt"!==u,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(d){if("no-prompt"===u)return e.credential=void 0,e.credentialToken=void 0,!1;n=d}}if(n)throw n;return!0}))).apply(this,arguments)}function Q(e,r,t=!1){const o=r.controller.signal,s=new Image;return r.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.fetchPriority=g.priority,s.src=e,p.loadImageAsync(s,e,t,o)}return y._abortableFetch=null,y._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],y}));
