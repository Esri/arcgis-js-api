/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["require","./chunks/_rollupPluginBabelHelpers","./config","./kernel","./core/Error","./core/has","./core/lang","./core/maybe","./core/promiseUtils","./core/urlUtils","./support/apiKeyUtils","./support/requestUtils"],(function(e,r,t,n,o,s,i,a,l,u,c,d){"use strict";const p=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function h(e,r){return f.apply(this,arguments)}function f(){return(f=r._asyncToGenerator((function*(e,r){var t;const n=u.isDataProtocol(e),o=u.isBlobProtocol(e);o||n||(e=u.normalize(e));const i={url:e,requestOptions:{...a.unwrap(r)}};let c=u.getInterceptor(e);if(c){const e=yield I(c,i);if(null!=e)return{data:e,getHeader:q,requestOptions:i.requestOptions,url:i.url};c.after||c.error||(c=null)}if(e=i.url,"image"===(r=i.requestOptions).responseType){if(s("host-webworker")||s("host-node"))throw x("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),i)}else if(n)throw x("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+r.responseType),i);if("head"===r.method){if(r.body)throw x("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),i);if(n||o)throw x("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),i)}if(yield v(),y)return y.execute(e,r);const d=new AbortController;l.onAbort(r,(()=>d.abort()));const p={controller:d,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:c,params:i,redoRequest:!1,useIdentity:m.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},h=yield j(p);return null==(t=c)||null==t.after||t.after(h),h}))).apply(this,arguments)}let y;const m=t.request,g="FormData"in globalThis,b=[499,498,403,401],w=["COM_0056","COM_0057","SB_0008"],T=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],q=()=>null,k=Symbol();function O(e){const r=u.getOrigin(e);r&&!h._corsServers.includes(r)&&h._corsServers.push(r)}function S(e){const r=u.getOrigin(e);return!r||r.endsWith(".arcgis.com")||h._corsServers.includes(r)||u.isTrustedServer(r)}function x(e,r,t,n){let s="Error";const a={url:t.url,requestOptions:t.requestOptions,getHeader:q,ssl:!1};if(r instanceof o)return r.details?(r.details=i.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=a,r;if(r){const e=n&&(e=>n.headers.get(e)),t=n&&n.status,o=r.message;o&&(s=o),e&&(a.getHeader=e),a.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,a.subCode=r.subcode,a.messageCode=r.messageCode,"string"==typeof r.details?a.messages=[r.details]:a.messages=r.details,a.raw=k in r?r[k]:r}return l.isAbortError(r)?l.createAbortError():new o(e,s,a)}function v(){return P.apply(this,arguments)}function P(){return(P=r._asyncToGenerator((function*(){s("host-webworker")?y||(y=yield new Promise(((r,t)=>e(["./core/workers/request"],r,t)))):h._abortableFetch||(h._abortableFetch=globalThis.fetch.bind(globalThis))}))).apply(this,arguments)}function E(){return C.apply(this,arguments)}function C(){return(C=r._asyncToGenerator((function*(){n.id||(yield new Promise(((r,t)=>e(["./identity/IdentityManager"],(e=>r(p(e))),t))))}))).apply(this,arguments)}function _(e){return L.apply(this,arguments)}function L(){return(L=r._asyncToGenerator((function*(e){const r=e.params.url,o=e.params.requestOptions,s=e.controller.signal,i=o.body;let a=null,u=null,d=null;if(g&&"HTMLFormElement"in globalThis&&(i instanceof FormData?a=i:i instanceof HTMLFormElement&&(u=i,a=new FormData(u))),"string"==typeof i&&(d=i),e.fetchOptions={cache:o.cacheBust&&!h._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:o.headers||{},method:"head"===o.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:s},(a||d)&&(e.fetchOptions.body=a||d),"anonymous"===o.authMode&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||o.query&&o.query.token||a&&a.get&&a.get("token")||u&&u.elements.token),!e.hasToken&&t.apiKey&&c.supportsApiKey(r)&&(o.query||(o.query={}),o.query.token=t.apiKey,e.hasToken=!0),e.useIdentity&&!e.hasToken&&!e.credentialToken&&!U(r)&&!l.isAborted(s)){let t;"immediate"===o.authMode?(yield E(),t=yield n.id.getCredential(r,{signal:s}),e.credential=t):"no-prompt"===o.authMode?(yield E(),t=yield n.id.getCredential(r,{prompt:!1,signal:s}).catch((()=>{})),e.credential=t):n.id&&(t=n.id.findCredential(r)),t&&(e.credentialToken=t.token,e.useSSL=!!t.ssl)}}))).apply(this,arguments)}function U(e){return T.some((r=>r.test(e)))}function D(e){return A.apply(this,arguments)}function A(){return(A=r._asyncToGenerator((function*(e){let r=e.params.url;const t=e.params.requestOptions,o=e.fetchOptions,i=u.isBlobProtocol(r)||u.isDataProtocol(r),a=t.responseType||"json",c=i?0:null!=t.timeout?t.timeout:m.timeout;let d=!1;if(!i){e.useSSL&&(r=u.toHTTPS(r)),t.cacheBust&&"default"===o.cache&&(r=u.addQueryParameter(r,"request.preventCache",Date.now()));let i={...t.query};e.credentialToken&&(i.token=e.credentialToken);let a=u.objectToQuery(i);s("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const l=r.length+1+a.length;let c;d="delete"===t.method||"post"===t.method||"put"===t.method||!!t.body||l>m.maxUrlLength;const p=t.useProxy||!!u.getProxyRule(r);if(p){const e=u.getProxyUrl(r);c=e.path,!d&&c.length+1+l>m.maxUrlLength&&(d=!0),e.query&&(i={...e.query,...i})}if("HEAD"===o.method&&(d||p)){if(d){if(l>m.maxUrlLength)throw x("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw x("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(p)throw x("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(d?(o.method="delete"===t.method?"DELETE":"put"===t.method?"PUT":"POST",t.body?r=u.addQueryParameters(r,i):(o.body=u.objectToQuery(i),o.headers["Content-Type"]="application/x-www-form-urlencoded")):r=u.addQueryParameters(r,i),p&&(e.useProxy=!0,r=`${c}?${r}`),i.token&&g&&o.body instanceof FormData){const e=o.body;e.set?e.set("token",i.token):e.append("token",i.token)}if(t.hasOwnProperty("withCredentials"))e.withCredentials=t.withCredentials;else if(!u.hasSameOrigin(r,u.getAppUrl()))if(u.isTrustedServer(r))e.withCredentials=!0;else if(n.id){const t=n.id.findServerInfo(r);t&&t.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(o.credentials="include")}let p,f,y=0,b=!1;c>0&&(y=setTimeout((()=>{b=!0,e.controller.abort()}),c));try{if("native-request-init"===t.responseType)f=o,f.url=r;else if("image"!==t.responseType||"default"!==o.cache||"GET"!==o.method||d||F(t.headers)||!i&&!e.useProxy&&m.proxyUrl&&!S(r)){if(p=yield h._abortableFetch(r,o),e.useProxy||O(r),"native"===t.responseType)f=p;else if("HEAD"!==o.method)if(p.ok){switch(a){case"array-buffer":f=yield p.arrayBuffer();break;case"blob":case"image":f=yield p.blob();break;default:f=yield p.text()}if(y&&(clearTimeout(y),y=0),"json"===a||"xml"===a||"document"===a)if(f)switch(a){case"json":f=JSON.parse(f);break;case"xml":f=M(f,"application/xml");break;case"document":f=M(f,"text/html")}else f=null;if(f){if("array-buffer"===a||"blob"===a){const e=p.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&f["blob"===a?"size":"byteLength"]<=750)try{const e=yield new Response(f).json();e.error&&(f=e)}catch{}}"image"===a&&f instanceof Blob&&(f=yield N(URL.createObjectURL(f),e,!0))}}else f=yield p.text()}else f=yield N(r,e)}catch(w){if("AbortError"===w.name){if(b)throw new Error("Timeout exceeded");throw l.createAbortError("Request canceled")}if(!(!p&&w instanceof TypeError&&m.proxyUrl)||t.body||"delete"===t.method||"head"===t.method||"post"===t.method||"put"===t.method||e.useProxy||S(r))throw w;e.redoRequest=!0,u.addProxyRule({proxyUrl:m.proxyUrl,urlPrefix:u.getOrigin(r)})}finally{y&&clearTimeout(y)}return[p,f]}))).apply(this,arguments)}function I(e,r){return R.apply(this,arguments)}function R(){return(R=r._asyncToGenerator((function*(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let n,s;try{s=yield e.before(r)}catch(t){n=x("request:interceptor",t,r)}if((s instanceof Error||s instanceof o)&&(n=x("request:interceptor",s,r)),n)throw e.error&&e.error(n),n;return s}}))).apply(this,arguments)}function F(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}function M(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}function j(e){return H.apply(this,arguments)}function H(){return(H=r._asyncToGenerator((function*(e){var r,t;let o,s;yield _(e);try{do{[o,s]=yield D(e)}while(!(yield G(e,o,s)))}catch(l){const r=x("request:server",l,e.params,o);throw r.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(r),r}const i=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(i)&&!e.hasToken&&!e.credentialToken&&null!=(r=s)&&null!=(t=r.user)&&t.username&&!u.isTrustedServer(i)){const e=u.getOrigin(i,!0);e&&m.trustedServers.push(e)}const a=e.credential;if(a&&n.id){const e=n.id.findServerInfo(a.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=n.id.findCredential(r,a.userId);e&&-1===n.id._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:s,getHeader:o?e=>o.headers.get(e):q,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}))).apply(this,arguments)}function G(e,r,t){return B.apply(this,arguments)}function B(){return(B=r._asyncToGenerator((function*(e,r,t){if(e.redoRequest)return e.redoRequest=!1,!1;const o=e.params.requestOptions;if(!r||"native"===o.responseType||"native-request-init"===o.responseType)return!0;let s,i,a,l;if(!r.ok)throw s=new Error(`Unable to load ${r.url} status: ${r.status}`),s[k]=t,s;null!=t&&t.error&&(s=t.error),s&&(i=Number(s.code),a=s.hasOwnProperty("subcode")?Number(s.subcode):null,l=s.messageCode,l=l&&l.toUpperCase());const u=o.authMode;if(403===i&&(4===a||s.message&&s.message.toLowerCase().indexOf("ssl")>-1&&-1===s.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==u||498===i)&&-1!==b.indexOf(i)&&!U(e.params.url)&&(403!==i||-1===w.indexOf(l)&&(null==a||2===a&&e.credentialToken))){yield E();try{const r=yield n.id.getCredential(e.params.url,{error:x("request:server",s,e.params),prompt:"no-prompt"!==u,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(c){if("no-prompt"===u)return e.credential=null,e.credentialToken=null,!1;s=c}}if(s)throw s;return!0}))).apply(this,arguments)}function N(e,r,t=!1){const n=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.src=e,d.loadImageAsync(o,e,t,n)}return h._abortableFetch=null,h._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],h}));
