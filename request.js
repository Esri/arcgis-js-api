/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","./chunks/_rollupPluginBabelHelpers","./config","./kernel","./core/Error","./core/global","./core/has","./core/lang","./core/maybe","./core/promiseUtils","./core/urlUtils","./support/apiKeyUtils","./support/requestUtils"],(function(e,r,t,n,o,s,i,a,l,u,c,d,p){"use strict";function h(e){return Object.freeze({__proto__:null,default:e})}function f(e,r){return y.apply(this,arguments)}function y(){return(y=r._asyncToGenerator((function*(e,r){const t=c.isDataProtocol(e),n=c.isBlobProtocol(e);n||t||(e=c.normalize(e));const o={url:e,requestOptions:{...l.unwrap(r)}};let s=c.getInterceptor(e);if(s){const e=yield R(s,o);if(null!=e)return{data:e,getHeader:k,requestOptions:o.requestOptions,url:o.url};s.after||s.error||(s=null)}if(e=o.url,"image"===(r=o.requestOptions).responseType){if(i("host-webworker")||i("host-node"))throw v("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),o)}else if(t)throw v("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+r.responseType),o);if("head"===r.method){if(r.body)throw v("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),o);if(t||n)throw v("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),o)}if(yield E(),m)return m.execute(e,r);const a=u.createAbortController();u.onAbort(r,(()=>a.abort()));const d={controller:a,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:s,params:o,redoRequest:!1,useIdentity:g.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},p=yield j(d);return s&&s.after&&s.after(p),p}))).apply(this,arguments)}let m;const g=t.request,b="FormData"in s,w=[499,498,403,401],T=["COM_0056","COM_0057","SB_0008"],q=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],k=()=>null,O=Symbol();function S(e){const r=c.getOrigin(e);r&&!f._corsServers.includes(r)&&f._corsServers.push(r)}function x(e){const r=c.getOrigin(e);return!r||r.endsWith(".arcgis.com")||f._corsServers.includes(r)||c.isTrustedServer(r)}function v(e,r,t,n){let s="Error";const i={url:t.url,requestOptions:t.requestOptions,getHeader:k,ssl:!1};if(r instanceof o)return r.details?(r.details=a.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=i,r;if(r){const e=n&&(e=>n.headers.get(e)),t=n&&n.status,o=r.message;o&&(s=o),e&&(i.getHeader=e),i.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,i.subCode=r.subcode,i.messageCode=r.messageCode,"string"==typeof r.details?i.messages=[r.details]:i.messages=r.details,i.raw=O in r?r[O]:r}return u.isAbortError(r)?u.createAbortError():new o(e,s,i)}function E(){return P.apply(this,arguments)}function P(){return(P=r._asyncToGenerator((function*(){i("host-webworker")?m||(m=yield new Promise((function(r,t){e(["./core/workers/request"],r,t)}))):f._abortableFetch||(f._abortableFetch=s.fetch.bind(s))}))).apply(this,arguments)}function C(){return _.apply(this,arguments)}function _(){return(_=r._asyncToGenerator((function*(){n.id||(yield new Promise((function(r,t){e(["./identity/IdentityManager"],(function(e){r(h(e))}),t)})))}))).apply(this,arguments)}function L(e){return U.apply(this,arguments)}function U(){return(U=r._asyncToGenerator((function*(e){const r=e.params.url,o=e.params.requestOptions,i=e.controller.signal,a=o.body;let l=null,c=null,p=null;if(b&&"HTMLFormElement"in s&&(a instanceof FormData?l=a:a instanceof HTMLFormElement&&(c=a,l=new FormData(c))),"string"==typeof a&&(p=a),e.fetchOptions={cache:o.cacheBust&&!f._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:o.headers||{},method:"head"===o.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:i},(l||p)&&(e.fetchOptions.body=l||p),"anonymous"===o.authMode&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||o.query&&o.query.token||l&&l.get&&l.get("token")||c&&c.elements.token),!e.hasToken&&t.apiKey&&d.supportsApiKey(r)&&(o.query||(o.query={}),o.query.token=t.apiKey,e.hasToken=!0),e.useIdentity&&!e.hasToken&&!e.credentialToken&&!D(r)&&!u.isAborted(i)){let t;"immediate"===o.authMode?(yield C(),t=yield n.id.getCredential(r,{signal:i}),e.credential=t):"no-prompt"===o.authMode?(yield C(),t=yield n.id.getCredential(r,{prompt:!1,signal:i}).catch((()=>{})),e.credential=t):n.id&&(t=n.id.findCredential(r)),t&&(e.credentialToken=t.token,e.useSSL=!!t.ssl)}}))).apply(this,arguments)}function D(e){return q.some((r=>r.test(e)))}function I(e){return A.apply(this,arguments)}function A(){return(A=r._asyncToGenerator((function*(e){let r=e.params.url;const t=e.params.requestOptions,o=e.fetchOptions,s=c.isBlobProtocol(r)||c.isDataProtocol(r),a=t.responseType||"json",l=s?0:null!=t.timeout?t.timeout:g.timeout;let d=!1;if(!s){e.useSSL&&(r=c.toHTTPS(r)),t.cacheBust&&"default"===o.cache&&(r=c.addQueryParameter(r,"request.preventCache",Date.now()));let s={...t.query};e.credentialToken&&(s.token=e.credentialToken);let a=c.objectToQuery(s);i("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const l=r.length+1+a.length;let u;d="delete"===t.method||"post"===t.method||"put"===t.method||!!t.body||l>g.maxUrlLength;const p=t.useProxy||!!c.getProxyRule(r);if(p){const e=c.getProxyUrl(r);u=e.path,!d&&u.length+1+l>g.maxUrlLength&&(d=!0),e.query&&(s={...e.query,...s})}if("HEAD"===o.method&&(d||p)){if(d){if(l>g.maxUrlLength)throw v("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw v("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(p)throw v("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(d?(o.method="delete"===t.method?"DELETE":"put"===t.method?"PUT":"POST",t.body?r=c.addQueryParameters(r,s):(o.body=c.objectToQuery(s),o.headers["Content-Type"]="application/x-www-form-urlencoded")):r=c.addQueryParameters(r,s),p&&(e.useProxy=!0,r=`${u}?${r}`),s.token&&b&&o.body instanceof FormData){const e=o.body;e.set?e.set("token",s.token):e.append("token",s.token)}if(t.hasOwnProperty("withCredentials"))e.withCredentials=t.withCredentials;else if(!c.hasSameOrigin(r,c.appUrl))if(c.isTrustedServer(r))e.withCredentials=!0;else if(n.id){const t=n.id.findServerInfo(r);t&&t.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(o.credentials="include")}let p,h,y=0,m=!1;l>0&&(y=setTimeout((()=>{m=!0,e.controller.abort()}),l));try{if("native-request-init"===t.responseType)h=o,h.url=r;else if("image"!==t.responseType||"default"!==o.cache||"GET"!==o.method||d||H(t.headers)||!s&&!e.useProxy&&g.proxyUrl&&!x(r)){if(p=yield f._abortableFetch(r,o),e.useProxy||S(r),"native"===t.responseType)h=p;else if("HEAD"!==o.method)if(p.ok){switch(a){case"array-buffer":h=yield p.arrayBuffer();break;case"blob":case"image":h=yield p.blob();break;default:h=yield p.text()}if(y&&(clearTimeout(y),y=0),"json"===a||"xml"===a||"document"===a)if(h)switch(a){case"json":h=JSON.parse(h);break;case"xml":h=M(h,"application/xml");break;case"document":h=M(h,"text/html")}else h=null;if(h){if("array-buffer"===a||"blob"===a){const e=p.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&h["blob"===a?"size":"byteLength"]<=750)try{const e=yield new Response(h).json();e.error&&(h=e)}catch{}}"image"===a&&h instanceof Blob&&(h=yield Q(URL.createObjectURL(h),e,!0))}}else h=yield p.text()}else h=yield Q(r,e)}catch(w){if("AbortError"===w.name){if(m)throw new Error("Timeout exceeded");throw u.createAbortError("Request canceled")}if(!(!p&&w instanceof TypeError&&g.proxyUrl)||t.body||"delete"===t.method||"head"===t.method||"post"===t.method||"put"===t.method||e.useProxy||x(r))throw w;e.redoRequest=!0,c.addProxyRule({proxyUrl:g.proxyUrl,urlPrefix:c.getOrigin(r)})}finally{y&&clearTimeout(y)}return[p,h]}))).apply(this,arguments)}function R(e,r){return F.apply(this,arguments)}function F(){return(F=r._asyncToGenerator((function*(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let n,s;try{s=yield e.before(r)}catch(t){n=v("request:interceptor",t,r)}if((s instanceof Error||s instanceof o)&&(n=v("request:interceptor",s,r)),n)throw e.error&&e.error(n),n;return s}}))).apply(this,arguments)}function H(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}function M(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}function j(e){return G.apply(this,arguments)}function G(){return(G=r._asyncToGenerator((function*(e){var r,t;let o,s;yield L(e);try{do{[o,s]=yield I(e)}while(!(yield B(e,o,s)))}catch(l){const r=v("request:server",l,e.params,o);throw r.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(r),r}const i=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(i)&&!e.hasToken&&!e.credentialToken&&null!=(r=s)&&null!=(t=r.user)&&t.username&&!c.isTrustedServer(i)){const e=c.getOrigin(i,!0);e&&g.trustedServers.push(e)}const a=e.credential;if(a&&n.id){const e=n.id.findServerInfo(a.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=n.id.findCredential(r,a.userId);e&&-1===n.id._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:s,getHeader:o?e=>o.headers.get(e):k,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}))).apply(this,arguments)}function B(e,r,t){return N.apply(this,arguments)}function N(){return(N=r._asyncToGenerator((function*(e,r,t){if(e.redoRequest)return e.redoRequest=!1,!1;const o=e.params.requestOptions;if(!r||"native"===o.responseType||"native-request-init"===o.responseType)return!0;let s,i,a,l;if(!r.ok)throw s=new Error(`Unable to load ${r.url} status: ${r.status}`),s[O]=t,s;null!=t&&t.error&&(s=t.error),s&&(i=Number(s.code),a=s.hasOwnProperty("subcode")?Number(s.subcode):null,l=s.messageCode,l=l&&l.toUpperCase());const u=o.authMode;if(403===i&&(4===a||s.message&&s.message.toLowerCase().indexOf("ssl")>-1&&-1===s.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==u||498===i)&&-1!==w.indexOf(i)&&!D(e.params.url)&&(403!==i||-1===T.indexOf(l)&&(null==a||2===a&&e.credentialToken))){yield C();try{const r=yield n.id.getCredential(e.params.url,{error:v("request:server",s,e.params),prompt:"no-prompt"!==u,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(c){if("no-prompt"===u)return e.credential=null,e.credentialToken=null,!1;s=c}}if(s)throw s;return!0}))).apply(this,arguments)}function Q(e,r,t=!1){const n=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.src=e,p.loadImageAsync(o,e,t,n)}return f._abortableFetch=null,f._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],f}));
