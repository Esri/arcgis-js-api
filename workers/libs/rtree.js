// COPYRIGHT Â© 2022 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.42/esri/copyright.txt for details.

var RTree=function(e){var n=3,t=6;isNaN(e)||(n=Math.floor(e/2),t=e),this.min_width=n,this.max_width=t;var r,a={x:0,y:0,w:0,h:0,id:"root",nodes:[]},h=(r={},function(e,t,r){var a=[],h=[],s=[];if(!e||!RTree.Rectangle.overlap_rectangle(e,r))return s;var i={x:e.x,y:e.y,w:e.w,h:e.h,target:t};h.push(r.nodes.length),a.push(r);do{var o=a.pop(),x=h.pop()-1;if("target"in i)for(;x>=0;){var c=o.nodes[x];if(RTree.Rectangle.overlap_rectangle(i,c)){if(i.target&&"leaf"in c&&c.leaf===i.target||!i.target&&("leaf"in c||RTree.Rectangle.contains_rectangle(c,i))){"nodes"in c?(s=l(c,!0,[],c),o.nodes.splice(x,1)):s=o.nodes.splice(x,1),RTree.Rectangle.make_MBR(o.nodes,o),delete i.target,o.nodes.length<n&&(i.nodes=l(o,!0,[],o));break}"nodes"in c&&(1,h.push(x),a.push(o),o=c,x=c.nodes.length)}x-=1}else if("nodes"in i){o.nodes.splice(x+1,1),o.nodes.length>0&&RTree.Rectangle.make_MBR(o.nodes,o);for(var d=0;d<i.nodes.length;d++)g(i.nodes[d],o);i.nodes.length=0,0===a.length&&o.nodes.length<=1?(i.nodes=l(o,!0,i.nodes,o),o.nodes.length=0,a.push(o),h.push(1)):a.length>0&&o.nodes.length<n?(i.nodes=l(o,!0,i.nodes,o),o.nodes.length=0):delete i.nodes}else RTree.Rectangle.make_MBR(o.nodes,o);1}while(a.length>0);return s}),s=function(e){for(var n=o(e);e.length>0;)i(e,n[0],n[1]);return n},i=function(e,t,r){for(var a,h,s,i=RTree.Rectangle.squarified_ratio(t.w,t.h,t.nodes.length+1),o=RTree.Rectangle.squarified_ratio(r.w,r.h,r.nodes.length+1),l=e.length-1;l>=0;l--){var g=e[l],x={};x.x=Math.min(t.x,g.x),x.y=Math.min(t.y,g.y),x.w=Math.max(t.x+t.w,g.x+g.w)-x.x,x.h=Math.max(t.y+t.h,g.y+g.h)-x.y;var c=Math.abs(RTree.Rectangle.squarified_ratio(x.w,x.h,t.nodes.length+2)-i),d={};d.x=Math.min(r.x,g.x),d.y=Math.min(r.y,g.y),d.w=Math.max(r.x+r.w,g.x+g.w)-d.x,d.h=Math.max(r.y+r.h,g.y+g.h)-d.y;var u=Math.abs(RTree.Rectangle.squarified_ratio(d.w,d.h,r.nodes.length+2)-o);(!h||!a||Math.abs(u-c)<a)&&(h=l,a=Math.abs(u-c),s=u<c?r:t)}var y=e.splice(h,1)[0];t.nodes.length+e.length+1<=n?(t.nodes.push(y),RTree.Rectangle.expand_rectangle(t,y)):r.nodes.length+e.length+1<=n?(r.nodes.push(y),RTree.Rectangle.expand_rectangle(r,y)):(s.nodes.push(y),RTree.Rectangle.expand_rectangle(s,y))},o=function(e){for(var n,t,r=e.length-1,a=0,h=e.length-1,s=0,i=e.length-2;i>=0;i--){var o=e[i];o.x>e[a].x?a=i:o.x+o.w<e[r].x+e[r].w&&(r=i),o.y>e[s].y?s=i:o.y+o.h<e[h].y+e[h].h&&(h=i)}return Math.abs(e[r].x+e[r].w-e[a].x)>Math.abs(e[h].y+e[h].h-e[s].y)?r>a?(n=e.splice(r,1)[0],t=e.splice(a,1)[0]):(t=e.splice(a,1)[0],n=e.splice(r,1)[0]):h>s?(n=e.splice(h,1)[0],t=e.splice(s,1)[0]):(t=e.splice(s,1)[0],n=e.splice(h,1)[0]),[{x:n.x,y:n.y,w:n.w,h:n.h,nodes:[n]},{x:t.x,y:t.y,w:t.w,h:t.h,nodes:[t]}]},l=function(e,n,t,r){var a=[];if(!RTree.Rectangle.overlap_rectangle(e,r))return t;a.push(r.nodes);do{for(var h=a.pop(),s=h.length-1;s>=0;s--){var i=h[s];RTree.Rectangle.overlap_rectangle(e,i)&&("nodes"in i?a.push(i.nodes):"leaf"in i&&(n?t.push(i):t.push(i.leaf)))}}while(a.length>0);return t},g=function(e,n){var r;if(0===n.nodes.length)return n.x=e.x,n.y=e.y,n.w=e.w,n.h=e.h,void n.nodes.push(e);var a=function(e,n){var t,r=-1,a=[];a.push(n);var h=n.nodes;do{-1!==r&&(a.push(h[r]),h=h[r].nodes,r=-1);for(var s=h.length-1;s>=0;s--){var i=h[s];if("leaf"in i){r=-1;break}var o=RTree.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),l=Math.max(i.x+i.w,e.x+e.w)-Math.min(i.x,e.x),g=Math.max(i.y+i.h,e.y+e.h)-Math.min(i.y,e.y),x=RTree.Rectangle.squarified_ratio(l,g,i.nodes.length+2);(r<0||Math.abs(x-o)<t)&&(t=Math.abs(x-o),r=s)}}while(-1!==r);return a}(e,n),h=e;do{if(r&&"nodes"in r&&0===r.nodes.length){var i=r;r=a.pop();for(var o=0;o<r.nodes.length;o++)if(r.nodes[o]===i||0===r.nodes[o].nodes.length){r.nodes.splice(o,1);break}}else r=a.pop();if("leaf"in h||"nodes"in h||Array.isArray(h)){if(Array.isArray(h)){for(var l=0;l<h.length;l++)RTree.Rectangle.expand_rectangle(r,h[l]);r.nodes=r.nodes.concat(h)}else RTree.Rectangle.expand_rectangle(r,h),r.nodes.push(h);if(r.nodes.length<=t)h={x:r.x,y:r.y,w:r.w,h:r.h};else{var g=s(r.nodes);h=g,a.length<1&&(r.nodes.push(g[0]),a.push(r),h=g[1])}}else RTree.Rectangle.expand_rectangle(r,h),h={x:r.x,y:r.y,w:r.w,h:r.h}}while(a.length>0)};this.serialize=function(){return JSON.stringify(a)},this.deserialize=function(e,n){var t,r;return r=e,(t=n=n||a).nodes=r.nodes,t.x=r.x,t.y=r.y,t.w=r.w,t.h=r.h,n},this.search=function(e,n){var t=[e,!!n,[],a];if(void 0===e)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";return l.apply(this,t)},this.remove=function(e,n){var t=Array.prototype.slice.call(arguments);if(1===t.length&&t.push(!1),t.push(a),!1===n){var r=0,s=[];do{r=s.length,s=s.concat(h.apply(this,t))}while(r!==s.length);return s}return h.apply(this,t)},this.insert=function(e,n){if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object.";var t={x:e.x,y:e.y,w:e.w,h:e.h,leaf:n};return g(t,a),a}};RTree.Rectangle=function(e,n,t,r){var a,h,s,i,o,l;e.x?(a=e.x,s=e.y,0!==e.w&&!e.w&&e.x2?(o=e.x2-e.x,l=e.y2-e.y):(o=e.w,l=e.h),h=a+o,i=s+l):(h=(a=e)+(o=t),i=(s=n)+(l=r)),this.x1=this.x=function(){return a},this.y1=this.y=function(){return s},this.x2=function(){return h},this.y2=function(){return i},this.w=function(){return o},this.h=function(){return l},this.toJSON=function(){return'{"x":'+a.toString()+', "y":'+s.toString()+', "w":'+o.toString()+', "h":'+l.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var n=Math.min(this.x(),e.x()),t=Math.min(this.y(),e.y());return o=Math.max(this.x2(),e.x2())-n,l=Math.max(this.y2(),e.y2())-t,a=n,s=t,this},this.setRect=function(e,n,t,r){var a,h,s,i;e.x?(a=e.x,h=e.y,0!==e.w&&!e.w&&e.x2?(s=e.x2-e.x,i=e.y2-e.y):(s=e.w,i=e.h),a+s):((a=e)+(s=t),h=n,i=r)}},RTree.Rectangle.overlap_rectangle=function(e,n){return e.x<n.x+n.w&&e.x+e.w>n.x&&e.y<n.y+n.h&&e.y+e.h>n.y},RTree.Rectangle.contains_rectangle=function(e,n){return e.x+e.w<=n.x+n.w&&e.x>=n.x&&e.y+e.h<=n.y+n.h&&e.y>=n.y},RTree.Rectangle.expand_rectangle=function(e,n){var t,r;return t=e.x<n.x?e.x:n.x,r=e.y<n.y?e.y:n.y,e.x+e.w>n.x+n.w?e.w=e.x+e.w-t:e.w=n.x+n.w-t,e.y+e.h>n.y+n.h?e.h=e.y+e.h-r:e.h=n.y+n.h-r,e.x=t,e.y=r,e},RTree.Rectangle.make_MBR=function(e,n){if(e.length<1)return{x:0,y:0,w:0,h:0};n?(n.x=e[0].x,n.y=e[0].y,n.w=e[0].w,n.h=e[0].h):n={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h};for(var t=e.length-1;t>0;t--)RTree.Rectangle.expand_rectangle(n,e[t]);return n},RTree.Rectangle.squarified_ratio=function(e,n,t){var r=(e+n)/2,a=e*n;return a*t/(a/(r*r))};