/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../request","../core/accessorSupport/decorators/property","../core/arrayUtils","../core/has","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./Network","./support/NamedTraceConfiguration","./support/TerminalConfiguration"],(function(e,r,t,o,n,a,i,s,l,u,d){"use strict";let c=function(r){function o(e){var t;return(t=r.call(this,e)||this).sharedNamedTraceConfigurations=[],t.type="utility",t}e._inheritsLoose(o,r);var n=o.prototype;return n.load=function(){var t=e._asyncToGenerator((function*(e){return this.addResolvingPromise(r.prototype.load.call(this,e)),this.addResolvingPromise(this._loadNamedTraceConfigurationsFromNetwork(e)),this}));function o(e){return t.apply(this,arguments)}return o}(),n.getTerminalConfiguration=function(e){let r=null,t=null;const o=e.layer;let n=null;if("feature"!==(null==o?void 0:o.type))return null;if(n=o.layerId,null===n)return null;const a=e.attributes;if(null==a)return null;for(const d of Object.keys(a))"ASSETGROUP"===d.toUpperCase()&&(r=e.getAttribute(d)),"ASSETTYPE"===d.toUpperCase()&&(t=e.getAttribute(d));if(!this.dataElement)return null;let i=null;const s=this.dataElement.domainNetworks;for(const d of s){var l;const e=null==(l=d.junctionSources)?void 0:l.find((e=>e.layerId===n));if(e){var u;const o=null==(u=e.assetGroups)?void 0:u.find((e=>e.assetGroupCode===r));if(o){var c;const e=null==(c=o.assetTypes)?void 0:c.find((e=>e.assetTypeCode===t));if(e){i=e.terminalConfigurationId;break}}}}if(null!=i){const e=this.dataElement.terminalConfigurations,r=null==e?void 0:e.find((e=>e.terminalConfigurationId===i));return r?d.fromJSON(r):null}return null},n.getTierNames=function(e){var r;const t=null==(r=this.dataElement)?void 0:r.domainNetworks.find((r=>r.domainNetworkName===e));return(null==t?void 0:t.tiers.map((e=>e.name)))||[]},n._loadNamedTraceConfigurationsFromNetwork=function(){var r=e._asyncToGenerator((function*(e){var r;if(0===(null==(r=this.sharedNamedTraceConfigurations)?void 0:r.length))return;const t=this.sharedNamedTraceConfigurations.map((e=>e.globalId)),o=yield this._fetchTraceConfigData(this.networkServiceUrl,t,e);for(const n of this.sharedNamedTraceConfigurations){const e=null==o?void 0:o.find((e=>e.globalId===n.globalId));e&&n.read(e,{origin:"service"})}}));function t(e){return r.apply(this,arguments)}return t}(),n._fetchTraceConfigData=function(e,r,o){return t(`${e}/traceConfigurations/query`,{responseType:"json",query:{globalIds:JSON.stringify(r),f:"json"},...o}).then((e=>e.data.traceConfigurations))},e._createClass(o,[{key:"serviceTerritoryFeatureLayerId",get:function(){var e;return null==(e=this.dataElement)?void 0:e.serviceTerritoryFeatureLayerId}},{key:"rulesTableId",get:function(){var e;return null==(e=this.sourceJSON)?void 0:e.systemLayers.rulesTableId}},{key:"rulesTableUrl",get:function(){return this.sourceJSON?`${this.featureServiceUrl}/${this.rulesTableId}`:null}},{key:"terminalConfigurations",get:function(){var e;return(null==(e=this.dataElement)?void 0:e.terminalConfigurations.map((e=>d.fromJSON(e))))||[]}},{key:"domainNetworkNames",get:function(){var e;return(null==(e=this.dataElement)?void 0:e.domainNetworks.map((e=>e.domainNetworkName)))||[]}}]),o}(l);r.__decorate([o.property({type:[u],json:{origins:{"web-map":{read:{source:"traceConfigurations"},write:{target:"traceConfigurations"}},service:{read:{source:"traceConfigurations"}}},read:!1}})],c.prototype,"sharedNamedTraceConfigurations",void 0),r.__decorate([o.property({type:["utility"],readOnly:!0,json:{read:!1,write:!1}})],c.prototype,"type",void 0),r.__decorate([o.property({readOnly:!0})],c.prototype,"serviceTerritoryFeatureLayerId",null),r.__decorate([o.property({readOnly:!0})],c.prototype,"rulesTableId",null),r.__decorate([o.property({readOnly:!0})],c.prototype,"rulesTableUrl",null),r.__decorate([o.property({readOnly:!0})],c.prototype,"terminalConfigurations",null),r.__decorate([o.property({readOnly:!0})],c.prototype,"domainNetworkNames",null),c=r.__decorate([s.subclass("esri.networks.UtilityNetwork")],c);return c}));
