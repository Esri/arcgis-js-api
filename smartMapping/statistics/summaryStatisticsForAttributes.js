/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","./support/utils","../support/utils","../support/adapters/support/layerUtils"],(function(e,r,s,t,i,n){"use strict";function a(e){return u.apply(this,arguments)}function u(){return(u=e._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.attributes))throw new r("summary-statistics-for-attributes:missing-parameters","'layer' and 'attributes' parameters are required");if(e.attributes.some((e=>!!e.valueExpression))&&!e.view)throw new r("summary-statistics-for-attributes:missing-parameters","View is required when 'valueExpression' is specified in attributes");const a=[n.LayerType.CSVLayer,n.LayerType.FeatureLayer,n.LayerType.OGCFeatureLayer,n.LayerType.GeoJSONLayer,n.LayerType.WFSLayer],{layer:u,...l}=e,o=n.createLayerAdapter(u,a),p={layerAdapter:o,...l};if(p.includeZeros=null==p.includeZeros||p.includeZeros,p.includeNegatives=null==p.includeNegatives||p.includeNegatives,!o)throw new r("summary-statistics-for-attributes:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(a).join(", "));const y=p.view,c=s.isSome(p.signal)?{signal:p.signal}:null;yield Promise.all([y&&y.when(),o.load(c)]);const f=[];for(const r of p.attributes){const e=yield i.getFieldsList({field:r.field,valueExpression:r.valueExpression});Array.prototype.push.apply(f,e)}const d=t.verifyBasicFieldValidity(o,f,"summary-statistics-for-attributes:invalid-parameters");if(d)throw d;return p}))).apply(this,arguments)}function l(e,r,s){const t=[],i=[],n=[],a=[],u=[];e.forEach(((e,r)=>{const l=e.field?"field":"expression",o=e.field||e.valueExpression;e.field?(u.push(o),i.push(`var ${l}${r} = Number($feature["${o}"]);`)):(t.push(`function getValueForExpr${r}() {\n  ${o} \n}`),i.push(`var ${l}${r} = Number(getValueForExpr${r}());`)),s||n.push(`${l}${r} = IIf(${l}${r} < 0, 0, ${l}${r});`),a.push(`${l}${r}`)}));let l="return sum;";const o=t.length?null:u.reduce(((e,r)=>`${e} + ${r}`));let p=null;r||s?r?s||(l="return IIf(sum >= 0, sum, null);",o&&(p=`(( ${o} ) >= 0)`)):(l="return IIf(sum != 0, sum, null);",o&&(p=`(( ${o} ) <> 0)`)):(l="return IIf(sum > 0, sum, null);",o&&(p=`(( ${o} ) > 0)`));return{valueExpression:[t.length?t.join("\n"):"",i.join("\n"),n.join("\n"),`var sum = ${a.join(" + ")};`,l].filter(Boolean).join("\n\n"),sqlExpression:o,sqlWhere:p}}function o(e){return p.apply(this,arguments)}function p(){return(p=e._asyncToGenerator((function*(e){const{layerAdapter:r,...s}=yield a(e),t=l(s.attributes,s.includeZeros,s.includeNegatives);return r.summaryStatistics({valueExpression:t.valueExpression,sqlExpression:t.sqlExpression,sqlWhere:t.sqlWhere,view:s.view,signal:s.signal})}))).apply(this,arguments)}return o}));
