/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","./support/utils","../support/utils","../support/adapters/support/layerUtils"],(function(e,s,r,t,i,n){"use strict";function u(e){return a.apply(this,arguments)}function a(){return(a=e._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.attributes))throw new s("summary-statistics-for-attributes:missing-parameters","'layer' and 'attributes' parameters are required");if(e.attributes.some((e=>!!e.valueExpression))&&!e.view)throw new s("summary-statistics-for-attributes:missing-parameters","View is required when 'valueExpression' is specified in attributes");const u=[0,2,3,1,6],{layer:a,...l}=e,o=n.createLayerAdapter(a,u),p={layerAdapter:o,...l};if(p.includeZeros=null==p.includeZeros||p.includeZeros,p.includeNegatives=null==p.includeNegatives||p.includeNegatives,!o)throw new s("summary-statistics-for-attributes:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(u).join(", "));const c=p.view,f=r.isSome(p.signal)?{signal:p.signal}:null;yield Promise.all([c&&c.when(),o.load(f)]);const d=[];for(const s of p.attributes){const e=yield i.getFieldsList({field:s.field,valueExpression:s.valueExpression});Array.prototype.push.apply(d,e)}const m=t.verifyBasicFieldValidity(o,d,"summary-statistics-for-attributes:invalid-parameters");if(m)throw m;return p}))).apply(this,arguments)}function l(e,s,r){const t=[],i=[],n=[],u=[],a=[];e.forEach(((e,s)=>{const l=e.field?"field":"expression",o=e.field||e.valueExpression;e.field?(a.push(o),i.push(`var ${l}${s} = Number($feature["${o}"]);`)):(t.push(`function getValueForExpr${s}() {\n  ${o} \n}`),i.push(`var ${l}${s} = Number(getValueForExpr${s}());`)),r||n.push(`${l}${s} = IIf(${l}${s} < 0, 0, ${l}${s});`),u.push(`${l}${s}`)}));let l="return sum;";const o=t.length?null:a.reduce(((e,s)=>`${e} + ${s}`));let p=null;s||r?s?r||(l="return IIf(sum >= 0, sum, null);",o&&(p=`(( ${o} ) >= 0)`)):(l="return IIf(sum != 0, sum, null);",o&&(p=`(( ${o} ) <> 0)`)):(l="return IIf(sum > 0, sum, null);",o&&(p=`(( ${o} ) > 0)`));return{valueExpression:[t.length?t.join("\n"):"",i.join("\n"),n.join("\n"),`var sum = ${u.join(" + ")};`,l].filter(Boolean).join("\n\n"),sqlExpression:o,sqlWhere:p}}function o(e){return p.apply(this,arguments)}function p(){return(p=e._asyncToGenerator((function*(e){const{layerAdapter:s,...r}=yield u(e),t=l(r.attributes,r.includeZeros,r.includeNegatives);return s.summaryStatistics({valueExpression:t.valueExpression,sqlExpression:t.sqlExpression,sqlWhere:t.sqlWhere,view:r.view,signal:r.signal})}))).apply(this,arguments)}return o}));
