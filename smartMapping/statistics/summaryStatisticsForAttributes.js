/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../core/maybe","../../core/Error","../../core/promiseUtils","../support/utils","./support/utils","../support/adapters/support/layerUtils"],(function(e,s,r,t,i,n){"use strict";return async function(a){const{layerAdapter:u,...l}=await async function(a){if(!(a&&a.layer&&a.attributes))throw new s("summary-statistics-for-attributes:missing-parameters","'layer' and 'attributes' parameters are required");if(a.attributes.some((e=>!!e.valueExpression))&&!a.view)throw new s("summary-statistics-for-attributes:missing-parameters","View is required when 'valueExpression' is specified in attributes");const u=[2,1],{layer:l,...o}=a,p=n.createLayerAdapter(l,u),c={layerAdapter:p,...o};if(c.includeZeros=null==c.includeZeros||c.includeZeros,c.includeNegatives=null==c.includeNegatives||c.includeNegatives,!p)throw new s("summary-statistics-for-attributes:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(u).join(", "));const f=c.view,m=e.isSome(c.signal)?{signal:c.signal}:null;await r.all([f&&f.when(),p.load(m)]);const d=[];for(const e of c.attributes){const s=await t.getFieldsList({field:e.field,valueExpression:e.valueExpression});Array.prototype.push.apply(d,s)}const y=i.verifyBasicFieldValidity(p,d,"summary-statistics-for-attributes:invalid-parameters");if(y)throw y;return c}(a),o=function(e,s,r){const t=[],i=[],n=[],a=[],u=[];e.forEach(((e,s)=>{const l=e.field?"field":"expression",o=e.field||e.valueExpression;e.field?(u.push(o),i.push(`var ${l}${s} = Number($feature["${o}"]);`)):(t.push(`function getValueForExpr${s}() {\n  ${o} \n}`),i.push(`var ${l}${s} = Number(getValueForExpr${s}());`)),r||n.push(`${l}${s} = IIf(${l}${s} < 0, 0, ${l}${s});`),a.push(`${l}${s}`)}));let l="return sum;";const o=t.length?null:u.reduce(((e,s)=>`${e} + ${s}`));let p=null;return s||r?s?r||(l="return IIf(sum >= 0, sum, null);",o&&(p=`(( ${o} ) >= 0)`)):(l="return IIf(sum != 0, sum, null);",o&&(p=`(( ${o} ) <> 0)`)):(l="return IIf(sum > 0, sum, null);",o&&(p=`(( ${o} ) > 0)`)),{valueExpression:[t.length?t.join("\n"):"",i.join("\n"),n.join("\n"),`var sum = ${a.join(" + ")};`,l].filter(Boolean).join("\n\n"),sqlExpression:o,sqlWhere:p}}(l.attributes,l.includeZeros,l.includeNegatives);return u.summaryStatistics({valueExpression:o.valueExpression,sqlExpression:o.sqlExpression,sqlWhere:o.sqlWhere,view:l.view,signal:l.signal})}}));
