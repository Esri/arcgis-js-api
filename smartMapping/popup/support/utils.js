/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/arrayUtils","../../../intl/messages","../../../intl/substitute","../../../layers/support/fieldUtils","../../../popup/content/AttachmentsContent","../../../popup/content/Content","../../../popup/content/CustomContent","../../../popup/content/ExpressionContent","../../../popup/content/FieldsContent","../../../popup/content/MediaContent","../../../popup/content/RelationshipContent","../../../popup/content/TextContent","../../../popup/ExpressionInfo","../../../popup/FieldInfo","../../../renderers/support/utils","../../../renderers/visualVariables/support/visualVariableUtils","../../support/adapters/support/utils"],(function(e,n,t,i,s,o,l,a,r,p,u,f,d,c,m,g,b,x,F){"use strict";let y=0;const h="expression/";function I(e){return"hasVisualVariables"in e&&e.hasVisualVariables()?e.visualVariables.filter((e=>!x.viewScaleRE.test(e.valueExpression)&&(!("target"in e)||"outline"!==e.target))):[]}function T(e,n){if(!n)return null;return F.getFeatureReductionFields(e)?.find((e=>e.name.toLowerCase()===n.toLowerCase()))}function $(e,n,t){let i=null;if(t){const n=e.featureReduction;n&&"popupTemplate"in n&&n.popupTemplate&&(i=n.popupTemplate.fieldInfos)}else"popupTemplate"in e&&e.popupTemplate&&(i=e.popupTemplate.fieldInfos);const s=t?T(e,n):e.getField(n);let l=null;if(i&&i.some((e=>!(!e||e.fieldName.toLowerCase()!==s.name.toLowerCase())&&(l=e.clone(),!0))),!l){const e=o.numericTypes.includes(s.type),n="integer"===s.type||"small-integer"===s.type;l=new g({fieldName:s.name,isEditable:s.editable,visible:!0,format:e?{places:n?0:2,digitSeparator:!0}:null})}return l.label||(l.label=s.alias),l}function V(e){const{expression:n,title:t,returnType:i}=e;return new m({name:"expr"+y++,expression:n,title:t,returnType:i})}function C(e){const n="number"===e.returnType?{places:2,digitSeparator:!0}:null;return new g({fieldName:`${h}${e.name}`,visible:!0,format:n})}function w(e){return v.apply(this,arguments)}function v(){return(v=n._asyncToGenerator((function*(e){const n=yield i.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),{renderer:o,layer:l,normFieldExpressionTemplate:a,isFeatureReduction:r}=e,p=[],u=[],f=b.getAttributes(o,I);for(const t of f)if("field"===t.type)p.push($(l,t.field,r));else if("normalized-field"===t.type){const e=r?T(l,t.field):l.getField(t.field),i=r?T(l,t.normalizationField):l.getField(t.normalizationField),o=V({type:"expression",expression:`\n      $feature["${e.name}"];\n      $feature["${i.name}"];\n      ${"percentage"===a?`($feature["${e.name}"] / $feature["${i.name}"]) * 100;`:`$feature["${e.name}"] / $feature["${i.name}"];`}\n      `,title:"percentage"===a?s.substitute(n.normFieldLabelAsPercent,{expression1:e.alias,expression2:i.alias}):s.substitute(n.normFieldLabel,{expression1:e.alias,expression2:i.alias}),returnType:"number"});p.push(C(o),$(l,t.field,r),$(l,t.normalizationField,r)),u.push(o)}else if("expression"===t.type){const e=V(t);p.push(C(e)),u.push(e)}return{fieldInfos:t.unique(p,((e,n)=>e.fieldName===n.fieldName)),expressionInfos:t.unique(u,((e,n)=>e.expression===n.expression))}}))).apply(this,arguments)}function z(e,n,t){return E.apply(this,arguments)}function E(){return(E=n._asyncToGenerator((function*(e,n,t){const{fieldInfos:o,expressionInfos:l}=n,a=yield i.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");if(o.length>2)return[new u({fieldInfos:o})];const r=[];for(const i of o){const n=i.fieldName;let o=i.label;if(!o){const i=t?T(e,n):e.getField(n);if(i)o=i.alias||n;else if(l){const e=n.split(h)[1],t=l[l.findIndex((n=>n.name===e))];t&&(o=t.title||t.name)}}r.push(new c({text:s.substitute(a.fieldInfo,{fieldLabel:o,fieldValue:`{${n}}`})}))}return r}))).apply(this,arguments)}function M(e){return!(!("normalizationField"in e)||!e.normalizationField)||"hasVisualVariables"in e&&e.hasVisualVariables()&&e.visualVariables.some((e=>!(!("normalizationField"in e)||!e.normalizationField)))}e.expressionFieldPrefix=h,e.getContentFromFieldInfos=z,e.getExpressionInfo=V,e.getFieldAndExpressionInfos=w,e.getFieldInfo=$,e.getFieldInfoFromExpressionInfo=C,e.getPrimaryVisualVariables=I,e.hasNormalizedField=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
