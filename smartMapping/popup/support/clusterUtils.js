/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../../PopupTemplate.js";import{fetchMessageBundle as t}from"../../../intl/messages.js";import{substitute as s}from"../../../intl/substitute.js";import{numericTypes as i}from"../../../layers/support/fieldUtils.js";import r from"../../../popup/ExpressionInfo.js";import l from"../../../popup/FieldInfo.js";import o from"../../../popup/support/FieldInfoFormat.js";import{getStatisticInfos as n,clusterCountField as a,getClusterField as u,getPredominantTypeExpression as p}from"../../support/clusterUtils.js";import{isClusterCompatibleRenderer as m}from"../../../views/2d/layers/support/clusterUtils.js";function f(e){const{fieldName:t,label:s,type:r}=e,n=i.includes(r),a=new l({fieldName:t,label:s,visible:!0,format:n?{places:"integer"===r||"small-integer"===r?0:2,digitSeparator:!0}:null});return"date"===r&&(a.format=new o({dateFormat:"short-date-short-time"})),a}function c(e,t){const s=t.getField(e);return s&&(s.alias||s.name)}function d(e,t,i){const{attributeInfo:r,statisticType:l}=t,{field:o,normalizationField:n}=r;let a,u="";if("avg"===l?a=n?i.clusters.avgNormFieldLabel:i.clusters.avgFieldLabel:"type"===l&&(a=i.clusters.predominantFieldLabel),a){const t=r.valueExpression?r.valueExpressionTitle:c(o,e),i=n&&c(n,e);u=s(a,{fieldLabel:t||"",normFieldLabel:i||""})}return u}function b(e,t,i,r){const{attributeInfo:l,statisticType:o}=t,{field:n,normalizationField:a}=l;let u,p="";if("avg"===o?u=a?r.clusters.avgNormFieldSummary:r.clusters.avgFieldSummary:"type"===o&&(u=r.clusters.predominantFieldSummary),u){const t=l.valueExpression?l.valueExpressionTitle:c(n,e),r=a&&c(a,e);p=s(u,{fieldLabel:t||"",normFieldLabel:r||"",fieldValue:"{"+i+"}"})}return p}async function y(i,l){if(!m(l))return null;const o=n(i,l),c=await t("esri/smartMapping/t9n/smartMapping"),y=c.clusters.predominantNoneValue,g="unique-value"===l.type?l.uniqueValueInfos:[],F=[],v=[],j=[];F.push(s(c.clusters.countSummary,{count:`{${a}}`})),v.push(f({fieldName:a,label:c.clusters.numFeatures,type:"integer"}));for(const e of o){const{statisticType:t,attributeInfo:s}=e,l=u(s,t),o=d(i,e,c);if("avg"===t)F.push(b(i,e,l,c)),v.push(f({fieldName:l,label:o,type:"double"}));else if("type"===t){const t=`expression/${l}`;F.push(b(i,e,t,c)),j.push(new r({name:l,title:o,returnType:"string",expression:p(g,l,y)})),v.push(f({fieldName:t}))}}return new e({fieldInfos:v,expressionInfos:j,content:F.join("<br/><br/>"),title:c.clusters.clusterPopupTitle})}export{y as createPopupTemplate};
