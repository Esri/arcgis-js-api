/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../../layers/support/fieldUtils","../../../popup/support/FieldInfoFormat","../../../popup/FieldInfo","../../../popup/ExpressionInfo","../../../PopupTemplate","../../../intl/substitute","../../../intl/messages","../../support/clusterUtils","../../../views/2d/layers/support/clusterUtils"],(function(e,t,s,i,l,n,r,u,a,o){"use strict";function p(e){const{fieldName:l,label:n,type:r}=e,u=t.numericTypes.indexOf(r)>-1,a=new i({fieldName:l,label:n,visible:!0,format:u?{places:"integer"===r||"small-integer"===r?0:2,digitSeparator:!0}:null});return"date"===r&&(a.format=new s({dateFormat:"short-date-short-time"})),a}function d(e,t){const s=t.getField(e);return s&&(s.alias||s.name)}function c(e,t,s){const{attributeInfo:i,statisticType:l}=t,{field:n,normalizationField:u}=i;let a,o="";if("avg"===l?a=u?s.clusters.avgNormFieldLabel:s.clusters.avgFieldLabel:"type"===l&&(a=s.clusters.predominantFieldLabel),a){const t=i.valueExpression?i.valueExpressionTitle:d(n,e),s=u&&d(u,e);o=r.substitute(a,{fieldLabel:t||"",normFieldLabel:s||""})}return o}function f(e,t,s,i){const{attributeInfo:l,statisticType:n}=t,{field:u,normalizationField:a}=l;let o,p="";if("avg"===n?o=a?i.clusters.avgNormFieldSummary:i.clusters.avgFieldSummary:"type"===n&&(o=i.clusters.predominantFieldSummary),o){const t=l.valueExpression?l.valueExpressionTitle:d(u,e),i=a&&d(a,e);p=r.substitute(o,{fieldLabel:t||"",normFieldLabel:i||"",fieldValue:"{"+s+"}"})}return p}e.createPopupTemplate=async function(e,t){if(!o.isClusterCompatibleRenderer(t))return null;const s=a.getStatisticInfos(e,t),i=await u.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),d=i.clusters.predominantNoneValue,m="unique-value"===t.type?t.uniqueValueInfos:[],b=[],y=[],g=[];b.push(r.substitute(i.clusters.countSummary,{count:`{${a.clusterCountField}}`})),y.push(p({fieldName:a.clusterCountField,label:i.clusters.numFeatures,type:"integer"}));for(const t of s){const{statisticType:s,attributeInfo:n}=t,r=a.getClusterField(n,s),u=c(e,t,i);if("avg"===s)b.push(f(e,t,r,i)),y.push(p({fieldName:r,label:u,type:"double"}));else if("type"===s){const s=`expression/${r}`;b.push(f(e,t,s,i)),g.push(new l({name:r,title:u,returnType:"string",expression:a.getPredominantTypeExpression(m,r,d)})),y.push(p({fieldName:s}))}}return new n({fieldInfos:y,expressionInfos:g,content:b.join("<br/><br/>")})},Object.defineProperty(e,"__esModule",{value:!0})}));
