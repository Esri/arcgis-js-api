/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/support/rasterFunctions/stretchUtils","./RasterLayerAdapter"],(function(t,e,r,a,s,i,o,n,l,c,h){"use strict";let u=function(e){function s(){return e.apply(this,arguments)||this}t._inheritsLoose(s,e);var i=s.prototype;return i.generateRasterInfo=function(){var e=t._asyncToGenerator((function*(t){const{layer:e}=this;if("imagery-tile"===e.type){return(yield e.generateRasterInfo(e.rasterFunction,{signal:t?.signal}))??e.rasterInfo}return this.rasterInfo}));function r(t){return e.apply(this,arguments)}return r}(),i.estimateStatisticsHistograms=function(){var e=t._asyncToGenerator((function*(t){if(null!==this._statsCache)return this._statsCache;const{raster:e}=this.layer,{extent:s,width:i,height:o}=this._getSamplePixelBlockDescriptor(e.rasterInfo),{pixelBlock:n}=yield e.fetchPixels(s,i,o,t);if(a.isNone(n))throw new r("raster-layer-adapter","Unable to estimate histograms");return this._statsCache=c.estimateStatisticsHistograms(n),this._statsCache}));function s(t){return e.apply(this,arguments)}return s}(),i.supportsMultidirectionalHillshade=function(){return!0},i.load=function(t){return this.addResolvingPromise(this.layer.load(t).then((()=>this.rasterInfo=this.layer.raster.rasterInfo))),Promise.resolve(this)},i._getSamplePixelBlockDescriptor=function(t,e=1e3){const{pyramidScalingFactor:r,maximumPyramidLevel:a}=t.storageInfo;let{extent:s,width:i,height:o,pixelSize:n}=t,c=Math.ceil(Math.log(Math.max(i,o)/e)/Math.log(r))-1,h=0,u=0;if(c<=a){const t=r**c;i=Math.floor(i/t),o=Math.floor(o/t)}else c=0,i=Math.min(i,e),o=Math.min(o,e),h=Math.max(Math.floor(i/2-500),0),u=Math.max(Math.floor(o/2-500),0),s=new l({xmin:s.xmin+h*n.x,xmax:Math.min(s.xmax,s.xmin+h*n.x*e),ymin:s.ymin+u*n.y,ymax:Math.min(s.ymax,s.ymin+u*n.y*e)});return{extent:s,width:i,height:o,origin:{x:h,y:u}}},s}(h);e.__decorate([s.property()],u.prototype,"layer",void 0),u=e.__decorate([n.subclass("esri.smartMapping.support.adapters.ImageryTileLayerAdapter")],u);return u}));
