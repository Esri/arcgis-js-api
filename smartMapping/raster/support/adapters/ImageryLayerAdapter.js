/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/maybe","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/urlUtils","../../../../core/uuid","../../../../portal/support/resourceExtension","../../../../geometry/Point","../../../../geometry","../../../../layers/support/rasterFunctions/pixelUtils","../../../../tasks/support/ImageHistogramParameters","./RasterLayerAdapter"],(function(e,t,s,r,i,a,o,n,l,u,c,p,h,g,d,m){"use strict";let y=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._cacheSize=20,e._statsCache=new Map,e}e._inheritsLoose(s,t);var i=s.prototype;return i.generateRasterInfo=function(e){const t=r.unwrap(null==e?void 0:e.renderingRule);return this.layer.generateRasterInfo(t,{signal:null==e?void 0:e.signal})},i.estimateStatisticsHistograms=async function(e){var t,s,i;const a=null!=(t=null==(s=r.unwrap(null==e?void 0:e.renderingRule))?void 0:s.functionName)?t:"default";if(this._statsCache.has(a))return this._statsCache.get(a);let{width:o,height:n,pixelSize:l}=this.layer.rasterInfo,u=1;for(;o>2e3||n>2e3;)o/=2,n/=2,u*=2;const c=null!=(i=null==e?void 0:e.renderingRule)?i:this.layer.renderingRule,{fullExtent:h,mosaicRule:m}=this.layer;l=new p(l.x*u,l.y*u,h.spatialReference);const y=new d({geometry:h,pixelSize:l,renderingRule:c,mosaicRule:m});let f;if(this.layer.capabilities.operations.supportsComputeStatisticsHistograms)f=await this.layer.computeStatisticsHistograms(y,e);else{const{histograms:t}=await this.layer.computeHistograms(y,e);f={statistics:g.estimateStatisticsFromHistograms(t),histograms:t}}if(this._statsCache.set(a,f),this._statsCache.size>this._cacheSize){const e=this._statsCache.keys().next().value;this._statsCache.delete(e)}return f},i.supportsMultidirectionalHillshade=function(){return this.layer.version>=10.81},i.load=function(e){return this.addResolvingPromise(this.layer.load(e).then((()=>{var t;this.generateRasterInfo({renderingRule:this.renderingRule,signal:null==(t=r.unwrap(e))?void 0:t.signal}).then((e=>this.rasterInfo=e))}))),Promise.resolve(this)},s}(m);return t.__decorate([o.property()],y.prototype,"layer",void 0),y=t.__decorate([n.subclass("esri.smartMapping.support.adapters.ImageryLayerAdapter")],y),y}));
