/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["../../core/maybe","../../core/Error","../../geometry/support/scaleUtils","../support/adapters/support/layerUtils","../statistics/spatialStatistics"],(function(e,a,t,n,i){"use strict";function s(e,a,t=!0){if(e.constraints&&"effectiveLODs"in e.constraints){const n=e.constraints.effectiveLODs,i=t?n:n.slice(0).reverse();let s=null;for(const e of i)if(!(t?e.scale>a:e.scale<a)){s=e;break}return s}}return async function(r){const l=await async function(t){const{view:i,sampleSize:s}=t;if(!(t&&i&&t.layer))throw new a("scale-range:missing-parameters","'view' and 'layer' parameters are required");const r=[0,2,3,1],{layer:l,...o}=t,c=n.createLayerAdapter(l,r),u={layerAdapter:c,...o};if(u.sampleSize=s||500,!c)throw new a("scale-range:invalid-parameters","'layer' must be one of these types: "+n.getLayerTypeLabels(r).join(", "));await i.when();const p=e.isSome(u.signal)?{signal:u.signal}:null;return await c.load(p),u}(r),{view:o,sampleSize:c,layerAdapter:u,signal:p}=l,m=await u.getSampleFeatures({view:o,sampleSize:c,returnGeometry:!0,signal:p}),y=await i({features:m,geometryType:u.geometryType}),{minScale:f,maxScale:g}=function(e,a,n){const i=function(e,a){let t=null,n=null,i=null,s=null;switch(e){case"point":case"multipoint":{const e=a;t=e.avgMinDistance,n=12,i=e.minDistance,s=320;break}case"polyline":{const e=a;t=e.avgLength,n=30,i=e.minLength,s=320;break}case"polygon":{const e=a;t=e.avgSize,n=15,i=e.minSize,s=640;break}}return{resolutionForMinScale:t>0?t/n:null,resolutionForMaxScale:i>0?i/s:null}}(e.geometryType,a);return{minScale:t.getScaleForResolution(i.resolutionForMinScale,n.spatialReference),maxScale:t.getScaleForResolution(i.resolutionForMaxScale,n.spatialReference)}}(u,y,o);return function(e,t,n,i){const{view:r,snapToLOD:l,layerAdapter:o}=e;if(l){const e=s(r,t),a=s(r,n,!1);t=e?e.scale:t,n=a?a.scale:n}if(t<n)throw new a("scale-range:invalid","calculated minScale is less than maxScale.");return n>t/2&&(n=Math.floor(n/2)),t>1e8&&(t=0),"polygon"!==o.geometryType&&(n=0),{minScale:Math.ceil(t),maxScale:Math.floor(n),spatialStatistics:i}}(l,f,g,y)}}));
