/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../core/arrayUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../core/MD5","./utils","../popup/support/utils"],(function(e,n,t,i,o,l,r){"use strict";const a="cluster_count";function s(e,n){return e.split(`cluster_${n}_`).pop()}function u(e){if(!e)return null;const{field:n,valueExpression:t,normalizationField:o,normalizationType:r,normalizationTotal:a}=e;let s=null;if(t)s=t;else if(n){const e=l.getNormalizationType({normalizationType:r,normalizationField:o,normalizationTotal:a});if(e){const t=e.toLowerCase();if(s=n.toLowerCase()+",norm:"+t,o)s+=","+o.toLowerCase();else if("percent-of-total"===t){let e=a;i.isValidNumber(e)&&0!==e||(e=null),s+=","+e}}}return s}function p(e){return o.createMD5Hash(e)}function c(e,t){const i=u(e);return`${t}_${n.isSome(i)?p(i):e.field}`}function f(e,n){return`cluster_${c(e,n)}`}function d(e,n){const t=n.getField(e);return t&&t.type}function m(e,t){const i="field"in t&&t.field,o=i?d(i,e):null;return{field:i,fieldType:n.isSome(o)?o:null,valueExpression:"valueExpression"in t?t.valueExpression:null,valueExpressionTitle:"valueExpressionTitle"in t?t.valueExpressionTitle:null,normalizationField:"normalizationField"in t?t.normalizationField:null,normalizationType:"normalizationType"in t?t.normalizationType:null,normalizationTotal:"normalizationTotal"in t?t.normalizationTotal:null}}function v(e,t){const i="rotation"===t.type?t.rotationType:null,o=t.legendOptions&&t.legendOptions.title,l=t.field,r=l?d(l,e):null;return{field:l,fieldType:n.isSome(r)?r:null,rotationType:i,valueExpression:t.valueExpression,valueExpressionTitle:t.valueExpressionTitle||t.valueExpression&&o,normalizationField:"normalizationField"in t?t.normalizationField:null,vvType:t.type}}function T(e){return e.map((e=>`{\n        "value": "${String(e.value)}",\n        "label": "${y(String(e.label))}"\n      }`))}function y(e){return e?e.replace(/"/g,'\\"'):""}function z(e,n,t){return`\n  var uvInfos = [${T(e).join(", ")}];\n  var predominantType = Text($feature["${n}"]);\n  var label = "${y(t)}";\n\n  for (var i = 0; i < Count(uvInfos); i++) {\n    if (uvInfos[i].value == predominantType) {\n      label = uvInfos[i].label;\n      break;\n    }\n  }\n\n  return label;\n  `}function b(e,n){const t=[c(e,n)];return"date"===e.fieldType&&t.push(e.fieldType.toLowerCase()),e.rotationType&&t.push(e.rotationType.toLowerCase()),t.join("_")}function g(e,n){return{statisticHash:b(e,n),attributeInfo:e,statisticType:n}}function x(e,n,i=!0){const o=[],l=m(e,n);"class-breaks"===n.type?o.push(g(l,"avg")):"unique-value"===n.type&&o.push(g(l,"type"));const a=r.getPrimaryVisualVariables(n);for(const t of a){const n=v(e,t);o.push(g(n,"avg"))}return i?t.unique(o,((e,n)=>e.statisticHash===n.statisticHash)):o}e.clusterCountField=a,e.getClusterField=f,e.getClusterFieldHash=s,e.getPredominantTypeExpression=z,e.getRendererAttributeInfo=m,e.getStatisticId=c,e.getStatisticInfo=g,e.getStatisticInfos=x,e.getVariableAttributeInfo=v,Object.defineProperty(e,"__esModule",{value:!0})}));
