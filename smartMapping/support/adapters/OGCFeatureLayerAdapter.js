/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/Error","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/support/fieldUtils","../../statistics/support/predominanceUtils","../../statistics/support/utils","../../statistics/support/WorkerClient","../utils","./FeatureLayerAdapter","./support/utils","../../../statistics/utils"],(function(e,r,t,i,s,n,a,o,u,l,c,p,y,d,f,h,m,w){"use strict";let g=function(r){function a(e){return r.call(this,e)||this}e._inheritsLoose(a,r);var o=a.prototype;return o._waitForLayerViewUpdate=function(){var r=e._asyncToGenerator((function*(e){if(!e)throw new i("ogc-feature-layer-adapter:insufficient-data","layerView is required to fetch the features");yield n.whenOnce((()=>!e.updating))}));function t(e){return r.apply(this,arguments)}return t}(),o._summaryStatsFromClientQuery=function(){var r=e._asyncToGenerator((function*(e,r){const{signal:t,view:a}=e;if(!a)throw new i("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const o=this._getSummaryStatsQuery(e,r),u=yield a.whenLayerView(this.layer);yield n.whenOnce((()=>!u.updating),s.unwrap(t));const l=yield u.queryFeatures(o,{signal:t}),c=m.getSummaryStatisticsFromFeatureSet(l,r);return w.processSummaryStatisticsResult(c)}));function t(e,t){return r.apply(this,arguments)}return t}(),o._uvFromClientQuery=function(){var r=e._asyncToGenerator((function*(e,r){const{signal:t,view:a}=e;if(!a)throw new i("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const o=this._getUVQuery(e),u=yield a.whenLayerView(this.layer);yield n.whenOnce((()=>!u.updating),s.unwrap(t));const l=yield u.queryFeatures(o,{signal:t}),c=yield m.getUniqueValuesFromFeatureSet(l,{layer:this,field:e.field,field2:e.field2,field3:e.field3,fieldDelimiter:f.FIELD_DELIMITER,view:e.view,signal:e.signal});return w.createUVResult(c,r,e.returnAllCodedValues,f.FIELD_DELIMITER)}));function t(e,t){return r.apply(this,arguments)}return t}(),o.summaryStatistics=function(e){const{field:r,valueExpression:t,sqlExpression:s,features:n,view:a}=e,o=r?this.getField(r):null,u=c.isDateField(o),l=!!t,p="3d"===a?.type;if(!t&&s&&!this.supportsSQLExpression)throw new i("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return l||n||p?this._summaryStatsFromMemory(e,o):this._summaryStatsFromClientQuery(e,u)},o.uniqueValues=function(){var r=e._asyncToGenerator((function*(e){const{valueExpression:r,sqlExpression:t,features:s,view:n}=e,a=yield m.getDomainsForFields(e,this),o=!!r,u="3d"===n?.type;if(!r&&t&&!this.supportsSQLExpression)throw new i("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return o||s||u?this._uvFromMemory(e,a):this._uvFromClientQuery(e,a)}));function t(e){return r.apply(this,arguments)}return t}(),o.histogram=function(e){const{features:r,valueExpression:t,normalizationType:s,sqlExpression:n}=e,a=r||!!t;if(!t&&n&&!this.supportsSQLExpression)throw new i("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return a||s?this._histogramFromMemory(e):this._histogramForField(e)},o.classBreaks=function(e){return!1!==e.analyzeData?this._classBreaksFromMemory(e):this._classBreaksFromInterpolation(e)},o.queryFeatureCount=function(){var r=e._asyncToGenerator((function*(e){const{whereClause:r,view:t,signal:a}=e;if(!t)throw new i("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const o=this.layer.createQuery();o.where=y.mergeWhereClauses(o.where,r);const u=yield t.whenLayerView(this.layer);return yield n.whenOnce((()=>!u.updating),s.unwrap(a)),u.queryFeatureCount(o,{signal:a})}));function t(e){return r.apply(this,arguments)}return t}(),o.generateRenderer=function(e,r){throw new i("ogc-feature-layer-adapter:not-supported","OGCFeatureLayer does not support generateRenderer operation")},o.predominantCategories=function(){var r=e._asyncToGenerator((function*(e){const{fields:r,view:t,signal:i}=e,s=p.getArcadeForPredominantCategory(r),n=yield this._uvFromMemory({valueExpression:s,view:t,signal:i});return m.getPredominantCategoriesFromUVInfos(n.uniqueValueInfos,r)}));function t(e){return r.apply(this,arguments)}return t}(),o.getSampleFeatures=function(){var r=e._asyncToGenerator((function*(e,r){const{view:s,sampleSize:n,requiredFields:a,returnGeometry:o,signal:u}=e,l=this.layer.createQuery(),c=1;if(l.outSpatialReference=e.spatialReference||s&&s.spatialReference,l.returnGeometry=!!o,l.outFields=a,!s)throw new i("ogc-feature-layer-adapter:not-supported","view is required to get sample features for OGCFeatureLayer");const p=yield s.whenLayerView(this.layer);if(m.getMissingFields(this,a,p).length)throw new i("ogc-feature-layer-adapter:not-supported","Required fields need to be passed in the outFields for OGCFeatureLayer");const y=yield this._fetchFeaturesFromMemory(p,l,u,r);return t.pickRandom(y,n>0&&n<=y.length?n:y.length,c)}));function s(e,t){return r.apply(this,arguments)}return s}(),o.load=function(r){var t=this;const i=this.layer.load(r).then(function(){var i=e._asyncToGenerator((function*(e){t.geometryType=e.geometryType,t.objectIdField=e.objectIdField,t.supportsSQLExpression=e.get("capabilities.query.supportsSqlExpression"),t.minScale=e.minScale,t.maxScale=e.maxScale,t.fullExtent=e.fullExtent,t.workerClient=d.WorkerClient.getInstance(),yield t.workerClient.open(s.unwrap(s.unwrap(r).signal))}));return function(e){return i.apply(this,arguments)}}());return this.addResolvingPromise(i),Promise.resolve(this)},a}(h);g=r.__decorate([l.subclass("esri.smartMapping.support.adapters.OGCFeatureLayerAdapter")],g);return g}));
