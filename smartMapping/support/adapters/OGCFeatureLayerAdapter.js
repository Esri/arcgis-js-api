/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/Error","../../../core/maybe","../../../core/watchUtils","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/set","../../../core/accessorSupport/decorators/subclass","../../../layers/support/fieldUtils","../../statistics/support/predominanceUtils","../../statistics/support/utils","../../statistics/support/WorkerClient","./FeatureLayerAdapter","./support/utils","../../../statistics/utils"],(function(e,t,r,s,i,n,a,o,u,l,c,p,d,y,f,h,m,w){"use strict";let g=function(t){function a(e){return t.call(this,e)||this}e._inheritsLoose(a,t);var o=a.prototype;return o._waitForLayerViewUpdate=function(){var t=e._asyncToGenerator((function*(e){if(!e)throw new s("ogc-feature-layer-adapter:insufficient-data","layerView is required to fetch the features");yield n.whenFalseOnce(e,"updating")}));function r(e){return t.apply(this,arguments)}return r}(),o._summaryStatsFromClientQuery=function(){var t=e._asyncToGenerator((function*(e,t){const{signal:r,view:i}=e;if(!i)throw new s("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const a=this._getSummaryStatsQuery(e,t),o=yield i.whenLayerView(this.layer);yield n.whenFalseOnce(o,"updating");const u=yield o.queryFeatures(a,{signal:r}),l=m.getSummaryStatisticsFromFeatureSet(u,t);return w.processSummaryStatisticsResult(l)}));function r(e,r){return t.apply(this,arguments)}return r}(),o._uvFromClientQuery=function(){var t=e._asyncToGenerator((function*(e,t){const{signal:r,view:i}=e;if(!i)throw new s("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const a=this._getUVQuery(e),o=yield i.whenLayerView(this.layer);yield n.whenFalseOnce(o,"updating");const u=yield o.queryFeatures(a,{signal:r}),l=yield m.getUniqueValuesFromFeatureSet(u,this,e.field,e.view,null,r);return w.createUVResult(l,t,e.returnAllCodedValues)}));function r(e,r){return t.apply(this,arguments)}return r}(),o.summaryStatistics=function(e){const{field:t,valueExpression:r,sqlExpression:i,features:n,view:a}=e,o=t?this.getField(t):null,u=p.isDateField(o),l=!!r,c="3d"===(null==a?void 0:a.type);if(i&&!this.supportsSQLExpression)throw new s("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return l||n||c?this._summaryStatsFromMemory(e,o):this._summaryStatsFromClientQuery(e,u)},o.uniqueValues=function(e){const{field:t,valueExpression:r,sqlExpression:i,features:n,view:a}=e,o=(t?this.getField(t):null)&&this.getFieldDomain(t),u=!!r,l="3d"===(null==a?void 0:a.type);if(i&&!this.supportsSQLExpression)throw new s("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return u||n||l?this._uvFromMemory(e,o):this._uvFromClientQuery(e,o)},o.histogram=function(e){const{features:t,valueExpression:r,normalizationType:i,sqlExpression:n}=e,a=t||!!r;if(n&&!this.supportsSQLExpression)throw new s("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return a||i?this._histogramFromMemory(e):this._histogramForField(e)},o.classBreaks=function(e){return!1!==e.analyzeData?this._classBreaksFromMemory(e):this._classBreaksFromInterpolation(e)},o.queryFeatureCount=function(){var t=e._asyncToGenerator((function*(e){const{whereClause:t,view:r,signal:i}=e;if(!r)throw new s("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const a=this.layer.createQuery();a.where=y.mergeWhereClauses(a.where,t);const o=yield r.whenLayerView(this.layer);return yield n.whenFalseOnce(o,"updating"),o.queryFeatureCount(a,{signal:i})}));function r(e){return t.apply(this,arguments)}return r}(),o.generateRenderer=function(e,t){throw new s("ogc-feature-layer-adapter:not-supported","OGCFeatureLayer does not support generateRenderer operation")},o.predominantCategories=function(){var t=e._asyncToGenerator((function*(e){const{fields:t,view:r,signal:s}=e,i=d.getArcadeForPredominantCategory(t),n=yield this._uvFromMemory({valueExpression:i,view:r,signal:s});return m.getPredominantCategoriesFromUVInfos(n.uniqueValueInfos,t)}));function r(e){return t.apply(this,arguments)}return r}(),o.getSampleFeatures=function(){var t=e._asyncToGenerator((function*(e,t){const{view:i,sampleSize:n,requiredFields:a,returnGeometry:o,signal:u}=e,l=this.layer.createQuery(),c=1;if(l.outSpatialReference=e.spatialReference||i&&i.spatialReference,l.returnGeometry=!!o,l.outFields=a,!i)throw new s("ogc-feature-layer-adapter:not-supported","view is required to get sample features for OGCFeatureLayer");const p=yield i.whenLayerView(this.layer);if((yield m.getMissingFields(this,a,p)).length)throw new s("ogc-feature-layer-adapter:not-supported","Required fields need to be passed in the outFields for OGCFeatureLayer");const d=yield this._fetchFeaturesFromMemory(p,l,u,t);return r.pickRandom(d,n>0&&n<=d.length?n:d.length,c)}));function i(e,r){return t.apply(this,arguments)}return i}(),o.load=function(t){var r=this;const s=this.layer.load(t).then(function(){var s=e._asyncToGenerator((function*(e){r.geometryType=e.geometryType,r.objectIdField=e.objectIdField,r.supportsSQLExpression=e.get("capabilities.query.supportsSqlExpression"),r.minScale=e.minScale,r.maxScale=e.maxScale,r.fullExtent=e.fullExtent,r.workerClient=f.WorkerClient.getInstance(),yield r.workerClient.open(i.unwrap(i.unwrap(t).signal))}));return function(e){return s.apply(this,arguments)}}());return this.addResolvingPromise(s),Promise.resolve(this)},a}(h);g=t.__decorate([c.subclass("esri.smartMapping.support.adapters.OGCFeatureLayerAdapter")],g);return g}));
