/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/Error","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/ensureType","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../layers/support/fieldUtils","../../statistics/support/predominanceUtils","../../statistics/support/utils","../../statistics/support/WorkerClient","./FeatureLayerAdapter","./support/utils"],(function(e,r,t,s,i,n,a,o,u,l,c,p,d,y,f,h,m){"use strict";let w=function(r){function a(e){return r.call(this,e)||this}e._inheritsLoose(a,r);var o=a.prototype;return o._waitForLayerViewUpdate=function(){var r=e._asyncToGenerator((function*(e){if(!e)throw new s("ogc-feature-layer-adapter:insufficient-data","layerView is required to fetch the features");yield n.whenFalseOnce(e,"updating")}));function t(e){return r.apply(this,arguments)}return t}(),o._summaryStatsFromClientQuery=function(){var r=e._asyncToGenerator((function*(e,r){const{signal:t,view:i}=e;if(!i)throw new s("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const a=this._getSummaryStatsQuery(e,r),o=yield i.whenLayerView(this.layer);yield n.whenFalseOnce(o,"updating");const u=yield o.queryFeatures(a,{signal:t}),l=m.getSummaryStatisticsFromFeatureSet(u,r);return m.processSummaryStatisticsResult(l)}));function t(e,t){return r.apply(this,arguments)}return t}(),o._uvFromClientQuery=function(){var r=e._asyncToGenerator((function*(e,r){const{signal:t,view:i}=e;if(!i)throw new s("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const a=this._getUVQuery(e),o=yield i.whenLayerView(this.layer);yield n.whenFalseOnce(o,"updating");const u=yield o.queryFeatures(a,{signal:t}),l=yield m.getUniqueValuesFromFeatureSet(u,this,e.field,e.view,null,t);return m.createUVResult(l,r,e.returnAllCodedValues)}));function t(e,t){return r.apply(this,arguments)}return t}(),o.summaryStatistics=function(e){const{field:r,valueExpression:t,sqlExpression:i,features:n,view:a}=e,o=r?this.getField(r):null,u=p.isDateField(o),l=!!t,c="3d"===(null==a?void 0:a.type);if(i&&!this.supportsSQLExpression)throw new s("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return l||n||c?this._summaryStatsFromMemory(e,o):this._summaryStatsFromClientQuery(e,u)},o.uniqueValues=function(e){const{field:r,valueExpression:t,sqlExpression:i,features:n,view:a}=e,o=(r?this.getField(r):null)&&this.getFieldDomain(r),u=!!t,l="3d"===(null==a?void 0:a.type);if(i&&!this.supportsSQLExpression)throw new s("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return u||n||l?this._uvFromMemory(e,o):this._uvFromClientQuery(e,o)},o.histogram=function(e){const{features:r,valueExpression:t,normalizationType:i,sqlExpression:n}=e,a=r||!!t;if(n&&!this.supportsSQLExpression)throw new s("ogc-feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries");return a||i?this._histogramFromMemory(e):this._histogramForField(e)},o.classBreaks=function(e){return!1!==e.analyzeData?this._classBreaksFromMemory(e):this._classBreaksFromInterpolation(e)},o.queryFeatureCount=function(){var r=e._asyncToGenerator((function*(e){const{whereClause:r,view:t,signal:i}=e;if(!t)throw new s("ogc-feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");const a=this.layer.createQuery();a.where=y.mergeWhereClauses(a.where,r);const o=yield t.whenLayerView(this.layer);return yield n.whenFalseOnce(o,"updating"),o.queryFeatureCount(a,{signal:i})}));function t(e){return r.apply(this,arguments)}return t}(),o.generateRenderer=function(e,r){throw new s("ogc-feature-layer-adapter:not-supported","OGCFeatureLayer does not support generateRenderer operation")},o.predominantCategories=function(){var r=e._asyncToGenerator((function*(e){const{fields:r,view:t,signal:s}=e,i=d.getArcadeForPredominantCategory(r),n=yield this._uvFromMemory({valueExpression:i,view:t,signal:s});return m.getPredominantCategoriesFromUVInfos(n.uniqueValueInfos,r)}));function t(e){return r.apply(this,arguments)}return t}(),o.getSampleFeatures=function(){var r=e._asyncToGenerator((function*(e,r){const{view:i,sampleSize:n,requiredFields:a,returnGeometry:o,signal:u}=e,l=this.layer.createQuery(),c=1;if(l.outSpatialReference=e.spatialReference||i&&i.spatialReference,l.returnGeometry=!!o,l.outFields=a,!i)throw new s("ogc-feature-layer-adapter:not-supported","view is required to get sample features for OGCFeatureLayer");const p=yield i.whenLayerView(this.layer);if((yield m.getMissingFields(this,a,p)).length)throw new s("ogc-feature-layer-adapter:not-supported","Required fields need to be passed in the outFields for OGCFeatureLayer");const d=yield this._fetchFeaturesFromMemory(p,l,u,r);return t.pickRandom(d,n>0&&n<=d.length?n:d.length,c)}));function i(e,t){return r.apply(this,arguments)}return i}(),o.load=function(r){var t=this;const s=this.layer.load(r).then(function(){var s=e._asyncToGenerator((function*(e){t.geometryType=e.geometryType,t.objectIdField=e.objectIdField,t.supportsSQLExpression=e.get("capabilities.query.supportsSqlExpression"),t.minScale=e.minScale,t.maxScale=e.maxScale,t.fullExtent=e.fullExtent,t.workerClient=f.WorkerClient.getInstance(),yield t.workerClient.open(i.unwrap(i.unwrap(r).signal))}));return function(e){return s.apply(this,arguments)}}());return this.addResolvingPromise(s),Promise.resolve(this)},a}(h);return w=r.__decorate([c.subclass("esri.smartMapping.support.adapters.OGCFeatureLayerAdapter")],w),w}));
