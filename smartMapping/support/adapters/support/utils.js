// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../core/promiseUtils","../../../../renderers/support/heatmapUtils","../../utils","../../../../support/arcadeOnDemand","../../../../tasks/support/ClassBreaksDefinition","../../../../tasks/support/generateRendererUtils"],(function(e,a,t,n,r,i,o,l,u){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.isValidNumber=a.msSinceUnixEpochSQL=a.calculateUniqueValuesFromMemory=a.createUVResult=a.getUniqueValuesFromFeatureSet=a.getHistogramFromFeatureSet=a.calculateHistogramFromMemory=a.getFieldExpr=a.generateBinParams=a.getEqualIntervalBins=a.resolveCBResult=a.calculateClassBreaksFromMemory=a.calculateHeatmapStats=a.createCBDefn=a.processSummaryStatisticsResult=a.getDataValues=a.calculateStatsFromMemory=a.getSummaryStatisticsFromFeatureSet=a.getMissingFields=a.statisticTypes=void 0;var s=/_value$/i,c=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,m=Math.LOG10E;a.statisticTypes=["min","max","avg","stddev","count","sum","variance"];var f=null;function d(e,a,t){return a=null==a?-1/0:a,t=null==t?1/0:t,e.filter((function(e){return null!=e&&M(e)&&e>=a&&e<=t}))}function v(e,a){return t.__awaiter(this,void 0,void 0,(function(){var n,r,i,l,u,s,c,m,d,v,h;return t.__generator(this,(function(t){switch(t.label){case 0:return n=e.field,r="function"==typeof n,i=e.valueExpression,l=e.normalizationType,u=e.normalizationField,s=e.normalizationTotal,c=[],m=e.view,d=null,v=null,i?f?[3,2]:[4,o.loadArcade()]:[3,3];case 1:h=t.sent().arcadeUtils,f=h,t.label=2;case 2:d=f.createFunction(i),v=m&&f.getViewInfo({viewingMode:"2d"===m.type?"map":m.viewingMode,scale:m.scale,spatialReference:m.spatialReference}),t.label=3;case 3:return a?(a.forEach((function(e){var a,t=e.attributes;if(i){var o=f.createExecContext(e,v);a=f.executeFunction(d,o)}else r?a=n.call(null,e):t&&(a=t[n]);if(l&&null!=a&&M(a)){var m=t&&parseFloat(t[u]);"log"===l&&0!==a?a=Math.log(a)*Math.LOG10E:"percent-of-total"===l&&M(s)&&0!==s?a=a/s*100:"field"===l&&M(m)&&0!==m&&(a/=m)}c.push(a)})),[2,c]):[2,c]}}))}))}function h(e){var a=e.field,t=e.classificationMethod||"equal-interval",n=e.normalizationType,r=e.normalizationField,i=new l;return i.classificationField=a,i.breakCount=e.breakCount,i.classificationMethod=t,i.standardDeviationInterval="standard-deviation"===t?e.standardDeviationInterval||1:void 0,i.normalizationType=n,i.normalizationField="field"===n?r:void 0,i}function g(e,a){var t=a.classBreaks,n=t.length,r=t[0].minValue,i=t[n-1].maxValue,o="standard-deviation"===e.classificationMethod,l=c;return{minValue:r,maxValue:i,classBreakInfos:t=t.map((function(e){var a=e.label,t={minValue:e.minValue,maxValue:e.maxValue,label:a};if(o&&a){var n=a.match(l).map((function(e){return+e.trim()}));2===n.length?(t.minStdDev=n[0],t.maxStdDev=n[1],n[0]<0&&n[1]>0&&(t.hasAvg=!0)):1===n.length&&(a.indexOf("<")>-1?(t.minStdDev=null,t.maxStdDev=n[0]):a.indexOf(">")>-1&&(t.minStdDev=n[0],t.maxStdDev=null))}return t})),normalizationTotal:a.normalizationTotal}}function p(e,a,t){for(var n,r=(a-e)/t,i=[],o=e,l=1;l<=t;l++)n=o+r,n=Number(n.toFixed(16)),i.push([o,n]),o=n;return i}function F(e){var a=e.field,t=e.normalizationType,n=e.normalizationField,r=e.normalizationTotal,o=e.layer,l=i.isIntegerField(o,a),u=a;return"percent-of-total"===t?u="(("+(l?i.castIntegerFieldToFloat(a):a)+" / "+r+") * 100)":"log"===t?u="(log("+a+") * "+m+")":"field"===t&&(u="("+(l?i.castIntegerFieldToFloat(a):a)+" / "+n+")"),u}function x(e,a){for(var t=-1,n=e.length-1;n>=0;n--){if(a>=e[n][0]){t=n;break}}return t}function V(e,a){var t;if(a=a.toLowerCase(),e)for(var n in e)if(n.toLowerCase()!==a){t=e[n];break}return t}function y(e,a){var t;if(a=a.toLowerCase(),e)for(var n in e)if(n.toLowerCase()===a){t=e[n];break}return t}function b(e,a){if(a)for(var t in e)e[t].label=a[t];return{count:e}}function T(e,a,t){var n=e.count,r=[];t&&a&&"coded-value"===a.type&&a.codedValues.forEach((function(e){var a=e.code;n.hasOwnProperty(a)||(n[a]={data:a,count:0})}));for(var i in n){var o=n[i];r.push({value:o.data,count:o.count,label:o.label})}return{uniqueValueInfos:r}}function M(e){return"number"==typeof e&&!isNaN(e)&&e!==1/0&&e!==-1/0}a.getMissingFields=function(e,a,n){return t.__awaiter(this,void 0,void 0,(function(){var r,i,o,l,u;return t.__generator(this,(function(t){if(r=[],a)for(i=0,o=a;i<o.length;i++)l=o[i],u=e.getField(l),"availableFields"in n&&-1===n.availableFields.indexOf(u.name)&&r.push(u.name);return[2,r]}))}))},a.getSummaryStatisticsFromFeatureSet=function(e,a){var t=e&&e.features,n=t&&t[0]&&t[0].attributes,r={};for(var i in n)r[i.replace(s,"").toLowerCase()]=n[i];return r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),a&&(["min","max","avg","stddev","sum","variance"].forEach((function(e){null!=r[e]&&(r[e]=Math.ceil(r[e]))})),r.min===r.max&&null!=r.min&&(r.avg=r.min,r.stddev=r.variance=0)),r},a.calculateStatsFromMemory=function(e,a,n){return t.__awaiter(this,void 0,void 0,(function(){var r,i;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,v(e,a)];case 1:return r=d(r=t.sent(),e.minValue,e.maxValue),i=function(e,a){for(var t=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,r=null,i=null,o=null,l=null,u=0,s=e;u<s.length;u++){var c=s[u];r+=c,t=Math.min(t,c),n=Math.max(n,c)}var m=e.length;if(m){i=r/m;for(var f=0,d=0,v=e;d<v.length;d++){c=v[d];f+=Math.pow(c-i,2)}l=a?m>1?f/(m-1):0:m>0?f/m:0,o=Math.sqrt(l)}else t=null,n=null;return{avg:i,count:m,max:n,min:t,stddev:o,sum:r,variance:l}}(r,!e.normalizationType),n&&["avg","stddev","variance"].forEach((function(e){null!=i[e]&&(i[e]=Math.ceil(i[e]))})),[2,i]}}))}))},a.getDataValues=v,a.processSummaryStatisticsResult=function(e){var t;for(t in e)a.statisticTypes.indexOf(t)>-1&&(M(e[t])||(e[t]=null));return e},a.createCBDefn=h,a.calculateHeatmapStats=function(e,a,t,n,i,o){void 0===a&&(a=10);for(var l=new Float64Array(i*o),u=r.createKernel(a),s=Math.round(3*a),c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,d=0,v=0,h=0,g=r.createValueFunction(n,t),p=0,F=e;p<F.length;p++)for(var x=F[p],V=x.geometry,y=x.attributes,b=V.x-s,T=V.y-s,M=Math.max(0,b),S=Math.max(0,T),I=Math.min(o,V.y+s),_=Math.min(i,V.x+s),E=+g(y),w=S;w<I;w++)for(var z=u[w-T],C=M;C<_;C++){var D=u[C-b],N=w*i+C,B=l[N],k=(f=l[N]+=z*D*E)-B;d+=k,v+=k*k,f<c&&(c=f),f>m&&(m=f),h++}if(!h)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};var O=(m-c)/2;return{mean:d/h,stdDev:Math.sqrt((v-d*d/h)/h),min:c,max:m,mid:O,count:h}},a.calculateClassBreaksFromMemory=function(e,a){return t.__awaiter(this,void 0,void 0,(function(){var n,r,i,o;return t.__generator(this,(function(t){switch(t.label){case 0:return n=e.normalizationTotal,r=h({field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||5}),[4,v(e,a)];case 1:return i=d(i=t.sent(),e.minValue,e.maxValue),o=u.createGenerateRendererClassBreaks({definition:r,values:i,normalizationTotal:n}),[2,g(e,o)]}}))}))},a.resolveCBResult=g,a.getEqualIntervalBins=p,a.generateBinParams=function(e){var a=[],t=e.classBreaks,n=t[0].minValue,r=t[t.length-1].maxValue;t.forEach((function(e){a.push([e.minValue,e.maxValue])}));var i={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:n,max:r,intervals:a,sqlExpr:F(i),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}},a.getFieldExpr=F,a.calculateHistogramFromMemory=function(e,a,n){return t.__awaiter(this,void 0,void 0,(function(){var r,i,o,l,u,s,c,m,f,d,h;return t.__generator(this,(function(t){switch(t.label){case 0:return r=a.min,i=a.max,o=a.normTotal,l=e.numBins||10,u=a.intervals||p(r,i,l),s=u.map((function(e,a){return{minValue:u[a][0],maxValue:u[a][1],count:0}})),[4,v(e,n)];case 1:for(c=t.sent(),m=0,f=c;m<f.length;m++)null!=(d=f[m])&&d>=r&&d<=i&&(h=x(u,d))>-1&&s[h].count++;return[2,{bins:s,minValue:r,maxValue:i,normalizationTotal:o}]}}))}))},a.getHistogramFromFeatureSet=function(e,a,t,n,r){var i={};e&&e.features&&e.features.forEach((function(e){var a=e.attributes,t=V(a,"countOFExpr"),n=y(a,"countOFExpr");0!==t&&(i[t]=n)}));var o=[];return p(a,t,n).forEach((function(e,a){var t=(a+1).toString();o.push({minValue:e[0],maxValue:e[1],count:i.hasOwnProperty(t)?i[t]:0})})),{bins:o,minValue:a,maxValue:t,normalizationTotal:r}},a.getUniqueValuesFromFeatureSet=function(e,a,t,r,i){var o=e&&e.features,l="countOF"+(t||"Expr"),u={},s=!1;if(o.forEach((function(e){var a=e.attributes,n=y(a,l),r=t?y(a,t):V(a,l);null===r&&0===n&&(s=!0),(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==u[r]?u[r]={count:n,data:r}:u[r].count=u[r].count+n})),t&&s){var c=t+" is NULL";return a.queryFeatureCount(c,i).then((function(e){return e=e||0,u.null.count=u.null.count+e,b(u,r)})).catch((function(){return n.throwIfAborted(i),b(u,r)}))}return n.resolve(b(u,r))},a.createUVResult=T,a.calculateUniqueValuesFromMemory=function(e,a,n){return t.__awaiter(this,void 0,void 0,(function(){var r,i,o,l,u;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,v(e,a)];case 1:for(r=t.sent(),i={},o=0,l=r;o<l.length;o++)(null==(u=l[o])||"string"==typeof u&&""===u.trim())&&(u=null),null==i[u]?i[u]={count:1,data:u}:i[u].count++;return[2,T({count:i},n,e.returnAllCodedValues)]}}))}))},a.msSinceUnixEpochSQL=function(e,a){return i.getDateDiffSQL(e,new Date(0),a,"milliseconds").sqlExpression},a.isValidNumber=M}));