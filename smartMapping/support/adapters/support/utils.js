/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/promiseUtils","../../../../renderers/support/heatmapUtils","../../../../rest/support/ClassBreaksDefinition","../../../../rest/support/generateRendererUtils","../../../statistics/support/predominanceUtils","../../utils","../../../../support/arcadeOnDemand"],(function(t,n,e,a,o,i,l,r,u){"use strict";const s=/_value$/i,c=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,m=5,f=10,d=Math.LOG10E,p="equal-interval",h=1,v=["min","max","avg","stddev","count","sum","variance","nullcount"];let y=null;function F(t){return t.map((t=>t.toJSON()))}function g(t,n,e){return x.apply(this,arguments)}function x(){return(x=n._asyncToGenerator((function*(t,n,e){const a=[];if(n)for(const o of n){const n=t.getField(o);"availableFields"in e&&-1===e.availableFields.indexOf(n.name)&&a.push(n.name)}return a}))).apply(this,arguments)}function T(t,n){const e=t&&t.features,a=e&&e[0]&&e[0].attributes,o={};for(const i in a)o[i.replace(s,"").toLowerCase()]=a[i];return null!=o.totalcount&&o.totalcount>=o.count&&(o.nullcount=o.totalcount-o.count),delete o.totalcount,o.min===o.max&&null!=o.min&&null==o.stddev&&(o.stddev=o.variance=0),n&&(["min","max","avg","stddev","sum","variance"].forEach((t=>{null!=o[t]&&(o[t]=Math.ceil(o[t]))})),o.min===o.max&&null!=o.min&&(o.avg=o.min,o.stddev=o.variance=0)),o}function V(t,n,e){return I.apply(this,arguments)}function I(){return(I=n._asyncToGenerator((function*(t,n,e){let a=yield z(t,n);a=b(a,t.minValue,t.maxValue);const o=E(a,!t.normalizationType);return e&&["avg","stddev","variance"].forEach((t=>{null!=o[t]&&(o[t]=Math.ceil(o[t]))})),o}))).apply(this,arguments)}function b(t,n,e){return n=null==n?-1/0:n,e=null==e?1/0:e,t.filter((t=>Number.isFinite(t)&&t>=n&&t<=e))}function z(t,n){return M.apply(this,arguments)}function M(){return(M=n._asyncToGenerator((function*(t,n){const e=t.field,a="function"==typeof e,o=t.valueExpression,i=t.normalizationType,l=t.normalizationField,r=t.normalizationTotal,s=[],c=t.view;let m=null,f=null;if(o){if(!y){const{arcadeUtils:t}=yield u.loadArcade();y=t}m=y.createFunction(o),f=c&&y.getViewInfo({viewingMode:"2d"===c.type?"map":c.viewingMode,scale:c.scale,spatialReference:c.spatialReference})}return n?(n.forEach((t=>{const n=t.attributes;let u;if(o){const n=y.createExecContext(t,f);u=y.executeFunction(m,n)}else a?u=e.call(null,t):n&&(u=n[e]);if(i&&Number.isFinite(u)){const t=n&&parseFloat(n[l]),e=u;u=null,"log"===i&&0!==e?u=Math.log(e)*Math.LOG10E:"percent-of-total"===i&&Number.isFinite(r)&&0!==r?u=e/r*100:"field"===i&&Number.isFinite(t)&&0!==t?u=e/t:"natural-log"===i&&e>0?u=Math.log(e):"square-root"===i&&e>0&&(u=e**.5)}s.push(u)})),s):s}))).apply(this,arguments)}function E(t,n){let e=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,o=null,i=null,l=null,r=null;for(const s of t)o+=s,e=Math.min(e,s),a=Math.max(a,s);const u=t.length;if(u){i=o/u;let e=0;for(const n of t)e+=(n-i)**2;r=n?u>1?e/(u-1):0:u>0?e/u:0,l=Math.sqrt(r)}else e=null,a=null;return{avg:i,count:u,max:a,min:e,stddev:l,sum:o,variance:r}}function N(t){let n;for(n in t)v.indexOf(n)>-1&&(Number.isFinite(t[n])||(t[n]=null));return t}function S(t){const n=t.field,e=t.classificationMethod||p,a=t.normalizationType,i=t.normalizationField,l=new o;return l.classificationField=n,l.breakCount=t.breakCount,l.classificationMethod=e,l.standardDeviationInterval="standard-deviation"===e?t.standardDeviationInterval||h:void 0,l.normalizationType=a,l.normalizationField="field"===a?i:void 0,l}function C(t,n=10,e,o,i,l){const r=new Float64Array(i*l),u=a.createKernel(n),s=Math.round(3*n);let c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,d=0,p=0,h=0;const v=a.createValueFunction(o,e);for(const{geometry:a,attributes:F}of t){const t=a.x-s,n=a.y-s,e=Math.max(0,t),o=Math.max(0,n),y=Math.min(l,a.y+s),g=Math.min(i,a.x+s),x=+v(F);for(let a=o;a<y;a++){const o=u[a-n];for(let n=e;n<g;n++){const e=u[n-t],l=a*i+n,s=r[l];f=r[l]+=o*e*x;const v=f-s;d+=v,p+=v*v,f<c&&(c=f),f>m&&(m=f),h++}}}if(!h)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};const y=(m-c)/2;return{mean:d/h,stdDev:Math.sqrt((p-d*d/h)/h),min:c,max:m,mid:y,count:h}}function w(t,n){return D.apply(this,arguments)}function D(){return(D=n._asyncToGenerator((function*(t,n){const e=t.normalizationTotal,a=S({field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,classificationMethod:t.classificationMethod,standardDeviationInterval:t.standardDeviationInterval,breakCount:t.numClasses||m});let o=yield z(t,n);o=b(o,t.minValue,t.maxValue);return O(t,i.createGenerateRendererClassBreaks({definition:a,values:o,normalizationTotal:e}))}))).apply(this,arguments)}function O(t,n){let e=n.classBreaks;const a=e.length,o=e[0].minValue,i=e[a-1].maxValue,l="standard-deviation"===t.classificationMethod,r=c;return e=e.map((t=>{const n=t.label,e={minValue:t.minValue,maxValue:t.maxValue,label:n};if(l&&n){const t=n.match(r).map((t=>+t.trim()));2===t.length?(e.minStdDev=t[0],e.maxStdDev=t[1],t[0]<0&&t[1]>0&&(e.hasAvg=!0)):1===t.length&&(n.indexOf("<")>-1?(e.minStdDev=null,e.maxStdDev=t[0]):n.indexOf(">")>-1&&(e.minStdDev=t[0],e.maxStdDev=null))}return e})),{minValue:o,maxValue:i,classBreakInfos:e,normalizationTotal:n.normalizationTotal}}function _(t,n,e){const a=(n-t)/e,o=[];let i,l=t;for(let r=1;r<=e;r++)i=l+a,i=Number(i.toFixed(16)),o.push([l,r===e?n:i]),l=i;return o}function k(t){const n=[],e=t.classBreaks,a=e[0].minValue,o=e[e.length-1].maxValue;e.forEach((t=>{n.push([t.minValue,t.maxValue])}));const i={field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,layer:t.layer};return{min:a,max:o,intervals:n,sqlExpr:q(i),excludeZerosExpr:t.where,normTotal:t.normalizationTotal}}function q(t){const{field:n,normalizationType:e,normalizationField:a,normalizationTotal:o,layer:i}=t,l=r.isIntegerField(i,n);let u=n;return"percent-of-total"===e?u=`((${l?r.castIntegerFieldToFloat(n):n} / ${o}) * 100)`:"log"===e?u=`(log(${n}) * ${d})`:"field"===e?u=`(${l?r.castIntegerFieldToFloat(n):n} / ${a})`:"natural-log"===e?u=`(log(${l?r.castIntegerFieldToFloat(n):n}))`:"square-root"===e&&(u=`(power(${l?r.castIntegerFieldToFloat(n):n}, 0.5))`),u}function B(t,n,e){return G.apply(this,arguments)}function G(){return(G=n._asyncToGenerator((function*(t,n,e){const{min:a,max:o,normTotal:i}=n,l=t.numBins||f,r=n.intervals||_(a,o,l),u=r.map(((t,n)=>({minValue:r[n][0],maxValue:r[n][1],count:0}))),s=yield z(t,e);for(const c of s)if(null!=c&&c>=a&&c<=o){const t=L(r,c);t>-1&&u[t].count++}return{bins:u,minValue:a,maxValue:o,normalizationTotal:i}}))).apply(this,arguments)}function L(t,n){let e=-1;for(let a=t.length-1;a>=0;a--){if(n>=t[a][0]){e=a;break}}return e}function U(t,n){let e;if(n=n.toLowerCase(),t)for(const a in t)if(a.toLowerCase()!==n){e=t[a];break}return e}function P(t,n){let e;if(n=n.toLowerCase(),t)for(const a in t)if(a.toLowerCase()===n){e=t[a];break}return e}function $(t,n,e,a,o){const i={},l="countOFExpr";t&&t.features&&t.features.forEach((t=>{const n=t.attributes,e=U(n,l),a=P(n,l);0!==e&&(i[e]=a)}));const r=[];return _(n,e,a).forEach(((t,n)=>{const e=(n+1).toString();r.push({minValue:t[0],maxValue:t[1],count:i.hasOwnProperty(e)?i[e]:0})})),{bins:r,minValue:n,maxValue:e,normalizationTotal:o}}function A(t,n,a,o,i,l){const r=t&&t.features,u="countOF"+(a||"Expr"),s={};let c=!1;if(r.forEach((t=>{const n=t.attributes,e=P(n,u);let o=a?P(n,a):U(n,u);null===o&&0===e&&(c=!0),(null==o||"string"==typeof o&&""===o.trim())&&(o=null),null==s[o]?s[o]={count:e,data:o}:s[o].count=s[o].count+e})),a&&c){const t=a+" is NULL";return n.queryFeatureCount({whereClause:t,view:o,signal:l}).then((t=>(t=t||0,s.null.count=s.null.count+t,R(s,i)))).catch((()=>(e.throwIfAborted(l),R(s,i))))}return Promise.resolve(R(s,i))}function R(t,n){if(n)for(const e in t)t[e].label=n[e];return{count:t}}function H(t,n,e){const a=t.count,o=[];if(e&&n&&"coded-value"===n.type){n.codedValues.forEach((t=>{const n=t.code;a.hasOwnProperty(n)||(a[n]={data:n,count:0})}))}for(const i in a){const t=a[i];o.push({value:t.data,count:t.count,label:t.label})}return{uniqueValueInfos:o}}function Y(t,n,e){return J.apply(this,arguments)}function J(){return(J=n._asyncToGenerator((function*(t,n,e){const a=yield z(t,n),o={};for(let i of a)(null==i||"string"==typeof i&&""===i.trim())&&(i=null),null==o[i]?o[i]={count:1,data:i}:o[i].count++;return H({count:o},e,t.returnAllCodedValues)}))).apply(this,arguments)}function Q(t,n){return r.getDateDiffSQL(t,new Date(0),n,"milliseconds").sqlExpression}function j(t,n){const e=t.map((t=>t.value)),a=n.filter((t=>-1===e.indexOf(t)));for(const o of a)t.push({value:o,count:0});t.sort(((t,e)=>n.indexOf(t.value)-n.indexOf(e.value)));for(const o of t)o.value===l.noDominantCategoryField&&(o.value=null);return{predominantCategoryInfos:t}}t.calculateClassBreaksFromMemory=w,t.calculateHeatmapStats=C,t.calculateHistogramFromMemory=B,t.calculateStatsFromMemory=V,t.calculateUniqueValuesFromMemory=Y,t.createCBDefn=S,t.createUVResult=H,t.ensureFeaturesJSON=F,t.generateBinParams=k,t.getDataValues=z,t.getEqualIntervalBins=_,t.getFieldExpr=q,t.getHistogramFromFeatureSet=$,t.getMissingFields=g,t.getPredominantCategoriesFromUVInfos=j,t.getSummaryStatisticsFromFeatureSet=T,t.getUniqueValuesFromFeatureSet=A,t.msSinceUnixEpochSQL=Q,t.processSummaryStatisticsResult=N,t.resolveCBResult=O,t.statisticTypes=v,Object.defineProperty(t,"__esModule",{value:!0})}));
