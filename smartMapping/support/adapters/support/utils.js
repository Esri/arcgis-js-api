/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/promiseUtils","../../../../core/has","../../../../layers/support/CodedValueDomain","../../../../layers/support/Domain","../../../../layers/support/InheritedDomain","../../../../layers/support/RangeDomain","../../../../layers/support/Field","../../../statistics/support/predominanceUtils","../../utils","../../../../statistics/utils"],(function(e,t,n,i,l,o,a,r,s,u,c,f){"use strict";const d=/_value$/i,m=Math.LOG10E;function p(e){return e.map((e=>e.toJSON()))}function g(e,t){const n=[],i="featureReduction"in e.layer&&e.layer.featureReduction;if(!("binning"===i?.type)||!t)return n;const l="fields"in i?i.fields?.map((e=>e.name?.toLowerCase())).filter(Boolean):null;for(const o of t)l.includes(o.toLowerCase())||n.push(o);return n}function F(e,t,n){const i=[];if(t)for(const l of t){const t=e.getField(l);"availableFields"in n&&!n.availableFields.includes(t.name)&&i.push(t.name)}return i}function y(e,t){const n=e&&e.features,i=n&&n[0]&&n[0].attributes,l={};for(const o in i)l[o.replace(d,"").toLowerCase()]=i[o];return null!=l.totalcount&&l.totalcount>=l.count&&(l.nullcount=l.totalcount-l.count),delete l.totalcount,l.min===l.max&&null!=l.min&&null==l.stddev&&(l.stddev=l.variance=0),t&&(["min","max","avg","stddev","sum","variance"].forEach((e=>{null!=l[e]&&(l[e]=Math.ceil(l[e]))})),l.min===l.max&&null!=l.min&&(l.avg=l.min,l.stddev=l.variance=0)),l}function h(e){const t=[],n=e.classBreaks,i=n[0].minValue,l=n[n.length-1].maxValue;n.forEach((e=>{t.push([e.minValue,e.maxValue])}));const o={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:i,max:l,intervals:t,sqlExpr:v(o),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function v(e){const{field:t,normalizationType:n,normalizationField:i,normalizationTotal:l,layer:o}=e,a=c.isIntegerField(o,t);let r=t;return"percent-of-total"===n?r=`((${a?c.castIntegerFieldToFloat(t):t} / ${l}) * 100)`:"log"===n?r=`(log(${t}) * ${m})`:"field"===n?r=`(${a?c.castIntegerFieldToFloat(t):t} / ${i})`:"natural-log"===n?r=`(log(${a?c.castIntegerFieldToFloat(t):t}))`:"square-root"===n&&(r=`(power(${a?c.castIntegerFieldToFloat(t):t}, 0.5))`),r}function x(e,t){let n;if(t=t.toLowerCase(),e)for(const i in e)if(i.toLowerCase()!==t){n=e[i];break}return n}function w(e,t){let n;if(t=t.toLowerCase(),e)for(const i in e)if(i.toLowerCase()===t){n=e[i];break}return n}function S(e,t,n,i,l){const o={},a="countOFExpr";e&&e.features&&e.features.forEach((e=>{const t=e.attributes,n=x(t,a),i=w(t,a);0!==n&&(o[n]=i)}));const r=[];return f.getEqualIntervalBins(t,n,i).forEach(((e,t)=>{const n=(t+1).toString();r.push({minValue:e[0],maxValue:e[1],count:o.hasOwnProperty(n)?o[n]:0})})),{bins:r,minValue:t,maxValue:n,normalizationTotal:l}}function V(e,t){const i=e&&e.features,{field:l,field2:o,field3:a,fieldDelimiter:r,layer:s,view:u,signal:c,labels:d}=t,m=`countOF${!(!l||!o)?"Expr":l||"Expr"}`,p={};let g=!1;if(i.forEach((e=>{const t=e.attributes,n=w(t,m);let i=l?w(t,l):x(t,m),s=o?w(t,o):null,u=a?w(t,a):null;null===i&&0===n&&(g=!0),(null==i||"string"==typeof i&&""===i.trim())&&(i=null),o&&(null==s||"string"==typeof s&&""===s.trim())&&(s=null),a&&(null==u||"string"==typeof u&&""===u.trim())&&(u=null);let c=i;o&&(c=`${f.processNullValue(c)}${r}${f.processNullValue(s)}`,a&&(c=`${c}${r}${f.processNullValue(u)}`)),null==p[c]?p[c]={count:n,data:c}:p[c].count=p[c].count+n})),l&&g){const e=l+" is NULL";return s.queryFeatureCount({whereClause:e,view:u,signal:c}).then((e=>(e=e||0,p.null.count=p.null.count+e,T(p,d)))).catch((()=>(n.throwIfAborted(c),T(p,d))))}return Promise.resolve(T(p,d))}function T(e,t){if(t)for(const n in e)e[n].label=t[n];return{count:e}}function E(e,t,n){return b.apply(this,arguments)}function b(){return(b=t._asyncToGenerator((function*(e,t,n){const i=e?n.getField(e):null,o=i?n.getFieldDomain(i.name):null;if(o)return o;const{uniqueValueInfos:a}=yield n.uniqueValues({field:e,sqlWhere:t.sqlWhere,features:t.features,useFeaturesInView:t.useFeaturesInView,view:t.view,signal:t.signal}),r=a.map((e=>({code:e.value})));return new l({codedValues:r})}))).apply(this,arguments)}function $(e,t){return I.apply(this,arguments)}function I(){return(I=t._asyncToGenerator((function*(e,t){if(!e.returnAllCodedValues)return[];const{field:n,field2:i,field3:l}=e;if(n&&!i){const e=n?t.getField(n):null,i=e?t.getFieldDomain(e.name):null;return i?[i]:[]}const o=[];return n&&(o.push(E(n,e,t)),i&&(o.push(E(i,e,t)),l&&o.push(E(l,e,t)))),Promise.all(o)}))).apply(this,arguments)}function C(e,t){return c.getDateDiffSQL(e,new Date(0),t,"milliseconds").sqlExpression}function D(e){return{viewingMode:"2d"===e.type?"map":e.viewingMode,scale:e.scale,spatialReference:e.spatialReference?.toJSON()}}function L(e,t){const n=e.map((e=>e.value)),i=t.filter((e=>!n.includes(e)));for(const l of i)e.push({value:l,count:0});e.sort(((e,n)=>t.indexOf(e.value)-t.indexOf(n.value)));for(const l of e)l.value===u.noDominantCategoryField&&(l.value=null);return{predominantCategoryInfos:e}}function z(e){const t="featureReduction"in e&&e.featureReduction;return("fields"in t&&t.fields||[]).map((t=>{const n=q(t,e.fieldsIndex);return n?new s({type:n,name:t.name,alias:t.alias}):null})).filter(Boolean)}function q(e,t){switch(e.statisticType){case"avg":case"avg_angle":return"double";case"count":return"integer";case"min":case"max":case"sum":return e.onStatisticField?t.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?null:"double":null;case"mode":return e.onStatisticField?t.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?"string":"double":null;default:return null}}e.ensureFeaturesJSON=p,e.generateBinParams=h,e.getAggregateFieldType=q,e.getDomainsForFields=$,e.getFeatureReductionFields=z,e.getFieldExpr=v,e.getHistogramFromFeatureSet=S,e.getMissingFields=F,e.getMissingFieldsForBinning=g,e.getPredominantCategoriesFromUVInfos=L,e.getSummaryStatisticsFromFeatureSet=y,e.getUniqueValuesFromFeatureSet=V,e.getViewInfoParams=D,e.msSinceUnixEpochSQL=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
