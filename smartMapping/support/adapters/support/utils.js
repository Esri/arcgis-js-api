/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../../../core/promiseUtils","../../../../support/arcadeOnDemand","../../../../tasks/support/ClassBreaksDefinition","../../../../tasks/support/generateRendererUtils","../../utils","../../../../renderers/support/heatmapUtils"],(function(t,e,n,a,o,l,i){"use strict";const r=/_value$/i,s=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,u=5,c=10,m=Math.LOG10E,f="equal-interval",d=1,p=["min","max","avg","stddev","count","sum","variance"];let v=null;async function h(t,e,n){const a=[];if(e)for(const o of e){const e=t.getField(o);"availableFields"in n&&-1===n.availableFields.indexOf(e.name)&&a.push(e.name)}return a}function g(t,e){const n=t&&t.features,a=n&&n[0]&&n[0].attributes,o={};for(const l in a)o[l.replace(r,"").toLowerCase()]=a[l];return o.min===o.max&&null!=o.min&&null==o.stddev&&(o.stddev=o.variance=0),e&&(["min","max","avg","stddev","sum","variance"].forEach((t=>{null!=o[t]&&(o[t]=Math.ceil(o[t]))})),o.min===o.max&&null!=o.min&&(o.avg=o.min,o.stddev=o.variance=0)),o}async function x(t,e,n){let a=await y(t,e);a=F(a,t.minValue,t.maxValue);const o=V(a,!t.normalizationType);return n&&["avg","stddev","variance"].forEach((t=>{null!=o[t]&&(o[t]=Math.ceil(o[t]))})),o}function F(t,e,n){return e=null==e?-1/0:e,n=null==n?1/0:n,t.filter((t=>null!=t&&A(t)&&t>=e&&t<=n))}async function y(t,e){const a=t.field,o="function"==typeof a,l=t.valueExpression,i=t.normalizationType,r=t.normalizationField,s=t.normalizationTotal,u=[],c=t.view;let m=null,f=null;if(l){if(!v){const{arcadeUtils:t}=await n.loadArcade();v=t}m=v.createFunction(l),f=c&&v.getViewInfo({viewingMode:"2d"===c.type?"map":c.viewingMode,scale:c.scale,spatialReference:c.spatialReference})}return e?(e.forEach((t=>{const e=t.attributes;let n;if(l){const e=v.createExecContext(t,f);n=v.executeFunction(m,e)}else o?n=a.call(null,t):e&&(n=e[a]);if(i&&null!=n&&A(n)){const t=e&&parseFloat(e[r]),a=n;n=null,"log"===i&&0!==a?n=Math.log(a)*Math.LOG10E:"percent-of-total"===i&&A(s)&&0!==s?n=a/s*100:"field"===i&&A(t)&&0!==t?n=a/t:"natural-log"===i&&a>0?n=Math.log(a):"square-root"===i&&a>0&&(n=a**.5)}u.push(n)})),u):u}function V(t,e){let n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,o=null,l=null,i=null,r=null;for(const u of t)o+=u,n=Math.min(n,u),a=Math.max(a,u);const s=t.length;if(s){l=o/s;let n=0;for(const e of t)n+=(e-l)**2;r=e?s>1?n/(s-1):0:s>0?n/s:0,i=Math.sqrt(r)}else n=null,a=null;return{avg:l,count:s,max:a,min:n,stddev:i,sum:o,variance:r}}function T(t){let e;for(e in t)p.indexOf(e)>-1&&(A(t[e])||(t[e]=null));return t}function I(t){const e=t.field,n=t.classificationMethod||f,o=t.normalizationType,l=t.normalizationField,i=new a;return i.classificationField=e,i.breakCount=t.breakCount,i.classificationMethod=n,i.standardDeviationInterval="standard-deviation"===n?t.standardDeviationInterval||d:void 0,i.normalizationType=o,i.normalizationField="field"===o?l:void 0,i}function b(t,e=10,n,a,o,l){const r=new Float64Array(o*l),s=i.createKernel(e),u=Math.round(3*e);let c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,d=0,p=0,v=0;const h=i.createValueFunction(a,n);for(const{geometry:i,attributes:x}of t){const t=i.x-u,e=i.y-u,n=Math.max(0,t),a=Math.max(0,e),g=Math.min(l,i.y+u),F=Math.min(o,i.x+u),y=+h(x);for(let l=a;l<g;l++){const a=s[l-e];for(let e=n;e<F;e++){const n=s[e-t],i=l*o+e,u=r[i];f=r[i]+=a*n*y;const h=f-u;d+=h,p+=h*h,f<c&&(c=f),f>m&&(m=f),v++}}}if(!v)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};const g=(m-c)/2;return{mean:d/v,stdDev:Math.sqrt((p-d*d/v)/v),min:c,max:m,mid:g,count:v}}async function z(t,e){const n=t.normalizationTotal,a=I({field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,classificationMethod:t.classificationMethod,standardDeviationInterval:t.standardDeviationInterval,breakCount:t.numClasses||u});let l=await y(t,e);l=F(l,t.minValue,t.maxValue);return M(t,o.createGenerateRendererClassBreaks({definition:a,values:l,normalizationTotal:n}))}function M(t,e){let n=e.classBreaks;const a=n.length,o=n[0].minValue,l=n[a-1].maxValue,i="standard-deviation"===t.classificationMethod,r=s;return n=n.map((t=>{const e=t.label,n={minValue:t.minValue,maxValue:t.maxValue,label:e};if(i&&e){const t=e.match(r).map((t=>+t.trim()));2===t.length?(n.minStdDev=t[0],n.maxStdDev=t[1],t[0]<0&&t[1]>0&&(n.hasAvg=!0)):1===t.length&&(e.indexOf("<")>-1?(n.minStdDev=null,n.maxStdDev=t[0]):e.indexOf(">")>-1&&(n.minStdDev=t[0],n.maxStdDev=null))}return n})),{minValue:o,maxValue:l,classBreakInfos:n,normalizationTotal:e.normalizationTotal}}function E(t,e,n){const a=(e-t)/n,o=[];let l,i=t;for(let r=1;r<=n;r++)l=i+a,l=Number(l.toFixed(16)),o.push([i,r===n?e:l]),i=l;return o}function w(t){const e=[],n=t.classBreaks,a=n[0].minValue,o=n[n.length-1].maxValue;n.forEach((t=>{e.push([t.minValue,t.maxValue])}));const l={field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,layer:t.layer};return{min:a,max:o,intervals:e,sqlExpr:S(l),excludeZerosExpr:t.where,normTotal:t.normalizationTotal}}function S(t){const{field:e,normalizationType:n,normalizationField:a,normalizationTotal:o,layer:i}=t,r=l.isIntegerField(i,e);let s=e;return"percent-of-total"===n?s=`((${r?l.castIntegerFieldToFloat(e):e} / ${o}) * 100)`:"log"===n?s=`(log(${e}) * ${m})`:"field"===n?s=`(${r?l.castIntegerFieldToFloat(e):e} / ${a})`:"natural-log"===n?s=`(log(${r?l.castIntegerFieldToFloat(e):e}))`:"square-root"===n&&(s=`(power(${r?l.castIntegerFieldToFloat(e):e}, 0.5))`),s}async function N(t,e,n){const{min:a,max:o,normTotal:l}=e,i=t.numBins||c,r=e.intervals||E(a,o,i),s=r.map(((t,e)=>({minValue:r[e][0],maxValue:r[e][1],count:0}))),u=await y(t,n);for(const c of u)if(null!=c&&c>=a&&c<=o){const t=D(r,c);t>-1&&s[t].count++}return{bins:s,minValue:a,maxValue:o,normalizationTotal:l}}function D(t,e){let n=-1;for(let a=t.length-1;a>=0;a--){if(e>=t[a][0]){n=a;break}}return n}function C(t,e){let n;if(e=e.toLowerCase(),t)for(const a in t)if(a.toLowerCase()!==e){n=t[a];break}return n}function k(t,e){let n;if(e=e.toLowerCase(),t)for(const a in t)if(a.toLowerCase()===e){n=t[a];break}return n}function O(t,e,n,a,o){const l={},i="countOFExpr";t&&t.features&&t.features.forEach((t=>{const e=t.attributes,n=C(e,i),a=k(e,i);0!==n&&(l[n]=a)}));const r=[];return E(e,n,a).forEach(((t,e)=>{const n=(e+1).toString();r.push({minValue:t[0],maxValue:t[1],count:l.hasOwnProperty(n)?l[n]:0})})),{bins:r,minValue:e,maxValue:n,normalizationTotal:o}}function q(t,n,a,o,l){const i=t&&t.features,r="countOF"+(a||"Expr"),s={};let u=!1;if(i.forEach((t=>{const e=t.attributes,n=k(e,r);let o=a?k(e,a):C(e,r);null===o&&0===n&&(u=!0),(null==o||"string"==typeof o&&""===o.trim())&&(o=null),null==s[o]?s[o]={count:n,data:o}:s[o].count=s[o].count+n})),a&&u){const t=a+" is NULL";return n.queryFeatureCount(t,l).then((t=>(t=t||0,s.null.count=s.null.count+t,B(s,o)))).catch((()=>(e.throwIfAborted(l),B(s,o))))}return Promise.resolve(B(s,o))}function B(t,e){if(e)for(const n in t)t[n].label=e[n];return{count:t}}function L(t,e,n){const a=t.count,o=[];if(n&&e&&"coded-value"===e.type){e.codedValues.forEach((t=>{const e=t.code;a.hasOwnProperty(e)||(a[e]={data:e,count:0})}))}for(const l in a){const t=a[l];o.push({value:t.data,count:t.count,label:t.label})}return{uniqueValueInfos:o}}async function U(t,e,n){const a=await y(t,e),o={};for(let l of a)(null==l||"string"==typeof l&&""===l.trim())&&(l=null),null==o[l]?o[l]={count:1,data:l}:o[l].count++;return L({count:o},n,t.returnAllCodedValues)}function $(t,e){return l.getDateDiffSQL(t,new Date(0),e,"milliseconds").sqlExpression}function A(t){return"number"==typeof t&&!isNaN(t)&&t!==1/0&&t!==-1/0}t.calculateClassBreaksFromMemory=z,t.calculateHeatmapStats=b,t.calculateHistogramFromMemory=N,t.calculateStatsFromMemory=x,t.calculateUniqueValuesFromMemory=U,t.createCBDefn=I,t.createUVResult=L,t.generateBinParams=w,t.getDataValues=y,t.getEqualIntervalBins=E,t.getFieldExpr=S,t.getHistogramFromFeatureSet=O,t.getMissingFields=h,t.getSummaryStatisticsFromFeatureSet=g,t.getUniqueValuesFromFeatureSet=q,t.isValidNumber=A,t.msSinceUnixEpochSQL=$,t.processSummaryStatisticsResult=T,t.resolveCBResult=M,t.statisticTypes=p,Object.defineProperty(t,"__esModule",{value:!0})}));
