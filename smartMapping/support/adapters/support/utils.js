/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{throwIfAborted as t}from"../../../../core/promiseUtils.js";import{noDominantCategoryField as n}from"../../../statistics/support/predominanceUtils.js";import{isIntegerField as o,castIntegerFieldToFloat as e,getDateDiffSQL as a}from"../../utils.js";import{getEqualIntervalBins as l}from"../../../../statistics/utils.js";const i=/_value$/i,r=Math.LOG10E;function u(t){return t.map((t=>t.toJSON()))}async function s(t,n,o){const e=[];if(n)for(const a of n){const n=t.getField(a);"availableFields"in o&&!o.availableFields.includes(n.name)&&e.push(n.name)}return e}function c(t,n){const o=t&&t.features,e=o&&o[0]&&o[0].attributes,a={};for(const l in e)a[l.replace(i,"").toLowerCase()]=e[l];return null!=a.totalcount&&a.totalcount>=a.count&&(a.nullcount=a.totalcount-a.count),delete a.totalcount,a.min===a.max&&null!=a.min&&null==a.stddev&&(a.stddev=a.variance=0),n&&(["min","max","avg","stddev","sum","variance"].forEach((t=>{null!=a[t]&&(a[t]=Math.ceil(a[t]))})),a.min===a.max&&null!=a.min&&(a.avg=a.min,a.stddev=a.variance=0)),a}function f(t){const n=[],o=t.classBreaks,e=o[0].minValue,a=o[o.length-1].maxValue;o.forEach((t=>{n.push([t.minValue,t.maxValue])}));const l={field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,layer:t.layer};return{min:e,max:a,intervals:n,sqlExpr:m(l),excludeZerosExpr:t.where,normTotal:t.normalizationTotal}}function m(t){const{field:n,normalizationType:a,normalizationField:l,normalizationTotal:i,layer:u}=t,s=o(u,n);let c=n;return"percent-of-total"===a?c=`((${s?e(n):n} / ${i}) * 100)`:"log"===a?c=`(log(${n}) * ${r})`:"field"===a?c=`(${s?e(n):n} / ${l})`:"natural-log"===a?c=`(log(${s?e(n):n}))`:"square-root"===a&&(c=`(power(${s?e(n):n}, 0.5))`),c}function p(t,n){let o;if(n=n.toLowerCase(),t)for(const e in t)if(e.toLowerCase()!==n){o=t[e];break}return o}function d(t,n){let o;if(n=n.toLowerCase(),t)for(const e in t)if(e.toLowerCase()===n){o=t[e];break}return o}function v(t,n,o,e,a){const i={},r="countOFExpr";t&&t.features&&t.features.forEach((t=>{const n=t.attributes,o=p(n,r),e=d(n,r);0!==o&&(i[o]=e)}));const u=[];return l(n,o,e).forEach(((t,n)=>{const o=(n+1).toString();u.push({minValue:t[0],maxValue:t[1],count:i.hasOwnProperty(o)?i[o]:0})})),{bins:u,minValue:n,maxValue:o,normalizationTotal:a}}function h(n,o,e,a,l,i){const r=n&&n.features,u="countOF"+(e||"Expr"),s={};let c=!1;if(r.forEach((t=>{const n=t.attributes,o=d(n,u);let a=e?d(n,e):p(n,u);null===a&&0===o&&(c=!0),(null==a||"string"==typeof a&&""===a.trim())&&(a=null),null==s[a]?s[a]={count:o,data:a}:s[a].count=s[a].count+o})),e&&c){const n=e+" is NULL";return o.queryFeatureCount({whereClause:n,view:a,signal:i}).then((t=>(t=t||0,s.null.count=s.null.count+t,x(s,l)))).catch((()=>(t(i),x(s,l))))}return Promise.resolve(x(s,l))}function x(t,n){if(n)for(const o in t)t[o].label=n[o];return{count:t}}function g(t,n){return a(t,new Date(0),n,"milliseconds").sqlExpression}function w(t){return{viewingMode:"2d"===t.type?"map":t.viewingMode,scale:t.scale,spatialReference:t.spatialReference?.toJSON()}}function y(t,o){const e=t.map((t=>t.value)),a=o.filter((t=>!e.includes(t)));for(const n of a)t.push({value:n,count:0});t.sort(((t,n)=>o.indexOf(t.value)-o.indexOf(n.value)));for(const l of t)l.value===n&&(l.value=null);return{predominantCategoryInfos:t}}export{u as ensureFeaturesJSON,f as generateBinParams,m as getFieldExpr,v as getHistogramFromFeatureSet,s as getMissingFields,y as getPredominantCategoriesFromUVInfos,c as getSummaryStatisticsFromFeatureSet,h as getUniqueValuesFromFeatureSet,w as getViewInfoParams,g as msSinceUnixEpochSQL};
