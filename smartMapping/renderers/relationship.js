/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/lang","../../core/maybe","../../intl/messages","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoClassBreakInfo","../../renderers/support/AuthoringInfoFieldInfo","./type","./support/utils","../support/binningUtils","../support/adapters/support/layerUtils","../symbology/relationship","../../symbols/support/utils"],(function(e,n,a,i,l,r,s,o,t,d,u,m,f,p,c){"use strict";const h=["equal-interval","natural-breaks","quantile"],y=["HH","HL","LH","LL"],b={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},g={2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]},v=e=>({minValue:e.minValue,maxValue:e.maxValue});function w(e){return I.apply(this,arguments)}function I(){return(I=n._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.field1&&e.field2))throw new a("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");e.forBinning&&m.verifyBinningParams(e,"relationship-renderer");const n={...e};if(n.symbolType=n.symbolType||"2d",n.defaultSymbolEnabled=null==n.defaultSymbolEnabled||n.defaultSymbolEnabled,n.classificationMethod=n.classificationMethod||"quantile",n.numClasses=n.numClasses||3,n.focus=n.focus||null,!h.includes(n.classificationMethod))throw new a("relationship-renderer:invalid-parameters",`classification method ${n.classificationMethod} is not supported`);if(n.numClasses<2||n.numClasses>4)throw new a("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(e.focus&&!y.includes(e.focus))throw new a("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");const i=e.forBinning?f.binningCapableLayerTypes:f.featureCapableLayerTypes,r=f.createLayerAdapter(n.layer,i,e.forBinning);if(n.layer=r,!r)throw new a("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(i).join(", "));const s=l.isSome(n.signal)?{signal:n.signal}:null;yield r.load(s);const o=r.geometryType,t=n.symbolType.includes("3d");if(n.outlineOptimizationEnabled="polygon"===o&&n.outlineOptimizationEnabled,n.sizeOptimizationEnabled=("point"===o||"multipoint"===o||"polyline"===o)&&n.sizeOptimizationEnabled,"mesh"===o)n.symbolType="3d-volumetric",n.colorMixMode=n.colorMixMode||"replace",n.edgesType=n.edgesType||"none";else{if("3d-volumetric-uniform"===n.symbolType&&"point"!==o)throw new a("relationship-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(t&&"polygon"===o)throw new a("relationship-renderer:not-supported","3d symbols are not supported for polygon layers");if(n.symbolType.includes("3d-volumetric")&&(!n.view||"3d"!==n.view.type))throw new a("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const{field1:d,field2:p}=n,c=[d.field,p.field];d.normalizationField&&c.push(d.normalizationField),p.normalizationField&&c.push(p.normalizationField);const b=u.verifyBasicFieldValidity(r,c,"relationship-renderer:invalid-parameters");if(b)throw b;return n}))).apply(this,arguments)}function M(e){return T.apply(this,arguments)}function T(){return(T=n._asyncToGenerator((function*(e){if(!(e&&e.renderer&&e.numClasses))throw new a("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");const{field1:n,field2:i,renderer:l,numClasses:r,colors:s}=e,o=r**2;if((n||i)&&!(n&&i&&n.field&&i.field))throw new a("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(n&&!n.classBreakInfos||i&&!i.classBreakInfos)throw new a("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!l.authoringInfo)throw new a("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");if(l.uniqueValueInfos.length!==o)throw new a("update-relationship-renderer:invalid-parameters",`Renderer must have ${o} unique value infos to support ${r} classes`);if(s&&s.length!==o)throw new a("update-relationship-renderer:invalid-parameters",`The scheme must have ${o} colors`);return e}))).apply(this,arguments)}function F(e){return z.apply(this,arguments)}function z(){return(z=n._asyncToGenerator((function*(e){let n=e.relationshipScheme,a=null,i=null;const r=yield u.getBasemapInfo(e.basemap,e.view);if(a=l.isSome(r.basemapId)?r.basemapId:null,i=l.isSome(r.basemapTheme)?r.basemapTheme:null,n)return{scheme:p.cloneScheme(n),basemapId:a,basemapTheme:i};const s=p.getSchemes({basemap:a,basemapTheme:i,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});return s&&(n=s.primaryScheme,a=s.basemapId,i=s.basemapTheme),{scheme:n,basemapId:a,basemapTheme:i}}))).apply(this,arguments)}function C(e,n){const a=i.clone(b[e]);return p.flatten2DArray(a,n)}function L(e,n){return C(e,n).map((e=>({value:e,count:0})))}function k(e,n,a,i){const{field:l,normalizationField:r}=e,{field:s,normalizationField:o}=n,t=a.map((e=>[e.minValue,e.maxValue])),d=i.map((e=>[e.minValue,e.maxValue])),u=t.length,m=g[u];return`\n  var field1 = $feature['${l}'];\n  var field2 = $feature['${s}'];\n  var hasNormField1 = ${r?"true":"false"};\n  var hasNormField2 = ${o?"true":"false"};\n  var normField1 = ${r?`$feature['${r}']`:"null"};\n  var normField2 = ${o?`$feature['${o}']`:"null"};\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||\n    (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))\n  ) {\n    return null;\n  }\n\n  var value1 = IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 = IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 = ${JSON.stringify(t)};\n  var breaks2 = ${JSON.stringify(d)};\n  var classCodes = ${JSON.stringify(m)};\n\n  function getClassCode(value, breaks) {\n    var code = null;\n\n    for (var i in breaks) {\n      var info = breaks[i];\n      if (value >= info[0] && value <= info[1]) {\n        code = classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 = getClassCode(value1, breaks1);\n  var code2 = getClassCode(value2, breaks2);\n\n  var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  `}function V(e,n,a){return H.apply(this,arguments)}function H(){return(H=n._asyncToGenerator((function*(e,n,i){const l=yield r.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),{basemap:o,classificationMethod:t,field1:u,field2:m,focus:f,numClasses:c,signal:h}=e,y=e.layer,b=n.classBreakInfos,g=i.classBreakInfos;if(c!==b.length||b.length!==g.length)throw new a("relationship-renderer:error","incompatible class breaks");const w=L(c,f),I=k(e.field1,e.field2,b,g),M=(yield F({basemap:o,geometryType:y.geometryType,theme:"default",relationshipScheme:e.relationshipScheme,worldScale:e.symbolType.includes("3d-volumetric"),view:e.view})).scheme,T=yield d.createRenderer({layer:y,basemap:o,valueExpression:I,valueExpressionTitle:l.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:e.defaultSymbolEnabled,typeScheme:{colors:p.getColors(M,c,f),...M},statistics:{uniqueValueInfos:w},legendOptions:e.legendOptions,outlineOptimizationEnabled:e.outlineOptimizationEnabled,sizeOptimizationEnabled:e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:h}),z=T.renderer,C=z.uniqueValueInfos,V=l.relationship;for(const a of C)a.label=V[a.value];const H=new s({type:"relationship",classificationMethod:t,numClasses:c,focus:f,field1:{field:u.field,normalizationField:u.normalizationField,label:u.label,classBreakInfos:b.map(v)},field2:{field:m.field,normalizationField:m.normalizationField,label:m.label,classBreakInfos:g.map(v)}});return z.authoringInfo=H,{renderer:z,classBreaks:{field1:n,field2:i},uniqueValueInfos:T.uniqueValueInfos,relationshipScheme:M,basemapId:T.basemapId,basemapTheme:T.basemapTheme}}))).apply(this,arguments)}function B(e,n,a){const i=C(n,a);e.sort(((e,n)=>{const a=i.indexOf(e.value),l=i.indexOf(n.value);let r=0;return a<l?r=-1:a>l&&(r=1),r}))}function S(e,n){const{authoringInfo:a}=e;a.numClasses=n.numClasses,a.focus=n.focus||null,a.focus||delete a.focus;const{field1:i,field2:l}=n;a.field1=new t.AuthoringInfoFieldInfo({field:i.field,normalizationField:i.normalizationField,label:i.label,classBreakInfos:i.classBreakInfos.map((e=>new o.AuthoringInfoClassBreakInfo(v(e))))}),a.field2=new t.AuthoringInfoFieldInfo({field:l.field,normalizationField:l.normalizationField,label:l.label,classBreakInfos:l.classBreakInfos.map((e=>new o.AuthoringInfoClassBreakInfo(v(e))))}),e.authoringInfo=a}function E(e){return x.apply(this,arguments)}function x(){return(x=n._asyncToGenerator((function*(e){const n=yield M(e),{field1:a,field2:i,renderer:l,numClasses:r,focus:s,colors:o}=n,t=l.clone();if(t.valueExpression=k(a,i,a.classBreakInfos,i.classBreakInfos),B(t.uniqueValueInfos,r,s),o){const e=u.createColors(o,o.length);t.uniqueValueInfos.forEach(((n,a)=>c.applyColorToSymbol(n.symbol,e[a])))}return S(t,n),t}))).apply(this,arguments)}function $(e){return q.apply(this,arguments)}function q(){return(q=n._asyncToGenerator((function*(e){const n=yield w(e),{layer:i,classificationMethod:l,field1:r,field2:s,numClasses:o,view:t,signal:d}=n,m={layer:i,classificationMethod:l,field:r.field,normalizationField:r.normalizationField,normalizationType:r.normalizationField?"field":null,minValue:r.minValue,maxValue:r.maxValue,analyzeData:!(null!=r.minValue&&null!=r.maxValue),numClasses:o,view:t,signal:d},f={layer:i,classificationMethod:l,field:s.field,normalizationField:s.normalizationField,normalizationType:s.normalizationField?"field":null,minValue:s.minValue,maxValue:s.maxValue,analyzeData:!(null!=s.minValue&&null!=s.maxValue),numClasses:o,view:t,signal:d},[p,c]=yield Promise.all([u.getClassBreaks(m),u.getClassBreaks(f)]);if(!p||!c)throw new a("relationship-renderer:error","error when calculating class breaks");return V(n,p.result,c.result)}))).apply(this,arguments)}e.createRenderer=$,e.updateRenderer=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
