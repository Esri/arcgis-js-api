/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Error","../../core/maybe","../../geometry/support/scaleUtils","../../renderers/support/AuthoringInfo","../heuristics/outline","./support/dotDensityUtils","./support/utils","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/utils","../support/adapters/support/layerUtils","../../chunks/dotDensity"],(function(e,t,r,n,i,a,s,l,o,u,d,p,y,c,m,b,f,g,h,v,S,w,V){"use strict";const T=500;function D(e){return E.apply(this,arguments)}function E(){return(E=t._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new d("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new d("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");const t={...e},r=[w.LayerType.FeatureLayer,w.LayerType.OGCFeatureLayer,w.LayerType.GeoJSONLayer,w.LayerType.WFSLayer],n=w.createLayerAdapter(t.layer,r);if(t.layer=n,t.dotBlendingEnabled=null==t.dotBlendingEnabled||t.dotBlendingEnabled,t.dotValueOptimizationEnabled=null==t.dotValueOptimizationEnabled||t.dotValueOptimizationEnabled,!n)throw new d("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(r).join(", "));const i=p.isSome(t.signal)?{signal:t.signal}:null;yield Promise.all([t.view.when(),n.load(i)]);if("polygon"!==n.geometryType)throw new d("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return t}))).apply(this,arguments)}function x(e){return L.apply(this,arguments)}function L(){return(L=t._asyncToGenerator((function*(e){let t=e.dotDensityScheme,r=null,n=null;const i=yield f.getBasemapInfo(e.basemap,e.view);if(r=p.isSome(i.basemapId)?i.basemapId:null,n=p.isSome(i.basemapTheme)?i.basemapTheme:null,t)return{scheme:V.cloneScheme(t),basemapId:r,basemapTheme:n};const a=V.getSchemes({basemap:r,numColors:e.attributes.length,basemapTheme:n});return a&&(t=a.primaryScheme,r=a.basemapId,n=a.basemapTheme),{scheme:t,basemapId:r,basemapTheme:n}}))).apply(this,arguments)}function R(e){return F.apply(this,arguments)}function F(){return(F=t._asyncToGenerator((function*(e){const{view:t,layer:r,attributes:n,signal:i}=e,a=yield r.getSampleFeatures({view:t,sampleSize:T,returnGeometry:!0,signal:i}),[s,l]=yield Promise.all([g({features:a,geometryType:r.geometryType}),h({layer:r,attributes:n,includeZeros:!1,includeNegatives:!1,view:t,signal:i})]),o="avgSize"in s&&s.avgSize,u=l.avg;if(!o)throw new d("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!u)throw new d("dot-density-renderer:insufficient-info","Average attribute value is invalid");const p=y.getResolutionForScale(t.scale,t.spatialReference),c=o*o/(p*p)*.1;return{dotValue:b.roundValue(u/c)||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:b.roundValue(u)}}))).apply(this,arguments)}function I(e){return O.apply(this,arguments)}function O(){return(O=t._asyncToGenerator((function*(e){const{view:t,layer:r,attributes:n,signal:i}=e,a=[];for(const d of n){const e=yield S.getFieldsList({field:d.field,valueExpression:d.valueExpression});a.push(...e)}const s=yield r.getSampleFeatures({view:t,sampleSize:T,requiredFields:a,returnGeometry:!0,signal:i}),l=yield v({features:s,attributes:n,includeZeros:!1,includeNegatives:!1,view:t});if(!l.avgDensity||!l.minDensity||!l.maxDensity)throw new d("dot-density-renderer:insufficient-info","Invalid density values");const o=y.getResolutionForScale(t.scale,t.spatialReference),u=o*o,p=b.roundValue(l.minDensity*u),c=b.roundValue(l.maxDensity*u),m=10;let f=b.roundValue(l.avgDensity*u*m)||1;return f>c&&(f=c),{dotValue:f,referenceScale:t.scale,minSliderValue:p,maxSliderValue:c}}))).apply(this,arguments)}function z(e){return G.apply(this,arguments)}function G(){return(G=t._asyncToGenerator((function*(e){const t=yield D(e),r=t.layer,n=r.geometryType,a=yield x(t),s=a&&a.scheme;if(!s)throw new d("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");const l={layer:r,view:t.view,attributes:t.attributes,signal:t.signal},o={layer:t.layer,view:t.view,signal:t.signal},[u,p]=yield Promise.all([t.trueDensity?I(l):R(l),t.outlineOptimizationEnabled?m(o):null]),{dotValue:y,referenceScale:b,minSliderValue:g,maxSliderValue:h}=u,v=f.createColors(s.colors,t.attributes.length),S=t.attributes.map(((e,t)=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:v[t]}))),w=new i({attributes:S,dotBlendingEnabled:t.dotBlendingEnabled,outline:p?f.getSymbolOutlineFromScheme(s,n,p.opacity):null,dotValue:y,referenceScale:t.dotValueOptimizationEnabled?b:null,legendOptions:t.legendOptions});return p&&p.visualVariables&&p.visualVariables.length&&(w.visualVariables=p.visualVariables.map((e=>e.clone()))),w.authoringInfo=new c({type:"dot-density",minSliderValue:g,maxSliderValue:h}),{renderer:w,dotDensityScheme:s,basemapId:a.basemapId,basemapTheme:a.basemapTheme}}))).apply(this,arguments)}e.createRenderer=z,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
