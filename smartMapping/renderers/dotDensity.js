/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Error","../../core/maybe","../../geometry/support/scaleUtils","../../renderers/support/AuthoringInfo","../heuristics/outline","./support/dotDensityUtils","./support/utils","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/utils","../support/adapters/support/layerUtils","../../chunks/dotDensity"],(function(e,t,r,n,i,a,s,l,o,u,d,p,y,c,m,f,b,g,h,v,w,S,V){"use strict";const T=500;function D(e){return E.apply(this,arguments)}function E(){return(E=t._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new d("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new d("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");const t={...e},r=[2,1,5],n=S.createLayerAdapter(t.layer,r);if(t.layer=n,t.dotBlendingEnabled=null==t.dotBlendingEnabled||t.dotBlendingEnabled,t.dotValueOptimizationEnabled=null==t.dotValueOptimizationEnabled||t.dotValueOptimizationEnabled,!n)throw new d("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+S.getLayerTypeLabels(r).join(", "));const i=p.isSome(t.signal)?{signal:t.signal}:null;yield Promise.all([t.view.when(),n.load(i)]);if("polygon"!==n.geometryType)throw new d("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return t}))).apply(this,arguments)}function x(e){return R.apply(this,arguments)}function R(){return(R=t._asyncToGenerator((function*(e){let t=e.dotDensityScheme,r=null,n=null;const i=yield b.getBasemapInfo(e.basemap,e.view);if(r=p.isSome(i.basemapId)?i.basemapId:null,n=p.isSome(i.basemapTheme)?i.basemapTheme:null,t)return{scheme:V.cloneScheme(t),basemapId:r,basemapTheme:n};const a=V.getSchemes({basemap:r,numColors:e.attributes.length,basemapTheme:n});return a&&(t=a.primaryScheme,r=a.basemapId,n=a.basemapTheme),{scheme:t,basemapId:r,basemapTheme:n}}))).apply(this,arguments)}function I(e){return z.apply(this,arguments)}function z(){return(z=t._asyncToGenerator((function*(e){const{view:t,layer:r,attributes:n,signal:i}=e,a=yield r.getSampleFeatures({view:t,sampleSize:T,returnGeometry:!0,signal:i}),[s,l]=yield Promise.all([g({features:a,geometryType:r.geometryType}),h({layer:r,attributes:n,includeZeros:!1,includeNegatives:!1,view:t,signal:i})]),o="avgSize"in s&&s.avgSize,u=l.avg;if(!o)throw new d("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!u)throw new d("dot-density-renderer:insufficient-info","Average attribute value is invalid");const p=y.getResolutionForScale(t.scale,t.spatialReference),c=o*o/(p*p)*.1;return{dotValue:f.roundValue(u/c)||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:f.roundValue(u)}}))).apply(this,arguments)}function O(e){return B.apply(this,arguments)}function B(){return(B=t._asyncToGenerator((function*(e){const{view:t,layer:r,attributes:n,signal:i}=e,a=[];for(const d of n){const e=yield w.getFieldsList({field:d.field,valueExpression:d.valueExpression});a.push(...e)}const s=yield r.getSampleFeatures({view:t,sampleSize:T,requiredFields:a,returnGeometry:!0,signal:i}),l=yield v({features:s,attributes:n,includeZeros:!1,includeNegatives:!1,view:t});if(!l.avgDensity||!l.minDensity||!l.maxDensity)throw new d("dot-density-renderer:insufficient-info","Invalid density values");const o=y.getResolutionForScale(t.scale,t.spatialReference),u=o*o,p=f.roundValue(l.minDensity*u),c=f.roundValue(l.maxDensity*u),m=10;let b=f.roundValue(l.avgDensity*u*m)||1;return b>c&&(b=c),{dotValue:b,referenceScale:t.scale,minSliderValue:p,maxSliderValue:c}}))).apply(this,arguments)}function F(e){return _.apply(this,arguments)}function _(){return(_=t._asyncToGenerator((function*(e){const t=yield D(e),r=t.layer,n=r.geometryType,a=yield x(t),s=a&&a.scheme;if(!s)throw new d("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");const l={layer:r,view:t.view,attributes:t.attributes,signal:t.signal},o={layer:t.layer,view:t.view,signal:t.signal},[u,p]=yield Promise.all([t.trueDensity?O(l):I(l),t.outlineOptimizationEnabled?m(o):null]),{dotValue:y,referenceScale:f,minSliderValue:g,maxSliderValue:h}=u,v=b.createColors(s.colors,t.attributes.length),w=t.attributes.map(((e,t)=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:v[t]}))),S=new i({attributes:w,dotBlendingEnabled:t.dotBlendingEnabled,outline:p?b.getSymbolOutlineFromScheme(s,n,p.opacity):null,dotValue:y,referenceScale:t.dotValueOptimizationEnabled?f:null,legendOptions:t.legendOptions});return p&&p.visualVariables&&p.visualVariables.length&&(S.visualVariables=p.visualVariables.map((e=>e.clone()))),S.authoringInfo=new c({type:"dot-density",minSliderValue:g,maxSliderValue:h}),{renderer:S,dotDensityScheme:s,basemapId:a.basemapId,basemapTheme:a.basemapTheme}}))).apply(this,arguments)}e.createRenderer=F,Object.defineProperty(e,"__esModule",{value:!0})}));
