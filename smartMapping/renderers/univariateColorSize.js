/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{isSome as i}from"../../core/maybe.js";import s from"../../renderers/support/AuthoringInfo.js";import o from"../../renderers/support/ClassBreakInfo.js";import a from"../../renderers/visualVariables/support/SizeStop.js";import{getSize as l}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{createVisualVariable as n}from"./color.js";import{createVisualVariables as t,createContinuousRenderer as r}from"./size.js";import{verifyBasicFieldValidity as u,createStopValuesForAboveBelow as m,clampAboveAndBelowStopValues as p,createDefaultStopValues as c}from"./support/utils.js";import{getFieldsList as d}from"../support/utils.js";import{createLayerAdapter as v,featureCapableLayerTypes as b,getLayerTypeLabels as f}from"../support/adapters/support/layerUtils.js";import{getAboveAndBelowSymbols as y}from"../symbology/support/aboveAndBelowUtils.js";import{applyCIMSymbolColor as w}from"../../symbols/support/cimSymbolUtils.js";import{Symbol3DMaterial as h}from"../../symbols/support/Symbol3DMaterial.js";const z=2**53-1;async function V(s){if(!(s&&s.layer&&(s.field||s.valueExpression||s.sqlExpression)))throw new e("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(s.valueExpression&&!s.sqlExpression&&!s.view)throw new e("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===s.theme&&s.sizeOptions?.sizeOptimizationEnabled)throw new e("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");const o={...s},a=v(o.layer,b);if(o.layer=a,o.theme=o.theme||o.colorOptions?.theme?o.theme:"high-to-low","90-10"===o.theme)throw new e("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");if(!a)throw new e("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+f(b).join(", "));const l=i(o.signal)?{signal:o.signal}:null;await a.load(l);const n=await d({field:o.field,normalizationField:o.normalizationField,valueExpression:o.valueExpression}),t=u(a,n,"univariate-colorsize-visual-variables:invalid-parameters");if(t)throw t;return o}function g(e,i){const s={...e},{sizeOptions:o,theme:a}=s,l=s.legendOptions||s.sizeOptions?.legendOptions;return delete s.sizeOptions,delete s.colorOptions,{...s,...o,statistics:i||s.statistics,theme:"above-and-below"===a?null:a,legendOptions:l}}function O(e,i){const s={...e},o=s.colorOptions,a=s.theme||o?.theme,l=s.legendOptions||s.colorOptions?.legendOptions;return delete s.sizeOptions,delete s.colorOptions,{...s,...o,statistics:i||s.statistics,theme:a,legendOptions:l}}async function x(s){if(!(s&&s.layer&&(s.field||s.valueExpression||s.sqlExpression)))throw new e("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(s.valueExpression&&!s.sqlExpression&&!s.view)throw new e("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const o={...s};o.symbolType=o.symbolType||"2d",o.colorOptions||(o.colorOptions={}),o.colorOptions.isContinuous=o.colorOptions.isContinuous??!1;const a=v(o.layer,b);if(o.layer=a,!a)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+f(b).join(", "));const l=i(o.signal)?{signal:o.signal}:null;if(await a.load(l),"above-and-below"===o.theme&&o.symbolOptions){if(o.symbolType.includes("3d-volumetric"))throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==a.geometryType&&"polygon"!==a.geometryType)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const n=await d({field:o.field,normalizationField:o.normalizationField,valueExpression:o.valueExpression}),t=u(a,n,"univariate-colorsize-continuous-renderer:invalid-parameters");if(t)throw t;return o}function E(e){const i={...e},s={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete s.sizeOptimizationEnabled,{...i,...s}}function S(e,i){if("type"in e&&"cim"===e.type)w(e,i);else if("type"in e&&e.type.includes("3d")){e.symbolLayers.forEach((e=>{"material"in e&&"color"in e.material&&(e.material?e.material.color=i:e.material=new h({color:i}))}))}else"color"in e&&(e.color=i)}function j(e,i,s){if((i?.symbolStyle||i?.symbols)&&("point"===s||"polygon"===s))return i.symbols||y(i.symbolStyle);const o=e.classBreakInfos[0].symbol;return{above:o.clone(),below:o.clone()}}function T(e,i,s){const a=s.symbolOptions,l=s.layer,n=a?.symbols?"custom":a?.symbolStyle,t=s.colorOptions?.isContinuous;if(I(e,i,t),n||!t){const{stops:s}=i.size.visualVariables[0],{above:r,below:u}=j(e,a,l.geometryType);if(!t){const e=i.color.colorScheme.colors,s=e[0];S(r,e[e.length-1]),S(u,s)}e.classBreakInfos=[new o({minValue:-z,maxValue:s[2].value,symbol:u}),new o({minValue:s[2].value,maxValue:z,symbol:r})],n&&(e.authoringInfo.univariateSymbolStyle=n)}}function I(e,i,s=!0){const o=i?.authoringInfo?.clone(),a=i.size.visualVariables.map((e=>e.clone()));s?a.push(i.color.visualVariable.clone()):o.visualVariables=o.visualVariables.filter((e=>"size"===e.type)),a.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=o,e.visualVariables=a}function q(e){const i={...e},s=i.symbolType,o=s.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const a=i;return a.worldScale=o,o&&(a.sizeOptions={...a.sizeOptions},a.sizeOptions.axis="3d-volumetric-uniform"===s?"all":"height"),a}async function D(e,i,s,o){const n=i[0],t=i[1],r=Math.round((t-n)/2)+n,u=e.clone();u.stops=[new a({value:s[0],size:t}),new a({value:s[1],size:r}),new a({value:s[2],size:n}),new a({value:s[3],size:r}),new a({value:s[4],size:t})],e.stops=[new a({value:o[0],size:l(u,o[0])}),new a({value:o[1],size:l(u,o[1])}),new a({value:o[2],size:l(u,o[2])}),new a({value:o[3],size:l(u,o[3])}),new a({value:o[4],size:l(u,o[4])})]}async function U(e,i,s,o){const a=e.find((e=>"width-and-depth"!==e.axis&&!e.target)),l="number"==typeof a?.minSize?a?.minSize:null,n="number"==typeof a?.maxSize?a?.maxSize:null;if(null!=a?.minDataValue&&null!=l&&null!=n)if(o)if("above-and-below"===o){a.minDataValue=null,a.maxDataValue=null,a.minSize=null,a.maxSize=null;const e=m(s),o=p(e,s);await D(a,[l,n],e,o),i.stops.forEach(((e,i)=>e.value=o[i]))}else{const{minDataValue:e,maxDataValue:s}=a,o=c(e,s,5);i.stops.forEach(((e,i)=>e.value=o[i])),a.minDataValue=o[0],a.maxDataValue=o[o.length-1]}else a.minDataValue=i.stops[0].value,a.maxDataValue=i.stops[i.stops.length-1].value}function C(e,i,o){const{theme:a,minValue:l,maxValue:n}=e,t=i.authoringInfo.visualVariables[0].clone(),r=o.authoringInfo.visualVariables[0].clone();if("above-and-below"===a){const e=i.visualVariable.stops;t.minSliderValue=r.minSliderValue=l??e[0].value,t.maxSliderValue=r.maxSliderValue=n??e[e.length-1].value,r.theme="above-and-below"}return new s({type:"univariate-color-size",univariateTheme:a,visualVariables:[t,r]})}async function B(e){const i=await V(e),s=await n(O(i)),{visualVariable:o,statistics:a}=s,l=await t(g(i,a)),r=l.visualVariables;return await U(r,o,a,i.theme),{basemapId:l.basemapId,basemapTheme:l.basemapTheme,statistics:a,defaultValuesUsed:s.defaultValuesUsed,color:{visualVariable:o,colorScheme:s.colorScheme},size:{visualVariables:r,sizeScheme:l.sizeScheme},authoringInfo:C(i,s,l)}}async function F(e){return k(e)}async function k(e){const i=await x(e),{renderer:s,statistics:o,defaultValuesUsed:a}=await r(E(i)),l=q(i);l.statistics=o;const n=await B(l);return"above-and-below"===i.theme?T(s,n,i):I(s,n),{renderer:s,statistics:o,defaultValuesUsed:a,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?n.color:null,size:n.size,basemapId:n.basemapId,basemapTheme:n.basemapTheme}}export{F as createContinuousRenderer,k as createRenderer,B as createVisualVariables};
