/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","../../renderers/support/AuthoringInfo","../../renderers/support/ClassBreakInfo","../../renderers/visualVariables/support/SizeStop","../../renderers/visualVariables/support/visualVariableUtils","./color","./size","./support/utils","../support/utils","../support/adapters/support/layerUtils","../symbology/support/aboveAndBelowUtils","../../symbols/support/cimSymbolUtils","../../symbols/support/Symbol3DMaterial"],(function(e,i,l,a,o,n,s,t,r,u,p,c,d,m,v,y){"use strict";const b=2**53-1;function f(e){return h.apply(this,arguments)}function h(){return(h=i._asyncToGenerator((function*(e){var i,o;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new l("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new l("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===e.theme&&null!=(i=e.sizeOptions)&&i.sizeOptimizationEnabled)throw new l("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");const n={...e},s=[0,2,1,3,5],t=d.createLayerAdapter(n.layer,s);if(n.layer=t,n.theme=n.theme||null!=(o=n.colorOptions)&&o.theme?n.theme:"high-to-low","90-10"===n.theme)throw new l("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");if(!t)throw new l("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(s).join(", "));const r=a.isSome(n.signal)?{signal:n.signal}:null;yield t.load(r);const u=yield c.getFieldsList({field:n.field,normalizationField:n.normalizationField,valueExpression:n.valueExpression}),m=p.verifyBasicFieldValidity(t,u,"univariate-colorsize-visual-variables:invalid-parameters");if(m)throw m;return n}))).apply(this,arguments)}function w(e,i){var l;const a={...e},{sizeOptions:o,theme:n}=a,s=a.legendOptions||(null==(l=a.sizeOptions)?void 0:l.legendOptions);return delete a.sizeOptions,delete a.colorOptions,{...a,...o,statistics:i||a.statistics,theme:"above-and-below"===n?null:n,legendOptions:s}}function z(e,i){var l;const a={...e},o=a.colorOptions,n=a.theme||(null==o?void 0:o.theme),s=a.legendOptions||(null==(l=a.colorOptions)?void 0:l.legendOptions);return delete a.sizeOptions,delete a.colorOptions,{...a,...o,statistics:i||a.statistics,theme:n,legendOptions:s}}function V(e){return g.apply(this,arguments)}function g(){return(g=i._asyncToGenerator((function*(e){var i;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new l("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new l("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const o={...e};o.symbolType=o.symbolType||"2d",o.colorOptions||(o.colorOptions={}),o.colorOptions.isContinuous=null!=(i=o.colorOptions.isContinuous)&&i;const n=[0,2,1,3,5],s=d.createLayerAdapter(o.layer,n);if(o.layer=s,!s)throw new l("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(n).join(", "));const t=a.isSome(o.signal)?{signal:o.signal}:null;if(yield s.load(t),"above-and-below"===o.theme&&o.symbolOptions){if(o.symbolType.indexOf("3d-volumetric")>-1)throw new l("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==s.geometryType&&"polygon"!==s.geometryType)throw new l("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const r=yield c.getFieldsList({field:o.field,normalizationField:o.normalizationField,valueExpression:o.valueExpression}),u=p.verifyBasicFieldValidity(s,r,"univariate-colorsize-continuous-renderer:invalid-parameters");if(u)throw u;return o}))).apply(this,arguments)}function O(e){const i={...e},l={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete l.sizeOptimizationEnabled,{...i,...l}}function S(e,i){if("type"in e&&"cim"===e.type)v.applyCIMSymbolColor(e,i);else if("type"in e&&e.type.indexOf("3d")>-1){e.symbolLayers.forEach((e=>{"material"in e&&"color"in e.material&&(e.material?e.material.color=i:e.material=new y.default({color:i}))}))}else"color"in e&&(e.color=i)}function x(e,i,l){if((null!=i&&i.symbolStyle||null!=i&&i.symbols)&&("point"===l||"polygon"===l))return i.symbols||m.getAboveAndBelowSymbols(i.symbolStyle);const a=e.classBreakInfos[0].symbol;return{above:a.clone(),below:a.clone()}}function E(e,i,l){var a;const o=l.symbolOptions,s=l.layer,t=null!=o&&o.symbols?"custom":null==o?void 0:o.symbolStyle,r=null==(a=l.colorOptions)?void 0:a.isContinuous;if(T(e,i,r),t||!r){const{stops:l}=i.size.visualVariables[0],{above:a,below:u}=x(e,o,s.geometryType);if(!r){const e=i.color.colorScheme.colors,l=e[0];S(a,e[e.length-1]),S(u,l)}e.classBreakInfos=[new n({minValue:-b,maxValue:l[2].value,symbol:u}),new n({minValue:l[2].value,maxValue:b,symbol:a})],t&&(e.authoringInfo.univariateSymbolStyle=t)}}function T(e,i,l=!0){var a;const o=null==i||null==(a=i.authoringInfo)?void 0:a.clone(),n=i.size.visualVariables.map((e=>e.clone()));l?n.push(i.color.visualVariable.clone()):o.visualVariables=o.visualVariables.filter((e=>"size"===e.type)),n.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=o,e.visualVariables=n}function I(e){const i={...e},l=i.symbolType,a=l.indexOf("3d-volumetric")>-1;delete i.symbolType,delete i.defaultSymbolEnabled;const o=i;return o.worldScale=a,a&&(o.sizeOptions={...o.sizeOptions},o.sizeOptions.axis="3d-volumetric-uniform"===l?"all":"height"),o}function D(e,i,l,a){return q.apply(this,arguments)}function q(){return(q=i._asyncToGenerator((function*(e,i,l,a){const o=i[0],n=i[1],r=Math.round((n-o)/2)+o,u=e.clone();u.stops=[new s({value:l[0],size:n}),new s({value:l[1],size:r}),new s({value:l[2],size:o}),new s({value:l[3],size:r}),new s({value:l[4],size:n})],e.stops=[new s({value:a[0],size:t.getSize(u,a[0])}),new s({value:a[1],size:t.getSize(u,a[1])}),new s({value:a[2],size:t.getSize(u,a[2])}),new s({value:a[3],size:t.getSize(u,a[3])}),new s({value:a[4],size:t.getSize(u,a[4])})]}))).apply(this,arguments)}function B(e,i,l,a){return _.apply(this,arguments)}function _(){return(_=i._asyncToGenerator((function*(e,i,l,a){const o=e.filter((e=>"width-and-depth"!==e.axis&&!e.target))[0],n="number"==typeof(null==o?void 0:o.minSize)?null==o?void 0:o.minSize:null,s="number"==typeof(null==o?void 0:o.maxSize)?null==o?void 0:o.maxSize:null;if(null!=(null==o?void 0:o.minDataValue)&&null!=n&&null!=s)if(a)if("above-and-below"===a){o.minDataValue=null,o.maxDataValue=null,o.minSize=null,o.maxSize=null;const e=p.createStopValuesForAboveBelow(l),a=p.clampAboveAndBelowStopValues(e,l);yield D(o,[n,s],e,a),i.stops.forEach(((e,i)=>e.value=a[i]))}else{const{minDataValue:e,maxDataValue:l}=o,a=p.createDefaultStopValues(e,l,5);i.stops.forEach(((e,i)=>e.value=a[i])),o.minDataValue=a[0],o.maxDataValue=a[a.length-1]}else o.minDataValue=i.stops[0].value,o.maxDataValue=i.stops[i.stops.length-1].value}))).apply(this,arguments)}function A(e,i,l){const{theme:a,minValue:n,maxValue:s}=e,t=i.authoringInfo.visualVariables[0].clone(),r=l.authoringInfo.visualVariables[0].clone();if("above-and-below"===a){const e=i.visualVariable.stops;t.minSliderValue=r.minSliderValue=null!=n?n:e[0].value,t.maxSliderValue=r.maxSliderValue=null!=s?s:e[e.length-1].value,r.theme="above-and-below"}return new o({type:"univariate-color-size",univariateTheme:a,visualVariables:[t,r]})}function C(e){return F.apply(this,arguments)}function F(){return(F=i._asyncToGenerator((function*(e){const i=yield f(e),l=yield r.createVisualVariable(z(i)),{visualVariable:a,statistics:o}=l,n=yield u.createVisualVariables(w(i,o)),s=n.visualVariables;return yield B(s,a,o,i.theme),{basemapId:n.basemapId,basemapTheme:n.basemapTheme,statistics:o,defaultValuesUsed:l.defaultValuesUsed,color:{visualVariable:a,colorScheme:l.colorScheme},size:{visualVariables:s,sizeScheme:n.sizeScheme},authoringInfo:A(i,l,n)}}))).apply(this,arguments)}function L(e){return U.apply(this,arguments)}function U(){return(U=i._asyncToGenerator((function*(e){return G(e)}))).apply(this,arguments)}function G(e){return k.apply(this,arguments)}function k(){return(k=i._asyncToGenerator((function*(e){var i;const l=yield V(e),{renderer:a,statistics:o,defaultValuesUsed:n}=yield u.createContinuousRenderer(O(l)),s=I(l);s.statistics=o;const t=yield C(s);return"above-and-below"===l.theme?E(a,t,l):T(a,t),{renderer:a,statistics:o,defaultValuesUsed:n,color:null!=(i=l.colorOptions)&&i.isContinuous||"above-and-below"!==l.theme?t.color:null,size:t.size,basemapId:t.basemapId,basemapTheme:t.basemapTheme}}))).apply(this,arguments)}e.createContinuousRenderer=L,e.createRenderer=G,e.createVisualVariables=C,Object.defineProperty(e,"__esModule",{value:!0})}));
