/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","../../renderers/support/AuthoringInfo","../../renderers/support/ClassBreakInfo","../../renderers/visualVariables/support/SizeStop","../../renderers/visualVariables/support/visualVariableUtils","./color","./size","./support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/support/aboveAndBelowUtils","../../symbols/support/cimSymbolUtils","../../symbols/support/Symbol3DMaterial"],(function(e,i,a,n,o,s,l,t,r,u,p,c,m,d,y,b,v){"use strict";const f=2**53-1;function h(e){return z.apply(this,arguments)}function z(){return(z=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new a("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new a("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===e.theme&&e.sizeOptions?.sizeOptimizationEnabled)throw new a("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");e.forBinning&&c.verifyBinningParams(e,"univariate-colorsize-visual-variables");const i={...e},o=e.forBinning?d.binningCapableLayerTypes:d.featureCapableLayerTypes,s=d.createLayerAdapter(i.layer,o,e.forBinning);if(i.layer=s,i.theme=i.theme||i.colorOptions?.theme?i.theme:"high-to-low","90-10"===i.theme)throw new a("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");if(!s)throw new a("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(o).join(", "));const l=n.isSome(i.signal)?{signal:i.signal}:null;yield s.load(l);const t=yield m.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),r=p.verifyBasicFieldValidity(s,t,"univariate-colorsize-visual-variables:invalid-parameters");if(r)throw r;return i}))).apply(this,arguments)}function g(e,i){const a={...e},{sizeOptions:n,theme:o}=a,s=a.legendOptions||a.sizeOptions?.legendOptions;return delete a.sizeOptions,delete a.colorOptions,{...a,...n,statistics:i||a.statistics,theme:"above-and-below"===o?null:o,legendOptions:s}}function w(e,i){const a={...e},n=a.colorOptions,o=a.theme||n?.theme,s=a.legendOptions||a.colorOptions?.legendOptions;return delete a.sizeOptions,delete a.colorOptions,{...a,...n,statistics:i||a.statistics,theme:o,legendOptions:s}}function V(e){return S.apply(this,arguments)}function S(){return(S=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new a("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new a("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&c.verifyBinningParams(e,"univariate-colorsize-continuous-renderer");const i={...e};i.symbolType=i.symbolType||"2d",i.colorOptions||(i.colorOptions={}),i.colorOptions.isContinuous=i.colorOptions.isContinuous??!1;const o=e.forBinning?d.binningCapableLayerTypes:d.featureCapableLayerTypes,s=d.createLayerAdapter(i.layer,o,e.forBinning);if(i.layer=s,!s)throw new a("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(o).join(", "));const l=n.isSome(i.signal)?{signal:i.signal}:null;if(yield s.load(l),"above-and-below"===i.theme&&i.symbolOptions){if(i.symbolType.includes("3d-volumetric"))throw new a("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==s.geometryType&&"polygon"!==s.geometryType)throw new a("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const t=yield m.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),r=p.verifyBasicFieldValidity(s,t,"univariate-colorsize-continuous-renderer:invalid-parameters");if(r)throw r;return i}))).apply(this,arguments)}function O(e){const i={...e},a={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete a.sizeOptimizationEnabled,{...i,...a}}function x(e,i){if("type"in e&&"cim"===e.type)b.applyCIMSymbolColor(e,i);else if("type"in e&&e.type.includes("3d")){e.symbolLayers.forEach((e=>{"material"in e&&"color"in e.material&&(e.material?e.material.color=i:e.material=new v.Symbol3DMaterial({color:i}))}))}else"color"in e&&(e.color=i)}function T(e,i,a){if((i?.symbolStyle||i?.symbols)&&("point"===a||"polygon"===a))return i.symbols||y.getAboveAndBelowSymbols(i.symbolStyle);const n=e.classBreakInfos[0].symbol;return{above:n.clone(),below:n.clone()}}function E(e,i,a){const n=a.symbolOptions,o=a.layer,l=n?.symbols?"custom":n?.symbolStyle,t=a.colorOptions?.isContinuous;if(B(e,i,t),l||!t){const{stops:a}=i.size.visualVariables[0],{above:r,below:u}=T(e,n,o.geometryType);if(!t){const e=i.color.colorScheme.colors,a=e[0];x(r,e[e.length-1]),x(u,a)}e.classBreakInfos=[new s({minValue:-f,maxValue:a[2].value,symbol:u}),new s({minValue:a[2].value,maxValue:f,symbol:r})],l&&(e.authoringInfo.univariateSymbolStyle=l)}}function B(e,i,a=!0){const n=i?.authoringInfo?.clone(),o=i.size.visualVariables.map((e=>e.clone()));a?o.push(i.color.visualVariable.clone()):n.visualVariables=n.visualVariables.filter((e=>"size"===e.type)),o.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=n,e.visualVariables=o}function I(e){const i={...e},a=i.symbolType,n=a.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const o=i;return o.worldScale=n,n&&(o.sizeOptions={...o.sizeOptions},o.sizeOptions.axis="3d-volumetric-uniform"===a?"all":"height"),o}function C(e,i,a,n){return L.apply(this,arguments)}function L(){return(L=i._asyncToGenerator((function*(e,i,a,n){const o=i[0],s=i[1],r=Math.round((s-o)/2)+o,u=e.clone();u.stops=[new l({value:a[0],size:s}),new l({value:a[1],size:r}),new l({value:a[2],size:o}),new l({value:a[3],size:r}),new l({value:a[4],size:s})],e.stops=[new l({value:n[0],size:t.getSize(u,n[0])}),new l({value:n[1],size:t.getSize(u,n[1])}),new l({value:n[2],size:t.getSize(u,n[2])}),new l({value:n[3],size:t.getSize(u,n[3])}),new l({value:n[4],size:t.getSize(u,n[4])})]}))).apply(this,arguments)}function D(e,i,a,n){return q.apply(this,arguments)}function q(){return(q=i._asyncToGenerator((function*(e,i,a,n){const o=e.find((e=>"width-and-depth"!==e.axis&&!e.target)),s="number"==typeof o?.minSize?o?.minSize:null,l="number"==typeof o?.maxSize?o?.maxSize:null;if(null!=o?.minDataValue&&null!=s&&null!=l)if(n)if("above-and-below"===n){o.minDataValue=null,o.maxDataValue=null,o.minSize=null,o.maxSize=null;const e=p.createStopValuesForAboveBelow(a),n=p.clampAboveAndBelowStopValues(e,a);yield C(o,[s,l],e,n),i.stops.forEach(((e,i)=>e.value=n[i]))}else{const{minDataValue:e,maxDataValue:a}=o,n=p.createDefaultStopValues(e,a,5);i.stops.forEach(((e,i)=>e.value=n[i])),o.minDataValue=n[0],o.maxDataValue=n[n.length-1]}else o.minDataValue=i.stops[0].value,o.maxDataValue=i.stops[i.stops.length-1].value}))).apply(this,arguments)}function A(e,i,a){const{theme:n,minValue:s,maxValue:l}=e,t=i.authoringInfo.visualVariables[0].clone(),r=a.authoringInfo.visualVariables[0].clone();if("above-and-below"===n){const e=i.visualVariable.stops;t.minSliderValue=r.minSliderValue=s??e[0].value,t.maxSliderValue=r.maxSliderValue=l??e[e.length-1].value,r.theme="above-and-below"}return new o({type:"univariate-color-size",univariateTheme:n,visualVariables:[t,r]})}function F(e){return U.apply(this,arguments)}function U(){return(U=i._asyncToGenerator((function*(e){const i=yield h(e),a=yield r.createVisualVariable(w(i)),{visualVariable:n,statistics:o}=a,s=yield u.createVisualVariables(g(i,o)),l=s.visualVariables;return yield D(l,n,o,i.theme),{basemapId:s.basemapId,basemapTheme:s.basemapTheme,statistics:o,defaultValuesUsed:a.defaultValuesUsed,color:{visualVariable:n,colorScheme:a.colorScheme},size:{visualVariables:l,sizeScheme:s.sizeScheme},authoringInfo:A(i,a,s)}}))).apply(this,arguments)}function _(e){return G.apply(this,arguments)}function G(){return(G=i._asyncToGenerator((function*(e){return M(e)}))).apply(this,arguments)}function M(e){return k.apply(this,arguments)}function k(){return(k=i._asyncToGenerator((function*(e){const i=yield V(e),{renderer:a,statistics:n,defaultValuesUsed:o}=yield u.createContinuousRenderer(O(i)),s=I(i);s.statistics=n;const l=yield F(s);return"above-and-below"===i.theme?E(a,l,i):B(a,l),{renderer:a,statistics:n,defaultValuesUsed:o,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?l.color:null,size:l.size,basemapId:l.basemapId,basemapTheme:l.basemapTheme}}))).apply(this,arguments)}e.createContinuousRenderer=_,e.createRenderer=M,e.createVisualVariables=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
