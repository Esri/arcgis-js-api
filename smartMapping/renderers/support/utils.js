// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../../Color","../../../symbols","../../../core/compilerUtils","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../intl/date","../../../renderers/support/numberUtils","../../../renderers/support/pointCloud/PointSizeSplatAlgorithm","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../support/utils","../../../views/support/colorUtils"],(function(e,t,i,r,n,a,o,l,s,u,c,m,d,f,y,h,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBasemapInfo=t.updateAgeRendererAuthoringInfoVV=t.getPointSizeAlgorithm=t.isValidPointSize=t.getSizeRangeForAxis=t.getSummaryStatistics=t.getClassBreaks=t.verifyBasicFieldValidity=t.createSymbol=t.getSymbolOutlineFromScheme=t.getSymbolSizeFromScheme=t.createStopValues=t.createColors=t.getDefaultDataRange=t.createError=t.formatDate=void 0;var g=/^(\d+(\.\d+)?)\s*(%)$/i,v=[0,0,0,.4],S=["hours","minutes","seconds"],b=[].concat(h.defaultBasemapGroups.light).concat(h.defaultBasemapGroups.dark);function w(e,t){return new o(e,t)}function D(e,t,i){var r,n,a=function(e){var t,i,r=e&&e.statistics;r||(r={});if(null==r.min)if(e.isDate){var n=z();t=n[0],i=n[1]}else t=0,i=100;else if(r.min===r.max)if(e.isDate){var a=z(r.min);t=a[0],i=a[1]}else r.min<0?(t=2*r.min,i=0):r.min>0?(t=0,i=2*r.min):(t=0,i=100);return{min:null!=t?t:r.min,max:null!=i?i:r.max,defaultValuesUsed:null!=t||null!=i}}({statistics:e,isDate:t});return a.defaultValuesUsed?(r=a.min,n=a.max):!i||null!=e.avg&&e.stddev||(r=e.min,n=e.max),null!=r?[r,n]:null}function z(e){var t=("number"==typeof e?new Date(e):new Date).getUTCFullYear(),i=Date.UTC(t,0,1,12,0,0,0),r=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<i&&(i=e),e>r&&(r=e)),[i,r]}t.formatDate=function(e,t,i){if("string"==typeof e){var r=i.getField(e);if(r&&"date"===r.type)return r.alias||r.name}else if("number"==typeof e||e instanceof Date){var n=S.indexOf(t)>-1?"short-date-short-time":"short-date";return u.formatDate(e,u.convertDateFormatToIntlOptions(n))}return e},t.createError=w,t.getDefaultDataRange=D,t.createColors=function(e,t){for(var i=[],n=e.length,a=0;a<t;a++)i.push(new r(e[a%n]));return i},t.createStopValues=function(e,t){void 0===t&&(t=!0);var i=e.avg,r=i-e.stddev,n=i+e.stddev;r<e.min&&(r=e.min),n>e.max&&(n=e.max),t&&(i=r+(n-r)/2);var a=c.round([r,n],{strictBounds:!0});return a=[r=a[0],r+(i-r)/2,i,i+((n=a[1])-i)/2,n],c.round(a,{strictBounds:!0})},t.getSymbolSizeFromScheme=function(e,t,i){switch(t){case"point":case"multipoint":return i?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return i?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;case"mesh":return;default:return void a.neverReached(t)}},t.getSymbolOutlineFromScheme=function(e,t,i){switch(t){case"point":case"multipoint":case"polygon":if(!("outline"in e))return null;var r={color:e.outline.color,width:e.outline.width};if(null!=i&&r.color){var n=r.color.clone();n.a=i,r.color=n}return r;case"polyline":case"mesh":return;default:return void a.neverReached(t)}},t.createSymbol=function(e,t){var i,r=t.type,a=t.size,o=t.color,l=t.outline;switch(e){case"point":case"multipoint":if("2d"===r)i=new n.SimpleMarkerSymbol({color:o,size:a,outline:{color:l.color,width:l.width}});else if("3d-flat"===r)i=new n.PointSymbol3D({symbolLayers:[new n.IconSymbol3DLayer({size:a,resource:{primitive:"circle"},material:{color:o},outline:{color:l.color,size:l.width}})]});else if(r.indexOf("3d-volumetric")>-1){var s="3d-volumetric-uniform"===r,u=s?"sphere":"cylinder",c=new n.ObjectSymbol3DLayer({height:a,resource:{primitive:u},material:{color:o}});s||(c.width=t.widthAndDepth,c.depth=t.widthAndDepth),i=new n.PointSymbol3D({symbolLayers:[c]})}break;case"polyline":"2d"===r?i=new n.SimpleLineSymbol({color:o,width:a}):"3d-flat"===r?i=new n.LineSymbol3D({symbolLayers:[new n.LineSymbol3DLayer({size:a,material:{color:o}})]}):"3d-volumetric"===r&&(i=new n.LineSymbol3D({symbolLayers:[new n.PathSymbol3DLayer({size:a,material:{color:o}})]}));break;case"polygon":"2d"===r?i=new n.SimpleFillSymbol({color:o,outline:{color:l.color,width:l.width}}):"3d-flat"===r?i=new n.PolygonSymbol3D({symbolLayers:[new n.FillSymbol3DLayer({material:{color:o},outline:{color:l.color,size:l.width}})]}):"3d-volumetric"===r&&(i=new n.PolygonSymbol3D({symbolLayers:[new n.ExtrudeSymbol3DLayer({size:a,material:{color:o}})]}));break;case"mesh":var m=t.meshInfo&&t.meshInfo.colorMixMode,d=t.meshInfo&&t.meshInfo.edgesType;i=new n.MeshSymbol3D({symbolLayers:[new n.FillSymbol3DLayer({material:{color:o,colorMixMode:m},edges:null==d||"none"===d?null:{type:d,color:v}})]})}return i},t.verifyBasicFieldValidity=function(e,t,i){var r=function(e){var t=e.layer;return e.fields.filter((function(e){return!t.getField(e)}))}({layer:e,fields:t});if(r.length)return w(i,"Unknown fields: "+r.join(", ")+". You can only use fields defined in the layer schema");var n=function(e){var t=e.layer;return e.fields.filter((function(e){var i=t.getFieldUsageInfo(e);return!i||!i.supportsRenderer}))}({layer:e,fields:t});return n.length?w(i,"Unsupported fields: "+n.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0},t.getClassBreaks=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,n,a,o,l,u;return i.__generator(this,(function(c){switch(c.label){case 0:return r={layer:e.layer,view:e.view,signal:e.signal},[4,s.all([f(e),t?d(r):null])];case 1:return n=c.sent(),a=n[0],o=n[1],(l=D({min:a.minValue,max:a.maxValue,avg:null,stddev:null},!1,!1))?[4,f(i.__assign(i.__assign({},e),{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:l[0],maxValue:l[1],normalizationTotal:l[0]+l[1]}))]:[3,3];case 2:return u=c.sent(),[3,4];case 3:u=a,c.label=4;case 4:return[2,{result:u,defaultValuesUsed:!!l,outlineResult:o}]}}))}))},t.getSummaryStatistics=function(e){return y(e)},t.getSizeRangeForAxis=function(e,t){var i=e.minSize,r=e.maxSize;if("height"===t){i=((r-i)/2+i)/4.6,r*=2}return{minSize:i,maxSize:r}},t.isValidPointSize=function(e){return g.test(e)},t.getPointSizeAlgorithm=function(e){var t=e.match(g),i=Number(t[1]);if("%"===t[3])return new m.default({scaleFactor:i/100})},t.updateAgeRendererAuthoringInfoVV=function(e,t,i,r){e.startTime=t instanceof Date?t.getTime():t,e.endTime=i instanceof Date?i.getTime():i,e.units=r,e.field="string"==typeof t?t:"string"==typeof i?i:null},t.getBasemapInfo=function(e,t){return i.__awaiter(this,void 0,void 0,(function(){var r,n,a;return i.__generator(this,(function(i){switch(i.label){case 0:return r=null,n=null,e||t?(!e&&t&&(e=t&&t.get("map.basemap")),e&&(r=h.getBasemapId(e,b,!1))&&(a=h.getBasemapGroup(r),l.isSome(a)&&(n=a)),r||!t?[3,2]:[4,p.getBackgroundColorTheme(t)]):[2,{basemapId:r,basemapTheme:n}];case 1:n=i.sent(),l.isSome(n)&&(r="dark"===n?"dark-gray":"gray"),i.label=2;case 2:return[2,{basemapId:r,basemapTheme:n}]}}))}))}}));