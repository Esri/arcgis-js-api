/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/maybe","../../core/Error","../../core/promiseUtils","../../intl/messages","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/AuthoringInfo","../../renderers/visualVariables/OpacityVariable","../../renderers/support/numberUtils","../statistics/support/predominanceUtils","../support/adapters/support/layerUtils","../statistics/summaryStatistics","../heuristics/outline","./support/utils","./size","./type","../statistics/predominantCategories","../../chunks/predominance"],(function(e,a,i,n,s,l,r,o,t,p,m,d,u,c,y,b,g,f){"use strict";e.createRenderer=async function(e){const h=await async function(e){if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new i("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new i("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new i("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");const n={...e};n.symbolType=n.symbolType||"2d",n.defaultSymbolEnabled=null==n.defaultSymbolEnabled||n.defaultSymbolEnabled,n.includeOpacityVariable=e.includeOpacityVariable||!1,n.includeSizeVariable=e.includeSizeVariable||!1,n.sortBy=null==n.sortBy?"count":n.sortBy;const s=[0,2,1,3],l=m.createLayerAdapter(n.layer,s);if(n.layer=l,!l)throw new i("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(s).join(", "));const r=a.isSome(n.signal)?{signal:n.signal}:null;await l.load(r);const o=l.geometryType,t=n.symbolType.indexOf("3d")>-1;if(n.outlineOptimizationEnabled="polygon"===o&&n.outlineOptimizationEnabled,n.includeSizeVariable||(n.sizeOptimizationEnabled=("point"===o||"multipoint"===o||"polyline"===o)&&n.sizeOptimizationEnabled),"mesh"===o)n.symbolType="3d-volumetric",n.colorMixMode=n.colorMixMode||"replace",n.edgesType=n.edgesType||"none",n.sizeOptimizationEnabled=!1;else{if(t&&("polyline"===o||"polygon"===o))throw new i("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(n.symbolType.indexOf("3d-volumetric")>-1&&(!n.view||"3d"!==n.view.type))throw new i("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const p=n.fields.map((e=>e.name)),d=c.verifyBasicFieldValidity(l,p,"predominance-renderer:invalid-parameters");if(d)throw d;return n}(e),v=h.layer,w=(await async function(e){let i=e.predominanceScheme,n=null,s=null;const l=await c.getBasemapInfo(e.basemap,e.view);if(n=a.isSome(l.basemapId)?l.basemapId:null,s=a.isSome(l.basemapTheme)?l.basemapTheme:null,i)return{scheme:f.cloneScheme(i),basemapId:n,basemapTheme:s};const r=f.getSchemes({basemap:n,basemapTheme:s,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view});return r&&(i=r.primaryScheme,n=r.basemapId,s=r.basemapTheme),{scheme:i,basemapId:n,basemapTheme:s}}({basemap:h.basemap,geometryType:v.geometryType,numColors:h.fields.length,predominanceScheme:h.predominanceScheme,worldScale:h.symbolType.indexOf("3d-volumetric")>-1,view:h.view})).scheme,S=h.fields.map((e=>e.name)),V=p.getPredominanceExpressions(v,S),z=async function(e,a,i,l){const o=await s.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),t=e.layer,p={layer:e.layer,view:e.view,signal:e.signal},[m,d]=await n.all([g({layer:t,fields:l,view:e.view,signal:e.signal}),e.outlineOptimizationEnabled?u(p):null]);let y=m;m&&m.predominantCategoryInfos||(y={predominantCategoryInfos:l.map((e=>({value:e,count:0})))});const f=d&&d.opacity,h=await b.createRenderer({layer:t,basemap:e.basemap,valueExpression:a.valueExpression,valueExpressionTitle:o.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:i,statistics:{uniqueValueInfos:y.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:e.signal}),{renderer:v,basemapId:w,basemapTheme:S,uniqueValueInfos:V,excludedUniqueValueInfos:z}=h,T=v.uniqueValueInfos,E={};for(const a of e.fields){const e=t.getField(a.name);E[e.name]=a.label||e&&e.alias||a.name}if(T.forEach(((e,a)=>{const i=E[e.value];e.label=i,V[a].label=i})),e.includeSizeVariable){let a=t.geometryType,n=null;if("polygon"===a){const s=i.sizeScheme,l=s.background;v.backgroundFillSymbol=c.createSymbol(a,{type:e.symbolType,color:l.color,outline:c.getSymbolOutlineFromScheme(l,a,f)}),n=s.marker.size,a="point"}else n="polyline"===a?i.width:i.size;const s=c.createColors(i.colors,T.length);T.forEach(((l,r)=>{const o=c.createSymbol(a,{type:e.symbolType,color:s[r],size:n,outline:c.getSymbolOutlineFromScheme(i,a,f),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});l.symbol=o,V[r].symbol=o.clone()}))}return d&&d.visualVariables&&d.visualVariables.length&&(v.visualVariables=d.visualVariables.map((e=>e.clone()))),v.authoringInfo=new r({type:"predominance",fields:[...l]}),{renderer:v,predominantCategoryInfos:V,excludedCategoryInfos:z,predominanceScheme:i,basemapId:w,basemapTheme:S}}(h,V.predominantCategory,w,S),T=h.includeSizeVariable?async function(e,a,i){const n=await s.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return y.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:i,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:n.sumOfCategories},view:e.view,signal:e.signal})}(h,V.size,w.sizeScheme):null,E=h.includeOpacityVariable?async function(e,a){const i=await s.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),n=await d({layer:e.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,view:e.view,signal:e.signal}),p=null==n.avg||null==n.stddev,m=1/e.fields.length*100;let u=p?100:n.avg+1.285*n.stddev;u>100&&(u=100);const c=t.round([m,u],{strictBounds:!0}),y=new o({valueExpression:a.valueExpression,stops:[{value:c[0],opacity:.15},{value:c[1],opacity:1}],legendOptions:{title:i.strengthOfPredominance}}),b=new l({type:"opacity",minSliderValue:n.min,maxSliderValue:n.max});return{visualVariable:y,statistics:n,defaultValuesUsed:p,authoringInfo:new r({visualVariables:[b]})}}(h,V.opacity):null,[x,O,I]=await n.all([z,T,E]),M=[],q=[];if(O&&(Array.prototype.push.apply(M,O.visualVariables.map((e=>e.clone()))),delete O.sizeScheme,x.size=O,Array.prototype.push.apply(q,O.authoringInfo.visualVariables.map((e=>e.clone())))),I&&(M.push(I.visualVariable.clone()),x.opacity=I,Array.prototype.push.apply(q,I.authoringInfo.visualVariables.map((e=>e.clone())))),M.length){const e=x.renderer.visualVariables||[];Array.prototype.push.apply(e,M),x.renderer.visualVariables=e,x.renderer.authoringInfo.visualVariables=q}return x},Object.defineProperty(e,"__esModule",{value:!0})}));
