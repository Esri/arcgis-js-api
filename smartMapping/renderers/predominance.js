/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/Error","../../core/maybe","../../intl/messages","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/numberUtils","../../renderers/visualVariables/OpacityVariable","../heuristics/outline","./size","./type","./support/utils","../statistics/predominantCategories","../statistics/summaryStatistics","../statistics/support/predominanceUtils","../support/adapters/support/layerUtils","../../chunks/predominance"],(function(e,a,i,n,r,l,s,t,o,p,u,m,d,y,c,b,f,h){"use strict";function g(e){return v.apply(this,arguments)}function v(){return(v=a._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new i("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new i("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new i("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");const a={...e};a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled=null==a.defaultSymbolEnabled||a.defaultSymbolEnabled,a.includeOpacityVariable=e.includeOpacityVariable||!1,a.includeSizeVariable=e.includeSizeVariable||!1,a.sortBy=null==a.sortBy?"count":a.sortBy;const r=f.createLayerAdapter(a.layer,f.featureCapableLayerTypes);if(a.layer=r,!r)throw new i("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(f.featureCapableLayerTypes).join(", "));const l=n.isSome(a.signal)?{signal:a.signal}:null;yield r.load(l);const s=r.geometryType,t=a.symbolType.indexOf("3d")>-1;if(a.outlineOptimizationEnabled="polygon"===s&&a.outlineOptimizationEnabled,a.includeSizeVariable||(a.sizeOptimizationEnabled=("point"===s||"multipoint"===s||"polyline"===s)&&a.sizeOptimizationEnabled),"mesh"===s)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none",a.sizeOptimizationEnabled=!1;else{if(t&&("polyline"===s||"polygon"===s))throw new i("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(a.symbolType.indexOf("3d-volumetric")>-1&&(!a.view||"3d"!==a.view.type))throw new i("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const o=a.fields.map((e=>e.name)),p=d.verifyBasicFieldValidity(r,o,"predominance-renderer:invalid-parameters");if(p)throw p;return a}))).apply(this,arguments)}function w(e){return T.apply(this,arguments)}function T(){return(T=a._asyncToGenerator((function*(e){let a=e.predominanceScheme,i=null,r=null;const l=yield d.getBasemapInfo(e.basemap,e.view);if(i=n.isSome(l.basemapId)?l.basemapId:null,r=n.isSome(l.basemapTheme)?l.basemapTheme:null,a)return{scheme:h.cloneScheme(a),basemapId:i,basemapTheme:r};const s=h.getSchemes({basemap:i,basemapTheme:r,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view});return s&&(a=s.primaryScheme,i=s.basemapId,r=s.basemapTheme),{scheme:a,basemapId:i,basemapTheme:r}}))).apply(this,arguments)}function S(e,a,i,n){return V.apply(this,arguments)}function V(){return(V=a._asyncToGenerator((function*(e,a,i,n){const s=yield r.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),t=e.layer,o={layer:e.layer,view:e.view,signal:e.signal},[u,c]=yield Promise.all([y({layer:t,fields:n,view:e.view,signal:e.signal}),e.outlineOptimizationEnabled?p(o):null]);let b=u;u&&u.predominantCategoryInfos||(b={predominantCategoryInfos:n.map((e=>({value:e,count:0})))});const f=c&&c.opacity,h=yield m.createRenderer({layer:t,basemap:e.basemap,valueExpression:a.valueExpression,valueExpressionTitle:s.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:i,statistics:{uniqueValueInfos:b.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:e.signal}),{renderer:g,basemapId:v,basemapTheme:w,uniqueValueInfos:T,excludedUniqueValueInfos:S}=h,V=g.uniqueValueInfos,z={};for(const r of e.fields){const e=t.getField(r.name);z[e.name]=r.label||e&&e.alias||r.name}if(V.forEach(((e,a)=>{const i=z[e.value];e.label=i,T[a].label=i})),e.includeSizeVariable){let a=t.geometryType,n=null;if("polygon"===a){const r=i.sizeScheme,l=r.background;g.backgroundFillSymbol=d.createSymbol(a,{type:e.symbolType,color:l.color,outline:d.getSymbolOutlineFromScheme(l,a,f)}),n=r.marker.size,a="point"}else if("polyline"===a){n=i.width}else{n=i.size}const r=d.createColors(i.colors,V.length);V.forEach(((l,s)=>{const t=d.createSymbol(a,{type:e.symbolType,color:r[s],size:n,outline:d.getSymbolOutlineFromScheme(i,a,f),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});l.symbol=t,T[s].symbol=t.clone()}))}return c&&c.visualVariables&&c.visualVariables.length&&(g.visualVariables=c.visualVariables.map((e=>e.clone()))),g.authoringInfo=new l({type:"predominance",fields:[...n]}),{renderer:g,predominantCategoryInfos:T,excludedCategoryInfos:S,predominanceScheme:i,basemapId:v,basemapTheme:w}}))).apply(this,arguments)}function z(e,a,i){return E.apply(this,arguments)}function E(){return(E=a._asyncToGenerator((function*(e,a,i){const n=yield r.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return u.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:i,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:n.sumOfCategories},view:e.view,signal:e.signal})}))).apply(this,arguments)}function x(e,a){return O.apply(this,arguments)}function O(){return(O=a._asyncToGenerator((function*(e,a){const i=yield r.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),n=yield c({layer:e.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,view:e.view,signal:e.signal}),p=null==n.avg||null==n.stddev,u=1/e.fields.length*100;let m=p?100:n.avg+1.285*n.stddev;m>100&&(m=100);const d=t.round([u,m],{strictBounds:!0}),y=new o({valueExpression:a.valueExpression,stops:[{value:d[0],opacity:.15},{value:d[1],opacity:1}],legendOptions:{title:i.strengthOfPredominance}}),b=new s({type:"opacity",minSliderValue:n.min,maxSliderValue:n.max});return{visualVariable:y,statistics:n,defaultValuesUsed:p,authoringInfo:new l({visualVariables:[b]})}}))).apply(this,arguments)}function I(e){return M.apply(this,arguments)}function M(){return(M=a._asyncToGenerator((function*(e){const a=yield g(e),i=a.layer,n=(yield w({basemap:a.basemap,geometryType:i.geometryType,numColors:a.fields.length,predominanceScheme:a.predominanceScheme,worldScale:a.symbolType.indexOf("3d-volumetric")>-1,view:a.view})).scheme,r=a.fields.map((e=>e.name)),l=b.getPredominanceExpressions(i,r),s=S(a,l.predominantCategory,n,r),t=a.includeSizeVariable?z(a,l.size,n.sizeScheme):null,o=a.includeOpacityVariable?x(a,l.opacity):null,[p,u,m]=yield Promise.all([s,t,o]),d=[],y=[];if(u&&(Array.prototype.push.apply(d,u.visualVariables.map((e=>e.clone()))),delete u.sizeScheme,p.size=u,Array.prototype.push.apply(y,u.authoringInfo.visualVariables.map((e=>e.clone())))),m&&(d.push(m.visualVariable.clone()),p.opacity=m,Array.prototype.push.apply(y,m.authoringInfo.visualVariables.map((e=>e.clone())))),d.length){const e=p.renderer.visualVariables||[];Array.prototype.push.apply(e,d),p.renderer.visualVariables=e,p.renderer.authoringInfo.visualVariables=y}return p}))).apply(this,arguments)}e.createRenderer=I,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
