// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Error","../../core/maybe","../../core/promiseUtils","../../intl/messages","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/numberUtils","../../renderers/visualVariables/OpacityVariable","../heuristics/outline","./size","./type","./support/utils","../statistics/predominantCategories","../statistics/summaryStatistics","../statistics/support/predominanceUtils","../support/adapters/support/layerUtils","../symbology/predominance"],(function(e,a,i,r,n,s,t,l,o,p,u,d,m,c,y,b,f,g,h,v){"use strict";function w(e){return i.__awaiter(this,void 0,void 0,(function(){var a,s,t,l,o,p,u,d;return i.__generator(this,(function(m){switch(m.label){case 0:if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new r("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new r("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new r("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");if((a=i.__assign({},e)).symbolType=a.symbolType||"2d",a.defaultSymbolEnabled=null==a.defaultSymbolEnabled||a.defaultSymbolEnabled,a.includeOpacityVariable=e.includeOpacityVariable||!1,a.includeSizeVariable=e.includeSizeVariable||!1,a.sortBy=null==a.sortBy?"count":a.sortBy,s=[0,2,1,3],t=h.createLayerAdapter(a.layer,s),a.layer=t,!t)throw new r("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+h.getLayerTypeLabels(s).join(", "));return l=n.isSome(a.signal)?{signal:a.signal}:null,[4,t.load(l)];case 1:if(m.sent(),o=t.geometryType,p=a.symbolType.indexOf("3d")>-1,a.outlineOptimizationEnabled="polygon"===o&&a.outlineOptimizationEnabled,a.includeSizeVariable||(a.sizeOptimizationEnabled=("point"===o||"multipoint"===o||"polyline"===o)&&a.sizeOptimizationEnabled),"mesh"===o)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none",a.sizeOptimizationEnabled=!1;else{if(p&&("polyline"===o||"polygon"===o))throw new r("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(a.symbolType.indexOf("3d-volumetric")>-1&&(!a.view||"3d"!==a.view.type))throw new r("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(u=a.fields.map((function(e){return e.name})),d=y.verifyBasicFieldValidity(t,u,"predominance-renderer:invalid-parameters"))throw d;return[2,a]}}))}))}function S(e){return i.__awaiter(this,void 0,void 0,(function(){var a,r,s,t,l;return i.__generator(this,(function(i){switch(i.label){case 0:return a=e.predominanceScheme,r=null,s=null,[4,y.getBasemapInfo(e.basemap,e.view)];case 1:return t=i.sent(),r=n.isSome(t.basemapId)?t.basemapId:null,s=n.isSome(t.basemapTheme)?t.basemapTheme:null,a?[2,{scheme:v.cloneScheme(a),basemapId:r,basemapTheme:s}]:((l=v.getSchemes({basemap:r,basemapTheme:s,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view}))&&(a=l.primaryScheme,r=l.basemapId,s=l.basemapTheme),[2,{scheme:a,basemapId:r,basemapTheme:s}])}}))}))}Object.defineProperty(a,"__esModule",{value:!0}),a.createRenderer=void 0,a.createRenderer=function(e){return i.__awaiter(this,void 0,void 0,(function(){var a,r,n,h,v,V,z,T,E,x,_,O,I,M,q,C;return i.__generator(this,(function(B){switch(B.label){case 0:return[4,w(e)];case 1:return a=B.sent(),r=a.layer,[4,S({basemap:a.basemap,geometryType:r.geometryType,numColors:a.fields.length,predominanceScheme:a.predominanceScheme,worldScale:a.symbolType.indexOf("3d-volumetric")>-1,view:a.view})];case 2:return n=B.sent(),h=n.scheme,v=a.fields.map((function(e){return e.name})),V=g.getPredominanceExpressions(r,v),z=function(e,a,r,n){return i.__awaiter(this,void 0,void 0,(function(){var o,p,u,m,f,g,h,v,w,S,V,z,T,E,x,_,O,I,M,q,C,B,A,U,F;return i.__generator(this,(function(Q){switch(Q.label){case 0:return[4,t.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return o=Q.sent(),p=e.layer,u={layer:e.layer,view:e.view,signal:e.signal},[4,s.all([b({layer:p,fields:n,view:e.view,signal:e.signal}),e.outlineOptimizationEnabled?d(u):null])];case 2:return m=Q.sent(),f=m[0],g=m[1],h=f,f&&f.predominantCategoryInfos||(h={predominantCategoryInfos:n.map((function(e){return{value:e,count:0}}))}),v=g&&g.opacity,[4,c.createRenderer({layer:p,basemap:e.basemap,valueExpression:a.valueExpression,valueExpressionTitle:o.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:r,statistics:{uniqueValueInfos:h.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:e.signal})];case 3:for(w=Q.sent(),S=w.renderer,V=w.basemapId,z=w.basemapTheme,T=w.uniqueValueInfos,E=w.excludedUniqueValueInfos,x=S.uniqueValueInfos,_={},O=0,I=e.fields;O<I.length;O++)M=I[O],q=p.getField(M.name),_[q.name]=M.label||q&&q.alias||M.name;return x.forEach((function(e,a){var i=_[e.value];e.label=i,T[a].label=i})),e.includeSizeVariable&&(C=p.geometryType,B=null,"polygon"===C?(A=r.sizeScheme,U=A.background,S.backgroundFillSymbol=y.createSymbol(C,{type:e.symbolType,color:U.color,outline:y.getSymbolOutlineFromScheme(U,C,v)}),B=A.marker.size,C="point"):B="polyline"===C?r.width:r.size,F=y.createColors(r.colors,x.length),x.forEach((function(a,i){var n=y.createSymbol(C,{type:e.symbolType,color:F[i],size:B,outline:y.getSymbolOutlineFromScheme(r,C,v),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});a.symbol=n,T[i].symbol=n.clone()}))),g&&g.visualVariables&&g.visualVariables.length&&(S.visualVariables=g.visualVariables.map((function(e){return e.clone()}))),S.authoringInfo=new l({type:"predominance",fields:i.__spreadArrays(n)}),[2,{renderer:S,predominantCategoryInfos:T,excludedCategoryInfos:E,predominanceScheme:r,basemapId:V,basemapTheme:z}]}}))}))}(a,V.predominantCategory,h,v),T=a.includeSizeVariable?function(e,a,r){return i.__awaiter(this,void 0,void 0,(function(){var n;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,t.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return n=i.sent(),[2,m.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:r,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:n.sumOfCategories},view:e.view,signal:e.signal})]}}))}))}(a,V.size,h.sizeScheme):null,E=a.includeOpacityVariable?function(e,a){return i.__awaiter(this,void 0,void 0,(function(){var r,n,s,d,m,c,y,b,g;return i.__generator(this,(function(i){switch(i.label){case 0:return[4,t.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return r=i.sent(),[4,f({layer:e.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,view:e.view,signal:e.signal})];case 2:return n=i.sent(),s=null==n.avg||null==n.stddev,d=1/e.fields.length*100,(m=s?100:n.avg+1.285*n.stddev)>100&&(m=100),c=p.round([d,m],{strictBounds:!0}),y=new u({valueExpression:a.valueExpression,stops:[{value:c[0],opacity:.15},{value:c[1],opacity:1}],legendOptions:{title:r.strengthOfPredominance}}),b=new o({type:"opacity",minSliderValue:n.min,maxSliderValue:n.max}),g=new l({visualVariables:[b]}),[2,{visualVariable:y,statistics:n,defaultValuesUsed:s,authoringInfo:g}]}}))}))}(a,V.opacity):null,[4,s.all([z,T,E])];case 3:return x=B.sent(),_=x[0],O=x[1],I=x[2],M=[],q=[],O&&(Array.prototype.push.apply(M,O.visualVariables.map((function(e){return e.clone()}))),delete O.sizeScheme,_.size=O,Array.prototype.push.apply(q,O.authoringInfo.visualVariables.map((function(e){return e.clone()})))),I&&(M.push(I.visualVariable.clone()),_.opacity=I,Array.prototype.push.apply(q,I.authoringInfo.visualVariables.map((function(e){return e.clone()})))),M.length&&(C=_.renderer.visualVariables||[],Array.prototype.push.apply(C,M),_.renderer.visualVariables=C,_.renderer.authoringInfo.visualVariables=q),[2,_]}}))}))}}));