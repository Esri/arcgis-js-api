/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../renderers/PointCloudClassBreaksRenderer","../../renderers/PointCloudRenderer","../../renderers/PointCloudRGBRenderer","../../renderers/PointCloudStretchRenderer","../../renderers/PointCloudUniqueValueRenderer","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Error","../../core/maybe","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/utils","../../renderers/visualVariables/ColorVariable","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/utils","../support/adapters/support/layerUtils","../../chunks/color"],(function(e,r,i,o,l,a,n,t,s,u,d,c,m,p,y,f,h,b,g,v,T,w,S,x,E,V,z,M,I,C,O){"use strict";const F="date",L="high-to-low",P=2**53-1,q=5;function B(e){return R.apply(this,arguments)}function R(){return(R=r._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new f("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new f("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");const r={...e};if("90-10"===r.theme)throw new f("color-visual-variable:not-supported","Only 'high-to-low', 'above-and-below', 'centered-on', 'extremes', 'above', 'below' themes are supported.");const i=[0,2,1,3,5],o=C.createLayerAdapter(r.layer,i);if(r.layer=o,!o)throw new f("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(i).join(", "));const l=h.isSome(r.signal)?{signal:r.signal}:null;yield o.load(l);if("mesh"!==o.geometryType&&r.worldScale&&(!r.view||"3d"!==r.view.type))return Promise.reject(z.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"));const a=yield I.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),n=z.verifyBasicFieldValidity(o,a,"color-visual-variable:invalid-parameters");if(n)throw n;return r}))).apply(this,arguments)}function k(e){return U.apply(this,arguments)}function U(){return(U=r._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new f("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new f("color-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const r={...e};r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled;const i=[0,2,1,3,5],o=C.createLayerAdapter(r.layer,i);if(r.layer=o,!o)throw new f("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(i).join(", "));const l=h.isSome(r.signal)?{signal:r.signal}:null;yield o.load(l);const a=o.geometryType;if(r.outlineOptimizationEnabled="polygon"===a&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===a||"multipoint"===a||"polyline"===a)&&r.sizeOptimizationEnabled,"mesh"===a)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==a)throw new f("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new f("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const n=yield I.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),t=z.verifyBasicFieldValidity(o,n,"color-continuous-renderer:invalid-parameters");if(t)throw t;return r}))).apply(this,arguments)}function A(e){return D.apply(this,arguments)}function D(){return(D=r._asyncToGenerator((function*(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new f("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new f("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");const r={...e};r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.classificationMethod=r.classificationMethod||"equal-interval",r.normalizationType=I.getNormalizationType(r);const i=[0,2,1,3,5],o=C.createLayerAdapter(r.layer,i);if(r.layer=o,!o)throw new f("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(i).join(", "));if(!(null!=r.minValue&&null!=r.maxValue)&&(null!=r.minValue||null!=r.maxValue))throw new f("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const l=h.isSome(r.signal)?{signal:r.signal}:null;yield o.load(l);const a=o.geometryType;if(r.outlineOptimizationEnabled="polygon"===a&&r.outlineOptimizationEnabled,"mesh"===a)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==a)throw new f("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new f("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const n=yield I.getFieldsList({field:r.field,normalizationField:r.normalizationField}),t=z.verifyBasicFieldValidity(o,n,"color-class-breaks-renderer:invalid-parameters");if(t)throw t;return r}))).apply(this,arguments)}function _(e){const r={...e};delete r.basemap,delete r.colorScheme,delete r.legendOptions,delete r.symbolType,delete r.defaultSymbolEnabled,delete r.colorMixMode,delete r.edgesType;const i=r;return i.analyzeData=!(null!=r.minValue&&null!=r.maxValue),i}function j(e){if(!e||!e.layer)return Promise.reject(z.createError("color-point-cloud-true-color-renderer:missing-parameters","'layer' parameter is required"));const r={...e},i=[4],o=C.createLayerAdapter(r.layer,i);if(r.layer=o,r.density=r.density||25,r.size=r.size||"100%",!z.isValidPointSize(r.size))return Promise.reject(z.createError("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"));if(!o)return Promise.reject(z.createError("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(i).join(", ")));const l=h.isSome(r.signal)?{signal:r.signal}:null;return o.load(l).then((()=>r))}function G(e){if(!(e&&e.layer&&e.field))return Promise.reject(z.createError("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required"));const r=e.field.toLowerCase();if("intensity"!==r&&"elevation"!==r)return Promise.reject(z.createError("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'"));const i={...e},o=[4],l=C.createLayerAdapter(i.layer,o);if(i.layer=l,i.density=i.density||25,i.size=i.size||"100%",!z.isValidPointSize(i.size))return Promise.reject(z.createError("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"));if(!l)return Promise.reject(z.createError("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(o).join(", ")));const a=h.isSome(i.signal)?{signal:i.signal}:null;return l.load(a).then((()=>i))}function H(e){const r={...e},i=r.symbolType.indexOf("3d-volumetric")>-1;delete r.symbolType,delete r.defaultSymbolEnabled,delete r.colorMixMode,delete r.edgesType;const o=r;return o.worldScale=i,o}function W(e){return $.apply(this,arguments)}function $(){return($=r._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new f("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");const r={...e};r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled;const i=[0,2,1,3,5],o=C.createLayerAdapter(r.layer,i);if(r.layer=o,!o)throw new f("color-age-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(i).join(", "));const l=h.isSome(r.signal)?{signal:r.signal}:null;yield o.load(l);const a=o.geometryType;if(r.outlineOptimizationEnabled="polygon"===a&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===a||"multipoint"===a||"polyline"===a)&&r.sizeOptimizationEnabled,"mesh"===a)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else if("3d-volumetric-uniform"===r.symbolType&&"point"!==a)throw new f("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new f("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");const n=M.verifyDates(o,r.startTime,r.endTime,"color-age-renderer:invalid-parameters");if(n)throw n;if(r.unit&&-1===M.supportedAgeUnits.indexOf(r.unit))throw new f("color-age-renderer:invalid-unit",`Supported units are: ${M.supportedAgeUnits.join(", ")}`);return r}))).apply(this,arguments)}function N(e,r){return J.apply(this,arguments)}function J(){return(J=r._asyncToGenerator((function*(e,r){let i=e.colorScheme,o=null,l=null;const a=yield z.getBasemapInfo(e.basemap,e.view);if(o=h.isSome(a.basemapId)?a.basemapId:null,l=h.isSome(a.basemapTheme)?a.basemapTheme:null,i)return{scheme:O.cloneScheme(i),basemapId:o,basemapTheme:l};const n=r||e.theme||L,t=O.getSchemes({theme:n,basemap:o,basemapTheme:l,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});if(t)if(o=t.basemapId,l=t.basemapTheme,e.schemeId){const r=n+"/"+o+"/"+e.schemeId;i=O.getSchemeById({id:r,geometryType:e.geometryType})}else i=t.primaryScheme;return{scheme:i,basemapId:o,basemapTheme:l}}))).apply(this,arguments)}function K(e,r){return Q.apply(this,arguments)}function Q(){return(Q=r._asyncToGenerator((function*(e,r){const i=r.layer,o=yield N({basemap:r.basemap,colorScheme:r.colorScheme,geometryType:i.geometryType,schemeId:"elevation"===r.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"}),l=o.scheme;if(!l)throw z.createError("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme");const a=z.createColors(l.colors,q);if(a.length<q)throw z.createError("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors");const n=z.getDefaultDataRange(e,!1,!0),t=n?z.createDefaultStopValues(n[0],n[1],5):z.createStopValues(e);return{stops:w.createColorStops({values:t,isDate:!1,dateFormatOptions:null,colors:a,labelIndexes:[0,2,4]}),basemapId:o.basemapId,basemapTheme:o.basemapTheme,statistics:e,defaultValuesUsed:!!n,colorScheme:O.cloneScheme(l)}}))).apply(this,arguments)}function X(e,r,i){return Y.apply(this,arguments)}function Y(){return(Y=r._asyncToGenerator((function*(e,r,i){const o=e.layer,{field:l,theme:a}=e,n=l&&!("function"==typeof l)?o.getField(l):null,t=n&&n.type===F,s=yield N({basemap:e.basemap,theme:e.theme,geometryType:o.geometryType,colorScheme:e.colorScheme,worldScale:e.worldScale,view:e.view}),u=s.scheme;if(!u)throw z.createError("color-visual-variable:insufficient-info","Unable to find color scheme");const d=z.createColors(u.colors,q);if(d.length<q)throw z.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors");const c=u.id.indexOf("seq-")>-1,m=z.getDataRange(r,i,a,t,"90-10"!==a),p=z.createDataValues(m,r,a,c),y=z.createColors(d,q),f=new S({field:l,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationField:e.normalizationField,stops:p.map(((e,r)=>({value:e,color:y[r]}))),legendOptions:e.legendOptions}),h=new T({type:"color",minSliderValue:null!=e.minValue?e.minValue:r.min,maxSliderValue:null!=e.maxValue?e.maxValue:r.max,theme:u.theme}),b=new v({visualVariables:[h]});return{basemapId:s.basemapId,basemapTheme:s.basemapTheme,visualVariable:f,statistics:r,defaultValuesUsed:m.defaultValuesUsed,colorScheme:O.cloneScheme(u),authoringInfo:b}}))).apply(this,arguments)}function Z(e,r,i,o,l,a){return ee.apply(this,arguments)}function ee(){return(ee=r._asyncToGenerator((function*(e,r,i,o,l,a){const n=yield b.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),s=a.layer,u=a.field,d=s.geometryType,c=a.defaultSymbolEnabled,m=O.cloneScheme(e.colorScheme),p=r&&r.opacity,y=[e.visualVariable.clone()];r&&r.visualVariables&&r.visualVariables.length&&y.push(...r.visualVariables.map((e=>e.clone()))),i&&i.minSize&&y.push(i.minSize);return{renderer:new t({classBreakInfos:[{minValue:-P,maxValue:P,symbol:z.createSymbol(d,{type:a.symbolType,color:m.noDataColor,size:z.getSymbolSizeFromScheme(m,d),outline:z.getSymbolOutlineFromScheme(m,d,p),meshInfo:{colorMixMode:a.colorMixMode,edgesType:a.edgesType}})}],defaultLabel:c?n.other:null,defaultSymbol:c?z.createSymbol(d,{type:a.symbolType,color:m.noDataColor,size:z.getSymbolSizeFromScheme(m,d),outline:z.getSymbolOutlineFromScheme(m,d,p),meshInfo:{colorMixMode:a.colorMixMode,edgesType:a.edgesType}}):null,field:u,normalizationType:o,normalizationField:l,valueExpression:a.valueExpression,valueExpressionTitle:a.valueExpressionTitle,visualVariables:y,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariable:e.visualVariable.clone(),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:O.cloneScheme(e.colorScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}}))).apply(this,arguments)}function re(e){return ie.apply(this,arguments)}function ie(){return(ie=r._asyncToGenerator((function*(e){const r=yield B(e),{view:i,field:o,valueExpression:l,minValue:a,maxValue:n,layer:t,normalizationField:s,signal:u,statistics:d}=r,c=s?"field":void 0,[m,p]=yield Promise.all([d||z.getSummaryStatistics({layer:t,field:o,valueExpression:l,sqlExpression:r.sqlExpression,sqlWhere:r.sqlWhere,normalizationType:c,normalizationField:s,minValue:a,maxValue:n,view:i,signal:u}),"90-10"===r.theme?z.getClassBreaks({layer:t,field:o,normalizationField:s,valueExpression:l,classificationMethod:"quantile",minValue:a,maxValue:n,view:i,numClasses:10,signal:u}):null]);return X(r,m,null==p?void 0:p.result)}))).apply(this,arguments)}function oe(e,r){const i=e.colorsForClassBreaks;let o;if(i&&i.length>0&&(i.some((e=>(e.numClasses===r&&(o=e.colors),!!o))),!o)){const e=i[i.length-1],l=r-e.numClasses;if(l>0){const r=e.colors[e.numClasses-1];o=e.colors.splice(0);for(let e=1;e<=l;e++)o.push(r)}}return o&&(o=z.createColors(o,o.length)),o}function le(e,r){return ae.apply(this,arguments)}function ae(){return(ae=r._asyncToGenerator((function*(e,r){const i=yield b.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),o=e.layer,l=e.defaultSymbolEnabled,a=o.geometryType,n=yield N({basemap:e.basemap,geometryType:a,colorScheme:e.colorScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view}),s=n.scheme,{result:u,outlineResult:d}=r,c=u.classBreakInfos,m=e.classificationMethod,p="standard-deviation"===m,y=e.normalizationType;if(!s)throw new f("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");const h=oe(s,c.length);if(!h||h.length!==c.length)throw new f("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");const g=d&&d.opacity,T=new t({classBreakInfos:c.map(((r,i)=>({minValue:r.minValue,maxValue:r.maxValue,symbol:z.createSymbol(a,{type:e.symbolType,color:h[i],size:z.getSymbolSizeFromScheme(s,a),outline:z.getSymbolOutlineFromScheme(s,a,g),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}}),label:r.label}))),defaultLabel:l?i.other:null,defaultSymbol:l?z.createSymbol(a,{type:e.symbolType,color:s.noDataColor,size:z.getSymbolSizeFromScheme(s,a),outline:z.getSymbolOutlineFromScheme(s,a,g),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:y,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===y?u.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new v({type:"class-breaks-color",classificationMethod:m,standardDeviationInterval:e.standardDeviationInterval})});return p||w.setLabelsForClassBreaks({classBreakInfos:T.classBreakInfos,classificationMethod:m,normalizationType:y,round:!0}),d&&d.visualVariables&&d.visualVariables.length&&(T.visualVariables=d.visualVariables.map((e=>e.clone()))),{renderer:T,colorScheme:O.cloneScheme(s),classBreaksResult:u,defaultValuesUsed:r.defaultValuesUsed,basemapId:n.basemapId,basemapTheme:n.basemapTheme}}))).apply(this,arguments)}function ne(e){return te.apply(this,arguments)}function te(){return(te=r._asyncToGenerator((function*(e){const r=yield k(e),{layer:i,view:o,signal:l}=r,[a,n,t]=yield Promise.all([re(H(r)),r.outlineOptimizationEnabled?E({layer:i,view:o,signal:l}):null,r.sizeOptimizationEnabled?V({layer:i,view:o,signal:l}):null]),s=r.normalizationField;return Z(a,n,t,s?"field":void 0,s,r)}))).apply(this,arguments)}function se(e){return ue.apply(this,arguments)}function ue(){return(ue=r._asyncToGenerator((function*(e){const r=yield A(e);return le(r,yield z.getClassBreaks(_(r),r.outlineOptimizationEnabled))}))).apply(this,arguments)}function de(e){return j(e).then((e=>({renderer:new l({field:"RGB",pointsPerInch:e.density,pointSizeAlgorithm:z.getPointSizeAlgorithm(e.size)})})))}function ce(e){return me.apply(this,arguments)}function me(){return(me=r._asyncToGenerator((function*(e){const r=yield G(e),i=r.statistics?r.statistics:yield z.getSummaryStatistics({layer:r.layer,field:r.field,signal:r.signal}),o=yield K(i,r);return{renderer:new a({field:r.field,pointsPerInch:r.density,pointSizeAlgorithm:z.getPointSizeAlgorithm(r.size),stops:o.stops}),basemapId:o.basemapId,basemapTheme:o.basemapTheme,statistics:o.statistics,defaultValuesUsed:o.defaultValuesUsed,colorScheme:o.colorScheme}}))).apply(this,arguments)}function pe(e){return ye.apply(this,arguments)}function ye(){return(ye=r._asyncToGenerator((function*(e){const r=yield b.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),i=yield W(e),{defaultSymbolEnabled:o,view:l,startTime:a,endTime:n,symbolType:t,colorMixMode:s,edgesType:u,minValue:d,maxValue:c,signal:m}=i,p=i.layer,[y,f,h]=yield Promise.all([i.unit?{unit:i.unit,statistics:null}:x({view:l,layer:p,startTime:a,endTime:n,minValue:d,maxValue:c,signal:m}),i.outlineOptimizationEnabled?E({layer:p,view:l,signal:m}):null,i.sizeOptimizationEnabled?V({layer:p,view:l,signal:m}):null]),{unit:v,statistics:T}=y,w=M.getAgeExpressions({layer:p,startTime:a,endTime:n,unit:v}).valueExpression,S=g.substitute(r[`ageInfo_${v}`],{unit:v,startTime:z.formatDate(a,v,p),endTime:z.formatDate(n,v,p)}),I=yield re(H({layer:p,basemap:i.basemap,valueExpression:w,symbolType:t,statistics:T,legendOptions:{title:S},colorScheme:i.colorScheme,theme:i.theme,view:l,minValue:i.minValue,maxValue:i.maxValue,signal:m})),C={layer:p,valueExpression:w,defaultSymbolEnabled:o,symbolType:t,colorMixMode:s,edgesType:u},O=yield Z(I,f,h,null,null,C);return O.renderer.authoringInfo.visualVariables.forEach((e=>z.updateAgeRendererAuthoringInfoVV(e,a,n,v))),{...O,unit:v}}))).apply(this,arguments)}e.createAgeRenderer=pe,e.createClassBreaksRenderer=se,e.createContinuousRenderer=ne,e.createPCContinuousRenderer=ce,e.createPCTrueColorRenderer=de,e.createVisualVariable=re,Object.defineProperty(e,"__esModule",{value:!0})}));
