/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Error","../../core/maybe","../../core/screenUtils","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/utils","../../renderers/visualVariables/SizeVariable","../../renderers/visualVariables/support/sizeVariableUtils","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/utils","../support/adapters/support/layerUtils","../../chunks/size"],(function(e,i,a,n,l,r,s,t,o,u,m,p,d,y,c,b,f,h,v,g,w,z,S,T,x,V,E,F){"use strict";const O="date",k=2**53-1;function I(e){return L.apply(this,arguments)}function L(){return(L=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new m("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new m("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");const i={...e};if("90-10"===i.theme)throw new m("size-visual-variable:not-supported","Only 'high-to-low', 'above', 'below' themes are supported.");const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));"height"===i.axis&&(i.sizeOptimizationEnabled=!1);const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType;if("mesh"===l)throw new m("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(i.worldScale){if("polyline"===l||"polygon"===l)throw new m("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!i.view||"3d"!==i.view.type)throw new m("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}const r=yield V.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),s=T.verifyBasicFieldValidity(a,r,"size-visual-variable:invalid-parameters");if(s)throw s;return i}))).apply(this,arguments)}function q(e){return B.apply(this,arguments)}function B(){return(B=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new m("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new m("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled;const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType,r=i.symbolType.indexOf("3d")>-1;if(i.outlineOptimizationEnabled="polygon"===l&&i.outlineOptimizationEnabled,"mesh"===l)throw new m("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(r&&("polyline"===l||"polygon"===l))throw new m("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new m("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const s=yield V.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),t=T.verifyBasicFieldValidity(a,s,"size-continuous-renderer:invalid-parameters");if(t)throw t;return i}))).apply(this,arguments)}function C(e){return D.apply(this,arguments)}function D(){return(D=i._asyncToGenerator((function*(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new m("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new m("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.classificationMethod=i.classificationMethod||"equal-interval",i.normalizationType=V.getNormalizationType(i);const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));if(!(null!=i.minValue&&null!=i.maxValue)&&(null!=i.minValue||null!=i.maxValue))throw new m("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType,r=i.symbolType.indexOf("3d")>-1;if(i.outlineOptimizationEnabled="polygon"===l&&i.outlineOptimizationEnabled,"mesh"===l)throw new m("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(r&&("polyline"===l||"polygon"===l))throw new m("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new m("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const s=yield V.getFieldsList({field:i.field,normalizationField:i.normalizationField}),t=T.verifyBasicFieldValidity(a,s,"size-class-breaks-renderer:invalid-parameters");if(t)throw t;return i}))).apply(this,arguments)}function M(e){const i={...e};delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;const a=i;return a.analyzeData=!(null!=i.minValue&&null!=i.maxValue),a}function R(e){const i={...e},a=i.symbolType.indexOf("3d-volumetric")>-1,n=i;return n.worldScale=a,a&&(n.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,n}function U(e){return A.apply(this,arguments)}function A(){return(A=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new m("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled;const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType,r=i.symbolType.indexOf("3d")>-1;if(i.outlineOptimizationEnabled="polygon"===l&&i.outlineOptimizationEnabled,"mesh"===l)throw new m("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(r&&("polyline"===l||"polygon"===l))throw new m("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new m("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const s=x.verifyDates(a,i.startTime,i.endTime,"size-age-renderer:invalid-parameters");if(s)throw s;if(i.unit&&-1===x.supportedAgeUnits.indexOf(i.unit))throw new m("size-age-renderer:invalid-unit",`Supported units are: ${x.supportedAgeUnits.join(", ")}`);return i}))).apply(this,arguments)}function _(e){return G.apply(this,arguments)}function G(){return(G=i._asyncToGenerator((function*(e){let i=e.sizeScheme,a=null,n=null;const l=yield T.getBasemapInfo(e.basemap,e.view);if(a=p.isSome(l.basemapId)?l.basemapId:null,n=p.isSome(l.basemapTheme)?l.basemapTheme:null,i)return{scheme:F.cloneScheme(i),basemapId:a,basemapTheme:n};const r=F.getSchemes({basemap:a,basemapTheme:n,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});return r&&(i=r.primaryScheme,a=r.basemapId,n=r.basemapTheme),{scheme:i,basemapId:a,basemapTheme:n}}))).apply(this,arguments)}function j(e,i){let a;switch(i){case"point":case"multipoint":{const i=e;a=[i.minSize,i.maxSize];break}case"polyline":{const i=e;a=[i.minWidth,i.maxWidth];break}case"polygon":{const i=e;a=[i.marker.minSize,i.marker.maxSize];break}}return a}function P(e,i){e.transformationType===g.TransformationType.ClampedLinear&&"below"===i&&e.flipSizes()}function W(e,i,a,n){return H.apply(this,arguments)}function H(){return(H=i._asyncToGenerator((function*(e,i,a,n){const{theme:l,field:r,normalizationField:s,minValue:t,maxValue:o,axis:u}=e,p=e.layer,d=r&&!("function"==typeof r)?p.getField(r):null,y=d&&d.type===O,c=p.geometryType,h=yield _({basemap:e.basemap,geometryType:c,sizeScheme:e.sizeScheme,worldScale:e.worldScale,view:e.view}),g=h.scheme;if(!g)throw new m("size-visual-variable:insufficient-info","Unable to find size scheme");const w=n&&[n.minSize,n.maxSize]||j(g,c),{minDataValue:z,maxDataValue:S,defaultValuesUsed:x}=T.getDataRange(i,a,l,y,"above"===l||"below"===l),V=[],E="height"===u,k=E?u:void 0,I=w[0];let L=w[1];if(E&&"number"==typeof I&&"number"==typeof L){const e=T.getSizeRangeForAxis({minSize:I,maxSize:L},k);V.push(new v({axis:"width-and-depth",minSize:e.minSize})),L=e.maxSize}const q=new v({field:r,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,valueUnit:"unknown",normalizationField:s,axis:k,minSize:I,maxSize:L,minDataValue:z,maxDataValue:S,legendOptions:e.legendOptions});P(q,l),V.unshift(q);const B=new f({type:"size",theme:l,minSliderValue:null!=t?t:i.min,maxSliderValue:null!=o?o:i.max}),C=new b({visualVariables:[B]});return{basemapId:h.basemapId,basemapTheme:h.basemapTheme,visualVariables:V,statistics:i,defaultValuesUsed:x,sizeScheme:F.cloneScheme(g),authoringInfo:C}}))).apply(this,arguments)}function $(e,i,a,n,l){return N.apply(this,arguments)}function N(){return(N=i._asyncToGenerator((function*(e,i,n,l,r){const s=yield y.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),t=r.layer,o=r.field,u=t.geometryType,m=r.defaultSymbolEnabled,p=F.cloneScheme(e.sizeScheme),d="polygon"===u,c=d?p.marker:p,b=d?p.background:null,f=d?"point":u,h=i&&i.opacity,v=e.visualVariables.map((e=>e.clone()));i&&i.visualVariables&&i.visualVariables.length&&v.push(...i.visualVariables.map((e=>e.clone())));return{renderer:new a({backgroundFillSymbol:b&&T.createSymbol(u,{type:r.symbolType,color:b.color,outline:T.getSymbolOutlineFromScheme(b,u,h)}),classBreakInfos:[{minValue:-k,maxValue:k,symbol:T.createSymbol(f,{type:r.symbolType,color:c.color,size:T.getSymbolSizeFromScheme(c,f),outline:T.getSymbolOutlineFromScheme(c,f,h)})}],defaultLabel:m?s.other:null,defaultSymbol:m?T.createSymbol(f,{type:r.symbolType,color:c.noDataColor,size:T.getSymbolSizeFromScheme(c,f,!0),outline:T.getSymbolOutlineFromScheme(c,f,h)}):null,field:o,normalizationField:l,normalizationType:n,valueExpression:r.valueExpression,valueExpressionTitle:r.valueExpressionTitle,visualVariables:v,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariables:e.visualVariables.map((e=>e.clone())),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,sizeScheme:F.cloneScheme(e.sizeScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}}))).apply(this,arguments)}function J(e,i){const a=d.toPt(e.minSize),n=(d.toPt(e.maxSize)-a)/(i>=4?i-1:i),l=[];for(let r=0;r<i;r++)l.push(a+n*r);return l}function K(e,i){return Q.apply(this,arguments)}function Q(){return(Q=i._asyncToGenerator((function*(e,i){const n=yield y.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),l=e.layer,r=e.defaultSymbolEnabled,s=l.geometryType,t="polygon"===s,o=e.symbolType.indexOf("3d-volumetric")>-1,u=yield _({basemap:e.basemap,geometryType:s,sizeScheme:e.sizeScheme,worldScale:o,view:e.view}),m=u.scheme,{result:p,outlineResult:d}=i,c=p.classBreakInfos,f=e.classificationMethod,v=e.normalizationType,g=t?m.marker:m,w=t?m.background:null,z=t?"point":s,S=j(g,z),x=o&&T.getSizeRangeForAxis({minSize:S[0],maxSize:S[1]},"height"),V=J({minSize:S[0],maxSize:o?x.maxSize:S[1]},c.length),E=d&&d.opacity,O=new a({backgroundFillSymbol:w&&T.createSymbol(s,{type:e.symbolType,color:w.color,outline:T.getSymbolOutlineFromScheme(w,s,E)}),classBreakInfos:c.map(((i,a)=>({minValue:i.minValue,maxValue:i.maxValue,symbol:T.createSymbol(z,{type:e.symbolType,color:g.color,size:V[a],widthAndDepth:x&&x.minSize,outline:T.getSymbolOutlineFromScheme(g,z,E)}),label:i.label}))),defaultLabel:r?n.other:null,defaultSymbol:r?T.createSymbol(z,{type:e.symbolType,color:g.noDataColor,size:T.getSymbolSizeFromScheme(g,z,!0),widthAndDepth:x&&x.minSize,outline:T.getSymbolOutlineFromScheme(g,z,E)}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:v,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===v?p.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new b({type:"class-breaks-size",classificationMethod:f,standardDeviationInterval:e.standardDeviationInterval})});return"standard-deviation"!==f&&h.setLabelsForClassBreaks({classBreakInfos:O.classBreakInfos,classificationMethod:f,normalizationType:v,round:!0}),d&&d.visualVariables&&d.visualVariables.length&&(O.visualVariables=d.visualVariables.map((e=>e.clone()))),{renderer:O,sizeScheme:F.cloneScheme(m),classBreaksResult:p,defaultValuesUsed:i.defaultValuesUsed,basemapId:u.basemapId,basemapTheme:u.basemapTheme}}))).apply(this,arguments)}function X(e){return Y.apply(this,arguments)}function Y(){return(Y=i._asyncToGenerator((function*(e){const i=yield I(e),{view:a,field:n,valueExpression:l,minValue:r,maxValue:s,layer:t,normalizationField:o,signal:u,statistics:m}=i,p=o?"field":void 0,[d,y,c]=yield Promise.all([m||T.getSummaryStatistics({layer:t,field:n,valueExpression:l,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:p,normalizationField:o,minValue:r,maxValue:s,view:a,signal:u}),"90-10"===i.theme?T.getClassBreaks({layer:t,field:n,normalizationField:o,valueExpression:l,classificationMethod:"quantile",minValue:r,maxValue:s,view:a,numClasses:10,signal:u}):null,i.sizeOptimizationEnabled?S({view:a,layer:t,signal:u}):null]);return W(i,d,null==y?void 0:y.result,c)}))).apply(this,arguments)}function Z(e){return ee.apply(this,arguments)}function ee(){return(ee=i._asyncToGenerator((function*(e){const i=yield q(e),a={layer:i.layer,view:i.view,signal:i.signal},[n,l]=yield Promise.all([X(R(i)),i.outlineOptimizationEnabled?z(a):null]),r=i.normalizationField;return $(n,l,r?"field":void 0,r,i)}))).apply(this,arguments)}function ie(e){return ae.apply(this,arguments)}function ae(){return(ae=i._asyncToGenerator((function*(e){const i=yield C(e);return K(i,yield T.getClassBreaks(M(i),i.outlineOptimizationEnabled))}))).apply(this,arguments)}function ne(e){return le.apply(this,arguments)}function le(){return(le=i._asyncToGenerator((function*(e){const i=yield U(e),{defaultSymbolEnabled:a,view:n,startTime:l,endTime:r,symbolType:s,minValue:t,maxValue:o,signal:u}=i,m=i.layer,p={layer:i.layer,view:i.view,signal:u},[d,b]=yield Promise.all([i.unit?{unit:i.unit,statistics:null,valueExpression:null}:yield w({view:n,layer:m,startTime:l,endTime:r,minValue:t,maxValue:o,signal:u}),i.outlineOptimizationEnabled?z(p):null]),{unit:f,statistics:h}=d,v=x.getAgeExpressions({layer:m,startTime:l,endTime:r,unit:f}).valueExpression,g=yield y.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),S=c.substitute(g[`ageInfo_${f}`],{unit:f,startTime:T.formatDate(l,f,m),endTime:T.formatDate(r,f,m)}),V=yield X(R({layer:m,basemap:i.basemap,valueExpression:v,symbolType:s,statistics:h,legendOptions:{title:S},theme:i.theme,sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:t,maxValue:o,signal:u})),E={layer:m,valueExpression:v,defaultSymbolEnabled:a,symbolType:s},F=yield $(V,b,null,null,E);return F.renderer.authoringInfo.visualVariables.forEach((e=>T.updateAgeRendererAuthoringInfoVV(e,l,r,f))),{...F,unit:f}}))).apply(this,arguments)}e.createAgeRenderer=ne,e.createClassBreaksRenderer=ie,e.createContinuousRenderer=Z,e.createVisualVariables=X,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
