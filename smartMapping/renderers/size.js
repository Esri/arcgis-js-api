// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../renderers","../../core/Error","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/utils","../../renderers/visualVariables/SizeVariable","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/size"],(function(e,i,a,r,n,s,t,l,o,u,m,d,p,c,y,b,f,v,h,g,w,z){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.createAgeRenderer=i.createClassBreaksRenderer=i.createContinuousRenderer=i.createVisualVariables=void 0;var S=Math.pow(2,53)-1;function x(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,t,l,o,u,m;return a.__generator(this,(function(d){switch(d.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new n("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new n("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");if(i=a.__assign({},e),r=[0,2,1,3],t=w.createLayerAdapter(i.layer,r),i.layer=t,!t)throw new n("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(r).join(", "));return"height"===i.axis&&(i.sizeOptimizationEnabled=!1),l=s.isSome(i.signal)?{signal:i.signal}:null,[4,t.load(l)];case 1:if(d.sent(),"mesh"===(o=t.geometryType))throw new n("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(i.worldScale){if("polyline"===o||"polygon"===o)throw new n("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!i.view||"3d"!==i.view.type)throw new n("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}return[4,g.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression})];case 2:if(u=d.sent(),m=v.verifyBasicFieldValidity(t,u,"size-visual-variable:invalid-parameters"))throw m;return[2,i]}}))}))}function T(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,t,l,o,u,m,d;return a.__generator(this,(function(p){switch(p.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new n("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new n("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((i=a.__assign({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,r=[0,2,1,3],t=w.createLayerAdapter(i.layer,r),i.layer=t,!t)throw new n("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(r).join(", "));return l=s.isSome(i.signal)?{signal:i.signal}:null,[4,t.load(l)];case 1:if(p.sent(),o=t.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new n("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(u&&("polyline"===o||"polygon"===o))throw new n("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new n("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,g.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression})];case 2:if(m=p.sent(),d=v.verifyBasicFieldValidity(t,m,"size-continuous-renderer:invalid-parameters"))throw d;return[2,i]}}))}))}function E(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,t,l,o,u,m,d;return a.__generator(this,(function(p){switch(p.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new n("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new n("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((i=a.__assign({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.classificationMethod=i.classificationMethod||"equal-interval",i.normalizationType=g.getNormalizationType(i),r=[0,2,1,3],t=w.createLayerAdapter(i.layer,r),i.layer=t,!t)throw new n("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(r).join(", "));if(!(null!=i.minValue&&null!=i.maxValue)&&(null!=i.minValue||null!=i.maxValue))throw new n("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return l=s.isSome(i.signal)?{signal:i.signal}:null,[4,t.load(l)];case 1:if(p.sent(),o=t.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new n("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(u&&("polyline"===o||"polygon"===o))throw new n("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new n("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,g.getFieldsList({field:i.field,normalizationField:i.normalizationField})];case 2:if(m=p.sent(),d=v.verifyBasicFieldValidity(t,m,"size-class-breaks-renderer:invalid-parameters"))throw d;return[2,i]}}))}))}function V(e){var i=a.__assign({},e);delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;var r=i;return r.analyzeData=!(null!=i.minValue&&null!=i.maxValue),r}function _(e){var i=a.__assign({},e),r=i.symbolType.indexOf("3d-volumetric")>-1,n=i;return n.worldScale=r,r&&(n.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,n}function O(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,t,l,o,u,m;return a.__generator(this,(function(d){switch(d.label){case 0:if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new n("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");if((i=a.__assign({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,r=[0,2,1,3],t=w.createLayerAdapter(i.layer,r),i.layer=t,!t)throw new n("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(r).join(", "));return l=s.isSome(i.signal)?{signal:i.signal}:null,[4,t.load(l)];case 1:if(d.sent(),o=t.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new n("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(u&&("polyline"===o||"polygon"===o))throw new n("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new n("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if(m=h.verifyDates(t,i.startTime,i.endTime,"size-age-renderer:invalid-parameters"))throw m;if(i.unit&&-1===h.supportedAgeUnits.indexOf(i.unit))throw new n("size-age-renderer:invalid-unit","Supported units are: "+h.supportedAgeUnits.join(", "));return[2,i]}}))}))}function F(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,n,t,l;return a.__generator(this,(function(a){switch(a.label){case 0:return i=e.sizeScheme,r=null,n=null,[4,v.getBasemapInfo(e.basemap,e.view)];case 1:return t=a.sent(),r=s.isSome(t.basemapId)?t.basemapId:null,n=s.isSome(t.basemapTheme)?t.basemapTheme:null,i?[2,{scheme:z.cloneScheme(i),basemapId:r,basemapTheme:n}]:((l=z.getSchemes({basemap:r,basemapTheme:n,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view}))&&(i=l.primaryScheme,r=l.basemapId,n=l.basemapTheme),[2,{scheme:i,basemapId:r,basemapTheme:n}])}}))}))}function k(e,i){var a;switch(i){case"point":case"multipoint":var r=e;a=[r.minSize,r.maxSize];break;case"polyline":var n=e;a=[n.minWidth,n.maxWidth];break;case"polygon":var s=e;a=[s.marker.minSize,s.marker.maxSize]}return a}function I(e,i,r,s){return a.__awaiter(this,void 0,void 0,(function(){var t,l,o,u,p,y,b,f,h,g,w,S,x,T,E,V,_,O,I,q;return a.__generator(this,(function(a){switch(a.label){case 0:return t=s.layer,l=s.field,o="function"==typeof l,u=l&&!o?t.getField(l):null,p=u&&"date"===u.type,y=t.geometryType,[4,F({basemap:s.basemap,geometryType:y,sizeScheme:s.sizeScheme,worldScale:s.worldScale,view:s.view})];case 1:if(b=a.sent(),!(f=b.scheme))throw new n("size-visual-variable:insufficient-info","Unable to find size scheme");return h=i&&[i.minSize,i.maxSize],g=h||k(f,y),w=v.getDefaultDataRange(e,p,!1),S=w||[e.min,e.max],x=[],T="height"===s.axis,E=T?s.axis:void 0,V=g[0],_=g[1],T&&"number"==typeof V&&"number"==typeof _&&(O=v.getSizeRangeForAxis({minSize:V,maxSize:_},E),x.push(new c({axis:"width-and-depth",minSize:O.minSize})),_=O.maxSize),x.unshift(new c({field:l,valueExpression:s.valueExpression,valueExpressionTitle:s.valueExpressionTitle,valueUnit:"unknown",normalizationField:r,axis:E,minSize:V,maxSize:_,minDataValue:S[0],maxDataValue:S[1],legendOptions:s.legendOptions})),I=new d({type:"size",minSliderValue:null!=s.minValue?s.minValue:e.min,maxSliderValue:null!=s.maxValue?s.maxValue:e.max}),q=new m({visualVariables:[I]}),[2,{basemapId:b.basemapId,basemapTheme:b.basemapTheme,visualVariables:x,statistics:e,defaultValuesUsed:!!w,sizeScheme:z.cloneScheme(f),authoringInfo:q}]}}))}))}function q(e,i,n,s,t){return a.__awaiter(this,void 0,void 0,(function(){var l,u,m,d,p,c,y,b,f,h,g,w;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,o.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return l=a.sent(),u=t.layer,m=t.field,d=u.geometryType,p=t.defaultSymbolEnabled,c=z.cloneScheme(e.sizeScheme),b=(y="polygon"===d)?c.marker:c,f=y?c.background:null,h=y?"point":d,g=i&&i.opacity,w=e.visualVariables.map((function(e){return e.clone()})),i&&i.visualVariables&&i.visualVariables.length&&w.push.apply(w,i.visualVariables.map((function(e){return e.clone()}))),[2,{renderer:new r.ClassBreaksRenderer({backgroundFillSymbol:f&&v.createSymbol(d,{type:t.symbolType,color:f.color,outline:v.getSymbolOutlineFromScheme(f,d,g)}),classBreakInfos:[{minValue:-S,maxValue:S,symbol:v.createSymbol(h,{type:t.symbolType,color:b.color,size:v.getSymbolSizeFromScheme(b,h),outline:v.getSymbolOutlineFromScheme(b,h,g)})}],defaultLabel:p?l.other:null,defaultSymbol:p?v.createSymbol(h,{type:t.symbolType,color:b.noDataColor,size:v.getSymbolSizeFromScheme(b,h,!0),outline:v.getSymbolOutlineFromScheme(b,h,g)}):null,field:m,normalizationField:s,normalizationType:n,valueExpression:t.valueExpression,valueExpressionTitle:t.valueExpressionTitle,visualVariables:w,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariables:e.visualVariables.map((function(e){return e.clone()})),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,sizeScheme:z.cloneScheme(e.sizeScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}]}}))}))}function B(e,i){return a.__awaiter(this,void 0,void 0,(function(){var n,s,t,u,d,c,y,b,f,h,g,w,S,x,T,E,V,_,O,I,q;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,o.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return n=a.sent(),s=e.layer,t=e.defaultSymbolEnabled,u=s.geometryType,d="polygon"===u,c=e.symbolType.indexOf("3d-volumetric")>-1,[4,F({basemap:e.basemap,geometryType:u,sizeScheme:e.sizeScheme,worldScale:c,view:e.view})];case 2:return y=a.sent(),b=y.scheme,f=i.result,h=i.outlineResult,g=f.classBreakInfos,w=e.classificationMethod,S=e.normalizationType,x=d?b.marker:b,T=d?b.background:null,V=k(x,E=d?"point":u),_=c&&v.getSizeRangeForAxis({minSize:V[0],maxSize:V[1]},"height"),O=function(e,i){for(var a=l.toPt(e.minSize),r=(l.toPt(e.maxSize)-a)/(i>=4?i-1:i),n=[],s=0;s<i;s++)n.push(a+r*s);return n}({minSize:V[0],maxSize:c?_.maxSize:V[1]},g.length),I=h&&h.opacity,q=new r.ClassBreaksRenderer({backgroundFillSymbol:T&&v.createSymbol(u,{type:e.symbolType,color:T.color,outline:v.getSymbolOutlineFromScheme(T,u,I)}),classBreakInfos:g.map((function(i,a){return{minValue:i.minValue,maxValue:i.maxValue,symbol:v.createSymbol(E,{type:e.symbolType,color:x.color,size:O[a],widthAndDepth:_&&_.minSize,outline:v.getSymbolOutlineFromScheme(x,E,I)}),label:i.label}})),defaultLabel:t?n.other:null,defaultSymbol:t?v.createSymbol(E,{type:e.symbolType,color:x.noDataColor,size:v.getSymbolSizeFromScheme(x,E,!0),widthAndDepth:_&&_.minSize,outline:v.getSymbolOutlineFromScheme(x,E,I)}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:S,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===S?f.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new m({type:"class-breaks-size",classificationMethod:w,standardDeviationInterval:e.standardDeviationInterval})}),"standard-deviation"!==w&&p.setLabelsForClassBreaks({classBreakInfos:q.classBreakInfos,classificationMethod:w,normalizationType:S,round:!0}),h&&h.visualVariables&&h.visualVariables.length&&(q.visualVariables=h.visualVariables.map((function(e){return e.clone()}))),[2,{renderer:q,sizeScheme:z.cloneScheme(b),classBreaksResult:f,defaultValuesUsed:i.defaultValuesUsed,basemapId:y.basemapId,basemapTheme:y.basemapTheme}]}}))}))}function L(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,n,s,l,o,u,m,d;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,x(e)];case 1:return i=a.sent(),r=i.view,n=i.layer,s=i.normalizationField,l=i.signal,o=s?"field":void 0,[4,t.all([i.statistics?i.statistics:v.getSummaryStatistics({layer:n,field:i.field,valueExpression:i.valueExpression,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:o,normalizationField:s,minValue:i.minValue,maxValue:i.maxValue,view:r,signal:l}),i.sizeOptimizationEnabled?f({view:r,layer:n,signal:l}):null])];case 2:return u=a.sent(),m=u[0],d=u[1],[2,I(m,d,s,i)]}}))}))}i.createVisualVariables=L,i.createContinuousRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,n,s,l,o;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,T(e)];case 1:return i=a.sent(),r={layer:i.layer,view:i.view,signal:i.signal},[4,t.all([L(_(i)),i.outlineOptimizationEnabled?b(r):null])];case 2:return n=a.sent(),s=n[0],l=n[1],o=i.normalizationField,[2,q(s,l,o?"field":void 0,o,i)]}}))}))},i.createClassBreaksRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,E(e)];case 1:return i=a.sent(),[4,v.getClassBreaks(V(i),i.outlineOptimizationEnabled)];case 2:return r=a.sent(),[2,B(i,r)]}}))}))},i.createAgeRenderer=function(e){return a.__awaiter(this,void 0,void 0,(function(){var i,r,n,s,l,m,d,p,c,f,g,w,z,S,x,T,E,V,F,k,I,B,A;return a.__generator(this,(function(M){switch(M.label){case 0:return[4,O(e)];case 1:return i=M.sent(),r=i.defaultSymbolEnabled,n=i.view,s=i.startTime,l=i.endTime,m=i.symbolType,d=i.minValue,p=i.maxValue,c=i.signal,f=i.layer,g={layer:i.layer,view:i.view,signal:c},T=(x=t).all,i.unit?(E={unit:i.unit,statistics:null,valueExpression:null},[3,4]):[3,2];case 2:return[4,y({view:n,layer:f,startTime:s,endTime:l,minValue:d,maxValue:p,signal:c})];case 3:E=M.sent(),M.label=4;case 4:return[4,T.apply(x,[[E,i.outlineOptimizationEnabled?b(g):null]])];case 5:return w=M.sent(),z=w[0],S=w[1],V=z.unit,F=z.statistics,k=h.getAgeExpressions({layer:f,startTime:s,endTime:l,unit:V}).valueExpression,[4,o.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 6:return I=M.sent(),B=u.substitute(I["ageInfo_"+V],{unit:V,startTime:v.formatDate(s,V,f),endTime:v.formatDate(l,V,f)}),[4,L(_({layer:f,basemap:i.basemap,valueExpression:k,symbolType:m,statistics:F,legendOptions:{title:B},sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:d,maxValue:p,signal:c}))];case 7:return[4,q(M.sent(),S,null,null,{layer:f,valueExpression:k,defaultSymbolEnabled:r,symbolType:m})];case 8:return A=M.sent(),A.renderer.authoringInfo.visualVariables.forEach((function(e){return v.updateAgeRendererAuthoringInfoVV(e,s,l,V)})),[2,a.__assign(a.__assign({},A),{unit:V})]}}))}))}}));