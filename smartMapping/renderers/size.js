/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Error","../../core/maybe","../../core/screenUtils","../../intl/messages","../../intl/substitute","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/utils","../../renderers/visualVariables/SizeVariable","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/support/ageUtils","../support/utils","../support/adapters/support/layerUtils","../../chunks/size"],(function(e,i,a,n,l,r,s,t,o,u,m,p,d,y,c,b,f,h,v,g,w,z,S,T,x,E,V){"use strict";const F="date",O=2**53-1;function k(e){return I.apply(this,arguments)}function I(){return(I=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new m("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new m("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");const i={...e};if("90-10"===i.theme)throw new m("size-visual-variable:not-supported","Only 'high-to-low', 'above', 'below' themes are supported.");const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));"height"===i.axis&&(i.sizeOptimizationEnabled=!1);const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType;if("mesh"===l)throw new m("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(i.worldScale){if("polyline"===l||"polygon"===l)throw new m("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!i.view||"3d"!==i.view.type)throw new m("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}const r=yield x.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),s=S.verifyBasicFieldValidity(a,r,"size-visual-variable:invalid-parameters");if(s)throw s;return i}))).apply(this,arguments)}function L(e){return q.apply(this,arguments)}function q(){return(q=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new m("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new m("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled;const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType,r=i.symbolType.indexOf("3d")>-1;if(i.outlineOptimizationEnabled="polygon"===l&&i.outlineOptimizationEnabled,"mesh"===l)throw new m("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(r&&("polyline"===l||"polygon"===l))throw new m("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new m("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const s=yield x.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),t=S.verifyBasicFieldValidity(a,s,"size-continuous-renderer:invalid-parameters");if(t)throw t;return i}))).apply(this,arguments)}function B(e){return D.apply(this,arguments)}function D(){return(D=i._asyncToGenerator((function*(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new m("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new m("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.classificationMethod=i.classificationMethod||"equal-interval",i.normalizationType=x.getNormalizationType(i);const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));if(!(null!=i.minValue&&null!=i.maxValue)&&(null!=i.minValue||null!=i.maxValue))throw new m("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType,r=i.symbolType.indexOf("3d")>-1;if(i.outlineOptimizationEnabled="polygon"===l&&i.outlineOptimizationEnabled,"mesh"===l)throw new m("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(r&&("polyline"===l||"polygon"===l))throw new m("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new m("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const s=yield x.getFieldsList({field:i.field,normalizationField:i.normalizationField}),t=S.verifyBasicFieldValidity(a,s,"size-class-breaks-renderer:invalid-parameters");if(t)throw t;return i}))).apply(this,arguments)}function C(e){const i={...e};delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;const a=i;return a.analyzeData=!(null!=i.minValue&&null!=i.maxValue),a}function R(e){const i={...e},a=i.symbolType.indexOf("3d-volumetric")>-1,n=i;return n.worldScale=a,a&&(n.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,n}function A(e){return M.apply(this,arguments)}function M(){return(M=i._asyncToGenerator((function*(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new m("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled;const a=E.createLayerAdapter(i.layer,E.featureCapableLayerTypes);if(i.layer=a,!a)throw new m("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+E.getLayerTypeLabels(E.featureCapableLayerTypes).join(", "));const n=p.isSome(i.signal)?{signal:i.signal}:null;yield a.load(n);const l=a.geometryType,r=i.symbolType.indexOf("3d")>-1;if(i.outlineOptimizationEnabled="polygon"===l&&i.outlineOptimizationEnabled,"mesh"===l)throw new m("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(r&&("polyline"===l||"polygon"===l))throw new m("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new m("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const s=T.verifyDates(a,i.startTime,i.endTime,"size-age-renderer:invalid-parameters");if(s)throw s;if(i.unit&&-1===T.supportedAgeUnits.indexOf(i.unit))throw new m("size-age-renderer:invalid-unit",`Supported units are: ${T.supportedAgeUnits.join(", ")}`);return i}))).apply(this,arguments)}function U(e){return _.apply(this,arguments)}function _(){return(_=i._asyncToGenerator((function*(e){let i=e.sizeScheme,a=null,n=null;const l=yield S.getBasemapInfo(e.basemap,e.view);if(a=p.isSome(l.basemapId)?l.basemapId:null,n=p.isSome(l.basemapTheme)?l.basemapTheme:null,i)return{scheme:V.cloneScheme(i),basemapId:a,basemapTheme:n};const r=V.getSchemes({basemap:a,basemapTheme:n,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});return r&&(i=r.primaryScheme,a=r.basemapId,n=r.basemapTheme),{scheme:i,basemapId:a,basemapTheme:n}}))).apply(this,arguments)}function G(e,i){let a;switch(i){case"point":case"multipoint":{const i=e;a=[i.minSize,i.maxSize];break}case"polyline":{const i=e;a=[i.minWidth,i.maxWidth];break}case"polygon":{const i=e;a=[i.marker.minSize,i.marker.maxSize];break}}return a}function j(e,i){"clamped-linear"===e.transformationType&&"below"===i&&e.flipSizes()}function P(e,i,a,n){return W.apply(this,arguments)}function W(){return(W=i._asyncToGenerator((function*(e,i,a,n){const{theme:l,field:r,normalizationField:s,minValue:t,maxValue:o,axis:u}=e,p=e.layer,d=r&&!("function"==typeof r)?p.getField(r):null,y=d&&d.type===F,c=p.geometryType,h=yield U({basemap:e.basemap,geometryType:c,sizeScheme:e.sizeScheme,worldScale:e.worldScale,view:e.view}),g=h.scheme;if(!g)throw new m("size-visual-variable:insufficient-info","Unable to find size scheme");const w=n&&[n.minSize,n.maxSize]||G(g,c),{minDataValue:z,maxDataValue:T,defaultValuesUsed:x}=S.getDataRange(i,a,l,y,"above"===l||"below"===l),E=[],O="height"===u,k=O?u:void 0,I=w[0];let L=w[1];if(O&&"number"==typeof I&&"number"==typeof L){const e=S.getSizeRangeForAxis({minSize:I,maxSize:L},k);E.push(new v({axis:"width-and-depth",minSize:e.minSize})),L=e.maxSize}const q=new v({field:r,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,valueUnit:"unknown",normalizationField:s,axis:k,minSize:I,maxSize:L,minDataValue:z,maxDataValue:T,legendOptions:e.legendOptions});j(q,l),E.unshift(q);const B=new f({type:"size",theme:l,minSliderValue:null!=t?t:i.min,maxSliderValue:null!=o?o:i.max}),D=new b({visualVariables:[B]});return{basemapId:h.basemapId,basemapTheme:h.basemapTheme,visualVariables:E,statistics:i,defaultValuesUsed:x,sizeScheme:V.cloneScheme(g),authoringInfo:D}}))).apply(this,arguments)}function H(e,i,a,n,l){return $.apply(this,arguments)}function $(){return($=i._asyncToGenerator((function*(e,i,n,l,r){const s=yield y.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),t=r.layer,o=r.field,u=t.geometryType,m=r.defaultSymbolEnabled,p=V.cloneScheme(e.sizeScheme),d="polygon"===u,c=d?p.marker:p,b=d?p.background:null,f=d?"point":u,h=i&&i.opacity,v=e.visualVariables.map((e=>e.clone()));i&&i.visualVariables&&i.visualVariables.length&&v.push(...i.visualVariables.map((e=>e.clone())));return{renderer:new a({backgroundFillSymbol:b&&S.createSymbol(u,{type:r.symbolType,color:b.color,outline:S.getSymbolOutlineFromScheme(b,u,h)}),classBreakInfos:[{minValue:-O,maxValue:O,symbol:S.createSymbol(f,{type:r.symbolType,color:c.color,size:S.getSymbolSizeFromScheme(c,f),outline:S.getSymbolOutlineFromScheme(c,f,h)})}],defaultLabel:m?s.other:null,defaultSymbol:m?S.createSymbol(f,{type:r.symbolType,color:c.noDataColor,size:S.getSymbolSizeFromScheme(c,f,!0),outline:S.getSymbolOutlineFromScheme(c,f,h)}):null,field:o,normalizationField:l,normalizationType:n,valueExpression:r.valueExpression,valueExpressionTitle:r.valueExpressionTitle,visualVariables:v,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariables:e.visualVariables.map((e=>e.clone())),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,sizeScheme:V.cloneScheme(e.sizeScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}}))).apply(this,arguments)}function N(e,i){const a=d.toPt(e.minSize),n=(d.toPt(e.maxSize)-a)/(i>=4?i-1:i),l=[];for(let r=0;r<i;r++)l.push(a+n*r);return l}function J(e,i){return K.apply(this,arguments)}function K(){return(K=i._asyncToGenerator((function*(e,i){const n=yield y.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),l=e.layer,r=e.defaultSymbolEnabled,s=l.geometryType,t="polygon"===s,o=e.symbolType.indexOf("3d-volumetric")>-1,u=yield U({basemap:e.basemap,geometryType:s,sizeScheme:e.sizeScheme,worldScale:o,view:e.view}),m=u.scheme,{result:p,outlineResult:d}=i,c=p.classBreakInfos,f=e.classificationMethod,v=e.normalizationType,g=t?m.marker:m,w=t?m.background:null,z=t?"point":s,T=G(g,z),x=o&&S.getSizeRangeForAxis({minSize:T[0],maxSize:T[1]},"height"),E=N({minSize:T[0],maxSize:o?x.maxSize:T[1]},c.length),F=d&&d.opacity,O=new a({backgroundFillSymbol:w&&S.createSymbol(s,{type:e.symbolType,color:w.color,outline:S.getSymbolOutlineFromScheme(w,s,F)}),classBreakInfos:c.map(((i,a)=>({minValue:i.minValue,maxValue:i.maxValue,symbol:S.createSymbol(z,{type:e.symbolType,color:g.color,size:E[a],widthAndDepth:x&&x.minSize,outline:S.getSymbolOutlineFromScheme(g,z,F)}),label:i.label}))),defaultLabel:r?n.other:null,defaultSymbol:r?S.createSymbol(z,{type:e.symbolType,color:g.noDataColor,size:S.getSymbolSizeFromScheme(g,z,!0),widthAndDepth:x&&x.minSize,outline:S.getSymbolOutlineFromScheme(g,z,F)}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:v,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===v?p.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new b({type:"class-breaks-size",classificationMethod:f,standardDeviationInterval:e.standardDeviationInterval})});return"standard-deviation"!==f&&h.setLabelsForClassBreaks({classBreakInfos:O.classBreakInfos,classificationMethod:f,normalizationType:v,round:!0}),d&&d.visualVariables&&d.visualVariables.length&&(O.visualVariables=d.visualVariables.map((e=>e.clone()))),{renderer:O,sizeScheme:V.cloneScheme(m),classBreaksResult:p,defaultValuesUsed:i.defaultValuesUsed,basemapId:u.basemapId,basemapTheme:u.basemapTheme}}))).apply(this,arguments)}function Q(e){return X.apply(this,arguments)}function X(){return(X=i._asyncToGenerator((function*(e){const i=yield k(e),{view:a,field:n,valueExpression:l,minValue:r,maxValue:s,layer:t,normalizationField:o,signal:u,statistics:m}=i,p=o?"field":void 0,[d,y,c]=yield Promise.all([m||S.getSummaryStatistics({layer:t,field:n,valueExpression:l,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:p,normalizationField:o,minValue:r,maxValue:s,view:a,signal:u}),"90-10"===i.theme?S.getClassBreaks({layer:t,field:n,normalizationField:o,valueExpression:l,classificationMethod:"quantile",minValue:r,maxValue:s,view:a,numClasses:10,signal:u}):null,i.sizeOptimizationEnabled?z({view:a,layer:t,signal:u}):null]);return P(i,d,null==y?void 0:y.result,c)}))).apply(this,arguments)}function Y(e){return Z.apply(this,arguments)}function Z(){return(Z=i._asyncToGenerator((function*(e){const i=yield L(e),a={layer:i.layer,view:i.view,signal:i.signal},[n,l]=yield Promise.all([Q(R(i)),i.outlineOptimizationEnabled?w(a):null]),r=i.normalizationField;return H(n,l,r?"field":void 0,r,i)}))).apply(this,arguments)}function ee(e){return ie.apply(this,arguments)}function ie(){return(ie=i._asyncToGenerator((function*(e){const i=yield B(e);return J(i,yield S.getClassBreaks(C(i),i.outlineOptimizationEnabled))}))).apply(this,arguments)}function ae(e){return ne.apply(this,arguments)}function ne(){return(ne=i._asyncToGenerator((function*(e){const i=yield A(e),{defaultSymbolEnabled:a,view:n,startTime:l,endTime:r,symbolType:s,minValue:t,maxValue:o,signal:u}=i,m=i.layer,p={layer:i.layer,view:i.view,signal:u},[d,b]=yield Promise.all([i.unit?{unit:i.unit,statistics:null,valueExpression:null}:yield g({view:n,layer:m,startTime:l,endTime:r,minValue:t,maxValue:o,signal:u}),i.outlineOptimizationEnabled?w(p):null]),{unit:f,statistics:h}=d,v=T.getAgeExpressions({layer:m,startTime:l,endTime:r,unit:f}).valueExpression,z=yield y.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),x=c.substitute(z[`ageInfo_${f}`],{unit:f,startTime:S.formatDate(l,f,m),endTime:S.formatDate(r,f,m)}),E=yield Q(R({layer:m,basemap:i.basemap,valueExpression:v,symbolType:s,statistics:h,legendOptions:{title:x},theme:i.theme,sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:t,maxValue:o,signal:u})),V={layer:m,valueExpression:v,defaultSymbolEnabled:a,symbolType:s},F=yield H(E,b,null,null,V);return F.renderer.authoringInfo.visualVariables.forEach((e=>S.updateAgeRendererAuthoringInfoVV(e,l,r,f))),{...F,unit:f}}))).apply(this,arguments)}e.createAgeRenderer=ae,e.createClassBreaksRenderer=ee,e.createContinuousRenderer=Y,e.createVisualVariables=Q,Object.defineProperty(e,"__esModule",{value:!0})}));
