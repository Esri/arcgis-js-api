// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../pointCloudRenderers","../../renderers","../../core/Error","../../core/lang","../../core/maybe","../../core/promiseUtils","../../intl/messages","../../renderers/support/LegendOptions","../../renderers/support/utils","../heuristics/outline","../heuristics/sizeRange","./support/utils","../statistics/uniqueValues","../support/utils","../support/adapters/support/layerUtils","../symbology/type"],(function(e,r,t,a,n,i,l,s,o,u,d,c,p,m,y,f,b,v,h){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.createPCClassRenderer=r.createRenderer=void 0;function g(e){return t.__awaiter(this,void 0,void 0,(function(){var r,a,n,o,u,d,c;return t.__generator(this,(function(p){switch(p.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new i("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new i("type-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((r=t.__assign({},e)).symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.sortEnabled=null==r.sortEnabled||r.sortEnabled,r.statistics=l.clone(r.statistics),a=[0,2,1,3],n=v.createLayerAdapter(r.layer,a),r.layer=n,!n)throw new i("type-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(a).join(", "));return o=s.isSome(r.signal)?{signal:r.signal}:null,[4,n.load(o)];case 1:if(p.sent(),u=n.geometryType,r.outlineOptimizationEnabled="polygon"===u&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===u||"multipoint"===u||"polyline"===u)&&r.sizeOptimizationEnabled,"mesh"===u)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==u)throw new i("type-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new i("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}return[4,b.getFieldsList({field:r.field,valueExpression:r.valueExpression})];case 2:if(d=p.sent(),c=y.verifyBasicFieldValidity(n,d,"type-renderer:invalid-parameters"))throw c;return[2,r]}}))}))}function w(e){return t.__awaiter(this,void 0,void 0,(function(){var r,a,n,o,u,d;return t.__generator(this,(function(c){switch(c.label){case 0:if(!(e&&e.layer&&e.field))throw new i("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required");if((r=t.__assign({},e)).statistics=l.clone(r.statistics),a=[4],n=v.createLayerAdapter(r.layer,a),r.layer=n,r.density=r.density||25,r.size=r.size||"100%",!y.isValidPointSize(r.size))throw new i("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");if(!n)throw new i("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(a).join(", "));return o=s.isSome(r.signal)?{signal:r.signal}:null,[4,n.load(o)];case 1:return c.sent(),[4,b.getFieldsList({field:r.field})];case 2:if(u=c.sent(),d=y.verifyBasicFieldValidity(n,u,"type-point-cloud-class-renderer:invalid-parameters"))throw d;return[2,r]}}))}))}function T(e){return t.__awaiter(this,void 0,void 0,(function(){var r,a,n,i,l;return t.__generator(this,(function(t){switch(t.label){case 0:return r=e.typeScheme,a=null,n=null,[4,y.getBasemapInfo(e.basemap,e.view)];case 1:return i=t.sent(),a=s.isSome(i.basemapId)?i.basemapId:null,n=s.isSome(i.basemapTheme)?i.basemapTheme:null,r?[2,{scheme:h.cloneScheme(r),basemapId:a,basemapTheme:n}]:((l=h.getSchemes({basemap:a,basemapTheme:n,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view}))&&(r=l.primaryScheme,a=l.basemapId,n=l.basemapTheme),[2,{scheme:r,basemapId:a,basemapTheme:n}])}}))}))}function S(e,r){return e.label<r.label?-1:e.label>r.label?1:0}function _(e,r){return e.value<r.value?-1:e.value>r.value?1:0}function E(e,r){var t=r.count-e.count;return 0===t&&(t=S(e,r)),t}function V(e,r){var t=r.count-e.count;return 0===t&&(t=_(e,r)),t}function x(e,r,t){var a;"count"===r?(a=V,t&&t.codedValues&&(a=E)):"value"===r&&(a=_,t&&t.codedValues&&(a=S)),a&&e.sort(a)}function z(e,r,a,i){return t.__awaiter(this,void 0,void 0,(function(){var l,s,o,p,m,f,b,v,g,w,S,_,E,V,z,I,M,q,O,C,L,F,U,R;return t.__generator(this,(function(B){switch(B.label){case 0:return[4,u.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return l=B.sent(),s=e.uniqueValueInfos,o=r.layer,p=r.field,m=p?o.getField(p):null,f=m?o.getFieldDomain(m.name):null,b=-1===r.numTypes?s.length:r.numTypes,v=o.geometryType,[4,T({basemap:r.basemap,geometryType:v,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view})];case 2:for(g=B.sent(),w=g.scheme,S=new n.UniqueValueRenderer({field:p}),_=-1,V={value:null,domain:f,fieldInfo:m},s.forEach((function(e,r){V.value=e.value,e.label=c.createUniqueValueLabel(V),null===e.value&&(_=r)})),_>-1&&(E=s.splice(_,1)[0]),!1!==r.sortEnabled&&x(s,r.sortBy,f),m&&"date"===m.type&&(z=s.filter((function(e,r){return r<b})),I=z.map((function(e){return e.value})),V.dateFormatInterval=c.calculateDateFormatInterval(I)),M=a&&a.opacity,q=y.createColors(w.colors,s.length),O=y.getSymbolSizeFromScheme(w,v),C=y.getSymbolOutlineFromScheme(w,v,M),s.forEach((function(e,t){V.value=e.value,e.label=c.createUniqueValueLabel(V),e.symbol=y.createSymbol(v,{type:r.symbolType,color:q[t],size:O,outline:C,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})})),r.valueExpression&&(S.valueExpression=r.valueExpression,S.valueExpressionTitle=r.valueExpressionTitle),r.legendOptions&&(S.legendOptions=new d.LegendOptions(r.legendOptions)),q=y.createColors(w.colors,b),R=0;R<b;R++)(L=s[R])&&S.addUniqueValueInfo({value:L.value,label:L.label,symbol:y.createSymbol(v,{type:r.symbolType,color:q[R],size:O,outline:C,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})});if(r.defaultSymbolEnabled&&(S.defaultSymbol=y.createSymbol(v,{type:r.symbolType,color:w.noDataColor,size:O,outline:C,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),S.defaultLabel=l.other),E&&(E.symbol=y.createSymbol(v,{type:r.symbolType,color:w.noDataColor,size:O,outline:C,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),s.push(E)),F=[],(U=S.uniqueValueInfos.length===s.length?-1:S.uniqueValueInfos.length)>-1)for(R=U;R<s.length;R++)F.push(t.__assign({},s[R]));return a&&a.visualVariables&&a.visualVariables.length&&(S.visualVariables=a.visualVariables.map((function(e){return e.clone()}))),i&&i.minSize&&(S.visualVariables?S.visualVariables.push(i.minSize):S.visualVariables=[i.minSize]),[2,{renderer:S,uniqueValueInfos:s,excludedUniqueValueInfos:F,typeScheme:h.cloneScheme(w),basemapId:g.basemapId,basemapTheme:g.basemapTheme}]}}))}))}function I(e,r){return t.__awaiter(this,void 0,void 0,(function(){var a,n,i,l,s;return t.__generator(this,(function(t){switch(t.label){case 0:return a=e.uniqueValueInfos,[4,T({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r})];case 1:return n=t.sent(),i=n&&n.scheme,l="point-cloud-class"===i.theme,s=l?i.colors:y.createColors(i.colors,a.length),x(a,"value"),[2,a.map((function(e,r){var t=e.value,a=null;return l?(a=s[t])||(a=s[s.length-1]):a=s[r],{values:[t],color:a,label:e.label}}))]}}))}))}r.createRenderer=function(e){return t.__awaiter(this,void 0,void 0,(function(){var r,a,n,i,l,s,u,d,c;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,g(e)];case 1:return r=t.sent(),a=r.layer,n=r.view,i=r.signal,l={layer:a,field:r.field,valueExpression:r.valueExpression,returnAllCodedValues:r.returnAllCodedValues,view:n,signal:i},[4,o.all([null!=r.statistics?r.statistics:f(l),r.outlineOptimizationEnabled?p({layer:a,view:n,signal:i}):null,r.sizeOptimizationEnabled?m({layer:a,view:n,signal:i}):null])];case 2:return s=t.sent(),u=s[0],d=s[1],c=s[2],[2,z(u,r,d,c)]}}))}))},r.createPCClassRenderer=function(e){return t.__awaiter(this,void 0,void 0,(function(){var r,n,i,l,s;return t.__generator(this,(function(t){switch(t.label){case 0:return[4,w(e)];case 1:return null==(r=t.sent()).statistics?[3,2]:(i=r.statistics,[3,4]);case 2:return[4,f({layer:r.layer,field:r.field,signal:r.signal})];case 3:i=t.sent(),t.label=4;case 4:return n=i,l=a.PointCloudUniqueValueRenderer.bind,s={field:r.field,pointsPerInch:r.density,pointSizeAlgorithm:y.getPointSizeAlgorithm(r.size)},[4,I(n,r.typeScheme)];case 5:return[2,{renderer:new(l.apply(a.PointCloudUniqueValueRenderer,[void 0,(s.colorUniqueValueInfos=t.sent(),s)]))}]}}))}))}}));