/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["./chunks/_rollupPluginBabelHelpers","./chunks/tslib.es6","./core/has","./core/lang","./core/Logger","./core/accessorSupport/ensureType","./core/accessorSupport/decorators/property","./core/accessorSupport/decorators/cast","./core/accessorSupport/decorators/reader","./core/accessorSupport/decorators/subclass","./core/accessorSupport/decorators/writer","./core/urlUtils","./core/uuid","./portal/support/resourceExtension","./core/promiseUtils","./core/JSONSupport","./core/Collection","./layers/support/fieldUtils","./popup/content/Content","./popup/content/AttachmentsContent","./popup/content/CustomContent","./popup/FieldInfo","./popup/content/FieldsContent","./popup/content/support/mediaInfoTypes","./popup/content/MediaContent","./popup/content/TextContent","./popup/content","./popup/ExpressionInfo","./popup/LayerOptions","./popup/RelatedRecordsInfo","./support/actions/ActionBase","./support/actions/ActionButton","./support/actions/ActionToggle"],(function(e,t,o,n,r,i,s,p,l,a,c,d,f,u,y,h,m,_,I,A,F,w,g,x,v,C,N,O,E,S,T,b,L){"use strict";var R;const J=m.ofType({key:"type",defaultKeyValue:"button",base:T,typeMap:{button:b,toggle:L}}),M={base:I,key:"type",typeMap:{media:v,custom:F,text:C,attachments:A,fields:g}},B="esri.PopupTemplate",P=r.getLogger(B),k=["attachments","fields","media","text"];let U=R=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).actions=null,e.content="",e.expressionInfos=null,e.fieldInfos=null,e.layerOptions=null,e.lastEditInfoEnabled=!0,e.outFields=null,e.overwriteActions=!1,e.returnGeometry=!1,e.title="",e.relatedRecordsInfo=null,e}e._inheritsLoose(o,t);var r=o.prototype;return r.castContent=function(e){return Array.isArray(e)?e.map((e=>i.ensureOneOfType(M,e))):"string"==typeof e||"function"==typeof e||e instanceof HTMLElement||y.isPromiseLike(e)?e:(P.error("content error","unsupported content value",{value:e}),null)},r.readContent=function(e,t){const{popupElements:o}=t;return Array.isArray(o)&&o.length>0?this._readPopupInfoElements(t):this._readPopupInfo(t)},r.writeContent=function(e,t){"string"!=typeof e?Array.isArray(e)&&(t.popupElements=e.filter((e=>-1!==k.indexOf(e.type))).map((e=>e&&e.toJSON())),t.popupElements.forEach((e=>{"attachments"===e.type?this._writeAttachmentContent(t):"media"===e.type?this._writeMediaContent(e,t):"text"===e.type&&this._writeTextContent(e,t)}))):t.description=e},r.writeFieldInfos=function(e,t){const{content:o}=this,n=Array.isArray(o)?o:null;if(e){const o=!!n&&n.some((e=>"fields"===e.type&&(!e.fieldInfos||0===e.fieldInfos.length)));t.fieldInfos=e.filter(Boolean).map((e=>{const t=e.toJSON();return o||(t.visible=!1),t}))}if(n)for(const e of n)"fields"===e.type&&this._writeFieldsContent(e,t)},r.writeLayerOptions=function(e,t){t.layerOptions=!e||null===e.showNoDataRecords&&null===e.returnTopmostRaster?null:e.toJSON()},r.writeTitle=function(e,t){t.title=e||""},r.clone=function(){const{actions:e}=this,t=e?n.clone(e.toArray()):[];return new R({actions:t,content:Array.isArray(this.content)?n.clone(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?n.clone(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?n.clone(this.fieldInfos):null,layerOptions:this.layerOptions?n.clone(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?n.clone(this.outFields):null,overwriteActions:this.overwriteActions,returnGeometry:this.returnGeometry,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?n.clone(this.relatedRecordsInfo):null})},r.collectRequiredFields=async function(e,t){await this._collectExpressionInfoFields(e,t,this.expressionInfos),_.collectFields(e,t,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])},r.getRequiredFields=async function(e){const t=new Set;return await this.collectRequiredFields(t,e),[...t].sort()},r._writeFieldsContent=function(e,t){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const o=n.clone(e.fieldInfos);Array.isArray(t.fieldInfos)?o.forEach((e=>{const o=t.fieldInfos.find((t=>t.fieldName.toLowerCase()===e.fieldName.toLowerCase()));o?o.visible=!0:t.fieldInfos.push(e)})):t.fieldInfos=o},r._writeAttachmentContent=function(e){e.showAttachments||(e.showAttachments=!0)},r._writeTextContent=function(e,t){!t.description&&e.text&&(t.description=e.text)},r._writeMediaContent=function(e,t){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const o=n.clone(e.mediaInfos);Array.isArray(t.mediaInfos)?t.mediaInfos=[...t.mediaInfos,...o]:t.mediaInfos=o},r._readPopupInfoElements=function({description:e,mediaInfos:t,popupElements:o}){const n={description:!1,mediaInfos:!1};return o.map((o=>"media"===o.type?(o.mediaInfos||!t||n.mediaInfos||(o.mediaInfos=t,n.mediaInfos=!0),v.fromJSON(o)):"text"===o.type?(o.text||!e||n.description||(o.text=e,n.description=!0),C.fromJSON(o)):"attachments"===o.type?A.fromJSON(o):"fields"===o.type?g.fromJSON(o):void 0)).filter(Boolean)},r._readPopupInfo=function({description:e,mediaInfos:t,showAttachments:o}){const n=[];return e?n.push(new C({text:e})):n.push(new g),Array.isArray(t)&&t.length&&n.push(v.fromJSON({mediaInfos:t})),o&&n.push(A.fromJSON({displayType:"list"})),n.length?n:e},r._getContentElementFields=function(e){if(!e||"attachments"===e.type)return[];if("custom"===e.type)return e.outFields||[];if("fields"===e.type)return this._getFieldInfoFields(e.fieldInfos||this.fieldInfos);if("media"===e.type){return(e.mediaInfos||[]).reduce(((e,t)=>[...e,...this._getMediaInfoFields(t)]),[])}return"text"===e.type?this._extractFieldNames(e.text):void 0},r._getMediaInfoFields=function(e){const{caption:t,title:o,value:n}=e,r=n||{},{fields:i=[],normalizeField:s,tooltipField:p,sourceURL:l,linkURL:a}=r,c=[...this._extractFieldNames(o),...this._extractFieldNames(t),...this._extractFieldNames(l),...this._extractFieldNames(a),...i];return s&&c.push(s),p&&c.push(p),c},r._getContentFields=function(e){return"string"==typeof e?this._extractFieldNames(e):Array.isArray(e)?e.reduce(((e,t)=>[...e,...this._getContentElementFields(t)]),[]):[]},r._collectExpressionInfoFields=async function(e,t,o){o&&await y.all(o.map((o=>_.collectArcadeFieldNames(e,t,o.expression))))},r._getFieldInfoFields=function(e){return e?e.filter((e=>void 0===e.visible||!!e.visible)).map((e=>e.fieldName)).filter((e=>-1===e.indexOf("relationships/")&&-1===e.indexOf("expression/"))):[]},r._getActionsFields=function(e){return e?e.toArray().reduce(((e,t)=>[...e,...this._getActionFields(t)]),[]):[]},r._getActionFields=function(e){const{className:t,title:o,type:n}=e,r="button"===n||"toggle"===n?e.image:"";return[...this._extractFieldNames(o),...this._extractFieldNames(t),...this._extractFieldNames(r)]},r._getTitleFields=function(e){return"string"==typeof e?this._extractFieldNames(e):[]},r._extractFieldNames=function(e){if(!e||"string"!=typeof e)return[];const t=e.match(/{[^}]*}/g);if(!t)return[];const o=/\{(\w+):.+\}/,n=t.filter((e=>!(0===e.indexOf("{relationships/")||0===e.indexOf("{expression/")))).map((e=>e.replace(o,"{$1}")));return n?n.map((e=>e.slice(1,-1))):[]},o}(h.JSONSupport);return t.__decorate([s.property({type:J})],U.prototype,"actions",void 0),t.__decorate([s.property()],U.prototype,"content",void 0),t.__decorate([p.cast("content")],U.prototype,"castContent",null),t.__decorate([l.reader("content",["description","popupElements","mediaInfos","showAttachments"])],U.prototype,"readContent",null),t.__decorate([c.writer("content",{popupElements:{type:m.ofType(N.persistableTypes)},showAttachments:{type:Boolean},mediaInfos:{type:m.ofType(x.types)},description:{type:String}})],U.prototype,"writeContent",null),t.__decorate([s.property({type:[O],json:{write:!0}})],U.prototype,"expressionInfos",void 0),t.__decorate([s.property({type:[w]})],U.prototype,"fieldInfos",void 0),t.__decorate([c.writer("fieldInfos")],U.prototype,"writeFieldInfos",null),t.__decorate([s.property({type:E})],U.prototype,"layerOptions",void 0),t.__decorate([c.writer("layerOptions")],U.prototype,"writeLayerOptions",null),t.__decorate([s.property({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],U.prototype,"lastEditInfoEnabled",void 0),t.__decorate([s.property()],U.prototype,"outFields",void 0),t.__decorate([s.property()],U.prototype,"overwriteActions",void 0),t.__decorate([s.property()],U.prototype,"returnGeometry",void 0),t.__decorate([s.property({json:{type:String}})],U.prototype,"title",void 0),t.__decorate([c.writer("title")],U.prototype,"writeTitle",null),t.__decorate([s.property({type:S,json:{write:!0}})],U.prototype,"relatedRecordsInfo",void 0),U=R=t.__decorate([a.subclass(B)],U),U}));
