// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","./core/arrayUtils","./core/Collection","./core/JSONSupport","./core/lang","./core/Logger","./core/promiseUtils","./core/SetUtils","./core/accessorSupport/decorators","./core/accessorSupport/ensureType","./layers/support/fieldUtils","./popup/content","./popup/ExpressionInfo","./popup/FieldInfo","./popup/LayerOptions","./popup/RelatedRecordsInfo","./popup/content/AttachmentsContent","./popup/content/Content","./popup/content/CustomContent","./popup/content/FieldsContent","./popup/content/MediaContent","./popup/content/TextContent","./popup/content/support/mediaInfoTypes","./support/actions/ActionBase","./support/actions/ActionButton","./support/actions/ActionToggle"],(function(t,e,o,n,r,i,s,p,a,l,c,d,u,f,y,_,h,m,I,A,v,F,w,g,x,O,C,N){var E=r.ofType({key:"type",defaultKeyValue:"button",base:O,typeMap:{button:C,toggle:N}}),S={base:A,key:"type",typeMap:{media:w,custom:v,text:g,attachments:I,fields:F}},T=p.getLogger("esri.PopupTemplate"),b=["attachments","fields","media","text"];return function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=null,e.content="",e.expressionInfos=null,e.fieldInfos=null,e.layerOptions=null,e.lastEditInfoEnabled=!0,e.outFields=null,e.overwriteActions=!1,e.title="",e.relatedRecordsInfo=null,e}var i;return o.__extends(e,t),i=e,e.prototype.castContent=function(t){return Array.isArray(t)?t.map((function(t){return d.ensureOneOfType(S,t)})):"string"==typeof t||"function"==typeof t||t instanceof HTMLElement||a.isPromiseLike(t)?t:(T.error("content error","unsupported content value",{value:t}),null)},e.prototype.readContent=function(t,e){var o=e.popupElements;return Array.isArray(o)&&o.length>0?this._readPopupInfoElements(e):this._readPopupInfo(e)},e.prototype.writeContent=function(t,e){var o=this;"string"!=typeof t?Array.isArray(t)&&(e.popupElements=t.filter((function(t){return-1!==b.indexOf(t.type)})).map((function(t){return t&&t.toJSON()})),e.popupElements.forEach((function(t){"attachments"===t.type?o._writeAttachmentContent(e):"media"===t.type?o._writeMediaContent(t,e):"text"===t.type&&o._writeTextContent(t,e)}))):e.description=t},e.prototype.writeFieldInfos=function(t,e){var o=this.content,n=Array.isArray(o)?o:null;if(t){var r=!!n&&n.some((function(t){return"fields"===t.type&&(!t.fieldInfos||0===t.fieldInfos.length)}));e.fieldInfos=t.filter(Boolean).map((function(t){var e=t.toJSON();return r||(e.visible=!1),e}))}if(n)for(var i=0,s=n;i<s.length;i++){var p=s[i];"fields"===p.type&&this._writeFieldsContent(p,e)}},e.prototype.writeLayerOptions=function(t,e){e.layerOptions=!t||null===t.showNoDataRecords&&null===t.returnTopmostRaster?null:t.toJSON()},e.prototype.writeTitle=function(t,e){e.title=t||""},e.prototype.clone=function(){var t=this.actions,e=t?s.clone(t.toArray()):[];return new i({actions:e,content:Array.isArray(this.content)?s.clone(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?s.clone(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?s.clone(this.fieldInfos):null,layerOptions:this.layerOptions?s.clone(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?s.clone(this.outFields):null,overwriteActions:this.overwriteActions,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?s.clone(this.relatedRecordsInfo):null})},e.prototype.collectRequiredFields=function(t,e){return o.__awaiter(this,void 0,void 0,(function(){return o.__generator(this,(function(n){switch(n.label){case 0:return[4,this._collectExpressionInfoFields(t,e,this.expressionInfos)];case 1:return n.sent(),u.collectFields(t,e,o.__spreadArrays(this.outFields||[],this._getActionsFields(this.actions),this._getTitleFields(this.title),this._getContentFields(this.content))),[2]}}))}))},e.prototype.getRequiredFields=function(t){return o.__awaiter(this,void 0,void 0,(function(){var e;return o.__generator(this,(function(o){switch(o.label){case 0:return e=new Set,[4,this.collectRequiredFields(e,t)];case 1:return o.sent(),[2,l.valuesOfSet(e).sort()]}}))}))},e.prototype._writeFieldsContent=function(t,e){if(Array.isArray(t.fieldInfos)&&t.fieldInfos.length){var o=s.clone(t.fieldInfos);Array.isArray(e.fieldInfos)?o.forEach((function(t){var o=n.find(e.fieldInfos,(function(e){return e.fieldName.toLowerCase()===t.fieldName.toLowerCase()}));o?o.visible=!0:e.fieldInfos.push(t)})):e.fieldInfos=o}},e.prototype._writeAttachmentContent=function(t){t.showAttachments||(t.showAttachments=!0)},e.prototype._writeTextContent=function(t,e){!e.description&&t.text&&(e.description=t.text)},e.prototype._writeMediaContent=function(t,e){if(Array.isArray(t.mediaInfos)&&t.mediaInfos.length){var n=s.clone(t.mediaInfos);Array.isArray(e.mediaInfos)?e.mediaInfos=o.__spreadArrays(e.mediaInfos,n):e.mediaInfos=n}},e.prototype._readPopupInfoElements=function(t){var e=t.description,o=t.mediaInfos,n=t.popupElements,r={description:!1,mediaInfos:!1};return n.map((function(t){return"media"===t.type?(t.mediaInfos||!o||r.mediaInfos||(t.mediaInfos=o,r.mediaInfos=!0),w.fromJSON(t)):"text"===t.type?(t.text||!e||r.description||(t.text=e,r.description=!0),g.fromJSON(t)):"attachments"===t.type?I.fromJSON(t):"fields"===t.type?F.fromJSON(t):void 0})).filter(Boolean)},e.prototype._readPopupInfo=function(t){var e=t.description,o=t.mediaInfos,n=t.showAttachments,r=[];return e?r.push(new g({text:e})):r.push(new F),Array.isArray(o)&&o.length&&r.push(w.fromJSON({mediaInfos:o})),n&&r.push(I.fromJSON({displayType:"list"})),r.length?r:e},e.prototype._getContentElementFields=function(t){var e=this;return t&&"attachments"!==t.type?"custom"===t.type?t.outFields||[]:"fields"===t.type?this._getFieldInfoFields(t.fieldInfos||this.fieldInfos):"media"===t.type?(t.mediaInfos||[]).reduce((function(t,n){return o.__spreadArrays(t,e._getMediaInfoFields(n))}),[]):"text"===t.type?this._extractFieldNames(t.text):void 0:[]},e.prototype._getMediaInfoFields=function(t){var e=t.caption,n=t.title,r=t.value||{},i=r.fields,s=void 0===i?[]:i,p=r.normalizeField,a=r.tooltipField,l=r.sourceURL,c=r.linkURL,d=o.__spreadArrays(this._extractFieldNames(n),this._extractFieldNames(e),this._extractFieldNames(l),this._extractFieldNames(c),s);return p&&d.push(p),a&&d.push(a),d},e.prototype._getContentFields=function(t){var e=this;return"string"==typeof t?this._extractFieldNames(t):Array.isArray(t)?t.reduce((function(t,n){return o.__spreadArrays(t,e._getContentElementFields(n))}),[]):[]},e.prototype._collectExpressionInfoFields=function(t,e,n){return o.__awaiter(this,void 0,void 0,(function(){return o.__generator(this,(function(o){switch(o.label){case 0:return n?[4,a.all(n.map((function(o){return u.collectArcadeFieldNames(t,e,o.expression)})))]:[2];case 1:return o.sent(),[2]}}))}))},e.prototype._getFieldInfoFields=function(t){return t?t.filter((function(t){return void 0===t.visible||!!t.visible})).map((function(t){return t.fieldName})).filter((function(t){return-1===t.indexOf("relationships/")&&-1===t.indexOf("expression/")})):[]},e.prototype._getActionsFields=function(t){var e=this;return t?t.toArray().reduce((function(t,n){return o.__spreadArrays(t,e._getActionFields(n))}),[]):[]},e.prototype._getActionFields=function(t){var e=t.className,n=t.title,r=t.type,i="button"===r||"toggle"===r?t.image:"";return o.__spreadArrays(this._extractFieldNames(n),this._extractFieldNames(e),this._extractFieldNames(i))},e.prototype._getTitleFields=function(t){return"string"==typeof t?this._extractFieldNames(t):[]},e.prototype._extractFieldNames=function(t){if(!t||"string"!=typeof t)return[];var e=t.match(/{[^}]*}/g);if(!e)return[];var o=/\{(\w+):.+\}/,n=e.filter((function(t){return!(0===t.indexOf("{relationships/")||0===t.indexOf("{expression/"))})).map((function(t){return t.replace(o,"{$1}")}));return n?n.map((function(t){return t.slice(1,-1)})):[]},o.__decorate([c.property({type:E})],e.prototype,"actions",void 0),o.__decorate([c.property()],e.prototype,"content",void 0),o.__decorate([c.cast("content")],e.prototype,"castContent",null),o.__decorate([c.reader("content",["description","popupElements","mediaInfos","showAttachments"])],e.prototype,"readContent",null),o.__decorate([c.writer("content",{popupElements:{type:r.ofType(f.types)},showAttachments:{type:Boolean},mediaInfos:{type:r.ofType(x.types)},description:{type:String}})],e.prototype,"writeContent",null),o.__decorate([c.property({type:[y],json:{write:!0}})],e.prototype,"expressionInfos",void 0),o.__decorate([c.property({type:[_]})],e.prototype,"fieldInfos",void 0),o.__decorate([c.writer("fieldInfos")],e.prototype,"writeFieldInfos",null),o.__decorate([c.property({type:h})],e.prototype,"layerOptions",void 0),o.__decorate([c.writer("layerOptions")],e.prototype,"writeLayerOptions",null),o.__decorate([c.property({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],e.prototype,"lastEditInfoEnabled",void 0),o.__decorate([c.property()],e.prototype,"outFields",void 0),o.__decorate([c.property()],e.prototype,"overwriteActions",void 0),o.__decorate([c.property({json:{type:String}})],e.prototype,"title",void 0),o.__decorate([c.writer("title")],e.prototype,"writeTitle",null),o.__decorate([c.property({type:m,json:{write:!0}})],e.prototype,"relatedRecordsInfo",void 0),e=i=o.__decorate([c.subclass("esri.PopupTemplate")],e)}(i.JSONSupport)}));