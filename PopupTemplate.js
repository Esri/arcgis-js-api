/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["./chunks/_rollupPluginBabelHelpers","./chunks/tslib.es6","./core/Clonable","./core/Collection","./core/JSONSupport","./core/lang","./core/Logger","./core/promiseUtils","./core/accessorSupport/decorators/property","./core/accessorSupport/decorators/cast","./core/accessorSupport/decorators/reader","./core/accessorSupport/decorators/subclass","./core/accessorSupport/decorators/writer","./core/accessorSupport/ensureType","./layers/support/fieldUtils","./popup/content","./popup/ExpressionInfo","./popup/FieldInfo","./popup/LayerOptions","./popup/RelatedRecordsInfo","./popup/content/support/mediaInfoTypes","./support/actions/ActionBase","./support/actions/ActionButton","./support/actions/ActionToggle","./popup/content/MediaContent","./popup/content/TextContent","./popup/content/AttachmentsContent","./popup/content/FieldsContent","./popup/content/ExpressionContent","./popup/content/RelationshipContent","./popup/content/Content","./popup/content/CustomContent"],(function(e,t,o,n,r,i,s,p,l,a,c,d,f,u,y,h,m,_,I,F,x,g,w,A,N,C,O,v,S,E,R,T){"use strict";const b="esri.PopupTemplate",J=s.getLogger(b),L="relationships/",B="expression/",M=n.ofType({key:"type",defaultKeyValue:"button",base:g,typeMap:{button:w,toggle:A}}),P={base:R,key:"type",typeMap:{media:N,custom:T,text:C,attachments:O,fields:v,expression:S,relationship:E}},k=["attachments","fields","media","text","expression","relationship"];let $=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).actions=null,e.content="",e.expressionInfos=null,e.fieldInfos=null,e.layerOptions=null,e.lastEditInfoEnabled=!0,e.outFields=null,e.overwriteActions=!1,e.returnGeometry=!1,e.title="",e}e._inheritsLoose(o,t);var n=o.prototype;return n.castContent=function(e){return Array.isArray(e)?e.map((e=>u.ensureOneOfType(P,e))):"string"==typeof e||"function"==typeof e||e instanceof HTMLElement||p.isPromiseLike(e)?e:(J.error("content error","unsupported content value",{value:e}),null)},n.readContent=function(e,t){const{popupElements:o}=t;return Array.isArray(o)&&o.length>0?this._readPopupInfoElements(t.description,t.mediaInfos,o):this._readPopupInfo(t)},n.writeContent=function(e,t,o,n){"string"!=typeof e?Array.isArray(e)&&(t.popupElements=e.filter((e=>k.includes(e.type))).map((e=>e&&e.toJSON(n))),t.popupElements.forEach((e=>{"attachments"===e.type?this._writeAttachmentContent(t):"media"===e.type?this._writeMediaContent(e,t):"text"===e.type?this._writeTextContent(e,t):"relationship"===e.type&&this._writeRelationshipContent(e,t)}))):t.description=e},n.writeFieldInfos=function(e,t,o,n){const{content:r}=this,i=Array.isArray(r)?r:null;if(e){const o=i?i.filter((e=>"fields"===e.type)):[],r=o.length&&o.every((e=>e.fieldInfos?.length));t.fieldInfos=e.filter(Boolean).map((e=>{const t=e.toJSON(n);return r&&(t.visible=!1),t}))}if(i)for(const s of i)"fields"===s.type&&this._writeFieldsContent(s,t)},n.writeLayerOptions=function(e,t,o,n){t[o]=!e||null===e.showNoDataRecords&&null===e.returnTopmostRaster?null:e.toJSON(n)},n.writeTitle=function(e,t){t.title=e||""},n.collectRequiredFields=function(){var t=e._asyncToGenerator((function*(e,t){const o=this.expressionInfos||[];yield this._collectExpressionInfoFields(e,t,[...o,...this._getContentExpressionInfos(this.content,o)]),y.collectFields(e,t,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}));function o(e,o){return t.apply(this,arguments)}return o}(),n.getRequiredFields=function(){var t=e._asyncToGenerator((function*(e){const t=new Set;return yield this.collectRequiredFields(t,e),[...t].sort()}));function o(e){return t.apply(this,arguments)}return o}(),n._writeFieldsContent=function(e,t){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const o=i.clone(e.fieldInfos);Array.isArray(t.fieldInfos)?o.forEach((e=>{const o=t.fieldInfos.find((t=>t.fieldName.toLowerCase()===e.fieldName.toLowerCase()));o?o.visible=!0:t.fieldInfos.push(e)})):t.fieldInfos=o},n._writeAttachmentContent=function(e){e.showAttachments||(e.showAttachments=!0)},n._writeRelationshipContent=function(e,t){const o=e.orderByFields?.map((t=>this._toFieldOrderJSON(t,e.relationshipId)))||[],n=[...t.relatedRecordsInfo?.orderByFields||[],...o];t.relatedRecordsInfo={showRelatedRecords:!0,...n?.length&&{orderByFields:n}}},n._writeTextContent=function(e,t){!t.description&&e.text&&(t.description=e.text)},n._writeMediaContent=function(e,t){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const o=i.clone(e.mediaInfos);Array.isArray(t.mediaInfos)?t.mediaInfos=[...t.mediaInfos,...o]:t.mediaInfos=o},n._readPopupInfoElements=function(e,t,o){const n={description:!1,mediaInfos:!1};return o.map((o=>"media"===o.type?(o.mediaInfos||!t||n.mediaInfos||(o.mediaInfos=t,n.mediaInfos=!0),N.fromJSON(o)):"text"===o.type?(o.text||!e||n.description||(o.text=e,n.description=!0),C.fromJSON(o)):"attachments"===o.type?O.fromJSON(o):"fields"===o.type?v.fromJSON(o):"expression"===o.type?S.fromJSON(o):"relationship"===o.type?E.fromJSON(o):void 0)).filter(Boolean)},n._toRelationshipContent=function(e){const{field:t,order:o}=e;if(!t?.startsWith(L))return null;const n=t.replace(L,"").split("/");if(2!==n.length)return null;const r=parseInt(n[0],10),i=n[1];return"number"==typeof r&&i?E.fromJSON({relationshipId:r,orderByFields:[{field:i,order:o}]}):null},n._toFieldOrderJSON=function(e,t){const{order:o,field:n}=e;return{field:`${L}${t}/${n}`,order:o}},n._readPopupInfo=function({description:e,mediaInfos:t,showAttachments:o,relatedRecordsInfo:n={showRelatedRecords:!1}}){const r=[];e?r.push(new C({text:e})):r.push(new v),Array.isArray(t)&&t.length&&r.push(N.fromJSON({mediaInfos:t})),o&&r.push(O.fromJSON({displayType:"auto"}));const{showRelatedRecords:i,orderByFields:s}=n;return i&&s?.length&&s.forEach((e=>{const t=this._toRelationshipContent(e);t&&r.push(t)})),r.length?r:e},n._getContentElementFields=function(e){const t=e?.type;if("attachments"===t)return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if("custom"===t)return e.outFields||[];if("fields"===t)return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos??this.fieldInfos)];if("media"===t){const t=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...t.reduce(((e,t)=>[...e,...this._getMediaInfoFields(t)]),[])]}return"text"===t?this._extractFieldNames(e.text):[]},n._getMediaInfoFields=function(e){const{caption:t,title:o,value:n}=e,r=n||{},{fields:i,normalizeField:s,tooltipField:p,sourceURL:l,linkURL:a}=r,c=[...this._extractFieldNames(o),...this._extractFieldNames(t),...this._extractFieldNames(l),...this._extractFieldNames(a),...i??[]];return s&&c.push(s),p&&c.push(p),c},n._getContentExpressionInfos=function(e,t){return Array.isArray(e)?e.reduce(((e,t)=>[...e,..."expression"===t.type&&t.expressionInfo?[t.expressionInfo]:[]]),t):[]},n._getContentFields=function(e){return"string"==typeof e?this._extractFieldNames(e):Array.isArray(e)?e.reduce(((e,t)=>[...e,...this._getContentElementFields(t)]),[]):[]},n._collectExpressionInfoFields=function(){var t=e._asyncToGenerator((function*(e,t,o){o&&(yield Promise.all(o.map((o=>y.collectArcadeFieldNames(e,t,o.expression)))))}));function o(e,o,n){return t.apply(this,arguments)}return o}(),n._getFieldInfoFields=function(e){return e?e.filter((e=>void 0===e.visible||!!e.visible)).map((e=>e.fieldName)).filter((e=>!e.startsWith(L)&&!e.startsWith(B))):[]},n._getActionsFields=function(e){return e?e.toArray().reduce(((e,t)=>[...e,...this._getActionFields(t)]),[]):[]},n._getActionFields=function(e){const{className:t,title:o,type:n}=e,r="button"===n||"toggle"===n?e.image:"";return[...this._extractFieldNames(o),...this._extractFieldNames(t),...this._extractFieldNames(r)]},n._getTitleFields=function(e){return"string"==typeof e?this._extractFieldNames(e):[]},n._extractFieldNames=function(e){if(!e||"string"!=typeof e)return[];const t=/{[^}]*}/g,o=e.match(t);if(!o)return[];const n=/\{(\w+):.+\}/,r=o.filter((e=>!(0===e.indexOf(`{${L}`)||0===e.indexOf(`{${B}`)))).map((e=>e.replace(n,"{$1}")));return r?r.map((e=>e.slice(1,-1))):[]},o}(o.ClonableMixin(r.JSONSupport));t.__decorate([l.property({type:M})],$.prototype,"actions",void 0),t.__decorate([l.property()],$.prototype,"content",void 0),t.__decorate([a.cast("content")],$.prototype,"castContent",null),t.__decorate([c.reader("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments","relatedRecordsInfo"])],$.prototype,"readContent",null),t.__decorate([f.writer("content",{popupElements:{type:n.ofType(h.persistableTypes)},showAttachments:{type:Boolean},mediaInfos:{type:n.ofType(x.types)},description:{type:String},relatedRecordsInfo:{type:F}})],$.prototype,"writeContent",null),t.__decorate([l.property({type:[m],json:{write:!0}})],$.prototype,"expressionInfos",void 0),t.__decorate([l.property({type:[_]})],$.prototype,"fieldInfos",void 0),t.__decorate([f.writer("fieldInfos")],$.prototype,"writeFieldInfos",null),t.__decorate([l.property({type:I})],$.prototype,"layerOptions",void 0),t.__decorate([f.writer("layerOptions")],$.prototype,"writeLayerOptions",null),t.__decorate([l.property({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],$.prototype,"lastEditInfoEnabled",void 0),t.__decorate([l.property()],$.prototype,"outFields",void 0),t.__decorate([l.property()],$.prototype,"overwriteActions",void 0),t.__decorate([l.property()],$.prototype,"returnGeometry",void 0),t.__decorate([l.property({json:{type:String}})],$.prototype,"title",void 0),t.__decorate([f.writer("title")],$.prototype,"writeTitle",null),$=t.__decorate([d.subclass("esri.PopupTemplate")],$);return $}));
