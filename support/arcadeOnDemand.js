/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["require","exports","../chunks/_rollupPluginBabelHelpers","../geometry","../core/Error","../core/Logger","../core/maybe","../geometry/SpatialReference"],(function(e,r,t,n,a,s,i,c){"use strict";const o=s.getLogger("esri.support.arcadeOnDemand");let l;function u(){return l||(l=t._asyncToGenerator((function*(){const r=yield new Promise(((r,t)=>e(["./arcadeUtils"],r,t)));return{arcade:r.arcade,arcadeUtils:r,Dictionary:r.Dictionary,Feature:r.arcadeFeature}}))()),l}const p=(e,r,t)=>h.create(e,r,t,null,["$feature"]),d=(e,r,t)=>h.create(e,r,t,null,["$feature","$view"]),f=d,y=(e,r,t,n)=>h.create(e,r,t,n,["$feature","$view"]);let h=function(){function e(e,r,t,n,a,s,i,c){this.script=e,this.evaluate=a;const o=Array.isArray(i)?i:i.fields;this.fields=o,this._syntaxTree=n,this._arcade=r,this._arcadeDictionary=t,this._arcadeFeature=s,this._spatialReference=c,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}e.create=function(){var r=t._asyncToGenerator((function*(r,t,n,s,l,p){const{arcade:d,Feature:f,Dictionary:y}=yield u(),h=c.fromJSON(t);let m=null;try{m=d.parseScript(r,p)}catch(E){return o.error(new a("arcade-bad-expression","Failed to parse arcade script",{script:r,error:E})),null}const _=l.reduce(((e,r)=>({...e,[r]:null})),{});let g=null;i.isSome(s)&&(g=new y(s),g.immutable=!0,_.$config=null);const F=d.scriptUsesGeometryEngine(m),b=F&&d.enableGeometrySupport(),x=d.scriptUsesFeatureSet(m)&&d.enableFeatureSetSupport(),S=d.scriptIsAsync(m),w=S&&d.enableAsyncSupport(),v={vars:_,spatialReference:h,useAsync:!!w};yield Promise.all([b,x,w]);const $=new Set;yield d.loadDependentModules($,m,null,S,F);const T=new y;T.immutable=!1,T.setField("scale",0);const D=d.compileScript(m,v),G=e=>("$view"in e&&e.$view&&(T.setField("scale",e.$view.scale),e.$view=T),g&&(e.$config=g),D({vars:e,spatialReference:h}));return new e(r,d,y,m,G,new f,n,h)}));function n(e,t,n,a,s,i){return r.apply(this,arguments)}return n}();var r=e.prototype;return r.repurposeFeature=function(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature},r.createDictionary=function(){return new this._arcadeDictionary},r.referencesMember=function(e){return this._arcade.referencesMember(this._syntaxTree,e)},r.referencesFunction=function(e){return this._arcade.referencesFunction(this._syntaxTree,e)},r.referencesGeometry=function(){return this._referencesGeometry},r.referencesScale=function(){return this._referencesScale},r.extractFieldLiterals=function(){return this._arcade.extractExpectedFieldLiterals(this._syntaxTree)},e}();r.ArcadeExpression=h,r.createDictionaryExpression=y,r.createLabelExpression=p,r.createRendererExpression=d,r.createVVExpression=f,r.loadArcade=u,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
