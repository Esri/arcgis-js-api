/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["require","exports","../chunks/_rollupPluginBabelHelpers","../geometry","../core/Error","../core/Logger","../core/maybe","../geometry/SpatialReference"],(function(e,r,t,a,n,s,i,c){"use strict";const o=s.getLogger("esri.support.arcadeOnDemand");let l;function u(){return l||(l=t._asyncToGenerator((function*(){const r=yield new Promise(((r,t)=>e(["./arcadeUtils"],r,t)));return{arcade:r.arcade,arcadeUtils:r,Dictionary:r.Dictionary,Feature:r.arcadeFeature}}))()),l}const p=(e,r,t)=>m.create(e,r,t,null,["$feature"]),d=(e,r,t)=>m.create(e,r,t,null,["$feature","$view"]),f=d,y=(e,r,t,a)=>m.create(e,r,t,a,["$feature","$view"]);let m=function(){function e(e,r,t,a,n,s,i){this.script=e,this.evaluate=a;const c=Array.isArray(s)?s:s.fields;this.fields=c,this._syntaxTree=t,this._arcade=r,this._arcadeFeature=n,this._spatialReference=i,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}e.create=function(){var r=t._asyncToGenerator((function*(r,t,a,s,l,p){const{arcade:d,Feature:f,Dictionary:y}=yield u(),m=c.fromJSON(t);let h;try{h=d.parseScript(r,p)}catch(E){return o.error(new n("arcade-bad-expression","Failed to parse arcade script",{script:r,error:E})),null}const g=l.reduce(((e,r)=>({...e,[r]:null})),{});let _=null;i.isSome(s)&&(_=new y(s),_.immutable=!0,g.$config=null);const S=d.scriptUsesGeometryEngine(h),b=S&&d.enableGeometrySupport(),v=d.scriptUsesFeatureSet(h)&&d.enableFeatureSetSupport(),w=d.scriptIsAsync(h),F=w&&d.enableAsyncSupport(),$={vars:g,spatialReference:m,useAsync:!!F};yield Promise.all([b,v,F]);const x=new Set;yield d.loadDependentModules(x,h,null,w,S);const G=new y;G.immutable=!1,G.setField("scale",0);const R=d.compileScript(h,$),A=e=>("$view"in e&&e.$view&&(G.setField("scale","object"==typeof e.$view?e.$view.scale:void 0),e.$view=G),_&&(e.$config=_),R({vars:e,spatialReference:m}));return new e(r,d,h,A,new f,a,m)}));function a(e,t,a,n,s,i){return r.apply(this,arguments)}return a}();var r=e.prototype;return r.repurposeFeature=function(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature},r.referencesGeometry=function(){return this._referencesGeometry},r.referencesScale=function(){return this._referencesScale},e}();r.ArcadeExpression=m,r.createDictionaryExpression=y,r.createLabelExpression=p,r.createRendererExpression=d,r.createVVExpression=f,r.loadArcade=u,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
