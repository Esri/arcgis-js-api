/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../core/maybe","../core/promiseUtils","../geometry/SpatialReference","../geometry"],(function(e,r,t,a,i,s){"use strict";let n;async function c(){return n||(n=(async()=>{const r=await new Promise((function(r,t){e(["./arcadeUtils"],r,t)}));return await r.arcade.load(),{arcade:r.arcade,arcadeUtils:r,Dictionary:r.Dictionary,Feature:r.arcadeFeature}})()),n}const o=(e,r,t)=>l.create(e,r,t,null,["$feature","$view"]),u=o;let l=function(){function e(e,r,t,a,i,s,n,c){this.script=e,this.evaluate=i,this.fields=n,this._syntaxTree=a,this._arcade=r,this._arcadeDictionary=t,this._arcadeFeature=s,this._spatialReference=c,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}e.create=async function(r,s,n,o,u,l){const{arcade:f,Feature:p,Dictionary:d}=await c(),y=i.fromJSON(s),h=f.parseScript(r,l),m=u.reduce(((e,r)=>({...e,[r]:null})),{});let _=null;t.isSome(o)&&(_=new d(o),_.immutable=!0,m.$config=null);const F=f.scriptUsesGeometryEngine(h)&&f.enableGeometrySupport(),w=f.scriptUsesFeatureSet(h)&&f.enableFeatureSetSupport(),x=f.scriptIsAsync(h)&&f.enableAsyncSupport(),b={vars:m,spatialReference:y,useAsync:!!x},S=new d;S.immutable=!1,S.setField("scale",0);const v=f.compileScript(h,b);return await a.all([F,w,x]),new e(r,f,d,h,(e=>("$view"in e&&e.$view&&(S.setField("scale",e.$view.scale),e.$view=S),_&&(e.$config=_),v({vars:e,spatialReference:y}))),new p,n,y)};var r=e.prototype;return r.repurposeFeature=function(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature},r.repurposeAdapter=function(e){return this._arcadeFeature.repurposeFromAdapter(e,{fields:this.fields}),this._arcadeFeature},r.createDictionary=function(){return new this._arcadeDictionary},r.referencesMember=function(e){return this._arcade.referencesMember(this._syntaxTree,e)},r.referencesFunction=function(e){return this._arcade.referencesFunction(this._syntaxTree,e)},r.referencesGeometry=function(){return this._referencesGeometry},r.referencesScale=function(){return this._referencesScale},r.extractFieldLiterals=function(e){return this._arcade.extractFieldLiterals(this._syntaxTree,e)},e}();r.ArcadeExpression=l,r.createDictionaryExpression=(e,r,t,a)=>l.create(e,r,t,a,["$feature","$view"]),r.createLabelExpression=(e,r,t)=>l.create(e,r,t,null,["$feature"]),r.createRendererExpression=o,r.createVVExpression=u,r.default=l,r.loadArcade=c,Object.defineProperty(r,"__esModule",{value:!0})}));
