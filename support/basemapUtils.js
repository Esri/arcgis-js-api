/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../core/Logger","../core/accessorSupport/ensureType","../core/urlUtils","../core/Collection","./basemapDefinitions","../Basemap"],(function(e,r,n,a,t,s,l){"use strict";const i=r.getLogger("esri.support.basemapUtils");function o(){return{}}function c(e){for(const r in e){const n=e[r];!1===(null==n?void 0:n.destroyed)&&n.destroy(),delete e[r]}}function u(e,r){var a;let t;if("string"==typeof e){if(!(e in s.esriBasemapDefinitions)){const r=Object.keys(s.esriBasemapDefinitions).map((e=>`"${e}"`)).join(", ");return i.warn(`Unable to find basemap definition for: ${e}. Try one of these: ${r}`),null}r&&(t=r[e]),t||(t=l.fromId(e),r&&(r[e]=t))}else t=n.ensureType(l,e);return null!=(a=t)&&a.destroyed&&(i.warn("The provided basemap is already destroyed",{basemap:t}),t=null),t}function f(e,r=null){const n=u(e);if(!n)return null;const a=new l({id:n.id,title:n.title,baseLayers:n.baseLayers.slice(),referenceLayers:n.referenceLayers.slice()});return r&&(a.baseLayers=m(a.baseLayers,r.baseLayers),a.referenceLayers=m(a.referenceLayers,r.referenceLayers)),a.load().catch((()=>{})),a.portalItem=n.portalItem,a}function y(e){let r=null;const n=h(e),a=!n.baseLayers.length;for(const t in s.esriBasemapDefinitions){const e=w(n,g(s.esriBasemapDefinitions[t]),{mustMatchReferences:a});if("equal"===e){r=t;break}"base-layers-equal"===e&&(r=t)}return r}function p(e,r){if(e===r)return!0;return"equal"===w(h(e),h(r),{mustMatchReferences:!0})}function m(e,r){const n=new t;return e.forEach((e=>{const a=r.find((r=>B(T(e),T(r))))||e;n.some((e=>e===a))?n.push(e):n.push(a)})),n}function b(e){return!(null==e||!e.baseLayers.concat(e.referenceLayers).some(L))}function L(e){if(S(e.url))return!0;if("vector-tile"===e.type)for(const r in e.sourceNameToSource){const n=e.sourceNameToSource[r];if(S(null==n?void 0:n.sourceUrl))return!0}return!1}const d=/^(basemaps|ibasemaps).*-api\.arcgis\.com$/i;function S(e){if(!e)return!1;const r=new a.Url(a.makeAbsolute(e));return d.test(r.authority)}function h(e){return e?!e.loaded&&e.resourceInfo?g(e.resourceInfo.data):{baseLayers:v(e.baseLayers),referenceLayers:v(e.referenceLayers)}:null}function v(e){return(t.isCollection(e)?e.toArray():e).map(T)}function T(e){return{type:e.type,url:D("urlTemplate"in e&&e.urlTemplate||e.url||"styleUrl"in e&&e.styleUrl),minScale:"minScale"in e&&null!=e.minScale?e.minScale:0,maxScale:"maxScale"in e&&null!=e.maxScale?e.maxScale:0,opacity:null!=e.opacity?e.opacity:1,visible:null==e.visible||!!e.visible}}function g(e){return e?{baseLayers:q(e.baseMapLayers.filter((e=>!e.isReference))),referenceLayers:q(e.baseMapLayers.filter((e=>e.isReference)))}:null}function q(e){return e.map((e=>x(e)))}function x(e){let r;switch(e.layerType){case"VectorTileLayer":r="vector-tile";break;case"ArcGISTiledMapServiceLayer":r="tile";break;default:r="unknown"}return{type:r,url:D(e.templateUrl||e.urlTemplate||e.styleUrl||e.url),minScale:null!=e.minScale?e.minScale:0,maxScale:null!=e.maxScale?e.maxScale:0,opacity:null!=e.opacity?e.opacity:1,visible:null==e.visibility||!!e.visibility}}function w(e,r,n){if(null!=e!=(null!=r))return"not-equal";if(!e)return"equal";if(!U(e.baseLayers,r.baseLayers))return"not-equal";return U(e.referenceLayers,r.referenceLayers)?"equal":n.mustMatchReferences?"not-equal":"base-layers-equal"}function U(e,r){if(e.length!==r.length)return!1;for(let n=0;n<e.length;n++)if(!B(e[n],r[n]))return!1;return!0}function B(e,r){return e.type===r.type&&e.url===r.url&&e.minScale===r.minScale&&e.maxScale===r.maxScale&&e.visible===r.visible&&e.opacity===r.opacity}function D(e){return e?a.normalize(e).replace(/^\s*https?:/i,"").toLowerCase():""}e.clonePreservingTiledLayers=f,e.contentEquals=p,e.createCache=o,e.destroyCache=c,e.ensureType=u,e.getWellKnownBasemapId=y,e.hasDeveloperBasemapLayer=b,e.isDeveloperBasemapLayer=L,Object.defineProperty(e,"__esModule",{value:!0})}));
