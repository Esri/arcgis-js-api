/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../core/CircularArray","../core/maybe","./geohashUtils","../geometry/SpatialReference","../layers/graphics/featureConversionUtils","../layers/graphics/OptimizedGeometry","../layers/graphics/data/projectionSupport","../views/2d/layers/features/support/FeatureSetReaderJSON"],(function(t,e,s,n,i,o,a,r,c,l){"use strict";let h=function(){function t(t=[],e,n=8096){this.onRelease=t=>{},this._nodes=0,this._root=new u(this,0,0,0),this._statisticFields=t,this._pool=n?new s(8096):null,this._serviceInfo=e}var i=t.prototype;return i.destroy=function(){this.clear()},i._acquire=function(t,e,s){this._nodes++;let i=null;return n.isSome(this._pool)&&(i=this._pool.dequeue()),n.isSome(i)?i.realloc(t,e,s):i=new u(this,t,e,s),i},i._release=function(t){this.onRelease(t),this._nodes--,n.isSome(this._pool)&&this._pool.enqueue(t)},i.dropLevels=function(t){this.forEach((e=>{if(e.depth>=t)for(let t=0;t<e.children.length;t++){const s=e.children[t];s&&this._release(s)}})),this.forEach((e=>{if(e.depth>=t)for(let t=0;t<e.children.length;t++)e.children[t]=null}))},i.clear=function(){this.forEach((t=>this._release(t))),this._root=new u(this,0,0,0)},i.insert=function(t,e,s=0){const n=l.FeatureSetReaderJSON.fromOptimizedFeatures([t],this._serviceInfo).getCursor();n.next();const i=n.readGeometry();if(!i)return;const[o,a]=i.coords,r=t.geohashX,c=t.geohashY;this.insertCursor(n,t.displayId,o,a,r,c,e,s)},i.insertCursor=function(t,e,s,n,i,o,a,r=0){let c=this._root,l=0,h=0,u=0;for(;null!==c;){if(c.depth>=r&&(c.count+=1,c.xTotal+=s,c.yTotal+=n,c.xGeohashTotal+=i,c.yGeohashTotal+=o,c.referenceId=e,this._updateStatisticsCursor(t,c,1)),l>=a)return void c.add(e);const d=Math.ceil((l+1)/2),f=Math.floor((l+1)/2),x=1-l%2,y=30-(3*d+2*f),g=30-(2*d+3*f),m=(i&7*x+3*(1-x)<<y)>>y,p=(o&3*x+7*(1-x)<<g)>>g,_=m+p*(8*x+4*(1-x));h=h<<3*x+2*(1-x)|m,u=u<<2*x+3*(1-x)|p,null==c.children[_]&&(c.children[_]=this._acquire(h,u,l+1)),l+=1,c=c.children[_]}},i.remove=function(t,e){const s=l.FeatureSetReaderJSON.fromOptimizedFeatures([t],this._serviceInfo).getCursor();s.next();const n=s.readGeometry();if(!n)return;const[i,o]=n.coords,a=t.geohashX,r=t.geohashY;this.removeCursor(s,i,o,a,r,e)},i.removeCursor=function(t,e,s,n,i,o){let a=this._root,r=0;for(;null!==a;){if(a.count-=1,a.xTotal-=e,a.yTotal-=s,a.xGeohashTotal-=n,a.yGeohashTotal-=i,this._updateStatisticsCursor(t,a,-1),r>=o)return void a.remove(t.getDisplayId());const c=Math.ceil((r+1)/2),l=Math.floor((r+1)/2),h=1-r%2,u=30-(3*c+2*l),d=30-(2*c+3*l),f=((n&7*h+3*(1-h)<<u)>>u)+((i&3*h+7*(1-h)<<d)>>d)*(8*h+4*(1-h)),x=a.children[f];1===x?.count&&(this._release(x),a.children[f]=null),r+=1,a=x}},i.forEach=function(t){let e=this._root;for(;null!==e;){const s=this._linkChildren(e)||e.next;t(e),e=s}},i.find=function(t,e,s){return this._root.find(t,e,s,0,0,0)},i.findIf=function(t){let e=null;return this.forEach((s=>{t(s)&&(e=s)})),e},i.findAllIf=function(t){const e=[];return this.forEach((s=>{t(s)&&e.push(s)})),e},i.findSingleOccupancyNode=function(t,e,s,n,i){let o=this._root;for(;null!==o;){const a=o.depth,r=o.xNode,c=o.yNode,l=1-a%2,h=o.xGeohashTotal/o.count,u=o.yGeohashTotal/o.count;if(1===o.count&&t<h&&h<=s&&e<u&&u<=n)return o;if(a>=i){o=o.next;continue}const d=Math.ceil((a+1)/2),f=Math.floor((a+1)/2),x=30-(3*d+2*f),y=30-(2*d+3*f),g=~((1<<x)-1),m=~((1<<y)-1),p=(t&g)>>x,_=(e&m)>>y,v=(s&g)>>x,M=(n&m)>>y,T=r<<3*l+2*(1-l),b=c<<2*l+3*(1-l),k=T+8*l+4*(1-l),N=b+4*l+8*(1-l),S=Math.max(T,p),C=Math.max(b,_),I=Math.min(k,v),G=Math.min(N,M);let L=null,w=null;for(let t=C;t<=G;t++)for(let e=S;e<=I;e++){const s=e-T+(t-b)*(8*l+4*(1-l)),n=o.children[s];n&&(L||(L=n,L.next=o.next),w&&(w.next=n),w=n,n.next=o.next)}o=L||o.next}return null},i.getRegionDisplayIds=function(t){let e=this._root;const{bounds:s,geohashBounds:n,level:i}=t,[o,a,r,c]=s,l=[];for(;null!==e;){const t=e.depth,s=e.xNode,h=e.yNode;if(t>=i){const t=e.xTotal/e.count,s=e.yTotal/e.count;t>=o&&t<=r&&s>=a&&s<=c&&e.displayIds.forEach((t=>l.push(t))),e=e.next;continue}const u=Math.ceil((t+1)/2),d=Math.floor((t+1)/2),f=1-t%2,x=30-(3*u+2*d),y=30-(2*u+3*d),g=~((1<<x)-1),m=~((1<<y)-1),p=(n.xLL&g)>>x,_=(n.yLL&m)>>y,v=(n.xTR&g)>>x,M=(n.yTR&m)>>y,T=s<<3*f+2*(1-f),b=h<<2*f+3*(1-f),k=T+8*f+4*(1-f),N=b+4*f+8*(1-f),S=Math.max(T,p),C=Math.max(b,_),I=Math.min(k,v),G=Math.min(N,M);let L=null,w=null;for(let n=C;n<=G;n++)for(let t=S;t<=I;t++){const s=t-T+(n-b)*(8*f+4*(1-f)),i=e.children[s];i&&(L||(L=i,L.next=e.next),w&&(w.next=i),w=i,i.next=e.next)}e=L||e.next}return l},i.getRegionStatistics=function(t){let e=this._root,s=0,n=0,i=0;const o={},{bounds:a,geohashBounds:r,level:c}=t,[l,h,u,d]=a;let f=0;for(;null!==e;){const t=e.depth,a=e.xNode,x=e.yNode;if(t>=c){const t=e.xTotal/e.count,a=e.yTotal/e.count;t>l&&t<=u&&a>h&&a<=d&&(s+=e.count,n+=e.xTotal,i+=e.yTotal,1===e.count&&(f=e.referenceId),this._aggregateStatistics(o,e.statistics)),e=e.next;continue}const y=Math.ceil((t+1)/2),g=Math.floor((t+1)/2),m=1-t%2,p=30-(3*y+2*g),_=30-(2*y+3*g),v=~((1<<p)-1),M=~((1<<_)-1),T=(r.xLL&v)>>p,b=(r.yLL&M)>>_,k=(r.xTR&v)>>p,N=(r.yTR&M)>>_,S=a<<3*m+2*(1-m),C=x<<2*m+3*(1-m),I=S+8*m+4*(1-m),G=C+4*m+8*(1-m),L=Math.max(S,T),w=Math.max(C,b),F=Math.min(I,k),R=Math.min(G,N);let z=null,O=null;for(let r=w;r<=R;r++)for(let t=L;t<=F;t++){const a=t-S+(r-C)*(8*m+4*(1-m)),c=e.children[a];if(c){if(r!==w&&r!==R&&t!==L&&t!==F){const t=c.xTotal/c.count,e=c.yTotal/c.count;t>l&&t<=u&&e>h&&e<=d&&(s+=c.count,n+=c.xTotal,i+=c.yTotal,1===c.count&&(f=c.referenceId),this._aggregateStatistics(o,c.statistics));continue}z||(z=c,z.next=e.next),O&&(O.next=c),O=c,c.next=e.next}}e=z||e.next}return{count:s,attributes:this.normalizeStatistics(o,s),xTotal:n,yTotal:i,referenceId:f}},i.getBins=function(t){const e=[],{geohashBounds:s,level:n}=t;let i=this._root;for(;null!==i;){const t=i.depth,o=i.xNode,a=i.yNode;if(t>=n){e.push(i),i=i.next;continue}const r=Math.ceil((t+1)/2),c=Math.floor((t+1)/2),l=1-t%2,h=30-(3*r+2*c),u=30-(2*r+3*c),d=~((1<<h)-1),f=~((1<<u)-1),x=(s.xLL&d)>>h,y=(s.yLL&f)>>u,g=(s.xTR&d)>>h,m=(s.yTR&f)>>u,p=o<<3*l+2*(1-l),_=a<<2*l+3*(1-l),v=p+8*l+4*(1-l),M=_+4*l+8*(1-l),T=Math.max(p,x),b=Math.max(_,y),k=Math.min(v,g),N=Math.min(M,m);let S=null,C=null;for(let e=b;e<=N;e++)for(let t=T;t<=k;t++){const s=t-p+(e-_)*(8*l+4*(1-l)),n=i.children[s];n&&(S||(S=n,S.next=i.next),C&&(C.next=n),C=n,n.next=i.next)}i=S||i.next}return e},i._linkChildren=function(t){let e=null,s=null;for(let n=0;n<=t.children.length;n++){const i=t.children[n];i&&(e||(e=i,e.next=t.next),s&&(s.next=i),s=i,i.next=t.next)}return e},i._updateStatisticsCursor=function(t,e,s){for(const n of this._statisticFields){const i=n.name,o=n.inField?t.readAttribute(n.inField):t.getComputedNumericAtIndex(n.inFieldIndex);switch(n.statisticType){case"min":{if(isNaN(o))break;if(!e.statistics[i]){e.statistics[i]={value:o};break}const t=e.statistics[i].value;e.statistics[i].value=Math.min(t,o);break}case"max":{if(isNaN(o))break;if(!e.statistics[i]){e.statistics[i]={value:o};break}const t=e.statistics[i].value;e.statistics[i].value=Math.max(t,o);break}case"count":break;case"sum":case"avg":{e.statistics[i]||(e.statistics[i]={value:0,nanCount:0});const t=e.statistics[i].value,n=e.statistics[i].nanCount??0;null==o||isNaN(o)?e.statistics[i].nanCount=n+s:e.statistics[i].value=t+s*o;break}case"avg_angle":{e.statistics[i]||(e.statistics[i]={x:0,y:0,nanCount:0});const t=e.statistics[i].x,n=e.statistics[i].y,a=e.statistics[i].nanCount??0,r=Math.PI/180;null==o||isNaN(o)?e.statistics[i].nanCount=a+s:(e.statistics[i].x=t+s*Math.cos(o*r),e.statistics[i].y=n+s*Math.sin(o*r));break}case"mode":{e.statistics[i]||(e.statistics[i]={});const t=e.statistics[i][o]||0;e.statistics[i][o]=t+s;break}}}},i._aggregateStatistics=function(t,e){for(const s of this._statisticFields){const n=s.name;switch(s.statisticType){case"min":{if(!t[n]){t[n]={value:e[n].value};break}const s=t[n].value;t[n].value=Math.min(s,e[n].value);break}case"max":{if(!t[n]){t[n]={value:e[n].value};break}const s=t[n].value;t[n].value=Math.max(s,e[n].value);break}case"count":break;case"sum":case"avg":case"avg_angle":case"mode":t[n]||(t[n]={});for(const s in e[n]){const i=t[n][s]||0;t[n][s]=i+e[n][s]}}}},i.normalizeStatistics=function(t,e){const s={};for(const n of this._statisticFields){const i=n.name;switch(n.statisticType){case"min":case"max":{const n=t[i];if(!e||!n)break;s[i]=n.value;break}case"count":if(!e)break;s[i]=e;break;case"sum":{if(!e)break;const{value:n,nanCount:o}=t[i];if(!(e-o))break;s[i]=n;break}case"avg":{if(!e)break;const{value:n,nanCount:o}=t[i];if(!(e-o))break;s[i]=n/(e-o);break}case"avg_angle":{if(!e)break;const{x:n,y:o,nanCount:a}=t[i];if(!(e-a))break;const r=n/(e-a),c=o/(e-a),l=180/Math.PI,h=Math.atan2(c,r)*l;s[i]=h;break}case"mode":{const e=t[i];let n=0,o=0,a=null;for(const t in e){const s=e[t];s===n?o+=1:s>n&&(n=s,o=1,a=t)}s[i]="null"===a||o>1?null:a;break}}}return s},e._createClass(t,[{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return n.mapOr(this._pool,0,(t=>t.size))}},{key:"depth",get:function(){let t=0;return this.forEach((e=>t=Math.max(t,e.depth))),t}}]),t}(),u=function(){function t(t,e,s,n){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=t,this.children=new Array(32);for(let i=0;i<this.children.length;i++)this.children[i]=null;this.xNode=e,this.yNode=s,this.depth=n}var s=t.prototype;return s.realloc=function(t,e,s){for(let n=0;n<this.children.length;n++)this.children[n]=null;return this.xNode=t,this.yNode=e,this.depth=s,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this},s.add=function(t){this.displayIds.add(t)},s.remove=function(t){this.displayIds.delete(t)},s.getAttributes=function(){const t=this._tree.normalizeStatistics(this.statistics,this.count);return t.referenceId=null,t.aggregateId=this.id,t.aggregateCount=this.count,t},s.getGeometry=function(t,e){const s=this.getLngLatBounds(),[i,l,h,u]=s,d={rings:[[[i,l],[i,u],[h,u],[h,l],[i,l]]]},f=c.project(d,o.WGS84,t),x=a.convertFromPolygon(new r,f,!1,!1);if(n.isSome(e)){return a.quantizeOptimizedGeometry(new r,x,!1,!1,"esriGeometryPolygon",e,!1,!1)}return x},s.getGeometryCentroid=function(t,e){const s=this.getLngLatBounds(),[i,l,h,u]=s,d={x:(i+h)/2,y:(l+u)/2},f=c.project(d,o.WGS84,t),x=a.convertFromPoint(new r,f);if(n.isSome(e)){return a.quantizeOptimizedGeometry(new r,x,!1,!1,"esriGeometryPoint",e,!1,!1)}return x},s.getLngLatBounds=function(){const t=this.depth,e=Math.ceil(t/2),s=Math.floor(t/2),n=30-(3*e+2*s),o=30-(2*e+3*s),a=this.xNode<<n,r=this.yNode<<o;return i.decodeGeohashXY({geohashX:a,geohashY:r},this.depth)},s.find=function(t,e,s,n,i,o){if(n>=s)return this;const a=1-n%2,r=3*a+2*(1-a),c=2*a+3*(1-a),l=30-i-r,h=30-o-c,u=((t&7*a+3*(1-a)<<l)>>l)+((e&3*a+7*(1-a)<<h)>>h)*(8*a+4*(1-a)),d=this.children[u];return null==d?null:d.find(t,e,s,n+1,i+r,o+c)},e._createClass(t,[{key:"id",get:function(){return`${this.xNode}.${this.yNode}`}}]),t}();t.GeohashNode=u,t.GeohashTree=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
