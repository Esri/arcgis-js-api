// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],(function(t,i,a,s,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.GeohashTree=void 0;var o=function(){function t(t,i,s){void 0===s&&(s=8096),this._nodes=0,this._root=new n(0,0,0),this._fields=t,this._statisticFields=i,this._pool=s?new a.default(8096):null}return t.prototype._acquire=function(t,i,a){this._nodes++;var e=null;return s.isSome(this._pool)&&(e=this._pool.dequeue()),s.isSome(e)?e.realloc(t,i,a):new n(t,i,a)},t.prototype._release=function(t){this._nodes--,s.isSome(this._pool)&&this._pool.enqueue(t)},Object.defineProperty(t.prototype,"count",{get:function(){return this._root.count},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._nodes},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"poolSize",{get:function(){return s.mapOr(this._pool,0,(function(t){return t.size}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){var t=0;return this._forEachNode((function(i){return t=Math.max(t,i.depth)})),t},enumerable:!1,configurable:!0}),t.prototype.dropLevels=function(t){var i=this;this._forEachNode((function(a){if(a.depth>=t)for(var s=0;s<a.children.length;s++){var e=a.children[s];a.children[s]=null,e&&i._release(e)}}))},t.prototype.clear=function(){this.dropLevels(0)},t.prototype.insert=function(t,i,a){void 0===a&&(a=0);for(var s=this._root,e=0,o=0,n=0;null!==s;){if(s.depth>=a&&(s.count+=1,s.xTotal+=t.geometry.coords[0],s.yTotal+=t.geometry.coords[1],s.xGeohashTotal+=t.geohashX,s.yGeohashTotal+=t.geohashY,s.displayId=t.displayId,this._updateStatistics(t,s,1)),e>=i)return;var r=Math.ceil((e+1)/2),l=Math.floor((e+1)/2),c=1-e%2,h=30-(3*r+2*l),u=30-(2*r+3*l),d=7*c+3*(1-c)<<h,f=3*c+7*(1-c)<<u,p=8*c+4*(1-c),v=(t.geohashX&d)>>h,y=(t.geohashY&f)>>u,x=v+y*p;o=o<<3*c+2*(1-c)|v,n=n<<2*c+3*(1-c)|y,null==s.children[x]&&(s.children[x]=this._acquire(o,n,e+1)),e+=1,s=s.children[x]}},t.prototype.insertCursor=function(t,i,a,s,e,o,n,r){void 0===r&&(r=0);for(var l=this._root,c=0,h=0,u=0;null!==l;){if(l.depth>=r&&(l.count+=1,l.xTotal+=a,l.yTotal+=s,l.xGeohashTotal+=e,l.yGeohashTotal+=o,l.displayId=i,this._updateStatisticsCursor(t,l,1)),c>=n)return;var d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),p=1-c%2,v=30-(3*d+2*f),y=30-(2*d+3*f),x=(e&7*p+3*(1-p)<<v)>>v,g=(o&3*p+7*(1-p)<<y)>>y,_=x+g*(8*p+4*(1-p));h=h<<3*p+2*(1-p)|x,u=u<<2*p+3*(1-p)|g,null==l.children[_]&&(l.children[_]=this._acquire(h,u,c+1)),c+=1,l=l.children[_]}},t.prototype.remove=function(t,i){for(var a=this._root,s=0;null!==a;){if(a.count-=1,a.xTotal-=t.geometry.coords[0],a.yTotal-=t.geometry.coords[1],a.xGeohashTotal-=t.geohashX,a.yGeohashTotal-=t.geohashY,this._updateStatistics(t,a,-1),s>=i)return;var e=Math.ceil((s+1)/2),o=Math.floor((s+1)/2),n=1-s%2,r=30-(3*e+2*o),l=30-(2*e+3*o),c=7*n+3*(1-n)<<r,h=3*n+7*(1-n)<<l,u=8*n+4*(1-n),d=((t.geohashX&c)>>r)+((t.geohashY&h)>>l)*u,f=a.children[d];1===f.count&&(this._release(f),a.children[d]=null),s+=1,a=f}},t.prototype.removeCursor=function(t,i,a,s,e,o){for(var n=this._root,r=0;null!==n;){if(n.count-=1,n.xTotal-=i,n.yTotal-=a,n.xGeohashTotal-=s,n.yGeohashTotal-=e,this._updateStatisticsCursor(t,n,-1),r>=o)return;var l=Math.ceil((r+1)/2),c=Math.floor((r+1)/2),h=1-r%2,u=30-(3*l+2*c),d=30-(2*l+3*c),f=((s&7*h+3*(1-h)<<u)>>u)+((e&3*h+7*(1-h)<<d)>>d)*(8*h+4*(1-h)),p=n.children[f];1===p.count&&(this._release(p),n.children[f]=null),r+=1,n=p}},t.prototype.find=function(t,i,a){return this._root.find(t,i,a,0,0,0)},t.prototype.findSingleOccupancyNode=function(t,i,a,s,e){for(var o=this._root;null!==o;){var n=o.depth,r=o.xNode,l=o.yNode,c=1-n%2,h=o.xGeohashTotal/o.count,u=o.yGeohashTotal/o.count;if(1===o.count&&t<h&&h<=a&&i<u&&u<=s)return o;if(n>=e)o=o.next;else{for(var d=Math.ceil((n+1)/2),f=Math.floor((n+1)/2),p=30-(3*d+2*f),v=30-(2*d+3*f),y=~((1<<p)-1),x=~((1<<v)-1),g=(t&y)>>p,_=(i&x)>>v,m=(a&y)>>p,N=(s&x)>>v,T=r<<3*c+2*(1-c),b=l<<2*c+3*(1-c),S=T+8*c+4*(1-c),M=b+4*c+8*(1-c),C=Math.max(T,g),G=Math.max(b,_),k=Math.min(S,m),F=Math.min(M,N),z=null,I=null,w=G;w<=F;w++)for(var P=C;P<=k;P++){var O=P-T+(w-b)*(8*c+4*(1-c)),q=o.children[O];q&&(z||((z=q).next=o.next),I&&(I.next=q),I=q,q.next=o.next)}o=z||o.next}}return null},t.prototype.getRegionStatistics=function(t,i,a,s,e){for(var o=this._root,n=0,r=0,l=0,c={},h=0;null!==o;){var u=o.depth,d=o.xNode,f=o.yNode;if(u>=e){var p=o.xGeohashTotal/o.count,v=o.yGeohashTotal/o.count;t<p&&p<=a&&i<v&&v<=s&&(n+=o.count,r+=o.xTotal,l+=o.yTotal,1===o.count&&(h=o.displayId),this._aggregateStatistics(c,o.statistics)),o=o.next}else{for(var y=Math.ceil((u+1)/2),x=Math.floor((u+1)/2),g=1-u%2,_=30-(3*y+2*x),m=30-(2*y+3*x),N=~((1<<_)-1),T=~((1<<m)-1),b=(t&N)>>_,S=(i&T)>>m,M=(a&N)>>_,C=(s&T)>>m,G=d<<3*g+2*(1-g),k=f<<2*g+3*(1-g),F=G+8*g+4*(1-g),z=k+4*g+8*(1-g),I=Math.max(G,b),w=Math.max(k,S),P=Math.min(F,M),O=Math.min(z,C),q=null,X=null,Y=w;Y<=O;Y++)for(var j=I;j<=P;j++){var A=j-G+(Y-k)*(8*g+4*(1-g)),L=o.children[A];if(L){if(Y!==w&&Y!==O&&j!==I&&j!==P){p=L.xGeohashTotal/L.count,v=L.yGeohashTotal/L.count;t<p&&p<=a&&i<v&&v<=s&&(n+=L.count,r+=L.xTotal,l+=L.yTotal,1===L.count&&(h=L.displayId),this._aggregateStatistics(c,L.statistics));continue}q||((q=L).next=o.next),X&&(X.next=L),X=L,L.next=o.next}}o=q||o.next}}return{count:n,attributes:this._normalizeStatistics(c,n),xTotal:r,yTotal:l,referenceId:h}},t.prototype._forEachNode=function(t){for(var i=this._root;null!==i;){var a=this._linkChildren(i)||i.next;t(i),i=a}},t.prototype._linkChildren=function(t){for(var i=null,a=null,s=0;s<=t.children.length;s++){var e=t.children[s];e&&(i||((i=e).next=t.next),a&&(a.next=e),a=e,e.next=t.next)}return i},t.prototype._updateStatistics=function(t,i,a){for(var s=0,e=this._fields;s<e.length;s++){var o=e[s],n=o.name,r=o.outStatistic.onStatisticField,l=t.attributes[r];switch(o.outStatistic.statisticType){case"norm":i.statistics[n]||(i.statistics[n]={});var c=o.outStatistic.onStatisticNormalizationField,h=t.attributes[c],u=i.statistics[n].onStatisticField||0,d=i.statistics[n].onStatisticNormalizationField||0;null==l||isNaN(l)||null==h||0===h||isNaN(h)||(i.statistics[n].onStatisticField=u+a*l,i.statistics[n].onStatisticNormalizationField=d+a*h);break;case"sum":case"avg":i.statistics[n]||(i.statistics[n]={value:0,nanCount:0});var f=i.statistics[n].value,p=i.statistics[n].nanCount;null==l||isNaN(l)?i.statistics[n].nanCount=p+a:i.statistics[n].value=f+a*l;break;case"avg_angle":i.statistics[n]||(i.statistics[n]={x:0,y:0,nanCount:0});var v=i.statistics[n].x,y=i.statistics[n].y,x=(p=i.statistics[n].nanCount,Math.PI/180);null==l||isNaN(l)?i.statistics[n].nanCount=p+a:(i.statistics[n].x=v+a*Math.cos(l*x),i.statistics[n].y=y+a*Math.sin(l*x));break;case"mode":i.statistics[n]||(i.statistics[n]={});f=i.statistics[n][l]||0;i.statistics[n][l]=f+a}}},t.prototype._updateStatisticsCursor=function(t,i,a){for(var s=0,e=this._statisticFields;s<e.length;s++){var o=e[s],n=o.name,r=o.inField?t.readAttribute(o.inField):t.getComputedNumericAtIndex(o.inFieldIndex);switch(o.statisticType){case"norm":i.statistics[n]||(i.statistics[n]={});var l=o.inNormalizationField,c=t.readAttribute(l),h=i.statistics[n].onStatisticField||0,u=i.statistics[n].onStatisticNormalizationField||0;null==r||isNaN(r)||null==c||0===c||isNaN(c)||(i.statistics[n].onStatisticField=h+a*r,i.statistics[n].onStatisticNormalizationField=u+a*c);break;case"sum":case"avg":i.statistics[n]||(i.statistics[n]={value:0,nanCount:0});var d=i.statistics[n].value,f=i.statistics[n].nanCount;null==r||isNaN(r)?i.statistics[n].nanCount=f+a:i.statistics[n].value=d+a*r;break;case"avg_angle":i.statistics[n]||(i.statistics[n]={x:0,y:0,nanCount:0});var p=i.statistics[n].x,v=i.statistics[n].y,y=(f=i.statistics[n].nanCount,Math.PI/180);null==r||isNaN(r)?i.statistics[n].nanCount=f+a:(i.statistics[n].x=p+a*Math.cos(r*y),i.statistics[n].y=v+a*Math.sin(r*y));break;case"mode":i.statistics[n]||(i.statistics[n]={});d=i.statistics[n][r]||0;i.statistics[n][r]=d+a}}},t.prototype._aggregateStatistics=function(t,i){for(var a=0,s=this._fields;a<s.length;a++){var e=s[a],o=e.name;switch(e.outStatistic.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var n in t[o]||(t[o]={}),i[o]){var r=t[o][n]||0;t[o][n]=r+i[o][n]}}}},t.prototype._normalizeStatistics=function(t,i){for(var a={},s=0,e=this._fields;s<e.length;s++){var o=e[s],n=o.name;switch(o.outStatistic.statisticType){case"norm":var r=t[n];if(i&&null==r.onStatisticNormalizationField)break;if(i&&r.onStatisticNormalizationField){a[n]=r.onStatisticField/r.onStatisticNormalizationField;break}a[n]=0;break;case"sum":if(!i)break;var l=t[n],c=l.value;if(!(i-(u=l.nanCount)))break;a[n]=c;break;case"avg":if(!i)break;var h=t[n];c=h.value;if(!(i-(u=h.nanCount)))break;a[n]=c/(i-u);break;case"avg_angle":if(!i)break;var u,d=t[n],f=d.x,p=d.y;if(!(i-(u=d.nanCount)))break;var v=f/(i-u),y=p/(i-u),x=180/Math.PI,g=Math.atan2(y,v)*x;a[n]=g;break;case"mode":var _=t[n],m=0,N=null;for(var T in _){var b=_[T];b>m&&(m=b,N=T)}a[n]="null"===N?null:N}}return a},t}();i.GeohashTree=o;var n=function(){function t(t,i,a){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var s=0;s<this.children.length;s++)this.children[s]=null;this.xNode=t,this.yNode=i,this.depth=a}return t.prototype.realloc=function(t,i,a){for(var s=0;s<this.children.length;s++)this.children[s]=null;return this.xNode=t,this.yNode=i,this.depth=a,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this},t.prototype.getLngLatBounds=function(){var t=this.depth,i=Math.ceil(t/2),a=Math.floor(t/2),s=30-(3*i+2*a),o=30-(2*i+3*a),n=this.xNode<<s,r=this.yNode<<o;return e.decodeGeohashXY({geohashX:n,geohashY:r},this.depth)},t.prototype.find=function(t,i,a,s,e,o){if(s>=a)return this;var n=1-s%2,r=3*n+2*(1-n),l=2*n+3*(1-n),c=30-e-r,h=30-o-l,u=((t&7*n+3*(1-n)<<c)>>c)+((i&3*n+7*(1-n)<<h)>>h)*(8*n+4*(1-n)),d=this.children[u];return null==d?null:d.find(t,i,a,s+1,e+r,o+l)},t}()}));