/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["require","./chunks/_rollupPluginBabelHelpers","./chunks/tslib.es6","./Color","./core/Collection","./core/collectionUtils","./core/compilerUtils","./core/Error","./core/JSONSupport","./core/lang","./core/Loadable","./core/loadAll","./core/Logger","./core/promiseUtils","./core/accessorSupport/decorators/property","./core/accessorSupport/ensureType","./core/has","./core/accessorSupport/decorators/subclass","./core/accessorSupport/decorators/writer","./ground/NavigationConstraint","./webdoc/support/opacityUtils"],(function(e,r,t,o,n,a,s,i,l,c,u,p,y,d,f,h,v,g,_,m,w){"use strict";var I;const C=y.getLogger("esri.Ground");let S=I=function(t){function o(e){var o;(o=t.call(this,e)||this).opacity=1,o.surfaceColor=null,o.navigationConstraint=null,o.layers=new n;const a=e=>{e.parent&&e.parent!==r._assertThisInitialized(o)&&"remove"in e.parent&&e.parent.remove(e),e.parent=r._assertThisInitialized(o),"elevation"!==e.type&&"base-elevation"!==e.type&&C.error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},s=e=>{e.parent=null};return o.layers.on("after-add",(e=>a(e.item))),o.layers.on("after-remove",(e=>s(e.item))),o}r._inheritsLoose(o,t);var l=o.prototype;return l.initialize=function(){this.when().catch((e=>{C.error("#load()","Failed to load ground",e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)},l.destroy=function(){const e=this.layers.removeAll();for(const r of e)r.destroy();this.layers.destroy()},l.normalizeCtorArgs=function(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e},l.writeLayers=function(e,r,t,o){const n=[];e?(o={...o,layerContainerType:"ground"},e.forEach((e=>{if("write"in e){const r={};s.typeCast(e)().write(r,o)&&n.push(r)}else o&&o.messages&&o.messages.push(new i("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in the ground`,{layer:e}))})),r.layers=n):r.layers=n},l.load=function(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)},l.loadAll=function(){return p.loadAll(this,(e=>{e(this.layers)}))},l.queryElevation=function(){var t=r._asyncToGenerator((function*(r,t){yield this.load({signal:null==t?void 0:t.signal});const{ElevationQuery:o}=yield new Promise((function(r,t){e(["./layers/support/ElevationQuery"],r,t)}));d.throwIfAborted(t);const n=new o,a=this.layers.filter(b).toArray();return n.queryAll(a,r,t)}));function o(e,r){return t.apply(this,arguments)}return o}(),l.createElevationSampler=function(){var t=r._asyncToGenerator((function*(r,t){yield this.load({signal:null==t?void 0:t.signal});const{ElevationQuery:o}=yield new Promise((function(r,t){e(["./layers/support/ElevationQuery"],r,t)}));d.throwIfAborted(t);const n=new o,a=this.layers.filter(b).toArray();return n.createSamplerAll(a,r,t)}));function o(e,r){return t.apply(this,arguments)}return o}(),l.clone=function(){const e={opacity:this.opacity,surfaceColor:c.clone(this.surfaceColor),navigationConstraint:c.clone(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new I({resourceInfo:this.resourceInfo}).set(e)},l.read=function(e,r){this.resourceInfo||this._set("resourceInfo",{data:e,context:r}),t.prototype.read.call(this,e,r)},l._loadFromSource=function(e){const r=this.resourceInfo;return r?this._loadLayersFromJSON(r.data,r.context,e):Promise.resolve(null)},l._loadLayersFromJSON=function(r,t,o){const n=t&&t.origin||"web-scene",a=t&&t.portal||null,s=t&&t.url||null;return new Promise((function(r,t){e(["./layers/support/layersCreator"],r,t)})).then((({populateOperationalLayers:e})=>{d.throwIfAborted(o);const t=[];if(r.layers&&Array.isArray(r.layers)){const o={context:{origin:n,url:s,portal:a,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};t.push(e(this.layers,r.layers,o))}return d.eachAlways(t)})).then((()=>{}))},r._createClass(o,[{key:"layers",set:function(e){this._set("layers",a.referenceSetter(e,this._get("layers")))}}]),o}(l.JSONSupportMixin(u));function A(e){return e&&"createElevationSampler"in e}function b(e){return"elevation"===e.type||A(e)}return t.__decorate([f.property({json:{read:!1}})],S.prototype,"layers",null),t.__decorate([_.writer("layers")],S.prototype,"writeLayers",null),t.__decorate([f.property({readOnly:!0})],S.prototype,"resourceInfo",void 0),t.__decorate([f.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:h.Integer,read:{reader:w.transparencyToOpacity,source:"transparency"},write:{writer:(e,r)=>{r.transparency=w.opacityToTransparency(e)},target:"transparency"}}})],S.prototype,"opacity",void 0),t.__decorate([f.property({type:o,json:{type:[h.Integer],write:(e,r)=>{r.surfaceColor=e.toJSON().slice(0,3)}}})],S.prototype,"surfaceColor",void 0),t.__decorate([f.property({type:m.NavigationConstraint,json:{write:!0}})],S.prototype,"navigationConstraint",void 0),S=I=t.__decorate([g.subclass("esri.Ground")],S),S}));
