// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","./Color","./core/Collection","./core/collectionUtils","./core/compilerUtils","./core/Error","./core/JSONSupport","./core/lang","./core/Loadable","./core/loadAll","./core/Logger","./core/promiseUtils","./core/accessorSupport/decorators","./core/accessorSupport/ensureType","./ground/NavigationConstraint","./webdoc/support/opacityUtils","@dojo/framework/shim/Promise"],(function(e,r,t,o,n,a,i,s,l,p,c,u,y,d,f,h,v,g){"use strict";var _=y.getLogger("esri.Ground");function m(e){return"elevation"===e.type||function(e){return e&&"createElevationSampler"in e}(e)}return(function(r){function l(e){var t=r.call(this,e)||this;t.opacity=1,t.surfaceColor=null,t.navigationConstraint=null,t.layers=new n;return t.layers.on("after-add",(function(e){return(r=e.item).parent&&r.parent!==t&&"remove"in r.parent&&r.parent.remove(r),r.parent=t,void("elevation"!==r.type&&"base-elevation"!==r.type&&_.error("Layer '"+r.title+", id:"+r.id+"' of type '"+r.type+"' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported."));var r})),t.layers.on("after-remove",(function(e){e.item.parent=null})),t}var c;return t.__extends(l,r),c=l,l.prototype.initialize=function(){this.when().catch((function(e){_.error("#load()","Failed to load ground",e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)},l.prototype.destroy=function(){for(var e=0,r=this.layers.removeAll();e<r.length;e++){r[e].destroy()}this.layers.destroy()},l.prototype.normalizeCtorArgs=function(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=t.__assign({},e)).resourceInfo),e},Object.defineProperty(l.prototype,"layers",{set:function(e){this._set("layers",a.referenceSetter(e,this._get("layers")))},enumerable:!1,configurable:!0}),l.prototype.writeLayers=function(e,r,o,n){var a=[];e?(n=t.__assign(t.__assign({},n),{layerContainerType:"ground"}),e.forEach((function(e){if("write"in e){var r={};i.typeCast(e)().write(r,n)&&a.push(r)}else n&&n.messages&&n.messages.push(new s("layer:unsupported","Layers ("+e.title+", "+e.id+") of type '"+e.declaredClass+"' cannot be persisted in the ground",{layer:e}))})),r.layers=a):r.layers=a},l.prototype.load=function(e){return this.addResolvingPromise(this._loadFromSource(e)),d.resolve(this)},l.prototype.loadAll=function(){var e=this;return u.loadAll(this,(function(r){r(e.layers)}))},l.prototype.queryElevation=function(e,r){var t=this;return this.load().then((function(){return t._importElevationQuery()})).then((function(o){var n=new o.ElevationQuery,a=t.layers.filter(m).toArray();return n.queryAll(a,e,r)}))},l.prototype.createElevationSampler=function(e,r){var t=this.layers.filter(m).toArray();return 1===t.length?t[0].createElevationSampler(e,r):this._importElevationQuery().then((function(o){return(new o.ElevationQuery).createSamplerAll(t,e,r)}))},l.prototype.clone=function(){var e={opacity:this.opacity,surfaceColor:p.clone(this.surfaceColor),navigationConstraint:p.clone(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new c({resourceInfo:this.resourceInfo}).set(e)},l.prototype.read=function(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),r.prototype.read.call(this,e,t)},l.prototype._loadFromSource=function(e){var r=this.resourceInfo;return r?this._loadLayersFromJSON(r.data,r.context,e):d.resolve(null)},l.prototype._loadLayersFromJSON=function(r,t,o){var n=this,a=t&&t.origin||"web-scene",i=t&&t.portal||null,s=t&&t.url||null;return new Promise((function(r,t){e(["./portal/support/layersCreator"],r,t)})).then((function(e){d.throwIfAborted(o);var t=[];if(r.layers&&Array.isArray(r.layers)){var l={context:{origin:a,url:s,portal:i,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};t.push(e.populateOperationalLayers(n.layers,r.layers,l))}return d.eachAlways(t)})).then((function(){}))},l.prototype._importElevationQuery=function(){return new Promise((function(r,t){e(["./layers/support/ElevationQuery"],r,t)}))},t.__decorate([f.property({json:{read:!1}})],l.prototype,"layers",null),t.__decorate([f.writer("layers")],l.prototype,"writeLayers",null),t.__decorate([f.property({readOnly:!0})],l.prototype,"resourceInfo",void 0),t.__decorate([f.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:h.Integer,read:{reader:g.transparencyToOpacity,source:"transparency"},write:{writer:function(e,r){r.transparency=g.opacityToTransparency(e)},target:"transparency"}}})],l.prototype,"opacity",void 0),t.__decorate([f.property({type:o,json:{type:[h.Integer],write:function(e,r){r.surfaceColor=e.toJSON().slice(0,3)}}})],l.prototype,"surfaceColor",void 0),t.__decorate([f.property({type:v.NavigationConstraint,json:{write:!0}})],l.prototype,"navigationConstraint",void 0),l=c=t.__decorate([f.subclass("esri.Ground")],l)}(l.JSONSupportMixin(c)))}));