// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","./CIMCursor","./CurveHelper"],(function(t,e,s,n,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GeometryWalker=e.DashPattern=void 0;var r=function(){function t(){this._values=[],this.extPtGap=0,this.ctrlPtGap=0,this._length=0,this._currentValue=0}return t.prototype.isEmpty=function(){return 0===this._values.length},t.prototype.size=function(){return this._values.length},t.prototype.init=function(t,e,s){if(void 0===s&&(s=!0),this._setEmpty(),!t||0===t.length)return!1;for(var n=0;n<t.length;n++){var i=Math.abs(t[n]);s&&i<1e-7&&(i=1e-7),this._values.push(i),this._length+=i}return e&&1&t.length&&(this._length*=2),0!==this._length&&(this.ctrlPtGap=this.extPtGap=0,this._currentValue=-1,!0)},t.prototype.scale=function(t){for(var e=this._values?this._values.length:0,s=0;s<e;++s)this._values[s]*=t;this._length*=t,this.extPtGap*=t,this.ctrlPtGap*=t},t.prototype.addValue=function(t){this._length+=t,this._values.push(t)},t.prototype.firstValue=function(){return this._values[0]},t.prototype.lastValue=function(){return this._values[this._values.length-1]},t.prototype.nextValue=function(){return this._currentValue++,this._currentValue===this._values.length&&(this._currentValue=0),this._values[this._currentValue]},t.prototype.reset=function(){this._currentValue=-1},t.prototype.length=function(){return this._length},t.prototype._setEmpty=function(){this.extPtGap=this.ctrlPtGap=this._length=0,this._currentValue=-1,this._values.length=0},t}();e.DashPattern=r;var h=function(){function t(){this.reset()}return t.prototype.reset=function(){this.segment=-1,this.segmentLength=0,this.abscissa=0,this.isPathEnd=!1,this.isPartEnd=!1},t.prototype.isValid=function(){return-1!==this.segment},t.prototype.copyTo=function(t){t.segment=this.segment,t.segmentLength=this.segmentLength,t.abscissa=this.abscissa,t.isPathEnd=this.isPathEnd,t.isPartEnd=this.isPartEnd},t}(),o=function(t){function e(e,s){void 0===e&&(e=0),void 0===s&&(s=!1);var n=t.call(this,e,s)||this;return n._tolerance=i.PIXEL_TOLERANCE,n._currentPosition=new h,n}return s.__extends(e,t),e.prototype.updateTolerance=function(t){this._tolerance=i.PIXEL_TOLERANCE*t},e.prototype.init=function(t,e,s){return void 0===s&&(s=!0),s?(this._patternLength=e.length(),this._partExtPtGap=e.extPtGap,this._partCtrlPtGap=e.ctrlPtGap):(this._patternLength=0,this._partExtPtGap=0,this._partCtrlPtGap=0),this._currentPosition.reset(),this._partSegCount=0,this._path=t,this._seg=-1,this.setPosAtNextPart()},e.prototype.curPositionIsValid=function(){return this._currentPosition.isValid()},e.prototype.nextPosition=function(t,e){void 0===e&&(e=0);var s=new h;return!!this._nextPosition(t,s,null,e)&&(s.copyTo(this._currentPosition),!0)},e.prototype.curPointAndAngle=function(t){t.pt=this._getPoint(this._currentPosition);var e=this._getAngle(this._currentPosition),s=e[0],n=e[1];t.ca=s,t.sa=n},e.prototype.nextPointAndAngle=function(t,e,s){void 0===s&&(s=0);var n=new h;if(!this._nextPosition(t,n,null,s))return!1;n.copyTo(this._currentPosition),e.pt=this._getPoint(n);var i=this._getAngle(n),r=i[0],o=i[1];return e.ca=r,e.sa=o,!0},e.prototype.nextCurve=function(t){if(0===t)return null;var e=[],s=new h;return this._nextPosition(t,s,e,1)?(s.copyTo(this._currentPosition),e):null},e.prototype.isPathEnd=function(){return this._currentPosition.isPathEnd},e.prototype.getPathEnd=function(){if(-1===this._currentPosition.segment)throw new Error("missing segment");return this._path[this._currentPosition.segment+1]},e.prototype._nextPosition=function(t,e,s,n){if(this._currentPosition.isPathEnd)return!1;var i=this._currentPosition.abscissa;for(this._currentPosition.segmentLength>0&&(i/=this._currentPosition.segmentLength),this._currentPosition.copyTo(e);e.abscissa+t*this._partLengthRatio>e.segmentLength+this._tolerance;){if(s){if(0===s.length)if(0===i){var r=this._path[e.segment];s.push([r[0],r[1]])}else s.push(this.getSegCoord2D(this._path,e.segment,i));var h=this._path[e.segment+1];s.push([h[0],h[1]])}if(i=0,t-=(e.segmentLength-e.abscissa)/this._partLengthRatio,this._partSegCount)e.segment=this.nextSegment(),e.segmentLength=this.calculateSegLength(this._path,e.segment),e.abscissa=0,this._partSegCount--;else{if(!this.setPosAtNextPart())return 0!==n&&(e.segmentLength=this.calculateSegLength(this._path,e.segment),e.isPartEnd=!0,1===n?(e.abscissa=e.segmentLength,e.isPathEnd=!0):e.abscissa=e.segmentLength+t,!0);this._currentPosition.copyTo(e)}}if(e.abscissa+=t*this._partLengthRatio,s){if(0===s.length)if(0===i){h=this._path[e.segment];s.push([h[0],h[1]])}else s.push(this.getSegCoord2D(this._path,e.segment,i));var o=e.abscissa/e.segmentLength;if(1===o){h=this._path[e.segment+1];s.push([h[0],h[1]])}else s.push(this.getSegCoord2D(this._path,e.segment,o))}return this._partSegCount||Math.abs(e.abscissa-e.segmentLength)<this._tolerance&&(e.isPathEnd=this._partIsLast,e.isPartEnd=!0),!0},e.prototype._getPoint=function(t){if(-1===t.segment)throw new Error("missing segment");var e=t.segmentLength<=0?0:t.abscissa/t.segmentLength;return this.getSegCoord2D(this._path,t.segment,e)},e.prototype._getAngle=function(t){if(-1===t.segment)throw new Error("missing segment");var e=t.segmentLength<=0?0:t.abscissa/t.segmentLength;return this.getSegAngleCS(this._path,t.segment,e)},e.prototype.setPosAtNextPart=function(){for(;this._partSegCount;)this.hasNextSegment()&&this.nextSegment(),this._partSegCount--;if(!this.hasNextSegment())return!1;for(this._partLength=0,this._partIsLast=!0,this._partSegCount=0;this.hasNextSegment();)if(this._partLength+=this.calculateSegLength(this._path,this.nextSegment()),this._partSegCount++,1===n.getId(this._path[this.getEndPointIndex()])){this._partIsLast=!this.hasNextSegment();break}for(var t=this._partSegCount;t;)this.previousSegment(),--t;this._currentPosition.segment=this.nextSegment(),this._currentPosition.segmentLength=this.calculateSegLength(this._path,this._currentPosition.segment),this._currentPosition.abscissa=0,this._currentPosition.isPathEnd=this._currentPosition.isPartEnd=!1,--this._partSegCount;var e=this.getStartPointIndex();this._ctrlPtBegin=1===n.getId(this._path[e]);var s=e+this._partSegCount+1;if(s>=this._path.length&&(s=0),this._ctrlPtEnd=1===n.getId(this._path[s]),this._patternLength>0){var i=this._ctrlPtBegin?this._partCtrlPtGap:this._partExtPtGap,r=this._ctrlPtEnd?this._partCtrlPtGap:this._partExtPtGap,h=Math.round((this._partLength-(i+r))/this._patternLength);h<=0&&(h=i+r>0?0:1),this._partLengthRatio=this._partLength/(i+r+h*this._patternLength),this._partLengthRatio<.01&&(this._partLengthRatio=1)}else this._partLengthRatio=1;return!0},e.prototype.hasNextSegment=function(){return this._seg<this._path.length-2},e.prototype.previousSegment=function(){return--this._seg},e.prototype.nextSegment=function(){return++this._seg},e.prototype.getStartPointIndex=function(){return this._seg},e.prototype.getEndPointIndex=function(){return this._seg+1},e}(i.CurveHelper);e.GeometryWalker=o}));