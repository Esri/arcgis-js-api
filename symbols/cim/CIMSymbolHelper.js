/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/Logger","../../core/mathUtils","../../Color","./CIMPlacements","./CIMSymbolDrawHelper","./packingUtils"],(function(e,r,t,o,i,a,s){"use strict";const n=Math.PI,c=n/2,l=4,m=r.getLogger("esri.symbols.cim.CIMSymbolHelper");function f(e,r){switch(r.type){case"CIMSymbolReference":{const t={type:"point",x:0,y:0};e.drawSymbol(r.symbol,t);break}case"CIMPointSymbol":{const t={type:"point",x:0,y:0};e.drawSymbol(r,t);break}case"CIMTextSymbol":break;case"CIMVectorMarker":{const t=new i.Placement;e.drawMarker(r,t);break}}return e.envelope()}let y=function(){function e(){}return e.getEnvelope=function(e){const r=new a.EnvDrawHelper;if(Array.isArray(e)){let t;for(const o of e)t?t.union(f(r,o)):t=f(r,o);return t}return f(r,e)},e.getTextureAnchor=function(e){const r=this.getEnvelope(e);if(!r||r.width<=0||r.height<=0)return[0,0,0];const t=96/72,o=(r.x+.5*r.width)*t,i=-(r.y+.5*r.height)*t,a=r.width*t+2,s=r.height*t+2;return[o/a,i/s,s]},e.rasterize=function(e,r,t,o=!0){const s=t||this.getEnvelope(r);if(!s||s.width<=0||s.height<=0)return[null,0,0,0,0];const n=96/72,c=(s.x+.5*s.width)*n,l=(s.y+.5*s.height)*n;e.width=s.width*n,e.height=s.height*n,t||(e.width+=2,e.height+=2);const m=e.getContext("2d"),f=a.Transformation.createScale(n,-n);f.translate(.5*e.width-c,.5*e.height+l);const y=new a.CanvasDrawHelper(m,f);switch(r.type){case"CIMPointSymbol":{const e={type:"point",x:0,y:0};y.drawSymbol(r,e);break}case"CIMVectorMarker":{const e=new i.Placement;y.drawMarker(r,e);break}}const h=m.getImageData(0,0,e.width,e.height),p=new Uint8Array(h.data);if(o){let e;for(let r=0;r<p.length;r+=4)e=p[r+3]/255,p[r]=p[r]*e,p[r+1]=p[r+1]*e,p[r+2]=p[r+2]*e}return[p,e.width,e.height,-c/e.width,-l/e.height]},e.fromSimpleMarker=function(e){const r=100,t=50;let o,i;const a=e.style;if("circle"===a||"esriSMSCircle"===a){const e=.25;let r=Math.acos(1-e/t),a=Math.ceil(n/r/4);0===a&&(a=1),r=c/a,a*=4;const s=[];s.push([t,0]);for(let o=1;o<a;o++)s.push([t*Math.cos(o*r),-t*Math.sin(o*r)]);s.push([t,0]),o={rings:[s]},i={xmin:-t,ymin:-t,xmax:t,ymax:t}}else if("cross"===a||"esriSMSCross"===a){const e=0;o={rings:[[[e,t],[e,e],[t,e],[t,-e],[e,-e],[e,-t],[-e,-t],[-e,-e],[-t,-e],[-t,e],[-e,e],[-e,t],[e,t]]]},i={xmin:-t,ymin:-t,xmax:t,ymax:t}}else if("diamond"===a||"esriSMSDiamond"===a)o={rings:[[[-t,0],[0,t],[t,0],[0,-t],[-t,0]]]},i={xmin:-t,ymin:-t,xmax:t,ymax:t};else if("square"===a||"esriSMSSquare"===a)o={rings:[[[-t,-t],[-t,t],[t,t],[t,-t],[-t,-t]]]},i={xmin:-t,ymin:-t,xmax:t,ymax:t};else if("x"===a||"esriSMSX"===a){const e=0;o={rings:[[[0,e],[t-e,t],[t,t-e],[e,0],[t,e-t],[t-e,-t],[0,-e],[e-t,-t],[-t,e-t],[-e,0],[-t,t-e],[e-t,t],[0,e]]]},i={xmin:-t,ymin:-t,xmax:t,ymax:t}}else if("triangle"===a||"esriSMSTriangle"===a){const e=r*.5773502691896257,t=-e,a=2/3*r,s=a-r;o={rings:[[[t,s],[0,a],[e,s],[t,s]]]},i={xmin:t,ymin:s,xmax:e,ymax:a}}else"arrow"!==a&&"esriSMSArrow"!==a||(o={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},i={xmin:-t,ymin:-t,xmax:t,ymax:t});let s;if(o&&i){const r=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&r.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});const t={type:"CIMPolygonSymbol",symbolLayers:r};s={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:i,markerGraphics:[{type:"CIMMarkerGraphic",geometry:o,symbol:t}]}]}}return s},e.fromCIMHatchFill=function(e){const r=void 0!==e.separation?e.separation:l,t=r/2;let o=this._getLineSymbolPeriod(e.lineSymbol)||l;for(;o<4;)o*=2;const i=o/2;return{type:"CIMVectorMarker",frame:{xmin:-i,xmax:i,ymin:-t,ymax:t},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-i,0],[i,0]]]},symbol:e.lineSymbol}],size:r}},e._getLineSymbolPeriod=function(e){if(e){const r=this._getEffectsRepeat(e.effects);if(r)return r;if(e.symbolLayers)for(const t of e.symbolLayers){const e=this._getEffectsRepeat(t.effects);if(e)return e;if(t){const e=this._getPlacementRepeat(t.markerPlacement);if(e)return e}}}return 0},e._getEffectsRepeat=function(e){if(e)for(const r of e)if(r)switch(r.type){case"CIMGeometricEffectDashes":{const e=r.dashTemplate;if(e&&e.length){let r=0;for(const t of e)r+=t;return 1&e.length&&(r*=2),r}break}case"CIMGeometricEffectWave":return r.period;default:m.error(`unsupported geometric effect type ${r.type}`)}return 0},e._getPlacementRepeat=function(e){if(e)switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const r=e.placementTemplate;if(r&&r.length){let e=0;for(const t of r)e+=t;return 1&r.length&&(e*=2),e}break}}return 0},e.fromCIMInsidePolygon=function(e){const r=e.markerPlacement,t={type:e.type,...e};let o,i,a,s;if(t.markerPlacement=null,t.anchorPoint=null,!0===r.shiftOddRows){i=r.stepX/2,a=r.stepY,s=2*r.stepY;o=[{x:-i,y:0},{x:i,y:0},{x:0,y:a},{x:0,y:-a}].map((e=>({type:"CIMMarkerGraphic",geometry:e,symbol:{type:"CIMPointSymbol",symbolLayers:[t]}})))}else i=r.stepX/2,a=r.stepY/2,s=r.stepY,o=[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[t]}}];return{type:"CIMVectorMarker",frame:{xmin:-i,xmax:i,ymin:-a,ymax:a},markerGraphics:o,size:s}},e.getFillColor=function(r){if(!r)return null;switch(r.type){case"CIMPolygonSymbol":if(r.symbolLayers)for(const t of r.symbolLayers){const r=e.getFillColor(t);if(null!=r)return r}break;case"CIMTextSymbol":return e.getFillColor(r.symbol);case"CIMSolidFill":return r.color}},e.getStrokeColor=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(const t of r.symbolLayers){const r=e.getStrokeColor(t);if(void 0!==r)return r}break;case"CIMTextSymbol":return e.getStrokeColor(r.symbol);case"CIMSolidStroke":return r.color}},e.getStrokeWidth=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(const t of r.symbolLayers){const r=e.getStrokeWidth(t);if(void 0!==r)return r}break;case"CIMTextSymbol":return e.getStrokeWidth(r.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return r.width}},e.getSize=function(r){if(r)switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{let t=0;if(r.symbolLayers)for(const o of r.symbolLayers){const r=e.getSize(o);r>t&&(t=r)}return t}case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return r.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return r.size}},e.getMarkerScaleRatio=function(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){const r=e.frame.ymax-e.frame.ymin;return e.size/r}}return 1},e}(),h=function(){function e(){}return e.rasterizeSimpleFill=function(e,r,o){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization");const i=t.nextPowerOfTwo(Math.ceil(o)),a=this._isHorizontalOrVertical(r)?8*i:16*i,s=2*i;e.width=a,e.height=a;const n=e.getContext("2d");n.strokeStyle="#FFFFFF",n.lineWidth=i,n.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(n.moveTo(a/2,-s),n.lineTo(a/2,a+s)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(n.moveTo(-s,a/2),n.lineTo(a+s,a/2)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(n.moveTo(-s,-s),n.lineTo(a+s,a+s),n.moveTo(a-s,-s),n.lineTo(a+s,s),n.moveTo(-s,a-s),n.lineTo(s,a+s)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(n.moveTo(a+s,-s),n.lineTo(-s,a+s),n.moveTo(s,-s),n.lineTo(-s,s),n.moveTo(a+s,a-s),n.lineTo(a-s,a+s)),n.stroke();const c=n.getImageData(0,0,e.width,e.height),l=new Uint8Array(c.data);let m;for(let t=0;t<l.length;t+=4)m=l[t+3]/255,l[t]=l[t]*m,l[t+1]=l[t+1]*m,l[t+2]=l[t+2]*m;return[l,e.width,e.height]},e.rasterizeSimpleLine=function(e,r){let t;switch(r){case"butt":t="Butt";break;case"square":t="Square";break;default:t="Round"}const o="Butt"===t;let i;switch(e){case"dash":case"esriSLSDash":i=o?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":i=o?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":i=o?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":i=o?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":i=o?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":i=o?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":i=o?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":i=o?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":i=o?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":i=o?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":m.error("Unexpected: style does not require rasterization"),i=[0,0];break;default:m.error(`Tried to rasterize SLS, but found an unexpected style: ${e}!`),i=[0,0]}return this.rasterizeDash(i,t)},e.rasterizeDash=function(e,r){const t="Butt"===r,o="Square"===r,i=!t&&!o,a=15,n=2*a+1;let c=0;for(const s of e)c+=s;const l=c*a,m=l*n,f=new Float32Array(m),y=i?a*a:a;for(let s=0;s<m;++s)f[s]=y;const h=a,p=.5*a;let S=0,u=0,d=!0;for(const s of e){S=u,u+=s*a;let e=S;for(;e<u;){let r=0;for(;r<n;){const a=r*l+e,s=i?(r-h)*(r-h):Math.abs(r-h);f[a]=d?t?Math.max(Math.max(S+p-e,s),Math.max(e-u+p,s)):s:i?Math.min((e-S)*(e-S)+s,(e-u)*(e-u)+s):o?Math.min(Math.max(e-S,s),Math.max(u-e,s)):Math.min(Math.max(e-S+p,s),Math.max(u+p-e,s)),r++}e++}d=!d}const M=f.length,b=new Uint8Array(4*M);for(let C=0;C<M;++C){const e=(i?Math.sqrt(f[C]):f[C])/a;s.packFloatRGBA(e,b,4*C)}return[b,l,n]},e._isHorizontalOrVertical=function(e){return"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e},e}(),p=function(){function e(){}return e.findApplicableOverrides=function(r,t,o){if(t){if(r.primitiveName){let e=!1;for(const t of o)if(t.primitiveName===r.primitiveName){e=!0;break}if(!e)for(const i of t)i.primitiveName===r.primitiveName&&o.push(i)}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(const i of r.effects)e.findApplicableOverrides(i,t,o);if(r.symbolLayers)for(const i of r.symbolLayers)e.findApplicableOverrides(i,t,o);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(r.effects)for(const i of r.effects)e.findApplicableOverrides(i,t,o);if(r.markerPlacement&&e.findApplicableOverrides(r.markerPlacement,t,o),"CIMVectorMarker"===r.type){if(r.markerGraphics)for(const i of r.markerGraphics)e.findApplicableOverrides(i,t,o),e.findApplicableOverrides(i.symbol,t,o)}else"CIMCharacterMarker"===r.type?e.findApplicableOverrides(r.symbol,t,o):"CIMHatchFill"===r.type&&e.findApplicableOverrides(r.lineSymbol,t,o)}}},e.applyOverrides=function(r,t,o,i){if(!t)return;const a=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;if(r.primitiveName)for(const s of t)if(s.primitiveName===r.primitiveName){const t=a(s.propertyName);if(i&&i.push({cim:r,nocapPropertyName:t,value:r[t]}),s.expression&&(s.value=e.toValue(s.propertyName,s.expression)),o){let e=!1;for(const t of o)t.primitiveName===r.primitiveName&&(e=!0);e||o.push(s)}r[t]=s.value}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(const a of r.effects)e.applyOverrides(a,t,o,i);if(r.symbolLayers)for(const a of r.symbolLayers)e.applyOverrides(a,t,o,i);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(r.effects)for(const a of r.effects)e.applyOverrides(a,t,o,i);if("CIMVectorMarker"===r.type&&r.markerGraphics)for(const a of r.markerGraphics)e.applyOverrides(a,t,o,i),e.applyOverrides(a.symbol,t,o,i)}},e.restoreOverrides=function(e){for(const r of e)r.cim[r.nocapPropertyName]=r.value},e.buildOverrideKey=function(e){let r="";for(const t of e)void 0!==t.value&&(r+=`${t.primitiveName}${t.propertyName}${JSON.stringify(t.value)}`);return r},e.toValue=function(e,r){if("DashTemplate"===e)return r.split(" ").map((e=>Number(e)));if("Color"===e){const e=new o(r).toRgba();return e[3]*=255,e}return r},e}();e.CIMSymbolHelper=y,e.OverrideHelper=p,e.SymbolHelper=h,Object.defineProperty(e,"__esModule",{value:!0})}));
