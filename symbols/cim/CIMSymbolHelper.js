/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../core/BidiText","../../core/floatRGBA","../../core/lang","../../core/Logger","../../core/mathUtils","../../core/maybe","../../core/screenUtils","../../geometry/support/aaBoundingRect","../../geometry/support/boundsUtils","./CIMPlacements","./CIMSymbolDrawHelper","./enums","./utils","../../views/2d/engine/vectorTiles/GeometryUtils","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/mesh/templates/shapingUtils"],(function(e,t,r,o,i,a,n,s,l,c,f,m,y,u,h,p,S,M){"use strict";const d=Math.PI,g=d/2,b=4,C=10,I=96/72,k=Math.PI/180,x=a.getLogger("esri.symbols.cim.CIMSymbolHelper");function w(e){if(!e||!e.type)return null;let t;switch(e.type){case"cim":return e.data;case"web-style":return e;case"simple-marker":t=D.fromSimpleMarker(e);break;case"picture-marker":t=D.fromPictureMarker(e);break;case"simple-line":t=D.fromSimpleLineSymbol(e);break;case"simple-fill":t=D.fromSimpleFillSymbol(e);break;case"picture-fill":t=D.fromPictureFillSymbol(e);break;case"text":t=D.fromTextSymbol(e)}return{type:"CIMSymbolReference",symbol:t}}function P(e,t){switch(t.type){case"CIMSymbolReference":return P(e,t.symbol);case"CIMPointSymbol":{const r={x:0,y:0};e.drawSymbol(t,r);break}case"CIMLineSymbol":{const r={paths:[[[0,0],[0,1]]]};e.drawSymbol(t,r);break}case"CIMPolygonSymbol":{const r={rings:[[[0,0],[0,1],[0,0]]]};e.drawSymbol(t,r);break}case"CIMTextSymbol":{const r={x:0,y:0};e.drawSymbol(t,r);break}case"CIMVectorMarker":{const r=new m.Placement;e.drawMarker(t,r);break}}return e.envelope()}function L(e){if(!e)return 0;switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAtExtremities":case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementAtRatioPositions":case"CIMMarkerPlacementOnLine":case"CIMMarkerPlacementOnVertices":return Math.abs(e.offset);default:return 0}}function v(e){if(!e)return 0;switch(e.type){case"CIMGeometricEffectArrow":return Math.abs(.5*e.width);case"CIMGeometricEffectBuffer":return Math.abs(e.size);case"CIMGeometricEffectExtension":case"CIMGeometricEffectRadial":return Math.abs(e.length);case"CIMGeometricEffectJog":return Math.abs(.5*e.length);case"CIMGeometricEffectMove":return Math.max(Math.abs(h.getValue(e.offsetX)),Math.abs(h.getValue(e.offsetY)));case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":return Math.abs(e.offset);case"CIMGeometricEffectRegularPolygon":return Math.abs(e.radius);case"CIMGeometricEffectRotate":case"CIMGeometricEffectScale":default:return 0;case"CIMGeometricEffectTaperedPolygon":return.5*Math.max(Math.abs(e.fromWidth),Math.abs(e.toWidth));case"CIMGeometricEffectWave":return Math.abs(e.amplitude)}}function F(e){if(!e)return 0;let t=0;for(const r of e)t+=v(r);return t}let T=function(){function e(){}var t=e.prototype;return t.getSymbolInflateSize=function(e,t,r,o,i){return e||(e=[0,0,0,0]),t?this._getInflateSize(e,t,r,o,i):e},e.safeSize=function(e){const t=Math.max(Math.abs(e[0]),Math.abs(e[2])),r=Math.max(Math.abs(e[1]),Math.abs(e[3]));return Math.sqrt(t*t+r*r)},t._vectorMarkerBounds=function(e,t,r,o){let i=!0;const a=c.create();if(t&&t.markerGraphics)for(const n of t.markerGraphics){const t=[0,0,0,0];n.geometry&&(f.getBoundsXY(a,n.geometry),t[0]=0,t[1]=0,t[2]=0,t[3]=0,this.getSymbolInflateSize(t,n.symbol,r,0,o),a[0]+=t[0],a[1]+=t[1],a[2]+=t[2],a[3]+=t[3],i?(e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3],i=!1):(e[0]=Math.min(e[0],a[0]),e[1]=Math.min(e[1],a[1]),e[2]=Math.max(e[2],a[2]),e[3]=Math.max(e[3],a[3])))}return e},t._getInflateSize=function(e,t,r,o,i){if(Y(t)){const a=this._getLayersInflateSize(e,t.symbolLayers,r,o,i),n=F(t.effects);return n>0&&(a[0]-=n,a[1]-=n,a[2]+=n,a[3]+=n),a}return this._getTextInflatedSize(e,t,i)},t._getLayersInflateSize=function(e,t,r,o,i){let a=!0;if(!t)return e;for(const n of t){if(!n)continue;let t=[0,0,0,0];switch(n.type){case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":{const e=n;let r=e.width;e.capStyle===u.LineCapStyle.Square||e.joinStyle===u.LineJoinStyle.Miter?r/=1.4142135623730951:r/=2,t[0]=-r,t[1]=-r,t[2]=r,t[3]=r;break}case"CIMCharacterMarker":case"CIMVectorMarker":case"CIMPictureMarker":{const e=n;if("CIMVectorMarker"===n.type){const e=n;if(t=this._vectorMarkerBounds(t,e,r,i),e.frame){const r=(e.frame.xmin+e.frame.xmax)/2,o=(e.frame.ymin+e.frame.ymax)/2;t[0]-=r,t[1]-=o,t[2]-=r,t[3]-=o;const i=e.size/(e.frame.ymax-e.frame.ymin);t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i}}else if("CIMPictureMarker"===n.type){const o=n,i=r.getResource(o.url);let a=1;s.isSome(i)&&i.height&&(a=i.width/i.height);const l=e.size/2,c=e.size*a*o.scaleX/2;t=[-c,-l,c,l]}else{const r=e.size/2;t=[-r,-r,r,r]}if(e.anchorPoint){let r,o;"Absolute"===e.anchorPointUnits?(r=e.anchorPoint.x,o=e.anchorPoint.y):(r=e.anchorPoint.x*(t[2]-t[0]),o=e.anchorPoint.y*(t[3]-t[1])),t[0]-=r,t[1]-=o,t[2]-=r,t[3]-=o}let a=h.getValue(e.rotation);if(e.rotateClockwise&&(a=-a),o&&(a-=o),a){const e=k*a,r=Math.cos(e),o=Math.sin(e),i=c.create([p.C_INFINITY,p.C_INFINITY,-p.C_INFINITY,-p.C_INFINITY]);c.expandPointInPlace(i,[t[0]*r-t[1]*o,t[0]*o+t[1]*r]),c.expandPointInPlace(i,[t[0]*r-t[3]*o,t[0]*o+t[3]*r]),c.expandPointInPlace(i,[t[2]*r-t[1]*o,t[2]*o+t[1]*r]),c.expandPointInPlace(i,[t[2]*r-t[3]*o,t[2]*o+t[3]*r]),t=i}let l=h.getValue(e.offsetX),f=h.getValue(e.offsetY);if(o){const e=k*o,t=Math.cos(e),r=Math.sin(e),i=l*r+f*t;l=l*t-f*r,f=i}t[0]+=l,t[1]+=f,t[2]+=l,t[3]+=f;const m=L(e.markerPlacement);m>0&&(t[0]-=m,t[1]-=m,t[2]+=m,t[3]+=m);break}}const l=F(n.effects);l>0&&(t[0]-=l,t[1]-=l,t[2]+=l,t[3]+=l),a?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],a=!1):(e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[2]),e[3]=Math.max(e[3],t[3]))}return e},t._getTextInflatedSize=function(e,t,o){var i,a;const n=null!=(i=t.height)?i:C;if(e[0]=-n/2,e[1]=-n/2,e[2]=n/2,e[3]=n/2,!o)return e;const s=o.get(t);if(!s)return e;const{text:l,mosaicItem:c}=s;if(!c||0===c.glyphMosaicItems.length)return e;const f=y.lineGapType2LineHeight(t.lineGapType,null!=(a=t.lineGap)?a:0,n),m=r.bidiText(l)[1],u=c.glyphMosaicItems,p=M.shapeGlyphs(u,m,{scale:n/S.GLYPH_SIZE,angle:h.getValue(t.angle),xOffset:h.getValue(t.offsetX),yOffset:h.getValue(t.offsetY),hAlign:y.horizontalAlignment2HAlign(t.horizontalAlignment),vAlign:y.verticalAlignment2VAlign(t.verticalAlignment),maxLineWidth:512,lineHeight:S.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(f||1,4)),decoration:t.font.decoration||"none",isCIM:!0}).boundsT;return e[0]=p.x-p.halfWidth,e[1]=-p.y-p.halfHeight,e[2]=p.x+p.halfWidth,e[3]=-p.y+p.halfHeight,e},e}(),D=function(){function e(){}return e.getEnvelope=function(e,t){const r=new y.EnvDrawHelper(t);if(Array.isArray(e)){let t;for(const o of e)t?t.union(P(r,o)):t=P(r,o);return t}return P(r,e)},e.getTextureAnchor=function(e,t){const r=this.getEnvelope(e,t);if(!r)return[0,0,0];const o=(r.x+.5*r.width)*I,i=-(r.y+.5*r.height)*I,a=r.width*I+2,n=r.height*I+2;return[o/a,i/n,n]},e.rasterize=function(e,t,r,o,i=!0){const a=r||this.getEnvelope(t,o);if(!a)return[null,0,0,0,0];const n=(a.x+.5*a.width)*I,s=(a.y+.5*a.height)*I;e.width=a.width*I,e.height=a.height*I,r||(e.width+=2,e.height+=2);const l=e.getContext("2d"),c=y.Transformation.createScale(I,-I);c.translate(.5*e.width-n,.5*e.height+s);const f=new y.CanvasDrawHelper(l,o,c);switch(t.type){case"CIMPointSymbol":{const e={type:"point",x:0,y:0};f.drawSymbol(t,e);break}case"CIMVectorMarker":{const e=new m.Placement;f.drawMarker(t,e);break}}const u=l.getImageData(0,0,e.width,e.height),h=new Uint8Array(u.data);if(i){let e;for(let t=0;t<h.length;t+=4)e=h[t+3]/255,h[t]=h[t]*e,h[t+1]=h[t+1]*e,h[t+2]=h[t+2]*e}return[h,e.width,e.height,-n/e.width,-s/e.height]},e.fromTextSymbol=function(e){const{angle:t,color:o,font:i,haloColor:a,haloSize:n,horizontalAlignment:s,kerning:l,text:c,verticalAlignment:f,xoffset:m,yoffset:y}=e;let p,S,M,d,g;i&&(p=i.family,S=i.style,M=i.weight,d=i.size,g=i.decoration);let b=!1;if(c){b=r.bidiText(c)[1]}return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPointUnits:"Relative",dominantSizeAxis3D:"Y",size:10,billboardMode3D:"FaceNearPlane",frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMTextSymbol",angle:t,blockProgression:u.BlockProgression.BTT,depth3D:1,extrapolateBaselines:!0,fontEffects:u.FontEffects.Normal,fontEncoding:u.FontEncoding.Unicode,fontFamilyName:p||"Arial",fontStyleName:R(S,M),fontType:u.FontType.Unspecified,haloSize:n,height:d,hinting:u.GlyphHinting.Default,horizontalAlignment:N(null!=s?s:"center"),kerning:l,letterWidth:100,ligatures:!0,lineGapType:"Multiple",offsetX:h.getValue(m),offsetY:h.getValue(y),strikethrough:"line-through"===g,underline:"underline"===g,symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:O(o)}]},haloSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:O(a)}]},shadowColor:[0,0,0,255],shadowOffsetX:1,shadowOffsetY:1,textCase:"Normal",textDirection:b?u.TextReadingDirection.RTL:u.TextReadingDirection.LTR,verticalAlignment:E(null!=f?f:"baseline"),verticalGlyphOrientation:u.VerticalGlyphOrientation.Right,wordSpacing:100,billboardMode3D:u.BillBoardMode.FaceNearPlane},textString:c}],scaleSymbolsProportionally:!0,respectFrame:!0}],scaleX:1,angleAlignment:"Display"}},e.fromPictureFillSymbol=function(e){const{height:t,outline:r,width:o,xoffset:i,xscale:a,yoffset:n,yscale:s}=e,l=[],c={type:"CIMPolygonSymbol",symbolLayers:l};if(r){const{cap:e,join:t,miterLimit:o,width:i}=r;l.push({type:"CIMSolidStroke",color:O(r.color),capStyle:A(e),joinStyle:V(t),miterLimit:o,width:i})}let f=e.url;"esriPFS"===e.type&&e.imageData&&(f=e.imageData);const m="angle"in e?e.angle:0,y=o*(a||1),p=t*(s||1);return l.push({type:"CIMPictureFill",invertBackfaceTexture:!1,scaleX:1,textureFilter:u.TextureFilter.Picture,tintColor:null,url:f,height:p,width:y,offsetX:h.getValue(i),offsetY:h.getValue(n),rotation:h.getValue(-m),colorSubstitutions:null}),c},e.fromSimpleFillSymbol=function(e){const{color:t,style:r,outline:o}=e,a=[],s={type:"CIMPolygonSymbol",symbolLayers:a};let l=null;if(o){const{cap:e,join:t,style:r}=o;"solid"!==r&&"none"!==r&&"esriSLSSolid"!==r&&"esriSLSNull"!==r&&(l=[{type:"CIMGeometricEffectDashes",dashTemplate:_(r,e),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]),a.push({type:"CIMSolidStroke",color:O(o.color),capStyle:A(e),joinStyle:V(t),miterLimit:o.miterLimit,width:o.width,effects:l})}if(r&&"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r){const e={type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",color:O(t),capStyle:u.LineCapStyle.Butt,joinStyle:u.LineJoinStyle.Miter,width:.75}]};let o=0;const s=n.nextPowerOfTwo(Math.ceil(window.devicePixelRatio)),l=U(r)?8*s:10*s;switch(r){case"vertical":case"esriSFSVertical":o=90;break;case"forward-diagonal":case"esriSFSForwardDiagonal":case"diagonal-cross":case"esriSFSDiagonalCross":o=-45;break;case"backward-diagonal":case"esriSFSBackwardDiagonal":o=45;break;case"cross":case"esriSFSCross":o=0}a.push({type:"CIMHatchFill",lineSymbol:e,offsetX:0,offsetY:0,rotation:o,separation:l}),"cross"===r||"esriSFSCross"===r?a.push({type:"CIMHatchFill",lineSymbol:i.clone(e),offsetX:0,offsetY:0,rotation:90,separation:l}):"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r||a.push({type:"CIMHatchFill",lineSymbol:i.clone(e),offsetX:0,offsetY:0,rotation:45,separation:l})}else!r||"solid"!==r&&"esriSFSSolid"!==r||a.push({type:"CIMSolidFill",enable:!0,color:O(t)});return s},e.fromSimpleLineSymbol=function(t){const{cap:r,color:o,join:i,marker:a,miterLimit:n,style:s,width:l}=t;let c=null;"solid"!==s&&"none"!==s&&"esriSLSSolid"!==s&&"esriSLSNull"!==s&&(c=[{type:"CIMGeometricEffectDashes",dashTemplate:_(s,r),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]);const f=[];if(a){let t;switch(a.placement){case"begin-end":t=u.ExtremityPlacement.Both;break;case"begin":t=u.ExtremityPlacement.JustBegin;break;case"end":t=u.ExtremityPlacement.JustEnd;break;default:t=u.ExtremityPlacement.None}const r=e.fromSimpleMarker(a,l,o).symbolLayers[0];r.markerPlacement={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:t,offsetAlongLine:0},f.push(r)}return"none"!==s&&"esriSLSNull"!==s&&f.push({type:"CIMSolidStroke",color:O(o),capStyle:A(r),joinStyle:V(i),miterLimit:n,width:l,effects:c}),{type:"CIMLineSymbol",symbolLayers:f}},e.fromPictureMarker=function(e){const{angle:t,height:r,width:o,xoffset:i,yoffset:a}=e;let n=e.url;return"esriPMS"===e.type&&e.imageData&&(n=e.imageData),{type:"CIMPointSymbol",symbolLayers:[{type:"CIMPictureMarker",invertBackfaceTexture:!1,scaleX:1,textureFilter:u.TextureFilter.Picture,tintColor:null,url:n,size:r,width:o,offsetX:h.getValue(i),offsetY:h.getValue(a),rotation:h.getValue(-t)}]}},e.fromSimpleMarker=function(e,t,r){var o;const{style:i}=e,a=null!=(o=e.color)?o:r;if("path"===i){const t=[];if("outline"in e&&e.outline){const r=e.outline;t.push({type:"CIMSolidStroke",enable:!0,width:l.pt2px(Math.round(l.px2pt(r.width))),color:O(r.color)})}t.push({type:"CIMSolidFill",enable:!0,color:O(a),path:e.path});const[r,o]=X("square");return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:h.getValue(-e.angle),size:h.getValue(e.size||6),offsetX:h.getValue(e.xoffset),offsetY:h.getValue(e.yoffset),frame:r,markerGraphics:[{type:"CIMMarkerGraphic",geometry:o,symbol:{type:"CIMPolygonSymbol",symbolLayers:t}}]}]}}const[n,s]=X(i);let c;if(s&&n){const r=[];if("outline"in e&&e.outline){const t=e.outline;r.push({type:"CIMSolidStroke",enable:!0,width:t.width>.667?l.pt2px(Math.round(l.px2pt(t.width))):t.width,color:O(t.color)})}else!t||"line-marker"!==e.type||"cross"!==e.style&&"x"!==e.style||r.push({type:"CIMSolidStroke",enable:!0,width:t,color:O(a)});r.push({type:"CIMSolidFill",enable:!0,color:O(a)});const o={type:"CIMPolygonSymbol",symbolLayers:r};c={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:h.getValue(-e.angle),size:h.getValue(e.size||6*t),offsetX:h.getValue(e.xoffset),offsetY:h.getValue(e.yoffset),frame:n,markerGraphics:[{type:"CIMMarkerGraphic",geometry:s,symbol:o}]}]}}return c},e.fromCIMHatchFill=function(e){var t;const r=null!=(t=e.separation)?t:b,o=r/2,i=4;let a=this._getLineSymbolPeriod(e.lineSymbol)||i;for(;a<i;)a*=2;const n=a/2;return{type:"CIMVectorMarker",frame:{xmin:-n,xmax:n,ymin:-o,ymax:o},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-n,0],[n,0]]]},symbol:e.lineSymbol}],size:r}},e._getLineSymbolPeriod=function(e){if(e){const t=this._getEffectsRepeat(e.effects);if(t)return t;if(e.symbolLayers)for(const r of e.symbolLayers){const e=this._getEffectsRepeat(r.effects);if(e)return e;if(r){const e=this._getPlacementRepeat(r.markerPlacement);if(e)return e}}}return 0},e._getEffectsRepeat=function(e){if(e)for(const t of e)if(t)switch(t.type){case"CIMGeometricEffectDashes":{const e=t.dashTemplate;if(e&&e.length){let t=0;for(const r of e)t+=r;return 1&e.length&&(t*=2),t}break}case"CIMGeometricEffectWave":return t.period;default:x.error(`unsupported geometric effect type ${t.type}`)}return 0},e._getPlacementRepeat=function(e){if(e)switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const t=e.placementTemplate;if(t&&t.length){let e=0;for(const r of t)e+=r;return 1&t.length&&(e*=2),e}break}}return 0},e.fromCIMInsidePolygon=function(e){const t=e.markerPlacement,r={type:e.type,...e};let o,i,a,n;if(r.markerPlacement=null,r.anchorPoint=null,!0===t.shiftOddRows){i=t.stepX/2,a=t.stepY,n=2*t.stepY;o=[{x:-i,y:0},{x:i,y:0},{x:0,y:a},{x:0,y:-a}].map((e=>({type:"CIMMarkerGraphic",geometry:e,symbol:{type:"CIMPointSymbol",symbolLayers:[r]}})))}else i=t.stepX/2,a=t.stepY/2,n=t.stepY,o=[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[r]}}];return{type:"CIMVectorMarker",frame:{xmin:-i,xmax:i,ymin:-a,ymax:a},markerGraphics:o,size:n}},e.getFillColor=function(t){if(!t)return null;switch(t.type){case"CIMPolygonSymbol":if(t.symbolLayers)for(const r of t.symbolLayers){const t=e.getFillColor(r);if(null!=t)return t}break;case"CIMTextSymbol":return e.getFillColor(t.symbol);case"CIMSolidFill":return t.color}},e.getStrokeColor=function(t){if(t)switch(t.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(t.symbolLayers)for(const r of t.symbolLayers){const t=e.getStrokeColor(r);if(void 0!==t)return t}break;case"CIMTextSymbol":return e.getStrokeColor(t.symbol);case"CIMSolidStroke":return t.color}},e.getStrokeWidth=function(t){if(t)switch(t.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(t.symbolLayers)for(const r of t.symbolLayers){const t=e.getStrokeWidth(r);if(void 0!==t)return t}break;case"CIMTextSymbol":return e.getStrokeWidth(t.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return t.width}},e.getSize=function(t){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{let r=0;if(t.symbolLayers)for(const o of t.symbolLayers){const t=e.getSize(o);t>r&&(r=t)}return r}case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return t.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return t.size}},e.getMarkerScaleRatio=function(e){if(e&&"CIMVectorMarker"===e.type)if(!1!==e.scaleSymbolsProportionally&&e.frame){const t=e.frame.ymax-e.frame.ymin;return e.size/t}return 1},e}(),G=function(){function e(){}return e.rasterizeSimpleFill=function(e,t,r){"solid"!==t&&"none"!==t&&"esriSFSSolid"!==t&&"esriSFSNull"!==t||console.error("Unexpected: style does not require rasterization");const o=n.nextPowerOfTwo(Math.ceil(r)),i=U(t)?8*o:16*o,a=2*o;e.width=i,e.height=i;const s=e.getContext("2d");s.strokeStyle="#FFFFFF",s.lineWidth=o,s.beginPath(),"vertical"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSVertical"!==t||(s.moveTo(i/2,-a),s.lineTo(i/2,i+a)),"horizontal"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSHorizontal"!==t||(s.moveTo(-a,i/2),s.lineTo(i+a,i/2)),"forward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSDiagonalCross"!==t&&"esriSFSForwardDiagonal"!==t||(s.moveTo(-a,-a),s.lineTo(i+a,i+a),s.moveTo(i-a,-a),s.lineTo(i+a,a),s.moveTo(-a,i-a),s.lineTo(a,i+a)),"backward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSBackwardDiagonal"!==t&&"esriSFSDiagonalCross"!==t||(s.moveTo(i+a,-a),s.lineTo(-a,i+a),s.moveTo(a,-a),s.lineTo(-a,a),s.moveTo(i+a,i-a),s.lineTo(i-a,i+a)),s.stroke();const l=s.getImageData(0,0,e.width,e.height),c=new Uint8Array(l.data);let f;for(let n=0;n<c.length;n+=4)f=c[n+3]/255,c[n]=c[n]*f,c[n+1]=c[n+1]*f,c[n+2]=c[n+2]*f;return[c,e.width,e.height]},e.rasterizeSimpleLine=function(e,t){return this.rasterizeDash(e,t)},e.rasterizeDash=function(e,t){const r="Butt"===t,i="Square"===t,a=!r&&!i;e.length%2==1&&(e=[...e,...e]);const n=15.5,s=2*n;let l=0;for(const o of e)l+=o;const c=Math.round(l*n),f=new Float32Array(c*s),m=.5*n;let y=0,u=0,h=.5,p=!0;for(const o of e){for(y=u,u+=o*n;h<=u;){let e=.5;for(;e<s;){const t=(e-.5)*c+h-.5,o=a?(e-n)*(e-n):Math.abs(e-n);f[t]=p?r?Math.max(Math.max(y+m-h,o),Math.max(h-u+m,o)):o:a?Math.min((h-y)*(h-y)+o,(h-u)*(h-u)+o):i?Math.min(Math.max(h-y,o),Math.max(u-h,o)):Math.min(Math.max(h-y+m,o),Math.max(u+m-h,o)),e++}h++}p=!p}const S=f.length,M=new Uint8Array(4*S);for(let d=0;d<S;++d){const e=(a?Math.sqrt(f[d]):f[d])/n;o.packFloatRGBA(e,M,4*d)}return[M,c,s]},e}(),z=function(){function e(){}return e.findApplicableOverrides=function(t,r,o){if(t&&r){if(t.primitiveName){let e=!1;for(const r of o)if(r.primitiveName===t.primitiveName){e=!0;break}if(!e)for(const i of r)i.primitiveName===t.primitiveName&&o.push(i)}switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(t.effects)for(const i of t.effects)e.findApplicableOverrides(i,r,o);if(t.symbolLayers)for(const i of t.symbolLayers)e.findApplicableOverrides(i,r,o);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(t.effects)for(const i of t.effects)e.findApplicableOverrides(i,r,o);if(t.markerPlacement&&e.findApplicableOverrides(t.markerPlacement,r,o),"CIMVectorMarker"===t.type){if(t.markerGraphics)for(const i of t.markerGraphics)e.findApplicableOverrides(i,r,o),e.findApplicableOverrides(i.symbol,r,o)}else"CIMCharacterMarker"===t.type?e.findApplicableOverrides(t.symbol,r,o):"CIMHatchFill"===t.type&&e.findApplicableOverrides(t.lineSymbol,r,o)}}},e.findEffectOverrides=function(e,t,r){if(!t||!e)return;const o=e.length;for(let i=0;i<o;i++){const o=e[i],a=null==o?void 0:o.primitiveName;if(a){let e=!1;for(const t of r)if(t.primitiveName===a){e=!0;break}if(!e)for(const o of t)o.primitiveName===a&&r.push(o)}}},e.applyOverrides=function(t,r,o,i){if(!r)return;const a=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;if(t.primitiveName)for(const n of r)if(n.primitiveName===t.primitiveName){const r=a(n.propertyName);if(i&&i.push({cim:t,nocapPropertyName:r,value:t[r]}),n.expression&&(n.value=e.toValue(n.propertyName,n.expression)),o){let e=!1;for(const r of o)r.primitiveName===t.primitiveName&&(e=!0);e||o.push(n)}t[r]=n.value}switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(t.effects)for(const a of t.effects)e.applyOverrides(a,r,o,i);if(t.symbolLayers)for(const a of t.symbolLayers)e.applyOverrides(a,r,o,i);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(t.effects)for(const a of t.effects)e.applyOverrides(a,r,o,i);if("CIMVectorMarker"===t.type&&t.markerGraphics)for(const a of t.markerGraphics)e.applyOverrides(a,r,o,i),e.applyOverrides(a.symbol,r,o,i)}},e.restoreOverrides=function(e){for(const t of e)t.cim[t.nocapPropertyName]=t.value},e.buildOverrideKey=function(e){let t="";for(const r of e)void 0!==r.value&&(t+=`${r.primitiveName}${r.propertyName}${JSON.stringify(r.value)}`);return t},e.toValue=function(e,r){if("DashTemplate"===e)return r.split(" ").map((e=>Number(e)));if("Color"===e){const e=new t(r).toRgba();return e[3]*=255,e}return r},e}();const A=e=>{if(!e)return u.LineCapStyle.Butt;switch(e){case"butt":return u.LineCapStyle.Butt;case"square":return u.LineCapStyle.Square;case"round":return u.LineCapStyle.Round}},V=e=>{if(!e)return u.LineJoinStyle.Miter;switch(e){case"miter":return u.LineJoinStyle.Miter;case"round":return u.LineJoinStyle.Round;case"bevel":return u.LineJoinStyle.Bevel}},N=e=>{if(!e)return"Center";switch(e){case"left":return"Left";case"right":return"Right";case"center":return"Center";case"justify":return"Justify"}},E=e=>{if(!e)return"Center";switch(e){case"baseline":return"Baseline";case"top":return"Top";case"middle":return"Center";case"bottom":return"Bottom"}},O=e=>{if(!e)return[0,0,0,0];const{r:t,g:r,b:o,a:i}=e;return[t,r,o,255*i]},R=(e,t)=>{const r=B(t),o=H(e);return r&&o?`${r}-${o}`:`${r}${o}`},B=e=>{if(!e)return"";switch(e.toLowerCase()){case"bold":case"bolder":return"bold"}return""},H=e=>{if(!e)return"";switch(e.toLowerCase()){case"italic":case"oblique":return"italic"}return""},_=(e,t)=>{const r="butt"===t;switch(e){case"dash":case"esriSLSDash":return r?[4,3]:[3,4];case"dash-dot":case"esriSLSDashDot":return r?[4,3,1,3]:[3,4,0,4];case"dot":case"esriSLSDot":return r?[1,3]:[0,4];case"long-dash":case"esriSLSLongDash":return r?[8,3]:[7,4];case"long-dash-dot":case"esriSLSLongDashDot":return r?[8,3,1,3]:[7,4,0,4];case"long-dash-dot-dot":case"esriSLSDashDotDot":return r?[8,3,1,3,1,3]:[7,4,0,4,0,4];case"short-dash":case"esriSLSShortDash":return r?[4,1]:[3,2];case"short-dash-dot":case"esriSLSShortDashDot":return r?[4,1,1,1]:[3,2,0,2];case"short-dash-dot-dot":case"esriSLSShortDashDotDot":return r?[4,1,1,1,1,1]:[3,2,0,2,0,2];case"short-dot":case"esriSLSShortDot":return r?[1,1]:[0,2];case"solid":case"esriSLSSolid":case"none":return x.error("Unexpected: style does not require rasterization"),[0,0];default:return x.error(`Tried to rasterize SLS, but found an unexpected style: ${e}!`),[0,0]}};function Y(e){return void 0!==e.symbolLayers}const X=e=>{const t=100,r=50;let o,i;const a=e;if("circle"===a||"esriSMSCircle"===a){const e=.25;let t=Math.acos(1-e/r),a=Math.ceil(d/t/4);0===a&&(a=1),t=g/a,a*=4;const n=[];n.push([r,0]);for(let o=1;o<a;o++)n.push([r*Math.cos(o*t),-r*Math.sin(o*t)]);n.push([r,0]),o={rings:[n]},i={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("cross"===a||"esriSMSCross"===a){const e=0;o={rings:[[[e,r],[e,e],[r,e],[r,-e],[e,-e],[e,-r],[-e,-r],[-e,-e],[-r,-e],[-r,e],[-e,e],[-e,r],[e,r]]]},i={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("diamond"===a||"esriSMSDiamond"===a)o={rings:[[[-r,0],[0,r],[r,0],[0,-r],[-r,0]]]},i={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("square"===a||"esriSMSSquare"===a)o={rings:[[[-r,-r],[-r,r],[r,r],[r,-r],[-r,-r]]]},i={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("x"===a||"esriSMSX"===a){const e=0;o={rings:[[[0,e],[r-e,r],[r,r-e],[e,0],[r,e-r],[r-e,-r],[0,-e],[e-r,-r],[-r,e-r],[-e,0],[-r,r-e],[e-r,r],[0,e]]]},i={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("triangle"===a||"esriSMSTriangle"===a){const e=t*.5773502691896257,r=-e,a=2/3*t,n=a-t;o={rings:[[[r,n],[0,a],[e,n],[r,n]]]},i={xmin:r,ymin:n,xmax:e,ymax:a}}else"arrow"===a&&(o={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},i={xmin:-r,ymin:-r,xmax:r,ymax:r});return[i,o]},U=e=>"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e;e.CIMSimbolInflatedSizeHelper=T,e.CIMSymbolHelper=D,e.OverrideHelper=z,e.SymbolHelper=G,e.slsDashToTemplateArray=_,e.symbolToCIM=w,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
