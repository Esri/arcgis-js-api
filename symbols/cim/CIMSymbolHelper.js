/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/Logger","../../core/mathUtils","../../Color","./CIMPlacements","./CIMSymbolDrawHelper","./packingUtils"],(function(e,r,t,o,i,a,s){"use strict";const n=Math.PI,c=n/2,l=r.getLogger("esri.symbols.cim.CIMSymbolHelper");function f(e,r){switch(r.type){case"CIMSymbolReference":{const t={type:"point",x:0,y:0};e.drawSymbol(r.symbol,t);break}case"CIMPointSymbol":{const t={type:"point",x:0,y:0};e.drawSymbol(r,t);break}case"CIMTextSymbol":break;case"CIMVectorMarker":{const t=new i.Placement;e.drawMarker(r,t);break}}return e.envelope()}let m=function(){function e(){}return e.getEnvelope=function(e){const r=new a.EnvDrawHelper;if(Array.isArray(e)){let t;for(const o of e)t?t.union(f(r,o)):t=f(r,o);return t}return f(r,e)},e.getTextureAnchor=function(e){const r=this.getEnvelope(e);if(!r||r.width<=0||r.height<=0)return[0,0,0];const t=96/72,o=(r.x+.5*r.width)*t,i=-(r.y+.5*r.height)*t,a=r.width*t+2,s=r.height*t+2;return[o/a,i/s,s]},e.rasterize=function(e,r,t,o=!0){const s=t||this.getEnvelope(r);if(!s||s.width<=0||s.height<=0)return[null,0,0,0,0];const n=96/72,c=(s.x+.5*s.width)*n,l=(s.y+.5*s.height)*n;e.width=s.width*n,e.height=s.height*n,t||(e.width+=2,e.height+=2);const f=e.getContext("2d"),m=a.Transformation.createScale(n,-n);m.translate(.5*e.width-c,.5*e.height+l);const y=new a.CanvasDrawHelper(f,m);switch(r.type){case"CIMPointSymbol":{const e={type:"point",x:0,y:0};y.drawSymbol(r,e);break}case"CIMVectorMarker":{const e=new i.Placement;y.drawMarker(r,e);break}}const h=f.getImageData(0,0,e.width,e.height),S=new Uint8Array(h.data);if(o){let e;for(let r=0;r<S.length;r+=4)e=S[r+3]/255,S[r]=S[r]*e,S[r+1]=S[r+1]*e,S[r+2]=S[r+2]*e}return[S,e.width,e.height,-c/e.width,-l/e.height]},e.fromSimpleMarker=function(e){const r=50;let t,o;const i=e.style;if("circle"===i||"esriSMSCircle"===i){const e=.25;let i=Math.acos(1-e/r),a=Math.ceil(n/i/4);0===a&&(a=1),i=c/a,a*=4;const s=[];s.push([r,0]);for(let e=1;e<a;e++)s.push([r*Math.cos(e*i),-50*Math.sin(e*i)]);s.push([r,0]),t={rings:[s]},o={xmin:-50,ymin:-50,xmax:r,ymax:r}}else if("cross"===i||"esriSMSCross"===i){const e=0;t={rings:[[[e,r],[e,e],[r,e],[r,-e],[e,-e],[e,-50],[-e,-50],[-e,-e],[-50,-e],[-50,e],[-e,e],[-e,r],[e,r]]]},o={xmin:-50,ymin:-50,xmax:r,ymax:r}}else if("diamond"===i||"esriSMSDiamond"===i)t={rings:[[[-50,0],[0,r],[r,0],[0,-50],[-50,0]]]},o={xmin:-50,ymin:-50,xmax:r,ymax:r};else if("square"===i||"esriSMSSquare"===i)t={rings:[[[-50,-50],[-50,r],[r,r],[r,-50],[-50,-50]]]},o={xmin:-50,ymin:-50,xmax:r,ymax:r};else if("x"===i||"esriSMSX"===i){const e=0;t={rings:[[[0,e],[r-e,r],[r,r-e],[e,0],[r,e-r],[r-e,-50],[0,-e],[e-r,-50],[-50,e-r],[-e,0],[-50,r-e],[e-r,r],[0,e]]]},o={xmin:-50,ymin:-50,xmax:r,ymax:r}}else if("triangle"===i||"esriSMSTriangle"===i){const e=100*.5773502691896257,r=-e,i=2/3*100,a=i-100;t={rings:[[[r,a],[0,i],[e,a],[r,a]]]},o={xmin:r,ymin:a,xmax:e,ymax:i}}else"arrow"!==i&&"esriSMSArrow"!==i||(t={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},o={xmin:-50,ymin:-50,xmax:r,ymax:r});let a;if(t&&o){const r=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&r.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});const i={type:"CIMPolygonSymbol",symbolLayers:r};a={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:o,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t,symbol:i}]}]}}return a},e.fromCIMHatchFill=function(e){const r=void 0!==e.separation?e.separation:4,t=r/2;let o=this._getLineSymbolPeriod(e.lineSymbol)||4;for(;o<4;)o*=2;const i=o/2;return{type:"CIMVectorMarker",frame:{xmin:-i,xmax:i,ymin:-t,ymax:t},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-i,0],[i,0]]]},symbol:e.lineSymbol}],size:r}},e._getLineSymbolPeriod=function(e){if(e){const r=this._getEffectsRepeat(e.effects);if(r)return r;if(e.symbolLayers)for(const r of e.symbolLayers){const e=this._getEffectsRepeat(r.effects);if(e)return e;if(r){const e=this._getPlacementRepeat(r.markerPlacement);if(e)return e}}}return 0},e._getEffectsRepeat=function(e){if(e)for(const r of e)if(r)switch(r.type){case"CIMGeometricEffectDashes":{const e=r.dashTemplate;if(e&&e.length){let r=0;for(const t of e)r+=t;return 1&e.length&&(r*=2),r}break}case"CIMGeometricEffectWave":return r.period;default:l.error(`unsupported geometric effect type ${r.type}`)}return 0},e._getPlacementRepeat=function(e){if(e)switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const r=e.placementTemplate;if(r&&r.length){let e=0;for(const t of r)e+=t;return 1&r.length&&(e*=2),e}break}}return 0},e.fromCIMInsidePolygon=function(e){const r=e.markerPlacement,t=r.stepX/2,o=r.stepY/2,i={xmin:-t,xmax:t,ymin:-o,ymax:o},a={type:e.type,...e};a.markerPlacement=null,a.anchorPoint=null;return{type:"CIMVectorMarker",frame:i,markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[a]}}],size:r.stepY}},e.getFillColor=function(r){if(!r)return null;switch(r.type){case"CIMPolygonSymbol":if(r.symbolLayers)for(const t of r.symbolLayers){const r=e.getFillColor(t);if(null!=r)return r}break;case"CIMTextSymbol":return e.getFillColor(r.symbol);case"CIMSolidFill":return r.color}},e.getStrokeColor=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(const t of r.symbolLayers){const r=e.getStrokeColor(t);if(void 0!==r)return r}break;case"CIMTextSymbol":return e.getStrokeColor(r.symbol);case"CIMSolidStroke":return r.color}},e.getStrokeWidth=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(const t of r.symbolLayers){const r=e.getStrokeWidth(t);if(void 0!==r)return r}break;case"CIMTextSymbol":return e.getStrokeWidth(r.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return r.width}},e.getSize=function(r){if(r)switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{let t=0;if(r.symbolLayers)for(const o of r.symbolLayers){const r=e.getSize(o);r>t&&(t=r)}return t}case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return r.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return r.size}},e.getMarkerScaleRatio=function(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){const r=e.frame.ymax-e.frame.ymin;return e.size/r}}return 1},e}(),y=function(){function e(){}return e.rasterizeSimpleFill=function(e,r,o){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization");const i=t.nextPowerOfTwo(Math.ceil(o)),a=this._isHorizontalOrVertical(r)?8*i:16*i,s=2*i;e.width=a,e.height=a;const n=e.getContext("2d");n.strokeStyle="#FFFFFF",n.lineWidth=i,n.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(n.moveTo(a/2,-s),n.lineTo(a/2,a+s)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(n.moveTo(-s,a/2),n.lineTo(a+s,a/2)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(n.moveTo(-s,-s),n.lineTo(a+s,a+s),n.moveTo(a-s,-s),n.lineTo(a+s,s),n.moveTo(-s,a-s),n.lineTo(s,a+s)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(n.moveTo(a+s,-s),n.lineTo(-s,a+s),n.moveTo(s,-s),n.lineTo(-s,s),n.moveTo(a+s,a-s),n.lineTo(a-s,a+s)),n.stroke();const c=n.getImageData(0,0,e.width,e.height),l=new Uint8Array(c.data);let f;for(let e=0;e<l.length;e+=4)f=l[e+3]/255,l[e]=l[e]*f,l[e+1]=l[e+1]*f,l[e+2]=l[e+2]*f;return[l,e.width,e.height]},e.rasterizeSimpleLine=function(e,r){let t;switch(r){case"butt":t="Butt";break;case"square":t="Square";break;default:t="Round"}const o="Butt"===t;let i;switch(e){case"dash":case"esriSLSDash":i=o?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":i=o?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":i=o?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":i=o?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":i=o?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":i=o?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":i=o?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":i=o?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":i=o?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":i=o?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":l.error("Unexpected: style does not require rasterization"),i=[0,0];break;default:l.error(`Tried to rasterize SLS, but found an unexpected style: ${e}!`),i=[0,0]}return this.rasterizeDash(i,t)},e.rasterizeDash=function(e,r){const t="Butt"===r,o="Square"===r,i=!t&&!o,a=15;let n=0;for(const r of e)n+=r;const c=n*a,l=31*c,f=new Float32Array(l),m=i?225:a;for(let e=0;e<l;++e)f[e]=m;const y=7.5;let h=0,S=0,p=!0;for(const r of e){h=S,S+=r*a;let e=h;for(;e<S;){let r=0;for(;r<31;){const a=r*c+e,s=i?(r-15)*(r-15):Math.abs(r-15);f[a]=p?t?Math.max(Math.max(h+y-e,s),Math.max(e-S+y,s)):s:i?Math.min((e-h)*(e-h)+s,(e-S)*(e-S)+s):o?Math.min(Math.max(e-h,s),Math.max(S-e,s)):Math.min(Math.max(e-h+y,s),Math.max(S+y-e,s)),r++}e++}p=!p}const u=f.length,d=new Uint8Array(4*u);for(let e=0;e<u;++e){const r=(i?Math.sqrt(f[e]):f[e])/a;s.packFloatRGBA(r,d,4*e)}return[d,c,31]},e._isHorizontalOrVertical=function(e){return"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e},e}(),h=function(){function e(){}return e.findApplicableOverrides=function(r,t,o){if(t){if(r.primitiveName){let e=!1;for(const t of o)if(t.primitiveName===r.primitiveName){e=!0;break}if(!e)for(const e of t)e.primitiveName===r.primitiveName&&o.push(e)}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(const i of r.effects)e.findApplicableOverrides(i,t,o);if(r.symbolLayers)for(const i of r.symbolLayers)e.findApplicableOverrides(i,t,o);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(r.effects)for(const i of r.effects)e.findApplicableOverrides(i,t,o);if(r.markerPlacement&&e.findApplicableOverrides(r.markerPlacement,t,o),"CIMVectorMarker"===r.type){if(r.markerGraphics)for(const i of r.markerGraphics)e.findApplicableOverrides(i,t,o),e.findApplicableOverrides(i.symbol,t,o)}else"CIMCharacterMarker"===r.type?e.findApplicableOverrides(r.symbol,t,o):"CIMHatchFill"===r.type&&e.findApplicableOverrides(r.lineSymbol,t,o)}}},e.applyOverrides=function(r,t,o,i){if(!t)return;if(r.primitiveName)for(const s of t)if(s.primitiveName===r.primitiveName){const t=(a=s.propertyName)?a.charAt(0).toLowerCase()+a.substr(1):a;if(i&&i.push({cim:r,nocapPropertyName:t,value:r[t]}),s.expression&&(s.value=e.toValue(s.propertyName,s.expression)),o){let e=!1;for(const t of o)t.primitiveName===r.primitiveName&&(e=!0);e||o.push(s)}r[t]=s.value}var a;switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(const a of r.effects)e.applyOverrides(a,t,o,i);if(r.symbolLayers)for(const a of r.symbolLayers)e.applyOverrides(a,t,o,i);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(r.effects)for(const a of r.effects)e.applyOverrides(a,t,o,i);if("CIMVectorMarker"===r.type&&r.markerGraphics)for(const a of r.markerGraphics)e.applyOverrides(a,t,o,i),e.applyOverrides(a.symbol,t,o,i)}},e.restoreOverrides=function(e){for(const r of e)r.cim[r.nocapPropertyName]=r.value},e.buildOverrideKey=function(e){let r="";for(const t of e)void 0!==t.value&&(r+=`${t.primitiveName}${t.propertyName}${JSON.stringify(t.value)}`);return r},e.toValue=function(e,r){if("DashTemplate"===e)return r.split(" ").map((e=>Number(e)));if("Color"===e){const e=new o(r).toRgba();return e[3]*=255,e}return r},e}();e.CIMSymbolHelper=m,e.OverrideHelper=h,e.SymbolHelper=y,Object.defineProperty(e,"__esModule",{value:!0})}));
