// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../geometry/support/jsonUtils","./packingUtils","./Rect"],(function(r,n,t,a,o){"use strict";function e(r){for(var n=1/0,t=-1/0,a=1/0,o=-1/0,e=0,i=r;e<i.length;e++)for(var l=0,u=i[e];l<u.length;l++){var v=u[l];v[0]<n&&(n=v[0]),v[0]>t&&(t=v[0]),v[1]<a&&(a=v[1]),v[1]>o&&(o=v[1])}return[n,a,t,o]}function i(r,n){for(var t=2*n,o=r.length,e=new Uint8Array(4*o),i=0;i<o;++i){var l=.5-r[i]/t;a.packFloatRGBA(l,e,4*i)}return e}Object.defineProperty(n,"__esModule",{value:!0}),n.buildSDF=n.getSDFMetrics=n.getExtent=n.getSDFSymbol=n.getSDFInfo=void 0,n.getSDFInfo=function r(n){if(!n)return null;switch(n.type){case"CIMPointSymbol":var t=n.symbolLayers;return t&&1===t.length?r(t[0]):null;case"CIMVectorMarker":var a=n.markerGraphics;if(!a||1!==a.length)return null;var o=a[0];if(!o)return null;var e=o.geometry;if(!e)return null;var i=o.symbol;return!i||"CIMPolygonSymbol"!==i.type&&"CIMLineSymbol"!==i.type?null:{geom:e,asFill:"CIMPolygonSymbol"===i.type};case"sdf":return{geom:n.geom,asFill:n.asFill}}return null},n.getSDFSymbol=function(r){var n=r.markerGraphics;if(!n||1!==n.length)return null;var t=n[0];if(!t)return null;var a=t.symbol;return!a||"CIMPolygonSymbol"!==a.type&&"CIMLineSymbol"!==a.type?null:a},n.getExtent=function(r){return r?r.rings?e(r.rings):r.paths?e(r.paths):t.isExtent(r)?[r.xmin,r.ymin,r.xmax,r.ymax]:null:null},n.getSDFMetrics=function(r,n,t,a,o){var e=r[0],i=r[1],l=r[2],u=r[3];if(l<e||u<i)return[0,0,0];var v=l-e,f=u-i,m=Math.floor(31.5),h=(128-2*(m+1))/Math.max(v,f),y=Math.round(v*h)+2*m,g=Math.round(f*h)+2*m,s=1;n&&(s=g/h/(n.ymax-n.ymin));var x=0,d=0;if(a)if(o){if(n&&t&&n.ymax-n.ymin>0){var M=(n.xmax-n.xmin)/(n.ymax-n.ymin);x=a.x/(t*M),d=a.y/t}}else x=a.x,d=a.y;return x=.5*(n.xmax+n.xmin)+x*(n.xmax-n.xmin),d=.5*(n.ymax+n.ymin)+d*(n.ymax-n.ymin),x-=e,d-=i,x*=h,d*=h,[s,(x+=m)/y-.5,-((d+=m)/g-.5)]},n.buildSDF=function(r){for(var n,t=(n=r.geom)?n.rings?n.rings:n.paths?n.paths:void 0!==n.xmin&&void 0!==n.ymin&&void 0!==n.xmax&&void 0!==n.ymax?[[[n.xmin,n.ymin],[n.xmin,n.ymax],[n.xmax,n.ymax],[n.xmax,n.ymin],[n.xmin,n.ymin]]]:null:null,a=function(r){for(var n=1/0,t=-1/0,a=1/0,e=-1/0,i=0,l=r;i<l.length;i++)for(var u=0,v=l[i];u<v.length;u++){var f=v[u];f[0]<n&&(n=f[0]),f[0]>t&&(t=f[0]),f[1]<a&&(a=f[1]),f[1]>e&&(e=f[1])}return new o.default(n,a,t-n,e-a)}(t),e=Math.floor(31.5),l=(128-2*(e+1))/Math.max(a.width,a.height),u=Math.round(a.width*l)+2*e,v=Math.round(a.height*l)+2*e,f=[],m=0,h=t;m<h.length;m++){var y=h[m];if(y&&y.length>1){for(var g=[],s=0,x=y;s<x.length;s++){var d=x[s],M=d[0],c=d[1];M-=a.x,c-=a.y,M*=l,c*=l,M+=e-.5,c+=e-.5,g.push([M,c])}if(r.asFill){var p=g.length-1;g[0][0]===g[p][0]&&g[0][1]===g[p][1]||g.push(g[0])}f.push(g)}}var S=function(r,n,t,a){for(var o=n*t,e=new Array(o),i=a*a+1,l=0;l<o;++l)e[l]=i;for(var u=0,v=r;u<v.length;u++){var f=v[u],m=f.length;for(l=1;l<m;++l){var h=f[l-1],y=f[l],g=void 0,s=void 0;h[0]<y[0]?(g=h[0],s=y[0]):(g=y[0],s=h[0]);var x=void 0,d=void 0;h[1]<y[1]?(x=h[1],d=y[1]):(x=y[1],d=h[1]);var M=Math.floor(g)-a,c=Math.floor(s)+a,p=Math.floor(x)-a,S=Math.floor(d)+a;M<0&&(M=0),c>n&&(c=n),p<0&&(p=0),S>t&&(S=t);for(var b=y[0]-h[0],F=y[1]-h[1],I=b*b+F*F,D=M;D<c;D++)for(var C=p;C<S;C++){var w=(D-h[0])*b+(C-h[1])*F,k=void 0,P=void 0;w<0?(k=h[0],P=h[1]):w>I?(k=y[0],P=y[1]):(w/=I,k=h[0]+w*b,P=h[1]+w*F);var A=(D-k)*(D-k)+(C-P)*(C-P),E=(t-C-1)*n+D;A<e[E]&&(e[E]=A)}}}for(l=0;l<o;++l)e[l]=Math.sqrt(e[l]);return e}(f,u,v,e);return r.asFill&&function(r,n,t,a,o){for(var e=0,i=r;e<i.length;e++)for(var l=i[e],u=l.length,v=1;v<u;++v){var f=l[v-1],m=l[v],h=void 0,y=void 0;f[0]<m[0]?(h=f[0],y=m[0]):(h=m[0],y=f[0]);var g=void 0,s=void 0;f[1]<m[1]?(g=f[1],s=m[1]):(g=m[1],s=f[1]);var x=Math.floor(h),d=Math.floor(y)+1,M=Math.floor(g),c=Math.floor(s)+1;x<a&&(x=a),d>n-a&&(d=n-a),M<a&&(M=a),c>t-a&&(c=t-a);for(var p=M;p<c;++p)if(f[1]>p!=m[1]>p){for(var S=(t-p-1)*n,b=x;b<d;++b)b<(m[0]-f[0])*(p-f[1])/(m[1]-f[1])+f[0]&&(o[S+b]=-o[S+b]);for(b=a;b<x;++b)o[S+b]=-o[S+b]}}}(f,u,v,e,S),[i(S,e),u,v]}}));