/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../core/mathUtils","./CIMSymbolHelper","./rasterizingUtils","./Rect","./SDFHelper","./utils"],(function(e,t,r,a,n,i){"use strict";const s=512;return function(){function o(e){this._resourceManager=e}var l=o.prototype;return l.dispose=function(){this._rasterizationCanvas=null},l.rasterizeJSONResource=function(i,s,o){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===i.type||"esriSFS"===i.type){const[t,a,n]=r.rasterizeSimpleFill(this._rasterizationCanvas,i.style,s);return{size:[a,n],image:new Uint32Array(t.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:e.nextPowerOfTwo(Math.ceil(s))}}if("simple-line"===i.type||"esriSLS"===i.type||"line"===i.type&&i.dashTemplate){let e,a;if("simple-line"===i.type||"esriSLS"===i.type)switch(e=t.slsDashToTemplateArray(i.style,i.cap),i.cap){case"butt":a="Butt";break;case"square":a="Square";break;default:a="Round"}else e=i.dashTemplate,a=i.cim.capStyle;const[n,s,o]=r.rasterizeDash(e,a);return{size:[s,o],image:new Uint32Array(n.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let l,m,c,f=1;if("simple-marker"===i.type||"esriSMS"===i.type||"line-marker"===i.type?(l=t.CIMSymbolHelper.fromSimpleMarker(i),c=n.getSDFInfo(l)):i.cim&&"CIMHatchFill"===i.cim.type?(l=t.CIMSymbolHelper.fromCIMHatchFill(i.cim,s),m=new a(l.frame.xmin,-l.frame.ymax,l.frame.xmax-l.frame.xmin,l.frame.ymax-l.frame.ymin),f=s):i.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===i.cim.markerPlacement.type?(l=t.CIMSymbolHelper.fromCIMInsidePolygon(i.cim),m=new a(l.frame.xmin,-l.frame.ymax,l.frame.xmax-l.frame.xmin,l.frame.ymax-l.frame.ymin)):(l=i.cim,c=n.getSDFInfo(l)),c&&!o){const[e,t,r]=n.buildSDF(c);return e?{size:[t,r],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:f}:null}const[h,p,u,y,d]=t.CIMSymbolHelper.rasterize(this._rasterizationCanvas,l,m,this._resourceManager,!o);return h?{size:[p,u],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1,anchorX:y,anchorY:d}:null},l.rasterizeImageResource=function(e,t,r,a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const n=this._rasterizationCanvas.getContext("2d");r instanceof ImageData?n.putImageData(r,0,0):(r.setAttribute("width",`${e}px`),r.setAttribute("height",`${t}px`),n.drawImage(r,0,0,e,t));const o=n.getImageData(0,0,e,t),l=new Uint8Array(o.data);if(a)for(const i of a)if(i&&i.oldColor&&4===i.oldColor.length&&i.newColor&&4===i.newColor.length){const[e,t,r,a]=i.oldColor,[n,s,o,m]=i.newColor;if(e===n&&t===s&&r===o&&a===m)continue;for(let i=0;i<l.length;i+=4)e===l[i]&&t===l[i+1]&&r===l[i+2]&&a===l[i+3]&&(l[i]=n,l[i+1]=s,l[i+2]=o,l[i+3]=m)}let m;for(let i=0;i<l.length;i+=4)m=l[i+3]/255,l[i]=l[i]*m,l[i+1]=l[i+1]*m,l[i+2]=l[i+2]*m;let c=l,f=e,h=t;const p=s;if(f>=p||h>=p){const r=f/h;r>1?(f=p,h=Math.round(p/r)):(h=p,f=Math.round(p*r)),c=new Uint8Array(4*f*h);const a=new Uint8ClampedArray(c.buffer);i.resampleHermite(l,e,t,a,f,h,!1)}return{size:[f,h],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}},o}()}));
