/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["../../core/mathUtils","./CIMSymbolHelper","./rasterizingUtils","./Rect","./SDFHelper","./utils"],(function(e,t,a,r,n,i){"use strict";const s=512;return function(){function o(e){this._resourceManager=e,this._rasterizationCanvas=null}var l=o.prototype;return l.dispose=function(){this._rasterizationCanvas=null},l.rasterizeJSONResource=function(i,s,o){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===i.type||"esriSFS"===i.type){const[t,r,n]=a.rasterizeSimpleFill(this._rasterizationCanvas,i.style,s);return{size:[r,n],image:new Uint32Array(t.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:e.nextPowerOfTwo(Math.ceil(s))}}if("simple-line"===i.type||"esriSLS"===i.type||"line"===i.type&&i.dashTemplate){let e,r;if("simple-line"===i.type||"esriSLS"===i.type)switch(e=t.slsDashToTemplateArray(i.style,i.cap),i.cap){case"butt":r="Butt";break;case"square":r="Square";break;default:r="Round"}else e=i.dashTemplate,r=i.cim.capStyle;const[n,s,o]=a.rasterizeDash(e,r);return{size:[s,o],image:new Uint32Array(n.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let l,m=null,c=null,f=1;if("simple-marker"===i.type||"esriSMS"===i.type||"line-marker"===i.type?(l=t.CIMSymbolHelper.fromSimpleMarker(i),c=n.getSDFInfo(l)):i.cim&&"CIMHatchFill"===i.cim.type?(l=t.CIMSymbolHelper.fromCIMHatchFill(i.cim,s),m=new r(l.frame.xmin,-l.frame.ymax,l.frame.xmax-l.frame.xmin,l.frame.ymax-l.frame.ymin),f=s):i.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===i.cim.markerPlacement.type?(l=t.CIMSymbolHelper.fromCIMInsidePolygon(i.cim),m=new r(l.frame.xmin,-l.frame.ymax,l.frame.xmax-l.frame.xmin,l.frame.ymax-l.frame.ymin)):(l=i.cim,i.avoidSDFRasterization||(c=n.getSDFInfo(l))),c&&!o){const[e,t,a]=n.buildSDF(c);return e?{size:[t,a],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:f}:null}const[u,h,p,y,d]=t.CIMSymbolHelper.rasterize(this._rasterizationCanvas,l,m,this._resourceManager,!o);return u?{size:[h,p],image:new Uint32Array(u.buffer),sdf:!1,simplePattern:!1,anchorX:y,anchorY:d}:null},l.rasterizeImageResource=function(e,t,a,r){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const n=this._rasterizationCanvas.getContext("2d");a instanceof ImageData?n.putImageData(a,0,0):(a.setAttribute("width",`${e}px`),a.setAttribute("height",`${t}px`),n.drawImage(a,0,0,e,t));const o=n.getImageData(0,0,e,t),l=new Uint8Array(o.data);if(r)for(const i of r)if(i&&i.oldColor&&4===i.oldColor.length&&i.newColor&&4===i.newColor.length){const[e,t,a,r]=i.oldColor,[n,s,o,m]=i.newColor;if(e===n&&t===s&&a===o&&r===m)continue;for(let i=0;i<l.length;i+=4)e===l[i]&&t===l[i+1]&&a===l[i+2]&&r===l[i+3]&&(l[i]=n,l[i+1]=s,l[i+2]=o,l[i+3]=m)}let m;for(let i=0;i<l.length;i+=4)m=l[i+3]/255,l[i]=l[i]*m,l[i+1]=l[i+1]*m,l[i+2]=l[i+2]*m;let c=l,f=e,u=t;const h=s;if(f>=h||u>=h){const a=f/u;a>1?(f=h,u=Math.round(h/a)):(u=h,f=Math.round(h*a)),c=new Uint8Array(4*f*u);const r=new Uint8ClampedArray(c.buffer);i.resampleHermite(l,e,t,r,f,u,!1)}return{size:[f,u],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}},o}()}));
