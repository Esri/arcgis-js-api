/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/string","../../core/Logger","../../support/arcadeOnDemand","../../Color","../../core/screenUtils","./utils","../../views/2d/arcade/callExpressionWithFeature","./CIMSymbolHelper","./SDFHelper"],(function(e,t,i,o,r,n,a,l,s,c){"use strict";const f=i.getLogger("esri.symbols.cim.cimAnalyzer");function m(e){switch(e){case"Butt":return 0;case"Square":return 2;case"Round":default:return 1}}function p(e){switch(e){case"Bevel":return 0;case"Miter":return 2;case"Round":default:return 1}}function u(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function y(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function h(e){let t="normal",i="normal";if(e){const o=e.toLowerCase();-1!==o.indexOf("italic")?t="italic":-1!==o.indexOf("oblique")&&(t="oblique"),-1!==o.indexOf("bold")?i="bold":-1!==o.indexOf("light")&&(i="lighter")}return{style:t,weight:i}}function g(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function d(e,t,i,o){let r;e[t]?r=e[t]:(r={},e[t]=r),r[i]=o}function S(e){const t=e.markerPlacement;return t&&t.angleToLine?1:0}async function C(e,t,i,r){const n=i||[];if(!e)return n;let a,l;const s={};if("CIMSymbolReference"!==e.type)return f.error("Expect cim type to be 'CIMSymbolReference'"),n;if(a=e.symbol,l=e.primitiveOverrides,l){const e=[];for(const i of l){const r=i.valueExpressionInfo;if(r&&t){const n=r.expression,a=o.createRendererExpression(n,t.spatialReference,t.fields).then((e=>{e&&d(s,i.primitiveName,i.propertyName,e)}));e.push(a)}else null!=i.value&&d(s,i.primitiveName,i.propertyName,i.value)}await Promise.all(e)}switch(a.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":b(a,l,s,t,n,r)}return n}function b(e,t,i,o,r,n){if(!e)return;const a=e.symbolLayers;if(!a)return;let l;const c=s.CIMSymbolHelper.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(l=1);let m=a.length;for(;m--;){const p=a[m];if(!p||!1===p.enable)continue;const u=[];switch(s.OverrideHelper.findApplicableOverrides(p,t,u),p.type){case"CIMSolidFill":v(p,i,u,o,r);break;case"CIMPictureFill":N(p,i,u,o,r);break;case"CIMHatchFill":O(p,i,u,o,r);break;case"CIMGradientFill":k(p,i,u,o,r);break;case"CIMSolidStroke":M(p,i,u,o,r,"CIMPolygonSymbol"===e.type,c);break;case"CIMPictureStroke":H(p,i,u,o,r,"CIMPolygonSymbol"===e.type,c);break;case"CIMGradientStroke":I(p,i,u,o,r,"CIMPolygonSymbol"===e.type,c);break;case"CIMCharacterMarker":if(P(p,i,u,o,r))break;break;case"CIMPictureMarker":if(P(p,i,u,o,r))break;"CIMLineSymbol"===e.type&&(l=S(p)),L(p,i,u,o,r,l,c);break;case"CIMVectorMarker":if(P(p,i,u,o,r))break;"CIMLineSymbol"===e.type&&(l=S(p)),x(p,i,u,o,r,l,c,n);break;default:f.error("Cannot analyze CIM layer",p.type)}}}function v(e,i,o,r,n){const l=e.primitiveName,s=a.fromCIMColor(e.color),c=t.numericHash(JSON.stringify(e)).toString();n.push({type:"fill",templateHash:c,materialHash:0===o.length?c:()=>c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:A(l,i,"Color",r,s,R),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e.effects})}function N(e,i,o,r,n){const l=e.primitiveName,s=e.tintColor?a.fromCIMColor(e.tintColor):{r:255,g:255,b:255,a:1},c=t.numericHash(JSON.stringify(e)).toString(),f=t.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();n.push({type:"fill",templateHash:c,materialHash:0===o.length?f:()=>f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:A(l,i,"TintColor",r,s,R),height:A(l,i,"Height",r,e.height),scaleX:A(l,i,"ScaleX",r,e.scaleX),angle:A(l,i,"Rotation",r,e.rotation),offsetX:A(l,i,"OffsetX",r,e.offsetX),offsetY:A(l,i,"OffsetY",r,e.offsetY)})}function O(e,i,o,r,n){const a=["Rotation","OffsetX","OffsetY"],l=o.filter((t=>t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName))),s=e.primitiveName,c=t.numericHash(JSON.stringify(e)).toString(),f=t.numericHash(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();n.push({type:"fill",templateHash:c,materialHash:0===o.length?f:$(f,i,l,r),cim:e,materialOverrides:l,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:A(s,i,"Separation",r,e.separation),scaleX:1,angle:A(s,i,"Rotation",r,e.rotation),offsetX:A(s,i,"OffsetX",r,e.offsetX),offsetY:A(s,i,"OffsetY",r,e.offsetY)})}function k(e,i,o,r,n){const a=t.numericHash(JSON.stringify(e)).toString();n.push({type:"fill",templateHash:a,materialHash:0===o.length?a:$(a,i,o,r),cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function M(e,i,o,r,n,l,s){const c=t.numericHash(JSON.stringify(e)).toString(),f=e.primitiveName,u=a.fromCIMColor(e.color),y=void 0!==e.width?e.width:4,h=m(e.capStyle),g=p(e.joinStyle),d=e.miterLimit;n.push({type:"line",templateHash:c,materialHash:0===o.length?c:()=>c,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:e.effects,color:A(f,i,"Color",r,u,R),width:A(f,i,"Width",r,y),cap:A(f,i,"CapStyle",r,h),join:A(f,i,"JoinStyle",r,g),miterLimit:A(f,i,"MiterLimit",r,d),referenceWidth:s,zOrder:Y(e.name),isDashed:!1})}function H(e,i,o,r,n,l,s){const c=t.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),f=e.primitiveName,u=a.fromCIMColor(e.tintColor),y=void 0!==e.width?e.width:4,h=m(e.capStyle),g=p(e.joinStyle),d=e.miterLimit,S=t.numericHash(JSON.stringify(e)).toString();n.push({type:"line",templateHash:S,materialHash:0===o.length?c:()=>c,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:e.effects,color:A(f,i,"TintColor",r,u,R),width:A(f,i,"Width",r,y),cap:A(f,i,"CapStyle",r,h),join:A(f,i,"JoinStyle",r,g),miterLimit:A(f,i,"MiterLimit",r,d),referenceWidth:s,zOrder:Y(e.name),isDashed:!1})}function I(e,i,o,r,n,a,l){const s=e.primitiveName,c=void 0!==e.width?e.width:4,f=m(e.capStyle),u=p(e.joinStyle),y=e.miterLimit,h=t.numericHash(JSON.stringify(e)).toString();n.push({type:"line",templateHash:h,materialHash:0===o.length?h:$(h,i,o,r),cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},width:A(s,i,"Width",r,c),cap:A(s,i,"CapStyle",r,f),join:A(s,i,"JoinStyle",r,u),miterLimit:A(s,i,"MiterLimit",r,y),referenceWidth:l,zOrder:Y(e.name),isDashed:!1})}function P(e,i,o,r,n){const a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;const l=a,s=["Rotation","OffsetX","OffsetY"],c=o.filter((t=>t.primitiveName!==e.primitiveName&&-1===s.indexOf(t.propertyName))),f=t.numericHash(JSON.stringify(e)).toString();return n.push({type:"fill",templateHash:f,materialHash:0===o.length?f:$(f,i,c,r),cim:e,materialOverrides:c,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:A(l.primitiveName,i,"StepY",r,l.stepY),scaleX:1,angle:A(l.primitiveName,i,"GridAngle",r,l.gridAngle),offsetX:A(l.primitiveName,i,"OffsetX",r,l.offsetX),offsetY:A(l.primitiveName,i,"OffsetY",r,l.offsetY)}),!0}function L(e,i,o,r,n,l,s){const c=e.primitiveName,f=e.size,m=e.scaleX,p=e.rotation,u=e.offsetX,y=e.offsetY,h=a.fromCIMColor(e.tintColor),g=t.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let d=!1,S="";for(const t of o)t.primitiveName===c&&(void 0!==t.value?S+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`:t.valueExpressionInfo&&(d=!0));n.push({type:"marker",templateHash:t.numericHash(JSON.stringify(e)+S).toString(),materialHash:d?()=>g:g,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:!1,alignment:l,size:A(c,i,"Size",r,f),scaleX:A(c,i,"ScaleX",r,m),rotation:A(c,i,"Rotation",r,p),offsetX:A(c,i,"OffsetX",r,u),offsetY:A(c,i,"OffsetY",r,y),color:A(c,i,"TintColor",r,h,R),anchorPoint:e.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:e.markerPlacement})}function x(e,t,i,o,r,n,a,l){const s=e.markerGraphics;if(!s)return;let c=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(c=t.ymax-t.ymin)}for(const f of s)if(f){const s=f.symbol;if(!s)continue;switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":z(e,f,i,t,o,r,n,a,c,l);break;case"CIMTextSymbol":X(e,f,t,i,o,r,n,a,c)}}}function X(e,i,o,r,n,l,c,f,m){const p=[];s.OverrideHelper.findApplicableOverrides(i,r,p);const d=i.geometry;if(!("x"in d)||!("y"in d))return;const S=i.symbol,C=g(S),b=h(S.fontStyleName);S.font={family:S.fontFamilyName,decoration:C,...b};const v=e.frame,N=d.x-.5*(v.xmin+v.xmax),O=d.y-.5*(v.ymin+v.ymax),k=e.size/m,M=e.primitiveName,H=(S.height||0)*k,I=S.angle||0,P=((S.offsetX||0)+N)*k,L=((S.offsetY||0)+O)*k,x=a.fromCIMColor(s.CIMSymbolHelper.getFillColor(S));let X=a.fromCIMColor(s.CIMSymbolHelper.getStrokeColor(S)),z=s.CIMSymbolHelper.getStrokeWidth(S);z||(X=a.fromCIMColor(s.CIMSymbolHelper.getFillColor(S.haloSymbol)),z=S.haloSize*k);let w="";for(const t of r)t.primitiveName===M&&void 0!==t.value&&(w+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`);const J=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),Y=t.numericHash(JSON.stringify(i)+J+w).toString();l.push({type:"text",templateHash:Y,materialHash:()=>t.numericHash(JSON.stringify(S.font)).toString(),cim:S,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,alignment:c,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:S.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:A(M,o,"Size",n,H),angle:A(M,o,"Rotation",n,I),offsetX:A(M,o,"OffsetX",n,P),offsetY:A(M,o,"OffsetY",n,L),horizontalAlignment:u(S.horizontalAlignment),verticalAlignment:y(S.verticalAlignment),text:A(i.primitiveName,o,"TextString",n,i.textString,a._adjustTextCase,S.textCase),color:x,outlineColor:X,outlineSize:z,referenceSize:f,sizeRatio:1,markerPlacement:e.markerPlacement})}function z(e,i,o,r,n,l,f,m,p,u){const y=i.symbol,h=i.geometry;if(!h)return;const g=y.symbolLayers;if(!g)return;if(u)return void w(e,i,r,o,n,l,f,m,p);let d=g.length;for(;d--;){const u=g[d];if(u&&!1!==u.enable)switch(u.type){case"CIMSolidFill":case"CIMSolidStroke":{const y=c.getExtent(h);if(!y)continue;const[g,d,S]=c.getSDFMetrics(y,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),C="CIMSolidFill"===u.type,b={type:"sdf",geom:h,asFill:C},v=e.primitiveName,N=e.size,O=e.rotation||0,k=e.offsetX,M=e.offsetY,H=u.primitiveName,I=C?a.fromCIMColor(s.CIMSymbolHelper.getFillColor(u)):a.fromCIMColor(s.CIMSymbolHelper.getStrokeColor(u)),P=C?{r:0,g:0,b:0,a:0}:a.fromCIMColor(s.CIMSymbolHelper.getStrokeColor(u)),L=s.CIMSymbolHelper.getStrokeWidth(u);if(!C&&!L)break;let x=!1,X="";for(const e of o)e.primitiveName!==H&&e.primitiveName!==v||(void 0!==e.value?X+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(x=!0));const z=JSON.stringify({...e,markerGraphics:null}),w=t.numericHash(JSON.stringify(b)).toString(),J={type:"marker",templateHash:t.numericHash(JSON.stringify(i)+JSON.stringify(u)+z+X).toString(),materialHash:x?()=>w:w,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:d,y:S},isAbsoluteAnchorPoint:!1,size:A(e.primitiveName,r,"Size",n,N),rotation:A(e.primitiveName,r,"Rotation",n,O),offsetX:A(e.primitiveName,r,"OffsetX",n,k),offsetY:A(e.primitiveName,r,"OffsetY",n,M),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:g,color:A(H,r,"Color",n,I,R),outlineColor:A(H,r,"Color",n,P,R),outlineWidth:A(H,r,"Width",n,L),markerPlacement:e.markerPlacement};l.push(J);break}default:w(e,i,r,o,n,l,f,m,p)}}}function w(e,i,o,r,a,l,c,f,m){const p=J(e,i);let u=[];const y=["Rotation","OffsetX","OffsetY"];u=r.filter((t=>t.primitiveName!==e.primitiveName||-1===y.indexOf(t.propertyName)));let h="";for(const t of r)void 0!==t.value&&(h+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`);const[g,d,S]=s.CIMSymbolHelper.getTextureAnchor(p),C=e.primitiveName,b=e.rotation||0,v=e.offsetX||0,N=e.offsetY||0,O=t.numericHash(JSON.stringify(p)+h).toString(),k={type:"marker",templateHash:O,materialHash:0===u.length?O:$(O,o,u,a),cim:p,materialOverrides:u,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:g,y:d},isAbsoluteAnchorPoint:!1,size:e.size,rotation:A(C,o,"Rotation",a,b),offsetX:A(C,o,"OffsetX",a,v),offsetY:A(C,o,"OffsetY",a,N),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:S/n.pt2px(e.size),markerPlacement:e.markerPlacement};l.push(k)}function J(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath,effects:e.effects}}function Y(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(NaN!==t)return t}return 0}function R(e){if(!e||0===e.length)return null;const t=new r(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function A(e,t,i,r,n,a,s){const c=t[e];if(c){const e=c[i];if("string"==typeof e||"number"==typeof e||e instanceof Array)return a?a.call(null,e,s):e;if(null!=e&&e instanceof o.ArcadeExpression)return(t,i,o)=>{let c=l(e,t,{$view:o},r.geometryType,i);return null!==c&&a&&(c=a.call(null,c,s)),null!==c?c:n}}return n}function $(e,i,r,n){for(const t of r){if(t.valueExpressionInfo){const e=i[t.primitiveName]&&i[t.primitiveName][t.propertyName];e instanceof o.ArcadeExpression&&(t.fn=(t,i,o)=>l(e,t,{$view:o},n.geometryType,i))}}return(i,o,n)=>{for(const e of r)e.fn&&(e.value=e.fn(i,o,n));return t.numericHash(e+s.OverrideHelper.buildOverrideKey(r)).toString()}}function F(e,t){if(!t||0===t.length)return e;const i=JSON.parse(JSON.stringify(e));return s.OverrideHelper.applyOverrides(i,t),i}e.analyzeCIMResource=F,e.analyzeCIMSymbol=C,Object.defineProperty(e,"__esModule",{value:!0})}));
