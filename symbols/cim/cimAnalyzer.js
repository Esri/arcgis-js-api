// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../Color","../../core/Logger","../../core/promiseUtils","../../core/screenUtils","../../core/string","../../support/arcadeOnDemand","./CIMSymbolHelper","./SDFHelper","./utils","../../views/2d/arcade/callExpressionWithFeature"],(function(e,t,r,i,o,a,n,l,s,f,c,m,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.analyzeCIMResource=t.analyzeCIMSymbol=void 0;var p=o.getLogger("esri.symbols.cim.cimAnalyzer");function h(e){switch(e){case"Butt":return 0;case"Square":return 2;case"Round":default:return 1}}function y(e){switch(e){case"Bevel":return 0;case"Miter":return 2;case"Round":default:return 1}}function g(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function v(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function d(e,t,r,i){var o;e[t]?o=e[t]:(o={},e[t]=o),o[r]=i}function S(e){var t=e.markerPlacement;return t&&t.angleToLine?1:0}function C(e,t,r,i,o){var a=e.primitiveName,n=m.fromCIMColor(e.color),s=l.numericHash(JSON.stringify(e)).toString();o.push({type:"fill",templateHash:s,materialHash:0===r.length?s:function(){return s},cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:Y(a,t,"Color",i,n,J),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e.effects})}function b(e,t,r,i,o){var a=e.primitiveName,n=e.tintColor?m.fromCIMColor(e.tintColor):{r:255,g:255,b:255,a:1},s=l.numericHash(JSON.stringify(e)).toString(),f=l.numericHash(""+e.url+JSON.stringify(e.colorSubstitutions)).toString();o.push({type:"fill",templateHash:s,materialHash:0===r.length?f:function(){return f},cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:Y(a,t,"TintColor",i,n,J),height:Y(a,t,"Height",i,e.height),scaleX:Y(a,t,"ScaleX",i,e.scaleX),angle:Y(a,t,"Rotation",i,e.rotation),offsetX:Y(a,t,"OffsetX",i,e.offsetX),offsetY:Y(a,t,"OffsetY",i,e.offsetY)})}function N(e,t,r,i,o){var a=["Rotation","OffsetX","OffsetY"],n=r.filter((function(t){return t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName)})),s=e.primitiveName,f=l.numericHash(JSON.stringify(e)).toString(),c=l.numericHash(""+e.separation+JSON.stringify(e.lineSymbol)).toString();o.push({type:"fill",templateHash:f,materialHash:0===r.length?c:R(c,t,n,i),cim:e,materialOverrides:n,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:Y(s,t,"Separation",i,e.separation),scaleX:1,angle:Y(s,t,"Rotation",i,e.rotation),offsetX:Y(s,t,"OffsetX",i,e.offsetX),offsetY:Y(s,t,"OffsetY",i,e.offsetY)})}function O(e,t,r,i,o){var a=l.numericHash(JSON.stringify(e)).toString();o.push({type:"fill",templateHash:a,materialHash:0===r.length?a:R(a,t,r,i),cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function k(e,t,r,i,o,a,n){var s=l.numericHash(JSON.stringify(e)).toString(),f=e.primitiveName,c=m.fromCIMColor(e.color),u=void 0!==e.width?e.width:4,p=h(e.capStyle),g=y(e.joinStyle),v=e.miterLimit;o.push({type:"line",templateHash:s,materialHash:0===r.length?s:function(){return s},cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:Y(f,t,"Color",i,c,J),width:Y(f,t,"Width",i,u),cap:Y(f,t,"CapStyle",i,p),join:Y(f,t,"JoinStyle",i,g),miterLimit:Y(f,t,"MiterLimit",i,v),referenceWidth:n,zOrder:w(e.name),isDashed:!1})}function M(e,t,r,i,o,a,n){var s=l.numericHash(""+e.url+JSON.stringify(e.colorSubstitutions)).toString(),f=e.primitiveName,c=m.fromCIMColor(e.tintColor),u=void 0!==e.width?e.width:4,p=h(e.capStyle),g=y(e.joinStyle),v=e.miterLimit,d=l.numericHash(JSON.stringify(e)).toString();o.push({type:"line",templateHash:d,materialHash:0===r.length?s:function(){return s},cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:Y(f,t,"TintColor",i,c,J),width:Y(f,t,"Width",i,u),cap:Y(f,t,"CapStyle",i,p),join:Y(f,t,"JoinStyle",i,g),miterLimit:Y(f,t,"MiterLimit",i,v),referenceWidth:n,zOrder:w(e.name),isDashed:!1})}function H(e,t,r,i,o,a,n){var s=e.primitiveName,f=void 0!==e.width?e.width:4,c=h(e.capStyle),m=y(e.joinStyle),u=e.miterLimit,p=l.numericHash(JSON.stringify(e)).toString();o.push({type:"line",templateHash:p,materialHash:0===r.length?p:R(p,t,r,i),cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},width:Y(s,t,"Width",i,f),cap:Y(s,t,"CapStyle",i,c),join:Y(s,t,"JoinStyle",i,m),miterLimit:Y(s,t,"MiterLimit",i,u),referenceWidth:n,zOrder:w(e.name),isDashed:!1})}function I(e,t,r,i,o){var a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;var n=a,s=["Rotation","OffsetX","OffsetY"],f=r.filter((function(t){return t.primitiveName!==e.primitiveName&&-1===s.indexOf(t.propertyName)})),c=l.numericHash(JSON.stringify(e)).toString();return o.push({type:"fill",templateHash:c,materialHash:0===r.length?c:R(c,t,f,i),cim:e,materialOverrides:f,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:Y(n.primitiveName,t,"StepY",i,n.stepY),scaleX:1,angle:Y(n.primitiveName,t,"GridAngle",i,n.gridAngle),offsetX:Y(n.primitiveName,t,"OffsetX",i,n.offsetX),offsetY:Y(n.primitiveName,t,"OffsetY",i,n.offsetY)}),!0}function P(e,t,r,i,o,a,n){for(var s=e.primitiveName,f=e.size,c=e.scaleX,u=e.rotation,p=e.offsetX,h=e.offsetY,y=m.fromCIMColor(e.tintColor),g=l.numericHash(""+e.url+JSON.stringify(e.colorSubstitutions)).toString(),v=!1,d="",S=0,C=r;S<C.length;S++){var b=C[S];b.primitiveName===s&&(void 0!==b.value?d+="-"+b.primitiveName+"-"+b.propertyName+"-"+JSON.stringify(b.value):b.valueExpressionInfo&&(v=!0))}o.push({type:"marker",templateHash:l.numericHash(JSON.stringify(e)+d).toString(),materialHash:v?function(){return g}:g,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:!1,alignment:a,size:Y(s,t,"Size",i,f),scaleX:Y(s,t,"ScaleX",i,c),rotation:Y(s,t,"Rotation",i,u),offsetX:Y(s,t,"OffsetX",i,p),offsetY:Y(s,t,"OffsetY",i,h),color:Y(s,t,"TintColor",i,y,J),anchorPoint:e.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:n,sizeRatio:1,markerPlacement:e.markerPlacement})}function L(e,t,r,i,o,a,n,l){var s=e.markerGraphics;if(s){var f=0;if(e.scaleSymbolsProportionally){var c=e.frame;c&&(f=c.ymax-c.ymin)}for(var m=0,u=s;m<u.length;m++){var p=u[m];if(p){var h=p.symbol;if(!h)continue;switch(h.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":x(e,p,r,t,i,o,a,n,f,l);break;case"CIMTextSymbol":X(e,p,t,r,i,o,a,n,f)}}}}}function X(e,t,i,o,a,n,s,c,u){f.OverrideHelper.findApplicableOverrides(t,o,[]);var p=t.geometry;if("x"in p&&"y"in p){var h,y=t.symbol,d=(h=y).underline?"underline":h.strikethrough?"line-through":"none",S=function(e){var t="normal",r="normal";if(e){var i=e.toLowerCase();-1!==i.indexOf("italic")?t="italic":-1!==i.indexOf("oblique")&&(t="oblique"),-1!==i.indexOf("bold")?r="bold":-1!==i.indexOf("light")&&(r="lighter")}return{style:t,weight:r}}(y.fontStyleName);y.font=r.__assign({family:y.fontFamilyName,decoration:d},S);var C=e.frame,b=p.x-.5*(C.xmin+C.xmax),N=p.y-.5*(C.ymin+C.ymax),O=e.size/u,k=e.primitiveName,M=(y.height||0)*O,H=y.angle||0,I=((y.offsetX||0)+b)*O,P=((y.offsetY||0)+N)*O,L=m.fromCIMColor(f.CIMSymbolHelper.getFillColor(y)),X=m.fromCIMColor(f.CIMSymbolHelper.getStrokeColor(y)),x=f.CIMSymbolHelper.getStrokeWidth(y);x||(X=m.fromCIMColor(f.CIMSymbolHelper.getFillColor(y.haloSymbol)),x=y.haloSize*O);for(var z="",w=0,J=o;w<J.length;w++){var R=J[w];R.primitiveName===k&&void 0!==R.value&&(z+="-"+R.primitiveName+"-"+R.propertyName+"-"+JSON.stringify(R.value))}var A=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),F=l.numericHash(JSON.stringify(t)+A+z).toString();n.push({type:"text",templateHash:F,materialHash:function(){return l.numericHash(JSON.stringify(y.font)).toString()},cim:y,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:y.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:Y(k,i,"Size",a,M),angle:Y(k,i,"Rotation",a,H),offsetX:Y(k,i,"OffsetX",a,I),offsetY:Y(k,i,"OffsetY",a,P),horizontalAlignment:g(y.horizontalAlignment),verticalAlignment:v(y.verticalAlignment),text:Y(t.primitiveName,i,"TextString",a,t.textString,m._adjustTextCase,y.textCase),color:L,outlineColor:X,outlineSize:x,referenceSize:c,sizeRatio:1,markerPlacement:e.markerPlacement})}}function x(e,t,i,o,a,n,s,u,p,h){var y=t.symbol,g=t.geometry;if(g){var v=y.symbolLayers;if(v)if(h)z(e,t,o,i,a,n,s,u,p);else for(var d=v.length,S=function(){var h=v[d];if(!h||!1===h.enable)return"continue";switch(h.type){case"CIMSolidFill":case"CIMSolidStroke":var y=c.getExtent(g);if(!y)return"continue";var S=c.getSDFMetrics(y,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),C=S[0],b=S[1],N=S[2],O="CIMSolidFill"===h.type,k={type:"sdf",geom:g,asFill:O},M=e.primitiveName,H=e.size,I=e.rotation||0,P=e.offsetX,L=e.offsetY,X=h.primitiveName,x=O?m.fromCIMColor(f.CIMSymbolHelper.getFillColor(h)):m.fromCIMColor(f.CIMSymbolHelper.getStrokeColor(h)),w=O?{r:0,g:0,b:0,a:0}:m.fromCIMColor(f.CIMSymbolHelper.getStrokeColor(h)),R=f.CIMSymbolHelper.getStrokeWidth(h);if(!O&&!R)break;for(var A=!1,F="",_=0,W=i;_<W.length;_++){var T=W[_];T.primitiveName!==X&&T.primitiveName!==M||(void 0!==T.value?F+="-"+T.primitiveName+"-"+T.propertyName+"-"+JSON.stringify(T.value):T.valueExpressionInfo&&(A=!0))}var D=JSON.stringify(r.__assign(r.__assign({},e),{markerGraphics:null})),j=l.numericHash(JSON.stringify(k)).toString(),E={type:"marker",templateHash:l.numericHash(JSON.stringify(t)+JSON.stringify(h)+D+F).toString(),materialHash:A?function(){return j}:j,cim:k,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:b,y:N},isAbsoluteAnchorPoint:!1,size:Y(e.primitiveName,o,"Size",a,H),rotation:Y(e.primitiveName,o,"Rotation",a,I),offsetX:Y(e.primitiveName,o,"OffsetX",a,P),offsetY:Y(e.primitiveName,o,"OffsetY",a,L),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:u,sizeRatio:C,color:Y(X,o,"Color",a,x,J),outlineColor:Y(X,o,"Color",a,w,J),outlineWidth:Y(X,o,"Width",a,R),markerPlacement:e.markerPlacement};n.push(E);break;default:z(e,t,o,i,a,n,s,u,p)}};d--;)S()}}function z(e,t,r,i,o,a,s,c,m){var u,p=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath,effects:e.effects}}(e,t),h=["Rotation","OffsetX","OffsetY"];u=i.filter((function(t){return t.primitiveName!==e.primitiveName||-1===h.indexOf(t.propertyName)}));for(var y="",g=0,v=i;g<v.length;g++){var d=v[g];void 0!==d.value&&(y+="-"+d.primitiveName+"-"+d.propertyName+"-"+JSON.stringify(d.value))}var S=f.CIMSymbolHelper.getTextureAnchor(p),C=S[0],b=S[1],N=S[2],O=e.primitiveName,k=e.rotation||0,M=e.offsetX||0,H=e.offsetY||0,I=l.numericHash(JSON.stringify(p)+y).toString(),P={type:"marker",templateHash:I,materialHash:0===u.length?I:R(I,r,u,o),cim:p,materialOverrides:u,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:C,y:b},isAbsoluteAnchorPoint:!1,size:e.size,rotation:Y(O,r,"Rotation",o,k),offsetX:Y(O,r,"OffsetX",o,M),offsetY:Y(O,r,"OffsetY",o,H),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:c,sizeRatio:N/n.pt2px(e.size),markerPlacement:e.markerPlacement};a.push(P)}function w(e){if(e&&0===e.indexOf("Level_")){var t=parseInt(e.substr(6),10);if(NaN!==t)return t}return 0}function J(e){if(!e||0===e.length)return null;var t=new i(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function Y(e,t,r,i,o,a,n){var l=t[e];if(l){var f=l[r];if("string"==typeof f||"number"==typeof f||f instanceof Array)return a?a.call(null,f,n):f;if(null!=f&&f instanceof s.default)return function(e,t,r){var l=u.default(f,e,{$view:r},i.geometryType,t);return null!==l&&a&&(l=a.call(null,l,n)),null!==l?l:o}}return o}function R(e,t,r,i){for(var o=function(e){if(e.valueExpressionInfo){var r=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];r instanceof s.default&&(e.fn=function(e,t,o){return u.default(r,e,{$view:o},i.geometryType,t)})}},a=0,n=r;a<n.length;a++){o(n[a])}return function(t,i,o){for(var a=0,n=r;a<n.length;a++){var s=n[a];s.fn&&(s.value=s.fn(t,i,o))}return l.numericHash(e+f.OverrideHelper.buildOverrideKey(r)).toString()}}t.analyzeCIMSymbol=function(e,t,i,o){return r.__awaiter(this,void 0,void 0,(function(){var n,l,c,m,u,h,y,g,v;return r.__generator(this,(function(r){switch(r.label){case 0:if(n=i||[],!e)return[2,n];if(m={},"CIMSymbolReference"!==e.type)return[3,3];if(l=e.symbol,!(c=e.primitiveOverrides))return[3,2];for(u=[],h=function(e){var r=e.valueExpressionInfo;if(r&&t){var i=r.expression,o=s.createRendererExpression(i,t.spatialReference,t.fields).then((function(t){t&&d(m,e.primitiveName,e.propertyName,t)}));u.push(o)}else null!=e.value&&d(m,e.primitiveName,e.propertyName,e.value)},y=0,g=c;y<g.length;y++)v=g[y],h(v);return[4,a.all(u)];case 1:r.sent(),r.label=2;case 2:return[3,4];case 3:return p.error("Expect cim type to be 'CIMSymbolReference'"),[2,n];case 4:switch(l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,r,i,o,a){if(!e)return;var n,l=e.symbolLayers;if(!l)return;var s=f.CIMSymbolHelper.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(n=1);var c=l.length;for(;c--;){var m=l[c];if(m&&!1!==m.enable){var u=[];switch(f.OverrideHelper.findApplicableOverrides(m,t,u),m.type){case"CIMSolidFill":C(m,r,u,i,o);break;case"CIMPictureFill":b(m,r,u,i,o);break;case"CIMHatchFill":N(m,r,u,i,o);break;case"CIMGradientFill":O(m,r,u,i,o);break;case"CIMSolidStroke":k(m,r,u,i,o,"CIMPolygonSymbol"===e.type,s);break;case"CIMPictureStroke":M(m,r,u,i,o,"CIMPolygonSymbol"===e.type,s);break;case"CIMGradientStroke":H(m,r,u,i,o,"CIMPolygonSymbol"===e.type,s);break;case"CIMCharacterMarker":if(I(m,r,u,i,o))break;break;case"CIMPictureMarker":if(I(m,r,u,i,o))break;"CIMLineSymbol"===e.type&&(n=S(m)),P(m,r,u,i,o,n,s);break;case"CIMVectorMarker":if(I(m,r,u,i,o))break;"CIMLineSymbol"===e.type&&(n=S(m)),L(m,r,u,i,o,n,s,a);break;default:p.error("Cannot analyze CIM layer",m.type)}}}}(l,c,m,t,n,o)}return[2,n]}}))}))},t.analyzeCIMResource=function(e,t){if(!t||0===t.length)return e;var r=JSON.parse(JSON.stringify(e));return f.OverrideHelper.applyOverrides(r,t),r}}));