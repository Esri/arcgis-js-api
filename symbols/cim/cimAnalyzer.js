/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/string","../../core/Logger","../../core/promiseUtils","../../support/arcadeOnDemand","../../Color","../../core/screenUtils","./utils","../../views/2d/arcade/callExpressionWithFeature","./CIMSymbolHelper","./SDFHelper"],(function(e,t,i,o,r,n,a,l,s,c,f){"use strict";const m=i.getLogger("esri.symbols.cim.cimAnalyzer");function p(e){switch(e){case"Butt":return 0;case"Square":return 2;case"Round":default:return 1}}function u(e){switch(e){case"Bevel":return 0;case"Miter":return 2;case"Round":default:return 1}}function y(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function h(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function g(e,t,i,o){let r;e[t]?r=e[t]:(r={},e[t]=r),r[i]=o}function d(e){const t=e.markerPlacement;return t&&t.angleToLine?1:0}function S(e,i,o,r,n){const a=e.primitiveName,s=l.fromCIMColor(e.color),c=t.numericHash(JSON.stringify(e)).toString();n.push({type:"fill",templateHash:c,materialHash:0===o.length?c:()=>c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:w(a,i,"Color",r,s,z),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e.effects})}function C(e,i,o,r,n){const a=e.primitiveName,s=e.tintColor?l.fromCIMColor(e.tintColor):{r:255,g:255,b:255,a:1},c=t.numericHash(JSON.stringify(e)).toString(),f=t.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();n.push({type:"fill",templateHash:c,materialHash:0===o.length?f:()=>f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:w(a,i,"TintColor",r,s,z),height:w(a,i,"Height",r,e.height),scaleX:w(a,i,"ScaleX",r,e.scaleX),angle:w(a,i,"Rotation",r,e.rotation),offsetX:w(a,i,"OffsetX",r,e.offsetX),offsetY:w(a,i,"OffsetY",r,e.offsetY)})}function b(e,i,o,r,n){const a=["Rotation","OffsetX","OffsetY"],l=o.filter((t=>t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName))),s=e.primitiveName,c=t.numericHash(JSON.stringify(e)).toString(),f=t.numericHash(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();n.push({type:"fill",templateHash:c,materialHash:0===o.length?f:J(f,i,l,r),cim:e,materialOverrides:l,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:w(s,i,"Separation",r,e.separation),scaleX:1,angle:w(s,i,"Rotation",r,e.rotation),offsetX:w(s,i,"OffsetX",r,e.offsetX),offsetY:w(s,i,"OffsetY",r,e.offsetY)})}function v(e,i,o,r,n){const a=t.numericHash(JSON.stringify(e)).toString();n.push({type:"fill",templateHash:a,materialHash:0===o.length?a:J(a,i,o,r),cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function N(e,i,o,r,n,a,s){const c=t.numericHash(JSON.stringify(e)).toString(),f=e.primitiveName,m=l.fromCIMColor(e.color),y=void 0!==e.width?e.width:4,h=p(e.capStyle),g=u(e.joinStyle),d=e.miterLimit;n.push({type:"line",templateHash:c,materialHash:0===o.length?c:()=>c,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:w(f,i,"Color",r,m,z),width:w(f,i,"Width",r,y),cap:w(f,i,"CapStyle",r,h),join:w(f,i,"JoinStyle",r,g),miterLimit:w(f,i,"MiterLimit",r,d),referenceWidth:s,zOrder:X(e.name),isDashed:!1})}function O(e,i,o,r,n,a,s){const c=t.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),f=e.primitiveName,m=l.fromCIMColor(e.tintColor),y=void 0!==e.width?e.width:4,h=p(e.capStyle),g=u(e.joinStyle),d=e.miterLimit,S=t.numericHash(JSON.stringify(e)).toString();n.push({type:"line",templateHash:S,materialHash:0===o.length?c:()=>c,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:w(f,i,"TintColor",r,m,z),width:w(f,i,"Width",r,y),cap:w(f,i,"CapStyle",r,h),join:w(f,i,"JoinStyle",r,g),miterLimit:w(f,i,"MiterLimit",r,d),referenceWidth:s,zOrder:X(e.name),isDashed:!1})}function k(e,i,o,r,n,a,l){const s=e.primitiveName,c=void 0!==e.width?e.width:4,f=p(e.capStyle),m=u(e.joinStyle),y=e.miterLimit,h=t.numericHash(JSON.stringify(e)).toString();n.push({type:"line",templateHash:h,materialHash:0===o.length?h:J(h,i,o,r),cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},width:w(s,i,"Width",r,c),cap:w(s,i,"CapStyle",r,f),join:w(s,i,"JoinStyle",r,m),miterLimit:w(s,i,"MiterLimit",r,y),referenceWidth:l,zOrder:X(e.name),isDashed:!1})}function M(e,i,o,r,n){const a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;const l=a,s=["Rotation","OffsetX","OffsetY"],c=o.filter((t=>t.primitiveName!==e.primitiveName&&-1===s.indexOf(t.propertyName))),f=t.numericHash(JSON.stringify(e)).toString();return n.push({type:"fill",templateHash:f,materialHash:0===o.length?f:J(f,i,c,r),cim:e,materialOverrides:c,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:w(l.primitiveName,i,"StepY",r,l.stepY),scaleX:1,angle:w(l.primitiveName,i,"GridAngle",r,l.gridAngle),offsetX:w(l.primitiveName,i,"OffsetX",r,l.offsetX),offsetY:w(l.primitiveName,i,"OffsetY",r,l.offsetY)}),!0}function H(e,i,o,r,n,a,s){const c=e.primitiveName,f=e.size,m=e.scaleX,p=e.rotation,u=e.offsetX,y=e.offsetY,h=l.fromCIMColor(e.tintColor),g=t.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let d=!1,S="";for(const e of o)e.primitiveName===c&&(void 0!==e.value?S+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(d=!0));n.push({type:"marker",templateHash:t.numericHash(JSON.stringify(e)+S).toString(),materialHash:d?()=>g:g,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:!1,alignment:a,size:w(c,i,"Size",r,f),scaleX:w(c,i,"ScaleX",r,m),rotation:w(c,i,"Rotation",r,p),offsetX:w(c,i,"OffsetX",r,u),offsetY:w(c,i,"OffsetY",r,y),color:w(c,i,"TintColor",r,h,z),anchorPoint:e.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:e.markerPlacement})}function I(e,t,i,o,r,n,a,l){const s=e.markerGraphics;if(!s)return;let c=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(c=t.ymax-t.ymin)}for(const f of s)if(f){const s=f.symbol;if(!s)continue;switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":L(e,f,i,t,o,r,n,a,c,l);break;case"CIMTextSymbol":P(e,f,t,i,o,r,n,a,c)}}}function P(e,i,o,r,n,a,s,f,m){c.OverrideHelper.findApplicableOverrides(i,r,[]);const p=i.geometry;if(!("x"in p)||!("y"in p))return;const u=i.symbol,g=(d=u).underline?"underline":d.strikethrough?"line-through":"none";var d;const S=function(e){let t="normal",i="normal";if(e){const o=e.toLowerCase();-1!==o.indexOf("italic")?t="italic":-1!==o.indexOf("oblique")&&(t="oblique"),-1!==o.indexOf("bold")?i="bold":-1!==o.indexOf("light")&&(i="lighter")}return{style:t,weight:i}}(u.fontStyleName);u.font={family:u.fontFamilyName,decoration:g,...S};const C=e.frame,b=p.x-.5*(C.xmin+C.xmax),v=p.y-.5*(C.ymin+C.ymax),N=e.size/m,O=e.primitiveName,k=(u.height||0)*N,M=u.angle||0,H=((u.offsetX||0)+b)*N,I=((u.offsetY||0)+v)*N,P=l.fromCIMColor(c.CIMSymbolHelper.getFillColor(u));let L=l.fromCIMColor(c.CIMSymbolHelper.getStrokeColor(u)),x=c.CIMSymbolHelper.getStrokeWidth(u);x||(L=l.fromCIMColor(c.CIMSymbolHelper.getFillColor(u.haloSymbol)),x=u.haloSize*N);let X="";for(const e of r)e.primitiveName===O&&void 0!==e.value&&(X+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const z=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),J=t.numericHash(JSON.stringify(i)+z+X).toString();a.push({type:"text",templateHash:J,materialHash:()=>t.numericHash(JSON.stringify(u.font)).toString(),cim:u,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:u.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:w(O,o,"Size",n,k),angle:w(O,o,"Rotation",n,M),offsetX:w(O,o,"OffsetX",n,H),offsetY:w(O,o,"OffsetY",n,I),horizontalAlignment:y(u.horizontalAlignment),verticalAlignment:h(u.verticalAlignment),text:w(i.primitiveName,o,"TextString",n,i.textString,l._adjustTextCase,u.textCase),color:P,outlineColor:L,outlineSize:x,referenceSize:f,sizeRatio:1,markerPlacement:e.markerPlacement})}function L(e,i,o,r,n,a,s,m,p,u){const y=i.symbol,h=i.geometry;if(!h)return;const g=y.symbolLayers;if(!g)return;if(u)return void x(e,i,r,o,n,a,s,m,p);let d=g.length;for(;d--;){const u=g[d];if(u&&!1!==u.enable)switch(u.type){case"CIMSolidFill":case"CIMSolidStroke":{const y=f.getExtent(h);if(!y)continue;const[g,d,S]=f.getSDFMetrics(y,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),C="CIMSolidFill"===u.type,b={type:"sdf",geom:h,asFill:C},v=e.primitiveName,N=e.size,O=e.rotation||0,k=e.offsetX,M=e.offsetY,H=u.primitiveName,I=C?l.fromCIMColor(c.CIMSymbolHelper.getFillColor(u)):l.fromCIMColor(c.CIMSymbolHelper.getStrokeColor(u)),P=C?{r:0,g:0,b:0,a:0}:l.fromCIMColor(c.CIMSymbolHelper.getStrokeColor(u)),L=c.CIMSymbolHelper.getStrokeWidth(u);if(!C&&!L)break;let x=!1,X="";for(const e of o)e.primitiveName!==H&&e.primitiveName!==v||(void 0!==e.value?X+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(x=!0));const J=JSON.stringify({...e,markerGraphics:null}),Y=t.numericHash(JSON.stringify(b)).toString(),R={type:"marker",templateHash:t.numericHash(JSON.stringify(i)+JSON.stringify(u)+J+X).toString(),materialHash:x?()=>Y:Y,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:d,y:S},isAbsoluteAnchorPoint:!1,size:w(e.primitiveName,r,"Size",n,N),rotation:w(e.primitiveName,r,"Rotation",n,O),offsetX:w(e.primitiveName,r,"OffsetX",n,k),offsetY:w(e.primitiveName,r,"OffsetY",n,M),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:g,color:w(H,r,"Color",n,I,z),outlineColor:w(H,r,"Color",n,P,z),outlineWidth:w(H,r,"Width",n,L),markerPlacement:e.markerPlacement};a.push(R);break}default:x(e,i,r,o,n,a,s,m,p)}}}function x(e,i,o,r,n,l,s,f,m){const p=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath,effects:e.effects}}(e,i);let u=[];const y=["Rotation","OffsetX","OffsetY"];u=r.filter((t=>t.primitiveName!==e.primitiveName||-1===y.indexOf(t.propertyName)));let h="";for(const e of r)void 0!==e.value&&(h+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[g,d,S]=c.CIMSymbolHelper.getTextureAnchor(p),C=e.primitiveName,b=e.rotation||0,v=e.offsetX||0,N=e.offsetY||0,O=t.numericHash(JSON.stringify(p)+h).toString(),k={type:"marker",templateHash:O,materialHash:0===u.length?O:J(O,o,u,n),cim:p,materialOverrides:u,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:g,y:d},isAbsoluteAnchorPoint:!1,size:e.size,rotation:w(C,o,"Rotation",n,b),offsetX:w(C,o,"OffsetX",n,v),offsetY:w(C,o,"OffsetY",n,N),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:S/a.pt2px(e.size),markerPlacement:e.markerPlacement};l.push(k)}function X(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(NaN!==t)return t}return 0}function z(e){if(!e||0===e.length)return null;const t=new n(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function w(e,t,i,o,n,a,l){const c=t[e];if(c){const e=c[i];if("string"==typeof e||"number"==typeof e||e instanceof Array)return a?a.call(null,e,l):e;if(null!=e&&e instanceof r.ArcadeExpression)return(t,i,r)=>{let c=s(e,t,{$view:r},o.geometryType,i);return null!==c&&a&&(c=a.call(null,c,l)),null!==c?c:n}}return n}function J(e,i,o,n){for(const e of o){if(e.valueExpressionInfo){const t=i[e.primitiveName]&&i[e.primitiveName][e.propertyName];t instanceof r.ArcadeExpression&&(e.fn=(e,i,o)=>s(t,e,{$view:o},n.geometryType,i))}}return(i,r,n)=>{for(const e of o)e.fn&&(e.value=e.fn(i,r,n));return t.numericHash(e+c.OverrideHelper.buildOverrideKey(o)).toString()}}e.analyzeCIMResource=function(e,t){if(!t||0===t.length)return e;const i=JSON.parse(JSON.stringify(e));return c.OverrideHelper.applyOverrides(i,t),i},e.analyzeCIMSymbol=async function(e,t,i,n){const a=i||[];if(!e)return a;let l,s;const f={};if("CIMSymbolReference"!==e.type)return m.error("Expect cim type to be 'CIMSymbolReference'"),a;if(l=e.symbol,s=e.primitiveOverrides,s){const e=[];for(const i of s){const o=i.valueExpressionInfo;if(o&&t){const n=o.expression,a=r.createRendererExpression(n,t.spatialReference,t.fields).then((e=>{e&&g(f,i.primitiveName,i.propertyName,e)}));e.push(a)}else null!=i.value&&g(f,i.primitiveName,i.propertyName,i.value)}await o.all(e)}switch(l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,i,o,r,n){if(!e)return;const a=e.symbolLayers;if(!a)return;let l;const s=c.CIMSymbolHelper.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(l=1);let f=a.length;for(;f--;){const p=a[f];if(!p||!1===p.enable)continue;const u=[];switch(c.OverrideHelper.findApplicableOverrides(p,t,u),p.type){case"CIMSolidFill":S(p,i,u,o,r);break;case"CIMPictureFill":C(p,i,u,o,r);break;case"CIMHatchFill":b(p,i,u,o,r);break;case"CIMGradientFill":v(p,i,u,o,r);break;case"CIMSolidStroke":N(p,i,u,o,r,"CIMPolygonSymbol"===e.type,s);break;case"CIMPictureStroke":O(p,i,u,o,r,"CIMPolygonSymbol"===e.type,s);break;case"CIMGradientStroke":k(p,i,u,o,r,"CIMPolygonSymbol"===e.type,s);break;case"CIMCharacterMarker":if(M(p,i,u,o,r))break;break;case"CIMPictureMarker":if(M(p,i,u,o,r))break;"CIMLineSymbol"===e.type&&(l=d(p)),H(p,i,u,o,r,l,s);break;case"CIMVectorMarker":if(M(p,i,u,o,r))break;"CIMLineSymbol"===e.type&&(l=d(p)),I(p,i,u,o,r,l,s,n);break;default:m.error("Cannot analyze CIM layer",p.type)}}}(l,s,f,t,a,n)}return a},Object.defineProperty(e,"__esModule",{value:!0})}));
