/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Color","../../core/fontUtils","../../core/lang","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/string","../../support/arcadeOnDemand","./CIMSymbolHelper","./enums","./quantizeTime","./SDFHelper","./utils","./effects/CIMEffectHelper","../../views/2d/arcade/callExpressionWithFeature","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/grouping"],(function(e,t,o,i,r,n,l,a,s,c,f,m,p,u,y,g,h,d,S){"use strict";const v=n.getLogger("esri.symbols.cim.cimAnalyzer");function C(e){switch(e){case"Butt":return m.CapType.BUTT;case"Square":return m.CapType.SQUARE;default:return m.CapType.ROUND}}function N(e){switch(e){case"Bevel":return m.JoinType.BEVEL;case"Miter":return m.JoinType.MITER;default:return m.JoinType.ROUND}}function b(e,t,o,i){let r;e[t]?r=e[t]:(r={},e[t]=r),r[o]=i}function O(e){const t=e.markerPlacement;return t&&t.angleToLine?m.Alignment.MAP:m.Alignment.SCREEN}function k(e,t,o,i,r){return M.apply(this,arguments)}function M(){return(M=t._asyncToGenerator((function*(e,t,o,i,r){const n=i??[];if(!e)return n;let a,s;const m={};if("CIMSymbolReference"!==e.type)return v.error("Expect cim type to be 'CIMSymbolReference'"),n;if(a=e.symbol,s=e.primitiveOverrides,s){const e=[];for(const o of s){const i=o.valueExpressionInfo;if(i&&t){const r=i.expression,n=c.createRendererExpression(r,t.spatialReference,t.fields).then((e=>{l.isNone(e)||b(m,o.primitiveName,o.propertyName,e)}));e.push(n)}else null!=o.value&&b(m,o.primitiveName,o.propertyName,o.value)}e.length>0&&(yield Promise.all(e))}const p=[];switch(f.CIMSymbolHelper.fetchResources(a,o,p),p.length>0&&(yield Promise.all(p)),a?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":I(a,s,m,t,n,o,!!r)}return n}))).apply(this,arguments)}function I(e,t,o,i,r,n,l){if(!e)return;const a=e.symbolLayers;if(!a)return;const s=e.effects;let c=m.Alignment.SCREEN;const p=f.CIMSymbolHelper.getSize(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(c=m.Alignment.MAP);let u=a.length;for(;u--;){const m=a[u];if(!m||!1===m.enable)continue;let y;s&&s.length&&(y=[...s]);const g=m.effects;g&&g.length&&(s?y.push(...g):y=[...g]);const h=[];let d;f.OverrideHelper.findEffectOverrides(y,t,h),d=h.length>0?G(y,h,o,i):y;const S=[];switch(f.OverrideHelper.findApplicableOverrides(m,t,S),m.type){case"CIMSolidFill":P(m,d,o,S,i,r);break;case"CIMPictureFill":H(m,d,o,S,i,n,r);break;case"CIMHatchFill":L(m,d,o,S,i,r);break;case"CIMGradientFill":A(m,d,o,S,i,r);break;case"CIMSolidStroke":w(m,d,o,S,i,r,"CIMPolygonSymbol"===e.type,p);break;case"CIMPictureStroke":x(m,d,o,S,i,r,"CIMPolygonSymbol"===e.type,p);break;case"CIMGradientStroke":z(m,d,o,S,i,r,"CIMPolygonSymbol"===e.type,p);break;case"CIMCharacterMarker":if(R(m,d,o,S,i,r))break;break;case"CIMPictureMarker":if(R(m,d,o,S,i,r))break;"CIMLineSymbol"===e.type&&(c=O(m)),X(m,d,o,S,i,n,r,c,p);break;case"CIMVectorMarker":if(R(m,d,o,S,i,r))break;"CIMLineSymbol"===e.type&&(c=O(m)),T(m,d,o,S,i,r,n,c,p,l);break;default:v.error("Cannot analyze CIM layer",m.type)}}}function P(e,t,o,i,r,n){const l=e.primitiveName,a=y.fromCIMColor(e.color),[c,f]=K(i,l,t,null,null),m=s.numericHash(JSON.stringify(e)+f).toString();n.push({type:"fill",templateHash:m,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,color:W(l,o,"Color",r,a,D),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t,applyRandomOffset:!1,sampleAlphaOnly:!0})}function H(e,t,o,i,r,n,a){const c=e.primitiveName,f=y.getTintColor(e),[m,p]=K(i,c,t,null,null),u=s.numericHash(JSON.stringify(e)+p).toString(),g=s.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let h=y.getValue(e.scaleX);if("width"in e&&"number"==typeof e.width){const t=e.width;let o=1;const i=n.getResource(e.url);l.isSome(i)&&(o=i.width/i.height),h/=o*(e.height/t)}a.push({type:"fill",templateHash:u,materialHash:m?()=>g:g,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:W(c,o,"TintColor",r,f,D),height:W(c,o,"Height",r,e.height),scaleX:W(c,o,"ScaleX",r,h),angle:W(c,o,"Rotation",r,y.getValue(e.rotation)),offsetX:W(c,o,"OffsetX",r,y.getValue(e.offsetX)),offsetY:W(c,o,"OffsetY",r,y.getValue(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}function L(e,t,o,i,r,n){const l=["Rotation","OffsetX","OffsetY"],a=i.filter((t=>t.primitiveName!==e.primitiveName||!l.includes(t.propertyName))),c=e.primitiveName;let[f,m]=K(i,c,t,null,null);const p=s.numericHash(JSON.stringify(e)+m).toString(),u=s.numericHash(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let g={r:255,g:255,b:255,a:1},h=!1;const d=e.lineSymbol?.symbolLayers?.find((e=>"CIMSolidStroke"===e.type&&null!=o[e.primitiveName]?.Color));if(d){g=y.fromCIMColor(d.color),g=W(d.primitiveName,o,"Color",r,g,D);const e="function"==typeof g;f=f||e,h=null!=d.color||e}n.push({type:"fill",templateHash:p,materialHash:f?B(u,o,a,r):u,cim:e,materialOverrides:a,colorLocked:!!e.colorLocked,effects:t,color:g,height:W(c,o,"Separation",r,e.separation),scaleX:1,angle:W(c,o,"Rotation",r,y.getValue(e.rotation)),offsetX:W(c,o,"OffsetX",r,y.getValue(e.offsetX)),offsetY:W(c,o,"OffsetY",r,y.getValue(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!h})}function A(e,t,o,i,r,n){const l=e.primitiveName,[a,c]=K(i,l,t,null,null),f=s.numericHash(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:a?B(f,o,i,r):f,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}function w(e,t,o,i,r,n,l,a){const c=e.primitiveName,f=y.fromCIMColor(e.color),m=null!=e.width?e.width:4,p=C(e.capStyle),u=N(e.joinStyle),g=e.miterLimit,[h,d]=K(i,c,t,null,null),S=s.numericHash(JSON.stringify(e)+d).toString();let v,b;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();v=e.dashTemplate,b=e.scaleDash}}n.push({type:"line",templateHash:S,materialHash:h?()=>S:S,cim:e,materialOverrides:null,isOutline:l,colorLocked:!!e.colorLocked,effects:t,color:W(c,o,"Color",r,f,D),width:W(c,o,"Width",r,m),cap:W(c,o,"CapStyle",r,p),join:W(c,o,"JoinStyle",r,u),miterLimit:g&&W(c,o,"MiterLimit",r,g),referenceWidth:a,zOrder:$(e.name),dashTemplate:v,scaleDash:b,sampleAlphaOnly:!0})}function x(e,t,o,i,r,n,l,a){const c=s.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),f=e.primitiveName,m=y.getTintColor(e),p=null!=e.width?e.width:4,u=C(e.capStyle),g=N(e.joinStyle),h=e.miterLimit,[d,S]=K(i,f,t,null,null),v=s.numericHash(JSON.stringify(e)+S).toString();n.push({type:"line",templateHash:v,materialHash:d?()=>c:c,cim:e,materialOverrides:null,isOutline:l,colorLocked:!!e.colorLocked,effects:t,color:W(f,o,"TintColor",r,m,D),width:W(f,o,"Width",r,p),cap:W(f,o,"CapStyle",r,u),join:W(f,o,"JoinStyle",r,g),miterLimit:h&&W(f,o,"MiterLimit",r,h),referenceWidth:a,zOrder:$(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}function z(e,t,o,i,r,n,l,a){const c=e.primitiveName,f=null!=e.width?e.width:4,m=C(e.capStyle),p=N(e.joinStyle),u=e.miterLimit,[y,g]=K(i,c,t,null,null),h=s.numericHash(JSON.stringify(e)+g).toString();n.push({type:"line",templateHash:h,materialHash:y?B(h,o,i,r):h,cim:e,materialOverrides:null,isOutline:l,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:W(c,o,"Width",r,f),cap:W(c,o,"CapStyle",r,m),join:W(c,o,"JoinStyle",r,p),miterLimit:u&&W(c,o,"MiterLimit",r,u),referenceWidth:a,zOrder:$(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}function R(e,t,o,i,r,n){const{markerPlacement:l,type:c}=e;if(!l||"CIMMarkerPlacementInsidePolygon"!==l.type)return!1;if("CIMVectorMarker"===c||"CIMPictureMarker"===c){const o=e.primitiveName;if(o){const[e,r]=K(i,o,t,null,null);if(e)return!1}const r=l.primitiveName;if(r){const[e,o]=K(i,r,t,null,null);if(e)return!1}if("CIMVectorMarker"===c){const{markerGraphics:t}=e;if(t)for(const e of t){const{symbol:t}=e;if("CIMPolygonSymbol"===t?.type&&t.symbolLayers){const{symbolLayers:e}=t;for(const t of e)if("CIMSolidStroke"===t.type)return!1}}}else{const{animatedSymbolProperties:t}=e;if(t)return!1}}const f=l,m=Math.abs(f.stepX),p=Math.abs(f.stepY);if(0===m||0===p)return!0;const u=["Rotation","OffsetX","OffsetY"],g=i.filter((t=>t.primitiveName!==e.primitiveName||!u.includes(t.propertyName))),h="url"in e&&"string"==typeof e.url?e.url:void 0,[S,v]=K(i,f.primitiveName,t,null,null),C=s.numericHash(JSON.stringify(e)+v).toString();let N,b,O=null;if("Random"===l.gridType){const e=a.px2pt(d.RANDOM_INSIDE_POLYGON_TEXTURE_SIZE),t=Math.max(Math.floor(e/m),1),o=Math.max(Math.floor(e/p),1);N=p*o,O=e=>e?e*o:0;b=t*m/N}else l.shiftOddRows?(N=2*p,O=e=>e?2*e:0,b=m/p*.5):(N=p,O=null,b=m/p);const k=y.getTintColor(e);return n.push({type:"fill",templateHash:C,materialHash:S?B(C,o,g,r):C,cim:e,materialOverrides:g,colorLocked:!!e.colorLocked,effects:t,color:W(f.primitiveName,o,"TintColor",r,k,D),height:W(f.primitiveName,o,"StepY",r,N,O),scaleX:b,angle:W(f.primitiveName,o,"GridAngle",r,f.gridAngle),offsetX:W(f.primitiveName,o,"OffsetX",r,y.getValue(f.offsetX)),offsetY:W(f.primitiveName,o,"OffsetY",r,y.getValue(f.offsetY)),url:h,applyRandomOffset:"Random"===l.gridType,sampleAlphaOnly:!h,hasUnresolvedReplacementColor:!0}),!0}function X(e,t,o,i,r,n,a,c,f){const m=e.primitiveName,p=y.getValue(e.size);let u=y.getValue(e.scaleX,1);const g=y.getValue(e.rotation),h=y.getValue(e.offsetX),d=y.getValue(e.offsetY),v=y.getTintColor(e),C=s.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString(),N=j(e.markerPlacement,i,o,r),b=_(e.animatedSymbolProperties,i,o,r),[O,k]=K(i,m,t,N,b),M=s.numericHash(JSON.stringify(e)+k).toString(),I=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const t=e.width;let o=1;const i=n.getResource(e.url);l.isSome(i)&&(o=i.width/i.height),u/=o*(p/t)}function P(e,t){return l.isSome(b)?y.evaluateValueOrFunction(b,e,t):null}const H=e.animatedSymbolProperties&&!0===e.animatedSymbolProperties.randomizeStartTime?(e,t,o,i)=>{const r=S.getMaterialGroup(i??0),n=P(e,t);return C+`-MATERIALGROUP(${r})`+`-ASP(${JSON.stringify(n)})`}:O?(e,t)=>{const o=P(e,t);return C+`-ASP(${JSON.stringify(o)})`}:C;a.push({type:"marker",templateHash:M,materialHash:H,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:c,size:W(m,o,"Size",r,p),scaleX:W(m,o,"ScaleX",r,u),rotation:W(m,o,"Rotation",r,g),offsetX:W(m,o,"OffsetX",r,h),offsetY:W(m,o,"OffsetY",r,d),color:W(m,o,"TintColor",r,v,D),anchorPoint:{x:I.x,y:-I.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!!e.rotateClockwise,referenceSize:f,sizeRatio:1,markerPlacement:N,url:e.url,animatedSymbolProperties:b})}function T(e,t,o,i,r,n,l,a,s,c){const f=e.markerGraphics;if(!f)return;let m=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(m=t.ymax-t.ymin)}const p=j(e.markerPlacement,i,o,r);for(const u of f)if(u){const f=u.symbol;if(!f)continue;switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":J(e,t,p,null,u,i,o,r,n,l,a,s,m,!!c);break;case"CIMTextSymbol":E(e,t,p,u,o,i,r,n,a,s,m)}}}function E(e,t,o,r,n,l,a,c,m,p,u){const g=[];f.OverrideHelper.findApplicableOverrides(r,l,g);const h=r.geometry;if(!("x"in h)||!("y"in h))return;const d=r.symbol,S=y.fromCIMFontDecoration(d),v=y.fromCIMFontStyle(d.fontStyleName),C=i.getFontFamily(d.fontFamilyName);d.font={family:C,decoration:S,...v};const N=e.frame,b=h.x-.5*(N.xmin+N.xmax),O=h.y-.5*(N.ymin+N.ymax),k=e.size/u,M=e.primitiveName,I=y.getValue(d.height)*k,P=y.getValue(d.angle),H=y.getValue(e.offsetX)+(y.getValue(d.offsetX)+b)*k,L=y.getValue(e.offsetY)+(y.getValue(d.offsetY)+O)*k,A=y.fromCIMColor(y.getFillColor(d));let w=y.fromCIMColor(y.getStrokeColor(d)),x=y.getStrokeWidth(d)??0;x||(w=y.fromCIMColor(y.getFillColor(d.haloSymbol)),d.haloSize&&(x=d.haloSize*k));let z=null,R=null,X=0;if(d.callout&&"CIMBackgroundCallout"===d.callout.type){const e=d.callout;if(e.backgroundSymbol){const t=e.backgroundSymbol.symbolLayers;if(t)for(const e of t)"CIMSolidFill"===e.type?z=y.fromCIMColor(e.color):"CIMSolidStroke"===e.type&&(R=y.fromCIMColor(e.color),X=y.getValue(e.width))}}const[T,E]=K(l,M,t,o,null),J=JSON.stringify(e.effects)+Number(e.colorLocked).toString()+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement)+e.size.toString(),V=s.numericHash(JSON.stringify(r)+J+E).toString();let Y=W(r.primitiveName,n,"TextString",a,r.textString??"",y.adjustTextCase,d.textCase);if(null==Y)return;const{fontStyleName:F}=d,$=C+(F?"-"+F.toLowerCase():"-regular"),D=$;"string"==typeof Y&&Y.includes("[")&&d.fieldMap&&(Y=y.createLabelOverrideFunction(d.fieldMap,Y,d.textCase)),c.push({type:"text",templateHash:V,materialHash:T||"function"==typeof Y||Y.match(/\[(.*?)\]/)?(e,t,o)=>D+"-"+y.evaluateValueOrFunction(Y,e,t,o):D+"-"+s.numericHash(Y),cim:d,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,alignment:m,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:$,decoration:S,weight:W(M,n,"Weight",a,v.weight),style:W(M,n,"Size",a,v.style),size:W(M,n,"Size",a,I),angle:W(M,n,"Rotation",a,P),offsetX:W(M,n,"OffsetX",a,H),offsetY:W(M,n,"OffsetY",a,L),horizontalAlignment:y.fromCIMHorizontalAlignment(d.horizontalAlignment),verticalAlignment:y.fromCIMVerticalAlignment(d.verticalAlignment),text:Y,color:A,outlineColor:w,outlineSize:x,backgroundColor:z,borderLineColor:R,borderLineWidth:X,referenceSize:p,sizeRatio:1,markerPlacement:o})}function J(e,t,o,i,r,n,a,c,f,m,p,h,d,S){const v=r.symbol,C=v.symbolLayers;if(!C)return;if(S)return void Y(e,t,o,i,r,a,n,c,f,m,p,h,d);let N=C.length;if(Q(C))return void V(e,t,o,i,r,C,n,a,c,f,p,h,d);const b=g.CIMEffectHelper.applyEffects(v.effects,r.geometry,m.geometryEngine);if(b)for(;N--;){const S=C[N];if(S&&!1!==S.enable)switch(S.type){case"CIMSolidFill":case"CIMSolidStroke":{const v=g.CIMEffectHelper.applyEffects(S.effects,b,m.geometryEngine),C=u.getExtent(v);if(!C)continue;const N="Relative"!==e.anchorPointUnits,[O,k,M]=u.getSDFMetrics(C,e.frame,e.size,e.anchorPoint,N),I="CIMSolidFill"===S.type,P={type:"sdf",geom:v,asFill:I},H=e.primitiveName,L=y.getValue(e.size)??10,A=y.getValue(e.rotation),w=y.getValue(e.offsetX),x=y.getValue(e.offsetY),z=S.path,R=S.primitiveName,X=I?y.fromCIMColor(y.getFillColor(S)):y.fromCIMColor(y.getStrokeColor(S)),T=I?{r:0,g:0,b:0,a:0}:y.fromCIMColor(y.getStrokeColor(S)),E=y.getStrokeWidth(S)??0;if(!I&&!E)break;let J=!1,V="";for(const e of n)e.primitiveName!==R&&e.primitiveName!==H||(void 0!==e.value?V+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(J=!0));(l.isSome(t)&&"function"==typeof t||l.isSome(o)&&"function"==typeof o)&&(J=!0);const Y=JSON.stringify({...e,markerGraphics:null}),F=s.numericHash(JSON.stringify(P)+z).toString(),$={type:"marker",templateHash:s.numericHash(JSON.stringify(r)+JSON.stringify(S)+Y+V).toString(),materialHash:J?()=>F:F,cim:P,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:p,anchorPoint:{x:k,y:M},isAbsoluteAnchorPoint:N,size:W(e.primitiveName,a,"Size",c,L),rotation:W(e.primitiveName,a,"Rotation",c,A),offsetX:W(e.primitiveName,a,"OffsetX",c,w),offsetY:W(e.primitiveName,a,"OffsetY",c,x),scaleX:1,frameHeight:d,rotateClockwise:!!e.rotateClockwise,referenceSize:h,sizeRatio:O,color:W(R,a,"Color",c,X,D),outlineColor:W(R,a,"Color",c,T,D),outlineWidth:W(R,a,"Width",c,E),markerPlacement:o,animatedSymbolProperties:i,path:z};f.push($);break}default:Y(e,t,o,i,r,a,n,c,f,m,p,h,d)}}}function V(e,t,o,i,r,n,a,c,f,m,p,g,h){const d=r.geometry,S=n[0],v=n[1],C=u.getExtent(d);if(!C)return;const N="Relative"!==e.anchorPointUnits,[b,O,k]=u.getSDFMetrics(C,e.frame,e.size,e.anchorPoint,N),M={type:"sdf",geom:d,asFill:!0},I=e.primitiveName,P=y.getValue(e.size),H=y.getValue(e.rotation),L=y.getValue(e.offsetX),A=y.getValue(e.offsetY),w=v.path,x=v.primitiveName,z=S.primitiveName,R=y.fromCIMColor(y.getFillColor(v)),X=y.fromCIMColor(y.getStrokeColor(S)),T=y.getStrokeWidth(S)??0;let E=!1,J="";for(const l of a)l.primitiveName!==x&&l.primitiveName!==z&&l.primitiveName!==I||(void 0!==l.value?J+=`-${l.primitiveName}-${l.propertyName}-${JSON.stringify(l.value)}`:l.valueExpressionInfo&&(E=!0));l.isSome(o)&&"function"==typeof o&&(E=!0);const V=JSON.stringify({...e,markerGraphics:null}),Y=s.numericHash(JSON.stringify(M)+w).toString(),F={type:"marker",templateHash:s.numericHash(JSON.stringify(r)+JSON.stringify(v)+JSON.stringify(S)+V+J).toString(),materialHash:E?()=>Y:Y,cim:M,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:p,anchorPoint:{x:O,y:k},isAbsoluteAnchorPoint:N,size:W(e.primitiveName,c,"Size",f,P),rotation:W(e.primitiveName,c,"Rotation",f,H),offsetX:W(e.primitiveName,c,"OffsetX",f,L),offsetY:W(e.primitiveName,c,"OffsetY",f,A),scaleX:1,frameHeight:h,rotateClockwise:!!e.rotateClockwise,referenceSize:g,sizeRatio:b,color:W(x,c,"Color",f,R,D),outlineColor:W(z,c,"Color",f,X,D),outlineWidth:W(z,c,"Width",f,T),markerPlacement:o,path:w,animatedSymbolProperties:i};m.push(F)}function Y(e,t,o,i,r,n,c,m,p,u,g,h,d){const S=F(e,r),v=["Rotation","OffsetX","OffsetY"],C=c.filter((t=>t.primitiveName!==e.primitiveName||!v.includes(t.propertyName)));let N="";for(const l of c)void 0!==l.value&&(N+=`-${l.primitiveName}-${l.propertyName}-${JSON.stringify(l.value)}`);const[b,O,k]=f.CIMSymbolHelper.getTextureAnchor(S,u),M=e.primitiveName,I=y.getValue(e.rotation),P=y.getValue(e.offsetX),H=y.getValue(e.offsetY),L=s.numericHash(JSON.stringify(S)+N).toString(),A={type:"marker",templateHash:L,materialHash:C.length>0||l.isSome(t)&&"function"==typeof t?B(L,n,C,m):L,cim:S,materialOverrides:C,colorLocked:!!e.colorLocked,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:g,anchorPoint:{x:b,y:O},isAbsoluteAnchorPoint:!1,size:y.getValue(e.size),rotation:W(M,n,"Rotation",m,I),offsetX:W(M,n,"OffsetX",m,P),offsetY:W(M,n,"OffsetY",m,H),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:d,rotateClockwise:!!e.rotateClockwise,referenceSize:h,sizeRatio:k/a.pt2px(e.size),markerPlacement:o,animatedSymbolProperties:i,avoidSDFRasterization:!0};p.push(A)}function F(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function $(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function D(e){if(!e||0===e.length)return null;const t=new o(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function W(e,t,o,i,r,n,l){if(null==e)return r;const a=t[e];if(a){const e=a[o];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,l):e;if(null!=e&&e instanceof c.ArcadeExpression&&i?.geometryType)return(t,o,a)=>{let s=h(e,t,{$view:a},i.geometryType,o);return null!==s&&n&&(s=n.call(null,s,l)),null!==s?s:r}}return r}function U(e){return e?e.charAt(0).toLowerCase()+e.substr(1):e}function G(e,t,o,i){for(const r of t){if(r.valueExpressionInfo&&i?.geometryType){const e=o[r.primitiveName]&&o[r.primitiveName][r.propertyName];e instanceof c.ArcadeExpression&&(r.fn=(t,o,r)=>h(e,t,{$view:r},i.geometryType,o))}}return(o,i,n)=>{for(const e of t)e.fn&&(e.value=e.fn(o,i,n));const l=[];for(let a of e){const e=a?.primitiveName;if(e){let o=!1;for(const i of t)if(i.primitiveName===e){const e=U(i.propertyName);null!=i.value&&i.value!==a[e]&&(o||(a=r.clone(a),o=!0),a[e]=i.value)}}l.push(a)}return l}}function j(e,t,o,i){const n=[];if(f.OverrideHelper.findApplicableOverrides(e,t,n),null==e||0===n.length)return e;for(const r of n){if(r.valueExpressionInfo&&i?.geometryType){const e=o[r.primitiveName]&&o[r.primitiveName][r.propertyName];e instanceof c.ArcadeExpression&&(r.fn=(t,o,r)=>h(e,t,{$view:r},i.geometryType,o))}}return(t,o,i)=>{for(const e of n)e.fn&&(e.value=e.fn(t,o,i));const l=r.clone(e),a=e.primitiveName;for(const e of n)if(e.primitiveName===a){const t=U(e.propertyName);null!=e.value&&e.value!==l[t]&&(l[t]=e.value)}return l}}function _(e,t,o,i){const n=[];if(f.OverrideHelper.findApplicableOverrides(e,t,n),null==e||0===n.length)return e;for(const r of n){if(r.valueExpressionInfo&&i?.geometryType){const e=o[r.primitiveName]&&o[r.primitiveName][r.propertyName];e instanceof c.ArcadeExpression&&(r.fn=(t,o,r)=>h(e,t,{$view:r},i.geometryType,o))}}return(t,o,i)=>{for(const e of n)e.fn&&(e.value=e.fn(t,o,i));const l=r.clone(e),a=e.primitiveName;for(const e of n)if(e.primitiveName===a){const t=U(e.propertyName);if(null!=e.value){const o=p.quantizeIfNeeded(e.value,e.propertyName);o!==l[t]&&(l[t]=o)}}return l}}function B(e,t,o,i){for(const r of o){if(r.valueExpressionInfo&&i?.geometryType){const e=t[r.primitiveName]&&t[r.primitiveName][r.propertyName];e instanceof c.ArcadeExpression&&(r.fn=(t,o,r)=>h(e,t,{$view:r},i.geometryType,o))}}return(t,i,r)=>{for(const e of o)e.fn&&(e.value=e.fn(t,i,r));return s.numericHash(e+f.OverrideHelper.buildOverrideKey(o)).toString()}}function q(e,t){if(!t||0===t.length)return e;const o=r.clone(e);return f.OverrideHelper.applyOverrides(o,t),o}function K(e,t,o,i,r){let n=!1,a="";for(const l of e)l.primitiveName===t&&(void 0!==l.value?a+=`-${l.primitiveName}-${l.propertyName}-${JSON.stringify(l.value)}`:l.valueExpressionInfo&&(n=!0));return l.isSome(o)&&"function"==typeof o&&(n=!0),l.isSome(i)&&"function"==typeof i&&(n=!0),l.isSome(r)&&"function"==typeof r&&(n=!0),[n,a]}const Q=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;e.analyzeCIMResource=q,e.analyzeCIMSymbol=k,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
