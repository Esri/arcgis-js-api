// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../request","../../core/promiseUtils","../../core/screenUtils","../../core/string","../../geometry/support/jsonUtils","./cimAnalyzer","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],(function(e,t,a,r,i,n,o,s,l,c,u,h,m,y){"use strict";var f;Object.defineProperty(t,"__esModule",{value:!0}),t.CIMSymbolRasterizer=t.GeometryStyle=void 0,function(e){e.Legend="legend",e.Preview="preview"}(f=t.GeometryStyle||(t.GeometryStyle={}));var p=function(e,t,a){if(e&&e.targetSize){var r=void 0;if(a){var i=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);r=e.targetSize/n.pt2px(i)}else r=e.targetSize/t.referenceSize;return r}return e&&e.scaleFactor?e.scaleFactor:1},g={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}},v=function(){function e(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new c.default,this._textRasterizer=new u.default,this._pictureMarkerCache=new Map}return e.prototype.rasterizeCIMSymbolAsync=function(e,t,r,i,n,o,l,c){return a.__awaiter(this,void 0,void 0,(function(){var u;return a.__generator(this,(function(a){switch(a.label){case 0:return i=i||(t?null!=t.centroid?"esriGeometryPolygon":s.getJsonType(t.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e),[4,this.analyzeCIMSymbol(e,t?(h=t.attributes,m=h?Object.keys(h):[],y=m.map((function(e){return{name:e,alias:e,type:"string"==typeof h[e]?"esriFieldTypeString":"esriFieldTypeDouble"}})),y):null,r,i,c)];case 1:return u=a.sent(),[2,this.rasterizeCIMSymbol(u,t,i,n,o,l)]}var h,m,y}))}))},e.prototype.analyzeCIMSymbol=function(e,t,r,n,o){return a.__awaiter(this,void 0,void 0,(function(){var s,c,u,m,y,f;return a.__generator(this,(function(a){switch(a.label){case 0:return s=[],c=t?{geometryType:n,spatialReference:this._spatialReference,fields:t}:null,[4,l.analyzeCIMSymbol(e.data,c,s,this._avoidSDF)];case 1:for(a.sent(),i.throwIfAborted(o),m=0,y=s;m<y.length;m++)"CIMPictureMarker"!==(f=y[m]).cim.type&&"CIMPictureFill"!==f.cim.type&&"CIMPictureStroke"!==f.cim.type||(u||(u=[]),u.push(this.fetchPictureMarkerResource(f,o))),r&&"text"===f.type&&"string"==typeof f.text&&f.text.indexOf("[")>-1&&(f.text=h.createLabelOverrideFunction(r,f.text,f.cim.textCase));return u?[4,i.all(u)]:[3,3];case 2:a.sent(),a.label=3;case 3:return[2,s]}}))}))},e.prototype.fetchPictureMarkerResource=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var i,n,o;return a.__generator(this,(function(a){switch(a.label){case 0:return i=e.materialHash,this._pictureMarkerCache.get(i)?[3,2]:[4,r(e.cim.url,{responseType:"image",signal:t&&t.signal})];case 1:n=a.sent(),o=n.data,this._pictureMarkerCache.set(i,o),a.label=2;case 2:return[2]}}))}))},e.prototype.rasterizeCIMSymbol=function(e,t,a,r,i,n){for(var o=[],s=0,l=e;s<l.length;s++){var c=l[s];r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(t,i,n));var u=this._getRasterizedResource(c,t,a,r,i,n);if(u){var m=0,y=u.anchorX||0,f=u.anchorY||0,g=!1,v=0,d=0;if("esriGeometryPoint"===a){var M=p(r,c,null);if(v=h.evaluateValueOrFunction(c.offsetX,t,i,n)*M||0,d=h.evaluateValueOrFunction(c.offsetY,t,i,n)*M||0,"marker"===c.type)m=h.evaluateValueOrFunction(c.rotation,t,i,n)||0,g=!!c.rotateClockwise&&c.rotateClockwise;else if("text"===c.type){if(m=h.evaluateValueOrFunction(c.angle,t,i,n)||0,void 0!==c.horizontalAlignment)switch(c.horizontalAlignment){case"left":y=-.5;break;case"right":y=.5;break;default:y=0}if(void 0!==c.verticalAlignment)switch(c.verticalAlignment){case"top":f=.5;break;case"bottom":f=-.5;break;case"baseline":f=-.25;break;default:f=0}}}null!=u&&o.push({angle:m,rotateClockWise:g,anchorX:y,anchorY:f,offsetX:v,offsetY:d,rasterizedResource:u})}}return this.getSymbolImage(o)},e.prototype.getSymbolImage=function(e){for(var t=document.createElement("canvas"),a=t.getContext("2d"),r=0,i=0,o=0,s=0,l=[],c=0;c<e.length;c++){var u=e[c],h=u.rasterizedResource;if(h){var m=h.size,f=u.offsetX,p=u.offsetY,g=u.anchorX,v=u.anchorY,d=u.rotateClockWise||!1,M=u.angle,x=n.pt2px(f)-m[0]*(.5+g),C=n.pt2px(p)-m[1]*(.5+v),I=x+m[0],z=C+m[1];if(M){d&&(M=-M);var P=Math.sin(M*Math.PI/180),_=Math.cos(M*Math.PI/180),b=x*_-C*P,w=x*P+C*_,S=x*_-z*P,k=x*P+z*_,F=I*_-z*P,R=I*P+z*_,O=I*_-C*P,V=I*P+C*_;x=Math.min(b,S,F,O),C=Math.min(w,k,R,V),I=Math.max(b,S,F,O),z=Math.max(w,k,R,V)}r=x<r?x:r,i=C<i?C:i,o=I>o?I:o,s=z>s?z:s;var D=a.createImageData(h.size[0],h.size[1]);D.data.set(new Uint8ClampedArray(h.image.buffer));var A={offsetX:f,offsetY:p,rotateClockwise:d,angle:M,rasterizedImage:D,anchorX:g,anchorY:v};l.push(A)}}t.width=o-r,t.height=s-i;var T=-r,X=s;for(c=0;c<l.length;c++){A=l[c];var Y=this._imageDataToCanvas(A.rasterizedImage),G=A.rasterizedImage.width,L=A.rasterizedImage.height,U=T-G*(.5+A.anchorX),H=X-L*(.5-A.anchorY);if(A.angle){var J=(360-A.angle)*Math.PI/180;a.save(),a.translate(n.pt2px(A.offsetX),-n.pt2px(A.offsetY)),a.translate(T,X),a.rotate(J),a.translate(-T,-X),a.drawImage(Y,U,H),a.restore()}else a.drawImage(Y,U+n.pt2px(A.offsetX),H-n.pt2px(A.offsetY))}var N=new y.default({x:T/t.width-.5,y:X/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:N}},e.prototype._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},e.prototype._imageTo32Array=function(e,t,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var r=this._imageDataCanvas,i=r.getContext("2d");return r.width=t,r.height=a,i.drawImage(e,0,0,t,a),new Uint32Array(i.getImageData(0,0,t,a).data.buffer)},e.prototype._getRasterizedResource=function(e,t,a,r,i,n){var s,l,c,u,y,v,M,x,C,I;if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a){var z=r&&r.style?r.style:f.Legend,P="esriGeometryPolyline"===a?g.stroke[z]:g.fill[z];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){var _=h.evaluateValueOrFunction(e.width,t,i,n),b=void 0,w=void 0,S=void 0;return b=(l=this._getPictureResource(e,_)).image,w=l.width,S=l.height,this._rasterizePictureResource(e,b,w,S,P,_)}return null}M=(s=d(e,t,i,n)).analyzedCIM,C=s.hash,x=this._embedCIMLayerInVectorMarker(M,P)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=h.evaluateValueOrFunction(e.offsetX,t,i,n),e.cim.offsetY=h.evaluateValueOrFunction(e.offsetY,t,i,n),e.cim.rotation=h.evaluateValueOrFunction(e.rotation,t,i,n),e.cim.markerPlacement=e.markerPlacement,M=d(e,t,i,n).analyzedCIM,C=o.numericHash(JSON.stringify(M)).toString(),x=this._embedCIMLayerInVectorMarker(M,P)}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){_=e.cim.size||e.cim.height,b=void 0,w=void 0,S=void 0;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)b=(c=this._getPictureResource(e,_)).image,w=c.width,S=c.height;else{M=(u=d(e,t,i,n)).analyzedCIM,C=u.hash;var k=this._rasterizer.rasterizeJSONResource(M,1,this._avoidSDF);b=k.image,w=k.size[0],S=k.size[1]}return this._rasterizePictureResource(e,b,w,S,P,null)}if("CIMSolidFill"!==e.cim.type)return null;M=(y=d(e,t,i,n)).analyzedCIM,C=y.hash,x=this._embedCIMLayerInVectorMarker(M,P)}}}else{if("text"===e.type)return I=this._rasterizeTextResource(e,t,r,i,n);M=(v=d(e,t,i,n)).analyzedCIM,C=v.hash;var F=p(r,e,null);if("CIMPictureMarker"===e.cim.type){_=h.evaluateValueOrFunction(e.size,t,i,n)*F;var R=this._getPictureResource(e,_);return I={image:b=R.image,size:[w=R.width,S=R.height],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0}}m.scaleCIMMarker(M,F),x=M}C+=a,r&&(C+=JSON.stringify(r));var O=this._resourceCache;return O.has(C)?O.get(C):(I=this._rasterizer.rasterizeJSONResource(x,window.devicePixelRatio||1,this._avoidSDF),O.set(C,I),I)},e.prototype._rasterizeTextResource=function(e,t,a,r,i){var n=p(a,e,null),o=h.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;var s=h.evaluateValueOrFunction(e.fontName,t,r,i),l=h.evaluateValueOrFunction(e.style,t,r,i),c=h.evaluateValueOrFunction(e.weight,t,r,i),u=h.evaluateValueOrFunction(e.decoration,t,r,i),m=h.evaluateValueOrFunction(e.size,t,r,i)*n,y=h.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),f=h.evaluateValueOrFunction(e.verticalAlignment,t,r,i),g=h.colorToArray(h.evaluateValueOrFunction(e.color,t,r,i)),v=h.colorToArray(h.evaluateValueOrFunction(e.outlineColor,t,r,i)),d={color:g,size:m,horizontalAlignment:y,verticalAlignment:f,font:{family:s,style:l,weight:c,decoration:u},halo:{size:h.evaluateValueOrFunction(e.outlineSize,t,r,i)||0,color:v,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,d)},e.prototype._rasterizePictureResource=function(e,t,a,r,i,o){var l=document.createElement("canvas"),c=l.getContext("2d");l.height=n.pt2px(Math.max(Math.abs(i.frame.ymax-i.frame.ymin),o)),l.width=n.pt2px(Math.abs(i.frame.xmax-i.frame.xmin));var u=c.createImageData(a,r);u.data.set(new Uint8ClampedArray(t.buffer));var h=this._imageDataToCanvas(u),m=c.createPattern(h,"repeat"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),f=Math.sin((-e.cim.rotation||0)*Math.PI/180);m.setTransform({m11:y,m12:f,m21:-f,m22:y,m41:n.pt2px(e.cim.offsetX)||0,m42:n.pt2px(e.cim.offsetY)||0});var p,g,v,d=i.canvasPaths;s.isPolygon(d)?(p=d.rings,c.fillStyle=m,g=c.fill,v=["evenodd"]):s.isPolyline(d)&&(p=d.paths,c.strokeStyle=m,c.lineWidth=o,g=c.stroke,p[0][0][1]=l.height/2,p[0][1][1]=l.height/2),c.beginPath();for(var M=0,x=p;M<x.length;M++){var C=x[M],I=C?C.length:0;if(I>1){var z=C[0];c.moveTo(n.pt2px(z[0]),n.pt2px(z[1]));for(var P=1;P<I;++P)z=C[P],c.lineTo(n.pt2px(z[0]),n.pt2px(z[1]));c.closePath()}}g.apply(c,v);var _=c.getImageData(0,0,l.width,l.height),b=new Uint8Array(_.data);return{size:[l.width,l.height],image:new Uint32Array(b.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}},e.prototype._getPictureResource=function(e,t){var a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;var r=a.height/a.width,i=t?r>1?n.pt2px(t):n.pt2px(t)/r:a.width,o=t?r>1?n.pt2px(t)*r:n.pt2px(t):a.height;return{image:this._imageTo32Array(a,i,o),width:i,height:o}},e.prototype._embedCIMLayerInVectorMarker=function(e,t){var a=s.isPolygon(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:a,symbolLayers:[e]}}]}},e}();function d(e,t,a,r){var i,n;"function"==typeof e.materialHash?(i=(0,e.materialHash)(t,a,r),n=l.analyzeCIMResource(e.cim,e.materialOverrides)):(i=e.materialHash,n=e.cim);return{analyzedCIM:n,hash:i}}t.CIMSymbolRasterizer=v}));