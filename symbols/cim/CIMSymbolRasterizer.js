/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Color","../../request","../../core/promiseUtils","../../core/screenUtils","../../core/string","../../geometry/support/jsonUtils","./cimAnalyzer","./CIMResourceManager","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],(function(e,t,a,r,i,n,o,s,l,c,u,m,h,y,f){"use strict";var g;e.GeometryStyle=void 0,(g=e.GeometryStyle||(e.GeometryStyle={})).Legend="legend",g.Preview="preview";const p=(e,t,a)=>{if(e&&e.targetSize){let r;if(a){const t=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);r=e.targetSize/n.pt2px(t)}else r=e.targetSize/t.referenceSize;return r}return e&&e.scaleFactor?e.scaleFactor:1},d={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};let M=function(){function g(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new m.TextRasterizer,this._cimResourceManager=new c,this._rasterizer=new u(this._cimResourceManager)}var M=g.prototype;return M.rasterizeCIMSymbolAsync=function(){var e=t._asyncToGenerator((function*(e,t,a,r,i,n,o,l){r=r||(t?null!=t.centroid?"esriGeometryPolygon":s.getJsonType(t.geometry):null)||v(e);const c=yield this.analyzeCIMSymbol(e,t?x(t.attributes):null,a,r,l);return this.rasterizeCIMSymbol(c,t,r,i,n,o)}));function a(t,a,r,i,n,o,s,l){return e.apply(this,arguments)}return a}(),M.analyzeCIMSymbol=function(){var e=t._asyncToGenerator((function*(e,t,a,r,n){const o=[],s=t?{geometryType:r,spatialReference:this._spatialReference,fields:t}:null;let c;yield l.analyzeCIMSymbol(e.data,s,this._cimResourceManager,o,this._avoidSDF),i.throwIfAborted(n);for(const i of o)"CIMPictureMarker"!==i.cim.type&&"CIMPictureFill"!==i.cim.type&&"CIMPictureStroke"!==i.cim.type||(c||(c=[]),c.push(this._fetchPictureMarkerResource(i,n))),a&&"text"===i.type&&"string"==typeof i.text&&i.text.indexOf("[")>-1&&(i.text=h.createLabelOverrideFunction(a,i.text,i.cim.textCase));return c&&(yield Promise.all(c)),o}));function a(t,a,r,i,n){return e.apply(this,arguments)}return a}(),M._fetchPictureMarkerResource=function(){var e=t._asyncToGenerator((function*(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(yield r(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,i)}}));function a(t,a){return e.apply(this,arguments)}return a}(),M.rasterizeCIMSymbol=function(e,t,a,r,i,n){const o=[];for(const s of e){r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(t,i,n));const e=this._getRasterizedResource(s,t,a,r,i,n);if(!e)continue;let l=0,c=e.anchorX||0,u=e.anchorY||0,m=!1,y=0,f=0;if("esriGeometryPoint"===a){const e=p(r,s,null);if(y=h.evaluateValueOrFunction(s.offsetX,t,i,n)*e||0,f=h.evaluateValueOrFunction(s.offsetY,t,i,n)*e||0,"marker"===s.type)l=h.evaluateValueOrFunction(s.rotation,t,i,n)||0,m=!!s.rotateClockwise&&s.rotateClockwise;else if("text"===s.type){if(l=h.evaluateValueOrFunction(s.angle,t,i,n)||0,void 0!==s.horizontalAlignment)switch(s.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==s.verticalAlignment)switch(s.verticalAlignment){case"top":u=.5;break;case"bottom":u=-.5;break;case"baseline":u=-.25;break;default:u=0}}}null!=e&&o.push({angle:l,rotateClockWise:m,anchorX:c,anchorY:u,offsetX:y,offsetY:f,rasterizedResource:e})}return this.getSymbolImage(o)},M.getSymbolImage=function(e){const t=document.createElement("canvas"),a=t.getContext("2d");let r=0,i=0,o=0,s=0;const l=[];for(let h=0;h<e.length;h++){const t=e[h],c=t.rasterizedResource;if(!c)continue;const u=c.size,m=t.offsetX,y=t.offsetY,f=t.anchorX,g=t.anchorY,p=t.rotateClockWise||!1;let d=t.angle,M=n.pt2px(m)-u[0]*(.5+f),x=n.pt2px(y)-u[1]*(.5+g),v=M+u[0],C=x+u[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),a=M*t-x*e,r=M*e+x*t,i=M*t-C*e,n=M*e+C*t,o=v*t-C*e,s=v*e+C*t,l=v*t-x*e,c=v*e+x*t;M=Math.min(a,i,o,l),x=Math.min(r,n,s,c),v=Math.max(a,i,o,l),C=Math.max(r,n,s,c)}r=M<r?M:r,i=x<i?x:i,o=v>o?v:o,s=C>s?C:s;const I=a.createImageData(c.size[0],c.size[1]);I.data.set(new Uint8ClampedArray(c.image.buffer));const z={offsetX:m,offsetY:y,rotateClockwise:p,angle:d,rasterizedImage:I,anchorX:f,anchorY:g};l.push(z)}t.width=o-r,t.height=s-i;const c=-r,u=s;for(let h=0;h<l.length;h++){const e=l[h],t=this._imageDataToCanvas(e.rasterizedImage),r=e.rasterizedImage.width,i=e.rasterizedImage.height,o=c-r*(.5+e.anchorX),s=u-i*(.5-e.anchorY);if(e.angle){const r=(360-e.angle)*Math.PI/180;a.save(),a.translate(n.pt2px(e.offsetX),-n.pt2px(e.offsetY)),a.translate(c,u),a.rotate(r),a.translate(-c,-u),a.drawImage(t,o,s),a.restore()}else a.drawImage(t,o+n.pt2px(e.offsetX),s-n.pt2px(e.offsetY))}const m=new f.Symbol3DAnchorPosition2D({x:c/t.width-.5,y:u/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:m}},M._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},M._imageTo32Array=function(e,t,r,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const n=this._imageDataCanvas,o=n.getContext("2d");if(n.width=t,n.height=r,o.drawImage(e,0,0,t,r),i){o.save();const n=new a(i);o.fillStyle=n.toHex(),o.globalCompositeOperation="multiply",o.fillRect(0,0,t,r),o.globalCompositeOperation="destination-atop",o.drawImage(e,0,0,t,r),o.restore()}return new Uint32Array(o.getImageData(0,0,t,r).data.buffer)},M._getRasterizedResource=function(t,a,r,i,n,s){let l,c,u,m,f=null,g=null;if("esriGeometryPolyline"===r||"esriGeometryPolygon"===r){const m=i&&i.style?i.style:e.GeometryStyle.Legend,y="esriGeometryPolyline"===r?d.stroke[m]:d.fill[m];if("line"===t.type){if("CIMSolidStroke"!==t.cim.type){if("CIMPictureStroke"===t.cim.type){const e=h.evaluateValueOrFunction(t.width,a,n,s),r=h.evaluateValueOrFunction(t.color,a,n,s),{image:i,width:o,height:l}=this._getPictureResource(t,e,r);return this._rasterizePictureResource(t,i,o,l,y,e)}return null}({analyzedCIM:l,hash:u}=C(t,a,n,s)),c=this._embedCIMLayerInVectorMarker(l,y)}else if("marker"===t.type){if("CIMPictureMarker"===t.cim.type){const e=h.evaluateValueOrFunction(t.size,a,n,s),r=h.evaluateValueOrFunction(t.color,a,n,s),{image:i,width:o,height:l}=this._getPictureResource(t,e,r);return this._rasterizePictureResource(t,i,o,l,y,e)}if("CIMVectorMarker"!==t.cim.type)return null;t.cim.offsetX=h.evaluateValueOrFunction(t.offsetX,a,n,s),t.cim.offsetY=h.evaluateValueOrFunction(t.offsetY,a,n,s),t.cim.rotation=h.evaluateValueOrFunction(t.rotation,a,n,s),t.cim.markerPlacement=t.markerPlacement,({analyzedCIM:l}=C(t,a,n,s)),u=o.numericHash(JSON.stringify(l)).toString(),c=this._embedCIMLayerInVectorMarker(l,y),f=h.evaluateValueOrFunction(t.size,a,n,s),g=t.path}else{if("text"===t.type)return null;if("fill"===t.type){if("CIMHatchFill"===t.cim.type||"CIMVectorMarker"===t.cim.type||"CIMPictureMarker"===t.cim.type||"CIMPictureFill"===t.cim.type){const e=t.cim.size||t.cim.height;let r,i,o;if("CIMPictureMarker"===t.cim.type||"CIMPictureFill"===t.cim.type)({image:r,width:i,height:o}=this._getPictureResource(t,e,h.evaluateValueOrFunction(t.color,a,n,s)));else{({analyzedCIM:l,hash:u}=C(t,a,n,s));const c=this._rasterizer.rasterizeJSONResource({cim:l,type:t.type,url:t.url,mosaicHash:u,size:e,path:g},1,this._avoidSDF);r=c.image,i=c.size[0],o=c.size[1]}return this._rasterizePictureResource(t,r,i,o,y,null)}if("CIMSolidFill"!==t.cim.type)return null;({analyzedCIM:l,hash:u}=C(t,a,n,s)),c=this._embedCIMLayerInVectorMarker(l,y)}}}else{if("text"===t.type)return m=this._rasterizeTextResource(t,a,i,n,s),m;({analyzedCIM:l,hash:u}=C(t,a,n,s));const e=p(i,t,null);if("CIMPictureMarker"===t.cim.type){const r=h.evaluateValueOrFunction(t.size,a,n,s)*e,{image:i,width:o,height:l}=this._getPictureResource(t,r,h.evaluateValueOrFunction(t.color,a,n,s));return m={image:i,size:[o,l],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},m}y.scaleCIMMarker(l,e,{preserveOutlineWidth:!1}),c=l}u+=r,i&&(u+=JSON.stringify(i));const M=this._resourceCache;return M.has(u)?M.get(u):(m=this._rasterizer.rasterizeJSONResource({cim:c,type:t.type,url:t.url,mosaicHash:u,size:f,path:g},window.devicePixelRatio||1,this._avoidSDF),M.set(u,m),m)},M._rasterizeTextResource=function(e,t,a,r,i){const n=p(a,e,null),o=h.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;const s=h.evaluateValueOrFunction(e.fontName,t,r,i),l=h.evaluateValueOrFunction(e.style,t,r,i),c=h.evaluateValueOrFunction(e.weight,t,r,i),u=h.evaluateValueOrFunction(e.decoration,t,r,i),m=h.evaluateValueOrFunction(e.size,t,r,i)*n,y=h.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),f=h.evaluateValueOrFunction(e.verticalAlignment,t,r,i),g=h.colorToArray(h.evaluateValueOrFunction(e.color,t,r,i)),d=h.colorToArray(h.evaluateValueOrFunction(e.outlineColor,t,r,i)),M={color:g,size:m,horizontalAlignment:y,verticalAlignment:f,font:{family:s,style:l,weight:c,decoration:u},halo:{size:h.evaluateValueOrFunction(e.outlineSize,t,r,i)||0,color:d,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)},M._rasterizePictureResource=function(e,t,a,r,i,o){const l=document.createElement("canvas"),c=l.getContext("2d");l.height=n.pt2px(Math.max(i.frame.ymax-i.frame.ymin,o)),l.width=n.pt2px(i.frame.xmax-i.frame.xmin);const u=c.createImageData(a,r);u.data.set(new Uint8ClampedArray(t.buffer));const m=this._imageDataToCanvas(u),h=c.createPattern(m,"repeat"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),f=Math.sin((-e.cim.rotation||0)*Math.PI/180);h.setTransform({m11:y,m12:f,m21:-f,m22:y,m41:n.pt2px(e.cim.offsetX)||0,m42:n.pt2px(e.cim.offsetY)||0});const g=i.canvasPaths;let p,d,M;s.isPolygon(g)?(p=g.rings,c.fillStyle=h,d=c.fill,M=["evenodd"]):s.isPolyline(g)&&(p=g.paths,c.strokeStyle=h,c.lineWidth=o,d=c.stroke,p[0][0][1]=l.height/2,p[0][1][1]=l.height/2),c.beginPath();for(const s of p){const e=s?s.length:0;if(e>1){let t=s[0];c.moveTo(n.pt2px(t[0]),n.pt2px(t[1]));for(let a=1;a<e;++a)t=s[a],c.lineTo(n.pt2px(t[0]),n.pt2px(t[1]));c.closePath()}}d.apply(c,M);const x=c.getImageData(0,0,l.width,l.height),v=new Uint8Array(x.data);return{size:[l.width,l.height],image:new Uint32Array(v.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}},M._getPictureResource=function(e,t,a){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const i=r.height/r.width,o=t?i>1?n.pt2px(t):n.pt2px(t)/i:r.width,s=t?i>1?n.pt2px(t)*i:n.pt2px(t):r.height;return{image:this._imageTo32Array(r,o,s,a),width:o,height:s}},M._embedCIMLayerInVectorMarker=function(e,t){const a=s.isPolygon(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",r=t.frame;return{type:"CIMVectorMarker",frame:r,size:r.ymax-r.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:a,symbolLayers:[e]}}]}},g}();function x(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}function v(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function C(e,t,a,r){let i,n;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,a,r),n=l.analyzeCIMResource(e.cim,e.materialOverrides)}else i=e.materialHash,n=e.cim;return{analyzedCIM:n,hash:i}}e.CIMSymbolRasterizer=M,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
