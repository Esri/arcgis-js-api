/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/string","../../core/promiseUtils","../../geometry/support/jsonUtils","../../core/screenUtils","../support/Symbol3DAnchorPosition2D","../../request","./utils","../support/cimSymbolUtils","./cimAnalyzer","./Rasterizer","./TextRasterizer"],(function(e,t,a,r,i,n,o,s,l,c,u,m){"use strict";var h;(h=e.GeometryStyle||(e.GeometryStyle={})).Legend="legend",h.Preview="preview";const f=(e,t,a)=>{if(e&&e.targetSize){let r;if(a){const t=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);r=e.targetSize/i.pt2px(t)}else r=e.targetSize/t.referenceSize;return r}return e&&e.scaleFactor?e.scaleFactor:1},y={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};let g=function(){function h(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new u,this._textRasterizer=new m.TextRasterizer,this._pictureMarkerCache=new Map}var g=h.prototype;return g.rasterizeCIMSymbolAsync=async function(e,t,a,i,n,o,s,l){i=i||(t?null!=t.centroid?"esriGeometryPolygon":r.getJsonType(t.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e);const c=await this.analyzeCIMSymbol(e,t?function(e){const t=e?Object.keys(e):[];return t.map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(t.attributes):null,a,i,l);return this.rasterizeCIMSymbol(c,t,i,n,o,s)},g.analyzeCIMSymbol=async function(e,t,r,i,n){const o=[],l=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null;let u;await c.analyzeCIMSymbol(e.data,l,o,this._avoidSDF),a.throwIfAborted(n);for(const e of o)"CIMPictureMarker"!==e.cim.type&&"CIMPictureFill"!==e.cim.type&&"CIMPictureStroke"!==e.cim.type||(u||(u=[]),u.push(this.fetchPictureMarkerResource(e,n))),r&&"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=s.createLabelOverrideFunction(r,e.text,e.cim.textCase));return u&&await a.all(u),o},g.fetchPictureMarkerResource=async function(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const r=(await o(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,r)}},g.rasterizeCIMSymbol=function(e,t,a,r,i,n){const o=[];for(const l of e){r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(t,i,n));const e=this._getRasterizedResource(l,t,a,r,i,n);if(!e)continue;let c=0,u=e.anchorX||0,m=e.anchorY||0,h=!1,y=0,g=0;if("esriGeometryPoint"===a){const e=f(r,l,null);if(y=s.evaluateValueOrFunction(l.offsetX,t,i,n)*e||0,g=s.evaluateValueOrFunction(l.offsetY,t,i,n)*e||0,"marker"===l.type)c=s.evaluateValueOrFunction(l.rotation,t,i,n)||0,h=!!l.rotateClockwise&&l.rotateClockwise;else if("text"===l.type){if(c=s.evaluateValueOrFunction(l.angle,t,i,n)||0,void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case"left":u=-.5;break;case"right":u=.5;break;default:u=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}null!=e&&o.push({angle:c,rotateClockWise:h,anchorX:u,anchorY:m,offsetX:y,offsetY:g,rasterizedResource:e})}return this.getSymbolImage(o)},g.getSymbolImage=function(e){const t=document.createElement("canvas"),a=t.getContext("2d");let r=0,o=0,s=0,l=0;const c=[];for(let t=0;t<e.length;t++){const n=e[t],u=n.rasterizedResource;if(!u)continue;const m=u.size,h=n.offsetX,f=n.offsetY,y=n.anchorX,g=n.anchorY,p=n.rotateClockWise||!1;let d=n.angle,M=i.pt2px(h)-m[0]*(.5+y),x=i.pt2px(f)-m[1]*(.5+g),C=M+m[0],I=x+m[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),a=M*t-x*e,r=M*e+x*t,i=M*t-I*e,n=M*e+I*t,o=C*t-I*e,s=C*e+I*t,l=C*t-x*e,c=C*e+x*t;M=Math.min(a,i,o,l),x=Math.min(r,n,s,c),C=Math.max(a,i,o,l),I=Math.max(r,n,s,c)}r=M<r?M:r,o=x<o?x:o,s=C>s?C:s,l=I>l?I:l;const v=a.createImageData(u.size[0],u.size[1]);v.data.set(new Uint8ClampedArray(u.image.buffer));const z={offsetX:h,offsetY:f,rotateClockwise:p,angle:d,rasterizedImage:v,anchorX:y,anchorY:g};c.push(z)}t.width=s-r,t.height=l-o;const u=-r,m=l;for(let e=0;e<c.length;e++){const t=c[e],r=this._imageDataToCanvas(t.rasterizedImage),n=t.rasterizedImage.width,o=t.rasterizedImage.height,s=u-n*(.5+t.anchorX),l=m-o*(.5-t.anchorY);if(t.angle){const e=(360-t.angle)*Math.PI/180;a.save(),a.translate(i.pt2px(t.offsetX),-i.pt2px(t.offsetY)),a.translate(u,m),a.rotate(e),a.translate(-u,-m),a.drawImage(r,s,l),a.restore()}else a.drawImage(r,s+i.pt2px(t.offsetX),l-i.pt2px(t.offsetY))}const h=new n.default({x:u/t.width-.5,y:m/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:h}},g._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},g._imageTo32Array=function(e,t,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const r=this._imageDataCanvas,i=r.getContext("2d");return r.width=t,r.height=a,i.drawImage(e,0,0,t,a),new Uint32Array(i.getImageData(0,0,t,a).data.buffer)},g._getRasterizedResource=function(a,r,i,n,o,c){let u,m,h,g;if("esriGeometryPolyline"===i||"esriGeometryPolygon"===i){const l=n&&n.style?n.style:e.GeometryStyle.Legend,f="esriGeometryPolyline"===i?y.stroke[l]:y.fill[l];if("line"===a.type){if("CIMSolidStroke"!==a.cim.type){if("CIMPictureStroke"===a.cim.type){const e=s.evaluateValueOrFunction(a.width,r,o,c);let t,i,n;return({image:t,width:i,height:n}=this._getPictureResource(a,e)),this._rasterizePictureResource(a,t,i,n,f,e)}return null}({analyzedCIM:u,hash:h}=p(a,r,o,c)),m=this._embedCIMLayerInVectorMarker(u,f)}else if("marker"===a.type){if("CIMPictureMarker"===a.cim.type)return null;if("CIMVectorMarker"!==a.cim.type)return null;a.cim.offsetX=s.evaluateValueOrFunction(a.offsetX,r,o,c),a.cim.offsetY=s.evaluateValueOrFunction(a.offsetY,r,o,c),a.cim.rotation=s.evaluateValueOrFunction(a.rotation,r,o,c),a.cim.markerPlacement=a.markerPlacement,({analyzedCIM:u}=p(a,r,o,c)),h=t.numericHash(JSON.stringify(u)).toString(),m=this._embedCIMLayerInVectorMarker(u,f)}else{if("text"===a.type)return null;if("fill"===a.type){if("CIMHatchFill"===a.cim.type||"CIMVectorMarker"===a.cim.type||"CIMPictureMarker"===a.cim.type||"CIMPictureFill"===a.cim.type){const e=a.cim.size||a.cim.height;let t,i,n;if("CIMPictureMarker"===a.cim.type||"CIMPictureFill"===a.cim.type)({image:t,width:i,height:n}=this._getPictureResource(a,e));else{({analyzedCIM:u,hash:h}=p(a,r,o,c));const e=this._rasterizer.rasterizeJSONResource(u,1,this._avoidSDF);t=e.image,i=e.size[0],n=e.size[1]}return this._rasterizePictureResource(a,t,i,n,f,null)}if("CIMSolidFill"!==a.cim.type)return null;({analyzedCIM:u,hash:h}=p(a,r,o,c)),m=this._embedCIMLayerInVectorMarker(u,f)}}}else{if("text"===a.type)return g=this._rasterizeTextResource(a,r,n,o,c),g;({analyzedCIM:u,hash:h}=p(a,r,o,c));const e=f(n,a,null);if("CIMPictureMarker"===a.cim.type){const t=s.evaluateValueOrFunction(a.size,r,o,c)*e,{image:i,width:n,height:l}=this._getPictureResource(a,t);return g={image:i,size:[n,l],sdf:!1,simplePattern:!1,anchorX:a.anchorPoint?a.anchorPoint.x:0,anchorY:a.anchorPoint?a.anchorPoint.y:0},g}l.scaleCIMMarker(u,e,{preserveOutlineWidth:!1}),m=u}h+=i,n&&(h+=JSON.stringify(n));const d=this._resourceCache;return d.has(h)?d.get(h):(g=this._rasterizer.rasterizeJSONResource(m,window.devicePixelRatio||1,this._avoidSDF),d.set(h,g),g)},g._rasterizeTextResource=function(e,t,a,r,i){const n=f(a,e,null),o=s.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;const l=s.evaluateValueOrFunction(e.fontName,t,r,i),c=s.evaluateValueOrFunction(e.style,t,r,i),u=s.evaluateValueOrFunction(e.weight,t,r,i),m=s.evaluateValueOrFunction(e.decoration,t,r,i),h=s.evaluateValueOrFunction(e.size,t,r,i)*n,y=s.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),g=s.evaluateValueOrFunction(e.verticalAlignment,t,r,i),p=s.colorToArray(s.evaluateValueOrFunction(e.color,t,r,i)),d=s.colorToArray(s.evaluateValueOrFunction(e.outlineColor,t,r,i)),M={color:p,size:h,horizontalAlignment:y,verticalAlignment:g,font:{family:l,style:c,weight:u,decoration:m},halo:{size:s.evaluateValueOrFunction(e.outlineSize,t,r,i)||0,color:d,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)},g._rasterizePictureResource=function(e,t,a,n,o,s){const l=document.createElement("canvas"),c=l.getContext("2d");l.height=i.pt2px(Math.max(Math.abs(o.frame.ymax-o.frame.ymin),s)),l.width=i.pt2px(Math.abs(o.frame.xmax-o.frame.xmin));const u=c.createImageData(a,n);u.data.set(new Uint8ClampedArray(t.buffer));const m=this._imageDataToCanvas(u),h=c.createPattern(m,"repeat"),f=Math.cos((-e.cim.rotation||0)*Math.PI/180),y=Math.sin((-e.cim.rotation||0)*Math.PI/180);h.setTransform({m11:f,m12:y,m21:-y,m22:f,m41:i.pt2px(e.cim.offsetX)||0,m42:i.pt2px(e.cim.offsetY)||0});const g=o.canvasPaths;let p,d,M;r.isPolygon(g)?(p=g.rings,c.fillStyle=h,d=c.fill,M=["evenodd"]):r.isPolyline(g)&&(p=g.paths,c.strokeStyle=h,c.lineWidth=s,d=c.stroke,p[0][0][1]=l.height/2,p[0][1][1]=l.height/2),c.beginPath();for(const e of p){const t=e?e.length:0;if(t>1){let a=e[0];c.moveTo(i.pt2px(a[0]),i.pt2px(a[1]));for(let r=1;r<t;++r)a=e[r],c.lineTo(i.pt2px(a[0]),i.pt2px(a[1]));c.closePath()}}d.apply(c,M);const x=c.getImageData(0,0,l.width,l.height),C=new Uint8Array(x.data);return{size:[l.width,l.height],image:new Uint32Array(C.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}},g._getPictureResource=function(e,t){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const r=a.height/a.width,n=t?r>1?i.pt2px(t):i.pt2px(t)/r:a.width,o=t?r>1?i.pt2px(t)*r:i.pt2px(t):a.height;return{image:this._imageTo32Array(a,n,o),width:n,height:o}},g._embedCIMLayerInVectorMarker=function(e,t){const a=r.isPolygon(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:a,symbolLayers:[e]}}]}},h}();function p(e,t,a,r){let i,n;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,a,r),n=c.analyzeCIMResource(e.cim,e.materialOverrides)}else i=e.materialHash,n=e.cim;return{analyzedCIM:n,hash:i}}e.CIMSymbolRasterizer=g,Object.defineProperty(e,"__esModule",{value:!0})}));
