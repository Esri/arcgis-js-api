/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Color","../../request","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./cimAnalyzer","./CIMResourceManager","./CIMSymbolDrawHelper","./CIMSymbolHelper","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],(function(e,t,a,r,i,n,o,s,c,l,h,u,m,g,f,p){"use strict";var y;e.GeometryStyle=void 0,(y=e.GeometryStyle||(e.GeometryStyle={})).Legend="legend",y.Preview="preview";const d=e=>e&&e.scaleFactor?e.scaleFactor:1,w=96/72;let v=function(){function e(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new m,this._cimResourceManager=new c,this._rasterizer=new u(this._cimResourceManager)}var y=e.prototype;return y.rasterizeCIMSymbolAsync=function(){var e=t._asyncToGenerator((function*(e,t,a,r,i,n,o,s){if(!e)return null;const{data:c}=e;if(!c||"CIMSymbolReference"!==c.type||!c.symbol)return null;const{symbol:u}=c;n||(n=g.mapCIMSymbolToGeometryType(u));const m=yield h.OverrideHelper.resolveSymbolOverrides(c,t,this._spatialReference,i,n,o,s);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const f=this._imageDataCanvas,p=this._cimResourceManager,y=[];h.CIMSymbolHelper.fetchResources(m,p,y),y.length>0&&(yield Promise.all(y));const{width:d,height:v}=a,M=C(n,d,v,r),_=h.CIMSymbolHelper.getEnvelope(m,M,p);if(!_)return null;const x=(window.devicePixelRatio||1)*w;let I=1,b=0,z=0;switch(u.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;_.width>d&&(e=d/_.width);let t=1;_.height>v&&(t=v/_.height),"preview"===r&&(_.width<d&&(e=d/_.width),_.height<v&&(t=v/_.height)),I=Math.min(e,t),b=_.x+_.width/2,z=_.y+_.height/2}break;case"CIMLineSymbol":{let e=1;_.height>v&&(e=v/_.height),I=e,z=_.y+_.height/2;const t=_.x*I+d/2,a=(_.x+_.width)*I+d/2;if(t<0){const{paths:e}=M;e[0][0][0]-=t}if(a>d){const{paths:e}=M;e[0][2][0]-=a-d}}break;case"CIMPolygonSymbol":{b=_.x+_.width/2,z=_.y+_.height/2;const e=_.x*I+d/2,t=(_.x+_.width)*I+d/2,a=_.y*I+v/2,r=(_.y+_.height)*I+v/2,{rings:i}=M;e<0&&(i[0][0][0]-=e,i[0][3][0]-=e,i[0][4][0]-=e),a<0&&(i[0][0][1]+=a,i[0][1][1]+=a,i[0][4][1]+=a),t>d&&(i[0][1][0]-=t-d,i[0][2][0]-=t-d),r>v&&(i[0][2][1]+=r-v,i[0][3][1]+=r-v)}}f.width=d*x,f.height=v*x;const R=1;f.width+=2*R,f.height+=2*R;const S=f.getContext("2d"),O=l.Transformation.createIdentity();O.translate(-b,-z),O.scale(I*x,-I*x),O.translate(d*x/2+R,v*x/2+R),S.clearRect(0,0,f.width,f.height);return new l.CanvasDrawHelper(S,p,O,!0).drawSymbol(m,M),S.getImageData(0,0,f.width,f.height)}));function a(t,a,r,i,n,o,s,c){return e.apply(this,arguments)}return a}(),y.analyzeCIMSymbol=function(){var e=t._asyncToGenerator((function*(e,t,a,r,i){const o=[],c=t?{geometryType:r,spatialReference:this._spatialReference,fields:t}:null;let l;yield s.analyzeCIMSymbol(e.data,c,this._cimResourceManager,o,this._avoidSDF),n.throwIfAborted(i);for(const n of o)"CIMPictureMarker"!==n.cim.type&&"CIMPictureFill"!==n.cim.type&&"CIMPictureStroke"!==n.cim.type||(l||(l=[]),l.push(this._fetchPictureMarkerResource(n,i))),a&&"text"===n.type&&"string"==typeof n.text&&n.text.includes("[")&&(n.text=g.createLabelOverrideFunction(a,n.text,n.cim.textCase));return l&&(yield Promise.all(l)),o}));function a(t,a,r,i,n){return e.apply(this,arguments)}return a}(),y.rasterizeCIMSymbol3D=function(e,t,a,r,i,n){const o=[];for(const s of e){r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(t,i,n));const e=this._getRasterizedResource(s,t,a,r,i,n);if(!e)continue;let c=0,l=e.anchorX||0,h=e.anchorY||0,u=!1,m=0,f=0;if("esriGeometryPoint"===a){const e=d(r);if(m=g.evaluateValueOrFunction(s.offsetX,t,i,n)*e||0,f=g.evaluateValueOrFunction(s.offsetY,t,i,n)*e||0,"marker"===s.type)c=g.evaluateValueOrFunction(s.rotation,t,i,n)||0,u=!!s.rotateClockwise&&s.rotateClockwise;else if("text"===s.type){if(c=g.evaluateValueOrFunction(s.angle,t,i,n)||0,void 0!==s.horizontalAlignment)switch(s.horizontalAlignment){case"left":l=-.5;break;case"right":l=.5;break;default:l=0}if(void 0!==s.verticalAlignment)switch(s.verticalAlignment){case"top":h=.5;break;case"bottom":h=-.5;break;case"baseline":h=-.25;break;default:h=0}}}null!=e&&o.push({angle:c,rotateClockWise:u,anchorX:l,anchorY:h,offsetX:m,offsetY:f,rasterizedResource:e})}return this.getSymbolImage(o)},y.getSymbolImage=function(e){const t=document.createElement("canvas"),a=i.unwrapOrThrow(t.getContext("2d"));let r=0,n=0,s=0,c=0;const l=[];for(let i=0;i<e.length;i++){const t=e[i],h=t.rasterizedResource;if(!h)continue;const u=h.size,m=t.offsetX,g=t.offsetY,f=t.anchorX,p=t.anchorY,y=t.rotateClockWise||!1;let d=t.angle,w=o.pt2px(m)-u[0]*(.5+f),v=o.pt2px(g)-u[1]*(.5+p),C=w+u[0],M=v+u[1];if(d){y&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),a=w*t-v*e,r=w*e+v*t,i=w*t-M*e,n=w*e+M*t,o=C*t-M*e,s=C*e+M*t,c=C*t-v*e,l=C*e+v*t;w=Math.min(a,i,o,c),v=Math.min(r,n,s,l),C=Math.max(a,i,o,c),M=Math.max(r,n,s,l)}r=w<r?w:r,n=v<n?v:n,s=C>s?C:s,c=M>c?M:c;const _=a.createImageData(h.size[0],h.size[1]);_.data.set(new Uint8ClampedArray(h.image.buffer));const x={offsetX:m,offsetY:g,rotateClockwise:y,angle:d,rasterizedImage:_,anchorX:f,anchorY:p};l.push(x)}t.width=s-r,t.height=c-n;const h=-r,u=c;for(let i=0;i<l.length;i++){const e=l[i],t=this._imageDataToCanvas(e.rasterizedImage),r=e.rasterizedImage.width,n=e.rasterizedImage.height,s=h-r*(.5+e.anchorX),c=u-n*(.5-e.anchorY);if(e.angle){const r=(360-e.angle)*Math.PI/180;a.save(),a.translate(o.pt2px(e.offsetX),-o.pt2px(e.offsetY)),a.translate(h,u),a.rotate(r),a.translate(-h,-u),a.drawImage(t,s,c),a.restore()}else a.drawImage(t,s+o.pt2px(e.offsetX),c-o.pt2px(e.offsetY))}const m=new p.Symbol3DAnchorPosition2D({x:h/t.width-.5,y:u/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:m}},y._fetchPictureMarkerResource=function(){var e=t._asyncToGenerator((function*(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(yield r(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,i)}}));function a(t,a){return e.apply(this,arguments)}return a}(),y._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=i.unwrapOrThrow(t.getContext("2d"));return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},y._imageTo32Array=function(e,t,r,n){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const o=this._imageDataCanvas,s=i.unwrapOrThrow(o.getContext("2d"));if(o.width=t,o.height=r,s.drawImage(e,0,0,t,r),n){s.save();const i=new a(n);s.fillStyle=i.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,t,r),s.globalCompositeOperation="destination-atop",s.drawImage(e,0,0,t,r),s.restore()}return new Uint32Array(s.getImageData(0,0,t,r).data.buffer)},y._getRasterizedResource=function(e,t,a,r,n,o){let s,c,l;const h=null,u=null;if("text"===e.type)return this._rasterizeTextResource(e,t,r,n,o);({analyzedCIM:s,hash:c}=M(e,t,n,o));const m=d(r);if("CIMPictureMarker"===e.cim.type){const a=g.evaluateValueOrFunction(e.size,t,n,o)*m,{image:r,width:s,height:c}=i.unwrapOrThrow(this._getPictureResource(e,a,g.evaluateValueOrFunction(e.color,t,n,o)));return l={image:r,size:[s,c],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},l}f.scaleCIMMarker(s,m,{preserveOutlineWidth:!1});const p=s;c+=a,r&&(c+=JSON.stringify(r));const y=this._resourceCache;return y.has(c)?y.get(c):(l=this._rasterizer.rasterizeJSONResource({cim:p,type:e.type,url:e.url,mosaicHash:c,size:h,path:u},window.devicePixelRatio||1,this._avoidSDF),y.set(c,l),l)},y._rasterizeTextResource=function(e,t,a,r,i){const n=d(a),o=g.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;const s=g.evaluateValueOrFunction(e.fontName,t,r,i),c=g.evaluateValueOrFunction(e.style,t,r,i),l=g.evaluateValueOrFunction(e.weight,t,r,i),h=g.evaluateValueOrFunction(e.decoration,t,r,i),u=g.evaluateValueOrFunction(e.size,t,r,i)*n,m=g.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),f=g.evaluateValueOrFunction(e.verticalAlignment,t,r,i),p=g.colorToArray(g.evaluateValueOrFunction(e.color,t,r,i)),y=g.colorToArray(g.evaluateValueOrFunction(e.outlineColor,t,r,i)),w={color:p,size:u,horizontalAlignment:m,verticalAlignment:f,font:{family:s,style:c,weight:l,decoration:h},halo:{size:g.evaluateValueOrFunction(e.outlineSize,t,r,i)||0,color:y,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,w)},y._getPictureResource=function(e,t,a){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const i=r.height/r.width,n=t?i>1?o.pt2px(t):o.pt2px(t)/i:r.width,s=t?i>1?o.pt2px(t)*i:o.pt2px(t):r.height;return{image:this._imageTo32Array(r,n,s,a),width:n,height:s}},t._createClass(e,[{key:"resourceManager",get:function(){return this._cimResourceManager}}]),e}();function C(e,t,a,r){const i=1,n=-t/2+i,o=t/2-i,s=a/2-i,c=-a/2+i;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[n,0],[0,0],[o,0]]]};default:return"legend"===r?{rings:[[[n,s],[o,0],[o,c],[n,c],[n,s]]]}:{rings:[[[n,s],[o,s],[o,c],[n,c],[n,s]]]}}}function M(e,t,a,r){let i,n;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,a,r),n=s.analyzeCIMResource(e.cim,e.materialOverrides)}else i=e.materialHash,n=e.cim;return{analyzedCIM:n,hash:i}}e.CIMSymbolRasterizer=v,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
