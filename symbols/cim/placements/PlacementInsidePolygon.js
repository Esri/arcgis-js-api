/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/RandomLCG","../CIMPlacements","../enums"],(function(t,i,s,e,n){"use strict";const h=512,_=10,r=12,o=25,a=24;function l(t){return void 0!==t.rings}let c=function(){function t(){}return t.local=function(){return null===t.instance&&(t.instance=new t),t.instance},t.prototype.execute=function(t,i,s,e,n){return new f(t,i,s,e,n)},t}();c.instance=null;let f=function(){function t(t,i,_,r,o){if(this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,this._currentX=0,this._currentY=0,this._accelerationMap=null,this._testInsidePolygon=!1,this._verticalSubdivision=!0,this._stepX=Math.abs(i.stepX??16)*_,this._stepY=Math.abs(i.stepY??16)*_,0!==this._stepX&&0!==this._stepY&&t&&l(t)&&t.rings){if(this._gridType=i.gridType??n.PlacementGridType.Fixed,this._gridType===n.PlacementGridType.Random){const t=i.seed??13,e=1;this._randomLCG=new s(t*e),this._randomness=(i.randomness??100)/100,this._gridAngle=0,this._shiftOddRows=!1,this._cosAngle=1,this._sinAngle=0,this._offsetX=0,this._offsetY=0,this._buildRandomValues()}else{if(this._randomness=0,this._gridAngle=i.gridAngle??0,this._shiftOddRows=i.shiftOddRows??!1,this._offsetX=(i.offsetX??0)*_,this._offsetY=(i.offsetY??0)*_,this._cosAngle=Math.cos(this._gridAngle/180*Math.PI),this._sinAngle=-Math.sin(this._gridAngle/180*Math.PI),this._stepX)if(this._offsetX<0)for(;this._offsetX<-.5*this._stepX;)this._offsetX+=this._stepX;else for(;this._offsetX>=.5*this._stepX;)this._offsetX-=this._stepX;if(this._stepY)if(this._offsetY<0)for(;this._offsetY<-.5*this._stepY;)this._offsetY+=this._stepY;else for(;this._offsetY>=.5*this._stepY;)this._offsetY-=this._stepY}if(this._graphicOriginX=0,this._graphicOriginY=0,null!=r){const[t,i,s]=r.split("/"),e=parseFloat(i),n=parseFloat(s);this._graphicOriginX=-n*h,this._graphicOriginY=e*h,this._testInsidePolygon=!0}this._internalPlacement=new e.Placement,this._calculateMinMax(t),this._geometry=t}}var c=t.prototype;return c.next=function(){return this._geometry?this._nextInside():null},c._buildRandomValues=function(){if(!t._randValues){t._randValues=[];for(let i=0;i<a;i++)for(let s=0;s<a;s++)t._randValues.push(this._randomLCG.getFloat()),t._randValues.push(this._randomLCG.getFloat())}},c._calculateMinMax=function(t){let i,s,e,n,_,a,l,c,f,u,g,p,M,d;this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,l=c=M=g=Number.MAX_VALUE,f=u=d=p=-Number.MAX_VALUE;const m=1!==this._cosAngle;let X=0;for(const h of t.rings){const t=h?h.length:0;for(let r=0;r<t;r++)a=h[r][0],_=h[r][1],i=a-this._graphicOriginX-this._offsetX,s=_-this._graphicOriginY-this._offsetY,m?(e=this._cosAngle*i-this._sinAngle*s,n=this._sinAngle*i+this._cosAngle*s):(e=i,n=s),l=Math.min(l,e),f=Math.max(f,e),c=Math.min(c,n),u=Math.max(u,n),g=Math.min(g,_),p=Math.max(p,_),M=Math.min(M,a),d=Math.max(d,a),X++}g=g!==Number.MAX_VALUE?g:-h-this._stepY,p=p!==-Number.MAX_VALUE?p:this._stepY,M=M!==Number.MAX_VALUE?M:-this._stepX,d=d!==-Number.MAX_VALUE?d:h+this._stepX;const A=p-g,Y=d-M;if(this._verticalSubdivision=A>=Y,this._polygonMin=this._verticalSubdivision?g:M,this._testInsidePolygon){let t=0-this._graphicOriginX-this._offsetX-this._stepX,i=h-this._graphicOriginX-this._offsetX+this._stepX,s=-h-this._graphicOriginY-this._offsetY-this._stepY,e=0-this._graphicOriginY-this._offsetY+this._stepY;if(m){const n=[[t,s],[t,e],[i,s],[i,e]];t=s=Number.MAX_VALUE,i=e=-Number.MAX_VALUE;for(const h of n){const n=this._cosAngle*h[0]-this._sinAngle*h[1],_=this._sinAngle*h[0]+this._cosAngle*h[1];t=Math.min(t,n),i=Math.max(i,n),s=Math.min(s,_),e=Math.max(e,_)}}l=l!==Number.MAX_VALUE?Math.max(l,t):t,c=c!==Number.MAX_VALUE?Math.max(c,s):s,f=f!==-Number.MAX_VALUE?Math.min(f,i):i,u=u!==-Number.MAX_VALUE?Math.min(u,e):e}this._xMin=Math.round(l/this._stepX),this._xMax=Math.round(f/this._stepX),this._yMin=Math.round(c/this._stepY),this._yMax=Math.round(u/this._stepY),this._currentX=this._xMax+1,this._currentY=this._yMin-1,this._testInsidePolygon&&X>r&&(A>o||Y>o)&&this._buildAccelerationMap(t,M,d,g,p)},c._buildAccelerationMap=function(t,i,s,e,n){const{rings:r}=t,o=new Map,a=this._verticalSubdivision,l=a?n-e:s-i;let c=Math.ceil(l/_);if(c<=1)return;const f=Math.floor(l/c);let u,p,M,d,m,X,A,Y,x,y;c++,this._delta=f,a?(Y=-h-this._stepY,x=this._stepY,y=e):(Y=-this._stepX,x=h+this._stepX,y=i);for(let h=0;h<r.length;h++)if(u=r[h],!(u.length<2))for(let t=1;t<u.length;t++){if(p=u[t-1],M=u[t],a){if(p[1]===M[1]||p[1]<Y&&M[1]<Y||p[1]>x&&M[1]>x)continue;d=Math.min(p[1],M[1]),m=Math.max(p[1],M[1])}else{if(p[0]===M[0]||p[0]<Y&&M[0]<Y||p[0]>x&&M[0]>x)continue;d=Math.min(p[0],M[0]),m=Math.max(p[0],M[0])}for(;d<m;)X=Math.floor((d-y)/f),g(X,h,t,o),d+=f;A=Math.floor((m-y)/f),A>X&&g(A,h,t,o)}this._accelerationMap=o},c._nextInside=function(){for(;;){if(this._currentX>this._xMax){if(this._currentY++,this._currentY>this._yMax)return null;this._currentX=this._xMin,this._shiftOddRows&&this._currentY%2&&this._currentX--}let i=this._currentX*this._stepX+this._offsetX;this._shiftOddRows&&this._currentY%2&&(i+=.5*this._stepX);const s=this._currentY*this._stepY+this._offsetY;let e,h;if(this._currentX++,this._gridType===n.PlacementGridType.Random){const n=(this._currentX%a+a)%a,_=(this._currentY%a+a)%a;e=this._graphicOriginX+i+this._stepX*this._randomness*(.5-t._randValues[_*a+n])*2/3,h=this._graphicOriginY+s+this._stepY*this._randomness*(.5-t._randValues[_*a+n+1])*2/3}else e=this._graphicOriginX+this._cosAngle*i+this._sinAngle*s,h=this._graphicOriginY-this._sinAngle*i+this._cosAngle*s;if(!this._testInsidePolygon||this._isInsidePolygon(e,h,this._geometry))return this._internalPlacement.setTranslate(e,h),this._internalPlacement}},c._isInsidePolygon=function(t,s,e){const{rings:n}=e;if(i.isNone(this._accelerationMap))return u(t,s,e);const h=this._verticalSubdivision,_=h?s:t,r=Math.floor((_-this._polygonMin)/this._delta),o=this._accelerationMap.get(r);if(!o)return!1;let a,l,c,f,g,p=0;for(const i of o){g=i[0];const e=n[g];if(f=i[1],a=e[f-1],l=e[f],h){if(a[1]>s==l[1]>s)continue;c=(l[0]-a[0])*(s-a[1])-(l[1]-a[1])*(t-a[0])}else{if(a[0]>t==l[0]>t)continue;c=(l[1]-a[1])*(t-a[0])-(l[0]-a[0])*(s-a[1])}c>0?p++:p--}return 0!==p},t}();function u(t,i,s){const{rings:e}=s;let n,h,_,r=0;for(const o of e){n=o.length;for(let s=1;s<n;++s){if(h=o[s-1],_=o[s],h[1]>i==_[1]>i)continue;(_[0]-h[0])*(i-h[1])-(_[1]-h[1])*(t-h[0])>0?r++:r--}}return 0!==r}function g(t,i,s,e){let n=e.get(t);n||(n=[],e.set(t,n)),n.push([i,s])}t.PlacementInsidePolygon=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
