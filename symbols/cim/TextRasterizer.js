/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../core/screenUtils"],(function(t,e){"use strict";function i(t){return`rgb(${t.slice(0,3).toString()})`}function n(t){return`rgba(${t.slice(0,3).toString()},${t[3]})`}let s=function(){function t(){}var s=t.prototype;return s.rasterizeText=function(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const s=this._textRasterizationCanvas,r=s.getContext("2d");this._setFontProperties(r,e),this.parameters=e,this.textLines=t.split(/\r?\n/),this.lineHeight=this._computeLineHeight();const h=this._computeTextWidth(r,e),{decoration:a,weight:l}=e.font;this.lineThroughWidthOffset=a&&"line-through"===a?.1*this.lineHeight:0;const d=this.lineHeight*this.textLines.length;s.width=h+2*this.lineThroughWidthOffset,s.height=d,this.renderedLineHeight=Math.round(this.lineHeight*e.pixelRatio),this.renderedHaloSize=e.halo.size*e.pixelRatio,this.renderedWidth=h*e.pixelRatio,this.renderedHeight=d*e.pixelRatio,this.lineThroughWidthOffset*=e.pixelRatio,this.fillStyle=n(e.color),this.haloStyle=i(e.halo.color);const c=this.renderedLineHeight,f=this.renderedHaloSize;this._setFontProperties(r,e);const g=o(r.textAlign,this.renderedWidth)+f,u=f,p=f>0;let x=this.lineThroughWidthOffset,m=0;p&&this._renderHalo(r,g,u,x,m,e),m+=u,x+=g;for(const i of this.textLines)r.globalCompositeOperation="destination-out",r.fillStyle="rgb(0, 0, 0)",r.fillText(i,x,m),r.globalCompositeOperation="source-over",r.fillStyle=this.fillStyle,r.fillText(i,x,m),a&&"none"!==a&&this._renderDecoration(r,x,m,a,l),m+=c;const _=this.renderedWidth+2*this.lineThroughWidthOffset,H=this.renderedHeight,z=r.getImageData(0,0,_,H),b=new Uint8Array(z.data);if(e.premultiplyColors){let t;for(let e=0;e<b.length;e+=4)t=b[e+3]/255,b[e]=b[e]*t,b[e+1]=b[e+1]*t,b[e+2]=b[e+2]*t}return{size:[_,H],image:new Uint32Array(b.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}},s._renderHalo=function(t,e,i,n,s,o){const r=this.renderedWidth,h=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=r,this._haloRasterizationCanvas.height=h;const a=this._haloRasterizationCanvas,l=a.getContext("2d");l.clearRect(0,0,r,h),this._setFontProperties(l,o);const{decoration:d,weight:c}=o.font;l.fillStyle=this.haloStyle,l.strokeStyle=this.haloStyle;const f=this.renderedHaloSize<3;l.lineJoin=f?"miter":"round",f?this._renderHaloEmulated(l,e,i,d,c):this._renderHaloNative(l,e,i,d,c),t.globalAlpha=this.parameters.halo.color[3],t.drawImage(a,0,0,r,h,n,s,r,h),t.globalAlpha=1},s._renderHaloEmulated=function(t,e,i,n,s){const o=this.renderedLineHeight,h=this.renderedHaloSize;for(const a of this.textLines){for(const[n,s]of r)t.fillText(a,e+h*n,i+h*s);n&&"none"!==n&&this._renderDecoration(t,e,i,n,s),i+=o}},s._renderHaloNative=function(t,e,i,n,s){const o=this.renderedLineHeight,r=this.renderedHaloSize;for(const h of this.textLines){const a=2*r,l=5,d=.1;for(let o=0;o<l;o++){const r=1-(l-1)*d+o*d;t.lineWidth=r*a,t.strokeText(h,e,i),n&&"none"!==n&&this._renderDecoration(t,e,i,n,s)}i+=o}},s._setFontProperties=function(t,i){const n=i.font,s=`${n.style} ${n.weight} ${e.pt2px(i.size*i.pixelRatio)}px ${n.family}, sans-serif`;let o;switch(t.font=s,t.textBaseline="top",i.horizontalAlignment){case"left":default:o="left";break;case"right":o="right";break;case"center":o="center"}t.textAlign=o},s.computeTextSize=function(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const i=this._textRasterizationCanvas,n=i.getContext("2d");this._setFontProperties(n,e),this.parameters=e,this.textLines=t.split(/\r?\n/),this.lineHeight=this._computeLineHeight();const s=this._computeTextWidth(n,e),o=this.lineHeight*this.textLines.length;return i.width=s,i.height=o,[s*e.pixelRatio,o*e.pixelRatio]},s._computeTextWidth=function(t,e){let i=0;for(const s of this.textLines)i=Math.max(i,t.measureText(s).width);const n=e.font;return("italic"===n.style||"oblique"===n.style||"string"==typeof n.weight&&("bold"===n.weight||"bolder"===n.weight)||"number"==typeof n.weight&&n.weight>600)&&(i+=.3*t.measureText("w").width),i+=2*this.parameters.halo.size,Math.round(i)},s._computeLineHeight=function(){let t=1.275*this.parameters.size;const e=this.parameters.font.decoration;return e&&"underline"===e&&(t*=1.3),Math.round(t+2*this.parameters.halo.size)},s._renderDecoration=function(t,e,i,n,s){const o=.9*this.lineHeight,r="bold"===s?.06:"bolder"===s?.09:.04;switch(t.textAlign){case"center":e-=this.renderedWidth/2;break;case"right":e-=this.renderedWidth}const h=t.textBaseline;if("underline"===n)switch(h){case"top":i+=o;break;case"middle":i+=o/2}else if("line-through"===n)switch(h){case"top":i+=o/1.5;break;case"middle":i+=o/3}t.save(),t.beginPath(),t.strokeStyle=t.fillStyle,t.lineWidth=Math.ceil(o*r),t.moveTo(e-this.lineThroughWidthOffset,i),t.lineTo(e+this.renderedWidth+2*this.lineThroughWidthOffset,i),t.stroke(),t.restore()},t}();function o(t,e){return"center"===t?.5*e:"right"===t?e:0}const r=[];{const t=16;for(let e=0;e<360;e+=360/t)r.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}t.TextRasterizer=s,t.default=s,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
