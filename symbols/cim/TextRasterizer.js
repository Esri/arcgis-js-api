/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
define(["../../core/screenUtils"],(function(t){"use strict";function e(t){return`rgb(${t.slice(0,3).toString()})`}function i(t){return`rgba(${t.slice(0,3).toString()},${t[3]})`}function n(t,e){return"center"===t?.5*e:"right"===t?e:0}return function(){function s(t){t&&(this._textRasterizationCanvas=t)}var o=s.prototype;return o.rasterizeText=function(t,s){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const o=this._textRasterizationCanvas,r=o.getContext("2d");this._setFontProperties(r,s),this._parameters=s,this._textLines=t.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const h=this._computeTextWidth(r,s),{decoration:a,weight:l}=s.font;this._lineThroughWidthOffset=a&&"line-through"===a?.1*this._lineHeight:0;const c=this._lineHeight*this._textLines.length;o.width=h+2*this._lineThroughWidthOffset,o.height=c,this._renderedLineHeight=Math.round(this._lineHeight*s.pixelRatio),this._renderedHaloSize=s.halo.size*s.pixelRatio,this._renderedWidth=h*s.pixelRatio,this._renderedHeight=c*s.pixelRatio,this._lineThroughWidthOffset*=s.pixelRatio;const d=s.color??[0,0,0,0],_=s.halo&&s.halo.color?s.halo.color:[0,0,0,0];this._fillStyle=i(d),this._haloStyle=e(_);const f=this._renderedLineHeight,g=this._renderedHaloSize;r.save(),r.clearRect(0,0,o.width,o.height),this._setFontProperties(r,s);const u=n(r.textAlign,this._renderedWidth)+g,p=g,x=g>0;let m=this._lineThroughWidthOffset,b=0;x&&this._renderHalo(r,u,p,m,b,s),b+=p,m+=u;for(const e of this._textLines)x?(r.globalCompositeOperation="destination-out",r.fillStyle="rgb(0, 0, 0)",r.fillText(e,m,b),r.globalCompositeOperation="source-over",r.fillStyle=this._fillStyle,r.fillText(e,m,b)):(r.fillStyle=this._fillStyle,r.fillText(e,m,b)),a&&"none"!==a&&this._renderDecoration(r,m,b,a,l),b+=f;r.restore();const z=this._renderedWidth+2*this._lineThroughWidthOffset,v=this._renderedHeight,w=r.getImageData(0,0,z,v),y=new Uint8Array(w.data);if(s.premultiplyColors){let t;for(let e=0;e<y.length;e+=4)t=y[e+3]/255,y[e]=y[e]*t,y[e+1]=y[e+1]*t,y[e+2]=y[e+2]*t}let H,R;switch(s.horizontalAlignment){case"left":H=-.5;break;case"right":H=.5;break;default:H=0}switch(s.verticalAlignment){case"bottom":R=-.5;break;case"top":R=.5;break;default:R=0}return{size:[z,v],image:new Uint32Array(y.buffer),sdf:!1,simplePattern:!1,anchorX:H,anchorY:R,canvas:o}},o._renderHalo=function(t,e,i,n,s,o){const r=this._renderedWidth,h=this._renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=r,this._haloRasterizationCanvas.height=h;const a=this._haloRasterizationCanvas,l=a.getContext("2d");l.clearRect(0,0,r,h),this._setFontProperties(l,o);const{decoration:c,weight:d}=o.font;l.fillStyle=this._haloStyle,l.strokeStyle=this._haloStyle,l.lineJoin="round",this._renderHaloNative(l,e,i,c,d),t.globalAlpha=this._parameters.halo.color[3],t.drawImage(a,0,0,r,h,n,s,r,h),t.globalAlpha=1},o._renderHaloNative=function(t,e,i,n,s){const o=this._renderedLineHeight,r=this._renderedHaloSize;for(const h of this._textLines){const a=2*r,l=5,c=.1;for(let o=0;o<l;o++){const r=(1-(l-1)*c+o*c)*a;t.lineWidth=r,t.strokeText(h,e,i),n&&"none"!==n&&this._renderDecoration(t,e,i,n,s,r)}i+=o}},o._setFontProperties=function(e,i){const n=Math.max(i.size,.5),s=i.font,o=`${s.style} ${s.weight} ${t.pt2px(n*i.pixelRatio).toFixed(1)}px ${s.family}, sans-serif`;let r;switch(e.font=o,e.textBaseline="top",i.horizontalAlignment){case"left":default:r="left";break;case"right":r="right";break;case"center":r="center"}e.textAlign=r},o.computeTextSize=function(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const i=this._textRasterizationCanvas,n=i.getContext("2d");this._setFontProperties(n,e),this._parameters=e,this._textLines=t.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const s=this._computeTextWidth(n,e),o=this._lineHeight*this._textLines.length;return i.width=s,i.height=o,[s*e.pixelRatio,o*e.pixelRatio]},o._computeTextWidth=function(t,e){let i=0;for(const s of this._textLines)i=Math.max(i,t.measureText(s).width);const n=e.font;return("italic"===n.style||"oblique"===n.style||"string"==typeof n.weight&&("bold"===n.weight||"bolder"===n.weight)||"number"==typeof n.weight&&n.weight>600)&&(i+=.3*t.measureText("w").width),i+=2*this._parameters.halo.size,Math.round(i)},o._computeLineHeight=function(){let t=1.275*this._parameters.size;const e=this._parameters.font.decoration;return e&&"underline"===e&&(t*=1.3),Math.round(t+2*this._parameters.halo.size)},o._renderDecoration=function(t,e,i,n,s,o){const r=.9*this._lineHeight,h="bold"===s?.06:"bolder"===s?.09:.04;switch(t.textAlign){case"center":e-=this._renderedWidth/2;break;case"right":e-=this._renderedWidth}const a=t.textBaseline;if("underline"===n)switch(a){case"top":i+=r;break;case"middle":i+=r/2}else if("line-through"===n)switch(a){case"top":i+=r/1.5;break;case"middle":i+=r/3}const l=o?1.5*o:Math.ceil(r*h);t.save(),t.beginPath(),t.strokeStyle=t.fillStyle,t.lineWidth=l,t.moveTo(e-this._lineThroughWidthOffset,i),t.lineTo(e+this._renderedWidth+2*this._lineThroughWidthOffset,i),t.stroke(),t.restore()},s}()}));
