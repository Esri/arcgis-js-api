/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/Logger","../../geometry/support/boundsUtils","../../geometry/support/jsonUtils","../../geometry/support/aaBoundingRect","./CIMPlacements","./CIMEffects","./CIMOperators","./Rect"],(function(t,e,i,s,n,r,o,a,c,l){"use strict";const h=Math.PI/180,f=i.getLogger("esri.symbols.cim.CIMSymbolDrawHelper");let u=function(){function t(t){this._t=t}t.createIdentity=function(){return new t([1,0,0,0,1,0])};var e=t.prototype;return e.clone=function(){return new t(this._t.slice())},e.transform=function(t){const e=this._t;return[e[0]*t[0]+e[1]*t[1]+e[2],e[3]*t[0]+e[4]*t[1]+e[5]]},t.createScale=function(e,i){return new t([e,0,0,0,i,0])},e.scale=function(t,e){const i=this._t;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=e,i[4]*=e,i[5]*=e,this},e.scaleRatio=function(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])},t.createTranslate=function(e,i){return new t([0,0,e,0,0,i])},e.translate=function(t,e){const i=this._t;return i[2]+=t,i[5]+=e,this},t.createRotate=function(e){const i=Math.cos(e),s=Math.sin(e);return new t([i,-s,0,s,i,0])},e.rotate=function(e){return this.multiply(t.createRotate(e))},e.multiply=function(t){const e=this._t,i=t._t,s=e[0]*i[0]+e[3]*i[1],n=e[1]*i[0]+e[4]*i[1],r=e[2]*i[0]+e[5]*i[1]+i[2],o=e[0]*i[3]+e[3]*i[4],a=e[1]*i[3]+e[4]*i[4],c=e[2]*i[3]+e[5]*i[4]+i[5];return e[0]=s,e[1]=n,e[2]=r,e[3]=o,e[4]=a,e[5]=c,this},t}(),y=function(){function t(t){this._transfos=[],this._sizeTransfos=[],this._transfos.push(t||u.createIdentity()),this._sizeTransfos.push(t?t.scaleRatio():1)}var e=t.prototype;return e.transformPt=function(t){return this._transfos[this._transfos.length-1].transform(t)},e.transformSize=function(t){return t*this._sizeTransfos[this._sizeTransfos.length-1]},e.back=function(){return this._transfos[this._transfos.length-1]},e.push=function(t,e){const i=e?t.scaleRatio():1;t.multiply(this.back()),this._transfos.push(t),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*i)},e.pop=function(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)},e.drawSymbol=function(t,e){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(t,e)}},e.drawMultiLayerSymbol=function(t,e){if(!t)return;const i=t.symbolLayers;if(!i)return;const s=t.effects;if(s){const t=this.executeEffects(s,e);if(t){let e=t.next();for(;e;)this.drawSymbolLayers(i,e),e=t.next()}}else this.drawSymbolLayers(i,e)},e.executeEffects=function(t,e){let i=new a.SimpleGeometryCursor(e);for(const e of t){const t=c.getEffectOperator(e);t&&(i=t.execute(i,e,1))}return i},e.drawSymbolLayers=function(t,e){let i=t.length;for(;i--;){const s=t[i];if(!s||!1===s.enable)continue;const n=s.effects;if(n){const t=this.executeEffects(n,e);if(t){let e=t.next();for(;e;)this.drawSymbolLayer(s,e),e=t.next()}}else this.drawSymbolLayer(s,e)}},e.drawSymbolLayer=function(t,e){switch(t.type){case"CIMSolidFill":this.drawSolidFill(e,t.color);break;case"CIMHatchFill":this.drawHatchFill(t,e);break;case"CIMSolidStroke":this.drawSolidStroke(e,t.color,t.width,t.capStyle,t.joinStyle,t.miterLimit);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(t,e)}},e.drawHatchFill=function(t,e){const i=this._buildHatchPolyline(t,e,1);i&&(this.pushClipPath(e),this.drawMultiLayerSymbol(t.lineSymbol,i),this.popClipPath())},e.drawMarkerLayer=function(t,e){const i=t.markerPlacement;if(i){const s=c.getPlacementOperator(i);if(s){const n="CIMMarkerPlacementInsidePolygon"===i.type;n&&this.pushClipPath(e);const r=1,o=s.execute(e,i,r);if(o){let e=o.next();for(;e;)this.drawMarker(t,e),e=o.next()}n&&this.popClipPath()}}else{const i=new o.Placement;i.tx=e.x,i.ty=e.y,this.drawMarker(t,i)}},e.drawMarker=function(t,e){switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(t,e);break;case"CIMVectorMarker":this.drawVectorMarker(t,e)}},e.drawPictureMarker=function(t,e){},e.drawVectorMarker=function(t,e){if(!t)return;const i=t.markerGraphics;if(!i)return;const s=t.size,n=t.frame,r=n?n.ymax-n.ymin:0,o=s&&r?s/r:1,a=u.createIdentity();n&&a.translate(.5*-(n.xmax+n.xmin),.5*-(n.ymax+n.ymin));const c=t.anchorPoint;if(c){let e=c.x,i=c.y;"Absolute"!==t.anchorPointUnits&&n&&(e*=n.xmax-n.xmin,i*=n.ymax-n.ymin),a.translate(-e,-i)}1!==o&&a.scale(o,o),t.rotation&&a.rotate(t.rotation*h),a.translate(t.offsetX||0,t.offsetY||0),a.translate(e.tx,e.ty),this.push(a,t.scaleSymbolsProportionally);for(const t of i)t&&t.symbol&&t.geometry||f.error("Invalid marker graphic",t),this.drawSymbol(t.symbol,t.geometry);this.pop()},e._buildHatchPolyline=function(t,e,i){let n=(void 0!==t.separation?t.separation:4)*i,o=void 0!==t.rotation?t.rotation:0;if(0===n)return null;n<0&&(n=-n);let a=0;const c=.5*n;for(;a>c;)a-=n;for(;a<-c;)a+=n;const l=r.create();s.getBoundsXY(l,e),l[0]-=c,l[1]-=c,l[2]+=c,l[3]+=c;const f=[[l[0],l[1]],[l[0],l[3]],[l[2],l[3]],[l[2],l[1]]];for(;o>180;)o-=180;for(;o<0;)o+=180;const u=Math.cos(o*h),y=Math.sin(o*h),p=-n*y,m=n*u;let _,d,M,x;a=(void 0!==t.offsetX?t.offsetX*i:0)*y-(void 0!==t.offsetY?t.offsetY*i:0)*u,_=M=Number.MAX_VALUE,d=x=-Number.MAX_VALUE;for(const t of f){const e=t[0],i=t[1],s=u*e+y*i,n=-y*e+u*i;_=Math.min(_,s),M=Math.min(M,n),d=Math.max(d,s),x=Math.max(x,n)}M=Math.floor(M/n)*n;let P=u*_-y*M-p*a/n,b=y*_+u*M-m*a/n,w=u*d-y*M-p*a/n,S=y*d+u*M-m*a/n;const g=1+Math.round((x-M)/n),C=[];for(let t=0;t<g;t++)P+=p,b+=m,w+=p,S+=m,C.push([[P,b],[w,S]]);return{paths:C}},t}(),p=function(t){function i(){var e;return(e=t.call(this)||this).reset(),e}e._inheritsLoose(i,t);var s=i.prototype;return s.reset=function(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0,this._clipCount=0},s.envelope=function(){return new l(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)},s.drawSolidFill=function(t){!t||this._clipCount>0||(n.isPolygon(t)?this._processPath(t.rings,0):n.isPolyline(t)&&this._processPath(t.paths,0))},s.drawSolidStroke=function(t,e,i){if(!t||this._clipCount>0)return;const s=.5*this.transformSize(i);n.isPolygon(t)?this._processPath(t.rings,s):n.isPolyline(t)&&this._processPath(t.paths,s)},s.pushClipPath=function(t){this.drawSolidFill(t),++this._clipCount},s.popClipPath=function(){--this._clipCount},s._processPath=function(t,e){if(t)for(const i of t){const t=i?i.length:0;if(t>1){this._merge(this.transformPt(i[0]),e);for(let s=1;s<t;++s)this._merge(this.transformPt(i[s]),e)}}},s._merge=function(t,e){t[0]-e<this._xmin&&(this._xmin=t[0]-e),t[0]+e>this._xmax&&(this._xmax=t[0]+e),t[1]-e<this._ymin&&(this._ymin=t[1]-e),t[1]+e>this._ymax&&(this._ymax=t[1]+e)},i}(y),m=function(t){function i(e,i){var s;return(s=t.call(this,i)||this)._ctx=e,s}e._inheritsLoose(i,t);var s=i.prototype;return s.drawSolidFill=function(t,e){if(!t)return;if(n.isPolygon(t))this._buildPath(t.rings,!0);else{if(!n.isPolyline(t))return;this._buildPath(t.paths,!0)}const i=this._ctx;i.fillStyle="string"==typeof e?e:"rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+e[3]/255+")",i.fill("evenodd")},s.drawSolidStroke=function(t,e,i,s,r,o){if(!t||!e||0===i)return;if(n.isPolygon(t))this._buildPath(t.rings,!0);else{if(!n.isPolyline(t))return;this._buildPath(t.paths,!1)}const a=this._ctx;a.strokeStyle="string"==typeof e?e:"rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+e[3]/255+")",a.lineWidth=this.transformSize(i)+.5,this._setCapStyle(s),this._setJoinStyle(r),a.miterLimit=o,a.stroke()},s.pushClipPath=function(t){this._ctx.save(),n.isPolygon(t)?this._buildPath(t.rings,!0):n.isPolyline(t)&&this._buildPath(t.paths,!0),this._ctx.clip("evenodd")},s.popClipPath=function(){this._ctx.restore()},s._buildPath=function(t,e){const i=this._ctx;if(i.beginPath(),t)for(const s of t){const t=s?s.length:0;if(t>1){let n=this.transformPt(s[0]);i.moveTo(n[0],n[1]);for(let e=1;e<t;++e)n=this.transformPt(s[e]),i.lineTo(n[0],n[1]);e&&i.closePath()}}},s._setCapStyle=function(t){switch(t){case"Butt":this._ctx.lineCap="butt";break;case"Round":this._ctx.lineCap="round";break;case"Square":this._ctx.lineCap="square"}},s._setJoinStyle=function(t){switch(t){case"Bevel":this._ctx.lineJoin="bevel";break;case"Round":this._ctx.lineJoin="round";break;case"Miter":this._ctx.lineJoin="miter"}},i}(y);t.CIMSymbolDrawHelper=y,t.C_DEG_TO_RAD=h,t.CanvasDrawHelper=m,t.EnvDrawHelper=p,t.Transformation=u,Object.defineProperty(t,"__esModule",{value:!0})}));
