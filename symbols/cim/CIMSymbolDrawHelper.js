// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../core/Logger","../../geometry/support/aaBoundingRect","../../geometry/support/boundsUtils","../../geometry/support/jsonUtils","../cim/CIMEffects","../cim/CIMOperators","../cim/CIMPlacements","./Rect"],(function(t,r,e,i,o,a,s,n,h,l,c){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.CanvasDrawHelper=r.EnvDrawHelper=r.CIMSymbolDrawHelper=r.Transformation=r.C_DEG_TO_RAD=void 0,r.C_DEG_TO_RAD=Math.PI/180;var p=i.getLogger("esri.symbols.cim.CIMSymbolDrawHelper"),f=function(){function t(t){this._t=t}return t.createIdentity=function(){return new t([1,0,0,0,1,0])},t.prototype.clone=function(){return new t(this._t.slice())},t.prototype.transform=function(t){var r=this._t;return[r[0]*t[0]+r[1]*t[1]+r[2],r[3]*t[0]+r[4]*t[1]+r[5]]},t.createScale=function(r,e){return new t([r,0,0,0,e,0])},t.prototype.scale=function(t,r){var e=this._t;return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=r,e[4]*=r,e[5]*=r,this},t.prototype.scaleRatio=function(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])},t.createTranslate=function(r,e){return new t([0,0,r,0,0,e])},t.prototype.translate=function(t,r){var e=this._t;return e[2]+=t,e[5]+=r,this},t.createRotate=function(r){var e=Math.cos(r),i=Math.sin(r);return new t([e,-i,0,i,e,0])},t.prototype.rotate=function(r){return this.multiply(t.createRotate(r))},t.prototype.multiply=function(t){var r=this._t,e=t._t,i=r[0]*e[0]+r[3]*e[1],o=r[1]*e[0]+r[4]*e[1],a=r[2]*e[0]+r[5]*e[1]+e[2],s=r[0]*e[3]+r[3]*e[4],n=r[1]*e[3]+r[4]*e[4],h=r[2]*e[3]+r[5]*e[4]+e[5];return r[0]=i,r[1]=o,r[2]=a,r[3]=s,r[4]=n,r[5]=h,this},t}();r.Transformation=f;var u=function(){function t(t){this._transfos=[],this._sizeTransfos=[],this._transfos.push(t||f.createIdentity()),this._sizeTransfos.push(t?t.scaleRatio():1)}return t.prototype.transformPt=function(t){return this._transfos[this._transfos.length-1].transform(t)},t.prototype.transformSize=function(t){return t*this._sizeTransfos[this._sizeTransfos.length-1]},t.prototype.back=function(){return this._transfos[this._transfos.length-1]},t.prototype.push=function(t,r){var e=r?t.scaleRatio():1;t.multiply(this.back()),this._transfos.push(t),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*e)},t.prototype.pop=function(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)},t.prototype.drawSymbol=function(t,r){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(t,r)}},t.prototype.drawMultiLayerSymbol=function(t,r){if(t){var e=t.symbolLayers;if(e){var i=t.effects;if(i){var o=this.executeEffects(i,r);if(o)for(var a=o.next();a;)this.drawSymbolLayers(e,a),a=o.next()}else this.drawSymbolLayers(e,r)}}},t.prototype.executeEffects=function(t,r){for(var e=new n.SimpleGeometryCursor(r),i=0,o=t;i<o.length;i++){var a=o[i],s=h.getEffectOperator(a);s&&(e=s.execute(e,a,1))}return e},t.prototype.drawSymbolLayers=function(t,r){for(var e=t.length;e--;){var i=t[e];if(i&&!1!==i.enable){var o=i.effects;if(o){var a=this.executeEffects(o,r);if(a)for(var s=a.next();s;)this.drawSymbolLayer(i,s),s=a.next()}else this.drawSymbolLayer(i,r)}}},t.prototype.drawSymbolLayer=function(t,r){switch(t.type){case"CIMSolidFill":this.drawSolidFill(r,t.color);break;case"CIMHatchFill":this.drawHatchFill(t,r);break;case"CIMSolidStroke":this.drawSolidStroke(r,t.color,t.width,t.capStyle,t.joinStyle,t.miterLimit);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(t,r)}},t.prototype.drawHatchFill=function(t,r){var e=this._buildHatchPolyline(t,r,1);e&&(this.pushClipPath(r),this.drawMultiLayerSymbol(t.lineSymbol,e),this.popClipPath())},t.prototype.drawMarkerLayer=function(t,r){var e=t.markerPlacement;if(e){var i=h.getPlacementOperator(e);if(i){var o="CIMMarkerPlacementInsidePolygon"===e.type;o&&this.pushClipPath(r);var a=i.execute(r,e,1);if(a)for(var s=a.next();s;)this.drawMarker(t,s),s=a.next();o&&this.popClipPath()}}else{var n=new l.Placement;n.tx=r.x,n.ty=r.y,this.drawMarker(t,n)}},t.prototype.drawMarker=function(t,r){switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(t,r);break;case"CIMVectorMarker":this.drawVectorMarker(t,r)}},t.prototype.drawPictureMarker=function(t,r){},t.prototype.drawVectorMarker=function(t,e){if(t){var i=t.markerGraphics;if(i){var o=t.size,a=t.frame,s=a?a.ymax-a.ymin:0,n=o&&s?o/s:1,h=f.createIdentity();a&&h.translate(.5*-(a.xmax+a.xmin),.5*-(a.ymax+a.ymin));var l=t.anchorPoint;if(l){var c=l.x,u=l.y;"Absolute"!==t.anchorPointUnits&&a&&(c*=a.xmax-a.xmin,u*=a.ymax-a.ymin),h.translate(-c,-u)}1!==n&&h.scale(n,n),t.rotation&&h.rotate(t.rotation*r.C_DEG_TO_RAD),h.translate(t.offsetX||0,t.offsetY||0),h.translate(e.tx,e.ty),this.push(h,t.scaleSymbolsProportionally);for(var y=0,_=i;y<_.length;y++){var m=_[y];m&&m.symbol&&m.geometry||p.error("Invalid marker graphic",m),this.drawSymbol(m.symbol,m.geometry)}this.pop()}}},t.prototype._buildHatchPolyline=function(t,e,i){var s=(void 0!==t.separation?t.separation:4)*i,n=void 0!==t.rotation?t.rotation:0;if(0===s)return null;s<0&&(s=-s);for(var h=0,l=.5*s;h>l;)h-=s;for(;h<-l;)h+=s;var c=o.create();a.getBoundsXY(c,e),c[0]-=l,c[1]-=l,c[2]+=l,c[3]+=l;for(var p=[[c[0],c[1]],[c[0],c[3]],[c[2],c[3]],[c[2],c[1]]];n>180;)n-=180;for(;n<0;)n+=180;var f,u,y,_,m=Math.cos(n*r.C_DEG_TO_RAD),d=Math.sin(n*r.C_DEG_TO_RAD),v=-s*d,M=s*m;h=(void 0!==t.offsetX?t.offsetX*i:0)*d-(void 0!==t.offsetY?t.offsetY*i:0)*m,f=y=Number.MAX_VALUE,u=_=-Number.MAX_VALUE;for(var x=0,P=p;x<P.length;x++){var b=P[x],w=b[0],g=b[1],C=m*w+d*g,S=-d*w+m*g;f=Math.min(f,C),y=Math.min(y,S),u=Math.max(u,C),_=Math.max(_,S)}for(var k=m*f-d*(y=Math.floor(y/s)*s)-v*h/s,I=d*f+m*y-M*h/s,L=m*u-d*y-v*h/s,T=d*u+m*y-M*h/s,D=1+Math.round((_-y)/s),E=[],R=0;R<D;R++)k+=v,I+=M,L+=v,T+=M,E.push([[k,I],[L,T]]);return{paths:E}},t}();r.CIMSymbolDrawHelper=u;var y=function(t){function r(){var r=t.call(this)||this;return r.reset(),r}return e.__extends(r,t),r.prototype.reset=function(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0,this._clipCount=0},r.prototype.envelope=function(){return new c.default(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)},r.prototype.drawSolidFill=function(t){!t||this._clipCount>0||(s.isPolygon(t)?this._processPath(t.rings,0):s.isPolyline(t)&&this._processPath(t.paths,0))},r.prototype.drawSolidStroke=function(t,r,e){if(t&&!(this._clipCount>0)){var i=.5*this.transformSize(e);s.isPolygon(t)?this._processPath(t.rings,i):s.isPolyline(t)&&this._processPath(t.paths,i)}},r.prototype.pushClipPath=function(t){this.drawSolidFill(t),++this._clipCount},r.prototype.popClipPath=function(){--this._clipCount},r.prototype._processPath=function(t,r){if(t)for(var e=0,i=t;e<i.length;e++){var o=i[e],a=o?o.length:0;if(a>1){this._merge(this.transformPt(o[0]),r);for(var s=1;s<a;++s)this._merge(this.transformPt(o[s]),r)}}},r.prototype._merge=function(t,r){t[0]-r<this._xmin&&(this._xmin=t[0]-r),t[0]+r>this._xmax&&(this._xmax=t[0]+r),t[1]-r<this._ymin&&(this._ymin=t[1]-r),t[1]+r>this._ymax&&(this._ymax=t[1]+r)},r}(u);r.EnvDrawHelper=y;var _=function(t){function r(r,e){var i=t.call(this,e)||this;return i._ctx=r,i}return e.__extends(r,t),r.prototype.drawSolidFill=function(t,r){if(t){if(s.isPolygon(t))this._buildPath(t.rings,!0);else{if(!s.isPolyline(t))return;this._buildPath(t.paths,!0)}var e=this._ctx;e.fillStyle="string"==typeof r?r:"rgba("+Math.round(r[0])+","+Math.round(r[1])+","+Math.round(r[2])+","+r[3]/255+")",e.fill("evenodd")}},r.prototype.drawSolidStroke=function(t,r,e,i,o,a){if(t&&r&&0!==e){if(s.isPolygon(t))this._buildPath(t.rings,!0);else{if(!s.isPolyline(t))return;this._buildPath(t.paths,!1)}var n=this._ctx;n.strokeStyle="string"==typeof r?r:"rgba("+Math.round(r[0])+","+Math.round(r[1])+","+Math.round(r[2])+","+r[3]/255+")",n.lineWidth=this.transformSize(e)+.5,this._setCapStyle(i),this._setJoinStyle(o),n.miterLimit=a,n.stroke()}},r.prototype.pushClipPath=function(t){this._ctx.save(),s.isPolygon(t)?this._buildPath(t.rings,!0):s.isPolyline(t)&&this._buildPath(t.paths,!0),this._ctx.clip("evenodd")},r.prototype.popClipPath=function(){this._ctx.restore()},r.prototype._buildPath=function(t,r){var e=this._ctx;if(e.beginPath(),t)for(var i=0,o=t;i<o.length;i++){var a=o[i],s=a?a.length:0;if(s>1){var n=this.transformPt(a[0]);e.moveTo(n[0],n[1]);for(var h=1;h<s;++h)n=this.transformPt(a[h]),e.lineTo(n[0],n[1]);r&&e.closePath()}}},r.prototype._setCapStyle=function(t){switch(t){case"Butt":this._ctx.lineCap="butt";break;case"Round":this._ctx.lineCap="round";break;case"Square":this._ctx.lineCap="square"}},r.prototype._setJoinStyle=function(t){switch(t){case"Bevel":this._ctx.lineJoin="bevel";break;case"Round":this._ctx.lineJoin="round";break;case"Miter":this._ctx.lineJoin="miter"}},r}(u);r.CanvasDrawHelper=_}));