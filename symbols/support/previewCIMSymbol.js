/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/screenUtils","../cim/CIMSymbolHelper","../cim/CIMSymbolRasterizer","../cim/utils","./previewUtils","./renderUtils"],(function(e,t,i,l,n,o,r,s){"use strict";const y=new n.CIMSymbolRasterizer(null,!0),a=i.px2pt(r.SymbolSizeDefaults.size),u=i.px2pt(r.SymbolSizeDefaults.maxSize),c=i.px2pt(r.SymbolSizeDefaults.lineWidth),h=1;function m(e){const t=e?.size;if("number"==typeof t)return{width:t,height:t};return{width:null!=t&&"object"==typeof t&&"width"in t?t.width:null,height:null!=t&&"object"==typeof t&&"height"in t?t.height:null}}function p(e){return d.apply(this,arguments)}function d(){return(d=t._asyncToGenerator((function*(e,t={}){const{node:r,opacity:p,symbolConfig:d}=t,f="object"==typeof d&&"isSquareFill"in d&&d.isSquareFill,g=t.cimOptions||t,b=g.geometryType||o.mapCIMSymbolToGeometryType(e?.data?.symbol),S=m(t),{feature:w,fieldMap:M}=g;if(null==S.width||null==S.height){const t=yield l.OverrideHelper.resolveSymbolOverrides(e.data,w,null,M,b);if(!t)return null;(e=e.clone()).data={type:"CIMSymbolReference",symbol:t},e.data.primitiveOverrides=void 0;const i=[];l.CIMSymbolHelper.fetchResources(t,y.resourceManager,i),i.length>0&&(yield Promise.all(i));const n=l.CIMSymbolHelper.getEnvelope(t,null,y.resourceManager),o=n?.width,r=n?.height;S.width="esriGeometryPolygon"===b?a:"esriGeometryPolyline"===b?c:null!=o&&isFinite(o)?Math.min(o,u):a,S.height="esriGeometryPolygon"===b?a:null!=r&&isFinite(r)?Math.max(Math.min(r,u),h):a}const v=yield y.rasterizeCIMSymbolAsync(e,w,S,f||"esriGeometryPolygon"!==b?n.GeometryStyle.Preview:n.GeometryStyle.Legend,M,b);if(!v)return null;const{width:C,height:I}=v,x=document.createElement("canvas");x.width=C,x.height=I;x.getContext("2d").putImageData(v,0,0);const z=i.pt2px(S.width),G=i.pt2px(S.height),P=new Image(z,G);P.src=x.toDataURL(),null!=p&&(P.style.opacity=`${p}`);let D=P;if(null!=t.effectView){const e={shape:{type:"image",x:0,y:0,width:z,height:G,src:P.src},fill:null,stroke:null,offset:[0,0]};D=s.renderSymbol([[e]],[z,G],{effectView:t.effectView})}return r&&D&&r.appendChild(D),D}))).apply(this,arguments)}e.previewCIMSymbol=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
