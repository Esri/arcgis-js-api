/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../core/Error","../../core/screenUtils","./gfxUtils","./previewUtils","./renderUtils"],(function(e,t,l,a,n,o,i){"use strict";const s="picture-fill",u="picture-marker",c="simple-fill",r="simple-line",m="simple-marker",p="text",h="Aa",d=o.SymbolSizeDefaults.size,f=o.SymbolSizeDefaults.maxSize,v=o.SymbolSizeDefaults.maxOutlineSize,y=o.SymbolSizeDefaults.lineWidth,g=document.createElement("canvas");function b(e,t){const l=g.getContext("2d"),a=[];return t&&(t.weight&&a.push(t.weight),t.size&&a.push(t.size+"px"),t.family&&a.push(t.family)),l.font=a.join(" "),l.measureText(e).width}const w=7.2/2.54,x=72/2.54;function M(e){if(0===e.length)return 0;if(e.length>2){const t=a.px2pt(1),l=parseFloat(e);switch(e.slice(-2)){case"px":return l;case"pt":return l*t;case"in":return 72*l*t;case"pc":return 12*l*t;case"mm":return l*w*t;case"cm":return l*x*t}}return parseFloat(e)}function z(e){const t=null==e?void 0:e.size;return{width:null!=t&&"object"==typeof t&&"width"in t?a.pt2px(t.width):null,height:null!=t&&"object"==typeof t&&"height"in t?a.pt2px(t.height):null}}function S(e,g){var w,x;const S="number"==typeof(null==g?void 0:g.size)?null==g?void 0:g.size:null,k=null!=S?a.pt2px(S):null,L=null!=(null==g?void 0:g.maxSize)?a.pt2px(g.maxSize):null,C=null!=(null==g?void 0:g.opacity)?g.opacity:null,j=null!=(null==g?void 0:g.rotation)?g.rotation:"angle"in e?e.angle:null,D=n.getFill(e);let F=n.getStroke(e);if(D&&!F){const e="type"in D?null:new t(D);"#ffffff"===(e?e.toHex():null)&&(F={color:"#bdc3c7",width:.75})}const P={shape:null,fill:null,stroke:F,offset:[0,0]};null!=(w=F)&&w.width&&(F.width=Math.min(F.width,v));const U=(null==(x=F)?void 0:x.width)||0;let E=null!=(null==g?void 0:g.size)&&(null==(null==g?void 0:g.scale)||(null==g?void 0:g.scale)),Z=0,q=0,T=!1;switch(e.type){case m:{const t=e.style,l=Math.min(null!=k?k:a.pt2px(e.size),L||f);switch(Z=l,q=l,t){case"circle":P.shape={type:"circle",cx:0,cy:0,r:.5*l},E||(Z+=U,q+=U);break;case"cross":P.shape={type:"path",path:[{command:"M",values:[0,.5*q]},{command:"L",values:[Z,.5*q]},{command:"M",values:[.5*Z,0]},{command:"L",values:[.5*Z,q]}]};break;case"diamond":P.shape={type:"path",path:[{command:"M",values:[0,.5*q]},{command:"L",values:[.5*Z,0]},{command:"L",values:[Z,.5*q]},{command:"L",values:[.5*Z,q]},{command:"Z",values:[]}]},E||(Z+=U,q+=U);break;case"square":P.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[Z,0]},{command:"L",values:[Z,q]},{command:"L",values:[0,q]},{command:"Z",values:[]}]},E||(Z+=U,q+=U),j&&(T=!0);break;case"triangle":P.shape={type:"path",path:[{command:"M",values:[.5*Z,0]},{command:"L",values:[Z,q]},{command:"L",values:[0,q]},{command:"Z",values:[]}]},E||(Z+=U,q+=U),j&&(T=!0);break;case"x":P.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[Z,q]},{command:"M",values:[Z,0]},{command:"L",values:[0,q]}]},j&&(T=!0);break;case"path":P.shape={type:"path",path:e.path||""},E||(Z+=U,q+=U),j&&(T=!0),E=!0}break}case r:{var B;const{width:e,height:t}=z(g),l=null!=t?t:Math.min(null!=k?k:U,L||v),a=null!=e?e:y;F.width=l,Z=a,q=l;const n=(null==P||null==(B=P.stroke)?void 0:B.cap)||"butt",o="round"===n;E=!0,P.stroke.cap="butt"===n?"square":n,P.shape={type:"path",path:[{command:"M",values:[o?l/2:0,q/2]},{command:"L",values:[o?Z-l/2:Z,q/2]}]};break}case s:case c:{const e="object"==typeof(null==g?void 0:g.symbolConfig)&&(null==g?void 0:g.symbolConfig.isSquareFill),{width:t,height:l}=z(g);Z=e&&null!=t?t:null!=k?k:d,q=e&&null!=l?l:Z,E||(Z+=U,q+=U),E=!0,P.shape=e?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[Z,0]},{command:"L",values:[Z,q]},{command:"L",values:[0,q]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:o.shapes.fill[0];break}case u:{let t=a.pt2px(e.width),l=a.pt2px(e.height);const n=null!=k?k:Math.max(t,l),o=t/l;t=o<=1?Math.ceil(n*o):n,l=o<=1?n:Math.ceil(n/o),Z=Math.min(t,L||f),q=Math.min(l,L||f),P.shape={type:"image",x:-Math.round(Z/2),y:-Math.round(q/2),width:Z,height:q,src:e.url||""},j&&(T=!0);break}case p:{const t=e,l=t.text||h,n=t.font,o=Math.min(null!=k?k:a.pt2px(n.size),L||f),i=b(l,{weight:n.weight,size:o,family:n.family}),s=/[\uE600-\uE6FF]/.test(l);Z=s?o:i,q=o;let u=.25*M((n?o:0).toString());s&&(u+=5),P.shape={type:"text",text:l,x:0,y:u,align:"middle",decoration:n&&n.decoration,rotated:t.rotated,kerning:t.kerning},P.font=n&&{size:o,style:n.style,decoration:n.decoration,weight:n.weight,family:n.family};break}}if(!P.shape)return Promise.reject(new l("symbolPreview: renderPreviewHTML2D","symbol not supported."));const H=D,O=e.color;let V=null;return H&&"pattern"===H.type&&O&&e.type!==s?V=n.getPatternUrlWithColor(H.src,O.toCss(!0)).then((e=>(H.src=e,P.fill=H,P))):(P.fill=D,V=Promise.resolve(P)),V.then((e=>{const t=[[e]];if("object"==typeof(null==g?void 0:g.symbolConfig)&&null!=g&&g.symbolConfig.applyColorModulation){const l=.6*Z;t.unshift([{...e,offset:[-l,0],fill:o.adjustColorBrightness(D,-.3)}]),t.push([{...e,offset:[l,0],fill:o.adjustColorBrightness(D,.3)}]),Z+=2*l,E=!1}return i.renderSymbol(t,[Z,q],{node:g&&g.node,scale:E,opacity:C,rotation:j,useRotationSize:T,effectView:null==g?void 0:g.effectView})}))}e.previewSymbol2D=S,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
