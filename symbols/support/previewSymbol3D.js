/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/has","../../core/maybe","../../core/Logger","../../core/Error","../../core/promiseUtils","../../core/screenUtils","./IconSymbol3DLayerResource","../../assets","./ObjectSymbol3DLayerResource","../../core/colorUtils","./styleUtils","./gfxUtils","./utils","./previewUtils","./renderUtils"],(function(e,t,s,o,a,l,r,n,i,c,h,p,u,m,y,f){"use strict";const d=i.getAssetUrl("esri/symbols/patterns/"),b=i.getAssetUrl("esri/images/Legend/legend3dsymboldefault.png"),g=22,v=120,x=o.getLogger("esri.symbols.support.previewSymbol3D");function k(e){const t=e.outline,o=s.isSome(e.material)?e.material.color:null,a=s.isSome(o)?o.toRgba().toString():null;if(s.isNone(t))return"fill"===e.type&&"255,255,255,1"===a?{color:"#bdc3c7",width:.75}:null;const l=r.pt2px(t.size)||0;return{color:"rgba("+(s.isSome(t.color)?t.color.toRgba():"255,255,255,1")+")",width:Math.min(l,80)}}function w(e,t=1){const s=e.a,o=h.toHSV(e),a=o.h,l=o.s/t,r=100-(100-o.v)/t,{r:n,g:i,b:c}=h.toRGB({h:a,s:l,v:r});return[n,i,c,s]}function S(e){return"water"===e.type?s.isNone(e.color)?null:e.color:s.isNone(e.material)||s.isNone(e.material.color)?null:e.material.color}function M(e,t=0){const s=S(e);if(!s){const e=u.defaultThematicColor.r,s=y.adjustColorComponentBrightness(e,t);return[s,s,s,100]}const o=s.toRgba();for(let e=0;e<3;e++)o[e]=y.adjustColorComponentBrightness(o[e],t);return o}async function L(e,t){const s=e.style;if("none"===s)return null;return{type:"pattern",x:0,y:0,src:await u.getPatternUrlWithColor(`${d}${s}.png`,t.toCss(!0)),width:5,height:5}}function z(e){return e.outline?k(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function C(e,t){const s=S(e);if(!s)return null;let o="rgba(";return o+=y.adjustColorComponentBrightness(s.r,t)+",",o+=y.adjustColorComponentBrightness(s.g,t)+",",o+=y.adjustColorComponentBrightness(s.b,t)+",",o+s.a+");"}function j(e,t){const s=C(e,t);if(!s)return{};return{color:s,width:Math.min(e.size?r.pt2px(e.size):.75,80)}}function U(e,t,s){const o=.75*s;return{type:"linear",x1:o?.25*o:0,y1:o?.5*o:0,x2:o||4,y2:o?.5*o:4,colors:[{color:e,offset:0},{color:t,offset:1}]}}function D(e,t){const s=t&&t.size?r.pt2px(t.size):null,o=t&&t.maxSize?r.pt2px(t.maxSize):null,a=t&&t.disableUpsampling,i=e.symbolLayers,h=[];let u=0,d=0;const w=i.getItemAt(i.length-1);let S;return w&&"icon"===w.type&&(S=w.size&&r.pt2px(w.size)),i.forEach((i=>{if("icon"!==i.type&&"object"!==i.type)return;const x="icon"===i.type?i.size&&r.pt2px(i.size):0,w=s||x?Math.ceil(Math.min(s||x,o||v)):g;if(i&&i.resource&&i.resource.href){const t=function(e,t){const s=t&&t.resource,o=s&&s.href;return e.thumbnail&&e.thumbnail.url?l.resolve(e.thumbnail.url):o&&"object"!==t.type?l.resolve(m.getIconHref(e,t)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?p.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch((e=>e)).then((e=>e&&e.thumbnail&&e.thumbnail.url||b)):l.resolve(b)}(e,i).then((function(e){const t=i.get("material.color"),s=function(e){return"icon"===e.type?"multiply":"tint"}(i);return f.tintImageWithColor(e,w,t,s,a)})).then((function(e){const t=e.width,s=e.height;return u=Math.max(u,t),d=Math.max(d,s),[{shape:{type:"image",x:0,y:0,width:t,height:s,src:e.url},fill:null,stroke:null}]}));h.push(t)}else{var L;let e=w;"icon"===i.type&&S&&s&&(e=w*(x/S));const o="tall"===(null==t?void 0:t.symbolConfig)||(null==t||null==(L=t.symbolConfig)?void 0:L.isTall)||"object"===i.type&&function(e){const t=e.depth,s=e.height,o=e.width;return o&&t&&s&&o===t&&o<s}(i);u=Math.max(u,o?20:e),d=Math.max(d,e),h.push(l.resolve(function(e,t,s){const o=[];if(!e)return o;switch(e.type){case"icon":{const s=0,a=0,l=t,r=t;switch(e.resource&&e.resource.primitive||n.defaultPrimitive){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:M(e,0),stroke:k(e)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[s,r]},{command:"L",values:[s,a]},{command:"L",values:[l,a]},{command:"L",values:[l,r]},{command:"Z",values:[]}]},fill:M(e,0),stroke:k(e)});break;case"triangle":o.push({shape:{type:"path",path:[{command:"M",values:[s,r]},{command:"L",values:[.5*l,a]},{command:"L",values:[l,r]},{command:"Z",values:[]}]},fill:M(e,0),stroke:k(e)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*l,a]},{command:"L",values:[.5*l,r]},{command:"M",values:[s,.5*r]},{command:"L",values:[l,.5*r]}]},stroke:z(e)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[s,a]},{command:"L",values:[l,r]},{command:"M",values:[l,a]},{command:"L",values:[s,r]}]},stroke:z(e)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[s,.5*r]},{command:"L",values:[.5*l,a]},{command:"L",values:[l,.5*r]},{command:"L",values:[.5*l,r]},{command:"Z",values:[]}]},fill:M(e,0),stroke:k(e)})}break}case"object":switch(e.resource&&e.resource.primitive||c.defaultPrimitive){case"cone":{const a=U(M(e,0),M(e,-.6),s?20:t),l=y.getConeShapes(t,s);o.push({shape:l[0],fill:a}),o.push({shape:l[1],fill:a});break}case"inverted-cone":{const s=M(e,0),a=U(s,M(e,-.6),t),l=y.getInvertedConeShapes(t);o.push({shape:l[0],fill:a}),o.push({shape:l[1],fill:s});break}case"cube":{const a=y.getCubeShapes(t,s);o.push({shape:a[0],fill:M(e,0)}),o.push({shape:a[1],fill:M(e,-.3)}),o.push({shape:a[2],fill:M(e,-.5)});break}case"cylinder":{const a=U(M(e,0),M(e,-.6),s?20:t),l=y.getCylinderShapes(t,s);o.push({shape:l[0],fill:a}),o.push({shape:l[1],fill:a}),o.push({shape:l[2],fill:M(e,0)});break}case"diamond":{const s=y.getDiamondShapes(t);o.push({shape:s[0],fill:M(e,-.3)}),o.push({shape:s[1],fill:M(e,0)}),o.push({shape:s[2],fill:M(e,-.3)}),o.push({shape:s[3],fill:M(e,-.7)});break}case"sphere":{const s=U(M(e,0),M(e,-.6));s.x1=0,s.y1=0,s.x2=.25*t,s.y2=.25*t,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:s});break}case"tetrahedron":{const s=y.getTetrahedronShapes(t);o.push({shape:s[0],fill:M(e,-.3)}),o.push({shape:s[1],fill:M(e,0)}),o.push({shape:s[2],fill:M(e,-.6)});break}}}return o}(i,e,o)))}})),l.eachAlways(h).then((function(e){const s=[];return e.forEach((function(e){e.value?s.push(e.value):e.error&&x.warn("error while building swatchInfo!",e.error)})),f.renderSymbol(s,[u,d],{node:t&&t.node,scale:!1,opacity:t&&t.opacity})}))}e.getPatternDescriptor=L,e.getSymbolLayerFill=M,e.previewSymbol3D=function(e,t){if(0===e.symbolLayers.length)return l.reject(new a("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));let o=null;switch(e.type){case"point-3d":o=D(e,t);break;case"line-3d":o=function(e,t){const s=e.symbolLayers,o=[],a=m.isVolumetricSymbol(e),n=t&&t.size?r.pt2px(t.size):null,i=(t&&t.maxSize?r.pt2px(t.maxSize):null)||80;let c,h=0,p=0;return s.forEach(((e,t)=>{if(!e)return;if("line"!==e.type&&"path"!==e.type)return;const s=[];switch(e.type){case"line":{const o=j(e,0),a=o&&o.width||0;0===t&&(c=a);const l=Math.min(n||a,i),r=0===t?l:n?l*(a/c):l,u=r>20?2*r:40;p=Math.max(p,r),h=Math.max(h,u),o.width=r,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*p]},{command:"L",values:[h,.5*p]}]},stroke:o});break}case"path":{const t=Math.min(n||g,i),o=M(e,0),a=M(e,-.2),l=C(e,-.4),r=l?{color:l,width:1}:{};if("quad"===e.profile){const t=e.width||e.size,l=e.height||e.size,n=t&&l?t/l:1,i=y.getPathSymbolShapes(n),c={...r,join:"bevel"};s.push({shape:i[0],fill:a,stroke:c}),s.push({shape:i[1],fill:a,stroke:c}),s.push({shape:i[2],fill:o,stroke:c})}else s.push({shape:y.shapes.pathSymbol3DLayer[0],fill:a,stroke:r}),s.push({shape:y.shapes.pathSymbol3DLayer[1],fill:o,stroke:r});p=Math.max(p,t),h=p}}o.push(s)})),l.resolve(f.renderSymbol(o,[h,p],{node:t&&t.node,scale:a,opacity:t&&t.opacity}))}(e,t);break;case"polygon-3d":case"mesh-3d":o=async function(e,t){const o="mesh-3d"===e.type,a=e.symbolLayers,n=t&&t.size?r.pt2px(t.size):null,i=t&&t.maxSize?r.pt2px(t.maxSize):null,c=n||g,h=[];let p=0,u=0,m=!1;for(let e=0;e<a.length;e++){const t=a.getItemAt(e),l=[];if(o&&"fill"!==t.type)continue;const r=y.shapes.fill[0];switch(t.type){case"fill":{const e=k(t),a=Math.min(c,i||v);p=Math.max(p,a),u=Math.max(u,a),m=!0;let n=M(t,0);const h="pattern"in t&&t.pattern,y=S(t);!o&&s.isSome(h)&&"style"===h.type&&"solid"!==h.style&&y&&(n=await L(h,y)),l.push({shape:r,fill:n,stroke:e});break}case"line":{const e={stroke:j(t,0),shape:r};p=Math.max(p,g),u=Math.max(u,g),l.push(e);break}case"extrude":{const e={join:"round",...j(t,-.4)},s=M(t,0),o=M(t,-.2),a=Math.min(c,i||v),r=y.getExtrudeSymbolShapes(a);e.width=1,l.push({shape:r[0],fill:o,stroke:e}),l.push({shape:r[1],fill:o,stroke:e}),l.push({shape:r[2],fill:s,stroke:e});const n=g,h=15.399999999999999+.5*a;p=Math.max(p,n),u=Math.max(u,h);break}case"water":{const e=S(t),s=w(e),o=w(e,2),a=w(e,3),r=y.getWaterSymbolShapes();m=!0,l.push({shape:r[0],fill:s}),l.push({shape:r[1],fill:o}),l.push({shape:r[2],fill:a});const n=Math.min(c,i||v);p=Math.max(p,n),u=Math.max(u,n);break}}h.push(l)}return l.resolve(f.renderSymbol(h,[p,u],{node:t&&t.node,scale:m,opacity:t&&t.opacity}))}(e,t)}return o||l.reject(new a("symbolPreview: swatchInfo3D","symbol not supported."))},Object.defineProperty(e,"__esModule",{value:!0})}));
