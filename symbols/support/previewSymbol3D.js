// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","tslib","../../assets","../../core/colorUtils","../../core/compilerUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./IconSymbol3DLayerResource","./ObjectSymbol3DLayerResource","./previewUtils","./renderUtils","./styleUtils","./utils"],(function(e,t,a,r,s,l,i,o,n,h,u,p,c,m,f,y,v,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.previewSymbol3D=t.getPatternDescriptor=t.getSymbolLayerFill=void 0;var b=r.getAssetUrl("esri/symbols/patterns/"),g=r.getAssetUrl("esri/images/Legend/legend3dsymboldefault.png"),x=o.getLogger("esri.symbols.support.previewSymbol3D");function w(e){var t=e.outline,a=n.isSome(e.material)?e.material.color:null,r=n.isSome(a)?a.toRgba().toString():null;if(n.isNone(t))return"fill"===e.type&&"255,255,255,1"===r?{color:"#bdc3c7",width:.75}:null;var s=u.pt2px(t.size)||0;return{color:"rgba("+(n.isSome(t.color)?t.color.toRgba():"255,255,255,1")+")",width:Math.min(s,80)}}function S(e,t){void 0===t&&(t=1);var a=e.a,r=s.toHSV(e),l=r.h,i=r.s/t,o=100-(100-r.v)/t,n=s.toRGB({h:l,s:i,v:o});return[n.r,n.g,n.b,a]}function M(e,t){return Math.round(Math.min(Math.max(e+255*t*.75,0),255))}function k(e){return"water"===e.type?n.isNone(e.color)?null:e.color:n.isNone(e.material)||n.isNone(e.material.color)?null:e.material.color}function L(e,t){void 0===t&&(t=0);var a=k(e);if(!a){var r=M(p.defaultThematicColor.r,t);return[r,r,r,100]}for(var s=a.toRgba(),l=0;l<3;l++)s[l]=M(s[l],t);return s}function z(e,t){return a.__awaiter(this,void 0,void 0,(function(){var r;return a.__generator(this,(function(a){switch(a.label){case 0:return"none"===(r=e.style)?[2,null]:[4,p.getPatternUrlWithColor(""+b+r+".png",t.toCss(!0))];case 1:return[2,{type:"pattern",x:0,y:0,src:a.sent(),width:5,height:5}]}}))}))}function _(e){return e.outline?w(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function U(e,t){var a=k(e);if(!a)return null;var r="rgba(";return r+=M(a.r,t)+",",r+=M(a.g,t)+",",(r+=M(a.b,t)+",")+a.a+");"}function D(e,t){var a=U(e,t);return a?{color:a,width:Math.min(e.size?u.pt2px(e.size):.75,80)}:{}}function j(e,t,a){var r=.75*a;return{type:"linear",x1:r?.25*r:0,y1:r?.5*r:0,x2:r||4,y2:r?.5*r:4,colors:[{color:e,offset:0},{color:t,offset:1}]}}function P(e,t){var a,r=t&&t.size?u.pt2px(t.size):null,s=t&&t.maxSize?u.pt2px(t.maxSize):null,i=t&&t.disableUpsampling,o=e.symbolLayers,n=[],p=0,b=0,S=o.getItemAt(o.length-1);return S&&"icon"===S.type&&(a=S.size&&u.pt2px(S.size)),o.forEach((function(o){if("icon"===o.type||"object"===o.type){var x="icon"===o.type?o.size&&u.pt2px(o.size):0,S=r||x?Math.ceil(Math.min(r||x,s||120)):22;if(o&&o.resource&&o.resource.href){var M=function(e,t){var a=t&&t.resource,r=a&&a.href;return e.thumbnail&&e.thumbnail.url?h.resolve(e.thumbnail.url):r&&"object"!==t.type?h.resolve(d.getIconHref(e,t)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?v.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch((function(e){return e})).then((function(e){return e&&e.thumbnail&&e.thumbnail.url||g})):h.resolve(g)}(e,o).then((function(e){var t=o.get("material.color"),a=function(e){return"icon"===e.type?"multiply":"tint"}(o);return y.tintImageWithColor(e,S,t,a,i)})).then((function(e){var t=e.width,a=e.height;return p=Math.max(p,t),b=Math.max(b,a),[{shape:{type:"image",x:0,y:0,width:t,height:a,src:e.url},fill:null,stroke:null}]}));n.push(M)}else{var k=S;"icon"===o.type&&a&&r&&(k=S*(x/a));var z=t&&"tall"===t.symbolConfig||"object"===o.type&&function(e){var t=e.depth,a=e.height,r=e.width;return r&&t&&a&&r===t&&r<a}(o);p=Math.max(p,z?20:k),b=Math.max(b,k),n.push(h.resolve(function(e,t,a){var r=[];if(!e)return r;switch(e.type){case"icon":var s=t,i=t;switch(o=e.resource&&e.resource.primitive||c.defaultPrimitive){case"circle":r.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:L(e,0),stroke:w(e)});break;case"square":r.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[0,0]},{command:"L",values:[s,0]},{command:"L",values:[s,i]},{command:"Z",values:[]}]},fill:L(e,0),stroke:w(e)});break;case"triangle":r.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[.5*s,0]},{command:"L",values:[s,i]},{command:"Z",values:[]}]},fill:L(e,0),stroke:w(e)});break;case"cross":r.push({shape:{type:"path",path:[{command:"M",values:[.5*s,0]},{command:"L",values:[.5*s,i]},{command:"M",values:[0,.5*i]},{command:"L",values:[s,.5*i]}]},stroke:_(e)});break;case"x":r.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[s,i]},{command:"M",values:[s,0]},{command:"L",values:[0,i]}]},stroke:_(e)});break;case"kite":r.push({shape:{type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*s,0]},{command:"L",values:[s,.5*i]},{command:"L",values:[.5*s,i]},{command:"Z",values:[]}]},fill:L(e,0),stroke:w(e)});break;default:l.neverReached(o)}break;case"object":var o;switch(o=e.resource&&e.resource.primitive||m.defaultPrimitive){case"cone":var n=j(L(e,0),L(e,-.6),a?20:t),h=f.getConeShapes(t,a);r.push({shape:h[0],fill:n}),r.push({shape:h[1],fill:n});break;case"inverted-cone":var u=L(e,0),p=j(u,L(e,-.6),t),y=f.getInvertedConeShapes(t);r.push({shape:y[0],fill:p}),r.push({shape:y[1],fill:u});break;case"cube":var v=f.getCubeShapes(t,a);r.push({shape:v[0],fill:L(e,0)}),r.push({shape:v[1],fill:L(e,-.3)}),r.push({shape:v[2],fill:L(e,-.5)});break;case"cylinder":var d=j(L(e,0),L(e,-.6),a?20:t),b=f.getCylinderShapes(t,a);r.push({shape:b[0],fill:d}),r.push({shape:b[1],fill:d}),r.push({shape:b[2],fill:L(e,0)});break;case"diamond":var g=f.getDiamondShapes(t);r.push({shape:g[0],fill:L(e,-.3)}),r.push({shape:g[1],fill:L(e,0)}),r.push({shape:g[2],fill:L(e,-.3)}),r.push({shape:g[3],fill:L(e,-.7)});break;case"sphere":var x=j(L(e,0),L(e,-.6));x.x1=0,x.y1=0,x.x2=.25*t,x.y2=.25*t,r.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:x});break;case"tetrahedron":var S=f.getTetrahedronShapes(t);r.push({shape:S[0],fill:L(e,-.3)}),r.push({shape:S[1],fill:L(e,0)}),r.push({shape:S[2],fill:L(e,-.6)});break;default:l.neverReached(o)}}return r}(o,k,z)))}}})),h.eachAlways(n).then((function(e){var a=[];return e.forEach((function(e){e.value?a.push(e.value):e.error&&x.warn("error while building swatchInfo!",e.error)})),y.renderSymbol(a,[p,b],{node:t&&t.node,scale:!1,opacity:t&&t.opacity})}))}t.getSymbolLayerFill=L,t.getPatternDescriptor=z,t.previewSymbol3D=function(e,t){if(0===e.symbolLayers.length)return h.reject(new i("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var r=null;switch(e.type){case"point-3d":r=P(e,t);break;case"line-3d":r=function(e,t){var r,s=e.symbolLayers,l=[],i=d.isVolumetricSymbol(e),o=t&&t.size?u.pt2px(t.size):null,n=(t&&t.maxSize?u.pt2px(t.maxSize):null)||80,p=0,c=0;return s.forEach((function(e,t){if(e&&("line"===e.type||"path"===e.type)){var s=[];switch(e.type){case"line":var i=(g=D(e,0))&&g.width||0;0===t&&(r=i);var h=Math.min(o||i,n),u=0===t?h:o?h*(i/r):h,m=u>20?2*u:40;c=Math.max(c,u),p=Math.max(p,m),g.width=u,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[p,.5*c]}]},stroke:g});break;case"path":var y=Math.min(o||22,n),v=L(e,0),d=L(e,-.2),b=U(e,-.4),g=b?{color:b,width:1}:{};if("quad"===e.profile){var x=e.width||e.size,w=e.height||e.size,S=x&&w?x/w:1,M=f.getPathSymbolShapes(S),k=a.__assign(a.__assign({},g),{join:"bevel"});s.push({shape:M[0],fill:d,stroke:k}),s.push({shape:M[1],fill:d,stroke:k}),s.push({shape:M[2],fill:v,stroke:k})}else s.push({shape:f.shapes.pathSymbol3DLayer[0],fill:d,stroke:g}),s.push({shape:f.shapes.pathSymbol3DLayer[1],fill:v,stroke:g});c=Math.max(c,y),p=c}l.push(s)}})),h.resolve(y.renderSymbol(l,[p,c],{node:t&&t.node,scale:i,opacity:t&&t.opacity}))}(e,t);break;case"polygon-3d":case"mesh-3d":r=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var r,s,l,i,o,p,c,m,v,d,b,g,x,M,_,U,j,P,C,R,I,O,N,A,E,W,q,H,T,Z;return a.__generator(this,(function(F){switch(F.label){case 0:r=e.type,s="mesh-3d"===r,l=e.symbolLayers,i=t&&t.size?u.pt2px(t.size):null,o=t&&t.maxSize?u.pt2px(t.maxSize):null,p=i||22,c=[],m=0,v=0,d=!1,b=0,F.label=1;case 1:if(!(b<l.length))return[3,10];if(g=l.getItemAt(b),x=[],s&&"fill"!==g.type)return[3,9];switch(M=f.shapes.fill[0],g.type){case"fill":return[3,2];case"line":return[3,5];case"extrude":return[3,6];case"water":return[3,7]}return[3,8];case 2:return _=w(g),Z=Math.min(p,o||120),m=Math.max(m,Z),v=Math.max(v,Z),d=!0,U=L(g,0),j="pattern"in g&&g.pattern,E=k(g),!s&&n.isSome(j)&&"style"===j.type&&"solid"!==j.style&&E?[4,z(j,E)]:[3,4];case 3:U=F.sent(),F.label=4;case 4:return x.push({shape:M,fill:U,stroke:_}),[3,8];case 5:return P=D(g,0),C={stroke:P,shape:M},m=Math.max(m,22),v=Math.max(v,22),x.push(C),[3,8];case 6:return R=a.__assign({join:"round"},D(g,-.4)),W=L(g,0),I=L(g,-.2),O=Math.min(p,o||120),N=f.getExtrudeSymbolShapes(O),R.width=1,x.push({shape:N[0],fill:I,stroke:R}),x.push({shape:N[1],fill:I,stroke:R}),x.push({shape:N[2],fill:W,stroke:R}),22,A=22*.7+.5*O,m=Math.max(m,22),v=Math.max(v,A),[3,8];case 7:return E=k(g),W=S(E),q=S(E,2),H=S(E,3),T=f.getWaterSymbolShapes(),d=!0,x.push({shape:T[0],fill:W}),x.push({shape:T[1],fill:q}),x.push({shape:T[2],fill:H}),Z=Math.min(p,o||120),m=Math.max(m,Z),v=Math.max(v,Z),[3,8];case 8:c.push(x),F.label=9;case 9:return b++,[3,1];case 10:return[2,h.resolve(y.renderSymbol(c,[m,v],{node:t&&t.node,scale:d,opacity:t&&t.opacity}))]}}))}))}(e,t)}return r||h.reject(new i("symbolPreview: swatchInfo3D","symbol not supported."))}}));