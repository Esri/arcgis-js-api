/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../core/maybe","../../Color","../../core/screenUtils","./Symbol3DMaterial","../../symbols","../../core/asyncUtils","../../chunks/vec3f64","./gfxUtils"],(function(e,t,o,n,r,l,i,s,c,u,a){"use strict";const y=/\/resource\/(.*?)\.svg$/,f=new r("white");function m(e){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const o=e.symbolLayers.getItemAt(t-1);return"outline"in o?n.get(o,"outline","size"):void 0}function b(e){if(!e)return 0;if(s.isSymbol3D(e)){const t=m(e);return n.isSome(t)?t:0}const t=a.getStroke(e);return t&&l.px2pt(t.width)||0}function p(e){if(!e||!e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function h(e,t){const n=t.resource.href;return!o("esri-canvas-svg-support")&&e.styleOrigin&&y.test(n)?n.replace(y,"/resource/png/$1.png"):n}function w(e,t){if(!e)return null;let o=null;return s.isSymbol3D(e)?o=S(e):s.isSymbol2D(e)&&(o=e.color?new r(e.color):null),o?d(o,t):null}function S(e){const t=e.symbolLayers;if(!t)return null;let o=null;return t.forEach((e=>{"object"===e.type&&null!=e.resource.href||(o="water"===e.type?n.unwrap(e.color):n.isSome(e.material)?n.unwrap(e.material.color):null)})),o?new r(o):null}function d(e,t){if(null==t)return e;const o=e.toRgba();return o[3]=o[3]*t,new r(o)}function g(e,t,o){const r=e.symbolLayers;if(!r)return;const l=e=>{const r=n.isSome(e)?e:null;return d(t=t||r||null!=o&&f,o)};r.forEach((e=>{if("object"!==e.type||null==e.resource.href||t)if("water"===e.type)e.color=l(e.color);else{const t=n.isSome(e.material)?e.material.color:null,r=l(t);n.isNone(e.material)?e.material=new i.default({color:r}):e.material.color=r,null!=o&&"outline"in e&&n.isSome(e.outline)&&n.isSome(e.outline.color)&&(e.outline.color=d(e.outline.color,o))}}))}function k(e,t,o){(t=t||e.color)&&(e.color=d(t,o)),null!=o&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=d(e.outline.color,o))}function L(e,t,o){e&&(t||null!=o)&&(t&&(t=new r(t)),s.isSymbol3D(e)?g(e,t,o):s.isSymbol2D(e)&&k(e,t,o))}async function z(e,t){const o=e.symbolLayers;o&&await c.forEach(o,(async e=>v(e,t)))}async function v(e,t){switch(e.type){case"extrude":x(e,t);break;case"icon":case"line":case"text":D(e,t);break;case"path":E(e,t);break;case"object":await O(e,t)}}function D(e,t){const o=j(t);n.isSome(o)&&(e.size=o)}function j(e){for(const t of e)if("number"==typeof t)return t;return null}function x(e,t){e.size="number"==typeof t[2]?t[2]:0}async function O(e,t){const{resourceSize:o,symbolSize:n}=await T(e),r=C(t,o,n);e.width=U(t[0],n[0],o[0],r),e.depth=U(t[1],n[1],o[1],r),e.height=U(t[2],n[2],o[2],r)}function E(e,t){const o=C(t,u.ONES,[e.width,void 0,e.height]);e.width=U(t[0],e.width,1,o),e.height=U(t[2],e.height,1,o)}function C(e,t,o){for(let n=0;n<3;n++){const r=e[n];switch(r){case"symbol-value":return null!=o[n]?o[n]/t[n]:1;case"proportional":break;default:if(r&&t[n])return r/t[n]}}return 1}async function T(t){const o=await new Promise((function(t,o){e(["./symbolLayerUtils"],t,o)})),n=await o.computeObjectLayerResourceSize(t,10),{width:r,height:l,depth:i}=t,s=[r,i,l];let c=1;for(let e=0;e<3;e++)if(null!=s[e]){c=s[e]/n[e];break}for(let e=0;e<3;e++)null==s[e]&&(s[e]=n[e]*c);return{resourceSize:n,symbolSize:s}}function U(e,t,o,n){switch(e){case"proportional":return o*n;case"symbol-value":return null!=t?t:o;default:return e}}function N(e,t){const o=j(t);if(!n.isNone(o))switch(e.type){case"simple-marker":e.size=o;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=o,e.height=o*t):(e.width=o*t,e.height=o);break}case"simple-line":e.width=o;break;case"text":e.font.size=o}}async function R(e,t){if(e&&t)return s.isSymbol3D(e)?z(e,t):void(s.isSymbol2D(e)&&N(e,t))}function I(e,t,o){if(e&&null!=t)if(s.isSymbol3D(e)){const n=e.symbolLayers;n&&n.forEach((e=>{if(e&&"object"===e.type)switch(o){case"tilt":e.tilt=t;break;case"roll":e.roll=t;break;default:e.heading=t}}))}else s.isSymbol2D(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=t))}t.applyColorToSymbol=L,t.applyOpacityToColor=d,t.applyRotationToSymbol=I,t.applySizesToSymbol=R,t.getColorFromSymbol=w,t.getIconHref=h,t.getSymbolOutlineSize=b,t.isVolumetricSymbol=p,Object.defineProperty(t,"__esModule",{value:!0})}));
