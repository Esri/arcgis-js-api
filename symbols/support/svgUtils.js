// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.17/esri/copyright.txt for details.

define(["require","exports","../../Color","../../core/has","../../core/libs/gl-matrix-2/mat2df32","../../core/libs/gl-matrix-2/math/mat2d","../../widgets/support/widget"],(function(t,e,r,i,n,a,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.renderSVG=e.getTransformMatrix=e.computeBBox=e.getBoundingBox=e.renderDef=e.generateTextAttributes=e.generateStrokeAttributes=e.generateFillAttributes=e.renderShape=void 0;var l=0,s=0,h=i("android"),d=i("chrome")||h&&h>=4?"auto":"optimizeLegibility",f={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},c=/([A-DF-Za-df-z])|([-+]?\d*[.]?\d+(?:[eE][-+]?\d+)?)/g,y={},u={},g={solid:"none",shortdash:[4,1],shortdot:[1,1],shortdashdot:[4,1,1,1],shortdashdotdot:[4,1,1,1,1,1],dot:[1,3],dash:[4,3],longdash:[8,3],dashdot:[4,3,1,3],longdashdot:[8,3,1,3],longdashdotdot:[8,3,1,3,1,3]};function x(t){return t.map((function(t){return t.command+" "+t.values.join(" ")})).join(" ").trim()}function p(t,e,r,i){if(t){if("circle"===t.type)return o.tsx("circle",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",cx:t.cx,cy:t.cy,r:t.r});if("ellipse"===t.type)return o.tsx("ellipse",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",cx:t.cx,cy:t.cy,rx:t.rx,ry:t.ry});if("rect"===t.type)return o.tsx("rect",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",x:t.x,y:t.y,width:t.width,height:t.height});if("image"===t.type)return o.tsx("image",{href:t.src,x:t.x,y:t.y,width:t.width,height:t.height,preserveAspectRatio:"none"});if("path"===t.type){var n="string"!=typeof t.path?x(t.path):t.path;return o.tsx("path",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",d:n})}if("text"===t.type)return o.tsx("text",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4","text-anchor":i.align,"text-decoration":i.decoration,kerning:i.kerning,rotate:i.rotate,"text-rendering":d,"font-style":i.font.style,"font-variant":i.font.variant,"font-weight":i.font.weight,"font-size":i.font.size,"font-family":i.font.family,x:t.x,y:t.y},t.text)}return null}function m(t){var e={fill:"none",pattern:null,linearGradient:null};if(t)if("type"in t&&"pattern"===t.type){var i="patternId-"+ ++l;e.fill="url(#"+i+")",e.pattern={id:i,x:t.x,y:t.y,width:t.width,height:t.height,image:{x:0,y:0,width:t.width,height:t.height,href:t.src}}}else if("type"in t&&"linear"===t.type){i="linearGradientId-"+ ++s;e.fill="url(#"+i+")",e.linearGradient={id:i,x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2,stops:t.colors.map((function(t){return{offset:t.offset,color:t.color&&new r(t.color).toString()}}))}}else if(t){var n=new r(t);e.fill=n.toString()}return e}function w(t){var e={color:"none",width:1,cap:"butt",join:"4",dashArray:"none"};if(t&&(null!=t.width&&(e.width=t.width),t.cap&&(e.cap=t.cap),t.join&&(e.join=t.join.toString()),t.color&&(e.color=new r(t.color).toString()),t.style)){var i=null;if(t.style in g&&(i=g[t.style]),Array.isArray(i)){i=i.slice(0);for(var n=0;n<i.length;++n)i[n]*=t.width;if("butt"!==t.cap){for(n=0;n<i.length;n+=2)i[n]-=t.width,i[n]<1&&(i[n]=1);for(n=1;n<i.length;n+=2)i[n]+=t.width}i=i.join(",")}e.dashArray=i}return e}function v(t,e){var r={align:null,decoration:null,kerning:null,rotate:null,font:{style:null,variant:null,weight:null,size:null,family:null}};return t&&(r.align=t.align,r.decoration=t.decoration,r.kerning=t.kerning?"auto":"0",r.rotate=t.rotated?"90":"0",r.font.style=e.style||"normal",r.font.variant=e.variant||"normal",r.font.weight=e.weight||"normal",r.font.size=e.size&&e.size.toString()||"10pt",r.font.family=e.family||"serif"),r}function k(t){var e=t.pattern,r=t.linearGradient;if(e)return o.tsx("pattern",{id:e.id,patternUnits:"userSpaceOnUse",x:e.x,y:e.y,width:e.width,height:e.height},o.tsx("image",{x:e.image.x,y:e.image.y,width:e.image.width,height:e.image.height,href:e.image.href}));if(r){var i=r.stops.map((function(t,e){return o.tsx("stop",{key:e+"-stop",offset:t.offset,"stop-color":t.color})}));return o.tsx("linearGradient",{id:r.id,gradientUnits:"userSpaceOnUse",x1:r.x1,y1:r.y1,x2:r.x2,y2:r.y2},i)}return null}function b(t,e,r,i,n){return a.scale(t,a.identity(t),[e,r]),t[4]=t[4]*e-i*e+i,t[5]=t[5]*r-n*r+n,t}function A(t,e){y&&"left"in y?(y.left>t&&(y.left=t),y.right<t&&(y.right=t),y.top>e&&(y.top=e),y.bottom<e&&(y.bottom=e)):y={left:t,bottom:e,right:t,top:e}}function j(t){var e,r=t.args,i=r.length;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(e=0;e<i;e+=2)A(r[e],r[e+1]);u.x=r[i-2],u.y=r[i-1];break;case"H":for(e=0;e<i;++e)A(r[e],u.y);u.x=r[i-1];break;case"V":for(e=0;e<i;++e)A(u.x,r[e]);u.y=r[i-1];break;case"m":var n=0;"x"in u||(A(u.x=r[0],u.y=r[1]),n=2);for(e=n;e<i;e+=2)A(u.x+=r[e],u.y+=r[e+1]);break;case"l":case"t":for(e=0;e<i;e+=2)A(u.x+=r[e],u.y+=r[e+1]);break;case"h":for(e=0;e<i;++e)A(u.x+=r[e],u.y);break;case"v":for(e=0;e<i;++e)A(u.x,u.y+=r[e]);break;case"c":for(e=0;e<i;e+=6)A(u.x+r[e],u.y+r[e+1]),A(u.x+r[e+2],u.y+r[e+3]),A(u.x+=r[e+4],u.y+=r[e+5]);break;case"s":case"q":for(e=0;e<i;e+=4)A(u.x+r[e],u.y+r[e+1]),A(u.x+=r[e+2],u.y+=r[e+3]);break;case"A":for(e=0;e<i;e+=7)A(r[e+5],r[e+6]);u.x=r[i-2],u.y=r[i-1];break;case"a":for(e=0;e<i;e+=7)A(u.x+=r[e+5],u.y+=r[e+6])}}function S(t,e,r){var i,n=f[t.toLowerCase()];"number"==typeof n&&(n?e.length>=n&&(i={action:t,args:e.slice(0,e.length-e.length%n)},r.push(i),j(i)):(i={action:t,args:[]},r.push(i),j(i)))}function N(t){var e={x:0,y:0,width:0,height:0};if("circle"===t.type)e.x=t.cx-t.r,e.y=t.cy-t.r,e.width=2*t.r,e.height=2*t.r;else if("ellipse"===t.type)e.x=t.cx-t.rx,e.y=t.cy-t.ry,e.width=2*t.rx,e.height=2*t.ry;else if("image"===t.type||"rect"===t.type)e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height;else if("path"===t.type){var r=function(t){var e=("string"!=typeof t.path?x(t.path):t.path).match(c),r=[];if(y={},u={},!e)return null;for(var i="",n=[],a=e.length,o=0;o<a;++o){var l=e[o],s=parseFloat(l);isNaN(s)?(i&&S(i,n,r),n=[],i=l):n.push(s)}S(i,n,r);var h={x:0,y:0,width:0,height:0};return y&&"left"in y&&(h.x=y.left,h.y=y.top,h.width=y.right-y.left,h.height=y.bottom-y.top),h}(t);e.x=r.x,e.y=r.y,e.width=r.width,e.height=r.height}return e}function I(t){for(var e={x:0,y:0,width:0,height:0},r=null,i=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,a=0,o=t;a<o.length;a++){var l=o[a];r?(r.x=Math.min(r.x,l.x),r.y=Math.min(r.y,l.y),i=Math.max(i,l.x+l.width),n=Math.max(n,l.y+l.height)):((r=e).x=l.x,r.y=l.y,i=l.x+l.width,n=l.y+l.height)}return r&&(r.width=i-r.x,r.height=n-r.y),r}function M(t,e,r,i,o,l){var s=e/2,h=r/2,d=t.width+i,f=t.height+i,c=n.mat2df32.create(),y=n.mat2df32.create(),u=!1;if(o&&0!==d&&0!==f){var g=d/f,x=e>r?e:r,p=1,m=1;isNaN(x)||(g>1?(p=x/d,m=x/g/f):(m=x/f,p=x*g/d)),a.multiply(y,y,b(c,p,m,s,h)),u=!0}var w=t.x+(d-i)/2,v=t.y+(f-i)/2,k=s-w,A=h-v;if(a.multiply(y,y,function(t,e,r){return a.translate(t,a.identity(t),[e,r])}(c,k,A)),!u&&(d>e||f>r)){var j=d/e>f/r,S=(j?e:r)/(j?d:f);a.multiply(y,y,b(c,S,S,w,v))}return l&&a.multiply(y,y,function(t,e,r,i){var n=e%360*Math.PI/180;a.rotate(t,a.identity(t),n);var o=Math.cos(n),l=Math.sin(n),s=t[4],h=t[5];return t[4]=s*o-h*l+i*l-r*o+r,t[5]=h*o+s*l-r*l-i*o+i,t}(c,l,w,v)),"matrix("+y[0]+","+y[1]+","+y[2]+","+y[3]+","+y[4]+","+y[5]+")"}e.renderShape=p,e.generateFillAttributes=m,e.generateStrokeAttributes=w,e.generateTextAttributes=v,e.renderDef=k,e.getBoundingBox=N,e.computeBBox=I,e.getTransformMatrix=M,e.renderSVG=function(t,e,r,i){for(var n=[],a=[],l=0,s=t;l<s.length;l++){for(var h=[],d=[],f=0,c=0,y=s[l];c<y.length;c++){var u=y[c],g=u.shape,x=u.fill,b=u.stroke,A=u.font;f+=b&&b.width||0;var j=m(x),S=w(b),z="text"===g.type?v(g,A):null;n.push(k(j)),h.push(p(g,j.fill,S,z)),d.push(N(g))}var G=M(I(d),e,r,f,i&&i.scale,i&&i.rotation);a.push(o.tsx("g",{transform:G},h))}return o.tsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:e,height:r},o.tsx("defs",null,n),a)}}));