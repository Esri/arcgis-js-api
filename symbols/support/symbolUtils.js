/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../core/maybe","../../support/arcadeOnDemand","./utils"],(function(e,t,l,o,i,r){"use strict";let a=null;function n(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function s(e,t,l){const{backgroundColor:o,outline:i,dotSize:r}=e,s=l&&l.swatchSize||22,c=.8,u=Math.round(s*s/r**2*c),y=window.devicePixelRatio,p=document.createElement("canvas"),b=s*y;p.width=b,p.height=b,p.style.width=p.width/y+"px",p.style.height=p.height/y+"px";const m=p.getContext("2d");if(o&&(m.fillStyle=o.toCss(!0),m.fillRect(0,0,b,b),m.fill()),m.fillStyle=t.toCss(!0),a&&a.length/2===u)for(let n=0;n<2*u;n+=2){const e=a[n],t=a[n+1];m.fillRect(e,t,r*y,r*y),m.fill()}else{a=[];for(let e=0;e<2*u;e+=2){const e=n(0,b),t=n(0,b);a.push(e,t),m.fillRect(e,t,r*y,r*y),m.fill()}}i&&(i.color&&(m.strokeStyle=i.color.toCss(!0)),m.lineWidth=i.width,m.strokeRect(0,0,b,b));const d=new Image(s,s);return d.src=p.toDataURL(),d}function c(e,t={}){const l=24,o=75,i="horizontal"===t.align,r=i?o:l,a=i?l:o,{width:n=r,height:s=a,gradient:c=!0}=t,u=window.devicePixelRatio,y=n*u,p=s*u,b=document.createElement("canvas");b.width=y,b.height=p,b.style.width=`${n}px`,b.style.height=`${s}px`;const m=b.getContext("2d"),d=i?y:0,h=i?0:p;if(c){const t=m.createLinearGradient(0,0,d,h),l=1/(e.length-1);e.forEach(((e,o)=>t.addColorStop(o*l,e.toString()))),m.fillStyle=t,m.fillRect(0,0,y,p)}else{const t=i?y/e.length:y,l=i?p:p/e.length;let o=0,r=0;for(const a of e)m.fillStyle=a.toString(),m.fillRect(o,r,t,l),o=i?o+t:0,r=i?0:r+l}const f=document.createElement("div");return f.style.width=`${n}px`,f.style.height=`${s}px`,f.appendChild(b),f}async function u(t,l){switch(t.type){case"web-style":{const{previewWebStyleSymbol:o}=await new Promise((function(t,l){e(["./previewWebStyleSymbol"],t,l)}));return o(t,u,l)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:o}=await new Promise((function(t,l){e(["./previewSymbol3D"],t,l)}));return o(t,l)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:o}=await new Promise((function(t,l){e(["./previewSymbol2D"],t,l)}));return o(t,l)}case"cim":{const{previewCIMSymbol:o}=await new Promise((function(t,l){e(["./previewCIMSymbol"],t,l)}));return o(t,l)}default:return}}function y(e){return e&&"opacity"in e?e.opacity*y(e.parent):1}async function p(t,l){if(!t)return;const a=y(t.layer||t.sourceLayer);if(o.isSome(t.symbol)&&(!o.isSome(l)||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await t.symbol.fetchSymbol(o.isSome(l)?l.abortOptions:null):t.symbol.clone();return r.applyColorToSymbol(e,null,a),e}const n=o.isSome(l)&&l.renderer||t.get("layer.renderer")||t.get("sourceLayer.renderer");let s=await n.getSymbolAsync(t,l);if(!s)return;if(s="web-style"===s.type?await s.fetchSymbol(o.isSome(l)?l.abortOptions:null):s.clone(),!("visualVariables"in n)||"visualVariables"in n&&!n.visualVariables||"visualVariables"in n&&n.visualVariables&&!n.visualVariables.length)return s;if(n.arcadeRequiredForVisualVariables&&(o.isNone(l)||o.isNone(l.arcade))){const e={...o.unwrap(l)};e.arcade=await i.loadArcade(),l=e}const c=await new Promise((function(t,l){e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l)})),u=[],p=[],b=[],m=[];for(const e of n.visualVariables)switch(e.type){case"color":u.push(e);break;case"opacity":p.push(e);break;case"rotation":m.push(e);break;case"size":e.target||b.push(e)}const d=!!u.length&&u[u.length-1],h=d?c.getColor(d,t,l):null,f=!!p.length&&p[p.length-1];let w=f?c.getOpacity(f,t,l):null;if(null!=a&&(w=null!=w?w*a:a),r.applyColorToSymbol(s,h,w),b.length){const e=c.getAllSizes(b,t,l);await r.applySizesToSymbol(s,e)}for(const e of m)r.applyRotationToSymbol(s,c.getRotationAngle(e,t,l),e.axis);return s}async function b(t,l){var a;if(!t)return;const n=y(t.layer||t.sourceLayer);if(o.isSome(t.symbol)&&(!o.isSome(l)||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await t.symbol.fetchSymbol(o.isSome(l)?l.abortOptions:null):t.symbol.clone();return r.getColorFromSymbol(e,n)}const s=o.isSome(l)&&l.renderer||t.get("layer.renderer")||t.get("sourceLayer.renderer");let c=await s.getSymbolAsync(t,l);if(!c)return;c="web-style"===c.type?await c.fetchSymbol(o.isSome(l)?l.abortOptions:null):c.clone();const u=r.getColorFromSymbol(c,n);if(!("visualVariables"in s)||"visualVariables"in s&&!s.visualVariables||"visualVariables"in s&&(null==(a=s.visualVariables)||!a.length))return u;if(s.arcadeRequiredForVisualVariables&&(o.isNone(l)||o.isNone(l.arcade))){const e={...o.unwrap(l)};e.arcade=await i.loadArcade(),l=e}const p=await new Promise((function(t,l){e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l)})),b=[],m=[];for(const e of s.visualVariables)switch(e.type){case"color":b.push(e);break;case"opacity":m.push(e)}const d=b.length>0?b[b.length-1]:null,h=d?p.getColor(d,t,l):u,f=m.length>0?m[m.length-1]:null;let w=f?p.getOpacity(f,t,l):null;return null!=n&&(w=null!=w?w*n:n),h?r.applyOpacityToColor(h,w):null}t.getDisplayedColor=b,t.getDisplayedSymbol=p,t.renderColorRampPreviewHTML=c,t.renderDotDensityPreviewHTML=s,t.renderPreviewHTML=u,Object.defineProperty(t,"__esModule",{value:!0})}));
