/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../core/maybe","../../support/arcadeOnDemand","./utils"],(function(e,t,l,i,o,n){"use strict";let r=null;function a(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function s(e){return e&&"opacity"in e?e.opacity*s(e.parent):1}t.getDisplayedSymbol=async function(t,l){if(!t)return;const r=s(t.layer||t.sourceLayer);if(i.isSome(t.symbol)&&(!i.isSome(l)||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await t.symbol.fetchSymbol(i.isSome(l)?l.abortOptions:null):t.symbol.clone();return n.applyColorToSymbol(e,null,r),e}const a=i.isSome(l)&&l.renderer||t.get("layer.renderer")||t.get("sourceLayer.renderer");let c=await a.getSymbolAsync(t);if(!c)return;if(c="web-style"===c.type?await c.fetchSymbol(i.isSome(l)?l.abortOptions:null):c.clone(),!("visualVariables"in a)||"visualVariables"in a&&!a.visualVariables||"visualVariables"in a&&a.visualVariables&&!a.visualVariables.length)return c;if(a.arcadeRequiredForVisualVariables&&(i.isNone(l)||i.isNone(l.arcade))){const e={...i.unwrap(l)};e.arcade=await o.loadArcade(),l=e}const u=await new Promise((function(t,l){e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l)})),y=[],p=[],d=[],h=[];for(const e of a.visualVariables)switch(e.type){case"color":y.push(e);break;case"opacity":p.push(e);break;case"rotation":h.push(e);break;case"size":e.target||d.push(e)}const f=!!y.length&&y[y.length-1],m=f?u.getColor(f,t,l):null,w=!!p.length&&p[p.length-1];let b=w?u.getOpacity(w,t,l):null;if(null!=r&&(b=null!=b?b*r:r),n.applyColorToSymbol(c,m,b),d.length){const e=u.getAllSizes(d,t,l);await n.applySizesToSymbol(c,e)}for(const e of h)n.applyRotationToSymbol(c,u.getRotationAngle(e,t,l),e.axis);return c},t.renderColorRampPreviewHTML=function(e,t={}){const l="horizontal"===t.align,i=l?75:24,o=l?24:75,{width:n=i,height:r=o,gradient:a=!0}=t,s=window.devicePixelRatio,c=n*s,u=r*s,y=document.createElement("canvas");y.width=c,y.height=u,y.style.width=`${n}px`,y.style.height=`${r}px`;const p=y.getContext("2d"),d=l?c:0,h=l?0:u;if(a){const t=p.createLinearGradient(0,0,d,h),l=1/(e.length-1);e.forEach(((e,i)=>t.addColorStop(i*l,e.toString()))),p.fillStyle=t,p.fillRect(0,0,c,u)}else{const t=l?c/e.length:c,i=l?u:u/e.length;let o=0,n=0;for(const r of e)p.fillStyle=r.toString(),p.fillRect(o,n,t,i),o=l?o+t:0,n=l?0:n+i}const f=document.createElement("div");return f.style.width=`${n}px`,f.style.height=`${r}px`,f.appendChild(y),f},t.renderDotDensityPreviewHTML=function(e,t,l){const{backgroundColor:i,outline:o,dotSize:n}=e,s=l&&l.swatchSize||22,c=Math.round(s*s/Math.pow(n,2)*.8),u=window.devicePixelRatio,y=document.createElement("canvas"),p=s*u;y.width=p,y.height=p,y.style.width=y.width/u+"px",y.style.height=y.height/u+"px";const d=y.getContext("2d");if(i&&(d.fillStyle=i.toCss(!0),d.fillRect(0,0,p,p),d.fill()),d.fillStyle=t.toCss(!0),r&&r.length/2===c)for(let e=0;e<2*c;e+=2){const t=r[e],l=r[e+1];d.fillRect(t,l,n*u,n*u),d.fill()}else{r=[];for(let e=0;e<2*c;e+=2){const e=a(0,p),t=a(0,p);r.push(e,t),d.fillRect(e,t,n*u,n*u),d.fill()}}o&&(o.color&&(d.strokeStyle=o.color.toCss(!0)),d.lineWidth=o.width,d.strokeRect(0,0,p,p));const h=new Image(s,s);return h.src=y.toDataURL(),h},t.renderPreviewHTML=async function t(l,i){switch(l.type){case"web-style":{const{previewWebStyleSymbol:o}=await new Promise((function(t,l){e(["./previewWebStyleSymbol"],t,l)}));return o(l,t,i)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:t}=await new Promise((function(t,l){e(["./previewSymbol3D"],t,l)}));return t(l,i)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:t}=await new Promise((function(t,l){e(["./previewSymbol2D"],t,l)}));return t(l,i)}case"cim":{const{previewCIMSymbol:t}=await new Promise((function(t,l){e(["./previewCIMSymbol"],t,l)}));return t(l,i)}default:return}},Object.defineProperty(t,"__esModule",{value:!0})}));
