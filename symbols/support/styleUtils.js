/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
define(["exports","../../request","../../symbols","../../core/devEnvironmentUtils","../../core/Error","../../core/urlUtils","../../portal/Portal","../../portal/PortalQueryParams","../../support/featureFlags","../../chunks/persistableUrlUtils","./jsonUtils","./StyleOrigin","./Thumbnail"],(function(e,t,r,n,l,o,s,a,i,m,u,y,c){"use strict";const f={};function b(e,t){return O(e,t).then((t=>({data:t.data,baseUrl:o.removeFile(e),styleUrl:e})))}function d(e,t,r){const n=t.portal||s.getDefault();let l;const o=`${n.url} - ${n.user&&n.user.username} - ${e}`;return f[o]||(f[o]=p(e,n,r).then((e=>(l=e,e.fetchData()))).then((t=>({data:t,baseUrl:l.itemUrl,styleName:e})))),f[o]}function p(e,t,r){return t.load(r).then((()=>{const n=new a({disableExtraQuery:!0,query:`owner:${v} AND type:${$} AND typekeywords:"${e}"`});return t.queryItems(n,r)})).then((({results:t})=>{let n=null;const o=e.toLowerCase();if(t&&Array.isArray(t))for(const e of t){if(e.typeKeywords.some((e=>e.toLowerCase()===o))&&e.type===$&&e.owner===v){n=e;break}}if(!n)throw new l("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return n.load(r)}))}function h(e,t,r){return e.styleUrl?b(e.styleUrl,r):e.styleName?d(e.styleName,t,r):Promise.reject(new l("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function S(e,t,r,n){return e.name?e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName?j(e,t,n):h(e,t,n).then((l=>N(l,e.name,t,r,n))):Promise.reject(new l("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function N(e,t,s,a,i){const f=e.data,b={portal:s.portal,url:o.urlToObject(e.baseUrl),origin:"portal-item"},d=f.items.find((e=>e.name===t));if(!d){const e=`The symbol name '${t}' could not be found`;return Promise.reject(new l("symbolstyleutils:symbol-name-not-found",e,{symbolName:t}))}let p=m.fromJSON(w(d,a),b),h=d.thumbnail&&d.thumbnail.href;const S=d.thumbnail&&d.thumbnail.imageData;n.isDevEnvironment()&&(p=n.adjustStaticAGOUrl(p),h=n.adjustStaticAGOUrl(h));const N={portal:s.portal,url:o.urlToObject(o.removeFile(p)),origin:"portal-item"};return O(p,i).then((n=>{const l="cimRef"===a?g(n.data):n.data,o=u.fromJSON(l,N);if(o&&r.isSymbol3D(o)){if(h){const e=m.fromJSON(h,b);o.thumbnail=new c.default({url:e})}else S&&(o.thumbnail=new c.default({url:`data:image/png;base64,${S}`}));e.styleUrl?o.styleOrigin=new y({portal:s.portal,styleUrl:e.styleUrl,name:t}):e.styleName&&(o.styleOrigin=new y({portal:s.portal,styleName:e.styleName,name:t}))}return o}))}function g(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function w(e,t){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!i.enableWebStyleForceWOSR())for(const r of e.formatInfos)if("gltf"===r.type)return r.href;return e.webRef}function U(e){for(const t of e.typeKeywords)if(/^Esri.*Style$/.test(t)&&"Esri Style"!==t)return t}function j(e,t,r){const n=D.replace(/\{SymbolName\}/gi,e.name);return O(n,r).then((e=>{const r=g(e.data);return u.fromJSON(r,{portal:t.portal,url:o.urlToObject(o.removeFile(n)),origin:"portal-item"})}))}function O(e,r){const n={responseType:"json",query:{f:"json"},...r};return t(o.normalize(e),n)}const v="esri_en",$="Style",D="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";e.fetchStyle=h,e.fetchSymbolFromStyle=N,e.resolveWebStyleSymbol=S,e.styleNameFromItem=U,Object.defineProperty(e,"__esModule",{value:!0})}));
