/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/urlUtils","../../chunks/persistableUrlUtils","../../core/promiseUtils","../../request","../../portal/PortalQueryParams","../../portal/Portal","./StyleOrigin","./Thumbnail","../../chunks/symbols","../../core/devEnvironmentUtils","../../support/featureFlags"],(function(e,t,r,n,l,o,s,a,i,m,u,y,c){"use strict";const f={};function b(e,r,n){const l=r.portal||a.getDefault();let o;const i=`${l.url} - ${l.user&&l.user.username} - ${e}`;return f[i]||(f[i]=function(e,r,n){return r.load(n).then((()=>{const t=new s({disableExtraQuery:!0,query:`owner:${N} AND type:${g} AND typekeywords:"${e}"`});return r.queryItems(t,n)})).then((({results:r})=>{let l=null;const o=e.toLowerCase();if(r&&Array.isArray(r))for(const e of r){if(e.typeKeywords.some((e=>e.toLowerCase()===o))&&e.type===g&&e.owner===N){l=e;break}}if(!l)throw new t("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return l.load(n)}))}(e,l,n).then((e=>(o=e,e.fetchData()))).then((t=>({data:t,baseUrl:o.itemUrl,styleName:e})))),f[i]}function d(e,n,o){return e.styleUrl?function(e,t){return S(e,t).then((t=>({data:t.data,baseUrl:r.removeFile(e),styleUrl:e})))}(e.styleUrl,o):e.styleName?b(e.styleName,n,o):l.reject(new t("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function p(e,o,s,a,f){const b=e.data,d={portal:s.portal,url:r.urlToObject(e.baseUrl),origin:"portal-item"},p=b.items.find((e=>e.name===o));if(!p){const e=`The symbol name '${o}' could not be found`;return l.reject(new t("symbolstyleutils:symbol-name-not-found",e,{symbolName:o}))}let N=n.fromJSON(function(e,t){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!c.enableWebStyleForceWOSR())for(const t of e.formatInfos)if("gltf"===t.type)return t.href;return e.webRef}(p,a),d),g=p.thumbnail&&p.thumbnail.href;const w=p.thumbnail&&p.thumbnail.imageData;y.isDevEnvironment()&&(N=y.adjustStaticAGOUrl(N),g=y.adjustStaticAGOUrl(g));const U={portal:s.portal,url:r.urlToObject(r.removeFile(N)),origin:"portal-item"};return S(N,f).then((t=>{const r="cimRef"===a?h(t.data):t.data,l=u.fromJSON(r,U);if(l&&u.isSymbol3D(l)){if(g){const e=n.fromJSON(g,d);l.thumbnail=new m.default({url:e})}else w&&(l.thumbnail=new m.default({url:`data:image/png;base64,${w}`}));e.styleUrl?l.styleOrigin=new i({portal:s.portal,styleUrl:e.styleUrl,name:o}):e.styleName&&(l.styleOrigin=new i({portal:s.portal,styleName:e.styleName,name:o}))}return l}))}function h(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function S(e,t){const n={responseType:"json",query:{f:"json"},...t};return o(r.normalize(e),n)}const N="esri_en",g="Style",w="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";e.fetchStyle=d,e.fetchSymbolFromStyle=p,e.resolveWebStyleSymbol=function(e,n,o,s){return e.name?e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName?function(e,t,n){const l=w.replace(/\{SymbolName\}/gi,e.name);return S(l,n).then((e=>{const n=h(e.data);return u.fromJSON(n,{portal:t.portal,url:r.urlToObject(r.removeFile(l)),origin:"portal-item"})}))}(e,n,s):d(e,n,s).then((t=>p(t,e.name,n,o,s))):l.reject(new t("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))},e.styleNameFromItem=function(e){for(const t of e.typeKeywords)if(/^Esri.*Style$/.test(t)&&"Esri Style"!==t)return t},Object.defineProperty(e,"__esModule",{value:!0})}));
