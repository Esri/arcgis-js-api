/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../core/urlUtils","../../chunks/persistableUrlUtils","../../request","../../portal/PortalQueryParams","../../portal/Portal","./StyleOrigin","./Thumbnail","../../symbols","./jsonUtils","../../core/devEnvironmentUtils","../../support/featureFlags"],(function(e,t,r,n,l,o,s,a,i,m,u,y,c){"use strict";const f={};function b(e,t){return O(e,t).then((t=>({data:t.data,baseUrl:r.removeFile(e),styleUrl:e})))}function d(e,t,r){const n=t.portal||s.getDefault();let l;const o=`${n.url} - ${n.user&&n.user.username} - ${e}`;return f[o]||(f[o]=p(e,n,r).then((e=>(l=e,e.fetchData()))).then((t=>({data:t,baseUrl:l.itemUrl,styleName:e})))),f[o]}function p(e,r,n){return r.load(n).then((()=>{const t=new o({disableExtraQuery:!0,query:`owner:${v} AND type:${$} AND typekeywords:"${e}"`});return r.queryItems(t,n)})).then((({results:r})=>{let l=null;const o=e.toLowerCase();if(r&&Array.isArray(r))for(const e of r){if(e.typeKeywords.some((e=>e.toLowerCase()===o))&&e.type===$&&e.owner===v){l=e;break}}if(!l)throw new t("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return l.load(n)}))}function h(e,r,n){return e.styleUrl?b(e.styleUrl,n):e.styleName?d(e.styleName,r,n):Promise.reject(new t("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function S(e,r,n,l){return e.name?e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName?j(e,r,l):h(e,r,l).then((t=>N(t,e.name,r,n,l))):Promise.reject(new t("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function N(e,l,o,s,c){const f=e.data,b={portal:o.portal,url:r.urlToObject(e.baseUrl),origin:"portal-item"},d=f.items.find((e=>e.name===l));if(!d){const e=`The symbol name '${l}' could not be found`;return Promise.reject(new t("symbolstyleutils:symbol-name-not-found",e,{symbolName:l}))}let p=n.fromJSON(w(d,s),b),h=d.thumbnail&&d.thumbnail.href;const S=d.thumbnail&&d.thumbnail.imageData;y.isDevEnvironment()&&(p=y.adjustStaticAGOUrl(p),h=y.adjustStaticAGOUrl(h));const N={portal:o.portal,url:r.urlToObject(r.removeFile(p)),origin:"portal-item"};return O(p,c).then((t=>{const r="cimRef"===s?g(t.data):t.data,y=u.fromJSON(r,N);if(y&&m.isSymbol3D(y)){if(h){const e=n.fromJSON(h,b);y.thumbnail=new i.default({url:e})}else S&&(y.thumbnail=new i.default({url:`data:image/png;base64,${S}`}));e.styleUrl?y.styleOrigin=new a({portal:o.portal,styleUrl:e.styleUrl,name:l}):e.styleName&&(y.styleOrigin=new a({portal:o.portal,styleName:e.styleName,name:l}))}return y}))}function g(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function w(e,t){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!c.enableWebStyleForceWOSR())for(const r of e.formatInfos)if("gltf"===r.type)return r.href;return e.webRef}function U(e){for(const t of e.typeKeywords)if(/^Esri.*Style$/.test(t)&&"Esri Style"!==t)return t}function j(e,t,n){const l=D.replace(/\{SymbolName\}/gi,e.name);return O(l,n).then((e=>{const n=g(e.data);return u.fromJSON(n,{portal:t.portal,url:r.urlToObject(r.removeFile(l)),origin:"portal-item"})}))}function O(e,t){const n={responseType:"json",query:{f:"json"},...t};return l(r.normalize(e),n)}const v="esri_en",$="Style",D="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";e.fetchStyle=h,e.fetchSymbolFromStyle=N,e.resolveWebStyleSymbol=S,e.styleNameFromItem=U,Object.defineProperty(e,"__esModule",{value:!0})}));
