/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.24/esri/copyright.txt for details.
*/
import{id as t}from"../../kernel.js";import e from"../../request.js";import{toHSV as i,toRGB as r}from"../../core/colorUtils.js";import n from"../../core/Error.js";import o from"../../core/has.js";import"../../libs/maquette/projection.js";import{createProjector as a}from"../../libs/maquette/projector.js";import{renderSVG as c}from"./svgUtils.js";import{getCSSFilterFromEffectList as s}from"./utils.js";const h=a();function l(t,e,i){const r=Math.ceil(e[0]),n=Math.ceil(e[1]);if(!t.some((t=>!!t.length)))return null;const o=i&&i.node||document.createElement("div");return null!=i.opacity&&(o.style.opacity=i.opacity.toString()),null!=i.effectView&&(o.style.filter=s(i.effectView)),h.append(o,c.bind(null,t,r,n,i)),o}function m(t,e){t=Math.ceil(t),e=Math.ceil(e);const i=document.createElement("canvas");i.width=t,i.height=e,i.style.width=t+"px",i.style.height=e+"px";const r=i.getContext("2d");return r.clearRect(0,0,t,e),r}function g(t,i,r){return t?e(t,{responseType:"image"}).then((t=>{const e=t.data,n=e.width,o=e.height,a=n/o;let c=i;if(r){const t=Math.max(n,o);c=Math.min(c,t)}return{image:e,width:a<=1?Math.ceil(c*a):c,height:a<=1?c:Math.ceil(c/a)}})):Promise.reject(new n("renderUtils: imageDataSize","href not provided."))}function u(t,e){return!(!t||"ignore"===e)&&("multiply"!==e||255!==t.r||255!==t.g||255!==t.b||1!==t.a)}function d(t,e,n,o,a){switch(a){case"multiply":t[e+0]*=n[0],t[e+1]*=n[1],t[e+2]*=n[2],t[e+3]*=n[3];break;default:{const a=i({r:t[e+0],g:t[e+1],b:t[e+2]});a.h=o.h,a.s=o.s,a.v=a.v/100*o.v;const c=r(a);t[e+0]=c.r,t[e+1]=c.g,t[e+2]=c.b,t[e+3]*=n[3];break}}}function f(e,r,n,a,c){return g(e,r,c).then((c=>{const s=c.width?c.width:r,h=c.height?c.height:r;if(c.image&&u(n,a)){let t=c.image.width,r=c.image.height;o("edge")&&/\.svg$/i.test(e)&&(t-=1,r-=1);const l=m(s,h);l.drawImage(c.image,0,0,t,r,0,0,s,h);const g=l.getImageData(0,0,s,h),u=[n.r/255,n.g/255,n.b/255,n.a],f=i(n);for(let e=0;e<g.data.length;e+=4)d(g.data,e,u,f,a);l.putImageData(g,0,0),e=l.canvas.toDataURL("image/png")}else{const i=t&&t.findCredential(e);if(i&&i.token){const t=e.includes("?")?"&":"?";e=`${e}${t}token=${i.token}`}}return{url:e,width:s,height:h}})).catch((()=>({url:e,width:r,height:r})))}export{l as renderSymbol,f as tintImageWithColor};
